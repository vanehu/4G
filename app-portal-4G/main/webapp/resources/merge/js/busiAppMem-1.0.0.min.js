CommonUtils.regNamespace("CONST");CONST=(function(){var f=-1;var t="10000";var A="20020054";var G={FOUR_G:11,APP:15,LTE:10,UI_LTE:8,ZDYY:14};var X={FLOW:"100",SERV:"10000"};var c={CDMA:235010000,DATA_CARD:280000000,PROD_FUN_4G:"280000020"};var R={MIFI_ID:"235010076",WIRE_GLOBAL:"13409441"};var i={FEE_TYPE:"10020030",IS_XINKONG:"40010030",PROD_USER:"800000011"};var v={IS_XINKONG_YES:"20",IS_XINKONG_NO:"10"};var P={CREDIT_LIMIT:"30010040",PROTOCOL_NBR:"30020008"};var T={UIM_CHARGE_ITEM_CD:"2014000"};var M={THREE:3,FOUR:4};var N={MUST:"1000",SELECT:"1001",ZDYY:"100004"};var l={CLOSE:"1000",KIP:"1001",CHOOSE:"1002"};var B={REMOVE_PROD:110000,NORMAL_PROD:100000,STOP_PROD:120000,READY_PROD:140001,DONE_PROD:140002,NEW_PROD:130000};var h={AFTER_PAY:1200,BEFORE_PAY:2100,NOLIMIT_PAY:3100,BEFORE_AFTER_PAY:2101,BEFORE_AFTER_QUASIREALTIME_PAY:3103,QUASIREALTIME_AFTER_PAY:3102,AFTER_BEFORE_PAY:1202,QUASIREALTIME_BEFORE_PAY:3101,QUASIREALTIME_PAY:1201};var a={CUST_ACTION:1000,ACCT_ACTION:1100,OFFER_ACTION:1200,PROD_ACTION:1300,MKTRES_ACTION:1600};var m={PROD:2,FUN_PROD:4,SERV:4,OFFER:7};var o={BUY_OFFER:"S1",DEL_OFFER:"S2",ADDOREXIT_COMP:"S3",UPDATE_OFFER:"S3",CUST_CREATE:"C1",CUSTINFOMODIFY:"C2",ACCT_CREATE:"A1",ACCTINFOMODIFY:"A2",NEW_PROD:"1",UPDATE_ACCNBR:"2",REMOVE_PROD:"3",PREMOVE_PROD:"4020200000",SERV_OPEN:"7",PREMOVE_BACK_PROD:"4070100003",BREAK_RULE_REMOVE_PROD:"4020300002",OWE_REMOVE_PROD:"66",NOACTIVE_REMOVE_PROD:"4020400000",DIFF_AREA_CHANGE_CARD:"4040600001",CHANGE_CARD:"14",LOSSREP_PROD:"1171",DISLOSSREP_PROD:"1172",STOPKEEPNUM:"19",DISSTOPKEEPNUM:"20",PRODUCT_PASSWORD:"18",PRODUCT_PASSWORD_RESET:"4040800003",PRODUCT_PARMS:"1179",PRODUCT_INFOS:"4040100000",TRANSFER:"11",ACTIVERETURN:"1020500000",TRANSFERRETURN:"4041700000",ACTIVERETURNTWO:"4070400000",CHANGE_ACCOUNT:"-6",ADD_COMP:"998",REMOVE_COMP:"999",COUPON_SALE:"3010200000",RETURN_COUPON:"3030300000",EXCHANGE_COUPON:"4040800002",CHANGE_FEE_TYPE:"1244",BUY_BACK:"5010100002",BUY_BACK_CHANGE_CARD:"7040100001",BUY_BACK_ORDER_CONTRACT:"3030200000",TERMINAL_RESERVATION:"3010300000",RETURN_TERMINAL:"3030400000"};var w={S1:"订购","1":"新装","3":"拆机","4020300002":"违章拆机","66":"欠费拆机","4020400000":"未激活拆机","1171":"挂失","1172":"解挂","19":"停机保号","20":"停机保号复机","18":"产品密码修改","4040800003":"产品密码重置",C1:"新建客户",C2:"修改客户信息","1179":"修改产品属性",S3:"主副卡成员变更","11":"过户","1020500000":"改客户资料返档","4041700000":"过户返档","-6":"改帐务定制关系",A2:"修改帐户信息","4020200000":"预拆机","4070100003":"预拆机复机","5010100002":"新装返销","2":"改号","7040100001":"补换卡返销","3030200000":"订购合约返销"};var d={OFFER_BUY:"订购销售品",OFFER_DEL:"退订销售品",OFFER_UPDATE:"变更销售品 ",PROD_NEW:"新装",PROD_UPDATE:"变更功能产品",PROD_OPEN:"开通功能产品",PROD_CLOSE:"关闭功能产品"};var s={REMOVE_REASON:"111111122",DEALER:"111111116",DEALER_NAME:"111111120",DEALER_CODE:"111111125",REMARK:"111111118",orderAttrName:"30010020",orderAttrPhoneNbr:"30010025",orderIdentidiesTypeCd:"30010026",orderAttrIdCard:"30010021",orderAttrAddr:"30010022",EXT_CUST_ID:"20900011",COR_CUST_ID:"30010027",EXT_PROD_INST_ID:"30010045",COR_PROD_INST_ID:"30010044",EXT_COUPON_INST_ID:"30010047",COR_COUPON_INST_ID:"30010046",PROV_ISALE:"40010029",THRETOFOUR_ITEM:"111111199",BUSITYPE_FLAG:"30010024",ZCD_ITEM:"111111198",SO_NBR:"111111196",STEP_ORDER_CHARGE_STAFF:"111111197",DELIVERY_TYPE:"800000013",DELIVERY_METHOD:"800000014",DELIVERY_TIME:"800000015",DELIVERY_ADDRESS:"800000016",DELIVERY_POLICY:"800000018",itemSpecID:"800000036"};var S={FEE_TYPE:"10020030",PROT_NUMBER:"11251741"};var e=function(Z){return w[Z]};var z={COMMON_MEMBER:1,MAIN_CARD:400,VICE_CARD:401,BROADBAND_MAIN_CARD:500,BROADBAND_VICE_CARD:501,CONTENT:99991};var U=[{MEMBER_ROLE_CD:1,MEMBER_ROLE_NAME:"普通成员"},{MEMBER_ROLE_CD:400,MEMBER_ROLE_NAME:"天翼主卡"},{MEMBER_ROLE_CD:401,MEMBER_ROLE_NAME:"天翼副卡"},{MEMBER_ROLE_CD:500,MEMBER_ROLE_NAME:"天翼宽带主卡"},{MEMBER_ROLE_CD:501,MEMBER_ROLE_NAME:"天翼宽带副卡"},{MEMBER_ROLE_CD:600,MEMBER_ROLE_NAME:"基础套餐级可选包"},{MEMBER_ROLE_CD:601,MEMBER_ROLE_NAME:"加装套餐级可选包"},{MEMBER_ROLE_CD:99991,MEMBER_ROLE_NAME:"内容产品"}];var q={SUCC_CODE:"POR-0000",FAIL_CODE:"POR-2004"};var u={busiOrderAttrs:111111122};var j={NEW_PROD:1,ATTACH_OFFER_CHANGE:2,OFFER_CHANGE:5,NEW_PROD:1,NEW_PROD:1};var x={COUPON_SALE:"2007000",COUPON_RESERVATION_SALE:"2007002"};var F={USABLE:"1001",HAVESALE:"1115"};var E={BRAND:60010002,PHONE_TYPE:60010003,COLOR:60010004,TERMINAL_TYPE:60010013,SUPPORT4G:60010023,SUPPORT4NFC:60010024};var Q={XIAN_JIN:100000,YIN_HANG:110000,POS:110100,WANG_YIN:110200,TUO_SHOU:110300,ZHI_PIAO:110400,FEN_QI_FU_KUAN:110500,YIN_HANG_DAI_KOU:110600,DI_SAN_FANG_ZHI_FU_PING_TAI:120000,YI_ZHI_FU:120100,ZHI_FU_BAO:120200,TAO_BAO_XIN_YONG_KA:120201,CAI_FU_TONG:120300,QU_DAO_DAI_SHOU:130000,JI_TUAN_DAI_SHOU:130100,ZHENG_QI_DAI_SHOU:130200,ZHANG_WU_DAI_SHOU:140000,HUA_FEI_YU_E:140100,DI_KOU_LEI:150000,DIAN_XIN_KA_DI_KOU:150100,JI_FEN_DI_KOU:150200,TAO_BAO_JI_FEN_DI_KOU:150201,DAI_JIN_QUAN_DI_KOU:150300,HUO_DAO_FU_KUAN:160000,XIAN_JIN_DAO_FU:160100,POS_DAO_FU:160200};var D={SILENT_OLID:"silentOlId"};var W=function(){if(CONST.APP_DESC==-1){p();return CONST.APP_DESC}else{return CONST.APP_DESC}};var p=function(){CONST.APP_DESC=globalAppDesc};var Y=/^(180|189|133|134|153|181|108|170|177)\d{8}$/;var L=/^(170)\d{8}$/;var k="100003";var g=381000960;var K=10020034;var I=10020035;var H=10020036;var y={ZQZXDL:100100,GZZXDL:100300,HYKHZXDL:100101,SYKHZXDL:100102,XYKHZXDL:100103,GZZXJL:100301,ZYOUT:110100,ZYINGT:110101,WBT:110102};var J=["381001824","13409900"];var V=["235010013","381001823"];var b={"235010013":"10020047","381001823":"10020047"};var O=function(aa,Z){if(b[aa]==Z){return b[aa]}else{return""}};var r={IS4G:"1",IS3G:"0"};var C={BATCHORDER_QRY_FLAG:"N",BATCHORDER_AUTH_FLAG:"N"};return{BATCHORDER_FLAG:C,APP_DESC:f,OFFER_FAST_FILL:A,setAppDesc:p,BO_ACTION_TYPE:o,ACTION_CLASS_CD:a,PROD_STATUS_CD:B,BUSI_ORDER_ATTR:s,MEMBER_ROLE_CD:z,MEMBER_ROLE_LIST:U,PROD_SPEC:c,PROD_ATTR:i,ACCT_ATTR:P,getBoActionTypeName:e,PAY_TYPE:h,CODE:q,OL_TYPE_CD:G,LABEL:X,PROD_CLASS:M,ITEM_SPEC_ID_CODE:u,EVENT:d,TEMPLATE_TYPE:j,CUST_COUPON_SALE:t,CHARGE_ITEM_CD:x,MKTRES_STATUS:F,ITEM_SPEC:S,OBJ_TYPE:m,ACCT_ITEM_TYPE:T,getAppDesc:W,RELA_TYPE_CD:N,UNSS_PROCESS_MODE:l,TERMINAL_SPEC_ATTR_ID:E,PAYMETHOD_CD:Q,DEL_ORDER_FLAG:D,PROD_SPEC_ID:R,LTE_PHONE_HEAD:Y,MVNO_PHONE_HEAD:L,RELATYPECD:k,YZFservSpecId:g,YZFitemSpecId1:K,YZFitemSpecId2:I,YZFitemSpecId3:H,CHANNEL_TYPE_CD:y,GROUP_SERV_SPEC_ID:V,GROUP_PROD_SPEC:J,getGroupServProdMap:O,CHANNEL_TYPE_CD:y,UIMTYPE3G4G:r,PROD_ATTR_VALUE:v}})();$(function(){CONST.getAppDesc()});CommonUtils.regNamespace("common");common=(function(f){var p=function(w,x,z,t){var A=JSON.stringify(w);var y=JSON.stringify(x);var s=JSON.stringify(z);var u=f.parseJSON(JSON.stringify(t));OrderInfo.actionFlag=u.actionFlag;if(ec.util.isObj(z)){order.prodModify.choosedProdInfo=f.parseJSON(s)}if(ec.util.isObj(w)){OrderInfo.staff=f.parseJSON(A)}if(ec.util.isObj(x)){OrderInfo.cust=f.parseJSON(y)}var v={staffInfos:A,custInfos:y,prodIdInfos:s};var r=u.method;f.callServiceAsHtml(contextPath+r,v,{before:function(){f.ecOverlay("正在努力加载中，请稍等...")},done:function(C){f.unecOverlay();f("#load").hide();var B=f("#content").html(C.data);f.refresh(B)},fail:function(B){f.unecOverlay();f.alert("提示","查询失败，请稍后再试！")}})};var i=function(r){var s=JSON.stringify(r);if(ec.util.isObj(r)){OrderInfo.cust=f.parseJSON(s)}};var c=function(s){var r=new Array(1);r[0]=s;MyPlugin.getIDCardInfos(r,function(t){},function(t){})};var b=function(s){var r=new Array(1);r[0]=s;MyPlugin.takePhotos(r,function(t){},function(t){})};var k=function(s){var r=new Array(1);r[0]=s;MyPlugin.getGenerationInfos(r,function(t){},function(t){})};var g=function(){var r=new Array(1);r[0]=JSON.stringify(OrderInfo.cust);MyPlugin.showCust(r,function(s){},function(s){})};var e=function(){if(f("#alert-modal").length>0){f("#alert-modal").hide()}var r=new Array(1);r[0]="";MyPlugin.closeWebview(r,function(s){},function(s){})};var j=function(){if(f("#alert-modal").length>0){f("#alert-modal").hide()}var r=new Array(1);r[0]="";MyPlugin.relocationCust(r,function(s){},function(s){})};var a=function(s){var r=new Array(1);
r[0]=s;MyPlugin.datasign(r,function(t){},function(t){})};var m=function(t,s){var r=new Array(1);r[0]=t;r[1]=s;MyPlugin.scanning(r,function(u){},function(u){})};var o=function(t,s,v,u){var r=new Array(1);r[0]=t;r[1]=s;r[2]=v;r[3]=u;MyPlugin.calendar(r,function(w){},function(w){})};var q=function(r,s){f("#"+s).val(r)};var l=function(){f.unecOverlay();if(OrderInfo.actionFlag==4||OrderInfo.actionFlag==8){e();return}if(OrderInfo.actionFlag==40){cart.main.cartBack();return}if(OrderInfo.actionFlag==140){order.calcharge.back();return}if(OrderInfo.actionFlag==150){mktRes.terminal.back();return}if(OrderInfo.returnFlag==2){order.phoneNumber.back();return}if(OrderInfo.order.step==1){e()}else{if(OrderInfo.order.step==2){if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==9){e();return}order.main.lastStep(function(){f("#order_prepare").show();if(OrderInfo.actionFlag!=13||OrderInfo.actionFlag!=14){f("#pakeage").show()}if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==14){f("#phone").show();f("#pakeage").hide();f("#number").hide()}f("#order").hide();if(OrderInfo.actionFlag==1){h(2)}if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==14){h(2)}OrderInfo.order.step=1})}else{if(OrderInfo.order.step==3){if(OrderInfo.actionFlag==3){var r=OrderInfo.boProd2Tds;if(r.length>0){for(var t=0;t<r.length;t++){var s={numType:2,numValue:r[t].terminalCode};f.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",s,{done:function(){}})}}e();return}SoOrder.orderBack();f("#order-content").show();f("#order-confirm").hide();f("#order-dealer").hide();OrderInfo.order.step=2}else{if(OrderInfo.order.step==4){f("#order-confirm").show();f("#order-print").hide();OrderInfo.order.step=3}else{e()}}}}};var h=function(s){var r=new Array(1);r[0]=s;MyPlugin.changeTitle(r,function(t){},function(t){})};var d=function(){var r=new Array(1);MyPlugin.sessionValid(r,function(s){},function(s){})};return{relocationCust:j,setCalendar:q,callcalendar:o,callCloseWebview:e,callCustInfo:i,callDatasign:a,callGenerationRec:k,callIDCardRec:c,callOrderServer:p,callPhotos:b,callReturnBack:l,callScanning:m,callSessionNotViald:d,callTitle:h,saveCust:g}})(jQuery);CommonUtils.regNamespace("order","prodModify");order.prodModify=(function(){var a={};var c=false;var b=function(e,d,g,f){OrderInfo.newofferSpecName=g;$("#"+d).show();$("#"+d).html("&nbsp;&nbsp;<span style='color: #327501;'>订购新套餐：</span>"+g);$("#li_"+d).attr("addSpecId",e).attr("addRoleId",f).attr("del","N").attr("addSpecName",g);c=true;if(document.getElementById("li_"+d)){$("#li_"+d).css("text-decoration","").attr("del","N").attr("knew","Y");$("#li_"+d).find("i:first-child").find("a").text("拆副卡")}};return{choosedProdInfo:a,chooseOfferForMember:b}})();CommonUtils.regNamespace("OrderInfo");OrderInfo=(function(){var H=0;var l=-1;var g=-1;var at="false";var K="false";var b="false";var aE="";var aG=0;var k="";var al="";var az="";var aB="";var z={provIsale:"",redirectUri:"",isFee:"1",extCustOrderID:"",reloadFlag:"",prodOfferId:"",prodOfferName:"",mergeFlag:"0"};var c={oldSubPhoneNum:""};var aj={DevelopmentCode:"",terminalCode:"",developmentObjId:""};var Z="";var Q="";var ay;var am={custId:"",partyName:"",vipLevel:"",vipLevelName:"",custFlag:"1100"};var t={};var a={staffId:0,channelId:0,channelName:"",areaId:0,areaCode:0,soAreaId:0,soAreaCode:0,distributorId:""};var aw=[];var z={provIsale:"",redirectUri:"",isFee:"1",extCustOrderID:"",reloadFlag:"",prodOfferId:"",prodOfferName:""};var s=0;var o={mainPhoneNum:"",newSubPhoneNum:"",oldSubPhoneNum:"",mktResInstCode:""};var m={mainPhoneNum:"",newSubPhoneNum:"",mktResInstCode:"",codeMsg:""};var ag={cardNum:"",checkMaskList:[],feeType:"",orderMark:"",isReloadFlag:"",objInstId:"",dealerlist:[],paymentAcctTypeCd:"",mailingType:"",bankAcct:"",bankId:"",limitQty:"",paymentMan:"",param1:"",param2:"",param3:"",param7:""};var ae={};var J={offerId:"",offerSpecId:"",offerMemberInfos:[]};var S=[];var av=[];var an=[];var p=[];var au=[];var B={offerId:"",offerSpecId:"",offerMemberInfos:[]};var D=0;var h="";var Y="订购";var G="";var ad="";var ac=[];var O={};var r=[];var y={};var ak={dealerType:"",soNbr:"",oldSoNbr:"",oldSoId:"",step:0,token:"",templateType:1,dealerTypeList:[]};var v={effTime:""};var C={seq:-1,offerSeq:-1,prodSeq:-1,servSeq:-1,itemSeq:-1,acctSeq:-1,acctCdSeq:-1,paramSeq:-1,atomActionSeq:-1,offerMemberSeq:-1,dealerSeq:1};var W=[];var R=[];var aA=[];var ai=[];var ah=[];var aJ=[];var d=[];var e=[];var ar=[];var x=function(){var aL={orderList:{orderListInfo:{isTemplateOrder:"N",templateType:OrderInfo.order.templateType,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,areaId:OrderInfo.staff.soAreaId,partyId:-1,olTypeCd:CONST.OL_TYPE_CD.UI_LTE},custOrderList:[{busiOrder:[]}]}};OrderInfo.orderData=aL;return OrderInfo.orderData};var A=function(aL,aM,aN){OrderInfo.channelList=[];if($("i[name='channel_iofo_i']").length==0){OrderInfo.channelList=window.parent.OrderInfo.getChannelList()}else{$("i[name='channel_iofo_i']").each(function(){var aQ=$(this).attr("channel_Id");var aO=$(this).attr("channel_Name");var aS=$(this).attr("channel_Nbr");var aR=0;if($(this).hasClass("select")){var aR=1}var aP={channelId:aQ,channelName:aO,channelNbr:aS,isSelect:aR};OrderInfo.channelList.push(aP)})}return OrderInfo.channelList};var aC=function(aM){var aL=w(-1);var aN={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.CUST_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.CUST_CREATE},data:{boCustInfos:[],boCustIdentities:[],boPartyContactInfo:[]}};if(ec.util.isObj(aL)){aN.busiObj.accessNumber=aL}cust.getCustInfo();aN.data.boCustInfos.push(OrderInfo.boCustInfos);aN.data.boCustIdentities.push(OrderInfo.boCustIdentities);if($("#tabProfile0").attr("click")=="0"&&($("#contactName").val()!="")){aN.data.boPartyContactInfo.push(OrderInfo.boPartyContactInfo)}if(OrderInfo.boCustProfiles!=undefined&&OrderInfo.boCustProfiles!=""){aN.data.boCustProfiles=[];aN.data.boCustProfiles=OrderInfo.boCustProfiles}aM.push(aN)};var f=function(aT,aU){var aM=OrderInfo.cust.partyName;var aV=100000;var aP="";var aR="";var aS="";var aO=-1;if(aV==110000){aP=$("#bankId").val();aR=$("#bankAcct").val();aS=$("#paymentMan").val()}var aL={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:aU},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.ACCT_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACCT_CREATE},data:{boAccountInfos:[{partyId:OrderInfo.cust.custId,acctName:aM,acctCd:aU,acctId:aU,businessPassword:"111111",state:"ADD",acctTypeCd:"1"}],boPaymentAccounts:[{paymentAcctTypeCd:aV,bankId:aP,bankAcct:aR,paymentMan:aS,limitQty:"1",state:"ADD"}],boAcct2PaymentAccts:[{priority:"1",state:"ADD"}],boAccountItems:[],boAccountMailings:[]}};var aN=w(-1);if(ec.util.isObj(aN)){aL.busiObj.accessNumber=aN}if($("#paymentType").val()==110000&&$.trim($("#protocalNbr").val())!=""){var aW={itemSpecId:CONST.ACCT_ATTR.PROTOCOL_NBR,value:$.trim($("#protocalNbr").val()),state:"ADD"};aL.data.boAccountItems.push(aW)}if(aO!=-1){var aQ={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"ADD"};if($("#postType").val()==11||$("#postType").val()==15){aQ.param1=$("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val()}aL.data.boAccountMailings.push(aQ)}aT.push(aL)};var aH=function(aM,aO,aQ){var aL=w(aQ);var aP={areaId:OrderInfo.getProdAreaId(aQ),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:aO.offerId,objId:aO.offerSpecId,offerTypeCd:aO.offerTypeCd},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:aO.boActionTypeCd},data:{}};if(ec.util.isObj(aO.offerSpecName)){aP.busiObj.objName=aO.offerSpecName}if(ec.util.isObj(aL)){aP.busiObj.accessNumber=aL}if(aO.boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_OFFER){var aN=$("li[name='tr_"+aQ+"_"+aO.offerSpecId+"']");if(aN!=undefined&&aN.length>0){aP.data.busiOrderAttrs=[];aN.each(function(){var aR={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select[name='dealerType_"+aQ+"_"+aO.offerSpecId+"']").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name='dealerChannel_"+aQ+"_"+aO.offerSpecId+"']").val()};
aP.data.busiOrderAttrs.push(aR);var aS={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select[name='dealerType_"+aQ+"_"+aO.offerSpecId+"']").val(),value:$(this).find("input").attr("value")};aP.data.busiOrderAttrs.push(aS)})}aP.data.ooOwners=[];aP.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"ADD"});if(ec.util.isArray(aO.offerSpecParams)){aP.data.ooParams=[];$.each(aO.offerSpecParams,function(){if(this.setValue==undefined){this.setValue=this.value}if(ec.util.isObj(this.setValue)){var aR={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};aP.data.ooParams.push(aR)}})}if(aO.ooTimes!=undefined){aP.data.ooTimes=[];aP.data.ooTimes.push(aO.ooTimes)}$.each(OrderInfo.attach2Coupons,function(){if(aO.offerSpecId==this.attachSepcId&&aQ==this.prodId){this.offerId=aO.offerId;aP.data.bo2Coupons=[];aP.data.bo2Coupons.push(this);return false}});aP.data.ooRoles=[];if(ec.util.isArray(aO.offerRoles)){$.each(aO.offerRoles,function(){var aR=this;$.each(this.roleObjs,function(){var aV={prodId:aQ,offerRoleId:aR.offerRoleId,objId:this.objId,objType:this.objType,relaType:this.relaTypeCd,state:"ADD"};var aT=true;if(this.objType==CONST.OBJ_TYPE.PROD){var aU=OrderInfo.getProdSpecId(aQ);if(aU==this.objId||aU==""){aV.objInstId=aQ}else{return true}}else{if(this.objType==CONST.OBJ_TYPE.SERV){var aW=CacheData.getServBySpecId(aQ,this.objId);if(aW!=undefined){aV.objInstId=aW.servId}else{var aS=CacheData.getServSpec(aQ,this.objId);if(aS!=undefined&&aS.isdel!="Y"&&aS.isdel!="C"&&aS.servId!=undefined&&aS.servId!=""){aV.objInstId=aS.servId}else{aT=false}}}else{aV.objInstId=OrderInfo.SEQ.offerSeq--}}if(aT){aP.data.ooRoles.push(aV)}})})}aM.push(aP)}else{if(aO.boActionTypeCd==CONST.BO_ACTION_TYPE.DEL_OFFER){aP.data.ooOwners=[];aP.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"DEL"});if(ec.util.isArray(aO.offerMemberInfos)){aP.data.ooRoles=[];$.each(aO.offerMemberInfos,function(){var aR={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerRoleId:this.offerRoleId,state:"DEL"};if(this.objType!=CONST.OBJ_TYPE.PROD){aR.prodId=aQ}if(this.offerMemberId!=undefined){aR.offerMemberId=this.offerMemberId}aP.data.ooRoles.push(aR)})}if(aO.isRepeat!="Y"){aM.push(aP)}}else{if(aO.boActionTypeCd==CONST.BO_ACTION_TYPE.UPDATE_OFFER){if(aO.isUpdate=="Y"){aP.data.ooRoles=aO.data}else{if(ec.util.isArray(aO.offerSpec.offerSpecParams)){aP.data.ooParams=[];$.each(aO.offerSpec.offerSpecParams,function(){if(this.isUpdate=="Y"){if(ec.util.isObj(this.value)){var aR={itemSpecId:this.itemSpecId,offerParamId:this.offerParamId,offerSpecParamId:this.offerSpecParamId,value:this.value,state:"DEL"};aP.data.ooParams.push(aR)}if(ec.util.isObj(this.setValue)){var aS={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};aP.data.ooParams.push(aS)}}})}}aM.push(aP)}}}};var P=function(aQ){var aM=w(aQ.prodId);var aP={areaId:OrderInfo.getProdAreaId(aQ.prodId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.getProdSpecId(aQ.prodId),instId:aQ.prodId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:aQ.boActionTypeCd},data:{}};if(ec.util.isObj(aQ.isComp)){aP.busiObj.isComp=aQ.isComp}if(ec.util.isObj(aM)){aP.busiObj.accessNumber=aM}if(aQ.boActionTypeCd==CONST.BO_ACTION_TYPE.PRODUCT_PARMS){if(ec.util.isArray(aQ.prodSpecParams)){aP.data.boServOrders=[];aP.data.boServOrders.push({servId:aQ.memberId,servSpecId:aQ.servSpecId});aP.data.boServItems=[];$.each(aQ.prodSpecParams,function(){if(this.isUpdate=="Y"){if(ec.util.isObj(this.value)){var aR={itemSpecId:this.itemSpecId,servId:aQ.memberId,value:this.value,state:"DEL"};aP.data.boServItems.push(aR)}if(ec.util.isObj(this.setValue)){var aS={itemSpecId:this.itemSpecId,servId:aQ.memberId,value:this.setValue,state:"ADD"};aP.data.boServItems.push(aS)}}})}}else{if(aQ.boActionTypeCd==CONST.BO_ACTION_TYPE.SERV_OPEN){var aO="ADD";if(aQ.servClose=="Y"){aO="DEL"}else{if(aQ.servSpecId==undefined&&aQ.objId!=undefined){aQ.servSpecId=aQ.objId}}var aN={servId:aQ.servId,servSpecId:aQ.servSpecId};if(ec.util.isObj(aQ.servSpecName)){aN.servSpecName=aQ.servSpecName}aP.data.boServOrders=[];aP.data.boServOrders.push(aN);aP.data.boServs=[];aP.data.boServs.push({servId:aQ.servId,state:aO});if(aQ.servClose!="Y"){if(ec.util.isArray(aQ.prodSpecParams)){aP.data.boServItems=[];$.each(aQ.prodSpecParams,function(){if(this.setValue==undefined){this.setValue=this.value}var aR=$("select[name='pay_type_-1']").val();if(aR==undefined){aR=order.prodModify.choosedProdInfo.feeType}if(aQ.servSpecId==CONST.YZFservSpecId&&aR==CONST.PAY_TYPE.AFTER_PAY){this.setValue=""}if(ec.util.isObj(this.setValue)){var aS={itemSpecId:this.itemSpecId,servId:aQ.servId,value:this.setValue,state:aO};aP.data.boServItems.push(aS)}})}}}else{if(aQ.boActionTypeCd==CONST.BO_ACTION_TYPE.REMOVE_PROD){aP.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}]}else{if(aQ.boActionTypeCd==CONST.BO_ACTION_TYPE.CHANGE_CARD||aQ.boActionTypeCd==CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD){var aL=OrderInfo.getProdUim(aQ.prodId);if(ec.util.isObj(aL.prodId)){aP.data.bo2Coupons=[];aP.data.bo2Coupons.push(aL);aP.data.bo2Coupons.push(OrderInfo.getProdOldUim(aQ.prodId))}else{return false}}}}}return aP};var E=function(aL,aO){var aM=order.prodModify.choosedProdInfo;var aN={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aM.productId,instId:aM.prodInstId,accessNumber:aM.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};aN.data=aO;aL.push(aN)};var aF={areaId:0,defaultIdType:"1",businessPassword:"",name:"",partyTypeCd:1,state:"ADD",telNumber:"",addressStr:"",mailAddressStr:""};var M={identidiesTypeCd:"1",identityNum:"",isDefault:"Y",state:"ADD"};var U={contactAddress:"",contactDesc:"",contactEmployer:"",contactGender:"",contactId:"",contactName:"",contactType:"",eMail:"",fax:"",headFlag:"",homePhone:"",mobilePhone:"",officePhone:"",postAddress:"",postcode:"",staffId:0,state:"",statusCd:"100001"};var aK={};var i=function(){OrderInfo.SEQ.seq=-1;OrderInfo.SEQ.offerSeq=-1;OrderInfo.SEQ.prodSeq=-1;OrderInfo.SEQ.servSeq=-1;OrderInfo.SEQ.itemSeq=-1;OrderInfo.SEQ.acctSeq=-1;OrderInfo.SEQ.acctCdSeq=-1;OrderInfo.SEQ.paramSeq=-1;OrderInfo.SEQ.atomActionSeq=-1};var X=function(){OrderInfo.boProdAns=[];OrderInfo.boProd2Tds=[];OrderInfo.bo2Coupons=[];AttachOffer.openList=[];AttachOffer.openedList=[];AttachOffer.openServList=[];AttachOffer.openedServList=[];AttachOffer.openAppList=[];AttachOffer.labelList=[];OrderInfo.confirmList=[];OrderInfo.orderResult={}};var ap=function(aL,aO,aP,aN,aM){if(aL!=""&&aL!=undefined){OrderInfo.actionClassCd=aL}if(aO!=""&&aO!=undefined){OrderInfo.boActionTypeCd=aO}if(aP!=undefined){OrderInfo.actionFlag=aP}if(aN!=""&&aN!=undefined){OrderInfo.actionTypeName=aN}if(aM!=""&&aM!=undefined){OrderInfo.order.templateType=aM}};var ab=function(aO){var aL={};for(var aM=0;aM<OrderInfo.boProdAns.length;aM++){var aN=OrderInfo.boProdAns[aM];if(aN==undefined){continue}else{if(aN.prodId==aO){aL=aN}}}return aL};var u=function(aM,aL){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==aM){this.an=aL;return false}})})};var I=function(aL){try{if(stepOrder.main.isStepOrder){return stepOrder.main.areaId}}catch(aM){}if(aL!=undefined&&aL>0){var aN=order.prodModify.choosedProdInfo.areaId;if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&order.service.oldMemberFlag){if(ec.util.isObj(OrderInfo.cust.areaId)){aN=OrderInfo.cust.areaId}else{aN=OrderInfo.staff.soAreaId}}if(aN==undefined||aN==""){$.alert("错误提示","产品信息未返回地区ID，请营业后台核实！");return}return aN}else{if(ec.util.isObj(OrderInfo.cust.areaId)){return OrderInfo.cust.areaId}else{return OrderInfo.staff.soAreaId}}};var ax=function(){var aL=OrderInfo.staff.soAreaId;
if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){}else{if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==4||OrderInfo.actionFlag==9){if(ec.util.isObj(OrderInfo.cust.areaId)){aL=OrderInfo.cust.areaId}}else{if(ec.util.isObj(order.prodModify.choosedProdInfo.areaId)){aL=order.prodModify.choosedProdInfo.areaId}}}return aL};var aq=function(aM){for(var aL=0;aL<OrderInfo.boProd2OldTds.length;aL++){var aN=OrderInfo.boProd2OldTds[aL];if(aN.prodId==aM){return aN}}return{}};var L=function(aM){for(var aL=0;aL<OrderInfo.boProd2Tds.length;aL++){var aN=OrderInfo.boProd2Tds[aL];if(aN.prodId==aM){return aN}}return{}};var af=function(aM){for(var aL=0;aL<OrderInfo.boProd2Tds.length;aL++){var aN=OrderInfo.boProd2Tds[aL];if(aN.prodId==aM){OrderInfo.boProd2Tds.splice(aL,1)}}};var aa=function(aM){for(var aL=0;aL<OrderInfo.boProd2Tds.length;aL++){var aN=OrderInfo.boProd2Tds[aL];if(aN.prodId==aM){return aN.terminalCode}}return""};var aD=function(aP){var aM=true;for(var aO=0;aO<OrderInfo.bo2Coupons.length;aO++){var aN=OrderInfo.bo2Coupons[aO];if(aN.prodId==aP){aM=false;return aN}}if(aM){var aL={prodId:aP,coupons:[]};OrderInfo.bo2Coupons.push(aL);return aL}};var V=function(aP){var aM=true;for(var aO=0;aO<OrderInfo.bo2Coupons.length;aO++){var aN=OrderInfo.bo2Coupons[aO];if(aN.prodId==aP){aN.coupons=[];return aN}}if(aM){var aL={prodId:aP,coupons:[]};OrderInfo.bo2Coupons.push(aL);return aL}};var aI=function(aO){var aL="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){$.each(OrderInfo.oldoffer,function(){var aQ=this;$.each(aQ.offerMemberInfos,function(){if(this.objInstId==aO){aL=this.accessNumber;return false}})})}else{for(var aM=0;aM<OrderInfo.boProdAns.length;aM++){var aN=OrderInfo.boProdAns[aM];if(aN.prodId==aO){if(aN.accessNumber!=undefined){aL=aN.accessNumber}}}}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){var aP="'"+aO+"'";if(aP.indexOf("-")!=-1){for(var aM=0;aM<OrderInfo.boProdAns.length;aM++){var aN=OrderInfo.boProdAns[aM];if(aN.prodId==aO){if(aN.accessNumber!=undefined){aL=aN.accessNumber}}}}else{$.each(OrderInfo.offer.offerMemberInfos,function(aQ){if(this.objInstId==aO){aL=this.accessNumber;return false}});if((aL==undefined||aL=="")&&offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==aO){aL=this.accessNumber;return false}})})}}}else{if(aO!=undefined&&aO>0){aL=order.prodModify.choosedProdInfo.accNbr}else{if(aO!=undefined&&aO>0){aL=order.prodModify.choosedProdInfo.accNbr}}}}return aL};var w=function(aO){var aL="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){$.each(OrderInfo.oldoffer,function(){var aP=this;$.each(aP.offerMemberInfos,function(){if(this.objInstId==aO){aL=this.accessNumber;return false}})})}else{for(var aM=0;aM<OrderInfo.boProdAns.length;aM++){var aN=OrderInfo.boProdAns[aM];if(aN.prodId==aO){if(aN.accessNumber!=undefined){aL=aN.accessNumber}}}}}else{if(OrderInfo.actionFlag==6||OrderInfo.actionFlag==2){for(var aM=0;aM<OrderInfo.boProdAns.length;aM++){var aN=OrderInfo.boProdAns[aM];if(aN.prodId==aO){if(aN.accessNumber!=undefined){aL=aN.accessNumber}}}$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==aO){aL=this.accNbr;return false}});$.each(OrderInfo.offer.offerMemberInfos,function(aP){if(this.objInstId==aO){aL=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.offer.offerMemberInfos,function(aP){if(this.objInstId==aO){aL=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==35){aL=stepOrder.main.getAccessNumber(aO)}else{if(aO!=undefined&&aO>0){aL=order.prodModify.choosedProdInfo.accNbr}}}}}return aL};var q=function(aO){var aL="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var aM=0;aM<OrderInfo.boProdAns.length;aM++){var aN=OrderInfo.boProdAns[aM];if(aN.prodId==aO){if(aN.areaCode!=undefined){aL=aN.areaCode}}}}else{if(aO!=undefined&&aO>0){aL=order.prodModify.choosedProdInfo.areaCode}}if(aL==undefined||aL==""){aL=OrderInfo.staff.areaCode}return aL};var N=function(aL){var aM="";$.each(OrderInfo.boProdAns,function(){if(this.memberRoleCd==aL){aM=this.accessNumber;return false}});if(aM==undefined||aM==""){aM=OrderInfo.boProdAns[0].accessNumber}return aM};var F=function(aM){var aL="";if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){if(OrderInfo.offer.offerMemberInfos!=undefined){$.each(OrderInfo.offer.offerMemberInfos,function(aN){if(this.objInstId==aM){aL=this.roleName;return false}})}}else{if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(aO){var aN=this.offerRoleName;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==aM){aL=aN;return false}})}})}}return aL};var ao=function(aM){var aL={};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(aN){if(this.objInstId==aM){aL=this;aL.accNbr=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==3){aL=order.prodModify.choosedProdInfo}else{$.each(OrderInfo.offerSpec.offerRoles,function(aN){if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==aM){aL=this;return false}})}})}}return aL};var T=function(aM){var aL=CONST.PROD_SPEC.CDMA;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==aM){aL=this.objId;return false}})})}else{if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(aN){if(this.objInstId==aM){aL=this.objId;return false}});if(offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==aM){aL=this.objId;return false}})})}if(offerChange.newMemberFlag){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==aM){aL=this.objId;return false}})})}}else{if(aM!=undefined&&aM>0){aL=order.prodModify.choosedProdInfo.productId}}}return aL};var j=function(aL){if(OrderInfo.privilege.effTime==""){var aM={manageCode:aL};return query.offer.checkOperate(aM)}};return{state:aE,delViceCard:b,newClothes:at,oldMember:K,objInstId:Z,terminalCode:aB,newPhoneId:Q,mktResInstCode:az,viceParam:t,acctId:l,acctCd:g,order:ak,SEQ:C,resetSeq:i,resetData:X,orderResult:O,cust:am,staff:a,offerSpec:ae,offer:J,attach2Coupons:e,boCustInfos:aF,boCustIdentities:M,boPartyContactInfo:U,boCustProfiles:aK,boCusts:W,boProdItems:R,boProdPasswords:aA,boProdAns:ai,boProd2Tds:ah,bo2Coupons:d,boProd2OldTds:aJ,clearProdUim:af,orderData:y,getOrderData:x,actionClassCd:D,boActionTypeCd:h,actionFlag:H,actionTypeName:Y,initData:ap,getOfferBusiOrder:aH,getProdBusiOrder:P,createCust:aC,createAcct:f,getProdAn:ab,getProdTd:aa,getProdUim:L,getProdOldUim:aq,getProdAreaId:I,getProdCoupon:aD,getProdInst:ao,getAccessNumber:w,getAreaCode:q,getAreaId:ax,getOfferRoleName:F,getAccNbrByRoleCd:N,getProdSpecId:T,getPrivilege:j,initProdCoupon:V,setProdAn:u,setProdModifyBusiOrder:E,confirmList:ac,businessName:G,password_remark:ad,privilege:v,offerProdInst:B,orderlonger:k,busitypeflag:aG,checkresult:r,custorderlonger:al,prodAttrs:ar,provinceInfo:z,reloadOrderInfo:ay,reloadProdInfo:ag,memberChangeInfo:o,newOrderNumInfo:m,oldSubPhoneNum:c,oldprodInstInfos:av,oldofferSpec:an,oldoffer:p,oldprodAcctInfos:au,oldAddNumList:S,surplusNum:s,oldSubPhoneNum:c,codeInfos:aj,getChannelList:A,channelList:aw}})();CommonUtils.regNamespace("SoOrder");SoOrder=(function(){var S=function(){if(query.offer.loadInst()){SoOrder.initFillPage();return true}else{return false}};var u="";var l=function(){SoOrder.initOrderData();OrderInfo.order.step=2;if(OrderInfo.actionFlag==1){try{common.callTitle(3)}catch(X){}}G()};var F=function(){OrderInfo.resetSeq();OrderInfo.resetData();OrderInfo.orderResult={};OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;
OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.getAreaId()};var w=function(Y){if(L(Y)){var X=contextPath+"/order/orderSubmit";if(OrderInfo.order.token!=""){X=contextPath+"/token/app/order/orderSubmit?token="+OrderInfo.order.token}$.callServiceAsJson(X,JSON.stringify(OrderInfo.orderData),{before:function(){$.ecOverlay("<strong>订单提交中，请稍等...</strong>")},done:function(ab){$.unecOverlay();G();if(ab.code==0){var ae=ab.data;if(OrderInfo.actionFlag==8||OrderInfo.actionFlag==4){if(ae.resultCode==0){if(OrderInfo.actionFlag==8){$.alert("信息提示","客户创建成功");common.saveCust()}else{$.alert("信息提示","客户修改成功")}}else{$.alert("信息提示",ae.resultMsg)}}else{if(ae.result.ruleInfos!=undefined&&ae.result.ruleInfos.length>0){var aa="";$.each(ae.result.ruleInfos,function(){aa+=this.ruleDesc+"<br/>"});$.alert("提示",aa);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq()}else{if(ae.checkRule!=undefined){var Z=order.calcharge.tochargeSubmit(ab.data);if(Z.code==0){var ad=I(ab.data);B(ad)}else{ab.data.provCheckError="Y";if(Z.data.resultMsg!=undefined&&$.trim(Z.data.resultMsg)!=""){ab.data.provCheckErrorMsg=Z.data.resultMsg}else{if(Z.data.errMsg!=undefined&&$.trim(Z.data.errMsg)!=""){ab.data.provCheckErrorMsg=Z.data.errMsg;if(Z.data.errCode){ab.data.provCheckErrorMsg="【错误编码："+Z.data.errCode+"】"+ab.data.provCheckErrorMsg}if(Z.data.errData){ab.data.provCheckErrorData=Z.data.errData;try{var ac=$.parseJSON(Z.data.errData);if(ac.resultMsg){ab.data.provCheckErrorMsg+=","+ac.resultMsg}}catch(af){}}if(Z.data.paramMap){ab.data.provCheckErrorMsg+="【入参："+Z.data.paramMap+"】"}}else{ab.data.provCheckErrorMsg="未返回错误信息，可能是下省请求超时，请返回填单页面并稍后重试订单提交。"}}var ad=I(ab.data);B(ad)}}else{var ad=I(ab.data);B(ad)}}}}else{if(ab.code==1002){$.alert("信息提示",ab.data)}else{$.alertM(ab.data);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();$("#order-content").show();$("#order-dealer").hide()}}}})}};var I=function(Z){var Y=contextPath+"/app/order/gotosubmitOrder";$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var X=$.callServiceAsHtml(Y,JSON.stringify(Z));$.unecOverlay();return X.data};var L=function(aq){var ad=[];var aa=[];var Y="N";if(r()){Y="Y"}aa.push({itemSpecId:CONST.BUSI_ORDER_ATTR.THRETOFOUR_ITEM,value:Y});aa.push({itemSpecId:CONST.BUSI_ORDER_ATTR.BUSITYPE_FLAG,value:OrderInfo.busitypeflag});if(!Q()){return false}var al=$("#order_remark").val();if(ec.util.isObj(al)){aa.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:al})}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){A(ad)}else{if(OrderInfo.actionFlag==2){offerChange.changeOffer(ad)}else{if(OrderInfo.actionFlag==3){N(ad);if(ad.length==0){$.alert("提示","没有做任何业务，无法提交");return false}}else{if(OrderInfo.actionFlag==4){V(ad,aq)}else{if(OrderInfo.actionFlag==5){m(ad,aq)}else{if(OrderInfo.actionFlag==6){if(OrderInfo.newClothes=="true"||OrderInfo.oldMember=="true"){var ac=[];var Z=[];var ao=[];if(OrderInfo.delViceCard=="true"){ac=OrderInfo.viceParam.viceParam;Z=OrderInfo.viceParam.ooRoles;ao={viceParam:ac,ooRoles:Z,remark:$("#order_remark").val()}}x(ad,ao)}else{var ac=[];var Z=[];var ao=[];ac=OrderInfo.viceParam.viceParam;Z=OrderInfo.viceParam.ooRoles;ao={viceParam:ac,ooRoles:Z,remark:$("#order_remark").val()};x(ad,ao)}}else{if(OrderInfo.actionFlag==7){J(ad,aq)}else{if(OrderInfo.actionFlag==8){OrderInfo.orderData.orderList.orderListInfo.partyId=-1;OrderInfo.orderData.orderList.orderListInfo.soNbr=UUID.getDataId();i(ad,aq)}else{if(OrderInfo.actionFlag==9){v(ad,aq)}else{if(OrderInfo.actionFlag==10){ad=aq}else{if(OrderInfo.actionFlag==11){ad=aq}else{if(OrderInfo.actionFlag==12){ad=aq}else{if(OrderInfo.actionFlag==16){f(ad)}else{if(OrderInfo.actionFlag==19){g(ad,aq,"N")}else{if(OrderInfo.actionFlag==20){J(ad,aq)}else{if(OrderInfo.actionFlag==21){var ac=[];var Z=[];var ao=[];ac=OrderInfo.viceParam.viceParam;Z=OrderInfo.viceParam.ooRoles;ao={viceParam:ac,ooRoles:Z,remark:$("#order_remark").val()};U(ad,ao)}else{if(OrderInfo.actionFlag==22){ad=aq}else{if(OrderInfo.actionFlag==23){ad=aq;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.staff.areaId;var ab=$("#custInfos").attr("corCustId");if(ec.util.isObj(ab)){var am={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_CUST_ID,value:ab};aa.push(am)}var aj=$("#custInfos").attr("extCustId");if(ec.util.isObj(aj)){var ak={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_CUST_ID,value:aj};aa.push(ak)}var ap=order.prodModify.choosedProdInfo.extProdInstId;if(ec.util.isObj(ap)){var ai={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_PROD_INST_ID,value:ap};aa.push(ai)}var X=order.prodModify.choosedProdInfo.corProdInstId;if(ec.util.isObj(X)){var ah={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_PROD_INST_ID,value:X};aa.push(ah)}var an=order.prodModify.choosedProdInfo.extCouponInstanceId;if(ec.util.isObj(an)){var ag={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_COUPON_INST_ID,value:an};aa.push(ag)}var ae=order.prodModify.choosedProdInfo.corCouponInstanceId;if(ec.util.isObj(ae)){var af={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_COUPON_INST_ID,value:ae};aa.push(af)}}else{g(ad,aq,"N")}}}}}}}}}}}}}}}}}}OrderInfo.orderData.orderList.orderListInfo.custOrderAttrs=aa;OrderInfo.orderData.orderList.orderListInfo.extCustOrderId=OrderInfo.provinceInfo.provIsale;OrderInfo.orderData.orderList.custOrderList[0].busiOrder=ad;if($("#isTemplateOrder").attr("checked")=="checked"){OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="Y";OrderInfo.orderData.orderList.orderListInfo.templateOrderName=$("#templateOrderName").val();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){OrderInfo.orderData.orderList.orderListInfo.templateType=$("#templateOrderDiv").find("select").val()}else{if(OrderInfo.actionFlag==2){OrderInfo.orderData.orderList.orderListInfo.templateType=5}else{if(OrderInfo.actionFlag==3){OrderInfo.orderData.orderList.orderListInfo.templateType=2}}}}else{OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="N"}if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){OrderInfo.orderData.orderList.orderListInfo.soNbr=OrderInfo.order.soNbr}return true};var a=function(Z){var aa=Z.coupons;OrderInfo.getOrderData();var X=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;if(OrderInfo.cust.custId==-1){OrderInfo.createCust(X)}else{if(OrderInfo.cust.custId!=undefined&&OrderInfo.cust.custId!=""){OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId}else{OrderInfo.orderData.orderList.orderListInfo.partyId=CONST.CUST_COUPON_SALE}}if(OrderInfo.actionFlag==18){OrderInfo.orderData.orderList.orderListInfo.partyId=aa[0].partyId}var Y={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:Z.busiObj,boActionType:Z.boActionType,data:{bo2Coupons:[]}};Y.data.bo2Coupons=aa;if(Z.dealers){Y.data.busiOrderAttrs=Z.dealers}X.push(Y)};var B=function(ae){SoOrder.step(2,ae);SoOrder.delOrderBegin();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> 套餐名称</h4><p class="list-group-item-text">'+OrderInfo.offerSpec.offerSpecName+"</p></li>");$("#tital").html("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName);$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> '+this.offerRoleName+'</h4><p class="list-group-item-text">'+OrderInfo.getProdAn(this.prodInstId).accessNumber+"</p></li>")})})}else{if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#order_prepare").hide();$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端名称：</div><div class="ui-block-b">'+OrderInfo.businessName+"</div></div>");var X=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;var Z=undefined;if(OrderInfo.actionFlag==13){for(var af=0;af<X.length;af++){var ai=X[af].boActionType;if(ai.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&ai.boActionTypeCd==CONST.BO_ACTION_TYPE.COUPON_SALE){Z=X[af].data.bo2Coupons}}$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端串码：</div><div class="ui-block-b">'+Z[0].couponInstanceNumber+"</div></div>")
}else{if(OrderInfo.actionFlag==17){for(var af=0;af<X.length;af++){var ai=X[af].boActionType;if(ai.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&ai.boActionTypeCd==CONST.BO_ACTION_TYPE.RETURN_COUPON){Z=X[af].data.bo2Coupons}}$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端串码：</div><div class="ui-block-b">'+Z[0].couponInstanceNumber+"</div></div>")}else{if(OrderInfo.actionFlag==18){for(var af=0;af<X.length;af++){var ai=X[af].boActionType;if(ai.boActionTypeCd==CONST.BO_ACTION_TYPE.EXCHANGE_COUPON){Z=X[af].data.bo2Coupons}}var Y=null;var aa=null;if(Z[0].state=="DEL"){Y=Z[0];aa=Z[1]}else{Y=Z[1];aa=Z[0]}$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">旧终端串码：</div><div class="ui-block-b">'+Y.couponInstanceNumber+"</div></div>");$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新终端串码：</div><div class="ui-block-b">'+aa.couponInstanceNumber+"</div></div>")}}}var ah=$("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName);$("#tital").append(ah)}else{var ag=order.prodModify.choosedProdInfo;$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> 套餐名称</h4><p class="list-group-item-text">'+ag.prodOfferName+"</p></li>");$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading"> 手机号码</h4><p class="list-group-item-text">'+ag.accNbr+"</p></li>");if(OrderInfo.actionFlag==2){OrderInfo.actionTypeName="套餐变更";$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading">新套餐名称</h4><p class="list-group-item-text">'+OrderInfo.offerSpec.offerSpecName+"</p></li>");$("#accNbrTr").hide();for(var af=0;af<OrderInfo.offer.offerMemberInfos.length;af++){var ad=OrderInfo.offer.offerMemberInfos[af];if(ad.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading">'+ad.roleName+'号码</h4><p class="list-group-item-text">'+ad.accessNumber+"</p></li>")}}}else{if(OrderInfo.actionFlag==3){OrderInfo.actionTypeName="订购/退订可选包与功能产品"}else{if(OrderInfo.actionFlag==4||OrderInfo.actionFlag==8){$("#offerSpecName").hide();$("#accNbrTr").hide()}else{if(OrderInfo.actionFlag==5){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.isRemove=="Y"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除副卡号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}else{$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==6){if(OrderInfo.newClothes=="true"||OrderInfo.oldMember=="true"){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading">'+this.roleName+'号码：</h4><p class="list-group-item-text">'+this.accessNumber+"</p></li>")}});$.each(OrderInfo.boProdAns,function(){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading">纳入副卡号码：</h4><p class="list-group-item-text">'+this.accessNumber+"</p></li>")});if(ec.util.isArray(OrderInfo.oldAddNumList)){for(var ac=0;ac<OrderInfo.oldoffer.length;ac++){for(var af=0;af<OrderInfo.oldoffer[ac].offerMemberInfos.length;af++){var ad=OrderInfo.oldoffer[ac].offerMemberInfos[af];if(ad.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading">纳入副卡号码：</h4><p class="list-group-item-text">'+ad.accessNumber+"</p></li>")}}}}if(ec.util.isArray(OrderInfo.choosedNumList)&&ec.util.isArray(OrderInfo.viceprodInstInfos)&&OrderInfo.oldMvFlag){for(var af=0;af<OrderInfo.choosedNumList.length;af++){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading">纳入副卡号码：</h4><p class="list-group-item-text">'+OrderInfo.choosedNumList[af].accNbr+"</p></li>")}}}if(OrderInfo.delViceCard=="true"){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading">新套餐名称：</h4><p class="list-group-item-text">'+this.offerSpecName+"</p></li>")})}$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var al="";var ak="";var am=this.objInstId;$.each(u,function(an,ao){if(ao.objInstId==am&&ao.knew=="Y"){al="Y"}if(ao.objInstId==am&&ao.del=="Y"){ak="Y"}});if(al=="Y"){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> 订购'+this.roleName+'号码：</h4><p class="list-group-item-text">'+this.accessNumber+"</p></li>")}else{if(ak=="Y"){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> 拆除'+this.roleName+'号码：</h4><p class="list-group-item-text">'+this.accessNumber+"</p></li>")}}}}})}OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==7){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div> ")}else{var ak="";var al=this.accessNumber;$.each(u,function(am,an){if(an.accessNumber==al&&an.del=="N"){ak="N"}});if(ak=="N"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}else{$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div> ")}}}});OrderInfo.actionTypeName=CONST.getBoActionTypeName(OrderInfo.boActionTypeCd)}else{if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading">新套餐名称：</h4><p class="list-group-item-text">'+this.offerSpecName+"</p></li>")})}$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var al="";var ak="";var am=this.objInstId;$.each(u,function(an,ao){if(ao.objInstId==am&&ao.knew=="Y"){al="Y"}if(ao.objInstId==am&&ao.del=="Y"){ak="Y"}});if(al=="Y"){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> 订购'+this.roleName+'号码：</h4><p class="list-group-item-text">'+this.accessNumber+"</p></li>")}else{if(ak=="Y"){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> 拆除'+this.roleName+'号码：</h4><p class="list-group-item-text">'+this.accessNumber+"</p></li>")}}}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==20){$("#accNbrTr").hide();for(var af=0;af<OrderInfo.offer.offerMemberInfos.length;af++){var ad=OrderInfo.offer.offerMemberInfos[af];if(ad.objType==CONST.OBJ_TYPE.PROD){if(ad.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+ad.roleName+'号码：</div><div class="ui-block-b">'+ad.accessNumber+"</div></div> ")}else{$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+ad.roleName+'号码：</div><div class="ui-block-b">'+ad.accessNumber+"</div></div>")}}}OrderInfo.actionTypeName="返销"}else{if(OrderInfo.actionFlag==12){$("#accNbrTr").hide();for(var af=0;af<OrderInfo.confirmList.length;af++){var ag=OrderInfo.confirmList[af];
for(var ac=0;ac<ag.accNbr.length;ac++){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+ag.name+'：</div><div class="ui-block-b">'+ag.accNbr[ac]+"</div></div>")}}}else{if(OrderInfo.actionFlag==16){OrderInfo.actionTypeName="改号";$.each(OrderInfo.boProdAns,function(){if(this.state=="ADD"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}})}else{if(OrderInfo.actionFlag==0&&OrderInfo.actionTypeName=="拆机"){$("#accNbrTr").hide();var aj="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&this.objInstId==order.prodModify.choosedProdInfo.prodInstId){aj="Y"}});if(aj=="Y"){$.each(OrderInfo.offer.offerMemberInfos,function(){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")})}OrderInfo.actionTypeName="拆机"}}}}}}}}}}}var ah=$("<span>订单确认</span>");$("#tital").append(ah)}}var ab=true;if($("#ruleTbody tr").length>0){$("#ruleTbody tr").each(function(){var ak=$(this).attr("ruleLevel");if(ak=="1"){ab=false;return false}})}if(ec.util.isObj($("#provCheckErrorMsg").html())){ab=false}if(ab){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){O()}else{if(OrderInfo.actionFlag==2){W()}else{if(OrderInfo.actionFlag==3){d()}else{if(OrderInfo.actionFlag==6){o()}else{if(OrderInfo.orderResult.autoBoInfos!=undefined&&OrderInfo.orderResult.autoBoInfos.length>0){$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));$.each(OrderInfo.orderResult.autoBoInfos,function(){$("#chooseTable").append($('<tr><td width="50%">'+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))})}}}}}}};var T=function(X,Z){for(var Y=1;Y<4;Y++){$("#step"+Y).hide()}$("#step"+X).show()};var D=function(X,Y){if(X==0){$("#orderedprod").hide();$("#order_prepare").hide();$("#order_fill_content").hide();$("#order_tab_panel_content").html(Y).show();X++}else{if(X==1){$("#order_prepare").hide();$("#order_confirm").hide();$("#order_fill").show()}else{if(X==2){$("#order-content").hide();$("#order-dealer").hide();$("#order-confirm").html(Y).show();OrderInfo.order.step=3}}}};var O=function(){var X=0;$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(X==0){$("#orderTbody").after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.prodInstId}else{$("#"+X).after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.prodInstId}$("#chooseTable_"+this.prodInstId).append($('<thead><tr><th  style="width: 60%;">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr></thead>"));k(this.prodInstId)})})};var o=function(){var X=0;if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(X==0){$("#orderTbody").after($('<table id="chooseTable_'+this.objInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.objInstId}else{$("#"+X).after($('<table id="chooseTable_'+this.objInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.objInstId}$("#chooseTable_"+this.objInstId).append($('<thead><tr><th  style="width: 60%;">业务名称('+this.roleName+")</th><th>业务动作</th></tr></thead>"));k(this.objInstId)}})})}else{$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){$.each(this.prodInsts,function(){if(X==0){$("#orderTbody").after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.prodInstId}else{$("#"+X).after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.prodInstId}$("#chooseTable_"+this.prodInstId).append($('<thead><tr><th  style="width: 60%;">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr></thead>"));k(this.prodInstId)})}})}};var W=function(){var X=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(X==0){$("#orderTbody").after($('<table id="chooseTable_'+this.objInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.objInstId}else{$("#"+X).after($('<table id="chooseTable_'+this.objInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.objInstId}$("#chooseTable_"+this.objInstId).append($('<thead><tr><th  style="width: 60%;">业务名称('+this.roleName+")</th><th>业务动作</th></tr></thead>"));k(this.objInstId)}})};var d=function(){var X=order.prodModify.choosedProdInfo;if(X==undefined||X.prodInstId==undefined){return true}$("#orderTbody").after($('<table id="chooseTable_'+X.prodInstId+'" class="table table-bordered tablecenter"></table>'));$("#chooseTable_"+X.prodInstId).append($('<thead><tr><th  style="width: 60%;">业务名称</th><th>业务动作</th></tr></thead>'));k(X.prodInstId)};var k=function(ac){var ab=CacheData.getOfferSpecList(ac);var Y=CacheData.getOfferList(ac);var X=CacheData.getServSpecList(ac);var aa=CacheData.getServList(ac);var Z=CacheData.getOpenAppList(ac);$("#chooseTable_"+ac).append("<tbody>");if(ab!=undefined&&ab.length>0){$.each(ab,function(){if(this.isdel!="Y"&&this.isdel!="C"){$("#chooseTable_"+ac).append($("<tr><td>"+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_BUY+"</td></tr>"))}})}if(Y!=undefined&&Y.length>0){$.each(Y,function(){if(this.isdel=="Y"){$("#chooseTable_"+ac).append($("<tr><td>"+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_DEL+"</td></tr>"))}else{if(this.update=="Y"){$("#chooseTable_"+ac).append($("<tr><td>"+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_UPDATE+"</td></tr>"))}}})}if(X!=undefined&&X.length>0){$.each(X,function(){if(this.isdel!="Y"&&this.isdel!="C"){$("#chooseTable_"+ac).append($("<tr><td>"+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(aa!=undefined&&aa.length>0){$.each(aa,function(){if(this.isdel=="Y"){$("#chooseTable_"+ac).append($("<tr><td>"+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_CLOSE+"</td></tr>"))}else{if(this.update=="Y"){$("#chooseTable_"+ac).append($("<tr><td>"+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_UPDATE+"</td></tr>"))}}})}if(Z!=undefined&&Z.length>0){$.each(Z,function(){if(this.dfQty==1){$("#chooseTable_"+ac).append($("<tr><td>"+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(OrderInfo.orderResult.autoBoInfos!=undefined){$.each(OrderInfo.orderResult.autoBoInfos,function(){if(this.instAccessNumber==OrderInfo.getAccessNumber(ac)){$("#chooseTable_"+ac).append($("<tr><td>"+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))}})}$("#chooseTable_"+ac).append("</tbody>")};var z=function(){SoOrder.delOrderFin();$("#order-content").show();$("#order-confirm").hide();OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();SoOrder.delOrder();G();if(CONST.getAppDesc()!=0){if($("#a-cust-modify")[0]){$("#a-cust-modify").show()}}};var H=function(){var X=OrderInfo.orderResult.olId;if(X!=0&&X!=undefined){var Y={olId:X,areaId:OrderInfo.getAreaId()};$.callServiceAsJsonGet(contextPath+"/app/order/delOrder",Y,{done:function(Z){if(Z.code==0){if(Z.data.resultCode==0){$.alert("提示","购物车作废成功！");OrderInfo.order.step=2}}else{if(Z.code==-2){$.alertM(Z.data.errData)}else{$.alert("提示","购物车作废失败！")}}},fail:function(Z){$.alert("提示","信息","请求可能发生异常，请稍后再试")}})}};var P=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,OrderInfo.orderResult.olId);$("a[href^='/']").off("mousedown").on("mousedown",function(){SoOrder.delOrderSilent();window.location.href=this.href});$(window).off("unload").on("unload",function(){SoOrder.delOrderSilent()})};var C=function(){var ab=$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID);$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);if(ab!=0&&ab!=undefined&&ab!=null){var ad={olId:ab,areaId:OrderInfo.getAreaId(),flag:"U"};
var X=$.callServiceAsJsonGet(contextPath+"/order/delOrder",ad);var ac=[];for(var aa=0;aa<OrderInfo.boProdAns.length;aa++){var Z={accNbr:OrderInfo.boProdAns[aa].accessNumber,accNbrType:1,action:"UPDATE"};ac.push(Z)}if(ac.length>0){var Y=contextPath+"/common/updateResState";$.callServiceAsJsonGet(Y,{strParam:JSON.stringify(ac)},{done:function(ae){if(ae.code==0){if(ae.data){}}}})}OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();G();SoOrder.delOrderFin()}};var y=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);$("a[href^='/']").off("mousedown");$(window).off("unload")};var m=function(X,Z){var Y=order.prodModify.choosedProdInfo;var aa={offerSpecId:Y.prodOfferId,offerId:Y.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:Z};OrderInfo.getOfferBusiOrder(X,aa,Z[0].objInstId,null,2);$.each(Z,function(){var ab={prodId:this.objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};X.push(OrderInfo.getProdBusiOrder(ab));$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.objInstId==prodId){this.isRemove="Y";return false}})})};var U=function(aj,ac){var X="";var ak=ac.viceParam;u=ak;var ag=ac.ooRoles;var ai=order.prodModify.choosedProdInfo;var Z={offerSpecId:ai.prodOfferId,offerId:ai.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:ac.ooRoles};$.each(OrderInfo.offer.offerMemberInfos,function(al){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){X=this.objInstId;return false}});OrderInfo.getOfferBusiOrder(aj,Z,X,null,2);for(var ad=0;ad<ak.length;ad++){if(ak[ad].knew=="Y"){var Y=ak[ad];var ae="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==Y.objInstId){ae=this.accessNumber}});var af={areaId:ai.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:Y.offerSpecId,objName:Y.offerSpecName,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};if(ec.util.isObj(ae)){af.busiObj.accessNumber=ae}for(var ab=0;ab<OrderInfo.offer.offerMemberInfos.length;ab++){var aa=OrderInfo.offer.offerMemberInfos[ab];if(aa.objInstId==Y.objInstId){var ag={objId:aa.objId,objInstId:aa.objInstId,objType:aa.objType,offerRoleId:Y.offerRoleId,state:"ADD"};af.data.ooRoles.push(ag);break}}aj.push(af)}else{var ah={prodId:ak[ad].objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};aj.push(OrderInfo.getProdBusiOrder(ah,2))}if(order.memberChange.getSimulateData()){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){var al=this.prodId;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(al==this.objInstId&&this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId,"delViceCard")&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var am={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var an=OrderInfo.getProdBusiOrder(am);if(an){aj.push(an)}}}})}})}AttachOffer.setAttachBusiOrder(aj,null,1)}}};var g=function(af,ab,Z){var ad=order.prodModify.choosedProdInfo;var ac=OrderInfo.boActionTypeCd;var Y=ad.productId;var aa=ad.prodInstId;var ae=OrderInfo.actionClassCd;if(ac==CONST.BO_ACTION_TYPE.ADDOREXIT_COMP){Y=ad.prodOfferId;aa=ad.prodOfferInstId;ae=CONST.ACTION_CLASS_CD.OFFER_ACTION}var X={areaId:OrderInfo.getProdAreaId(ad.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:Y,instId:aa,isComp:Z,accessNumber:ad.accNbr,offerTypeCd:"1"},boActionType:{actionClassCd:ae,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};X.data=ab;af.push(X)};var A=function(aa){if(OrderInfo.cust.custId==-1){OrderInfo.createCust(aa)}var Y=-1;if(Y<0&&Y!=undefined){OrderInfo.createAcct(aa,Y)}var ab=q(aa);for(var Z=0;Z<ab.data.ooRoles.length;Z++){var X=ab.data.ooRoles[Z];if(X.objType==2){aa.push(p(X.objInstId,X.objId))}}AttachOffer.setAttachBusiOrder(aa)};var G=function(){var X=$.callServiceAsHtmlGet(contextPath+"/common/getToken");OrderInfo.order.token=X.data};var c=function(){var X=$.callServiceAsHtmlGet(contextPath+"/common/getToken");OrderInfo.order.token=X.data};var x=function(ah,au){var ar=order.prodModify.choosedProdInfo;var ag={areaId:ar.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ar.prodOfferId,instId:ar.prodOfferInstId,accessNumber:ar.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP},data:{ooRoles:[]}};if(OrderInfo.oldMember=="true"){var an="";for(var ao=0;ao<OrderInfo.offerSpec.offerRoles.length;ao++){var al=OrderInfo.offerSpec.offerRoles[ao];if(al.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){an=al.offerRoleId;break}}var Y=(OrderInfo.hasMainCarFlag)?CONST.BO_ACTION_TYPE.DEL_OFFER:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;for(var aj=0;aj<OrderInfo.oldprodInstInfos.length;aj++){var ai=OrderInfo.oldprodInstInfos[aj];var Z={areaId:ai.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ai.mainProdOfferInstInfos[0].prodOfferId,instId:ai.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:ai.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:Y},data:{ooRoles:[]}};var at=-1;for(var ao=0;ao<OrderInfo.oldoffer.length;ao++){if(OrderInfo.oldoffer[ao].accNbr==ai.accNbr){$.each(OrderInfo.oldoffer[ao].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var av={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:at,offerRoleId:an,state:"ADD"};ag.data.ooRoles.push(av);var aw={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};Z.data.ooRoles.push(aw);--at}})}}ah.push(Z)}if(CONST.getAppDesc()==0){for(var ao=0;ao<OrderInfo.oldoffer.length;ao++){$.each(OrderInfo.oldoffer[ao].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId,"olemember")&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var av={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var aw=OrderInfo.getProdBusiOrder(av);if(aw){ah.push(aw)}}}})}}}if(OrderInfo.newClothes=="true"){for(var ao=0;ao<OrderInfo.offerSpec.offerRoles.length;ao++){var al=OrderInfo.offerSpec.offerRoles[ao];if(al.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(al.prodInsts!=undefined&&al.prodInsts.length>0){for(var am=0;am<al.prodInsts.length;am++){var ab=al.prodInsts[am];var ac={objId:ab.objId,objInstId:ab.prodInstId,objType:ab.objType,offerMemberId:OrderInfo.SEQ.offerMemberSeq--,offerRoleId:ab.offerRoleId,state:"ADD"};ag.data.ooRoles.push(ac);ah.push(p(ab.prodInstId,ab.objId))}}}}}if(OrderInfo.delViceCard=="true"&&au!=null){var ae=au.viceParam;u=ae;var aa=au.ooRoles;$.each(aa,function(){ag.data.ooRoles.push(this)});for(var ao=0;ao<ae.length;ao++){if(ae[ao].knew=="Y"){var X=ae[ao];var af="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==X.objInstId){af=this.accessNumber}});var ap={areaId:ar.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:X.offerSpecId,objName:X.offerSpecName,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};if(ec.util.isObj(af)){ap.busiObj.accessNumber=af}for(var am=0;am<OrderInfo.offer.offerMemberInfos.length;am++){var ak=OrderInfo.offer.offerMemberInfos[am];
if(ak.objInstId==X.objInstId){var aa={objId:ak.objId,objInstId:ak.objInstId,objType:ak.objType,offerRoleId:X.offerRoleId,state:"ADD"};ap.data.ooRoles.push(aa);break}}var aq=$("tr[name='tr_"+X.offerSpecId+"']");if(aq!=undefined){ap.data.busiOrderAttrs=[];aq.each(function(){var av={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};ap.data.busiOrderAttrs.push(av);var aw={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};ap.data.busiOrderAttrs.push(aw)})}ah.push(ap)}else{var ad={prodId:ae[ao].objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};ah.push(OrderInfo.getProdBusiOrder(ad))}}if(order.memberChange.getSimulateData()){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){var av=this.prodId;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(av==this.objInstId&&this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId,"delViceCard")&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var aw={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var ax=OrderInfo.getProdBusiOrder(aw);if(ax){ah.push(ax)}}}})}})}}}AttachOffer.setAttachBusiOrder(ah);ah.push(ag)};var J=function(al,am){var an=am;var ae="";var Y=true;var ak=CONST.ACTION_CLASS_CD.OFFER_ACTION;var aj=CONST.BO_ACTION_TYPE.DEL_OFFER;var Z=CONST.ACTION_CLASS_CD.OFFER_ACTION;var ai=CONST.BO_ACTION_TYPE.BUY_OFFER;if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){ak=CONST.ACTION_CLASS_CD.PROD_ACTION;aj=CONST.BO_ACTION_TYPE.BUY_BACK;Z=CONST.ACTION_CLASS_CD.OFFER_ACTION;ai=CONST.BO_ACTION_TYPE.BUY_OFFER;v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.BUY_BACK;an=am.viceParam;ae=am.remark}else{if(OrderInfo.actionFlag==7){v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.REMOVE_PROD}}for(var ad=0;ad<an.length;ad++){var aa=an[ad];if(aa.del=="N"){Y=false}}if(Y){u=an;var X={areaId:OrderInfo.getProdAreaId(order.prodModify.choosedProdInfo.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,objId:order.prodModify.choosedProdInfo.productId,instId:order.prodModify.choosedProdInfo.prodInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:order.prodModify.choosedProdInfo.prodStateCd,state:"DEL"},{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};al.push(X);for(var ad=0;ad<an.length;ad++){var aa=an[ad];var X={areaId:OrderInfo.getProdAreaId(aa.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:aa.accessNumber,objId:aa.objId,instId:aa.objInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};al.push(X)}return}if(OrderInfo.actionFlag==7){u=an;var ah=order.prodModify.choosedProdInfo;var X={areaId:OrderInfo.getProdAreaId(ah.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ah.prodOfferId,instId:ah.prodOfferInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:ak,boActionTypeCd:aj},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"DEL"}]}};for(var ad=0;ad<OrderInfo.offer.offerMemberInfos.length;ad++){var ac=OrderInfo.offer.offerMemberInfos[ad];var ag={objId:ac.objId,objInstId:ac.objInstId,objType:ac.objType,offerMemberId:ac.offerMemberId,offerRoleId:ac.offerRoleId,state:"DEL"};X.data.ooRoles.push(ag)}al.push(X)}else{var ah=order.prodModify.choosedProdInfo;var X={areaId:OrderInfo.getProdAreaId(ah.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ah.productId,instId:ah.prodInstId,accessNumber:ah.accNbr,isComp:"N"},boActionType:{actionClassCd:ak,boActionTypeCd:aj},data:{boProdStatuses:[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};al.push(X)}for(var ad=0;ad<an.length;ad++){var aa=an[ad];if(aa.del=="N"){var af={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aa.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:Z,boActionTypeCd:ai},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};for(var ab=0;ab<OrderInfo.offer.offerMemberInfos.length;ab++){var ac=OrderInfo.offer.offerMemberInfos[ab];if(ac.objInstId==aa.objInstId){var ag={objId:ac.objId,objInstId:ac.objInstId,objType:ac.objType,offerRoleId:aa.offerRoleId,state:"ADD"};af.data.ooRoles.push(ag);break}}al.push(af)}else{var X={areaId:OrderInfo.getProdAreaId(aa.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:aa.accessNumber,objId:aa.objId,instId:aa.objInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};al.push(X)}}};var N=function(Y){AttachOffer.setAttachBusiOrder(Y);var Z=order.prodModify.choosedProdInfo;if(AttachOffer.isChangeUim(Z.prodInstId)){if(OrderInfo.boProd2Tds.length>0){var X={prodId:Z.prodInstId,prodSpecId:Z.productId,isComp:"N",accessNumber:Z.accNbr,boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};Y.push(OrderInfo.getProdBusiOrder(X))}}};var V=function(X,Z){var Y={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};Y.data=Z;X.push(Y)};var v=function(Y,aa){var Z={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};Z.data=aa;Y.push(Z);var X={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,objId:order.prodModify.choosedProdInfo.productId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACTIVERETURNTWO},data:{}};X.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.READY_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.DONE_PROD,state:"ADD"}];Y.push(X)};var i=function(X,Z){var Y={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};Y.data=Z;X.push(Y)};var q=function(ae){var X={areaId:OrderInfo.getProdAreaId(-1),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.offerSpec.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[],busiOrderAttrs:[]}};var Z=OrderInfo.getAccessNumber(-1);if(ec.util.isObj(Z)){X.busiObj.accessNumber=Z}$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var ah={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,memberRoleCd:this.memberRoleCd,offerRoleId:this.offerRoleId,state:"ADD"};X.data.ooRoles.push(ah);
var ag=this.prodInstId;if(this.servInsts!=undefined&&this.servInsts.length>0){$.each(this.servInsts,function(){var ai={objId:this.objId,objInstId:OrderInfo.SEQ.servSeq--,objType:this.objType,prodId:ag,offerRoleId:this.offerRoleId,state:"ADD"};X.data.ooRoles.push(ai)})}})});var ac=OrderInfo.offerSpec.offerSpecParams;if(ac!=undefined&&ac.length>0){X.data.ooParams=[];for(var ab=0;ab<ac.length;ab++){var Y=ac[ab];var aa={itemSpecId:Y.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:Y.offerSpecParamId,value:Y.value,state:"ADD"};X.data.ooParams.push(aa)}}if(OrderInfo.offerSpec.ooTimes!=undefined){X.data.ooTimes=[];X.data.ooTimes.push(OrderInfo.offerSpec.ooTimes)}var af={partyId:OrderInfo.cust.custId,state:"ADD"};X.data.ooOwners.push(af);var ad=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(ad!=undefined){ad.each(function(){var ag={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};X.data.busiOrderAttrs.push(ag);var ah={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};X.data.busiOrderAttrs.push(ah)})}ae.push(X);return X};var p=function(ad,aj){var X={areaId:OrderInfo.getProdAreaId(ad),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aj,instId:ad,isComp:"N"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:"1"},data:{boProdFeeTypes:[],boProdSpecs:[{prodSpecId:aj,state:"ADD"}],boCusts:[],boProdItems:[],boProdPasswords:[],boProdAns:[],bo2Coupons:[],boAccountRelas:[],boProdStatuses:[],busiOrderAttrs:[]}};var aa=CONST.PROD_STATUS_CD.NORMAL_PROD;X.data.boProdStatuses.push({state:"ADD",prodStatusCd:aa});var Y=OrderInfo.boProdAns;for(var ac=0;ac<Y.length;ac++){if(Y[ac].prodId==ad){X.data.boProdAns.push(Y[ac]);X.busiObj.accessNumber=Y[ac].accessNumber;break}}var ah=OrderInfo.boProd2Tds;for(var ac=0;ac<ah.length;ac++){if(ah[ac].prodId==ad){X.data.bo2Coupons.push(ah[ac]);break}}X.data.boCusts.push({partyId:OrderInfo.cust.custId,partyProductRelaRoleCd:"0",state:"ADD"});var af=$("#pwd_"+ad).val();if(af=="******"||af==undefined||OrderInfo.actionFlag==1){af=order.main.genRandPass6()}var ab={prodPwTypeCd:2,pwd:af,state:"ADD"};X.data.boProdPasswords.push(ab);$("[name=prodSpec_"+ad+"]").each(function(){var al=$(this).attr("id").split("_")[0];var an=$.trim($(this).val());if(an!=""&&an!=undefined){var am={itemSpecId:al,prodSpecItemId:OrderInfo.SEQ.itemSeq--,state:"ADD",value:an};X.data.boProdItems.push(am)}});var ag=$('select[name="pay_type_-1"]').val();if(ag!=undefined){X.data.boProdFeeTypes.push({feeType:ag,state:"ADD"})}var ae;if(OrderInfo.actionFlag==6){var ae;if(OrderInfo.actionFlag==6){ae=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']")}else{ae=$("#dealerTbody tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']")}if(ae!=undefined){ae.each(function(){var al={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};X.data.busiOrderAttrs.push(al);var am={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};X.data.busiOrderAttrs.push(am)})}}var ai=-1;var ak=-1;if(OrderInfo.actionFlag==6){ai=OrderInfo.acctId;ak=OrderInfo.acctCd}var Z={acctId:ai,acctCd:ak,acctRelaTypeCd:"1",chargeItemCd:"0",percent:"100",priority:"1",state:"ADD"};X.data.boAccountRelas.push(Z);return X};var E=function(ac,ab,Y,Z,aa,X){if(Y==1){ac.offerTypeCd=2;ac.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;OrderInfo.getOfferBusiOrder(Z,ac,ab,aa,X)}else{if(Y==2){if(ac.offerSpec.offerSpecParams!=undefined&&ac.offerSpec.offerSpecParams.length>0){ac.offerTypeCd=2;ac.boActionTypeCd=CONST.BO_ACTION_TYPE.UPDATE_OFFER;OrderInfo.getOfferBusiOrder(Z,ac,ab,aa,X)}}else{ac.offerTypeCd=2;ac.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;ac.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(Z,ac,ab,aa,X)}}};var R=function(Z,ac,Y,aa,ab,X){Z.prodId=ac;if(Y==1){Z.servClose="Y";Z.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;aa.push(OrderInfo.getProdBusiOrder(Z,ab,X))}else{if(Y==2){if(Z.prodSpecParams!=undefined&&Z.prodSpecParams.length>0){Z.boActionTypeCd=CONST.BO_ACTION_TYPE.PRODUCT_PARMS;Z.memberId=Z.servId;aa.push(OrderInfo.getProdBusiOrder(Z,ab,X))}}else{Z.servId=OrderInfo.SEQ.servSeq--;Z.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;aa.push(OrderInfo.getProdBusiOrder(Z,ab,X))}}};var f=function(X){var Y={};Y.boProdAns=OrderInfo.boProdAns;OrderInfo.setProdModifyBusiOrder(X,Y)};var Q=function(){if(OrderInfo.newClothes=="true"||OrderInfo.oldMember=="true"){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(OrderInfo.cust.custId==""){$.alert("提示","客户信息不能为空！");return false}if(ec.util.isArray(OrderInfo.oldprodAcctInfos)){for(var aw=0;aw<OrderInfo.oldprodAcctInfos.length;aw++){var ag=OrderInfo.oldprodAcctInfos[aw].prodAcctInfos[0].acctId;var ah=$("#acctSelect option:selected").val();if(ag!=ah){$.alert("提示","副卡和主卡的账户不一致！");return false}}}if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){for(var au=0;au<OrderInfo.offerSpec.offerRoles.length;au++){var ao=OrderInfo.offerSpec.offerRoles[au];for(var ap=0;ap<ao.prodInsts.length;ap++){var ac=ao.prodInsts[ap];var aq=OrderInfo.getProdAn(ac.prodInstId).accessNumber;if(aq==undefined||aq==""){$.alert("信息提示","【接入产品("+ao.offerRoleName+")】号码不能为空！");return false}if(OrderInfo.getProdTd(ac.prodInstId)==""){$.alert("信息提示","【接入产品("+ao.offerRoleName+")】UIM卡不能为空！");$("#uim_txt_"+ac.prodInstId).css("border-color","red");return false}var at=false;$("[name='pay_type_-1']").each(function(){if($(this).val()!=undefined&&$(this).val()!=null&&$(this).val()!=""){at=true}});if(!at){$.alert("信息提示","没有配置付费类型，无法提交");return false}var Z=true;var ae=null;$(OrderInfo.prodAttrs).each(function(){var ax=this.isOptional;var az=this.id;if(ax=="N"&&az){var ay=$.trim($("#"+az).val());if(ay==""||ay==undefined){ae=this.name;Z=false}}});if(!Z){$.alert("信息提示","没有配置产品属性("+ae+")，无法提交");return false}}}}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==3||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var au=0;au<AttachOffer.openList.length;au++){var ab=AttachOffer.openList[au].specList;var ak=OrderInfo.getOfferRoleName(AttachOffer.openList[au].prodId);for(var ap=0;ap<ab.length;ap++){var ad=ab[ap];if(ad.isdel!="Y"&&ad.isdel!="C"){if(ad.ifParams){if(ad.isset!="Y"){}}}}}for(var au=0;au<AttachOffer.openServList.length;au++){var ab=AttachOffer.openServList[au].servSpecList;var ak=OrderInfo.getOfferRoleName(AttachOffer.openServList[au].prodId);for(var ap=0;ap<ab.length;ap++){var ad=ab[ap];if(ad.isdel!="Y"&&ad.isdel!="C"){if(ad.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){if("no"==$("#isMIFI_-"+(au+1)).val()){$.alert("提示","要开通"+ad.servSpecName+"功能，请选择4G上网卡-全球卡（MIFI卡）！");$("#uim_txt_-"+(au+1)).css("border-color","red");return false}}if(ad.ifParams=="Y"){if(ad.isset!="Y"){}}}}}for(var au=0;au<AttachOffer.openList.length;au++){var ab=AttachOffer.openList[au].specList;var an=AttachOffer.openList[au].prodId;var ak=OrderInfo.getOfferRoleName(an);for(var ap=0;ap<ab.length;ap++){var ad=ab[ap];if(ad.isdel!="Y"&&ad.isdel!="C"){if(ad.isTerminal==1){var at=true;$.each(OrderInfo.attach2Coupons,function(){if(ad.offerSpecId==this.attachSepcId&&an==this.prodId){at=false;return false}});if(at){$.alert("提示",ak+" "+ad.offerSpecName+"：终端信息未填写");return false}}}}}}if(CONST.getAppDesc()==0){if(OrderInfo.actionFlag==2){for(var au=0;au<OrderInfo.offer.offerMemberInfos.length;au++){var Y=OrderInfo.offer.offerMemberInfos[au];if(Y.objType==CONST.OBJ_TYPE.PROD){if(AttachOffer.isChangeUim(Y.objInstId)){var af=OrderInfo.getProdTd(Y.objInstId);if(af==""){$.alert("提示",Y.roleName+" UIM卡不能为空！");return false}}}}}else{if(OrderInfo.actionFlag==3){if(AttachOffer.isChangeUim()){if(OrderInfo.boProd2Tds.length==0){$.alert("提示","UIM卡不能为空！");return false}}}}}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(OrderInfo.boProd2OldTds.length==0){$.alert("提示","原UIM卡信息为空！");
return false}if(OrderInfo.boProd2Tds.length==0){$.alert("提示","UIM卡不能为空！");return false}}if(CONST.getAppDesc()==0){for(var au=0;au<AttachOffer.openServList.length;au++){var ab=AttachOffer.openServList[au].servSpecList;var at=false;var am=false;$.each(ab,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G&&this.isdel!="Y"&&this.isdel!="C"){at=true;return false}});var an=AttachOffer.openServList[au].prodId;var aj="";if(AttachOffer.openList[au]!=undefined){var X=AttachOffer.openList[au].specList;for(var ap=0;ap<X.length;ap++){var ad=X[ap];if(ad.isdel!="Y"&&ad.isdel!="C"){if(ad.isTerminal==1){$.each(OrderInfo.attach2Coupons,function(){if(an==this.prodId){am=true;if(ec.util.isObj(this.termTypeFlag)){aj=this.termTypeFlag}return false}})}}}}var ak=OrderInfo.getOfferRoleName(an);if(am&&aj==""){$.alert("信息提示",ak+"中,营销资源未返回终端机型，无法判断是3G终端还是4G终端!");return false}if(at){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){var aa=OrderInfo.getProdUim(an);if(aa.cardTypeFlag=="2"){$.alert("信息提示",ak+"中UIM卡是3G卡，无法提交");return false}if(am&&aj=="2"){$.alert("信息提示",ak+"中终端是3G机型，无法提交");return false}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){var al=OrderInfo.getProdOldUim(an);if(al.is4GCard!="Y"){var aa=OrderInfo.getProdUim(an);if(aa.cardTypeFlag=="2"){$.alert("信息提示",ak+"中UIM卡是3G卡，无法提交");return false}}if(am&&aj=="2"){$.alert("信息提示",ak+"中终端是3G机型，无法提交");return false}}}}else{if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(am){var aa=OrderInfo.getProdUim(an);if(aa.cardTypeFlag!=aj){var ar=aa.cardTypeFlag=="1"?"4G卡":"3G卡";var av=aj=="1"?"4G机型":"3G机型";$.alert("信息提示",ak+"中UIM卡是"+ar+" 终端是"+av+"，无法提交");return false}}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){if(am){var ai=OrderInfo.getProdUim(an);if(ec.util.isObj(ai)&&ec.util.isObj(ai.cardTypeFlag)){if(ai.cardTypeFlag=="2"&&aj=="1"){$.alert("信息提示",ak+"中UIM卡是3G卡 终端是4G机型，无法提交");return false}if(ai.cardTypeFlag=="1"&&aj=="2"){$.alert("信息提示",ak+"中UIM卡是4G卡 终端是3G机型，无法提交");return false}}else{var al=OrderInfo.getProdOldUim(an);if(ec.util.isObj(al.is4GCard)){if(al.is4GCard!="Y"){if(aj=="1"){$.alert("信息提示",ak+"中UIM卡是3G卡 终端是4G机型，无法提交");return false}}else{if(aj=="2"){$.alert("信息提示",ak+"中UIM卡是4G卡 终端是3G机型，无法提交");return false}}}}}}}}}}}return true};var s=function(){if($.trim($("#acctName").val())==""){$.alert("提示","帐户名称不能为空");return false}if($("#paymentType").val()==110000){if($("#bankId").val()==""||$.trim($("#bankAcct").val())==""||$.trim($("#paymentMan").val())==""){$.alert("提示","若选择银行支付请填写必要的银行支付信息");return false}}if($("#postType").val()!=-1){if($.trim($("#postAddress").val())==""){$.alert("提示","若选择投递账单请填写必要的账单投递信息");return false}if($("#postType").val()==13){var X=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;if(X.test($("#postAddress").val())==false){$.alert("提示","若选择 Email 投递帐单请输入有效的 Email 地址");return false}}}return true};var b=function(){var aa=[];for(var Z=0;Z<OrderInfo.boProdAns.length;Z++){var Y={accNbr:OrderInfo.boProdAns[Z].accessNumber,accNbrType:1,action:"UPDATE"};aa.push(Y)}for(var Z=0;Z<OrderInfo.boProd2Tds.length;Z++){var Y={accNbr:OrderInfo.boProd2Tds[Z].terminalCode,accNbrType:2,action:"UPDATE"};aa.push(Y)}if(aa.length>0){var X=contextPath+"/common/updateResState";$.callServiceAsJsonGet(X,{strParam:JSON.stringify(aa)},{done:function(ab){if(ab.code==0){if(ab.data){}}}})}};var j=function(X){if($("#isTemplateOrder").attr("checked")=="checked"){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$(".template_info_type").show();$("#isActivation").removeAttr("checked");$("#isActivation").attr("disabled","disabled")}$(".template_info_name").show()}else{$(".template_info_name").hide();$(".template_info_type").hide();$("#templateOrderName").val("");$("#isActivation").removeAttr("disabled")}};var e=function(){if($("#isActivation").attr("checked")=="checked"){$("#isTemplateOrder").removeAttr("checked");$("#isTemplateOrder").attr("disabled","disabled");$(".template_info_name").hide();$(".template_info_type").hide();$("#templateOrderName").val("")}else{$("#isTemplateOrder").removeAttr("disabled")}};var t=function(aa){var Y=[];for(var X=0;X<aa.offerRoles.length;X++){var Z=aa.offerRoles[X];if(Z.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){Y.push(Z)}}for(var X=0;X<aa.offerRoles.length;X++){var Z=aa.offerRoles[X];if(Z.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){Y.push(Z)}}aa.offerRoles=Y;return aa};var h=function(){var X=false;var ab=order.prodModify.choosedProdInfo.prodClass;var aa=order.prodModify.choosedProdInfo.prodInstId;var Y=CacheData.getOfferSpecList(aa);if(ec.util.isArray(Y)){$.each(Y,function(){if(this.ifPackage4G=="Y"&&this.isdel!="Y"&&this.isdel!="C"){X=true;return false}})}if(CONST.getAppDesc()==0&&X&&ab==CONST.PROD_CLASS.THREE&&OrderInfo.actionFlag==3){if(offerChange.checkOrder()){var Z=offerChange.checkAttachOffer(aa);if(Z!=""){if(Q()){$("#offer_serv").html(Z);easyDialog.open({container:"offer_dialog"})}}else{SoOrder.submitOrder()}}}else{SoOrder.submitOrder()}};var K=function(){var X=order.prodModify.choosedProdInfo.prodInstId;AttachOffer.setChangeList(X);SoOrder.submitOrder();easyDialog.close()};var r=function(){var ab=order.prodModify.choosedProdInfo.is3G;if(OrderInfo.actionFlag==2){var Z=OrderInfo.offerSpec.is3G;if(ec.util.isObj(ab)){if(ec.util.isObj(Z)){if(ab=="Y"&&Z=="N"){return true}}}}else{if(OrderInfo.actionFlag==3){if(ec.util.isObj(ab)){if(ab=="Y"){for(var aa=0;aa<AttachOffer.openServList.length;aa++){var Y=AttachOffer.openServList[aa].servSpecList;var X=false;$.each(Y,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G&&this.isdel!="Y"&&this.isdel!="C"){X=true;return false}});if(X){return true}}}}}}return false};var M=function(Y,X){$("#modal-title").html(Y);$("#modal-content").html(X);$("#alert-modal").modal("show")};return{builder:S,createAttOffer:E,createServ:R,delOrder:H,delAndNew:J,getOrderInfo:L,getToken:G,getTokenSynchronize:c,initFillPage:l,initOrderData:F,orderBack:z,step:D,showStep:T,submitOrder:w,showAlertDialog:M,checkAcctInfo:s,showTemplateOrderName:j,sortOfferSpec:t,updateResState:b,delOrderBegin:P,delOrderSilent:C,delOrderFin:y,showActivation:e,checkOrder:h,orderPrepare:K,checkData:Q}})();CommonUtils.regNamespace("AttachOffer");AttachOffer=(function(){var _openList=[];var _openedList=[];var _openServList=[];var _openedServList=[];var _openAppList=[];var _changeList=[];var _labelList=[];var totalNums=0;var _init=function(){var prodInfo=order.prodModify.choosedProdInfo;if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=3;OrderInfo.busitypeflag=14;query.offer.setOffer(function(){if(!rule.rule.ruleCheck()){return}var param={offerSpecId:prodInfo.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};if(ec.util.isObj(prodInfo.prodOfferId)){if(!query.offer.queryMainOfferSpec(param)){return}}else{OrderInfo.offerSpec={}}if(CONST.getAppDesc()==0){if(!prod.uim.setProdUim()){return}}AttachOffer.queryAttachOffer()})};var _queryAttachOfferSpec=function(param){query.offer.queryAttachSpec(param,function(data){if(data){$("#attach_"+param.prodId).html(data);_showMainRoleProd(param.prodId);AttachOffer.changeLabel(param.prodId,param.prodSpecId,"100");if(param.prodId==-1&&OrderInfo.actionFlag==14){AttachOffer.addOpenList(param.prodId,mktRes.terminal.offerSpecId)}}})};var _showApp=function(prodId){var appList=CacheData.getOpenAppList(prodId);var content=CacheData.getAppContent(prodId,appList);$.confirm("增值业务设置： ",content[0].innerHTML,{yes:function(){$.each(appList,function(){if($("#"+prodId+"_"+this.objId).attr("checked")=="checked"){this.dfQty=1}else{this.dfQty=0}})},no:function(){}})};var getProdInst=function(prodId){for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(ec.util.isArray(offerRole.prodInsts)){for(var j=0;j<offerRole.prodInsts.length;j++){if(offerRole.prodInsts[j].prodInstId==prodId){return offerRole.prodInsts[j]}}}}};var _showMainRoleProd=function(prodId){var prodInst=getProdInst(prodId);
var app={prodId:prodId,appList:[]};AttachOffer.openAppList.push(app);for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(roleObj.objType==CONST.OBJ_TYPE.SERV){if(prodInst.objId==roleObj.parentProdId&&prodInst.componentTypeCd.substring(0,1)==roleObj.componentTypeCd.substring(0,1)){app.appList.push(roleObj);if(roleObj.servSpecId==undefined){roleObj.servSpecId=roleObj.objId}if(roleObj.servSpecName==undefined){roleObj.servSpecName=roleObj.objName}}}}if(app.appList.length>0){var $li=$('<li id="li_'+prodId+"_"+offerRole.offerRoleId+'"></li>');$li.append('<dd class="mustchoose" ></dd>');$li.append("<span>"+offerRole.offerRoleName+"</span>");$li.append('<dd id="can_'+prodId+"_"+offerRole.offerRoleId+'" class="gou2" onclick="AttachOffer.showApp('+prodId+');"></dd>');$("#open_app_ul_"+prodId).append($li)}}else{if(offerRole.prodInsts==undefined){continue}$.each(offerRole.prodInsts,function(){if(this.prodInstId==prodId){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldLi=$("#li_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(roleObj.dfQty==0&&spec.ifDault==1){var $span=$oldLi.find("span");$span.addClass("del");spec.isdel="Y"}}if(roleObj.minQty==1){$oldLi.removeAttr("onclick");var $span=$("#span_"+prodId+"_"+newSpec.servSpecId);var $span_remove=$("#span_remove_"+prodId+"_"+newSpec.servSpecId);if(ec.util.isObj($span)){$span.removeClass("del")}if(ec.util.isObj($span_remove)){$span_remove.hide()}}continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){var $span=$("#span_"+prodId+"_"+offer.servId);var $span_remove=$("#span_remove_"+prodId+"_"+offer.servId);if(ec.util.isObj($span)){$span.removeClass("del")}if(ec.util.isObj($span_remove)){$span_remove.hide()}$oldLi.removeAttr("onclick")}continue}if(roleObj.dfQty>0){var servSpec=jQuery.extend(true,{},roleObj);CacheData.setServSpec(prodId,servSpec);spec=servSpec;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<a id="li_'+prodId+"_"+servSpecId+'" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+'\')" class="list-group-item"></a>');$li.append('<span id="span_'+prodId+"_"+servSpecId+'">'+spec.servSpecName+"</span>");if(roleObj.minQty==0){$li.append('<span id="span_remove_'+prodId+"_"+servSpecId+'" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span>')}else{$li.removeAttr("onclick")}$("#open_serv_ul_"+prodId).append($li);spec.isdel="N";_showHideUim(0,prodId,servSpecId)}}}}})}}};var _showMainMemberRoleProd=function(prodId){for(var i=0;i<OrderInfo.viceOfferSpec.length;i++){var offerSpec=OrderInfo.viceOfferSpec[i];if(prodId==offerSpec.prodId){for(var j=0;j<offerSpec.offerRoles.length;j++){var offerRole=offerSpec.offerRoles[j];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldLi=$("#li_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}if(roleObj.dfQty>0){var servSpec=jQuery.extend(true,{},roleObj);CacheData.setServSpec(prodId,servSpec);spec=servSpec;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');if(roleObj.minQty==0){$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+"')\"></dd>")}else{$li.append('<dd class="mustchoose"></dd>')}$li.append("<span>"+spec.servSpecName+"</span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$li.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');$("#open_serv_ul_"+prodId).append($li);spec.isdel="N";_showHideUim(0,prodId,servSpecId)}}}}}}}};var _searchAttachOfferSpec=function(prodId,offerSpecId,prodSpecId){var param={prodId:prodId,prodSpecId:prodSpecId,offerSpecIds:[offerSpecId],ifCommonUse:""};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){if(this.prodInstId==prodId){param.acctNbr=this.accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}})}else{if(OrderInfo.actionFlag==3){var prodInfo=order.prodModify.choosedProdInfo;param.acctNbr=prodInfo.accNbr;if(!ec.util.isObj(prodInfo.prodOfferId)){prodInfo.prodOfferId=""}var offerRoleId=CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;if(offerRoleId==undefined){offerRoleId=""}param.offerRoleId=offerRoleId;param.offerSpecIds.push(prodInfo.prodOfferId)}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.viceOfferSpec,function(){var offerSpecId=this.offerSpecId;var accessNumber=this.accessnumber;if(this.prodId==prodId){$.each(this.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||this.memberRoleCd=="1"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){param.acctNbr=accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(offerSpecId);return false}})}})}})}else{if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr;$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){param.offerSpecIds.push(this.offerSpec.offerSpecId);$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){param.offerRoleId=this.offerRoleId}})}})}}}else{param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}}}}}var offerSepcName=$("#search_text_"+prodId).val();if(offerSepcName.replace(/\ /g,"")==""){$.alert("提示","请输入查询条件！");return}param.offerSpecName=offerSepcName;query.offer.searchAttachOfferSpec(param,function(data){if(data!=undefined){$("#attach_div_"+prodId).html(data).show();$("#btn_hide_"+prodId).show();$("#attachSearch_div_"+prodId+" div").each(function(){$(this).hide()})}})};var _closeSearchAttach=function(prodId){$("#attach_div_"+prodId).hide();$("#btn_hide_"+prodId).hide();var labelId=$("#attach_div_"+prodId).attr("value");$("#ul_"+prodId+"_"+labelId).show()};var _selectAttachOffer=function(prodId,offerSpecId){_addAttOffer(prodId,offerSpecId)};var _selectServ=function(prodId,servSpecId,specName,ifParams){$("#attach_div_"+prodId).hide();_openServSpec(prodId,servSpecId,specName,ifParams)};var _closeAttachSearch=function(prodId){$("#attach_div_"+prodId).hide();
$("#attachSearch_div_"+prodId+" div").each(function(){$(this).show()})};var _queryAttachOffer=function(){var prodInfo=order.prodModify.choosedProdInfo;var prodId=prodInfo.prodInstId;var param={prodId:prodId,prodSpecId:prodInfo.productId,offerSpecId:prodInfo.prodOfferId,acctNbr:prodInfo.accNbr};if(ec.util.isObj(prodInfo.prodBigClass)){param.prodBigClass=prodInfo.prodBigClass}query.offer.queryAttachOfferHtml(param,function(data){SoOrder.initFillPage();$("#order-content").html(data).show();$("#fillNextStep").off("click").on("click",function(){if(!SoOrder.checkData()){return false}$("#order-content").hide();$("#order-dealer").show();order.dealer.initDealer()});var member=CacheData.getOfferMember(prodId);if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){param.queryType="1,2";param.objId=member.objId;param.objType=member.objType;param.offerRoleId=member.offerRoleId;param.memberRoleCd=member.roleCd;var data=query.offer.queryDefMustOfferSpec(param);CacheData.parseOffer(data,prodId);var data=query.offer.queryServSpec(param,prodId);CacheData.parseServ(data)}if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){var member=CacheData.getOfferMember(prodId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==member.offerRoleId&&member.objType==CONST.OBJ_TYPE.PROD){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(this.minQty==1){$oldLi.removeAttr("onclick");var $span=$("#span_"+prodId+"_"+serv.servId);var $span_remove=$("#span_remove_"+prodId+"_"+serv.servId);if(ec.util.isObj($span)){$span.removeClass("del")}if(ec.util.isObj($span_remove)){$span_remove.hide()}}}}});return false}})}order.dealer.initDealer()})};var _delOfferSpec=function(prodId,offerSpecId){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.addOfferSpec(prodId,offerSpecId)}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);var content=CacheData.getOfferProdStr(prodId,spec,2);$.confirm("信息确认",content,{yes:function(){$span.addClass("del");spec.isdel="Y";delServSpec(prodId,spec);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#terminalUl_"+prodId+"_"+offerSpecId).remove();spec.isTerminal=0},no:function(){}})}};var _delOffer=function(prodId,offerId,reload){var $span=$("#li_"+prodId+"_"+offerId).find("span");if($span.attr("class")=="del"){AttachOffer.addOffer(prodId,offerId,$span.text())}else{var offer=CacheData.getOffer(prodId,offerId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offerId};var acctNbr="";if(OrderInfo.actionFlag==6){acctNbr=OrderInfo.getAccessNumber(prodId);if(acctNbr==undefined||acctNbr==""||acctNbr==null){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.areaId=OrderInfo.oldprodInstInfos[i].areaId;param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr}}}else{param.acctNbr=OrderInfo.getAccessNumber(prodId)}}var data=query.offer.queryOfferInst(param);if(data==undefined){return}var offerMemberInfos=[];$.each(data.offerMemberInfos,function(){var prodInstId=this.objInstId;var flag=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==prodInstId){flag=true;return false}});if(flag){offerMemberInfos.push(this)}});offer.offerMemberInfos=data.offerMemberInfos=offerMemberInfos;offer.offerSpec=data.offerSpec}if(OrderInfo.provinceInfo.reloadFlag=="N"){offer.isdel="Y";$span.addClass("del");delServByOffer(prodId,offer)}else{var content="";if(offer.offerSpec!=undefined){content=CacheData.getOfferProdStr(prodId,offer,1)}else{content="退订【"+$span.text()+"】可选包"}$.confirm("信息确认",content,{yes:function(){offer.isdel="Y";$span.addClass("del");delServByOffer(prodId,offer)},no:function(){}})}}};var _closeServSpec=function(prodId,servSpecId,specName,ifParams){var $span=$("#li_"+prodId+"_"+servSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams)}else{$.confirm("信息确认","取消开通【"+$span.text()+"】功能产品",{yesdo:function(){var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}$span.addClass("del");spec.isdel="Y";_showHideUim(1,prodId,servSpecId);var serv=CacheData.getServBySpecId(prodId,servSpecId);if(ec.util.isObj(serv)){$span.addClass("del");serv.isdel="Y"}},no:function(){}})}};var _closeServ=function(prodId,servId){var serv=CacheData.getServ(prodId,servId);var $span=$("#li_"+prodId+"_"+serv.servId).find("span");if($span.attr("class")=="del"){_openServ(prodId,serv)}else{if("13409244"==serv.servSpecId){$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能")}else{$.confirm("信息确认","关闭【"+$span.text()+"】功能产品",{yesdo:function(){$span.addClass("del");serv.isdel="Y"},no:function(){}})}}};var _openServSpec=function(prodId,servSpecId,specName,ifParams){$.confirm("信息确认","开通【"+specName+"】功能产品",{yesdo:function(){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams;if(servSpecId==CONST.YZFservSpecId){var feeType=$("select[name='pay_type_-1']").val();if(feeType==undefined){feeType=order.prodModify.choosedProdInfo.feeType}if(feeType==CONST.PAY_TYPE.AFTER_PAY){for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];prodSpecParam.setValue=""}}else{for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];if(prodSpecParam.value!=""){prodSpecParam.setValue=prodSpecParam.value}else{if(!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!=""){prodSpecParam.setValue=prodSpecParam.valueRange[0].value}}}}}}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDepend(prodId,servSpec)},no:function(){}})};var _openServ=function(prodId,serv){$.confirm("信息确认","取消关闭【"+serv.servSpecName+"】功能产品",{yesdo:function(){if(serv!=undefined){if(serv.servSpecId==""){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.removeClass("del");serv.isdel="N"}else{_checkServExcludeDepend(prodId,serv)}}},no:function(){}})};var _checkOfferExcludeDepend=function(prodId,offerSpec){var offerSpecId=offerSpec.offerSpecId;var param=CacheData.getExcDepOfferParam(prodId,offerSpecId);var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName)}};var _checkServExcludeDepend=function(prodId,serv,flag){var servSpecId=serv.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserServData(data.result,prodId,serv)}}};var _addOfferSpec=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)},no:function(){}})};var _addOfferSpecByCheck=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)}})};var delServSpec=function(prodId,offerSpec){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var servSpecId=this.objId;if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){var spec=CacheData.getServSpec(prodId,servSpecId);
if(ec.util.isObj(spec)){spec.isdel="Y";$li.find("span").addClass("del");_showHideUim(1,prodId,servSpecId)}}})})};var delServByOffer=function(prodId,offer){$.each(offer.offerMemberInfos,function(){var servId=this.objInstId;if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){var serv=CacheData.getServ(prodId,servId);if(ec.util.isObj(serv)){serv.isdel="Y";var $li=$("#li_"+prodId+"_"+servId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del")}}})};var _addOffer=function(prodId,offerId){var specName=$("#li_"+prodId+"_"+offerId).find("span").text();$.confirm("信息确认","取消退订【"+specName+"】可选包",{yesdo:function(){var offer=CacheData.getOffer(prodId,offerId);if(offer!=undefined){if(offer.offerSpecId==""){var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.removeClass("del");offer.isdel="N"}else{_checkOfferExcludeDepend(prodId,offer)}}},no:function(){}})};var _addAttOffer=function(prodId,offerSpecId,specName){_addOfferSpec(prodId,offerSpecId)};var paserOfferData=function(result,prodId,offerSpecId,specName){var content="";var param={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(result!=""){var exclude=result.offerSpec.exclude;var depend=result.offerSpec.depend;var defaultOffer=result.offerSpec.defaultList;if(ec.util.isArray(exclude)){for(var i=0;i<exclude.length;i++){var offerList=CacheData.getOfferList(prodId);var flag=true;if(offerList!=undefined){for(var j=0;j<offerList.length;j++){if(offerList[j].isdel=="Y"){if(offerList[j].offerSpecId==exclude[i].offerSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+exclude[i].offerSpecName+"<br>";param.excludeOffer.push(exclude[i].offerSpecId)}}}if(depend!=undefined&&ec.util.isArray(depend.offerInfos)){for(var i=0;i<depend.offerInfos.length;i++){content+="需要开通： "+depend.offerInfos[i].offerSpecName+"<br>";param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId)}}if(depend!=undefined&&ec.util.isArray(depend.offerGrpInfos)){for(var i=0;i<depend.offerGrpInfos.length;i++){var offerGrpInfo=depend.offerGrpInfos[i];param.dependOffer.offerGrpInfos.push(offerGrpInfo);content+="需要开通： 开通"+offerGrpInfo.minQty+"-"+offerGrpInfo.maxQty+"个以下业务:<br>";if(offerGrpInfo.subOfferSpecInfos!="undefined"&&offerGrpInfo.subOfferSpecInfos.length>0){for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){var subOfferSpec=offerGrpInfo.subOfferSpecInfos[j];var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}}else{var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}}}}}}if(ec.util.isArray(defaultOffer)){for(var i=0;i<defaultOffer.length;i++){content+="需要开通： "+defaultOffer[i].offerSpecName+"<br>";param.defaultOffer.push(defaultOffer[i].offerSpecId)}}}var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);content=content+serContent;if(content==""){AttachOffer.addOpenList(prodId,offerSpecId)}else{content="<div style='max-height:300px;overflow:auto;'>"+content+"</div>";$.confirm("订购： "+specName,content,{yes:function(){CacheData.setOffer2ExcludeOfferSpec(param)},yesdo:function(){excludeAddattch(prodId,offerSpecId,param);excludeAddServ(prodId,"",paramObj)},no:function(){}})}};var paserServData=function(result,prodId,serv){var servSpecId=serv.servSpecId;var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";var param={excludeServ:[],dependServ:[],relatedServ:[]};if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";param.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.dependServ.push(this)})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.relatedServ.push(this)})}if(content==""){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{$.confirm("开通： "+serv.servSpecName,content,{yesdo:function(){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);excludeAddServ(prodId,servSpecId,param)},no:function(){}})}};var excludeAddServ=function(prodId,servSpecId,param){if(ec.util.isArray(param.excludeServ)){for(var i=0;i<param.excludeServ.length;i++){var excludeServSpecId=param.excludeServ[i].servSpecId;var spec=CacheData.getServSpec(prodId,excludeServSpecId);if(spec!=undefined){var $span=$("#li_"+prodId+"_"+excludeServSpecId).find("span");$span.addClass("del");spec.isdel="Y"}else{var serv=CacheData.getServBySpecId(prodId,excludeServSpecId);if(serv!=undefined){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.addClass("del");serv.isdel="Y"}}}}if(ec.util.isArray(param.dependServ)){for(var i=0;i<param.dependServ.length;i++){var servSpec=param.dependServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}if(ec.util.isArray(param.relatedServ)){for(var i=0;i<param.relatedServ.length;i++){var servSpec=param.relatedServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}};var excludeAddattch=function(prodId,specId,param){if(param.dependOffer.offerGrpInfos.length>0){var dependOffer=param.dependOffer;for(var i=0;i<dependOffer.offerGrpInfos.length;i++){var offerGrpInfo=dependOffer.offerGrpInfos[i];var len=offerGrpInfo.checkLen;if(len>=offerGrpInfo.minQty&&len<=offerGrpInfo.maxQty){$.each(offerGrpInfo.subOfferSpecInfos,function(){if(this.isCheck){AttachOffer.addOpenList(prodId,this.offerSpecId)}})}else{if(len<offerGrpInfo.minQty){$.alert("提示信息","依赖组至少选中"+offerGrpInfo.minQty+"个！");return}else{if(len>offerGrpInfo.maxQty){$.alert("提示信息","依赖组至多选中"+offerGrpInfo.maxQty+"个！");return}else{$.alert("错误信息","依赖组选择出错！");return}}}}}AttachOffer.addOpenList(prodId,specId);if(param.excludeOffer.length>0){for(var i=0;i<param.excludeOffer.length;i++){var excludeSpecId=param.excludeOffer[i];var spec=CacheData.getOfferSpec(prodId,excludeSpecId);if(spec!=undefined){var $span=$("#li_"+prodId+"_"+excludeSpecId).find("span");$span.addClass("del");spec.isdel="Y";$("#terminalUl_"+prodId+"_"+excludeSpecId).remove()}var offer=CacheData.getOfferBySpecId(prodId,excludeSpecId);if(offer!=undefined){var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.addClass("del");offer.isdel="Y"}}}if(param.dependOffer.dependOffers.length>0){for(var i=0;i<param.dependOffer.dependOffers.length;
i++){var offerSpecId=param.dependOffer.dependOffers[i];AttachOffer.addOpenList(prodId,offerSpecId)}}if(param.defaultOffer.length>0){for(var i=0;i<param.defaultOffer.length;i++){var offerSpecId=param.defaultOffer[i];AttachOffer.addOpenList(prodId,offerSpecId)}}};var _addOpenList=function(prodId,offerSpecId){if(!_manyPhoneFilter(prodId,offerSpecId)){return}var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(offer!=undefined){if(offer.isdel!="Y"){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}}else{var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.removeClass("del");offer.isdel="N"}return}var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}if(newSpec.isdel=="C"){if(_ifOrderAgain(newSpec)){return}var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();var $li=$('<a id="li_'+prodId+"_"+offerSpecId+'" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+')" class="list-group-item"></a>');$li.append('<span id="span_'+prodId+"_"+offerSpecId+'">'+newSpec.offerSpecName+"</span>");if(newSpec.ifDault==0){$li.removeAttr("onclick")}else{$li.append('<span id="span_remove_'+prodId+"_"+offerSpecId+'" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span>')}$("#open_ul_"+prodId).append($li);newSpec.isdel="N"}else{if((newSpec.isdel=="Y")){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");$span.removeClass("del");newSpec.isdel="N"}else{var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();var $li=$('<a id="li_'+prodId+"_"+offerSpecId+'" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+')" class="list-group-item"></a>');$li.append('<span id="span_'+prodId+"_"+offerSpecId+'">'+newSpec.offerSpecName+"</span>");if(newSpec.ifDault==0){$li.removeAttr("onclick")}else{$li.append('<span id="span_remove_'+prodId+"_"+offerSpecId+'" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span>')}$("#open_ul_"+prodId).append($li)}}if(newSpec!=undefined){$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty!=2){var ifParams="N";if(ec.util.isArray(this.prodSpecParams)){ifParams="Y"}_addOpenServList(prodId,this.objId,this.objName,ifParams);if(this.minQty>0){_minQtyFileter(prodId,this.objId)}}})})}if(ec.util.isArray(newSpec.agreementInfos)){if(OrderInfo.actionFlag!=14){totalNums=0;_removeAttach2Coupons(prodId,newSpec.offerSpecId);var objInstId=prodId+"_"+newSpec.offerSpecId;var $ul=$('<div id="terminalUl_'+objInstId+'"></div>');var minNum=newSpec.agreementInfos[0].minNum;var maxNum=newSpec.agreementInfos[0].maxNum;var $li3=$("<div></div>");var isFastOffer=0;if(ec.util.isArray(newSpec.extAttrParams)){$.each(newSpec.extAttrParams,function(){if(this.attrId==CONST.OFFER_FAST_FILL){isFastOffer=1;return false}})}for(var i=0;i<newSpec.agreementInfos.length;i++){var agreementInfo=newSpec.agreementInfos[i];var $ulGroups=$('<ul id="ul_'+objInstId+'" style="margin-left: -40px;"></ul>');var $liGroups=$('<li class="form-group" style="list-style-type:none;"><label> 终端：</label></li>');var $selTerms=$('<select style="display:none;" id="'+objInstId+'"></select>');var $selTermGroups=$('<select style="display:none;" id="group_'+objInstId+'"></select>');if(ec.util.isArray(agreementInfo.terminalGroups)){for(var j=0;j<agreementInfo.terminalGroups.length;j++){var $optionTermGroups=$('<option value="'+agreementInfo.terminalGroups[j].terminalGroupId+'" terminalMaxNum="'+agreementInfo.terminalGroups[j].terminalMaxNum+'" terminalMinNum="'+agreementInfo.terminalGroups[j].terminalMinNum+'">'+agreementInfo.terminalGroups[j].terminalGroupId+"</option>");$selTermGroups.append($optionTermGroups);if(ec.util.isArray(agreementInfo.terminalGroups[j].terminalGroup)){$.each(agreementInfo.terminalGroups[j].terminalGroup,function(){var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+"</option>");$selTerms.append($optionTerms)})}}}if(ec.util.isArray(agreementInfo.terminals)){$.each(agreementInfo.terminals,function(){var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+"</option>");$selTerms.append($optionTerms)})}$liGroups.append($selTerms).append($selTermGroups);if(maxNum>newSpec.agreementInfos[0].minNum){var $strAdd=$('<button id="terminalAddBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="0" onclick="AttachOffer.addAndDelTerminal(this)" value="添加" class="btn btn-default">添加</button>');var $strDel=$('<button id="terminalDelBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="1" onclick="AttachOffer.addAndDelTerminal(this)" value="删除" class="btn btn-default">删除</button>');$liGroups.append($strAdd).append($strDel)}$ulGroups.append($liGroups);var minNumArray=new Array();for(var k=1;k<=minNum;k++){var id="terminalText_"+objInstId+"_"+k;minNumArray[k-1]=id;var $liTerminal=$('<li class="form-group" style="list-style-type:none;"><label for="exampleInputPassword1">终端校验<span class="text-warning">*</span></label><div class="input-group"><input id="terminalText_'+objInstId+"_"+k+'" type="text" class="form-control" maxlength="50" placeholder="请先输入终端串号" /><span class="input-group-btn"><button id="terminalBtn_'+objInstId+"_"+k+'" type="button" num="'+k+'" flag="'+isFastOffer+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" class="btn btn-default">校验</button></span></div></li>');var $li4=$('<li id="terminalDesc_'+k+'" style="display:none;list-style-type:none;" ><label></label><label id="terminalName_'+k+'"></label></li>');$ulGroups.append($liTerminal).append($li4)}$ul.append($ulGroups);totalNums+=minNum}var $div=$("#terminalDiv_"+prodId);$ul.appendTo($div);$div.show();var terminalCode="";if(OrderInfo.terminalCode!=null&&OrderInfo.terminalCode!=""&&OrderInfo.terminalCode!="null"&&OrderInfo.reloadFlag!="N"){var accessNum=OrderInfo.getAccessNumber(prodId);if(accessNum!=""&&accessNum!=null&&accessNum!=undefined){var terminalCodeArray=OrderInfo.terminalCode.split(",");for(var k=0;k<terminalCodeArray.length;k++){if(terminalCodeArray[k].indexOf(accessNum)!=-1){terminalCode=terminalCodeArray[k].split("_")[1];for(var z=0;z<minNumArray.length;z++){if(minNumArray[z].indexOf(prodId)!=-1){$("#"+minNumArray[z]).val(terminalCode);break}}}}}}if(newSpec.agreementInfos[0].minNum>0){newSpec.isTerminal=1}}else{if(OrderInfo.actionFlag==14){var objInstId=prodId+"_"+newSpec.offerSpecId;var terminalUl=$("#terminalUl_"+objInstId);if(terminalUl.length>0){return}var $ul=$('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');var $sel=$('<select id="terminalSel_'+objInstId+'"></select>');var $li1=$('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+"</span></label></li>");var $li2=$('<li style="display:none;"><label> 可选终端规格：</label></li>');$.each(newSpec.agreementInfos,function(){var $option=$('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+"</option>");$sel.append($option)});$li2.append($sel).append('<label class="f_red">*</label>');var $li3=$('<li><label>终端校验：</label><input id="terminalText_'+objInstId+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+","+newSpec.offerSpecId+')" value="校验" class="purchase" style="float:left"></input></li>');var $div=$("#terminalDiv_"+prodId);var $li4=$('<li id="terminalDesc" style="display:none;white-space:nowrap;"><label> 终端规格：</label><label id="terminalName"></label></li>');$ul.append($li1).append($li2).append($li3).append($li4).appendTo($div);$div.show();newSpec.isTerminal=1;for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var coupon=OrderInfo.attach2Coupons[i];if(prodId==coupon.prodId){$("#terminalSel_"+objInstId).val(coupon.couponId);
$("#terminalSel_"+objInstId).attr("disabled",true);$("#terminalText_"+objInstId).val(coupon.couponInstanceNumber);$("#terminalText_"+objInstId).attr("disabled",true);$("#terminalBtn_"+objInstId).hide()}}}}}};var _checkTerminalCode=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var num=$(obj).attr("num");var flag=$(obj).attr("flag");if(flag==undefined){flag=0}_filterAttach2Coupons(prodId,offerSpecId,num);var objInstId=prodId+"_"+offerSpecId;var resIdArray=[];var terminalGroupIdArray=[];$("#"+objInstId+"  option").each(function(){resIdArray.push($(this).val())});$("#group_"+objInstId+"  option").each(function(){terminalGroupIdArray.push($(this).val())});var resId=resIdArray.join("|");var terminalGroupId=terminalGroupIdArray.join("|");if((resId==undefined||$.trim(resId)=="")&&(terminalGroupId==undefined||$.trim(terminalGroupId)=="")){$.alert("信息提示","终端规格不能为空！");return}var instCode=$("#terminalText_"+objInstId+"_"+num).val();if(instCode==undefined||$.trim(instCode)==""){$.alert("信息提示","终端串码不能为空！");return}if(_checkData(objInstId,instCode)){return}var param={instCode:instCode,flag:flag,mktResId:resId,offerSpecId:offerSpecId};var data=query.prod.checkTerminal(param);if(data==undefined){return}var activtyType="";for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"&&ec.util.isArray(spec.agreementInfos)){if(spec.agreementInfos[0].activtyType==2){activtyType="2"}}}}if(data.statusCd==CONST.MKTRES_STATUS.USABLE||(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2")){$.alert("信息提示",data.message);var mktPrice=0;var mktColor="";if(ec.util.isArray(data.mktAttrList)){$.each(data.mktAttrList,function(){if(this.attrId=="65010058"){mktPrice=this.attrValue}else{if(this.attrId=="60010004"){mktColor=this.attrValue}}})}$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");$("#terminalDesc_"+num).css("display","block");var coupon={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:data.mktResStoreId,storeName:"1",agentId:1,apCharge:mktPrice,couponInstanceNumber:data.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:-1,attachSepcId:offerSpecId,state:"ADD",relaSeq:"",num:num,attrList:data.mktAttrList};if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2"){coupon.couponSource="2"}if(CONST.getAppDesc()==0){coupon.termTypeFlag=data.termTypeFlag}OrderInfo.attach2Coupons.push(coupon)}else{if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}else{$.alert("提示",data.message)}}};var _setSpec=function(prodId,offerSpecId){var newSpec=CacheData.getOfferSpec(prodId,offerSpecId);if(newSpec==undefined){newSpec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!newSpec){return}CacheData.setOfferSpec(prodId,newSpec)}return newSpec};var _addOpenServList=function(prodId,servSpecId,servSpecName,ifParams){var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){$("#li_"+prodId+"_"+serv.servId).find("span").removeClass("del");serv.isdel="N";return}var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:servSpecName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams}CacheData.setServSpec(prodId,newSpec);spec=newSpec}if(spec.isdel=="C"){$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<a id="li_'+prodId+"_"+servSpecId+'" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+servSpecName+"','"+ifParams+'\')" class="list-group-item"></a>');$li.append('<span id="span_'+prodId+"_"+servSpecId+'">'+spec.servSpecName+"</span>");if(spec.ifDault==0){$li.removeAttr("onclick")}else{$li.append('<span id="span_remove_'+prodId+"_"+servSpecId+'" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span>')}$("#open_serv_ul_"+prodId).append($li)}else{$("#li_"+prodId+"_"+servSpecId).find("span").removeClass("del")}spec.isdel="N";_showHideUim(0,prodId,servSpecId)};var _showMainParam=function(){var content=CacheData.getParamContent(-1,OrderInfo.offerSpec,0);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){}).ketchup({bindElement:"easyDialogYesBtn"})};var _showParam=function(prodId,offerSpecId,flag){if(flag==1){var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offer.offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=query.offer.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}if(!offer.isGetParam){var param={offerTypeCd:"2",offerId:offer.offerId,offerSpecId:offer.offerSpecId};var offerParam=query.offer.queryOfferParam(param);if(offerParam==undefined){return}else{offer.offerParamInfos=offerParam.offerParamInfos;offer.isGetParam=true}}var content=CacheData.getParamContent(prodId,offer,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});order.protocolnbr.init();$("#paramForm").bind("formIsValid",function(event,form){if(!paramInputCheck()){return}var isset=false;$.each(offer.offerSpec.offerSpecParams,function(){var itemInfo=CacheData.getOfferParam(prodId,offer.offerId,this.itemSpecId);if(itemInfo.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){itemInfo.setValue=$("#select1").val()}else{itemInfo.setValue=$("#"+prodId+"_"+this.itemSpecId).val()}if(itemInfo.value!=itemInfo.setValue){itemInfo.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu").addClass("canshu2");offer.isset="Y";offer.update="Y"}else{$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu2").addClass("canshu");offer.isset="N";offer.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);if(spec==undefined){spec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!spec){return}}var content=CacheData.getParamContent(prodId,spec,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});order.protocolnbr.init();$("#paramForm").bind("formIsValid",function(event,form){if(!paramInputCheck()){return}if(!!spec.offerSpecParams){for(var i=0;i<spec.offerSpecParams.length;i++){var param=spec.offerSpecParams[i];var itemSpec=CacheData.getSpecParam(prodId,offerSpecId,param.itemSpecId);if(itemSpec.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){itemSpec.setValue=$("#select1").val()}else{itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}}if(spec.offerRoles!=undefined&&spec.offerRoles.length>0){for(var i=0;i<spec.offerRoles.length;i++){var offerRole=spec.offerRoles[i];for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(!!roleObj.prodSpecParams){for(var k=0;k<roleObj.prodSpecParams.length;k++){var prodParam=roleObj.prodSpecParams[k];var prodItem=CacheData.getProdSpecParam(prodId,offerSpecId,prodParam.itemSpecId);prodItem.value=$("#"+prodId+"_"+prodParam.itemSpecId).val()}}}}}$("#can_"+prodId+"_"+offerSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getOfferSpec(prodId,offerSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var _showServParam=function(prodId,servSpecId,flag){if(flag==1){var serv=CacheData.getServBySpecId(prodId,servSpecId);var param={prodId:serv.servId,ifServItem:"Y"};if(!serv.isGetParamSpec){param.prodSpecId=serv.servSpecId;var dataSepc=query.prod.prodSpecParamQuery(param);
if(dataSepc==undefined){return}else{serv.prodSpecParams=dataSepc.result.prodSpecParams;serv.isGetParamSpec=true}}if(!serv.isGetParamInst){var data=query.prod.prodInstParamQuery(param);if(data==undefined){return}else{serv.prodInstParams=data.result.prodInstParams;serv.isGetParamInst=true}}var content=CacheData.getParamContent(prodId,serv,3);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var isset=false;$.each(serv.prodSpecParams,function(){var prodItem=CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);prodItem.setValue=$("#"+prodId+"_"+this.itemSpecId).val();if(prodItem.value!=prodItem.setValue){prodItem.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");serv.isset="Y";serv.update="Y"}else{$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");serv.isset="N";serv.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}var content=CacheData.getParamContent(prodId,spec,2);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){if(!!spec.prodSpecParams){for(var i=0;i<spec.prodSpecParams.length;i++){var param=spec.prodSpecParams[i];var itemSpec=CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getServSpec(prodId,servSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var paramInputCheck=function(){var pass=true;$("#paramForm").find("input[type=text]").each(function(){var mask=$(this).attr("mask");var maskmsg=$(this).attr("maskmsg");if(mask!=null&&mask!=""&&mask.substring(0,1)=="/"&&mask.substring(mask.length-1,mask.length)=="/"){if(!eval(mask).test($(this).val())){$.alert("提示",maskmsg);pass=false;return false}}});return pass};var _showTime=function(prodId,offerSpecId,offerSpecName){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(offerSpecName+"--生失效设置");var spec=CacheData.getOfferSpec(prodId,offerSpecId);_initTime(spec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setAttachTime(prodId,offerSpecId)});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showStartTime=function(){var strDate=DateUtil.Format("yyyy年MM月dd日",new Date());var endDate=$("#endDt").val();if(endDate==""){$.calendar({minDate:strDate})}else{$.calendar({minDate:strDate,maxDate:endDate})}};var _showEndTime=function(){var strDate=$("#startDt").val();if(strDate==""){strDate=DateUtil.Format("yyyy年MM月dd日",new Date())}$.calendar({minDate:strDate})};var _initTime=function(spec){if(spec!=undefined&&spec.ooTimes!=undefined){var ooTime=spec.ooTimes;$("input[name=startTimeType][value='"+ooTime.startType+"']").attr("checked","checked");$("input[name=endTimeType][value='"+ooTime.endType+"']").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("");if(ooTime.startType==4){$("#startDt").val(ooTime.startDt)}if(ooTime.endType==4){$("#endDt").val(ooTime.endDt)}else{if(ooTime.endType==5){$("#endTime").val(ooTime.effTime);$("#endTimeUnit").val(ooTime.effTimeUnitCd)}}}else{$("input[name=startTimeType][value=1]").attr("checked","checked");$("input[name=endTimeType][value=1]").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("")}};var _showOfferTime=function(){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(OrderInfo.offerSpec.offerSpecName+"-生失效设置");_initTime(OrderInfo.offerSpec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setMainTime()});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showMainMember=function(){$("#memberName").text(OrderInfo.offerSpec.offerSpecName+"-构成");$("#main_member_div").empty();$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)});$("#main_member_div").append('<div class="clear"></div>')}else{$.each(offerRole.prodInsts,function(){var prodId=this.prodInstId;var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)}});$("#main_member_div").append('<div class="clear"></div>')})}});easyDialog.open({container:"div_member_dialog"});$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(offerRole.prodInsts,function(){var prodInst=this;$.each(offerRole.roleObjs,function(){var servSpecId=this.objId;if(this.minQty>0){$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked");$(this).attr("disabled","disabled")}})}});if(!!prodInst.servInsts){$.each(prodInst.servInsts,function(){var servSpecId=this.objId;$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked")}})})}})});$("#memberSpan").off("click").on("click",function(){_setMainMember()})};var _setMainMember=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(this.prodInsts,function(){var prodInst=this;prodInst.servInsts=[];$("input[name='serv_check_"+this.prodInstId+"']:checked").each(function(){var servSpecId=$(this).attr("servSpecId");$.each(offerRole.roleObjs,function(){if(this.objId==servSpecId){prodInst.servInsts.push(this)}})})})});easyDialog.close()};var _getTime=function(){var ooTime={state:"ADD"};var startRadio=$("input[name=startTimeType]:checked").attr("value");ooTime.startType=startRadio;if(startRadio==1){ooTime.isDefaultStart="Y"}else{if(startRadio==2){}else{if(startRadio==3){ooTime.startTime=1;ooTime.startTimeUnitCd=7}else{if(startRadio==4){if($("#startDt").val()==""){$.alert("提示","指定生效时间不能为空!");return}ooTime.startDt=$("#startDt").val()}}}}var endRadio=$("input[name=endTimeType]:checked").attr("value");ooTime.endType=endRadio;if(endRadio==1){ooTime.isDefaultEnd="Y"}else{if(endRadio==4){if($("#endDt").val()==""){$.alert("提示","指定失效时间不能为空!");return}ooTime.endDt=$("#endDt").val()}else{if(endRadio==5){var end=$("#endTime").val();if(end==""){$.alert("提示","有效时长不能为空!");return}if(isNaN(end)){$.alert("提示","有效时长必须为数字!");return}if(end<=0){$.alert("提示","有效时长必须大于0!");return}ooTime.effTime=end;ooTime.effTimeUnitCd=$("#endTimeUnit").val()}}}return ooTime};var _setMainTime=function(){var ooTime=_getTime();if(ooTime==undefined){return}OrderInfo.offerSpec.ooTimes=ooTime;$("#mainTime").removeClass("time").addClass("time2");easyDialog.close()};var _setAttachTime=function(prodId,offerSpecId){var ooTime=_getTime();if(ooTime==undefined){return}var spec=CacheData.getOfferSpec(prodId,offerSpecId);
spec.ooTimes=ooTime;$("#time_"+prodId+"_"+offerSpecId).removeClass("time").addClass("time2");easyDialog.close()};var _changeLabel1=function(prodId,prodSpecId,labelId){_changeLabel(prodId,prodSpecId,labelId)};var _changeLabel=function(prodId,prodSpecId,labelId){if(labelId==""){labelId=$("#attachType_"+prodId).val()}$("#attach_div_"+prodId).hide();$("#btn_hide_"+prodId).hide();$("#attachSearch_div_"+prodId+" div").each(function(){$(this).hide()});$("#attach_div_"+prodId).attr("value",labelId);var $ul=$("#ul_"+prodId+"_"+labelId);if($ul[0]==undefined){var queryType="3";if(prodId>0){queryType=""}if(labelId==CONST.LABEL.SERV){$("#open_serv_ul_"+prodId).show();var param={prodId:prodId,prodSpecId:prodSpecId,queryType:queryType,labelId:labelId};var data=query.offer.queryServSpec(param);var $ul=$('<div id="ul_'+prodId+"_"+labelId+'"></div>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.servSpec)){var servList=CacheData.getServList(prodId);var servSpecList=CacheData.getServSpecList(prodId);var i=0;var html="";$.each(data.result.servSpec,function(){var servSpecId=this.servSpecId;var flag=true;$.each(servList,function(){if(this.servSpecId==servSpecId&&this.isDel!="C"){flag=false;return false}});$.each(servSpecList,function(){if(this.servSpecId==servSpecId){flag=false;return false}});if(flag){html='<a class="list-group-item" href="javascript:AttachOffer.openServSpec('+prodId+","+this.servSpecId+",'"+this.servSpecName+"','"+this.ifParams+'\')" id="li_'+prodId+"_"+this.servSpecId+'">';html+='<h5 class="list-group-item-heading">'+this.servSpecName+"</h5>";html+="</a>";$ul.append(html);i++}});if(i==0){html='<a href="javascript:void(0);" class="list-group-item"><span>没有可订购的功能产品</span></a>';$ul.append(html)}}else{var html='<a href="javascript:void(0);" class="list-group-item"><span>没有可订购的功能产品</span></a>';$ul.append(html)}}$("#attachSearch_div_"+prodId).append($ul)}else{var param={prodSpecId:prodSpecId,offerSpecIds:[],queryType:queryType,prodId:prodId,partyId:OrderInfo.cust.custId,labelId:labelId,ifCommonUse:""};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){if(this.prodInstId==prodId){param.acctNbr=this.accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}})}else{if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22){var prodInfo=order.prodModify.choosedProdInfo;param.acctNbr=prodInfo.accNbr;if(!ec.util.isObj(prodInfo.prodOfferId)){prodInfo.prodOfferId=""}var offerRoleId=CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;if(offerRoleId==undefined){offerRoleId=""}param.offerRoleId=offerRoleId;param.offerSpecIds.push(prodInfo.prodOfferId)}else{param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}}}query.offer.queryCanBuyAttachSpec(param,function(data){var $ul=$('<div id="ul_'+prodId+"_"+labelId+'" ></div>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.offerSpecList)){var offerList=CacheData.getOfferList(prodId);var offerSpecList=CacheData.getOfferSpecList(prodId);var i=0;var html="";$.each(data.result.offerSpecList,function(){var offerSpecId=this.offerSpecId;var flag=true;$.each(offerList,function(){if(this.offerSpecId==offerSpecId&&this.isDel!="C"){flag=false;return false}});$.each(offerSpecList,function(){if(this.offerSpecId==offerSpecId){flag=false;return false}});if(flag){html='<a class="list-group-item" href="javascript:AttachOffer.addOfferSpec('+prodId+","+this.offerSpecId+')" id="li_'+prodId+"_"+this.offerSpecId+'">';html+='<h5 class="list-group-item-heading">'+this.offerSpecName+"</h5>";html+="</a>";$ul.append(html);i++}});if(i==0){html='<a href="javascript:void(0);" class="list-group-item"><span>没有可订购的可选包</span></a>';$ul.append(html)}}else{var html='<a href="javascript:void(0);" class="list-group-item"><span>没有可订购的可选包</span></a>';$ul.append(html)}}$("#attachSearch_div_"+prodId).append($ul)})}}else{$("#ul_"+prodId+"_"+labelId).show()}};var _showHideUim=function(flag,prodId,servSpecId){if(CONST.getAppDesc()==0&&servSpecId==CONST.PROD_SPEC.PROD_FUN_4G){var prodClass=order.prodModify.choosedProdInfo.prodClass;if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){prodClass=CacheData.getOfferMember(prodId).prodClass}else{if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){prodClass=OrderInfo.oldprodInstInfos[i].prodClass}}}}if(flag==0){if(prodClass==CONST.PROD_CLASS.THREE){$("#title_"+prodId).show();$("#uimDiv_"+prodId).show()}}else{if(flag==1){if(prodClass==CONST.PROD_CLASS.THREE){$("#uimDiv_"+prodId).hide()}}}}};var _isChangeUim=function(objId,action){if(CONST.getAppDesc()==0){var prodClass=order.prodModify.choosedProdInfo.prodClass;var prodId=order.prodModify.choosedProdInfo.prodInstId;if(OrderInfo.actionFlag==6){if(action=="delViceCard"){var member=CacheData.getOfferMember(objId);prodClass=member.prodClass;prodId=member.objInstId}else{if(action=="oldmember"){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==objId){prodClass=this.prodClass;prodId=this.prodInstId}})}}}if(prodClass==CONST.PROD_CLASS.THREE){var servSpec=CacheData.getServSpec(prodId,CONST.PROD_SPEC.PROD_FUN_4G);if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){return true}}}return false};var _setAttachBusiOrder=function(busiOrders){$.each(AttachOffer.openServList,function(){var prodId=this.prodId;$.each(this.servSpecList,function(){if(this.isdel!="Y"&&this.isdel!="C"){SoOrder.createServ(this,prodId,0,busiOrders)}})});$.each(AttachOffer.openedServList,function(){var prodId=this.prodId;$.each(this.servList,function(){if(this.isdel=="Y"){SoOrder.createServ(this,prodId,1,busiOrders)}else{if(this.update=="Y"){SoOrder.createServ(this,prodId,2,busiOrders)}}})});for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"){if(ec.util.isObj(spec.counts)){for(var k=0;k<spec.counts;k++){SoOrder.createAttOffer(spec,open.prodId,0,busiOrders)}}else{SoOrder.createAttOffer(spec,open.prodId,0,busiOrders)}}}}for(var i=0;i<AttachOffer.openedList.length;i++){var opened=AttachOffer.openedList[i];for(var j=0;j<opened.offerList.length;j++){var offer=opened.offerList[j];if(offer.isdel=="Y"){if(ec.util.isObj(offer.counts)){for(var k=0;k<offer.orderCount;k++){offer.offerId=offer.offerIds[k];SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{if(offer.update=="Y"){SoOrder.createAttOffer(offer,opened.prodId,2,busiOrders)}else{if(ec.util.isObj(offer.orderCount)&&ec.util.isObj(offer.counts)){if(offer.orderCount>offer.counts){for(var k=0;k<(offer.orderCount-offer.counts);k++){offer.offerId=offer.offerIds[k];SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{if(offer.orderCount<offer.counts){var spec=CacheData.getOfferSpec(opened.prodId,offer.offerSpecId);for(var k=0;k<(offer.counts-offer.orderCount);k++){}}}}}}}}$.each(AttachOffer.openAppList,function(){var prodId=this.prodId;$.each(this.appList,function(){if(this.dfQty==1){SoOrder.createServ(this,prodId,0,busiOrders)}})})};var _setChangeList=function(prodId){AttachOffer.changeList=[];var prodInfos=offerChange.resultOffer.prodInfos;if(ec.util.isArray(prodInfos)){$.each(prodInfos,function(){if(prodId!=this.accProdInstId){return true}if(prodId!=this.prodInstId){var param={prodInstId:prodId};var serv=CacheData.getServ(prodId,this.prodInstId);var servSpec=CacheData.getServSpec(prodId,this.productId);if(this.state=="DEL"){if(serv!=undefined&&serv.isdel!="Y"){param.objId=this.prodInstId;param.status=(serv.isdel!=undefined?serv.isdel:"N");param.objIdType=1;serv.isdel="Y";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){param.objId=this.productId;
param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(serv!=undefined&&serv.isdel=="Y"){param.objId=this.prodInstId;param.status=serv.isdel;param.objIdType=1;serv.isdel="N";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel=="Y"){param.objId=this.productId;param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(serv==undefined&&servSpec==undefined){param.objId=this.productId;param.status="Y";param.objIdType=2;AttachOffer.changeList.push(param);if(this.productId!=undefined&&this.productId!=""){var newSerSpec={objId:this.productId,servSpecId:this.productId,servSpecName:this.productName,ifParams:"N",isdel:"N"};CacheData.setServSpec(prodId,newSerSpec);var servSpec=CacheData.getServSpec(prodId,this.productId);servSpec.isdel="N"}}}}}}}})}var offers=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(offers)){$.each(offers,function(){if(this.memberInfo==undefined){return true}var flag=true;$.each(this.memberInfo,function(){if(ec.util.isObj(this.accProdInstId)&&prodId==this.accProdInstId){flag=false;return false}});if(flag){return true}var param={prodInstId:prodId};var offer=CacheData.getOffer(prodId,this.prodOfferInstId);var offerSpec=CacheData.getOfferSpec(prodId,this.prodOfferId);if(this.state=="DEL"){if(offer!=undefined&&offer.isdel!="Y"){param.objId=this.prodOfferInstId;param.status=(offer.isdel!=undefined?offer.isdel:"N");param.objIdType=3;offer.isdel="Y";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(offer!=undefined&&offer.isdel=="Y"){param.objId=this.prodOfferInstId;param.status=offer.isdel;param.objIdType=3;offer.isdel="N";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel=="Y"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(offer==undefined&&offerSpec==undefined){param.objId=this.prodOfferId;param.status="Y";param.objIdType=4;AttachOffer.changeList.push(param);if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){var newOfferSpec=_setSpec(prodId,this.prodOfferId);newOfferSpec.isdel="N"}}}}}}})}};var _reductionChangList=function(prodId){$.each(AttachOffer.changeList,function(){if(this.prodInstId==prodId){if(this.objIdType==1){var serv=CacheData.getServ(prodId,this.objId);if(serv!=undefined){serv.isdel=this.status}}else{if(this.objIdType==2){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec!=undefined){servSpec.isdel=this.status}}else{if(this.objIdType==3){var offer=CacheData.getOffer(prodId,this.objId);if(offer!=undefined){offer.isdel=this.status}}else{if(this.objIdType==4){var offerSpec=CacheData.getOfferSpec(prodId,this.objId);if(offerSpec!=undefined){offerSpec.isdel=this.status}}}}}}})};var _servExDepReByRoleObjs=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);paramObj.excludeServ=[];paramObj.dependServ=[];paramObj.relatedServ=[];var globContent="";$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec==undefined){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv==undefined){var newServSpec={objId:this.objId,servSpecId:this.objId,servSpecName:this.objName,ifParams:this.isCompParam,prodSpecParams:this.prodSpecParams,isdel:"C"};CacheData.setServSpec(prodId,newServSpec);servSpec=newServSpec}else{servSpec=serv}}var servSpecId=servSpec.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){}else{var data=query.offer.queryExcludeDepend(param);var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);if(content!=""){content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);globContent+=(content+"<br>")}}}})});return globContent};var paramObj={excludeServ:[],dependServ:[],relatedServ:[]};var paserServDataByObjs=function(result,prodId,serv,newSpec){var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";paramObj.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.dependServ.push(this)}})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.relatedServ.push(this)}})}return content};var _filterServ=function(servSpecId,newSpec){var flag=false;$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){if(servSpecId==this.objId){flag=true;return false}}})});if(!flag){if(ec.util.isArray(paramObj.dependServ)){for(var i=0;i<paramObj.dependServ.length;i++){if(servSpecId==paramObj.dependServ[i].servSpecId){flag=true;break}}}if(!flag){if(ec.util.isArray(paramObj.relatedServ)){for(var i=0;i<paramObj.relatedServ.length;i++){if(servSpecId==paramObj.relatedServ[i].servSpecId){flag=true;break}}}}}return flag};var _minQtyFileter=function(prodId,servSpecId){var serv=CacheData.getServBySpecId(prodId,servSpecId);var $li,$span,$span_remove;if(serv!=undefined){$li=$("#li_"+prodId+"_"+serv.servId);$span=$("#span_"+prodId+"_"+serv.servId);$span_remove=$("#span_remove_"+prodId+"_"+serv.servId)}else{$li=$("#li_"+prodId+"_"+servSpecId);$span=$("#span_"+prodId+"_"+servSpecId);$span_remove=$("#span_remove_"+prodId+"_"+servSpecId)}if($li!=undefined){if(ec.util.isObj($span)){$span.removeClass("del")}if(ec.util.isObj($span_remove)){$span_remove.hide()}$li.removeAttr("onclick")}};var _manyPhoneFilter=function(prodId,offerSpecId){if(OrderInfo.actionFlag==14){return true}var newSpec;var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(ec.util.isObj(offer)){newSpec=offer}else{newSpec=_setSpec(prodId,offerSpecId)}if(newSpec==undefined){return false}if(ec.util.isArray(newSpec.agreementInfos)){var num=0;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.objType==CONST.OBJ_TYPE.PROD){num++}})})}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){num++}})}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==prodId){num++}})}}}var minNum=newSpec.agreementInfos[0].minNum;var maxNum=newSpec.agreementInfos[0].maxNum;if(!ec.util.isObj(minNum)){$.alert("信息提示","销售品规格查询，未返回最小合约数，请后台确认。");return false}if(num<minNum){$.alert("信息提示","该合约的最小合约数为"+minNum+"个，而该套餐的成员实例只有"+num+"个，故无法办理该合约。");return false}if(maxNum>num){newSpec.agreementInfos[0].maxNum=num}}return true};var _addAndDelTerminal=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var fag=$(obj).attr("fag");var newSpec;var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(ec.util.isObj(offer)){newSpec=offer}else{newSpec=_setSpec(prodId,offerSpecId)}var objInstId=prodId+"_"+newSpec.offerSpecId;var maxNum=newSpec.agreementInfos[0].maxNum;var minNum=newSpec.agreementInfos[0].minNum;var $ul=$("#ul_"+objInstId);var $li=$("#ul_"+objInstId+" li");var length=$li.length-1;var isFastOffer=0;
if(ec.util.isArray(newSpec.extAttrParams)){$.each(newSpec.extAttrParams,function(){if(this.attrId==CONST.OFFER_FAST_FILL){isFastOffer=1;return false}})}if(fag==0){if(totalNums>=maxNum){$.alert("信息提示","终端数已经达到最大，不能再添加了。");return}var $liTerminalAdd=$('<li class="form-group"><label for="exampleInputFile">终端校验<span class="text-warning">*</span></label><div class="input-group"><input id="terminalText_'+objInstId+"_"+(length/2+1)+'" type="text" class="form-control" maxlength="50" placeholder="请先输入终端串号" /><span class="input-group-btn"><button id="terminalBtn_'+objInstId+"_"+(length/2+1)+'" type="button" flag="'+isFastOffer+'" num="'+(length/2+1)+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" class="btn btn-default">校验</button></li>');var $liAdd=$('<li id="terminalDesc_'+(length/2+1)+'" style="display:none;list-style-type:none;"><label></label><label id="terminalName_'+(length/2+1)+'"></label></span> </div></li>');$ul.append($liTerminalAdd).append($liAdd);totalNums++}else{if(minNum==(length/2)){$.alert("信息提示","终端数已经达到最小，不能再删除了。");return}$li.each(function(index){if(length-1==index){$(this).remove()}else{if(length==index){_filterAttach2Coupons(prodId,offerSpecId,(index/2));$(this).remove()}}});totalNums--}};var _checkData=function(objInstId,terminalCode){var $input=$("input[id^=terminalText_"+objInstId+"]");var num=0;$input.each(function(){var instCode=$.trim(this.value);if(ec.util.isObj(instCode)&&terminalCode==instCode){num++}});if(num>=2){$.alert("信息提示","终端串码重复了，请填写不同的串码。");return true}return false};var _filterAttach2Coupons=function(prodId,offerSpecId,num){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId&&attach2Coupon.num==num){OrderInfo.attach2Coupons.splice(i,1);$("#terminalName_"+num).html("");break}}};var _removeAttach2Coupons=function(prodId,offerSpecId){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId){OrderInfo.attach2Coupons.splice(i,1);i--}}};var _ifOrderAgain=function(newSpec){if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){if(parseInt(newSpec.orderCount)<newSpec.counts){$.alert("信息提示","可选包："+newSpec.offerSpecName+"至多只能订购"+newSpec.orderCount+"次");return true}}};var _setParam=function(prodId,offerSpecId,flag){var newSpec=_setSpec(prodId,offerSpecId);var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(flag==1){newSpec.counts=offer.counts}var content='<form id="paramForm">';content+='次数 : <input id="text_'+prodId+"_"+offerSpecId+'" class="inputWidth183px" type="text" value="'+newSpec.counts+'"><br>';content+="</form>";$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var nums=$("#text_"+prodId+"_"+offerSpecId).val();var reg=/^\+?[1-9][0-9]*$/;if(!reg.test(nums)){$.alert("信息提示","次数只能是正整数。");return}if(parseInt(newSpec.orderCount)<nums){$.alert("信息提示","可选包【"+newSpec.offerSpecName+"】至多只能订购"+newSpec.orderCount+"次");return}if(flag==1&&offer!=undefined){if(offer.orderCount>nums){if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offer.offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=query.offer.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}}offer.counts=nums}else{newSpec.counts=nums}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})};var _offerSpecDetail=function(prodId,offerSpecId){var offerSpecName="";var summary="";$.each(AttachOffer.allOfferList,function(){if(this.offerSpecId==offerSpecId){offerSpecName=this.offerSpecName;summary=this.summary}else{if(this.servSpecId==offerSpecId){offerSpecName=this.servSpecName;summary=this.summary}}});$("#detail_tbody").empty();var $tr=$("<tr></tr>");$tr.append("<td>"+offerSpecName+'</td><td width="900">'+summary+"</td>");$("#detail_tbody").append($tr);easyDialog.open({container:"div_detail_dialog"})};var _queryCardAttachOffer=function(cardTypeFlag){var prodInfo=order.prodModify.choosedProdInfo;var prodId=prodInfo.prodInstId;var param={prodId:prodId,prodSpecId:prodInfo.productId,offerSpecId:prodInfo.prodOfferId,acctNbr:prodInfo.accNbr};if(ec.util.isObj(prodInfo.prodBigClass)){param.prodBigClass=prodInfo.prodBigClass}var data=query.offer.queryAttachOfferHtml(param);$("#attach").html(data).show();var temp={boActionTypeCd:"14",cardType:cardTypeFlag=="1"?"4G":"3G",accNbr:prodInfo.accNbr,prodInstId:prodId,prodId:prodId,prodSpecId:prodInfo.productId};var data=query.offer.queryDefMustOfferSpecAndServ(temp);CacheData.parseOffer(data);CacheData.parseServ(data);if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){var member=CacheData.getOfferMember(prodId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==member.offerRoleId&&member.objType==CONST.OBJ_TYPE.PROD){var offerRole=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(this.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>')}}});return false}})}};var _show=function(prodId){$("#attach_"+prodId).show();$("#prodinfo_"+prodId).hide();$("#nextNav").hide();$("#c-indicators").hide()};var _btnBack=function(prodId){$("#prodinfo_"+prodId).show();$("#nextNav").show();$("#attach_"+prodId).hide();$("#c-indicators").show()};var _changeOfferS=function(obj,prodId,val){if(val=="0"){$("#open_ul_"+prodId).show();$("#open_serv_ul_"+prodId).hide()}else{$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).show()}};var _changeOfferOrdered=function(obj,prodId){var val=$(obj).val();if(val=="0"){$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).hide();$("#order_ul_"+prodId).show();$("#serv_ul_"+prodId).hide()}else{if(val=="1"){$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).hide();$("#order_ul_"+prodId).hide();$("#serv_ul_"+prodId).show()}else{if(val=="2"){$("#open_ul_"+prodId).show();$("#open_serv_ul_"+prodId).hide();$("#order_ul_"+prodId).hide();$("#serv_ul_"+prodId).hide()}else{if(val=="3"){$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).show();$("#order_ul_"+prodId).hide();$("#serv_ul_"+prodId).hide()}}}}};return{addOffer:_addOffer,addOfferSpec:_addOfferSpec,addOpenList:_addOpenList,addOpenServList:_addOpenServList,addOfferSpecByCheck:_addOfferSpecByCheck,addAndDelTerminal:_addAndDelTerminal,closeAttachSearch:_closeAttachSearch,changeLabel:_changeLabel,changeLabel1:_changeLabel1,changeList:_changeList,closeServ:_closeServ,closeServSpec:_closeServSpec,closeSearchAttach:_closeSearchAttach,checkData:_checkData,delOffer:_delOffer,delOfferSpec:_delOfferSpec,labelList:_labelList,isChangeUim:_isChangeUim,init:_init,openList:_openList,openedList:_openedList,openServList:_openServList,openedServList:_openedServList,openServSpec:_openServSpec,openAppList:_openAppList,queryAttachOffer:_queryAttachOffer,queryAttachOfferSpec:_queryAttachOfferSpec,queryCardAttachOffer:_queryCardAttachOffer,showParam:_showParam,showServParam:_showServParam,showTime:_showTime,setAttachTime:_setAttachTime,searchAttachOfferSpec:_searchAttachOfferSpec,selectAttachOffer:_selectAttachOffer,showOfferTime:_showOfferTime,showMainParam:_showMainParam,showMainMember:_showMainMember,selectServ:_selectServ,showStartTime:_showStartTime,showEndTime:_showEndTime,setAttachBusiOrder:_setAttachBusiOrder,showApp:_showApp,showHideUim:_showHideUim,showMainRoleProd:_showMainRoleProd,checkTerminalCode:_checkTerminalCode,checkOfferExcludeDepend:_checkOfferExcludeDepend,checkServExcludeDepend:_checkServExcludeDepend,servExDepReByRoleObjs:_servExDepReByRoleObjs,setChangeList:_setChangeList,reductionChangList:_reductionChangList,filterServ:_filterServ,setParam:_setParam,showMainMemberRoleProd:_showMainMemberRoleProd,changeOfferS:_changeOfferS,changeOfferOrdered:_changeOfferOrdered,offerSpecDetail:_offerSpecDetail,show:_show,btnBack:_btnBack}
})();CommonUtils.regNamespace("order","calcharge");order.calcharge=(function(){var O=[];var i=[];var j=0;var Q=0;var S=0;var L=0;var C="newOrder";var J=false;var k=false;var M="";var a="";var t="";var w="";var g=function(W,V){if($("#div_payitem_"+W)!=undefined&&$("#div_payitem_"+W).html()!=undefined){var X=$("#div_payitem_"+W).html();var U=$("#paydialog").html();var T=$.popup("#div_payitem_choose_"+W,X,{width:600,height:500,contentHeight:400,afterClose:function(){$("#paydialog").html(U)}});order.calcharge.trObj=V}else{$.alert("提示","没有可添加费用项的业务对象！")}};var d=function(ab,Y,V,U,Z,aa,T,X){var ac="0";if(OrderInfo.actionFlag==11){ac="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){ac="2"}}var W={boId:ab,objInstId:T,prodId:X,boActionTypeCd:Y,actionFlag:OrderInfo.actionFlag,objType:V,objId:U,itemNum:S,objName:Z,actionName:aa,refundType:ac};$.callServiceAsHtml(contextPath+"/pad/order/getChargeAddByObjId",W,{before:function(){$.ecOverlay("<strong>正在增加收费项,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(ad){if(ad.code!=0){$.alert("提示","查询失败,稍后重试");return}$("#div_payitem_choose_"+X).popup("close");f(ab,ad.data)},fail:function(ad){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var f=function(T,U){if(U!=""){$(order.calcharge.trObj).parent().parent().parent().after(U);var V=$("#order_confirm");$.jqmRefresh(V);S--;l()}else{$.alert("提示","没有可添加的费用项");return}};var B=function(U,W,V){if(V=="old"){var T=$("#feeAmount_"+W).val();if(($("#realAmount_"+W).val())*100==0){$("#realAmount_"+W).val(((T/100).toFixed(2))+"")}else{$("#realAmount_"+W).val("0")}var X=($("#realAmount_"+W).val())*100;if(X!=T){$("#chargeModifyReasonCd_"+W).show()}else{$("#chargeModifyReasonCd_"+W).hide()}}else{$(U).parent().parent().parent().remove()}l()};var l=function(){O=[];i=[];var X=0;$("#calChangeTab tr").each(function(){var aa=$(this).attr("id");if(aa!=undefined&&aa!=""){aa=aa.substr(5,aa.length);if($("#paymentAmount_"+aa)&&$("#paymentAmount_"+aa).val()*1==0){}else{var Y=$("#realAmount_"+aa).val();if(!isNaN(Y)){var Z=($("#realAmount_"+aa).val())*1;if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){Z=($("#backAmount_"+aa).val())*1}X=X+Z;$("#realhidden_money"+aa).val(X);D(aa)}}}});if(OrderInfo.actionFlag==15){var U=0;$("#calChangeTab tr").each(function(){var Z=$(this).attr("id");if(Z!=undefined&&Z!=""){if($("#paymentAmount_"+Z)&&$("#paymentAmount_"+Z).val()*1==0){}else{Z=Z.substr(5,Z.length);var Y=($("#backAmount_"+Z).val())*1;U=U+Y}}});$("#backAmount").val(Number(U).toFixed(2))}var V=0;var W=$("input[name='realhidden_']");for(var T=0;T<W.length;T++){V+=W[T].value*1}$("#realMoney").html(Number(V).toFixed(2));if(OrderInfo.actionFlag==15){order.refund.conBtns()}else{y()}};var c=function(){var V=true;var U=true;var T=true;$("#calChangeTab tr").each(function(){var Z=$(this).attr("id");if(Z!=undefined&&Z!=""){Z=Z.substr(5,Z.length);var aa=$("#chargeModifyReasonCd_"+Z).val();if(aa=="1"){if($("#remark_"+Z).val()==undefined||$("#remark_"+Z).val()==null||$("#remark_"+Z).val()==""){V=false}}var Y=$("#payMethodCd_"+Z).val();var W=$("#terminalNumber").val();var X=$("#serialNumber").val();if(Y=="110101"){if(W==undefined||$.trim(W)==""){T=false}if(X==undefined||$.trim(X)==""){T=false}if(W.length>100){U=false}if(X.length>100){U=false}}}});if(!V){$.alert("提示信息","请填写修改原因");return false}if(!T){$.alert("提示信息","pos流水号或者终端号不能为空，请重新输入！");return false}if(!U){$.alert("提示信息","pos流水号或者终端号长度超过100位，请重新输入！");return false}O=[];z();return true};var z=function(){$("#calChangeTab tr").each(function(){var am=$(this).attr("id");if(am!=undefined&&am!=""){am=am.substr(5,am.length);var ab=($("#realhidden_money"+am).val())*100+"";if(isNaN(ab)){return}var U=($("#realhidden_money"+am).val())*100+"";var aa=$("#feeAmount_"+am).val();var X="";if(aa!=undefined&&aa!=""){X=aa+""}else{X=U}if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){X=$("#feeAmount_"+am).val()*1+"";U=(0-($("#backAmount_"+am).val())*100)+""}var T=$("#acctItemTypeId_"+am).val();var ae=$("#objId_"+am).val();var ag=$("#objType_"+am).val();var ah=$("#acctItemId_"+am).val();var aj=$("#boId_"+am).val();var W=$("#payMethodCd_"+am).val();var V=$("#objInstId_"+am).val();var ai=$("#prodId_"+am).val();var ac=$("#boActionType_"+am).val();var af=$("#paymentAmount_"+am).val();var ad=1;var ak="";if($("#chargeModifyReasonCd_"+am).css("display")=="none"){if(X!=U){ak="其他"}}else{ad=$("#chargeModifyReasonCd_"+am).val();ak=$("#chargeModifyReasonCd_"+am).find("option:selected").text();if(ad=="1"){ak=$("#remark_"+am).val()}}if(X!=U&&ak==""){ak="其他"}var al="";var Y="";if(W=="110101"){al=$("#terminalNumber").val();Y=$("#serialNumber").val()}var Z={realAmount:U,feeAmount:X,paymentAmount:af,acctItemTypeId:T,objId:ae,objType:ag,acctItemId:ah,boId:aj,prodId:ai,objInstId:V,payMethodCd:W,terminalNo:al,posSeriaNbr:Y,chargeModifyReasonCd:ad,remark:ak,boActionType:ac};O.push(Z)}})};var x=function(W,Z,Y){var U={acctItemTypeId:W};var T=contextPath+"/app/order/queryPayMethodByItem";var V=$.callServiceAsJson(T,U);if(V.code==0){if(V.data!=undefined&&V.data!=null){if(V.data.length>0){var aa=V.data;var ab=false;if(OrderInfo.actionFlag==11){if(aa[0].limitChange=="N"){return true}}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){if(aa[0].limitBuyBack=="N"){return true}}else{if(OrderInfo.actionFlag==15){if(aa[0].limitRedo=="N"){ab=true}}else{if(aa[0].limitChange=="N"){ab=true}}}}var ac=aa[0].payMethods;if(ac.length>0){if(Z){var X='<select  id="changeMethod_'+Z+'"  data-native-menu="false">';$.each(ac,function(ad,ae){if(ae.payMethodCd==Y){X+='<option value="'+ae.payMethodCd+'" selected="selected">'+ae.payMethodName+"</option>"}else{X+='<option value="'+ae.payMethodCd+'">'+ae.payMethodName+"</option>"}});X+="</select>";$("#payMethodText_"+Z).html(X)}}return ab}else{return false}}else{return false}}else{if(V.code==-2){$.alertM(V.data);return false}else{$.alert("提示","查询付费方式失败!");return false}}};var e=function(T){if($("#chargeModifyReasonCd_"+T).val()=="1"){$("#chargeModifyReasonCdDiv_"+T).hide();$("#chargeModifyReasonCdDiv_"+T).next(".edit").show()}$("#chargeModifyButton_"+T).on("onclick",function(){$(this).parents().find(".edit").hide();$("#chargeModifyReasonCd_"+T+" option").each(function(){if($(this).val()=="3"){$(this).attr("selected",true)}});$("#chargeModifyReasonCd_"+T).selectmenu("refresh");$("#chargeModifyReasonCdDiv_"+T).show()})};var q=function(U,X,V,W){var T=x(U,X,V);if(T){if(A(X)){$("#payMethodDiv").html($("#payMethodText_"+X).html());$("#chargeModifyReasonCd_"+X).off("change").on("change",function(){if($(this).val()=="1"){$("#remark_"+X).css("display","inline")}else{$("#remark_"+X).css("display","none")}});if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20||OrderInfo.actionFlag==15){$("#backAmount_"+X).removeAttr("disabled").css("border","1px solid #DCDCDC").focus()}else{$("#realAmount_"+X).removeAttr("disabled").css("border","1px solid #DCDCDC").focus()}$("#changeMethod_"+X).off("change").on("change",function(){var Y=$(this).val();$("#payMethodCd_"+X).val(Y);$("#changeMethod_"+X).selectmenu("refresh");if(Y=="110101"){$("#posDiv").css("display","inline");$("#posDiv").css("disabled","")}else{$("#posDiv").css("display","none");$("#posDiv").css("disabled","disabled")}})}}};var A=function(Z){var Y={};var W=contextPath+"/app/order/queryAuthenticDataRange";var U=$.callServiceAsJson(W,Y);if(U.code==0){var V=U.data;var T=false;for(var X=0;X<V.length;X++){if($("#acctItemTypeId_"+Z).val()==V[X].dataDimensionName){T=true;break}else{T=false}}if(T){return true}else{$.alert("提示","当前费用项不允许修改!");return false}}else{if(U.code==-2){$.alertM(U.data);return false}else{$.alert("提示","权限数据范围查询失败!");return false}}};var D=function(X){var ad=($("#realAmount_"+X).val())*100+"";var ab=$("#feeAmount_"+X).val();var Z="";if(ab!=undefined&&ab!=""){Z=ab+""}else{Z=ad}var aa=$("#acctItemTypeId_"+X).val();var U=$("#objId_"+X).val();var W=$("#objType_"+X).val();var ac=$("#acctItemId_"+X).val();var Y=$("#acctItemTypeName_"+X).val();
var T=$("#paymentAmount_"+X).val();var V={realmoney:ad,feeAmount:Z,paymentAmount:T,acctItemTypeId:aa,objId:U,objType:W,acctItemId:ac,acctItemTypeName:Y};i.push(V)};var p=function(W,Z,Y){var X=$("#trid").val();if(typeof W=="object"){M=$.trim($(W).val())}else{M=W}if(M==""){$(W).val("0");order.calcharge.reflashTotal()}else{if(Y=="old"){var V=$("#feeAmount_"+Z).val();var T=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(M)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");T=false}else{if((M*100>V*1)&&V>0){$.alert("提示","实收费用金额不能高于应收金额！");T=false}else{if((M*100<V*1)&&V<0){$.alert("提示","实收费用金额不能低于应收金额！");T=false}}}if(T){var aa=(M)*100;if(aa!=V){$("#chargeModifyReasonCdDiv_"+Z).show()}else{$("#chargeModifyReasonCdDiv_"+Z).hide()}if(typeof W!="object"){$("#cal_main_content").show();$("#edit_content").hide()}$("#chargeModifyReasonCd_"+Z)[0].style.display="block";l()}else{if(L!=""){}L=""}}else{if(Y=="undo"){var T=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(M)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");T=false}else{if(M<0){$.alert("提示","退费金额不能为负值！");T=false}else{var V=$("#realhidden_"+Z).val();var U=M*-1;if(U<V*1){$.alert("提示","退费金额不能高于实收金额！");T=false}}}if(T){var aa=($(W).val())*-1;if(aa!=0){$("#chargeModifyReasonCdDiv_"+Z).show()}else{$("#chargeModifyReasonCdDiv_"+Z).hide();$("#chargeModifyReasonCdDiv_"+Z).next(".edit").hide()}if(typeof W!="object"){$("#cal_main_content").show();$("#edit_content").hide()}l()}else{if(L!=""){$(W).val(L)}L=""}}else{if(Y=="new"){if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(M)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");if(L!=""){$(W).val(L)}L=""}else{if(M<0){$.alert("提示","实收费用金额不能为负值！")}else{if(typeof W!="object"){$("#cal_main_content").show();$("#edit_content").hide()}l()}}}}}}a=$("#changeMethod_"+Z).val();t=$("#chargeModifyReasonCd_"+Z).val();w=$("#remark_"+Z).val()};var u=function(T){L=$.trim($(T).val())};var F=function(){$("#toComplate").attr("disabled","disabled");$("#orderCancel").attr("disabled","disabled");$("#orderBack").attr("disabled","disabled");$("#orderCancel").off("onclick");$("#toComplate").off("onclick");$("#toCharge").off("onclick")};var y=function(){$("#orderCancel").removeAttr("disabled");$("#orderBack").removeAttr("disabled");var T=$.trim($("#realMoney").html())*1;if(OrderInfo.actionFlag==11){$("#orderCancel").off("onclick").on("onclick",function(U){order.undo.orderBack()})}else{$("#orderCancel").off("onclick").on("onclick",function(U){SoOrder.orderBack()})}if(!J){if(T!=0){$("#toCharge").removeAttr("disabled");$("#toComplate").attr("disabled","disabled");$("#toCharge").off("onclick").on("onclick",function(U){r("1")});$("#toComplate").off("onclick")}else{$("#toComplate").removeAttr("disabled");$("#toCharge").off("onclick");$("#toComplate").off("onclick").on("onclick",function(U){b("0",false)})}}else{$("#toCharge").removeAttr("disabled");$("#toComplate").attr("disabled","disabled");$("#toCharge").off("onclick");$("#toComplate").off("onclick")}};var r=function(T){F();if(J){$.alert("提示","订单已经建档成功,不能重复操作!");return}if(k){return}if(!c()){y();return}k=true;var U=contextPath+"/app/order/updateChargeInfoForCheck";var V={olId:j,soNbr:OrderInfo.order.soNbr,areaId:OrderInfo.staff.areaId,chargeItems:O,custId:OrderInfo.cust.custId};$.callServiceAsJson(U,V,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},done:function(W){$.unecOverlay();if(W.code==0){b(T,true)}else{if(W.code==-2){y();k=false;$.alertM(W.data)}else{y();k=false;if(W.data!=undefined){$.alert("提示",W.data)}else{$.alert("提示","代理商保证金校验失败!")}}}}})};var o=function(X){var V=contextPath+"/app/order/checkRuleToProv";var Y={olId:X.rolId,soNbr:X.rsoNbr,areaId:OrderInfo.staff.areaId,chargeItems:[]};$.ecOverlay("<strong>正在下省校验,请稍等会儿....</strong>");var U=$.callServiceAsJson(V,Y);$.unecOverlay();var T;if(U.code==0){var W=U.data;if(W.checkResult!=undefined){OrderInfo.checkresult=W.checkResult}T={code:0}}else{T={code:1,data:U.data}}return T};var b=function(aa,Z){var ab=$("#realmoney").val();if(ab=="0.00"){if(!c()){return}}var W={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,areaId:OrderInfo.staff.areaId,chargeItems:O};var T=contextPath+"/app/order/chargeSubmit?token="+OrderInfo.order.token;var X=$.callServiceAsJson(T,W,{});var V="";if(X.code==0){J=true;SoOrder.delOrderFin();if(OrderInfo.actionFlag==31){var T=contextPath+"/cust/passwordReset";var Y=$.callServiceAsJson(T,null,{})}if(aa=="1"){if(OrderInfo.actionFlag==11){V="退费成功"}else{V="收费成功"}}else{V="受理成功"}$("#toComplate").removeAttr("disabled");$("#orderCancel").removeAttr("disabled");$("#printVoucherA").attr("disabled","disabled");$("#calChangeTab tr").each(function(){var ac=$(this).attr("id");if(ac!=undefined&&ac!=""){ac=ac.substr(5,ac.length);$("#backAmount_"+ac).attr("disabled","disabled");$("#upate").attr("disabled","disabled")}});if(OrderInfo.actionFlag==11){$("#orderCancel").html("<span>返回首页</span>");$("#orderCancel").off("onclick").on("onclick",function(ac){order.undo.toUndoMain(1)})}else{var U=OrderInfo.provinceInfo.redirectUri;if(U!=null&&U!=undefined&&U!=""){$("#orderCancel").off("click").on("click",function(ac){R()})}}SoOrder.updateResState();if(aa=="1"){var ab=($("#realMoney").html())*1;N(aa,V)}else{N(aa,V)}return}else{if(X.code==-2){y();SoOrder.getToken();k=false;$.alertM(X.data)}else{y();SoOrder.getToken();k=false;if(X.data!=undefined){alert(X.data)}else{$.alert("提示","费用信息提交失败!")}}}};var N=function(T,V){var U="";if(T=="1"){if(OrderInfo.actionFlag==11){U="退费结果"}else{U="收费结果"}}else{U="受理结果"}$("#btn-dialog-ok").removeAttr("data-dismiss");$("#alert-modal").modal({backdrop:"static",keyboard:false});var W=OrderInfo.provinceInfo.redirectUri;if(W!=null&&W!=undefined&&W!=""){$("#btn-dialog-ok").off("click").on("click",function(X){R()})}else{$("#div_info_btn").hide()}$("#modal-title").html(U);$("#modal-content").html(V);$("#alert-modal").modal()};var v=function(V,U){var T=$("#payMethodCd_"+V);T.empty();$("select[@id=backpayMethodCd_"+V+"] option").each(function(){var X=$(this).val();if(X!=undefined){var W=$(this).text();if(X.split("_")[1]==$(U).val()){$("<option value='"+X.split("_")[0]+"'>"+W+"</option>").appendTo(T)}}})};var H=function(){common.callCloseWebview()};var h=function(){j=OrderInfo.orderResult.olId;Q=OrderInfo.orderResult.soNbr;O=[];i=[];S=0;L=0;J=false;k=false;var T="0";if(OrderInfo.actionFlag==11){T="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){T="2"}}var U={olId:j,custVipLevel:OrderInfo.cust.vipLevel,actionFlag:OrderInfo.actionFlag,actionTypeName:encodeURI(OrderInfo.actionTypeName),businessName:encodeURI(OrderInfo.businessName),olNbr:OrderInfo.orderResult.olNbr,soNbr:OrderInfo.order.soNbr,refundType:T,checkResult:JSON.stringify(OrderInfo.checkresult)};$.callServiceAsHtmlGet(contextPath+"/token/app/order/getChargeList",U,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){},done:function(V){$.unecOverlay();SoOrder.getToken();if(V.code!=0){$.alert("提示","收费页面加载失败，请稍后重试");return}if(OrderInfo.provinceInfo.isFee=="1"){SoOrder.delOrderFin();$("#toComplate").attr("disabled","disabled");var Y=OrderInfo.provinceInfo.redirectUri;if(Y!=null&&Y!=""&&Y!="undefined"){R()}else{$("#btn-dialog-ok").removeAttr("data-dismiss");$("#alert-modal").modal({backdrop:"static",keyboard:false});$("#div_info_btn").hide();$("#modal-title").html("提示");$("#modal-content").html("订单暂存成功！");$("#alert-modal").modal()}}else{if(OrderInfo.provinceInfo.isFee=="2"){SoOrder.getToken();var X=$("#order-confirm").html(V.data).fadeIn();var W=$("#paydialog").html();$("#paydialog").html("");$.refresh(X);$("#paydialog").html(W);$.each($(".cashier_dd"),function(){var Z=$(this).attr("id");var aa=$(this);if($.trim($(this).html())==""&&$(".userorderlist")!=undefined){$.each($("#userorderlist li").find("dl:eq(0)"),function(){var ac=$(this).attr("prodInstId");var ad=$(this).attr("accNbr");var ab=$(this).attr("productName");if(ac!=undefined&&ad!=undefined){if(Z==ac){aa.html(ab+"&nbsp;-&nbsp;"+ad)}}})}});$("#printVoucherA").off("click").on("click",function(Z){if(!c()){return}var aa={olId:j,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:O,areaId:OrderInfo.getAreaId()};
common.print.signVoucher(aa)});if(OrderInfo.actionFlag==15){order.refund.conBtns()}else{y()}}}},fail:function(V){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var I=function(){var T={olId:OrderInfo.order.oldSoId,soNbr:OrderInfo.order.oldSoNbr};$.callServiceAsHtmlGet(contextPath+"/app/order/invaideInvoice",T,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},done:function(U){$.unecOverlay();if(U.code==0){var V=$.parseJSON(U.data);if(V.code==0){$("#successTip_dialog_inv").off("onclick");$.alert("提示","作废发票成功！")}else{if(V.code==1){$.alert("提示","作废发票失败！")}else{if(V.code==2){$.alert("提示","未获取到发票信息！")}else{if(V.code==3){$.alert("提示","获取发票失败！")}else{$.alert("提示","作废发票异常！")}}}}}else{if(U.code==-2){}else{$.alert("提示","作废发票异常！")}}},fail:function(U){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var K=function(U,X,V){var W={trid:X};var T=contextPath+"/token/app/order/getEditPage";$.callServiceAsHtmlGet(T,W,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(Y){$.unecOverlay();$("#cal_main_content").hide();var Z=$("#edit_content");Z.html(Y.data).show();$("#cal_main_content").hide();$("#edit_content").show();$("#pnumber").text(U);$("#payMethodDiv").html($("#payMethodText_"+X).html());$("#editBtnDiv").html($("#editBtn_"+X).html());V=$("#realhidden_money"+X).val();$("#realAmount_"+X).val(V);if(a!=""){$("#changeMethod_"+X).val(a)}if(t!=""){$("#chargeModifyReasonCd_"+X).val(t)}$("#remark_"+X).val(w)},fail:function(Y){$.alert("提示","显示费用编辑页面失败，请稍后再试！")}})};var m=function(){var U=$("#trid").val();p($("#realAmount_"+U).val(),U,"old");var T=$("#payMethodDiv select").val();if(T!=null&&T!=""&&T!=undefined){$("#payMethodCd_"+U).val(T)}};var P=function(T,V,U){$("#cal_main_content").show();$("#edit_content").hide()};var G=function(T){if(T&&T.page&&T.page>=1){s(T.page,T.scroll)}};var s=function(U,T){OrderInfo.actionFlag=140;var V=1;if(U>0){V=U}var W={};W={startDate:($("#p_startDt").val()).replace(/-/g,""),channelId:$("#p_channelId").val(),areaId:$("#p_channelId").attr("areaid"),pageIndex:V,pageSize:10};$.callServiceAsHtmlGet(contextPath+"/app/report/freeInfoList",W,{before:function(){$.ecOverlay("终端销售详情查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(X){if(X&&X.code==-2){return}else{$("#fee_search").hide();$("#fee_list").html(X.data).show();OrderInfo.order.step=2;$("#fee_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(T&&$.isFunction(T)){T.apply(this,[])}}},fail:function(X){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var E=function(){if(OrderInfo.order.step==1){common.callCloseWebview()}else{if(OrderInfo.order.step==2){$("#fee_search").show();$("#fee_list").hide();OrderInfo.order.step=1}else{common.callCloseWebview()}}};var R=function(){var T={provIsale:OrderInfo.provinceInfo.provIsale,extCustOrderID:OrderInfo.orderResult.olId,resultCode:"0",redirectUri:OrderInfo.provinceInfo.redirectUri};$.callServiceAsHtmlGet(contextPath+"/mode/app/backProvince",T,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){},done:function(U){$.unecOverlay();if(U.code==0){var V=$.parseJSON(U.data);if(V.code==0){if(V.data.indexOf("&amp;")!=-1){V.data=V.data.replace(/\&amp;/g,"&")}window.location.href=V.data;return}else{if(V.code==1){$.alert("提示",V.data)}}}else{$.alert("提示","页面回调异常！")}},fail:function(U){$.unecOverlay();$.alert("提示","页面回调可能发生异常，请稍后再试！")}})};return{addItems:f,delItems:B,reflashTotal:l,editMoney:p,setGlobeMoney:u,addbusiOrder:g,addSubmit:d,selePaymethod:v,calchargeInit:h,pageFlag:C,changePayMethod:q,bindChargeModifyReason:e,invaideInvoice:I,tochargeSubmit:o,chargeSave:b,showEditPage:K,confirm:m,close:P,updateChargeInfoForCheck:r,feeScroll:G,btnQueryfee:s,back:E,backToProvince:R}})();$(function(){OrderInfo.order.step=1});CommonUtils.regNamespace("order","service");order.service=(function(){var x="";var h="";var i=function(){OrderInfo.order.step=1;OrderInfo.busitypeflag=1;OrderInfo.actionFlag=1;order.service.queryApConfig();order.service.searchPack(h)};var p="";var s=function(z){if(p!=z){var y=$(".btn-group button");$.each(y,function(){if(z==this){$("#qryStr").val($(this).attr("value"));var A=$("#subPage").val();g(A);p=z;$(this).removeClass("btn btn-default");$(this).removeClass("btn btn-default active");$(this).addClass("btn btn-default btn-group-active")}else{$(this).removeClass("btn btn-default active");$(this).removeClass("btn btn-default btn-group-active");$(this).addClass("btn btn-default")}})}};var g=function(F,E,H){var G=OrderInfo.cust.custId;var J=$("#qryStr").val();var B={subPage:F,qryStr:J,pnLevelId:"",custId:G,PageSize:10};if(F){var A=$("#select_price").val();if(ec.util.isObj(A)){var D=A.split("-");if(D[0]!=null&&D[0]!=""){B.priceMin=D[0]}if(D[1]!=null&&D[1]!=""){B.priceMax=D[1]}}var I=$("#select_invoice").val();if(ec.util.isObj(I)){var z=I.split("-");if(z[0]!=null&&z[0]!=""){B.INFLUXMin=z[0]*1024}if(z[1]!=null&&z[1]!=""){B.INFLUXMax=z[1]*1024}}var y=$("#select_influx").val();if(ec.util.isObj(y)){var C=y.split("-");if(C[0]!=null&&C[0]!=""){B.INVOICEMin=C[0]}if(C[1]!=null&&C[1]!=""){B.INVOICEMax=C[1]}}}m(B,F,E)};var m=function(C,z,y){if(OrderInfo.actionFlag==2){var D=order.prodModify.choosedProdInfo.prodOfferId;if(D!=undefined){C.changeGradeProdOfferId=D}var B="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.objId!=undefined){B=B+","+this.objId}}});if(B!=""){B=B.substring(1,B.length);C.prodSpecId=B}C.actionFlag=2}else{if(CONST.getAppDesc()==0){C.prodOfferFlag="4G"}}var A=contextPath+"/token/app/order/offerSpecListSub";$.callServiceAsHtmlGet(A,C,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay();$("#search-modal").modal("hide")},done:function(E){$("#search-modal").modal("hide");if(E.code!=0){$.alert("提示","<br/>查询失败,稍后重试");return}var F=$("#offer-list");F.html(E.data);if(y&&$.isFunction(y)){y.apply(this,[])}},fail:function(E){$.unecOverlay();$("#search-modal").modal("hide");$.alert("提示","套餐加载失败，请稍后再试！")}})};var j=function(B){if(B&&B.page&&B.page>=1){if(B.page==1){g(1,B.scroll)}else{var z=10;var A=(B.page-2)*z;var y=A+z;$("#div_all_data").children().slice(A,y).appendTo($("#div_offer_list"));if(B.scroll&&$.isFunction(B.scroll)){B.scroll.apply(this,[])}}}};var r=function(){var z={CONFIG_PARAM_TYPE:"PROD_AND_OFFER"};var y=contextPath+"/app/order/queryApConf";$.callServiceAsJsonGet(y,z,{done:function(A){if(A.data){var E=A.data.length;for(var D=0;D<E;D++){if(A.data[D].OFFER_PRICE){OFFER_PRICE=A.data[D].OFFER_PRICE;for(var B=0;B<OFFER_PRICE.length;B++){var F=OFFER_PRICE[B].COLUMN_VALUE;var C=OFFER_PRICE[B].COLUMN_VALUE_NAME;$("#select_price option[value='"+F+"']").remove();$("#select_price").append("<option value='"+F+"'>"+C+"</option>")}}else{if(A.data[D].OFFER_INFLUX){OFFER_INFLUX=A.data[D].OFFER_INFLUX;for(var B=0;B<OFFER_INFLUX.length;B++){var F=OFFER_INFLUX[B].COLUMN_VALUE;var C=OFFER_INFLUX[B].COLUMN_VALUE_NAME;$("#select_invoice option[value='"+F+"']").remove();$("#select_invoice").append("<option value='"+F+"'>"+C+"</option>")}}else{if(A.data[D].OFFER_INVOICE){OFFER_INVOICE=A.data[D].OFFER_INVOICE;for(var B=0;B<OFFER_INVOICE.length;B++){var F=OFFER_INVOICE[B].COLUMN_VALUE;var C=OFFER_INVOICE[B].COLUMN_VALUE_NAME;$("#select_influx option[value='"+F+"']").remove();$("#select_influx").append("<option value='"+F+"'>"+C+"</option>")}}}}$.refresh($("#search-modal"))}}}})};var q=function(B,C,y){var D={aoId:B,agreementType:C,numLevel:y};var A=contextPath+"/order/queryPackForTerm";var z=$.callServiceAsJson(A,D,{});return z};var t=function(y,A){var z=OrderInfo.cust.custId;offerprice=A;if(OrderInfo.cust==undefined||z==undefined||z==""){$.alert("提示","在订购套餐之前请先进行客户定位！")}else{var C={price:A,specId:y,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};if(OrderInfo.actionFlag==2){order.service.opeSer(C)}else{var B=[{boActionTypeCd:"S1",instId:"",specId:y}];rule.rule.ruleCheck(B,function(D){if(ec.util.isObj(D)){$("#order_prepare").hide();var E=$("#order").html(D).show();
$.refresh(E)}else{order.service.opeSer(C)}})}}};var a=function(D){var z={offerSpecId:D.specId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var A=query.offer.queryMainOfferSpec(z);if(!A){return}if(OrderInfo.actionFlag==2){var y=contextPath+"/app/order/queryFeeType";$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");var B=$.callServiceAsJsonGet(y,z);$.unecOverlay();if(B.code==0){if(B.data!=undefined){if("0"==B.data){var G=false;if(order.prodModify.choosedProdInfo.feeType=="2100"&&(A.feeType=="2100"||A.feeType=="3100"||A.feeType=="3101"||A.feeType=="3103"||A.feeType=="1202"||A.feeType=="2101")){G=true}else{if(order.prodModify.choosedProdInfo.feeType=="1200"&&(A.feeType=="1200"||A.feeType=="3100"||A.feeType=="3102"||A.feeType=="3103"||A.feeType=="1202"||A.feeType=="2101")){G=true}else{if(order.prodModify.choosedProdInfo.feeType=="1201"&&(A.feeType=="1201"||A.feeType=="3101"||A.feeType=="3102"||A.feeType=="3103")){G=true}}}if(!G){alert("付费类型不一致,无法进行套餐变更。");return}}}}offerChange.offerChangeView();return}var C=0;var F=0;var E="";$("#div_content").empty();$.each(A.offerRoles,function(){var H=this;if(H.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){$.each(this.roleObjs,function(){var I=H.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){if(H.minQty==0){this.minQty=0;this.dfQty=0}F=this.maxQty<0?"不限制":this.maxQty;E+="<div class='form-group'><label for='"+I+"'>副卡数量:"+this.minQty+"-"+F+"(张)</label><div class='input-group input-group-lg'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.subNum('"+I+"',"+this.minQty+")> - </button></span><input type='text'  readonly='readonly' class='form-control' id='"+I+"' value='"+this.dfQty+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.addNum('"+I+"',"+this.maxQty+",'"+H.parentOfferRoleId+"')> + </button></span> </div></div>";C++;return false}})}});var z={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:A,actionFlag:1,type:1};if(C>0){$("#div_content").append(E);$("#vice_modal").modal("show");$("#btn_modal").off("click").on("click",function(){order.service.confirm(z)})}else{if(!d(1)){$.alert("错误提示","请选择一个接入产品");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(z)}}};var v=function(y){if(!d()){$.alert("错误提示","请选择一个接入产品");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(y)}$("#vice_modal").modal("hide")};var d=function(z){var A=-1;var y=false;$.each(OrderInfo.offerSpec.offerRoles,function(){var B=this;B.prodInsts=[];$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var C=0;if(z==1){C=1}else{if(B.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&OrderInfo.actionFlag!=6){C=1}else{C=$("#"+B.offerRoleId+"_"+this.objId).val()}}if(C==undefined||C==""){C=0}for(var E=0;E<C;E++){var D=jQuery.extend(true,{},this);D.prodInstId=A--;if(C>1){D.offerRoleName=B.offerRoleName+(E+1)}else{D.offerRoleName=B.offerRoleName}D.memberRoleCd=B.memberRoleCd;B.prodInsts.push(D);y=true}B.selQty=C}else{if(this.minQty==0){this.dfQty=1}}})});return y};var k=function(y,F,D){OrderInfo.newPhoneId=y;if(ec.util.isObj(D)){var H=0;var C=[];var z=0;$.each(OrderInfo.offerSpec.offerRoles,function(){var I=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var J=I.offerRoleId+"_"+this.objId;if(ec.util.isObj(I.parentOfferRoleId)&&D==I.parentOfferRoleId){C.push(I);z=I.parentMaxQty;H+=Number($("#"+J).val())}}})});if(z>0){if(H>=z){if(ec.util.isArray(C)){var E="【";for(var A=0;A<C.length;A++){var G=C[A];E+=G.offerRoleName+","}E=E.substr(0,E.lastIndexOf(","));E+="】角色成员数量总和不能超过"+z;$.alert("规则限制",E);return}}}}var B=Number($("#"+y).val());if(F<0){B+=1;$("#"+y).val(B)}else{if(B<F){B+=1;$("#"+y).val(B)}}};var w=function(A,z){var y=Number($("#"+A).val());if(y>z){y-=1;$("#"+A).val(y)}};var o=function(){$("#order_prepare").show();$("#order").hide()};var b=0;var c={};var u=function(y){h=y;var A={};var z=contextPath+"/token/app/order/prodoffer/preparesub?subPage="+y;$.callServiceAsHtml(z,A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(B){if(!B){B.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>页面显示失败,稍后重试</strong></div>'}if(B.code!=0){$.alert("提示","页面显示失败,稍后重试");return}$("#member_prepare").hide();var C=$("#offerspecContent");C.html(B.data).show();$("#tentrance").show();$("#pentrance").hide();$("#nentrance").hide();$("#pakeage").attr("class","tab-pane fade in active");$("#tentrance").css("width","100%")}})};var l=function(){$("#offerspecContent").hide();$("#member_prepare").show()};var f=function(y,z){$("#uim_txt_"+z).val(y)};var e=function(A,L,I,J,y){var C={offerSpecId:L};var E=$.callServiceAsJson(contextPath+"/app/order/queryOfferSpec",C);if(E.code==0){if(E.data){var D="";var z=E.data.offerSpec;if(z&&z.offerRoles){var K=z.offerRoles;for(var F=0;F<K.length;F++){if(K[F].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||K[F].memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(K[F].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){D=K[F].offerRoleId;break}}else{D=K[F].offerRoleId;break}}}if(D!=""){l();var H=$("#li_"+J).attr("objinstid");var G=$("#li_"+J).attr("accessnumber");for(var F=0;F<OrderInfo.viceOfferSpec.length;F++){var B=OrderInfo.viceOfferSpec[F];if(H==B.prodId){OrderInfo.viceOfferSpec.splice(F,1);break}}z.prodId=H;z.accessnumber=G;OrderInfo.viceOfferSpec.push(z);order.prodModify.chooseOfferForMember(L,J,y,D)}else{$.alert("提示","无法选择套餐，套餐规格查询失败！")}}}else{if(E.code==-2){$.alertM(E.data)}else{$.alert("提示","套餐详细加载失败，请稍后再试！")}}};return{subPage:h,btnBack:o,buyService:t,queryApConfig:r,queryData:m,init:i,opeSer:a,scaningCallBack:f,scroll:j,searchPack:g,setOfferSpec:d,tabChange:s,queryPackForTerm:q,addNum:k,subNum:w,releaseFlag:b,boProdAn:c,offerprice:x,offerDialog:u,choosedOffer:e,confirm:v}})();CommonUtils.regNamespace("order","main");order.main=(function(){var I=function(M){if(M==undefined||!M){M=e()}if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){if(OrderInfo.actionFlag==6){var L=false;if(M.feeTypeMain=="2100"&&(M.offerSpec.feeType=="2100"||M.offerSpec.feeType=="3100"||M.offerSpec.feeType=="3101"||M.offerSpec.feeType=="3103")){L=true}else{if(M.feeTypeMain=="1200"&&(M.offerSpec.feeType=="1200"||M.offerSpec.feeType=="3100"||M.offerSpec.feeType=="3102"||M.offerSpec.feeType=="3103")){L=true}else{if(M.feeTypeMain=="1201"&&(M.offerSpec.feeType=="1201"||M.offerSpec.feeType=="3101"||M.offerSpec.feeType=="3102"||M.offerSpec.feeType=="3103")){L=true}}}if(!L){$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");return}}}$.callServiceAsHtml(contextPath+"/token/app/order/mainsub2",M,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(N){if(!N){$.unecOverlay();N.data="查询失败,稍后重试"}if(N.code!=0){$.unecOverlay();$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=M.actionFlag;OrderInfo.actionFlag=M.actionFlag;if(OrderInfo.actionFlag==2){setTimeout(function(){$.unecOverlay();offerChange.fillOfferChange(N,M)},800)}else{if(OrderInfo.actionFlag==21){order.memberChange.fillmemberChange(N,M,2)}else{$.unecOverlay();v(N,M)}}}})};var j=function(M){if(M==undefined||!M){M=e()}if(OrderInfo.newClothes=="true"||OrderInfo.oldMember=="true"){if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){if(OrderInfo.actionFlag==6){var L=false;if(M.newofferSpec!=undefined&&M.newofferSpec!=null){if(M.feeTypeMain=="2100"&&(M.newofferSpec.feeType=="2100"||M.newofferSpec.feeType=="3100"||M.newofferSpec.feeType=="3101"||M.newofferSpec.feeType=="3103")){L=true}else{if(M.feeTypeMain=="1200"&&(M.newofferSpec.feeType=="1200"||M.newofferSpec.feeType=="3100"||M.newofferSpec.feeType=="3102"||M.newofferSpec.feeType=="3103")){L=true}else{if(M.feeTypeMain=="1201"&&(M.newofferSpec.feeType=="1201"||M.newofferSpec.feeType=="3101"||M.newofferSpec.feeType=="3102"||M.newofferSpec.feeType=="3103")){L=true}}}}}if(!L){$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");return}}}$.callServiceAsHtml(contextPath+"/token/app/order/mainsub2",M,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")
},done:function(N){if(!N){$.unecOverlay();N.data="查询失败,稍后重试"}if(N.code!=0){$.unecOverlay();$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=M.actionFlag;$.unecOverlay();if(OrderInfo.actionFlag==6){if(OrderInfo.newClothes=="true"||OrderInfo.oldMember=="true"||OrderInfo.delViceCard=="true"){v(N,M)}}else{if(OrderInfo.actionFlag==21){order.memberChange.fillmemberChange(N,M,2)}}}})};var x=function(M){if(M==undefined||!M){M=e()}if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){if(OrderInfo.actionFlag==6){var L=false;if(M.feeTypeMain=="2100"&&(M.offerSpec.feeType=="2100"||M.offerSpec.feeType=="3100"||M.offerSpec.feeType=="3101"||M.offerSpec.feeType=="3103")){L=true}else{if(M.feeTypeMain=="1200"&&(M.offerSpec.feeType=="1200"||M.offerSpec.feeType=="3100"||M.offerSpec.feeType=="3102"||M.offerSpec.feeType=="3103")){L=true}else{if(M.feeTypeMain=="1201"&&(M.offerSpec.feeType=="1201"||M.offerSpec.feeType=="3101"||M.offerSpec.feeType=="3102"||M.offerSpec.feeType=="3103")){L=true}}}if(!L){$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");return}}}$.callServiceAsHtml(contextPath+"/token/app/order/mainsub2",M,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(N){if(!N){$.unecOverlay();N.data="查询失败,稍后重试"}if(N.code!=0){$.unecOverlay();$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=M.actionFlag;OrderInfo.actionFlag=M.actionFlag;if(OrderInfo.actionFlag==2){setTimeout(function(){$.unecOverlay();offerChange.fillOfferChange(N,M)},800)}else{if(OrderInfo.actionFlag==21){order.memberChange.fillmemberChange(N,M)}else{$.unecOverlay();v(N,M)}}}})};var l=function(){if(order.memberChange.reloadFlag=="N"){var N=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;var R=N[1];$.each(N,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){var S=this;var V=false;$.each(AttachOffer.openList,function(){if(this.prodId==S.data.ooRoles[0].prodId){$.each(this.specList,function(){if(this.offerSpecId==S.busiObj.objId){V=true;return false}})}});if(!V){AttachOffer.addOpenList(S.data.ooRoles[0].prodId,S.busiObj.objId);if(S.data.ooParams!=undefined){if(S.data.ooParams.length>0){var aj=S.data.ooParams[0];var ab=CacheData.getOfferSpec(aj.offerParamId,aj.offerSpecParamId);if(!!ab.offerSpecParams){for(var aq=0;aq<ab.offerSpecParams.length;aq++){var Y=ab.offerSpecParams[aq];var T=CacheData.getSpecParam(aj.offerParamId,aj.offerSpecParamId,Y.itemSpecId);if(T.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){T.setValue=$("#select1").val()}else{T.setValue=aj.value}}}if(ab.offerRoles!=undefined&&ab.offerRoles.length>0){for(var aq=0;aq<ab.offerRoles.length;aq++){var am=ab.offerRoles[aq];for(var ap=0;ap<am.roleObjs.length;ap++){var W=am.roleObjs[ap];if(!!W.prodSpecParams){for(var ao=0;ao<W.prodSpecParams.length;ao++){var af=W.prodSpecParams[ao];var ar=CacheData.getProdSpecParam(aj.offerParamId,aj.offerSpecParamId,af.itemSpecId);ar.value=aj.value}}}}}$("#can_"+aj.offerParamId+"_"+aj.offerSpecParamId).removeClass("canshu").addClass("canshu2");var ah=CacheData.getOfferSpec(aj.offerParamId,aj.offerSpecParamId);ah.isset="Y"}}if(S.data.bo2Coupons!=undefined){var ai=S.data.bo2Coupons[0];$("#terminalText_"+ai.prodId+"_"+ai.attachSepcId+"_"+ai.num).val(ai.couponInstanceNumber);var ac={couponUsageTypeCd:ai.couponUsageTypeCd,inOutTypeId:ai.inOutTypeId,inOutReasonId:ai.inOutReasonId,saleId:ai.saleId,couponId:ai.couponId,couponinfoStatusCd:ai.couponinfoStatusCd,chargeItemCd:ai.chargeItemCd,couponNum:ai.couponNum,storeId:ai.storeId,storeName:ai.storeName,agentId:ai.agentId,apCharge:ai.apCharge,couponInstanceNumber:ai.couponInstanceNumber,ruleId:ai.ruleId,partyId:ai.partyId,prodId:ai.prodId,offerId:ai.offerId,attachSepcId:ai.attachSepcId,state:ai.state,relaSeq:ai.relaSeq,num:ai.num};OrderInfo.attach2Coupons.push(ac)}var ag=this.busiObj.objId;var ae=this.busiObj.accessNumber;var ad=this.busiObj.objName;var ak=this.data.ooRoles[0].prodId;var an=this.busiObj.offerTypeCd;if(this.data.busiOrderAttrs!=undefined){var aa={};var Z={};var X={};$.each(this.data.busiOrderAttrs,function(){if(this.role=="40020005"){aa.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aa.staffid=this.value;aa.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aa.staffname=this.value}}aa.objInstId=ag;aa.accessNumber=ae;aa.objName=ad;aa.prodId=ak;aa.offerTypeCd=an}else{if(this.role=="40020006"){Z.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){Z.staffid=this.value;Z.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){Z.staffname=this.value}}Z.objInstId=ag;Z.accessNumber=ae;Z.objName=ad;Z.prodId=ak;Z.offerTypeCd=an}else{if(this.role=="40020007"){X.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){X.staffid=this.value;X.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){X.staffname=this.value}}X.objInstId=ag;X.accessNumber=ae;X.objName=ad;X.prodId=ak;X.offerTypeCd=an}}}});if(ec.util.isObj(aa.role)){OrderInfo.reloadProdInfo.dealerlist.push(aa)}if(ec.util.isObj(Z.role)){OrderInfo.reloadProdInfo.dealerlist.push(Z)}if(ec.util.isObj(X.role)){OrderInfo.reloadProdInfo.dealerlist.push(X)}}}}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"&&this.busiObj.offerTypeCd=="2"){var S=this;var U="";if(R.boActionType.actionClassCd=="1200"&&R.boActionType.boActionTypeCd=="S1"&&R.busiObj.offerTypeCd=="1"){U=this.data.ooRoles[0].objInstId;AttachOffer.delOffer(U,this.busiObj.instId,"reload")}else{$.each(order.memberChange.oldmembers.objInstId,function(){if(this.instId==S.busiObj.instId){U=this.objInstId;return false}});AttachOffer.delOffer(U,this.busiObj.instId,"reload")}}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(this.data.boServs[0].state=="ADD"){var S=this;var V=false;$.each(AttachOffer.openServList,function(){if(this.prodId==S.data.boServOrders[0].servId){$.each(this.servSpecList,function(){if(this.servSpecId==S.data.boServOrders[0].servSpecId){V=true;return false}})}});if(!V){var al="N";if(S.data.boServItems!=undefined){al="Y"}H(this.busiObj.instId,S.data.boServOrders[0].servSpecId,S.data.boServOrders[0].servSpecName,al);if(al=="Y"){var ab=CacheData.getServSpec(this.busiObj.instId,S.data.boServOrders[0].servSpecId);if(!!ab.prodSpecParams){for(var aq=0;aq<ab.prodSpecParams.length;aq++){var Y=ab.prodSpecParams[aq];var T=CacheData.getServSpecParam(this.busiObj.instId,S.data.boServOrders[0].servSpecId,Y.itemSpecId);$.each(S.data.boServItems,function(){if(T.itemSpecId==this.itemSpecId){T.setValue=this.value}})}}$("#can_"+this.busiObj.instId+"_"+S.data.boServOrders[0].servSpecId,Y.itemSpecId).removeClass("canshu").addClass("canshu2");var ah=CacheData.getServSpec(this.busiObj.instId,S.data.boServOrders[0].servSpecId,Y.itemSpecId);ah.isset="Y"}}}else{if(this.data.boServs[0].state=="DEL"){AttachOffer.closeServ(this.busiObj.instId,this.data.boServOrders[0].servId,"reload")}}}}}});$.each(AttachOffer.openList,function(){var S=this;$.each(this.specList,function(){var U=this;var T=false;$.each(N,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){if(this.busiObj.objId==U.offerSpecId){T=true;return false}}});if(!T){AttachOffer.delOfferSpec(S.prodId,this.offerSpecId,"reload")}})});$.each(AttachOffer.openServList,function(){var S=this;$.each(this.servSpecList,function(){var U=this;var T=false;$.each(N,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(U.servSpecId==this.data.boServOrders[0].servSpecId&&S.prodId==this.busiObj.instId){T=true;return false}}});if(!T){var V=$("#li_"+S.prodId+"_"+this.servSpecId).find("span");var W=CacheData.getServSpec(S.prodId,this.servSpecId);if(W==undefined){return}V.addClass("del");W.isdel="Y";AttachOffer.showHideUim(1,S.prodId,this.servSpecId);var X=CacheData.getServBySpecId(S.prodId,this.servSpecId);if(ec.util.isObj(X)){V.addClass("del");
X.isdel="Y"}}})});$.each(N,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="14"){var S=this.busiObj.instId;$("#uim_check_btn_"+S).attr("disabled",true);$("#uim_check_btn_"+S).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+S).attr("disabled",false);$("#uim_release_btn_"+S).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+S).attr("disabled",true);$.each(this.data.bo2Coupons,function(){if(this.state=="ADD"){$("#uim_txt_"+S).val(this.terminalCode);var T={couponUsageTypeCd:this.couponUsageTypeCd,cardTypeFlag:this.cardTypeFlag,inOutTypeId:this.inOutTypeId,inOutReasonId:this.inOutReasonId,saleId:this.saleId,couponId:this.couponId,couponinfoStatusCd:this.couponinfoStatusCd,chargeItemCd:this.chargeItemCd,couponNum:this.couponNum,storeId:this.storeId,storeName:this.storeName,agentId:this.agentId,apCharge:this.apCharge,couponInstanceNumber:this.couponInstanceNumber,terminalCode:this.terminalCode,ruleId:this.ruleId,partyId:this.partyId,prodId:this.prodId,offerId:this.offerId,state:this.state,relaSeq:this.relaSeq};OrderInfo.clearProdUim(S);OrderInfo.boProd2Tds.push(T)}})}})}var M=order.memberChange.rejson.orderList.custOrderList;var L=order.memberChange.rejson.orderList.orderListInfo;if(L!=null&&M!=null){var O=L.custOrderAttrs;var P=L.isTemplateOrder;var Q=L.templateOrderName;$(O).each(function(T,U){var S=U.itemSpecId;if(S=="111111118"){var V=U.value;if(V!=null&&V!=""){$("#order_remark").html(V)}}});if(P=="Y"){$("#isTemplateOrder").click();SoOrder.showTemplateOrderName();$("#templateOrderName").val(Q)}}};var v=function(L,R){if(OrderInfo.newClothes=="true"||OrderInfo.oldMember=="true"){SoOrder.initFillPage();$("#order_prepare").hide();$("#member_prepare").hide();var V=$("#order").html(L.data).show();$.refresh(V);w();k(R);if(R.actionFlag==""){OrderInfo.actionFlag=1}if(OrderInfo.actionFlag==6){if(R.oldofferSpec!=undefined&&R.oldofferSpec!=null){E(R)}if(R.newofferSpec!=undefined&&R.newofferSpec!=null){f(R)}}if(OrderInfo.actionFlag==6){g(0);if(ec.util.isArray(OrderInfo.oldprodInstInfos)){for(var ab=0;ab<OrderInfo.oldprodInstInfos.length;ab++){var ae=OrderInfo.oldprodInstInfos[ab];order.dealer.initDealer(ae)}}else{order.dealer.initDealer()}}order.phoneNumber.initOffer("-1");$("#fillNextStep").off("click").on("click",function(){if(!SoOrder.checkData()){return false}$("#order-content").hide();$("#order-dealer").show();order.dealer.initDealer()});if(R.memberChange){$("#orderedprod").hide();$("#order_prepare").hide();$("#productDiv .pdcardcon:first").show();$("#fillLastStep").off("click").on("click",function(){order.prodModify.cancel()})}else{$("#fillLastStep").off("click").on("click",function(){r()})}if(order.memberChange.reloadFlag=="N"){$("#content").show()}if(order.memberChange.newSubPhoneNum!=""&&order.memberChange.reloadFlag=="Y"){var ac=order.memberChange.newSubPhoneNum.split(",");for(var Y=0;Y<ac.length;Y++){$("#nbr_btn_-"+(Y+1)).removeAttr("onclick");$("#nbr_btn_-"+(Y+1)).removeClass("selectBoxTwo");$("#nbr_btn_-"+(Y+1)).addClass("selectBoxTwoOn");var Q={phoneNum:ac[Y]};var af=order.phoneNumber.queryPhoneNumber(Q);if(af.datamap.baseInfo){$("#nbr_btn_-"+(Y+1)).val(ac[Y]);var Z={prodId:"-"+(Y+1),accessNumber:af.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:af.datamap.baseInfo.phoneNumId,pnLevelId:af.datamap.baseInfo.phoneLevelId,anTypeCd:af.datamap.baseInfo.pnTypeId,state:"ADD",areaId:af.datamap.baseInfo.areaId,areaCode:af.datamap.baseInfo.zoneNumber,memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,preStore:af.datamap.baseInfo.prePrice,minCharge:af.datamap.baseInfo.pnPrice};OrderInfo.boProdAns.push(Z);order.dealer.changeAccNbr("-"+(Y+1),ac[Y])}}}if(order.memberChange.reloadFlag=="Y"){if(order.memberChange.mktResInstCode!=""&&order.memberChange.mktResInstCode!=null&&order.memberChange.mktResInstCode!="null"){var M="-1";M=order.prodModify.choosedProdInfo.prodOfferInstId;$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){M=this.mainProdOfferInstInfos[0].prodOfferInstId}});var T=order.memberChange.mktResInstCode.split(",");for(var W=0;W<T.length;W++){if(T[W]!=""&&T[W]!=null&&T[W]!="null"){var X=T[W].split("_");var O=X[0];var P=X[1];var ac=order.memberChange.newSubPhoneNum.split(",");for(var Y=0;Y<ac.length;Y++){if(ac[Y]==O){$("#uim_txt_-"+(Y+1)).attr("disabled",true);var N={instCode:P};var L=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",N);if(L.code==0){if(L.data.mktResBaseInfo){if(L.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_-"+(Y+1)).attr("disabled",true);$("#uim_check_btn_-"+(Y+1)).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_-"+(Y+1)).attr("disabled",false);$("#uim_release_btn_-"+(Y+1)).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_-"+(Y+1)).val(P);var U={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:L.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:L.data.mktResBaseInfo.qty,storeId:L.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:P,terminalCode:P,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-(Y+1),offerId:M,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(-(Y+1));OrderInfo.boProd2Tds.push(U)}else{$.alert("提示","UIM卡不是预占状态，当前为"+L.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(L.code==-2){$.alertM(L.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}}}}if(order.memberChange.reloadFlag=="N"){$("#dealerTbody").empty();var ad=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;$.each(ad,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="3"){}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){$("#nbr_btn_"+this.data.boProdAns[0].prodId).removeClass("selectBoxTwo");$("#nbr_btn_"+this.data.boProdAns[0].prodId).addClass("selectBoxTwoOn");$("#nbr_btn_"+this.data.boProdAns[0].prodId).val(this.busiObj.accessNumber);var ag={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};OrderInfo.boProdAns.push(ag);order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);var al={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};
OrderInfo.clearProdUim(this.busiObj.instId);OrderInfo.boProd2Tds.push(al);$("#pwd_"+this.busiObj.instId).val(this.data.boProdPasswords[0].pwd);$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected")}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"){}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="1"){}}}}if(this.data.busiOrderAttrs!=undefined){var ap=[];var aw={};var av={};var au={};$.each(this.data.busiOrderAttrs,function(){if(this.role=="40020005"){aw.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aw.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aw.staffname=this.value}}}else{if(this.role=="40020006"){av.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){av.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){av.staffname=this.value}}}else{if(this.role=="40020007"){au.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){au.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){au.staffname=this.value}}}}}});if(ec.util.isObj(aw.role)){ap.push(aw)}if(ec.util.isObj(av.role)){ap.push(av)}if(ec.util.isObj(au.role)){ap.push(au)}var aj="";var ah="";if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){aj=this.busiObj.instId}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){aj=this.data.ooRoles[0].prodId+"_"+this.busiObj.objId;ah="DEL"}}var ar=this.busiObj.accessNumber;for(var aq=0;aq<ap.length;aq++){var ao;if(aq==0){ao=$("<tr id='tr_"+aj+"' name='tr_"+aj+"'></tr>")}else{ao=$('<tr name="tr_'+aj+'"></tr>')}var an=$("<td></td>");var ai=aj+"_"+OrderInfo.SEQ.dealerSeq;var am=$('<select id="dealerType_'+ai+'" name="dealerType_'+aj+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+aj+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(ap[aq].role==this.PARTYPRODUCTRELAROLECD){am.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected>"+this.NAME+"</option>")}else{am.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});an.append(am);an.append('<label class="f_red">*</label>');ao.append("<td>"+ar+"</td>");if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){ao.append("<td>移动电话（仅含本地语音）</td>")}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){ao.append("<td>"+this.busiObj.objName+"</td>")}}ao.append(an);var ak;if(ah=="DEL"){if(aq==0){ak=$('<td><input type="text" id="dealer_'+ai+'" staffId="'+ap[aq].staffid+'" value="'+ap[aq].staffname+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>')}else{ak=$('<td><input type="text" id="dealer_'+ai+'" staffId="'+ap[aq].staffid+'" value="'+ap[aq].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>')}}else{ak=$('<td><input type="text" id="dealer_'+ai+'" staffId="'+ap[aq].staffid+'" value="'+ap[aq].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>')}ak.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+ai+"');\">选择</a>");if(aq==0){if(ah=="DEL"){ak.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>')}ak.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+aj+',1)">添加</a><label class="f_red">*</label>')}else{ak.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>')}ao.append(ak);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(ao)}}if(this.data.boAccountRelas!=undefined){var at=this.data.boAccountRelas[0].acctId;$("#acctSelect").find("option[value="+at+"]").attr("selected","selected")}});var S=order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;$.each(S,function(){if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){$("#order_remark").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrName){$("#orderAttrName").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrPhoneNbr){$("#orderAttrPhoneNbr").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderIdentidiesTypeCd){$("#orderIdentidiesTypeCd").find("option[value="+this.value+"]").attr("selected","selected")}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrIdCard){$("#orderAttrIdCard").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrAddr){$("#orderAttrAddr").val(this.value)}})}$("#fillNextStepSub").off("click").on("click",function(){SoOrder.submitOrder()})}if(OrderInfo.delViceCard=="true"){if(OrderInfo.oldMember=="true"||OrderInfo.newClothes=="true"){$("#member_prepare").hide();if(OrderInfo.delViceCard=="true"){$("#offerspecContent").show()}}else{$("#member_prepare").show();SoOrder.initFillPage();$("#member_prepare").html(L.data)}$("#fillNextStep").off("click").on("click",function(){OrderInfo.viceParam=R;if(!SoOrder.checkData()){return false}$("#order-content").hide();$("#order-dealer").show();order.dealer.initDealer()});$("#fillNextStepSub").off("click").on("click",function(){D(R)});var ae=order.prodModify.choosedProdInfo;var aa=false;$.each(R.viceParam,function(){var an=this.objInstId;var ai={areaId:OrderInfo.getProdAreaId(an),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:an,prodSpecId:this.objId,offerSpecId:ae.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var ap=query.offer.queryChangeAttachOffer(ai,"delViceCard",2);$("#attach_"+an).html(ap);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){ai.queryType="1,2";ai.objId=this.objId;ai.objType=this.objType;ai.memberRoleCd="400";ai.offerSpecId=this.offerSpecId;var am=query.offer.queryDefMustOfferSpec(ai,"delViceCard","sign");CacheData.parseOffer(am,an);var am=query.offer.queryServSpec(ai,"delViceCard","sign");CacheData.parseServ(am,an,"delViceCard")}AttachOffer.showMainMemberRoleProd(an);AttachOffer.changeLabel(an,this.objId,"");if(AttachOffer.isChangeUim(an,"delViceCard")){if(!aa){$("#uimDiv_"+an).show();var al=CacheData.getOfferMember(an);if(al!=null&&al!=undefined&&al!=""&&al!="null"){if(OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""&&OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!="null"){var at=OrderInfo.mktResInstCode.split(",");for(var ar=0;ar<at.length;ar++){if(at[ar]!=""&&at[ar]!=null&&at[ar]!="null"){var ah=at[ar].split("_");var aq=ah[0];var ao=ah[1];if(al==aq){$("#uim_txt_"+an).attr("disabled",true);var ak={instCode:ao};var aj=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",ak);if(aj.code==0){if(aj.data.mktResBaseInfo){if(aj.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_"+an).attr("disabled",true);$("#uim_check_btn_"+an).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+an).attr("disabled",false);$("#uim_release_btn_"+an).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+an).val(ao);var ag={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:aj.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:aj.data.mktResBaseInfo.qty,storeId:aj.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:ao,terminalCode:ao,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-(Y+1),offerId:M,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(an);OrderInfo.boProd2Tds.push(ag)}else{$.alert("提示","UIM卡不是预占状态，当前为"+aj.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(aj.code==-2){$.alertM(aj.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}}}}else{$("#uimDiv_"+an).hide()}}aa=true});order.dealer.initDealer(2);if(OrderInfo.newClothes=="true"||OrderInfo.oldMember=="true"){$("#member_prepare").hide()}else{$("#member_prepare").show()}}$("#content").show();
if(OrderInfo.provinceInfo.reloadFlag=="N"){order.main.reload()}};var D=function(L){var M=[];var N=[];var O=[];M=L.viceParam;N=L.ooRoles;O={viceParam:M,ooRoles:N,remark:$("#order_remark").val()};SoOrder.submitOrder(O)};var g=function(L){if(OrderInfo.actionFlag==6){var P={};if(L==1){for(var N=0;N<OrderInfo.oldprodInstInfos.length;N++){P.prodId=OrderInfo.oldprodInstInfos[N].prodInstId;P.acctNbr=OrderInfo.oldprodInstInfos[N].accNbr;P.areaId=OrderInfo.oldprodInstInfos[N].areaId;var O=$.callServiceAsJson(contextPath+"/apporder/queryProdAcctInfo",P);if(O.code==-2){$.alertM(O.data);return}var M=O.data;M[0].accessNumber=OrderInfo.oldprodInstInfos.accNbr;OrderInfo.oldprodAcctInfos.push({prodAcctInfos:M})}}else{P.prodId=order.prodModify.choosedProdInfo.prodInstId;P.acctNbr=order.prodModify.choosedProdInfo.accNbr;P.areaId=order.prodModify.choosedProdInfo.areaId;var O=$.callServiceAsJson(contextPath+"/app/order/queryProdAcctInfo",P);if(O.code==-2){$.alertM(O.data);return}var M=O.data;$.each(M,function(Q,R){OrderInfo.acctId=R.acctId;OrderInfo.acctCd=R.acctCd})}}};var w=function(){touch.on(".item","touchstart",function(L){});$(".item").each(function(L){touch.on(this,"swiperight",function(M){$("#carousel-example-generic").carousel("prev")});touch.on(this,"swipeleft",function(M){$("#carousel-example-generic").carousel("next")})})};var E=function(O){for(var L=0;L<OrderInfo.oldprodInstInfos.length;L++){var M=OrderInfo.oldprodInstInfos[L];$.each(OrderInfo.oldoffer,function(){if(this.accNbr==M.accNbr){var P=this;$.each(P.offerMemberInfos,function(){var U=this;var S=this.objInstId;var T={areaId:OrderInfo.getProdAreaId(S),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:S,prodSpecId:U.objId,offerSpecId:M.mainProdOfferInstInfos[0].prodOfferId,offerRoleId:"",acctNbr:U.accessNumber,partyId:M.custId,distributorId:OrderInfo.staff.distributorId,mainOfferSpecId:M.mainProdOfferInstInfos[0].prodOfferId,soNbr:OrderInfo.order.soNbr};if(ec.util.isObj(M.prodBigClass)){T.prodBigClass=M.prodBigClass}$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==M.accNbr){$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){T.offerRoleId=this.offerRoleId}})}});var Q=query.offer.queryChangeAttachOffer(T,"oldmember",1);$("#attach_"+S).html(Q);if(ec.util.isObj(U.objId)&&ec.util.isObj(U.objType)&&ec.util.isObj(U.offerRoleId)){T.queryType="1,2";T.objId=U.objId;T.objType=U.objType;T.memberRoleCd="401";var R=query.offer.queryDefMustOfferSpec(T,"oldmember",1);CacheData.parseOffer(R);var R=query.offer.queryServSpec(T,"oldmember",1);CacheData.parseServ(R)}if(ec.util.isArray(OrderInfo.oldofferSpec)){$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==M.accNbr){var V=this.offerSpec.offerRoles;$.each(V,function(){if(this.offerRoleId==U.offerRoleId&&U.objType==CONST.OBJ_TYPE.PROD){var W=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var Y=CacheData.getServBySpecId(S,this.objId);if(Y!=undefined){var X=$("#li_"+S+"_"+Y.servId);if(this.minQty==1){}}}});return false}})}})}AttachOffer.changeLabel(S,M.productId,"")})}});var N={};if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){if(this.accNbr==M.accNbr){N=this}})}if(order.prodModify.choosedProdInfo.is3G=="N"&&M.mainProdOfferInstInfos[0].is3G=="Y"){if(!order.memberChange.checkOrder(M,N)){return}order.memberChange.checkOfferProd(N)}}};var f=function(L){if(OrderInfo.actionFlag==6&&L.newofferSpec!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(){var O=this;for(var M=0;M<this.prodInsts.length;M++){var N=this.prodInsts[M];var Q={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:N.objId,offerRoleId:N.offerRoleId,prodId:N.prodInstId,queryType:"1,2",objType:N.objType,objId:N.objId,memberRoleCd:N.memberRoleCd};s(Q,"newClothes",1);var P={div_id:"item_order_"+N.prodInstId,prodId:N.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:N.objId,roleCd:O.roleCd,offerRoleId:O.offerRoleId,partyId:OrderInfo.cust.custId};order.main.spec_parm(P)}})}else{$.each(OrderInfo.offerSpec.offerRoles,function(){var O=this;for(var M=0;M<this.prodInsts.length;M++){var N=this.prodInsts[M];var Q={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:N.objId,offerRoleId:N.offerRoleId,prodId:N.prodInstId,queryType:"1,2",objType:N.objType,objId:N.objId,memberRoleCd:N.memberRoleCd};s(Q,"newClothes",1);var P={div_id:"item_order_"+N.prodInstId,prodId:N.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:N.objId,roleCd:O.roleCd,offerRoleId:O.offerRoleId,partyId:OrderInfo.cust.custId};order.main.spec_parm(P)}})}};var s=function(P,O,L){query.offer.addParam(P,O,L);var N=contextPath+"/app/offer/queryAttachSpec";var M=$.callServiceAsHtmlGet(N,{strParam:JSON.stringify(P)},{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});if(M.code==0){if(M.data){$("#attach_"+P.prodId).html(M.data);AttachOffer.showMainRoleProd(P.prodId);AttachOffer.changeLabel(P.prodId,P.prodSpecId,"100");if(P.prodId==-1&&OrderInfo.actionFlag==14){AttachOffer.addOpenList(P.prodId,mktRes.terminal.offerSpecId)}}}else{if(M.code==-2){$.alertM(M.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}};var a=function(L){$(".paymethodChange").each(function(){if($(this).attr("id")!=$(L).attr("id")){$(this).val($(L).val())}})};var K=function(N){if($("#isTemplateOrder").attr("checked")=="checked"){var M=$('select[name="pay_type_-1"]').val();if(N&&$(N).val()){if($(N).val()=="0"&&M!="2100"){$.alert("提示","您选择批开活卡模板，付费方式需改成'预付费'！");$("html").scrollTop(0);return false}}else{var L=$("#templateOrderDiv select").val();if(L){if(L=="0"&&M!="2100"){$.alert("提示","您选择批开活卡模板，付费方式需改成预付费！");$("html").scrollTop(0);return false}}}}return true};var k=function(L){if(L.feeType!=undefined&&L.feeType&&L.feeType!=CONST.PAY_TYPE.NOLIMIT_PAY){$("input[name^=pay_type_][value="+L.feeType+"]").attr("checked","checked");$("input[name^=pay_type_]").attr("disabled","disabled")}};var i=function(L){$("#acctListTab tbody").empty();$.each(L,function(M,O){var N=$("<tr></tr>").appendTo($("#acctListTab tbody"));if(O.name){$("<td class='teleNum'>"+O.name+"</td>").appendTo(N)}else{$("<td></td>").appendTo(N)}if(O.acctId){$("<td acctId='"+O.acctId+"'>"+O.accountNumber+"</td>").appendTo(N)}else{$("<td></td>").appendTo(N)}if(O.owner){$("<td>"+O.owner+"</td>").appendTo(N)}else{$("<td></td>").appendTo(N)}if(O.accessNumber){$("<td>"+O.accessNumber+"</td>").appendTo(N)}else{$("<td></td>").appendTo(N)}N.click(function(){var Q=false;var P=$("#acctSelect").find("option");$.each(P,function(S,R){if(R.value==O.acctId){$("#acctSelect").find("option[value="+R.value+"]").attr("selected","selected");Q=true;return false}});$(this).dispatchJEvent("chooseAcct",O);easyDialog.close();$("#defineNewAcct").hide()})})};function o(L){$.callServiceAsHtmlGet(contextPath+"/app/order/orderSpecParam",L,{done:function(M){if(M&&M.code==-2){return}else{if(M&&(M.data==0||M.data=="0")){return}}$("#"+L.div_id).append(M.data);$.refresh($(this));$("#choose_user_btn_"+L.prodId).parent().parent().parent().hide();var O=$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+L.prodId);if(O.length==1){var N=false;if(OrderInfo.prodInstAttrs&&OrderInfo.prodInstAttrs.length){$.each(OrderInfo.prodInstAttrs,function(){if(this.itemSpecId==CONST.PROD_ATTR.IS_XINKONG){$(O).val(this.value);N=true}})}if(N){$(O).attr("disabled","disabled")}else{$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+L.prodId+" option[value='']").remove();$(O).val("20");if(OrderInfo.offerSpec.feeType==CONST.PAY_TYPE.BEFORE_PAY){$(O).attr("disabled","disabled")}}}},fail:function(M){$.unecOverlay()}})}function B(){if(!h("order_spc_update")){return}var M=new Array();var N=0;$("#order_spc_update input").each(function(){if($(this).attr("id")!="order_remark"&&$(this).attr("id")!="isTemplateOrder"&&$(this).attr("id")!="templateOrderName"&&$(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var R={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};
M.push(R);N++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var Q={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};M.push(Q);N++}if($(this).val()!=null&&$(this).val()!=""){var P={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};M.push(P);N++}}}}}});$("#order_spc_update select").each(function(){if($(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var R={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};M.push(R);N++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var Q={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};M.push(Q);N++}if($(this).val()!=null&&$(this).val()!=""){var P={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};M.push(P);N++}}}}}});var L;if($("#order_remark").val()){L=[{atomActionId:OrderInfo.SEQ.atomActionSeq--,itemSpecId:CONST.ITEM_SPEC_ID_CODE.busiOrderAttrs,value:$("#order_remark").val()}];N++}if(N<1){$.alert("提示","您未修改订单属性");return}var O={boProdItems:M};if(L){O.busiOrderAttrs=L}OrderInfo.actionFlag=33;SoOrder.submitOrder(O)}function H(R,T,L,W){var M=CacheData.getServSpec(R,T);if(M==undefined){var S={objId:T,servSpecId:T,servSpecName:L,ifParams:W,isdel:"C"};var V={prodSpecId:T};if(W=="Y"){var P=query.prod.prodSpecParamQuery(V);if(P==undefined||P.result==undefined){return}S.prodSpecParams=P.result.prodSpecParams;if(T==CONST.YZFservSpecId){var U=$("select[name='pay_type_-1']").val();if(U==undefined){U=order.prodModify.choosedProdInfo.feeType}if(U==CONST.PAY_TYPE.AFTER_PAY){for(var O=0;O<S.prodSpecParams.length;O++){var Q=S.prodSpecParams[O];Q.setValue=""}}else{for(var O=0;O<S.prodSpecParams.length;O++){var Q=S.prodSpecParams[O];if(Q.value!=""){Q.setValue=Q.value}else{if(!!Q.valueRange[0]&&Q.valueRange[0].value!=""){Q.setValue=Q.valueRange[0].value}}}}}}CacheData.setServSpec(R,S);M=S}var T=M.servSpecId;var N=CacheData.getExcDepServParam(R,T);AttachOffer.addOpenServList(R,T,M.servSpecName,M.ifParams)}function h(M){var L=true;$("#"+M).find("input").each(function(){if(L){L=t(this)}});return L}function t(P){if($(P).attr("check_option")=="N"){if($(P).val()==null||$(P).val()==""){$.alert("提示",$(P).attr("check_name")+" 尚未填写");return false}}if($(P).attr("check_type")=="check"){var L=$(P).attr("check_len");if(L>0){if($(P).val().length>L){$.alert("提示",$(P).attr("check_name")+" 长度过长(<"+L+")");return false}}var M=$(P).attr("check_mask");if(M!=null&&$(P).val()!=null&&$(P).val()!=""){var O=new RegExp(M);if(!O.test($(P).val())){$.alert("提示",$(P).attr("check_name")+" 校验失败："+$(P).attr("check_mess"));return false}}var N=$(P).val().length;if(N>0&&$(P).attr("dataType")=="3"){if(!/^[0-9]+$/.test($(P).val())){$.alert("提示",$(P).attr("check_name")+" 非数字，请修改");return false}}else{if(N>0&&$(P).attr("dataType")=="5"){if(!/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test($(P).val())){$.alert("提示",$(P).attr("check_name")+" 非小数，请修改");return false}}else{if(N>0&&($(P).attr("dataType")=="4"||$(P).attr("dataType")=="16")){}}}}return true}var u=function(L){if(L&&L.page){m(L.page,L.scroll)}};var A=function(M,L){$.callServiceAsHtmlGet(contextPath+"/pad/staffMgr/getStaffListPrepare",{dealerId:M,objInstId:L},{done:function(O){var N=$.popup("#div_staff_dialog",O.data,{cache:true,width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){}});$("#btn_staff_select_chk").off("tap").on("tap",function(){G(L)});$("#a_order_staff_qry").off("tap").on("tap",function(){m(1)})}})};var m=function(M,L){var N={dealerId:$("#dealer_id").val(),qrySalesCode:$("#qrySalesCode").val(),staffName:$("#qryStaffName").val(),staffCode:$("#qryStaffCode").val(),staffCode2:$("#qryStaffCode").val(),salesCode:$("#qrySalesCode").val(),pageIndex:M,objInstId:$("#objInstId").val(),pageSize:10};$.callServiceAsHtml(contextPath+"/pad/staffMgr/getStaffList",N,{before:function(){if(M==1){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}},always:function(){if(M==1){$.unecOverlay()}},done:function(O){var P="";if(!O){P=""}else{P=O.data}var Q=$("#div_order_dealer_list");if(M==1){Q.html(P)}else{Q.find("tbody").append(P)}Q.find("tr").each(function(){$(this).off("tap").on("tap",function(R){$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg")})});if(L&&$.isFunction(L)){L.apply(this,[])}}})};var G=function(M){var L=$("#div_order_dealer_list tr.userorderlistlibg");L.each(function(){$("#dealer_"+M).val($(this).attr("staffName")).attr("staffId",$(this).attr("staffId"))});if(L.length>0){$("#div_staff_dialog").popup("close")}else{$.alert("提示","请先选择协销人！")}};var z=function(){$("#acctDialog .contract_list td").text("帐户查询");$("#acctDialog .selectList").show();easyDialog.open({container:"acctDialog"});$("#acctPageDiv").show();var L="chooseAcct";var M=$("#acctSelect");if(!M.hasJEventListener(L)){M.addJEventListener(L,function(O){var N=false;$.each(M.find("option"),function(P,Q){if($(Q).val()==O.acctId){N=true;return false}});if(N==false){$("<option>").text(O.name+" : "+O.accountNumber).attr("value",O.acctId).attr("acctcd",O.accountNumber).appendTo(M)}M.find("option[value="+O.acctId+"]").attr("selected","selected");if(O.acctId>0){$("#account").find("a:eq(1)").show()}})}$("#acctListTab tbody").empty();$("#acctPageDiv").empty()};var y=function(){$("#acctSelect").append("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>");$("#acctSelect").find("option[value='-1']").attr("selected","selected");$("#acctName").val(OrderInfo.cust.partyName);$("#defineNewAcct").show();$("#account").find("a:gt(0)").hide();window.setTimeout("order.main.showNewAcct()",0)};var c=function(){acct.acctModify.ifCanAdjustBankPayment();acct.acctModify.getBILL_POST(function(){acct.acctModify.paymentType();acct.acctModify.billPostType()})};var q=function(){var M=$("#acctSelect");if(!M.val()){$.alert("提示","请选择一个帐户");return}if(M.val()==-1){$.alert("提示","该帐户是新建帐户");return}$("#acctDialog .contract_list td").text("帐户信息");$("#acctDialog .selectList").hide();$("#acctPageDiv").hide();$("#acctListTab tbody").empty();easyDialog.open({container:"acctDialog"});var L={acctCd:M.find("option:selected").attr("acctcd"),isServiceOpen:"Y"};$.callServiceAsJson(contextPath+"/order/account",L,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(N){if(N.code==-2){$.alertM(N.data);return}if(N.code==0){i(N.data.accountInfos)}else{$("<tr><td colspan=4>"+N.data+"</td</tr>").appendTo($("#acctListTab tbody"))}$("#acctListTab tr").off("click")}})};var r=function(L){$.confirm("信息","确定回到上一步吗？",{yes:function(){var N=OrderInfo.boProdAns;var M=OrderInfo.boProd2Tds;if(M.length>0){for(var P=0;P<M.length;P++){var O={numType:2,numValue:M[P].terminalCode};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",O,{done:function(){}})}}if(N.length>0){for(var P=0;P<N.length;P++){if(N[P].idFlag){continue}var O={numType:1,numValue:N[P].accessNumber};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",O)}}order.phoneNumber.resetBoProdAn();$("#order_prepare").show();$("#order").hide();if(typeof(L)=="function"){L()}},no:function(){}},"question")};var e=function(){return{boActionTypeCd:"S1",boActionTypeName:"订购",offerSpecId:1234,offerSpecName:"乐享3G-129套餐",feeType:1200,viceCardNum:3,offerNum:3,type:1,terminalInfo:{terminalName:"IPhone5",terminalCode:"46456457345"},offerRoles:[{offerRoleId:1234,offerRoleName:"主卡",memberRoleCd:"0",roleObjs:[{offerRoleId:1,objId:CONST.PROD_SPEC.CDMA,objName:"CDMA",objType:2}]},{offerRoleId:2345,offerRoleName:"副卡",memberRoleCd:"1"}]}
};var C=function(M){var L=J();$("#"+M).val(L)};var J=function(){var P="";var O="";var N="";var M=0;for(var L=0;L<6;L++){do{if(P.length>0){O=P.substring(P.length-1,P.length)}M=parseInt(Math.random()*9+1);N=""+M;if(P.length==5){if(d(P+N)){continue}}}while(O==N);P=P+N}if(P.length!=6){return null}return P};var d=function(O){var L=0;if(O&&O.length==6){for(var M=0;M<5;M++){var P=parseInt(O.substring(M,M+1));var N=parseInt(O.substring(M+1,M+2));L=L+(P-N)}if(L==5||L==-5){return true}else{return false}}else{return false}};var p=function(N,L){var M=$("#"+N).val();return F(M,L)};var F=function(P,M){var O="<div style='text-indent:0px;'>密码设置规则：<br/>1、密码必须为六位全数字；<br/>2、密码不能与接入号中的信息重复；<br/>3、密码不能包含连续相同的数字；<br/>4、密码不能是连续的六位数字。</div>";var N=new RegExp("^([0-9]{6})$");if(P==null){$.alertMore("提示","","密码不可为空！",O,"");return false}else{if(!N.test(P)){$.alertMore("提示","","密码包含非数字或长度不是6位",O,"");return false}}if(M!=null&&M.indexOf(P)>=0){$.alertMore("提示","","密码不能与接入号中的信息重复，请修改！",O,"");return false}for(var L=0;L<5;L++){lastOneS=P.substring(L,L+1);thisOneS=P.substring(L+1,L+2);if(lastOneS==thisOneS){$.alertMore("提示","","密码中包含连续相同数字，请修改！",O,"");return false}}if(d(P)){$.alertMore("提示","","密码不可是连续6位数字，请修改！",O,"");return false}return true};var b=function(O,M){var L=$(O).val();var N=$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+M);if(L==CONST.PAY_TYPE.BEFORE_PAY){$(N).val("20");$(N).attr("disabled",true)}else{$(N).attr("disabled",false)}$(N).addClass("styled-select")};return{buildMainView:j,feeTypeCascadeChange:b,initTounch:w,spec_parm:o,check_parm:h,queryScroll:u,queryStaff:A,queryStaffPage:m,setStaff:G,chooseAcct:z,check_parm_self:t,createAcct:y,showNewAcct:c,acctDetail:q,spec_parm_change_save:B,paymethodChange:a,templateTypeCheck:K,lastStep:r,genRandPass6:J,genRandPass6Input:C,passwordCheckInput:p,passwordCheckVal:F,checkIncreace6:d,reload:l,buildMainViewSub:x,callBackBuildView:v}})();CommonUtils.regNamespace("query","offer");query.offer=(function(){var z=function(F,E){F.areaId=OrderInfo.cust.areaId;var D=contextPath+"/app/offer/queryOfferSpec";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,F,{before:function(){$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>")},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data.offerSpec)}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");var C=$.callServiceAsJsonGet(D,F);$.unecOverlay();if(C.code==0){if(C.data){return C.data.offerSpec}}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}};var t=function(F,E){var D=contextPath+"/app/offer/queryOfferInst";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,F,{before:function(){$("#attach-modal").modal("show")},done:function(G){$("#attach-modal").modal("hide");if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");var C=$.callServiceAsJsonGet(D,F);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}};var u=function(G){var C=order.prodModify.choosedProdInfo;var H={offerId:C.prodOfferInstId,offerSpecId:C.prodOfferId,acctNbr:C.accNbr,areaId:C.areaId,distributorId:""};if(typeof(G)=="function"){query.offer.queryOfferInst(H,function(L){if(L&&L.code==CONST.CODE.SUCC_CODE){var J=true;if(ec.util.isArray(L.offerMemberInfos)){CacheData.sortOffer(L);for(var K=0;K<L.offerMemberInfos.length;K++){var M=L.offerMemberInfos[K];if(M.objType==""){$.alert("提示","销售品实例构成 "+M.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(M.objType==CONST.OBJ_TYPE.PROD){if(M.accessNumber==""){$.alert("提示","销售品实例构成 "+M.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(M.objInstId==C.prodInstId){J=false}}if(J){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+C.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=L.offerMemberInfos;OrderInfo.offer.offerId=C.prodOfferInstId;OrderInfo.offer.offerSpecId=C.prodOfferId;OrderInfo.offer.offerSpecName=C.prodOfferName;G()}else{$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");return false}}})}else{var F=query.offer.queryOfferInst(H);if(F&&F.code==CONST.CODE.SUCC_CODE){var D=true;if(ec.util.isArray(F.offerMemberInfos)){CacheData.sortOffer(F);for(var E=0;E<F.offerMemberInfos.length;E++){var I=F.offerMemberInfos[E];if(I.objType==""){$.alert("提示","销售品实例构成 "+I.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(I.objType==CONST.OBJ_TYPE.PROD){if(I.accessNumber==""){$.alert("提示","销售品实例构成 "+I.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(I.objInstId==C.prodInstId){D=false}}if(D){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+C.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=F.offerMemberInfos;OrderInfo.offer.offerId=C.prodOfferInstId;OrderInfo.offer.offerSpecId=C.prodOfferId;OrderInfo.offer.offerSpecName=C.prodOfferName;return true}else{$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");return false}}}};var j=function(F,E){var D=contextPath+"/app/offer/queryOfferParam";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,F,{before:function(){$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}})}else{$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,F);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}};var v=function(F,E){h(F);var D=contextPath+"/token/app/offer/queryAttachOffer";if(OrderInfo.actionFlag==22){D=contextPath+"/app/offer/queryAttachOffer2"}if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}};var a=function(E){h(E);var D=contextPath+"/app/offer/queryOpenedAttachAndServ";$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(E)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var B=function(G,F,C){h(G,F,C);G.isServiceOpen="Y";var E=contextPath+"/app/offer/queryChangeAttachOffer";if(typeof(callBackFun)=="function"){$.callServiceAsHtmlGet(E,{strParam:JSON.stringify(G)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(H){$.unecOverlay();if(H.code==0){if(H.data){callBackFun(H.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var D=$.callServiceAsHtmlGet(E,{strParam:JSON.stringify(G)});$.unecOverlay();if(D.code==0){if(D.data){return D.data}}else{$.alert("提示","查询附属销售品实例失败,稍后重试");return}}};var w=function(F,E){h(F);var D=contextPath+"/app/offer/queryAttachSpec";if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(G){if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var q=function(F,E){h(F);var D=contextPath+"/app/offer/queryCanBuyAttachSpec";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")
},always:function(){},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var e=function(G,F,C){h(G,F,C);var E=contextPath+"/app/offer/queryDefaultAndRequiredOfferSpec";$.ecOverlay("<strong>查询默认必须可选包中，请稍等...</strong>");var D=$.callServiceAsJsonGet(E,G);$.unecOverlay();if(D.code==0){if(D.data){return D.data}}else{if(D.code==-2){OrderInfo.isSuccess="N";$.alertM(D.data);return}else{OrderInfo.isSuccess="N";$.alert("提示","可订购功能产品失败,稍后重试");return}}};var c=function(E){h(E);var D=contextPath+"//app/offer/queryDefaultAndRequiredOfferSpecAndServ";$.ecOverlay("<strong>查询默认必须可选包和功能产品中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){OrderInfo.isSuccess="Y";if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","可订购可选包和功能产品失败,稍后重试");return}}};var l=function(G,F,C){h(G,F,C);var E=contextPath+"/app/offer/queryServSpec";$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");var D=$.callServiceAsJsonGet(E,G);$.unecOverlay();if(D.code==0){if(D.data){return D.data}}else{if(D.code==-2){$.alertM(D.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var i=function(E){h(E);var D=contextPath+"/app/offer/queryExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(E)});$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var g=function(E){h(E);var D=contextPath+"/app/offer/queryServExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(E)});$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var m=function(F,E){h(F);var D=contextPath+"/app/offer/searchAttachOfferSpec";if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:encodeURI(JSON.stringify(F),"utf-8")},{before:function(){$.ecOverlay("附属销售品查询中，请稍等...")},done:function(G){$.unecOverlay();if(G.code==0){E(G.data)}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询附属销售失败，请稍后重试！")}}},fail:function(G){$.unecOverlay();$.alert("提示","查询附属销售失败，请稍后重试！")}})}else{$.ecOverlay("<strong>附属销售品查询中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:encodeURI(JSON.stringify(F),"utf-8")});$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询附属销售失败，请稍后重试！")}}}};var f=function(E){var D=contextPath+"//app/order/checkOperate";$.ecOverlay("<strong>受理权限查询中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,"");$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","受理权限查询失败，请稍后重试！")}}};var A=function(E){var D=contextPath+"/app/order/orderSubmit";if(OrderInfo.order.token!=""){D=contextPath+"/app/order/orderSubmit?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var C=$.callServiceAsHtml(D,E);$.unecOverlay();if(!C||C.code!=0){return}return C.data};var s=function(E){var D=contextPath+"/app/order/orderSubmitComplete";if(OrderInfo.order.token!=""){D=contextPath+"/app/order/orderSubmitComplete?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(!C||C.code!=0){return}return C.data};var y=function(D){var C=query.offer.queryOfferSpec(D);if(C==undefined){return false}if(C.offerRoles==undefined){$.alert("错误提示","销售品规格构成查询: 返回的销售品规格构成结构不对！");return false}if(C.offerSpecId==undefined||C.offerSpecId==""){$.alert("错误提示","销售品规格构成查询: 销售品规格ID未返回，无法继续受理！");return false}if(C.offerRoles.length==0){$.alert("错误提示","销售品规格构成查询: 成员角色为空，无法继续受理！");return false}if(C.feeType==undefined||C.feeType==""||C.feeType=="null"){$.alert("错误提示","无付费类型，无法新装！");return false}C=SoOrder.sortOfferSpec(C);if(OrderInfo.actionFlag==6&&OrderInfo.oldMember=="true"){OrderInfo.oldofferSpec.push({offerSpec:C,accNbr:D.accNbr})}else{OrderInfo.offerSpec=C}return C};var r=function(F,I){var H={offerSpecId:I,partyId:OrderInfo.cust.custId,offerTypeCd:2};if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){H.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}if(OrderInfo.actionFlag==3){H.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId}if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==F){H.mainOfferSpecId=this.offerSpecId;return false}})}}var G=query.offer.queryOfferSpec(H);if(G==undefined||G.offerRoles==undefined){$.alert("提示","返回的销售品规格构成结构不对！");return false}if(G.offerSpecId==undefined||G.offerSpecId==""){$.alert("提示","销售品规格ID未返回，继续受理将出现异常！");return false}if(G.offerSpecName==undefined||G.offerSpecName==""){$.alert("提示","销售品规格名称未返回，继续受理将出现异常！");return false}var D=[];var E=OrderInfo.getProdSpecId(F);var C=false;$.each(G.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objId==E){C=true;return false}});if(C){D.push(this);return false}});G.offerRoles=D;return G};var p=function(E){var D=contextPath+"/token/pc/order/prodModify/updateCheckByChange";$.ecOverlay("<strong>正在预校验中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{if(C.data.resultMsg){$.alert("提示","预校验失败!失败原因为："+C.data.resultMsg)}else{$.alert("提示","预校验失败! 集团营业后台未给出原因。")}}}};var o=function(){if(OrderInfo.order.soNbr==null||OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}if(CONST.getAppDesc()!=0){return true}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){return true}if(order.prodModify==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var C=order.prodModify.choosedProdInfo;if(C==undefined||C.prodInstId==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var G={areaId:OrderInfo.getProdAreaId(C.prodInstId),acctNbr:C.accNbr,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,instId:C.prodInstId,type:"2",queryType:"1,2,3,4,5",acctNbr:"",data:[]};var F=OrderInfo.provinceInfo.mergeFlag;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){var D=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.accessNumber==C.accNbr){D=false;return false}});if(D){if(F!=null&&F!=""&&F!="undefined"&&F=="1"){G.data.push({accessNbr:C.accNbr,instId:C.prodInstId});return d(G)}else{return query.offer.invokeLoadInst(G)}}else{var E=true;if(F!=null&&F!=""&&F!="undefined"&&F=="1"){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){G.data.push({accessNbr:this.accessNumber,instId:this.objInstId})}});if(G!=null){if(!d(G)){E=false;return false}}}else{$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){G.acctNbr=this.accessNumber;G.instId=this.objInstId;if(!query.offer.invokeLoadInst(G)){E=false;return false}}})}return E}}else{if(F!=null&&F!=""&&F!="undefined"&&F=="1"){G.data.push({accessNbr:C.accNbr,instId:C.prodInstId});return d(G)}else{return query.offer.invokeLoadInst(G)}}};var d=function(E){var D=contextPath+"/token/app/offer/loadInstNew";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var C=$.callServiceAsJson(D,JSON.stringify(E));$.unecOverlay();if(C.code==0){return true}else{if(C.code==-2){$.alertM(C.data);return false}else{if(C.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",C.msg)}return false}}};var h=function(F,E,C){F.staffId=OrderInfo.staff.staffId;F.channelId=OrderInfo.staff.channelId;F.areaId=OrderInfo.getProdAreaId(F.prodId);F.partyId=OrderInfo.cust.custId;if(OrderInfo.actionFlag==6){if(E==1){F.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId
}else{if(E==2){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==F.prodId){F.mainOfferSpecId=this.offerSpecId;return false}})}}}}if(ec.util.isObj(OrderInfo.order.soNbr)){F.soNbr=OrderInfo.order.soNbr}else{F.soNbr=UUID.getDataId();OrderInfo.order.soNbr=UUID.getDataId()}if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){}}if(C==1&&E=="oldmember"){if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var D=0;D<OrderInfo.oldprodInstInfos.length;D++){if(F.acctNbr==OrderInfo.oldprodInstInfos[D].accNbr){F.areaId=OrderInfo.oldprodInstInfos[D].areaId;F.partyId=OrderInfo.oldprodInstInfos[D].custId;F.mainOfferSpecId=OrderInfo.oldprodInstInfos[D].mainProdOfferInstInfos[0].prodOfferId}}}}};var k=function(E){var D=contextPath+"/app/offer/loadInst";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){return true}else{if(C.code==-2){$.alertM(C.data);return false}else{if(C.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",C.msg)}return false}}};var x=function(E){var D=contextPath+"/app/cust/offerorderprod";$.ecOverlay("<strong>查询产品信息中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var b=function(E){var D=contextPath+"/app/order/prodInstParam";$.ecOverlay("<strong>查询产品实例属性中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};return{checkOperate:f,loadInst:o,invokeLoadInst:k,setOffer:u,searchAttachOfferSpec:m,queryOfferSpec:z,queryServSpec:l,queryOfferInst:t,queryOfferParam:j,queryAttachOfferHtml:v,queryChangeAttachOffer:B,queryCanBuyAttachSpec:q,queryExcludeDepend:i,queryServExcludeDepend:g,queryAttachSpec:w,queryMainOfferSpec:y,queryAttachOfferSpec:r,queryDefMustOfferSpec:e,queryDefMustOfferSpecAndServ:c,orderSubmit:A,orderSubmitComplete:s,updateCheckByChange:p,queryProduct:x,queryOpenedAttachAndServ:a,queryProdInstParam:b,addParam:h,invokeLoadInstSub:d}})();CommonUtils.regNamespace("offerChange");offerChange=(function(){var l=function(){OrderInfo.order.step=1;OrderInfo.busitypeflag=2;OrderInfo.actionFlag=2;if(!query.offer.setOffer()){return}order.service.queryApConfig();order.service.searchPack()};var c=function(){var q=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==2){q++}});var t=1;var p=0;if(q>1){t=2}if(!k(t,p)){return}if(CONST.getAppDesc()==0){if(order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){offerChange.checkOrder(undefined,function(u){if(!u){return}if(!prod.uim.setProdUim()){return}var v=order.prodModify.choosedProdInfo;var w={boActionTypeCd:"S2",boActionTypeName:"套餐变更",actionFlag:"2",offerSpec:OrderInfo.offerSpec,prodId:v.prodInstId,offerMembers:OrderInfo.offer.offerMemberInfos,oldOfferSpecName:v.prodOfferName,prodClass:v.prodClass,appDesc:CONST.getAppDesc()};order.main.buildMainView(w)});return}if(!prod.uim.setProdUim()){return}}var r=order.prodModify.choosedProdInfo;var s={boActionTypeCd:"S2",boActionTypeName:"套餐变更",actionFlag:"2",offerSpec:OrderInfo.offerSpec,prodId:r.prodInstId,offerMembers:OrderInfo.offer.offerMemberInfos,oldOfferSpecName:r.prodOfferName,prodClass:r.prodClass,appDesc:CONST.getAppDesc()};order.main.buildMainView(s)};var m=function(p,r){SoOrder.initFillPage();$("#order_prepare").hide();$("#order").html(p.data).show();$("#fillNextStep").off("click").on("click",function(){if(!SoOrder.checkData()){return false}$("#order-content").hide();$("#order-dealer").show();order.dealer.initDealer()});var q=order.prodModify.choosedProdInfo;$("#attach-modal").modal("show");$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){var u=this.prodInstId;var v={areaId:OrderInfo.getProdAreaId(u),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:u,prodSpecId:this.objId,offerSpecId:q.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var s=query.offer.queryChangeAttachOffer(v);$("#attach_"+u).html(s);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){v.queryType="1,2";v.objId=this.objId;v.objType=this.objType;v.memberRoleCd=this.roleCd;v.offerSpecId=OrderInfo.offerSpec.offerSpecId;var t=query.offer.queryDefMustOfferSpec(v);CacheData.parseOffer(t,u);v.queryType="1";var t=query.offer.queryServSpec(v);CacheData.parseServ(t,u)}AttachOffer.showMainRoleProd(u);if(AttachOffer.isChangeUim(u)){$("#uimDiv_"+u).show()}})}});if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){offerChange.checkOfferProd()}order.main.initTounch()};var i=function(p){j(p,OrderInfo.offer);o(p,OrderInfo.offer);AttachOffer.setAttachBusiOrder(p);if(CONST.getAppDesc()==0){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(OrderInfo.boProd2Tds.length>0){var q={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var r=OrderInfo.getProdBusiOrder(q);if(r){p.push(r)}}}})}}};var j=function(p,r){r.offerTypeCd=1;r.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;var q=order.prodModify.choosedProdInfo;OrderInfo.getOfferBusiOrder(p,r,q.prodInstId)};var o=function(w,x){var v=order.prodModify.choosedProdInfo;var q=OrderInfo.offerSpec;var p={areaId:OrderInfo.getProdAreaId(v.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.SEQ.offerSeq--,objId:q.offerSpecId,offerTypeCd:"1",accessNumber:v.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};$.each(q.offerRoles,function(){var y=this;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){var z={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,offerRoleId:y.offerRoleId,state:"ADD"};p.data.ooRoles.push(z)})}});if(ec.util.isArray(q.offerSpecParams)){p.data.ooParams=[];for(var t=0;t<q.offerSpecParams.length;t++){var r=q.offerSpecParams[t];var s={itemSpecId:r.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:r.offerSpecParamId,value:r.value,state:"ADD"};p.data.ooParams.push(s)}}if(q.ooTimes!=undefined){p.data.ooTimes=[];p.data.ooTimes.push(q.ooTimes)}p.data.busiOrderAttrs=[];var u=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(u!=undefined){u.each(function(){var y={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};p.data.busiOrderAttrs.push(y)})}w.push(p)};var h=function(p){};var f=function(r,p){if(OrderInfo.actionFlag==3){b()}else{e()}if(typeof(p)=="function"){query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData),function(s){OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(s==undefined){p(false)}if(s.resultCode==0&&ec.util.isObj(s.result)){offerChange.resultOffer=s.result}else{$.alert("预校验规则限制",s.resultMsg);offerChange.resultOffer={};p(false)}p(true)})}else{var q=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(q==undefined){return false}if(q.resultCode==0&&ec.util.isObj(q.result)){offerChange.resultOffer=q.result}else{$.alert("预校验规则限制",q.resultMsg);offerChange.resultOffer={};return false}return true}};var b=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;var t=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;for(var s=0;s<AttachOffer.openList.length;s++){var r=AttachOffer.openList[s];for(var q=0;q<r.specList.length;q++){var p=r.specList[q];if(p.isdel!="Y"&&p.isdel!="C"&&p.ifPackage4G=="Y"){p.offerTypeCd=2;
p.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;p.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(t,p,r.prodId)}}}$.each(t,function(){this.busiObj.state="ADD"})};var k=function(p,y){if(p==1){var x=g();if(x==undefined){alert("错误提示","无法变更到该套餐");return false}x.prodInsts=[];var w=false;$.each(x.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var z=this;w=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(z.objId!=this.objId){$.alert("规则限制","新套餐【"+z.offerRoleName+"】角色的规格ID【"+z.objId+"】和旧套餐【"+this.roleName+"】角色的规格ID【"+this.objId+"】不一样");w=true;return false}z.prodInstId=this.objInstId;z.accessNumber=this.accessNumber;x.prodInsts.push(z)}});if(w){return false}}});if(w){return false}}else{for(var t=0;t<OrderInfo.offer.offerMemberInfos.length;t++){var r=OrderInfo.offer.offerMemberInfos[t];if(r.objType==CONST.OBJ_TYPE.PROD){var w=true;for(var s=0;s<OrderInfo.offerSpec.offerRoles.length;s++){var x=OrderInfo.offerSpec.offerRoles[s];if(r.roleCd==x.memberRoleCd){for(var q=0;q<x.roleObjs.length;q++){var v=x.roleObjs[q];if(v.objType==CONST.OBJ_TYPE.PROD){if(v.objId!=r.objId){$.alert("规则限制","新套餐【"+v.offerRoleName+"】角色的规格ID【"+v.objId+"】和旧套餐【"+r.roleName+"】角色的规格ID【"+r.objId+"】不一样");return false}if(!ec.util.isArray(x.prodInsts)){x.prodInsts=[]}var u=jQuery.extend(true,{},v);u.prodInstId=r.objInstId;u.accessNumber=r.accessNumber;x.prodInsts.push(u);if(x.prodInsts.length>v.maxQty){$.alert("规则限制","新套餐【"+x.offerRoleName+"】角色最多可以办理数量为"+v.maxQty+",而旧套餐数量大于"+v.maxQty);return false}break}}w=false;break}}if(w){$.alert("规则限制","旧套餐【"+r.roleName+"】角色在新套餐中不存在，无法变更");return false}}}}return true};var g=function(){for(var r=0;r<OrderInfo.offerSpec.offerRoles.length;r++){var s=OrderInfo.offerSpec.offerRoles[r];if(s.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return s}}for(var r=0;r<OrderInfo.offerSpec.offerRoles.length;r++){var s=OrderInfo.offerSpec.offerRoles[r];for(var q=0;q<s.roleObjs.length;q++){var p=s.roleObjs[q];if(p.objType==CONST.OBJ_TYPE.PROD){return s}}}};var e=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;var p=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;j(p,OrderInfo.offer);o(p,OrderInfo.offer)};var a=function(){if(offerChange.resultOffer==undefined){return}var p=offerChange.resultOffer.prodInfos;if(ec.util.isArray(p)){$.each(p,function(){var v=this.accProdInstId;var t=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==v){t=false;return false}});if(t){return true}if(v!=this.prodInstId){var w=CacheData.getServ(v,this.prodInstId);if(this.state=="DEL"){if(w!=undefined){var x=$("#li_"+v+"_"+this.prodInstId);if(ec.util.isObj(x)){var s=$("#span_"+v+"_"+this.prodInstId);var u=$("#span_remove_"+v+"_"+this.prodInstId);if(ec.util.isObj(s)){s.addClass("del")}if(ec.util.isObj(u)){u.hide()}x.removeAttr("onclick");w.isdel="Y"}}}else{if(this.state=="ADD"){if(w!=undefined){var x=$("#li_"+v+"_"+this.prodInstId);if(ec.util.isObj(x)){var s=$("#span_"+v+"_"+this.prodInstId);var u=$("#span_remove_"+v+"_"+this.prodInstId);if(ec.util.isObj(s)){s.removeClass("del")}if(ec.util.isObj(u)){u.hide()}x.removeAttr("onclick");w.isdel="N"}}else{var r=CacheData.getServSpec(v,this.productId);if(r!=undefined){var x=$("#li_"+v+"_"+this.productId);if(ec.util.isObj(x)){var s=$("#span_"+v+"_"+this.productId);var u=$("#span_remove_"+v+"_"+this.productId);if(ec.util.isObj(s)){s.removeClass("del")}if(ec.util.isObj(u)){u.hide()}x.removeAttr("onclick");r.isdel="N"}$("#del_"+v+"_"+this.productId).hide()}else{if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(v,this.productId)}}}}}}})}var q=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(q)){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){var r=this.objInstId;$.each(q,function(){if(this.memberInfo==undefined){return true}var v=CacheData.getOffer(r,this.prodOfferInstId);var t=true;$.each(this.memberInfo,function(){if(r==this.accProdInstId){if(ec.util.isObj(v)){this.prodId=this.accProdInstId}t=false;return false}});if(t){return true}if(this.state=="DEL"){if(v!=undefined){var x=$("#li_"+r+"_"+this.prodOfferInstId);if(ec.util.isObj(x)){var s=$("#span_"+r+"_"+this.prodOfferInstId);var u=$("#span_remove_"+r+"_"+this.prodOfferInstId);if(ec.util.isObj(s)){s.addClass("del")}if(ec.util.isObj(u)){u.hide()}x.removeAttr("onclick");v.isdel="N"}v.isdel="Y";if(this.isRepeat!="Y"){this.isRepeat="Y"}else{v.isRepeat="Y"}}}else{if(this.state=="ADD"){if(v!=undefined){var x=$("#li_"+r+"_"+this.prodOfferInstId);if(ec.util.isObj(x)){var s=$("#span_"+r+"_"+this.prodOfferInstId);var u=$("#span_remove_"+r+"_"+this.prodOfferInstId);if(ec.util.isObj(s)){s.removeClass("del")}if(ec.util.isObj(u)){u.hide()}x.removeAttr("onclick");v.isdel="N"}}else{var w=CacheData.getOfferSpec(r,this.prodOfferId);if(w!=undefined){var x=$("#li_"+r+"_"+this.prodOfferId);if(ec.util.isObj(x)){var s=$("#span_"+r+"_"+this.prodOfferId);var u=$("#span_remove_"+r+"_"+this.prodOfferId);if(ec.util.isObj(s)){s.removeClass("del")}if(ec.util.isObj(u)){u.hide()}x.removeAttr("onclick");w.isdel="N"}}else{if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(r,this.prodOfferId)}}}}}})})}}};var d=function(s){var r="";if(offerChange.resultOffer==undefined){return r}var p=offerChange.resultOffer.prodInfos;if(ec.util.isArray(p)){var t="";$.each(p,function(){if(s!=this.accProdInstId){return true}if(s!=this.prodInstId){var v=CacheData.getServ(s,this.prodInstId);var u=CacheData.getServSpec(s,this.productId);if(this.state=="DEL"){if(v!=undefined){t+='<li id="li_'+s+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+s+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+v.servSpecName+"</span></li>"}else{if(u!=undefined){t+='<li id="li_'+s+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+s+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+u.servSpecName+"</span></li>"}else{if(this.productName!=undefined&&this.productName!=""){t+='<li id="li_'+s+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+s+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+this.productName+"</span></li>"}}}}else{if(this.state=="ADD"){if(v!=undefined){t+='<li id="li_'+s+"_"+this.prodInstId+'"><dd id="del_'+s+"_"+this.prodInstId+'" class="delete"></dd><span>'+v.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(u!=undefined){t+='<li id="li_'+s+"_"+this.prodInstId+'"><dd id="del_'+s+"_"+this.prodInstId+'" class="delete"></dd><span>'+u.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(this.productName!=undefined&&this.productName!=""){t+='<li id="li_'+s+"_"+this.prodInstId+'"><dd id="del_'+s+"_"+this.prodInstId+'" class="delete"></dd><span>'+this.productName+'</span><dd class="mustchoose"></dd></li>'}}}}}}});if(t==""){r=""}else{r="<div class='fs_choosed'>订购4G流量包，需订购和取消如下功能产品：<br><ul>"+t+"</ul></div><br>"}}var q=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(q)){var t="";$.each(q,function(){if(this.memberInfo==undefined){return true}var u=true;$.each(this.memberInfo,function(){if(ec.util.isObj(this.accProdInstId)&&s==this.accProdInstId){u=false;return false}});if(u){return true}var v=CacheData.getOffer(s,this.prodOfferInstId);var w=CacheData.getOfferSpec(s,this.prodOfferId);if(this.state=="DEL"){if(v!=undefined){t+='<li id="li_'+s+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+s+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+v.offerSpecName+"</span></li>"}else{if(w!=undefined){t+='<li id="li_'+s+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+s+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+w.offerSpecName+"</span></li>"
}else{if(this.prodOfferName!=undefined&&this.prodOfferName!=""){t+='<li id="li_'+s+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+s+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+this.prodOfferName+"</span></li>"}}}}else{if(this.state=="ADD"){if(v!=undefined){t+='<li id="li_'+s+"_"+this.prodOfferInstId+'"><dd id="del_'+s+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+v.offerSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(w!=undefined){t+='<li id="li_'+s+"_"+this.prodOfferInstId+'"><dd id="del_'+s+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+w.offerSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(this.prodOfferName!=undefined&&this.prodOfferName!=""){t+='<li id="li_'+s+"_"+this.prodOfferInstId+'"><dd id="del_'+s+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+this.prodOfferName+'</span><dd class="mustchoose"></dd></li>'}}}}}});if(t!=""){r+="<div class='fs_choosed'>订购4G流量包，需开通和关闭如下可选包：<br><ul>"+t+"</ul></div>"}}return r};return{init:l,offerChangeView:c,changeOffer:i,changeTab:h,checkOrder:f,checkAttachOffer:d,fillOfferChange:m,checkOfferProd:a,getChangeInfo:e,setChangeOfferSpec:k}})();CommonUtils.regNamespace("CacheData");CacheData=(function(){var c=function(N,O){O.isdel="C";var K=true;for(var M=0;M<AttachOffer.openList.length;M++){var L=AttachOffer.openList[M];if(L.prodId==N){K=false;break}}if(K){var L={prodId:N,specList:[]};AttachOffer.openList.push(L)}CacheData.getOfferSpecList(N).push(O)};var j=function(O,L){L.isdel="C";if(L.servSpecId==undefined){L.servSpecId=L.objId}if(L.servSpecName==undefined){L.servSpecName=L.objName}var K=true;for(var N=0;N<AttachOffer.openServList.length;N++){var M=AttachOffer.openServList[N];if(M.prodId==O){K=false;break}}if(K){var M={prodId:O,servSpecList:[]};AttachOffer.openServList.push(M)}CacheData.getServSpecList(O).push(L)};var x=function(K,L){if(L!=undefined){$.each(L.offerRoles,function(){$.each(this.roleObjs,function(){if($("#check_"+K+"_"+this.objId).attr("checked")=="checked"){this.selQty=1}else{this.selQty=2}})})}};var F=function(O,L,K){var N='<form id="paramForm">';if(K==2){if(ec.util.isArray(L.prodSpecParams)){for(var M=0;M<L.prodSpecParams.length;M++){var Q=L.prodSpecParams[M];if(Q.value==undefined){Q.value=""}N+=o(O,Q,Q.itemSpecId,Q.value)}}}else{if(K==3){if(ec.util.isArray(L.prodSpecParams)){for(var M=0;M<L.prodSpecParams.length;M++){var Q=L.prodSpecParams[M];if(ec.util.isArray(L.prodInstParams)){$.each(L.prodInstParams,function(){if(this.itemSpecId==Q.itemSpecId){Q.value=this.value}})}if(Q.value==undefined){Q.value=""}N+=o(O,Q,Q.itemSpecId,Q.value)}}}else{if(K==1){if(L.offerSpec!=undefined){if(ec.util.isArray(L.offerSpec.offerSpecParams)){var P=L.offerSpec.offerSpecParams;$.each(P,function(){var R=this;if(ec.util.isArray(L.offerParamInfos)){$.each(L.offerParamInfos,function(){if(this.itemSpecId==R.itemSpecId){R.value=this.value}})}N+=o(O,this,this.itemSpecId,this.value)})}}}else{if(ec.util.isArray(L.offerSpecParams)){var P=L.offerSpecParams;$.each(P,function(){N+=o(O,this,this.itemSpecId,this.value)})}}}}N+="</form>";return N};var f=function(M,L){var K=$('<form id="appForm"></form>');if(!!L&&L.length>0){$.each(L,function(){var N=$('<input id="'+M+"_"+this.objId+'" name="'+M+'" type="checkbox">'+this.objName+"</input></br>");if(this.minQty==0){if(this.dfQty>0){N.attr("checked","checked")}}else{if(this.minQty>0){N.attr("checked","checked");N.attr("disabled","disabled")}}K.append(N)})}return K};var o=function(P,R){var M=R.itemSpecId;if(R.setValue==undefined){R.setValue=R.value}var N=R.setValue;var K="";if(ec.util.isArray(R.valueRange)){var O="";if(R.rule.isConstant=="Y"){K=R.name+": <select class='inputWidth183px' id="+P+"_"+M+" disabled='disabled'>"}else{if(R.rule.isOptional=="N"){K=R.name+": <select class='inputWidth183px' id="+P+"_"+M+" data-validate='validate(required,reg:"+R.rule.maskMsg+"("+R.rule.mask+")) on(blur)'><label class='f_red'>*</label><br>"}else{K=R.name+": <select class='inputWidth183px' id="+P+"_"+M+"><br>";O+='<option value="" >请选择</option>'}}for(var L=0;L<R.valueRange.length;L++){var Q=R.valueRange[L];if(Q.value==R.setValue){O+='<option value="'+Q.value+'" selected="selected" >'+Q.text+"</option>"}else{O+='<option value="'+Q.value+'">'+Q.text+"</option>"}}K+=O+"</select><br>"}else{if(R.dataTypeCd==1){if(R.rule==undefined){K+=R.name+' : <input id="'+P+"_"+M+'" class="inputWidth183px" type="text" value="'+N+'" ><br>'}else{if(R.rule.isConstant=="Y"){K+=R.name+' : <input id="'+P+"_"+M+'" class="inputWidth183px" type="text" disabled="disabled" value="'+N+'" ><br>'}else{if(R.rule.isOptional=="N"){K+=R.name+' : <input id="'+P+"_"+M+'" class="inputWidth183px" type="text" data-validate="validate(required,reg:'+R.rule.maskMsg+"("+R.rule.mask+')) on(blur)" value="'+N+'" ><label class="f_red">*</label><br>'}else{K+=R.name+' : <input id="'+P+"_"+M+'" class="inputWidth183px" type="text" data-validate="validate(reg:'+R.rule.maskMsg+"("+R.rule.mask+')) on(blur)" value="'+N+'" ><br>'}}}}else{if(R.dataTypeCd==8){if(R.rule==undefined){K+=R.name+' : <input id="'+P+"_"+M+'" class="inputWidth183px" type="password" value="'+N+'" ><br>'}else{if(R.rule.isConstant=="Y"){K+=R.name+' : <input id="'+P+"_"+M+'" class="inputWidth183px" type="password"  disabled="disabled" value="'+N+'" ><br>'}else{if(R.rule.isOptional=="N"){K+=R.name+' : <input id="'+P+"_"+M+'" class="inputWidth183px" type="password" data-validate="validate(required,reg:'+R.rule.maskMsg+"("+R.rule.mask+')) on(blur)" value="'+N+'" ><label class="f_red">*</label><br>'}else{K+=R.name+' : <input id="'+P+"_"+M+'" class="inputWidth183px" type="password" data-validate="validate(reg:'+R.rule.maskMsg+"("+R.rule.mask+')) on(blur)" value="'+N+'" ><br>'}}}}else{if(R.dataTypeCd==4){}}}}return K};var r=function(N,L,K){var M='<form id="paramForm">';var O="";if(K==0){$.each(L.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4){if(this.minQty==0&&this.maxQty>0&&this.dfQty>0){O+='<input id="check_'+N+"_"+this.objId+'" type="checkbox" checked="checked"><label for=check_'+N+"_"+this.objId+">"+this.objName+"</label><br>"}else{if(this.minQty>0){O+='<input id="check_'+N+"_"+this.objId+'"  type="checkbox" checked="checked" disabled="disabled"><label for=check_'+N+"_"+this.objId+">"+this.objName+"</label><br>"}else{if(this.minQty==0&&this.maxQty>0&&this.dfQty==0){O+='<input id="check_'+N+"_"+this.objId+'" type="checkbox"><label for=check_'+N+"_"+this.objId+">"+this.objName+"</label><br>"}}}}})});if(O==""){M="订购【"+L.offerSpecName+"】可选包"}else{M="订购【"+L.offerSpecName+"】可选包，需要开通以下勾选的功能产品：<br>"+O}}else{if(K==1){$.each(L.offerMemberInfos,function(){var P=this;$.each(L.offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(P.objId==this.objId&&this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){var Q=P.objInstId;if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE&&this.minQty<=0){O+='<input id="check_'+N+"_"+Q+'" type="checkbox" checked="checked" disabled="disabled"><label for=check_'+N+"_"+this.servId+">"+this.objName+"</label><br>"}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE&&this.minQty<=0){O+='<input id="check_'+N+"_"+Q+'" type="checkbox" checked="checked"><label for=check_'+N+"_"+this.servId+">"+this.objName+"</label><br>"}}}})})});if(O==""){M="退订【"+L.offerSpecName+"】可选包"}else{M="退订【"+L.offerSpecName+"】可选包，需要关闭以下勾选的功能产品：<br>"+O}}else{if(K==2){$.each(L.offerRoles,function(){$.each(this.roleObjs,function(){if(this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE&&this.minQty<=0){O+='<input id="check_'+N+"_"+this.objId+'" type="checkbox" checked="checked" disabled="disabled"><label for=check_'+N+"_"+this.objId+">"+this.objName+"</label><br>"}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE&&this.minQty<=0){O+='<input id="check_'+N+"_"+this.objId+'" type="checkbox" checked="checked"><label for=check_'+N+"_"+this.objId+">"+this.objName+"</label><br>"}}}})});
if(O==""){M="取消订购【"+L.offerSpecName+"】可选包"}else{M="取消订购【"+L.offerSpecName+"】可选包，需要取消开通以下勾选的功能产品：<br>"+O}}}}M+="</form>";return M};var H=function(L,N){if(ec.util.isArray(N.offerSpecParams)){for(var K=0;K<N.offerSpecParams.length;K++){var M=N.offerSpecParams[K];if(ec.util.isArray(M.valueRange)){if(M.value==undefined||M.value==""){if(M.rule.isOptional=="N"){return false}}}else{if(M.value==undefined||M.value==""){if(M.rule.isOptional=="N"){return false}}}}}N.isset="Y";return true};var t=function(M,K){if(ec.util.isArray(K.prodSpecParams)){for(var L=0;L<K.prodSpecParams.length;L++){var N=K.prodSpecParams[L];if(ec.util.isArray(N.valueRange)){if(N.value==undefined||N.value==""){if(N.rule.isOptional=="N"){return false}}}else{if(N.value==undefined||N.value==""){if(N.rule.isOptional=="N"){return false}}}}}K.isset="Y";return true};var y=function(M){for(var L=0;L<AttachOffer.openList.length;L++){var K=AttachOffer.openList[L];if(K.prodId==M){return K.specList}}return[]};var w=function(M,N){var K=y(M);if(K!=undefined){for(var L=0;L<K.length;L++){if(K[L].offerSpecId==N){return K[L]}}}};var p=function(N,O,L){var K=w(N,O);if(ec.util.isObj(K)){for(var M=0;M<K.offerSpecParams.length;M++){if(K.offerSpecParams[M].itemSpecId==L){return K.offerSpecParams[M]}}}};var a=function(O,R,L){var S=w(O,R);if(!!S.offerRoles){for(var N=0;N<S.offerRoles.length;N++){var Q=S.offerRoles[N];for(var M=0;M<Q.roleObjs.length;M++){var P=Q.roleObjs[M];if(P.prodSpecParams!=undefined&&P.prodSpecParams.length>0){for(var K=0;K<P.prodSpecParams.length;K++){if(P.prodSpecParams[K].itemSpecId==L){return P.prodSpecParams[K]}}}}}}};var d=function(L){for(var K=0;K<AttachOffer.openedList.length;K++){var M=AttachOffer.openedList[K];if(M.prodId==L){return M.offerList}}return[]};var z=function(N,K){var L=d(N);if(ec.util.isArray(L)){for(var M=0;M<L.length;M++){if(L[M].offerId==K){return L[M]}}}};var h=function(M,N){var K=d(M);if(ec.util.isArray(K)){for(var L=0;L<K.length;L++){if(K[L].offerSpecId==N){return K[L]}}}};var m=function(O,K,L){var N=z(O,K);if(ec.util.isArray(N.offerSpec.offerSpecParams)){for(var M=0;M<N.offerSpec.offerSpecParams.length;M++){if(N.offerSpec.offerSpecParams[M].itemSpecId==L){return N.offerSpec.offerSpecParams[M]}}}};var J=function(Q,O,K){var R=z(Q,O);if(ec.util.isArray(R.offerMembers)){for(var P=0;P<R.offerMembers.length;P++){var M=R.offerMembers[P];for(var N=0;N<M.prodParamInfos.length;N++){for(var L=0;L<M.prodParamInfos.length;L++){var S=M.prodParamInfos[L];if(S.itemSpecId==K){return S}}}}}};var B=function(M){for(var L=0;L<AttachOffer.openServList.length;L++){var K=AttachOffer.openServList[L];if(K.prodId==M){return K.servSpecList}}return[]};var b=function(M,N){var K=B(M);if(K!=undefined){for(var L=0;L<K.length;L++){if(K[L].servSpecId==N){return K[L]}}}};var i=function(N,O,L){var K=b(N,O);if(ec.util.isArray(K.prodSpecParams)){for(var M=0;M<K.prodSpecParams.length;M++){if(K.prodSpecParams[M].itemSpecId==L){return K.prodSpecParams[M]}}}};var v=function(L){for(var K=0;K<AttachOffer.openedServList.length;K++){var M=AttachOffer.openedServList[K];if(M.prodId==L){return M.servList}}return[]};var A=function(M,N){var L=v(M);if(ec.util.isArray(L)){for(var K=0;K<L.length;K++){if(L[K].servId==N){return L[K]}}}};var k=function(M,N){var L=v(M);if(ec.util.isArray(L)){for(var K=0;K<L.length;K++){if(L[K].servSpecId==N){return L[K]}}}};var g=function(N,P,K){var O=A(N,P);if(ec.util.isArray(O.prodSpecParams)){for(var L=0;L<O.prodSpecParams.length;L++){var M=O.prodSpecParams[L];if(M.itemSpecId==K){return M}}}};var s=function(M){for(var L=0;L<AttachOffer.openAppList.length;L++){var K=AttachOffer.openAppList[L];if(K.prodId==M){return K.appList}}return[]};var E=function(M){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){for(var K=0;K<OrderInfo.offer.offerMemberInfos.length;K++){var L=OrderInfo.offer.offerMemberInfos[K];if(L.objInstId==M){return L}}}return{}};var e=function(N){for(var K=0;K<OrderInfo.oldoffer.length;K++){for(var L=0;L<OrderInfo.oldoffer[K].offerMemberInfos.length;L++){var M=OrderInfo.oldoffer[K].offerMemberInfos[L];if(M.objInstId==N){return M}}}return{}};var l=function(M,O){var N={servSpecId:O,prodId:M,orderedServSpecIds:[]};var K=CacheData.getServSpecList(M);if(ec.util.isArray(K)){$.each(K,function(){if(this.servSpecId!=O&&this.isdel!="Y"&&this.isdel!="C"){N.orderedServSpecIds.push(this.servSpecId)}})}var L=CacheData.getServList(M);if(ec.util.isArray(L)){$.each(L,function(){if(this.servSpecId!=O&&this.isdel!="Y"&&this.isdel!="C"){N.orderedServSpecIds.push(this.servSpecId)}})}return N};var u=function(M,P){var O={prodId:M,offerSpecId:P,objType:CONST.OBJ_TYPE.PROD,orderedOfferSpecIds:[]};var N=CacheData.getOfferSpec(M,P);if(ec.util.isObj(N)){if(ec.util.isArray(N.offerRoles)){$.each(N.offerRoles,function(){if(ec.util.isArray(this.roleObjs)){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){O.offerRoleId=this.offerRoleId;O.objId=this.objId;return false}})}})}}else{var K=CacheData.getOfferBySpecId(M,P);if(ec.util.isObj(K)){O.offerRoleId=K.offerRoleId;if(ec.util.isArray(K.offerMemberInfos)){$.each(K.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){O.objId=this.objId;return false}})}}}var L=CacheData.getOfferSpecList(M);if(ec.util.isArray(L)){$.each(L,function(){if(this.offerSpecId!=P&&this.isdel!="Y"){if(this.offerSpecId!=undefined){O.orderedOfferSpecIds.push(this.offerSpecId)}}})}return O};var C=function(O,Q,N){if(ec.util.isObj(O)){if(ec.util.isArray(O.result.servSpec)){for(var P=0;P<O.result.servSpec.length;P++){var L=O.result.servSpec[P];var M=CacheData.getServBySpecId(Q,L.servSpecId);var R=CacheData.getServSpec(Q,L.servSpecId);if(L.ifDault==0){if(ec.util.isObj(M)){var T=$("#li_"+Q+"_"+M.servId);if(ec.util.isObj(T)){var S=$("#span_"+Q+"_"+M.servId);var K=$("#span_remove_"+Q+"_"+M.servId);if(ec.util.isObj(S)){S.removeClass("del")}if(ec.util.isObj(K)){K.hide()}T.removeAttr("onclick");M.isdel="N"}}else{if(ec.util.isObj(R)){var T=$("#li_"+Q+"_"+R.servSpecId);if(ec.util.isObj(T)){var S=$("#span_"+Q+"_"+R.servSpecId);var K=$("#span_remove_"+Q+"_"+R.servSpecId);if(ec.util.isObj(S)){S.removeClass("del")}if(ec.util.isObj(K)){K.hide()}T.removeAttr("onclick");R.isdel="N"}}else{if(OrderInfo.actionFlag==2){L.isdel="C";CacheData.setServSpec(Q,L);AttachOffer.addOpenServList(Q,L.servSpecId,L.servSpecName,L.ifParams)}}}}else{if((OrderInfo.actionFlag==6)&&L.ifDault==1){if(N=="delViceCard"){if(ec.util.isObj(M)){var T=$("#li_"+Q+"_"+M.servId);if(ec.util.isObj(T)){var S=$("#span_"+Q+"_"+M.servId);if(ec.util.isObj(S)){S.removeClass("del")}M.isdel="N"}}else{if(ec.util.isObj(R)){var T=$("#li_"+Q+"_"+R.servSpecId);if(ec.util.isObj(T)){var S=$("#span_"+Q+"_"+R.servSpecId);if(ec.util.isObj(S)){S.removeClass("del")}R.isdel="N"}}else{L.isdel="C";CacheData.setServSpec(Q,L);AttachOffer.addOpenServList(Q,L.servSpecId,L.servSpecName,L.ifParams)}}}}}}}}};var q=function(P,S){if(ec.util.isObj(P)){if(ec.util.isArray(P.result.offerSpec)){for(var Q=0;Q<P.result.offerSpec.length;Q++){var O=P.result.offerSpec[Q];if(O.ifDault==0){var V=CacheData.getOfferBySpecId(S,O.offerSpecId);if(ec.util.isObj(V)){var T=$("#li_"+S+"_"+V.offerId);if(ec.util.isObj(T)){var U=$("#span_"+S+"_"+V.offerId);var L=$("#span_remove_"+S+"_"+V.offerId);if(ec.util.isObj(U)){U.removeClass("del")}if(ec.util.isObj(L)){L.hide()}T.removeAttr("onclick");V.isdel="N"}}var R=CacheData.getOfferSpec(S,O.offerSpecId);if(ec.util.isObj(R)){var T=$("#li_"+S+"_"+R.offerSpecId);if(ec.util.isObj(T)){var U=$("#span_"+S+"_"+R.offerSpecId);var L=$("#span_remove_"+S+"_"+R.offerSpecId);if(ec.util.isObj(U)){U.removeClass("del")}if(ec.util.isObj(L)){L.hide()}T.removeAttr("onclick");R.isdel="N"}}else{if(OrderInfo.actionFlag==2){O.isdel="C";CacheData.setOfferSpec(S,O);var N=CacheData.getExcDepOfferParam(S,O.offerSpecId);AttachOffer.addOpenList(S,O.offerSpecId);if(N.orderedOfferSpecIds.length>0){var M=query.offer.queryExcludeDepend(N);if(M!=undefined&&M.result!=undefined){var W=M.result.offerSpec.exclude;if(ec.util.isArray(W)){for(var Q=0;Q<W.length;Q++){var K=W[Q];
var V=CacheData.getOfferBySpecId(S,K);if(V!=undefined){var T=$("#li_"+S+"_"+V.offerId);if(ec.util.isObj(T)){var U=$("#span_"+S+"_"+V.offerId);var L=$("#span_remove_"+S+"_"+V.offerId);if(ec.util.isObj(U)){U.addClass("del")}if(ec.util.isObj(L)){L.hide()}T.removeAttr("onclick");V.isdel="N"}}}}}}}}}}}}};var I=function(K){var L="";if(K>0){if(OrderInfo.offer.offerMemberInfos!=undefined){$.each(OrderInfo.offer.offerMemberInfos,function(M){if(this.objInstId==K){L=this.offerRoleId;return false}})}}else{if(K<0){if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(N){var M=this.offerRoleId;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==K){L=M;return false}})}})}}}return L};var D=function(N){var K=[];for(var L=0;L<N.offerMemberInfos.length;L++){var M=N.offerMemberInfos[L];if(M.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){K.push(M)}}for(var L=0;L<N.offerMemberInfos.length;L++){var M=N.offerMemberInfos[L];if(M.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){K.push(M)}}N.offerMemberInfos=K};var G=function(R){if(R.dependOffer.offerGrpInfos.length>0){var Q=R.dependOffer;for(var N=0;N<Q.offerGrpInfos.length;N++){var P=Q.offerGrpInfos[N];var O=$("input[name="+P.grpId+"]:checked");var K=O.length;Q.offerGrpInfos[N].checkLen=K;for(var M=0;M<P.subOfferSpecInfos.length;M++){var L=P.subOfferSpecInfos[M];O.each(function(){if($(this).val()==L.offerSpecId){L.isCheck=true}})}}}};return{getServSpec:b,setParam:H,setServParam:t,setOfferSpec:c,setServSpec:j,setServ2OfferSpec:x,setOffer2ExcludeOfferSpec:G,sortOffer:D,getParamContent:F,getOfferSpecList:y,getOfferSpec:w,getSpecParam:p,getOfferList:d,getOffer:z,getOfferParam:m,getOfferBySpecId:h,getServList:v,getServ:A,getServBySpecId:k,getServSpec:b,getServSpecList:B,getProdInstParam:J,getProdSpecParam:a,getServInstParam:g,getServSpecParam:i,getOfferProdStr:r,getOpenAppList:s,getAppContent:f,getOfferMember:E,getExcDepServParam:l,getExcDepOfferParam:u,getOfferRoleId:I,parseServ:C,parseOffer:q,getOldOfferMember:e}})();CommonUtils.regNamespace("cust","mgr");cust.mgr=(function(){var N=function(){$("#custCreateForm").off("formIsValid").on("formIsValid",function(Y){var X=contextPath+"/order/createorderlonger";var W=$.callServiceAsJson(X,{});if(W.code==0){OrderInfo.custorderlonger=W.data}o()}).ketchup({bindElement:"btn_cust_create_save"})};var F=false;var a={};var c={};var Q=null;var l=null;var L="0";var m=null;var B="";var J=[];var s=[];var z=function(){return Q};var y="";var j=function(){$("#custAuthForm").off("formIsValid").on("formIsValid",function(X,W){var Y=a;Y.prodPwd=$.trim($("#authPassword").val());Y.accessNumber=a.accessNumber;Y.authFlag=l;$.callServiceAsHtml(contextPath+"/cust/custAuth",Y,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(Z){if(Z.code==-2){return}if(Z.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}try{var ab=$.parseJSON(Z.data);$.alertMore("异常信息",ab.resultMsg,ab.errorStack,"error");return}catch(aa){}Q=Y;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;v(Z)},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"custAuthbtn"})};var t=function(X,Y){var W=$(X).val();i(W,Y);g()};var i=function(Y,X){var W=$("#"+X);$.callServiceAsJson(contextPath+"/cust/queryCertType",{partyTypeCd:Y},{before:function(){},done:function(Z){if(Z.code==-2){$.alertM(Z.data);return false}if(Z.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(Z.code==0){var ad=Z.data;if(ad!=undefined&&ad.length>0){var af=[];for(var ab=0;ab<ad.length;ab++){var ae=true;for(var aa=0;aa<af.length;aa++){ae=ae&&ad[ab].certTypeCd!=af[aa].certTypeCd;if(!ae){break}}if(ae){af.push(ad[ab])}}for(var ab=0;ab<af.length;ab++){var ac=af[ab];W.append("<option value='"+ac.certTypeCd+"' >"+ac.name+"</option>")}W.selectmenu().selectmenu("refresh");if(X=="identidiesTypeCd"){f($("#"+X).children(":first-child"),"cCustIdCard")}}}},fail:function(Z){},always:function(){}})};var I=function(W,Y){var X=$(W).val();if(X==-1){$("#"+Y).attr("placeHolder","请输入接入号码");$("#"+Y).attr("data-validate","validate(required:请准确填写接入号码) on(blur)")}else{if(X==1){$("#"+Y).attr("placeHolder","请输入身份证号码");$("#"+Y).attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(blur)")}else{if(X==2){$("#"+Y).attr("placeHolder","请输入军官证");$("#"+Y).attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(X==3){$("#"+Y).attr("placeHolder","请输入护照");$("#"+Y).attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#"+Y).attr("placeHolder","请输入证件号码");$("#"+Y).attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}}if(X!=-1){$("#isAppointNum").val("0").slider().slider("refresh")}e()};var f=function(W,Z){var X=$(W).val();var Y=$("#"+Z);if(X==1){Y.attr("placeHolder","请输入合法身份证号码");Y.attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(X==2){Y.attr("placeHolder","请输入合法军官证");Y.attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(X==3){Y.attr("placeHolder","请输入合法护照");Y.attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{Y.attr("placeHolder","请输入合法证件号码");Y.attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}g()};var e=function(){$("#custQueryFirstForm").off("formIsValid").on("formIsValid",function(X,Z){var af="";var ae="";var Y="";var W="";var ac="";var ab="";var ad="";af=$("#p_cust_identityCd").val();ac=$.trim($("#p_cust_identityNum").val());if(order.cust.mgr.fromProvFlag=="1"||(af!=-1&&CONST.getAppDesc()!=0)){af=$("#p_cust_identityCd").val();l="1"}else{l="0"}if(af==-1){W=ac;ac="";af=""}else{if(af=="acctCd"||af=="custNumber"){W="";ac="";af="";ab=$("#p_cust_identityCd").val();ad=$.trim($("#p_cust_identityNum").val())}}Y=$("#DiffPlaceFlag").val();areaId=$("#p_cust_areaId").val();if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");return}var aa={acctNbr:W,identityCd:af,identityNum:ac,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:Y,areaId:areaId,queryType:ab,queryTypeValue:ad};$.callServiceAsHtml(contextPath+"/pad/cust/queryCust",aa,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(ag){if(ag.code==-2){return}R(ag)},fail:function(ag){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})}).ketchup({bindElement:"a_user_search"})};var g=function(){$("#custCreateForm").off("formIsValid").on("formIsValid",function(Y){var X=contextPath+"/order/createorderlonger";var W=$.callServiceAsJson(X,{});if(W.code==0){OrderInfo.custorderlonger=W.data}o()}).ketchup({bindElement:"btn_cust_create_save"})};var R=function(W){if(W.data.indexOf("false")>=0){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}var X=$("#div_user_qry_result");X.find("ul").html(W.data);$("#a_cust_qry_back").off("tap").on("tap",function(Y){l=""});$.jqmRefresh(X)};var G=function(){window.location.reload();$("#custQueryFirstForm").show();$("#custInfo").hide();$("#p_cust_identityNum").val("");$("#authPassword").val("");l="";OrderInfo.boCusts.partyId="";OrderInfo.boCustInfos.name="";OrderInfo.boCustIdentities.identityNum="";OrderInfo.cust={custId:-1,custName:"",areaId:""};OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId="";OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.cust="";y="";OrderInfo.order.step=0;if((CONST.getAppDesc()!=0)&&($("#custModifyId").is(":hidden"))){$("#a-cust-modify").show()}};var q=function(W){var X=a;X.prodPwd=$.trim($("#authPassword").val());X.authFlag=l;$.callServiceAsHtml(contextPath+"/cust/custAuth",X,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(Y){if(Y.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}Q=X;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;
OrderInfo.cust=a;v(Y)},always:function(){$.unecOverlay()}})};var K=function(){if(order.cust.mgr.jumpAuthflag!="0"){$.alert("提示","没有跳过校验权限！");return}var W=a;W.authFlag="1";$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",W,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(X){if(X.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}Q=W;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;v(X)},always:function(){$.unecOverlay()}})};var v=function(W){if(l=="0"){$("#dlg-chk-auth").popup("close")}$("#custQueryFirstForm").hide();$("#custInfo").html(W.data).show().enhanceWithin();if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){$("#a-cust-modify").hide()}else{$("#a-cust-modify").show();$("#a-cust-modify").off("tap").on("tap",order.prodModify.showCustInfoModify)}$("#a-cust-rechk").off("tap").on("tap",G);$("#a-qry-cust-prod").off("tap").on("tap",U);$("#cCustName").val("");$("#cCustIdCard").val("");main.home.hideMainIco()};var b=function(W){var X=$(W);a={custId:X.attr("custId"),partyName:X.attr("partyName"),idCardNumber:X.attr("idCardNumber"),identityName:X.attr("identityName"),areaName:X.attr("areaName"),areaId:X.attr("areaId"),identityCd:X.attr("identityCd"),addressStr:X.attr("addressStr"),norTaxPayer:X.attr("norTaxPayer"),segmentId:X.attr("segmentId"),segmentName:X.attr("segmentName"),custFlag:X.attr("custFlag"),vipLevel:X.attr("vipLevel"),vipLevelName:X.attr("vipLevelName")};if(l=="0"){if(order.cust.mgr.authType=="00"){$("#custAuthTypeName").html("客户密码：")}else{$("#custAuthTypeName").html("产品密码：")}if(order.cust.mgr.jumpAuthflag=="0"){$("#jumpAuth").show();$("#jumpAuth").off("tap").on("tap",K)}else{$("#jumpAuth").hide()}$("#authPassword").val("");$("#custAuthbtn").off("tap").on("tap",j);$("#dlg-chk-auth").popup("open")}else{q(W)}};var x=function(){var W=$("#p_cust_areaId").val();if(W.indexOf("0000")>0){$.alert("提示","前页受理地区为省级地区无法进行创建,请先选择市级地区！");return}$.callServiceAsHtmlGet(contextPath+"/pad/cust/create.html",{},{done:function(Y){if(!Y||!Y.data){return}var X=$.popup("#div_cust_create",Y.data,{cache:true,width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}}});$("#div_cust_create input[type='text']").val("");t($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");w();X.find("div[data-role='collapsible']").collapsible({collapsed:true,collapse:function(Z,aa){$("#contactName").attr("data-validate","");g()},expand:function(Z,aa){$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(blur)").attr("placeholder","请准确填写联系人名称");g()}})}})};var r=function(X){$("#plan2ndDiv tbody tr").removeClass("plan_select2");$("#plan2ndDiv tbody tr").children(":first-child").next().html("");$(X).addClass("plan_select2");var W="<i class='select'></i>";$(X).children(":first-child").next().html(W);order.prodModify.getChooseProdInfo()};_btnQueryCustProdPrepare=function(){$.callServiceAsHtmlGet(contextPath+"/pad/cust/orderProdPrepare.html",{diffPlaceFlag:$("#diffPlaceFlag").val()},{before:function(){},always:function(){},done:function(W){if(!W||W.code!=0){$.alert("提示","已订购业务查询失败,稍后重试");return}$.popup("#dlg_cust_prod",W.data,{width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){},cache:true});$(".ui-panel-inner > .ui-listview").height($(window).height());P(1)}})};var U=function(){if(OrderInfo.cust.custId==-1){$.alert("提示","新建客户无法查询已订购业务！");return}if(y==""){_btnQueryCustProdPrepare();y="1"}else{if(y=="1"){$("#dlg_cust_prod").popup("open",{transition:"slide"});y="1"}else{$("#dlg_cust_prod").popup("close");y="1"}}};var P=function(Y,W){var Z={};if(!a||!$.isPlainObject(a)||$.isEmptyObject(a)){Z.custId=""}else{Z.custId=a.custId;Z.areaId=$("#area").attr("areaId")}if($("#accNbrQuery").length==1){Z.acctNbr=$.trim($("#accNbrQuery").val());if(CONST.getAppDesc()==0){Z.areaId=$("#p_cust_areaId").val()}}else{if($("#isAppointNum").attr("value")=="1"){Z.acctNbr=$.trim($("#p_cust_identityNum").val());if(CONST.getAppDesc()==0){Z.areaId=$("#p_cust_areaId").val()}}else{Z.acctNbr=""}}Z.pageSize="8";Z.curPage=Y;if(!(Z.custId)||Z.custId==""){$.alert("提示","无法查询已订购产品");return}var X=contextPath+"/pad/cust/orderprod";$.callServiceAsHtmlGet(X,Z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(aa){if(!aa||aa.code!=0){$.alert("提示","查询失败,稍后重试");return}var ab=$("#dlg_cust_prod").find("ul:first");if(Y==1){ab.html(aa.data)}else{ab.append(aa.data)}ab.listview().listview("refresh");ab.find("li").off("tap").on("tap",function(){var ac=$(this);if(ac.hasClass("multi")){if(ac.next(".multidiv").is(":hidden")){ac.next(".multidiv").show().siblings(".multidiv").hide()}else{ac.next(".multidiv").hide().siblings(".multidiv").hide()}}k(this,function(){ac.addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg");$("#div_2nd_order").panel("open")})});ab.find("div.multidiv li").off("tap").on("tap",function(){k(this,function(){$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").parent().siblings("li").removeClass("userorderlistlibg");$("#div_2nd_order").panel("open");order.prodModify.getChooseProdInfo()})});ab.find("li:first").trigger("tap").next("div.multidiv li:first").trigger("tap");order.prodModify.getChooseProdInfo()}})};var k=function(X,W){if(1==OrderInfo.order.step&&(!$(X).hasClass("userorderlistlibg"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){u();OrderInfo.order.step=0;W.apply(this,[])},no:function(){}})}else{if(2==OrderInfo.order.step&&(!$(X).hasClass("userorderlistlibg"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();u();OrderInfo.order.step=0;W.apply(this,[])},no:function(){}})}else{W.apply(this,[])}}};var A=function(){order.pad.area.chooseAreaTree("order/prepare","p_cust_areaId_val","p_cust_areaId",3)};var E=function(){order.area.chooseAreaTreeManger("cust/preQueryCust","p_areaId_val","p_areaId",3)};var S=function(){order.area.chooseAreaTreeAll("p_cust_areaId_val","p_cust_areaId",3,"limitProvince")};var d=function(){order.area.chooseAreaTree("order/prepare","p_ncust_areaId_val","p_ncust_areaId",3)};var D=function(){order.area.chooseAreaTree("order/prepare","prodareaName","prodareaid",3);order.prodModify.choosedProdInfo.areaId=$("#prodareaid").val()};var M=function(){$("#p_cust_identityCd").off("change").on("change",function(){I($(this).find("option:selected"),"p_cust_identityNum");$("#p_cust_identityCd").selectmenu().selectmenu("refresh")});i("-1","p_cust_identityCd");$("#isAppointNum").off("change").on("change",V);T();$("#a_user_create").off("tap").on("tap",x);e()};var T=function(){if($("#fromProvFlag").length&&$("#fromProvFlag").val()=="1"){order.cust.mgr.fromProvFlag="1";order.cust.mgr.provIsale=$("#provIsale").val();$("#p_cust_areaId_val").val("");$("#p_cust_areaId").val($("#provAreaId").val());$("#p_cust_identityCd").val($("#provIdentityCd").val());$("#p_cust_identityNum").val($("#provIdentityNum").val());if($("#provIdentityCd").val()!=-1){$("#isAppointNum").attr("checked",false)}$("#a_user_search").click()}else{order.cust.fromProvFlag="0";order.cust.provIsale=null}};var w=function(){$.callServiceAsHtmlGet(contextPath+"/pad/cust/partyProfileSpecList",{},{before:function(){$.ecOverlay("<strong>加载更多属性,请稍等...</strong>")},always:function(){$.unecOverlay()},fail:function(){$.alert("提示","属性加载异常,请稍后重试.");$.unecOverlay()},done:function(X){if(X.code==-2){return}var W=$("#partyProfile").html(X.data);$("#otabs li").on("tap",function(){O($(this))});$.jqmRefresh(W)}})};var h=function(){var Y="";var W="";var X="";Y=$("#p_cust_identityCd").val();X=$.trim($("#p_cust_identityNum").val());if(X==""){$.alert("提示","请输入证件号码！");
return}if(Y==1){Y=$("#p_cust_identityCd").val()}if(Y==-1){W=X;X="";Y=""}diffPlace=$("#DiffPlaceFlag").val();areaId=$("#p_areaId").val();var Z={acctNbr:W,identityCd:Y,identityNum:X,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:areaId};$.callServiceAsHtmlGet(contextPath+"/cust/queryCustAlone",Z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(aa){if(aa.code==-2){return}if(!aa){aa.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(aa.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(aa.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctList").html(aa.data).show();$("#acctDetail").hide()},fail:function(aa){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var p=function(X){var W={partyId:X,areaId:$("#p_areaId").val()};$.callServiceAsHtml(contextPath+"/cust/custInfo",W,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(Y){if(Y.code==-2){return}if(!Y){Y.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(Y.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(Y.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctDetail").html(Y.data).show();$("#acctList").hide()},fail:function(Y){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var H=function(){createCustInfo={cAreaId:OrderInfo.staff.soAreaId,cAreaName:OrderInfo.staff.soAreaName,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cPartyTypeName:($.trim($("#partyTypeCd  option:selected").val())==1)?"个人客户":"政企客户",cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val()),cMailAddressStr:$.trim($("#cMailAddressStr").val())};var W={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$.trim($("#headFlag  option:selected").val()),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postcode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};OrderInfo.boCustInfos.name=createCustInfo.cCustName;OrderInfo.boCustInfos.areaId=createCustInfo.cAreaId;OrderInfo.boCustInfos.partyTypeCd=createCustInfo.cPartyTypeCd;OrderInfo.boCustInfos.defaultIdType=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustInfos.addressStr=createCustInfo.cAddressStr;OrderInfo.boCustInfos.mailAddressStr=createCustInfo.cMailAddressStr;OrderInfo.boCustIdentities.identidiesTypeCd=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustIdentities.identityNum=createCustInfo.cCustIdCard;OrderInfo.boPartyContactInfo.contactAddress=W.contactAddress,OrderInfo.boPartyContactInfo.contactDesc=W.contactDesc,OrderInfo.boPartyContactInfo.contactEmployer=W.contactEmployer,OrderInfo.boPartyContactInfo.contactGender=W.contactGender,OrderInfo.boPartyContactInfo.contactId=W.contactId,OrderInfo.boPartyContactInfo.contactName=W.contactName,OrderInfo.boPartyContactInfo.contactType=W.contactType,OrderInfo.boPartyContactInfo.eMail=W.eMail,OrderInfo.boPartyContactInfo.fax=W.fax,OrderInfo.boPartyContactInfo.headFlag=W.headFlag,OrderInfo.boPartyContactInfo.homePhone=W.homePhone,OrderInfo.boPartyContactInfo.mobilePhone=W.mobilePhone,OrderInfo.boPartyContactInfo.officePhone=W.officePhone,OrderInfo.boPartyContactInfo.postAddress=W.postAddress,OrderInfo.boPartyContactInfo.postcode=W.postcode,OrderInfo.boPartyContactInfo.staffId=W.staffId,OrderInfo.boPartyContactInfo.state=W.state,OrderInfo.boPartyContactInfo.statusCd=W.statusCd;OrderInfo.cust={custId:-1,partyName:createCustInfo.cCustName,areaId:createCustInfo.cAreaId};OrderInfo.boCustProfiles=[];for(var X=0;X<J.length;X++){var Z=J[X];var Y=$("#"+Z.attrId).val();if(""==Y||undefined==Y){Y==$("#"+Z.attrId+"option:selected").val()}var Z={partyProfileCatgCd:Z.attrId,profileValue:Y,state:"ADD"};if(""!=Y&&Y!=undefined){OrderInfo.boCustProfiles.push(Z)}}$("#div_cust_create").popup("close");var aa={};aa.prodPwd="";aa.accessNumber="";aa.authFlag="1";authFlag="";aa.identityCd=createCustInfo.cIdentidiesTypeCd;aa.idCardNumber=createCustInfo.cCustIdCard;aa.partyName=createCustInfo.cCustName;aa.areaId=createCustInfo.cAreaId;aa.areaName=createCustInfo.cAreaName;aa.segmentName=createCustInfo.cPartyTypeName;aa.identityName=$("#identidiesTypeCd option:selected").text();$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",aa,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(ab){if(ab.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(ab.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}v(ab)},always:function(){$.unecOverlay()}})};var o=function(){var ab=$("#p_cust_areaId").val();if(ab==null||ab==""){ab=OrderInfo.staff.areaId}var Y=$("#p_cust_areaId_val").val();createCustInfo={cAreaId:ab,cAreaName:Y,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd option:selected").val()),cIdentidiesTypeCd:$.trim($("#identidiesTypeCd option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};diffPlace=$("#DiffPlaceFlag").val();var aa={acctNbr:"",identityCd:createCustInfo.cIdentidiesTypeCd,identityNum:createCustInfo.cCustIdCard,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:createCustInfo.cAreaId};var X=contextPath+"/pad/cust/checkIdentity";var W=$.callServiceAsJson(X,aa,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});var Z="";if(W.code==0){$.unecOverlay();$.confirm("确认","此证件号码已存在,是否确认新建?",{yes:function(){H()},no:function(){}})}else{$.unecOverlay();H()}};var O=function(W){var Z=$(W).attr("tabid");if(Z!="0"&&$("#contactName").val()==""){$("#contactName").blur();return}var X=$(W).index();var Y=$("#otabs-body > div");$(W).parent().children("li").attr("class","otab-nav");$(W).attr("class","otab-nav-action");$(W).parent().children("li").find(".ui-input-search").hide();$(W).parent().children("li").find(".ui-select").hide();$(W).children("div").show();Y.hide();Y.eq(X).show()};var V=function(){if(!F){F=true;if($("#p_cust_identityCd").find("option:selected").val()!=-1){$.alertSync("提示","只能接入号码才能指定号码！","information",function(){$("#isAppointNum").val("0").slider().slider("refresh");F=false})}}};var u=function(){var W=OrderInfo.boProd2Tds;if(W.length>0){for(var Z=0;Z<W.length;Z++){var Y={numType:2,numValue:W[Z].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",Y)}}var X=OrderInfo.boProdAns;if(X.length>0){for(var Z=0;Z<X.length;Z++){if(X[Z].idFlag){continue}var Y={numType:1,numValue:X[Z].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",Y)}order.service.boProdAn={};order.phoneNumber.resetBoProdAn()}$("#order_fill_content").empty();order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show()};var C=function(){$("#acctDetail").hide();$("#acctList").show()};return{showCustAuth:b,showCustCreate:x,custAuth:q,getCustInfo:z,custReset:G,btnQueryCustProd:P,btnQueryCustProdMore:U,jumpAuth:K,identidiesTypeCdChoose:f,custidentidiesTypeCdChoose:I,choosedCustInfo:a,partyTypeCdChoose:t,chooseArea:A,chooseAllArea:S,newCustChooseArea:d,prodChooseArea:D,init:M,partyProfiles:J,profileTabLists:s,queryCust:h,queryCustDetail:p,changeLabel:O,jumpAuthflag:B,orderBtnflag:y,custCreateButton:g,isAppointNum:V,preQueryCustChooseArea:E,linkSelectPlan:r,back:C,fromProvFlag:L,provIsale:m}
})();CommonUtils.regNamespace("cust");cust=(function(){var e=function(){$("#cmCustName").val("");$("#cmAddressStr").val("");$("#telNumber").val("");$("#mailAddressStr").val("");$("#cmCustIdCard").val("");$("#cmCustIdCardOther").val("");cust.validatorForm()};var s=function(){$("#custFormdata").data("bootstrapValidator").validate();if($("#custFormdata").data("bootstrapValidator").isValid()){k()}};var v=function(){OrderInfo.cust.custId=-1;OrderInfo.cust.partyName=$("#cmCustName").val();OrderInfo.cust.areaId=OrderInfo.staff.areaId;OrderInfo.cust.telNumber=$("#telNumber").val();OrderInfo.cust.addressStr=$("#cmAddressStr").val();OrderInfo.cust.mailAddressStr=$("#mailAddressStr").val();OrderInfo.cust.identityCd=$("#cm_identidiesTypeCd").val();if($.trim($("#contactName").val()).length>0){OrderInfo.boPartyContactInfo.contactName=$.trim($("#contactName").val());OrderInfo.boPartyContactInfo.mobilePhone=$.trim($("#mobilePhone").val());OrderInfo.boPartyContactInfo.contactAddress=$.trim($("#contactAddress").val())}if(OrderInfo.cust.identityCd==1){OrderInfo.cust.identityNum=$("#cmCustIdCard").val()}else{OrderInfo.cust.identityNum=$("#cmCustIdCardOther").val()}var w=$("#flag").val();if(ec.util.isObj(w)){var x={boCustInfos:[],boCustIdentities:[],boPartyContactInfo:[]};b();x.boCustInfos.push(OrderInfo.boCustInfos);x.boCustIdentities.push(OrderInfo.boCustIdentities);if($.trim($("#contactName").val()).length>0){x.boPartyContactInfo.push(OrderInfo.boPartyContactInfo)}SoOrder.submitOrder(x)}else{common.saveCust()}};var b=function(){OrderInfo.boCustInfos.name=OrderInfo.cust.partyName;OrderInfo.boCustInfos.areaId=OrderInfo.staff.areaId;OrderInfo.boCustInfos.partyTypeCd=1;OrderInfo.boCustInfos.defaultIdType=1;OrderInfo.boCustInfos.addressStr=OrderInfo.cust.addressStr;OrderInfo.boCustInfos.telNumber=OrderInfo.cust.telNumber;OrderInfo.boCustInfos.mailAddressStr=OrderInfo.cust.mailAddressStr;OrderInfo.boCustInfos.state="ADD";OrderInfo.boCustIdentities.identidiesTypeCd=OrderInfo.cust.identityCd;OrderInfo.boCustIdentities.identityNum=OrderInfo.cust.identityNum;OrderInfo.boCustIdentities.identidiesPic=encodeURIComponent(OrderInfo.cust.identityPic);OrderInfo.boCustIdentities.isDefault="Y";OrderInfo.boCustIdentities.state="ADD"};var o=function(){$("#custFormdata").data("bootstrapValidator").validate();if($("#custFormdata").data("bootstrapValidator").isValid()){var w={};w.boCustInfos=[{areaId:OrderInfo.cust.areaId,name:$("#boCustIdentities").attr("partyName"),norTaxPayerId:"0",partyTypeCd:$("#boCustIdentities").attr("partyTypeCd"),addressStr:$("#boCustIdentities").attr("addressStr"),state:"DEL"},{areaId:OrderInfo.cust.areaId,name:modifyCustInfo.custName,norTaxPayerId:"0",partyTypeCd:$("#cmPartyTypeCd").val(),addressStr:modifyCustInfo.addressStr,state:"ADD"}];var x=OrderInfo.cust.identityPic;if(x===undefined){x=""}if(!ec.util.isObj(OrderInfo.cust.idCardNumber)){w.boCustIdentities=[{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD",identidiesPic:encodeURIComponent(x)}]}else{w.boCustIdentities=[{identidiesTypeCd:OrderInfo.cust.identityCd,identityNum:OrderInfo.cust.idCardNumber,isDefault:"Y",state:"DEL",identidiesPic:""},{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD",identidiesPic:encodeURIComponent(x)}]}SoOrder.submitOrder(w)}};var k=function(){var B=OrderInfo.staff.areaId;if(B==null||B==""){B=OrderInfo.staff.areaId}var y=$("#p_cust_areaId_val").val();createCustInfo={cAreaId:B,cAreaName:y,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};diffPlace=$("#DiffPlaceFlag").val();var A={acctNbr:"",identityCd:createCustInfo.cIdentidiesTypeCd,identityNum:createCustInfo.cCustIdCard,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:createCustInfo.cAreaId};var x=contextPath+"/app/cust/checkIdentity";var w=$.callServiceAsJson(x,A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});var z="";if(w.code==0){$.unecOverlay();$.confirm("确认","此证件号码已存在,是否确认新建?",{yes:function(){v()},no:function(){}})}else{$.unecOverlay();v()}};var f=function(){$("#custInfoModifyBtn").off("click").on("click",function(y){$("#custFormdata").data("bootstrapValidator").validate();if($("#custFormdata").data("bootstrapValidator").isValid()){var B={};B={custName:$.trim($("#cmCustName").val()),identidiesTypeCd:$("#div_cm_identidiesType  option:selected").val(),custIdCard:$.trim($("#cmCustIdCard").val()),addressStr:$.trim($("#cmAddressStr").val())};var z={};z.boCustInfos=[{areaId:OrderInfo.cust.areaId,name:$("#boCustIdentities").attr("partyName"),norTaxPayerId:"0",partyTypeCd:$("#boCustIdentities").attr("partyTypeCd"),addressStr:$("#boCustIdentities").attr("addressStr"),state:"DEL"},{areaId:OrderInfo.cust.areaId,name:B.custName,norTaxPayerId:"0",partyTypeCd:$("#cmPartyTypeCd").val(),addressStr:B.addressStr,state:"ADD"}];var A=OrderInfo.cust.identityPic;if(A===undefined){A=""}if(!ec.util.isObj(OrderInfo.cust.idCardNumber)){z.boCustIdentities=[{identidiesTypeCd:B.identidiesTypeCd,identityNum:B.custIdCard,isDefault:"Y",state:"ADD",identidiesPic:encodeURIComponent(A)}]}else{z.boCustIdentities=[{identidiesTypeCd:OrderInfo.cust.identityCd,identityNum:OrderInfo.cust.idCardNumber,isDefault:"Y",state:"DEL",identidiesPic:""},{identidiesTypeCd:B.identidiesTypeCd,identityNum:B.custIdCard,isDefault:"Y",state:"ADD",identidiesPic:encodeURIComponent(A)}]}z.boPartyContactInfo=[];var w={contactId:$("#contactIdOld").val(),statusCd:"100001",contactName:$("#contactNameOld").val(),headFlag:$("#headFlagOld").val(),state:"DEL"};var x={contactAddress:$.trim($("#contactAddress").val()),contactId:"",contactName:$.trim($("#contactName").val()),mobilePhone:$.trim($("#mobilePhone").val()),headFlag:$("#headFlag").val(),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};if(ec.util.isObj(w.contactId)){z.boPartyContactInfo.push(w);z.boPartyContactInfo.push(x)}else{if(ec.util.isObj($.trim($("#contactName").val()))){z.boPartyContactInfo.push(x)}}SoOrder.submitOrder(z)}})};var a=function(x){var w=$(x).val();$("#cm_identidiesTypeCd").empty();p(w);c($("#div_cm_identidiesType").children(":first-child"))};var p=function(w){var y={partyTypeCd:w};var x=contextPath+"/cust/queryCertType";var z=$.callServiceAsJson(x,y,{});if(z.code==-2){$.alertM(z.data)}if(z.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置");return}if(z.code==0){var A=z.data;var C=$("#currentCT").val();var D=false;if(C==CONST.CHANNEL_TYPE_CD.ZQZXDL||C==CONST.CHANNEL_TYPE_CD.GZZXDL||C==CONST.CHANNEL_TYPE_CD.HYKHZXDL||C==CONST.CHANNEL_TYPE_CD.SYKHZXDL||C==CONST.CHANNEL_TYPE_CD.XYKHZXDL||C==CONST.CHANNEL_TYPE_CD.GZZXJL||C==CONST.CHANNEL_TYPE_CD.ZYOUT||C==CONST.CHANNEL_TYPE_CD.ZYINGT||C==CONST.CHANNEL_TYPE_CD.WBT){D=true}if(A!=undefined&&A.length>0){for(var B=0;B<A.length;B++){var E=A[B];if(E.certTypeCd=="1"){$("#cm_identidiesTypeCd").append("<option value='"+E.certTypeCd+"' >"+E.name+"</option>")}else{if(D){$("#cm_identidiesTypeCd").append("<option value='"+E.certTypeCd+"' >"+E.name+"</option>")}}}}}};var c=function(w){var x=$(w).val();if(x==undefined){x=$("#div_cm_identidiesType  option:selected").val()}$("#cmCustName").removeAttr("readonly");$("#cmCustIdCard").removeAttr("readonly");$("#cmAddressStr").removeAttr("readonly");if(x==1){$("#cmCustIdCard").attr("placeHolder","请输入合法身份证号码");$("#div-cmcustidcard").show();$("#div-cmcustidcard-none").hide();$("#cmCustName").attr("readonly","readonly");$("#cmCustIdCard").attr("readonly","readonly");$("#cmAddressStr").attr("readonly","readonly");$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",false,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",true,null)}else{if(x==2){$("#cmCustIdCardOther").attr("placeHolder","请输入合法军官证");
$("#div-cmcustidcard-none").show();$("#div-cmcustidcard").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",true,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",false,null)}else{if(x==3){$("#cmCustIdCardOther").attr("placeHolder","请输入合法护照");$("#div-cmcustidcard-none").show();$("#div-cmcustidcard").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",true,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",false,null)}else{$("#cmCustIdCardOther").attr("placeHolder","请输入合法证件号码");$("#div-cmcustidcard-none").show();$("#div-cmcustidcard").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",true,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",false,null)}}}f()};var g=function(){$("#custFormdata").bootstrapValidator({message:"无效值",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},fields:{cmCustName:{trigger:"blur",validators:{notEmpty:{message:"客户姓名不能为空"}}},cmCustIdCard:{trigger:"blur",validators:{notEmpty:{message:"身份证号码不能为空"},regexp:{regexp:/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/,message:"请输入合法身份证号码"}}},cmCustIdCardOther:{trigger:"blur",validators:{notEmpty:{message:"证件号码不能为空"},regexp:{regexp:/^[0-9a-zA-Z]*$/g,message:"证件号码只能为数字或字母"}}},cmAddressStr:{trigger:"blur",validators:{notEmpty:{message:"证件地址不能为空"}}},mobilePhone:{trigger:"blur",validators:{regexp:{regexp:/(^\d{11}$)/,message:"手机号码只能为11数字"}}},phonenumber:{trigger:"blur",validators:{notEmpty:{message:"手机号码不能为空"}}}}})};var j=function(){a("#cmPartyTypeCd");$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected",true);c($("#cm_identidiesTypeCd option[selected='selected']"));OrderInfo.busitypeflag=12;var w=CONST.BO_ACTION_TYPE.ACTIVERETURN;OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,w,9,CONST.getBoActionTypeName(w),"");SoOrder.initFillPage()};var m=function(){cust.validatorForm();a("#cmPartyTypeCd");$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected",true);c($("#cm_identidiesTypeCd option[selected='selected']"));$("#newCustBtn").off("click").on("click",s);var w=CONST.BO_ACTION_TYPE.CUST_CREATE;OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,w,8,CONST.getBoActionTypeName(w),"");SoOrder.initFillPage()};var q=function(){cust.validatorForm();a("#cmPartyTypeCd");$("#cm_identidiesTypeCd").find("option[value="+$("#zjlx").val()+"]").attr("selected","selected");$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected",true);c($("#cm_identidiesTypeCd option[selected='selected']"));$("#updateCustBtn").off("click").on("click",o);var w=CONST.BO_ACTION_TYPE.CUSTINFOMODIFY;OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,w,4,CONST.getBoActionTypeName(w),"");SoOrder.initFillPage()};var h=function(y,z,x,w){$("#cmCustName").val(y);$("#cm_identidiesTypeCd").val("1");$("#cm_identidiesTypeCd").change();$("#cmCustIdCard").val(z);$("#cmAddressStr").val(x);$("#photos").attr("src","data:image/jpg;base64,"+w)};var u=function(w){$("#photos").attr("src","data:image/jpg;base64,"+w)};var r=function(x,y,w,z){$("#cmCustName").val(x);$("#cm_identidiesTypeCd").val("1");$("#cm_identidiesTypeCd").change();$("#cmCustIdCard").val(y);$("#cmAddressStr").val(w);OrderInfo.cust.identityPic=z};var l=function(){var w={};$.callServiceAsHtml(contextPath+"/app/cust/custQueryAdd",w,{before:function(){$.ecOverlay("加载中请稍等...")},always:function(){$.unecOverlay()},done:function(x){$("#order-content").hide();$("#cust").html(x.data).show()},fail:function(){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var d=function(x,w){var z=1;if(x>0){z=x}var A=$("#p_startDt").val().replace(/-/g,"");var y=$("#p_endDt").val().replace(/-/g,"");if(A>y){$.alert("提示","起始时间不能大于结束时间！");return}else{param={startDt:($("#p_startDt").val()).replace(/-/g,""),endDt:($("#p_endDt").val()).replace(/-/g,""),nowPage:z,pageSize:10};$.callServiceAsHtml(contextPath+"/app/cust/custQueryAddList",param,{before:function(){$.ecOverlay("查询中请稍等...")},always:function(){$.unecOverlay()},done:function(B){if(B&&B.code==-2){return}else{if(z==1){$("#cust_search").hide();$("#cust_list").html(B.data).show();$("#cust_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(w&&$.isFunction(w)){w.apply(this,[])}}if(z>1){$("#all_cust_list").append(B.data);$("#cust_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(w&&$.isFunction(w)){w.apply(this,[])}}}},fail:function(){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})}};var i=function(w){if(w&&w.page&&w.page>=1){d(w.page,w.scroll)}};var t=function(C,I,F,E){var w={acctNbr:"",areaId:I,diffPlace:"local",identidies_type:"",identityCd:"",identityNum:"",olTypeCd:"8",operType:F,partyName:"",prodClass:"12",queryType:"",queryTypeValue:""};if(F==1){w.queryTypeValue=C;w.identidies_type="客户编码";w.queryType="custNumber"}else{w.acctNbr=C;w.identidies_type="接入号码"}$.ecOverlay("<strong>正在查询客户架构信息中,请稍等...</strong>");var y=$.callServiceAsJson(contextPath+"/token/pc/cust/queryCustCompreInfo",w);$.unecOverlay();if(y.code==0){if(y.data==null){$.alert("提示","客户架构信息接口无数据返回。");return false}if(y.data.custInfos==undefined){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return false}else{if(!ec.util.isArray(y.data.custInfos)){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return false}}if(y.data.prodInstInfos==undefined&&F!=1){$.alert("提示","客户下没有可以办理业务的移动用户。");return false}if(y.data.offerMemberInfos==undefined&&F!=1){$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理。");return false}if(E=="OLD"){var x=y.data.custInfos;if(OrderInfo.actionFlag!=1&&x[0].custId!=OrderInfo.cust.custId){$.alert("提示",C+"和主卡的客户不一致！");return false}var H={};var z=y.data.prodInstInfos;$.each(z,function(){if(this.accNbr==C){H=this;if(H.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示",C+"不是在用产品！");return false}if(OrderInfo.actionFlag!=1&&H.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){$.alert("提示",C+"和主卡的付费类型不一致！");return false}if(H.productId=="280000000"){$.alert("提示",C+"是无线宽带，不能纳入！");return false}H.custId=x[0].custId;OrderInfo.oldprodInstInfos.push(H)}});var D=true;for(var B=0;B<y.data.offerMemberInfos.length;B++){var A=y.data.offerMemberInfos[B];if(A.objType==""){$.alert("提示","销售品实例构成 "+A.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(A.objType==CONST.OBJ_TYPE.PROD){if(A.accessNumber==""){$.alert("提示","销售品实例构成 "+A.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(A.objInstId==H.prodInstId){D=false}}if(D){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+H.accNbr+"】，无法继续受理，请业务后台核实");return false}var G={offerMemberInfos:y.data.offerMemberInfos,offerId:H.mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:H.mainProdOfferInstInfos[0].prodOfferId,offerSpecName:H.mainProdOfferInstInfos[0].prodOfferName,accNbr:H.accNbr};OrderInfo.oldoffer.push(G);order.memberChange.viceCartNum=0;$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){order.memberChange.viceCartNum++}})})}else{var x=y.data.custInfos;OrderInfo.cust={addressStr:x[0].addressStr,areaId:x[0].areaId,areaName:x[0].areaName,authFlag:x[0].authType,custFlag:x[0].custFlag,custId:x[0].custId,idCardNumber:x[0].idCardNumber,identityCd:x[0].identityCd,identityName:x[0].identityName,norTaxPayer:"",partyName:x[0].partyName,segmentId:x[0].segmentId,segmentName:x[0].segmentName,vipLevel:x[0].vipLevel,vipLevelName:x[0].vipLevelName};if(F!=1){var H=y.data.prodInstInfos;order.prodModify.choosedProdInfo={accNbr:H[0].accNbr,areaCode:H[0].zoneNumber,areaId:H[0].areaId,corProdInstId:H[0].corProdInstId,custId:H[0].mainProdOfferInstInfos[0].custId,custName:H[0].mainProdOfferInstInfos[0].custName,endDt:H[0].mainProdOfferInstInfos[0].endDt,extProdInstId:H[0].extProductId,feeType:H[0].feeType.feeType,feeTypeName:H[0].feeType.feeTypeName,is3G:H[0].mainProdOfferInstInfos[0].is3G,prodBigClass:H[0].prodBigClass,prodClass:H[0].prodClass,prodInstId:H[0].prodInstId,prodOfferId:H[0].mainProdOfferInstInfos[0].prodOfferId,prodOfferInstId:H[0].mainProdOfferInstInfos[0].prodOfferInstId,prodOfferName:H[0].mainProdOfferInstInfos[0].prodOfferName,prodStateCd:H[0].prodStateCd,prodStateName:H[0].prodStateName,productId:H[0].productId,productName:H[0].productName,startDt:H[0].mainProdOfferInstInfos[0].startDt,stopRecordCd:H[0].prodStopRecords[0].stopRecordCd,stopRecordName:H[0].prodStopRecords[0].stopRecordName};
var D=true;for(var B=0;B<y.data.offerMemberInfos.length;B++){var A=y.data.offerMemberInfos[B];if(A.objType==""){$.alert("提示","销售品实例构成 "+A.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(A.objType==CONST.OBJ_TYPE.PROD){if(A.accessNumber==""){$.alert("提示","销售品实例构成 "+A.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(A.objInstId==order.prodModify.choosedProdInfo.prodInstId){D=false}}if(D){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+order.prodModify.choosedProdInfo.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=y.data.offerMemberInfos;OrderInfo.offer.offerId=order.prodModify.choosedProdInfo.prodOfferInstId;OrderInfo.offer.offerSpecId=order.prodModify.choosedProdInfo.prodOfferId;OrderInfo.offer.offerSpecName=order.prodModify.choosedProdInfo.prodOfferName}}}else{$.alertM(y.data);return false}return true};return{scroll:i,custQueryAddList:d,custQueryAdd:l,getIdentidiesTypeCd:j,identidiesTypeCdChoose:c,validatorForm:g,initNewCust:m,initUpdateCust:q,clearCustForm:e,getCustInfo:b,getGenerationInfos:r,getIDCardInfos:h,getPicture:u,queryCustCompreInfo:t}})();CommonUtils.regNamespace("cart","main");cart.main=(function(){var d=function(l,k){OrderInfo.actionFlag=40;var o=1;if(l>0){o=l}var m=$("#p_qryNumber").val();var p={};if($("#if_p_olNbr").is(":checked")){$("#cartFormdata").data("bootstrapValidator").enableFieldValidators("p_olNbr",true,null);$("#cartFormdata").data("bootstrapValidator").enableFieldValidators("p_qryNumber",false,null);$("#cartFormdata").data("bootstrapValidator").enableFieldValidators("p_channelId",false,null);$("#cartFormdata").data("bootstrapValidator").validate();if(!$("#cartFormdata").data("bootstrapValidator").isValid()){return}p={areaId:$("#p_areaId").val(),olNbr:$("#p_olNbr").val(),qryBusiOrder:$("#p_qryBusiOrder").val(),startDt:"",endDt:"",qryNumber:"",channelId:"",olStatusCd:"",busiStatusCd:"",nowPage:o,pageSize:10}}else{p={startDt:($("#p_startDt").val()).replace(/-/g,""),endDt:($("#p_startDt").val()).replace(/-/g,""),qryNumber:m,olStatusCd:$("#p_olStatusCd").val(),busiStatusCd:$("#p_busiStatusCd").val(),olNbr:"",qryBusiOrder:$("#p_qryBusiOrder").val(),channelId:$("#p_channelId").val(),areaId:$("#p_channelId").attr("areaid"),nowPage:o,pageSize:10}}$.callServiceAsHtmlGet(contextPath+"/app/report/cartList",p,{before:function(){$.ecOverlay("购物车查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(q){if(q&&q.code==-2){return}else{$("#cart_search").hide();$("#cart_list").html(q.data).show();OrderInfo.order.step=2;$("#cart_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(k&&$.isFunction(k)){k.apply(this,[])}}},fail:function(q){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var b=function(){if($("#p_channelId").val()!=""){$("#p_areaId_val").attr("disabled",true)}else{$("#p_areaId_val").attr("disabled",false)}};var c=function(k){if(k&&k.page&&k.page>=1){d(k.page,k.scroll)}};var a=function(){if($("#if_p_olNbr").is(":checked")){$("#p_areaId_val").attr("disabled",false);$("#p_olNbr").attr("disabled",false);$(".form_date").datetimepicker("remove");$("#p_qryNumber").attr("disabled",true);$("#p_olStatusCd").attr("disabled",true);$("#p_busiStatusCd").attr("disabled",true);$("#p_channelId").attr("disabled",true)}else{$("#p_olNbr").attr("disabled",true);$(".form_date").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0});$("#p_qryNumber").attr("disabled",false);$("#p_olStatusCd").attr("disabled",false);$("#p_busiStatusCd").attr("disabled",false);$("#p_channelId").attr("disabled",false);if($("#p_channelId").val()!=""){$("#p_areaId_val").attr("disabled",true)}else{$("#p_areaId_val").attr("disabled",false)}}$("select").addClass("styled-select")};var h=function(){$("#cartFormdata").bootstrapValidator({message:"无效值",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},fields:{p_qryNumber:{trigger:"blur",validators:{notEmpty:{message:"接入号和渠道不能同时为空"}}},p_olNbr:{trigger:"blur",validators:{notEmpty:{message:"购物车流水不能为空"}}},p_channelId:{trigger:"blur",validators:{notEmpty:{message:"接入号和渠道不能同时为空"}}}}})};var i=function(k){var l={olId:k};l.areaId=$("#p_areaId").val();$.callServiceAsHtmlGet(contextPath+"/app/report/cartInfo",l,{before:function(){$.ecOverlay("详情查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(m){if(m&&m.code==-2){return}else{$("#cart_list").hide();$("#cart_info").html(m.data).show();OrderInfo.order.step=3}},fail:function(m){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var f=function(k){var l={olId:$(k).attr("olid"),boId:$(k).attr("boid"),offerId:$(k).attr("offerid"),prodId:$(k).attr("prodid")};$.callServiceAsHtmlGet(contextPath+"/app/report/cartOfferInfo",l,{before:function(){$.ecOverlay("详情查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(m){if(m&&m.code==-2){return}else{$("#cart_info").hide();$("#cart_item_detail").html(m.data).show();OrderInfo.order.step=4}},fail:function(m){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var e=function(){OrderInfo.actionFlag=40;OrderInfo.order.step=1;var k={attrSpecCode:"EVT-0002"};$.callServiceAsJson(contextPath+"/app/staffMgr/getCTGMainData",k,{done:function(m){if(m.code==0){var p=m.data;if(p!=undefined&&p.length>0){for(var o=0;o<p.length;o++){var l=p[o];$("#p_busiStatusCd").append("<option value='"+l.attrValueCode+"' >"+l.attrValueName+"</option>");$("#p_olStatusCd").append("<option value='"+l.attrValueCode+"' >"+l.attrValueName+"</option>")}$("#p_busiStatusCd").addClass("styled-select");$("#p_olStatusCd").addClass("styled-select")}}else{if(m.code==-2){$.alertM(m.data);return}else{$.alert("提示","调用主数据接口失败！");return}}}})};var j=function(k){$("#p_start_input").val(k);$("#p_startDt").val(k)};var g=function(){if(OrderInfo.order.step==1){common.callCloseWebview()}else{if(OrderInfo.order.step==2){$("#cart_search").show();$("#cart_list").hide();OrderInfo.order.step=1}else{if(OrderInfo.order.step==3){$("#cart_list").show();$("#cart_info").hide();OrderInfo.order.step=2}else{if(OrderInfo.order.step==4){$("#cart_info").show();$("#cart_item_detail").hide();OrderInfo.order.step=3}else{common.callCloseWebview()}}}}};return{cartBack:g,channelChange:b,queryCartList:d,queryCartInfo:i,initDic:e,olNbrChange:a,scroll:c,setCalendar:j,showOffer:f,validatorForm:h}})();CommonUtils.regNamespace("rule","rule");rule.rule=(function(){var checkFlag=false;var checkObj={};var _callBackStr="";var _callBackParam={};var _init=function(){$("#ruleBody").html("");$("#ruleclose").click(function(){_closeRuleDiv()});$("#credit").click(function(){_credit()});$("#closedialog").click(function(){_cancel()})};var _prepare=function(param,callBackStr,callBackParam){_init();_callBackStr=callBackStr;_callBackParam=callBackParam;if(!query.offer.loadInst()){return}var inParam={prodInfo:order.prodModify.choosedProdInfo,areaId:param.areaId,staffId:param.staffId,channelId:param.channelId,custId:param.custId,boInfos:param.boInfos,soNbr:OrderInfo.order.soNbr};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var response=$.callServiceAsJson(contextPath+"/rule/prepare",inParam);$.unecOverlay();var checkData=response.data;if(response.code==0){if(checkData==null){$.alert("提示","规则校验异常，请联系管理人员！");return}}else{$.alertM(response.data);return}if(checkData.ruleType=="portal"){if(checkData.resultCode=="0"){$.alert("提示",checkData.resultMsg);return true}}if(checkData.result&&checkData.result.resultInfo){var checkRuleInfo=checkData.result.resultInfo;if(checkRuleInfo!=null&&checkRuleInfo.length>0){$.each(checkRuleInfo,function(i,ruleInfo){$("<tr><td>"+ruleInfo.resultCode+"</td><td>"+ruleInfo.ruleDesc+"</td><td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});easyDialog.open({container:"ruleDiv"})}else{_credit();SoOrder.initFillPage()}}else{_credit();SoOrder.initFillPage()
}if(checkData.resultCode!=0){$("#ruleSubmit").hide()}else{checkObj=param;checkFlag=true}};var _getRuleImgClass=function(ruleLevel){if(ruleLevel<4){return"correct"}else{return"error"}};var _getRuleLevelName=function(ruleLevel){if(ruleLevel==0){return"提示级"}else{if(ruleLevel==1){return"中级"}else{if(ruleLevel==2){return"高级"}else{if(ruleLevel==3){return"特技"}else{if(ruleLevel==4){return"限制级"}}}}}};var _prepareCallBack=function(response){var content$=$("#ruleDiv");content$.html(response.data).show()};var _submit=function(){if(!checkFlag){return}$.callServiceAsHtml(contextPath+checkObj.uri,checkObj.param,checkObj.callObj);easyDialog.close()};var _closeRuleDiv=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _cancel=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _showRuleDiv=function(ruleInfo){};var _credit=function(){eval(_callBackStr+"("+JSON.stringify(_callBackParam)+")")};var _ruleCheck=function(boInfos){if(!query.offer.loadInst()){return false}if(boInfos==undefined){return true}var inParam={areaId:OrderInfo.staff.soAreaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,boInfos:boInfos,prodInfo:order.prodModify.choosedProdInfo};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var response=$.callServiceAsJson(contextPath+"/rule/prepare",inParam);$.unecOverlay();if(response!=undefined&&response.code==0){var checkData=response.data;if(checkData.result.resultInfo!=undefined&&checkData.result.resultInfo.length>0){var ruleDesc="";$.each(checkData.result.resultInfo,function(){ruleDesc+=this.ruleDesc+"<br/>"});$.alert("提示",ruleDesc);return false}if(checkData==null){$.alert("提示","规则校验异常，请联系管理人员！");return false}if(checkData.ruleType=="portal"){if(checkData.resultCode=="0"){$.alert("提示",checkData.resultMsg);return false}}var checkRuleInfo=checkData.result.resultInfo;if(checkRuleInfo!=undefined&&checkRuleInfo.length>0){$.each(checkRuleInfo,function(i,ruleInfo){$("<tr><td>"+ruleInfo.resultCode+"</td><td>"+ruleInfo.ruleDesc+"</td><td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});easyDialog.open({container:"ruleDiv"});return false}else{return true}}else{$.alertM(response.data);return}};return{submit:_submit,prepare:_prepare,showRuleDiv:_showRuleDiv,ruleCheck:_ruleCheck}})();$(function(){});CommonUtils.regNamespace("order","phoneNumber");var phoneNum_level="";var selectedObj=null;var _queryFlag="0";order.phoneNumber=(function(){var d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",areaCode:"",memberRoleCd:"",preStore:"",minCharge:""};var B=function(){d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",areaCode:"",memberRoleCd:"",preStore:"",minCharge:""}};var h=0;var D="";var u=[];var g=contextPath+"/app/mktRes/phonenumber/list";var c="";var s=function(J,H){var I=$.trim($("#idCode").val());if(I!=""){b();return}selectedObj=null;J=j(J);J.isReserveFlag=_queryFlag;if(_queryFlag=="1"){J.queryFlag="3"}if($("#pakeage").length>0){$("#pakeage").hide()}$.callServiceAsHtml(g,J,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay();$("#numberModal").modal("hide")},done:function(K){$("#numberModal").modal("hide");if(K.data.indexOf("showVerificationcode")>=0){$("#vali_code_input").val("");$("#validatecodeImg").css({width:"80px",height:"32px"}).attr("src",contextPath+"/validatecode/codeimg.jpg?"+Math.floor(Math.random()*100)).fadeIn();easyDialog.open({container:"Verificationcode_div"})}if(!K||K.code!=0){K.data="查询失败,稍后重试"}var L=$("#phonenumber-list");if($("#subPage").val()=="offer"||$("#subPage").val()=="terminal"){L=$("#number-list")}L.html(K.data);$("#phonenumber-list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(H&&$.isFunction(H)){H.apply(this,[])}$("#btnSwitchNbr").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber({})})},fail:function(K){$.unecOverlay();$("#numberModal").modal("hide");$.alert("提示","请求可能发生异常，请稍后再试！")}})};var q=function(K){var I=contextPath+"/app/mktRes/phone/numberlist";var J={areaId:OrderInfo.getAreaId(),phoneNumber:K.phoneNum};var H=$.callServiceAsJson(I,J);if(H&&H.code==0){if(H.data){return H.data}}else{if(H.code==-2){$.alertM(H.data)}else{$.alert("提示","查询号码信息失败,稍后重试")}}};var b=function(){var I=$.trim($("#idCode").val());if(!a(I)){$.alert("提示","身份证号码输入有误!");return}var K=$("#p_cust_areaId").val();var H=$("#subPage").val();var J={identityId:I,areaId:K,subPage:H};$.callServiceAsHtmlGet(contextPath+"/app/mktRes/phonenumber/listByIdentity",J,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay();$("#numberModal").modal("hide")},done:function(L){$("#numberModal").modal("hide");if(!L||L.code!=0){L.data="查询失败,稍后重试"}var M=$("#phonenumber-list");if($("#subPage").val()=="offer"||$("#subPage").val()=="terminal"){M=$("#number-list")}M.html(L.data)},fail:function(L){$.unecOverlay();$("#numberModal").modal("hide");$.alert("提示","请求可能发生异常，请稍后再试！")}})};var f=function(V){c=$(V).attr("numberVal");var W=CONST.MEMBER_ROLE_CD.MAIN_CARD;var R=$("#subFlag").val();if(R=="Y2"){W=CONST.MEMBER_ROLE_CD.VICE_CARD}var O=$("#subnum").val();var ac=$("#subPage").val();var J=c.split("_")[1];var N=c.split("_")[2];if(order.service.offerprice!=""){var ae=parseInt(N);var T=parseInt(order.service.offerprice);if(T<ae){$.unecOverlay();$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var Q=c.split("_")[0];var ad=c.split("_")[3];var aa=D;if(D==""){aa=c.split("_")[5]}var af=c.split("_")[5];var X=c.split("_")[6];var Y=$("#p_cust_areaId").val();if(Y==null||Y==""){Y=OrderInfo.staff.areaId}var H=$(V).attr("zoneNumber");if(H==null||H==""){H=OrderInfo.staff.areaCode}if(Q){var K=false;var I="";var U="";if(ac=="terminal"||ac=="number"){I=d.accessNumber;U=d.anTypeCd}else{if(ac=="offer"){for(var Z=0;Z<OrderInfo.boProdAns.length;Z++){if(OrderInfo.boProdAns[Z].prodId==O){I=OrderInfo.boProdAns[Z].accessNumber;U=OrderInfo.boProdAns[Z].anTypeCd;break}}for(var Z=0;Z<OrderInfo.boProdAns.length;Z++){if(OrderInfo.boProdAns[Z].prodId!=O){if(OrderInfo.boProdAns[Z].accessNumber==Q){$.unecOverlay();$.alert("提示","你已经选择了该号码,请选择其它号码!");return}}}}}if(I!=""){K=true;for(var Z=0;Z<u.length;Z++){if(u[Z]==I){K=false;break}}if(K){var M=contextPath+"/app/mktRes/phonenumber/purchase";var ab={oldPhoneNumber:I,oldAnTypeCd:U};$.callServiceAsJson(M,ab,{})}}$.unecOverlay();u.push(Q);if(ac=="number"){var S=$("#order_fill_content");S.html("");d.accessNumber=Q;d.anTypeCd=ad;d.level=aa;d.org_level=af;d.anId=X;d.areaId=Y;d.areaCode=H;d.memberRoleCd=W;d.idFlag=0;d.preStore=J;d.minCharge=N;order.service.boProdAn=d;OrderInfo.returnFlag=2;OrderInfo.order.step=2;$("#tentrance").show();$("#pentrance").hide();$("#nentrance").hide();$("#pakeage").show();$("#pakeage").attr("class","tab-pane fade in active");$("#tentrance").css("width","100%");$("#phone").hide();$("#number").hide()}else{if(ac=="terminal"){mktRes.terminal.setNumber(Q,aa);d.accessNumber=Q;d.anTypeCd=ad;d.level=aa;d.org_level=af;d.anId=X;d.areaId=Y;d.areaCode=H;d.memberRoleCd=W;d.idFlag=0;d.preStore=J;d.minCharge=N;order.service.boProdAn=d;$("#order").show();$("#phonenumberContent").hide()}else{if(ac=="offer"){d.anTypeCd=ad;d.anId=X;d.accessNumber=Q;d.level=aa;d.org_level=af;d.areaId=Y;d.areaCode=H;d.preStore=J;d.minCharge=N;$("#nbr_btn_"+O).val(Q);$("#choosedNumSpan").val(Q);var L=false;if(OrderInfo.boProdAns.length>0){for(var Z=0;Z<OrderInfo.boProdAns.length;Z++){if(OrderInfo.boProdAns[Z].prodId==O){OrderInfo.boProdAns[Z].accessNumber=Q;OrderInfo.boProdAns[Z].anTypeCd=ad;OrderInfo.boProdAns[Z].pnLevelId=aa;OrderInfo.boProdAns[Z].anId=X;OrderInfo.boProdAns[Z].areaId=Y;OrderInfo.boProdAns[Z].areaCode=H;OrderInfo.boProdAns[Z].memberRoleCd=W;OrderInfo.boProdAns[Z].idFlag=0;OrderInfo.boProdAns[Z].preStore=J;OrderInfo.boProdAns[Z].minCharge=N;L=true;OrderInfo.setProdAn(OrderInfo.boProdAns[Z]);
order.dealer.changeAccNbr(O,Q);break}}}if(!L){var P={prodId:O,accessNumber:Q,anChooseTypeCd:"2",anId:X,anTypeCd:ad,pnLevelId:aa,state:"ADD",areaId:Y,areaCode:H,memberRoleCd:W,idFlag:0,preStore:J,minCharge:N};OrderInfo.boProdAns.push(P)}if(O=="-1"){OrderInfo.boCustInfos.telNumber=Q}$("#order_content").show();$("#phonenumberContent").hide()}}}}else{$.alert("提示","号码格式不正确!")}};var t=function(H){if(d.accessNumber!=""){$("#nbr_btn_"+H).removeClass("selectBoxTwo");$("#nbr_btn_"+H).addClass("selectBoxTwoOn");$("#nbr_btn_"+H).val(d.accessNumber);order.dealer.changeAccNbr(H,d.accessNumber);var I=false;if(OrderInfo.boProdAns.length>0){for(var J=0;J<OrderInfo.boProdAns.length;J++){if(OrderInfo.boProdAns[J].prodId==H){OrderInfo.boProdAns[J].accessNumber=d.accessNumber;OrderInfo.boProdAns[J].anTypeCd=d.anTypeCd;OrderInfo.boProdAns[J].anId=d.anId;OrderInfo.boProdAns[J].pnLevelId=d.level;OrderInfo.boProdAns[J].areaId=d.areaId;OrderInfo.boProdAns[J].memberRoleCd=d.memberRoleCd;OrderInfo.boProdAns[J].preStore=d.preStore;OrderInfo.boProdAns[J].minCharge=d.minCharge;if(d.idFlag){OrderInfo.boProdAns[J].idFlag=d.idFlag}OrderInfo.setProdAn(OrderInfo.boProdAns[J]);order.dealer.changeAccNbr(H,phoneNumber);I=true;break}}}if(!I){var K={prodId:H,accessNumber:d.accessNumber,anChooseTypeCd:"2",anId:d.anId,pnLevelId:d.level,anTypeCd:d.anTypeCd,state:"ADD",areaId:d.areaId,areaCode:d.areaCode,memberRoleCd:d.memberRoleCd,preStore:d.preStore,minCharge:d.minCharge};if(d.idFlag){K.idFlag=d.idFlag}OrderInfo.boProdAns.push(K)}if(H=="-1"){OrderInfo.boCustInfos.telNumber=d.accessNumber}}};var y=function(S,X){c=$(S).attr("numberVal");var T=CONST.MEMBER_ROLE_CD.MAIN_CARD;var P=$("#subFlag").val();if(P=="Y2"){T=CONST.MEMBER_ROLE_CD.VICE_CARD}var N=$("#subnum").val();var Z=$("#subPage").val();var K=c.split("_")[1];var M=c.split("_")[2];var U=$("#p_cust_areaId").val();if(U==null||U==""){U=OrderInfo.staff.areaId}var H=$(S).attr("zoneNumber");if(H==null||H==""){H=OrderInfo.staff.areaCode}if(order.service.offerprice!=""){var ac=parseInt(M);var Q=parseInt(order.service.offerprice);if(Q<ac){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var O=c.split("_")[0];var ab=c.split("_")[3];var W=c.split("_")[5];if(O){var Y=$("#p_cust_areaId").val();var aa={};if(X){aa={phoneNumber:O,actionType:"E",anTypeCd:ab,areaId:Y,attrList:[{attrId:"65010036",attrValue:X}]}}else{aa={phoneNumber:O,actionType:"E",anTypeCd:ab,areaId:Y}}var J=false;var I="";var R="";if(Z=="terminal"||Z=="number"){I=d.accessNumber;R=d.anTypeCd;if(I==O){$.alert("提示","号码已经被预占,请选择其它号码!");return}else{d={}}}else{if(Z=="offer"){for(var V=0;V<OrderInfo.boProdAns.length;V++){if(OrderInfo.boProdAns[V].prodId==N){I=OrderInfo.boProdAns[V].accessNumber;R=OrderInfo.boProdAns[V].anTypeCd;break}}for(var V=0;V<OrderInfo.boProdAns.length;V++){if(OrderInfo.boProdAns[V].accessNumber==O){$.alert("提示","号码已经被预占,请选择其它号码!");return}}}}if(I&&I!=""){J=true;for(var V=0;V<u.length;V++){if(u[V]==I){J=false;break}}if(J){if(X){aa={newPhoneNumber:O,oldPhoneNumber:I,newAnTypeCd:ab,oldAnTypeCd:R,areaId:Y,attrList:[{attrId:"65010036",attrValue:X}]}}else{aa={newPhoneNumber:O,oldPhoneNumber:I,newAnTypeCd:ab,oldAnTypeCd:R,areaId:Y}}}}var L=contextPath+"/app/mktRes/phonenumber/purchase";$.callServiceAsJson(L,aa,{before:function(){$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>")},done:function(ad){$.unecOverlay();if(ad.code==0){if(D==""){D=ad.data.phoneLevelId}if(Z=="number"){var ag=$("#order_fill_content");ag.html("");d.accessNumber=O;d.anTypeCd=ab;d.level=D;d.org_level=ad.data.phoneLevelId;d.anId=ad.data.phoneNumId;d.areaId=U;d.areaCode=H;d.memberRoleCd=T;d.preStore=K;d.minCharge=M;order.service.boProdAn=d;OrderInfo.returnFlag=2;OrderInfo.order.step=2;$("#tentrance").show();$("#pentrance").hide();$("#nentrance").hide();$("#pakeage").show();$("#pakeage").attr("class","tab-pane fade in active");$("#tentrance").css("width","100%");$("#phone").hide();$("#number").hide()}else{if(Z=="terminal"){mktRes.terminal.setNumber(O,ad.data.phoneLevelId);d.accessNumber=O;d.anTypeCd=ab;d.level=D;d.org_level=ad.data.phoneLevelId;d.anId=ad.data.phoneNumId;d.areaId=U;d.areaCode=H;d.memberRoleCd=T;d.preStore=K;d.minCharge=M;order.service.boProdAn=d;$("#order").show();$("#phonenumberContent").hide()}else{if(Z=="offer"){$("#nbr_btn_"+N).val(O);$("#choosedNumSpan").val(O);d.accessNumber=O;d.level=D;d.org_level=ad.data.phoneLevelId;d.areaId=U;d.anTypeCd=ab;d.anId=ad.data.phoneNumId;d.preStore=K;d.minCharge=M;var ae=false;if(OrderInfo.boProdAns.length>0){for(var af=0;af<OrderInfo.boProdAns.length;af++){if(OrderInfo.boProdAns[af].prodId==N){OrderInfo.boProdAns[af].accessNumber=O;OrderInfo.boProdAns[af].anTypeCd=ab;OrderInfo.boProdAns[af].pnLevelId=D;OrderInfo.boProdAns[af].anId=ad.data.phoneNumId;OrderInfo.boProdAns[af].areaId=U;OrderInfo.boProdAns[af].areaCode=H;OrderInfo.boProdAns[af].memberRoleCd=T;OrderInfo.boProdAns[af].preStore=K;OrderInfo.boProdAns[af].minCharge=M;ae=true;if(OrderInfo.offerSpec.offerRoles!=undefined){OrderInfo.setProdAn(OrderInfo.boProdAns[af])}order.dealer.changeAccNbr(N,O);break}}}if(!ae){var ai={prodId:N,accessNumber:O,anChooseTypeCd:"2",anId:ad.data.phoneNumId,pnLevelId:D,anTypeCd:ab,state:"ADD",areaId:U,areaCode:H,memberRoleCd:T,preStore:K,minCharge:M};OrderInfo.boProdAns.push(ai);if(OrderInfo.offerSpec.offerRoles!=undefined){OrderInfo.setProdAn(ai)}order.dealer.changeAccNbr(N,O)}if(N=="-1"){OrderInfo.boCustInfos.telNumber=O}$("#order").show();$("#phonenumberContent").hide()}}}}else{if(ad.code==-2){$.alertM(ad.data)}else{var ah="";if(ad.data!=undefined&&ad.data.msg!=undefined){ah=ad.data.msg}else{ah="号码["+O+"]预占失败"}$.alert("提示","号码预占失败，可能原因:"+ah)}}},fail:function(ad){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})}else{$.alert("提示","号码格式不正确!")}};var z=function(I,H){e(I,H);s()};var j=function(J){var K=$('input[name="query_flag_01"]').parent().attr("class");if(K=="toggle btn btn-default off"){K="1"}else{K="2"}var P="";if(OrderInfo.cust==undefined||OrderInfo.cust.custId==undefined||OrderInfo.cust.custId==""){P=$("#p_cust_areaId").val()}else{P=OrderInfo.getAreaId()}var Q=$("#pnHead").val();var I=$("#pncharacteristic").find("a.selected").attr("val");var R=$.trim($("#pnEnd").val());if(I!=null&&I!=""){R=I}else{if(R=="最后四位"){R=""}}var S="";var L="";var M=$("#Greater").val();var H=$("#Less").val();var N=$("#nbrPool option:selected").val();var O=$("#subPage").val();L=$("#pnCharacterId_basic option:selected").val();L=ec.util.defaultStr(L);return{pnHead:Q,pnEnd:R,goodNumFlag:L,maxPrePrice:H,minPrePrice:M,pnLevelId:"",pageSize:"10",phoneNum:S,areaId:P,poolId:N,subPage:O,queryFlag:K}};var e=function(I,H){$(I).each(function(){$(this).removeClass("selected")});$(H).addClass("selected")};var G=function(H){var I={pageIndex:H};order.phoneNumber.btnQueryPhoneNumber(I)};var a=function(L){L=L.toUpperCase();if(!(/(^\d{15}$)|(^\d{17}([0-9]|X)$)/.test(L))){return false}var M,R;M=L.length;if(M==15){R=new RegExp(/^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/);var Q=L.match(R);var J=new Date("19"+Q[2]+"/"+Q[3]+"/"+Q[4]);var I;I=(J.getYear()==Number(Q[2]))&&((J.getMonth()+1)==Number(Q[3]))&&(J.getDate()==Number(Q[4]));if(!I){return false}else{var O=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var P=new Array("1","0","X","9","8","7","6","5","4","3","2");var N=0,K;L=L.substr(0,6)+"19"+L.substr(6,L.length-6);for(K=0;K<17;K++){N+=L.substr(K,1)*O[K]}L+=P[N%11];return L}}if(M==18){R=new RegExp(/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/);var Q=L.match(R);var J=new Date(Q[2]+"/"+Q[3]+"/"+Q[4]);var I;I=(J.getFullYear()==Number(Q[2]))&&((J.getMonth()+1)==Number(Q[3]))&&(J.getDate()==Number(Q[4]));if(!I){return false}else{var H;var O=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var P=new Array("1","0","X","9","8","7","6","5","4","3","2");var N=0,K;for(K=0;K<17;K++){N+=L.substr(K,1)*O[K]}H=P[N%11];if(H!=L.substr(17,1)){return false}return L}}return false};var w=function(){order.area.chooseAreaTree("order/prepare","p_phone_areaId_val","p_phone_areaId",3)};var l=function(I,H){var J=contextPath+"/app/mktRes/phonenumber/prepare";
var K={};$.callServiceAsHtmlGet(J,K,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(L){if(!L){L.data="选号页面加载异常,稍后重试"}if(L.code!=0){$.alert("提示","查询失败,稍后重试");return}$("#order").hide();$("#order_prepare").hide();var M=$("#phonenumberContent");M.html(L.data).show();$("#subnum").val(I);$("#subPage").val(H);d={accessNumber:"",level:"",anId:"",anTypeCd:""};k(H)}})};var k=function(I,H){$("#phone").hide();$("#subPage").val(I);if(CONST.getAppDesc()==1){$("#psw_dt").hide();$("#psw_dd").hide()}selectedObj=null;h=0;D="";order.phoneNumber.queryApConfig();A();var J={};order.phoneNumber.btnQueryPhoneNumber(J,H);$("#btnNumSearch1").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber(J,H)})};var x=function(){var I={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var H=contextPath+"/app/order/queryApConf";$.callServiceAsJsonGet(H,I,{done:E})};var E=function(N){var Q;var K;if(N.data){var L=N.data.length;$("#pnHeadDiv").empty();for(var O=0;O<L;O++){if(N.data[O].PHONE_NUMBER_SEGMENT){Q=N.data[O].PHONE_NUMBER_SEGMENT;var S=$('<select id="pnHead" class="selectpicker show-tick form-control"></select>');var I=$('<option value="" selected="selected">请选择号段</option>');S.append(I);for(var M=0;M<Q.length;M++){var P=Q[M].COLUMN_VALUE_NAME;P=P.replace(/\"/g,"");var H=$('<option value="'+P+'">'+P+"</option>");S.append(H)}$("#pnHeadDiv").append(S);S.addClass("styled-select");continue}}$("#pnCharacterId_basicDiv").empty();for(var O=0;O<L;O++){if(N.data[O].PHONE_NUMBER_FEATURE){K=N.data[O].PHONE_NUMBER_FEATURE;var J;if(K.length<=9){J=K.length}else{J=9}var S=$('<select id="pnCharacterId_basic" class="selectpicker show-tick form-control"></select>');var I=$('<option value="" selected="selected">请选择类型</option>');S.append(I);for(var M=0;M<J;M++){var T=(K[M].COLUMN_VALUE_NAME).replace(/\"/g,"");var R=(K[M].COLUMN_VALUE).replace(/\"/g,"");var H=$('<option value="'+R+'">'+T+"</option>");S.append(H)}$("#pnCharacterId_basicDiv").append(S);S.addClass("styled-select");continue}}$("#pnHeadDiv").append('<span class="input-group-addon select-span"></span>');$("#pnCharacterId_basicDiv").append('<span class="input-group-addon select-span"></span>')}};var A=function(){if($("#subPage").val()=="number"){$("#nbrPoolDiv").empty()}else{$("#nbrPoolDiv2").empty()}var L=contextPath+"/app/mktRes/phonenumber/queryPhoneNbrPool";var O={};var J=$.callServiceAsJson(L,O);if(J.code==0){if(J.data){var K=J.data.phoneNbrPoolList;var I=$('<div class="input-group select-top"></div>');var H=$('<span class="input-group-addon select-span"></span>');var N=$('<select id="nbrPool" class="selectpicker show-tick form-control"></select>');var M=$('<option value="" selected="selected">请选择号池</option>');N.append(M);if(K!=null){$.each(K,function(){var P=$('<option value="'+this.poolId+'">'+this.poolName+"</option>");N.append(P)})}I.append(N).append(H);if($("#subPage").val()=="number"){$("#nbrPoolDiv").append(I)}else{$("#nbrPoolDiv2").append(I)}N.addClass("styled-select")}}else{if(J.code==-2){$.alertM(J.data)}else{$.alert("提示","号池加载失败，请稍后再试！")}}};var r=function(L){var I=contextPath+"/app/mktRes/phonenumber/queryPnLevelProdOffer";var K="";if(order.ysl!=undefined||L!=undefined){K=$("#_session_staff_info").attr("areaid")}else{K=$("#p_cust_areaId").val()}K=K.substring(0,3)+"0000";var J={areaId:K};var H=$.callServiceAsJson(I,J)};var o=function(){if(selectedObj==undefined||selectedObj==null){$.alert("提示","请先选择号码！");return}var I=$(selectedObj).attr("numberVal");var L=I.split("_")[5];var J=I.split("_")[0];var K=$("#p_cust_areaId").val();if(K==null||K==""){K=OrderInfo.staff.areaId}var H=contextPath+"/app/mktRes/qryPhoneNbrLevelInfoList";$.ligerDialog.open({width:560,height:350,allowClose:false,title:"设置号码等级（"+J+"）",url:H+"?pnLevelId="+D+"&areaId="+K+"&org_level="+L,buttons:[{text:"确定",onclick:function(N,M){var O=phoneNum_level.split("_");M.close();$(".select_nbr_li").each(function(){if($(this).hasClass("select")){var Q=$(this).attr("numberval").split("_");var P;if(phoneNum_level!=undefined&&phoneNum_level!=""&&Q[5]!=O[0]){P="<span style='float:left;margin-left:10px;'>预存<span class='orange'>"+Q[1]+"</span>元<br/>保底<span class='orange'>"+Q[2]+"</span>元</span><span style='float:right;margin-right:10px;'>预存<span class='orange'>"+O[1]+"</span>元<br/>保底<span class='orange'>"+O[2]+"</span>元</span><span style='width: 15px; display: table; height: 30px; padding-top: 10px;'><img  src='"+contextPath+"/image/common/levelArrow.png'></span>"}else{P="<span style='padding-left:10px;'>预存<span class='orange'>"+Q[1]+"</span>元</span> <span style='padding-left:10px;'> 保底<span class='orange'>"+Q[2]+"</span>元</span>"}$(this).find("div").html(P)}});$(".select_nbr_li").addClass("styled-select");D=O[0]}},{text:"关闭",onclick:function(N,M){M.close()}}]})};var F=function(J,I){$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>");selectedObj=J;h=I;if(h==1){f(selectedObj)}else{var H=$(selectedObj).attr("numberVal").split("_")[7];if(H=="1"){$("#app_password_dialog").modal("show")}else{y(selectedObj)}}};var p=function(J,I){if(selectedObj==J){return}h=I;selectedObj=J;var H=$(selectedObj).attr("numberVal");D=H.split("_")[5];$(J).siblings().each(function(){$(this).removeClass("select");var L=$(this).attr("numberval").split("_");var K="<span style='padding-left:10px;'>预存<span class='orange'>"+L[1]+"</span>元</span> <span style='padding-left:10px;'> 月保底<span class='orange'>"+L[2]+"</span>元</span>";$(this).find("div").html(K)});$(J).addClass("select")};var C=function(){var H=$("#pree_password_text").val();if($.trim(H)==""){$.alert("提示","预占密码不能为空！")}else{$("#app_password_dialog").modal("hide");$("#pree_password_text").val("");y(selectedObj,H)}};var v=function(H){$("#order").show();$("#phonenumberContent").hide()};var m=function(H){if(H&&H.page&&H.page>=1){k($("#subPage").val(),H.scroll)}};var i=function(){if(OrderInfo.order.step==1){var I=OrderInfo.boProdAns;var H=OrderInfo.boProd2Tds;if(H.length>0){for(var K=0;K<H.length;K++){var J={numType:2,numValue:H[K].terminalCode};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",J,{done:function(){}})}}if(I.length>0){for(var K=0;K<I.length;K++){if(I[K].idFlag){continue}var J={numType:1,numValue:I[K].accessNumber};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",J,{done:function(){}})}}order.phoneNumber.resetBoProdAn();common.callCloseWebview()}else{if(OrderInfo.order.step==2){$.confirm("确认","确定要取消该订单吗？",{yes:function(){var N=OrderInfo.boProdAns;var L=OrderInfo.boProd2Tds;var M=order.service.boProdAn;if(L.length>0){for(var P=0;P<L.length;P++){var O={numType:2,numValue:L[P].terminalCode};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",O,{done:function(){}})}}if(N.length>0){for(var P=0;P<N.length;P++){if(N[P].idFlag){continue}var O={numType:1,numValue:N[P].accessNumber};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",O,{done:function(){}})}}else{if(M.accessNumber.length>0){var O={numType:1,numValue:M.accessNumber};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",O,{done:function(){}})}}order.phoneNumber.resetBoProdAn();$("#pakeage").hide();$("#pakeage").attr("class","tab-pane fade in active");$("#tentrance").show();$("#phone").show();$("#number").show();$("#pentrance").show();$("#nentrance").show();$("#tentrance").css("width","");$("#nentrance").attr("class","");$("#div_content").html("");$("#vice_modal").modal("hide");$("#order_prepare").show();OrderInfo.order.step=1},no:function(){}},"question")}else{if(OrderInfo.order.step==3){SoOrder.orderBack();$("#order-content").show();$("#order-confirm").hide();$("#order-dealer").hide();OrderInfo.order.step=2}else{if(OrderInfo.order.step==4){$("#order-confirm").show();$("#order-print").hide();OrderInfo.order.step=3}else{common.callCloseWebview()}}}}};return{qryPhoneNbrLevelInfoList:o,selectNum:p,endSelectNum:F,btnQueryPhoneNumber:s,linkQueryPhoneNumber:z,getIndexPagePhoneNumber:G,queryApConfig:x,initPhonenumber:k,boProdAn:d,resetBoProdAn:B,btnIBydentityQuery:b,initOffer:t,initPage:l,chooseArea:w,preePassword:C,queryPhoneNbrPool:A,queryFlag:_queryFlag,queryPnLevelProdOffer:r,btnBack:v,scroll:m,queryPhoneNumber:q,back:i}
})();CommonUtils.regNamespace("mktRes","terminal");mktRes.terminal=(function(f){var w="";var C=10;var x={};var k={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false};_initBuyChk=function(){k={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false}};var s=function(){if("lj"==k.buyType){OrderInfo.actionFlag=13;f("#treaty").hide();f("#agreementFie").hide();f("#phonenumberFie").hide()}else{if("hy"==k.buyType){OrderInfo.actionFlag=14;f("#phonenumberFie").show()}}};var e=function(F,E){f("#choosedNumSpan").val(F);k.numFlag=true;k.numLevel=E;s();f("#treaty").show()};var p=function(E){if(E&&E.page&&E.page>=1){r(E.page,E.scroll)}};var u=function(E){if(E&&E.page&&E.page>=1){c(E.page,E.scroll)}};var c=function(F,E){OrderInfo.actionFlag=150;var G=1;if(F>0){G=F}var H={};H={startDate:(f("#p_startDt").val()).replace(/-/g,""),channelId:f("#p_channelId").val(),areaId:f("#p_channelId").attr("areaid"),pageIndex:G,pageSize:10};f.callServiceAsHtmlGet(contextPath+"/app/report/terminalSalesList",H,{before:function(){f.ecOverlay("终端销售详情查询中，请稍等...")},always:function(){f.unecOverlay()},done:function(I){if(I&&I.code==-2){return}else{OrderInfo.order.step=2;f("#terminal_sales_search").hide();f("#terminal_sales_list").html(I.data).show();f("#terminal_sales_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(E&&f.isFunction(E)){E.apply(this,[])}}},fail:function(I){f.unecOverlay();f.alert("提示","请求可能发生异常，请稍后再试！")}})};var r=function(G,E){f("#phoneModal").modal("hide");if(f("#pakeage").length>0){f("#pakeage").hide()}var F=contextPath+"/app/mktRes/terminal/list";var H=i(G);f.callServiceAsHtml(F,H,{before:function(){if(G==1){f.ecOverlay("<strong>查询中,请稍等...</strong>")}},always:function(){if(G==1){f.unecOverlay()}},done:function(I){if(I.code!=0){f.alert("提示","<br/>查询失败,稍后重试");return}if(G==1){f("#phone-list").html(I.data);f.refresh(f("#phone-list"))}else{f("#phone-list-all").append(I.data);f.refresh(f("#phone-list-all"))}if(E&&f.isFunction(E)){E.apply(this,[])}}})};var i=function(I){var L=ec.util.defaultStr(f("#select_brand").val());var G=ec.util.defaultStr(f("#select_phone_type").val());var H=ec.util.defaultStr(f("#phonePrice_numd01").val());var J=ec.util.defaultStr(f("#phonePrice_numd02").val());var F=f("#input_phone_name").val();if(H!=""){H=parseInt(H)*100}if(J!=""){J=parseInt(J)*100}var K=[];if(L!=""&&L!="无限"){var E={attrId:CONST.TERMINAL_SPEC_ATTR_ID.BRAND,attrValue:L};K.push(E)}if(G!=""&&G!="无限"){var E={attrId:CONST.TERMINAL_SPEC_ATTR_ID.PHONE_TYPE,attrValue:G};K.push(E)}return{mktResCd:"",mktResName:F,mktResType:"",minPrice:H,maxPrice:J,pageInfo:{pageIndex:I,pageSize:C},attrList:K}};var z=function(){mktRes.terminal.queryApConfig();mktRes.terminal.btnQueryTerminal(1)};var D=function(I){var E=I.data.length;var S;var L;var G;for(var J=0;J<E;J++){if(I.data[J].PHONE_BRAND){var O=f("#select_brand");S=I.data[J].PHONE_BRAND;for(var H=0;H<S.length;H++){var P=(S[H].COLUMN_VALUE_NAME).replace(/\"/g,"");O.append("<option value='"+P+"'>"+P+"</option>")}}if(ec.util.isArray(I.data[J].PHONE_PRICE_AREA)){L=I.data[J].PHONE_PRICE_AREA;var R=(L[0].COLUMN_VALUE_NAME).replace(/\"/g,"");var Q=R.split("-");var K="";var F="";var N="";if(Q.length!=1){K=Q[0]}else{Q=Q.toString();K=Q.substring(0,Q.length-2)}R=(L[L.length-1].COLUMN_VALUE_NAME).replace(/\"/g,"");Q=R.split("-");if(Q.length!=1){F=Q[1];N=F}else{Q=Q.toString();N=Q.substring(0,Q.length-2);F=""}f(".noUiSliderd").noUiSlider({range:[parseInt(K),parseInt(N)],start:[parseInt(K),parseInt(N)],step:10,slide:function(){var U=f(this).val();f("#phonePrice_numd01").val(U[0]);if(parseInt(U[0])>=parseInt(N)&&F==""){f("#phonePrice_numd02").val("")}else{f("#phonePrice_numd02").val(U[1])}}})}if(I.data[J].PHONE_TYPE){var O=f("#select_phone_type");G=I.data[J].PHONE_TYPE;for(var H=0;H<G.length;H++){var T=(G[H].COLUMN_VALUE_NAME).replace(/\"/g,"");O.append("<option value="+T+">"+T+"</option>")}}var M=f("#phoneModal");f.refresh(M)}};var t=function(){var F={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var E=contextPath+"/app/order/queryApConf";f.callServiceAsJsonGet(E,F,{done:D})};var y=function(){OrderInfo.order.step=1;OrderInfo.busitypeflag=1;var F=contextPath+"/app/mktRes/terminal/prepare";var H={};var E=f.callServiceAsHtmlGet(F,H);var G=f("#phone");G.html(E.data);f.refresh(G);z();f("#form_terminal_qry").off("submit").on("submit",function(I){I.preventDefault();mktRes.terminal.btnQueryTerminal(1)})};var b=function(E){_initBuyChk();k.buyType="hy";s();f("#buyTypeBtns .btn-default").removeClass("active");f(E).addClass("active")};var B=function(E){f("#choosedNumSpan").val("");_initBuyChk();k.buyType="lj";s();f("#buyTypeBtns .btn-default").removeClass("active");f(E).addClass("active")};var l=function(F){var G={mktResTypeCd:f(F).attr("mktResTypeCd"),mktResCd:f(F).attr("mktResCd"),mktResId:f(F).attr("mktResId"),brand:f(F).attr("brand"),phoneType:f(F).attr("phoneType"),phoneColor:f(F).attr("phoneColor"),mktName:f(F).attr("mktName"),mktPrice:f(F).attr("mktPrice"),mktPicA:f(F).attr("mktPicA")};if(CONST.getAppDesc()==0){G.mktSpecCode=f(F).attr("mktSpecCode");G.pageInfo={pageIndex:1,pageSize:C};G.attrList=[];G.is4G="yes"}var E=contextPath+"/app/mktRes/terminal/detail";f.callServiceAsHtml(E,G,{before:function(){f.ecOverlay("<strong>查询中,请稍等...</strong>")},always:function(){f.unecOverlay()},done:function(H){if(!H||H.code!=0){f.alert("提示","<br/>处理失败，请稍后重试！");return}common.callTitle(3);OrderInfo.order.step=2;var I=f("#order").html(H.data).show();f.refresh(I);f("#order_prepare").hide();_initBuyChk();f("#cNumA").click(function(){var J=OrderInfo.cust.custId;if(OrderInfo.cust==undefined||J==undefined||J==""){f.alert("提示","在选号码之前请先进行客户定位或者新建客户！");return}s();order.phoneNumber.initPage("-1","terminal")});f("#chkTsnA").off("click").on("click",function(){v("#tsn")});f("#purchaseTermA").off("click").on("click",function(){j()});f("#btn_terminal_back").off("click").on("click",function(){f("#order_prepare").show();f("#order").hide()});OrderInfo.actionFlag=13}})};var o=function(I){var M=f(I).attr("p_pic");var E=f(I).attr("mktResName");var J=f(I).attr("mktSalePrice");var K=f(I).attr("mktNormalSalePrice");var L=f(I).attr("mktResId");var F=f(I).attr("mktResTypeCd");var H=f(I).attr("mktSpecCode");f("#term_pic_id").attr("src",M);f("#mkt_resname_id").html(E);f("#mkt_saleprice_id").html(J+" 元");f("#mktResId").val(L);f("#mktResName").val(E);f("#price").val(K);f("#mktResType").val(F);f("#mktSpecCode").val(H);f("#fls_terminal_color .btn-default").removeClass("active");f("#treaty .btn-default").removeClass("active");f(I).addClass("active");var G=k.buyType;_initBuyChk();k.buyType=G;s();f("#tsn_hid").val("");f("#tsn").val("");f("#choosedNumSpan").val("");f("#choosedOfferPlan").html("");x={}};var q=function(F,G){f("#treaty .btn-default").removeClass("active");if(!k.numFlag){f.alert("提示","请先选号！");return}if(F==1){k.hyType="cfsj"}else{k.hyType="gjsf"}f(G).addClass("active");k.hyFlag=true;s();var H={mktResCd:f("#mktResId").val(),agreementType:F};var E=contextPath+"/app/mktRes/terminal/mktplan";f.callServiceAsHtmlGet(E,H,{before:function(){},always:function(){},done:function(I){if(!I){f.alert("提示","<br/>处理失败，请稍后重试！");return}if(I.code!=0){if(I.code==1006){f.alert("提示","<br/>查询不到，请稍后重试")}else{f.alert("提示","<br/>查询失败，请稍后重试")}return}f("#div_offer").html(I.data).show();f.refresh(f("#div_offer"));f("#terminalMain").hide();var J=f("#select_offerSpecId_0").val();d(J,F);f("#termOfferSpecConfirm").off("click").on("click",function(K){m()})}})};_changeHyContent=function(F,E){var G=f(F).val();d(G,E)};_changePeriod=function(G,F){var E=f(G).val();f("#tab_content .itemMain").hide();f("#tab_content_"+E).show();_changeHyContent(f("#select_offerSpecId_"+E),F)};var d=function(Q,K){f("#select_offerSpecId").val(Q);var H=order.service.queryPackForTerm(Q,K,"");if(typeof(H)=="undefined"||H==null){f.alert("提示","<br/>未查到套餐，请稍后再试！");
return}if(H.code==-2){f.alertM(H.data);f.unecOverlay();return}if(H.code!=0||H.data.code!="POR-0000"){f.alert("提示","<br/>未查到合适套餐，请稍后再试！");return}var P="<table class='table table-striped tablecenter'>";P+="  <thead>";P+="    <tr>";P+="      <th>套餐名称</th>";P+="    </tr>";P+="  </thead>";P+="  <tbody class='panel-group'>";var N=H.data.prodOfferInfos;if(N.length==0){f.alert("提示","<br/>未查到套餐，请稍后再试！")}for(var I=0;I<N.length;I++){var O=N[I];var R="";if(O.inFlux>=1024){R=O.inFlux/1024+"G"}else{R=O.inFlux+"M"}var E=ec.util.defaultStr(O.inVoice);var F=ec.util.defaultStr(O.inWIFI);var M=ec.util.defaultStr(O.inSMS);var J=ec.util.defaultStr(O.inMMS);var G=ec.util.defaultStr(O.outFlux);var L=ec.util.defaultStr(O.outVoice);P+="<tr offerSpecId='"+O.offerSpecId+"'";P+=" offerSpecName='"+O.offerSpecName+"'";P+=" price='"+O.price+"'";P+=" inWIFI='"+F+"'";P+=" inFlux='"+R+"'";P+=" inSMS='"+M+"'";P+=" inMMS='"+J+"'";P+=" outFlux='"+G+"'";P+=" outVoice='"+L+"'";P+=" inVoice='"+E+"'>";P+=" <td>"+ec.util.defaultStr(O.offerSpecName)+"</td>";P+="</tr>"}P+="  </tbody>";P+="  </table>";f("#offerSecond").html(P);f.refresh(f("#offerSecond"));f("#offerSecond tbody tr").off("click").on("click",function(S){g(this);S.stopPropagation()})};var g=function(F){f("#offerSecond tbody tr").removeClass("success");var G=f(F).attr("offerSpecId");var E=A(G,F);if(E){f(F).addClass("success")}};var A=function(G,F){var E={price:f(F).attr("price"),id:"tcnum1",specId:G,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};order.service.opeSer(E);return true};var m=function(){var E=f("#offerSecond tbody tr[class='success']");if(E.length!=1){f.alert("提示","请选择一个套餐！");return}var F=true;f.each(OrderInfo.offerSpec.offerRoles,function(){if(this.prodInsts==undefined||this.prodInsts==null){F=false;return}});if(F){mktRes.terminal.offerSpecId=f("#select_offerSpecId").val();k.hyFlag=true;k.hyOfferSpecId=E.attr("offerSpecId");k.hyOfferSpecName=E.attr("offerSpecName");s();f("#agreementFie").show();f("#choosedOfferPlan").html(E.attr("offerSpecName"));f("#terminalMain").show();f("#div_offer").hide()}else{f.alert("提示","请选择一个接入产品！");return}};var v=function(I){x={};k.tsnFlag=false;s();f("#tsn_hid").val("");var E=f(I).val();if(E==""){return}var G={instCode:E,mktResTypeCd:f("#mktResType").val(),orderNo:""};if(CONST.getAppDesc()==0){var H=f("#mktSpecCode").val();if(f.trim(H)==""){f.alert("提示","营销资源返回的规格存货编码为空！");return}if(H.length>=22){H=H.substring(0,22)}G.mktSpecCode=H}else{G.mktResId=f("#mktResId").val()}var F=contextPath+"/mktRes/terminal/checkTerminal";f.callServiceAsJson(F,G,{done:function(J){if(J&&J.code==-2){f.alertM(J.data)}else{if(J&&J.data&&J.data.code==0){if(J.data.statusCd==CONST.MKTRES_STATUS.USABLE){f.alert("提示","<br/>此终端串号可以使用");k.tsnFlag=true;s();f("#tsn_hid").val(E);x=J.data}else{if(J.data.statusCd==CONST.MKTRES_STATUS.HAVESALE){if(k.hyType=="gjsf"){f.alert("提示","<br/>此终端串号可以使用");k.tsnFlag=true;s();f("#tsn_hid").val(E);x=J.data;x.couponSourc="2"}else{f.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}}else{f.alert("提示",J.data.message)}}}else{if(J&&J.data&&J.data.message&&J.data.code==1){f.alert("提示",J.data.message)}else{f.alert("提示","<br/>校验失败，请稍后重试！")}}}}})};var j=function(){if("lj"==k.buyType){if(!k.tsnFlag){f.alert("提示","<br/>请先校验终端串号。");return}var G=f("#price").val()/100;var I=[{couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:x.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:x.mktResStoreId,storeName:"1",agentId:1,apCharge:G,couponInstanceNumber:x.instCode,ruleId:"",partyId:CONST.CUST_COUPON_SALE,prodId:0,offerId:0,state:"ADD",relaSeq:""}];if((OrderInfo.cust.custId)&&OrderInfo.cust.custId!=""){I[0].partyId=OrderInfo.cust.custId}OrderInfo.actionTypeName="订购";OrderInfo.businessName=f("#mktResName").val();var F={};F.busiObj={instId:x.mktResId};F.boActionType={actionClassCd:CONST.ACTION_CLASS_CD.MKTRES_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.COUPON_SALE};F.coupons=I;f("#terminalMain").hide();SoOrder.getTokenSynchronize();SoOrder.submitOrder(F);return}else{if("hy"==k.buyType){if(!k.tsnFlag){f.alert("提示","<br/>请先校验终端串号。");return}if(!(OrderInfo.cust.custId)||OrderInfo.cust.custId==""){f.alert("提示","<br/>在订购套餐之前请先进行客户定位！");return}if(k.hyType==""){f.alert("提示","<br/>请选择合约!");return}}else{return}}var E={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:x.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:x.mktResStoreId,storeName:"1",agentId:1,apCharge:f("#price").val()/100,couponInstanceNumber:x.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-1,offerId:-1,attachSepcId:mktRes.terminal.offerSpecId,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){E.termTypeFlag=x.termTypeFlag}OrderInfo.attach2Coupons=[];OrderInfo.attach2Coupons.push(E);var H={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:OrderInfo.offerSpec,offerSpecId:k.hyOfferSpecId,offerSpecName:k.hyOfferSpecName,viceCardNum:Number(k.hyOfferSpecQty),feeType:k.hyOfferSpecFt,offerNum:1,type:2,actionFlag:OrderInfo.actionFlag,terminalInfo:{terminalName:f("#mktResName").val(),terminalCode:f("#tsn_hid").val()},offerRoles:k.hyOfferRoles};OrderInfo.actionTypeName="订购";SoOrder.builder();order.main.buildMainView(H)};var h=function(){if(OrderInfo.order.step==1){common.callCloseWebview()}else{if(OrderInfo.order.step==2){f("#terminal_sales_search").show();f("#terminal_sales_list").hide();OrderInfo.order.step=1}else{common.callCloseWebview()}}};var a=function(F,E){f.alert(F,E)};return{btnQueryTerminal:r,initPhone:y,queryApConfig:t,selectTerminal:l,setNumber:e,offerSpecId:w,selectColor:o,scroll:p,hyClick:b,ljClick:B,selectHy:q,changeHyContent:_changeHyContent,changePeriod:_changePeriod,termSaleScroll:u,back:h,btnQueryTerminalSale:c,showNbr:a}})(jQuery);$(function(){OrderInfo.order.step=1});CommonUtils.regNamespace("prod","uim");prod.uim=(function(){var d=function(j){var q=OrderInfo.getAccessNumber(j);var h="-1";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(q==""){$.alert("提示","校验UIM卡前请先选号!");return false}}if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23||OrderInfo.actionFlag==6){if(ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==j){h=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{h=order.prodModify.choosedProdInfo.prodOfferInstId}}var p=$.trim($("#uim_txt_"+j).val());if(p==undefined||p==""){$.alert("提示","UIM卡不能为空!");return false}var k={instCode:p,phoneNum:q,areaId:OrderInfo.getProdAreaId(j)};var l=OrderInfo.getProdSpecId(j);var o="";if(CONST.getAppDesc()==0){if(b(j)){o=c(CONST.PROD_SPEC_ID.MIFI_ID)}else{o=c(l)}if(ec.util.isObj(o)){}else{$.alert("提示","查询卡类型失败！");return}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(prod.changeUim.is4GProdInst){k.onlyLTE="1"}}}var i=query.prod.checkUim(k);if(i==undefined||i.baseInfo==undefined){return false}var m=i.baseInfo.qty;if(m==undefined||m==null){m=1}var g={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:i.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:m,storeId:i.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:i.baseInfo.mktResInstCode,terminalCode:i.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:j,offerId:h,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){g.cardTypeFlag=i.baseInfo.cardTypeFlag}$("#uim_check_btn_"+j).attr("disabled",true);$("#uim_release_btn_"+j).removeAttr("disabled");$("#uim_txt_"+j).attr("disabled",true);if(b(j)){$("#isMIFI_"+j).val("yes")}else{$("#isMIFI_"+j).val("no")}OrderInfo.clearProdUim(j);OrderInfo.boProd2Tds.push(g);if(OrderInfo.actionFlag==22&&i.baseInfo.cardTypeFlag==1){AttachOffer.queryCardAttachOffer(i.baseInfo.cardTypeFlag)}};var b=function(l){var k=(Math.abs(l)-1);if(AttachOffer.openServList.length>k){var i=AttachOffer.openServList[k].servSpecList;for(var h=0;h<i.length;h++){var g=i[h];if(g.isdel!="Y"&&g.isdel!="C"){if(g.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true
}}}}return false};var c=function(i){var j={prodSpecId:i};var h=contextPath+"/mktRes/uim/getMktResCd";$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");var g=$.callServiceAsJson(h,j);$.unecOverlay();if(g.code=="0"){return g.data}else{return""}};var f=function(h){var g=$.trim($("#uim_txt_"+h).val());if(g==undefined||g==""){$.alert("提示","UIM卡不能为空!");return false}var j={numType:2,numValue:g};var i=$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",j);if(i.code==-2){$.alertM(i.data);return}if(i.code==-1){$.alert("提示",i.data);return}$.alert("提示","成功释放UIM卡："+g);if(OrderInfo.actionFlag==22){$("#attach").children().remove()}$("#uim_check_btn_"+h).attr("disabled",false);$("#uim_release_btn_"+h).attr("disabled",true);$("#uim_txt_"+h).attr("disabled",false);$("#uim_txt_"+h).val("");OrderInfo.clearProdUim(h)};var a=function(g,i,h){var j={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:h.couponId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:h.couponInsNumber,terminalCode:h.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:i,offerId:g,state:"DEL",relaSeq:"",id:0,isOld:"T",is4GCard:h.is4GCard};OrderInfo.boProd2OldTds.push(j);order.prodModify.choosedProdInfo.extCouponInstanceId=h.extCouponInstanceId;order.prodModify.choosedProdInfo.corCouponInstanceId=h.corCouponInstanceId};var e=function(i){OrderInfo.boProd2OldTds=[];var h=true;if(OrderInfo.actionFlag==6){if(i=="delViceCard"){var g={};$.each(OrderInfo.viceOfferSpec,function(){var j=this.prodId;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==j){g.prodInstId=this.objInstId;g.accNbr=this.accessNumber;var k=query.prod.getTerminalInfo(g);if(k==undefined){h=false;return false}a(this.offerId,this.objInstId,k);if(k.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}}})})}else{var g={};$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){g.prodInstId=this.objInstId;g.accNbr=this.accessNumber;var k=query.prod.getTerminalInfo(g);if(k==undefined){h=false;return false}a(this.offerId,this.objInstId,k);if(k.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}var j=order.prodModify.choosedProdInfo;if(j!=undefined&&j.prodInstId==this.objInstId){j.prodClass=this.prodClass}}})}}return h};return{getMktResCd:c,checkUim:d,releaseUim:f,setProdUim:e,setOldUim:a}})();CommonUtils.regNamespace("query","prod");query.prod=(function(){var i=function(m){g(m);var l=contextPath+"/prod/prodSpecParamQuery";$.ecOverlay("<strong>正在查询产品规格属性中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,m);$.unecOverlay();if(k.code==0){if(k.data){return k.data}}else{if(k.code==-2){$.alertM(k.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var j=function(m){g(m);var l=contextPath+"/prod/prodInstParamQuery";$.ecOverlay("<strong>正在查询产品实例属性中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,m);$.unecOverlay();if(k.code==0){if(k.data){return k.data}}else{if(k.code==-2){$.alertM(k.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var a=function(k){var m={prodId:k.prodInstId,areaId:OrderInfo.getProdAreaId(k.prodInstId),acctNbr:k.accNbr,isServiceOpen:"Y"};$.ecOverlay("<strong>正在查询产品下终端实例数据中,请稍后....</strong>");var l=$.callServiceAsJson(contextPath+"/token/app/order/queryTerminalInfo",m,{});$.unecOverlay();if(l.code==0){return l.data}else{if(l.code==-2){$.alertM(l.data)}else{$.alert("错误提示","接口未返回号码["+m.acctNbr+"]产品原UIM卡数据，无法继续受理！")}}};var c=function(o,m){o.isServiceOpen="Y";var l=contextPath+"/order/account";if(typeof(m)=="function"){$.callServiceAsJsonGet(l,o,{before:function(){$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>")},done:function(p){$.unecOverlay();if(p.code==0){m(p.data)}else{if(p.code==-2){$.alertM(p.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,o);$.unecOverlay();if(k.code==0){if(k.data){return k.data.offerSpec}}else{if(k.code==-2){$.alertM(k.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}};var e=function(m){var l=contextPath+"/mktRes/terminal/checkTerminal";$.ecOverlay("<strong>终端校验中,请稍后....</strong>");var k=$.callServiceAsJson(l,m);$.unecOverlay();if(k.code==-2){$.alertM(k.data)}else{if(k.data&&k.data.code==0){return k.data}else{if(k.data.code==1){$.alert("提示",k.data.message)}else{$.alert("提示","<br/>校验失败，请稍后重试！")}}}};var f=function(o){var l=contextPath+"/app/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");var k=$.callServiceAsJson(l,o);$.unecOverlay();if(k.code==0){$.alert("提示","UIM卡校验成功!");return k.data}else{if(typeof k==undefined){$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常")}else{if(k.code==-2){$.alertM(k.data)}else{var m="";if(k.data!=undefined&&k.data.msg!=undefined){m=k.data.msg}else{m="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡校验失败，可能原因:"+m)}}}};var h=function(o){var l=contextPath+"/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>");var k=$.callServiceAsJson(l,o);$.unecOverlay();if(k.code==0){$.alert("提示","UIM卡释放成功!");return k.data}else{if(typeof k==undefined){$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常")}else{if(k.code==-2){$.alertM(k.data)}else{var m="";if(k.data!=undefined&&k.data.msg!=undefined){m=k.data.msg}else{m="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡释放失败，可能原因:"+m)}}}};var d=function(){var l=order.prodModify.choosedProdInfo;var k=a(l);if(k==undefined){return}var m={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:k.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:k.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:l.prodInstId,offerId:l.prodOfferInstId,state:"DEL",relaSeq:"",id:0,isOld:"T"};return m};var b=function(l){var o={prodId:l.prodInstId,prodSpecId:l.productId,offerSpecId:l.prodOfferId,acctNbr:l.accNbr};var m=query.offer.queryOpenedAttachAndServ(o);if(m&&m.result&&m.result.servLists){var k=false;$.each(m.result.servLists,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G){k=true}});return k}return false};var g=function(k){k.staffId=OrderInfo.staff.staffId;k.channelId=OrderInfo.staff.channelId;k.partyId=OrderInfo.cust.custId;k.areaId=OrderInfo.getProdAreaId(k.prodId);k.distributorId=OrderInfo.staff.distributorId;if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){k.soNbr=OrderInfo.order.soNbr}};return{checkUim:f,releaseUim:h,getTerminalInfo:a,prodSpecParamQuery:i,prodInstParamQuery:j,getOldUim:d,queryAcct:c,checkTerminal:e,checkIs4GProdInst:b}})();CommonUtils.regNamespace("common","print");common.print=(function(g){var s=function(N){var P=g("a[olId="+N+"]").attr("ifPrint");if(CONST.getAppDesc()==0&&"N"==P){var K=g("#tab_orderList tr[olId="+N+"]");var O="";var C=[];var E="false";for(var H=0;H<K.length;H++){var M=K[H];var J=g(M).attr("actionClass");if(J=="1600"){continue}E=g(M).attr("newProdFlag");if(E=="true"){break}var D=g(M).attr("objInstId");if(D==undefined||D==""){g.alert("提示","objInstId为空，请核查接口返回的数据！");return false}var I=g(M).attr("accessNumber");if(I==undefined||I==""){g.alert("提示","accessNumber为空，请核查接口返回的数据！");return false}}for(var H=0;E=="false"&&H<K.length;H++){var M=K[H];var J=g(M).attr("actionClass");if(J=="1600"){continue}var D=g(M).attr("objInstId");var I=g(M).attr("accessNumber");if(g.inArray(D,C)>=0){continue}O=g(M).attr("areaId");OrderInfo.orderResult.olNbr=g(M).attr("olNbr");var L="";OrderInfo.order.soNbr=UUID.getDataId();var F={areaId:O,acctNbr:I,custId:L,soNbr:OrderInfo.order.soNbr,instId:D,type:"2"};var G=query.offer.invokeLoadInst(F);if(!G){return false}C.push(D)}g("a[olId="+N+"]").attr("ifPrint","Y")}if(OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olId=N;return true};var v=function(D,F){if(!s(D)){return}var E={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr};
var C=new Array(3);if(ec.util.browser.versions.android){C[0]="order/sign/downVoucher"}else{C[0]="print/iosVoucher"}C[1]="voucherInfo";C[2]=JSON.stringify(E);MyPlugin.printShow(C,function(G){},function(G){})};var x=function(E){var D="1";E.PcFlag=D;var C=contextPath+"/order/sign/previewHtmlForSign";g.callServiceAsHtml(C,E,{before:function(){g.ecOverlay("<strong>生成回执预览的html,请稍等会儿....</strong>")},always:function(){g.unecOverlay()},done:function(F){if(F.code==0){g("#order-confirm").hide();g("#order-print").html(F.data).show();OrderInfo.order.step=4;g("#datasignBtn").off("click").on("click",function(){common.callDatasign("common.print.showDataSign")});g("#print_ok").off("click").on("click",function(){if(!ec.util.isObj(g("#signinput").val())){g.alert("提示","请先进行签名，然后再保存！")}else{f()}})}else{if(F.code==-2){g.alertM(F.data)}else{g.alert("提示","生成回执预览的html失败!")}}},fail:function(F){g.unecOverlay();g.alert("提示","服务忙，请稍后再试！")}})};var f=function(){var D={olId:OrderInfo.orderResult.olId,signFlag:"5",busiType:"9",sign:l(g("#signinput").val())};var C=contextPath+"/order/sign/saveSignPdfForApp";g.callServiceAsJson(C,D,{before:function(){g.ecOverlay("<strong>正在保存回执,请稍等会儿....</strong>")},done:function(E){g.unecOverlay();if(E.code==0){g("#order-confirm").show();g("#order-print").hide();g("#printVoucherA").attr("disabled","disabled");OrderInfo.order.step=3}else{if(E.code==-2){g.alertM(E.data)}else{var F=E.data.errData!=null?E.data.errData:"保存回执失败!";g.alert("提示",F)}}}})};var l=function(D){var C=new RegExp("=","g");D=D.replace(C,"<p/>");return D};var e=function(C){g("#datasign").attr("src","data:image/jpg;base64,"+C);g("#signinput").val(C)};var z=function(C,E){if(!s(C)){return}var D={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:E};common.print.printVoucher(D)};var u=function(D){var C=new Array(3);if(ec.util.browser.versions.android){C[0]="print/voucher"}else{C[0]="print/iosVoucher"}C[1]="voucherInfo";C[2]=JSON.stringify(D);MyPlugin.printShow(C,function(E){},function(E){})};var i=function(Q,D,P){var I=g("a[olId="+Q+"]").attr("ifInvoice");var R=g("a[olId="+Q+"]").attr("areaId");if(CONST.getAppDesc()==0&&"N"==I){var M=g("#tab_orderList tr[olId="+Q+"]");var C=[];var F="false";for(var J=0;J<M.length;J++){var O=M[J];var L=g(O).attr("actionClass");if(L=="1600"){continue}F=g(O).attr("newProdFlag");if(F=="true"){break}var E=g(O).attr("objInstId");if(E==undefined||E==""){g.alert("提示","objInstId为空，请核查接口返回的数据！");return}var K=g(O).attr("accessNumber");if(K==undefined||K==""){g.alert("提示","accessNumber为空，请核查接口返回的数据！");return}}for(var J=0;F=="false"&&J<M.length;J++){var O=M[J];var L=g(O).attr("actionClass");if(L=="1600"){continue}var E=g(O).attr("objInstId");var K=g(O).attr("accessNumber");if(g.inArray(E,C)>=0){continue}R=g(O).attr("areaId");OrderInfo.orderResult.olNbr=g(O).attr("olNbr");var N="";OrderInfo.order.soNbr=UUID.getDataId();var G={areaId:R,acctNbr:K,custId:N,soNbr:OrderInfo.order.soNbr,instId:E,type:"2"};var H=query.offer.invokeLoadInst(G);if(!H){return}C.push(E)}g("a[olId="+Q+"]").attr("ifInvoice","Y")}if(OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olNbr=D;OrderInfo.orderResult.olId=Q;var G={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,billType:0,printFlag:P,areaId:R,acctItemIds:[]};common.print.prepareInvoiceInfo(G)};var d=function(G){g.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");var D=contextPath+"/print/getInvoiceItems";var C=g.callServiceAsJson(D,G,{});g.unecOverlay();if(!C){g.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return false}if(C.code==-2){g.alertM(C.data);return false}if(C.code!=0){g.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return false}if(C.data.resultCode!="0"){g.alert("提示",C.data.resultMsg);return false}if(C.data.chargeItems==undefined||C.data.chargeItems.length==0){g.alert("提示","没有可打印的费用项");return false}else{var E=0;for(;E<C.data.chargeItems.length;E++){var F=C.data.chargeItems[E];if(F.paymentAmount!=0){break}}if(E==C.data.chargeItems.length){g.alert("提示","没有可打印的费用项");return false}}return C};var k=function(){var E={staffId:OrderInfo.staff.staffId,areaId:OrderInfo.staff.areaId,custSoNbr:OrderInfo.orderResult.olNbr,custOrderId:OrderInfo.orderResult.olId,invoiceType:"100"};var D=contextPath+"/print/getInvoiceInfo";var C=g.callServiceAsJson(D,E,{});if(!C){return false}if(C.code==-2){g.alertM(C.data);return false}if(C.code!=0){return false}if(C.data.invoiceInfos!=undefined&&C.data.invoiceInfos instanceof Array&&C.data.invoiceInfos.length>0){}else{return false}return C};var p=function(C){if(OrderInfo.cust.norTaxPayer=="Y"){g.alert("提示","客户为一般纳税人，请到省份CRM系统打印专用增值税发票！");g.confirm("提示信息","客户为一般纳税人，专用增值税发票需要到省份CRM系统打印。是否只打印普通发票?",{yes:function(){h(C)},no:function(){return}},"question")}else{h(C)}};var h=function(J){var G=d(J);if(!G){return}var E=k();if(!E){}else{var P=E.data.invoiceInfos;if(ec.util.isArray(P[0].invoiceInfos)){g("#invoiceNbrInp").val(P[0].invoiceInfos[0].invoiceNbr);g("#invoiceNumInp").val(P[0].invoiceInfos[0].invoiceNum)}else{g("#invoiceNbrInp").val(P[0].invoiceNbr);g("#invoiceNumInp").val(P[0].invoiceNum)}}var U=G.data.invoiceInfos;if(U!=undefined&&U instanceof Array&&U.length>0){}else{var Y={soNbr:OrderInfo.order.soNbr,billType:0,olId:J.olId,printFlag:-1,areaId:OrderInfo.staff.areaId,acctItemIds:[]};var F=common.print.initPrintInfo(Y);if(!F){return}if(J.printFlag==1){g.alert("信息","此购物车对应的发票未打印过，请到发票补打页面。");return}G=d(J);if(!G){return}}common.print.oldInvoiceFlag="0";if(r(G.data.invoiceInfos,J.printFlag)){return}var I=contextPath+"/print/getInvoiceTemplates";var M={areaId:OrderInfo.staff.areaId};var Q=g.callServiceAsJson(I,M,{});if(Q.code==-2){g.alertM(Q.data);return}else{if(Q.code!=0){g.alert("提示",ec.util.defaultStr(Q.data,"获取打印模板出错"));return}else{var D=Q.data;if(D.resultCode!="POR-0000"){g.alert("提示",ec.util.defaultStr(D.resultMsg,"获取打印模板异常"));return}if(D.length==0){g.alert("提示","没有获取到可用的打印模板");return}var O="";var W=D.tempList;if(typeof W!=undefined&&W.length>0){O+="<option selected='selected' value="+W[0].templateId+">"+W[0].templateName+"</option>";for(var R=1;R<W.length;R++){var V=W[R];O+="<option value="+V.templateId+">"+V.templateName+"</option>"}}g("#tempListSel").html(O)}}var S="";var X=G.data.prodInfo;if(X!=undefined&&X.length>0){S+="<option selected='selected' value="+X[0].accessNumber+">"+X[0].accessNumber+"</option>";for(var R=1;R<X.length;R++){var L=X[R];S+="<option value="+L.accessNumber+">"+L.accessNumber+"</option>"}}g("#acceNbrSel").html(S);var N="";N+="<div id='invoiceContDiv'>";N+="  <table class='searchtable'>";N+="    <tr>";N+="      <th>是否打印</th><th>费用名称</th><th>费用(元)</th><th>税金(元)</th><th>付费方式</th>";N+="    </tr>";var H=G.data.chargeItems;for(var R=0;R<H.length;R++){var T=H[R];if(R==0){g("#invoiceTitleInp").val(T.custName)}if(T.paymentAmount==0){continue}N+="    <tr acctItemId="+T.acctItemId+" acctItemTypeId="+T.acctItemTypeId+" ";N+="        acctItemTypeName='"+T.acctItemTypeName+"' boActionType='"+T.boActionType+"' ";N+="        boActionType='"+T.boActionType+"' boId="+T.boId+" feeAmount="+T.feeAmount+" ";N+="        invoiceId="+T.invoiceId+" objId="+T.objId+" objType="+T.objType+" ";N+="        payMethodCd="+T.payMethodCd+" payMethodName="+T.payMethodName+" ";N+="        realAmount="+T.realAmount+" ";N+="        tax="+T.tax+" taxRate="+T.taxRate+" >";if(a(T)){N+="      <td><input type='checkbox' name='invoiceItemsChkBox' checked='checked'/></td>"}else{N+="      <td><input type='checkbox' name='invoiceItemsChkBox' disabled='disabled'/></td>"}N+="      <td>"+T.acctItemTypeName+"</td>";N+="      <td>"+(T.realAmount/100).toFixed(2)+"</td>";N+="      <td>"+(T.tax/100).toFixed(2)+"</td>";N+="      <td>"+T.payMethodName+"</td>";N+="    </tr>"}N+="  </table>";N+="</div>";g("#invoiceItemsContDiv").html(N);var K=g("#div_printInvoice").html();g("#div_printInvoice").html("");var C=g.popup("#div_printInvoice_prepare",K,{width:g(window).width()-200,height:g(window).height(),contentHeight:g(window).height()-120,afterClose:function(){g("#div_printInvoice").html(K)
}});g("#billType").off("change").on("change",function(Z){if(g("#billType").val()=="0"){g("#invoiceNbrNumDl").show();g("#titleDt").html("发票抬头：");g("#tempDt").html("发票模板：");J.billType=0}else{g("#invoiceNbrNumDl").hide();g("#titleDt").html("票据抬头：");g("#tempDt").html("票据模板：");J.billType=1}});g("#invoiceItemsConfirm").off("tap").on("tap",function(Z){if(common.print.oldInvoiceFlag!="0"){g.alert("信息","存在未作废发票，请先确定作废发票");return}m(J,G.data)});g("#invoiceItemsConCancel").off("tap").on("tap",function(Z){g("#div_printInvoice_prepare").popup("close")})};var q=function(I){var D=contextPath+"/print/getInvoiceItems";var F=g.callServiceAsJson(D,I);if(!F){g.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(F.code==-2){g.alertM(F.data);return}if(F.code!=0){g.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(F.data.resultCode!="0"){g.alert("提示",F.data.resultMsg);return}if(F.data.chargeItems==undefined||F.data.chargeItems.length==0){g.alert("提示","没有可打印的费用项");return}var C=y(I,F.data);var E=C.invoiceInfos;var H={invoiceInfos:E};var G=j(H,I.printFlag);if(G==false){return false}E=t(E,G.data.invoiceIds,"0");return E};var c=function(C){if(C=="-1"){return"初始打印"}else{if(C=="0"){return"正常打印"}else{if(C=="1"){return"重打"}else{if(C=="2"){return"补打"}else{return"未知操作"}}}}};var r=function(E,D){if(E!=undefined&&E instanceof Array&&E.length>0){for(var C=0;C<E.length;C++){if(!E[C]){g.alert("信息","接口返回的发票信息不是有效值，请确认。");return true}if(E[C].printFlag=="-1"){if(D=="0"||D=="2"){}else{g.alert("信息","此购物车对应的发票未打印过，请到发票补打页面。");return true}}else{if(E[C].printFlag=="0"){if(E[C].billType=="1"){return false}if(D=="1"){b(E,D)}else{g.alert("信息","此购物车对应的发票正常打印过，只允许重打。");return true}}else{if(E[C].printFlag=="1"||E[C].printFlag=="2"){if(D=="1"){b(E,D)}else{g.alert("信息","此购物车对应的发票已打印过，只允许重打。");return true}}else{g.alert("信息","发票信息中打印标识值不规范");return true}}}}return false}else{if(D=="0"){return false}else{g.alert("信息","此购物车没有对应的发票信息，不能进行补打或重打");return true}}};var b=function(G,E){if(G!=undefined&&G instanceof Array&&G.length>0){var C='<ul data-role="listview" style="min-width:380px;min-height: 140px">';C+="<li>存在未作废发票，请先作废发票：</li>";var F=[];for(var D=0;D<G.length;D++){var H=G[D];if(g.inArray(H.invoiceId,F)>=0){}else{C+="<li>发票代码："+H.invoiceNbr+";发票号码："+H.invoiceNum+"</li>";F.push(H.invoiceId)}}C+="</ul>";if(F.length>0){common.print.oldInvoiceFlag="1";g("#invalidInvoiceInfoDiv").html(C);g.jqmRefresh(g("#invalidInvoiceInfoDiv"));g("#dlg-invalid-invoice").popup("open");g("#invalidInvoiceConfirm").off("tap").on("tap",function(){common.print.oldInvoiceFlag="0";g("#dlg-invalid-invoice").popup("close")})}return false}else{return false}};var a=function(C){var D=C.payMethodCd;if(D==CONST.PAYMETHOD_CD.ZHANG_WU_DAI_SHOU){return false}return true};var w=function(D){try{if(D.billType!=1){if(g("#invoiceNbrInp").val()==""){g.alert("提示","请输入发票代码");return true}if(!/^\d{0,12}$/.test(g("#invoiceNbrInp").val())){g.alert("提示","请输入正确的发票代码");return true}if(g("#invoiceNumInp").val()==""){g.alert("提示","请输入发票号码");return true}if(!/^\d{0,12}$/.test(g("#invoiceNumInp").val())){g.alert("提示","请输入正确的发票号码");return true}}if(g("#invoiceTitleInp").val()==""){g.alert("提示","请输入发票抬头");return true}if(g("#invoiceContDiv tbody input:checked").length<1){g.alert("提示","请选择要打印的费用项");return true}}catch(C){return true}return false};var y=function(C,H){var P=[];var L={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"100",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:C.billType,printFlag:C.printFlag,invoiceId:0};var E=false;var G=0;var Q=0;var N=0;var K=[];var D="";var I=H.chargeItems;for(var F=0;F<I.length;F++){var M=I[F];L.acctItemIds.push({acctItemId:M.acctItemId});if(M.objType=="2"){L.instanceType=M.objType;L.instanceId=M.objId;L.paymethod=M.payMethodCd;E=true}else{if(!E&&M.objType=="7"){L.instanceType=M.objType;L.instanceId=M.objId;L.paymethod=M.payMethodCd}}G+=parseInt(M.feeAmount);Q+=parseInt(M.realAmount);N+=parseInt(M.tax);D=M.payMethodName}L.amount=G;L.realPay=Q;L.tax=N;L.account=Q;L.accountUpper=ec.util.atoc(Q);L.invoiceNbr=0;L.invoiceNum="0";var J=H.prodInfo;if(J!=undefined&&J.length>0){L.acctNbr=J[0].accessNumber}P.push(L);var O={payMethodName:D,items:K,invoiceInfos:P};return O};var o=function(C,H){var M=[];var J={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"100",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:C.billType,printFlag:C.printFlag,invoiceId:0};J.invoiceId=H.invoiceInfos[0].invoiceId;J.billType=g("#billType").val();if(J.billType=="0"){J.invoiceType="100"}else{J.invoiceType="200"}var E=false;var G=0;var N=0;var K=0;var I=[];var D="";var F=B(H);J.acctItemIds=[];g("#invoiceContDiv tbody input:checked").parent().parent().parent().each(function(){J.acctItemIds.push({acctItemId:g(this).attr("acctItemId")});if(g(this).attr("objType")=="2"){J.instanceType=g(this).attr("objType");J.instanceId=g(this).attr("objId");J.paymethod=g(this).attr("payMethodCd");E=true}else{if(!E&&g(this).attr("objType")=="7"){J.instanceType=g(this).attr("objType");J.instanceId=g(this).attr("objId");J.paymethod=g(this).attr("payMethodCd")}}G+=parseInt(g(this).attr("feeAmount"));N+=parseInt(g(this).attr("realAmount"));K+=parseInt(g(this).attr("tax"));var P="";var O=g(this).attr("boId");for(var Q=0;Q<F.length;Q++){if(O==F[Q].boId){P=F[Q].accessNumber}}I.push({itemName:g(this).attr("acctItemTypeName"),charge:parseInt(g(this).attr("realAmount")),tax:parseInt(g(this).attr("tax")),acceNumber:P});D=g(this).attr("payMethodName")});if(OrderInfo.actionFlag==11){J.printFlag=0}J.amount=G;J.realPay=N;J.tax=K;J.account=N;J.accountUpper=ec.util.atoc(N);J.invoiceNbr=g("#invoiceNbrInp").val();J.invoiceNum=""+g("#invoiceNumInp").val();J.acctNbr=g("#acceNbrSel option:selected").val();M.push(J);var L={payMethodName:D,items:I,invoiceInfos:M};return L};var B=function(I){var F=[];var J=I.chargeItems;var K=I.prodInfo;for(var G=0;G<J.length;G++){var M=J[G].boId;for(var D=0;D<K.length;D++){var H=K[D].accessNumber;var L=K[D].busiOrders;for(var C=0;C<L.length;C++){if(L[C].boId==M){var E={boId:M,accessNumber:H};F.push(E)}}}}return F};var m=function(I,F){if(w(I)){return}if(!F.invoiceInfos[0]){g.alert("提示","集团营业受理后台接口返回缺少发票信息，请确认。");return}var C=o(I,F);var E=C.invoiceInfos;var H={invoiceInfos:E};var G=j(H,I.printFlag);if(G==false){return}var D={partyName:g("#invoiceTitleInp").val(),templateId:g("#tempListSel :selected").val(),prodInfo:F.prodInfo,items:C.items,payMethod:C.payMethodName,invoiceInfos:E};A(D);if(OrderInfo.cust.norTaxPayer!="Y"){g("#div_printInvoice_prepare").popup("close")}return};var j=function(E,D){g.ecOverlay("<strong>正在提交中,请稍等会儿....</strong>");var C=g.callServiceAsJson(contextPath+"/print/saveInvoiceInfo",E);g.unecOverlay();if(C.code==-2){g.alertM(C.data);return false}else{if(C.code!=0||C.data.resultCode!="0"){g.alert("提示",c(D)+"调用集团发票打印处理接口失败，请稍后重试");return false}}return C};var t=function(F,E,D){for(var C=0;C<F.length;C++){F[C].invoiceId=E[C];F[C].printFlag=D}return F};var A=function(D){var C=new Array(3);if(ec.util.browser.versions.android){C[0]="print/invoice"}else{C[0]="print/iosInvoice"}C[1]="invoiceParam";C[2]=encodeURI(JSON.stringify(D));MyPlugin.printShow(C,function(E){},function(E){})};return{showDataSign:e,signVoucher:x,preVoucher:z,preSign:v,printVoucher:u,preInvoice:i,initPrintInfo:q,prepareInvoiceInfo:p,saveInvoiceInfo:m,chkInput:w,printInvoice:A}})(jQuery);$(function(){});
CommonUtils.regNamespace("order","dealer");order.dealer=(function(){var c=function(){if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:"40020005",NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:"40020006",NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:"40020007",NAME:"第三发展人"}]}else{$.ecOverlay("<strong>正在查询发展人类型中,请稍后....</strong>");var r=$.callServiceAsJson(contextPath+"/app/order/queryPartyProfileSpecList",null);$.unecOverlay();if(r.code==0){OrderInfo.order.dealerTypeList=r.data}else{if(r.code==-2){$.alertM(r.data);return}else{$.alert("信息提示",r.msg);return}}}$("#dealerTbody").empty();if(OrderInfo.actionFlag!=3&&OrderInfo.actionFlag!=2){$("#head").text(OrderInfo.offerSpec.offerSpecName)}var z=OrderInfo.provinceInfo.reloadFlag;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==14){var t=OrderInfo.offerSpec.offerSpecId;var x=$("<li id='tr_"+t+"' name='tr_"+t+"' href='#' class='list-group-item'></li>");x.append("<h5 class='list-group-item-heading text-warning'>主套餐</h5>");x.append("<p class='list-group-item-text'>"+OrderInfo.offerSpec.offerSpecName+"</p><p> </p>");var G=$("<p> </p>");var H=$('<div class="row"> </div>');var w=$('<div class="col-xs-6" style="width:33%"> </div>');var B=OrderInfo.SEQ.dealerSeq;var y=t+"_"+B;OrderInfo.codeInfos.developmentObjId=y;var E=$('<select id="dealerType_'+y+'" name="dealerType_'+t+'"  class="selectpicker show-tick form-control" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+t+"',a)\"></select>");var v;var q=$("<div class='col-xs-6' style=\"width:33%\"></div>");var s=$('<select id="dealerChannel_'+y+'" name="dealerChannel_'+t+'" class="selectpicker show-tick form-control styled-select" onclick=a=this.value;></select>');if(z=="N"){if(OrderInfo.reloadProdInfo.dealerlist.length>0){$.each(OrderInfo.reloadProdInfo.dealerlist,function(K,L){if(this.offerTypeCd=="1"){if(this.role!=undefined){var M=this.role;$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==M){E.append("<option value='"+this.PARTYPRODUCTRELAROLECD+'\' selected="selected">'+this.NAME+"</option>")}else{E.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}})}var J=this.staffid;if(J!=null&&J!=""&&J!=undefined){v=$('<div class="col-xs-6" style="width:33%"><input type="text" onclick="javascript:order.dealer.showDealer(0,\'dealer\',\''+y+'\');" onChange="javascript:this.staffId=OrderInfo.staff.staffId;this.value=OrderInfo.staff.staffName" class="form-control" id="dealer_'+y+'" staffId="'+J+'" value="'+this.staffname+'" ></input></div>')}var I=this.channelNbr;$.each(OrderInfo.channelList,function(){if(this.channelNbr==I){s.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{s.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}})}})}$("#order_remark").val(OrderInfo.reloadProdInfo.orderMark)}else{$.each(OrderInfo.order.dealerTypeList,function(I,J){E.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});v=$('<div class="col-xs-6" style="width:33%"><input type="text" onclick="javascript:order.dealer.showDealer(0,\'dealer\',\''+y+'\');" onChange="javascript:this.staffId=OrderInfo.staff.staffId;this.value=OrderInfo.staff.staffName" class="form-control" id="dealer_'+y+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" ></input></div>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){s.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{s.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}})}w.append(E);H.append(w);H.append(v);q.append(s);H.append(q);x.append(H);x.append(G);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(x);$.refresh($("#dealerTbody"))}if(OrderInfo.actionFlag==6){}if(OrderInfo.actionFlag==13){var t=$("#mktResId").val();var x=$("<li id='tr_"+t+"' name='tr_"+t+"'></li>");var C=$("<dl></dl>");var A=$("<dd></dd>");var D=$('<fieldset data-role="fieldcontain"></fieldset>');var y=t+"_"+OrderInfo.SEQ.dealerSeq;var E=$('<select id="dealerType_'+y+'" name="dealerType_'+t+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+t+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){E.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});D.append(E);A.append(D);C.append(A);var F=$('<dd><input type="text" id="dealer_'+y+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');C.append(F);var u='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';u+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+y+"');\">选择</button></div>";u+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+t+',1)">添加</button></div></div></dd>';C.append(u);x.append(C);OrderInfo.SEQ.dealerSeq++;$("#dealerMktTbody").append(x);$.jqmRefresh($("#dealerMktTbody"))}if(z!=null&&z!=""&&z=="N"){if(OrderInfo.reloadProdInfo.dealerlist.length>0){$.each(OrderInfo.reloadProdInfo.dealerlist,function(J,W){if(this.offerTypeCd=="2"){var L=this.objInstId;var P=this.prodId;if(this.role!=undefined){var I=L+"_"+OrderInfo.SEQ.dealerSeq;var Q=$("#atr_"+L);var R=$('<li name="tr_'+P+"_"+L+'" id="tr_'+P+"_"+L+"\" class='list-group-item'></li>");R.append("<h5 class='list-group-item-heading text-warning'>"+this.accessNumber+"[<a href=\"javascript:order.dealer.removeDealerNew('"+P+"_"+L+"');\">删除</a>]</h5>");R.append("<p class='list-group-item-text'>"+this.objName+"</p>");R.append("<p ></p>");var S=$('<div class="row"> </div>');var O=$('<div class="col-xs-6" style="width:33%"> </div>');OrderInfo.codeInfos.developmentObjId=I;var N=$('<select id="dealerType_'+I+'" name="dealerType_'+P+"_"+L+'"  class="selectpicker show-tick form-control" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+L+"',a)\"></select>");var V=this.role;$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==V){N.append("<option value='"+this.PARTYPRODUCTRELAROLECD+'\' selected="selected">'+this.NAME+"</option>")}else{N.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});O.append(N);S.append(O);var K=$('<div class="col-xs-6" style="width:33%"><input type="text" onclick="javascript:order.dealer.showDealer(0,\'dealer\',\''+I+'\');" onChange="javascript:this.staffId=OrderInfo.staff.staffId;this.value=OrderInfo.staff.staffName" class="form-control" id="dealer_'+I+'" staffId="'+this.staffid+'" value="'+this.staffname+'" ></input></div>');S.append(K);var U=this.channelNbr;var M=$("<div class='col-xs-6' style=\"width:33%\"></div>");var T=$('<select id="dealerChannel_'+I+'" name="dealerChannel_'+P+"_"+L+'" class="selectpicker show-tick form-control styled-select" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.channelNbr==U){T.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{T.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});M.append(T);S.append(M);R.append(S);R.append("<p ></p>");$("#dealerTbody").append(R);OrderInfo.SEQ.dealerSeq++}}})}}};function b(r,q,w){$("#sel").empty();$("#diqu").empty();var u=OrderInfo.staff.areaId.substring(0,3)+"0000";var v=OrderInfo.staff.areaAllName.substring(0,OrderInfo.staff.areaAllName.indexOf(">"));var t=$('<select  class="selectpicker show-tick form-control" onChange="order.dealer.queryChildNode('+u+')">');var s=$('<option value="">'+v+"</option>");t.append(s);$("#sel").append(t);t.addClass("styled-select");p(u);$("#queryStaff").off("click").on("click",function(){o(r,q,w)})}function p(q){var r={upRegionId:q,areaLevel:3,areaLimit:0};
$.callServiceAsJson(contextPath+"/app/orderQuery/areaTreeAllChilden",r,{before:function(){},done:function(t){if(t.data){var s="";var v=t.data;if(v.length>0){for(var u=0;u<v.length;u++){if(v[u].commonRegionId==OrderInfo.staff.areaId.substring(0,5)+"00"){s=s+"<option  selected='selected' value='"+v[u].commonRegionId+"' zone_number='"+v[u].zoneNumber+"' name='"+v[u].regionName+"'>"+v[u].regionName+"</option>"}else{s=s+"<option value='"+v[u].commonRegionId+"' zone_number='"+v[u].zoneNumber+"' name='"+v[u].regionName+"'>"+v[u].regionName+"</option>"}}$("#diqu").html(s);$("#diqu").addClass("styled-select");$("#developModal").modal("show")}}}})}function k(r){var q=$("#staff_list_body .plan_select");q.each(function(){$("#dealer_"+r).val($(this).attr("staffName")).attr("staffId",$(this).attr("staffId"))});if(q.length>0){easyDialog.close()}else{$.alert("操作提示","请选择 协销人！")}}function o(r,q,u){if($("#staffName").val()==""&&$("#staffCode").val()==""){$.alert("操作提示","请输入工号或者姓名！");return}var s=$("#staffCode").val();var t={dealerId:q,areaId:$("#diqu").val(),name:$("#staffName").val(),code:s,pageIndex:1,objInstId:u,pageSize:1};$.callServiceAsJson(contextPath+"/app/staffMgr/getStaffList2",t,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},done:function(v){$.unecOverlay();if(!v){v.data=""}if(v.code==0){if(v.data.length==0){if(s!=null&&s!=""){$.alert("操作提示","未查询到工号为["+s+"]的员工信息")}else{$.alert("操作提示","没有查询到该员工信息！")}}else{$("#dealer_"+u).attr("value",v.data[0].staffName).attr("staffId",v.data[0].staffId);$("#developModal").modal("hide")}}else{if(v.code==-2){$.alertM(v.data);return}else{$.alert("信息提示",v.msg);return}}}})}var g=function(q,t,s){var r=0;$("select[name="+t+"]").each(function(){if($(this).val()==$(q).val()){r++}});if(r>1){$.alert("信息提示","每个业务的发展人类型不能重复");$(q).val(s)}};var e=function(){$("input[name=attach_dealer]:checked").each(function(){var s=$(this).attr("id");var w=s.split("_")[0];if($("#tr_"+s)[0]==undefined){var q=s+"_"+OrderInfo.SEQ.dealerSeq;var x=d(s,q);if(x==undefined){return false}var y=$("#atr_"+s);var z=$("<li name='tr_"+s+"' id='tr_"+s+"' class='list-group-item'></li>");z.append("<h5 class='list-group-item-heading text-warning'>"+y.children().eq(1).text()+"[<a href=\"javascript:order.dealer.removeDealerNew('"+s+"');\">删除</a>]</h5>");z.append("<p class='list-group-item-text'>"+y.children().eq(2).text()+"</p>");z.append("<p ></p>");var A=$('<div class="row"> </div>');var v=$('<div class="col-xs-6" style="width:33%"> </div>');OrderInfo.codeInfos.developmentObjId=q;var u=$('<select id="dealerType_'+q+'" name="dealerType_'+s+'"  class="selectpicker show-tick form-control" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+s+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){u.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});v.append(u);A.append(v);var r=$('<div class="col-xs-6" style="width:33%"><input type="text" onclick="javascript:order.dealer.showDealer(0,\'dealer\',\''+q+'\');" onChange="javascript:this.staffId=OrderInfo.staff.staffId;this.value=OrderInfo.staff.staffName" class="form-control" id="dealer_'+q+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" ></input></div>');A.append(r);var t=$("<div class='col-xs-6' style=\"width:33%\"></div>");var B=$('<select id="dealerChannel_'+q+'" name="dealerChannel_'+s+'" class="selectpicker show-tick form-control styled-select" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){B.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{B.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});t.append(B);A.append(t);z.append(A);z.append("<p ></p>");$("#dealerTbody").append(z);OrderInfo.SEQ.dealerSeq++}});$("#addModal").modal("hide")};var h=function(u,r,y){var z=$(u).parent().parent().parent().parent().parent();var s=r+"_"+OrderInfo.SEQ.dealerSeq;var v=d(r,s);if(v==undefined){return}var x=$('<li name="tr_'+r+'"></li>');var t=$("<dl></dl>");if(OrderInfo.actionFlag!=13){t.append("<dd>"+z.find("dd").eq(0).text()+"</dd>");t.append("<dd>"+z.find("dd").eq(1).text()+"</dd>")}t.append(v);if(order.ysl!=undefined){var w=$('<dd><input type="text" id="dealer_'+s+'" name="dealer_'+r+'" staffId="'+z.find("input").attr("staffId")+'" value="'+z.find("input").attr("value")+'"  data-mini="true"></input></dd>');t.append(w)}else{var w=$('<dd><input type="text" id="dealer_'+s+'" name="dealer_'+r+'" staffId="'+z.find("input").attr("staffId")+'" value="'+z.find("input").attr("value")+'"  data-mini="true"  readonly="readonly"></input></dd>');t.append(w)}var q='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';q+="<button data-mini=\"ture\" onclick=\"order.main.queryStaff('dealer','"+s+"');\">选择</button></div>";q+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';t.append(q);x.append(t);z.after(x);$.jqmRefresh($("#dealerTbody"));OrderInfo.SEQ.dealerSeq++};var l=function(r,q){$("li[name^='tr_"+r+"']").each(function(){$(this).find("dd").eq(0).text(q)})};var d=function(u,r){var t="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var w=this.PARTYPRODUCTRELAROLECD;var v=true;$("select[name='dealerType_"+u+"']").each(function(){if(w==$(this).val()){v=false;return false}});if(v){t=w;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(t==undefined||t==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var s=$("<dd></dd>");var r=u+"_"+OrderInfo.SEQ.dealerSeq;var q=$('<select id="dealerType_'+r+'" name="dealerType_'+u+'"  class="selectpicker show-tick form-control" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+u+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==t){q.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{q.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});s.append(q);return s};var m=function(){$("#addBody").empty();var q=$('<div data-role="content"></div>');var z=$('<table class="searchtable"></table>');z.append('<tr><th>操作</th><th style="width:150px;text-align:center;">号码</th><th style="text-align:center;">发展业务</th></tr>');$.each(AttachOffer.openList,function(){var C=this.prodId;var B="";if(OrderInfo.actionFlag==6){B=OrderInfo.getAccessNumber(C);for(var A=0;A<OrderInfo.oldprodInstInfos.length;A++){if(C==OrderInfo.oldprodInstInfos[A].prodInstId){B=OrderInfo.oldprodInstInfos[A].accNbr}}}else{B=OrderInfo.getAccessNumber(C)}if(B==undefined||B==""){B="未选号"}$.each(this.specList,function(){var E=C+"_"+this.offerSpecId;if(this.isdel!="Y"&&this.isdel!="C"&&$("li[name='tr_"+E+"']")[0]==undefined){var D=$('<tr id="atr_'+E+'" onclick="order.dealer.checkAttach(\''+C+"','"+this.offerSpecId+"');\"></tr>");D.append("<td style='text-align:center'><input type='checkbox' id=\""+E+'" onclick="order.dealer.checkAttach(\''+C+"','"+this.offerSpecId+'\');" name="attach_dealer"/></td>');D.append("<td style='text-align:center'>"+B+"</td><td style='text-align:center'>"+this.offerSpecName+"</td>");z.append(D)}})});if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){for(var v=0;v<order.ysl.openList.length;v++){if(order.ysl.openList[v].type=="1"){var w="-1";var s=$("#choosedNumSpan").val();if(s==undefined||s==""){s="未选号"}var y="N";var u=$("#dealerTbody").find("tr");u.each(function(){if($(this).attr("name")=="tr_-1_"+order.ysl.openList[v].id){y="Y"}else{y="N"
}});if(y=="N"){var r=w+"_"+order.ysl.openList[v].id;var x=$('<tr id="atr_'+r+'" onclick="order.dealer.checkAttach(\''+r+"')\"></tr>");x.append('<td><input type="checkbox" id="'+r+'" onclick="order.dealer.checkAttach(\''+r+'\')" name="attach_dealer"/></td>');x.append("<td style='text-align:center'>"+s+"</td><td>"+order.ysl.openList[v].name+"</td>");z.append(x)}}}}}q.append(z);var t='<div data-role="footer" data-position="inline" data-tap-toggle="false" data-theme="n"> <button data-inline="true" data-icon="next" id="sureAdddealer">确定</button>';t+='<button data-inline="true" data-icon="back" data-rel="back" id="closeAdddealer">取消</button></div>';$("#addBody").append(q);$("#addModel").modal("show");$("#sureAdddealer").off("click").on("click",function(){e()});$("#addModal").modal("show")};var j=function(r,s){var q=$("#"+r+"_"+s);if(q.attr("checked")=="checked"){}else{}};var a=function(q){$(q).parent().parent().parent().parent().parent().remove();$.refresh($("#dealerTbody"))};var f=function(q){$("#tr_"+q).remove()};var i=function(q){$("li[name^='tr_"+q+"']").each(function(){$(this).remove()});$.refresh($("#dealerTbody"))};return{initDealer:c,changeAccNbr:l,showOfferList:m,addProdDealer:h,addAttachDealer:e,checkAttach:j,removeDealer:a,removeAttDealer:i,changeDealer:g,queryStaff:o,showDealer:b,queryChildNode:p,removeDealerNew:f}})();CommonUtils.regNamespace("order","memberChange");order.memberChange=function(){var O=0;var m="";var I={};var Q=[];var w=false;var W=1;var r=1;var d="";var v;var S;var E;var y={};var c={objInstId:[]};var ab=0;var C={accessNumbers:[]};var A={accessNumbers:[]};var p={};var M=function(af){m=af;var ah={};var ag=contextPath+"/app/order/prodoffer/prepare?subPage="+af;$.callServiceAsHtml(ag,ah,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(ai){if(!ai){ai.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>页面显示失败,稍后重试</strong></div>'}if(ai.code!=0){$.alert("提示","页面显示失败,稍后重试");return}$("#member_prepare").hide();var aj=$("#offerspecContent");aj.html(ai.data).show();$("#tentrance").show();$("#pentrance").hide();$("#nentrance").hide();$("#pakeage").attr("class","tab-pane fade in active");$("#tentrance").css("width","100%")}})};var X=function(){if(order.prodModify.choosedProdInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","当前产品状态不是【在用】,不允许受理该业务！");return}Q=[];W=1;r=1;OrderInfo.busitypeflag=3;OrderInfo.actionFlag=6;OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldprodAcctInfos=[];OrderInfo.oldAddNumList=[];OrderInfo.viceOfferSpec=[];$("#order_fill_content").empty();OrderInfo.order.step=0;if(order.memberChange.reloadFlag=="N"){$("#orderedprod").hide();$("#order_prepare").hide();$("#member_prepare").hide();$("#content").hide()}else{$("#orderedprod").show();$("#order_prepare").show()}$("#order_confirm").hide();if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"){$.alert("提示","3G套餐不允许做主副卡成员变更业务！","information");return}var ao=a();var aj="";var al="";if(order.memberChange.newSubPhoneNum!=null&&order.memberChange.newSubPhoneNum!=""&&order.memberChange.newSubPhoneNum!=undefined){aj=order.memberChange.newSubPhoneNum.split(",")}if(order.memberChange.oldSubPhoneNum!=null&&order.memberChange.oldSubPhoneNum!=""&&order.memberChange.oldSubPhoneNum!=undefined){al=order.memberChange.oldSubPhoneNum.split(",")}var ag={offerSpecId:order.prodModify.choosedProdInfo.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var ah=query.offer.queryMainOfferSpec(ag);if(!ah){return}var am=true;$.each(ah.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){am=false;return false}});if(am){$.alert("错误","你选择的套餐不是主副卡套餐，不能进行主副卡成员变更");return}if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!query.offer.setOffer()){return}}var ak=0;var at=true;$.each(ah.offerRoles,function(){var ax=this;var aw=ax.offerRoleName;if(ax.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){aw+="    "+this.objName}});$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ax.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){aw+=":"+this.accessNumber;return}});$("#memberp").text(aw)}else{$.each(ax.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){this.minQty=0;this.dfQty=0;viceMinQty=0;viceMaxQty=this.maxQty;numId=ax.offerRoleId+"_"+this.objId}});var au=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ax.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){au++}});$.each(this.roleObjs,function(){var aF=ax.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){Q.push(aF);if(ax.minQty==0){this.minQty=0;this.dfQty=0}var aB=this.maxQty<0?"不限制":this.maxQty;aB=aB-au;ab=aB;if(aB>0){if(aj.length+al.length>aB){$.alert("规则限制","newSubPhoneNum和oldSubPhoneNumsize的角色成员数量总和不能超过"+aB);at=false;return false}else{O=aB;if(aj.length==0){OrderInfo.objInstId=aF;var aD=$("<div class='form-group'></div>");var aA=$("<div class='input-group col-xs-6'>");var az=$("<label>移动电话（仅含本地语音）"+this.objName+this.minQty+"-"+aB+"（张）</label>");var aC=$("<span class='input-group-btn'>");aC.append("<button id='newSubNumBtn' class='btn btn-default' type='button' onClick='javascript:order.service.subNum(\""+aF+'",'+this.minQty+");'> - </button>");aA.append(aC).appendTo(aD);var aE=$("<input id='"+aF+"' type='text' value='"+this.dfQty+"' class='form-control' readonly='readonly'>");aA.append(aE);aC.append("<button id='newAddNumBtn' class='btn btn-default' type='button' onClick='javascript:order.service.addNum(\""+aF+'",'+aB+");'> + </button>");aA.append(aC).appendTo(aD);az.appendTo(aD);aA.appendTo(aD);$("#form").append(aD)}else{OrderInfo.objInstId=aF;var aD=$("<div class='form-group'></div>");var aA=$("<div class='input-group col-xs-6'>");var az=$("<label>移动电话（仅含本地语音）"+this.objName+this.minQty+"-"+aB+"（张）</label>");var aC=$("<span class='input-group-btn'>");aA.append(aC).appendTo(aD);var aE=$("<input id='"+aF+"' type='text' value='"+aj.length+"' class='form-control' readonly='readonly'>");aA.append(aE);aA.append(aC).appendTo(aD);az.appendTo(aD);aA.appendTo(aD);$("#form").append(aD)}}}ak++}});if(ao){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var aB=this.maxQty<0?"不限制":this.maxQty;aB=aB-au;if(aB>0){var aG="";if(al.length==0){var aD=$("<div class='form-group' id='oldnum_1'></div>");var aA=$("<div class='input-group'>");var az=$("<label>已有移动电话"+this.objName+this.minQty+"-"+aB+"（张）</label>");var aF=$("<input name='oldphonenum' id='oldphonenum_1' class='form-control'>");aA.append(aF);var aC=$("<span class='input-group-btn'>");aC.append("<button class='btn btn-default' type='button' onClick='javascript:order.memberChange.addNum("+aB+");'> + </button>");aC.append("<button class='btn btn-default' type='button' onClick='javascript:order.memberChange.delNum(\"oldnum_"+r+"\");'> - </button>");aA.append(aC).appendTo(aD);az.appendTo(aD);aA.appendTo(aD);$("#form").append(aD)}else{if(al.length>aB){$.alert("规则限制","oldSubPhoneNum的角色成员数量总和不能超过"+aB);at=false;return false}else{for(var aE=0;aE<al.length;aE++){if(aE==0){var aD=$("<div class='form-group' id='oldnum_1'></div>");var aA=$("<div class='input-group'>");var az=$("<label>已有移动电话"+this.objName+this.minQty+"-"+aB+"（张）</label>");var aF=$("<input name='oldphonenum'  id='oldphonenum_1' value='"+al[aE]+"'  readonly='readonly'   class='form-control'>");aA.append(aF);var aC=$("<span class='input-group-btn'>");aA.append(aC).appendTo(aD);az.appendTo(aD);aA.appendTo(aD);$("#form").append(aD)}else{H(aB,al[aE])}}}}}}});var ay=false;if(ay){var av="<tr style='background:#f8f8f8;' id='mvCardNum'><td align='left' class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有主副卡</span></td><td align='left' colspan='3'><input style='margin-top:10px' class='numberTextBox' id='mvCardPhone' type='text'><a href='javascript:void(0)' class='purchase' onclick='order.memberChange.queryMVCard()'>查询</a><a href='javascript:void(0)' class='purchase' onclick='order.memberChange.addMvMember()'>加装主副卡</a></td></tr>";
$tr.after(av)}}$.each(OrderInfo.offer.offerMemberInfos,function(){var aB=$("<div class='form-group'></div>");var az=$("<div class='input-group'>");if(this.offerRoleId==ax.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){var aF=$("<input del='N' knew='N' accessNumber='"+this.accessNumber+"' offerRoleId="+this.offerRoleId+" offerMemberId="+this.offerMemberId+" objType="+this.objType+" objId="+this.objId+" objInstId="+this.objInstId+' id="li_viceCard_new_'+this.accessNumber+'" value='+this.accessNumber+" class='form-control' disabled >");var aC=$("<span id='viceCard_new_"+this.accessNumber+"' class='form-control' style='display:none'>");az.append(aF);az.append(aC);var aA=$("<span class='input-group-btn'>");var aD=$("<button class='btn btn-default' accNbr='"+this.accessNumber+"' type='button'>拆副卡</button>");aD.click(function(){if($("input[id^='li_viceCard_new_"+$(this).attr("accNbr")+"']").attr("del")=="N"){$("input[id^='li_viceCard_new_"+$(this).attr("accNbr")+"']").css("text-decoration","line-through").attr("del","Y").attr("knew","N");$("span[id^='viceCard_new_"+$(this).attr("accNbr")+"']").css("text-decoration","line-through").attr("del","Y").attr("knew","N");$(this).text("不 拆")}else{$("input[id^='li_viceCard_new_"+$(this).attr("accNbr")+"']").css("text-decoration","").attr("del","N").attr("knew","N");$("span[id^='viceCard_new_"+$(this).attr("accNbr")+"']").css("text-decoration","").attr("del","N").attr("knew","N");$(this).text("拆副卡");$("#viceCard_new_"+$(this).find("a").attr("accNbr")).html("")}});aA.append(aD);if(ao){var aE=$("<button class='btn btn-default' accNbr='"+this.accessNumber+"' type='button'>保留>>选择新套餐 </button>");aE.click(function(){order.service.offerDialog("viceCard_new_"+$(this).attr("accNbr"))});aA.append(aE)}az.append(aA).appendTo(aB);au++}az.appendTo(aB);$("#form").append(aB)})}});if(order.memberChange.reloadFlag=="N"){var an=order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;var aq=true;var ar=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;var ap=1;var af=1;var ai=1;order.memberChange.newSubPhoneNum="";order.memberChange.oldSubPhoneNum="";$.each(ar,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="3"){OrderInfo.delViceCard="true";order.memberChange.delmembers.flag=true;order.memberChange.delmembers.accessNumbers.push({nbr:this.busiObj.accessNumber});$("input[id^='li_viceCard_new_"+this.busiObj.accessNumber+"']").css("text-decoration","line-through").attr("del","Y").attr("knew","N");$("span[id^='viceCard_new_"+this.busiObj.accessNumber+"']").css("text-decoration","line-through").attr("del","Y").attr("knew","N")}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){order.memberChange.newmembers.flag=true;OrderInfo.newClothes="true";if(ap==1){order.memberChange.newSubPhoneNum+=this.busiObj.accessNumber;ap++}else{order.memberChange.newSubPhoneNum+=","+this.busiObj.accessNumber}var ay=$("#"+OrderInfo.objInstId).val();$("#"+OrderInfo.objInstId).val((parseInt(ay)+1))}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"){if(this.busiObj.offerTypeCd=="1"){order.memberChange.oldmembers.flag=true;if(af==1){order.memberChange.oldSubPhoneNum+=this.busiObj.accessNumber;af++}else{order.memberChange.oldSubPhoneNum+=","+this.busiObj.accessNumber}if(ai==1){$("#oldphonenum_"+ai).val(this.busiObj.accessNumber)}else{memberChange.addNum(10);$("#oldphonenum_"+ai).val(this.busiObj.accessNumber)}}var az=this.data.ooRoles[0].objInstId;var au=this.busiObj.instId;order.memberChange.oldmembers.objInstId.push({instId:au,objInstId:az})}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="1"){order.memberChange.changemembers.flag=true;order.memberChange.changemembers.accessNumbers.push({nbr:this.busiObj.accessNumber,specId:this.busiObj.objId,name:this.busiObj.objName});var ax=this.busiObj.objId;var aw=this.busiObj.accessNumber;var av=this.busiObj.objName;order.service.choosedOffer("tcnum"+1,ax,"","viceCard_new_"+aw,av)}}}}});order.memberChange.submit()}};function a(ah){var ai=OrderInfo.staff.soAreaId.substring(0,3)+"0000";var af={areaid:ai};$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var ag=$.callServiceAsJsonGet(contextPath+"/token/pc/offer/areaidJurisdiction",af);$.unecOverlay();if(ag.code==0){if(ag.data=="ON"){return true}else{return false}}else{return false}}var H=function(ah,al){if(W>=ah){return}r++;W++;var aj=$("<div class='form-group' id='oldnum_"+r+"'></div>");var ag=$("<div class='input-group'>");var af=$("<label>已有移动电话</label>");var ak=$("<input name='oldphonenum' input value='"+al+"'  readonly='readonly'  id='oldphonenum_"+r+"' class='form-control'>");ag.append(ak);var ai=$("<span class='input-group-btn'>");ag.append(ai).appendTo(aj);af.appendTo(aj);ag.appendTo(aj);$("#form").append(aj)};var K=function(ah){if(W>=ah){return}r++;W++;var aj=$("<div class='form-group' id='oldnum_"+r+"'></div>");var ag=$("<div class='input-group'>");var af=$("<label>已有移动电话</label>");var ak=$("<input name='oldphonenum' id='oldphonenum_"+r+"' class='form-control'>");ag.append(ak);var ai=$("<span class='input-group-btn'>");ai.append("<button class='btn btn-default' type='button' onClick='javascript:order.memberChange.delNum(\"oldnum_"+r+"\");'> - </button>");ag.append(ai).appendTo(aj);af.appendTo(aj);ag.appendTo(aj);$("#form").append(aj)};var i=function(af){W--;$("#"+af).remove()};var aa=[];var t=function(){var ag=$("#mvCardPhone");if(ag.length>0){var ah=$.trim(ag.val());aa=[];var ai=true;if(ah==""){$.alert("提示","请输入电信手机号码!");return false}else{if(!/^(180|189|133|134|153|181|108|170|177)\d{8}$/.test(ah)){$.alert("提示","您输入的不是正确的电信号码,请重新输入！");return false}else{for(var af=0;af<OrderInfo.offer.offerMemberInfos.length;af++){if(ah==OrderInfo.offer.offerMemberInfos[af].accessNumber){$.alert("提示",ah+"号码重复，请重新输入！");ai=false;return false}}}}if(ai){if(G(ah,aa)){f()}}}};var f=function(){OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldMvFlag=false;var ai=OrderInfo.staff.soAreaId;if($("#memberTr").length>0){$("#memberTr").remove()}for(var al=0;al<aa.length;al++){var ah={areaId:ai,acctNbr:aa[al].accNbr,custId:aa[al].custId,curPage:"1",pageSize:"5"};var ao=query.offer.queryProduct(ah);if(ao==undefined){$.alert("提示","产品信息查询失败,查询返回结果【"+ao+"】,请后台核实！");return}else{for(var al=0;al<ao.length;al++){if(ao[al].accNbr==aa[al].accNbr){var aq=ao[al];OrderInfo.oldprodInstInfos.push(aq);_mainProdOfferInstInfos=aq.mainProdOfferInstInfos[0];var am={offerId:_mainProdOfferInstInfos.prodOfferInstId,offerSpecId:_mainProdOfferInstInfos.prodOfferId,acctNbr:ao[al].accNbr,areaId:ao[al].areaId};data=query.offer.queryOfferInst(am);if(data==undefined){return false}var ap=true;if(ec.util.isArray(data.offerMemberInfos)){CacheData.sortOffer(data);var ag=0;var ar=$("<tr id='memberTr'><td align='left' class='borderLTB' colspan='4'><div id='memberDiv'><ul></ul></div></td></tr>");for(var aj=0;aj<data.offerMemberInfos.length;aj++){var ak=data.offerMemberInfos[aj];if(ak.objType==""){$.alert("提示","销售品实例构成 "+ak.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(ak.objType==CONST.OBJ_TYPE.PROD){if(ak.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD&&ak.accessNumber==ao[al].accNbr){$.alert("提示","【"+ak.accessNumber+"】不是主接入号,请重新输入!");return false}if(ak.objId==""){$.alert("提示","销售品实例构成 "+ak.roleName+" 接入产品规格【objId】节点为空，无法继续受理,请营业后台核实");return false}if(ak.accessNumber==""){$.alert("提示","销售品实例构成 "+ak.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}ag++;$memberLi=$("<li><input type='checkbox' checked='true' value=\""+ak.accessNumber+'"><span>'+ak.roleName+ak.accessNumber+"</span></li>");ar.find("ul").append($memberLi)}}if(ak.objInstId==aq.prodInstId){ap=false}}if(ap){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+ao[al].accNbr+"】，无法继续受理，请业务后台核实");return false}else{if(ag>1){OrderInfo.oldMvFlag=true}if(OrderInfo.oldMvFlag){$("#mvCardNum").after(ar)}else{$.alert("提示",aa[al].accNbr+"不是多产品，请选择【已有移动电话】入口纳入!");
return false}var af={offerMemberInfos:data.offerMemberInfos,offerId:_mainProdOfferInstInfos.prodOfferInstId,offerSpecId:_mainProdOfferInstInfos.prodOfferId,offerSpecName:_mainProdOfferInstInfos.prodOfferName};OrderInfo.oldoffer.push(af)}}else{$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");return false}var an=aq.mainProdOfferInstInfos[0].prodOfferId;if(ec.util.isObj(an)){var ah={offerSpecId:an,offerTypeCd:1,partyId:aq.mainProdOfferInstInfos[0].custId,accNbr:ao[al].accNbr};if(!query.offer.queryMainOfferSpec(ah)){return}}}}}}};var Z=function(ag){if(ag==undefined||!ag){ag=_getTestParam()}if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){if(OrderInfo.actionFlag==6){var af=false;if(ag.feeTypeMain=="2100"&&(ag.offerSpec.feeType=="2100"||ag.offerSpec.feeType=="3100"||ag.offerSpec.feeType=="3101"||ag.offerSpec.feeType=="3103")){af=true}else{if(ag.feeTypeMain=="1200"&&(ag.offerSpec.feeType=="1200"||ag.offerSpec.feeType=="3100"||ag.offerSpec.feeType=="3102"||ag.offerSpec.feeType=="3103")){af=true}else{if(ag.feeTypeMain=="1201"&&(ag.offerSpec.feeType=="1201"||ag.offerSpec.feeType=="3101"||ag.offerSpec.feeType=="3102"||ag.offerSpec.feeType=="3103")){af=true}}}if(!af){$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");return}}}$.callServiceAsHtml(contextPath+"/token/app/order/mainsub2",ag,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(ah){if(!ah){$.unecOverlay();ah.data="查询失败,稍后重试"}if(ah.code!=0){$.unecOverlay();$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=ag.actionFlag;OrderInfo.actionFlag=ag.actionFlag;if(OrderInfo.actionFlag==2){setTimeout(function(){$.unecOverlay();offerChange.fillOfferChange(ah,ag)},800)}else{if(OrderInfo.actionFlag==21){order.memberChange.fillmemberChange(ah,ag)}else{$.unecOverlay();order.main.callBackBuildView(ah,ag)}}}})};var J=function(){OrderInfo.choosedNumList=[];OrderInfo.viceOffer=[];OrderInfo.viceprodInstInfos=[];OrderInfo.hasMainCarFlag=false;if($("#memberTr").length>0){$("#memberTr").find("input[type='checkbox']:checked").each(function(){var al=$(this).val();OrderInfo.choosedNumList.push({accNbr:al,custId:aa[0].custId})})}if(OrderInfo.choosedNumList.length==0){$.alert("提示","请选择需要加装的号码！");return}var ak=OrderInfo.choosedNumList.length;var ag=q(ak);if(ag){for(var ah=0;ah<OrderInfo.oldoffer.length;ah++){var ai=OrderInfo.oldoffer[ah];var aj=[];$.each(ai.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){for(var al=0;al<OrderInfo.choosedNumList.length;al++){if(this.accessNumber==OrderInfo.choosedNumList[al].accNbr){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||this.roleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){OrderInfo.hasMainCarFlag=true}aj.push(this)}}}});var af={offerMemberInfos:aj,offerId:ai.offerId,offerSpecId:ai.offerSpecId,offerSpecName:ai.offerSpecName};OrderInfo.viceOffer.push(af)}if(ac()){D()}}};var q=function(ag){var af=true;$.each(OrderInfo.offerSpec.offerRoles,function(){var ai=this;if(ai.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var ah=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ai.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){ah++}});$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var aj=this.maxQty<0?"不限制":this.maxQty;if(aj>0&&(aj-ah-ag)<0){$.alert("提示","加装数量已经超过能加装的最大数量【"+aj+"】!");af=false;return false}}})}});return af};var o=function(){var ai=true;$("input[name='oldphonenum']").each(function(){var ak=$.trim($(this).val());if(ec.util.isObj(ak)){if(ec.util.isArray(OrderInfo.oldAddNumList)){if(!ai){return false}$.each(OrderInfo.oldAddNumList,function(){if(ak==this.accNbr){ai=false;$.alert("提示",ak+"重复，请重新输入！");return false}});if(ai){OrderInfo.oldAddNumList.push({accNbr:ak})}}else{OrderInfo.oldAddNumList.push({accNbr:ak})}}});if(!ai){return false}if(OrderInfo.oldAddNumList.length==0){$.alert("提示","请输入手机号码!");return false}var aj=true;for(var ah=0;ah<OrderInfo.oldAddNumList.length;ah++){for(var af=0;af<OrderInfo.offer.offerMemberInfos.length;af++){if(OrderInfo.oldAddNumList[ah].accNbr==OrderInfo.offer.offerMemberInfos[af].accessNumber){$.alert("提示",OrderInfo.oldAddNumList[ah].accNbr+"号码重复，请重新输入！");aj=false;return false}}if(OrderInfo.provinceInfo.mergeFlag=="0"){aj=G(OrderInfo.oldAddNumList[ah].accNbr,aa);if(!aj){break}}else{var ag=OrderInfo.staff.soAreaId;aj=cust.queryCustCompreInfo(OrderInfo.oldAddNumList[ah].accNbr,ag,3,"OLD");if(!aj){break}}}if(aj){if(OrderInfo.provinceInfo.mergeFlag=="0"){return e()}else{if(q(order.memberChange.viceCartNum)){return L()}}}};var G=function(ag,ah){var aj={acctNbr:ag,identityCd:"",identityNum:"",partyName:"",diffPlace:"local",areaId:OrderInfo.staff.soAreaId,queryType:"",queryTypeValue:"",prodClass:"12"};var af=$.callServiceAsJson(contextPath+"/app/cust/queryoffercust",aj,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});if(af.code==0){$.unecOverlay();if(af.data.custInfos.length==0){$.alert("提示","抱歉，没有定位到"+ag+"客户，请尝试其他客户。");return false}var ai=af.data.custInfos[0].custId;if(ai!=OrderInfo.cust.custId){$.alert("提示",ag+"和主卡的客户不一致！");return false}ah.push({accNbr:ag,custId:ai})}else{$.unecOverlay();$.alertM(af.data);return false}return true};var ac=function(){var al=true;for(var ak=0;ak<OrderInfo.oldprodInstInfos.length;ak++){var aj=OrderInfo.oldprodInstInfos[ak];for(var ai=0;ai<OrderInfo.choosedNumList.length;ai++){var ag=OrderInfo.choosedNumList[ai].accNbr;if(aj.accNbr==ag){OrderInfo.viceprodInstInfos.push(aj)}else{var af={areaId:aj.areaId,acctNbr:OrderInfo.choosedNumList[ai].accNbr,custId:OrderInfo.choosedNumList[ai].custId,curPage:"1",pageSize:"5"};var an=query.offer.queryProduct(af);if(an==undefined){return}else{for(var ah=0;ah<an.length;ah++){if(an[ah].accNbr==ag){var am=an[ah];if(am.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){al=false;$.alert("提示",OrderInfo.choosedNumList[ah].accNbr+"不是在用产品！");return}if(am.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){al=false;$.alert("提示",OrderInfo.choosedNumList[ah].accNbr+"和主卡的付费类型不一致！");return}if(am.productId==CONST.PROD_SPEC.DATA_CARD){al=false;$.alert("提示",OrderInfo.choosedNumList[ah].accNbr+"是无线宽带，不能纳入！");return}OrderInfo.viceprodInstInfos.push(am);break}}}}}}return al};var e=function(){var af=true;for(var ai=0;ai<aa.length;ai++){var al={};al.custId=aa[ai].custId;al.acctNbr=aa[ai].accNbr;al.areaId=OrderInfo.staff.soAreaId;al.pageSize="";al.curPage="";al.DiffPlaceFlag="local";if(al.custId==null||al.custId==""){af=false;$.alert("提示",aa[ai].accNbr+"无法查询已订购产品");return false}var ag=$.callServiceAsJson(contextPath+"/app/cust/offerorderprod",al,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});if(ag.code==0){$.unecOverlay();var ak=ag.data;if(!ec.util.isArray(ak)){$.alert("提示",aa[ai].accNbr+"无法查询已订购产品");return false}for(var ah=0;ah<ak.length;ah++){if(ak[ah].accNbr==aa[ai].accNbr){var aj=ak[ah];aj.custId=aa[ai].custId;if(aj.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){af=false;$.alert("提示",aa[ai].accNbr+"不是在用产品！");return false}if(aj.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){af=false;$.alert("提示",aa[ai].accNbr+"和主卡的付费类型不一致！");return false}if(aj.productId=="280000000"){$.alert("提示",aa[ai].accNbr+"是无线宽带，不能纳入！");return false}OrderInfo.oldprodInstInfos.push(aj);break}}}else{af=false;$.unecOverlay();$.alertM(ag.data);return false}}if(af){return B()}};var L=function(){var af=true;for(var ag=0;ag<OrderInfo.oldprodInstInfos.length;ag++){var ai=OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferId;if(ec.util.isObj(ai)){var ah={offerSpecId:ai,offerTypeCd:1,partyId:OrderInfo.oldprodInstInfos[ag].custId,accNbr:OrderInfo.oldprodInstInfos[ag].accNbr};if(!query.offer.queryMainOfferSpec(ah)){af=false;return false}}}if(af){return D()}};var B=function(){var am=true;var ak=0;var ao=[];for(var an=0;an<OrderInfo.oldprodInstInfos.length;an++){if(ec.util.isArray(ao)){for(var aj in ao){if(OrderInfo.oldprodInstInfos[an].accNbr==ao[aj].accessNumber){$.alert("提示","号码【"+OrderInfo.oldprodInstInfos[an].accNbr+"】与【"+ao[aj].accNbr+"】为同一套餐下的实例成员，不能重复加装!");return false}}}var ag={offerId:OrderInfo.oldprodInstInfos[an].mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:OrderInfo.oldprodInstInfos[an].mainProdOfferInstInfos[0].prodOfferId,acctNbr:OrderInfo.oldprodInstInfos[an].accNbr,areaId:OrderInfo.oldprodInstInfos[an].areaId,distributorId:""};
var ai=query.offer.queryOfferInst(ag);if(ai&&ai.code==CONST.CODE.SUCC_CODE){var al=true;if(ec.util.isArray(ai.offerMemberInfos)){CacheData.sortOffer(ai);var ap=0;for(var aj=0;aj<ai.offerMemberInfos.length;aj++){var ah=ai.offerMemberInfos[aj];ah.prodClass=OrderInfo.oldprodInstInfos[an].prodClass;if(ah.objType==""){am=false;$.alert("提示","销售品实例构成 "+ah.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(ah.objType==CONST.OBJ_TYPE.PROD){if(ah.accessNumber==""){am=false;$.alert("提示","销售品实例构成 "+ah.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}ap++;ak++;ao.push({accNbr:OrderInfo.oldprodInstInfos[an].accNbr,accessNumber:ah.accessNumber})}}if(ah.objInstId==OrderInfo.oldprodInstInfos[an].prodInstId){al=false}}if(al){am=false;$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+OrderInfo.oldprodInstInfos[an].accNbr+"】，无法继续受理，请业务后台核实");return false}var af={offerMemberInfos:ai.offerMemberInfos,offerId:OrderInfo.oldprodInstInfos[an].mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:OrderInfo.oldprodInstInfos[an].mainProdOfferInstInfos[0].prodOfferId,offerSpecName:OrderInfo.oldprodInstInfos[an].mainProdOfferInstInfos[0].prodOfferName,accNbr:OrderInfo.oldprodInstInfos[an].accNbr};OrderInfo.oldoffer.push(af)}else{am=false;$.alert("提示",OrderInfo.oldprodInstInfos[an].accNbr+"查询销售品实例构成，没有返回成员实例无法继续受理");return false}}}if(am&&q(ak)){return L()}};var D=function(){var ag=true;OrderInfo.boProd2OldTds=[];if(ec.util.isArray(OrderInfo.viceprodInstInfos)&&OrderInfo.oldMvFlag){var af={};for(var ah=0;ah<OrderInfo.viceOffer.length;ah++){$.each(OrderInfo.viceOffer[ah].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){af.prodInstId=this.objInstId;af.accNbr=this.accessNumber;var ak=query.prod.getTerminalInfo(af);if(ak==undefined){ag=false;return false}k(this.offerId,this.objInstId,ak);if(ak.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}}})}}else{$.each(OrderInfo.oldoffer,function(){var al=this;var ak={};$.each(al.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){ak.prodInstId=this.objInstId;ak.accNbr=this.accessNumber;var am=query.prod.getTerminalInfo(ak);if(am==undefined){ag=false;return false}k(this.offerId,this.objInstId,am);if(am.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}}})})}if(ag){var aj=true;if(OrderInfo.order.soNbr==null||OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}for(var ah=0;ah<OrderInfo.oldprodInstInfos.length;ah++){var af=OrderInfo.oldprodInstInfos[ah];if(af==undefined||af.prodInstId==undefined){aj=false;$.alert("提示",OrderInfo.oldprodInstInfos[ah].accNbr+"未获取到老用户产品相关信息，无法办理二次业务！");return false}var ai={areaId:af.areaId,acctNbr:af.accNbr,custId:af.custId,soNbr:OrderInfo.order.soNbr,instId:af.prodInstId,type:"2"};if(!Y(ai,af)){aj=false;return false}}if(aj){return x()}}};var k=function(af,ah,ag){var ai={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:ag.couponId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:ag.couponInsNumber,terminalCode:ag.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:ah,offerId:af,state:"DEL",relaSeq:"",id:0,isOld:"T",is4GCard:ag.is4GCard};OrderInfo.boProd2OldTds.push(ai)};var Y=function(ak,af){if(ec.util.isArray(OrderInfo.viceprodInstInfos)&&OrderInfo.oldMvFlag){for(var aj=0;aj<OrderInfo.viceOffer.length;aj++){if(ec.util.isArray(OrderInfo.viceOffer[aj].offerMemberInfos)){var ag=true;$.each(OrderInfo.viceOffer[aj].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.accessNumber==af.accNbr){instflag=false;ag=false;return}});if(ag){return query.offer.invokeLoadInst(ak)}else{var ah=true;$.each(OrderInfo.viceOffer[aj].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){ak.acctNbr=this.accessNumber;ak.instId=this.objInstId;if(!query.offer.invokeLoadInst(ak)){ah=false;return false}}});return ah}}else{$.alert("提示","没有选择需要加装的副卡,全量查询失败！");return false}}}else{for(var ai=0;ai<OrderInfo.oldoffer.length;ai++){if(OrderInfo.oldoffer[ai].accNbr==af.accNbr){if(ec.util.isArray(OrderInfo.oldoffer[ai].offerMemberInfos)){var ag=true;$.each(OrderInfo.oldoffer[ai].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.accessNumber==af.accNbr){instflag=false;ag=false;return}});if(ag){return query.offer.invokeLoadInst(ak)}else{var ah=true;$.each(OrderInfo.oldoffer[ai].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){ak.acctNbr=this.accessNumber;ak.instId=this.objInstId;if(!query.offer.invokeLoadInst(ak)){ah=false;return false}}});return ah}}else{return query.offer.invokeLoadInst(ak)}}}}};var x=function(){var af=true;for(var ai=0;ai<OrderInfo.oldprodInstInfos.length;ai++){var aj=OrderInfo.oldprodInstInfos[ai];var an={boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:aj.mainProdOfferInstInfos[0].prodOfferInstId,prodId:aj.prodInstId};if(aj.mainProdOfferInstInfos[0].prodOfferId!=""){an.specId=aj.mainProdOfferInstInfos[0].prodOfferId}var al=[];al.push(an);var ak={areaId:OrderInfo.staff.soAreaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:aj.custId,soNbr:OrderInfo.order.soNbr,boInfos:al,prodInfo:aj};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var ah=$.callServiceAsJson(contextPath+"/rule/prepare",ak);$.unecOverlay();if(ah!=undefined&&ah.code==0){var am=ah.data;if(am==null){af=false;$.alert("提示","规则校验异常，请联系管理人员！");return false}if(am.ruleType=="portal"){if(am.resultCode=="0"){af=false;$.alert("提示",am.resultMsg);return false}}var ag=am.result.resultInfo;if(ag!=undefined&&ag.length>0){$.each(ag,function(ap,ao){$("<tr><td>"+ao.resultCode+"</td><td>"+ao.ruleDesc+"</td><td>"+rule.rule.getRuleLevelName(ao.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+rule.rule.getRuleImgClass(ao.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});easyDialog.open({container:"ruleDiv"});af=false;return false}}else{af=false;$.alertM(ah.data);return false}}if(af){return true}};var ad=function(){};var N=function(){OrderInfo.actionFlag==6;OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldAddNumList=[];OrderInfo.oldMvFlag=false;OrderInfo.hasMainCarFlag=true;aa=[];OrderInfo.oldprodAcctInfos=[];OrderInfo.choosedNumList=[];var af=$("input[id^='li_viceCard_new']");var ap=false;for(var au=0;au<af.length;au++){if($(af[au]).attr("del")=="Y"||$(af[au]).attr("knew")=="Y"){ap=true;break}}var aj=0;$.each(Q,function(){aj=aj+Number($("#"+this).val())});var ao=0;$("input[name='oldphonenum']").each(function(){if(this.value!=null&&this.value!=""&&this.value.length==11){ao+=1}});var av=Number($("#"+OrderInfo.objInstId).val());if(ao+av>O){$.alert("提示","加装副卡和纳入老成员数量超过最大值"+O);return}if(!(ap)&&aj<=0&&ao<=0){$.alert("提示","没有对副卡进行操作。");return}var ai={type:1,boActionTypeName:"主副卡成员变更",offerNum:1,actionFlag:6};if(aj>0){OrderInfo.newClothes="true";var ak=order.prodModify.choosedProdInfo;var ax=[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:ak.prodOfferInstId,specId:ak.prodOfferId,prodId:I.objInstId}];var aq={prodId:ak.prodInstId,acctNbr:ak.accNbr,prodSpecId:ak.productId,areaId:ak.areaId};var ar=query.offer.queryProdInstParam(aq);if(ar&&ar.prodSpecParams){OrderInfo.prodInstAttrs=ar.prodSpecParams}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");ai.newviceCardNum=parseInt(aj);ai.feeTypeMain=ak.feeType;ai.custId=OrderInfo.cust.custId;ai.access=I.accessNumber;ai.newofferSpec=OrderInfo.offerSpec;ai.newClothes="true";order.service.setOfferSpec();if(rule.rule.ruleCheck(ax)){}else{$.alert("提示：","规则校验不通过");return}}else{ai.newClothes="false"}if(ao>0){OrderInfo.oldMember="true";order.memberChange.queryofferinfo();OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
ai.oldviceCardNum=parseInt(OrderInfo.oldAddNumList.length);ai.oldofferSpec=OrderInfo.oldofferSpec;ai.prodInstInfos=OrderInfo.oldprodInstInfos;ai.offer=OrderInfo.oldoffer;ai.oldMember="true";var ak=order.prodModify.choosedProdInfo;var ax=[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:ak.prodOfferInstId,specId:ak.prodOfferId,prodId:I.objInstId}];if(rule.rule.ruleCheck(ax)){}else{$.alert("提示：","规则校验不通过");return}}else{ai.oldMember="false"}if(ap){OrderInfo.delViceCard="true";ai.delViceCard="true";var am=[];$.each(af,function(aA,az){if($(this).attr("knew")=="Y"||$(this).attr("del")=="Y"){am.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerRoleId:$(this).attr("addRoleId"),offerSpecId:$(this).attr("addSpecId"),offerMemberId:$(this).attr("offerMemberId"),del:$(this).attr("del"),accessNumber:$(this).attr("accessNumber"),offerSpecName:$(this).attr("addSpecName"),roleName:"基础移动电话",knew:$(this).attr("knew")})}});var ah=[];$.each(af,function(aA,az){if($(this).attr("del")=="Y"||$(this).attr("knew")=="Y"){ah.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerMemberId:$(this).attr("offerMemberId"),offerRoleId:$(this).attr("offerRoleId"),state:"DEL"})}});if(OrderInfo.newClothes=="false"&&OrderInfo.oldMember=="false"){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3")}var ag="removeProd";var al=CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;var aw={boActionTypeCd:al,boActionTypeName:CONST.getBoActionTypeName(al),submitFlag:ag,viceParam:am,ooRoles:ah};var an={areaId:OrderInfo.staff.areaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,boInfos:[]};an.boInfos=ax;if(b()){if(rule.rule.ruleCheck(ax)){if(!l("delViceCard")){return}var ay=order.prodModify.choosedProdInfo;ai.boActionTypeCd=al;ai.delViceCardboActionTypeName=CONST.getBoActionTypeName(al);ai.prodId=ay.prodInstId;ai.offerMembers=OrderInfo.offer.offerMemberInfos;ai.oldOfferSpecName=ay.prodOfferName;ai.prodClass=ay.prodClass;ai.appDesc=CONST.getAppDesc();ai.submitFlag=ag;ai.viceParam=am;ai.ooRoles=ah}else{$.alert("提示：","规则校验不通过");return}}else{var at=rule.rule.prepare(an,"order.prodModify.commonPrepare",aw);if(at){return}}}else{ai.delViceCard="false"}order.main.buildMainView(ai);order.memberChange.closeDialog()};var l=function(af){return prod.uim.setProdUim(af)};var b=function(){var ah={code:"old_memberchange"};var ag=contextPath+"/order/getSimulateData";$.ecOverlay("<strong>正在查询公共数据查询的服务中,请稍后....</strong>");var af=$.callServiceAsJsonGet(ag,ah);$.unecOverlay();if(af.code==0){if(af.data!=undefined){if("Y"==af.data){return false}}}return true};var F=function(ag,ak,aj,af){if(OrderInfo.oldMember=="true"||OrderInfo.newClothes=="true"){$("#member_prepare").hide();if(OrderInfo.delViceCard=="true"){$("#offerspecContent").show()}}else{$("#member_prepare").show();SoOrder.initFillPage();$("#member_prepare").html(ag.data)}$("#fillNextStep").off("click").on("click",function(){OrderInfo.viceParam=ak;if(!SoOrder.checkData()){return false}$("#order-content").hide();$("#order-dealer").show();order.dealer.initDealer()});$("#fillNextStepSub").off("click").on("click",function(){V(ak)});var ah=order.prodModify.choosedProdInfo;var ai=false;$.each(ak.viceParam,function(){var at=this.objInstId;var an={areaId:OrderInfo.getProdAreaId(at),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:at,prodSpecId:this.objId,offerSpecId:ah.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var av=query.offer.queryChangeAttachOffer(an,aj,af);$("#attach_"+at).html(av);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){an.queryType="1,2";an.objId=this.objId;an.objType=this.objType;an.memberRoleCd="400";an.offerSpecId=this.offerSpecId;var ar=query.offer.queryDefMustOfferSpec(an,aj,"sign");CacheData.parseOffer(ar,at);var ar=query.offer.queryServSpec(an,aj,"sign");CacheData.parseServ(ar,at,"delViceCard")}AttachOffer.showMainMemberRoleProd(at);AttachOffer.changeLabel(at,this.objId,"");if(AttachOffer.isChangeUim(at,"delViceCard")){if(!ai){$("#uimDiv_"+at).show();var aq=CacheData.getOfferMember(at);if(aq!=null&&aq!=undefined&&aq!=""&&aq!="null"){if(OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""&&OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!="null"){var ay=OrderInfo.mktResInstCode.split(",");for(var ax=0;ax<ay.length;ax++){if(ay[ax]!=""&&ay[ax]!=null&&ay[ax]!="null"){var am=ay[ax].split("_");var aw=am[0];var au=am[1];if(aq==aw){$("#uim_txt_"+at).attr("disabled",true);var ap={instCode:au};var ao=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",ap);if(ao.code==0){if(ao.data.mktResBaseInfo){if(ao.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_"+at).attr("disabled",true);$("#uim_check_btn_"+at).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+at).attr("disabled",false);$("#uim_release_btn_"+at).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+at).val(au);var al={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:ao.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:ao.data.mktResBaseInfo.qty,storeId:ao.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:au,terminalCode:au,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-(n+1),offerId:offerId,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(at);OrderInfo.boProd2Tds.push(al)}else{$.alert("提示","UIM卡不是预占状态，当前为"+ao.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(ao.code==-2){$.alertM(ao.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}}}}else{$("#uimDiv_"+at).hide()}}ai=true});order.dealer.initDealer(2);if(OrderInfo.newClothes=="true"||OrderInfo.oldMember=="true"){$("#member_prepare").hide()}else{$("#member_prepare").show()}};var R=function(){if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){order.prodModify.dialogForm.close(order.prodModify.dialog)}};var V=function(af){var ag=[];var ah=[];var ai=[];ag=af.viceParam;ah=af.ooRoles;ai={viceParam:ag,ooRoles:ah,remark:$("#order_remark").val()};SoOrder.submitOrder(ai)};function U(){var af=OrderInfo.provinceInfo.provIsale;var ag={provTransId:af};$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var ah=$.callServiceAsJsonGet(contextPath+"/accessToken/queryOrderInfos",ag);$.unecOverlay();if(ah.code==0){order.memberChange.rejson=ah.data;return true}else{if(ah.code==1002){$.alert("错误",ah.data);return false}else{$.alertM(ah.data);return false}}}var h=function(ag,ai){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.cust.areaId;var af=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;P(af,ai,ag.prodInstId);z(af,ai,ag);var ah=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(ah==undefined){return false}if(ah.resultCode==0&&ec.util.isObj(ah.result)){offerChange.resultOffer=ah.result}else{$.alert("预校验规则限制",ah.resultMsg);offerChange.resultOffer={};return false}return true};var P=function(ag,ah,af){ah.offerTypeCd=1;ah.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;OrderInfo.getOfferBusiOrder(ag,ah,af)};var z=function(am,ao,al){var ag=OrderInfo.offerSpec;var an=ae();if(an==undefined){alert("错误提示","无法加装到该套餐");return false}var af={areaId:OrderInfo.getProdAreaId(al.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.SEQ.offerSeq--,objId:ag.offerSpecId,offerTypeCd:"1",accessNumber:al.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};if(ec.util.isArray(ao.offerMemberInfos)){af.data.ooRoles=[];
$.each(ao.offerMemberInfos,function(){var ap={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerRoleId:an.offerRoleId,state:"ADD"};if(this.objType!=CONST.OBJ_TYPE.PROD){ap.prodId=prodId}af.data.ooRoles.push(ap)})}if(ec.util.isArray(ag.offerSpecParams)){af.data.ooParams=[];for(var aj=0;aj<ag.offerSpecParams.length;aj++){var ah=ag.offerSpecParams[aj];var ai={itemSpecId:ah.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:ah.offerSpecParamId,value:ah.value,state:"ADD"};af.data.ooParams.push(ai)}}if(ag.ooTimes!=undefined){af.data.ooTimes=[];af.data.ooTimes.push(ag.ooTimes)}af.data.busiOrderAttrs=[];var ak=$("tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(ak!=undefined){ak.each(function(){var ap={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};af.data.busiOrderAttrs.push(ap)})}am.push(af)};var ae=function(){for(var ah=0;ah<OrderInfo.offerSpec.offerRoles.length;ah++){var ai=OrderInfo.offerSpec.offerRoles[ah];if(ai.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return ai}}for(var ah=0;ah<OrderInfo.offerSpec.offerRoles.length;ah++){var ai=OrderInfo.offerSpec.offerRoles[ah];for(var ag=0;ag<ai.roleObjs.length;ag++){var af=ai.roleObjs[ag];if(af.objType==CONST.OBJ_TYPE.PROD){return ai}}}};var x=function(ah,ag){if(!query.offer.loadInst()){return false}if(ah==undefined){return true}var af={areaId:OrderInfo.staff.soAreaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,boInfos:ah,prodInfo:order.prodModify.choosedProdInfo};$.callServiceAsHtml(contextPath+"/app/rule/prepare",af,{before:function(){$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>")},done:function(ai){setTimeout(function(){$.unecOverlay();var aj=ai.data;if(typeof(ag)=="function"){ag(aj)}},800)}})};var j=function(af){if(af>0){var ah={prodId:prod.prodInstId,acctNbr:prod.accNbr,prodSpecId:prod.productId,areaId:prod.areaId};var ag=query.offer.queryProdInstParam(ah);if(ag&&ag.prodSpecParams){OrderInfo.prodInstAttrs=ag.prodSpecParams}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");ah={memberChange:"Y",type:1,boActionTypeName:"主副卡成员变更",viceCardNum:parseInt(af),feeTypeMain:prod.feeType,offerNum:1,custId:OrderInfo.cust.custId,actionFlag:6,access:I.accessNumber,offerSpec:OrderInfo.offerSpec};order.service.setOfferSpec();rule.rule.ruleCheck(boInfos,function(ai){order.main.buildMainView(ah)})}};var u=function(ah){var ai={prodSpecId:ah};var ag=contextPath+"/mktRes/uim/getMktResCd";$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");var af=$.callServiceAsJson(ag,ai);$.unecOverlay();if(af.code=="0"){return af.data}else{return""}};var T=function(aj){var ai=(Math.abs(aj)-1);if(AttachOffer.openServList.length>ai){var ah=AttachOffer.openServList[ai].servSpecList;for(var ag=0;ag<ah.length;ag++){var af=ah[ag];if(af.isdel!="Y"&&af.isdel!="C"){if(af.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true}}}}return false};var g=function(ak,ah,ag){var aq=OrderInfo.getAccessNumber(ak,ah,ag);var ai="-1";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(aq==""){$.alert("提示","校验UIM卡前请先选号!");return false}}if(OrderInfo.actionFlag==6){if(ah!=undefined&&ah=="oldmember"){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==ak){ai=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{if(ah!=undefined&&ah=="newmember"){ai=order.prodModify.choosedProdInfo.prodOfferInstId}}}var ap=$.trim($("#uim_txt_"+ak).val());if(ap==undefined||ap==""){$.alert("提示","UIM卡不能为空!");return false}var al={instCode:ap,phoneNum:aq,areaId:OrderInfo.getProdAreaId(ak)};var am=OrderInfo.getProdSpecId(ak);var ao="";if(CONST.getAppDesc()==0){if(T(ak)){ao=u(CONST.PROD_SPEC_ID.MIFI_ID)}else{ao=u(am)}if(ec.util.isObj(ao)){}else{$.alert("提示","查询卡类型失败！");return}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(prod.changeUim.is4GProdInst){al.onlyLTE="1"}}}var aj=query.prod.checkUim(al);if(aj==undefined||aj.baseInfo==undefined){return false}var an=aj.baseInfo.qty;if(an==undefined||an==null){an=1}var af={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:aj.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:an,storeId:aj.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:aj.baseInfo.mktResInstCode,terminalCode:aj.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:ak,offerId:ai,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){af.cardTypeFlag=aj.baseInfo.cardTypeFlag}$("#uim_check_btn_"+ak).attr("disabled",true);$("#uim_release_btn_"+ak).attr("disabled",false);$("#uim_txt_"+ak).attr("disabled",true);if(T(ak)){$("#isMIFI_"+ak).val("yes")}else{$("#isMIFI_"+ak).val("no")}OrderInfo.clearProdUim(ak);OrderInfo.boProd2Tds.push(af);if(OrderInfo.actionFlag==22&&aj.baseInfo.cardTypeFlag==1){AttachOffer.queryCardAttachOffer(aj.baseInfo.cardTypeFlag)}};var s=function(ah){if(offerChange.resultOffer==undefined){return}var af=offerChange.resultOffer.prodInfos;if(ec.util.isArray(af)){$.each(af,function(){var al=this.accProdInstId;var ak=true;$.each(ah.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==al){ak=false;return false}});if(ak){return true}if(al!=this.prodInstId){var am=CacheData.getServ(al,this.prodInstId);if(this.state=="DEL"){if(am!=undefined){var aj=$("#li_"+al+"_"+this.prodInstId).find("span");aj.addClass("del");am.isdel="Y";$("#del_"+al+"_"+this.prodInstId).hide()}}else{if(this.state=="ADD"){if(am!=undefined){$("#del_"+al+"_"+this.prodInstId).hide()}else{var ai=CacheData.getServSpec(al,this.productId);if(ai!=undefined){$("#del_"+al+"_"+this.productId).hide()}else{if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(al,this.productId)}}}}}}})}var ag=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(ag)){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){var ai=this.objInstId;$.each(ag,function(){if(this.memberInfo==undefined){return true}var al=CacheData.getOffer(ai,this.prodOfferInstId);var ak=true;$.each(this.memberInfo,function(){if(ai==this.accProdInstId){if(ec.util.isObj(al)){this.prodId=this.accProdInstId}ak=false;return false}});if(ak){return true}if(this.state=="DEL"){if(al!=undefined){var aj=$("#li_"+ai+"_"+this.prodOfferInstId).find("span");aj.addClass("del");al.isdel="Y";if(this.isRepeat!="Y"){this.isRepeat="Y"}else{al.isRepeat="Y"}$("#del_"+ai+"_"+this.prodOfferInstId).hide()}}else{if(this.state=="ADD"){if(al!=undefined){$("#del_"+ai+"_"+this.prodOfferInstId).hide()}else{var am=CacheData.getOfferSpec(ai,this.prodOfferId);if(am!=undefined){$("#del_"+ai+"_"+this.prodOfferId).hide()}else{if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(ai,this.prodOfferId)}}}}}})})}}};return{init:X,mktResInstCode:E,queryMVCard:t,addMvMember:J,closeDialog:R,submit:N,offerProd:I,ischooseOffer:w,removeAndAdd:V,queryofferinfo:o,addNum:K,checkOrder:h,checkOfferProd:s,getSimulateData:b,fillmemberChange:F,delNum:i,reloadFlag:d,newSubPhoneNum:v,oldSubPhoneNum:S,newmembers:y,oldmembers:c,delmembers:C,changemembers:A,rejson:p,subPage:m,checkUim:g}}();$(function(){$("#memeberChangeclose").click(function(){order.memberChange.closeDialog()});$("#memeberChange .btna_o:first").click(function(){$("#memeberChange .btna_o:first").removeClass("btna_o").addClass("btna_g");order.memberChange.submit();$("#memeberChange .btna_g:first").removeClass("btna_g").addClass("btna_o")});$("#memeberChange .btna_o:last").click(function(){order.memberChange.closeDialog()})});