CommonUtils.regNamespace("CONST");CONST=(function(){var f=-1;var s="10000";var z="20020054";var F={FOUR_G:11,APP:15,LTE:10,UI_LTE:8,ZDYY:14};var W={FLOW:"100",SERV:"10000"};var c={CDMA:235010000,DATA_CARD:280000000,PROD_FUN_4G:"280000020"};var Q={MIFI_ID:"235010076",WIRE_GLOBAL:"13409441"};var i={FEE_TYPE:"10020030",IS_XINKONG:"40010030",PROD_USER:"800000011"};var u={IS_XINKONG_YES:"20",IS_XINKONG_NO:"10"};var O={CREDIT_LIMIT:"30010040",PROTOCOL_NBR:"30020008"};var S={UIM_CHARGE_ITEM_CD:"2014000"};var L={THREE:3,FOUR:4};var M={MUST:"1000",SELECT:"1001",ZDYY:"100004"};var l={CLOSE:"1000",KIP:"1001",CHOOSE:"1002"};var A={REMOVE_PROD:110000,NORMAL_PROD:100000,STOP_PROD:120000,READY_PROD:140001,DONE_PROD:140002,NEW_PROD:130000};var h={AFTER_PAY:1200,BEFORE_PAY:2100,NOLIMIT_PAY:3100,BEFORE_AFTER_PAY:2101,BEFORE_AFTER_QUASIREALTIME_PAY:3103,QUASIREALTIME_AFTER_PAY:3102,AFTER_BEFORE_PAY:1202,QUASIREALTIME_BEFORE_PAY:3101,QUASIREALTIME_PAY:1201};var a={CUST_ACTION:1000,ACCT_ACTION:1100,OFFER_ACTION:1200,PROD_ACTION:1300,MKTRES_ACTION:1600};var m={PROD:2,FUN_PROD:4,SERV:4,OFFER:7};var n={BUY_OFFER:"S1",DEL_OFFER:"S2",ADDOREXIT_COMP:"S3",UPDATE_OFFER:"S3",CUST_CREATE:"C1",CUSTINFOMODIFY:"C2",ACCT_CREATE:"A1",ACCTINFOMODIFY:"A2",NEW_PROD:"1",UPDATE_ACCNBR:"2",REMOVE_PROD:"3",PREMOVE_PROD:"4020200000",SERV_OPEN:"7",PREMOVE_BACK_PROD:"4070100003",BREAK_RULE_REMOVE_PROD:"4020300002",OWE_REMOVE_PROD:"66",NOACTIVE_REMOVE_PROD:"4020400000",DIFF_AREA_CHANGE_CARD:"4040600001",CHANGE_CARD:"14",LOSSREP_PROD:"1171",DISLOSSREP_PROD:"1172",STOPKEEPNUM:"19",DISSTOPKEEPNUM:"20",PRODUCT_PASSWORD:"18",PRODUCT_PASSWORD_RESET:"4040800003",PRODUCT_PARMS:"1179",PRODUCT_INFOS:"4040100000",TRANSFER:"11",ACTIVERETURN:"1020500000",TRANSFERRETURN:"4041700000",ACTIVERETURNTWO:"4070400000",CHANGE_ACCOUNT:"-6",ADD_COMP:"998",REMOVE_COMP:"999",COUPON_SALE:"3010200000",RETURN_COUPON:"3030300000",EXCHANGE_COUPON:"4040800002",CHANGE_FEE_TYPE:"1244",BUY_BACK:"5010100002",BUY_BACK_CHANGE_CARD:"7040100001",BUY_BACK_ORDER_CONTRACT:"3030200000",TERMINAL_RESERVATION:"3010300000",RETURN_TERMINAL:"3030400000"};var v={S1:"订购","1":"新装","3":"拆机","4020300002":"违章拆机","66":"欠费拆机","4020400000":"未激活拆机","1171":"挂失","1172":"解挂","19":"停机保号","20":"停机保号复机","18":"产品密码修改","4040800003":"产品密码重置",C1:"新建客户",C2:"修改客户信息","1179":"修改产品属性",S3:"主副卡成员变更","11":"过户","1020500000":"改客户资料返档","4041700000":"过户返档","-6":"改帐务定制关系",A2:"修改帐户信息","4020200000":"预拆机","4070100003":"预拆机复机","5010100002":"新装返销","2":"改号","7040100001":"补换卡返销","3030200000":"订购合约返销"};var d={OFFER_BUY:"订购销售品",OFFER_DEL:"退订销售品",OFFER_UPDATE:"变更销售品 ",PROD_NEW:"新装",PROD_UPDATE:"变更功能产品",PROD_OPEN:"开通功能产品",PROD_CLOSE:"关闭功能产品"};var r={REMOVE_REASON:"111111122",DEALER:"111111116",DEALER_NAME:"111111120",DEALER_CODE:"111111125",REMARK:"111111118",orderAttrName:"30010020",orderAttrPhoneNbr:"30010025",orderIdentidiesTypeCd:"30010026",orderAttrIdCard:"30010021",orderAttrAddr:"30010022",EXT_CUST_ID:"20900011",COR_CUST_ID:"30010027",EXT_PROD_INST_ID:"30010045",COR_PROD_INST_ID:"30010044",EXT_COUPON_INST_ID:"30010047",COR_COUPON_INST_ID:"30010046",PROV_ISALE:"40010029",THRETOFOUR_ITEM:"111111199",BUSITYPE_FLAG:"30010024",ZCD_ITEM:"111111198",SO_NBR:"111111196",STEP_ORDER_CHARGE_STAFF:"111111197",DELIVERY_TYPE:"800000013",DELIVERY_METHOD:"800000014",DELIVERY_TIME:"800000015",DELIVERY_ADDRESS:"800000016",DELIVERY_POLICY:"800000018",itemSpecID:"800000036"};var R={FEE_TYPE:"10020030",PROT_NUMBER:"11251741"};var e=function(Y){return v[Y]};var y={COMMON_MEMBER:1,MAIN_CARD:400,VICE_CARD:401,BROADBAND_MAIN_CARD:500,BROADBAND_VICE_CARD:501,CONTENT:99991};var T=[{MEMBER_ROLE_CD:1,MEMBER_ROLE_NAME:"普通成员"},{MEMBER_ROLE_CD:400,MEMBER_ROLE_NAME:"天翼主卡"},{MEMBER_ROLE_CD:401,MEMBER_ROLE_NAME:"天翼副卡"},{MEMBER_ROLE_CD:500,MEMBER_ROLE_NAME:"天翼宽带主卡"},{MEMBER_ROLE_CD:501,MEMBER_ROLE_NAME:"天翼宽带副卡"},{MEMBER_ROLE_CD:600,MEMBER_ROLE_NAME:"基础套餐级可选包"},{MEMBER_ROLE_CD:601,MEMBER_ROLE_NAME:"加装套餐级可选包"},{MEMBER_ROLE_CD:99991,MEMBER_ROLE_NAME:"内容产品"}];var p={SUCC_CODE:"POR-0000",FAIL_CODE:"POR-2004"};var t={busiOrderAttrs:111111122};var j={NEW_PROD:1,ATTACH_OFFER_CHANGE:2,OFFER_CHANGE:5,NEW_PROD:1,NEW_PROD:1};var w={COUPON_SALE:"2007000",COUPON_RESERVATION_SALE:"2007002"};var E={USABLE:"1001",HAVESALE:"1115"};var D={BRAND:60010002,PHONE_TYPE:60010003,COLOR:60010004,TERMINAL_TYPE:60010013,SUPPORT4G:60010023,SUPPORT4NFC:60010024};var P={XIAN_JIN:100000,YIN_HANG:110000,POS:110100,WANG_YIN:110200,TUO_SHOU:110300,ZHI_PIAO:110400,FEN_QI_FU_KUAN:110500,YIN_HANG_DAI_KOU:110600,DI_SAN_FANG_ZHI_FU_PING_TAI:120000,YI_ZHI_FU:120100,ZHI_FU_BAO:120200,TAO_BAO_XIN_YONG_KA:120201,CAI_FU_TONG:120300,QU_DAO_DAI_SHOU:130000,JI_TUAN_DAI_SHOU:130100,ZHENG_QI_DAI_SHOU:130200,ZHANG_WU_DAI_SHOU:140000,HUA_FEI_YU_E:140100,DI_KOU_LEI:150000,DIAN_XIN_KA_DI_KOU:150100,JI_FEN_DI_KOU:150200,TAO_BAO_JI_FEN_DI_KOU:150201,DAI_JIN_QUAN_DI_KOU:150300,HUO_DAO_FU_KUAN:160000,XIAN_JIN_DAO_FU:160100,POS_DAO_FU:160200};var C={SILENT_OLID:"silentOlId"};var V=function(){if(CONST.APP_DESC==-1){o();return CONST.APP_DESC}else{return CONST.APP_DESC}};var o=function(){CONST.APP_DESC=globalAppDesc};var X=/^(180|189|133|134|153|181|108|170|177)\d{8}$/;var K=/^(170)\d{8}$/;var k="100003";var g=381000960;var J=10020034;var H=10020035;var G=10020036;var x={ZQZXDL:100100,GZZXDL:100300,HYKHZXDL:100101,SYKHZXDL:100102,XYKHZXDL:100103,GZZXJL:100301,ZYOUT:110100,ZYINGT:110101,WBT:110102};var I=["381001824","13409900"];var U=["235010013","381001823"];var b={"235010013":"10020047","381001823":"10020047"};var N=function(Z,Y){if(b[Z]==Y){return b[Z]}else{return""}};var q={IS4G:"1",IS3G:"0"};var B={BATCHORDER_QRY_FLAG:"N",BATCHORDER_AUTH_FLAG:"N"};return{BATCHORDER_FLAG:B,APP_DESC:f,OFFER_FAST_FILL:z,setAppDesc:o,BO_ACTION_TYPE:n,ACTION_CLASS_CD:a,PROD_STATUS_CD:A,BUSI_ORDER_ATTR:r,MEMBER_ROLE_CD:y,MEMBER_ROLE_LIST:T,PROD_SPEC:c,PROD_ATTR:i,ACCT_ATTR:O,getBoActionTypeName:e,PAY_TYPE:h,CODE:p,OL_TYPE_CD:F,LABEL:W,PROD_CLASS:L,ITEM_SPEC_ID_CODE:t,EVENT:d,TEMPLATE_TYPE:j,CUST_COUPON_SALE:s,CHARGE_ITEM_CD:w,MKTRES_STATUS:E,ITEM_SPEC:R,OBJ_TYPE:m,ACCT_ITEM_TYPE:S,getAppDesc:V,RELA_TYPE_CD:M,UNSS_PROCESS_MODE:l,TERMINAL_SPEC_ATTR_ID:D,PAYMETHOD_CD:P,DEL_ORDER_FLAG:C,PROD_SPEC_ID:Q,LTE_PHONE_HEAD:X,MVNO_PHONE_HEAD:K,RELATYPECD:k,YZFservSpecId:g,YZFitemSpecId1:J,YZFitemSpecId2:H,YZFitemSpecId3:G,CHANNEL_TYPE_CD:x,GROUP_SERV_SPEC_ID:U,GROUP_PROD_SPEC:I,getGroupServProdMap:N,CHANNEL_TYPE_CD:x,UIMTYPE3G4G:q,PROD_ATTR_VALUE:u}})();$(function(){CONST.getAppDesc()});CommonUtils.regNamespace("common");common=(function(f){var o=function(v,w,y,s){var z=JSON.stringify(v);var x=JSON.stringify(w);var r=JSON.stringify(y);var t=f.parseJSON(JSON.stringify(s));OrderInfo.actionFlag=t.actionFlag;if(ec.util.isObj(y)){order.prodModify.choosedProdInfo=f.parseJSON(r)}if(ec.util.isObj(v)){OrderInfo.staff=f.parseJSON(z)}if(ec.util.isObj(w)){OrderInfo.cust=f.parseJSON(x)}var u={staffInfos:z,custInfos:x,prodIdInfos:r};var q=t.method;f.callServiceAsHtml(contextPath+q,u,{before:function(){f.ecOverlay("正在努力加载中，请稍等...")},done:function(B){f.unecOverlay();f("#load").hide();var A=f("#content").html(B.data);f.refresh(A)},fail:function(A){f.unecOverlay();f.alert("提示","查询失败，请稍后再试！")}})};var i=function(q){var r=JSON.stringify(q);if(ec.util.isObj(q)){OrderInfo.cust=f.parseJSON(r)}};var c=function(r){var q=new Array(1);q[0]=r;MyPlugin.getIDCardInfos(q,function(s){},function(s){})};var b=function(r){var q=new Array(1);q[0]=r;MyPlugin.takePhotos(q,function(s){},function(s){})};var k=function(r){var q=new Array(1);q[0]=r;MyPlugin.getGenerationInfos(q,function(s){},function(s){})};var g=function(){var q=new Array(1);q[0]=JSON.stringify(OrderInfo.cust);MyPlugin.showCust(q,function(r){},function(r){})};var e=function(){if(f("#alert-modal").length>0){f("#alert-modal").hide()}var q=new Array(1);q[0]="";MyPlugin.closeWebview(q,function(r){},function(r){})};var j=function(){if(f("#alert-modal").length>0){f("#alert-modal").hide()}var q=new Array(1);q[0]="";MyPlugin.relocationCust(q,function(r){},function(r){})};var a=function(r){var q=new Array(1);
q[0]=r;MyPlugin.datasign(q,function(s){},function(s){})};var m=function(s,r){var q=new Array(1);q[0]=s;q[1]=r;MyPlugin.scanning(q,function(t){},function(t){})};var n=function(s,r,u,t){var q=new Array(1);q[0]=s;q[1]=r;q[2]=u;q[3]=t;MyPlugin.calendar(q,function(v){},function(v){})};var p=function(q,r){f("#"+r).val(q)};var l=function(){f.unecOverlay();if(OrderInfo.actionFlag==4||OrderInfo.actionFlag==8){e();return}if(OrderInfo.actionFlag==40){cart.main.cartBack();return}if(OrderInfo.actionFlag==140){order.calcharge.back();return}if(OrderInfo.actionFlag==150){mktRes.terminal.back();return}if(OrderInfo.returnFlag==2){order.phoneNumber.back();return}if(OrderInfo.order.step==1){e()}else{if(OrderInfo.order.step==2){if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==9){e();return}order.main.lastStep(function(){f("#order_prepare").show();if(OrderInfo.actionFlag!=13||OrderInfo.actionFlag!=14){f("#pakeage").show()}if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==14){f("#phone").show();f("#pakeage").hide();f("#number").hide()}f("#order").hide();if(OrderInfo.actionFlag==1){h(2)}if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==14){h(2)}OrderInfo.order.step=1})}else{if(OrderInfo.order.step==3){if(OrderInfo.actionFlag==3){var q=OrderInfo.boProd2Tds;if(q.length>0){for(var s=0;s<q.length;s++){var r={numType:2,numValue:q[s].terminalCode};f.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",r,{done:function(){}})}}e();return}SoOrder.orderBack();f("#order-content").show();f("#order-confirm").hide();f("#order-dealer").hide();OrderInfo.order.step=2}else{if(OrderInfo.order.step==4){f("#order-confirm").show();f("#order-print").hide();OrderInfo.order.step=3}else{e()}}}}};var h=function(r){var q=new Array(1);q[0]=r;MyPlugin.changeTitle(q,function(s){},function(s){})};var d=function(){var q=new Array(1);MyPlugin.sessionValid(q,function(r){},function(r){})};return{relocationCust:j,setCalendar:p,callcalendar:n,callCloseWebview:e,callCustInfo:i,callDatasign:a,callGenerationRec:k,callIDCardRec:c,callOrderServer:o,callPhotos:b,callReturnBack:l,callScanning:m,callSessionNotViald:d,callTitle:h,saveCust:g}})(jQuery);CommonUtils.regNamespace("order","prodModify");order.prodModify=(function(){var a={};var c=false;var b=function(e,d,g,f){OrderInfo.newofferSpecName=g;$("#"+d).show();$("#"+d).html("&nbsp;&nbsp;<span style='color: #327501;'>订购新套餐：</span>"+g);$("#li_"+d).attr("addSpecId",e).attr("addRoleId",f).attr("del","N").attr("addSpecName",g);c=true;if(document.getElementById("li_"+d)){$("#li_"+d).css("text-decoration","").attr("del","N").attr("knew","Y");$("#li_"+d).find("i:first-child").find("a").text("拆副卡")}};return{choosedProdInfo:a,chooseOfferForMember:b}})();CommonUtils.regNamespace("OrderInfo");OrderInfo=(function(){var G=0;var l=-1;var g=-1;var ar="false";var J="false";var b="false";var aD="";var aF=0;var k="";var ak="";var ay="";var aA="";var y={provIsale:"",redirectUri:"",isFee:"1",extCustOrderID:"",reloadFlag:"",prodOfferId:"",prodOfferName:"",mergeFlag:"0"};var c={oldSubPhoneNum:""};var ai={DevelopmentCode:"",terminalCode:"",developmentObjId:""};var Y="";var P="";var ax;var al={custId:"",partyName:"",vipLevel:"",vipLevelName:"",custFlag:"1100"};var s={};var a={staffId:0,channelId:0,channelName:"",areaId:0,areaCode:0,soAreaId:0,soAreaCode:0,distributorId:""};var av=[];var y={provIsale:"",redirectUri:"",isFee:"1",extCustOrderID:"",reloadFlag:"",prodOfferId:"",prodOfferName:""};var r=0;var n={mainPhoneNum:"",newSubPhoneNum:"",oldSubPhoneNum:"",mktResInstCode:""};var m={mainPhoneNum:"",newSubPhoneNum:"",mktResInstCode:"",codeMsg:""};var af={cardNum:"",checkMaskList:[],feeType:"",orderMark:"",isReloadFlag:"",objInstId:"",dealerlist:[],paymentAcctTypeCd:"",mailingType:"",bankAcct:"",bankId:"",limitQty:"",paymentMan:"",param1:"",param2:"",param3:"",param7:""};var ad={};var I={offerId:"",offerSpecId:"",offerMemberInfos:[]};var R=[];var au=[];var am=[];var o=[];var at=[];var A={offerId:"",offerSpecId:"",offerMemberInfos:[]};var C=0;var h="";var X="订购";var F="";var ac="";var ab=[];var N={};var q=[];var x={};var aj={dealerType:"",soNbr:"",oldSoNbr:"",oldSoId:"",step:0,token:"",templateType:1,dealerTypeList:[]};var u={effTime:""};var B={seq:-1,offerSeq:-1,prodSeq:-1,servSeq:-1,itemSeq:-1,acctSeq:-1,acctCdSeq:-1,paramSeq:-1,atomActionSeq:-1,offerMemberSeq:-1,dealerSeq:1};var V=[];var Q=[];var az=[];var ah=[];var ag=[];var aI=[];var d=[];var e=[];var aq=[];var w=function(){var aK={orderList:{orderListInfo:{isTemplateOrder:"N",templateType:OrderInfo.order.templateType,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,areaId:OrderInfo.staff.soAreaId,partyId:-1,olTypeCd:CONST.OL_TYPE_CD.UI_LTE},custOrderList:[{busiOrder:[]}]}};OrderInfo.orderData=aK;return OrderInfo.orderData};var z=function(aK,aL,aM){OrderInfo.channelList=[];if($("i[name='channel_iofo_i']").length==0){OrderInfo.channelList=window.parent.OrderInfo.getChannelList()}else{$("i[name='channel_iofo_i']").each(function(){var aP=$(this).attr("channel_Id");var aN=$(this).attr("channel_Name");var aR=$(this).attr("channel_Nbr");var aQ=0;if($(this).hasClass("select")){var aQ=1}var aO={channelId:aP,channelName:aN,channelNbr:aR,isSelect:aQ};OrderInfo.channelList.push(aO)})}return OrderInfo.channelList};var aB=function(aL){var aK=v(-1);var aM={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.CUST_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.CUST_CREATE},data:{boCustInfos:[],boCustIdentities:[],boPartyContactInfo:[]}};if(ec.util.isObj(aK)){aM.busiObj.accessNumber=aK}cust.getCustInfo();aM.data.boCustInfos.push(OrderInfo.boCustInfos);aM.data.boCustIdentities.push(OrderInfo.boCustIdentities);if($("#tabProfile0").attr("click")=="0"&&($("#contactName").val()!="")){aM.data.boPartyContactInfo.push(OrderInfo.boPartyContactInfo)}if(OrderInfo.boCustProfiles!=undefined&&OrderInfo.boCustProfiles!=""){aM.data.boCustProfiles=[];aM.data.boCustProfiles=OrderInfo.boCustProfiles}aL.push(aM)};var f=function(aS,aT){var aL=OrderInfo.cust.partyName;var aU=100000;var aO="";var aQ="";var aR="";var aN=-1;if(aU==110000){aO=$("#bankId").val();aQ=$("#bankAcct").val();aR=$("#paymentMan").val()}var aK={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:aT},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.ACCT_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACCT_CREATE},data:{boAccountInfos:[{partyId:OrderInfo.cust.custId,acctName:aL,acctCd:aT,acctId:aT,businessPassword:"111111",state:"ADD",acctTypeCd:"1"}],boPaymentAccounts:[{paymentAcctTypeCd:aU,bankId:aO,bankAcct:aQ,paymentMan:aR,limitQty:"1",state:"ADD"}],boAcct2PaymentAccts:[{priority:"1",state:"ADD"}],boAccountItems:[],boAccountMailings:[]}};var aM=v(-1);if(ec.util.isObj(aM)){aK.busiObj.accessNumber=aM}if($("#paymentType").val()==110000&&$.trim($("#protocalNbr").val())!=""){var aV={itemSpecId:CONST.ACCT_ATTR.PROTOCOL_NBR,value:$.trim($("#protocalNbr").val()),state:"ADD"};aK.data.boAccountItems.push(aV)}if(aN!=-1){var aP={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"ADD"};if($("#postType").val()==11||$("#postType").val()==15){aP.param1=$("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val()}aK.data.boAccountMailings.push(aP)}aS.push(aK)};var aG=function(aL,aN,aP){var aK=v(aP);var aO={areaId:OrderInfo.getProdAreaId(aP),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:aN.offerId,objId:aN.offerSpecId,offerTypeCd:aN.offerTypeCd},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:aN.boActionTypeCd},data:{}};if(ec.util.isObj(aN.offerSpecName)){aO.busiObj.objName=aN.offerSpecName}if(ec.util.isObj(aK)){aO.busiObj.accessNumber=aK}if(aN.boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_OFFER){var aM=$("li[name='tr_"+aP+"_"+aN.offerSpecId+"']");if(aM!=undefined&&aM.length>0){aO.data.busiOrderAttrs=[];aM.each(function(){var aQ={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select[name='dealerType_"+aP+"_"+aN.offerSpecId+"']").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name='dealerChannel_"+aP+"_"+aN.offerSpecId+"']").val()};
aO.data.busiOrderAttrs.push(aQ);var aR={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select[name='dealerType_"+aP+"_"+aN.offerSpecId+"']").val(),value:$(this).find("input").attr("value")};aO.data.busiOrderAttrs.push(aR)})}aO.data.ooOwners=[];aO.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"ADD"});if(ec.util.isArray(aN.offerSpecParams)){aO.data.ooParams=[];$.each(aN.offerSpecParams,function(){if(this.setValue==undefined){this.setValue=this.value}if(ec.util.isObj(this.setValue)){var aQ={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};aO.data.ooParams.push(aQ)}})}if(aN.ooTimes!=undefined){aO.data.ooTimes=[];aO.data.ooTimes.push(aN.ooTimes)}$.each(OrderInfo.attach2Coupons,function(){if(aN.offerSpecId==this.attachSepcId&&aP==this.prodId){this.offerId=aN.offerId;aO.data.bo2Coupons=[];aO.data.bo2Coupons.push(this);return false}});aO.data.ooRoles=[];if(ec.util.isArray(aN.offerRoles)){$.each(aN.offerRoles,function(){var aQ=this;$.each(this.roleObjs,function(){var aU={prodId:aP,offerRoleId:aQ.offerRoleId,objId:this.objId,objType:this.objType,relaType:this.relaTypeCd,state:"ADD"};var aS=true;if(this.objType==CONST.OBJ_TYPE.PROD){var aT=OrderInfo.getProdSpecId(aP);if(aT==this.objId||aT==""){aU.objInstId=aP}else{return true}}else{if(this.objType==CONST.OBJ_TYPE.SERV){var aV=CacheData.getServBySpecId(aP,this.objId);if(aV!=undefined){aU.objInstId=aV.servId}else{var aR=CacheData.getServSpec(aP,this.objId);if(aR!=undefined&&aR.isdel!="Y"&&aR.isdel!="C"&&aR.servId!=undefined&&aR.servId!=""){aU.objInstId=aR.servId}else{aS=false}}}else{aU.objInstId=OrderInfo.SEQ.offerSeq--}}if(aS){aO.data.ooRoles.push(aU)}})})}aL.push(aO)}else{if(aN.boActionTypeCd==CONST.BO_ACTION_TYPE.DEL_OFFER){aO.data.ooOwners=[];aO.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"DEL"});if(ec.util.isArray(aN.offerMemberInfos)){aO.data.ooRoles=[];$.each(aN.offerMemberInfos,function(){var aQ={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerRoleId:this.offerRoleId,state:"DEL"};if(this.objType!=CONST.OBJ_TYPE.PROD){aQ.prodId=aP}if(this.offerMemberId!=undefined){aQ.offerMemberId=this.offerMemberId}aO.data.ooRoles.push(aQ)})}if(aN.isRepeat!="Y"){aL.push(aO)}}else{if(aN.boActionTypeCd==CONST.BO_ACTION_TYPE.UPDATE_OFFER){if(aN.isUpdate=="Y"){aO.data.ooRoles=aN.data}else{if(ec.util.isArray(aN.offerSpec.offerSpecParams)){aO.data.ooParams=[];$.each(aN.offerSpec.offerSpecParams,function(){if(this.isUpdate=="Y"){if(ec.util.isObj(this.value)){var aQ={itemSpecId:this.itemSpecId,offerParamId:this.offerParamId,offerSpecParamId:this.offerSpecParamId,value:this.value,state:"DEL"};aO.data.ooParams.push(aQ)}if(ec.util.isObj(this.setValue)){var aR={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};aO.data.ooParams.push(aR)}}})}}aL.push(aO)}}}};var O=function(aP){var aL=v(aP.prodId);var aO={areaId:OrderInfo.getProdAreaId(aP.prodId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.getProdSpecId(aP.prodId),instId:aP.prodId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:aP.boActionTypeCd},data:{}};if(ec.util.isObj(aP.isComp)){aO.busiObj.isComp=aP.isComp}if(ec.util.isObj(aL)){aO.busiObj.accessNumber=aL}if(aP.boActionTypeCd==CONST.BO_ACTION_TYPE.PRODUCT_PARMS){if(ec.util.isArray(aP.prodSpecParams)){aO.data.boServOrders=[];aO.data.boServOrders.push({servId:aP.memberId,servSpecId:aP.servSpecId});aO.data.boServItems=[];$.each(aP.prodSpecParams,function(){if(this.isUpdate=="Y"){if(ec.util.isObj(this.value)){var aQ={itemSpecId:this.itemSpecId,servId:aP.memberId,value:this.value,state:"DEL"};aO.data.boServItems.push(aQ)}if(ec.util.isObj(this.setValue)){var aR={itemSpecId:this.itemSpecId,servId:aP.memberId,value:this.setValue,state:"ADD"};aO.data.boServItems.push(aR)}}})}}else{if(aP.boActionTypeCd==CONST.BO_ACTION_TYPE.SERV_OPEN){var aN="ADD";if(aP.servClose=="Y"){aN="DEL"}else{if(aP.servSpecId==undefined&&aP.objId!=undefined){aP.servSpecId=aP.objId}}var aM={servId:aP.servId,servSpecId:aP.servSpecId};if(ec.util.isObj(aP.servSpecName)){aM.servSpecName=aP.servSpecName}aO.data.boServOrders=[];aO.data.boServOrders.push(aM);aO.data.boServs=[];aO.data.boServs.push({servId:aP.servId,state:aN});if(aP.servClose!="Y"){if(ec.util.isArray(aP.prodSpecParams)){aO.data.boServItems=[];$.each(aP.prodSpecParams,function(){if(this.setValue==undefined){this.setValue=this.value}var aQ=$("select[name='pay_type_-1']").val();if(aQ==undefined){aQ=order.prodModify.choosedProdInfo.feeType}if(aP.servSpecId==CONST.YZFservSpecId&&aQ==CONST.PAY_TYPE.AFTER_PAY){this.setValue=""}if(ec.util.isObj(this.setValue)){var aR={itemSpecId:this.itemSpecId,servId:aP.servId,value:this.setValue,state:aN};aO.data.boServItems.push(aR)}})}}}else{if(aP.boActionTypeCd==CONST.BO_ACTION_TYPE.REMOVE_PROD){aO.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}]}else{if(aP.boActionTypeCd==CONST.BO_ACTION_TYPE.CHANGE_CARD||aP.boActionTypeCd==CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD){var aK=OrderInfo.getProdUim(aP.prodId);if(ec.util.isObj(aK.prodId)){aO.data.bo2Coupons=[];aO.data.bo2Coupons.push(aK);aO.data.bo2Coupons.push(OrderInfo.getProdOldUim(aP.prodId))}else{return false}}}}}return aO};var D=function(aK,aN){var aL=order.prodModify.choosedProdInfo;var aM={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aL.productId,instId:aL.prodInstId,accessNumber:aL.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};aM.data=aN;aK.push(aM)};var aE={areaId:0,defaultIdType:"1",businessPassword:"",name:"",partyTypeCd:1,state:"ADD",telNumber:"",addressStr:"",mailAddressStr:""};var L={identidiesTypeCd:"1",identityNum:"",isDefault:"Y",state:"ADD"};var T={contactAddress:"",contactDesc:"",contactEmployer:"",contactGender:"",contactId:"",contactName:"",contactType:"",eMail:"",fax:"",headFlag:"",homePhone:"",mobilePhone:"",officePhone:"",postAddress:"",postcode:"",staffId:0,state:"",statusCd:"100001"};var aJ={};var i=function(){OrderInfo.SEQ.seq=-1;OrderInfo.SEQ.offerSeq=-1;OrderInfo.SEQ.prodSeq=-1;OrderInfo.SEQ.servSeq=-1;OrderInfo.SEQ.itemSeq=-1;OrderInfo.SEQ.acctSeq=-1;OrderInfo.SEQ.acctCdSeq=-1;OrderInfo.SEQ.paramSeq=-1;OrderInfo.SEQ.atomActionSeq=-1};var W=function(){OrderInfo.boProdAns=[];OrderInfo.boProd2Tds=[];OrderInfo.bo2Coupons=[];AttachOffer.openList=[];AttachOffer.openedList=[];AttachOffer.openServList=[];AttachOffer.openedServList=[];AttachOffer.openAppList=[];AttachOffer.labelList=[];OrderInfo.confirmList=[];OrderInfo.orderResult={}};var ao=function(aK,aN,aO,aM,aL){if(aK!=""&&aK!=undefined){OrderInfo.actionClassCd=aK}if(aN!=""&&aN!=undefined){OrderInfo.boActionTypeCd=aN}if(aO!=undefined){OrderInfo.actionFlag=aO}if(aM!=""&&aM!=undefined){OrderInfo.actionTypeName=aM}if(aL!=""&&aL!=undefined){OrderInfo.order.templateType=aL}};var aa=function(aN){var aK={};for(var aL=0;aL<OrderInfo.boProdAns.length;aL++){var aM=OrderInfo.boProdAns[aL];if(aM==undefined){continue}else{if(aM.prodId==aN){aK=aM}}}return aK};var t=function(aL,aK){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==aL){this.an=aK;return false}})})};var H=function(aK){try{if(stepOrder.main.isStepOrder){return stepOrder.main.areaId}}catch(aL){}if(aK!=undefined&&aK>0){var aM=order.prodModify.choosedProdInfo.areaId;if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&order.service.oldMemberFlag){if(ec.util.isObj(OrderInfo.cust.areaId)){aM=OrderInfo.cust.areaId}else{aM=OrderInfo.staff.soAreaId}}if(aM==undefined||aM==""){$.alert("错误提示","产品信息未返回地区ID，请营业后台核实！");return}return aM}else{if(ec.util.isObj(OrderInfo.cust.areaId)){return OrderInfo.cust.areaId}else{return OrderInfo.staff.soAreaId}}};var aw=function(){var aK=OrderInfo.staff.soAreaId;
if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){}else{if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==4||OrderInfo.actionFlag==9){if(ec.util.isObj(OrderInfo.cust.areaId)){aK=OrderInfo.cust.areaId}}else{if(ec.util.isObj(order.prodModify.choosedProdInfo.areaId)){aK=order.prodModify.choosedProdInfo.areaId}}}return aK};var ap=function(aL){for(var aK=0;aK<OrderInfo.boProd2OldTds.length;aK++){var aM=OrderInfo.boProd2OldTds[aK];if(aM.prodId==aL){return aM}}return{}};var K=function(aL){for(var aK=0;aK<OrderInfo.boProd2Tds.length;aK++){var aM=OrderInfo.boProd2Tds[aK];if(aM.prodId==aL){return aM}}return{}};var ae=function(aL){for(var aK=0;aK<OrderInfo.boProd2Tds.length;aK++){var aM=OrderInfo.boProd2Tds[aK];if(aM.prodId==aL){OrderInfo.boProd2Tds.splice(aK,1)}}};var Z=function(aL){for(var aK=0;aK<OrderInfo.boProd2Tds.length;aK++){var aM=OrderInfo.boProd2Tds[aK];if(aM.prodId==aL){return aM.terminalCode}}return""};var aC=function(aO){var aL=true;for(var aN=0;aN<OrderInfo.bo2Coupons.length;aN++){var aM=OrderInfo.bo2Coupons[aN];if(aM.prodId==aO){aL=false;return aM}}if(aL){var aK={prodId:aO,coupons:[]};OrderInfo.bo2Coupons.push(aK);return aK}};var U=function(aO){var aL=true;for(var aN=0;aN<OrderInfo.bo2Coupons.length;aN++){var aM=OrderInfo.bo2Coupons[aN];if(aM.prodId==aO){aM.coupons=[];return aM}}if(aL){var aK={prodId:aO,coupons:[]};OrderInfo.bo2Coupons.push(aK);return aK}};var aH=function(aN){var aK="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){$.each(OrderInfo.oldoffer,function(){var aP=this;$.each(aP.offerMemberInfos,function(){if(this.objInstId==aN){aK=this.accessNumber;return false}})})}else{for(var aL=0;aL<OrderInfo.boProdAns.length;aL++){var aM=OrderInfo.boProdAns[aL];if(aM.prodId==aN){if(aM.accessNumber!=undefined){aK=aM.accessNumber}}}}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){var aO="'"+aN+"'";if(aO.indexOf("-")!=-1){for(var aL=0;aL<OrderInfo.boProdAns.length;aL++){var aM=OrderInfo.boProdAns[aL];if(aM.prodId==aN){if(aM.accessNumber!=undefined){aK=aM.accessNumber}}}}else{$.each(OrderInfo.offer.offerMemberInfos,function(aP){if(this.objInstId==aN){aK=this.accessNumber;return false}});if((aK==undefined||aK=="")&&offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==aN){aK=this.accessNumber;return false}})})}}}else{if(aN!=undefined&&aN>0){aK=order.prodModify.choosedProdInfo.accNbr}else{if(aN!=undefined&&aN>0){aK=order.prodModify.choosedProdInfo.accNbr}}}}return aK};var v=function(aN){var aK="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){$.each(OrderInfo.oldoffer,function(){var aO=this;$.each(aO.offerMemberInfos,function(){if(this.objInstId==aN){aK=this.accessNumber;return false}})})}else{for(var aL=0;aL<OrderInfo.boProdAns.length;aL++){var aM=OrderInfo.boProdAns[aL];if(aM.prodId==aN){if(aM.accessNumber!=undefined){aK=aM.accessNumber}}}}}else{if(OrderInfo.actionFlag==6||OrderInfo.actionFlag==2){for(var aL=0;aL<OrderInfo.boProdAns.length;aL++){var aM=OrderInfo.boProdAns[aL];if(aM.prodId==aN){if(aM.accessNumber!=undefined){aK=aM.accessNumber}}}$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==aN){aK=this.accNbr;return false}});$.each(OrderInfo.offer.offerMemberInfos,function(aO){if(this.objInstId==aN){aK=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.offer.offerMemberInfos,function(aO){if(this.objInstId==aN){aK=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==35){aK=stepOrder.main.getAccessNumber(aN)}else{if(aN!=undefined&&aN>0){aK=order.prodModify.choosedProdInfo.accNbr}}}}}return aK};var p=function(aN){var aK="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var aL=0;aL<OrderInfo.boProdAns.length;aL++){var aM=OrderInfo.boProdAns[aL];if(aM.prodId==aN){if(aM.areaCode!=undefined){aK=aM.areaCode}}}}else{if(aN!=undefined&&aN>0){aK=order.prodModify.choosedProdInfo.areaCode}}if(aK==undefined||aK==""){aK=OrderInfo.staff.areaCode}return aK};var M=function(aK){var aL="";$.each(OrderInfo.boProdAns,function(){if(this.memberRoleCd==aK){aL=this.accessNumber;return false}});if(aL==undefined||aL==""){aL=OrderInfo.boProdAns[0].accessNumber}return aL};var E=function(aL){var aK="";if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){if(OrderInfo.offer.offerMemberInfos!=undefined){$.each(OrderInfo.offer.offerMemberInfos,function(aM){if(this.objInstId==aL){aK=this.roleName;return false}})}}else{if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(aN){var aM=this.offerRoleName;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==aL){aK=aM;return false}})}})}}return aK};var an=function(aL){var aK={};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(aM){if(this.objInstId==aL){aK=this;aK.accNbr=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==3){aK=order.prodModify.choosedProdInfo}else{$.each(OrderInfo.offerSpec.offerRoles,function(aM){if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==aL){aK=this;return false}})}})}}return aK};var S=function(aL){var aK=CONST.PROD_SPEC.CDMA;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==aL){aK=this.objId;return false}})})}else{if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(aM){if(this.objInstId==aL){aK=this.objId;return false}});if(offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==aL){aK=this.objId;return false}})})}if(offerChange.newMemberFlag){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==aL){aK=this.objId;return false}})})}}else{if(aL!=undefined&&aL>0){aK=order.prodModify.choosedProdInfo.productId}}}return aK};var j=function(aK){if(OrderInfo.privilege.effTime==""){var aL={manageCode:aK};return query.offer.checkOperate(aL)}};return{state:aD,delViceCard:b,newClothes:ar,oldMember:J,objInstId:Y,terminalCode:aA,newPhoneId:P,mktResInstCode:ay,viceParam:s,acctId:l,acctCd:g,order:aj,SEQ:B,resetSeq:i,resetData:W,orderResult:N,cust:al,staff:a,offerSpec:ad,offer:I,attach2Coupons:e,boCustInfos:aE,boCustIdentities:L,boPartyContactInfo:T,boCustProfiles:aJ,boCusts:V,boProdItems:Q,boProdPasswords:az,boProdAns:ah,boProd2Tds:ag,bo2Coupons:d,boProd2OldTds:aI,clearProdUim:ae,orderData:x,getOrderData:w,actionClassCd:C,boActionTypeCd:h,actionFlag:G,actionTypeName:X,initData:ao,getOfferBusiOrder:aG,getProdBusiOrder:O,createCust:aB,createAcct:f,getProdAn:aa,getProdTd:Z,getProdUim:K,getProdOldUim:ap,getProdAreaId:H,getProdCoupon:aC,getProdInst:an,getAccessNumber:v,getAreaCode:p,getAreaId:aw,getOfferRoleName:E,getAccNbrByRoleCd:M,getProdSpecId:S,getPrivilege:j,initProdCoupon:U,setProdAn:t,setProdModifyBusiOrder:D,confirmList:ab,businessName:F,password_remark:ac,privilege:u,offerProdInst:A,orderlonger:k,busitypeflag:aF,checkresult:q,custorderlonger:ak,prodAttrs:aq,provinceInfo:y,reloadOrderInfo:ax,reloadProdInfo:af,memberChangeInfo:n,newOrderNumInfo:m,oldSubPhoneNum:c,oldprodInstInfos:au,oldofferSpec:am,oldoffer:o,oldprodAcctInfos:at,oldAddNumList:R,surplusNum:r,oldSubPhoneNum:c,codeInfos:ai,getChannelList:z,channelList:av}})();CommonUtils.regNamespace("SoOrder");SoOrder=(function(){var R=function(){if(query.offer.loadInst()){SoOrder.initFillPage();return true}else{return false}};var t="";var l=function(){SoOrder.initOrderData();OrderInfo.order.step=2;if(OrderInfo.actionFlag==1){try{common.callTitle(3)}catch(W){}}F()};var E=function(){OrderInfo.resetSeq();OrderInfo.resetData();OrderInfo.orderResult={};OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;
OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.getAreaId()};var v=function(X){if(K(X)){var W=contextPath+"/order/orderSubmit";if(OrderInfo.order.token!=""){W=contextPath+"/token/app/order/orderSubmit?token="+OrderInfo.order.token}$.callServiceAsJson(W,JSON.stringify(OrderInfo.orderData),{before:function(){$.ecOverlay("<strong>订单提交中，请稍等...</strong>")},done:function(aa){$.unecOverlay();F();if(aa.code==0){var ad=aa.data;if(OrderInfo.actionFlag==8||OrderInfo.actionFlag==4){if(ad.resultCode==0){if(OrderInfo.actionFlag==8){$.alert("信息提示","客户创建成功");common.saveCust()}else{$.alert("信息提示","客户修改成功")}}else{$.alert("信息提示",ad.resultMsg)}}else{if(ad.result.ruleInfos!=undefined&&ad.result.ruleInfos.length>0){var Z="";$.each(ad.result.ruleInfos,function(){Z+=this.ruleDesc+"<br/>"});$.alert("提示",Z);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq()}else{if(ad.checkRule!=undefined){var Y=order.calcharge.tochargeSubmit(aa.data);if(Y.code==0){var ac=H(aa.data);A(ac)}else{aa.data.provCheckError="Y";if(Y.data.resultMsg!=undefined&&$.trim(Y.data.resultMsg)!=""){aa.data.provCheckErrorMsg=Y.data.resultMsg}else{if(Y.data.errMsg!=undefined&&$.trim(Y.data.errMsg)!=""){aa.data.provCheckErrorMsg=Y.data.errMsg;if(Y.data.errCode){aa.data.provCheckErrorMsg="【错误编码："+Y.data.errCode+"】"+aa.data.provCheckErrorMsg}if(Y.data.errData){aa.data.provCheckErrorData=Y.data.errData;try{var ab=$.parseJSON(Y.data.errData);if(ab.resultMsg){aa.data.provCheckErrorMsg+=","+ab.resultMsg}}catch(ae){}}if(Y.data.paramMap){aa.data.provCheckErrorMsg+="【入参："+Y.data.paramMap+"】"}}else{aa.data.provCheckErrorMsg="未返回错误信息，可能是下省请求超时，请返回填单页面并稍后重试订单提交。"}}var ac=H(aa.data);A(ac)}}else{var ac=H(aa.data);A(ac)}}}}else{$.alertM(aa.data);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();$("#order-content").show();$("#order-dealer").hide()}}})}};var H=function(Y){var X=contextPath+"/token/app/order/gotosubmitOrder";$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var W=$.callServiceAsHtml(X,JSON.stringify(Y));$.unecOverlay();return W.data};var K=function(aa){if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){if(OrderInfo.actionFlag==18&&aa.boActionType.actionClassCd==CONST.ACTION_CLASS_CD.OFFER_ACTION){}else{query.offer.loadInst()}a(aa);if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){OrderInfo.orderData.orderList.orderListInfo.soNbr=OrderInfo.order.soNbr}return true}var ai=[];var aj=[];var X="N";if(q()){X="Y"}aj.push({itemSpecId:CONST.BUSI_ORDER_ATTR.THRETOFOUR_ITEM,value:X});aj.push({itemSpecId:"30010024",value:OrderInfo.busitypeflag});if(!P()){return false}var ae=$("#order_remark").val();if(ec.util.isObj(ae)){aj.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:ae})}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){z(ai)}else{if(OrderInfo.actionFlag==2){offerChange.changeOffer(ai)}else{if(OrderInfo.actionFlag==3){M(ai);if(ai.length==0){$.alert("提示","没有做任何业务，无法提交");return false}}else{if(OrderInfo.actionFlag==4){U(ai,aa)}else{if(OrderInfo.actionFlag==5){m(ai,aa)}else{if(OrderInfo.actionFlag==6){w(ai)}else{if(OrderInfo.actionFlag==7){I(ai,aa)}else{if(OrderInfo.actionFlag==8){OrderInfo.orderData.orderList.orderListInfo.partyId=-1;OrderInfo.orderData.orderList.orderListInfo.soNbr=UUID.getDataId();i(ai,aa)}else{if(OrderInfo.actionFlag==9){u(ai,aa)}else{if(OrderInfo.actionFlag==10){ai=aa}else{if(OrderInfo.actionFlag==11){ai=aa}else{if(OrderInfo.actionFlag==12){ai=aa}else{if(OrderInfo.actionFlag==16){f(ai)}else{if(OrderInfo.actionFlag==19){g(ai,aa,"N")}else{if(OrderInfo.actionFlag==20){I(ai,aa)}else{if(OrderInfo.actionFlag==21){T(ai,aa)}else{if(OrderInfo.actionFlag==22){ai=aa}else{if(OrderInfo.actionFlag==23){ai=aa;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.staff.areaId;var ac=$("#custInfos").attr("corCustId");if(ec.util.isObj(ac)){var ah={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_CUST_ID,value:ac};aj.push(ah)}var am=$("#custInfos").attr("extCustId");if(ec.util.isObj(am)){var ag={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_CUST_ID,value:am};aj.push(ag)}var Y=order.prodModify.choosedProdInfo.extProdInstId;if(ec.util.isObj(Y)){var af={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_PROD_INST_ID,value:Y};aj.push(af)}var al=order.prodModify.choosedProdInfo.corProdInstId;if(ec.util.isObj(al)){var ad={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_PROD_INST_ID,value:al};aj.push(ad)}var W=order.prodModify.choosedProdInfo.extCouponInstanceId;if(ec.util.isObj(W)){var ab={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_COUPON_INST_ID,value:W};aj.push(ab)}var ak=order.prodModify.choosedProdInfo.corCouponInstanceId;if(ec.util.isObj(ak)){var Z={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_COUPON_INST_ID,value:ak};aj.push(Z)}}else{g(ai,aa,"N")}}}}}}}}}}}}}}}}}}OrderInfo.orderData.orderList.orderListInfo.custOrderAttrs=aj;OrderInfo.orderData.orderList.orderListInfo.extCustOrderId=OrderInfo.provinceInfo.provIsale;OrderInfo.orderData.orderList.custOrderList[0].busiOrder=ai;if($("#isTemplateOrder").attr("checked")=="checked"){OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="Y";OrderInfo.orderData.orderList.orderListInfo.templateOrderName=$("#templateOrderName").val();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){OrderInfo.orderData.orderList.orderListInfo.templateType=$("#templateOrderDiv").find("select").val()}else{if(OrderInfo.actionFlag==2){OrderInfo.orderData.orderList.orderListInfo.templateType=5}else{if(OrderInfo.actionFlag==3){OrderInfo.orderData.orderList.orderListInfo.templateType=2}}}}else{OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="N"}if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){OrderInfo.orderData.orderList.orderListInfo.soNbr=OrderInfo.order.soNbr}return true};var a=function(Y){var Z=Y.coupons;OrderInfo.getOrderData();var W=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;if(OrderInfo.cust.custId==-1){OrderInfo.createCust(W)}else{if(OrderInfo.cust.custId!=undefined&&OrderInfo.cust.custId!=""){OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId}else{OrderInfo.orderData.orderList.orderListInfo.partyId=CONST.CUST_COUPON_SALE}}if(OrderInfo.actionFlag==18){OrderInfo.orderData.orderList.orderListInfo.partyId=Z[0].partyId}var X={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:Y.busiObj,boActionType:Y.boActionType,data:{bo2Coupons:[]}};X.data.bo2Coupons=Z;if(Y.dealers){X.data.busiOrderAttrs=Y.dealers}W.push(X)};var A=function(ad){SoOrder.step(2,ad);SoOrder.delOrderBegin();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> 套餐名称</h4><p class="list-group-item-text">'+OrderInfo.offerSpec.offerSpecName+"</p></li>");$("#tital").html("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName);$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> '+this.offerRoleName+'</h4><p class="list-group-item-text">'+OrderInfo.getProdAn(this.prodInstId).accessNumber+"</p></li>")})});if(order.service.oldMemberFlag){for(var ac=0;ac<OrderInfo.oldoffer.length;ac++){for(var ae=0;ae<OrderInfo.oldoffer[ac].offerMemberInfos.length;ae++){var ab=OrderInfo.oldoffer[ac].offerMemberInfos[ae];if(ab.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+ab.accessNumber+"</td></tr> ")}}}}}else{if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#order_prepare").hide();$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端名称：</div><div class="ui-block-b">'+OrderInfo.businessName+"</div></div>");var W=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;var Y=undefined;if(OrderInfo.actionFlag==13){for(var ae=0;ae<W.length;ae++){var ah=W[ae].boActionType;if(ah.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&ah.boActionTypeCd==CONST.BO_ACTION_TYPE.COUPON_SALE){Y=W[ae].data.bo2Coupons
}}$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端串码：</div><div class="ui-block-b">'+Y[0].couponInstanceNumber+"</div></div>")}else{if(OrderInfo.actionFlag==17){for(var ae=0;ae<W.length;ae++){var ah=W[ae].boActionType;if(ah.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&ah.boActionTypeCd==CONST.BO_ACTION_TYPE.RETURN_COUPON){Y=W[ae].data.bo2Coupons}}$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端串码：</div><div class="ui-block-b">'+Y[0].couponInstanceNumber+"</div></div>")}else{if(OrderInfo.actionFlag==18){for(var ae=0;ae<W.length;ae++){var ah=W[ae].boActionType;if(ah.boActionTypeCd==CONST.BO_ACTION_TYPE.EXCHANGE_COUPON){Y=W[ae].data.bo2Coupons}}var X=null;var Z=null;if(Y[0].state=="DEL"){X=Y[0];Z=Y[1]}else{X=Y[1];Z=Y[0]}$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">旧终端串码：</div><div class="ui-block-b">'+X.couponInstanceNumber+"</div></div>");$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新终端串码：</div><div class="ui-block-b">'+Z.couponInstanceNumber+"</div></div>")}}}var ag=$("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName);$("#tital").append(ag)}else{var af=order.prodModify.choosedProdInfo;$("#orderTbody").append('<li class="list-group-item" id="offerSpecName"> <h4 class="list-group-item-heading"> 套餐名称</h4><p class="list-group-item-text">'+af.prodOfferName+"</p></li>");$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading"> 手机号码</h4><p class="list-group-item-text">'+af.accNbr+"</p></li>");if(OrderInfo.actionFlag==2){OrderInfo.actionTypeName="套餐变更";$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading">新套餐名称</h4><p class="list-group-item-text">'+OrderInfo.offerSpec.offerSpecName+"</p></li>");$("#accNbrTr").hide();for(var ae=0;ae<OrderInfo.offer.offerMemberInfos.length;ae++){var ab=OrderInfo.offer.offerMemberInfos[ae];if(ab.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading">'+ab.roleName+'号码</h4><p class="list-group-item-text">'+ab.accessNumber+"</p></li>")}}if(offerChange.newMemberFlag){$.each(OrderInfo.boProdAns,function(){$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading">纳入副卡号码</h4><p class="list-group-item-text">'+this.accessNumber+"</p></li>")})}if(offerChange.oldMemberFlag){for(var ac=0;ac<OrderInfo.oldoffer.length;ac++){for(var ae=0;ae<OrderInfo.oldoffer[ac].offerMemberInfos.length;ae++){var ab=OrderInfo.oldoffer[ac].offerMemberInfos[ae];if(ab.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading">纳入副卡号码</h4><p class="list-group-item-text">'+ab.accessNumber+"</p></li>")}}}}}else{if(OrderInfo.actionFlag==3){OrderInfo.actionTypeName="订购/退订可选包与功能产品"}else{if(OrderInfo.actionFlag==4||OrderInfo.actionFlag==8){$("#offerSpecName").hide();$("#accNbrTr").hide()}else{if(OrderInfo.actionFlag==5){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.isRemove=="Y"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除副卡号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}else{$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==6){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}});$.each(OrderInfo.boProdAns,function(){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">纳入副卡号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div> ")});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==7){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div> ")}else{var aj="";var ak=this.accessNumber;$.each(t,function(al,am){if(am.accessNumber==ak&&am.del=="N"){aj="N"}});if(aj=="N"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}else{$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div> ")}}}});OrderInfo.actionTypeName=CONST.getBoActionTypeName(OrderInfo.boActionTypeCd)}else{if(OrderInfo.actionFlag==21){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var ak="";var aj="";var al=this.objInstId;$.each(t,function(am,an){if(an.objInstId==al&&an.knew=="Y"){ak="Y"}if(an.objInstId==al&&an.del=="Y"){aj="Y"}});if(ak=="Y"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}else{if(aj=="Y"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}}}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==20){$("#accNbrTr").hide();for(var ae=0;ae<OrderInfo.offer.offerMemberInfos.length;ae++){var ab=OrderInfo.offer.offerMemberInfos[ae];if(ab.objType==CONST.OBJ_TYPE.PROD){if(ab.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+ab.roleName+'号码：</div><div class="ui-block-b">'+ab.accessNumber+"</div></div> ")}else{$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+ab.roleName+'号码：</div><div class="ui-block-b">'+ab.accessNumber+"</div></div>")}}}OrderInfo.actionTypeName="返销"}else{if(OrderInfo.actionFlag==12){$("#accNbrTr").hide();for(var ae=0;ae<OrderInfo.confirmList.length;ae++){var af=OrderInfo.confirmList[ae];for(var ac=0;ac<af.accNbr.length;ac++){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+af.name+'：</div><div class="ui-block-b">'+af.accNbr[ac]+"</div></div>")}}}else{if(OrderInfo.actionFlag==16){OrderInfo.actionTypeName="改号";$.each(OrderInfo.boProdAns,function(){if(this.state=="ADD"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}})}else{if(OrderInfo.actionFlag==0&&OrderInfo.actionTypeName=="拆机"){$("#accNbrTr").hide();var ai="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&this.objInstId==order.prodModify.choosedProdInfo.prodInstId){ai="Y"}});if(ai=="Y"){$.each(OrderInfo.offer.offerMemberInfos,function(){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")})}OrderInfo.actionTypeName="拆机"}}}}}}}}}}}var ag=$("<span>订单确认</span>");$("#tital").append(ag)}}var aa=true;if($("#ruleTbody tr").length>0){$("#ruleTbody tr").each(function(){var aj=$(this).attr("ruleLevel");if(aj=="1"){aa=false;return false}})}if(ec.util.isObj($("#provCheckErrorMsg").attr("title"))){aa=false}if(aa){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){N()}else{if(OrderInfo.actionFlag==2){V()}else{if(OrderInfo.actionFlag==3){d()}else{if(OrderInfo.actionFlag==6){n()}else{if(OrderInfo.orderResult.autoBoInfos!=undefined&&OrderInfo.orderResult.autoBoInfos.length>0){$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));
$.each(OrderInfo.orderResult.autoBoInfos,function(){$("#chooseTable").append($('<tr><td width="50%">'+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))})}}}}}}};var S=function(W,Y){for(var X=1;X<4;X++){$("#step"+X).hide()}$("#step"+W).show()};var C=function(W,X){if(W==0){$("#orderedprod").hide();$("#order_prepare").hide();$("#order_fill_content").hide();$("#order_tab_panel_content").html(X).show();W++}else{if(W==1){$("#order_prepare").hide();$("#order_confirm").hide();$("#order_fill").show()}else{if(W==2){$("#order-content").hide();$("#order-dealer").hide();$("#order-confirm").html(X).show();OrderInfo.order.step=3}}}};var N=function(){var W=0;$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(W==0){$("#orderTbody").after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));W="chooseTable_"+this.prodInstId}else{$("#"+W).after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));W="chooseTable_"+this.prodInstId}$("#chooseTable_"+this.prodInstId).append($('<thead><tr><th  style="width: 60%;">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr></thead>"));k(this.prodInstId)})})};var n=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr>"));$.each(this.prodInsts,function(){k(this.prodInstId)})}})};var V=function(){var X=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(X==0){$("#orderTbody").after($('<table id="chooseTable_'+this.objInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.objInstId}else{$("#"+X).after($('<table id="chooseTable_'+this.objInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.objInstId}$("#chooseTable_"+this.objInstId).append($('<thead><tr><th  style="width: 60%;">业务名称('+this.roleName+")</th><th>业务动作</th></tr></thead>"));k(this.objInstId)}});var W=0;$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd==401){$.each(this.prodInsts,function(){var Y='"'+this.prodInstId+'"';if(Y.indexOf("-")!=-1){if(W==0){W="chooseTable_"+this.prodInstId}else{$("#"+W).after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));W="chooseTable_"+this.prodInstId}k(this.prodInstId)}})}});if(offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){k(this.objInstId)}})})}};var d=function(){var W=order.prodModify.choosedProdInfo;if(W==undefined||W.prodInstId==undefined){return true}$("#orderTbody").after($('<table id="chooseTable_'+W.prodInstId+'" class="table table-bordered tablecenter"></table>'));$("#chooseTable_"+W.prodInstId).append($('<thead><tr><th  style="width: 60%;">业务名称</th><th>业务动作</th></tr></thead>'));k(W.prodInstId)};var k=function(ab){var aa=CacheData.getOfferSpecList(ab);var X=CacheData.getOfferList(ab);var W=CacheData.getServSpecList(ab);var Z=CacheData.getServList(ab);var Y=CacheData.getOpenAppList(ab);$("#chooseTable_"+ab).append("<tbody>");if(aa!=undefined&&aa.length>0){$.each(aa,function(){if(this.isdel!="Y"&&this.isdel!="C"){$("#chooseTable_"+ab).append($("<tr><td>"+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_BUY+"</td></tr>"))}})}if(X!=undefined&&X.length>0){$.each(X,function(){if(this.isdel=="Y"){$("#chooseTable_"+ab).append($("<tr><td>"+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_DEL+"</td></tr>"))}else{if(this.update=="Y"){$("#chooseTable_"+ab).append($("<tr><td>"+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_UPDATE+"</td></tr>"))}}})}if(W!=undefined&&W.length>0){$.each(W,function(){if(this.isdel!="Y"&&this.isdel!="C"){$("#chooseTable_"+ab).append($("<tr><td>"+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(Z!=undefined&&Z.length>0){$.each(Z,function(){if(this.isdel=="Y"){$("#chooseTable_"+ab).append($("<tr><td>"+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_CLOSE+"</td></tr>"))}else{if(this.update=="Y"){$("#chooseTable_"+ab).append($("<tr><td>"+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_UPDATE+"</td></tr>"))}}})}if(Y!=undefined&&Y.length>0){$.each(Y,function(){if(this.dfQty==1){$("#chooseTable_"+ab).append($("<tr><td>"+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(OrderInfo.orderResult.autoBoInfos!=undefined){$.each(OrderInfo.orderResult.autoBoInfos,function(){if(this.instAccessNumber==OrderInfo.getAccessNumber(ab)){$("#chooseTable_"+ab).append($("<tr><td>"+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))}})}$("#chooseTable_"+ab).append("</tbody>")};var y=function(){SoOrder.delOrderFin();$("#order-content").show();$("#order-confirm").hide();OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();SoOrder.delOrder();F();if(CONST.getAppDesc()!=0){if($("#a-cust-modify")[0]){$("#a-cust-modify").show()}}};var G=function(){var W=OrderInfo.orderResult.olId;if(W!=0&&W!=undefined){var X={olId:W,areaId:OrderInfo.getAreaId()};$.callServiceAsJsonGet(contextPath+"/app/order/delOrder",X,{done:function(Y){if(Y.code==0){if(Y.data.resultCode==0){$.alert("提示","购物车作废成功！");OrderInfo.order.step=2}}else{if(Y.code==-2){$.alertM(Y.data.errData)}else{$.alert("提示","购物车作废失败！")}}},fail:function(Y){$.alert("提示","信息","请求可能发生异常，请稍后再试")}})}};var O=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,OrderInfo.orderResult.olId);$("a[href^='/']").off("mousedown").on("mousedown",function(){SoOrder.delOrderSilent();window.location.href=this.href});$(window).off("unload").on("unload",function(){SoOrder.delOrderSilent()})};var B=function(){var aa=$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID);$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);if(aa!=0&&aa!=undefined&&aa!=null){var ac={olId:aa,areaId:OrderInfo.getAreaId(),flag:"U"};var W=$.callServiceAsJsonGet(contextPath+"/order/delOrder",ac);var ab=[];for(var Z=0;Z<OrderInfo.boProdAns.length;Z++){var Y={accNbr:OrderInfo.boProdAns[Z].accessNumber,accNbrType:1,action:"UPDATE"};ab.push(Y)}if(ab.length>0){var X=contextPath+"/common/updateResState";$.callServiceAsJsonGet(X,{strParam:JSON.stringify(ab)},{done:function(ad){if(ad.code==0){if(ad.data){}}}})}OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();F();SoOrder.delOrderFin()}};var x=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);$("a[href^='/']").off("mousedown");$(window).off("unload")};var m=function(W,Y){var X=order.prodModify.choosedProdInfo;var Z={offerSpecId:X.prodOfferId,offerId:X.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:Y};OrderInfo.getOfferBusiOrder(W,Z,Y[0].objInstId);$.each(Y,function(){var aa={prodId:this.objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};W.push(OrderInfo.getProdBusiOrder(aa));$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.objInstId==prodId){this.isRemove="Y";return false}})})};var T=function(ah,ab){var W="";var ai=ab.viceParam;t=ai;var ae=ab.ooRoles;var ag=order.prodModify.choosedProdInfo;var Y={offerSpecId:ag.prodOfferId,offerId:ag.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:ab.ooRoles};$.each(OrderInfo.offer.offerMemberInfos,function(aj){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){W=this.objInstId;return false}});OrderInfo.getOfferBusiOrder(ah,Y,W);for(var ac=0;ac<ai.length;ac++){if(ai[ac].knew=="Y"){var X=ai[ac];var ad={areaId:ag.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:X.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};for(var aa=0;aa<OrderInfo.offer.offerMemberInfos.length;
aa++){var Z=OrderInfo.offer.offerMemberInfos[aa];if(Z.objInstId==X.objInstId){var ae={objId:Z.objId,objInstId:Z.objInstId,objType:Z.objType,offerRoleId:X.offerRoleId,state:"ADD"};ad.data.ooRoles.push(ae);break}}ah.push(ad)}else{var af={prodId:ai[ac].objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};ah.push(OrderInfo.getProdBusiOrder(af))}}};var g=function(ae,aa,Y){var ac=order.prodModify.choosedProdInfo;var ab=OrderInfo.boActionTypeCd;var X=ac.productId;var Z=ac.prodInstId;var ad=OrderInfo.actionClassCd;if(ab==CONST.BO_ACTION_TYPE.ADDOREXIT_COMP){X=ac.prodOfferId;Z=ac.prodOfferInstId;ad=CONST.ACTION_CLASS_CD.OFFER_ACTION}var W={areaId:OrderInfo.getProdAreaId(ac.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:X,instId:Z,isComp:Y,accessNumber:ac.accNbr,offerTypeCd:"1"},boActionType:{actionClassCd:ad,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};W.data=aa;ae.push(W)};var z=function(Z){if(OrderInfo.cust.custId==-1){OrderInfo.createCust(Z)}var X=-1;if(OrderInfo.acct!=undefined&&OrderInfo.acct.acctId!=undefined&&OrderInfo.acct.acctId!=null&&OrderInfo.acct.acctId!=""){X=OrderInfo.acct.acctId}if(X<0&&X!=undefined){OrderInfo.createAcct(Z,X)}var aa=p(Z);for(var Y=0;Y<aa.data.ooRoles.length;Y++){var W=aa.data.ooRoles[Y];if(W.objType==2&&W.memberRoleCd!=undefined){Z.push(o(W.objInstId,W.objId))}}AttachOffer.setAttachBusiOrder(Z)};var F=function(){var W=$.callServiceAsHtmlGet(contextPath+"/common/getToken");OrderInfo.order.token=W.data};var c=function(){var W=$.callServiceAsHtmlGet(contextPath+"/common/getToken");OrderInfo.order.token=W.data};var w=function(ae){var ad=order.prodModify.choosedProdInfo;var W={areaId:ad.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ad.prodOfferId,instId:ad.prodOfferInstId,accessNumber:ad.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP},data:{ooRoles:[]}};if(ec.util.isArray(OrderInfo.oldprodInstInfos)){var aa="";for(var ab=0;ab<OrderInfo.offerSpec.offerRoles.length;ab++){var af=OrderInfo.offerSpec.offerRoles[ab];if(af.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){aa=af.offerRoleId;break}}var ag=(OrderInfo.hasMainCarFlag)?CONST.BO_ACTION_TYPE.DEL_OFFER:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;for(var Y=0;Y<OrderInfo.oldprodInstInfos.length;Y++){var Z=OrderInfo.oldprodInstInfos[Y];var X={areaId:Z.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:Z.mainProdOfferInstInfos[0].prodOfferId,instId:Z.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:Z.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var ac=-1;for(var ab=0;ab<OrderInfo.oldoffer.length;ab++){if(OrderInfo.oldoffer[ab].accNbr==Z.accNbr){$.each(OrderInfo.oldoffer[ab].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var ah={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:ac,offerRoleId:aa,state:"ADD"};W.data.ooRoles.push(ah);var ai={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};X.data.ooRoles.push(ai);--ac}})}}ae.push(X)}if(CONST.getAppDesc()==0){for(var ab=0;ab<OrderInfo.oldoffer.length;ab++){$.each(OrderInfo.oldoffer[ab].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var ah={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var ai=OrderInfo.getProdBusiOrder(ah);if(ai){ae.push(ai)}}}})}}}AttachOffer.setAttachBusiOrder(ae);ae.push(W)};var I=function(ak,al){var am=al;var ad="";var X=true;var aj=CONST.ACTION_CLASS_CD.OFFER_ACTION;var ai=CONST.BO_ACTION_TYPE.DEL_OFFER;var Y=CONST.ACTION_CLASS_CD.OFFER_ACTION;var ah=CONST.BO_ACTION_TYPE.BUY_OFFER;if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){aj=CONST.ACTION_CLASS_CD.PROD_ACTION;ai=CONST.BO_ACTION_TYPE.BUY_BACK;Y=CONST.ACTION_CLASS_CD.OFFER_ACTION;ah=CONST.BO_ACTION_TYPE.BUY_OFFER;v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.BUY_BACK;am=al.viceParam;ad=al.remark}else{if(OrderInfo.actionFlag==7){v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.REMOVE_PROD}}for(var ac=0;ac<am.length;ac++){var Z=am[ac];if(Z.del=="N"){X=false}}if(X){t=am;var W={areaId:OrderInfo.getProdAreaId(order.prodModify.choosedProdInfo.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,objId:order.prodModify.choosedProdInfo.productId,instId:order.prodModify.choosedProdInfo.prodInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:order.prodModify.choosedProdInfo.prodStateCd,state:"DEL"},{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};ak.push(W);for(var ac=0;ac<am.length;ac++){var Z=am[ac];var W={areaId:OrderInfo.getProdAreaId(Z.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:Z.accessNumber,objId:Z.objId,instId:Z.objInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};ak.push(W)}return}if(OrderInfo.actionFlag==7){t=am;var ag=order.prodModify.choosedProdInfo;var W={areaId:OrderInfo.getProdAreaId(ag.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ag.prodOfferId,instId:ag.prodOfferInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:aj,boActionTypeCd:ai},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"DEL"}]}};for(var ac=0;ac<OrderInfo.offer.offerMemberInfos.length;ac++){var ab=OrderInfo.offer.offerMemberInfos[ac];var af={objId:ab.objId,objInstId:ab.objInstId,objType:ab.objType,offerMemberId:ab.offerMemberId,offerRoleId:ab.offerRoleId,state:"DEL"};W.data.ooRoles.push(af)}ak.push(W)}else{var ag=order.prodModify.choosedProdInfo;var W={areaId:OrderInfo.getProdAreaId(ag.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ag.productId,instId:ag.prodInstId,accessNumber:ag.accNbr,isComp:"N"},boActionType:{actionClassCd:aj,boActionTypeCd:ai},data:{boProdStatuses:[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};ak.push(W)}for(var ac=0;ac<am.length;ac++){var Z=am[ac];if(Z.del=="N"){var ae={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:Z.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:Y,boActionTypeCd:ah},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};for(var aa=0;aa<OrderInfo.offer.offerMemberInfos.length;aa++){var ab=OrderInfo.offer.offerMemberInfos[aa];if(ab.objInstId==Z.objInstId){var af={objId:ab.objId,objInstId:ab.objInstId,objType:ab.objType,offerRoleId:Z.offerRoleId,state:"ADD"};ae.data.ooRoles.push(af);break}}ak.push(ae)}else{var W={areaId:OrderInfo.getProdAreaId(Z.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:Z.accessNumber,objId:Z.objId,instId:Z.objInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};ak.push(W)
}}};var M=function(X){AttachOffer.setAttachBusiOrder(X);var Y=order.prodModify.choosedProdInfo;if(AttachOffer.isChangeUim(Y.prodInstId)){if(OrderInfo.boProd2Tds.length>0){var W={prodId:Y.prodInstId,prodSpecId:Y.productId,isComp:"N",accessNumber:Y.accNbr,boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};X.push(OrderInfo.getProdBusiOrder(W))}}};var U=function(W,Y){var X={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};X.data=Y;W.push(X)};var u=function(X,Z){var Y={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};Y.data=Z;X.push(Y);var W={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,objId:order.prodModify.choosedProdInfo.productId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACTIVERETURNTWO},data:{}};W.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.READY_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.DONE_PROD,state:"ADD"}];X.push(W)};var i=function(W,Y){var X={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};X.data=Y;W.push(X)};var p=function(ai){var W={areaId:OrderInfo.getProdAreaId(-1),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.offerSpec.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[],busiOrderAttrs:[]}};var ab=OrderInfo.getAccessNumber(-1);if(ec.util.isObj(ab)){W.busiObj.accessNumber=ab}$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var am={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,memberRoleCd:this.memberRoleCd,offerRoleId:this.offerRoleId,state:"ADD"};W.data.ooRoles.push(am);var al=this.prodInstId;if(this.servInsts!=undefined&&this.servInsts.length>0){$.each(this.servInsts,function(){var an={objId:this.objId,objInstId:OrderInfo.SEQ.servSeq--,objType:this.objType,prodId:al,offerRoleId:this.offerRoleId,state:"ADD"};W.data.ooRoles.push(an)})}})});if(order.service.oldMemberFlag){var ac="";for(var ae=0;ae<OrderInfo.offerSpec.offerRoles.length;ae++){var aj=OrderInfo.offerSpec.offerRoles[ae];if(aj.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ac=aj.offerRoleId;break}}for(var Y=0;Y<OrderInfo.oldprodInstInfos.length;Y++){var Z=OrderInfo.oldprodInstInfos[Y];var X={areaId:Z.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:Z.mainProdOfferInstInfos[0].prodOfferId,instId:Z.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:Z.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var ah=-1;for(var ae=0;ae<OrderInfo.oldoffer.length;ae++){if(OrderInfo.oldoffer[ae].accNbr==Z.accNbr){$.each(OrderInfo.oldoffer[ae].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var al={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:ah,offerRoleId:ac,state:"ADD"};W.data.ooRoles.push(al);var am={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};X.data.ooRoles.push(am);--ah}})}}ai.push(X)}if(CONST.getAppDesc()==0){for(var ae=0;ae<OrderInfo.oldoffer.length;ae++){$.each(OrderInfo.oldoffer[ae].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var al={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var am=OrderInfo.getProdBusiOrder(al);if(am){ai.push(am)}}}})}}}var af=OrderInfo.offerSpec.offerSpecParams;if(af!=undefined&&af.length>0){W.data.ooParams=[];for(var ae=0;ae<af.length;ae++){var aa=af[ae];var ad={itemSpecId:aa.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:aa.offerSpecParamId,value:aa.value,state:"ADD"};W.data.ooParams.push(ad)}}if(OrderInfo.offerSpec.ooTimes!=undefined){W.data.ooTimes=[];W.data.ooTimes.push(OrderInfo.offerSpec.ooTimes)}var ak={partyId:OrderInfo.cust.custId,state:"ADD"};W.data.ooOwners.push(ak);var ag=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(ag!=undefined){ag.each(function(){var al={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select[name='dealerType_"+OrderInfo.offerSpec.offerSpecId+"']").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()};W.data.busiOrderAttrs.push(al);var am={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select[name='dealerType_"+OrderInfo.offerSpec.offerSpecId+"']").val(),value:$(this).find("input").attr("value")};W.data.busiOrderAttrs.push(am)})}ai.push(W);return W};var o=function(ac,ah){var W={areaId:OrderInfo.getProdAreaId(ac),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ah,instId:ac,isComp:"N"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:"1"},data:{boProdFeeTypes:[],boProdSpecs:[{prodSpecId:ah,state:"ADD"}],boCusts:[],boProdItems:[],boProdPasswords:[],boProdAns:[],bo2Coupons:[],boAccountRelas:[],boProdStatuses:[],busiOrderAttrs:[]}};var Z=CONST.PROD_STATUS_CD.NORMAL_PROD;W.data.boProdStatuses.push({state:"ADD",prodStatusCd:Z});var X=OrderInfo.boProdAns;for(var ab=0;ab<X.length;ab++){if(X[ab].prodId==ac){W.data.boProdAns.push(X[ab]);W.busiObj.accessNumber=X[ab].accessNumber;break}}var af=OrderInfo.boProd2Tds;for(var ab=0;ab<af.length;ab++){if(af[ab].prodId==ac){W.data.bo2Coupons.push(af[ab]);break}}W.data.boCusts.push({partyId:OrderInfo.cust.custId,partyProductRelaRoleCd:"0",state:"ADD"});var ad=$("#pwd_"+ac).val();if(ad=="******"||OrderInfo.actionFlag==1){ad=order.main.genRandPass6()}var aa={prodPwTypeCd:2,pwd:ad,state:"ADD"};W.data.boProdPasswords.push(aa);$("[name=prodSpec_"+ac+"]").each(function(){var aj=$(this).attr("id").split("_")[0];var al=$.trim($(this).val());if(al!=""&&al!=undefined){var ak={itemSpecId:aj,prodSpecItemId:OrderInfo.SEQ.itemSeq--,state:"ADD",value:al};W.data.boProdItems.push(ak)}});var ae=$('select[name="pay_type_-1"]').val();if(ae!=undefined){W.data.boProdFeeTypes.push({feeType:ae,state:"ADD"})}var ag=-1;if(OrderInfo.acct!=undefined&&OrderInfo.acct.acctId!=undefined&&OrderInfo.acct.acctId!=null&&OrderInfo.acct.acctId!=""){ag=OrderInfo.acct.acctId}var ai=-1;if(ag==undefined){ag=-1;ai=-1}else{if(ag<0){ai=ag}else{ai=OrderInfo.acct.acctcd}}var Y={acctId:ag,acctCd:ai,acctRelaTypeCd:"1",chargeItemCd:"0",percent:"100",priority:"1",state:"ADD"};W.data.boAccountRelas.push(Y);return W};var D=function(Z,Y,W,X){if(W==1){Z.offerTypeCd=2;Z.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;OrderInfo.getOfferBusiOrder(X,Z,Y)}else{if(W==2){if(Z.offerSpec.offerSpecParams!=undefined&&Z.offerSpec.offerSpecParams.length>0){Z.offerTypeCd=2;Z.boActionTypeCd=CONST.BO_ACTION_TYPE.UPDATE_OFFER;OrderInfo.getOfferBusiOrder(X,Z,Y)}}else{Z.offerTypeCd=2;Z.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;Z.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(X,Z,Y)}}};var Q=function(X,Z,W,Y){X.prodId=Z;if(W==1){X.servClose="Y";X.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;Y.push(OrderInfo.getProdBusiOrder(X))}else{if(W==2){if(X.prodSpecParams!=undefined&&X.prodSpecParams.length>0){X.boActionTypeCd=CONST.BO_ACTION_TYPE.PRODUCT_PARMS;
X.memberId=X.servId;Y.push(OrderInfo.getProdBusiOrder(X))}}else{X.servId=OrderInfo.SEQ.servSeq--;X.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;Y.push(OrderInfo.getProdBusiOrder(X))}}};var f=function(W){var X={};X.boProdAns=OrderInfo.boProdAns;OrderInfo.setProdModifyBusiOrder(W,X)};var P=function(){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14||(OrderInfo.actionFlag==2&&offerChange.newMemberFlag)){if(OrderInfo.cust.custId==""){$.alert("提示","客户信息不能为空！");return false}if(ec.util.isArray(OrderInfo.oldprodAcctInfos)){for(var aA=0;aA<OrderInfo.oldprodAcctInfos.length;aA++){var ag=OrderInfo.oldprodAcctInfos[aA].prodAcctInfos[0].acctId;var aj=$("#acctSelect option:selected").val();if(ag!=aj){$.alert("提示","副卡和主卡的账户不一致！");return false}}}if(order.service.oldMemberFlag){var ai=$('select[name="pay_type_-1"]').val();var ah=0;var ae="";$.each(OrderInfo.oldprodInstInfos,function(){if(this.feeType.feeType!=ai){ah=1;ae=this.accNbr;return}});if(ah==1){}}for(var ay=0;ay<OrderInfo.offerSpec.offerRoles.length;ay++){var at=OrderInfo.offerSpec.offerRoles[ay];var aB=OrderInfo.offerSpec.offerRoles[ay].prodInsts;if(aB!=undefined&&aB!=null&&aB!=""){for(var au=0;au<at.prodInsts.length;au++){var ab=at.prodInsts[au];if(OrderInfo.actionFlag==2){var aq='"'+ab.prodInstId+'"';if(ab.memberRoleCd=="401"&&aq.indexOf("-")!=-1){var av=OrderInfo.getProdAn(ab.prodInstId).accessNumber;if(av==undefined||av==""){$.alert("信息提示","【接入产品("+at.offerRoleName+")】号码不能为空！");return false}if(OrderInfo.getProdTd(ab.prodInstId)==""){$.alert("信息提示","【接入产品("+at.offerRoleName+")】UIM卡不能为空！");$("#uim_txt_"+ab.prodInstId).css("border-color","red");return false}}}else{var av=OrderInfo.getProdAn(ab.prodInstId).accessNumber;if(av==undefined||av==""){$.alert("信息提示","【接入产品("+at.offerRoleName+")】号码不能为空！");return false}if(OrderInfo.getProdTd(ab.prodInstId)==""){$.alert("信息提示","【接入产品("+at.offerRoleName+")】UIM卡不能为空！");$("#uim_txt_"+ab.prodInstId).css("border-color","red");return false}}var ax=false;$("[name='pay_type_-1']").each(function(){if($(this).val()!=undefined&&$(this).val()!=null&&$(this).val()!=""){ax=true}});if(!ax){$.alert("信息提示","没有配置付费类型，无法提交");return false}var Y=true;var af=null;$(OrderInfo.prodAttrs).each(function(){var aC=this.isOptional;var aE=this.id;if(aC=="N"&&aE){var aD=$.trim($("#"+aE).val());if(aD==""||aD==undefined){af=this.name;Y=false}}});if(!Y){$.alert("信息提示","没有配置产品属性("+af+")，无法提交");return false}}}}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==3||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var ay=0;ay<AttachOffer.openList.length;ay++){var aa=AttachOffer.openList[ay].specList;var am=OrderInfo.getOfferRoleName(AttachOffer.openList[ay].prodId);for(var au=0;au<aa.length;au++){var ad=aa[au];if(ad.isdel!="Y"&&ad.isdel!="C"){if(ad.ifParams){if(ad.isset!="Y"){}}}}}for(var ay=0;ay<AttachOffer.openServList.length;ay++){var aa=AttachOffer.openServList[ay].servSpecList;var am=OrderInfo.getOfferRoleName(AttachOffer.openServList[ay].prodId);for(var au=0;au<aa.length;au++){var ad=aa[au];if(ad.isdel!="Y"&&ad.isdel!="C"){if(ad.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){if("no"==$("#isMIFI_-"+(ay+1)).val()){$.alert("提示","要开通"+ad.servSpecName+"功能，请选择4G上网卡-全球卡（MIFI卡）！");$("#uim_txt_-"+(ay+1)).css("border-color","red");return false}}if(ad.ifParams=="Y"){if(ad.isset!="Y"){}}}}}for(var ay=0;ay<AttachOffer.openList.length;ay++){var aa=AttachOffer.openList[ay].specList;var ar=AttachOffer.openList[ay].prodId;var am=OrderInfo.getOfferRoleName(ar);for(var au=0;au<aa.length;au++){var ad=aa[au];if(ad.isdel!="Y"&&ad.isdel!="C"){if(ad.isTerminal==1){var ax=true;$.each(OrderInfo.attach2Coupons,function(){if(ad.offerSpecId==this.attachSepcId&&ar==this.prodId){ax=false;return false}});if(ax){$.alert("提示",am+" "+ad.offerSpecName+"：终端信息未填写");return false}}}}}}if(CONST.getAppDesc()==0){if(OrderInfo.actionFlag==2){for(var ay=0;ay<OrderInfo.offer.offerMemberInfos.length;ay++){var X=OrderInfo.offer.offerMemberInfos[ay];if(X.objType==CONST.OBJ_TYPE.PROD){if(AttachOffer.isChangeUim(X.objInstId)){var ac=OrderInfo.getProdTd(X.objInstId);if(ac==""){$.alert("提示",X.roleName+" UIM卡不能为空！");return false}}}}var ap=true;if(offerChange.oldMemberFlag){for(var ay=0;ay<OrderInfo.oldoffer.length;ay++){$.each(OrderInfo.oldoffer[ay].offerMemberInfos,function(){var aD=this;if(aD.objType==CONST.OBJ_TYPE.PROD){if(AttachOffer.isChangeUim(aD.objInstId)){var aC=OrderInfo.getProdTd(aD.objInstId);if(aC==""){$.alert("提示","加装移动电话"+aD.accessNumber+" UIM卡不能为空！");ap=false;return false}}}});if(!ap){break}}if(!ap){return}}}else{if(OrderInfo.actionFlag==3){if(AttachOffer.isChangeUim()){if(OrderInfo.boProd2Tds.length==0){$.alert("提示","UIM卡不能为空！");return false}}}}}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(OrderInfo.boProd2OldTds.length==0){$.alert("提示","原UIM卡信息为空！");return false}if(OrderInfo.boProd2Tds.length==0){$.alert("提示","UIM卡不能为空！");return false}}if(CONST.getAppDesc()==0){for(var ay=0;ay<AttachOffer.openServList.length;ay++){var aa=AttachOffer.openServList[ay].servSpecList;var ax=false;var ao=false;$.each(aa,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G&&this.isdel!="Y"&&this.isdel!="C"){ax=true;return false}});var ar=AttachOffer.openServList[ay].prodId;var al="";if(AttachOffer.openList[ay]!=undefined){var W=AttachOffer.openList[ay].specList;for(var au=0;au<W.length;au++){var ad=W[au];if(ad.isdel!="Y"&&ad.isdel!="C"){if(ad.isTerminal==1){$.each(OrderInfo.attach2Coupons,function(){if(ar==this.prodId){ao=true;if(ec.util.isObj(this.termTypeFlag)){al=this.termTypeFlag}return false}})}}}}var am=OrderInfo.getOfferRoleName(ar);if(ao&&al==""){$.alert("信息提示",am+"中,营销资源未返回终端机型，无法判断是3G终端还是4G终端!");return false}if(ax){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){var Z=OrderInfo.getProdUim(ar);if(Z.cardTypeFlag=="2"){$.alert("信息提示",am+"中UIM卡是3G卡，无法提交");return false}if(ao&&al=="2"){$.alert("信息提示",am+"中终端是3G机型，无法提交");return false}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){var an=OrderInfo.getProdOldUim(ar);if(an.is4GCard!="Y"){var Z=OrderInfo.getProdUim(ar);if(Z.cardTypeFlag=="2"){$.alert("信息提示",am+"中UIM卡是3G卡，无法提交");return false}}if(ao&&al=="2"){$.alert("信息提示",am+"中终端是3G机型，无法提交");return false}}}}else{if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(ao){var Z=OrderInfo.getProdUim(ar);if(Z.cardTypeFlag!=al){var aw=Z.cardTypeFlag=="1"?"4G卡":"3G卡";var az=al=="1"?"4G机型":"3G机型";$.alert("信息提示",am+"中UIM卡是"+aw+" 终端是"+az+"，无法提交");return false}}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){if(ao){var ak=OrderInfo.getProdUim(ar);if(ec.util.isObj(ak)&&ec.util.isObj(ak.cardTypeFlag)){if(ak.cardTypeFlag=="2"&&al=="1"){$.alert("信息提示",am+"中UIM卡是3G卡 终端是4G机型，无法提交");return false}if(ak.cardTypeFlag=="1"&&al=="2"){$.alert("信息提示",am+"中UIM卡是4G卡 终端是3G机型，无法提交");return false}}else{var an=OrderInfo.getProdOldUim(ar);if(ec.util.isObj(an.is4GCard)){if(an.is4GCard!="Y"){if(al=="1"){$.alert("信息提示",am+"中UIM卡是3G卡 终端是4G机型，无法提交");return false}}else{if(al=="2"){$.alert("信息提示",am+"中UIM卡是4G卡 终端是3G机型，无法提交");return false}}}}}}}}}}return true};var r=function(){if($.trim($("#acctName").val())==""){$.alert("提示","帐户名称不能为空");return false}if($("#paymentType").val()==110000){if($("#bankId").val()==""||$.trim($("#bankAcct").val())==""||$.trim($("#paymentMan").val())==""){$.alert("提示","若选择银行支付请填写必要的银行支付信息");return false}}if($("#postType").val()!=-1){if($.trim($("#postAddress").val())==""){$.alert("提示","若选择投递账单请填写必要的账单投递信息");return false}if($("#postType").val()==13){var W=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;if(W.test($("#postAddress").val())==false){$.alert("提示","若选择 Email 投递帐单请输入有效的 Email 地址");return false}}}return true};var b=function(){var Z=[];for(var Y=0;Y<OrderInfo.boProdAns.length;Y++){var X={accNbr:OrderInfo.boProdAns[Y].accessNumber,accNbrType:1,action:"UPDATE"};Z.push(X)}for(var Y=0;Y<OrderInfo.boProd2Tds.length;Y++){var X={accNbr:OrderInfo.boProd2Tds[Y].terminalCode,accNbrType:2,action:"UPDATE"};
Z.push(X)}if(Z.length>0){var W=contextPath+"/common/updateResState";$.callServiceAsJsonGet(W,{strParam:JSON.stringify(Z)},{done:function(aa){if(aa.code==0){if(aa.data){}}}})}};var j=function(W){if($("#isTemplateOrder").attr("checked")=="checked"){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$(".template_info_type").show();$("#isActivation").removeAttr("checked");$("#isActivation").attr("disabled","disabled")}$(".template_info_name").show()}else{$(".template_info_name").hide();$(".template_info_type").hide();$("#templateOrderName").val("");$("#isActivation").removeAttr("disabled")}};var e=function(){if($("#isActivation").attr("checked")=="checked"){$("#isTemplateOrder").removeAttr("checked");$("#isTemplateOrder").attr("disabled","disabled");$(".template_info_name").hide();$(".template_info_type").hide();$("#templateOrderName").val("")}else{$("#isTemplateOrder").removeAttr("disabled")}};var s=function(Z){var X=[];for(var W=0;W<Z.offerRoles.length;W++){var Y=Z.offerRoles[W];if(Y.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){X.push(Y)}}for(var W=0;W<Z.offerRoles.length;W++){var Y=Z.offerRoles[W];if(Y.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){X.push(Y)}}Z.offerRoles=X;return Z};var h=function(){var W=false;var aa=order.prodModify.choosedProdInfo.prodClass;var Z=order.prodModify.choosedProdInfo.prodInstId;var X=CacheData.getOfferSpecList(Z);if(ec.util.isArray(X)){$.each(X,function(){if(this.ifPackage4G=="Y"&&this.isdel!="Y"&&this.isdel!="C"){W=true;return false}})}if(CONST.getAppDesc()==0&&W&&aa==CONST.PROD_CLASS.THREE&&OrderInfo.actionFlag==3){if(offerChange.checkOrder()){var Y=offerChange.checkAttachOffer(Z);if(Y!=""){if(P()){$("#offer_serv").html(Y);easyDialog.open({container:"offer_dialog"})}}else{SoOrder.submitOrder()}}}else{SoOrder.submitOrder()}};var J=function(){var W=order.prodModify.choosedProdInfo.prodInstId;AttachOffer.setChangeList(W);SoOrder.submitOrder();easyDialog.close()};var q=function(){var aa=order.prodModify.choosedProdInfo.is3G;if(OrderInfo.actionFlag==2){var Y=OrderInfo.offerSpec.is3G;if(ec.util.isObj(aa)){if(ec.util.isObj(Y)){if(aa=="Y"&&Y=="N"){return true}}}}else{if(OrderInfo.actionFlag==3){if(ec.util.isObj(aa)){if(aa=="Y"){for(var Z=0;Z<AttachOffer.openServList.length;Z++){var X=AttachOffer.openServList[Z].servSpecList;var W=false;$.each(X,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G&&this.isdel!="Y"&&this.isdel!="C"){W=true;return false}});if(W){return true}}}}}}return false};var L=function(X,W){$("#modal-title").html(X);$("#modal-content").html(W);$("#alert-modal").modal("show")};return{builder:R,createAttOffer:D,createServ:Q,delOrder:G,delAndNew:I,getOrderInfo:K,getToken:F,getTokenSynchronize:c,initFillPage:l,initOrderData:E,orderBack:y,step:C,showStep:S,submitOrder:v,showAlertDialog:L,checkAcctInfo:r,showTemplateOrderName:j,sortOfferSpec:s,updateResState:b,delOrderBegin:O,delOrderSilent:B,delOrderFin:x,showActivation:e,checkOrder:h,orderPrepare:J,checkData:P,createProd:o}})();CommonUtils.regNamespace("AttachOffer");AttachOffer=(function(){var _openList=[];var _openedList=[];var _openServList=[];var _openedServList=[];var _openAppList=[];var _changeList=[];var _labelList=[];var checkedReserveNbr="";var checkedReserveCode="";var checkedOfferSpec=[];var totalNums=0;var _init=function(){var prodInfo=order.prodModify.choosedProdInfo;if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=3;query.offer.setOffer(function(){if(!rule.rule.ruleCheck()){return}var param={offerSpecId:prodInfo.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};if(ec.util.isObj(prodInfo.prodOfferId)){if(!query.offer.queryMainOfferSpec(param)){return}}else{OrderInfo.offerSpec={}}if(CONST.getAppDesc()==0){if(!prod.uim.setProdUim()){return}}AttachOffer.queryAttachOffer()})};var _queryAttachOfferSpec=function(param){var data=query.offer.queryAttachSpec(param);if(data){$("#attach_"+param.prodId).html(data);_showMainRoleProd(param.prodId);AttachOffer.changeLabel(param.prodId,param.prodSpecId,"100");if(param.prodId==-1&&OrderInfo.actionFlag==14){AttachOffer.addOpenList(param.prodId,mktRes.terminal.offerSpecId)}}};var _showApp=function(prodId){var appList=CacheData.getOpenAppList(prodId);var content=CacheData.getAppContent(prodId,appList);$.confirm("增值业务设置： ",content[0].innerHTML,{yes:function(){$.each(appList,function(){if($("#"+prodId+"_"+this.objId).attr("checked")=="checked"){this.dfQty=1}else{this.dfQty=0}})},no:function(){}})};var getProdInst=function(prodId){for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(ec.util.isArray(offerRole.prodInsts)){for(var j=0;j<offerRole.prodInsts.length;j++){if(offerRole.prodInsts[j].prodInstId==prodId){return offerRole.prodInsts[j]}}}}};var _showMainRoleProd=function(prodId){var prodInst=getProdInst(prodId);var app={prodId:prodId,appList:[]};AttachOffer.openAppList.push(app);for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(roleObj.objType==CONST.OBJ_TYPE.SERV){if(prodInst.objId==roleObj.parentProdId&&prodInst.componentTypeCd.substring(0,1)==roleObj.componentTypeCd.substring(0,1)){app.appList.push(roleObj);if(roleObj.servSpecId==undefined){roleObj.servSpecId=roleObj.objId}if(roleObj.servSpecName==undefined){roleObj.servSpecName=roleObj.objName}}}}if(app.appList.length>0){var $li=$('<li id="li_'+prodId+"_"+offerRole.offerRoleId+'"></li>');$li.append('<dd class="mustchoose" ></dd>');$li.append("<span>"+offerRole.offerRoleName+"</span>");$li.append('<dd id="can_'+prodId+"_"+offerRole.offerRoleId+'" class="gou2" onclick="AttachOffer.showApp('+prodId+');"></dd>');$("#open_app_ul_"+prodId).append($li)}}else{if(offerRole.prodInsts==undefined){continue}$.each(offerRole.prodInsts,function(){if(this.prodInstId==prodId){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldLi=$("#li_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(roleObj.dfQty==0&&spec.ifDault==1){var $span=$oldLi.find("span");$span.addClass("del");spec.isdel="Y"}}if(roleObj.minQty==1){$oldLi.removeAttr("onclick");var $span=$("#span_"+prodId+"_"+spec.servSpecId);var $span_remove=$("#span_remove_"+prodId+"_"+spec.servSpecId);if(ec.util.isObj($span)){$span.removeClass("del")}if(ec.util.isObj($span_remove)){$span_remove.hide()}}continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){var $span=$("#span_"+prodId+"_"+offer.servId);var $span_remove=$("#span_remove_"+prodId+"_"+offer.servId);if(ec.util.isObj($span)){$span.removeClass("del")}if(ec.util.isObj($span_remove)){$span_remove.hide()}$oldLi.removeAttr("onclick")}continue}if(roleObj.dfQty>0){var servSpec=jQuery.extend(true,{},roleObj);CacheData.setServSpec(prodId,servSpec);spec=servSpec;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<a id="li_'+prodId+"_"+servSpecId+'" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+'\')" class="list-group-item"></a>');$li.append('<span id="span_'+prodId+"_"+servSpecId+'">'+spec.servSpecName+"</span>");if(roleObj.minQty==0){$li.append('<span id="span_remove_'+prodId+"_"+servSpecId+'" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span>')}else{$li.removeAttr("onclick")}$("#open_serv_ul_"+prodId).append($li);spec.isdel="N";_showHideUim(0,prodId,servSpecId)}}}}})}}};var _showMainMemberRoleProd=function(prodId){for(var i=0;i<OrderInfo.viceOfferSpec.length;i++){var offerSpec=OrderInfo.viceOfferSpec[i];if(prodId==offerSpec.prodId){for(var j=0;
j<offerSpec.offerRoles.length;j++){var offerRole=offerSpec.offerRoles[j];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldLi=$("#li_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}if(roleObj.dfQty>0){var servSpec=jQuery.extend(true,{},roleObj);CacheData.setServSpec(prodId,servSpec);spec=servSpec;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');if(roleObj.minQty==0){$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+"')\"></dd>")}else{$li.append('<dd class="mustchoose"></dd>')}$li.append("<span>"+spec.servSpecName+"</span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$li.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');$("#open_serv_ul_"+prodId).append($li);spec.isdel="N";_showHideUim(0,prodId,servSpecId)}}}}}}}};var _searchAttachOfferSpec=function(prodId,offerSpecId,prodSpecId){var param={prodId:prodId,prodSpecId:prodSpecId,offerSpecIds:[offerSpecId],ifCommonUse:""};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){if(this.prodInstId==prodId){param.acctNbr=this.accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}})}else{if(OrderInfo.actionFlag==3){var prodInfo=order.prodModify.choosedProdInfo;param.acctNbr=prodInfo.accNbr;if(!ec.util.isObj(prodInfo.prodOfferId)){prodInfo.prodOfferId=""}var offerRoleId=CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;if(offerRoleId==undefined){offerRoleId=""}param.offerRoleId=offerRoleId;param.offerSpecIds.push(prodInfo.prodOfferId)}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.viceOfferSpec,function(){var offerSpecId=this.offerSpecId;var accessNumber=this.accessnumber;if(this.prodId==prodId){$.each(this.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||this.memberRoleCd=="1"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){param.acctNbr=accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(offerSpecId);return false}})}})}})}else{if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr;$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){param.offerSpecIds.push(this.offerSpec.offerSpecId);$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){param.offerRoleId=this.offerRoleId}})}})}}}else{param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}}}}}var offerSepcName=$("#search_text_"+prodId).val();if(offerSepcName.replace(/\ /g,"")==""){$.alert("提示","请输入查询条件！");return}param.offerSpecName=offerSepcName;query.offer.searchAttachOfferSpec(param,function(data){if(data!=undefined){$("#attach_div_"+prodId).html(data).show();$("#btn_hide_"+prodId).show();$("#attachSearch_div_"+prodId+" div").each(function(){$(this).hide()})}})};var _closeSearchAttach=function(prodId){$("#attach_div_"+prodId).hide();$("#btn_hide_"+prodId).hide();var labelId=$("#attach_div_"+prodId).attr("value");$("#ul_"+prodId+"_"+labelId).show()};var _selectAttachOffer=function(prodId,offerSpecId){_addAttOffer(prodId,offerSpecId)};var _selectServ=function(prodId,servSpecId,specName,ifParams){$("#attach_div_"+prodId).hide();_openServSpec(prodId,servSpecId,specName,ifParams)};var _closeAttachSearch=function(prodId){$("#attach_div_"+prodId).hide();$("#attachSearch_div_"+prodId+" div").each(function(){$(this).show()})};var _queryAttachOffer=function(){var prodInfo=order.prodModify.choosedProdInfo;var prodId=prodInfo.prodInstId;var param={prodId:prodId,prodSpecId:prodInfo.productId,offerSpecId:prodInfo.prodOfferId,acctNbr:prodInfo.accNbr};if(ec.util.isObj(prodInfo.prodBigClass)){param.prodBigClass=prodInfo.prodBigClass}query.offer.queryAttachOfferHtml(param,function(data){SoOrder.initFillPage();$("#order-content").html(data).show();$("#fillNextStep").off("click").on("click",function(){if(!SoOrder.checkData()){return false}$("#order-content").hide();$("#order-dealer").show();order.dealer.initDealer()});var member=CacheData.getOfferMember(prodId);if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){param.queryType="1,2";param.objId=member.objId;param.objType=member.objType;param.offerRoleId=member.offerRoleId;param.memberRoleCd=member.roleCd;var data=query.offer.queryDefMustOfferSpec(param);CacheData.parseOffer(data,prodId);var data=query.offer.queryServSpec(param,prodId);CacheData.parseServ(data)}if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){var member=CacheData.getOfferMember(prodId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==member.offerRoleId&&member.objType==CONST.OBJ_TYPE.PROD){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(this.minQty==1){$oldLi.removeAttr("onclick");var $span=$("#span_"+prodId+"_"+serv.servId);var $span_remove=$("#span_remove_"+prodId+"_"+serv.servId);if(ec.util.isObj($span)){$span.removeClass("del")}if(ec.util.isObj($span_remove)){$span_remove.hide()}}}}});return false}})}order.dealer.initDealer()})};var _delOfferSpec=function(prodId,offerSpecId){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.addOfferSpec(prodId,offerSpecId)}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);var content=CacheData.getOfferProdStr(prodId,spec,2);$.confirm("信息确认",content,{yes:function(){$span.addClass("del");spec.isdel="Y";delServSpec(prodId,spec);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#terminalUl_"+prodId+"_"+offerSpecId).remove();spec.isTerminal=0},no:function(){}})}};var _delOfferSpecReload=function(prodId,offerSpecId){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.addOfferSpec(prodId,offerSpecId)}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);var content=CacheData.getOfferProdStr(prodId,spec,2);$span.addClass("del");spec.isdel="Y";delServSpec(prodId,spec);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#terminalUl_"+prodId+"_"+offerSpecId).remove();spec.isTerminal=0}};var _delOffer=function(prodId,offerId){var $span=$("#li_"+prodId+"_"+offerId).find("span");if($span.attr("class")=="del"){AttachOffer.addOffer(prodId,offerId,$span.text())}else{var offer=CacheData.getOffer(prodId,offerId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offerId};
if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.areaId=OrderInfo.oldprodInstInfos[i].areaId;param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr}}}else{param.acctNbr=OrderInfo.getAccessNumber(prodId)}var data=query.offer.queryOfferInst(param);if(data==undefined){return}var offerMemberInfos=[];$.each(data.offerMemberInfos,function(){var prodInstId=this.objInstId;var flag=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==prodInstId){flag=true;return false}});if(flag){offerMemberInfos.push(this)}});offer.offerMemberInfos=data.offerMemberInfos=offerMemberInfos;offer.offerSpec=data.offerSpec}var content="";if(offer.offerSpec!=undefined){content=CacheData.getOfferProdStr(prodId,offer,1)}else{content="退订【"+$span.text()+"】可选包"}$.confirm("信息确认",content,{yes:function(){offer.isdel="Y";$span.addClass("del");delServByOffer(prodId,offer)},no:function(){}})}};var _closeServSpec=function(prodId,servSpecId,specName,ifParams){var $span=$("#li_"+prodId+"_"+servSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams)}else{$.confirm("信息确认","取消开通【"+$span.text()+"】功能产品",{yesdo:function(){var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}$span.addClass("del");spec.isdel="Y";_showHideUim(1,prodId,servSpecId);var serv=CacheData.getServBySpecId(prodId,servSpecId);if(ec.util.isObj(serv)){$span.addClass("del");serv.isdel="Y"}},no:function(){}})}};var _closeServSpecReload=function(prodId,servSpecId,specName,ifParams){var $span=$("#li_"+prodId+"_"+servSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.openServSpecReload(prodId,servSpecId,specName,ifParams)}else{var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}$span.addClass("del");spec.isdel="Y";_showHideUim(1,prodId,servSpecId);var serv=CacheData.getServBySpecId(prodId,servSpecId);if(ec.util.isObj(serv)){$span.addClass("del");serv.isdel="Y"}}};var _closeServ=function(prodId,servId){var serv=CacheData.getServ(prodId,servId);var $span=$("#li_"+prodId+"_"+serv.servId).find("span");if($span.attr("class")=="del"){_openServ(prodId,serv)}else{if("13409244"==serv.servSpecId){$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能")}else{$.confirm("信息确认","关闭【"+$span.text()+"】功能产品",{yesdo:function(){$span.addClass("del");serv.isdel="Y"},no:function(){}})}}};var _openServSpec=function(prodId,servSpecId,specName,ifParams){$.confirm("信息确认","开通【"+specName+"】功能产品",{yesdo:function(){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams;if(servSpecId==CONST.YZFservSpecId){var feeType=$("select[name='pay_type_-1']").val();if(feeType==undefined){feeType=order.prodModify.choosedProdInfo.feeType}if(feeType==CONST.PAY_TYPE.AFTER_PAY){for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];prodSpecParam.setValue=""}}else{for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];if(prodSpecParam.value!=""){prodSpecParam.setValue=prodSpecParam.value}else{if(!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!=""){prodSpecParam.setValue=prodSpecParam.valueRange[0].value}}}}}}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDepend(prodId,servSpec)},no:function(){}})};var _openServSpecReload=function(prodId,servSpecId,specName,ifParams){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams;if(servSpecId==CONST.YZFservSpecId){var feeType=$("select[name='pay_type_-1']").val();if(feeType==undefined){feeType=order.prodModify.choosedProdInfo.feeType}if(feeType==CONST.PAY_TYPE.AFTER_PAY){for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];prodSpecParam.setValue=""}}else{for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];if(prodSpecParam.value!=""){prodSpecParam.setValue=prodSpecParam.value}else{if(!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!=""){prodSpecParam.setValue=prodSpecParam.valueRange[0].value}}}}}}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDepend(prodId,servSpec)};var _openServ=function(prodId,serv){$.confirm("信息确认","取消关闭【"+serv.servSpecName+"】功能产品",{yesdo:function(){if(serv!=undefined){if(serv.servSpecId==""){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.removeClass("del");serv.isdel="N"}else{_checkServExcludeDepend(prodId,serv)}}},no:function(){}})};var _checkOfferExcludeDepend=function(prodId,offerSpec){var offerSpecId=offerSpec.offerSpecId;var param=CacheData.getExcDepOfferParam(prodId,offerSpecId);var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName)}};var _checkServExcludeDepend=function(prodId,serv,flag){var servSpecId=serv.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserServData(data.result,prodId,serv)}}};var _addOfferSpec=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);if(OrderInfo.provinceInfo.reloadFlag=="N"){CacheData.setServ2OfferSpec(prodId,newSpec);_checkOfferExcludeDepend(prodId,newSpec)}else{$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)},no:function(){}})}};var _addOfferSpecByCheck=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)}})};var delServSpec=function(prodId,offerSpec){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var servSpecId=this.objId;if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){var spec=CacheData.getServSpec(prodId,servSpecId);if(ec.util.isObj(spec)){spec.isdel="Y";$li.find("span").addClass("del");_showHideUim(1,prodId,servSpecId)}}})})};var delServByOffer=function(prodId,offer){$.each(offer.offerMemberInfos,function(){var servId=this.objInstId;if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){var serv=CacheData.getServ(prodId,servId);if(ec.util.isObj(serv)){serv.isdel="Y";var $li=$("#li_"+prodId+"_"+servId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del")}}})};var _addOffer=function(prodId,offerId){var specName=$("#li_"+prodId+"_"+offerId).find("span").text();$.confirm("信息确认","取消退订【"+specName+"】可选包",{yesdo:function(){var offer=CacheData.getOffer(prodId,offerId);if(offer!=undefined){if(offer.offerSpecId==""){var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.removeClass("del");offer.isdel="N"}else{_checkOfferExcludeDepend(prodId,offer)}}},no:function(){}})};var _addAttOffer=function(prodId,offerSpecId,specName){_addOfferSpec(prodId,offerSpecId)};var paserOfferData=function(result,prodId,offerSpecId,specName){var content="";
var param={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(result!=""){var exclude=result.offerSpec.exclude;var depend=result.offerSpec.depend;var defaultOffer=result.offerSpec.defaultList;if(ec.util.isArray(exclude)){for(var i=0;i<exclude.length;i++){var offerList=CacheData.getOfferList(prodId);var flag=true;if(offerList!=undefined){for(var j=0;j<offerList.length;j++){if(offerList[j].isdel=="Y"){if(offerList[j].offerSpecId==exclude[i].offerSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+exclude[i].offerSpecName+"<br>";param.excludeOffer.push(exclude[i].offerSpecId)}}}if(depend!=undefined&&ec.util.isArray(depend.offerInfos)){for(var i=0;i<depend.offerInfos.length;i++){content+="需要开通： "+depend.offerInfos[i].offerSpecName+"<br>";param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId)}}if(depend!=undefined&&ec.util.isArray(depend.offerGrpInfos)){for(var i=0;i<depend.offerGrpInfos.length;i++){var offerGrpInfo=depend.offerGrpInfos[i];param.dependOffer.offerGrpInfos.push(offerGrpInfo);content+="需要开通： 开通"+offerGrpInfo.minQty+"-"+offerGrpInfo.maxQty+"个以下业务:<br>";if(offerGrpInfo.subOfferSpecInfos!="undefined"&&offerGrpInfo.subOfferSpecInfos.length>0){for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){var subOfferSpec=offerGrpInfo.subOfferSpecInfos[j];var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}}else{var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'"><label for='+subOfferSpec.offerSpecId+">"+subOfferSpec.offerSpecName+"</label></input><br>"}}}}}}if(ec.util.isArray(defaultOffer)){for(var i=0;i<defaultOffer.length;i++){content+="需要开通： "+defaultOffer[i].offerSpecName+"<br>";param.defaultOffer.push(defaultOffer[i].offerSpecId)}}}var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);content=content+serContent;if(content==""){AttachOffer.addOpenList(prodId,offerSpecId)}else{content="<div style='max-height:300px;overflow:auto;'>"+content+"</div>";$.confirm("订购： "+specName,content,{yes:function(){CacheData.setOffer2ExcludeOfferSpec(param)},yesdo:function(){excludeAddattch(prodId,offerSpecId,param);AttachOffer.excludeAddServ(prodId,"",paramObj)},no:function(){}})}};var paserServData=function(result,prodId,serv){var servSpecId=serv.servSpecId;var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";var param={excludeServ:[],dependServ:[],relatedServ:[]};if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";param.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.dependServ.push(this)})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.relatedServ.push(this)})}if(content==""){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);AttachOffer.excludeAddServ(prodId,servSpecId,param)}else{$.confirm("开通： "+serv.servSpecName,content,{yesdo:function(){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);AttachOffer.excludeAddServ(prodId,servSpecId,param)},no:function(){}})}}};var _excludeAddServ=function(prodId,servSpecId,param){if(ec.util.isArray(param.excludeServ)){for(var i=0;i<param.excludeServ.length;i++){var excludeServSpecId=param.excludeServ[i].servSpecId;var spec=CacheData.getServSpec(prodId,excludeServSpecId);if(spec!=undefined){var $span=$("#li_"+prodId+"_"+excludeServSpecId).find("span");$span.addClass("del");spec.isdel="Y"}else{var serv=CacheData.getServBySpecId(prodId,excludeServSpecId);if(serv!=undefined){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.addClass("del");serv.isdel="Y"}}}}if(ec.util.isArray(param.dependServ)){for(var i=0;i<param.dependServ.length;i++){var servSpec=param.dependServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}if(ec.util.isArray(param.relatedServ)){for(var i=0;i<param.relatedServ.length;i++){var servSpec=param.relatedServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}};var excludeAddattch=function(prodId,specId,param){if(param.dependOffer.offerGrpInfos.length>0){var dependOffer=param.dependOffer;for(var i=0;i<dependOffer.offerGrpInfos.length;i++){var offerGrpInfo=dependOffer.offerGrpInfos[i];var len=offerGrpInfo.checkLen;if(len>=offerGrpInfo.minQty&&len<=offerGrpInfo.maxQty){$.each(offerGrpInfo.subOfferSpecInfos,function(){if(this.isCheck){AttachOffer.addOpenList(prodId,this.offerSpecId)}})}else{if(len<offerGrpInfo.minQty){$.alert("提示信息","依赖组至少选中"+offerGrpInfo.minQty+"个！");return}else{if(len>offerGrpInfo.maxQty){$.alert("提示信息","依赖组至多选中"+offerGrpInfo.maxQty+"个！");return}else{$.alert("错误信息","依赖组选择出错！");return}}}}}AttachOffer.addOpenList(prodId,specId);if(param.excludeOffer.length>0){for(var i=0;i<param.excludeOffer.length;i++){var excludeSpecId=param.excludeOffer[i];var spec=CacheData.getOfferSpec(prodId,excludeSpecId);if(spec!=undefined){var $span=$("#li_"+prodId+"_"+excludeSpecId).find("span");$span.addClass("del");spec.isdel="Y"}var offer=CacheData.getOfferBySpecId(prodId,excludeSpecId);if(offer!=undefined){var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.addClass("del");offer.isdel="Y"}}}if(param.dependOffer.dependOffers.length>0){for(var i=0;i<param.dependOffer.dependOffers.length;i++){var offerSpecId=param.dependOffer.dependOffers[i];AttachOffer.addOpenList(prodId,offerSpecId)}}if(param.defaultOffer.length>0){for(var i=0;i<param.defaultOffer.length;i++){var offerSpecId=param.defaultOffer[i];AttachOffer.addOpenList(prodId,offerSpecId)}}};var _addOpenList=function(prodId,offerSpecId){if(!_manyPhoneFilter(prodId,offerSpecId)){return}var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(offer!=undefined){if(offer.isdel!="Y"){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}}else{var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.removeClass("del");offer.isdel="N"}return}var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}if(newSpec.isdel=="C"){if(_ifOrderAgain(newSpec)){return}var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();$("#li_"+prodId+"_"+offerSpecId).remove();
var $li=$('<a id="li_'+prodId+"_"+offerSpecId+'" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+')" class="list-group-item"></a>');$li.append('<span id="span_'+prodId+"_"+offerSpecId+'">'+newSpec.offerSpecName+"</span>");if(newSpec.ifDault==0){$li.removeAttr("onclick")}else{$li.append('<span id="span_remove_'+prodId+"_"+offerSpecId+'" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span>')}$("#open_ul_"+prodId).append($li);newSpec.isdel="N"}else{if((newSpec.isdel=="Y")){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");$span.removeClass("del");newSpec.isdel="N"}else{var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();var $li=$('<a id="li_'+prodId+"_"+offerSpecId+'" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+')" class="list-group-item"></a>');$li.append('<span id="span_'+prodId+"_"+offerSpecId+'">'+newSpec.offerSpecName+"</span>");if(newSpec.ifDault==0){$li.removeAttr("onclick")}else{$li.append('<span id="span_remove_'+prodId+"_"+offerSpecId+'" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span>')}$("#open_ul_"+prodId).append($li)}}if(newSpec!=undefined){$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty!=2){var ifParams="N";if(ec.util.isArray(this.prodSpecParams)){ifParams="Y"}_addOpenServList(prodId,this.objId,this.objName,ifParams);if(this.minQty>0){_minQtyFileter(prodId,this.objId)}}})})}if(ec.util.isArray(newSpec.agreementInfos)){if(OrderInfo.actionFlag!=14){totalNums=0;_removeAttach2Coupons(prodId,newSpec.offerSpecId);var objInstId=prodId+"_"+newSpec.offerSpecId;var $ul=$('<div id="terminalUl_'+objInstId+'"></div>');var minNum=newSpec.agreementInfos[0].minNum;var maxNum=newSpec.agreementInfos[0].maxNum;var $li3=$("<div></div>");var isFastOffer=0;if(ec.util.isArray(newSpec.extAttrParams)){$.each(newSpec.extAttrParams,function(){if(this.attrId==CONST.OFFER_FAST_FILL){isFastOffer=1;return false}})}for(var i=0;i<newSpec.agreementInfos.length;i++){var agreementInfo=newSpec.agreementInfos[i];var $ulGroups=$('<ul id="ul_'+objInstId+'" style="margin-left: -40px;"></ul>');var $liGroups=$('<li class="form-group" style="list-style-type:none;"><label> 终端：</label></li>');var $selTerms=$('<select style="display:none;" id="'+objInstId+'"></select>');var $selTermGroups=$('<select style="display:none;" id="group_'+objInstId+'"></select>');if(ec.util.isArray(agreementInfo.terminalGroups)){for(var j=0;j<agreementInfo.terminalGroups.length;j++){var $optionTermGroups=$('<option value="'+agreementInfo.terminalGroups[j].terminalGroupId+'" terminalMaxNum="'+agreementInfo.terminalGroups[j].terminalMaxNum+'" terminalMinNum="'+agreementInfo.terminalGroups[j].terminalMinNum+'">'+agreementInfo.terminalGroups[j].terminalGroupId+"</option>");$selTermGroups.append($optionTermGroups);if(ec.util.isArray(agreementInfo.terminalGroups[j].terminalGroup)){$.each(agreementInfo.terminalGroups[j].terminalGroup,function(){var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+"</option>");$selTerms.append($optionTerms)})}}}if(ec.util.isArray(agreementInfo.terminals)){$.each(agreementInfo.terminals,function(){var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+"</option>");$selTerms.append($optionTerms)})}$liGroups.append($selTerms).append($selTermGroups);if(maxNum>newSpec.agreementInfos[0].minNum){var $strAdd=$('<button id="terminalAddBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="0" onclick="AttachOffer.addAndDelTerminal(this)" value="添加" class="btn btn-default"></button>');var $strDel=$('<button id="terminalDelBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="1" onclick="AttachOffer.addAndDelTerminal(this)" value="删除" class="btn btn-default"></button>');$liGroups.append($strAdd).append($strDel)}$ulGroups.append($liGroups);var minNumArray=new Array();for(var k=1;k<=minNum;k++){var id="terminalText_"+objInstId+"_"+k;minNumArray[k-1]=id;var $liTerminal=$('<li class="form-group" style="list-style-type:none;"><label for="exampleInputPassword1">终端校验：</label><div class="input-group" style="width:100%;"><input id="terminalText_'+objInstId+"_"+k+'" type="text" class="form-control" maxlength="50" placeholder="请先输入终端串号" /><li class="form-group" style="list-style-type:none;"><input type="checkbox" id="if_p_reserveCode" onclick="AttachOffer.changereserveCode()"><label for="exampleInputPassword1">使用预约码：</label><div class="input-group"><input id="reserveCode" type="text" disabled="disabled" class="form-control" maxlength="50" placeholder="请输入预约码" style="background-color: #E8E8E8;"/><span class="input-group-btn"><button id="terminalBtn_'+objInstId+"_"+k+'" type="button" num="'+k+'" flag="'+isFastOffer+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" class="btn btn-default">校验</button></span></div></li>');var $li4=$('<li id="terminalDesc_'+k+'" style="display:none;list-style-type:none;" ><label></label><label id="terminalName_'+k+'"></label></li>');$ulGroups.append($liTerminal).append($li4)}$ul.append($ulGroups);totalNums+=minNum}var $div=$("#terminalDiv_"+prodId);$ul.appendTo($div);$div.show();var terminalCode="";if(OrderInfo.terminalCode!=null&&OrderInfo.terminalCode!=""&&OrderInfo.terminalCode!="null"&&OrderInfo.reloadFlag!="N"){var accessNum=OrderInfo.getAccessNumber(prodId);if(accessNum!=""&&accessNum!=null&&accessNum!=undefined){var terminalCodeArray=OrderInfo.terminalCode.split(",");for(var k=0;k<terminalCodeArray.length;k++){if(terminalCodeArray[k].indexOf(accessNum)!=-1){terminalCode=terminalCodeArray[k].split("_")[1];for(var z=0;z<minNumArray.length;z++){if(minNumArray[z].indexOf(prodId)!=-1){$("#"+minNumArray[z]).val(terminalCode);break}}}}}}if(newSpec.agreementInfos[0].minNum>0){newSpec.isTerminal=1}}else{if(OrderInfo.actionFlag==14){var objInstId=prodId+"_"+newSpec.offerSpecId;var terminalUl=$("#terminalUl_"+objInstId);if(terminalUl.length>0){return}var $ul=$('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');var $sel=$('<select id="terminalSel_'+objInstId+'"></select>');var $li1=$('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+"</span></label></li>");var $li2=$('<li style="display:none;"><label> 可选终端规格：</label></li>');$.each(newSpec.agreementInfos,function(){var $option=$('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+"</option>");$sel.append($option)});$li2.append($sel).append('<label class="f_red">*</label>');var $li3=$('<li><label>终端校验：</label><input id="terminalText_'+objInstId+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+","+newSpec.offerSpecId+')" value="校验" class="purchase" style="float:left"></input></li>');var $div=$("#terminalDiv_"+prodId);var $li4=$('<li id="terminalDesc" style="display:none;white-space:nowrap;"><label> 终端规格：</label><label id="terminalName"></label></li>');$ul.append($li1).append($li2).append($li3).append($li4).appendTo($div);$div.show();newSpec.isTerminal=1;for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var coupon=OrderInfo.attach2Coupons[i];if(prodId==coupon.prodId){$("#terminalSel_"+objInstId).val(coupon.couponId);$("#terminalSel_"+objInstId).attr("disabled",true);$("#terminalText_"+objInstId).val(coupon.couponInstanceNumber);$("#terminalText_"+objInstId).attr("disabled",true);$("#terminalBtn_"+objInstId).hide()}}}}}};var _changereserveCode=function(){if(document.getElementById("if_p_reserveCode").checked){$("#reserveCode").css("background-color","white").attr("disabled",false)}else{$("#reserveCode").css("background-color","#E8E8E8").attr("disabled",true)
}};var _checkTerminalCode=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var num=$(obj).attr("num");var flag=$(obj).attr("flag");if(flag==undefined){flag=0}OrderInfo.termReserveFlag="";_filterAttach2Coupons(prodId,offerSpecId,num);var objInstId=prodId+"_"+offerSpecId;var resIdArray=[];var terminalGroupIdArray=[];$("#"+objInstId+"  option").each(function(){resIdArray.push($(this).val())});$("#group_"+objInstId+"  option").each(function(){terminalGroupIdArray.push($(this).val())});var resId=resIdArray.join("|");var terminalGroupId=terminalGroupIdArray.join("|");if((resId==undefined||$.trim(resId)=="")&&(terminalGroupId==undefined||$.trim(terminalGroupId)=="")){$.alert("信息提示","终端规格不能为空！");return}var instCode=$("#terminalText_"+objInstId+"_"+num).val();if(instCode==undefined||$.trim(instCode)==""){$.alert("信息提示","终端串码不能为空！");return}if(document.getElementById("if_p_reserveCode").checked){var reserveCode=$("#reserveCode").val();if(reserveCode==""){$.alert("信息提示","请输入终端预约码！");return}}else{$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[]}if(_checkData(objInstId,instCode)){return}var newSpec=_setSpec(prodId,offerSpecId);var param={instCode:instCode,flag:flag,mktResId:resId,offerSpecId:offerSpecId,offerSpecName:newSpec.offerSpecName};var data=query.prod.checkTerminal(param);if(data==undefined){return}var activtyType="";for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"&&ec.util.isArray(spec.agreementInfos)){if(spec.agreementInfos[0].activtyType==2){activtyType="2"}}}}if(data.statusCd==CONST.MKTRES_STATUS.USABLE||(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2")){var mktPrice=0;var mktColor="";if(ec.util.isArray(data.mktAttrList)){$.each(data.mktAttrList,function(){if(this.attrId=="65010058"){mktPrice=this.attrValue}else{if(this.attrId=="60010004"){mktColor=this.attrValue}}})}$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");$("#terminalDesc_"+num).css("display","block");var coupon={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:data.mktResStoreId,storeName:"1",agentId:1,apCharge:mktPrice,couponInstanceNumber:data.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:-1,attachSepcId:offerSpecId,state:"ADD",relaSeq:"",num:num,attrList:data.mktAttrList};if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2"){coupon.couponSource="2"}if(CONST.getAppDesc()==0){coupon.termTypeFlag=data.termTypeFlag}if(document.getElementById("if_p_reserveCode").checked){var custId=OrderInfo.cust.custId;var identityTypeCd="";var identityNum="";if(custId==-1){identityTypeCd=OrderInfo.boCustIdentities.identidiesTypeCd;identityNum=OrderInfo.boCustIdentities.identityNum}var param={reserveCode:reserveCode,couponId:data.mktResId,terminalPrice:mktPrice,custId:custId,identityTypeCd:identityTypeCd,identityNum:identityNum};var url=contextPath+"/mktRes/terminal/queryCouponReserveCodeCheck ";$.callServiceAsJson(url,param,{before:function(){},always:function(){},done:function(response){if(response&&response.code==-2){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[];$.alertM(response.data);return}else{if(response&&response.data&&response.data.code==0){if(response.data.buyFlag!=null&&response.data.buyFlag=="Y"){var content="您购买的终端和预约的终端不一致，请确认是否需要购买该终端？";$.confirm("信息确认",content,{yes:function(){},yesdo:function(){if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})})}checkedReserveNbr=response.data.couponInfo.reserveNbr;coupon.sourceId=checkedReserveNbr;OrderInfo.termReserveFlag=CONST.OL_TYPE_CD.ZDYY;OrderInfo.attach2Coupons.push(coupon);if(response.data.offerSpec.length>0){checkedOfferSpec=response.data.offerSpec;var content='<form id="promotionForm"><div><table>';var selectStr="";var optionStr="";selectStr=selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>";$.each(response.data.offerSpec,function(){var offerSpec=this;optionStr+='<option value="'+this.offerSpecId+'">'+this.offerSpecName+"</option>"});selectStr+=optionStr+"</select></td></tr></tbody></table></div>";content+=selectStr;var offerSpecId;$.confirm("促销包选择",content,{yes:function(){offerSpecId=$("#"+checkedReserveNbr+" option:selected").val();$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove();AttachOffer.selectAttachOffer(prodId,offerSpecId)},no:function(){}})}},no:function(){}})}else{if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})})}checkedReserveNbr=response.data.couponInfo.reserveNbr;coupon.sourceId=checkedReserveNbr;OrderInfo.termReserveFlag=CONST.OL_TYPE_CD.ZDYY;OrderInfo.attach2Coupons.push(coupon);if(response.data.offerSpec.length>0){checkedOfferSpec=response.data.offerSpec;var content='<form id="promotionForm"><div><table>';var selectStr="";var optionStr="";selectStr=selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>";$.each(response.data.offerSpec,function(){var offerSpec=this;optionStr+='<option value="'+this.offerSpecId+'">'+this.offerSpecName+"</option>"});selectStr+=optionStr+"</select></td></tr></tbody></table></div>";content+=selectStr;var offerSpecId;$.confirm("促销包选择",content,{yes:function(){offerSpecId=$("#"+checkedReserveNbr+" option:selected").val();$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove();AttachOffer.selectAttachOffer(prodId,offerSpecId)},no:function(){}})}else{$.alert("信息提示",data.message)}}}else{if(response&&response.data&&response.data.message&&response.data.code==1){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[];$.alert("提示",response.data.message);return}else{$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()
}})});checkedOfferSpec=[];$.alert("提示","<br/>终端预约码校验失败，请稍后重试！");return}}}}})}else{$.alert("信息提示",data.message);OrderInfo.attach2Coupons.push(coupon)}}else{if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}else{$.alert("提示",data.message)}}};var _setSpec=function(prodId,offerSpecId){var newSpec=CacheData.getOfferSpec(prodId,offerSpecId);if(newSpec==undefined){newSpec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!newSpec){return}CacheData.setOfferSpec(prodId,newSpec)}return newSpec};var _addOpenServList=function(prodId,servSpecId,servSpecName,ifParams){var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){$("#li_"+prodId+"_"+serv.servId).find("span").removeClass("del");serv.isdel="N";return}var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:servSpecName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams}CacheData.setServSpec(prodId,newSpec);spec=newSpec}if(spec.isdel=="C"){$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<a id="li_'+prodId+"_"+servSpecId+'" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+servSpecName+"','"+ifParams+'\')" class="list-group-item"></a>');$li.append('<span id="span_'+prodId+"_"+servSpecId+'">'+spec.servSpecName+"</span>");if(spec.ifDault==0){$li.removeAttr("onclick")}else{$li.append('<span id="span_remove_'+prodId+"_"+servSpecId+'" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span>')}$("#open_serv_ul_"+prodId).append($li)}else{$("#li_"+prodId+"_"+servSpecId).find("span").removeClass("del")}spec.isdel="N";_showHideUim(0,prodId,servSpecId)};var _showMainParam=function(){var content=CacheData.getParamContent(-1,OrderInfo.offerSpec,0);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){}).ketchup({bindElement:"easyDialogYesBtn"})};var _showParam=function(prodId,offerSpecId,flag){if(flag==1){var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offer.offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=query.offer.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}if(!offer.isGetParam){var param={offerTypeCd:"2",offerId:offer.offerId,offerSpecId:offer.offerSpecId};var offerParam=query.offer.queryOfferParam(param);if(offerParam==undefined){return}else{offer.offerParamInfos=offerParam.offerParamInfos;offer.isGetParam=true}}var content=CacheData.getParamContent(prodId,offer,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});order.protocolnbr.init();$("#paramForm").bind("formIsValid",function(event,form){if(!paramInputCheck()){return}var isset=false;$.each(offer.offerSpec.offerSpecParams,function(){var itemInfo=CacheData.getOfferParam(prodId,offer.offerId,this.itemSpecId);if(itemInfo.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){itemInfo.setValue=$("#select1").val()}else{itemInfo.setValue=$("#"+prodId+"_"+this.itemSpecId).val()}if(itemInfo.value!=itemInfo.setValue){itemInfo.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu").addClass("canshu2");offer.isset="Y";offer.update="Y"}else{$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu2").addClass("canshu");offer.isset="N";offer.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);if(spec==undefined){spec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!spec){return}}var content=CacheData.getParamContent(prodId,spec,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});order.protocolnbr.init();$("#paramForm").bind("formIsValid",function(event,form){if(!paramInputCheck()){return}if(!!spec.offerSpecParams){for(var i=0;i<spec.offerSpecParams.length;i++){var param=spec.offerSpecParams[i];var itemSpec=CacheData.getSpecParam(prodId,offerSpecId,param.itemSpecId);if(itemSpec.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){itemSpec.setValue=$("#select1").val()}else{itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}}if(spec.offerRoles!=undefined&&spec.offerRoles.length>0){for(var i=0;i<spec.offerRoles.length;i++){var offerRole=spec.offerRoles[i];for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(!!roleObj.prodSpecParams){for(var k=0;k<roleObj.prodSpecParams.length;k++){var prodParam=roleObj.prodSpecParams[k];var prodItem=CacheData.getProdSpecParam(prodId,offerSpecId,prodParam.itemSpecId);prodItem.value=$("#"+prodId+"_"+prodParam.itemSpecId).val()}}}}}$("#can_"+prodId+"_"+offerSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getOfferSpec(prodId,offerSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var _showServParam=function(prodId,servSpecId,flag){if(flag==1){var serv=CacheData.getServBySpecId(prodId,servSpecId);var param={prodId:serv.servId,ifServItem:"Y"};if(!serv.isGetParamSpec){param.prodSpecId=serv.servSpecId;var dataSepc=query.prod.prodSpecParamQuery(param);if(dataSepc==undefined){return}else{serv.prodSpecParams=dataSepc.result.prodSpecParams;serv.isGetParamSpec=true}}if(!serv.isGetParamInst){var data=query.prod.prodInstParamQuery(param);if(data==undefined){return}else{serv.prodInstParams=data.result.prodInstParams;serv.isGetParamInst=true}}var content=CacheData.getParamContent(prodId,serv,3);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var isset=false;$.each(serv.prodSpecParams,function(){var prodItem=CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);prodItem.setValue=$("#"+prodId+"_"+this.itemSpecId).val();if(prodItem.value!=prodItem.setValue){prodItem.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");serv.isset="Y";serv.update="Y"}else{$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");serv.isset="N";serv.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}var content=CacheData.getParamContent(prodId,spec,2);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){if(!!spec.prodSpecParams){for(var i=0;i<spec.prodSpecParams.length;i++){var param=spec.prodSpecParams[i];var itemSpec=CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getServSpec(prodId,servSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var paramInputCheck=function(){var pass=true;$("#paramForm").find("input[type=text]").each(function(){var mask=$(this).attr("mask");var maskmsg=$(this).attr("maskmsg");if(mask!=null&&mask!=""&&mask.substring(0,1)=="/"&&mask.substring(mask.length-1,mask.length)=="/"){if(!eval(mask).test($(this).val())){$.alert("提示",maskmsg);pass=false;return false}}});return pass};var _showTime=function(prodId,offerSpecId,offerSpecName){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(offerSpecName+"--生失效设置");var spec=CacheData.getOfferSpec(prodId,offerSpecId);_initTime(spec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setAttachTime(prodId,offerSpecId)
});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showStartTime=function(){var strDate=DateUtil.Format("yyyy年MM月dd日",new Date());var endDate=$("#endDt").val();if(endDate==""){$.calendar({minDate:strDate})}else{$.calendar({minDate:strDate,maxDate:endDate})}};var _showEndTime=function(){var strDate=$("#startDt").val();if(strDate==""){strDate=DateUtil.Format("yyyy年MM月dd日",new Date())}$.calendar({minDate:strDate})};var _initTime=function(spec){if(spec!=undefined&&spec.ooTimes!=undefined){var ooTime=spec.ooTimes;$("input[name=startTimeType][value='"+ooTime.startType+"']").attr("checked","checked");$("input[name=endTimeType][value='"+ooTime.endType+"']").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("");if(ooTime.startType==4){$("#startDt").val(ooTime.startDt)}if(ooTime.endType==4){$("#endDt").val(ooTime.endDt)}else{if(ooTime.endType==5){$("#endTime").val(ooTime.effTime);$("#endTimeUnit").val(ooTime.effTimeUnitCd)}}}else{$("input[name=startTimeType][value=1]").attr("checked","checked");$("input[name=endTimeType][value=1]").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("")}};var _showOfferTime=function(){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(OrderInfo.offerSpec.offerSpecName+"-生失效设置");_initTime(OrderInfo.offerSpec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setMainTime()});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showMainMember=function(){$("#memberName").text(OrderInfo.offerSpec.offerSpecName+"-构成");$("#main_member_div").empty();$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)});$("#main_member_div").append('<div class="clear"></div>')}else{$.each(offerRole.prodInsts,function(){var prodId=this.prodInstId;var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)}});$("#main_member_div").append('<div class="clear"></div>')})}});easyDialog.open({container:"div_member_dialog"});$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(offerRole.prodInsts,function(){var prodInst=this;$.each(offerRole.roleObjs,function(){var servSpecId=this.objId;if(this.minQty>0){$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked");$(this).attr("disabled","disabled")}})}});if(!!prodInst.servInsts){$.each(prodInst.servInsts,function(){var servSpecId=this.objId;$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked")}})})}})});$("#memberSpan").off("click").on("click",function(){_setMainMember()})};var _setMainMember=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(this.prodInsts,function(){var prodInst=this;prodInst.servInsts=[];$("input[name='serv_check_"+this.prodInstId+"']:checked").each(function(){var servSpecId=$(this).attr("servSpecId");$.each(offerRole.roleObjs,function(){if(this.objId==servSpecId){prodInst.servInsts.push(this)}})})})});easyDialog.close()};var _getTime=function(){var ooTime={state:"ADD"};var startRadio=$("input[name=startTimeType]:checked").attr("value");ooTime.startType=startRadio;if(startRadio==1){ooTime.isDefaultStart="Y"}else{if(startRadio==2){}else{if(startRadio==3){ooTime.startTime=1;ooTime.startTimeUnitCd=7}else{if(startRadio==4){if($("#startDt").val()==""){$.alert("提示","指定生效时间不能为空!");return}ooTime.startDt=$("#startDt").val()}}}}var endRadio=$("input[name=endTimeType]:checked").attr("value");ooTime.endType=endRadio;if(endRadio==1){ooTime.isDefaultEnd="Y"}else{if(endRadio==4){if($("#endDt").val()==""){$.alert("提示","指定失效时间不能为空!");return}ooTime.endDt=$("#endDt").val()}else{if(endRadio==5){var end=$("#endTime").val();if(end==""){$.alert("提示","有效时长不能为空!");return}if(isNaN(end)){$.alert("提示","有效时长必须为数字!");return}if(end<=0){$.alert("提示","有效时长必须大于0!");return}ooTime.effTime=end;ooTime.effTimeUnitCd=$("#endTimeUnit").val()}}}return ooTime};var _setMainTime=function(){var ooTime=_getTime();if(ooTime==undefined){return}OrderInfo.offerSpec.ooTimes=ooTime;$("#mainTime").removeClass("time").addClass("time2");easyDialog.close()};var _setAttachTime=function(prodId,offerSpecId){var ooTime=_getTime();if(ooTime==undefined){return}var spec=CacheData.getOfferSpec(prodId,offerSpecId);spec.ooTimes=ooTime;$("#time_"+prodId+"_"+offerSpecId).removeClass("time").addClass("time2");easyDialog.close()};var _changeLabel1=function(prodId,prodSpecId,labelId){_changeLabel(prodId,prodSpecId,labelId)};var _changeLabel=function(prodId,prodSpecId,labelId){if(labelId==""){labelId=$("#attachType_"+prodId).val()}$("#attach_div_"+prodId).hide();$("#btn_hide_"+prodId).hide();$("#attachSearch_div_"+prodId+" div").each(function(){$(this).hide()});$("#attach_div_"+prodId).attr("value",labelId);var $ul=$("#ul_"+prodId+"_"+labelId);if($ul[0]==undefined){var queryType="3";if(prodId>0){queryType=""}if(labelId==CONST.LABEL.SERV){$("#open_serv_ul_"+prodId).show();var param={prodId:prodId,prodSpecId:prodSpecId,queryType:queryType,labelId:labelId};var data=query.offer.queryServSpec(param);var $ul=$('<div id="ul_'+prodId+"_"+labelId+'"></div>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.servSpec)){var servList=CacheData.getServList(prodId);var servSpecList=CacheData.getServSpecList(prodId);var i=0;var html="";$.each(data.result.servSpec,function(){var servSpecId=this.servSpecId;var flag=true;$.each(servList,function(){if(this.servSpecId==servSpecId&&this.isDel!="C"){flag=false;return false}});$.each(servSpecList,function(){if(this.servSpecId==servSpecId){flag=false;return false}});if(flag){html='<a class="list-group-item" href="javascript:AttachOffer.openServSpec('+prodId+","+this.servSpecId+",'"+this.servSpecName+"','"+this.ifParams+'\')" id="li_'+prodId+"_"+this.servSpecId+'">';html+='<h5 class="list-group-item-heading">'+this.servSpecName+"</h5>";html+="</a>";$ul.append(html);i++}});if(i==0){html='<a href="javascript:void(0);" class="list-group-item"><span>没有可订购的功能产品</span></a>';$ul.append(html)}}else{var html='<a href="javascript:void(0);" class="list-group-item"><span>没有可订购的功能产品</span></a>';$ul.append(html)}}$("#attachSearch_div_"+prodId).append($ul)}else{var param={prodSpecId:prodSpecId,offerSpecIds:[],queryType:queryType,prodId:prodId,partyId:OrderInfo.cust.custId,labelId:labelId,ifCommonUse:""};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){if(this.prodInstId==prodId){param.acctNbr=this.accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}})}else{if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22){var prodInfo=order.prodModify.choosedProdInfo;param.acctNbr=prodInfo.accNbr;if(!ec.util.isObj(prodInfo.prodOfferId)){prodInfo.prodOfferId=""
}var offerRoleId=CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;if(offerRoleId==undefined){offerRoleId=""}param.offerRoleId=offerRoleId;param.offerSpecIds.push(prodInfo.prodOfferId)}else{param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}}}query.offer.queryCanBuyAttachSpec(param,function(data){var $ul=$('<div id="ul_'+prodId+"_"+labelId+'" ></div>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.offerSpecList)){var offerList=CacheData.getOfferList(prodId);var offerSpecList=CacheData.getOfferSpecList(prodId);var i=0;var html="";$.each(data.result.offerSpecList,function(){var offerSpecId=this.offerSpecId;var flag=true;$.each(offerList,function(){if(this.offerSpecId==offerSpecId&&this.isDel!="C"){flag=false;return false}});$.each(offerSpecList,function(){if(this.offerSpecId==offerSpecId){flag=false;return false}});if(flag){html='<a class="list-group-item" href="javascript:AttachOffer.addOfferSpec('+prodId+","+this.offerSpecId+')" id="li_'+prodId+"_"+this.offerSpecId+'">';html+='<h5 class="list-group-item-heading">'+this.offerSpecName+"</h5>";html+="</a>";$ul.append(html);i++}});if(i==0){html='<a href="javascript:void(0);" class="list-group-item"><span>没有可订购的可选包</span></a>';$ul.append(html)}}else{var html='<a href="javascript:void(0);" class="list-group-item"><span>没有可订购的可选包</span></a>';$ul.append(html)}}$("#attachSearch_div_"+prodId).append($ul)})}}else{$("#ul_"+prodId+"_"+labelId).show()}};var _showHideUim=function(flag,prodId,servSpecId){if(CONST.getAppDesc()==0&&servSpecId==CONST.PROD_SPEC.PROD_FUN_4G){var prodClass=order.prodModify.choosedProdInfo.prodClass;if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){prodClass=CacheData.getOfferMember(prodId).prodClass;if(prodClass==undefined&&offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==prodId){prodClass=this.prodClass}})})}}else{if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){prodClass=OrderInfo.oldprodInstInfos[i].prodClass}}}}if(flag==0){if(prodClass==CONST.PROD_CLASS.THREE){$("#title_"+prodId).show();$("#uimDiv_"+prodId).show();var actionFalg=OrderInfo.actionFlag;var instCode=OrderInfo.newOrderNumInfo.mktResInstCode;var codeMsg=OrderInfo.newOrderNumInfo.codeMsg;if(actionFalg=="3"&&OrderInfo.provinceInfo.reloadFlag=="Y"){if(codeMsg!=null&&codeMsg!=""){alert(codeMsg)}else{if(instCode!=null&&instCode!=""){$("#uim_txt_"+prodId).val(instCode);$("#uim_check_btn_"+prodId).hide();$("#uim_release_btn_"+prodId).hide();$("#uim_txt_"+prodId).attr("disabled",true);var uimParam={instCode:instCode};var response=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);if(response.code==0){if(response.data.mktResBaseInfo){var statusCd=response.data.mktResBaseInfo.statusCd;if(statusCd=="1102"){var offerId="";if(ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){offerId=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{offerId=order.prodModify.choosedProdInfo.prodOfferInstId}_packageCouponInfo(prodId,offerId,response,instCode)}else{alert("UIM卡不是预占状态，当前为"+statusCd)}}else{alert("查询不到UIM卡["+instCode+"]信息")}}else{if(response.code==-2){alert(response.data)}else{alert("UIM信息查询接口出错,稍后重试")}}}}}if(OrderInfo.actionFlag==2&&OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""&&OrderInfo.mktResInstCode!="null"&&OrderInfo.provinceInfo.reloadFlag=="Y"){var nbrlist=[];var nbrflag=true;var offerId="-1";$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){offerId=this.mainProdOfferInstInfos[0].prodOfferInstId}});var mktResInstCodesize=order.memberChange.mktResInstCode.split(",");for(var u=0;u<mktResInstCodesize.length;u++){if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null"&&order.memberChange.oldSubPhoneNum!=""){var nbrAndUimCode=mktResInstCodesize[u].split("_");var _accNbr=nbrAndUimCode[0];var _uimCode=nbrAndUimCode[1];var oldSubPhoneNumsize=order.memberChange.oldSubPhoneNum.split(",");var uimflag=false;$.each(nbrlist,function(){if(this==_accNbr){nbrflag=false;return false}else{nbrflag=true}});if(!nbrflag){$.alert("提示","UIM卡"+_uimCode+"对应的号码重复");return}for(var n=0;n<oldSubPhoneNumsize.length;n++){if(oldSubPhoneNumsize[n]==_accNbr){nbrlist.push(oldSubPhoneNumsize[n]);uimflag=true;$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.accessNumber==_accNbr){var uimParam={instCode:_uimCode};var response=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);if(response.code==0){if(response.data.mktResBaseInfo){if(response.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_"+this.objInstId).attr("disabled",true);$("#uim_release_btn_"+this.objInstId).attr("disabled",false);$("#uim_release_btn_"+this.objInstId).removeClass("disabled");$("#uim_txt_"+this.objInstId).attr("disabled",true);$("#uim_txt_"+this.objInstId).val(_uimCode);var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:response.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:response.data.mktResBaseInfo.qty,storeId:response.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:_uimCode,terminalCode:_uimCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:this.objInstId,offerId:offerId,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(this.objInstId);OrderInfo.boProd2Tds.push(coupon)}else{$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(response.code==-2){$.alertM(response.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}})})}}if(!uimflag){$.alert("提示","UIM卡"+_uimCode+"未匹配到接入号")}}}}}}else{if(flag==1){if(prodClass==CONST.PROD_CLASS.THREE){$("#uimDiv_"+prodId).hide()}}}}};var _packageCouponInfo=function(prodId,offerId,response,instCode){var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:response.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:response.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:instCode,terminalCode:instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:offerId,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(prodId);OrderInfo.boProd2Tds.push(coupon)};var _isChangeUim=function(objId){if(CONST.getAppDesc()==0){var prodClass=order.prodModify.choosedProdInfo.prodClass;var prodId=order.prodModify.choosedProdInfo.prodInstId;if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){var member=CacheData.getOfferMember(objId);prodClass=member.prodClass;prodId=member.objInstId}else{if(OrderInfo.actionFlag==6&&ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==objId){prodClass=this.prodClass;prodId=this.prodInstId}})}}if(prodClass==CONST.PROD_CLASS.THREE){var servSpec=CacheData.getServSpec(prodId,CONST.PROD_SPEC.PROD_FUN_4G);if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){return true}}}return false};var _setAttachBusiOrder=function(busiOrders){$.each(AttachOffer.openServList,function(){var prodId=this.prodId;$.each(this.servSpecList,function(){if(this.isdel!="Y"&&this.isdel!="C"){SoOrder.createServ(this,prodId,0,busiOrders)}})});$.each(AttachOffer.openedServList,function(){var prodId=this.prodId;$.each(this.servList,function(){if(this.isdel=="Y"){SoOrder.createServ(this,prodId,1,busiOrders)}else{if(this.update=="Y"){SoOrder.createServ(this,prodId,2,busiOrders)}}})});for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"){if(ec.util.isObj(spec.counts)){for(var k=0;
k<spec.counts;k++){SoOrder.createAttOffer(spec,open.prodId,0,busiOrders)}}else{SoOrder.createAttOffer(spec,open.prodId,0,busiOrders)}}}}for(var i=0;i<AttachOffer.openedList.length;i++){var opened=AttachOffer.openedList[i];for(var j=0;j<opened.offerList.length;j++){var offer=opened.offerList[j];if(offer.isdel=="Y"){if(ec.util.isObj(offer.counts)){for(var k=0;k<offer.orderCount;k++){offer.offerId=offer.offerIds[k];SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{if(offer.update=="Y"){SoOrder.createAttOffer(offer,opened.prodId,2,busiOrders)}else{if(ec.util.isObj(offer.orderCount)&&ec.util.isObj(offer.counts)){if(offer.orderCount>offer.counts){for(var k=0;k<(offer.orderCount-offer.counts);k++){offer.offerId=offer.offerIds[k];SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{if(offer.orderCount<offer.counts){var spec=CacheData.getOfferSpec(opened.prodId,offer.offerSpecId);for(var k=0;k<(offer.counts-offer.orderCount);k++){SoOrder.createAttOffer(spec,opened.prodId,0,busiOrders)}}}}}}}}$.each(AttachOffer.openAppList,function(){var prodId=this.prodId;$.each(this.appList,function(){if(this.dfQty==1){SoOrder.createServ(this,prodId,0,busiOrders)}})})};var _setChangeList=function(prodId){AttachOffer.changeList=[];var prodInfos=offerChange.resultOffer.prodInfos;if(ec.util.isArray(prodInfos)){$.each(prodInfos,function(){if(prodId!=this.accProdInstId){return true}if(prodId!=this.prodInstId){var param={prodInstId:prodId};var serv=CacheData.getServ(prodId,this.prodInstId);var servSpec=CacheData.getServSpec(prodId,this.productId);if(this.state=="DEL"){if(serv!=undefined&&serv.isdel!="Y"){param.objId=this.prodInstId;param.status=(serv.isdel!=undefined?serv.isdel:"N");param.objIdType=1;serv.isdel="Y";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){param.objId=this.productId;param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(serv!=undefined&&serv.isdel=="Y"){param.objId=this.prodInstId;param.status=serv.isdel;param.objIdType=1;serv.isdel="N";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel=="Y"){param.objId=this.productId;param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(serv==undefined&&servSpec==undefined){param.objId=this.productId;param.status="Y";param.objIdType=2;AttachOffer.changeList.push(param);if(this.productId!=undefined&&this.productId!=""){var newSerSpec={objId:this.productId,servSpecId:this.productId,servSpecName:this.productName,ifParams:"N",isdel:"N"};CacheData.setServSpec(prodId,newSerSpec);var servSpec=CacheData.getServSpec(prodId,this.productId);servSpec.isdel="N"}}}}}}}})}var offers=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(offers)){$.each(offers,function(){if(this.memberInfo==undefined){return true}var flag=true;$.each(this.memberInfo,function(){if(ec.util.isObj(this.accProdInstId)&&prodId==this.accProdInstId){flag=false;return false}});if(flag){return true}var param={prodInstId:prodId};var offer=CacheData.getOffer(prodId,this.prodOfferInstId);var offerSpec=CacheData.getOfferSpec(prodId,this.prodOfferId);if(this.state=="DEL"){if(offer!=undefined&&offer.isdel!="Y"){param.objId=this.prodOfferInstId;param.status=(offer.isdel!=undefined?offer.isdel:"N");param.objIdType=3;offer.isdel="Y";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(offer!=undefined&&offer.isdel=="Y"){param.objId=this.prodOfferInstId;param.status=offer.isdel;param.objIdType=3;offer.isdel="N";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel=="Y"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(offer==undefined&&offerSpec==undefined){param.objId=this.prodOfferId;param.status="Y";param.objIdType=4;AttachOffer.changeList.push(param);if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){var newOfferSpec=_setSpec(prodId,this.prodOfferId);newOfferSpec.isdel="N"}}}}}}})}};var _reductionChangList=function(prodId){$.each(AttachOffer.changeList,function(){if(this.prodInstId==prodId){if(this.objIdType==1){var serv=CacheData.getServ(prodId,this.objId);if(serv!=undefined){serv.isdel=this.status}}else{if(this.objIdType==2){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec!=undefined){servSpec.isdel=this.status}}else{if(this.objIdType==3){var offer=CacheData.getOffer(prodId,this.objId);if(offer!=undefined){offer.isdel=this.status}}else{if(this.objIdType==4){var offerSpec=CacheData.getOfferSpec(prodId,this.objId);if(offerSpec!=undefined){offerSpec.isdel=this.status}}}}}}})};var _servExDepReByRoleObjs=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);paramObj.excludeServ=[];paramObj.dependServ=[];paramObj.relatedServ=[];var globContent="";$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec==undefined){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv==undefined){var newServSpec={objId:this.objId,servSpecId:this.objId,servSpecName:this.objName,ifParams:this.isCompParam,prodSpecParams:this.prodSpecParams,isdel:"C"};CacheData.setServSpec(prodId,newServSpec);servSpec=newServSpec}else{servSpec=serv}}var servSpecId=servSpec.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){}else{var data=query.offer.queryExcludeDepend(param);var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);if(content!=""){content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);globContent+=(content+"<br>")}}}})});return globContent};var paramObj={excludeServ:[],dependServ:[],relatedServ:[]};var paserServDataByObjs=function(result,prodId,serv,newSpec){var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";paramObj.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.dependServ.push(this)}})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.relatedServ.push(this)}})}return content};var _filterServ=function(servSpecId,newSpec){var flag=false;$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){if(servSpecId==this.objId){flag=true;return false}}})});if(!flag){if(ec.util.isArray(paramObj.dependServ)){for(var i=0;i<paramObj.dependServ.length;i++){if(servSpecId==paramObj.dependServ[i].servSpecId){flag=true;break}}}if(!flag){if(ec.util.isArray(paramObj.relatedServ)){for(var i=0;i<paramObj.relatedServ.length;i++){if(servSpecId==paramObj.relatedServ[i].servSpecId){flag=true;break}}}}}return flag};var _minQtyFileter=function(prodId,servSpecId){var serv=CacheData.getServBySpecId(prodId,servSpecId);var $li,$span,$span_remove;if(serv!=undefined){$li=$("#li_"+prodId+"_"+serv.servId);$span=$("#span_"+prodId+"_"+serv.servId);$span_remove=$("#span_remove_"+prodId+"_"+serv.servId)}else{$li=$("#li_"+prodId+"_"+servSpecId);
$span=$("#span_"+prodId+"_"+servSpecId);$span_remove=$("#span_remove_"+prodId+"_"+servSpecId)}if($li!=undefined){if(ec.util.isObj($span)){$span.removeClass("del")}if(ec.util.isObj($span_remove)){$span_remove.hide()}$li.removeAttr("onclick")}};var _manyPhoneFilter=function(prodId,offerSpecId){if(OrderInfo.actionFlag==14){return true}var newSpec;var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(ec.util.isObj(offer)){newSpec=offer}else{newSpec=_setSpec(prodId,offerSpecId)}if(newSpec==undefined){return false}if(ec.util.isArray(newSpec.agreementInfos)){var num=0;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.objType==CONST.OBJ_TYPE.PROD){num++}})})}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){num++}})}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==prodId){num++}})}}}var minNum=newSpec.agreementInfos[0].minNum;var maxNum=newSpec.agreementInfos[0].maxNum;if(!ec.util.isObj(minNum)){$.alert("信息提示","销售品规格查询，未返回最小合约数，请后台确认。");return false}if(num<minNum){$.alert("信息提示","该合约的最小合约数为"+minNum+"个，而该套餐的成员实例只有"+num+"个，故无法办理该合约。");return false}if(maxNum>num){newSpec.agreementInfos[0].maxNum=num}}return true};var _addAndDelTerminal=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var fag=$(obj).attr("fag");var newSpec;var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(ec.util.isObj(offer)){newSpec=offer}else{newSpec=_setSpec(prodId,offerSpecId)}var objInstId=prodId+"_"+newSpec.offerSpecId;var maxNum=newSpec.agreementInfos[0].maxNum;var minNum=newSpec.agreementInfos[0].minNum;var $ul=$("#ul_"+objInstId);var $li=$("#ul_"+objInstId+" li");var length=$li.length-1;var isFastOffer=0;if(ec.util.isArray(newSpec.extAttrParams)){$.each(newSpec.extAttrParams,function(){if(this.attrId==CONST.OFFER_FAST_FILL){isFastOffer=1;return false}})}if(fag==0){if(totalNums>=maxNum){$.alert("信息提示","终端数已经达到最大，不能再添加了。");return}var $liTerminalAdd=$('<li class="form-group"><label for="exampleInputFile">终端校验：</label><div class="input-group"><input id="terminalText_'+objInstId+"_"+(length/2+1)+'" type="text" class="form-control" maxlength="50" placeholder="请先输入终端串号" /><span class="input-group-btn"><button id="terminalBtn_'+objInstId+"_"+(length/2+1)+'" type="button" flag="'+isFastOffer+'" num="'+(length/2+1)+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" class="btn btn-default">校验</button></li>');var $liAdd=$('<li id="terminalDesc_'+(length/2+1)+'" style="white-space:nowrap;"><label></label><label id="terminalName_'+(length/2+1)+'"></label></span> </div></li>');$ul.append($liTerminalAdd).append($liAdd);totalNums++}else{if(minNum==(length/2)){$.alert("信息提示","终端数已经达到最小，不能再删除了。");return}$li.each(function(index){if(length-1==index){$(this).remove()}else{if(length==index){_filterAttach2Coupons(prodId,offerSpecId,(index/2));$(this).remove()}}});totalNums--}};var _checkData=function(objInstId,terminalCode){var $input=$("input[id^=terminalText_"+objInstId+"]");var num=0;$input.each(function(){var instCode=$.trim(this.value);if(ec.util.isObj(instCode)&&terminalCode==instCode){num++}});if(num>=2){$.alert("信息提示","终端串码重复了，请填写不同的串码。");return true}return false};var _filterAttach2Coupons=function(prodId,offerSpecId,num){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId&&attach2Coupon.num==num){OrderInfo.attach2Coupons.splice(i,1);$("#terminalName_"+num).html("");break}}};var _removeAttach2Coupons=function(prodId,offerSpecId){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId){OrderInfo.attach2Coupons.splice(i,1);i--}}};var _ifOrderAgain=function(newSpec){if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){if(parseInt(newSpec.orderCount)<newSpec.counts){$.alert("信息提示","可选包："+newSpec.offerSpecName+"至多只能订购"+newSpec.orderCount+"次");return true}}};var _setParam=function(prodId,offerSpecId,flag){var newSpec=_setSpec(prodId,offerSpecId);var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(flag==1){newSpec.counts=offer.counts}var content='<form id="paramForm">';content+='次数 : <input id="text_'+prodId+"_"+offerSpecId+'" class="inputWidth183px" type="text" value="'+newSpec.counts+'"><br>';content+="</form>";$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var nums=$("#text_"+prodId+"_"+offerSpecId).val();var reg=/^\+?[1-9][0-9]*$/;if(!reg.test(nums)){$.alert("信息提示","次数只能是正整数。");return}if(parseInt(newSpec.orderCount)<nums){$.alert("信息提示","可选包【"+newSpec.offerSpecName+"】至多只能订购"+newSpec.orderCount+"次");return}if(flag==1&&offer!=undefined){if(offer.orderCount>nums){if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offer.offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=query.offer.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}}offer.counts=nums}else{newSpec.counts=nums}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})};var _offerSpecDetail=function(prodId,offerSpecId){var offerSpecName="";var summary="";$.each(AttachOffer.allOfferList,function(){if(this.offerSpecId==offerSpecId){offerSpecName=this.offerSpecName;summary=this.summary}else{if(this.servSpecId==offerSpecId){offerSpecName=this.servSpecName;summary=this.summary}}});$("#detail_tbody").empty();var $tr=$("<tr></tr>");$tr.append("<td>"+offerSpecName+'</td><td width="900">'+summary+"</td>");$("#detail_tbody").append($tr);easyDialog.open({container:"div_detail_dialog"})};var _queryCardAttachOffer=function(cardTypeFlag){var prodInfo=order.prodModify.choosedProdInfo;var prodId=prodInfo.prodInstId;var param={prodId:prodId,prodSpecId:prodInfo.productId,offerSpecId:prodInfo.prodOfferId,acctNbr:prodInfo.accNbr};if(ec.util.isObj(prodInfo.prodBigClass)){param.prodBigClass=prodInfo.prodBigClass}var data=query.offer.queryAttachOfferHtml(param);$("#attach").html(data).show();var temp={boActionTypeCd:"14",cardType:cardTypeFlag=="1"?"4G":"3G",accNbr:prodInfo.accNbr,prodInstId:prodId,prodId:prodId,prodSpecId:prodInfo.productId};var data=query.offer.queryDefMustOfferSpecAndServ(temp);CacheData.parseOffer(data);CacheData.parseServ(data);if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){var member=CacheData.getOfferMember(prodId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==member.offerRoleId&&member.objType==CONST.OBJ_TYPE.PROD){var offerRole=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(this.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>')}}});return false}})}};var _show=function(prodId){$("#attach_"+prodId).show();$("#prodinfo_"+prodId).hide();$("#nextNav").hide();$("#c-indicators").hide()};var _btnBack=function(prodId){$("#prodinfo_"+prodId).show();$("#nextNav").show();$("#attach_"+prodId).hide();$("#c-indicators").show()};var _changeOfferS=function(obj,prodId,val){if(val=="0"){$("#open_ul_"+prodId).show();$("#open_serv_ul_"+prodId).hide()}else{$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).show()}};var _changeOfferOrdered=function(obj,prodId){var val=$(obj).val();if(val=="0"){$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).hide();
$("#order_ul_"+prodId).show();$("#serv_ul_"+prodId).hide()}else{if(val=="1"){$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).hide();$("#order_ul_"+prodId).hide();$("#serv_ul_"+prodId).show()}else{if(val=="2"){$("#open_ul_"+prodId).show();$("#open_serv_ul_"+prodId).hide();$("#order_ul_"+prodId).hide();$("#serv_ul_"+prodId).hide()}else{if(val=="3"){$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).show();$("#order_ul_"+prodId).hide();$("#serv_ul_"+prodId).hide()}}}}};var _delServSpec=function(prodId,offerSpec){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var servSpecId=this.objId;if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){var spec=CacheData.getServSpec(prodId,servSpecId);if(ec.util.isObj(spec)){spec.isdel="Y";var $li=$("#li_"+prodId+"_"+servSpecId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del");_showHideUim(1,prodId,servSpecId)}}})})};var _addOfferSpecReload=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);CacheData.setServ2OfferSpec(prodId,newSpec);_checkOfferExcludeDepend(prodId,newSpec)};return{filterAttach2Coupons:_filterAttach2Coupons,addOffer:_addOffer,addOfferSpec:_addOfferSpec,addOpenList:_addOpenList,addOpenServList:_addOpenServList,addOfferSpecByCheck:_addOfferSpecByCheck,addAndDelTerminal:_addAndDelTerminal,closeAttachSearch:_closeAttachSearch,changeLabel:_changeLabel,changeLabel1:_changeLabel1,changeList:_changeList,closeServ:_closeServ,closeServSpec:_closeServSpec,closeSearchAttach:_closeSearchAttach,checkData:_checkData,delOffer:_delOffer,delOfferSpec:_delOfferSpec,labelList:_labelList,isChangeUim:_isChangeUim,init:_init,openList:_openList,openedList:_openedList,openServList:_openServList,openedServList:_openedServList,openServSpec:_openServSpec,openAppList:_openAppList,queryAttachOffer:_queryAttachOffer,queryAttachOfferSpec:_queryAttachOfferSpec,queryCardAttachOffer:_queryCardAttachOffer,showParam:_showParam,showServParam:_showServParam,showTime:_showTime,setAttachTime:_setAttachTime,searchAttachOfferSpec:_searchAttachOfferSpec,selectAttachOffer:_selectAttachOffer,showOfferTime:_showOfferTime,showMainParam:_showMainParam,showMainMember:_showMainMember,selectServ:_selectServ,showStartTime:_showStartTime,showEndTime:_showEndTime,setAttachBusiOrder:_setAttachBusiOrder,showApp:_showApp,showHideUim:_showHideUim,showMainRoleProd:_showMainRoleProd,checkTerminalCode:_checkTerminalCode,checkOfferExcludeDepend:_checkOfferExcludeDepend,checkServExcludeDepend:_checkServExcludeDepend,servExDepReByRoleObjs:_servExDepReByRoleObjs,setChangeList:_setChangeList,reductionChangList:_reductionChangList,filterServ:_filterServ,setParam:_setParam,showMainMemberRoleProd:_showMainMemberRoleProd,changeOfferS:_changeOfferS,changeOfferOrdered:_changeOfferOrdered,offerSpecDetail:_offerSpecDetail,show:_show,btnBack:_btnBack,openServSpecReload:_openServSpecReload,delOfferSpecReload:_delOfferSpecReload,closeServSpecReload:_closeServSpecReload,excludeAddServ:_excludeAddServ,changereserveCode:_changereserveCode,delServSpec:_delServSpec,addOfferSpecReload:_addOfferSpecReload}})();CommonUtils.regNamespace("order","calcharge");order.calcharge=(function(){var N=[];var i=[];var j=0;var P=0;var R=0;var K=0;var B="newOrder";var I=false;var k=false;var L="";var a="";var s="";var v="";var g=function(V,U){if($("#div_payitem_"+V)!=undefined&&$("#div_payitem_"+V).html()!=undefined){var W=$("#div_payitem_"+V).html();var T=$("#paydialog").html();var S=$.popup("#div_payitem_choose_"+V,W,{width:600,height:500,contentHeight:400,afterClose:function(){$("#paydialog").html(T)}});order.calcharge.trObj=U}else{$.alert("提示","没有可添加费用项的业务对象！")}};var d=function(aa,X,U,T,Y,Z,S,W){var ab="0";if(OrderInfo.actionFlag==11){ab="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){ab="2"}}var V={boId:aa,objInstId:S,prodId:W,boActionTypeCd:X,actionFlag:OrderInfo.actionFlag,objType:U,objId:T,itemNum:R,objName:Y,actionName:Z,refundType:ab};$.callServiceAsHtml(contextPath+"/pad/order/getChargeAddByObjId",V,{before:function(){$.ecOverlay("<strong>正在增加收费项,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(ac){if(ac.code!=0){$.alert("提示","查询失败,稍后重试");return}$("#div_payitem_choose_"+W).popup("close");f(aa,ac.data)},fail:function(ac){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var f=function(S,T){if(T!=""){$(order.calcharge.trObj).parent().parent().parent().after(T);var U=$("#order_confirm");$.jqmRefresh(U);R--;l()}else{$.alert("提示","没有可添加的费用项");return}};var A=function(T,V,U){if(U=="old"){var S=$("#feeAmount_"+V).val();if(($("#realAmount_"+V).val())*100==0){$("#realAmount_"+V).val(((S/100).toFixed(2))+"")}else{$("#realAmount_"+V).val("0")}var W=($("#realAmount_"+V).val())*100;if(W!=S){$("#chargeModifyReasonCd_"+V).show()}else{$("#chargeModifyReasonCd_"+V).hide()}}else{$(T).parent().parent().parent().remove()}l()};var l=function(){N=[];i=[];var W=0;$("#calChangeTab tr").each(function(){var Z=$(this).attr("id");if(Z!=undefined&&Z!=""){Z=Z.substr(5,Z.length);if($("#paymentAmount_"+Z)&&$("#paymentAmount_"+Z).val()*1==0){}else{var X=$("#realAmount_"+Z).val();if(!isNaN(X)){var Y=($("#realAmount_"+Z).val())*1;if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){Y=($("#backAmount_"+Z).val())*1}W=W+Y;$("#realhidden_money"+Z).val(W);C(Z)}}}});if(OrderInfo.actionFlag==15){var T=0;$("#calChangeTab tr").each(function(){var Y=$(this).attr("id");if(Y!=undefined&&Y!=""){if($("#paymentAmount_"+Y)&&$("#paymentAmount_"+Y).val()*1==0){}else{Y=Y.substr(5,Y.length);var X=($("#backAmount_"+Y).val())*1;T=T+X}}});$("#backAmount").val(Number(T).toFixed(2))}var U=0;var V=$("input[name='realhidden_']");for(var S=0;S<V.length;S++){U+=V[S].value*1}$("#realMoney").html(Number(U).toFixed(2));if(OrderInfo.actionFlag==15){order.refund.conBtns()}else{x()}};var c=function(){var U=true;var T=true;var S=true;$("#calChangeTab tr").each(function(){var Y=$(this).attr("id");if(Y!=undefined&&Y!=""){Y=Y.substr(5,Y.length);var Z=$("#chargeModifyReasonCd_"+Y).val();if(Z=="1"){if($("#remark_"+Y).val()==undefined||$("#remark_"+Y).val()==null||$("#remark_"+Y).val()==""){U=false}}var X=$("#payMethodCd_"+Y).val();var V=$("#terminalNumber").val();var W=$("#serialNumber").val();if(X=="110101"){if(V==undefined||$.trim(V)==""){S=false}if(W==undefined||$.trim(W)==""){S=false}if(V.length>100){T=false}if(W.length>100){T=false}}}});if(!U){$.alert("提示信息","请填写修改原因");return false}if(!S){$.alert("提示信息","pos流水号或者终端号不能为空，请重新输入！");return false}if(!T){$.alert("提示信息","pos流水号或者终端号长度超过100位，请重新输入！");return false}N=[];y();return true};var y=function(){$("#calChangeTab tr").each(function(){var al=$(this).attr("id");if(al!=undefined&&al!=""){al=al.substr(5,al.length);var aa=($("#realhidden_money"+al).val())*100+"";if(isNaN(aa)){return}var T=($("#realhidden_money"+al).val())*100+"";var Z=$("#feeAmount_"+al).val();var W="";if(Z!=undefined&&Z!=""){W=Z+""}else{W=T}if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){W=$("#feeAmount_"+al).val()*1+"";T=(0-($("#backAmount_"+al).val())*100)+""}var S=$("#acctItemTypeId_"+al).val();var ad=$("#objId_"+al).val();var af=$("#objType_"+al).val();var ag=$("#acctItemId_"+al).val();var ai=$("#boId_"+al).val();var V=$("#payMethodCd_"+al).val();var U=$("#objInstId_"+al).val();var ah=$("#prodId_"+al).val();var ab=$("#boActionType_"+al).val();var ae=$("#paymentAmount_"+al).val();var ac=1;var aj="";if($("#chargeModifyReasonCd_"+al).css("display")=="none"){if(W!=T){aj="其他"}}else{ac=$("#chargeModifyReasonCd_"+al).val();aj=$("#chargeModifyReasonCd_"+al).find("option:selected").text();if(ac=="1"){aj=$("#remark_"+al).val()}}if(W!=T&&aj==""){aj="其他"}var ak="";var X="";if(V=="110101"){ak=$("#terminalNumber").val();X=$("#serialNumber").val()}var Y={realAmount:T,feeAmount:W,paymentAmount:ae,acctItemTypeId:S,objId:ad,objType:af,acctItemId:ag,boId:ai,prodId:ah,objInstId:U,payMethodCd:V,terminalNo:ak,posSeriaNbr:X,chargeModifyReasonCd:ac,remark:aj,boActionType:ab};
N.push(Y)}})};var w=function(V,Y,X){var T={acctItemTypeId:V};var S=contextPath+"/app/order/queryPayMethodByItem";var U=$.callServiceAsJson(S,T);if(U.code==0){if(U.data!=undefined&&U.data!=null){if(U.data.length>0){var Z=U.data;var aa=false;if(OrderInfo.actionFlag==11){if(Z[0].limitChange=="N"){return true}}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){if(Z[0].limitBuyBack=="N"){return true}}else{if(OrderInfo.actionFlag==15){if(Z[0].limitRedo=="N"){aa=true}}else{if(Z[0].limitChange=="N"){aa=true}}}}var ab=Z[0].payMethods;if(ab.length>0){if(Y){var W='<select  id="changeMethod_'+Y+'"  data-native-menu="false">';$.each(ab,function(ac,ad){if(ad.payMethodCd==X){W+='<option value="'+ad.payMethodCd+'" selected="selected">'+ad.payMethodName+"</option>"}else{W+='<option value="'+ad.payMethodCd+'">'+ad.payMethodName+"</option>"}});W+="</select>";$("#payMethodText_"+Y).html(W)}}return aa}else{return false}}else{return false}}else{if(U.code==-2){$.alertM(U.data);return false}else{$.alert("提示","查询付费方式失败!");return false}}};var e=function(S){if($("#chargeModifyReasonCd_"+S).val()=="1"){$("#chargeModifyReasonCdDiv_"+S).hide();$("#chargeModifyReasonCdDiv_"+S).next(".edit").show()}$("#chargeModifyButton_"+S).on("onclick",function(){$(this).parents().find(".edit").hide();$("#chargeModifyReasonCd_"+S+" option").each(function(){if($(this).val()=="3"){$(this).attr("selected",true)}});$("#chargeModifyReasonCd_"+S).selectmenu("refresh");$("#chargeModifyReasonCdDiv_"+S).show()})};var p=function(T,W,U,V){var S=w(T,W,U);if(S){if(z(W)){$("#payMethodDiv").html($("#payMethodText_"+W).html());$("#chargeModifyReasonCd_"+W).off("change").on("change",function(){if($(this).val()=="1"){$("#remark_"+W).css("display","inline")}else{$("#remark_"+W).css("display","none")}});if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20||OrderInfo.actionFlag==15){$("#backAmount_"+W).removeAttr("disabled").css("border","1px solid #DCDCDC").focus()}else{$("#realAmount_"+W).removeAttr("disabled").css("border","1px solid #DCDCDC").focus()}$("#changeMethod_"+W).off("change").on("change",function(){var X=$(this).val();$("#payMethodCd_"+W).val(X);$("#changeMethod_"+W).selectmenu("refresh");if(X=="110101"){$("#posDiv").css("display","inline");$("#posDiv").css("disabled","")}else{$("#posDiv").css("display","none");$("#posDiv").css("disabled","disabled")}})}}};var z=function(Y){var X={};var V=contextPath+"/app/order/queryAuthenticDataRange";var T=$.callServiceAsJson(V,X);if(T.code==0){var U=T.data;var S=false;for(var W=0;W<U.length;W++){if($("#acctItemTypeId_"+Y).val()==U[W].dataDimensionName){S=true;break}else{S=false}}if(S){return true}else{$.alert("提示","当前费用项不允许修改!");return false}}else{if(T.code==-2){$.alertM(T.data);return false}else{$.alert("提示","权限数据范围查询失败!");return false}}};var C=function(W){var ac=($("#realAmount_"+W).val())*100+"";var aa=$("#feeAmount_"+W).val();var Y="";if(aa!=undefined&&aa!=""){Y=aa+""}else{Y=ac}var Z=$("#acctItemTypeId_"+W).val();var T=$("#objId_"+W).val();var V=$("#objType_"+W).val();var ab=$("#acctItemId_"+W).val();var X=$("#acctItemTypeName_"+W).val();var S=$("#paymentAmount_"+W).val();var U={realmoney:ac,feeAmount:Y,paymentAmount:S,acctItemTypeId:Z,objId:T,objType:V,acctItemId:ab,acctItemTypeName:X};i.push(U)};var o=function(V,Y,X){var W=$("#trid").val();if(typeof V=="object"){L=$.trim($(V).val())}else{L=V}if(L==""){$(V).val("0");order.calcharge.reflashTotal()}else{if(X=="old"){var U=$("#feeAmount_"+Y).val();var S=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(L)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");S=false}else{if((L*100>U*1)&&U>0){$.alert("提示","实收费用金额不能高于应收金额！");S=false}else{if((L*100<U*1)&&U<0){$.alert("提示","实收费用金额不能低于应收金额！");S=false}}}if(S){var Z=(L)*100;if(Z!=U){$("#chargeModifyReasonCdDiv_"+Y).show()}else{$("#chargeModifyReasonCdDiv_"+Y).hide()}if(typeof V!="object"){$("#cal_main_content").show();$("#edit_content").hide()}$("#chargeModifyReasonCd_"+Y)[0].style.display="block";l()}else{if(K!=""){}K=""}}else{if(X=="undo"){var S=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(L)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");S=false}else{if(L<0){$.alert("提示","退费金额不能为负值！");S=false}else{var U=$("#realhidden_"+Y).val();var T=L*-1;if(T<U*1){$.alert("提示","退费金额不能高于实收金额！");S=false}}}if(S){var Z=($(V).val())*-1;if(Z!=0){$("#chargeModifyReasonCdDiv_"+Y).show()}else{$("#chargeModifyReasonCdDiv_"+Y).hide();$("#chargeModifyReasonCdDiv_"+Y).next(".edit").hide()}if(typeof V!="object"){$("#cal_main_content").show();$("#edit_content").hide()}l()}else{if(K!=""){$(V).val(K)}K=""}}else{if(X=="new"){if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(L)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");if(K!=""){$(V).val(K)}K=""}else{if(L<0){$.alert("提示","实收费用金额不能为负值！")}else{if(typeof V!="object"){$("#cal_main_content").show();$("#edit_content").hide()}l()}}}}}}a=$("#changeMethod_"+Y).val();s=$("#chargeModifyReasonCd_"+Y).val();v=$("#remark_"+Y).val()};var t=function(S){K=$.trim($(S).val())};var E=function(){$("#toComplate").attr("disabled","disabled");$("#orderCancel").attr("disabled","disabled");$("#orderBack").attr("disabled","disabled");$("#orderCancel").off("onclick");$("#toComplate").off("onclick");$("#toCharge").off("onclick")};var x=function(){$("#orderCancel").removeAttr("disabled");$("#orderBack").removeAttr("disabled");var S=$.trim($("#realMoney").html())*1;if(OrderInfo.actionFlag==11){$("#orderCancel").off("onclick").on("onclick",function(T){order.undo.orderBack()})}else{$("#orderCancel").off("onclick").on("onclick",function(T){SoOrder.orderBack()})}if(!I){if(S!=0){$("#toCharge").removeAttr("disabled");$("#toComplate").attr("disabled","disabled");$("#toCharge").off("onclick").on("onclick",function(T){q("1")});$("#toComplate").off("onclick")}else{$("#toComplate").removeAttr("disabled");$("#toCharge").off("onclick");$("#toComplate").off("onclick").on("onclick",function(T){b("0",false)})}}else{$("#toCharge").removeAttr("disabled");$("#toComplate").attr("disabled","disabled");$("#toCharge").off("onclick");$("#toComplate").off("onclick")}};var q=function(S){E();if(I){$.alert("提示","订单已经建档成功,不能重复操作!");return}if(k){return}if(!c()){x();return}k=true;var T=contextPath+"/app/order/updateChargeInfoForCheck";var U={olId:j,soNbr:OrderInfo.order.soNbr,areaId:OrderInfo.staff.areaId,chargeItems:N,custId:OrderInfo.cust.custId};$.callServiceAsJson(T,U,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},done:function(V){$.unecOverlay();if(V.code==0){b(S,true)}else{if(V.code==-2){x();k=false;$.alertM(V.data)}else{x();k=false;if(V.data!=undefined){$.alert("提示",V.data)}else{$.alert("提示","代理商保证金校验失败!")}}}}})};var n=function(W){var U=contextPath+"/app/order/checkRuleToProv";var X={olId:W.rolId,soNbr:W.rsoNbr,areaId:OrderInfo.staff.areaId,chargeItems:[]};$.ecOverlay("<strong>正在下省校验,请稍等会儿....</strong>");var T=$.callServiceAsJson(U,X);$.unecOverlay();var S;if(T.code==0){var V=T.data;if(V.checkResult!=undefined){OrderInfo.checkresult=V.checkResult}S={code:0}}else{S={code:1,data:T.data}}return S};var b=function(Z,Y){var aa=$("#realmoney").val();if(aa=="0.00"){if(!c()){return}}var V={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,areaId:OrderInfo.staff.areaId,chargeItems:N};var S=contextPath+"/app/order/chargeSubmit?token="+OrderInfo.order.token;var W=$.callServiceAsJson(S,V,{});var U="";if(W.code==0){I=true;SoOrder.delOrderFin();if(OrderInfo.actionFlag==31){var S=contextPath+"/cust/passwordReset";var X=$.callServiceAsJson(S,null,{})}if(Z=="1"){if(OrderInfo.actionFlag==11){U="退费成功"}else{U="收费成功"}}else{U="受理成功"}$("#toComplate").removeAttr("disabled");$("#orderCancel").removeAttr("disabled");$("#printVoucherA").attr("disabled","disabled");$("#calChangeTab tr").each(function(){var ab=$(this).attr("id");if(ab!=undefined&&ab!=""){ab=ab.substr(5,ab.length);$("#backAmount_"+ab).attr("disabled","disabled");$("#upate").attr("disabled","disabled")}});if(OrderInfo.actionFlag==11){$("#orderCancel").html("<span>返回首页</span>");$("#orderCancel").off("onclick").on("onclick",function(ab){order.undo.toUndoMain(1)
})}else{var T=OrderInfo.provinceInfo.redirectUri;if(T!=null&&T!=undefined&&T!=""){$("#orderCancel").off("click").on("click",function(ab){Q()})}}SoOrder.updateResState();if(Z=="1"){var aa=($("#realMoney").html())*1;M(Z,U)}else{M(Z,U)}return}else{if(W.code==-2){x();SoOrder.getToken();k=false;$.alertM(W.data)}else{x();SoOrder.getToken();k=false;if(W.data!=undefined){alert(W.data)}else{$.alert("提示","费用信息提交失败!")}}}};var M=function(S,U){var T="";if(S=="1"){if(OrderInfo.actionFlag==11){T="退费结果"}else{T="收费结果"}}else{T="受理结果"}$("#btn-dialog-ok").removeAttr("data-dismiss");$("#alert-modal").modal({backdrop:"static",keyboard:false});var V=OrderInfo.provinceInfo.redirectUri;if(V!=null&&V!=undefined&&V!=""){$("#btn-dialog-ok").off("click").on("click",function(W){Q()})}else{$("#div_info_btn").hide()}$("#modal-title").html(T);$("#modal-content").html(U);$("#alert-modal").modal()};var u=function(U,T){var S=$("#payMethodCd_"+U);S.empty();$("select[@id=backpayMethodCd_"+U+"] option").each(function(){var W=$(this).val();if(W!=undefined){var V=$(this).text();if(W.split("_")[1]==$(T).val()){$("<option value='"+W.split("_")[0]+"'>"+V+"</option>").appendTo(S)}}})};var G=function(){common.callCloseWebview()};var h=function(){j=OrderInfo.orderResult.olId;P=OrderInfo.orderResult.soNbr;N=[];i=[];R=0;K=0;I=false;k=false;var S="0";if(OrderInfo.actionFlag==11){S="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){S="2"}}var T={olId:j,custVipLevel:OrderInfo.cust.vipLevel,actionFlag:OrderInfo.actionFlag,actionTypeName:encodeURI(OrderInfo.actionTypeName),businessName:encodeURI(OrderInfo.businessName),olNbr:OrderInfo.orderResult.olNbr,soNbr:OrderInfo.order.soNbr,refundType:S,checkResult:JSON.stringify(OrderInfo.checkresult)};$.callServiceAsHtmlGet(contextPath+"/token/app/order/getChargeList",T,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){},done:function(U){$.unecOverlay();SoOrder.getToken();if(U.code!=0){$.alert("提示","收费页面加载失败，请稍后重试");return}if(OrderInfo.provinceInfo.isFee=="1"){SoOrder.delOrderFin();$("#toComplate").attr("disabled","disabled");var X=OrderInfo.provinceInfo.redirectUri;if(X!=null&&X!=""&&X!="undefined"){Q()}else{$("#btn-dialog-ok").removeAttr("data-dismiss");$("#alert-modal").modal({backdrop:"static",keyboard:false});$("#div_info_btn").hide();$("#modal-title").html("提示");$("#modal-content").html("订单暂存成功！");$("#alert-modal").modal()}}else{if(OrderInfo.provinceInfo.isFee=="2"){SoOrder.getToken();var W=$("#order-confirm").html(U.data).fadeIn();var V=$("#paydialog").html();$("#paydialog").html("");$.refresh(W);$("#paydialog").html(V);$.each($(".cashier_dd"),function(){var Y=$(this).attr("id");var Z=$(this);if($.trim($(this).html())==""&&$(".userorderlist")!=undefined){$.each($("#userorderlist li").find("dl:eq(0)"),function(){var ab=$(this).attr("prodInstId");var ac=$(this).attr("accNbr");var aa=$(this).attr("productName");if(ab!=undefined&&ac!=undefined){if(Y==ab){Z.html(aa+"&nbsp;-&nbsp;"+ac)}}})}});$("#printVoucherA").off("click").on("click",function(Y){if(!c()){return}var Z={olId:j,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:N,areaId:OrderInfo.getAreaId()};common.print.signVoucher(Z)});if(OrderInfo.actionFlag==15){order.refund.conBtns()}else{x()}}}},fail:function(U){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var H=function(){var S={olId:OrderInfo.order.oldSoId,soNbr:OrderInfo.order.oldSoNbr};$.callServiceAsHtmlGet(contextPath+"/app/order/invaideInvoice",S,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},done:function(T){$.unecOverlay();if(T.code==0){var U=$.parseJSON(T.data);if(U.code==0){$("#successTip_dialog_inv").off("onclick");$.alert("提示","作废发票成功！")}else{if(U.code==1){$.alert("提示","作废发票失败！")}else{if(U.code==2){$.alert("提示","未获取到发票信息！")}else{if(U.code==3){$.alert("提示","获取发票失败！")}else{$.alert("提示","作废发票异常！")}}}}}else{if(T.code==-2){}else{$.alert("提示","作废发票异常！")}}},fail:function(T){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var J=function(T,W,U){var V={trid:W};var S=contextPath+"/token/app/order/getEditPage";$.callServiceAsHtmlGet(S,V,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(X){$.unecOverlay();$("#cal_main_content").hide();var Y=$("#edit_content");Y.html(X.data).show();$("#cal_main_content").hide();$("#edit_content").show();$("#pnumber").text(T);$("#payMethodDiv").html($("#payMethodText_"+W).html());$("#editBtnDiv").html($("#editBtn_"+W).html());U=$("#realhidden_money"+W).val();$("#realAmount_"+W).val(U);if(a!=""){$("#changeMethod_"+W).val(a)}if(s!=""){$("#chargeModifyReasonCd_"+W).val(s)}$("#remark_"+W).val(v)},fail:function(X){$.alert("提示","显示费用编辑页面失败，请稍后再试！")}})};var m=function(){var T=$("#trid").val();o($("#realAmount_"+T).val(),T,"old");var S=$("#payMethodDiv select").val();if(S!=null&&S!=""&&S!=undefined){$("#payMethodCd_"+T).val(S)}};var O=function(S,U,T){$("#cal_main_content").show();$("#edit_content").hide()};var F=function(S){if(S&&S.page&&S.page>=1){r(S.page,S.scroll)}};var r=function(T,S){OrderInfo.actionFlag=140;var U=1;if(T>0){U=T}var V={};V={startDate:($("#p_startDt").val()).replace(/-/g,""),channelId:$("#p_channelId").val(),areaId:$("#p_channelId").attr("areaid"),pageIndex:U,pageSize:10};$.callServiceAsHtmlGet(contextPath+"/app/report/freeInfoList",V,{before:function(){$.ecOverlay("终端销售详情查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(W){if(W&&W.code==-2){return}else{$("#fee_search").hide();$("#fee_list").html(W.data).show();OrderInfo.order.step=2;$("#fee_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(S&&$.isFunction(S)){S.apply(this,[])}}},fail:function(W){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var D=function(){if(OrderInfo.order.step==1){common.callCloseWebview()}else{if(OrderInfo.order.step==2){$("#fee_search").show();$("#fee_list").hide();OrderInfo.order.step=1}else{common.callCloseWebview()}}};var Q=function(){var S={provIsale:OrderInfo.provinceInfo.provIsale,extCustOrderID:OrderInfo.orderResult.olId,resultCode:"0",redirectUri:OrderInfo.provinceInfo.redirectUri};$.callServiceAsHtmlGet(contextPath+"/mode/app/backProvince",S,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){},done:function(T){$.unecOverlay();if(T.code==0){var U=$.parseJSON(T.data);if(U.code==0){if(U.data.indexOf("&amp;")!=-1){U.data=U.data.replace(/\&amp;/g,"&")}window.location.href=U.data;return}else{if(U.code==1){$.alert("提示",U.data)}}}else{$.alert("提示","页面回调异常！")}},fail:function(T){$.unecOverlay();$.alert("提示","页面回调可能发生异常，请稍后再试！")}})};return{addItems:f,delItems:A,reflashTotal:l,editMoney:o,setGlobeMoney:t,addbusiOrder:g,addSubmit:d,selePaymethod:u,calchargeInit:h,pageFlag:B,changePayMethod:p,bindChargeModifyReason:e,invaideInvoice:H,tochargeSubmit:n,chargeSave:b,showEditPage:J,confirm:m,close:O,updateChargeInfoForCheck:q,feeScroll:F,btnQueryfee:r,back:D,backToProvince:Q}})();$(function(){OrderInfo.order.step=1});CommonUtils.regNamespace("order","service");order.service=(function(){var A="";var g=false;var p=false;var f=[];var w=0;var j=function(){OrderInfo.order.step=1;OrderInfo.actionFlag=1;order.service.queryApConfig();order.service.searchPack()};var r="";var u=function(C){if(r!=C){var B=$(".btn-group button");$.each(B,function(){if(C==this){$("#qryStr").val($(this).attr("value"));i();r=C;$(this).removeClass("btn btn-default");$(this).removeClass("btn btn-default active");$(this).addClass("btn btn-default btn-group-active")}else{$(this).removeClass("btn btn-default active");$(this).removeClass("btn btn-default btn-group-active");$(this).addClass("btn btn-default")}})}};var i=function(I,H){var J=OrderInfo.cust.custId;var L=$("#qryStr").val();var E={qryStr:L,pnLevelId:"",custId:J};if(I){var D=$("#select_price").val();if(ec.util.isObj(D)){var G=D.split("-");if(G[0]!=null&&G[0]!=""){E.priceMin=G[0]}if(G[1]!=null&&G[1]!=""){E.priceMax=G[1]}}var K=$("#select_invoice").val();if(ec.util.isObj(K)){var C=K.split("-");if(C[0]!=null&&C[0]!=""){E.INFLUXMin=C[0]*1024
}if(C[1]!=null&&C[1]!=""){E.INFLUXMax=C[1]*1024}}var B=$("#select_influx").val();if(ec.util.isObj(B)){var F=B.split("-");if(F[0]!=null&&F[0]!=""){E.INVOICEMin=F[0]}if(F[1]!=null&&F[1]!=""){E.INVOICEMax=F[1]}}}n(E,I,H)};var n=function(F,C,B){if(OrderInfo.actionFlag==2){var G=order.prodModify.choosedProdInfo.prodOfferId;if(G!=undefined){F.changeGradeProdOfferId=G}var E="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.objId!=undefined){E=E+","+this.objId}}});if(E!=""){E=E.substring(1,E.length);F.prodSpecId=E}F.actionFlag=2}else{if(CONST.getAppDesc()==0){F.prodOfferFlag="4G"}}var D=contextPath+"/app/order/offerSpecList";$.callServiceAsHtmlGet(D,F,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay();$("#search-modal").modal("hide")},done:function(H){$("#search-modal").modal("hide");if(H.code!=0){$.alert("提示","<br/>查询失败,稍后重试");return}var I=$("#offer-list");I.html(H.data);if(B&&$.isFunction(B)){B.apply(this,[])}},fail:function(H){$.unecOverlay();$("#search-modal").modal("hide");$.alert("提示","套餐加载失败，请稍后再试！")}})};var k=function(E){if(E&&E.page&&E.page>=1){if(E.page==1){i(1,E.scroll)}else{var C=10;var D=(E.page-2)*C;var B=D+C;$("#div_all_data").children().slice(D,B).appendTo($("#div_offer_list"));if(E.scroll&&$.isFunction(E.scroll)){E.scroll.apply(this,[])}}}};var t=function(){var C={CONFIG_PARAM_TYPE:"PROD_AND_OFFER"};var B=contextPath+"/app/order/queryApConf";$.callServiceAsJsonGet(B,C,{done:function(D){if(D.data){var H=D.data.length;for(var G=0;G<H;G++){if(D.data[G].OFFER_PRICE){OFFER_PRICE=D.data[G].OFFER_PRICE;for(var E=0;E<OFFER_PRICE.length;E++){var I=OFFER_PRICE[E].COLUMN_VALUE;var F=OFFER_PRICE[E].COLUMN_VALUE_NAME;$("#select_price").append("<option value='"+I+"'>"+F+"</option>")}}else{if(D.data[G].OFFER_INFLUX){OFFER_INFLUX=D.data[G].OFFER_INFLUX;for(var E=0;E<OFFER_INFLUX.length;E++){var I=OFFER_INFLUX[E].COLUMN_VALUE;var F=OFFER_INFLUX[E].COLUMN_VALUE_NAME;$("#select_invoice").append("<option value='"+I+"'>"+F+"</option>")}}else{if(D.data[G].OFFER_INVOICE){OFFER_INVOICE=D.data[G].OFFER_INVOICE;for(var E=0;E<OFFER_INVOICE.length;E++){var I=OFFER_INVOICE[E].COLUMN_VALUE;var F=OFFER_INVOICE[E].COLUMN_VALUE_NAME;$("#select_influx").append("<option value='"+I+"'>"+F+"</option>")}}}}$.refresh($("#search-modal"))}}}})};var s=function(E,F,B){var G={aoId:E,agreementType:F,numLevel:B};var D=contextPath+"/order/queryPackForTerm";var C=$.callServiceAsJson(D,G,{});return C};var v=function(B,D){OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldAddNumList=[];var C=OrderInfo.cust.custId;offerprice=D;if(OrderInfo.cust==undefined||C==undefined||C==""){$.alert("提示","在订购套餐之前请先进行客户定位！")}else{var F={price:D,specId:B,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};if(OrderInfo.actionFlag==2){order.service.opeSer(F)}else{var E=[{boActionTypeCd:"S1",instId:"",specId:B}];rule.rule.ruleCheck(E,function(G){if(ec.util.isObj(G)){$("#order_prepare").hide();var H=$("#order").html(G).show();$.refresh(H)}else{order.service.opeSer(F)}})}}};var a=function(H){f=[];OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];var D={offerSpecId:H.specId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var E=query.offer.queryMainOfferSpec(D);if(!E){return}if(OrderInfo.actionFlag==2){var B=contextPath+"/app/order/queryFeeType";$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");var F=$.callServiceAsJsonGet(B,D);$.unecOverlay();if(F.code==0){if(F.data!=undefined){if("0"==F.data){var L=false;if(order.prodModify.choosedProdInfo.feeType=="2100"&&(E.feeType=="2100"||E.feeType=="3100"||E.feeType=="3101"||E.feeType=="3103"||E.feeType=="1202"||E.feeType=="2101")){L=true}else{if(order.prodModify.choosedProdInfo.feeType=="1200"&&(E.feeType=="1200"||E.feeType=="3100"||E.feeType=="3102"||E.feeType=="3103"||E.feeType=="1202"||E.feeType=="2101")){L=true}else{if(order.prodModify.choosedProdInfo.feeType=="1201"&&(E.feeType=="1201"||E.feeType=="3101"||E.feeType=="3102"||E.feeType=="3103")){L=true}}}if(!L){alert("付费类型不一致,无法进行套餐变更。");return}}}}offerChange.offerChangeView();return}var K=order.memberChange.areaidJurisdiction();var G=0;var J=0;var I="";var C="";$("#div_content").empty();$.each(E.offerRoles,function(){var M=this;if(M.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){$.each(this.roleObjs,function(){var Q=M.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){if(M.memberRoleCd=="401"){f.push(Q)}if(M.minQty==0){this.minQty=0;this.dfQty=0}if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){this.dfQty=OrderInfo.reloadProdInfo.cardNum}J=this.maxQty<0?"不限制":this.maxQty;w=J;var N=this.minQty;if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""&&M.memberRoleCd=="401"){var O=OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");var P=O.length;this.dfQty=P;this.minQty=P;this.maxQty=P;J=P}if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""&&OrderInfo.newOrderNumInfo.newSubPhoneNum==""&&M.memberRoleCd=="401"){this.maxQty=0;J=0}I+="<div class='form-group'><label for='"+Q+"'>副卡数量:"+this.minQty+"-"+J+"(张)</label><div class='input-group input-group-lg'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.subNum('"+Q+"',"+this.minQty+")> - </button></span><input type='text'  readonly='readonly' class='form-control' id='"+Q+"' value='"+this.dfQty+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.addNum('"+Q+"',"+this.maxQty+",'"+M.parentOfferRoleId+"')> + </button></span> </div></div>";$("#div_content").append(I);G++;return false}})}if(M.memberRoleCd=="401"&&K!=""&&K.net_vice_card=="0"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var O=this.maxQty<0?"不限制":this.maxQty;var R=this.minQty;var S=OrderInfo.oldSubPhoneNum.oldSubPhoneNum;if(this.maxQty!=0){var S="";if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){var N=OrderInfo.reloadOrderInfo;var Q=N.orderList.custOrderList[0].busiOrder;$.each(Q,function(V,W){if(W.boActionType.actionClassCd==1200&&W.boActionType.boActionTypeCd=="S2"&&W.busiObj.offerTypeCd=="1"){var U=W.busiObj.accessNumber;OrderInfo.oldAddNumList.push({accNbr:U});S+=U+","}})}else{S=OrderInfo.oldSubPhoneNum.oldSubPhoneNum}C+="<div class='form-group'><label >已有移动号码:"+R+"-"+O+"(张)</label><div class='input-group input-group-lg' id='oldnum_1' name='oldnbr'><input type='text'  class='form-control' id='oldphonenum_1'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick='order.memberChange.addNum("+O+");'> + </button></span> </div></div>";$("#div_content").append(C);if(S!=null&&S!=""){var T=S.split(",");if(T!=null&&T.length>0){for(var P=0;P<T.length;P++){if(P==0){$("#oldphonenum_1").val(T[P])}else{order.memberChange.addNum(O);$("#oldphonenum_"+(P+1)).val(T[P])}}}}}}})}});var D={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:E,actionFlag:1,type:1};if(G>0){$("#vice_modal").modal("show");if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){order.service.confirm(D)}else{$("#btn_modal").off("click").on("click",function(){order.service.confirm(D)})}}else{if(!d(1)){$.alert("错误提示","请选择一个接入产品");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(D)}}};var y=function(D){order.memberChange.viceCartNum=0;$.each(OrderInfo.offerSpec.offerRoles,function(){this.prodInsts=[]});var C=0;$.each(f,function(){C=C+Number($("#"+this).val())});var B=0;$("#div_content").find("div[name='oldnbr']").each(function(){var E=$.trim($(this).children("input").val());if(ec.util.isObj(E)){B++}});if(!d()){$.alert("错误提示","请选择一个接入产品");return}if(C>0){order.service.newMemberFlag=true;D.newnum=C}else{order.service.newMemberFlag=false}if(B>0){order.service.oldMemberFlag=true;if(!order.memberChange.queryofferinfo()){return}D.oldprodInstInfos=OrderInfo.oldprodInstInfos;D.oldofferSpec=OrderInfo.oldofferSpec;D.oldoffer=OrderInfo.oldoffer;D.oldnum=B}else{order.service.oldMemberFlag=false
}if(parseInt(C)+parseInt(order.memberChange.viceCartNum)>w){$.alert("提示","加装数量已经超过能加装的最大数量【"+w+"】---!");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(D)}else{mktRes.terminal.newnum=C;mktRes.terminal.oldnum=B}$("#vice_modal").modal("hide")};var d=function(C){var D=-1;var B=false;$.each(OrderInfo.offerSpec.offerRoles,function(){var E=this;if(E.prodInsts==undefined){E.prodInsts=[]}$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var F=0;if(C==1){F=1}else{if(E.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&OrderInfo.actionFlag!=2){F=1}else{F=$("#"+E.offerRoleId+"_"+this.objId).val()}}if(F==undefined||F==""){F=0}for(var H=0;H<F;H++){var G=jQuery.extend(true,{},this);G.prodInstId=D--;if(F>1){G.offerRoleName=E.offerRoleName+(H+1)}else{G.offerRoleName=E.offerRoleName}G.memberRoleCd=E.memberRoleCd;E.prodInsts.push(G);B=true}E.selQty=F}else{if(this.minQty==0){this.dfQty=1}}})});return B};var l=function(B,I,G){if(ec.util.isObj(G)){var K=0;var F=[];var C=0;$.each(OrderInfo.offerSpec.offerRoles,function(){var L=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var M=L.offerRoleId+"_"+this.objId;if(ec.util.isObj(L.parentOfferRoleId)&&G==L.parentOfferRoleId){F.push(L);C=L.parentMaxQty;K+=Number($("#"+M).val())}}})});if(C>0){if(K>=C){if(ec.util.isArray(F)){var H="【";for(var D=0;D<F.length;D++){var J=F[D];H+=J.offerRoleName+","}H=H.substr(0,H.lastIndexOf(","));H+="】角色成员数量总和不能超过"+C;$.alert("规则限制",H);return}}}}var E=Number($("#"+B).val());if(I<0){E+=1;$("#"+B).val(E)}else{if(E<I){E+=1;$("#"+B).val(E)}}};var z=function(D,C){var B=Number($("#"+D).val());if(B>C){B-=1;$("#"+D).val(B)}};var q=function(){$("#order_prepare").show();$("#order").hide()};var o=function(){$("#order-content").show();$("#order-dealer").hide()};var b=0;var c={};var x=function(B){var D={};var C=contextPath+"/order/prodoffer/prepare?subPage="+B;$.callServiceAsHtmlGet(C,D,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(E){if(!E){E.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>页面显示失败,稍后重试</strong></div>'}if(E.code!=0){$.alert("提示","页面显示失败,稍后重试");return}var F=$("#offerspecContent");F.html(E.data);order.prepare.backToInit();_initSpec();order.prodOffer.queryApConfig();order.service.searchPack();$("#chooseofferspecclose").click(function(){m()});easyDialog.open({container:"chooseofferspec"})}})};var m=function(){if(!$("#chooseofferspec").is(":hidden")){easyDialog.close()}};var h=function(B,C){$("#uim_txt_"+C).val(B)};var e=function(D,L,I,J,B){var E={offerSpecId:L};var G=$.callServiceAsJson(contextPath+"/order/queryOfferSpec",E);if(G.code==0){if(G.data){var F="";var C=G.data.offerSpec;if(C&&C.offerRoles){var K=C.offerRoles;for(var H=0;H<K.length;H++){if(K[H].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||K[H].memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(K[H].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){F=K[H].offerRoleId;break}}else{F=K[H].offerRoleId;break}}}if(F!=""){m();order.prodModify.chooseOfferForMember(L,J,B,F)}else{$.alert("提示","无法选择套餐，套餐规格查询失败！")}}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","套餐详细加载失败，请稍后再试！")}}};return{btnBack:q,buyService:v,queryApConfig:t,queryData:n,init:j,opeSer:a,scaningCallBack:h,scroll:k,searchPack:i,setOfferSpec:d,tabChange:u,queryPackForTerm:s,addNum:l,subNum:z,releaseFlag:b,boProdAn:c,offerprice:A,offerDialog:x,choosedOffer:e,confirm:y,oldMemberFlag:p,newMemberFlag:g,backStepTwo:o}})();CommonUtils.regNamespace("order","main");order.main=(function(){var k=function(M){if(M==undefined||!M){M=e()}if(OrderInfo.actionFlag==6){var L=false;if(M.feeTypeMain=="2100"&&(M.offerSpec.feeType=="2100"||M.offerSpec.feeType=="3100"||M.offerSpec.feeType=="3101"||M.offerSpec.feeType=="3103")){L=true}else{if(M.feeTypeMain=="1200"&&(M.offerSpec.feeType=="1200"||M.offerSpec.feeType=="3100"||M.offerSpec.feeType=="3102"||M.offerSpec.feeType=="3103")){L=true}else{if(M.feeTypeMain=="1201"&&(M.offerSpec.feeType=="1201"||M.offerSpec.feeType=="3101"||M.offerSpec.feeType=="3102"||M.offerSpec.feeType=="3103")){L=true}}}if(!L){$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");return}}$.callServiceAsHtml(contextPath+"/token/app/order/main",M,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(N){if(!N){$.unecOverlay();N.data="查询失败,稍后重试"}if(N.code!=0){$.unecOverlay();$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=M.actionFlag;if(OrderInfo.actionFlag==2){setTimeout(function(){$.unecOverlay();offerChange.fillOfferChange(N,M)},800)}else{$.unecOverlay();y(N,M)}}})};var y=function(N,M){SoOrder.initFillPage();$("#order_prepare").hide();var O=$("#order").html(N.data).show();$.refresh(O);z();l(M);if(M.actionFlag==""){OrderInfo.actionFlag=1}if(OrderInfo.actionFlag==6){if(order.memberChange.newMemberFlag){f(M)}if(order.memberChange.oldMemberFlag){_initAcct(1);G(M)}if(order.memberChange.changeMemberFlag){order.memberChange.fillmemberChange(N,M)}}else{f(M)}order.phoneNumber.initOffer("-1");$("#fillNextStep").off("click").on("click",function(){if(!SoOrder.checkData()){return false}$("#order-content").hide();$("#order-dealer").show();order.dealer.initDealer();var V=OrderInfo.codeInfos.DevelopmentCode;var W=OrderInfo.provinceInfo.reloadFlag;if(V!=null&&V!=""&&V!="null"&&W=="Y"&&(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2)){$("#staffCode").val(V);order.dealer.queryStaff(0,"dealer",OrderInfo.codeInfos.developmentObjId)}});if(M.memberChange){$("#orderedprod").hide();$("#order_prepare").hide();$("#productDiv .pdcardcon:first").show();order.prepare.step(1);$("#fillLastStep").off("click").on("click",function(){order.prodModify.cancel()})}else{$("#fillLastStep").off("click").on("click",function(){s()})}o();if(OrderInfo.acct&&OrderInfo.acct.acctCd!=null&&OrderInfo.acct.acctCd!=""){A()}if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""){var M={phoneNum:"",prodId:""};M.phoneNum=OrderInfo.newOrderNumInfo.mainPhoneNum;M.prodId="-1";var U=order.phoneNumber.queryPhoneNumber(M);if(U==undefined||U.datamap==undefined||U.datamap.baseInfo==undefined){$("#nbr_btn_-1").val("");$("#phonenum_btn_-1").removeAttr("onclick")}else{if(U&&U.datamap.baseInfo!=undefined){var R={prodId:M.prodId,accessNumber:U.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:U.datamap.baseInfo.phoneNumId,pnLevelId:U.datamap.baseInfo.phoneLevelId,anTypeCd:U.datamap.baseInfo.pnTypeId,state:"ADD",areaId:U.datamap.baseInfo.areaId,areaCode:U.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:U.datamap.baseInfo.prePrice,minCharge:U.datamap.baseInfo.pnPrice,idFlag:"1"};if(M.prodId&&M.prodId=="-1"){R.memberRoleCd=CONST.MEMBER_ROLE_CD.MAIN_CARD}$("#nbr_btn_-1").val(OrderInfo.newOrderNumInfo.mainPhoneNum);$("#phonenum_btn_-1").removeAttr("onclick");OrderInfo.boProdAns.push(R)}}}if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""){var M={phoneNum:"",prodId:""};var T=$("input[id^='nbr_btn_']");var Q=OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");var L=[];$.each(T,function(){if($(this).attr("id")!="nbr_btn_-1"){L.push(this)}});$.each(L,function(V,Y){M.phoneNum=Q[V];M.prodId=-2-V;var W=order.phoneNumber.queryPhoneNumber(M);if(W==undefined||W.datamap==undefined||W.datamap.baseInfo==undefined){$(Y).val("");$("#phonenum_btn_"+prodId).removeAttr("onclick")}else{if(W&&W.datamap.baseInfo!=undefined){var X={prodId:M.prodId,accessNumber:W.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:W.datamap.baseInfo.phoneNumId,pnLevelId:W.datamap.baseInfo.phoneLevelId,anTypeCd:W.datamap.baseInfo.pnTypeId,state:"ADD",areaId:W.datamap.baseInfo.areaId,areaCode:W.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:W.datamap.baseInfo.prePrice,minCharge:W.datamap.baseInfo.pnPrice,idFlag:"1"};if(M.prodId&&M.prodId!="-1"){X.memberRoleCd=CONST.MEMBER_ROLE_CD.VICE_CARD}$(Y).val(Q[V]);$("#phonenum_btn_"+prodId).removeAttr("onclick");OrderInfo.boProdAns.push(X)}}})}if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){var S=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;
$.each(S,function(){var ah=this.busiObj.offerTypeCd;if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){var ag=this.busiObj.instId;var ac=this.busiObj.accessNumber;var an=this.data.bo2Coupons[0].terminalCode;var ad=this.data.boProdFeeTypes[0].feeType;var am=this.data.boProdPasswords[0].prodPwTypeCd;var Y=this.data.boProdPasswords[0].pwd;var ae="20";if(this.data.boProdItems&&this.data.boProdItems[0].itemSpecId){var al=this.data.boProdItems[0].itemSpecId;if(al=="40010030"){ae=this.data.boProdItems[0].value}var ak={};ak.itemSpecId=al;ak.prodId=ag;ak.isCheckMask=ae;OrderInfo.reloadProdInfo.checkMaskList.push(ak);$("#"+al+"_"+ag+"").find("option[value='"+ae+"']").attr("selected","selected")}$("#nbr_btn_"+ag).val(ac);var ai={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};OrderInfo.boProdAns.push(ai);OrderInfo.reloadProdInfo.feeType=ad;$("#idtype").find("option[value='"+ad+"']").attr("selected","selected");$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).removeClass("disabled");$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);var aa={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};OrderInfo.clearProdUim(this.busiObj.instId);OrderInfo.boProd2Tds.push(aa)}var V="";var aj="";var ab="";var ag="";if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){V=this.busiObj.objId;aj=this.busiObj.accessNumber;ab=this.busiObj.objName;ag=this.data.ooRoles[0].prodId}if(this.data.busiOrderAttrs!=undefined){var Z={};var X={};var W={};$.each(this.data.busiOrderAttrs,function(){if(this.role=="40020005"){Z.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){Z.staffid=this.value;Z.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){Z.staffname=this.value}}Z.objInstId=V;Z.accessNumber=aj;Z.objName=ab;Z.prodId=ag;Z.offerTypeCd=ah}else{if(this.role=="40020006"){X.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){X.staffid=this.value;X.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){X.staffname=this.value}}X.objInstId=V;X.accessNumber=aj;X.objName=ab;X.prodId=ag;X.offerTypeCd=ah}else{if(this.role=="40020007"){W.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){W.staffid=this.value;W.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){W.staffname=this.value}}W.objInstId=V;W.accessNumber=aj;W.objName=ab;W.prodId=ag;W.offerTypeCd=ah}}}});if(ec.util.isObj(Z.role)){OrderInfo.reloadProdInfo.dealerlist.push(Z)}if(ec.util.isObj(X.role)){OrderInfo.reloadProdInfo.dealerlist.push(X)}if(ec.util.isObj(W.role)){OrderInfo.reloadProdInfo.dealerlist.push(W)}}if(this.data.boAccountRelas!=undefined){var af=this.data.boAccountRelas[0].acctId;$("#acctSelect").find("option[value="+af+"]").attr("selected","selected")}});order.main.newProdReload();var P=OrderInfo.reloadOrderInfo.orderList.orderListInfo.custOrderAttrs;$.each(P,function(){if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){OrderInfo.reloadProdInfo.orderMark=this.value}})}};var u=function(){var L=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;$.each(L,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){var N=this;$.each(AttachOffer.openList,function(){if(this.prodId==N.data.ooRoles[0].prodId){var P=false;$.each(this.specList,function(){if(this.offerSpecId==N.busiObj.objId){P=true;return false}});if(!P){g(this.prodId,N.busiObj.objId);if(N.data.bo2Coupons!=undefined){for(var S=0;S<N.data.bo2Coupons.length;S++){var R=N.data.bo2Coupons[S];if(S==0){$("#terminalText_"+R.prodId+"_"+R.attachSepcId+"_"+R.num).val(R.couponInstanceNumber);AttachOffer.checkTerminalCode($("#terminalBtn_"+R.prodId+"_"+R.attachSepcId+"_"+R.num))}else{AttachOffer.addAndDelTerminal($("#terminalAddBtn_"+R.prodId+"_"+R.attachSepcId));$("#terminalText_"+R.prodId+"_"+R.attachSepcId+"_"+R.num).val(R.couponInstanceNumber);AttachOffer.checkTerminalCode($("#terminalBtn_"+R.prodId+"_"+R.attachSepcId+"_"+R.num))}var Q={couponUsageTypeCd:R.couponUsageTypeCd,inOutTypeId:R.inOutTypeId,inOutReasonId:R.inOutReasonId,saleId:R.saleId,couponId:R.couponId,couponinfoStatusCd:R.couponinfoStatusCd,chargeItemCd:R.chargeItemCd,couponNum:R.couponNum,storeId:R.storeId,storeName:R.storeName,agentId:R.agentId,apCharge:R.apCharge,couponInstanceNumber:R.couponInstanceNumber,ruleId:R.ruleId,partyId:R.partyId,prodId:R.prodId,offerId:R.offerId,attachSepcId:R.attachSepcId,state:R.state,relaSeq:R.relaSeq,num:R.num};OrderInfo.attach2Coupons.push(Q)}}}}});if(N.data.ooRoles[0].prodId>0){AttachOffer.addOfferSpecReload(N.data.ooRoles[0].prodId,N.busiObj.objId)}}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){var N=this;var M=false;$.each(AttachOffer.openServList,function(){if(this.prodId==N.data.boServOrders[0].servId){$.each(this.servSpecList,function(){if(this.servSpecId==N.data.boServOrders[0].servSpecId){M=true;return false}})}});if(!M){var O="N";if(N.data.boServItems!=undefined){O="Y"}AttachOffer.openServSpecReload(this.busiObj.instId,N.data.boServOrders[0].servSpecId,N.data.boServOrders[0].servSpecName,O)}if(N.busiObj.instId>0){var O="N";if(N.data.boServItems!=undefined){O="Y"}AttachOffer.openServSpecReload(N.busiObj.instId,N.data.boServOrders[0].servSpecId,N.data.boServOrders[0].servSpecName,O)}}}});$.each(AttachOffer.openList,function(){var M=this;$.each(this.specList,function(){var O=this;var N=false;$.each(L,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){if(this.busiObj.objId==O.offerSpecId){N=true;return false}}});if(!N){AttachOffer.delOfferSpecReload(M.prodId,this.offerSpecId)}})});$.each(AttachOffer.openServList,function(){var M=this;$.each(this.servSpecList,function(){var O=this;var N=false;$.each(L,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(O.servSpecId==this.data.boServOrders[0].servSpecId&&M.prodId==this.busiObj.instId){N=true;return false}}});if(!N){AttachOffer.closeServSpecReload(M.prodId,this.servSpecId,this.servSpecName,this.ifParams)}})})};var g=function(O,P,M){var L=n(O,P);if(L==undefined){return}var N=CacheData.getOfferProdStr(O,L,0);v(O,L);x(O,L)};var n=function(M,N){var L=CacheData.getOfferSpec(M,N);if(L==undefined){L=query.offer.queryAttachOfferSpec(M,N);if(!L){return}CacheData.setOfferSpec(M,L)}return L};var v=function(M,N,L){if(N!=undefined){$.each(N.offerRoles,function(){$.each(this.roleObjs,function(){var O=M+"_"+this.objId;
$(L).each(function(Q,R){var P=R.prodId+"_"+R.objId;if(O==P){this.selQty=1;return false}else{this.selQty=2}})})})}};var x=function(M,O){var P=O.offerSpecId;var N=CacheData.getExcDepOfferParam(M,P);var L=query.offer.queryExcludeDepend(N);if(L!=undefined){h(L.result,M,P,O.offerSpecName)}};var h=function(aa,T,Y,M){var U="";var Q={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(aa!=""){var O=aa.offerSpec.exclude;var N=aa.offerSpec.depend;var W=aa.offerSpec.defaultList;if(ec.util.isArray(O)){for(var S=0;S<O.length;S++){var Z=CacheData.getOfferList(T);var V=true;if(Z!=undefined){for(var R=0;R<Z.length;R++){if(Z[R].isdel=="Y"){if(Z[R].offerSpecId==O[S].offerSpecId){V=false;break}}}}if(V){U+="需要关闭：   "+O[S].offerSpecName+"<br>";Q.excludeOffer.push(O[S].offerSpecId)}}}if(N!=undefined&&ec.util.isArray(N.offerInfos)){for(var S=0;S<N.offerInfos.length;S++){U+="需要开通： "+N.offerInfos[S].offerSpecName+"<br>";Q.dependOffer.dependOffers.push(N.offerInfos[S].offerSpecId)}}if(N!=undefined&&ec.util.isArray(N.offerGrpInfos)){for(var S=0;S<N.offerGrpInfos.length;S++){var L=N.offerGrpInfos[S];Q.dependOffer.offerGrpInfos.push(L);U+="需要开通： 开通"+L.minQty+"-"+L.maxQty+"个以下业务:<br>";if(L.subOfferSpecInfos!="undefined"&&L.subOfferSpecInfos.length>0){for(var R=0;R<L.subOfferSpecInfos.length;R++){var X=L.subOfferSpecInfos[R];var P=CacheData.getOfferSpec(T,X.offerSpecId);if(ec.util.isObj(P)){if(P.isdel!="Y"&&P.isdel!="C"){U+='<input id="'+X.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+L.grpId+'" value="'+X.offerSpecId+'">'+X.offerSpecName+"</input><br>"}else{U+='<input id="'+X.offerSpecId+'" checked="checked" type="checkbox" name="'+L.grpId+'" value="'+X.offerSpecId+'">'+X.offerSpecName+"</input><br>"}}else{var P=CacheData.getOfferBySpecId(T,X.offerSpecId);if(ec.util.isObj(P)){if(P.isdel!="Y"&&P.isdel!="C"){U+='<input id="'+X.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+L.grpId+'" value="'+X.offerSpecId+'">'+X.offerSpecName+"</input><br>"}else{U+='<input id="'+X.offerSpecId+'" checked="checked" type="checkbox" name="'+L.grpId+'" value="'+X.offerSpecId+'">'+X.offerSpecName+"</input><br>"}}else{U+='<input id="'+X.offerSpecId+'" checked="checked" type="checkbox" name="'+L.grpId+'" value="'+X.offerSpecId+'">'+X.offerSpecName+"</input><br>"}}}}}}if(ec.util.isArray(W)){for(var S=0;S<W.length;S++){U+="需要开通： "+W[S].offerSpecName+"<br>";Q.defaultOffer.push(W[S].offerSpecId)}}}AttachOffer.addOpenList(T,Y)};var z=function(){touch.on(".item","touchstart",function(L){});$(".item").each(function(L){touch.on(this,"swiperight",function(M){$("#carousel-example-generic").carousel("prev")});touch.on(this,"swipeleft",function(M){$("#carousel-example-generic").carousel("next")})})};var o=function(){var V=OrderInfo.newOrderNumInfo.codeMsg;if(V!=null&&V!=""){$.alert("提示",V)}else{var U=OrderInfo.newOrderNumInfo.mktResInstCode;if(OrderInfo.newOrderNumInfo.mktResInstCode&&U!=null&&U!=""&&U!="null"){var T=U.split(",");if(T!=null&&T.length>0){for(var R=0;R<=T.length;R++){var O=T[R];if(O!=null&&O!=""){var L=O.split("_");if(L!=null&&L.length==2){var S=L[0];var N=L[1];var Q={instCode:N};var P=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",Q);if(P.code==0){if(P.data&&P.data.mktResBaseInfo){if(P.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_"+S).attr("disabled",true);$("#uim_check_btn_"+S).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+S).attr("disabled",false);$("#uim_release_btn_"+S).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+S).val(N);var M={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:P.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:P.data.mktResBaseInfo.qty,storeId:P.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:P.data.mktResBaseInfo.instCode,terminalCode:P.data.mktResBaseInfo.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:S,offerId:"-1",state:"ADD",relaSeq:""};OrderInfo.clearProdUim(S);OrderInfo.boProd2Tds.push(M)}else{$.alert("提示","UIM卡["+N+"]不是预占状态，当前为"+P.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","没有查询到相应的UIM卡["+N+"]信息")}}else{if(P.code==-2){$.alert(P.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}}}}};var A=function(){var L;L={acctCd:OrderInfo.acct.acctCd,isServiceOpen:"Y"};L.areaId=OrderInfo.getAreaId();$.callServiceAsJson(contextPath+"/order/account",L,{before:function(){},always:function(){},done:function(M){if(M.code==-2){$.alertM(M.data);return}if(M.code==0){var N=M.data;if(N.resultCode==0){if(N.accountInfos&&N.accountInfos.length>0){$.each(N.accountInfos,function(O,P){if(P.acctId!=null&&P.acctId!=""){OrderInfo.acct={acctId:P.acctId,acctcd:P.accountNumber,name:P.name};return false}})}else{$.alert("提示","没有查询到帐户合同号对应的帐户信息")}}else{$.alertM(N.resultMsg)}}else{$.alertM(M.data)}}})};var G=function(O){for(var L=0;L<OrderInfo.oldprodInstInfos.length;L++){var M=OrderInfo.oldprodInstInfos[L];$.each(OrderInfo.oldoffer,function(){if(this.accNbr==M.accNbr){var P=this;$.each(P.offerMemberInfos,function(){var U=this;if(U.objType==CONST.OBJ_TYPE.PROD){var S=this.objInstId;var T={areaId:OrderInfo.getProdAreaId(S),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:S,prodSpecId:U.objId,offerSpecId:M.mainProdOfferInstInfos[0].prodOfferId,offerRoleId:"",acctNbr:U.accessNumber,partyId:M.custId,distributorId:OrderInfo.staff.distributorId,mainOfferSpecId:M.mainProdOfferInstInfos[0].prodOfferId,soNbr:OrderInfo.order.soNbr};if(ec.util.isObj(M.prodBigClass)){T.prodBigClass=M.prodBigClass}$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==M.accNbr){$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){T.offerRoleId=this.offerRoleId}})}});var Q=query.offer.queryChangeAttachOfferSub(T);$("#attach_"+S).html(Q);if(ec.util.isObj(U.objId)&&ec.util.isObj(U.objType)&&ec.util.isObj(U.offerRoleId)){T.queryType="1,2";T.objId=U.objId;T.objType=U.objType;T.memberRoleCd="401";var R=query.offer.queryDefMustOfferSpec(T);CacheData.parseOffer(R);var R=query.offer.queryServSpec(T);CacheData.parseServ(R)}if(ec.util.isArray(OrderInfo.oldofferSpec)){$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==M.accNbr){var V=this.offerSpec.offerRoles;$.each(V,function(){if(this.offerRoleId==U.offerRoleId&&U.objType==CONST.OBJ_TYPE.PROD){var W=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var Y=CacheData.getServBySpecId(S,this.objId);if(Y!=undefined){var X=$("#li_"+S+"_"+Y.servId);if(this.minQty==1){X.append('<dd class="mustchoose"></dd>')}X.append('<dd id="jue_'+S+"_"+Y.servId+'" class="jue2" title="'+W.offerRoleName+'"></dd>')}}});return false}})}})}AttachOffer.changeLabel(S,M.productId,"")}})}});var N={};if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){if(this.accNbr==M.accNbr){N=this}})}if(order.prodModify.choosedProdInfo.is3G=="N"&&M.mainProdOfferInstInfos[0].is3G=="Y"){if(!order.memberChange.checkOrder(M,N)){return}order.memberChange.checkOfferProd(N)}}};var f=function(L){$.each(OrderInfo.offerSpec.offerRoles,function(){var O=this;for(var M=0;M<this.prodInsts.length;M++){var N=this.prodInsts[M];var Q={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:N.objId,offerRoleId:N.offerRoleId,prodId:N.prodInstId,queryType:"1,2",objType:N.objType,objId:N.objId,memberRoleCd:N.memberRoleCd};AttachOffer.queryAttachOfferSpec(Q);var P={div_id:"item_order_"+N.prodInstId,prodId:N.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:N.objId,roleCd:O.roleCd,offerRoleId:O.offerRoleId,partyId:OrderInfo.cust.custId};order.main.spec_parm(P)}});if(order.service.oldMemberFlag){order.main.loadAttachOffer()}};var a=function(L){$(".paymethodChange").each(function(){if($(this).attr("id")!=$(L).attr("id")){$(this).val($(L).val())}})};var K=function(N){if($("#isTemplateOrder").attr("checked")=="checked"){var M=$('select[name="pay_type_-1"]').val();
if(N&&$(N).val()){if($(N).val()=="0"&&M!="2100"){$.alert("提示","您选择批开活卡模板，付费方式需改成'预付费'！");$("html").scrollTop(0);return false}}else{var L=$("#templateOrderDiv select").val();if(L){if(L=="0"&&M!="2100"){$.alert("提示","您选择批开活卡模板，付费方式需改成预付费！");$("html").scrollTop(0);return false}}}}return true};var l=function(L){if(L.feeType!=undefined&&L.feeType&&L.feeType!=CONST.PAY_TYPE.NOLIMIT_PAY){$("input[name^=pay_type_][value="+L.feeType+"]").attr("checked","checked");$("input[name^=pay_type_]").attr("disabled","disabled")}};var j=function(L){$("#acctListTab tbody").empty();$.each(L,function(M,O){var N=$("<tr></tr>").appendTo($("#acctListTab tbody"));if(O.name){$("<td class='teleNum'>"+O.name+"</td>").appendTo(N)}else{$("<td></td>").appendTo(N)}if(O.acctId){$("<td acctId='"+O.acctId+"'>"+O.accountNumber+"</td>").appendTo(N)}else{$("<td></td>").appendTo(N)}if(O.owner){$("<td>"+O.owner+"</td>").appendTo(N)}else{$("<td></td>").appendTo(N)}if(O.accessNumber){$("<td>"+O.accessNumber+"</td>").appendTo(N)}else{$("<td></td>").appendTo(N)}N.click(function(){var Q=false;var P=$("#acctSelect").find("option");$.each(P,function(S,R){if(R.value==O.acctId){$("#acctSelect").find("option[value="+R.value+"]").attr("selected","selected");Q=true;return false}});$(this).dispatchJEvent("chooseAcct",O);easyDialog.close();$("#defineNewAcct").hide()})})};function p(L){$.callServiceAsHtmlGet(contextPath+"/token/app/order/orderSpecParam",L,{done:function(M){if(M&&M.code==-2){return}else{if(M&&(M.data==0||M.data=="0")){return}}$("#"+L.div_id).append(M.data);$.refresh($(this));$("#choose_user_btn_"+L.prodId).parent().parent().parent().hide();var O=$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+L.prodId);if(O.length==1){if(OrderInfo.actionFlag!=1&&OrderInfo.actionFlag!=14){$(O).attr("disabled","disabled")}else{$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+L.prodId+" option[value=' ']").remove();$(O).val("20");if(OrderInfo.offerSpec.feeType==CONST.PAY_TYPE.BEFORE_PAY){$(O).attr("disabled","disabled")}}$(O).addClass("styled-select")}if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){$.each(OrderInfo.reloadProdInfo.checkMaskList,function(){$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+this.prodId+"").find("option[value='"+this.isCheckMask+"']").attr("selected","selected")});var N=$("select[name='pay_type_-1']").find("option:selected").val();if(N=="2100"){order.main.feeTypeCascadeChange($("select[name='pay_type_-1']"),"-1")}}},fail:function(M){$.unecOverlay()}})}function E(){if(!i("order_spc_update")){return}var M=new Array();var N=0;$("#order_spc_update input").each(function(){if($(this).attr("id")!="order_remark"&&$(this).attr("id")!="isTemplateOrder"&&$(this).attr("id")!="templateOrderName"&&$(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var R={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};M.push(R);N++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var Q={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};M.push(Q);N++}if($(this).val()!=null&&$(this).val()!=""){var P={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};M.push(P);N++}}}}}});$("#order_spc_update select").each(function(){if($(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var R={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};M.push(R);N++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var Q={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};M.push(Q);N++}if($(this).val()!=null&&$(this).val()!=""){var P={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};M.push(P);N++}}}}}});var L;if($("#order_remark").val()){L=[{atomActionId:OrderInfo.SEQ.atomActionSeq--,itemSpecId:CONST.ITEM_SPEC_ID_CODE.busiOrderAttrs,value:$("#order_remark").val()}];N++}if(N<1){$.alert("提示","您未修改订单属性");return}var O={boProdItems:M};if(L){O.busiOrderAttrs=L}OrderInfo.actionFlag=33;SoOrder.submitOrder(O)}function i(M){var L=true;$("#"+M).find("input").each(function(){if(L){L=t(this)}});return L}function t(P){if($(P).attr("check_option")=="N"){if($(P).val()==null||$(P).val()==""){$.alert("提示",$(P).attr("check_name")+" 尚未填写");return false}}if($(P).attr("check_type")=="check"){var L=$(P).attr("check_len");if(L>0){if($(P).val().length>L){$.alert("提示",$(P).attr("check_name")+" 长度过长(<"+L+")");return false}}var M=$(P).attr("check_mask");if(M!=null&&$(P).val()!=null&&$(P).val()!=""){var O=new RegExp(M);if(!O.test($(P).val())){$.alert("提示",$(P).attr("check_name")+" 校验失败："+$(P).attr("check_mess"));return false}}var N=$(P).val().length;if(N>0&&$(P).attr("dataType")=="3"){if(!/^[0-9]+$/.test($(P).val())){$.alert("提示",$(P).attr("check_name")+" 非数字，请修改");return false}}else{if(N>0&&$(P).attr("dataType")=="5"){if(!/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test($(P).val())){$.alert("提示",$(P).attr("check_name")+" 非小数，请修改");return false}}else{if(N>0&&($(P).attr("dataType")=="4"||$(P).attr("dataType")=="16")){}}}}return true}var w=function(L){if(L&&L.page){m(L.page,L.scroll)}};var D=function(M,L){$.callServiceAsHtmlGet(contextPath+"/pad/staffMgr/getStaffListPrepare",{dealerId:M,objInstId:L},{done:function(O){var N=$.popup("#div_staff_dialog",O.data,{cache:true,width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){}});$("#btn_staff_select_chk").off("tap").on("tap",function(){I(L)});$("#a_order_staff_qry").off("tap").on("tap",function(){m(1)})}})};var m=function(M,L){var N={dealerId:$("#dealer_id").val(),qrySalesCode:$("#qrySalesCode").val(),staffName:$("#qryStaffName").val(),staffCode:$("#qryStaffCode").val(),staffCode2:$("#qryStaffCode").val(),salesCode:$("#qrySalesCode").val(),pageIndex:M,objInstId:$("#objInstId").val(),pageSize:10};$.callServiceAsHtml(contextPath+"/pad/staffMgr/getStaffList",N,{before:function(){if(M==1){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}},always:function(){if(M==1){$.unecOverlay()}},done:function(O){var P="";if(!O){P=""}else{P=O.data}var Q=$("#div_order_dealer_list");if(M==1){Q.html(P)}else{Q.find("tbody").append(P)}Q.find("tr").each(function(){$(this).off("tap").on("tap",function(R){$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg")})});if(L&&$.isFunction(L)){L.apply(this,[])}}})};var I=function(M){var L=$("#div_order_dealer_list tr.userorderlistlibg");L.each(function(){$("#dealer_"+M).val($(this).attr("staffName")).attr("staffId",$(this).attr("staffId"))});if(L.length>0){$("#div_staff_dialog").popup("close")}else{$.alert("提示","请先选择协销人！")}};var C=function(){$("#acctDialog .contract_list td").text("帐户查询");$("#acctDialog .selectList").show();easyDialog.open({container:"acctDialog"});$("#acctPageDiv").show();var L="chooseAcct";var M=$("#acctSelect");if(!M.hasJEventListener(L)){M.addJEventListener(L,function(O){var N=false;$.each(M.find("option"),function(P,Q){if($(Q).val()==O.acctId){N=true;return false}});if(N==false){$("<option>").text(O.name+" : "+O.accountNumber).attr("value",O.acctId).attr("acctcd",O.accountNumber).appendTo(M)}M.find("option[value="+O.acctId+"]").attr("selected","selected");if(O.acctId>0){$("#account").find("a:eq(1)").show()}})}$("#acctListTab tbody").empty();$("#acctPageDiv").empty()};var B=function(){$("#acctSelect").append("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>");$("#acctSelect").find("option[value='-1']").attr("selected","selected");
$("#acctName").val(OrderInfo.cust.partyName);$("#defineNewAcct").show();$("#account").find("a:gt(0)").hide();window.setTimeout("order.main.showNewAcct()",0)};var c=function(){acct.acctModify.ifCanAdjustBankPayment();acct.acctModify.getBILL_POST(function(){acct.acctModify.paymentType();acct.acctModify.billPostType()})};var r=function(){var M=$("#acctSelect");if(!M.val()){$.alert("提示","请选择一个帐户");return}if(M.val()==-1){$.alert("提示","该帐户是新建帐户");return}$("#acctDialog .contract_list td").text("帐户信息");$("#acctDialog .selectList").hide();$("#acctPageDiv").hide();$("#acctListTab tbody").empty();easyDialog.open({container:"acctDialog"});var L={acctCd:M.find("option:selected").attr("acctcd"),isServiceOpen:"Y"};$.callServiceAsJson(contextPath+"/order/account",L,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(N){if(N.code==-2){$.alertM(N.data);return}if(N.code==0){j(N.data.accountInfos)}else{$("<tr><td colspan=4>"+N.data+"</td</tr>").appendTo($("#acctListTab tbody"))}$("#acctListTab tr").off("click")}})};var s=function(L){$.confirm("信息","确定回到上一步吗？",{yes:function(){var N=OrderInfo.boProdAns;var M=OrderInfo.boProd2Tds;if(M.length>0){for(var P=0;P<M.length;P++){var O={numType:2,numValue:M[P].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",O,{done:function(){}})}}if(N.length>0){for(var P=0;P<N.length;P++){if(N[P].idFlag){continue}var O={numType:1,numValue:N[P].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",O)}}order.phoneNumber.resetBoProdAn();$("#order_prepare").show();$("#order").hide();if(typeof(L)=="function"){L()}},no:function(){}},"question")};var e=function(){return{boActionTypeCd:S1,boActionTypeName:"订购",offerSpecId:1234,offerSpecName:"乐享3G-129套餐",feeType:1200,viceCardNum:3,offerNum:3,type:1,terminalInfo:{terminalName:"IPhone5",terminalCode:"46456457345"},offerRoles:[{offerRoleId:1234,offerRoleName:"主卡",memberRoleCd:"0",roleObjs:[{offerRoleId:1,objId:CONST.PROD_SPEC.CDMA,objName:"CDMA",objType:2}]},{offerRoleId:2345,offerRoleName:"副卡",memberRoleCd:"1"}]}};var F=function(M){var L=J();$("#"+M).val(L)};var J=function(){var P="";var O="";var N="";var M=0;for(var L=0;L<6;L++){do{if(P.length>0){O=P.substring(P.length-1,P.length)}M=parseInt(Math.random()*9+1);N=""+M;if(P.length==5){if(d(P+N)){continue}}}while(O==N);P=P+N}if(P.length!=6){return null}return P};var d=function(O){var L=0;if(O&&O.length==6){for(var M=0;M<5;M++){var P=parseInt(O.substring(M,M+1));var N=parseInt(O.substring(M+1,M+2));L=L+(P-N)}if(L==5||L==-5){return true}else{return false}}else{return false}};var q=function(N,L){var M=$("#"+N).val();return H(M,L)};var H=function(P,M){var O="<div style='text-indent:0px;'>密码设置规则：<br/>1、密码必须为六位全数字；<br/>2、密码不能与接入号中的信息重复；<br/>3、密码不能包含连续相同的数字；<br/>4、密码不能是连续的六位数字。</div>";var N=new RegExp("^([0-9]{6})$");if(P==null){$.alertMore("提示","","密码不可为空！",O,"");return false}else{if(!N.test(P)){$.alertMore("提示","","密码包含非数字或长度不是6位",O,"");return false}}if(M!=null&&M.indexOf(P)>=0){$.alertMore("提示","","密码不能与接入号中的信息重复，请修改！",O,"");return false}for(var L=0;L<5;L++){lastOneS=P.substring(L,L+1);thisOneS=P.substring(L+1,L+2);if(lastOneS==thisOneS){$.alertMore("提示","","密码中包含连续相同数字，请修改！",O,"");return false}}if(d(P)){$.alertMore("提示","","密码不可是连续6位数字，请修改！",O,"");return false}return true};var b=function(O,M){var L=$(O).val();var N=$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+M);if(L==CONST.PAY_TYPE.BEFORE_PAY){$(N).val("20");$(N).attr("disabled",true)}else{$(N).attr("disabled",false)}$(N).addClass("styled-select")};return{buildMainView:k,feeTypeCascadeChange:b,initTounch:z,spec_parm:p,check_parm:i,queryScroll:w,queryStaff:D,queryStaffPage:m,setStaff:I,chooseAcct:C,check_parm_self:t,createAcct:B,createAcctWithId:A,showNewAcct:c,acctDetail:r,spec_parm_change_save:E,paymethodChange:a,templateTypeCheck:K,lastStep:s,genRandPass6:J,genRandPass6Input:F,passwordCheckInput:q,passwordCheckVal:H,checkIncreace6:d,newProdReload:u,loadAttachOffer:G}})();CommonUtils.regNamespace("query","offer");query.offer=(function(){var z=function(F,E){F.areaId=OrderInfo.cust.areaId;var D=contextPath+"/app/offer/queryOfferSpec";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,F,{before:function(){$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>")},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data.offerSpec)}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");var C=$.callServiceAsJsonGet(D,F);$.unecOverlay();if(C.code==0){if(C.data){return C.data.offerSpec}}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}};var t=function(F,E){var D=contextPath+"/app/offer/queryOfferInst";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,F,{before:function(){$("#attach-modal").modal("show")},done:function(G){$("#attach-modal").modal("hide");if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");var C=$.callServiceAsJsonGet(D,F);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}};var u=function(G){var C=order.prodModify.choosedProdInfo;var H={offerId:C.prodOfferInstId,offerSpecId:C.prodOfferId,acctNbr:C.accNbr,areaId:C.areaId,distributorId:""};if(typeof(G)=="function"){query.offer.queryOfferInst(H,function(L){if(L&&L.code==CONST.CODE.SUCC_CODE){var J=true;if(ec.util.isArray(L.offerMemberInfos)){CacheData.sortOffer(L);for(var K=0;K<L.offerMemberInfos.length;K++){var M=L.offerMemberInfos[K];if(M.objType==""){$.alert("提示","销售品实例构成 "+M.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(M.objType==CONST.OBJ_TYPE.PROD){if(M.accessNumber==""){$.alert("提示","销售品实例构成 "+M.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(M.objInstId==C.prodInstId){J=false}}if(J){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+C.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=L.offerMemberInfos;OrderInfo.offer.offerId=C.prodOfferInstId;OrderInfo.offer.offerSpecId=C.prodOfferId;OrderInfo.offer.offerSpecName=C.prodOfferName;G()}else{$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");return false}}})}else{var F=query.offer.queryOfferInst(H);if(F&&F.code==CONST.CODE.SUCC_CODE){var D=true;if(ec.util.isArray(F.offerMemberInfos)){CacheData.sortOffer(F);for(var E=0;E<F.offerMemberInfos.length;E++){var I=F.offerMemberInfos[E];if(I.objType==""){$.alert("提示","销售品实例构成 "+I.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(I.objType==CONST.OBJ_TYPE.PROD){if(I.accessNumber==""){$.alert("提示","销售品实例构成 "+I.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(I.objInstId==C.prodInstId){D=false}}if(D){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+C.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=F.offerMemberInfos;OrderInfo.offer.offerId=C.prodOfferInstId;OrderInfo.offer.offerSpecId=C.prodOfferId;OrderInfo.offer.offerSpecName=C.prodOfferName;return true}else{$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");return false}}}};var j=function(F,E){var D=contextPath+"/app/offer/queryOfferParam";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,F,{before:function(){$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}})}else{$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,F);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}};var v=function(F,E){h(F);F.isServiceOpen="Y";var D=contextPath+"/token/app/offer/queryAttachOffer";if(OrderInfo.actionFlag==22){D=contextPath+"/app/offer/queryAttachOffer2"}if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")
},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}};var a=function(E){h(E);var D=contextPath+"/app/offer/queryOpenedAttachAndServ";$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(E)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var B=function(F,E){h(F);F.isServiceOpen="Y";var D=contextPath+"/app/offer/queryChangeAttachOffer";if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品实例失败,稍后重试");return}}};var l=function(F,E){h(F);F.isServiceOpen="Y";var D=contextPath+"/token/app/offer/queryChangeAttachOfferSub";if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍候....</strong>")},always:function(){$.unecOverlay()},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品实例失败,稍后重试");return}}};var w=function(F,E){h(F);F.isServiceOpen="Y";var D=contextPath+"/app/offer/queryAttachSpec";if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍候....</strong>")},always:function(){$.unecOverlay()},done:function(G){if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var q=function(F,E){h(F);var D=contextPath+"/app/offer/queryCanBuyAttachSpec";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍候....</strong>")},always:function(){$.unecOverlay()},done:function(G){if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var e=function(E){h(E);var D=contextPath+"/app/offer/queryDefaultAndRequiredOfferSpec";$.ecOverlay("<strong>查询默认必须可选包中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){OrderInfo.isSuccess="N";$.alertM(C.data);return}else{OrderInfo.isSuccess="N";$.alert("提示","可订购功能产品失败,稍后重试");return}}};var c=function(E){h(E);var D=contextPath+"//app/offer/queryDefaultAndRequiredOfferSpecAndServ";$.ecOverlay("<strong>查询默认必须可选包和功能产品中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){OrderInfo.isSuccess="Y";if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","可订购可选包和功能产品失败,稍后重试");return}}};var m=function(E){h(E);var D=contextPath+"/app/offer/queryServSpec";$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var i=function(E){h(E);var D=contextPath+"/app/offer/queryExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(E)});$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var g=function(E){h(E);var D=contextPath+"/app/offer/queryServExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(E)});$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var n=function(F,E){h(F);var D=contextPath+"/app/offer/searchAttachOfferSpec";if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:encodeURI(JSON.stringify(F),"utf-8")},{before:function(){$.ecOverlay("附属销售品查询中，请稍等...")},done:function(G){$.unecOverlay();if(G.code==0){E(G.data)}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询附属销售失败，请稍后重试！")}}},fail:function(G){$.unecOverlay();$.alert("提示","查询附属销售失败，请稍后重试！")}})}else{$.ecOverlay("<strong>附属销售品查询中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:encodeURI(JSON.stringify(F),"utf-8")});$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询附属销售失败，请稍后重试！")}}}};var f=function(E){var D=contextPath+"//app/order/checkOperate";$.ecOverlay("<strong>受理权限查询中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,"");$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","受理权限查询失败，请稍后重试！")}}};var A=function(E){var D=contextPath+"/app/order/orderSubmit";if(OrderInfo.order.token!=""){D=contextPath+"/app/order/orderSubmit?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var C=$.callServiceAsHtml(D,E);$.unecOverlay();if(!C||C.code!=0){return}return C.data};var s=function(E){var D=contextPath+"/app/order/orderSubmitComplete";if(OrderInfo.order.token!=""){D=contextPath+"/app/order/orderSubmitComplete?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(!C||C.code!=0){return}return C.data};var y=function(D){var C=query.offer.queryOfferSpec(D);if(C==undefined){return false}if(C.offerRoles==undefined){$.alert("错误提示","销售品规格构成查询: 返回的销售品规格构成结构不对！");return false}if(C.offerSpecId==undefined||C.offerSpecId==""){$.alert("错误提示","销售品规格构成查询: 销售品规格ID未返回，无法继续受理！");return false}if(C.offerRoles.length==0){$.alert("错误提示","销售品规格构成查询: 成员角色为空，无法继续受理！");return false}if(C.feeType==undefined||C.feeType==""||C.feeType=="null"){$.alert("错误提示","无付费类型，无法新装！");return false}C=SoOrder.sortOfferSpec(C);if((OrderInfo.actionFlag==6||OrderInfo.actionFlag==2||OrderInfo.actionFlag==1)&&ec.util.isArray(OrderInfo.oldprodInstInfos)){OrderInfo.oldofferSpec.push({offerSpec:C,accNbr:D.accNbr})}else{OrderInfo.offerSpec=C}return C};var r=function(F,I){var H={offerSpecId:I,partyId:OrderInfo.cust.custId,offerTypeCd:2};if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){H.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}if(OrderInfo.actionFlag==3){H.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId}if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==F){H.mainOfferSpecId=this.offerSpecId;return false}})}}var G=query.offer.queryOfferSpec(H);if(G==undefined||G.offerRoles==undefined){$.alert("提示","返回的销售品规格构成结构不对！");return false}if(G.offerSpecId==undefined||G.offerSpecId==""){$.alert("提示","销售品规格ID未返回，继续受理将出现异常！");return false}if(G.offerSpecName==undefined||G.offerSpecName==""){$.alert("提示","销售品规格名称未返回，继续受理将出现异常！");return false}var D=[];var E=OrderInfo.getProdSpecId(F);
var C=false;$.each(G.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objId==E){C=true;return false}});if(C){D.push(this);return false}});G.offerRoles=D;return G};var p=function(E){var D=contextPath+"/token/pc/order/prodModify/updateCheckByChange";$.ecOverlay("<strong>正在预校验中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{if(C.data.resultMsg){$.alert("提示","预校验失败!失败原因为："+C.data.resultMsg)}else{$.alert("提示","预校验失败! 集团营业后台未给出原因。")}}}};var o=function(){if(OrderInfo.order.soNbr==null||OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}if(CONST.getAppDesc()!=0){return true}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){return true}if(order.prodModify==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var C=order.prodModify.choosedProdInfo;if(C==undefined||C.prodInstId==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var G={areaId:OrderInfo.getProdAreaId(C.prodInstId),acctNbr:C.accNbr,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,instId:C.prodInstId,type:"2",queryType:"1,2,3,4,5",acctNbr:"",data:[]};var F=OrderInfo.provinceInfo.mergeFlag;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){var D=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.accessNumber==C.accNbr){D=false;return false}});if(D){if(F!=null&&F!=""&&F!="undefined"&&F=="1"){G.data.push({accessNbr:C.accNbr,instId:C.prodInstId});return d(G)}else{return query.offer.invokeLoadInst(G)}}else{var E=true;if(F!=null&&F!=""&&F!="undefined"&&F=="1"){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){G.data.push({accessNbr:this.accessNumber,instId:this.objInstId})}});if(G!=null){if(!d(G)){E=false;return false}}}else{$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){G.acctNbr=this.accessNumber;G.instId=this.objInstId;if(!query.offer.invokeLoadInst(G)){E=false;return false}}})}return E}}else{if(F!=null&&F!=""&&F!="undefined"&&F=="1"){G.data.push({accessNbr:C.accNbr,instId:C.prodInstId});return d(G)}else{return query.offer.invokeLoadInst(G)}}};var d=function(E){var D=contextPath+"/token/app/offer/loadInstNew";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var C=$.callServiceAsJson(D,JSON.stringify(E));$.unecOverlay();if(C.code==0){return true}else{if(C.code==-2){$.alertM(C.data);return false}else{if(C.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",C.msg)}return false}}};var h=function(D){D.staffId=OrderInfo.staff.staffId;D.channelId=OrderInfo.staff.channelId;D.areaId=OrderInfo.getProdAreaId(D.prodId);D.partyId=OrderInfo.cust.custId;if(OrderInfo.actionFlag==3){D.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId}else{if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==D.prodId){D.mainOfferSpecId=this.offerSpecId;return false}})}}else{D.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}}if(ec.util.isObj(OrderInfo.order.soNbr)){D.soNbr=OrderInfo.order.soNbr}else{D.soNbr=UUID.getDataId();OrderInfo.order.soNbr=UUID.getDataId()}if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){}}if(ec.util.isArray(OrderInfo.oldprodInstInfos)){for(var C=0;C<OrderInfo.oldprodInstInfos.length;C++){if(D.acctNbr==OrderInfo.oldprodInstInfos[C].accNbr){D.areaId=OrderInfo.oldprodInstInfos[C].areaId;D.partyId=OrderInfo.oldprodInstInfos[C].custId;D.mainOfferSpecId=OrderInfo.oldprodInstInfos[C].mainProdOfferInstInfos[0].prodOfferId}}}};var k=function(E){var D=contextPath+"/app/offer/loadInst";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){return true}else{if(C.code==-2){$.alertM(C.data);return false}else{if(C.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",C.msg)}return false}}};var x=function(E){var D=contextPath+"/app/cust/offerorderprod";$.ecOverlay("<strong>查询产品信息中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var b=function(E){var D=contextPath+"/app/order/prodInstParam";$.ecOverlay("<strong>查询产品实例属性中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};return{checkOperate:f,loadInst:o,invokeLoadInst:k,setOffer:u,searchAttachOfferSpec:n,queryOfferSpec:z,queryServSpec:m,queryOfferInst:t,queryOfferParam:j,queryAttachOfferHtml:v,queryChangeAttachOffer:B,queryCanBuyAttachSpec:q,queryExcludeDepend:i,queryServExcludeDepend:g,queryAttachSpec:w,queryMainOfferSpec:y,queryAttachOfferSpec:r,queryDefMustOfferSpec:e,queryDefMustOfferSpecAndServ:c,orderSubmit:A,orderSubmitComplete:s,updateCheckByChange:p,queryProduct:x,queryOpenedAttachAndServ:a,queryProdInstParam:b,queryChangeAttachOfferSub:l,invokeLoadInstSub:d}})();CommonUtils.regNamespace("offerChange");offerChange=(function(){var j=0;var e=[];var f=false;var o=false;var v=0;var k=function(){OrderInfo.order.step=1;OrderInfo.busitypeflag=2;OrderInfo.actionFlag=2;if(!query.offer.setOffer()){return}order.service.queryApConfig();order.service.searchPack()};var t="";var x=function(){e=[];offerChange.newMemberFlag=false;offerChange.oldMemberFlag=false;var D=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==2){D++}});var F=1;var C=0;var A=0;if(D>1){F=2}if(!u(F,C)){return}if(CONST.getAppDesc()==0){if(order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){if(!offerChange.checkOrder()){return}}if(!prod.uim.setProdUim()){return}}if(OrderInfo.actionFlag==2){var B=[];var E=[];if(order.memberChange.newSubPhoneNum!=""){B=order.memberChange.newSubPhoneNum.split(",")}if(order.memberChange.oldSubPhoneNum!=""){E=order.memberChange.oldSubPhoneNum.split(",")}var z=0;t="";$("#div_content").empty();$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd=="401"){var G=this;$.each(this.roleObjs,function(){var J=G.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){e.push(J);if(G.minQty==0){this.minQty=0;this.dfQty=0}var I=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd=="401"){I++}});z=this.maxQty<0?"不限制":this.maxQty-I;if(z<0){z=0}v=z;t+="<div class='form-group' id='memberTable'><label for='"+J+"'>副卡数量:"+this.minQty+"-"+z+"(张)</label><div class='input-group input-group-lg'><label>"+this.objName+"</label><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.subNum('"+J+"',"+this.minQty+")> - </button></span><input type='text' style='margin-top:10px;' readonly='readonly' class='form-control' id='"+J+"' value='"+B.length+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.addNum('"+J+"',"+z+",'"+G.parentOfferRoleId+"')> + </button></span> </div>";if(z>0){if(E.length==0){t+="<div class='input-group input-group-lg'><label style='width:170px;'>已有移动电话</label><span class='input-group-btn' style='width:40px'></span><input type='text' style='margin-top:10px;' class='form-control' name='oldphonenum' value=''><span class='input-group-btn'><button class='btn btn-default' type='button' onclick='offerChange.addNum("+z+',"")\';> + </button></span> </div>'}else{for(var H=0;H<E.length;H++){if(H==0){t+="<div class='input-group input-group-lg'><label style='width:170px;'>已有移动电话</label><span class='input-group-btn' style='width:40px'></span><input type='text' style='margin-top:10px;' class='form-control' name='oldphonenum' value='"+E[H]+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick='offerChange.addNum("+z+',"")\';> + </button></span> </div>'}else{offerChange.addNum(z,E[H])}}}}t+="</div>"}})}});$("#div_content").append(t);$("#vice_modal").removeClass("modal fade").addClass("modal show");
$("#btn_modal").off("click").on("click",function(){h()})}};var a=1;var m=function(z,C){var A=$("input[name='oldphonenum']");A=A.length+1;if(A>z){return}a++;if(C==""){var B="<div class='input-group input-group-lg' id='oldnum_"+a+"'><label style='width:170px;'>已有移动电话</label><span class='input-group-btn' style='width:40px'></span><input type='text' style='margin-top:10px;' class='form-control' name='oldphonenum' value='"+C+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.memberChange.delNum(\"oldnum_"+a+'")> - </button></span> </div>';$("#memberTable").append(B)}t+="<div class='input-group input-group-lg' id='oldnum_"+a+"'><label style='width:170px;'>已有移动电话</label><span class='input-group-btn' style='width:40px'></span><input type='text' style='margin-top:10px;' class='form-control' name='oldphonenum' value='"+C+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.memberChange.delNum(\"oldnum_"+a+'")> - </button></span> </div>'};function h(){OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldAddNumList=[];var A=0;var z=0;order.memberChange.viceCartNum=0;var B=[];$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd=="401"){if(this.prodInsts!=undefined){var G=this.prodInsts;for(var F=0;F<this.prodInsts.length;F++){var E='"'+this.prodInsts[F].prodInstId+'"';if(E.indexOf("-")!=-1){B.push(this.prodInsts[F])}}$.each(B,function(){var H=this.prodInstId;$.each(G,function(I){if(this.prodInstId=H){G.splice(I,1)}})})}}});$.each(e,function(){A=A+Number($("#"+this).val())});$("input[name='oldphonenum']").each(function(){var E=$.trim($(this).val());if(ec.util.isObj(E)){z++}});if(A>0){offerChange.newMemberFlag=true;order.service.setOfferSpec()}if(z>0){offerChange.oldMemberFlag=true;if(!order.memberChange.queryofferinfo()){return}}if(parseInt(A)+parseInt(order.memberChange.viceCartNum)>v){$.alert("提示","加装数量已经超过能加装的最大数量【"+v+"】!");return}var C=order.prodModify.choosedProdInfo;var D={boActionTypeCd:"S2",boActionTypeName:"套餐变更",actionFlag:"2",offerSpec:OrderInfo.offerSpec,prodId:C.prodInstId,offerMembers:OrderInfo.offer.offerMemberInfos,oldOfferSpecName:C.prodOfferName,prodClass:C.prodClass,appDesc:CONST.getAppDesc(),areaId:order.prodModify.choosedProdInfo.areaId,newnum:parseInt(A),oldnum:parseInt(z),feeTypeMain:C.feeType};if(z>0){D.oldprodInstInfos=OrderInfo.oldprodInstInfos;D.oldofferSpec=OrderInfo.oldofferSpec;D.oldoffer=OrderInfo.oldoffer}order.main.buildMainView(D);$("#vice_modal").removeClass("modal show").addClass("modal fade")}var p=function(z,E){SoOrder.initFillPage();$("#order_prepare").hide();$("#order").html(z.data).show();$("#fillNextStep").off("click").on("click",function(){if(!SoOrder.checkData()){return false}$("#order-content").hide();$("#order-dealer").show();order.dealer.initDealer();var T=OrderInfo.codeInfos.DevelopmentCode;var U=OrderInfo.provinceInfo.reloadFlag;if(T!=null&&T!=""&&T!="null"&&U=="Y"&&(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2)){$("#staffCode").val(T);order.dealer.queryStaff(0,"dealer",OrderInfo.codeInfos.developmentObjId)}});var R=order.prodModify.choosedProdInfo;$("#attach-modal").modal("show");$.each(OrderInfo.offerSpec.offerRoles,function(){var T=this;if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){var V="'"+this.prodInstId+"'";if(V.indexOf("-")==-1){var af=this.prodInstId;var Y={areaId:OrderInfo.getProdAreaId(af),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:af,prodSpecId:this.objId,offerSpecId:R.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var ag=this.accessNumber;var am=query.offer.queryChangeAttachOffer(Y);$("#attach_"+af).html(am);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){Y.queryType="1,2";Y.objId=this.objId;Y.objType=this.objType;Y.memberRoleCd=this.roleCd;Y.offerSpecId=OrderInfo.offerSpec.offerSpecId;var al=query.offer.queryDefMustOfferSpec(Y);CacheData.parseOffer(al,af);Y.queryType="1";var al=query.offer.queryServSpec(Y);CacheData.parseServ(al,af)}AttachOffer.showMainRoleProd(af);if(AttachOffer.isChangeUim(af)){if(OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""&&OrderInfo.mktResInstCode!="null"){var Z=OrderInfo.mktResInstCode.split(",");if(Z!=null&&Z.length>0){var ai="";var ac="";var aa="0";for(var aj=0;aj<Z.length;aj++){var W=Z[aj].split("_");if(W!=null&&W.length==2){var ae=W[0];var ad=W[1];if(ai!=null&&ai!=""){if(ai==ae||ac==ad){aa="1";break}}else{ai=ae;ac=ad}}}if(aa=="1"){$.alert("提示","传入的UIM参数中存在重复数据,参数为["+OrderInfo.mktResInstCode+"]")}else{var U="";for(var aj=0;aj<Z.length;aj++){var W=Z[aj].split("_");if(W!=null&&W.length==2){var ah=W[0];var ak=W[1];if(ah==ag){U=ak}}}if(U!=null&&U!=""&&U!="null"){g(U,af);$("#uim_check_btn_"+af).hide();$("#uim_release_btn_"+af).hide()}}}}j++;$("#uimDiv_"+af).show()}}else{var X=this;var Y={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:X.objId,offerRoleId:X.offerRoleId,prodId:X.prodInstId,queryType:"1,2",objType:X.objType,objId:X.objId,memberRoleCd:X.memberRoleCd};AttachOffer.queryAttachOfferSpec(Y);var ab={div_id:"item_order_"+X.prodInstId,prodId:X.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:X.objId,roleCd:T.roleCd,offerRoleId:T.offerRoleId,partyId:OrderInfo.cust.custId};order.main.spec_parm(ab)}})}});if(offerChange.oldMemberFlag){for(var P=0;P<OrderInfo.oldprodInstInfos.length;P++){var R=OrderInfo.oldprodInstInfos[P];$.each(OrderInfo.oldoffer,function(){if(this.accNbr==R.accNbr){var T=this;$.each(T.offerMemberInfos,function(){var Y=this;if(Y.objType==CONST.OBJ_TYPE.PROD){var W=this.objInstId;var X={areaId:OrderInfo.getProdAreaId(W),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:W,prodSpecId:Y.objId,offerSpecId:R.mainProdOfferInstInfos[0].prodOfferId,offerRoleId:"",acctNbr:Y.accessNumber,partyId:R.custId,distributorId:OrderInfo.staff.distributorId,mainOfferSpecId:R.mainProdOfferInstInfos[0].prodOfferId,soNbr:OrderInfo.order.soNbr};if(ec.util.isObj(R.prodBigClass)){X.prodBigClass=R.prodBigClass}$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==R.accNbr){$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){X.offerRoleId=this.offerRoleId}})}});var U=query.offer.queryChangeAttachOffer(X);$("#attach_"+W).html(U);if(ec.util.isObj(Y.objId)&&ec.util.isObj(Y.objType)&&ec.util.isObj(Y.offerRoleId)){X.queryType="1,2";X.objId=Y.objId;X.objType=Y.objType;X.memberRoleCd="401";var V=query.offer.queryDefMustOfferSpec(X);CacheData.parseOffer(V,W);var V=query.offer.queryServSpec(X);CacheData.parseServ(V,W)}if(ec.util.isArray(OrderInfo.oldofferSpec)){$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==R.accNbr){var Z=this.offerSpec.offerRoles;$.each(Z,function(){if(this.offerRoleId==Y.offerRoleId&&Y.objType==CONST.OBJ_TYPE.PROD){var aa=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var ac=CacheData.getServBySpecId(W,this.objId);if(ac!=undefined){var ab=$("#li_"+W+"_"+ac.servId)}}});return false}})}})}}})}});var N={};if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){if(this.accNbr==R.accNbr){N=this}})}if(order.prodModify.choosedProdInfo.is3G=="N"&&R.mainProdOfferInstInfos[0].is3G=="Y"){if(!order.memberChange.checkOrder(R,N)){return}order.memberChange.checkOfferProd(N)}}}if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){offerChange.checkOfferProd()}order.main.initTounch();var K=[];var I=true;if(order.memberChange.newSubPhoneNum!=""&&OrderInfo.provinceInfo.reloadFlag=="Y"){var Q=order.memberChange.newSubPhoneNum.split(",");for(var M=0;M<Q.length;M++){if(Q[M]!=""&&Q[M]!=null&&Q[M]!="null"){$.each(K,function(){if(this==Q[M]){I=false;return false}else{I=true}});if(I){K.push(Q[M]);var E={phoneNum:Q[M]};var S=order.phoneNumber.queryPhoneNumber(E);
if(S.datamap.baseInfo){$("#nbr_btn_-"+(M+1)).val(Q[M]);var O={prodId:"-"+(M+1),accessNumber:S.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:S.datamap.baseInfo.phoneNumId,pnLevelId:S.datamap.baseInfo.phoneLevelId,anTypeCd:S.datamap.baseInfo.pnTypeId,state:"ADD",areaId:S.datamap.baseInfo.areaId,areaCode:S.datamap.baseInfo.zoneNumber,memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,preStore:S.datamap.baseInfo.prePrice,minCharge:S.datamap.baseInfo.pnPrice};OrderInfo.boProdAns.push(O);order.dealer.changeAccNbr("-"+(M+1),Q[M])}}else{$.alert("提示","号码"+Q[M]+"重复输入")}}}}if(OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""&&OrderInfo.mktResInstCode!="null"&&OrderInfo.provinceInfo.reloadFlag=="Y"){K=[];I=true;var A="-1";var G=OrderInfo.mktResInstCode.split(",");for(var J=0;J<G.length;J++){if(G[J]!=""&&G[J]!=null&&G[J]!="null"&&order.memberChange.newSubPhoneNum!=""){var L=G[J].split("_");var C=L[0];var D=L[1];var Q=order.memberChange.newSubPhoneNum.split(",");var F=false;$.each(K,function(){if(this==C){I=false;return false}else{I=true}});if(!I){$.alert("提示","UIM卡"+D+"对应的号码重复");return}for(var M=0;M<Q.length;M++){if(Q[M]==C){K.push(Q[M]);F=true;var B={instCode:D};var z=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",B);if(z.code==0){if(z.data.mktResBaseInfo){if(z.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_-"+(M+1)).attr("disabled",true);$("#uim_release_btn_-"+(M+1)).attr("disabled",false);$("#uim_release_btn_-"+(M+1)).removeClass("disabled");$("#uim_txt_-"+(M+1)).attr("disabled",true);$("#uim_txt_-"+(M+1)).val(D);var H={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:z.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:z.data.mktResBaseInfo.qty,storeId:z.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:D,terminalCode:D,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-(M+1),offerId:A,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(-(M+1));OrderInfo.boProd2Tds.push(H)}else{$.alert("提示","UIM卡不是预占状态，当前为"+z.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(z.code==-2){$.alertM(z.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}if(!F){$.alert("提示","UIM卡"+D+"未匹配到接入号")}}}}};function g(C,D){var B={instCode:C};var A=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",B);if(A.code==0){if(A.data.mktResBaseInfo){if(A.data.mktResBaseInfo.statusCd=="1102"){$("#uim_txt_"+D).val(C);var z={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:A.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:A.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:C,ruleId:"",partyId:OrderInfo.cust.custId,prodId:D,offerId:-1,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(D);OrderInfo.boProd2Tds.push(z)}else{$.alert("提示","UIM卡["+C+"]不是预占状态，当前为"+A.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM卡["+C+"]信息")}}else{if(A.code==-2){$.alertM(A.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}var r=function(z){q(z,OrderInfo.offer);s(z,OrderInfo.offer);AttachOffer.setAttachBusiOrder(z);if(CONST.getAppDesc()==0){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(OrderInfo.boProd2Tds.length>0){var A={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var B=OrderInfo.getProdBusiOrder(A);if(B){z.push(B)}}}})}}};var i=function(K){var J=order.prodModify.choosedProdInfo;var C={};var z={areaId:J.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:J.prodOfferId,instId:J.prodOfferInstId,accessNumber:J.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP},data:{ooRoles:[]}};if(offerChange.oldMemberFlag){var F="";for(var H=0;H<OrderInfo.offerSpec.offerRoles.length;H++){var L=OrderInfo.offerSpec.offerRoles[H];if(L.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){F=L.offerRoleId;break}}for(var B=0;B<OrderInfo.oldprodInstInfos.length;B++){var E=OrderInfo.oldprodInstInfos[B];var A={areaId:E.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:E.mainProdOfferInstInfos[0].prodOfferId,instId:E.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:E.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var I=-1;for(var H=0;H<OrderInfo.oldoffer.length;H++){if(OrderInfo.oldoffer[H].accNbr==E.accNbr){$.each(OrderInfo.oldoffer[H].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var N={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:I,offerRoleId:F,state:"ADD"};z.data.ooRoles.push(N);var O={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};A.data.ooRoles.push(O);--I}})}}K.push(A)}if(CONST.getAppDesc()==0){for(var H=0;H<OrderInfo.oldoffer.length;H++){$.each(OrderInfo.oldoffer[H].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var N={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var O=OrderInfo.getProdBusiOrder(N);if(O){K.push(O)}}}})}}}if(offerChange.newMemberFlag){for(var H=0;H<OrderInfo.offerSpec.offerRoles.length;H++){var L=OrderInfo.offerSpec.offerRoles[H];if(L.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(L.prodInsts!=undefined&&L.prodInsts.length>0){for(var G=0;G<L.prodInsts.length;G++){var M=L.prodInsts[G];var D={objId:M.objId,objInstId:M.prodInstId,objType:M.objType,offerMemberId:OrderInfo.SEQ.offerMemberSeq--,offerRoleId:M.offerRoleId,state:"ADD"};z.data.ooRoles.push(D);K.push(SoOrder.createProd(M.prodInstId,M.objId))}}}}}K.push(z)};var q=function(z,B){B.offerTypeCd=1;B.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;var A=order.prodModify.choosedProdInfo;OrderInfo.getOfferBusiOrder(z,B,A.prodInstId)};var s=function(I,B){var G=order.prodModify.choosedProdInfo;var A=OrderInfo.offerSpec;var H={areaId:OrderInfo.getProdAreaId(G.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.SEQ.offerSeq--,objId:A.offerSpecId,offerTypeCd:"1",accessNumber:G.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};$.each(A.offerRoles,function(){var S=this;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){var T='"'+this.prodInstId+'"';if(T.indexOf("-")==-1){var U={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,offerRoleId:S.offerRoleId,state:"ADD"};H.data.ooRoles.push(U)}})}});if(offerChange.oldMemberFlag){var O="";for(var P=0;P<OrderInfo.offerSpec.offerRoles.length;P++){var M=OrderInfo.offerSpec.offerRoles[P];if(M.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){O=M.offerRoleId;break}}for(var K=0;K<OrderInfo.oldprodInstInfos.length;K++){var J=OrderInfo.oldprodInstInfos[K];var C={areaId:J.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:J.mainProdOfferInstInfos[0].prodOfferId,instId:J.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:J.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var R=-1;for(var P=0;P<OrderInfo.oldoffer.length;P++){if(OrderInfo.oldoffer[P].accNbr==J.accNbr){$.each(OrderInfo.oldoffer[P].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var S={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:R,offerRoleId:O,state:"ADD"};
H.data.ooRoles.push(S);var T={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};C.data.ooRoles.push(T);--R}})}}I.push(C)}if(CONST.getAppDesc()==0){for(var P=0;P<OrderInfo.oldoffer.length;P++){$.each(OrderInfo.oldoffer[P].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var S={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var T=OrderInfo.getProdBusiOrder(S);if(T){I.push(T)}}}})}}}if(offerChange.newMemberFlag){for(var P=0;P<OrderInfo.offerSpec.offerRoles.length;P++){var M=OrderInfo.offerSpec.offerRoles[P];if(M.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(M.prodInsts!=undefined&&M.prodInsts.length>0){for(var N=0;N<M.prodInsts.length;N++){var D=M.prodInsts[N];var L='"'+D.prodInstId+'"';if(D.memberRoleCd=="401"&&L.indexOf("-")!=-1){var F={objId:D.objId,objInstId:D.prodInstId,objType:D.objType,offerMemberId:OrderInfo.SEQ.offerMemberSeq--,offerRoleId:D.offerRoleId,state:"ADD"};H.data.ooRoles.push(F);I.push(SoOrder.createProd(D.prodInstId,D.objId))}}}}}}if(ec.util.isArray(A.offerSpecParams)){H.data.ooParams=[];for(var P=0;P<A.offerSpecParams.length;P++){var E=A.offerSpecParams[P];var z={itemSpecId:E.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:E.offerSpecParamId,value:E.value,state:"ADD"};H.data.ooParams.push(z)}}if(A.ooTimes!=undefined){H.data.ooTimes=[];H.data.ooTimes.push(A.ooTimes)}H.data.busiOrderAttrs=[];var Q=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(Q!=undefined){Q.each(function(){var S={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select[name='dealerType_"+OrderInfo.offerSpec.offerSpecId+"']").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()};H.data.busiOrderAttrs.push(S);var T={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select[name='dealerType_"+OrderInfo.offerSpec.offerSpecId+"']").val(),value:$(this).find("input").attr("value")};H.data.busiOrderAttrs.push(T)})}I.push(H)};var d=function(z){};var n=function(A){if(OrderInfo.actionFlag==3){l()}else{w()}var z=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(z==undefined){return false}if(z.resultCode==0&&ec.util.isObj(z.result)){offerChange.resultOffer=z.result}else{$.alert("预校验规则限制",z.resultMsg);offerChange.resultOffer={};return false}return true};var l=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;var D=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;for(var C=0;C<AttachOffer.openList.length;C++){var B=AttachOffer.openList[C];for(var A=0;A<B.specList.length;A++){var z=B.specList[A];if(z.isdel!="Y"&&z.isdel!="C"&&z.ifPackage4G=="Y"){z.offerTypeCd=2;z.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;z.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(D,z,B.prodId)}}}$.each(D,function(){this.busiObj.state="ADD"})};var u=function(z,I){if(z==1){var H=y();if(H==undefined){alert("错误提示","无法变更到该套餐");return false}H.prodInsts=[];var G=false;$.each(H.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var J=this;G=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(J.objId!=this.objId){$.alert("规则限制","新套餐【"+J.offerRoleName+"】角色的规格ID【"+J.objId+"】和旧套餐【"+this.roleName+"】角色的规格ID【"+this.objId+"】不一样");G=true;return false}J.prodInstId=this.objInstId;J.accessNumber=this.accessNumber;J.memberRoleCd=this.roleCd;H.prodInsts.push(J)}});if(G){return false}}});if(G){return false}}else{for(var D=0;D<OrderInfo.offer.offerMemberInfos.length;D++){var B=OrderInfo.offer.offerMemberInfos[D];if(B.objType==CONST.OBJ_TYPE.PROD){var G=true;for(var C=0;C<OrderInfo.offerSpec.offerRoles.length;C++){var H=OrderInfo.offerSpec.offerRoles[C];if(B.roleCd==H.memberRoleCd){for(var A=0;A<H.roleObjs.length;A++){var F=H.roleObjs[A];if(F.objType==CONST.OBJ_TYPE.PROD){if(F.objId!=B.objId){$.alert("规则限制","新套餐【"+F.offerRoleName+"】角色的规格ID【"+F.objId+"】和旧套餐【"+B.roleName+"】角色的规格ID【"+B.objId+"】不一样");return false}if(!ec.util.isArray(H.prodInsts)){H.prodInsts=[]}var E=jQuery.extend(true,{},F);E.prodInstId=B.objInstId;E.accessNumber=B.accessNumber;E.memberRoleCd=B.roleCd;H.prodInsts.push(E);if(H.prodInsts.length>F.maxQty){$.alert("规则限制","新套餐【"+H.offerRoleName+"】角色最多可以办理数量为"+F.maxQty+",而旧套餐数量大于"+F.maxQty);return false}break}}G=false;break}}if(G){alert("旧套餐【"+B.roleName+"】角色在新套餐中不存在，无法变更");return false}}}}return true};var y=function(){for(var B=0;B<OrderInfo.offerSpec.offerRoles.length;B++){var C=OrderInfo.offerSpec.offerRoles[B];if(C.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return C}}for(var B=0;B<OrderInfo.offerSpec.offerRoles.length;B++){var C=OrderInfo.offerSpec.offerRoles[B];for(var A=0;A<C.roleObjs.length;A++){var z=C.roleObjs[A];if(z.objType==CONST.OBJ_TYPE.PROD){return C}}}};var w=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.cust.areaId;var z=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;q(z,OrderInfo.offer);s(z,OrderInfo.offer)};var b=function(){if(offerChange.resultOffer==undefined){return}var z=offerChange.resultOffer.prodInfos;if(ec.util.isArray(z)){$.each(z,function(){var F=this.accProdInstId;var D=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==F){D=false;return false}});if(D){return true}if(F!=this.prodInstId){var G=CacheData.getServ(F,this.prodInstId);if(this.state=="DEL"){if(G!=undefined){var H=$("#li_"+F+"_"+this.prodInstId);if(ec.util.isObj(H)){var C=$("#span_"+F+"_"+this.prodInstId);var E=$("#span_remove_"+F+"_"+this.prodInstId);if(ec.util.isObj(C)){C.addClass("del")}if(ec.util.isObj(E)){E.hide()}H.removeAttr("onclick");G.isdel="Y"}}}else{if(this.state=="ADD"){if(G!=undefined){var H=$("#li_"+F+"_"+this.prodInstId);if(ec.util.isObj(H)){var C=$("#span_"+F+"_"+this.prodInstId);var E=$("#span_remove_"+F+"_"+this.prodInstId);if(ec.util.isObj(C)){C.removeClass("del")}if(ec.util.isObj(E)){E.hide()}H.removeAttr("onclick");G.isdel="N"}}else{var B=CacheData.getServSpec(F,this.productId);if(B!=undefined){var H=$("#li_"+F+"_"+this.productId);if(ec.util.isObj(H)){var C=$("#span_"+F+"_"+this.productId);var E=$("#span_remove_"+F+"_"+this.productId);if(ec.util.isObj(C)){C.removeClass("del")}if(ec.util.isObj(E)){E.hide()}H.removeAttr("onclick");B.isdel="N"}$("#del_"+F+"_"+this.productId).hide()}else{if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(F,this.productId)}}}}}}})}var A=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(A)){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){var B=this.objInstId;$.each(A,function(){if(this.memberInfo==undefined){return true}var F=CacheData.getOffer(B,this.prodOfferInstId);var D=true;$.each(this.memberInfo,function(){if(B==this.accProdInstId){if(ec.util.isObj(F)){this.prodId=this.accProdInstId}D=false;return false}});if(D){return true}if(this.state=="DEL"){if(F!=undefined){var H=$("#li_"+B+"_"+this.prodOfferInstId);if(ec.util.isObj(H)){var C=$("#span_"+B+"_"+this.prodOfferInstId);var E=$("#span_remove_"+B+"_"+this.prodOfferInstId);if(ec.util.isObj(C)){C.addClass("del")}if(ec.util.isObj(E)){E.hide()}H.removeAttr("onclick");F.isdel="N"}F.isdel="Y";if(this.isRepeat!="Y"){this.isRepeat="Y"}else{F.isRepeat="Y"}}}else{if(this.state=="ADD"){if(F!=undefined){var H=$("#li_"+B+"_"+this.prodOfferInstId);if(ec.util.isObj(H)){var C=$("#span_"+B+"_"+this.prodOfferInstId);var E=$("#span_remove_"+B+"_"+this.prodOfferInstId);
if(ec.util.isObj(C)){C.removeClass("del")}if(ec.util.isObj(E)){E.hide()}H.removeAttr("onclick");F.isdel="N"}}else{var G=CacheData.getOfferSpec(B,this.prodOfferId);if(G!=undefined){var H=$("#li_"+B+"_"+this.prodOfferId);if(ec.util.isObj(H)){var C=$("#span_"+B+"_"+this.prodOfferId);var E=$("#span_remove_"+B+"_"+this.prodOfferId);if(ec.util.isObj(C)){C.removeClass("del")}if(ec.util.isObj(E)){E.hide()}H.removeAttr("onclick");G.isdel="N"}}else{if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(B,this.prodOfferId)}}}}}})})}}};var c=function(C){var B="";if(offerChange.resultOffer==undefined){return B}var z=offerChange.resultOffer.prodInfos;if(ec.util.isArray(z)){var D="";$.each(z,function(){if(C!=this.accProdInstId){return true}if(C!=this.prodInstId){var F=CacheData.getServ(C,this.prodInstId);var E=CacheData.getServSpec(C,this.productId);if(this.state=="DEL"){if(F!=undefined){D+='<li id="li_'+C+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+F.servSpecName+"</span></li>"}else{if(E!=undefined){D+='<li id="li_'+C+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+E.servSpecName+"</span></li>"}else{if(this.productName!=undefined&&this.productName!=""){D+='<li id="li_'+C+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+this.productName+"</span></li>"}}}}else{if(this.state=="ADD"){if(F!=undefined){D+='<li id="li_'+C+"_"+this.prodInstId+'"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span>'+F.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(E!=undefined){D+='<li id="li_'+C+"_"+this.prodInstId+'"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span>'+E.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(this.productName!=undefined&&this.productName!=""){D+='<li id="li_'+C+"_"+this.prodInstId+'"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span>'+this.productName+'</span><dd class="mustchoose"></dd></li>'}}}}}}});if(D==""){B=""}else{B="<div class='fs_choosed'>订购4G流量包，需订购和取消如下功能产品：<br><ul>"+D+"</ul></div><br>"}}var A=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(A)){var D="";$.each(A,function(){if(this.memberInfo==undefined){return true}var E=true;$.each(this.memberInfo,function(){if(ec.util.isObj(this.accProdInstId)&&C==this.accProdInstId){E=false;return false}});if(E){return true}var F=CacheData.getOffer(C,this.prodOfferInstId);var G=CacheData.getOfferSpec(C,this.prodOfferId);if(this.state=="DEL"){if(F!=undefined){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+F.offerSpecName+"</span></li>"}else{if(G!=undefined){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+G.offerSpecName+"</span></li>"}else{if(this.prodOfferName!=undefined&&this.prodOfferName!=""){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+this.prodOfferName+"</span></li>"}}}}else{if(this.state=="ADD"){if(F!=undefined){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+F.offerSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(G!=undefined){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+G.offerSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(this.prodOfferName!=undefined&&this.prodOfferName!=""){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+this.prodOfferName+'</span><dd class="mustchoose"></dd></li>'}}}}}});if(D!=""){B+="<div class='fs_choosed'>订购4G流量包，需开通和关闭如下可选包：<br><ul>"+D+"</ul></div>"}}return B};return{init:k,offerChangeView:x,changeOffer:r,changeTab:d,checkOrder:n,checkAttachOffer:c,fillOfferChange:p,checkOfferProd:b,getChangeInfo:w,setChangeOfferSpec:u,addNum:m}})();CommonUtils.regNamespace("CacheData");CacheData=(function(){var c=function(L,M){M.isdel="C";var I=true;for(var K=0;K<AttachOffer.openList.length;K++){var J=AttachOffer.openList[K];if(J.prodId==L){I=false;break}}if(I){var J={prodId:L,specList:[]};AttachOffer.openList.push(J)}CacheData.getOfferSpecList(L).push(M)};var i=function(M,J){J.isdel="C";if(J.servSpecId==undefined){J.servSpecId=J.objId}if(J.servSpecName==undefined){J.servSpecName=J.objName}var I=true;for(var L=0;L<AttachOffer.openServList.length;L++){var K=AttachOffer.openServList[L];if(K.prodId==M){I=false;break}}if(I){var K={prodId:M,servSpecList:[]};AttachOffer.openServList.push(K)}CacheData.getServSpecList(M).push(J)};var v=function(I,J){if(J!=undefined){$.each(J.offerRoles,function(){$.each(this.roleObjs,function(){if($("#check_"+I+"_"+this.objId).attr("checked")=="checked"){this.selQty=1}else{this.selQty=2}})})}};var D=function(M,J,I){var L='<form id="paramForm">';if(I==2){if(ec.util.isArray(J.prodSpecParams)){for(var K=0;K<J.prodSpecParams.length;K++){var O=J.prodSpecParams[K];if(O.value==undefined){O.value=""}L+=m(M,O,O.itemSpecId,O.value)}}}else{if(I==3){if(ec.util.isArray(J.prodSpecParams)){for(var K=0;K<J.prodSpecParams.length;K++){var O=J.prodSpecParams[K];if(ec.util.isArray(J.prodInstParams)){$.each(J.prodInstParams,function(){if(this.itemSpecId==O.itemSpecId){O.value=this.value}})}if(O.value==undefined){O.value=""}L+=m(M,O,O.itemSpecId,O.value)}}}else{if(I==1){if(J.offerSpec!=undefined){if(ec.util.isArray(J.offerSpec.offerSpecParams)){var N=J.offerSpec.offerSpecParams;$.each(N,function(){var P=this;if(ec.util.isArray(J.offerParamInfos)){$.each(J.offerParamInfos,function(){if(this.itemSpecId==P.itemSpecId){P.value=this.value}})}L+=m(M,this,this.itemSpecId,this.value)})}}}else{if(ec.util.isArray(J.offerSpecParams)){var N=J.offerSpecParams;$.each(N,function(){L+=m(M,this,this.itemSpecId,this.value)})}}}}L+="</form>";return L};var e=function(K,J){var I=$('<form id="appForm"></form>');if(!!J&&J.length>0){$.each(J,function(){var L=$('<input id="'+K+"_"+this.objId+'" name="'+K+'" type="checkbox">'+this.objName+"</input></br>");if(this.minQty==0){if(this.dfQty>0){L.attr("checked","checked")}}else{if(this.minQty>0){L.attr("checked","checked");L.attr("disabled","disabled")}}I.append(L)})}return I};var m=function(N,P){var K=P.itemSpecId;if(P.setValue==undefined){P.setValue=P.value}var L=P.setValue;var I="";if(ec.util.isArray(P.valueRange)){var M="";if(P.rule.isConstant=="Y"){I=P.name+": <select class='inputWidth183px' id="+N+"_"+K+" disabled='disabled'>"}else{if(P.rule.isOptional=="N"){I=P.name+": <select class='inputWidth183px' id="+N+"_"+K+" data-validate='validate(required,reg:"+P.rule.maskMsg+"("+P.rule.mask+")) on(blur)'><label class='f_red'>*</label><br>"}else{I=P.name+": <select class='inputWidth183px' id="+N+"_"+K+"><br>";M+='<option value="" >请选择</option>'}}for(var J=0;J<P.valueRange.length;J++){var O=P.valueRange[J];if(O.value==P.setValue){M+='<option value="'+O.value+'" selected="selected" >'+O.text+"</option>"}else{M+='<option value="'+O.value+'">'+O.text+"</option>"}}I+=M+"</select><br>"}else{if(P.dataTypeCd==1){if(P.rule==undefined){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="text" value="'+L+'" ><br>'}else{if(P.rule.isConstant=="Y"){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="text" disabled="disabled" value="'+L+'" ><br>'}else{if(P.rule.isOptional=="N"){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="text" data-validate="validate(required,reg:'+P.rule.maskMsg+"("+P.rule.mask+')) on(blur)" value="'+L+'" ><label class="f_red">*</label><br>'
}else{I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="text" data-validate="validate(reg:'+P.rule.maskMsg+"("+P.rule.mask+')) on(blur)" value="'+L+'" ><br>'}}}}else{if(P.dataTypeCd==8){if(P.rule==undefined){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="password" value="'+L+'" ><br>'}else{if(P.rule.isConstant=="Y"){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="password"  disabled="disabled" value="'+L+'" ><br>'}else{if(P.rule.isOptional=="N"){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="password" data-validate="validate(required,reg:'+P.rule.maskMsg+"("+P.rule.mask+')) on(blur)" value="'+L+'" ><label class="f_red">*</label><br>'}else{I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="password" data-validate="validate(reg:'+P.rule.maskMsg+"("+P.rule.mask+')) on(blur)" value="'+L+'" ><br>'}}}}else{if(P.dataTypeCd==4){}}}}return I};var p=function(L,J,I){var K='<form id="paramForm">';var M="";if(I==0){$.each(J.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4){if(this.minQty==0&&this.maxQty>0&&this.dfQty>0){M+='<input id="check_'+L+"_"+this.objId+'" type="checkbox" checked="checked"><label for=check_'+L+"_"+this.objId+">"+this.objName+"</label><br>"}else{if(this.minQty>0){M+='<input id="check_'+L+"_"+this.objId+'"  type="checkbox" checked="checked" disabled="disabled"><label for=check_'+L+"_"+this.objId+">"+this.objName+"</label><br>"}else{if(this.minQty==0&&this.maxQty>0&&this.dfQty==0){M+='<input id="check_'+L+"_"+this.objId+'" type="checkbox"><label for=check_'+L+"_"+this.objId+">"+this.objName+"</label><br>"}}}}})});if(M==""){K="订购【"+J.offerSpecName+"】可选包"}else{K="订购【"+J.offerSpecName+"】可选包，需要开通以下勾选的功能产品：<br>"+M}}else{if(I==1){$.each(J.offerMemberInfos,function(){var N=this;$.each(J.offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(N.objId==this.objId&&this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){var O=N.objInstId;if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE&&this.minQty<=0){M+='<input id="check_'+L+"_"+O+'" type="checkbox" checked="checked" disabled="disabled"><label for=check_'+L+"_"+this.servId+">"+this.objName+"</label><br>"}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE&&this.minQty<=0){M+='<input id="check_'+L+"_"+O+'" type="checkbox" checked="checked"><label for=check_'+L+"_"+this.servId+">"+this.objName+"</label><br>"}}}})})});if(M==""){K="退订【"+J.offerSpecName+"】可选包"}else{K="退订【"+J.offerSpecName+"】可选包，需要关闭以下勾选的功能产品：<br>"+M}}else{if(I==2){$.each(J.offerRoles,function(){$.each(this.roleObjs,function(){if(this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE&&this.minQty<=0){M+='<input id="check_'+L+"_"+this.objId+'" type="checkbox" checked="checked" disabled="disabled"><label for=check_'+L+"_"+this.objId+">"+this.objName+"</label><br>"}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE&&this.minQty<=0){M+='<input id="check_'+L+"_"+this.objId+'" type="checkbox" checked="checked"><label for=check_'+L+"_"+this.objId+">"+this.objName+"</label><br>"}}}})});if(M==""){K="取消订购【"+J.offerSpecName+"】可选包"}else{K="取消订购【"+J.offerSpecName+"】可选包，需要取消开通以下勾选的功能产品：<br>"+M}}}}K+="</form>";return K};var F=function(J,L){if(ec.util.isArray(L.offerSpecParams)){for(var I=0;I<L.offerSpecParams.length;I++){var K=L.offerSpecParams[I];if(ec.util.isArray(K.valueRange)){if(K.value==undefined||K.value==""){if(K.rule.isOptional=="N"){return false}}}else{if(K.value==undefined||K.value==""){if(K.rule.isOptional=="N"){return false}}}}}L.isset="Y";return true};var r=function(K,I){if(ec.util.isArray(I.prodSpecParams)){for(var J=0;J<I.prodSpecParams.length;J++){var L=I.prodSpecParams[J];if(ec.util.isArray(L.valueRange)){if(L.value==undefined||L.value==""){if(L.rule.isOptional=="N"){return false}}}else{if(L.value==undefined||L.value==""){if(L.rule.isOptional=="N"){return false}}}}}I.isset="Y";return true};var w=function(K){for(var J=0;J<AttachOffer.openList.length;J++){var I=AttachOffer.openList[J];if(I.prodId==K){return I.specList}}return[]};var u=function(K,L){var I=w(K);if(I!=undefined){for(var J=0;J<I.length;J++){if(I[J].offerSpecId==L){return I[J]}}}};var n=function(L,M,J){var I=u(L,M);if(ec.util.isObj(I)){for(var K=0;K<I.offerSpecParams.length;K++){if(I.offerSpecParams[K].itemSpecId==J){return I.offerSpecParams[K]}}}};var a=function(M,P,J){var Q=u(M,P);if(!!Q.offerRoles){for(var L=0;L<Q.offerRoles.length;L++){var O=Q.offerRoles[L];for(var K=0;K<O.roleObjs.length;K++){var N=O.roleObjs[K];if(N.prodSpecParams!=undefined&&N.prodSpecParams.length>0){for(var I=0;I<N.prodSpecParams.length;I++){if(N.prodSpecParams[I].itemSpecId==J){return N.prodSpecParams[I]}}}}}}};var d=function(J){for(var I=0;I<AttachOffer.openedList.length;I++){var K=AttachOffer.openedList[I];if(K.prodId==J){return K.offerList}}return[]};var x=function(L,I){var J=d(L);if(ec.util.isArray(J)){for(var K=0;K<J.length;K++){if(J[K].offerId==I){return J[K]}}}};var g=function(K,L){var I=d(K);if(ec.util.isArray(I)){for(var J=0;J<I.length;J++){if(I[J].offerSpecId==L){return I[J]}}}};var l=function(M,I,J){var L=x(M,I);if(ec.util.isArray(L.offerSpec.offerSpecParams)){for(var K=0;K<L.offerSpec.offerSpecParams.length;K++){if(L.offerSpec.offerSpecParams[K].itemSpecId==J){return L.offerSpec.offerSpecParams[K]}}}};var H=function(O,M,I){var P=x(O,M);if(ec.util.isArray(P.offerMembers)){for(var N=0;N<P.offerMembers.length;N++){var K=P.offerMembers[N];for(var L=0;L<K.prodParamInfos.length;L++){for(var J=0;J<K.prodParamInfos.length;J++){var Q=K.prodParamInfos[J];if(Q.itemSpecId==I){return Q}}}}}};var z=function(K){for(var J=0;J<AttachOffer.openServList.length;J++){var I=AttachOffer.openServList[J];if(I.prodId==K){return I.servSpecList}}return[]};var b=function(K,L){var I=z(K);if(I!=undefined){for(var J=0;J<I.length;J++){if(I[J].servSpecId==L){return I[J]}}}};var h=function(L,M,J){var I=b(L,M);if(ec.util.isArray(I.prodSpecParams)){for(var K=0;K<I.prodSpecParams.length;K++){if(I.prodSpecParams[K].itemSpecId==J){return I.prodSpecParams[K]}}}};var t=function(J){for(var I=0;I<AttachOffer.openedServList.length;I++){var K=AttachOffer.openedServList[I];if(K.prodId==J){return K.servList}}return[]};var y=function(K,L){var J=t(K);if(ec.util.isArray(J)){for(var I=0;I<J.length;I++){if(J[I].servId==L){return J[I]}}}};var j=function(K,L){var J=t(K);if(ec.util.isArray(J)){for(var I=0;I<J.length;I++){if(J[I].servSpecId==L){return J[I]}}}};var f=function(L,N,I){var M=y(L,N);if(ec.util.isArray(M.prodSpecParams)){for(var J=0;J<M.prodSpecParams.length;J++){var K=M.prodSpecParams[J];if(K.itemSpecId==I){return K}}}};var q=function(K){for(var J=0;J<AttachOffer.openAppList.length;J++){var I=AttachOffer.openAppList[J];if(I.prodId==K){return I.appList}}return[]};var C=function(K){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){for(var I=0;I<OrderInfo.offer.offerMemberInfos.length;I++){var J=OrderInfo.offer.offerMemberInfos[I];if(J.objInstId==K){return J}}}return{}};var k=function(K,M){var L={servSpecId:M,prodId:K,orderedServSpecIds:[]};var I=CacheData.getServSpecList(K);if(ec.util.isArray(I)){$.each(I,function(){if(this.servSpecId!=M&&this.isdel!="Y"&&this.isdel!="C"){L.orderedServSpecIds.push(this.servSpecId)}})}var J=CacheData.getServList(K);if(ec.util.isArray(J)){$.each(J,function(){if(this.servSpecId!=M&&this.isdel!="Y"&&this.isdel!="C"){L.orderedServSpecIds.push(this.servSpecId)}})}return L};var s=function(K,N){var M={prodId:K,offerSpecId:N,objType:CONST.OBJ_TYPE.PROD,orderedOfferSpecIds:[]};var L=CacheData.getOfferSpec(K,N);if(ec.util.isObj(L)){if(ec.util.isArray(L.offerRoles)){$.each(L.offerRoles,function(){if(ec.util.isArray(this.roleObjs)){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){M.offerRoleId=this.offerRoleId;M.objId=this.objId;return false}})}})}}else{var I=CacheData.getOfferBySpecId(K,N);if(ec.util.isObj(I)){M.offerRoleId=I.offerRoleId;if(ec.util.isArray(I.offerMemberInfos)){$.each(I.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){M.objId=this.objId;
return false}})}}}var J=CacheData.getOfferSpecList(K);if(ec.util.isArray(J)){$.each(J,function(){if(this.offerSpecId!=N&&this.isdel!="Y"){if(this.offerSpecId!=undefined){M.orderedOfferSpecIds.push(this.offerSpecId)}}})}return M};var A=function(L,N){if(ec.util.isObj(L)){if(ec.util.isArray(L.result.servSpec)){for(var M=0;M<L.result.servSpec.length;M++){var J=L.result.servSpec[M];var K=CacheData.getServBySpecId(N,J.servSpecId);var O=CacheData.getServSpec(N,J.servSpecId);if(J.ifDault==0){if(ec.util.isObj(K)){var P=$("#li_"+N+"_"+K.servId);if(ec.util.isObj(P)){var Q=$("#span_"+N+"_"+K.servId);var I=$("#span_remove_"+N+"_"+K.servId);if(ec.util.isObj(Q)){Q.removeClass("del")}if(ec.util.isObj(I)){I.hide()}P.removeAttr("onclick");K.isdel="N"}}else{if(ec.util.isObj(O)){var P=$("#li_"+N+"_"+O.servSpecId);if(ec.util.isObj(P)){var Q=$("#span_"+N+"_"+O.servSpecId);var I=$("#span_remove_"+N+"_"+O.servSpecId);if(ec.util.isObj(Q)){Q.removeClass("del")}if(ec.util.isObj(I)){I.hide()}P.removeAttr("onclick");O.isdel="N"}}else{if(OrderInfo.actionFlag==2){J.isdel="C";CacheData.setServSpec(N,J);AttachOffer.addOpenServList(N,J.servSpecId,J.servSpecName,J.ifParams)}}}}else{if((OrderInfo.actionFlag==2||OrderInfo.actionFlag==21||OrderInfo.actionFlag==22)&&J.ifDault==1){if(ec.util.isObj(K)){var P=$("#li_"+N+"_"+K.servId);if(ec.util.isObj(P)){var Q=$("#span_"+N+"_"+K.servId);if(ec.util.isObj(Q)){Q.removeClass("del")}K.isdel="N"}}else{if(ec.util.isObj(O)){var P=$("#li_"+N+"_"+O.servSpecId);if(ec.util.isObj(P)){var Q=$("#span_"+N+"_"+O.servSpecId);if(ec.util.isObj(Q)){Q.removeClass("del")}O.isdel="N"}}else{J.isdel="C";CacheData.setServSpec(N,J);AttachOffer.addOpenServList(N,J.servSpecId,J.servSpecName,J.ifParams)}}}}}}}};var o=function(N,Q){if(ec.util.isObj(N)){if(ec.util.isArray(N.result.offerSpec)){for(var O=0;O<N.result.offerSpec.length;O++){var M=N.result.offerSpec[O];if(M.ifDault==0){var T=CacheData.getOfferBySpecId(Q,M.offerSpecId);if(ec.util.isObj(T)){var R=$("#li_"+Q+"_"+T.offerId);if(ec.util.isObj(R)){var S=$("#span_"+Q+"_"+T.offerId);var J=$("#span_remove_"+Q+"_"+T.offerId);if(ec.util.isObj(S)){S.removeClass("del")}if(ec.util.isObj(J)){J.hide()}R.removeAttr("onclick");T.isdel="N"}}var P=CacheData.getOfferSpec(Q,M.offerSpecId);if(ec.util.isObj(P)){var R=$("#li_"+Q+"_"+P.offerSpecId);if(ec.util.isObj(R)){var S=$("#span_"+Q+"_"+P.offerSpecId);var J=$("#span_remove_"+Q+"_"+P.offerSpecId);if(ec.util.isObj(S)){S.removeClass("del")}if(ec.util.isObj(J)){J.hide()}R.removeAttr("onclick");P.isdel="N"}}else{if(OrderInfo.actionFlag==2){M.isdel="C";CacheData.setOfferSpec(Q,M);var L=CacheData.getExcDepOfferParam(Q,M.offerSpecId);AttachOffer.addOpenList(Q,M.offerSpecId);if(L.orderedOfferSpecIds.length>0){var K=query.offer.queryExcludeDepend(L);if(K!=undefined&&K.result!=undefined){var U=K.result.offerSpec.exclude;if(ec.util.isArray(U)){for(var O=0;O<U.length;O++){var I=U[O];var T=CacheData.getOfferBySpecId(Q,I);if(T!=undefined){var R=$("#li_"+Q+"_"+T.offerId);if(ec.util.isObj(R)){var S=$("#span_"+Q+"_"+T.offerId);var J=$("#span_remove_"+Q+"_"+T.offerId);if(ec.util.isObj(S)){S.addClass("del")}if(ec.util.isObj(J)){J.hide()}R.removeAttr("onclick");T.isdel="N"}}}}}}}}}}}}};var G=function(I){var J="";if(I>0){if(OrderInfo.offer.offerMemberInfos!=undefined){$.each(OrderInfo.offer.offerMemberInfos,function(K){if(this.objInstId==I){J=this.offerRoleId;return false}})}}else{if(I<0){if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(L){var K=this.offerRoleId;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==I){J=K;return false}})}})}}}return J};var B=function(L){var I=[];for(var J=0;J<L.offerMemberInfos.length;J++){var K=L.offerMemberInfos[J];if(K.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){I.push(K)}}for(var J=0;J<L.offerMemberInfos.length;J++){var K=L.offerMemberInfos[J];if(K.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){I.push(K)}}L.offerMemberInfos=I};var E=function(P){if(P.dependOffer.offerGrpInfos.length>0){var O=P.dependOffer;for(var L=0;L<O.offerGrpInfos.length;L++){var N=O.offerGrpInfos[L];var M=$("input[name="+N.grpId+"]:checked");var I=M.length;O.offerGrpInfos[L].checkLen=I;for(var K=0;K<N.subOfferSpecInfos.length;K++){var J=N.subOfferSpecInfos[K];M.each(function(){if($(this).val()==J.offerSpecId){J.isCheck=true}})}}}};return{setParam:F,setServParam:r,setOfferSpec:c,setServSpec:i,setServ2OfferSpec:v,setOffer2ExcludeOfferSpec:E,sortOffer:B,getParamContent:D,getOfferSpecList:w,getOfferSpec:u,getSpecParam:n,getOfferList:d,getOffer:x,getOfferParam:l,getOfferBySpecId:g,getServList:t,getServ:y,getServBySpecId:j,getServSpec:b,getServSpecList:z,getProdInstParam:H,getProdSpecParam:a,getServInstParam:f,getServSpecParam:h,getOfferProdStr:p,getOpenAppList:q,getAppContent:e,getOfferMember:C,getExcDepServParam:k,getExcDepOfferParam:s,getOfferRoleId:G,parseServ:A,parseOffer:o}})();CommonUtils.regNamespace("cust","mgr");cust.mgr=(function(){var L=function(){$("#custCreateForm").off("formIsValid").on("formIsValid",function(W){var V=contextPath+"/order/createorderlonger";var U=$.callServiceAsJson(V,{});if(U.code==0){OrderInfo.custorderlonger=U.data}m()}).ketchup({bindElement:"btn_cust_create_save"})};var D=false;var a={};var c={};var O=null;var k=null;var J="0";var l=null;var z="";var H=[];var q=[];var x=function(){return O};var w="";var i=function(){$("#custAuthForm").off("formIsValid").on("formIsValid",function(V,U){var W=a;W.prodPwd=$.trim($("#authPassword").val());W.accessNumber=a.accessNumber;W.authFlag=k;$.callServiceAsHtml(contextPath+"/cust/custAuth",W,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(X){if(X.code==-2){return}if(X.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}try{var Z=$.parseJSON(X.data);$.alertMore("异常信息",Z.resultMsg,Z.errorStack,"error");return}catch(Y){}O=W;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;t(X)},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"custAuthbtn"})};var r=function(V,W){var U=$(V).val();h(U,W);g()};var h=function(W,V){var U=$("#"+V);$.callServiceAsJson(contextPath+"/cust/queryCertType",{partyTypeCd:W},{before:function(){},done:function(X){if(X.code==-2){$.alertM(X.data);return false}if(X.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(X.code==0){var ab=X.data;if(ab!=undefined&&ab.length>0){var ad=[];for(var Z=0;Z<ab.length;Z++){var ac=true;for(var Y=0;Y<ad.length;Y++){ac=ac&&ab[Z].certTypeCd!=ad[Y].certTypeCd;if(!ac){break}}if(ac){ad.push(ab[Z])}}for(var Z=0;Z<ad.length;Z++){var aa=ad[Z];U.append("<option value='"+aa.certTypeCd+"' >"+aa.name+"</option>")}U.selectmenu().selectmenu("refresh");if(V=="identidiesTypeCd"){f($("#"+V).children(":first-child"),"cCustIdCard")}}}},fail:function(X){},always:function(){}})};var G=function(U,W){var V=$(U).val();if(V==-1){$("#"+W).attr("placeHolder","请输入接入号码");$("#"+W).attr("data-validate","validate(required:请准确填写接入号码) on(blur)")}else{if(V==1){$("#"+W).attr("placeHolder","请输入身份证号码");$("#"+W).attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(blur)")}else{if(V==2){$("#"+W).attr("placeHolder","请输入军官证");$("#"+W).attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(V==3){$("#"+W).attr("placeHolder","请输入护照");$("#"+W).attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#"+W).attr("placeHolder","请输入证件号码");$("#"+W).attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}}if(V!=-1){$("#isAppointNum").val("0").slider().slider("refresh")}e()};var f=function(U,X){var V=$(U).val();var W=$("#"+X);if(V==1){W.attr("placeHolder","请输入合法身份证号码");W.attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(V==2){W.attr("placeHolder","请输入合法军官证");W.attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(V==3){W.attr("placeHolder","请输入合法护照");W.attr("data-validate","validate(required:请准确填写护照) on(blur)")
}else{W.attr("placeHolder","请输入合法证件号码");W.attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}g()};var e=function(){$("#custQueryFirstForm").off("formIsValid").on("formIsValid",function(V,X){var ad="";var ac="";var W="";var U="";var aa="";var Z="";var ab="";ad=$("#p_cust_identityCd").val();aa=$.trim($("#p_cust_identityNum").val());if(order.cust.mgr.fromProvFlag=="1"||(ad!=-1&&CONST.getAppDesc()!=0)){ad=$("#p_cust_identityCd").val();k="1"}else{k="0"}if(ad==-1){U=aa;aa="";ad=""}else{if(ad=="acctCd"||ad=="custNumber"){U="";aa="";ad="";Z=$("#p_cust_identityCd").val();ab=$.trim($("#p_cust_identityNum").val())}}W=$("#DiffPlaceFlag").val();areaId=$("#p_cust_areaId").val();if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");return}var Y={acctNbr:U,identityCd:ad,identityNum:aa,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:W,areaId:areaId,queryType:Z,queryTypeValue:ab};$.callServiceAsHtml(contextPath+"/pad/cust/queryCust",Y,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(ae){if(ae.code==-2){return}P(ae)},fail:function(ae){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})}).ketchup({bindElement:"a_user_search"})};var g=function(){$("#custCreateForm").off("formIsValid").on("formIsValid",function(W){var V=contextPath+"/order/createorderlonger";var U=$.callServiceAsJson(V,{});if(U.code==0){OrderInfo.custorderlonger=U.data}m()}).ketchup({bindElement:"btn_cust_create_save"})};var P=function(U){if(U.data.indexOf("false")>=0){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}var V=$("#div_user_qry_result");V.find("ul").html(U.data);$("#a_cust_qry_back").off("tap").on("tap",function(W){k=""});$.jqmRefresh(V)};var E=function(){window.location.reload();$("#custQueryFirstForm").show();$("#custInfo").hide();$("#p_cust_identityNum").val("");$("#authPassword").val("");k="";OrderInfo.boCusts.partyId="";OrderInfo.boCustInfos.name="";OrderInfo.boCustIdentities.identityNum="";OrderInfo.cust={custId:-1,custName:"",areaId:""};OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId="";OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.cust="";w="";OrderInfo.order.step=0;if((CONST.getAppDesc()!=0)&&($("#custModifyId").is(":hidden"))){$("#a-cust-modify").show()}};var o=function(U){var V=a;V.prodPwd=$.trim($("#authPassword").val());V.authFlag=k;$.callServiceAsHtml(contextPath+"/cust/custAuth",V,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(W){if(W.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}O=V;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;t(W)},always:function(){$.unecOverlay()}})};var I=function(){if(order.cust.mgr.jumpAuthflag!="0"){$.alert("提示","没有跳过校验权限！");return}var U=a;U.authFlag="1";$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",U,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(V){if(V.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}O=U;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;t(V)},always:function(){$.unecOverlay()}})};var t=function(U){if(k=="0"){$("#dlg-chk-auth").popup("close")}$("#custQueryFirstForm").hide();$("#custInfo").html(U.data).show().enhanceWithin();if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){$("#a-cust-modify").hide()}else{$("#a-cust-modify").show();$("#a-cust-modify").off("tap").on("tap",order.prodModify.showCustInfoModify)}$("#a-cust-rechk").off("tap").on("tap",E);$("#a-qry-cust-prod").off("tap").on("tap",S);$("#cCustName").val("");$("#cCustIdCard").val("");main.home.hideMainIco()};var b=function(U){var V=$(U);a={custId:V.attr("custId"),partyName:V.attr("partyName"),idCardNumber:V.attr("idCardNumber"),identityName:V.attr("identityName"),areaName:V.attr("areaName"),areaId:V.attr("areaId"),identityCd:V.attr("identityCd"),addressStr:V.attr("addressStr"),norTaxPayer:V.attr("norTaxPayer"),segmentId:V.attr("segmentId"),segmentName:V.attr("segmentName"),custFlag:V.attr("custFlag"),vipLevel:V.attr("vipLevel"),vipLevelName:V.attr("vipLevelName")};if(k=="0"){if(order.cust.mgr.authType=="00"){$("#custAuthTypeName").html("客户密码：")}else{$("#custAuthTypeName").html("产品密码：")}if(order.cust.mgr.jumpAuthflag=="0"){$("#jumpAuth").show();$("#jumpAuth").off("tap").on("tap",I)}else{$("#jumpAuth").hide()}$("#authPassword").val("");$("#custAuthbtn").off("tap").on("tap",i);$("#dlg-chk-auth").popup("open")}else{o(U)}};var v=function(){var U=$("#p_cust_areaId").val();if(U.indexOf("0000")>0){$.alert("提示","前页受理地区为省级地区无法进行创建,请先选择市级地区！");return}$.callServiceAsHtmlGet(contextPath+"/pad/cust/create.html",{},{done:function(W){if(!W||!W.data){return}var V=$.popup("#div_cust_create",W.data,{cache:true,width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}}});$("#div_cust_create input[type='text']").val("");r($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");u();V.find("div[data-role='collapsible']").collapsible({collapsed:true,collapse:function(X,Y){$("#contactName").attr("data-validate","");g()},expand:function(X,Y){$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(blur)").attr("placeholder","请准确填写联系人名称");g()}})}})};var p=function(V){$("#plan2ndDiv tbody tr").removeClass("plan_select2");$("#plan2ndDiv tbody tr").children(":first-child").next().html("");$(V).addClass("plan_select2");var U="<i class='select'></i>";$(V).children(":first-child").next().html(U);order.prodModify.getChooseProdInfo()};_btnQueryCustProdPrepare=function(){$.callServiceAsHtmlGet(contextPath+"/pad/cust/orderProdPrepare.html",{diffPlaceFlag:$("#diffPlaceFlag").val()},{before:function(){},always:function(){},done:function(U){if(!U||U.code!=0){$.alert("提示","已订购业务查询失败,稍后重试");return}$.popup("#dlg_cust_prod",U.data,{width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){},cache:true});$(".ui-panel-inner > .ui-listview").height($(window).height());N(1)}})};var S=function(){if(OrderInfo.cust.custId==-1){$.alert("提示","新建客户无法查询已订购业务！");return}if(w==""){_btnQueryCustProdPrepare();w="1"}else{if(w=="1"){$("#dlg_cust_prod").popup("open",{transition:"slide"});w="1"}else{$("#dlg_cust_prod").popup("close");w="1"}}};var N=function(W,U){var X={};if(!a||!$.isPlainObject(a)||$.isEmptyObject(a)){X.custId=""}else{X.custId=a.custId;X.areaId=$("#area").attr("areaId")}if($("#accNbrQuery").length==1){X.acctNbr=$.trim($("#accNbrQuery").val());if(CONST.getAppDesc()==0){X.areaId=$("#p_cust_areaId").val()}}else{if($("#isAppointNum").attr("value")=="1"){X.acctNbr=$.trim($("#p_cust_identityNum").val());if(CONST.getAppDesc()==0){X.areaId=$("#p_cust_areaId").val()}}else{X.acctNbr=""}}X.pageSize="8";X.curPage=W;if(!(X.custId)||X.custId==""){$.alert("提示","无法查询已订购产品");return}var V=contextPath+"/pad/cust/orderprod";$.callServiceAsHtmlGet(V,X,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(Y){if(!Y||Y.code!=0){$.alert("提示","查询失败,稍后重试");return}var Z=$("#dlg_cust_prod").find("ul:first");if(W==1){Z.html(Y.data)}else{Z.append(Y.data)}Z.listview().listview("refresh");Z.find("li").off("tap").on("tap",function(){var aa=$(this);if(aa.hasClass("multi")){if(aa.next(".multidiv").is(":hidden")){aa.next(".multidiv").show().siblings(".multidiv").hide()}else{aa.next(".multidiv").hide().siblings(".multidiv").hide()}}j(this,function(){aa.addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg");$("#div_2nd_order").panel("open")
})});Z.find("div.multidiv li").off("tap").on("tap",function(){j(this,function(){$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").parent().siblings("li").removeClass("userorderlistlibg");$("#div_2nd_order").panel("open");order.prodModify.getChooseProdInfo()})});Z.find("li:first").trigger("tap").next("div.multidiv li:first").trigger("tap");order.prodModify.getChooseProdInfo()}})};var j=function(V,U){if(1==OrderInfo.order.step&&(!$(V).hasClass("userorderlistlibg"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){s();OrderInfo.order.step=0;U.apply(this,[])},no:function(){}})}else{if(2==OrderInfo.order.step&&(!$(V).hasClass("userorderlistlibg"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();s();OrderInfo.order.step=0;U.apply(this,[])},no:function(){}})}else{U.apply(this,[])}}};var y=function(){order.pad.area.chooseAreaTree("order/prepare","p_cust_areaId_val","p_cust_areaId",3)};var C=function(){order.area.chooseAreaTreeManger("cust/preQueryCust","p_areaId_val","p_areaId",3)};var Q=function(){order.area.chooseAreaTreeAll("p_cust_areaId_val","p_cust_areaId",3,"limitProvince")};var d=function(){order.area.chooseAreaTree("order/prepare","p_ncust_areaId_val","p_ncust_areaId",3)};var B=function(){order.area.chooseAreaTree("order/prepare","prodareaName","prodareaid",3);order.prodModify.choosedProdInfo.areaId=$("#prodareaid").val()};var K=function(){$("#p_cust_identityCd").off("change").on("change",function(){G($(this).find("option:selected"),"p_cust_identityNum");$("#p_cust_identityCd").selectmenu().selectmenu("refresh")});h("-1","p_cust_identityCd");$("#isAppointNum").off("change").on("change",T);R();$("#a_user_create").off("tap").on("tap",v);e()};var R=function(){if($("#fromProvFlag").length&&$("#fromProvFlag").val()=="1"){order.cust.mgr.fromProvFlag="1";order.cust.mgr.provIsale=$("#provIsale").val();$("#p_cust_areaId_val").val("");$("#p_cust_areaId").val($("#provAreaId").val());$("#p_cust_identityCd").val($("#provIdentityCd").val());$("#p_cust_identityNum").val($("#provIdentityNum").val());if($("#provIdentityCd").val()!=-1){$("#isAppointNum").attr("checked",false)}$("#a_user_search").click()}else{order.cust.fromProvFlag="0";order.cust.provIsale=null}};var u=function(){$.callServiceAsHtmlGet(contextPath+"/pad/cust/partyProfileSpecList",{},{before:function(){$.ecOverlay("<strong>加载更多属性,请稍等...</strong>")},always:function(){$.unecOverlay()},fail:function(){$.alert("提示","属性加载异常,请稍后重试.");$.unecOverlay()},done:function(V){if(V.code==-2){return}var U=$("#partyProfile").html(V.data);$("#otabs li").on("tap",function(){M($(this))});$.jqmRefresh(U)}})};var n=function(V){var U={partyId:V,areaId:$("#p_areaId").val()};$.callServiceAsHtml(contextPath+"/cust/custInfo",U,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(W){if(W.code==-2){return}if(!W){W.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(W.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(W.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctDetail").html(W.data).show();$("#acctList").hide()},fail:function(W){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var F=function(){createCustInfo={cAreaId:OrderInfo.staff.soAreaId,cAreaName:OrderInfo.staff.soAreaName,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cPartyTypeName:($.trim($("#partyTypeCd  option:selected").val())==1)?"个人客户":"政企客户",cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val()),cMailAddressStr:$.trim($("#cMailAddressStr").val())};var U={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$.trim($("#headFlag  option:selected").val()),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postcode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};OrderInfo.boCustInfos.name=createCustInfo.cCustName;OrderInfo.boCustInfos.areaId=createCustInfo.cAreaId;OrderInfo.boCustInfos.partyTypeCd=createCustInfo.cPartyTypeCd;OrderInfo.boCustInfos.defaultIdType=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustInfos.addressStr=createCustInfo.cAddressStr;OrderInfo.boCustInfos.mailAddressStr=createCustInfo.cMailAddressStr;OrderInfo.boCustIdentities.identidiesTypeCd=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustIdentities.identityNum=createCustInfo.cCustIdCard;OrderInfo.boPartyContactInfo.contactAddress=U.contactAddress,OrderInfo.boPartyContactInfo.contactDesc=U.contactDesc,OrderInfo.boPartyContactInfo.contactEmployer=U.contactEmployer,OrderInfo.boPartyContactInfo.contactGender=U.contactGender,OrderInfo.boPartyContactInfo.contactId=U.contactId,OrderInfo.boPartyContactInfo.contactName=U.contactName,OrderInfo.boPartyContactInfo.contactType=U.contactType,OrderInfo.boPartyContactInfo.eMail=U.eMail,OrderInfo.boPartyContactInfo.fax=U.fax,OrderInfo.boPartyContactInfo.headFlag=U.headFlag,OrderInfo.boPartyContactInfo.homePhone=U.homePhone,OrderInfo.boPartyContactInfo.mobilePhone=U.mobilePhone,OrderInfo.boPartyContactInfo.officePhone=U.officePhone,OrderInfo.boPartyContactInfo.postAddress=U.postAddress,OrderInfo.boPartyContactInfo.postcode=U.postcode,OrderInfo.boPartyContactInfo.staffId=U.staffId,OrderInfo.boPartyContactInfo.state=U.state,OrderInfo.boPartyContactInfo.statusCd=U.statusCd;OrderInfo.cust={custId:-1,partyName:createCustInfo.cCustName,areaId:createCustInfo.cAreaId};OrderInfo.boCustProfiles=[];for(var V=0;V<H.length;V++){var X=H[V];var W=$("#"+X.attrId).val();if(""==W||undefined==W){W==$("#"+X.attrId+"option:selected").val()}var X={partyProfileCatgCd:X.attrId,profileValue:W,state:"ADD"};if(""!=W&&W!=undefined){OrderInfo.boCustProfiles.push(X)}}$("#div_cust_create").popup("close");var Y={};Y.prodPwd="";Y.accessNumber="";Y.authFlag="1";authFlag="";Y.identityCd=createCustInfo.cIdentidiesTypeCd;Y.idCardNumber=createCustInfo.cCustIdCard;Y.partyName=createCustInfo.cCustName;Y.areaId=createCustInfo.cAreaId;Y.areaName=createCustInfo.cAreaName;Y.segmentName=createCustInfo.cPartyTypeName;Y.identityName=$("#identidiesTypeCd option:selected").text();$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",Y,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(Z){if(Z.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(Z.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}t(Z)},always:function(){$.unecOverlay()}})};var m=function(){var Z=$("#p_cust_areaId").val();if(Z==null||Z==""){Z=OrderInfo.staff.areaId}var W=$("#p_cust_areaId_val").val();createCustInfo={cAreaId:Z,cAreaName:W,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd option:selected").val()),cIdentidiesTypeCd:$.trim($("#identidiesTypeCd option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};diffPlace=$("#DiffPlaceFlag").val();var Y={acctNbr:"",identityCd:createCustInfo.cIdentidiesTypeCd,identityNum:createCustInfo.cCustIdCard,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:createCustInfo.cAreaId};var V=contextPath+"/pad/cust/checkIdentity";var U=$.callServiceAsJson(V,Y,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});var X="";if(U.code==0){$.unecOverlay();$.confirm("确认","此证件号码已存在,是否确认新建?",{yes:function(){F()},no:function(){}})}else{$.unecOverlay();F()}};var M=function(U){var X=$(U).attr("tabid");
if(X!="0"&&$("#contactName").val()==""){$("#contactName").blur();return}var V=$(U).index();var W=$("#otabs-body > div");$(U).parent().children("li").attr("class","otab-nav");$(U).attr("class","otab-nav-action");$(U).parent().children("li").find(".ui-input-search").hide();$(U).parent().children("li").find(".ui-select").hide();$(U).children("div").show();W.hide();W.eq(V).show()};var T=function(){if(!D){D=true;if($("#p_cust_identityCd").find("option:selected").val()!=-1){$.alertSync("提示","只能接入号码才能指定号码！","information",function(){$("#isAppointNum").val("0").slider().slider("refresh");D=false})}}};var s=function(){var U=OrderInfo.boProd2Tds;if(U.length>0){for(var X=0;X<U.length;X++){var W={numType:2,numValue:U[X].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",W)}}var V=OrderInfo.boProdAns;if(V.length>0){for(var X=0;X<V.length;X++){if(V[X].idFlag){continue}var W={numType:1,numValue:V[X].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",W)}order.service.boProdAn={};order.phoneNumber.resetBoProdAn()}$("#order_fill_content").empty();order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show()};var A=function(){$("#acctDetail").hide();$("#acctList").show()};return{showCustAuth:b,showCustCreate:v,custAuth:o,getCustInfo:x,custReset:E,btnQueryCustProd:N,btnQueryCustProdMore:S,jumpAuth:I,identidiesTypeCdChoose:f,custidentidiesTypeCdChoose:G,choosedCustInfo:a,partyTypeCdChoose:r,chooseArea:y,chooseAllArea:Q,newCustChooseArea:d,prodChooseArea:B,init:K,partyProfiles:H,profileTabLists:q,queryCustDetail:n,changeLabel:M,jumpAuthflag:z,orderBtnflag:w,custCreateButton:g,isAppointNum:T,preQueryCustChooseArea:C,linkSelectPlan:p,back:A,fromProvFlag:J,provIsale:l}})();CommonUtils.regNamespace("cust");cust=(function(){var e=function(){$("#cmCustName").val("");$("#cmAddressStr").val("");$("#telNumber").val("");$("#mailAddressStr").val("");$("#cmCustIdCard").val("");$("#cmCustIdCardOther").val("");cust.validatorForm()};var r=function(){$("#custFormdata").data("bootstrapValidator").validate();if($("#custFormdata").data("bootstrapValidator").isValid()){k()}};var u=function(){OrderInfo.cust.custId=-1;OrderInfo.cust.partyName=$("#cmCustName").val();OrderInfo.cust.areaId=OrderInfo.staff.areaId;OrderInfo.cust.telNumber=$("#telNumber").val();OrderInfo.cust.addressStr=$("#cmAddressStr").val();OrderInfo.cust.mailAddressStr=$("#mailAddressStr").val();OrderInfo.cust.identityCd=$("#cm_identidiesTypeCd").val();if($.trim($("#contactName").val()).length>0){OrderInfo.boPartyContactInfo.contactName=$.trim($("#contactName").val());OrderInfo.boPartyContactInfo.mobilePhone=$.trim($("#mobilePhone").val());OrderInfo.boPartyContactInfo.contactAddress=$.trim($("#contactAddress").val())}if(OrderInfo.cust.identityCd==1){OrderInfo.cust.identityNum=$("#cmCustIdCard").val()}else{OrderInfo.cust.identityNum=$("#cmCustIdCardOther").val()}var v=$("#flag").val();if(ec.util.isObj(v)){var w={boCustInfos:[],boCustIdentities:[],boPartyContactInfo:[]};b();w.boCustInfos.push(OrderInfo.boCustInfos);w.boCustIdentities.push(OrderInfo.boCustIdentities);if($.trim($("#contactName").val()).length>0){w.boPartyContactInfo.push(OrderInfo.boPartyContactInfo)}SoOrder.submitOrder(w)}else{common.saveCust()}};var b=function(){OrderInfo.boCustInfos.name=OrderInfo.cust.partyName;OrderInfo.boCustInfos.areaId=OrderInfo.staff.areaId;OrderInfo.boCustInfos.partyTypeCd=1;OrderInfo.boCustInfos.defaultIdType=1;OrderInfo.boCustInfos.addressStr=OrderInfo.cust.addressStr;OrderInfo.boCustInfos.telNumber=OrderInfo.cust.telNumber;OrderInfo.boCustInfos.mailAddressStr=OrderInfo.cust.mailAddressStr;OrderInfo.boCustInfos.state="ADD";OrderInfo.boCustIdentities.identidiesTypeCd=OrderInfo.cust.identityCd;OrderInfo.boCustIdentities.identityNum=OrderInfo.cust.identityNum;OrderInfo.boCustIdentities.isDefault="Y";OrderInfo.boCustIdentities.state="ADD"};var n=function(){$("#custFormdata").data("bootstrapValidator").validate();if($("#custFormdata").data("bootstrapValidator").isValid()){var v={};v.boCustInfos=[{areaId:OrderInfo.cust.areaId,name:$("#boCustIdentities").attr("partyName"),norTaxPayerId:"0",partyTypeCd:$("#boCustIdentities").attr("partyTypeCd"),addressStr:$("#boCustIdentities").attr("addressStr"),state:"DEL"},{areaId:OrderInfo.cust.areaId,name:modifyCustInfo.custName,norTaxPayerId:"0",partyTypeCd:$("#cmPartyTypeCd").val(),addressStr:modifyCustInfo.addressStr,state:"ADD"}];if(!ec.util.isObj(OrderInfo.cust.idCardNumber)){v.boCustIdentities=[{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD"}]}else{v.boCustIdentities=[{identidiesTypeCd:OrderInfo.cust.identityCd,identityNum:OrderInfo.cust.idCardNumber,isDefault:"Y",state:"DEL"},{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD"}]}SoOrder.submitOrder(v)}};var k=function(){var A=OrderInfo.staff.areaId;if(A==null||A==""){A=OrderInfo.staff.areaId}var x=$("#p_cust_areaId_val").val();createCustInfo={cAreaId:A,cAreaName:x,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};diffPlace=$("#DiffPlaceFlag").val();var z={acctNbr:"",identityCd:createCustInfo.cIdentidiesTypeCd,identityNum:createCustInfo.cCustIdCard,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:createCustInfo.cAreaId};var w=contextPath+"/app/cust/checkIdentity";var v=$.callServiceAsJson(w,z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});var y="";if(v.code==0){$.unecOverlay();$.confirm("确认","此证件号码已存在,是否确认新建?",{yes:function(){u()},no:function(){}})}else{$.unecOverlay();u()}};var f=function(){$("#custInfoModifyBtn").off("click").on("click",function(x){$("#custFormdata").data("bootstrapValidator").validate();if($("#custFormdata").data("bootstrapValidator").isValid()){var z={};z={custName:$.trim($("#cmCustName").val()),identidiesTypeCd:$("#div_cm_identidiesType  option:selected").val(),custIdCard:$.trim($("#cmCustIdCard").val()),addressStr:$.trim($("#cmAddressStr").val())};var y={};y.boCustInfos=[{areaId:OrderInfo.cust.areaId,name:$("#boCustIdentities").attr("partyName"),norTaxPayerId:"0",partyTypeCd:$("#boCustIdentities").attr("partyTypeCd"),addressStr:$("#boCustIdentities").attr("addressStr"),state:"DEL"},{areaId:OrderInfo.cust.areaId,name:z.custName,norTaxPayerId:"0",partyTypeCd:$("#cmPartyTypeCd").val(),addressStr:z.addressStr,state:"ADD"}];if(!ec.util.isObj(OrderInfo.cust.idCardNumber)){y.boCustIdentities=[{identidiesTypeCd:z.identidiesTypeCd,identityNum:z.custIdCard,isDefault:"Y",state:"ADD"}]}else{y.boCustIdentities=[{identidiesTypeCd:OrderInfo.cust.identityCd,identityNum:OrderInfo.cust.idCardNumber,isDefault:"Y",state:"DEL"},{identidiesTypeCd:z.identidiesTypeCd,identityNum:z.custIdCard,isDefault:"Y",state:"ADD"}]}y.boPartyContactInfo=[];var v={contactId:$("#contactIdOld").val(),statusCd:"100001",contactName:$("#contactNameOld").val(),headFlag:$("#headFlagOld").val(),state:"DEL"};var w={contactAddress:$.trim($("#contactAddress").val()),contactId:"",contactName:$.trim($("#contactName").val()),mobilePhone:$.trim($("#mobilePhone").val()),headFlag:$("#headFlag").val(),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};if(ec.util.isObj(v.contactId)){y.boPartyContactInfo.push(v);y.boPartyContactInfo.push(w)}else{if(ec.util.isObj($.trim($("#contactName").val()))){y.boPartyContactInfo.push(w)}}SoOrder.submitOrder(y)}})};var a=function(w){var v=$(w).val();$("#cm_identidiesTypeCd").empty();o(v);c($("#div_cm_identidiesType").children(":first-child"))};var o=function(v){var x={partyTypeCd:v};var w=contextPath+"/cust/queryCertType";var y=$.callServiceAsJson(w,x,{});if(y.code==-2){$.alertM(y.data)}if(y.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置");return}if(y.code==0){var z=y.data;
var B=$("#currentCT").val();var C=false;if(B==CONST.CHANNEL_TYPE_CD.ZQZXDL||B==CONST.CHANNEL_TYPE_CD.GZZXDL||B==CONST.CHANNEL_TYPE_CD.HYKHZXDL||B==CONST.CHANNEL_TYPE_CD.SYKHZXDL||B==CONST.CHANNEL_TYPE_CD.XYKHZXDL||B==CONST.CHANNEL_TYPE_CD.GZZXJL||B==CONST.CHANNEL_TYPE_CD.ZYOUT||B==CONST.CHANNEL_TYPE_CD.ZYINGT||B==CONST.CHANNEL_TYPE_CD.WBT){C=true}if(z!=undefined&&z.length>0){for(var A=0;A<z.length;A++){var D=z[A];if(D.certTypeCd=="1"){$("#cm_identidiesTypeCd").append("<option value='"+D.certTypeCd+"' >"+D.name+"</option>")}else{if(C){$("#cm_identidiesTypeCd").append("<option value='"+D.certTypeCd+"' >"+D.name+"</option>")}}}}}};var c=function(v){var w=$(v).val();if(w==undefined){w=$("#div_cm_identidiesType  option:selected").val()}$("#cmCustName").removeAttr("readonly");$("#cmCustIdCard").removeAttr("readonly");$("#cmAddressStr").removeAttr("readonly");if(w==1){$("#cmCustIdCard").attr("placeHolder","请输入合法身份证号码");$("#div-cmcustidcard").show();$("#div-cmcustidcard-none").hide();$("#cmCustName").attr("readonly","readonly");$("#cmCustIdCard").attr("readonly","readonly");$("#cmAddressStr").attr("readonly","readonly");$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",false,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",true,null)}else{if(w==2){$("#cmCustIdCardOther").attr("placeHolder","请输入合法军官证");$("#div-cmcustidcard-none").show();$("#div-cmcustidcard").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",true,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",false,null)}else{if(w==3){$("#cmCustIdCardOther").attr("placeHolder","请输入合法护照");$("#div-cmcustidcard-none").show();$("#div-cmcustidcard").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",true,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",false,null)}else{$("#cmCustIdCardOther").attr("placeHolder","请输入合法证件号码");$("#div-cmcustidcard-none").show();$("#div-cmcustidcard").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",true,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",false,null)}}}f()};var g=function(){$("#custFormdata").bootstrapValidator({message:"无效值",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},fields:{cmCustName:{trigger:"blur",validators:{notEmpty:{message:"客户姓名不能为空"}}},cmCustIdCard:{trigger:"blur",validators:{notEmpty:{message:"身份证号码不能为空"},regexp:{regexp:/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/,message:"请输入合法身份证号码"}}},cmCustIdCardOther:{trigger:"blur",validators:{notEmpty:{message:"证件号码不能为空"},regexp:{regexp:/^[0-9a-zA-Z]*$/g,message:"证件号码只能为数字或字母"}}},cmAddressStr:{trigger:"blur",validators:{notEmpty:{message:"证件地址不能为空"}}},mobilePhone:{trigger:"blur",validators:{regexp:{regexp:/(^\d{11}$)/,message:"手机号码只能为11数字"}}},phonenumber:{trigger:"blur",validators:{notEmpty:{message:"手机号码不能为空"}}}}})};var j=function(){a("#cmPartyTypeCd");$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected",true);c($("#cm_identidiesTypeCd option[selected='selected']"));OrderInfo.busitypeflag=12;var v=CONST.BO_ACTION_TYPE.ACTIVERETURN;OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,v,9,CONST.getBoActionTypeName(v),"");SoOrder.initFillPage()};var m=function(){cust.validatorForm();a("#cmPartyTypeCd");$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected",true);c($("#cm_identidiesTypeCd option[selected='selected']"));$("#newCustBtn").off("click").on("click",r);var v=CONST.BO_ACTION_TYPE.CUST_CREATE;OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,v,8,CONST.getBoActionTypeName(v),"");SoOrder.initFillPage()};var p=function(){cust.validatorForm();a("#cmPartyTypeCd");$("#cm_identidiesTypeCd").find("option[value="+$("#zjlx").val()+"]").attr("selected","selected");$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected",true);c($("#cm_identidiesTypeCd option[selected='selected']"));$("#updateCustBtn").off("click").on("click",n);var v=CONST.BO_ACTION_TYPE.CUSTINFOMODIFY;OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,v,4,CONST.getBoActionTypeName(v),"");SoOrder.initFillPage()};var h=function(x,y,w,v){$("#cmCustName").val(x);$("#cm_identidiesTypeCd").val("1");$("#cm_identidiesTypeCd").change();$("#cmCustIdCard").val(y);$("#cmAddressStr").val(w);$("#photos").attr("src","data:image/jpg;base64,"+v)};var t=function(v){$("#photos").attr("src","data:image/jpg;base64,"+v)};var q=function(w,x,v){$("#cmCustName").val(w);$("#cm_identidiesTypeCd").val("1");$("#cm_identidiesTypeCd").change();$("#cmCustIdCard").val(x);$("#cmAddressStr").val(v)};var l=function(){var v={};$.callServiceAsHtml(contextPath+"/app/cust/custQueryAdd",v,{before:function(){$.ecOverlay("加载中请稍等...")},always:function(){$.unecOverlay()},done:function(w){$("#order-content").hide();$("#cust").html(w.data).show()},fail:function(){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var d=function(w,v){var y=1;if(w>0){y=w}var z=$("#p_startDt").val().replace(/-/g,"");var x=$("#p_endDt").val().replace(/-/g,"");if(z>x){$.alert("提示","起始时间不能大于结束时间！");return}else{param={startDt:($("#p_startDt").val()).replace(/-/g,""),endDt:($("#p_endDt").val()).replace(/-/g,""),nowPage:y,pageSize:10};$.callServiceAsHtml(contextPath+"/app/cust/custQueryAddList",param,{before:function(){$.ecOverlay("查询中请稍等...")},always:function(){$.unecOverlay()},done:function(A){if(A&&A.code==-2){return}else{if(y==1){$("#cust_search").hide();$("#cust_list").html(A.data).show();$("#cust_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(v&&$.isFunction(v)){v.apply(this,[])}}if(y>1){$("#all_cust_list").append(A.data);$("#cust_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(v&&$.isFunction(v)){v.apply(this,[])}}}},fail:function(){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})}};var i=function(v){if(v&&v.page&&v.page>=1){d(v.page,v.scroll)}};var s=function(B,H,E,D){var v={acctNbr:"",areaId:H,diffPlace:"local",identidies_type:"",identityCd:"",identityNum:"",olTypeCd:"8",operType:E,partyName:"",prodClass:"12",queryType:"",queryTypeValue:""};if(E==1){v.queryTypeValue=B;v.identidies_type="客户编码";v.queryType="custNumber"}else{v.acctNbr=B;v.identidies_type="接入号码"}$.ecOverlay("<strong>正在查询客户架构信息中,请稍等...</strong>");var x=$.callServiceAsJson(contextPath+"/token/pc/cust/queryCustCompreInfo",v);$.unecOverlay();if(x.code==0){if(x.data==null){$.alert("提示","客户架构信息接口无数据返回。");return false}if(x.data.custInfos==undefined){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return false}else{if(!ec.util.isArray(x.data.custInfos)){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return false}}if(x.data.prodInstInfos==undefined&&E!=1){$.alert("提示","客户下没有可以办理业务的移动用户。");return false}if(x.data.offerMemberInfos==undefined&&E!=1){$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理。");return false}if(D=="OLD"){var w=x.data.custInfos;if(OrderInfo.actionFlag!=1&&w[0].custId!=OrderInfo.cust.custId){$.alert("提示",B+"和主卡的客户不一致！");return false}var G={};var y=x.data.prodInstInfos;$.each(y,function(){if(this.accNbr==B){G=this;if(G.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示",B+"不是在用产品！");return false}if(OrderInfo.actionFlag!=1&&G.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){$.alert("提示",B+"和主卡的付费类型不一致！");return false}if(G.productId=="280000000"){$.alert("提示",B+"是无线宽带，不能纳入！");return false}G.custId=w[0].custId;OrderInfo.oldprodInstInfos.push(G)}});var C=true;for(var A=0;A<x.data.offerMemberInfos.length;A++){var z=x.data.offerMemberInfos[A];if(z.objType==""){$.alert("提示","销售品实例构成 "+z.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(z.objType==CONST.OBJ_TYPE.PROD){if(z.accessNumber==""){$.alert("提示","销售品实例构成 "+z.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
return false}}}if(z.objInstId==G.prodInstId){C=false}}if(C){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+G.accNbr+"】，无法继续受理，请业务后台核实");return false}var F={offerMemberInfos:x.data.offerMemberInfos,offerId:G.mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:G.mainProdOfferInstInfos[0].prodOfferId,offerSpecName:G.mainProdOfferInstInfos[0].prodOfferName,accNbr:G.accNbr};OrderInfo.oldoffer.push(F);order.memberChange.viceCartNum=0;$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){order.memberChange.viceCartNum++}})})}else{var w=x.data.custInfos;OrderInfo.cust={addressStr:w[0].addressStr,areaId:w[0].areaId,areaName:w[0].areaName,authFlag:w[0].authType,custFlag:w[0].custFlag,custId:w[0].custId,idCardNumber:w[0].idCardNumber,identityCd:w[0].identityCd,identityName:w[0].identityName,norTaxPayer:"",partyName:w[0].partyName,segmentId:w[0].segmentId,segmentName:w[0].segmentName,vipLevel:w[0].vipLevel,vipLevelName:w[0].vipLevelName};if(E!=1){var G=x.data.prodInstInfos;order.prodModify.choosedProdInfo={accNbr:G[0].accNbr,areaCode:G[0].zoneNumber,areaId:G[0].areaId,corProdInstId:G[0].corProdInstId,custId:G[0].mainProdOfferInstInfos[0].custId,custName:G[0].mainProdOfferInstInfos[0].custName,endDt:G[0].mainProdOfferInstInfos[0].endDt,extProdInstId:G[0].extProductId,feeType:G[0].feeType.feeType,feeTypeName:G[0].feeType.feeTypeName,is3G:G[0].mainProdOfferInstInfos[0].is3G,prodBigClass:G[0].prodBigClass,prodClass:G[0].prodClass,prodInstId:G[0].prodInstId,prodOfferId:G[0].mainProdOfferInstInfos[0].prodOfferId,prodOfferInstId:G[0].mainProdOfferInstInfos[0].prodOfferInstId,prodOfferName:G[0].mainProdOfferInstInfos[0].prodOfferName,prodStateCd:G[0].prodStateCd,prodStateName:G[0].prodStateName,productId:G[0].productId,productName:G[0].productName,startDt:G[0].mainProdOfferInstInfos[0].startDt,stopRecordCd:G[0].prodStopRecords[0].stopRecordCd,stopRecordName:G[0].prodStopRecords[0].stopRecordName};var C=true;for(var A=0;A<x.data.offerMemberInfos.length;A++){var z=x.data.offerMemberInfos[A];if(z.objType==""){$.alert("提示","销售品实例构成 "+z.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(z.objType==CONST.OBJ_TYPE.PROD){if(z.accessNumber==""){$.alert("提示","销售品实例构成 "+z.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(z.objInstId==order.prodModify.choosedProdInfo.prodInstId){C=false}}if(C){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+order.prodModify.choosedProdInfo.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=x.data.offerMemberInfos;OrderInfo.offer.offerId=order.prodModify.choosedProdInfo.prodOfferInstId;OrderInfo.offer.offerSpecId=order.prodModify.choosedProdInfo.prodOfferId;OrderInfo.offer.offerSpecName=order.prodModify.choosedProdInfo.prodOfferName}}}else{$.alertM(x.data);return false}return true};return{scroll:i,custQueryAddList:d,custQueryAdd:l,getIdentidiesTypeCd:j,identidiesTypeCdChoose:c,validatorForm:g,initNewCust:m,initUpdateCust:p,clearCustForm:e,getCustInfo:b,getGenerationInfos:q,getIDCardInfos:h,getPicture:t,queryCustCompreInfo:s}})();CommonUtils.regNamespace("cart","main");cart.main=(function(){var d=function(l,k){OrderInfo.actionFlag=40;var n=1;if(l>0){n=l}var m=$("#p_qryNumber").val();var o={};if($("#if_p_olNbr").is(":checked")){$("#cartFormdata").data("bootstrapValidator").enableFieldValidators("p_olNbr",true,null);$("#cartFormdata").data("bootstrapValidator").enableFieldValidators("p_qryNumber",false,null);$("#cartFormdata").data("bootstrapValidator").enableFieldValidators("p_channelId",false,null);$("#cartFormdata").data("bootstrapValidator").validate();if(!$("#cartFormdata").data("bootstrapValidator").isValid()){return}o={areaId:$("#p_areaId").val(),olNbr:$("#p_olNbr").val(),qryBusiOrder:$("#p_qryBusiOrder").val(),startDt:"",endDt:"",qryNumber:"",channelId:"",olStatusCd:"",busiStatusCd:"",nowPage:n,pageSize:10}}else{o={startDt:($("#p_startDt").val()).replace(/-/g,""),endDt:($("#p_startDt").val()).replace(/-/g,""),qryNumber:m,olStatusCd:$("#p_olStatusCd").val(),busiStatusCd:$("#p_busiStatusCd").val(),olNbr:"",qryBusiOrder:$("#p_qryBusiOrder").val(),channelId:$("#p_channelId").val(),areaId:$("#p_channelId").attr("areaid"),nowPage:n,pageSize:10}}$.callServiceAsHtmlGet(contextPath+"/app/report/cartList",o,{before:function(){$.ecOverlay("购物车查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(p){if(p&&p.code==-2){return}else{$("#cart_search").hide();$("#cart_list").html(p.data).show();OrderInfo.order.step=2;$("#cart_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(k&&$.isFunction(k)){k.apply(this,[])}}},fail:function(p){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var b=function(){if($("#p_channelId").val()!=""){$("#p_areaId_val").attr("disabled",true)}else{$("#p_areaId_val").attr("disabled",false)}};var c=function(k){if(k&&k.page&&k.page>=1){d(k.page,k.scroll)}};var a=function(){if($("#if_p_olNbr").is(":checked")){$("#p_areaId_val").attr("disabled",false);$("#p_olNbr").attr("disabled",false);$(".form_date").datetimepicker("remove");$("#p_qryNumber").attr("disabled",true);$("#p_olStatusCd").attr("disabled",true);$("#p_busiStatusCd").attr("disabled",true);$("#p_channelId").attr("disabled",true)}else{$("#p_olNbr").attr("disabled",true);$(".form_date").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0});$("#p_qryNumber").attr("disabled",false);$("#p_olStatusCd").attr("disabled",false);$("#p_busiStatusCd").attr("disabled",false);$("#p_channelId").attr("disabled",false);if($("#p_channelId").val()!=""){$("#p_areaId_val").attr("disabled",true)}else{$("#p_areaId_val").attr("disabled",false)}}$("select").addClass("styled-select")};var h=function(){$("#cartFormdata").bootstrapValidator({message:"无效值",feedbackIcons:{valid:"glyphicon glyphicon-ok",invalid:"glyphicon glyphicon-remove",validating:"glyphicon glyphicon-refresh"},fields:{p_qryNumber:{trigger:"blur",validators:{notEmpty:{message:"接入号和渠道不能同时为空"}}},p_olNbr:{trigger:"blur",validators:{notEmpty:{message:"购物车流水不能为空"}}},p_channelId:{trigger:"blur",validators:{notEmpty:{message:"接入号和渠道不能同时为空"}}}}})};var i=function(k){var l={olId:k};l.areaId=$("#p_areaId").val();$.callServiceAsHtmlGet(contextPath+"/app/report/cartInfo",l,{before:function(){$.ecOverlay("详情查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(m){if(m&&m.code==-2){return}else{$("#cart_list").hide();$("#cart_info").html(m.data).show();OrderInfo.order.step=3}},fail:function(m){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var f=function(k){var l={olId:$(k).attr("olid"),boId:$(k).attr("boid"),offerId:$(k).attr("offerid"),prodId:$(k).attr("prodid")};$.callServiceAsHtmlGet(contextPath+"/app/report/cartOfferInfo",l,{before:function(){$.ecOverlay("详情查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(m){if(m&&m.code==-2){return}else{$("#cart_info").hide();$("#cart_item_detail").html(m.data).show();OrderInfo.order.step=4}},fail:function(m){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var e=function(){OrderInfo.actionFlag=40;OrderInfo.order.step=1;var k={attrSpecCode:"EVT-0002"};$.callServiceAsJson(contextPath+"/app/staffMgr/getCTGMainData",k,{done:function(m){if(m.code==0){var o=m.data;if(o!=undefined&&o.length>0){for(var n=0;n<o.length;n++){var l=o[n];$("#p_busiStatusCd").append("<option value='"+l.attrValueCode+"' >"+l.attrValueName+"</option>");$("#p_olStatusCd").append("<option value='"+l.attrValueCode+"' >"+l.attrValueName+"</option>")}$("#p_busiStatusCd").addClass("styled-select");$("#p_olStatusCd").addClass("styled-select")}}else{if(m.code==-2){$.alertM(m.data);return}else{$.alert("提示","调用主数据接口失败！");return}}}})};var j=function(k){$("#p_start_input").val(k);$("#p_startDt").val(k)};var g=function(){if(OrderInfo.order.step==1){common.callCloseWebview()}else{if(OrderInfo.order.step==2){$("#cart_search").show();$("#cart_list").hide();OrderInfo.order.step=1}else{if(OrderInfo.order.step==3){$("#cart_list").show();
$("#cart_info").hide();OrderInfo.order.step=2}else{if(OrderInfo.order.step==4){$("#cart_info").show();$("#cart_item_detail").hide();OrderInfo.order.step=3}else{common.callCloseWebview()}}}}};return{cartBack:g,channelChange:b,queryCartList:d,queryCartInfo:i,initDic:e,olNbrChange:a,scroll:c,setCalendar:j,showOffer:f,validatorForm:h}})();CommonUtils.regNamespace("order","ysl");order.ysl=(function(){var m={yslflag:"ysl"};var K=[];var o=[];var U=0;var V="";var b="";var T="";var G;var k=function(){$("#identidiesTypeCd").empty();$("#cCustIdCard").val("");var X=$("#partyTypeCd").val();cust.validatorForm();if(X=="1"){$("#identidiesTypeCd").append('<option value="1">身份证</option><option value="2">军官证</option><option value="22">警官证</option><option value="3">护照</option><option value="4">港澳台通行证</option><option value="99">其它有效证件</option>')}else{if(X=="2"){$("#identidiesTypeCd").append('<option value="15">组织机构代码证</option><option value="6">工商执照</option><option value="99">其它有效证件</option>')}}$.refresh($("#zjlx"));g($("#identidiesTypeCd").children(":first-child"))};var g=function(X){var Y=$(X).val();if(Y==undefined){Y=$("#div_cm_identidiesType  option:selected").val()}$("#cmCustName").removeAttr("readonly");$("#cmCustIdCard").removeAttr("readonly");$("#cmAddressStr").removeAttr("readonly");if(Y==1){$("#cmCustIdCard").attr("placeHolder","请输入合法身份证号码");$("#cmCustName").attr("readonly","readonly");$("#cmCustIdCard").attr("readonly","readonly");$("#cmAddressStr").attr("readonly","readonly");$("#div-cmcustidcard").show();$("#div-cmcustidcard-none").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",false,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",true,null)}else{if(Y==2){$("#cmCustIdCardOther").attr("placeHolder","请输入合法军官证");$("#div-cmcustidcard-none").show();$("#div-cmcustidcard").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",true,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",false,null)}else{if(Y==3){$("#cmCustIdCardOther").attr("placeHolder","请输入合法护照");$("#div-cmcustidcard-none").show();$("#div-cmcustidcard").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",true,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",false,null)}else{$("#cmCustIdCardOther").attr("placeHolder","请输入合法证件号码");$("#div-cmcustidcard-none").show();$("#div-cmcustidcard").hide();$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCardOther",true,null);$("#custFormdata").data("bootstrapValidator").enableFieldValidators("cmCustIdCard",false,null)}}}};var C=function(){var X={attrSpecCode:"ACCT_ITEM_TYPE"};$.callServiceAsJson(contextPath+"/staffMgr/getCTGMainData",X,{done:function(Z){if(Z.code==0){var ab=Z.data;if(ab!=undefined&&ab.length>0){$("#payitems").hide();for(var aa=0;aa<ab.length;aa++){var Y=ab[aa];$("#selpayitems").append("<option value='"+Y.attrValueCode+"' >"+Y.attrValueName+"</option>")}$.refresh($("#feiyongitem"))}else{$("#selpayitems").next().hide();$("#payitems").show()}}else{$("#selpayitems").next().hide();$("#payitems").show()}}})};var t=function(){var Y=contextPath+"/app/order/querybusitype";var X=$.callServiceAsJson(Y,{});if(X.code==-2){$.alertM(X.data)}if(X.code==1002){$.alert("错误","查询业务类型无数据,请配置");return}if(X.code==0){var ab=X.data;if(ab!=undefined&&ab.length>0){for(var Z=0;Z<ab.length;Z++){var aa=ab[Z];$("#busitype").append("<option value='"+aa.busiTypeCd+"' >"+aa.busiTypeName+"</option>")}$("#busitype").addClass("styled-select")}}};var I=function(ae,af){if(af=="ysl"){$("#tcmc").html("套餐名称：");$("#tcuim").html("UIM卡号：");$("#tcuim").removeAttr("style");$("#tccphm").html("产品号码：");$("#tcname").show();$("#tcfflx").show();$("#tcbm").show();$("#tccpmm").show();$("#tccpgg").show();$("#tcxh").show();$("#tuim").show()}$("#busiactiontype").empty();var Y=$(ae).val();if(Y==""){return}var Z={busitypecd:Y};var X=contextPath+"/app/order/querybusiactiontype";var aa=$.callServiceAsJson(X,Z);if(aa.code==0){var ab=aa.data;if(ab!=undefined&&ab.length>0){for(var ac=0;ac<ab.length;ac++){var ad=ab[ac];$("#busiactiontype").append("<option value='"+ad.actionTypeCd+"' >"+ad.name+"</option>")}}else{$("#busiactiontype").append("<option value=''>请选择</option>")}$.refresh($("#ywdzc"));if(af=="ysl"){$("#taocan").show();$("#fushu").show();$("#zhongduan").show();$("#dealerAidDiv").show();$("#beizhu").show();$("#feiyong").show();$("#tijiao").show();if(Y=="3"){$("#tcmc").html("新套餐名称：");$("#tcuim").html("UIM卡号[3转4补换卡]：");$("#tcuim").css({width:"140px","margin-left":"-50px"});$("#tccphm").html("原产品号码：");$("#tcfflx").hide();$("#tccpmm").hide();$("#tcxh").hide();$("#zhongduan").hide()}else{if(Y=="4"){$("#tcuim").html("UIM卡号[3转4补换卡]：");$("#tcuim").css({width:"140px","margin-left":"-50px"});$("#tccphm").html("原产品号码：");$("#tcname").hide();$("#tcfflx").hide();$("#tcbm").hide();$("#tccpmm").hide();$("#tcxh").hide();$("#zhongduan").hide()}else{if(Y=="2"){$("#tcuim").html("新UIM卡号：");$("#tccphm").html("原产品号码：");$("#tcname").hide();$("#tcfflx").hide();$("#tcbm").hide();$("#tccpmm").hide();$("#tccpgg").hide();$("#tcxh").hide();$("#fushu").hide();$("#zhongduan").hide();$("#dealerAidDiv").hide()}else{if(Y=="5"||Y=="6"||Y=="7"||Y=="8"){$("#tccphm").html("原产品号码：");$("#tcname").hide();$("#tcfflx").hide();$("#tuim").hide();$("#tcbm").hide();$("#tccpmm").hide();$("#tccpgg").hide();$("#tcxh").hide();$("#fushu").hide();$("#zhongduan").hide();$("#dealerAidDiv").hide()}}}}}}};var M=function(){var X=$("#pwd").val();if(X=="******"){X=order.main.genRandPass6();$("#pwd").val(X)}};var e=function(){var X=$("#qryStr").val();var Y={subPage:"",qryStr:X,pnLevelId:"",custId:"",PageIndex:1,PageSize:10,orderflag:"ysl"};order.service.queryData(Y)};var W=function(Z,X){$("#offer_spec_name").val(X);$("#offer_spec_cd").val(Z);easyDialog.close();OrderInfo.actionFlag=1;OrderInfo.offerSpec.offerSpecId=Z;OrderInfo.offerSpec.offerSpecName=X;var Y=$("#dealerTbody").find("tr");Y.each(function(){if($(this).children().eq(0).html()=="主套餐"){$(this).remove()}});order.dealer.initDealer()};var Q=function(){OrderInfo.order.soNbr=UUID.getDataId();OrderInfo.cust.custId="-1";var X=$("#prodSpecId").val();var ab=$("#offer_spec_cd").val();var aa={prodId:"-1",prodSpecId:X,offerSpecIds:[ab],ifCommonUse:""};var Y=$("#search_text_-1").val();if(Y.replace(/\ /g,"")==""){$.alert("提示","请输入查询条件！");return}aa.offerSpecName=Y;var Z=query.offer.searchAttachOfferSpec(aa);if(Z!=undefined){$("#attach_div_-1").html(Z).show()}};var F=function(Y,aa,X){$("#prod_spec_cd").val(aa);$("#prod_spec_name").val(Y);for(var Z=0;Z<document.getElementById("prodtype").options.length;Z++){if(document.getElementById("prodtype").options[Z].value==X){document.getElementById("prodtype").options[Z].selected=true;break}}$.refresh($("#ywlxc2"));$("#attach_div_-1").hide()};var s=function(){var af=$("#prod_spec_cd").val();var Z=$("#prod_spec_name").val();var ah=$("#prodtype").val();var ad=$("#proactiontype").val();if(af==""||Z==""){$.alert("提示","产品编码或名称不能为空！");return}var aa="true";var Y=$("#openkxblist").find("a");var ag=$("#opengncplist").find("a");var ac=$("#closekxblist").find("a");var ab=$("#closegncplist").find("a");Y.each(function(){if($(this).attr("id")==af){aa="false";$.alert("提示","已添加该产品！");return}});ag.each(function(){if($(this).attr("id")==af){aa="false";$.alert("提示","已添加该产品！");return}});ac.each(function(){if($(this).attr("id")==af){aa="false";$.alert("提示","已添加该产品！");return}});ab.each(function(){if($(this).attr("id")==af){aa="false";$.alert("提示","已添加该产品！");return}});if(aa=="false"){return}var X='<a href="javascript:void(0);"  id='+af+' class="list-group-item"> <h5 class="list-group-item-heading">'+Z+"<span onclick=\"order.ysl.delprod('"+af+"','"+Z+"','"+ah+"','"+ad+'\')" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span></h5>';$("#myTab").find("li").removeClass("active");$("#myTabContent").find("div").removeClass("in");
$("#myTabContent").find("div").removeClass("active");if(ad=="ADD"){$("#openfushu").addClass("active");if(ah=="1"){$("#openkxblist").append(X);$("#openkxb").addClass("active");$("#openkxb").addClass("in")}else{$("#opengncplist").append(X);$("#opengncp").addClass("active");$("#opengncp").addClass("in")}}else{if(ad=="DEL"){$("#closefushu").addClass("active");if(ah=="1"){$("#closekxblist").append(X);$("#closekxb").addClass("active");$("#closekxb").addClass("in")}else{$("#closegncplist").append(X);$("#closegncp").addClass("active");$("#closegncp").addClass("in")}}}var ae={id:af,name:Z,type:ah,proactiontype:ad};order.ysl.openList.push(ae)};var J=function(ae,Z,ab,ac){var ad="<span onclick=\"order.ysl.delprod('"+ae+"','"+Z+"','"+ab+"','"+ac+'\')" class="glyphicon glyphicon-remove pull-right" aria-hidden="true"></span>';var X=$("#"+ae).find("h5");if(X.find("del")!=undefined&&X.find("del")!=null&&X.find("del").html()!=undefined){X.html(X.find("del").html()+ad);var Y={id:ae,name:Z,type:ab,proactiontype:ac};order.ysl.openList.push(Y)}else{X.html('<del class="text-warning">'+Z+"</del>"+ad);for(var aa=0;aa<order.ysl.openList.length;aa++){if(order.ysl.openList[aa].id==ae){order.ysl.openList.splice(aa,1)}}}};var n=function(X){if(X=="tc"){var Z=$("#offer_spec_name").val();var ab=$("#offer_spec_cd").val();if(ab!=""&&Z!=""){OrderInfo.actionFlag=1;OrderInfo.offerSpec.offerSpecId=ab;OrderInfo.offerSpec.offerSpecName=Z}}else{if(X=="kxb"){var Y=$("#choosedNumSpan").val();var aa=$("#dealerTbody").find("tr");aa.each(function(){if($(this).attr("name").indexOf("tr_-1_")!=-1){var ac=$(this).attr("name").substring(3);order.dealer.changeAccNbr(ac,Y)}})}}};var f=0;var l=function(){var Z="";var Y="";var ad=$("#paymoney").val();if(document.getElementById("payitems").style.display=="none"){Z=$("#selpayitems").find("option:selected").html();Y=$("#selpayitems").val()}else{Z=$("#payitems").val();Y=""}if(document.getElementById("payitems").style.display=="block"){if(Z==""){$.alert("提示","费用项不能为空！");return}}if(ad==""){$.alert("提示","金额不能为空！");return}else{ad=parseFloat($("#paymoney").val()).toFixed(2)}var ac="true";var ab=$("#payTbody").find("tr");ab.each(function(){if($(this).children("td").eq(0).html()==Z){ac="false";$.alert("提示","已添加该费用项！");return}});if(ac=="false"){return}var aa=$("#paytype").find("option:selected").html();var X=$("#paytype").val();f++;$("#payTbody").append("<tr id='paytr_"+f+"'><td acct_item_type_id='"+Y+"'>"+Z+"</td><td>"+ad+"</td><td paytypecd='"+X+"'>"+aa+'</td><td><span class="glyphicon glyphicon-remove pull-right" aria-hidden="true" onclick="order.ysl.delpay(\'paytr_'+f+"')\"></span></td></tr>")};var D=function(X){$("#"+X).remove()};var x=function(){if($("#cmCustName").val()==""){$.alert("提示","客户姓名不能为空！","information");return}var af="";if($("#identidiesTypeCd").val()==1){af=$("#cmCustIdCard").val()}else{af=$("#cmCustIdCardOther").val()}if(af==""){$.alert("提示","证件号码不能为空！","information");return}if($("#cmAddressStr").val()==""){$.alert("提示","客户地址不能为空！","information");return}var ae=$("#busitype").val();if(ae=="1"||ae=="3"){if($("#offer_spec_name").val()==""){$.alert("提示","套餐名称不能为空！","information");return}if($("#offer_spec_cd").val()==""){$.alert("提示","套餐编码不能为空！","information");return}}if(ae=="1"||ae=="3"||ae=="2"){if($("#uimcode").val()==""){$.alert("提示","UIM卡号不能为空！","information");return}}if($("#choosedNumSpan").val()==""){$.alert("提示","产品号码不能为空！","information");return}var ac=$("#pwd").val();var ah=$("#prodSpecId").val();var ag=$("#payment_type_cd").val();if(ae=="1"){if(ac==""){$.alert("提示","产品密码不能为空！","information");return}}else{ac="";ah="";ag=""}var ad={CUST_TYPE_CD:$("#partyTypeCd").val(),IDENTIDIES_TYPE_CD:$("#identidiesTypeCd").val(),IDENTITY_NUM:af,NAME:$("#cmCustName").val(),ADDRESS_STR:$("#cmAddressStr").val(),CONTACT_NO:$("#phonenumber").val(),BUSI_TYPE_CD:$("#busitype").val(),ACTION_TYPE_CD:$("#busiactiontype").val(),REMARKS:$("#order_remark").val(),PAYMENT_TYPE_CD:ag,uimcode:$("#uimcode").val(),ACCESS_NBR:$("#choosedNumSpan").val(),PROD_PWD:ac,PROD_SPEC_ID:ah,terminalcode:$("#terminalcode").val(),paytotal:0,openofferMap:{},dealerMap:{},paymentMap:{}};var Z={id:$("#offer_spec_cd").val(),name:$("#offer_spec_name").val(),type:"0",proactiontype:"ADD"};order.ysl.openList.push(Z);ad.openofferMap=order.ysl.openList;var X=$("#payTbody").find("tr");X.each(function(){var ak={ACCT_ITEM_TYPE_ID:"",ACCT_ITEM_TYPE:"",PAY_METHOD_CD:"",PAY_METHOD_TYPE:"",ACCT_ITEM_FEE:""};ak.ACCT_ITEM_TYPE_ID=$(this).children("td").eq(0).attr("acct_item_type_id");ak.ACCT_ITEM_TYPE=$(this).children("td").eq(0).html();ak.ACCT_ITEM_FEE=$(this).children().eq(1).html();ak.PAY_METHOD_CD=$(this).children("td").eq(2).attr("paytypecd");ak.PAY_METHOD_TYPE=$(this).children("td").eq(2).html();ad.paytotal+=parseInt(ak.ACCT_ITEM_FEE);order.ysl.paymentbean.push(ak)});ad.paymentMap=order.ysl.paymentbean;var Y=contextPath+"/app/order/suborderysl";var aa=$.callServiceAsJson(Y,ad);if(aa.code==-2){$.alertM(aa.data)}if(aa.code==1002){$.alertM(aa.data);return}if(aa.code==0){order.ysl.CUST_SO_NUMBER=aa.data.CUST_SO_NUMBER;order.ysl.CUST_ORDER_ID=aa.data.CUST_ORDER_ID;order.ysl.INVOICE_ID=aa.data.INVOICE_ID;$("#yslbuyid").html(aa.data.CUST_SO_NUMBER);$("#yslbuynum").html($("#choosedNumSpan").val());if(order.ysl.paymentbean.length>0){for(var ab=0;ab<order.ysl.paymentbean.length;ab++){var aj=order.ysl.paymentbean[ab];var ai="";var ai=ai+'<li class="list-group-item">';var ai=ai+'<h4 class="list-group-item-heading">费用名称</h4>';var ai=ai+'<p class="list-group-item-text" id="">'+aj.ACCT_ITEM_TYPE+"</p>";var ai=ai+'<h4 class="list-group-item-heading">费用（元）</h4>';var ai=ai+'<p class="list-group-item-text" id="">'+aj.ACCT_ITEM_FEE+"</p>";var ai=ai+'<h4 class="list-group-item-heading">付费方式</h4>';var ai=ai+'<p class="list-group-item-text" id="">'+aj.PAY_METHOD_TYPE+"</p>";var ai=ai+"</li>";$("#orderTbody").append(ai)}}$("#yslpage").hide();$("#order").hide();$("#successContent").show()}};var u=function(){if(CONST.getAppDesc()==0){var Y=contextPath+"/print/getInvoiceTemplates";var ab={areaId:OrderInfo.staff.areaId};var X=$.callServiceAsJson(Y,ab,{});if(X.code==-2){$.alertM(X.data);return}else{if(X.code!=0){$.alert("提示",ec.util.defaultStr(X.data,"获取打印模板出错"));return}else{var aa=X.data;if(aa.resultCode!="POR-0000"){$.alert("提示",ec.util.defaultStr(aa.resultMsg,"获取打印模板异常"));return}if(aa.length==0){$.alert("提示","没有获取到可用的打印模板");return}var ac="";var ad=aa.tempList;if(typeof ad!=undefined&&ad.length>0){ac+="<option selected='selected' value="+ad[0].templateId+">"+ad[0].templateName+"</option>";for(var Z=1;Z<ad.length;Z++){var ag=ad[Z];ac+="<option value="+ag.templateId+">"+ag.templateName+"</option>"}}$("#tempListSel").html(ac)}}}else{$("#tempListSel").parent().parent().hide()}var ae="";var ai=$("#choosedNumSpan").val();ae+="<option value="+ai+">"+ai+"</option>";$("#acceNbrSel").html(ae);var af="";af+="<div id='invoiceContDiv' class='plan_second_list cashier_tr'>";af+="  <table class='contract_list'>";af+="  <thead>";af+="    <tr>";af+="      <td>是否打印</td><td>费用名称</td><td>费用(元)</td><td>付费方式</td>";af+="    </tr>";af+="  </thead>";af+="  <tbody>";for(var Z=0;Z<order.ysl.paymentbean.length;Z++){var ah=order.ysl.paymentbean[Z];if(Z==0){$("#invoiceTitleInp").val($("#cCustName").val())}af+="<tr realAmount="+ah.ACCT_ITEM_FEE+" payMethodName="+ah.PAY_METHOD_CD+" acctItemTypeName="+ah.ACCT_ITEM_TYPE+">";af+="      <td><input type='checkbox' name='invoiceItemsChkBox' checked='checked'/></td>";af+="      <td>"+ah.ACCT_ITEM_TYPE+"</td>";af+="      <td>"+ah.ACCT_ITEM_FEE+"</td>";af+="      <td>"+ah.PAY_METHOD_TYPE+"</td>";af+="    </tr>"}af+="  </tbody>";af+="  </table>";af+="</div>";$("#invoiceItemsContDiv").html(af);$("#ec-dialog-form-content").css("height","auto");$("input[name=billType]").off("click").on("click",function(aj){if($("input[name=billType]:checked").val()=="0"){$("#invoiceNbrNumDl").show();$("#titleDt").html("发票抬头：");$("#tempDt").html("发票模板：")}else{$("#invoiceNbrNumDl").hide();$("#titleDt").html("票据抬头：");$("#tempDt").html("票据模板：")}});
$("#billTypeVo").hide();$("#invoiceItemsConfirm").off("click").on("click",function(aj){E()});ec.form.dialog.createDialog({id:"-invoice-items",width:580,zIndex:1100,initCallBack:function(ak,aj){common.print.dialogForm=ak;common.print.dialog=aj;$("#invoiceItemsConCancel").off("click").on("click",function(al){common.print.closePrintDialog()})},submitCallBack:function(ak,aj){},closeCallBack:function(ak,aj){}})};var E=function(){var ae=[];var ac={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"58B",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:order.ysl.CUST_ORDER_ID,custSoNumber:order.ysl.CUST_SO_NUMBER,custId:"",commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:0,printFlag:-1,invoiceId:order.ysl.INVOICE_ID,boActionTypeName:$("#busitype option:selected").text()};ac.billType=$("input[name='billType']:checked").val();var ab=0;var Z=[];var Y="";$("#invoiceContDiv tbody input:checked").parent().parent().each(function(){ab+=parseInt($(this).attr("realAmount"));Z.push({itemName:$(this).attr("acctItemTypeName"),charge:parseInt($(this).attr("realAmount"))*100,tax:0,acceNumber:$("#acceNbrSel option:selected").val()});Y=$(this).attr("payMethodName")});ac.amount=ab;ac.realPay=ab;ac.account=ab*100;ac.accountUpper=ec.util.atoc(ab*100);ac.invoiceNbr=$("#invoiceNbrInp").val();ac.invoiceNum=""+$("#invoiceNumInp").val();ac.acctNbr=$("#acceNbrSel option:selected").val();ac.busiName=$("#busitype option:selected").text();ae.push(ac);var ad={partyName:$("#invoiceTitleInp").val(),templateId:$("#tempListSel :selected").val(),prodInfo:[],items:Z,payMethod:$("#paytype option:selected").text(),invoiceInfos:ae,printflag:"true"};h(ad);var aa=contextPath+"/order/suborderysl";var X=$.callServiceAsJson(aa,ad);common.print.closePrintDialog();return};var h=function(Y){$("#invoiceForm").remove();if(R("_session_pad_flag")=="1"){var X=new Array(3);if(ec.util.browser.versions.android){X[0]="print/invoice"}else{X[0]="print/iosInvoice"}X[1]="invoiceParam";X[2]=encodeURI(JSON.stringify(Y));MyPlugin.printShow(X,function(Z){},function(Z){})}else{$("<form>",{id:"invoiceForm",style:"display:none;",target:"_blank",method:"POST",action:contextPath+"/print/invoice"}).append($("<input>",{id:"invoiceParam",name:"invoiceParam",type:"hidden",value:encodeURI(JSON.stringify(Y))})).appendTo("body").submit()}$("#printfp").removeClass("btna_go");$("#printfp").addClass("btna_g");$("#printfp").attr("onclick","")};var p=function(){var af={custInfo:{},orderEvent:[],feeInfos:{},remarkInfos:[],advInfos:[],terminalInfos:[],agreements:{},orderListInfo:{},chargeItems:[]};var ag={norCustInfo:[]};var X=[];if($("#identidiesTypeCd").val()==1){custIdCard=$("#cmCustIdCard").val()}else{custIdCard=$("#cmCustIdCardOther").val()}ag.norCustInfo.push({itemName:"客户名称",itemValue:$("#cmCustName").val()});ag.norCustInfo.push({itemName:"联系电话",itemValue:$("#phonenumber").val()});ag.norCustInfo.push({itemName:"证件类型",itemValue:$("#identidiesTypeCd option:selected").text()});ag.norCustInfo.push({itemName:"证件号码",itemValue:custIdCard});ag.norCustInfo.push({itemName:"通信地址",itemValue:$("#cmAddressStr").val()});ag.norCustInfo.push({itemName:"邮政编码",itemValue:"无"});ag.norCustInfo.push({itemName:"电子邮箱",itemValue:"无"});af.custInfo=ag;var Y={orderEventType:"1",orderEventTitle:{},orderEventCont:{}};var ae={attachOfferSpecName:"",boActionTypeCd:$("#busiactiontype").val(),boActionTypeName:$("#busiactiontype option:selected").text(),effectRule:"立即生效",prodSpecName:$("#offer_spec_name").val(),summary:$("#offer_spec_name").val()};Y.orderEventTitle=ae;var al={osAttachInfos:{},osBaseInfo:[],osOtherInfo:[],osOutInfos:[],userAcceNbrs:[]};var am={acceNbr:$("#choosedNumSpan").val(),acceType:$("#prodSpecId option:selected").text(),donateItems:[],isAloneLine:"Y",isBarCode:"Y",itemParam:{},memberRoleCd:"",memberRoleName:"一般构成成员",objId:$("#prodSpecId").val(),offerProdAttr:[],roleCd:"",roleName:"一般构成成员",userType:"新开户"};al.userAcceNbrs.push(am);Y.orderEventCont=al;af.orderEvent.push(Y);if($("#busitype").val()=="1"||$("#busitype").val()=="3"||$("#busitype").val()=="4"){if(order.ysl.openList.length>0){var ao={orderEventType:"3",orderEventTitle:{},orderEventCont:[]};var ae={boActionTypeCd:"7",boActionTypeName:"变更",prodSpecName:$("#prodSpecId option:selected").text()};for(var ak=0;ak<order.ysl.openList.length;ak++){if(order.ysl.openList[ak].type!="0"){var aj={actionName:"",effectRule:"立即生效",isAloneLine:"Y",itemName:"",itemParam:"",objId:"",relaAcceNbr:$("#choosedNumSpan").val()};var Z="";if(order.ysl.openList[ak].proactiontype=="ADD"){Z="开通"}else{if(order.ysl.openList[ak].proactiontype=="DEL"){Z="关闭"}}aj.actionName=Z;aj.itemName=order.ysl.openList[ak].name;aj.objId=order.ysl.openList[ak].id;ao.orderEventCont.push(aj);ao.orderEventTitle=ae}}af.orderEvent.push(ao)}}if(order.ysl.paymentbean.length>0){var ac={chargeItems:[]};var an={acctFeeInfos:[]};for(var ai=0;ai<order.ysl.paymentbean.length;ai++){var ab={accNbr:$("#choosedNumSpan").val(),acctItemId:"",acctItemTypeId:order.ysl.paymentbean[ai].ACCT_ITEM_TYPE_ID,acctItemTypeName:order.ysl.paymentbean[ai].ACCT_ITEM_TYPE,amount:parseInt(order.ysl.paymentbean[ai].ACCT_ITEM_FEE)*100,areaId:OrderInfo.staff.areaId,billId:"",billingCycleId:"",boActionTypeCd:"",boActionTypeName:$("#busitype option:selected").text(),boId:"",createDate:"",custId:"",custName:$("#cCustName").val(),invoiceNum:"",modifyReasonCd:"",objectName:"",offerId:"",offerInstId:"",olId:"",payMethodName:order.ysl.paymentbean[ai].PAY_METHOD_TYPE,payedState:"N",paymentAmount:parseInt(order.ysl.paymentbean[ai].ACCT_ITEM_FEE)*100,paymentId:"",paymentSeriaNbr:"-1",perferCash:"",perferReason:"",prodInstId:"",prodSpecId:$("#prodSpecId").val(),readDate:"",realAmount:parseInt(order.ysl.paymentbean[ai].ACCT_ITEM_FEE)*100,statusCd:"记录有效",statusDate:""};ac.chargeItems.push(ab);var aa={realAmount:parseInt(order.ysl.paymentbean[ai].ACCT_ITEM_FEE)*100,feeAmount:parseInt(order.ysl.paymentbean[ai].ACCT_ITEM_FEE)*100,paymentAmount:parseInt(order.ysl.paymentbean[ai].ACCT_ITEM_FEE)*100,acctItemTypeId:order.ysl.paymentbean[ai].ACCT_ITEM_TYPE_ID,objId:$("#prodSpecId").val(),objType:"",acctItemId:"",boId:"",prodId:"",objInstId:"",payMethodCd:order.ysl.paymentbean[ai].PAY_METHOD_CD,posSeriaNbr:"-1",chargeModifyReasonCd:"1",remark:"",boActionType:""};af.chargeItems.push(aa)}an.acctFeeInfos.push(ac);af.feeInfos=an}if($("#uimcode").val()!=""){var ad={isAloneLine:"Y",tiName:"UIM卡",tiParam:"个",tiRemark:"UIM卡:"+$("#uimcode").val()};af.terminalInfos.push(ad)}if($("#terminalcode").val()!=""){var ad={isAloneLine:"Y",tiName:"终端",tiParam:"个",tiRemark:"终端串码:"+$("#terminalcode").val()};af.terminalInfos.push(ad)}if($("#order_remark").val()!=""){af.remarkInfos.push($("#order_remark").val())}var ah={olId:order.ysl.CUST_ORDER_ID,soNbr:order.ysl.CUST_SO_NUMBER,busiType:"1",chargeItems:"",result:af};common.print.printVoucher(ah)};var R=function(Z){var Y="";var X=document.cookie.match(new RegExp("(^| )"+Z+"=([^;]*)(;|$)"));if(X!=null){Y=unescape(X[2])}return Y};var q=function(){$("#custCreateForm").off().bind("formIsValid",function(X){}).ketchup({bindElement:"createcustsussbtn"})};var y=function(){order.area.chooseAreaTreeManger("report/cartMain","p_areaId_val","p_areaId",3)};var z=function(Y,X){var ab=$("#p_startDt").val();var Z=$("#p_endDt").val();if(ab==""||Z==""){$.alert("提示","请先选择时间段再进行查询");return}if(ab.replace(/-/g,"")>Z.replace(/-/g,"")){$.alert("提示","开始时间不能晚于结束时间");return}var aa=1;if(Y>0){aa=Y}var ad={startDt:$("#p_startDt").val()+" 00:00:00",endDt:$("#p_endDt").val()+" 23:59:59",olNbr:$("#olNbr").val(),busitype:$("#ywlxc").val(),accnum:$("#accnum").val(),custname:$("#custname").val(),CustIdCard:$("#CustIdCard").val(),nowPage:aa,pageSize:10};var ac="";if($("#p_channelId").val()&&$("#p_channelId").val()!=""){ac=$("#p_channelId").attr("areaid");ad.channelId=$("#p_channelId").val()}else{ac=$("#p_areaId").val();
if(ac==null||ac==""||ac==undefined){$.alert("提示","请选择 '地区' 再查询");return}ad.channelId=""}ad.areaId=ac;$.callServiceAsHtmlGet(contextPath+"/app/order/queryyslList",ad,{before:function(){$.ecOverlay("购物车查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(ae){if(ae&&ae.code==-2){return}else{if(aa==1){$("#ysl_search").hide();$("#ysl_list").html(ae.data).show();$("#order-ysl-list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(X&&$.isFunction(X)){X.apply(this,[])}}if(aa>1){$("#all_ysl_list").append(ae.data);$("#order-ysl-list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(X&&$.isFunction(X)){X.apply(this,[])}}}},fail:function(ae){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var d=function(ab,Z){var aa={cust_so_number:ab,status_cd:Z,queryflag:"true"};var Y=contextPath+"/order/suborderysl";var X=$.callServiceAsJson(Y,aa);z(1)};var w=function(Y,X){var Z={cust_so_number:Y,status_cd:X,detail:"true"};$.callServiceAsJson(contextPath+"/app/order/queryYslDetail",Z,{before:function(){$.ecOverlay("详情查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(aa){if(aa&&aa.code==-2){return}else{$("#ysl_list").hide();$("#geren").hide();$("#feiyongcontainer").hide();$("#d_yslInfo").show();$("#tcmc").html("套餐名称：");$("#tcuim").html("UIM卡号：");$("#tcuim").removeAttr("style");$("#tccphm").html("产品号码：");$("#tcname").show();$("#tcfflx").show();$("#tcbm").show();$("#tccpmm").show();$("#tccpgg").show();$("#tcxh").show();$("#tuim").show();$("#taocan").show();$("#fushu").show();$("#zhongduan").show();$("#dealerAidDiv").show();$("#beizhu").show();$("#feiyong").show();order.ysl.certTypeByPartyType();var aq=aa.data;var an=aq.CUST_ITEM;var ae=aq.CUST_ORDER;var ab=aq.taocan;var ar=aq.PRODUCT_ITEM;var ai=aq.COUPON_ITEM;var ao=aq.ORDER_FEE;var ac=aq.closelist;var am=aq.openlist;var ag=aq.BUSI_STAFF_RELA;if(ec.util.isArray(an)){for(var al=0;al<document.getElementById("partyTypeCd").options.length;al++){if(document.getElementById("partyTypeCd").options[al].value==an[0].CUST_TYPE_CD){document.getElementById("partyTypeCd").options[al].selected=true;break}}for(var al=0;al<document.getElementById("identidiesTypeCd").options.length;al++){if(document.getElementById("identidiesTypeCd").options[al].value==an[0].IDENTIDIES_TYPE_CD){document.getElementById("identidiesTypeCd").options[al].selected=true;break}}$("#cmCustName").val(an[0].NAME);$("#cmCustIdCard").val(an[0].IDENTITY_NUM);$("#phonenumber").val(an[0].CONTACT_NO);$("#cmAddressStr").val(an[0].ADDRESS_STR)}$("#busitype").empty();$("#busitype").append("<option value='"+ae[0].BUSI_TYPE_CD+"' >"+ae[0].BUSI_TYPE_NAME+"</option>");order.ysl.busiactiontypeChoose("#busitype","detail");$("#order_remark").val(ae[0].REMARKS);$("#payTbody").empty();var ah=0;for(var al=0;al<ao.length;al++){$("#payTbody").append("<tr id=paytr_"+ah+'><td acct_item_type_id="'+ao[al].ACCT_ITEM_TYPE_ID+'">'+ao[al].ACCT_ITEM_TYPE+"</td><td>"+parseFloat(ao[al].ACCT_ITEM_FEE).toFixed(2)+"</td><td paytypecd="+ao[al].PAY_METHOD_CD+">"+ao[al].NAME+"</td><td></td></tr>");ah++}var aj=ae[0].BUSI_TYPE_CD;$("#offer_spec_name").val(ab[0].OFFER_SPEC_NAME);for(var al=0;al<document.getElementById("payment_type_cd").options.length;al++){if(document.getElementById("payment_type_cd").options[al].value==ar[0].PAYMENT_TYPE_CD){document.getElementById("payment_type_cd").options[al].selected=true;break}}$("#offer_spec_cd").val(ab[0].OFFER_SPEC_CD);$("#choosedNumSpan").val(ar[0].ACCESS_NBR);for(var al=0;al<ai.length;al++){if(ai[al].COUPON_TYPE_CD=="1"){$("#uimcode").val(ai[al].COUPON_INST_NBR)}else{if(ai[al].COUPON_TYPE_CD=="2"){$("#terminalcode").val(ai[al].COUPON_INST_NBR)}}}$("#pwd").val(ar[0].PROD_PWD);for(var al=0;al<document.getElementById("prodSpecId").options.length;al++){if(document.getElementById("prodSpecId").options[al].value==ar[0].PROD_SPEC_ID){document.getElementById("prodSpecId").options[al].selected=true;break}}$("#openprodhtml").empty();for(var al=0;al<am.length;al++){if(am[al].OFFER_TYPE_CD!=undefined){$("#openprodhtml").append("<li id="+am[al].OFFER_SPEC_CD+'><dd class="delete" onclick="order.ysl.delprod(\''+am[al].OFFER_SPEC_CD+"','"+am[al].OFFER_SPEC_NAME+"','1','ADD')\"></dd><span>"+am[al].OFFER_SPEC_NAME+"</span></li>")}else{$("#openprodhtml").append("<li id="+am[al].PROD_SPEC_CD+'><dd class="delete" onclick="order.ysl.delprod(\''+am[al].PROD_SPEC_CD+"','"+am[al].PROD_SPEC_NAME+"','2','ADD')\"></dd><span>"+am[al].PROD_SPEC_NAME+"</span></li>")}}$("#closeprodhtml").empty();for(var al=0;al<ac.length;al++){if(ac[al].OFFER_TYPE_CD!=undefined){$("#closeprodhtml").append("<li id="+ac[al].OFFER_SPEC_CD+'><dd class="delete" onclick="order.ysl.delprod(\''+ac[al].OFFER_SPEC_CD+"','"+ac[al].OFFER_SPEC_NAME+"','1','DEL')\"></dd><span>"+ac[al].OFFER_SPEC_NAME+"</span></li>")}else{$("#closeprodhtml").append("<li id="+ac[al].PROD_SPEC_CD+'><dd class="delete" onclick="order.ysl.delprod(\''+ac[al].PROD_SPEC_CD+"','"+ac[al].PROD_SPEC_NAME+"','2','DEL')\"></dd><span>"+ac[al].PROD_SPEC_NAME+"</span></li>")}}$("#adddealer").hide();$("#dealerTbody").empty();var ak="true";for(var al=0;al<ag.length;al++){var ad=ag[al].OFFER_SPEC_CD;var af=ad+"_"+OrderInfo.SEQ.dealerSeq;var ap="";if(ag[al].DEVELOP_TYPE=="40020005"){ap="第一发展人"}else{if(ag[al].DEVELOP_TYPE=="40020006"){ap="第二发展人"}else{if(ag[al].DEVELOP_TYPE=="40020007"){ap="第三发展人"}}}if(al==0&&ag[al].OFFER_TYPE_CD=="0"){$("#dealerTbody").append("<tr name='tr_"+ad+"' id='tr_"+ad+"'><td>主套餐</td><td>"+ag[al].OFFER_SPEC_NAME+'（包含接入产品）</td><td><select id="dealerType_'+af+'" name="dealerType_'+ad+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+ad+'\',a)" disabled="disabled"><option value="'+ag[al].DEVELOP_TYPE+'">'+ap+'</option></select><label class="f_red">*</label></td><td><input type="text" id="dealer_'+af+'" staffId="'+ag[al].STAFF_ID+'" value="'+ag[al].SALE_NAME+'" class="inputWidth183px" readonly="readonly"></input></td></tr>')}else{if(ag[al].OFFER_TYPE_CD=="0"&&al!=0){$("#dealerTbody").append("<tr name='tr_"+ad+"'><td>主套餐</td><td>"+ag[al].OFFER_SPEC_NAME+'（包含接入产品）</td><td><select id="dealerType_'+af+'" name="dealerType_'+ad+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+ad+'\',a)" disabled="disabled"><option value="'+ag[al].DEVELOP_TYPE+'">'+ap+'</option></select><label class="f_red">*</label></td><td><input type="text" id="dealer_'+af+'" staffId="'+ag[al].STAFF_ID+'" value="'+ag[al].SALE_NAME+'" class="inputWidth183px" readonly="readonly"></input></td></tr>')}else{if(ag[al].OFFER_TYPE_CD=="1"&&ak=="true"){$("#dealerTbody").append("<tr name='tr_-1_"+ad+"'><td>"+ar[0].ACCESS_NBR+"</td><td>"+ag[al].OFFER_SPEC_NAME+'</td><td><select id="dealerType_-1_'+af+'" name="dealerType_-1_'+ad+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_-1_'+ad+'\',a)" disabled="disabled"><option value="'+ag[al].DEVELOP_TYPE+'">'+ap+'</option></select><label class="f_red">*</label></td><td><input type="text" id="dealer_-1_'+af+'" name="dealer_-1_'+ad+'" staffId="'+ag[al].STAFF_ID+'" value="'+ag[al].SALE_NAME+'" class="inputWidth183px"  readonly="readonly"></input></td></tr>');ak="false"}else{if(ag[al].OFFER_TYPE_CD=="1"&&ak=="false"){$("#dealerTbody").append("<tr name='tr_-1_"+ad+"'><td>"+ar[0].ACCESS_NBR+"</td><td>"+ag[al].OFFER_SPEC_NAME+'</td><td><select id="dealerType_-1_'+af+'" name="dealerType_-1_'+ad+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_-1_'+ad+'\',a)" disabled="disabled"><option value="'+ag[al].DEVELOP_TYPE+'">'+ap+'</option></select><label class="f_red">*</label></td><td><input type="text" id="dealer_-1_'+af+'" name="dealer_-1_'+ad+'" staffId="'+ag[al].STAFF_ID+'" value="'+ag[al].SALE_NAME+'" class="inputWidth183px" readonly="readonly"></input></td></tr>')}}}}OrderInfo.SEQ.dealerSeq++}if(aj=="3"){$("#tcmc").html("新套餐名称：");$("#tcuim").html("UIM卡号[3转4补换卡]：");$("#tcuim").css({width:"140px","margin-left":"-50px"});
$("#tccphm").html("原产品号码：");$("#tcfflx").hide();$("#tccpmm").hide();$("#tccpgg").hide();$("#tcxh").hide();$("#zhongduan").hide()}else{if(aj=="4"){$("#tcuim").html("UIM卡号[3转4补换卡]：");$("#tcuim").css({width:"140px","margin-left":"-50px"});$("#tccphm").html("原产品号码：");$("#tcname").hide();$("#tcfflx").hide();$("#tcbm").hide();$("#tccpmm").hide();$("#tccpgg").hide();$("#tcxh").hide();$("#zhongduan").hide()}else{if(aj=="2"){$("#tcuim").html("新UIM卡号：");$("#tccphm").html("原产品号码：");$("#tcname").hide();$("#tcfflx").hide();$("#tcbm").hide();$("#tccpmm").hide();$("#tccpgg").hide();$("#tcxh").hide();$("#fushu").hide();$("#zhongduan").hide();$("#dealerAidDiv").hide()}else{if(aj=="5"||aj=="6"||aj=="7"||aj=="8"){$("#tccphm").html("原产品号码：");$("#tcname").hide();$("#tcfflx").hide();$("#tuim").hide();$("#tcbm").hide();$("#tccpmm").hide();$("#tccpgg").hide();$("#tcxh").hide();$("#fushu").hide();$("#zhongduan").hide();$("#dealerAidDiv").hide()}}}}$("#d_query").hide();$("#d_yslInfo").show()}},fail:function(aa){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var r=function(){$("#d_yslInfo").hide();$("#d_query").show()};var c=function(X){if(X&&X.page&&X.page>=1){z(X.page,X.scroll)}};var B=function(){var X=contextPath+"/app/order/yslPack";var Y={};$.callServiceAsHtml(X,Y,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(Z){if(!Z){Z.data="选套餐页面加载异常,稍后重试"}if(Z.code!=0){$.alert("提示","查询失败,稍后重试");return}$("#order").hide();var aa=$("#packContent");aa.html(Z.data).show()}})};var A=function(){OrderInfo.order.step=1;OrderInfo.busitypeflag=2;OrderInfo.actionFlag=2;order.service.queryApConfig();order.ysl.yslSearchPack()};var i=function(ae,ad,ag){var af=OrderInfo.cust.custId;var ai=$("#qryStr").val();var aa={subPage:ae,qryStr:ai,pnLevelId:"",custId:af,PageSize:10};if(ae){var Z=$("#select_price").val();if(ec.util.isObj(Z)){var ac=Z.split("-");if(ac[0]!=null&&ac[0]!=""){aa.priceMin=ac[0]}if(ac[1]!=null&&ac[1]!=""){aa.priceMax=ac[1]}}var ah=$("#select_influx").val();if(ec.util.isObj(ah)){var Y=ah.split("-");if(Y[0]!=null&&Y[0]!=""){aa.INFLUXMin=Y[0]*1024}if(Y[1]!=null&&Y[1]!=""){aa.INFLUXMax=Y[1]*1024}}var X=$("#select_invoice").val();if(ec.util.isObj(X)){var ab=X.split("-");if(ab[0]!=null&&ab[0]!=""){aa.INVOICEMin=ab[0]}if(ab[1]!=null&&ab[1]!=""){aa.INVOICEMax=ab[1]}}}S(aa,ae,ad)};var S=function(ab,Y,X){if(OrderInfo.actionFlag==2){var ac=order.prodModify.choosedProdInfo.prodOfferId;if(ac!=undefined){ab.changeGradeProdOfferId=ac}var aa="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.objId!=undefined){aa=aa+","+this.objId}}});if(aa!=""){aa=aa.substring(1,aa.length);ab.prodSpecId=aa}ab.actionFlag=2}else{if(CONST.getAppDesc()==0){ab.prodOfferFlag="4G"}}var Z=contextPath+"/app/order/yslOfferSpecList";$.callServiceAsHtmlGet(Z,ab,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay();$("#search-modal").modal("hide")},done:function(ad){$("#search-modal").modal("hide");if(ad.code!=0){$.alert("提示","<br/>查询失败,稍后重试");return}var ae=$("#offer-list");ae.html(ad.data);if(X&&$.isFunction(X)){X.apply(this,[])}},fail:function(ad){$.unecOverlay();$("#search-modal").modal("hide");$.alert("提示","套餐加载失败，请稍后再试！")}})};var P=function(aa){if(aa&&aa.page&&aa.page>=1){if(aa.page==1){i(1,aa.scroll)}else{var Y=10;var Z=(aa.page-2)*Y;var X=Z+Y;$("#div_all_data").children().slice(Z,X).appendTo($("#div_offer_list"));if(aa.scroll&&$.isFunction(aa.scroll)){aa.scroll.apply(this,[])}}}};var H=function(ac,X){var ae="";var ad={offerSpecId:X};var Z=$.callServiceAsJson(contextPath+"/app/order/queryOfferSpec",ad);if(Z.code==0){if(Z.data){var Y=Z.data.offerSpec;if(Y&&Y.offerRoles){var aa=Y.offerRoles;for(var ab=0;ab<aa.length;ab++){if(aa[ab].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||aa[ab].memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(aa[ab].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){ae=aa[ab].offerRoleId;break}}else{ae=aa[ab].offerRoleId;break}}}if(ae!=""){G=Y.offerRoles}else{$.alert("提示","无法选择套餐，套餐规格查询失败！");return}}}else{if(Z.code==-2){$.alertM(Z.data)}else{$.alert("提示","套餐详细加载失败，请稍后再试！");return}}$("#offer_spec_name").val(ac);$("#offer_spec_cd").val(X);$("#offerRoleId").val(ae);$("#packContent").hide();$("#order").show()};var j=0;var a=function(){if($("#offer_spec_cd").val().length<1){$.alert("提示","请先选择套餐");return}if(j==0){var X={mainOfferSpecId:$("#offer_spec_cd").val(),offerSpecId:$("#offer_spec_cd").val(),soNbr:UUID.getDataId(),prodId:"-1",prodSpecId:$("#prodSpecId").val(),offerRoleId:$("#offerRoleId").val()};order.ysl.queryAttachSpec(X,function(Y){if(Y){$("#order").hide();$("#kxbContent").html(Y).show();j=1;OrderInfo.actionFlag=10000000;OrderInfo.offerSpec.offerRoles=G;OrderInfo.offerSpec.offerSpecId=$("#offer_spec_cd").val();AttachOffer.showMainRoleProd(X.prodId);AttachOffer.changeLabel(X.prodId,X.prodSpecId,"100",X.offerRoleId);OrderInfo.offerSpec.offerRoles=undefined}})}else{$("#order").hide();$("#kxbContent").show();OrderInfo.actionFlag=10000000;OrderInfo.offerSpec.offerRoles=G;OrderInfo.offerSpec.offerSpecId=$("#offer_spec_cd").val();AttachOffer.showMainRoleProd(X.prodId);AttachOffer.changeLabel(X.prodId,X.prodSpecId,"100",X.offerRoleId);OrderInfo.offerSpec.offerRoles=undefined}};var L=function(aa,Z){var Y=contextPath+"/app/offer/queryYslKxb";if(typeof(Z)=="function"){$.callServiceAsHtml(Y,aa,{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(ab){if(ab.code==0){if(ab.data){Z(ab.data)}}else{if(ab.code==-2){$.alertM(ab.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var X=$.callServiceAsHtmlGet(Y,aa);$.unecOverlay();if(X.code==0){if(X.data){return X.data}}else{if(X.code==-2){$.alertM(X.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var N=function(aa,ac,X){var ab={prodId:aa,prodSpecId:$("#prodSpecId").val(),offerSpecIds:[ac],ifCommonUse:""};var Y=$("#search_text_"+aa).val();if(Y.replace(/\ /g,"")==""){$.alert("提示","请输入查询条件！");return}ab.offerSpecName=Y;var Z=query.offer.searchAttachOfferSpec(ab);if(Z!=undefined){$("#attach_div_"+aa).html(Z).show()}};var v=function(X){$.alert("流水号",X)};var O=function(X,Y){$("#"+X).hide();$("#"+Y).show()};return{closePopPage:O,searchAttachOfferSpec:N,showLsh:v,queryAttachSpec:L,showKxb:a,yslSelectPack:H,yslSearchPack:i,yslQueryData:S,yslScroll:P,showPack:B,initPack:A,yslbean:m,openList:K,realmoney:U,CUST_ORDER_ID:V,CUST_SO_NUMBER:b,INVOICE_ID:T,paymentbean:o,certTypeByPartyType:k,custcreateButton:q,querybusitype:t,busiactiontypeChoose:I,genRandPass6Input:M,searchPack:e,confirmoffer:W,addParam:Q,confirmAttachOffer:F,addprod:s,delprod:J,adddealer:n,addpayinfo:l,delpay:D,suborderysl:x,invoiceprint:u,saveInvoiceInfo:E,printInvoice:h,printVoucher:p,queryyslinfos:z,chooseArea:y,upOrderInfo:d,queryYslDetail:w,showMain:r,queryfeeitems:C,identidiesTypeCdChoose:g,scroll:c}})();CommonUtils.regNamespace("rule","rule");rule.rule=(function(){var checkFlag=false;var checkObj={};var _callBackStr="";var _callBackParam={};var _init=function(){$("#ruleBody").html("");$("#ruleclose").click(function(){_closeRuleDiv()});$("#credit").click(function(){_credit()});$("#closedialog").click(function(){_cancel()})};var _prepare=function(param,callBackStr,callBackParam){_init();_callBackStr=callBackStr;_callBackParam=callBackParam;if(!query.offer.loadInst()){return}var inParam={prodInfo:order.prodModify.choosedProdInfo,areaId:param.areaId,staffId:param.staffId,channelId:param.channelId,custId:param.custId,boInfos:param.boInfos,soNbr:OrderInfo.order.soNbr};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var response=$.callServiceAsJson(contextPath+"/rule/prepare",inParam);$.unecOverlay();var checkData=response.data;if(response.code==0){if(checkData==null){$.alert("提示","规则校验异常，请联系管理人员！");return}}else{$.alertM(response.data);return}if(checkData.ruleType=="portal"){if(checkData.resultCode=="0"){$.alert("提示",checkData.resultMsg);
return true}}if(checkData.result&&checkData.result.resultInfo){var checkRuleInfo=checkData.result.resultInfo;if(checkRuleInfo!=null&&checkRuleInfo.length>0){$.each(checkRuleInfo,function(i,ruleInfo){$("<tr><td>"+ruleInfo.resultCode+"</td><td>"+ruleInfo.ruleDesc+"</td><td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});easyDialog.open({container:"ruleDiv"})}else{_credit();SoOrder.initFillPage()}}else{_credit();SoOrder.initFillPage()}if(checkData.resultCode!=0){$("#ruleSubmit").hide()}else{checkObj=param;checkFlag=true}};var _getRuleImgClass=function(ruleLevel){if(ruleLevel<4){return"correct"}else{return"error"}};var _getRuleLevelName=function(ruleLevel){if(ruleLevel==0){return"提示级"}else{if(ruleLevel==1){return"中级"}else{if(ruleLevel==2){return"高级"}else{if(ruleLevel==3){return"特技"}else{if(ruleLevel==4){return"限制级"}}}}}};var _prepareCallBack=function(response){var content$=$("#ruleDiv");content$.html(response.data).show()};var _submit=function(){if(!checkFlag){return}$.callServiceAsHtml(contextPath+checkObj.uri,checkObj.param,checkObj.callObj);easyDialog.close()};var _closeRuleDiv=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _cancel=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _showRuleDiv=function(ruleInfo){};var _credit=function(){eval(_callBackStr+"("+JSON.stringify(_callBackParam)+")")};var _ruleCheck=function(boInfos,callBack){if(!query.offer.loadInst()){return false}if(boInfos==undefined){return true}var inParam={areaId:OrderInfo.staff.soAreaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,boInfos:boInfos,prodInfo:order.prodModify.choosedProdInfo};$.callServiceAsHtml(contextPath+"/app/rule/prepare",inParam,{before:function(){$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>")},done:function(response){setTimeout(function(){$.unecOverlay();var checkData=response.data;if(typeof(callBack)=="function"){callBack(checkData)}},800)}})};return{submit:_submit,prepare:_prepare,showRuleDiv:_showRuleDiv,ruleCheck:_ruleCheck,init:_init,getRuleLevelName:_getRuleLevelName,getRuleImgClass:_getRuleImgClass}})();$(function(){});CommonUtils.regNamespace("order","phoneNumber");var phoneNum_level="";var selectedObj=null;var _queryFlag="0";order.phoneNumber=(function(){var d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",areaCode:"",memberRoleCd:"",preStore:"",minCharge:""};var A=function(){d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",areaCode:"",memberRoleCd:"",preStore:"",minCharge:""}};var h=0;var C="";var t=[];var g=contextPath+"/app/mktRes/phonenumber/list";var c="";var r=function(I,G){var H=$.trim($("#idCode").val());if(H!=""){b();return}selectedObj=null;I=j(I);I.isReserveFlag=_queryFlag;if(_queryFlag=="1"){I.queryFlag="3"}if($("#pakeage").length>0){$("#pakeage").hide()}$.callServiceAsHtml(g,I,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay();$("#numberModal").modal("hide")},done:function(J){$("#numberModal").modal("hide");if(J.data.indexOf("showVerificationcode")>=0){$("#vali_code_input").val("");$("#validatecodeImg").css({width:"80px",height:"32px"}).attr("src",contextPath+"/validatecode/codeimg.jpg?"+Math.floor(Math.random()*100)).fadeIn();easyDialog.open({container:"Verificationcode_div"})}if(!J||J.code!=0){J.data="查询失败,稍后重试"}var K=$("#phonenumber-list");if($("#subPage").val()=="offer"||$("#subPage").val()=="terminal"){K=$("#number-list")}K.html(J.data);$("#phonenumber-list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(G&&$.isFunction(G)){G.apply(this,[])}$("#btnSwitchNbr").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber({})})},fail:function(J){$.unecOverlay();$("#numberModal").modal("hide");$.alert("提示","请求可能发生异常，请稍后再试！")}})};var p=function(J){var H=contextPath+"/app/mktRes/phone/numberlist";var I={areaId:OrderInfo.getAreaId(),phoneNumber:J.phoneNum};var G=$.callServiceAsJson(H,I);if(G&&G.code==0){if(G.data){return G.data}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询号码信息失败,稍后重试")}}};var b=function(){var H=$.trim($("#idCode").val());if(!a(H)){$.alert("提示","身份证号码输入有误!");return}var J=$("#p_cust_areaId").val();var G=$("#subPage").val();var I={identityId:H,areaId:J,subPage:G};$.callServiceAsHtmlGet(contextPath+"/app/mktRes/phonenumber/listByIdentity",I,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay();$("#numberModal").modal("hide")},done:function(K){$("#numberModal").modal("hide");if(!K||K.code!=0){K.data="查询失败,稍后重试"}var L=$("#phonenumber-list");if($("#subPage").val()=="offer"||$("#subPage").val()=="terminal"){L=$("#number-list")}L.html(K.data)},fail:function(K){$.unecOverlay();$("#numberModal").modal("hide");$.alert("提示","请求可能发生异常，请稍后再试！")}})};var f=function(U){c=$(U).attr("numberVal");var V=CONST.MEMBER_ROLE_CD.MAIN_CARD;var Q=$("#subFlag").val();if(Q=="Y2"){V=CONST.MEMBER_ROLE_CD.VICE_CARD}var N=$("#subnum").val();var ab=$("#subPage").val();var I=c.split("_")[1];var M=c.split("_")[2];if(order.service.offerprice!=""){var ad=parseInt(M);var S=parseInt(order.service.offerprice);if(S<ad){$.unecOverlay();$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var P=c.split("_")[0];var ac=c.split("_")[3];var Z=C;if(C==""){Z=c.split("_")[5]}var ae=c.split("_")[5];var W=c.split("_")[6];var X=$("#p_cust_areaId").val();if(X==null||X==""){X=OrderInfo.staff.areaId}var G=$(U).attr("zoneNumber");if(G==null||G==""){G=OrderInfo.staff.areaCode}if(P){var J=false;var H="";var T="";if(ab=="terminal"||ab=="number"){H=d.accessNumber;T=d.anTypeCd}else{if(ab=="offer"){for(var Y=0;Y<OrderInfo.boProdAns.length;Y++){if(OrderInfo.boProdAns[Y].prodId==N){H=OrderInfo.boProdAns[Y].accessNumber;T=OrderInfo.boProdAns[Y].anTypeCd;break}}for(var Y=0;Y<OrderInfo.boProdAns.length;Y++){if(OrderInfo.boProdAns[Y].prodId!=N){if(OrderInfo.boProdAns[Y].accessNumber==P){$.unecOverlay();$.alert("提示","你已经选择了该号码,请选择其它号码!");return}}}}}if(H!=""){J=true;for(var Y=0;Y<t.length;Y++){if(t[Y]==H){J=false;break}}if(J){var L=contextPath+"/app/mktRes/phonenumber/purchase";var aa={oldPhoneNumber:H,oldAnTypeCd:T};$.callServiceAsJson(L,aa,{})}}$.unecOverlay();t.push(P);if(ab=="number"){var R=$("#order_fill_content");R.html("");d.accessNumber=P;d.anTypeCd=ac;d.level=Z;d.org_level=ae;d.anId=W;d.areaId=X;d.areaCode=G;d.memberRoleCd=V;d.idFlag=0;d.preStore=I;d.minCharge=M;order.service.boProdAn=d;OrderInfo.returnFlag=2;OrderInfo.order.step=2;$("#tentrance").show();$("#pentrance").hide();$("#nentrance").hide();$("#pakeage").show();$("#pakeage").attr("class","tab-pane fade in active");$("#tentrance").css("width","100%");$("#phone").hide();$("#number").hide()}else{if(ab=="terminal"){mktRes.terminal.setNumber(P,Z);d.accessNumber=P;d.anTypeCd=ac;d.level=Z;d.org_level=ae;d.anId=W;d.areaId=X;d.areaCode=G;d.memberRoleCd=V;d.idFlag=0;d.preStore=I;d.minCharge=M;order.service.boProdAn=d;$("#order").show();$("#phonenumberContent").hide()}else{if(ab=="offer"){d.anTypeCd=ac;d.anId=W;d.accessNumber=P;d.level=Z;d.org_level=ae;d.areaId=X;d.areaCode=G;d.preStore=I;d.minCharge=M;$("#nbr_btn_"+N).val(P);$("#choosedNumSpan").val(P);var K=false;if(OrderInfo.boProdAns.length>0){for(var Y=0;Y<OrderInfo.boProdAns.length;Y++){if(OrderInfo.boProdAns[Y].prodId==N){OrderInfo.boProdAns[Y].accessNumber=P;OrderInfo.boProdAns[Y].anTypeCd=ac;OrderInfo.boProdAns[Y].pnLevelId=Z;OrderInfo.boProdAns[Y].anId=W;OrderInfo.boProdAns[Y].areaId=X;OrderInfo.boProdAns[Y].areaCode=G;OrderInfo.boProdAns[Y].memberRoleCd=V;OrderInfo.boProdAns[Y].idFlag=0;OrderInfo.boProdAns[Y].preStore=I;OrderInfo.boProdAns[Y].minCharge=M;K=true;OrderInfo.setProdAn(OrderInfo.boProdAns[Y]);order.dealer.changeAccNbr(N,P);break}}}if(!K){var O={prodId:N,accessNumber:P,anChooseTypeCd:"2",anId:W,anTypeCd:ac,pnLevelId:Z,state:"ADD",areaId:X,areaCode:G,memberRoleCd:V,idFlag:0,preStore:I,minCharge:M};
OrderInfo.boProdAns.push(O)}if(N=="-1"){OrderInfo.boCustInfos.telNumber=P}$("#order_content").show();$("#phonenumberContent").hide()}}}}else{$.alert("提示","号码格式不正确!")}};var s=function(G){if(d.accessNumber!=""){$("#nbr_btn_"+G).removeClass("selectBoxTwo");$("#nbr_btn_"+G).addClass("selectBoxTwoOn");$("#nbr_btn_"+G).val(d.accessNumber);order.dealer.changeAccNbr(G,d.accessNumber);var H=false;if(OrderInfo.boProdAns.length>0){for(var I=0;I<OrderInfo.boProdAns.length;I++){if(OrderInfo.boProdAns[I].prodId==G){OrderInfo.boProdAns[I].accessNumber=d.accessNumber;OrderInfo.boProdAns[I].anTypeCd=d.anTypeCd;OrderInfo.boProdAns[I].anId=d.anId;OrderInfo.boProdAns[I].pnLevelId=d.level;OrderInfo.boProdAns[I].areaId=d.areaId;OrderInfo.boProdAns[I].memberRoleCd=d.memberRoleCd;OrderInfo.boProdAns[I].preStore=d.preStore;OrderInfo.boProdAns[I].minCharge=d.minCharge;if(d.idFlag){OrderInfo.boProdAns[I].idFlag=d.idFlag}OrderInfo.setProdAn(OrderInfo.boProdAns[I]);order.dealer.changeAccNbr(G,phoneNumber);H=true;break}}}if(!H){var J={prodId:G,accessNumber:d.accessNumber,anChooseTypeCd:"2",anId:d.anId,pnLevelId:d.level,anTypeCd:d.anTypeCd,state:"ADD",areaId:d.areaId,areaCode:d.areaCode,memberRoleCd:d.memberRoleCd,preStore:d.preStore,minCharge:d.minCharge};if(d.idFlag){J.idFlag=d.idFlag}OrderInfo.boProdAns.push(J)}if(G=="-1"){OrderInfo.boCustInfos.telNumber=d.accessNumber}}};var x=function(R,W){c=$(R).attr("numberVal");var S=CONST.MEMBER_ROLE_CD.MAIN_CARD;var O=$("#subFlag").val();if(O=="Y2"){S=CONST.MEMBER_ROLE_CD.VICE_CARD}var M=$("#subnum").val();var Y=$("#subPage").val();var J=c.split("_")[1];var L=c.split("_")[2];var T=$("#p_cust_areaId").val();if(T==null||T==""){T=OrderInfo.staff.areaId}var G=$(R).attr("zoneNumber");if(G==null||G==""){G=OrderInfo.staff.areaCode}if(order.service.offerprice!=""){var ab=parseInt(L);var P=parseInt(order.service.offerprice);if(P<ab){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var N=c.split("_")[0];var aa=c.split("_")[3];var V=c.split("_")[5];if(N){var X=$("#p_cust_areaId").val();var Z={};if(W){Z={phoneNumber:N,actionType:"E",anTypeCd:aa,areaId:X,attrList:[{attrId:"65010036",attrValue:W}]}}else{Z={phoneNumber:N,actionType:"E",anTypeCd:aa,areaId:X}}var I=false;var H="";var Q="";if(Y=="terminal"||Y=="number"){H=d.accessNumber;Q=d.anTypeCd;if(H==N){$.alert("提示","号码已经被预占,请选择其它号码!");return}else{d={}}}else{if(Y=="offer"){for(var U=0;U<OrderInfo.boProdAns.length;U++){if(OrderInfo.boProdAns[U].prodId==M){H=OrderInfo.boProdAns[U].accessNumber;Q=OrderInfo.boProdAns[U].anTypeCd;break}}for(var U=0;U<OrderInfo.boProdAns.length;U++){if(OrderInfo.boProdAns[U].accessNumber==N){$.alert("提示","号码已经被预占,请选择其它号码!");return}}}}if(H&&H!=""){I=true;for(var U=0;U<t.length;U++){if(t[U]==H){I=false;break}}if(I){if(W){Z={newPhoneNumber:N,oldPhoneNumber:H,newAnTypeCd:aa,oldAnTypeCd:Q,areaId:X,attrList:[{attrId:"65010036",attrValue:W}]}}else{Z={newPhoneNumber:N,oldPhoneNumber:H,newAnTypeCd:aa,oldAnTypeCd:Q,areaId:X}}}}var K=contextPath+"/app/mktRes/phonenumber/purchase";$.callServiceAsJson(K,Z,{before:function(){$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>")},done:function(ac){$.unecOverlay();if(ac.code==0){if(C==""){C=ac.data.phoneLevelId}if(Y=="number"){var af=$("#order_fill_content");af.html("");d.accessNumber=N;d.anTypeCd=aa;d.level=C;d.org_level=ac.data.phoneLevelId;d.anId=ac.data.phoneNumId;d.areaId=T;d.areaCode=G;d.memberRoleCd=S;d.preStore=J;d.minCharge=L;order.service.boProdAn=d;OrderInfo.returnFlag=2;OrderInfo.order.step=2;$("#tentrance").show();$("#pentrance").hide();$("#nentrance").hide();$("#pakeage").show();$("#pakeage").attr("class","tab-pane fade in active");$("#tentrance").css("width","100%");$("#phone").hide();$("#number").hide()}else{if(Y=="terminal"){mktRes.terminal.setNumber(N,ac.data.phoneLevelId);d.accessNumber=N;d.anTypeCd=aa;d.level=C;d.org_level=ac.data.phoneLevelId;d.anId=ac.data.phoneNumId;d.areaId=T;d.areaCode=G;d.memberRoleCd=S;d.preStore=J;d.minCharge=L;order.service.boProdAn=d;$("#order").show();$("#phonenumberContent").hide()}else{if(Y=="offer"){$("#nbr_btn_"+M).val(N);$("#choosedNumSpan").val(N);d.accessNumber=N;d.level=C;d.org_level=ac.data.phoneLevelId;d.areaId=T;d.anTypeCd=aa;d.anId=ac.data.phoneNumId;d.preStore=J;d.minCharge=L;var ad=false;if(OrderInfo.boProdAns.length>0){for(var ae=0;ae<OrderInfo.boProdAns.length;ae++){if(OrderInfo.boProdAns[ae].prodId==M){OrderInfo.boProdAns[ae].accessNumber=N;OrderInfo.boProdAns[ae].anTypeCd=aa;OrderInfo.boProdAns[ae].pnLevelId=C;OrderInfo.boProdAns[ae].anId=ac.data.phoneNumId;OrderInfo.boProdAns[ae].areaId=T;OrderInfo.boProdAns[ae].areaCode=G;OrderInfo.boProdAns[ae].memberRoleCd=S;OrderInfo.boProdAns[ae].preStore=J;OrderInfo.boProdAns[ae].minCharge=L;ad=true;if(OrderInfo.offerSpec.offerRoles!=undefined){OrderInfo.setProdAn(OrderInfo.boProdAns[ae])}order.dealer.changeAccNbr(M,N);break}}}if(!ad){var ah={prodId:M,accessNumber:N,anChooseTypeCd:"2",anId:ac.data.phoneNumId,pnLevelId:C,anTypeCd:aa,state:"ADD",areaId:T,areaCode:G,memberRoleCd:S,preStore:J,minCharge:L};OrderInfo.boProdAns.push(ah);if(OrderInfo.offerSpec.offerRoles!=undefined){OrderInfo.setProdAn(ah)}order.dealer.changeAccNbr(M,N)}if(M=="-1"){OrderInfo.boCustInfos.telNumber=N}$("#order").show();$("#phonenumberContent").hide()}}}}else{if(ac.code==-2){$.alertM(ac.data)}else{var ag="";if(ac.data!=undefined&&ac.data.msg!=undefined){ag=ac.data.msg}else{ag="号码["+N+"]预占失败"}$.alert("提示","号码预占失败，可能原因:"+ag)}}},fail:function(ac){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})}else{$.alert("提示","号码格式不正确!")}};var y=function(H,G){e(H,G);r()};var j=function(I){var J=$('input[name="query_flag_01"]').parent().attr("class");if(J=="toggle btn btn-default off"){J="1"}else{J="2"}var O="";if(OrderInfo.cust==undefined||OrderInfo.cust.custId==undefined||OrderInfo.cust.custId==""){O=$("#p_cust_areaId").val()}else{O=OrderInfo.getAreaId()}var P=$("#pnHead").val();var H=$("#pncharacteristic").find("a.selected").attr("val");var Q=$.trim($("#pnEnd").val());if(H!=null&&H!=""){Q=H}else{if(Q=="最后四位"){Q=""}}var R="";var K="";var L=$("#Greater").val();var G=$("#Less").val();var M=$("#nbrPool option:selected").val();var N=$("#subPage").val();K=$("#pnCharacterId_basic option:selected").val();K=ec.util.defaultStr(K);return{pnHead:P,pnEnd:Q,goodNumFlag:K,maxPrePrice:G,minPrePrice:L,pnLevelId:"",pageSize:"10",phoneNum:R,areaId:O,poolId:M,subPage:N,queryFlag:J}};var e=function(H,G){$(H).each(function(){$(this).removeClass("selected")});$(G).addClass("selected")};var F=function(G){var H={pageIndex:G};order.phoneNumber.btnQueryPhoneNumber(H)};var a=function(K){K=K.toUpperCase();if(!(/(^\d{15}$)|(^\d{17}([0-9]|X)$)/.test(K))){return false}var L,Q;L=K.length;if(L==15){Q=new RegExp(/^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/);var P=K.match(Q);var I=new Date("19"+P[2]+"/"+P[3]+"/"+P[4]);var H;H=(I.getYear()==Number(P[2]))&&((I.getMonth()+1)==Number(P[3]))&&(I.getDate()==Number(P[4]));if(!H){return false}else{var N=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var O=new Array("1","0","X","9","8","7","6","5","4","3","2");var M=0,J;K=K.substr(0,6)+"19"+K.substr(6,K.length-6);for(J=0;J<17;J++){M+=K.substr(J,1)*N[J]}K+=O[M%11];return K}}if(L==18){Q=new RegExp(/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/);var P=K.match(Q);var I=new Date(P[2]+"/"+P[3]+"/"+P[4]);var H;H=(I.getFullYear()==Number(P[2]))&&((I.getMonth()+1)==Number(P[3]))&&(I.getDate()==Number(P[4]));if(!H){return false}else{var G;var N=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var O=new Array("1","0","X","9","8","7","6","5","4","3","2");var M=0,J;for(J=0;J<17;J++){M+=K.substr(J,1)*N[J]}G=O[M%11];if(G!=K.substr(17,1)){return false}return K}}return false};var v=function(){order.area.chooseAreaTree("order/prepare","p_phone_areaId_val","p_phone_areaId",3)};var l=function(H,G){var I=contextPath+"/app/mktRes/phonenumber/prepare";var J={};$.callServiceAsHtmlGet(I,J,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(K){if(!K){K.data="选号页面加载异常,稍后重试"}if(K.code!=0){$.alert("提示","查询失败,稍后重试");
return}$("#order").hide();$("#order_prepare").hide();var L=$("#phonenumberContent");L.html(K.data).show();$("#subnum").val(H);$("#subPage").val(G);d={accessNumber:"",level:"",anId:"",anTypeCd:""};k(G)}})};var k=function(H,G){$("#phone").hide();$("#subPage").val(H);if(CONST.getAppDesc()==1){$("#psw_dt").hide();$("#psw_dd").hide()}selectedObj=null;h=0;C="";order.phoneNumber.queryApConfig();z();var I={};order.phoneNumber.btnQueryPhoneNumber(I,G);$("#btnNumSearch1").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber(I,G)})};var w=function(){var H={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var G=contextPath+"/app/order/queryApConf";$.callServiceAsJsonGet(G,H,{done:D})};var D=function(M){var P;var J;if(M.data){var K=M.data.length;$("#pnHeadDiv").empty();for(var N=0;N<K;N++){if(M.data[N].PHONE_NUMBER_SEGMENT){P=M.data[N].PHONE_NUMBER_SEGMENT;var R=$('<select id="pnHead" class="selectpicker show-tick form-control"></select>');var H=$('<option value="" selected="selected">请选择号段</option>');R.append(H);for(var L=0;L<P.length;L++){var O=P[L].COLUMN_VALUE_NAME;O=O.replace(/\"/g,"");var G=$('<option value="'+O+'">'+O+"</option>");R.append(G)}$("#pnHeadDiv").append(R);R.addClass("styled-select");continue}}$("#pnCharacterId_basicDiv").empty();for(var N=0;N<K;N++){if(M.data[N].PHONE_NUMBER_FEATURE){J=M.data[N].PHONE_NUMBER_FEATURE;var I;if(J.length<=9){I=J.length}else{I=9}var R=$('<select id="pnCharacterId_basic" class="selectpicker show-tick form-control"></select>');var H=$('<option value="" selected="selected">请选择类型</option>');R.append(H);for(var L=0;L<I;L++){var S=(J[L].COLUMN_VALUE_NAME).replace(/\"/g,"");var Q=(J[L].COLUMN_VALUE).replace(/\"/g,"");var G=$('<option value="'+Q+'">'+S+"</option>");R.append(G)}$("#pnCharacterId_basicDiv").append(R);R.addClass("styled-select");continue}}$("#pnHeadDiv").append('<span class="input-group-addon select-span"></span>');$("#pnCharacterId_basicDiv").append('<span class="input-group-addon select-span"></span>')}};var z=function(){if($("#subPage").val()=="number"){$("#nbrPoolDiv").empty()}else{$("#nbrPoolDiv2").empty()}var K=contextPath+"/app/mktRes/phonenumber/queryPhoneNbrPool";var N={};var I=$.callServiceAsJson(K,N);if(I.code==0){if(I.data){var J=I.data.phoneNbrPoolList;var H=$('<div class="input-group select-top"></div>');var G=$('<span class="input-group-addon select-span"></span>');var M=$('<select id="nbrPool" class="selectpicker show-tick form-control"></select>');var L=$('<option value="" selected="selected">请选择号池</option>');M.append(L);if(J!=null){$.each(J,function(){var O=$('<option value="'+this.poolId+'">'+this.poolName+"</option>");M.append(O)})}H.append(M).append(G);if($("#subPage").val()=="number"){$("#nbrPoolDiv").append(H)}else{$("#nbrPoolDiv2").append(H)}M.addClass("styled-select")}}else{if(I.code==-2){$.alertM(I.data)}else{$.alert("提示","号池加载失败，请稍后再试！")}}};var q=function(K){var H=contextPath+"/app/mktRes/phonenumber/queryPnLevelProdOffer";var J="";if(order.ysl!=undefined||K!=undefined){J=$("#_session_staff_info").attr("areaid")}else{J=$("#p_cust_areaId").val()}J=J.substring(0,3)+"0000";var I={areaId:J};var G=$.callServiceAsJson(H,I)};var n=function(){if(selectedObj==undefined||selectedObj==null){$.alert("提示","请先选择号码！");return}var H=$(selectedObj).attr("numberVal");var K=H.split("_")[5];var I=H.split("_")[0];var J=$("#p_cust_areaId").val();if(J==null||J==""){J=OrderInfo.staff.areaId}var G=contextPath+"/app/mktRes/qryPhoneNbrLevelInfoList";$.ligerDialog.open({width:560,height:350,allowClose:false,title:"设置号码等级（"+I+"）",url:G+"?pnLevelId="+C+"&areaId="+J+"&org_level="+K,buttons:[{text:"确定",onclick:function(M,L){var N=phoneNum_level.split("_");L.close();$(".select_nbr_li").each(function(){if($(this).hasClass("select")){var P=$(this).attr("numberval").split("_");var O;if(phoneNum_level!=undefined&&phoneNum_level!=""&&P[5]!=N[0]){O="<span style='float:left;margin-left:10px;'>预存<span class='orange'>"+P[1]+"</span>元<br/>保底<span class='orange'>"+P[2]+"</span>元</span><span style='float:right;margin-right:10px;'>预存<span class='orange'>"+N[1]+"</span>元<br/>保底<span class='orange'>"+N[2]+"</span>元</span><span style='width: 15px; display: table; height: 30px; padding-top: 10px;'><img  src='"+contextPath+"/image/common/levelArrow.png'></span>"}else{O="<span style='padding-left:10px;'>预存<span class='orange'>"+P[1]+"</span>元</span> <span style='padding-left:10px;'> 保底<span class='orange'>"+P[2]+"</span>元</span>"}$(this).find("div").html(O)}});$(".select_nbr_li").addClass("styled-select");C=N[0]}},{text:"关闭",onclick:function(M,L){L.close()}}]})};var E=function(I,H){$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>");selectedObj=I;h=H;if(h==1){f(selectedObj)}else{var G=$(selectedObj).attr("numberVal").split("_")[7];if(G=="1"){$("#app_password_dialog").modal("show")}else{x(selectedObj)}}};var o=function(I,H){if(selectedObj==I){return}h=H;selectedObj=I;var G=$(selectedObj).attr("numberVal");C=G.split("_")[5];$(I).siblings().each(function(){$(this).removeClass("select");var K=$(this).attr("numberval").split("_");var J="<span style='padding-left:10px;'>预存<span class='orange'>"+K[1]+"</span>元</span> <span style='padding-left:10px;'> 月保底<span class='orange'>"+K[2]+"</span>元</span>";$(this).find("div").html(J)});$(I).addClass("select")};var B=function(){var G=$("#pree_password_text").val();if($.trim(G)==""){$.alert("提示","预占密码不能为空！")}else{$("#app_password_dialog").modal("hide");$("#pree_password_text").val("");x(selectedObj,G)}};var u=function(G){$("#order").show();$("#phonenumberContent").hide()};var m=function(G){if(G&&G.page&&G.page>=1){k($("#subPage").val(),G.scroll)}};var i=function(){if(OrderInfo.order.step==1){var H=OrderInfo.boProdAns;var G=OrderInfo.boProd2Tds;if(G.length>0){for(var J=0;J<G.length;J++){var I={numType:2,numValue:G[J].terminalCode};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",I,{done:function(){}})}}if(H.length>0){for(var J=0;J<H.length;J++){if(H[J].idFlag){continue}var I={numType:1,numValue:H[J].accessNumber};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",I,{done:function(){}})}}order.phoneNumber.resetBoProdAn();common.callCloseWebview()}else{if(OrderInfo.order.step==2){$.confirm("确认","确定要取消该订单吗？",{yes:function(){var M=OrderInfo.boProdAns;var K=OrderInfo.boProd2Tds;var L=order.service.boProdAn;if(K.length>0){for(var O=0;O<K.length;O++){var N={numType:2,numValue:K[O].terminalCode};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",N,{done:function(){}})}}if(M.length>0){for(var O=0;O<M.length;O++){if(M[O].idFlag){continue}var N={numType:1,numValue:M[O].accessNumber};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",N,{done:function(){}})}}else{if(L.accessNumber.length>0){var N={numType:1,numValue:L.accessNumber};$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",N,{done:function(){}})}}order.phoneNumber.resetBoProdAn();$("#pakeage").hide();$("#pakeage").attr("class","tab-pane fade in active");$("#tentrance").show();$("#phone").show();$("#number").show();$("#pentrance").show();$("#nentrance").show();$("#tentrance").css("width","");$("#nentrance").attr("class","");$("#div_content").html("");$("#vice_modal").modal("hide");$("#order_prepare").show();OrderInfo.order.step=1},no:function(){}},"question")}else{if(OrderInfo.order.step==3){SoOrder.orderBack();$("#order-content").show();$("#order-confirm").hide();$("#order-dealer").hide();OrderInfo.order.step=2}else{if(OrderInfo.order.step==4){$("#order-confirm").show();$("#order-print").hide();OrderInfo.order.step=3}else{common.callCloseWebview()}}}}};return{qryPhoneNbrLevelInfoList:n,selectNum:o,endSelectNum:E,btnQueryPhoneNumber:r,linkQueryPhoneNumber:y,getIndexPagePhoneNumber:F,queryApConfig:w,initPhonenumber:k,boProdAn:d,resetBoProdAn:A,btnIBydentityQuery:b,initOffer:s,initPage:l,chooseArea:v,preePassword:B,queryPhoneNbrPool:z,queryFlag:_queryFlag,queryPnLevelProdOffer:q,btnBack:u,scroll:m,queryPhoneNumber:p,back:i}})();CommonUtils.regNamespace("mktRes","terminal");
mktRes.terminal=(function(f){var v="";var B=10;var w={};var k={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false};_initBuyChk=function(){k={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false}};var r=function(){if("lj"==k.buyType){OrderInfo.actionFlag=13;f("#treaty").hide();f("#agreementFie").hide();f("#phonenumberFie").hide()}else{if("hy"==k.buyType){OrderInfo.actionFlag=14;f("#phonenumberFie").show()}}};var e=function(E,D){f("#choosedNumSpan").val(E);k.numFlag=true;k.numLevel=D;r();f("#treaty").show()};var o=function(D){if(D&&D.page&&D.page>=1){q(D.page,D.scroll)}};var t=function(D){if(D&&D.page&&D.page>=1){c(D.page,D.scroll)}};var c=function(E,D){OrderInfo.actionFlag=150;var F=1;if(E>0){F=E}var G={};G={startDate:(f("#p_startDt").val()).replace(/-/g,""),channelId:f("#p_channelId").val(),areaId:f("#p_channelId").attr("areaid"),pageIndex:F,pageSize:10};f.callServiceAsHtmlGet(contextPath+"/app/report/terminalSalesList",G,{before:function(){f.ecOverlay("终端销售详情查询中，请稍等...")},always:function(){f.unecOverlay()},done:function(H){if(H&&H.code==-2){return}else{OrderInfo.order.step=2;f("#terminal_sales_search").hide();f("#terminal_sales_list").html(H.data).show();f("#terminal_sales_list_scroller").css("transform","translate(0px, -40px) translateZ(0px)");if(D&&f.isFunction(D)){D.apply(this,[])}}},fail:function(H){f.unecOverlay();f.alert("提示","请求可能发生异常，请稍后再试！")}})};var q=function(F,D){f("#phoneModal").modal("hide");if(f("#pakeage").length>0){f("#pakeage").hide()}var E=contextPath+"/app/mktRes/terminal/list";var G=i(F);f.callServiceAsHtml(E,G,{before:function(){if(F==1){f.ecOverlay("<strong>查询中,请稍等...</strong>")}},always:function(){if(F==1){f.unecOverlay()}},done:function(H){if(H.code!=0){f.alert("提示","<br/>查询失败,稍后重试");return}if(F==1){f("#phone-list").html(H.data);f.refresh(f("#phone-list"))}else{f("#phone-list-all").append(H.data);f.refresh(f("#phone-list-all"))}if(D&&f.isFunction(D)){D.apply(this,[])}}})};var i=function(H){var K=ec.util.defaultStr(f("#select_brand").val());var F=ec.util.defaultStr(f("#select_phone_type").val());var G=ec.util.defaultStr(f("#phonePrice_numd01").val());var I=ec.util.defaultStr(f("#phonePrice_numd02").val());var E=f("#input_phone_name").val();if(G!=""){G=parseInt(G)*100}if(I!=""){I=parseInt(I)*100}var J=[];if(K!=""&&K!="无限"){var D={attrId:CONST.TERMINAL_SPEC_ATTR_ID.BRAND,attrValue:K};J.push(D)}if(F!=""&&F!="无限"){var D={attrId:CONST.TERMINAL_SPEC_ATTR_ID.PHONE_TYPE,attrValue:F};J.push(D)}return{mktResCd:"",mktResName:E,mktResType:"",minPrice:G,maxPrice:I,pageInfo:{pageIndex:H,pageSize:B},attrList:J}};var y=function(){mktRes.terminal.queryApConfig();mktRes.terminal.btnQueryTerminal(1)};var C=function(H){var D=H.data.length;var R;var K;var F;for(var I=0;I<D;I++){if(H.data[I].PHONE_BRAND){var N=f("#select_brand");R=H.data[I].PHONE_BRAND;for(var G=0;G<R.length;G++){var O=(R[G].COLUMN_VALUE_NAME).replace(/\"/g,"");N.append("<option value='"+O+"'>"+O+"</option>")}}if(ec.util.isArray(H.data[I].PHONE_PRICE_AREA)){K=H.data[I].PHONE_PRICE_AREA;var Q=(K[0].COLUMN_VALUE_NAME).replace(/\"/g,"");var P=Q.split("-");var J="";var E="";var M="";if(P.length!=1){J=P[0]}else{P=P.toString();J=P.substring(0,P.length-2)}Q=(K[K.length-1].COLUMN_VALUE_NAME).replace(/\"/g,"");P=Q.split("-");if(P.length!=1){E=P[1];M=E}else{P=P.toString();M=P.substring(0,P.length-2);E=""}f(".noUiSliderd").noUiSlider({range:[parseInt(J),parseInt(M)],start:[parseInt(J),parseInt(M)],step:10,slide:function(){var T=f(this).val();f("#phonePrice_numd01").val(T[0]);if(parseInt(T[0])>=parseInt(M)&&E==""){f("#phonePrice_numd02").val("")}else{f("#phonePrice_numd02").val(T[1])}}})}if(H.data[I].PHONE_TYPE){var N=f("#select_phone_type");F=H.data[I].PHONE_TYPE;for(var G=0;G<F.length;G++){var S=(F[G].COLUMN_VALUE_NAME).replace(/\"/g,"");N.append("<option value="+S+">"+S+"</option>")}}var L=f("#phoneModal");f.refresh(L)}};var s=function(){var E={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var D=contextPath+"/app/order/queryApConf";f.callServiceAsJsonGet(D,E,{done:C})};var x=function(){OrderInfo.order.step=1;OrderInfo.busitypeflag=1;var E=contextPath+"/app/mktRes/terminal/prepare";var G={};var D=f.callServiceAsHtmlGet(E,G);var F=f("#phone");F.html(D.data);f.refresh(F);y();f("#form_terminal_qry").off("submit").on("submit",function(H){H.preventDefault();mktRes.terminal.btnQueryTerminal(1)})};var b=function(D){_initBuyChk();k.buyType="hy";r();f("#buyTypeBtns .btn-default").removeClass("active");f(D).addClass("active")};var A=function(D){f("#choosedNumSpan").val("");_initBuyChk();k.buyType="lj";r();f("#buyTypeBtns .btn-default").removeClass("active");f(D).addClass("active")};var l=function(E){var F={mktResTypeCd:f(E).attr("mktResTypeCd"),mktResCd:f(E).attr("mktResCd"),mktResId:f(E).attr("mktResId"),brand:f(E).attr("brand"),phoneType:f(E).attr("phoneType"),phoneColor:f(E).attr("phoneColor"),mktName:f(E).attr("mktName"),mktPrice:f(E).attr("mktPrice"),mktPicA:f(E).attr("mktPicA")};if(CONST.getAppDesc()==0){F.mktSpecCode=f(E).attr("mktSpecCode");F.pageInfo={pageIndex:1,pageSize:B};F.attrList=[];F.is4G="yes"}var D=contextPath+"/app/mktRes/terminal/detail";f.callServiceAsHtml(D,F,{before:function(){f.ecOverlay("<strong>查询中,请稍等...</strong>")},always:function(){f.unecOverlay()},done:function(G){if(!G||G.code!=0){f.alert("提示","<br/>处理失败，请稍后重试！");return}common.callTitle(3);OrderInfo.order.step=2;var H=f("#order").html(G.data).show();f.refresh(H);f("#order_prepare").hide();_initBuyChk();f("#cNumA").click(function(){var I=OrderInfo.cust.custId;if(OrderInfo.cust==undefined||I==undefined||I==""){f.alert("提示","在选号码之前请先进行客户定位或者新建客户！");return}r();order.phoneNumber.initPage("-1","terminal")});f("#chkTsnA").off("click").on("click",function(){u("#tsn")});f("#purchaseTermA").off("click").on("click",function(){j()});f("#btn_terminal_back").off("click").on("click",function(){f("#order_prepare").show();f("#order").hide()});OrderInfo.actionFlag=13}})};var n=function(H){var L=f(H).attr("p_pic");var D=f(H).attr("mktResName");var I=f(H).attr("mktSalePrice");var J=f(H).attr("mktNormalSalePrice");var K=f(H).attr("mktResId");var E=f(H).attr("mktResTypeCd");var G=f(H).attr("mktSpecCode");f("#term_pic_id").attr("src",L);f("#mkt_resname_id").html(D);f("#mkt_saleprice_id").html(I+" 元");f("#mktResId").val(K);f("#mktResName").val(D);f("#price").val(J);f("#mktResType").val(E);f("#mktSpecCode").val(G);f("#fls_terminal_color .btn-default").removeClass("active");f("#treaty .btn-default").removeClass("active");f(H).addClass("active");var F=k.buyType;_initBuyChk();k.buyType=F;r();f("#tsn_hid").val("");f("#tsn").val("");f("#choosedNumSpan").val("");f("#choosedOfferPlan").html("");w={}};var p=function(E,F){f("#treaty .btn-default").removeClass("active");if(!k.numFlag){f.alert("提示","请先选号！");return}if(E==1){k.hyType="cfsj"}else{k.hyType="gjsf"}f(F).addClass("active");k.hyFlag=true;r();var G={mktResCd:f("#mktResId").val(),agreementType:E};var D=contextPath+"/app/mktRes/terminal/mktplan";f.callServiceAsHtmlGet(D,G,{before:function(){},always:function(){},done:function(H){if(!H){f.alert("提示","<br/>处理失败，请稍后重试！");return}if(H.code!=0){if(H.code==1006){f.alert("提示","<br/>查询不到，请稍后重试")}else{f.alert("提示","<br/>查询失败，请稍后重试")}return}f("#div_offer").html(H.data).show();f.refresh(f("#div_offer"));f("#terminalMain").hide();var I=f("#select_offerSpecId_0").val();d(I,E);f("#termOfferSpecConfirm").off("click").on("click",function(J){m()})}})};_changeHyContent=function(E,D){var F=f(E).val();d(F,D)};_changePeriod=function(F,E){var D=f(F).val();f("#tab_content .itemMain").hide();f("#tab_content_"+D).show();_changeHyContent(f("#select_offerSpecId_"+D),E)};var d=function(P,J){f("#select_offerSpecId").val(P);var G=order.service.queryPackForTerm(P,J,"");if(typeof(G)=="undefined"||G==null){f.alert("提示","<br/>未查到套餐，请稍后再试！");return}if(G.code==-2){f.alertM(G.data);
f.unecOverlay();return}if(G.code!=0||G.data.code!="POR-0000"){f.alert("提示","<br/>未查到合适套餐，请稍后再试！");return}var O="<table class='table table-striped tablecenter'>";O+="  <thead>";O+="    <tr>";O+="      <th>套餐名称</th>";O+="    </tr>";O+="  </thead>";O+="  <tbody class='panel-group'>";var M=G.data.prodOfferInfos;if(M.length==0){f.alert("提示","<br/>未查到套餐，请稍后再试！")}for(var H=0;H<M.length;H++){var N=M[H];var Q="";if(N.inFlux>=1024){Q=N.inFlux/1024+"G"}else{Q=N.inFlux+"M"}var D=ec.util.defaultStr(N.inVoice);var E=ec.util.defaultStr(N.inWIFI);var L=ec.util.defaultStr(N.inSMS);var I=ec.util.defaultStr(N.inMMS);var F=ec.util.defaultStr(N.outFlux);var K=ec.util.defaultStr(N.outVoice);O+="<tr offerSpecId='"+N.offerSpecId+"'";O+=" offerSpecName='"+N.offerSpecName+"'";O+=" price='"+N.price+"'";O+=" inWIFI='"+E+"'";O+=" inFlux='"+Q+"'";O+=" inSMS='"+L+"'";O+=" inMMS='"+I+"'";O+=" outFlux='"+F+"'";O+=" outVoice='"+K+"'";O+=" inVoice='"+D+"'>";O+=" <td>"+ec.util.defaultStr(N.offerSpecName)+"</td>";O+="</tr>"}O+="  </tbody>";O+="  </table>";f("#offerSecond").html(O);f.refresh(f("#offerSecond"));f("#offerSecond tbody tr").off("click").on("click",function(R){g(this);R.stopPropagation()})};var g=function(E){f("#offerSecond tbody tr").removeClass("success");var F=f(E).attr("offerSpecId");var D=z(F,E);if(D){f(E).addClass("success")}};var z=function(F,E){var D={price:f(E).attr("price"),id:"tcnum1",specId:F,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};order.service.opeSer(D);return true};var m=function(){var D=f("#offerSecond tbody tr[class='success']");if(D.length!=1){f.alert("提示","请选择一个套餐！");return}var E=true;f.each(OrderInfo.offerSpec.offerRoles,function(){if(this.prodInsts==undefined||this.prodInsts==null){E=false;return}});if(E){mktRes.terminal.offerSpecId=f("#select_offerSpecId").val();k.hyFlag=true;k.hyOfferSpecId=D.attr("offerSpecId");k.hyOfferSpecName=D.attr("offerSpecName");r();f("#agreementFie").show();f("#choosedOfferPlan").html(D.attr("offerSpecName"));f("#terminalMain").show();f("#div_offer").hide()}else{f.alert("提示","请选择一个接入产品！");return}};var u=function(H){w={};k.tsnFlag=false;r();f("#tsn_hid").val("");var D=f(H).val();if(D==""){return}var F={instCode:D,mktResTypeCd:f("#mktResType").val(),orderNo:""};if(CONST.getAppDesc()==0){var G=f("#mktSpecCode").val();if(f.trim(G)==""){f.alert("提示","营销资源返回的规格存货编码为空！");return}if(G.length>=22){G=G.substring(0,22)}F.mktSpecCode=G}else{F.mktResId=f("#mktResId").val()}var E=contextPath+"/mktRes/terminal/checkTerminal";f.callServiceAsJson(E,F,{done:function(I){if(I&&I.code==-2){f.alertM(I.data)}else{if(I&&I.data&&I.data.code==0){if(I.data.statusCd==CONST.MKTRES_STATUS.USABLE){f.alert("提示","<br/>此终端串号可以使用");k.tsnFlag=true;r();f("#tsn_hid").val(D);w=I.data}else{if(I.data.statusCd==CONST.MKTRES_STATUS.HAVESALE){if(k.hyType=="gjsf"){f.alert("提示","<br/>此终端串号可以使用");k.tsnFlag=true;r();f("#tsn_hid").val(D);w=I.data;w.couponSourc="2"}else{f.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}}else{f.alert("提示",I.data.message)}}}else{if(I&&I.data&&I.data.message&&I.data.code==1){f.alert("提示",I.data.message)}else{f.alert("提示","<br/>校验失败，请稍后重试！")}}}}})};var j=function(){if("lj"==k.buyType){if(!k.tsnFlag){f.alert("提示","<br/>请先校验终端串号。");return}var F=f("#price").val()/100;var H=[{couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:w.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:w.mktResStoreId,storeName:"1",agentId:1,apCharge:F,couponInstanceNumber:w.instCode,ruleId:"",partyId:CONST.CUST_COUPON_SALE,prodId:0,offerId:0,state:"ADD",relaSeq:""}];if((OrderInfo.cust.custId)&&OrderInfo.cust.custId!=""){H[0].partyId=OrderInfo.cust.custId}OrderInfo.actionTypeName="订购";OrderInfo.businessName=f("#mktResName").val();var E={};E.busiObj={instId:w.mktResId};E.boActionType={actionClassCd:CONST.ACTION_CLASS_CD.MKTRES_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.COUPON_SALE};E.coupons=H;f("#terminalMain").hide();SoOrder.getTokenSynchronize();SoOrder.submitOrder(E);return}else{if("hy"==k.buyType){if(!k.tsnFlag){f.alert("提示","<br/>请先校验终端串号。");return}if(!(OrderInfo.cust.custId)||OrderInfo.cust.custId==""){f.alert("提示","<br/>在订购套餐之前请先进行客户定位！");return}if(k.hyType==""){f.alert("提示","<br/>请选择合约!");return}}else{return}}var D={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:w.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:w.mktResStoreId,storeName:"1",agentId:1,apCharge:f("#price").val()/100,couponInstanceNumber:w.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-1,offerId:-1,attachSepcId:mktRes.terminal.offerSpecId,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){D.termTypeFlag=w.termTypeFlag}OrderInfo.attach2Coupons=[];OrderInfo.attach2Coupons.push(D);var G={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:OrderInfo.offerSpec,offerSpecId:k.hyOfferSpecId,offerSpecName:k.hyOfferSpecName,viceCardNum:Number(k.hyOfferSpecQty),feeType:k.hyOfferSpecFt,offerNum:1,type:2,actionFlag:OrderInfo.actionFlag,terminalInfo:{terminalName:f("#mktResName").val(),terminalCode:f("#tsn_hid").val()},offerRoles:k.hyOfferRoles};OrderInfo.actionTypeName="订购";SoOrder.builder();order.main.buildMainView(G)};var h=function(){if(OrderInfo.order.step==1){common.callCloseWebview()}else{if(OrderInfo.order.step==2){f("#terminal_sales_search").show();f("#terminal_sales_list").hide();OrderInfo.order.step=1}else{common.callCloseWebview()}}};var a=function(E,D){f.alert(E,D)};return{btnQueryTerminal:q,initPhone:x,queryApConfig:s,selectTerminal:l,setNumber:e,offerSpecId:v,selectColor:n,scroll:o,hyClick:b,ljClick:A,selectHy:p,changeHyContent:_changeHyContent,changePeriod:_changePeriod,termSaleScroll:t,back:h,btnQueryTerminalSale:c,showNbr:a}})(jQuery);$(function(){OrderInfo.order.step=1});CommonUtils.regNamespace("prod","uim");prod.uim=(function(){var d=function(j){var p=OrderInfo.getAccessNumber(j);var h="-1";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14||(OrderInfo.actionFlag==2&&offerChange.newMemberFlag)){if(p==""){$.alert("提示","校验UIM卡前请先选号!");return false}}if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23||OrderInfo.actionFlag==6){if(ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==j){h=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{h=order.prodModify.choosedProdInfo.prodOfferInstId}}var o=$.trim($("#uim_txt_"+j).val());if(o==undefined||o==""){$.alert("提示","UIM卡不能为空!");return false}var k={instCode:o,selUimType:"1",phoneNum:p,areaId:OrderInfo.getProdAreaId(j)};var l=OrderInfo.getProdSpecId(j);var n="";if(CONST.getAppDesc()==0){if(b(j)){n=c(CONST.PROD_SPEC_ID.MIFI_ID)}else{n=c(l)}if(ec.util.isObj(n)){}else{$.alert("提示","查询卡类型失败！");return}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(prod.changeUim.is4GProdInst){k.onlyLTE="1"}}}var i=query.prod.checkUim(k);if(i==undefined||i.baseInfo==undefined){return false}var m=i.baseInfo.qty;if(m==undefined||m==null){m=1}var g={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:i.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:m,storeId:i.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:i.baseInfo.mktResInstCode,terminalCode:i.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:j,offerId:h,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){g.cardTypeFlag=i.baseInfo.cardTypeFlag}$("#uim_check_btn_"+j).attr("disabled",true);$("#uim_release_btn_"+j).attr("disabled",false);$("#uim_release_btn_"+j).removeClass("disabled");$("#uim_txt_"+j).attr("disabled",true);if(b(j)){$("#isMIFI_"+j).val("yes")}else{$("#isMIFI_"+j).val("no")}OrderInfo.clearProdUim(j);OrderInfo.boProd2Tds.push(g);if(OrderInfo.actionFlag==22&&i.baseInfo.cardTypeFlag==1){AttachOffer.queryCardAttachOffer(i.baseInfo.cardTypeFlag)}};var b=function(l){var k=(Math.abs(l)-1);if(AttachOffer.openServList.length>k){var i=AttachOffer.openServList[k].servSpecList;
for(var h=0;h<i.length;h++){var g=i[h];if(g.isdel!="Y"&&g.isdel!="C"){if(g.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true}}}}return false};var c=function(i){var j={prodSpecId:i};var h=contextPath+"/mktRes/uim/getMktResCd";$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");var g=$.callServiceAsJson(h,j);$.unecOverlay();if(g.code=="0"){return g.data}else{return""}};var f=function(h){var g=$.trim($("#uim_txt_"+h).val());if(g==undefined||g==""){$.alert("提示","UIM卡不能为空!");return false}var j={numType:2,numValue:g};var i=$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",j);if(i.code==-2){$.alertM(i.data);return}if(i.code==-1){$.alert("提示",i.data);return}$.alert("提示","成功释放UIM卡："+g);if(OrderInfo.actionFlag==22){$("#attach").children().remove()}$("#uim_check_btn_"+h).attr("disabled",false);$("#uim_release_btn_"+h).attr("disabled",true);$("#uim_txt_"+h).attr("disabled",false);$("#uim_txt_"+h).val("");OrderInfo.clearProdUim(h)};var a=function(g,i,h){var j={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:h.couponId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:h.couponInsNumber,terminalCode:h.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:i,offerId:g,state:"DEL",relaSeq:"",id:0,isOld:"T",is4GCard:h.is4GCard};OrderInfo.boProd2OldTds.push(j);order.prodModify.choosedProdInfo.extCouponInstanceId=h.extCouponInstanceId;order.prodModify.choosedProdInfo.corCouponInstanceId=h.corCouponInstanceId};var e=function(){OrderInfo.boProd2OldTds=[];var h=true;if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){var g=order.prodModify.choosedProdInfo;var i=query.prod.getTerminalInfo(g);if(i==undefined){return false}a(g.prodOfferInstId,g.prodInstId,i);if(i.is4GCard=="Y"){g.prodClass=CONST.PROD_CLASS.FOUR}else{g.prodClass=CONST.PROD_CLASS.THREE}}else{if(OrderInfo.actionFlag==21){var g={};$.each(OrderInfo.viceOfferSpec,function(){var j=this.prodId;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==j){g.prodInstId=this.objInstId;g.accNbr=this.accessNumber;var k=query.prod.getTerminalInfo(g);if(k==undefined){h=false;return false}a(this.offerId,this.objInstId,k);if(k.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}}})})}else{var g={};$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){g.prodInstId=this.objInstId;g.accNbr=this.accessNumber;var k=query.prod.getTerminalInfo(g);if(k==undefined){h=false;return false}a(this.offerId,this.objInstId,k);if(k.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}var j=order.prodModify.choosedProdInfo;if(j!=undefined&&j.prodInstId==this.objInstId){j.prodClass=this.prodClass}}})}}return h};return{getMktResCd:c,checkUim:d,releaseUim:f,setProdUim:e,setOldUim:a}})();CommonUtils.regNamespace("query","prod");query.prod=(function(){var i=function(m){g(m);var l=contextPath+"/prod/prodSpecParamQuery";$.ecOverlay("<strong>正在查询产品规格属性中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,m);$.unecOverlay();if(k.code==0){if(k.data){return k.data}}else{if(k.code==-2){$.alertM(k.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var j=function(m){g(m);var l=contextPath+"/prod/prodInstParamQuery";$.ecOverlay("<strong>正在查询产品实例属性中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,m);$.unecOverlay();if(k.code==0){if(k.data){return k.data}}else{if(k.code==-2){$.alertM(k.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var a=function(k){var m={prodId:k.prodInstId,areaId:OrderInfo.getProdAreaId(k.prodInstId),acctNbr:k.accNbr,isServiceOpen:"Y"};$.ecOverlay("<strong>正在查询产品下终端实例数据中,请稍后....</strong>");var l=$.callServiceAsJson(contextPath+"/token/app/order/queryTerminalInfo",m,{});$.unecOverlay();if(l.code==0){return l.data}else{if(l.code==-2){$.alertM(l.data)}else{$.alert("错误提示","接口未返回号码["+m.acctNbr+"]产品原UIM卡数据，无法继续受理！")}}};var c=function(n,m){n.isServiceOpen="Y";var l=contextPath+"/order/account";if(typeof(m)=="function"){$.callServiceAsJsonGet(l,n,{before:function(){$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>")},done:function(o){$.unecOverlay();if(o.code==0){m(o.data)}else{if(o.code==-2){$.alertM(o.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,n);$.unecOverlay();if(k.code==0){if(k.data){return k.data.offerSpec}}else{if(k.code==-2){$.alertM(k.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}};var e=function(m){var l=contextPath+"/mktRes/terminal/checkTerminal";$.ecOverlay("<strong>终端校验中,请稍后....</strong>");var k=$.callServiceAsJson(l,m);$.unecOverlay();if(k.code==-2){$.alertM(k.data)}else{if(k.data&&k.data.code==0){return k.data}else{if(k.data.code==1){$.alert("提示",k.data.message)}else{$.alert("提示","<br/>校验失败，请稍后重试！")}}}};var f=function(n){var l=contextPath+"/app/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");var k=$.callServiceAsJson(l,n);$.unecOverlay();if(k.code==0){$.alert("提示","UIM卡校验成功!");return k.data}else{if(typeof k==undefined){$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常")}else{if(k.code==-2){$.alertM(k.data)}else{var m="";if(k.data!=undefined&&k.data.msg!=undefined){m=k.data.msg}else{m="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡校验失败，可能原因:"+m)}}}};var h=function(n){var l=contextPath+"/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>");var k=$.callServiceAsJson(l,n);$.unecOverlay();if(k.code==0){$.alert("提示","UIM卡释放成功!");return k.data}else{if(typeof k==undefined){$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常")}else{if(k.code==-2){$.alertM(k.data)}else{var m="";if(k.data!=undefined&&k.data.msg!=undefined){m=k.data.msg}else{m="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡释放失败，可能原因:"+m)}}}};var d=function(){var l=order.prodModify.choosedProdInfo;var k=a(l);if(k==undefined){return}var m={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:k.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:k.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:l.prodInstId,offerId:l.prodOfferInstId,state:"DEL",relaSeq:"",id:0,isOld:"T"};return m};var b=function(l){var n={prodId:l.prodInstId,prodSpecId:l.productId,offerSpecId:l.prodOfferId,acctNbr:l.accNbr};var m=query.offer.queryOpenedAttachAndServ(n);if(m&&m.result&&m.result.servLists){var k=false;$.each(m.result.servLists,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G){k=true}});return k}return false};var g=function(k){k.staffId=OrderInfo.staff.staffId;k.channelId=OrderInfo.staff.channelId;k.partyId=OrderInfo.cust.custId;k.areaId=OrderInfo.getProdAreaId(k.prodId);k.distributorId=OrderInfo.staff.distributorId;if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){k.soNbr=OrderInfo.order.soNbr}};return{checkUim:f,releaseUim:h,getTerminalInfo:a,prodSpecParamQuery:i,prodInstParamQuery:j,getOldUim:d,queryAcct:c,checkTerminal:e,checkIs4GProdInst:b}})();CommonUtils.regNamespace("common","print");common.print=(function(g){var r=function(M){var O=g("a[olId="+M+"]").attr("ifPrint");if(CONST.getAppDesc()==0&&"N"==O){var J=g("#tab_orderList tr[olId="+M+"]");var N="";var B=[];var D="false";for(var G=0;G<J.length;G++){var L=J[G];var I=g(L).attr("actionClass");if(I=="1600"){continue}D=g(L).attr("newProdFlag");if(D=="true"){break}var C=g(L).attr("objInstId");if(C==undefined||C==""){g.alert("提示","objInstId为空，请核查接口返回的数据！");return false}var H=g(L).attr("accessNumber");if(H==undefined||H==""){g.alert("提示","accessNumber为空，请核查接口返回的数据！");return false}}for(var G=0;D=="false"&&G<J.length;G++){var L=J[G];var I=g(L).attr("actionClass");if(I=="1600"){continue}var C=g(L).attr("objInstId");var H=g(L).attr("accessNumber");if(g.inArray(C,B)>=0){continue}N=g(L).attr("areaId");OrderInfo.orderResult.olNbr=g(L).attr("olNbr");var K="";
OrderInfo.order.soNbr=UUID.getDataId();var E={areaId:N,acctNbr:H,custId:K,soNbr:OrderInfo.order.soNbr,instId:C,type:"2"};var F=query.offer.invokeLoadInst(E);if(!F){return false}B.push(C)}g("a[olId="+M+"]").attr("ifPrint","Y")}if(OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olId=M;return true};var u=function(C,E){if(!r(C)){return}var D={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr};var B=new Array(3);if(ec.util.browser.versions.android){B[0]="order/sign/downVoucher"}else{B[0]="print/iosVoucher"}B[1]="voucherInfo";B[2]=JSON.stringify(D);MyPlugin.printShow(B,function(F){},function(F){})};var w=function(D){var C="1";D.PcFlag=C;var B=contextPath+"/order/sign/previewHtmlForSign";g.callServiceAsHtml(B,D,{before:function(){g.ecOverlay("<strong>生成回执预览的html,请稍等会儿....</strong>")},always:function(){g.unecOverlay()},done:function(E){if(E.code==0){g("#order-confirm").hide();g("#order-print").html(E.data).show();OrderInfo.order.step=4;g("#datasignBtn").off("click").on("click",function(){common.callDatasign("common.print.showDataSign")});g("#print_ok").off("click").on("click",function(){if(!ec.util.isObj(g("#signinput").val())){g.alert("提示","请先进行签名，然后再保存！")}else{f()}})}else{if(E.code==-2){g.alertM(E.data)}else{g.alert("提示","生成回执预览的html失败!")}}},fail:function(E){g.unecOverlay();g.alert("提示","服务忙，请稍后再试！")}})};var f=function(){var C={olId:OrderInfo.orderResult.olId,signFlag:"5",busiType:"9",sign:l(g("#signinput").val())};var B=contextPath+"/order/sign/saveSignPdfForApp";g.callServiceAsJson(B,C,{before:function(){g.ecOverlay("<strong>正在保存回执,请稍等会儿....</strong>")},done:function(D){g.unecOverlay();if(D.code==0){g("#order-confirm").show();g("#order-print").hide();g("#printVoucherA").attr("disabled","disabled");OrderInfo.order.step=3}else{if(D.code==-2){g.alertM(D.data)}else{var E=D.data.errData!=null?D.data.errData:"保存回执失败!";g.alert("提示",E)}}}})};var l=function(C){var B=new RegExp("=","g");C=C.replace(B,"<p/>");return C};var e=function(B){g("#datasign").attr("src","data:image/jpg;base64,"+B);g("#signinput").val(B)};var y=function(B,D){if(!r(B)){return}var C={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:D};common.print.printVoucher(C)};var t=function(C){var B=new Array(3);if(ec.util.browser.versions.android){B[0]="print/voucher"}else{B[0]="print/iosVoucher"}B[1]="voucherInfo";B[2]=JSON.stringify(C);MyPlugin.printShow(B,function(D){},function(D){})};var i=function(P,C,O){var H=g("a[olId="+P+"]").attr("ifInvoice");var Q=g("a[olId="+P+"]").attr("areaId");if(CONST.getAppDesc()==0&&"N"==H){var L=g("#tab_orderList tr[olId="+P+"]");var B=[];var E="false";for(var I=0;I<L.length;I++){var N=L[I];var K=g(N).attr("actionClass");if(K=="1600"){continue}E=g(N).attr("newProdFlag");if(E=="true"){break}var D=g(N).attr("objInstId");if(D==undefined||D==""){g.alert("提示","objInstId为空，请核查接口返回的数据！");return}var J=g(N).attr("accessNumber");if(J==undefined||J==""){g.alert("提示","accessNumber为空，请核查接口返回的数据！");return}}for(var I=0;E=="false"&&I<L.length;I++){var N=L[I];var K=g(N).attr("actionClass");if(K=="1600"){continue}var D=g(N).attr("objInstId");var J=g(N).attr("accessNumber");if(g.inArray(D,B)>=0){continue}Q=g(N).attr("areaId");OrderInfo.orderResult.olNbr=g(N).attr("olNbr");var M="";OrderInfo.order.soNbr=UUID.getDataId();var F={areaId:Q,acctNbr:J,custId:M,soNbr:OrderInfo.order.soNbr,instId:D,type:"2"};var G=query.offer.invokeLoadInst(F);if(!G){return}B.push(D)}g("a[olId="+P+"]").attr("ifInvoice","Y")}if(OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olNbr=C;OrderInfo.orderResult.olId=P;var F={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,billType:0,printFlag:O,areaId:Q,acctItemIds:[]};common.print.prepareInvoiceInfo(F)};var d=function(F){g.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");var C=contextPath+"/print/getInvoiceItems";var B=g.callServiceAsJson(C,F,{});g.unecOverlay();if(!B){g.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return false}if(B.code==-2){g.alertM(B.data);return false}if(B.code!=0){g.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return false}if(B.data.resultCode!="0"){g.alert("提示",B.data.resultMsg);return false}if(B.data.chargeItems==undefined||B.data.chargeItems.length==0){g.alert("提示","没有可打印的费用项");return false}else{var D=0;for(;D<B.data.chargeItems.length;D++){var E=B.data.chargeItems[D];if(E.paymentAmount!=0){break}}if(D==B.data.chargeItems.length){g.alert("提示","没有可打印的费用项");return false}}return B};var k=function(){var D={staffId:OrderInfo.staff.staffId,areaId:OrderInfo.staff.areaId,custSoNbr:OrderInfo.orderResult.olNbr,custOrderId:OrderInfo.orderResult.olId,invoiceType:"100"};var C=contextPath+"/print/getInvoiceInfo";var B=g.callServiceAsJson(C,D,{});if(!B){return false}if(B.code==-2){g.alertM(B.data);return false}if(B.code!=0){return false}if(B.data.invoiceInfos!=undefined&&B.data.invoiceInfos instanceof Array&&B.data.invoiceInfos.length>0){}else{return false}return B};var o=function(B){if(OrderInfo.cust.norTaxPayer=="Y"){g.alert("提示","客户为一般纳税人，请到省份CRM系统打印专用增值税发票！");g.confirm("提示信息","客户为一般纳税人，专用增值税发票需要到省份CRM系统打印。是否只打印普通发票?",{yes:function(){h(B)},no:function(){return}},"question")}else{h(B)}};var h=function(I){var F=d(I);if(!F){return}var D=k();if(!D){}else{var O=D.data.invoiceInfos;if(ec.util.isArray(O[0].invoiceInfos)){g("#invoiceNbrInp").val(O[0].invoiceInfos[0].invoiceNbr);g("#invoiceNumInp").val(O[0].invoiceInfos[0].invoiceNum)}else{g("#invoiceNbrInp").val(O[0].invoiceNbr);g("#invoiceNumInp").val(O[0].invoiceNum)}}var T=F.data.invoiceInfos;if(T!=undefined&&T instanceof Array&&T.length>0){}else{var X={soNbr:OrderInfo.order.soNbr,billType:0,olId:I.olId,printFlag:-1,areaId:OrderInfo.staff.areaId,acctItemIds:[]};var E=common.print.initPrintInfo(X);if(!E){return}if(I.printFlag==1){g.alert("信息","此购物车对应的发票未打印过，请到发票补打页面。");return}F=d(I);if(!F){return}}common.print.oldInvoiceFlag="0";if(q(F.data.invoiceInfos,I.printFlag)){return}var H=contextPath+"/print/getInvoiceTemplates";var L={areaId:OrderInfo.staff.areaId};var P=g.callServiceAsJson(H,L,{});if(P.code==-2){g.alertM(P.data);return}else{if(P.code!=0){g.alert("提示",ec.util.defaultStr(P.data,"获取打印模板出错"));return}else{var C=P.data;if(C.resultCode!="POR-0000"){g.alert("提示",ec.util.defaultStr(C.resultMsg,"获取打印模板异常"));return}if(C.length==0){g.alert("提示","没有获取到可用的打印模板");return}var N="";var V=C.tempList;if(typeof V!=undefined&&V.length>0){N+="<option selected='selected' value="+V[0].templateId+">"+V[0].templateName+"</option>";for(var Q=1;Q<V.length;Q++){var U=V[Q];N+="<option value="+U.templateId+">"+U.templateName+"</option>"}}g("#tempListSel").html(N)}}var R="";var W=F.data.prodInfo;if(W!=undefined&&W.length>0){R+="<option selected='selected' value="+W[0].accessNumber+">"+W[0].accessNumber+"</option>";for(var Q=1;Q<W.length;Q++){var K=W[Q];R+="<option value="+K.accessNumber+">"+K.accessNumber+"</option>"}}g("#acceNbrSel").html(R);var M="";M+="<div id='invoiceContDiv'>";M+="  <table class='searchtable'>";M+="    <tr>";M+="      <th>是否打印</th><th>费用名称</th><th>费用(元)</th><th>税金(元)</th><th>付费方式</th>";M+="    </tr>";var G=F.data.chargeItems;for(var Q=0;Q<G.length;Q++){var S=G[Q];if(Q==0){g("#invoiceTitleInp").val(S.custName)}if(S.paymentAmount==0){continue}M+="    <tr acctItemId="+S.acctItemId+" acctItemTypeId="+S.acctItemTypeId+" ";M+="        acctItemTypeName='"+S.acctItemTypeName+"' boActionType='"+S.boActionType+"' ";M+="        boActionType='"+S.boActionType+"' boId="+S.boId+" feeAmount="+S.feeAmount+" ";M+="        invoiceId="+S.invoiceId+" objId="+S.objId+" objType="+S.objType+" ";M+="        payMethodCd="+S.payMethodCd+" payMethodName="+S.payMethodName+" ";M+="        realAmount="+S.realAmount+" ";M+="        tax="+S.tax+" taxRate="+S.taxRate+" >";if(a(S)){M+="      <td><input type='checkbox' name='invoiceItemsChkBox' checked='checked'/></td>"}else{M+="      <td><input type='checkbox' name='invoiceItemsChkBox' disabled='disabled'/></td>"}M+="      <td>"+S.acctItemTypeName+"</td>";
M+="      <td>"+(S.realAmount/100).toFixed(2)+"</td>";M+="      <td>"+(S.tax/100).toFixed(2)+"</td>";M+="      <td>"+S.payMethodName+"</td>";M+="    </tr>"}M+="  </table>";M+="</div>";g("#invoiceItemsContDiv").html(M);var J=g("#div_printInvoice").html();g("#div_printInvoice").html("");var B=g.popup("#div_printInvoice_prepare",J,{width:g(window).width()-200,height:g(window).height(),contentHeight:g(window).height()-120,afterClose:function(){g("#div_printInvoice").html(J)}});g("#billType").off("change").on("change",function(Y){if(g("#billType").val()=="0"){g("#invoiceNbrNumDl").show();g("#titleDt").html("发票抬头：");g("#tempDt").html("发票模板：");I.billType=0}else{g("#invoiceNbrNumDl").hide();g("#titleDt").html("票据抬头：");g("#tempDt").html("票据模板：");I.billType=1}});g("#invoiceItemsConfirm").off("tap").on("tap",function(Y){if(common.print.oldInvoiceFlag!="0"){g.alert("信息","存在未作废发票，请先确定作废发票");return}m(I,F.data)});g("#invoiceItemsConCancel").off("tap").on("tap",function(Y){g("#div_printInvoice_prepare").popup("close")})};var p=function(H){var C=contextPath+"/print/getInvoiceItems";var E=g.callServiceAsJson(C,H);if(!E){g.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(E.code==-2){g.alertM(E.data);return}if(E.code!=0){g.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(E.data.resultCode!="0"){g.alert("提示",E.data.resultMsg);return}if(E.data.chargeItems==undefined||E.data.chargeItems.length==0){g.alert("提示","没有可打印的费用项");return}var B=x(H,E.data);var D=B.invoiceInfos;var G={invoiceInfos:D};var F=j(G,H.printFlag);if(F==false){return false}D=s(D,F.data.invoiceIds,"0");return D};var c=function(B){if(B=="-1"){return"初始打印"}else{if(B=="0"){return"正常打印"}else{if(B=="1"){return"重打"}else{if(B=="2"){return"补打"}else{return"未知操作"}}}}};var q=function(D,C){if(D!=undefined&&D instanceof Array&&D.length>0){for(var B=0;B<D.length;B++){if(!D[B]){g.alert("信息","接口返回的发票信息不是有效值，请确认。");return true}if(D[B].printFlag=="-1"){if(C=="0"||C=="2"){}else{g.alert("信息","此购物车对应的发票未打印过，请到发票补打页面。");return true}}else{if(D[B].printFlag=="0"){if(D[B].billType=="1"){return false}if(C=="1"){b(D,C)}else{g.alert("信息","此购物车对应的发票正常打印过，只允许重打。");return true}}else{if(D[B].printFlag=="1"||D[B].printFlag=="2"){if(C=="1"){b(D,C)}else{g.alert("信息","此购物车对应的发票已打印过，只允许重打。");return true}}else{g.alert("信息","发票信息中打印标识值不规范");return true}}}}return false}else{if(C=="0"){return false}else{g.alert("信息","此购物车没有对应的发票信息，不能进行补打或重打");return true}}};var b=function(F,D){if(F!=undefined&&F instanceof Array&&F.length>0){var B='<ul data-role="listview" style="min-width:380px;min-height: 140px">';B+="<li>存在未作废发票，请先作废发票：</li>";var E=[];for(var C=0;C<F.length;C++){var G=F[C];if(g.inArray(G.invoiceId,E)>=0){}else{B+="<li>发票代码："+G.invoiceNbr+";发票号码："+G.invoiceNum+"</li>";E.push(G.invoiceId)}}B+="</ul>";if(E.length>0){common.print.oldInvoiceFlag="1";g("#invalidInvoiceInfoDiv").html(B);g.jqmRefresh(g("#invalidInvoiceInfoDiv"));g("#dlg-invalid-invoice").popup("open");g("#invalidInvoiceConfirm").off("tap").on("tap",function(){common.print.oldInvoiceFlag="0";g("#dlg-invalid-invoice").popup("close")})}return false}else{return false}};var a=function(B){var C=B.payMethodCd;if(C==CONST.PAYMETHOD_CD.ZHANG_WU_DAI_SHOU){return false}return true};var v=function(C){try{if(C.billType!=1){if(g("#invoiceNbrInp").val()==""){g.alert("提示","请输入发票代码");return true}if(!/^\d{0,12}$/.test(g("#invoiceNbrInp").val())){g.alert("提示","请输入正确的发票代码");return true}if(g("#invoiceNumInp").val()==""){g.alert("提示","请输入发票号码");return true}if(!/^\d{0,12}$/.test(g("#invoiceNumInp").val())){g.alert("提示","请输入正确的发票号码");return true}}if(g("#invoiceTitleInp").val()==""){g.alert("提示","请输入发票抬头");return true}if(g("#invoiceContDiv tbody input:checked").length<1){g.alert("提示","请选择要打印的费用项");return true}}catch(B){return true}return false};var x=function(B,G){var O=[];var K={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"100",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:B.billType,printFlag:B.printFlag,invoiceId:0};var D=false;var F=0;var P=0;var M=0;var J=[];var C="";var H=G.chargeItems;for(var E=0;E<H.length;E++){var L=H[E];K.acctItemIds.push({acctItemId:L.acctItemId});if(L.objType=="2"){K.instanceType=L.objType;K.instanceId=L.objId;K.paymethod=L.payMethodCd;D=true}else{if(!D&&L.objType=="7"){K.instanceType=L.objType;K.instanceId=L.objId;K.paymethod=L.payMethodCd}}F+=parseInt(L.feeAmount);P+=parseInt(L.realAmount);M+=parseInt(L.tax);C=L.payMethodName}K.amount=F;K.realPay=P;K.tax=M;K.account=P;K.accountUpper=ec.util.atoc(P);K.invoiceNbr=0;K.invoiceNum="0";var I=G.prodInfo;if(I!=undefined&&I.length>0){K.acctNbr=I[0].accessNumber}O.push(K);var N={payMethodName:C,items:J,invoiceInfos:O};return N};var n=function(B,G){var L=[];var I={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"100",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:B.billType,printFlag:B.printFlag,invoiceId:0};I.invoiceId=G.invoiceInfos[0].invoiceId;I.billType=g("#billType").val();if(I.billType=="0"){I.invoiceType="100"}else{I.invoiceType="200"}var D=false;var F=0;var M=0;var J=0;var H=[];var C="";var E=A(G);I.acctItemIds=[];g("#invoiceContDiv tbody input:checked").parent().parent().parent().each(function(){I.acctItemIds.push({acctItemId:g(this).attr("acctItemId")});if(g(this).attr("objType")=="2"){I.instanceType=g(this).attr("objType");I.instanceId=g(this).attr("objId");I.paymethod=g(this).attr("payMethodCd");D=true}else{if(!D&&g(this).attr("objType")=="7"){I.instanceType=g(this).attr("objType");I.instanceId=g(this).attr("objId");I.paymethod=g(this).attr("payMethodCd")}}F+=parseInt(g(this).attr("feeAmount"));M+=parseInt(g(this).attr("realAmount"));J+=parseInt(g(this).attr("tax"));var O="";var N=g(this).attr("boId");for(var P=0;P<E.length;P++){if(N==E[P].boId){O=E[P].accessNumber}}H.push({itemName:g(this).attr("acctItemTypeName"),charge:parseInt(g(this).attr("realAmount")),tax:parseInt(g(this).attr("tax")),acceNumber:O});C=g(this).attr("payMethodName")});if(OrderInfo.actionFlag==11){I.printFlag=0}I.amount=F;I.realPay=M;I.tax=J;I.account=M;I.accountUpper=ec.util.atoc(M);I.invoiceNbr=g("#invoiceNbrInp").val();I.invoiceNum=""+g("#invoiceNumInp").val();I.acctNbr=g("#acceNbrSel option:selected").val();L.push(I);var K={payMethodName:C,items:H,invoiceInfos:L};return K};var A=function(H){var E=[];var I=H.chargeItems;var J=H.prodInfo;for(var F=0;F<I.length;F++){var L=I[F].boId;for(var C=0;C<J.length;C++){var G=J[C].accessNumber;var K=J[C].busiOrders;for(var B=0;B<K.length;B++){if(K[B].boId==L){var D={boId:L,accessNumber:G};E.push(D)}}}}return E};var m=function(H,E){if(v(H)){return}if(!E.invoiceInfos[0]){g.alert("提示","集团营业受理后台接口返回缺少发票信息，请确认。");return}var B=n(H,E);var D=B.invoiceInfos;var G={invoiceInfos:D};var F=j(G,H.printFlag);if(F==false){return}var C={partyName:g("#invoiceTitleInp").val(),templateId:g("#tempListSel :selected").val(),prodInfo:E.prodInfo,items:B.items,payMethod:B.payMethodName,invoiceInfos:D};z(C);if(OrderInfo.cust.norTaxPayer!="Y"){g("#div_printInvoice_prepare").popup("close")}return};var j=function(D,C){g.ecOverlay("<strong>正在提交中,请稍等会儿....</strong>");var B=g.callServiceAsJson(contextPath+"/print/saveInvoiceInfo",D);g.unecOverlay();if(B.code==-2){g.alertM(B.data);return false}else{if(B.code!=0||B.data.resultCode!="0"){g.alert("提示",c(C)+"调用集团发票打印处理接口失败，请稍后重试");return false}}return B};var s=function(E,D,C){for(var B=0;B<E.length;B++){E[B].invoiceId=D[B];
E[B].printFlag=C}return E};var z=function(C){var B=new Array(3);if(ec.util.browser.versions.android){B[0]="print/invoice"}else{B[0]="print/iosInvoice"}B[1]="invoiceParam";B[2]=encodeURI(JSON.stringify(C));MyPlugin.printShow(B,function(D){},function(D){})};return{showDataSign:e,signVoucher:w,preVoucher:y,preSign:u,printVoucher:t,preInvoice:i,initPrintInfo:p,prepareInvoiceInfo:o,saveInvoiceInfo:m,chkInput:v,printInvoice:z}})(jQuery);$(function(){});CommonUtils.regNamespace("order","dealer");order.dealer=(function(){var c=function(){if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:"40020005",NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:"40020006",NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:"40020007",NAME:"第三发展人"}]}else{$.ecOverlay("<strong>正在查询发展人类型中,请稍后....</strong>");var q=$.callServiceAsJson(contextPath+"/app/order/queryPartyProfileSpecList",null);$.unecOverlay();if(q.code==0){OrderInfo.order.dealerTypeList=q.data}else{if(q.code==-2){$.alertM(q.data);return}else{$.alert("信息提示",q.msg);return}}}$("#dealerTbody").empty();if(OrderInfo.actionFlag!=3&&OrderInfo.actionFlag!=2){$("#head").text(OrderInfo.offerSpec.offerSpecName)}var y=OrderInfo.provinceInfo.reloadFlag;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==14){var s=OrderInfo.offerSpec.offerSpecId;var w=$("<li id='tr_"+s+"' name='tr_"+s+"' href='#' class='list-group-item'></li>");w.append("<h5 class='list-group-item-heading text-warning'>主套餐</h5>");w.append("<p class='list-group-item-text'>"+OrderInfo.offerSpec.offerSpecName+"</p><p> </p>");var F=$("<p> </p>");var G=$('<div class="row"> </div>');var v=$('<div class="col-xs-6" style="width:33%"> </div>');var A=OrderInfo.SEQ.dealerSeq;var x=s+"_"+A;OrderInfo.codeInfos.developmentObjId=x;var D=$('<select id="dealerType_'+x+'" name="dealerType_'+s+'"  class="selectpicker show-tick form-control" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+s+"',a)\"></select>");var u;var p=$("<div class='col-xs-6' style=\"width:33%\"></div>");var r=$('<select id="dealerChannel_'+x+'" name="dealerChannel_'+s+'" class="selectpicker show-tick form-control styled-select" onclick=a=this.value;></select>');if(y=="N"){if(OrderInfo.reloadProdInfo.dealerlist.length>0){$.each(OrderInfo.reloadProdInfo.dealerlist,function(J,K){if(this.offerTypeCd=="1"){if(this.role!=undefined){var L=this.role;$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==L){D.append("<option value='"+this.PARTYPRODUCTRELAROLECD+'\' selected="selected">'+this.NAME+"</option>")}else{D.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}})}var I=this.staffid;if(I!=null&&I!=""&&I!=undefined){u=$('<div class="col-xs-6" style="width:33%"><input type="text" onclick="javascript:order.dealer.showDealer(0,\'dealer\',\''+x+'\');" onChange="javascript:this.staffId=OrderInfo.staff.staffId;this.value=OrderInfo.staff.staffName" class="form-control" id="dealer_'+x+'" staffId="'+I+'" value="'+this.staffname+'" ></input></div>')}var H=this.channelNbr;$.each(OrderInfo.channelList,function(){if(this.channelNbr==H){r.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{r.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}})}})}$("#order_remark").val(OrderInfo.reloadProdInfo.orderMark)}else{$.each(OrderInfo.order.dealerTypeList,function(H,I){D.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});u=$('<div class="col-xs-6" style="width:33%"><input type="text" onclick="javascript:order.dealer.showDealer(0,\'dealer\',\''+x+'\');" onChange="javascript:this.staffId=OrderInfo.staff.staffId;this.value=OrderInfo.staff.staffName" class="form-control" id="dealer_'+x+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" ></input></div>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){r.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{r.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}})}v.append(D);G.append(v);G.append(u);p.append(r);G.append(p);w.append(G);w.append(F);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(w);$.refresh($("#dealerTbody"))}if(OrderInfo.actionFlag==6){}if(OrderInfo.actionFlag==13){var s=$("#mktResId").val();var w=$("<li id='tr_"+s+"' name='tr_"+s+"'></li>");var B=$("<dl></dl>");var z=$("<dd></dd>");var C=$('<fieldset data-role="fieldcontain"></fieldset>');var x=s+"_"+OrderInfo.SEQ.dealerSeq;var D=$('<select id="dealerType_'+x+'" name="dealerType_'+s+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+s+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){D.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});C.append(D);z.append(C);B.append(z);var E=$('<dd><input type="text" id="dealer_'+x+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');B.append(E);var t='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';t+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+x+"');\">选择</button></div>";t+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+s+',1)">添加</button></div></div></dd>';B.append(t);w.append(B);OrderInfo.SEQ.dealerSeq++;$("#dealerMktTbody").append(w);$.jqmRefresh($("#dealerMktTbody"))}if(y!=null&&y!=""&&y=="N"){if(OrderInfo.reloadProdInfo.dealerlist.length>0){$.each(OrderInfo.reloadProdInfo.dealerlist,function(I,V){if(this.offerTypeCd=="2"){var K=this.objInstId;var O=this.prodId;if(this.role!=undefined){var H=K+"_"+OrderInfo.SEQ.dealerSeq;var P=$("#atr_"+K);var Q=$('<li name="tr_'+O+"_"+K+'" id="tr_'+O+"_"+K+"\" class='list-group-item'></li>");Q.append("<h5 class='list-group-item-heading text-warning'>"+this.accessNumber+"[<a href=\"javascript:order.dealer.removeDealerNew('"+O+"_"+K+"');\">删除</a>]</h5>");Q.append("<p class='list-group-item-text'>"+this.objName+"</p>");Q.append("<p ></p>");var R=$('<div class="row"> </div>');var N=$('<div class="col-xs-6" style="width:33%"> </div>');OrderInfo.codeInfos.developmentObjId=H;var M=$('<select id="dealerType_'+H+'" name="dealerType_'+O+"_"+K+'"  class="selectpicker show-tick form-control" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+K+"',a)\"></select>");var U=this.role;$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==U){M.append("<option value='"+this.PARTYPRODUCTRELAROLECD+'\' selected="selected">'+this.NAME+"</option>")}else{M.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});N.append(M);R.append(N);var J=$('<div class="col-xs-6" style="width:33%"><input type="text" onclick="javascript:order.dealer.showDealer(0,\'dealer\',\''+H+'\');" onChange="javascript:this.staffId=OrderInfo.staff.staffId;this.value=OrderInfo.staff.staffName" class="form-control" id="dealer_'+H+'" staffId="'+this.staffid+'" value="'+this.staffname+'" ></input></div>');R.append(J);var T=this.channelNbr;var L=$("<div class='col-xs-6' style=\"width:33%\"></div>");var S=$('<select id="dealerChannel_'+H+'" name="dealerChannel_'+O+"_"+K+'" class="selectpicker show-tick form-control styled-select" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.channelNbr==T){S.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{S.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});L.append(S);R.append(L);Q.append(R);Q.append("<p ></p>");$("#dealerTbody").append(Q);OrderInfo.SEQ.dealerSeq++}}})}}};function b(q,p,v){$("#sel").empty();
$("#diqu").empty();var t=OrderInfo.staff.areaId.substring(0,3)+"0000";var u=OrderInfo.staff.areaAllName.substring(0,OrderInfo.staff.areaAllName.indexOf(">"));var s=$('<select  class="selectpicker show-tick form-control" onChange="order.dealer.queryChildNode('+t+')">');var r=$('<option value="">'+u+"</option>");s.append(r);$("#sel").append(s);s.addClass("styled-select");o(t);$("#queryStaff").off("click").on("click",function(){n(q,p,v)})}function o(p){var q={upRegionId:p,areaLevel:3,areaLimit:0};$.callServiceAsJson(contextPath+"/app/orderQuery/areaTreeAllChilden",q,{before:function(){},done:function(s){if(s.data){var r="";var u=s.data;if(u.length>0){for(var t=0;t<u.length;t++){if(u[t].commonRegionId==OrderInfo.staff.areaId.substring(0,5)+"00"){r=r+"<option  selected='selected' value='"+u[t].commonRegionId+"' zone_number='"+u[t].zoneNumber+"' name='"+u[t].regionName+"'>"+u[t].regionName+"</option>"}else{r=r+"<option value='"+u[t].commonRegionId+"' zone_number='"+u[t].zoneNumber+"' name='"+u[t].regionName+"'>"+u[t].regionName+"</option>"}}$("#diqu").html(r);$("#diqu").addClass("styled-select");$("#developModal").modal("show")}}}})}function k(q){var p=$("#staff_list_body .plan_select");p.each(function(){$("#dealer_"+q).val($(this).attr("staffName")).attr("staffId",$(this).attr("staffId"))});if(p.length>0){easyDialog.close()}else{$.alert("操作提示","请选择 协销人！")}}function n(q,p,t){if($("#staffName").val()==""&&$("#staffCode").val()==""){$.alert("操作提示","请输入工号或者姓名！");return}var r=$("#staffCode").val();var s={dealerId:p,areaId:$("#diqu").val(),name:$("#staffName").val(),code:r,pageIndex:1,objInstId:t,pageSize:1};$.callServiceAsJson(contextPath+"/app/staffMgr/getStaffList2",s,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},done:function(u){$.unecOverlay();if(!u){u.data=""}if(u.code==0){if(u.data.length==0){if(r!=null&&r!=""){$.alert("操作提示","未查询到工号为["+r+"]的员工信息")}else{$.alert("操作提示","没有查询到该员工信息！")}}else{$("#dealer_"+t).attr("value",u.data[0].staffName).attr("staffId",u.data[0].staffId);$("#developModal").modal("hide")}}else{if(u.code==-2){$.alertM(u.data);return}else{$.alert("信息提示",u.msg);return}}}})}var g=function(p,s,r){var q=0;$("select[name="+s+"]").each(function(){if($(this).val()==$(p).val()){q++}});if(q>1){$.alert("信息提示","每个业务的发展人类型不能重复");$(p).val(r)}};var e=function(){$("input[name=attach_dealer]:checked").each(function(){var r=$(this).attr("id");var v=r.split("_")[0];if($("#tr_"+r)[0]==undefined){var p=r+"_"+OrderInfo.SEQ.dealerSeq;var w=d(r,p);if(w==undefined){return false}var x=$("#atr_"+r);var y=$("<li name='tr_"+r+"' id='tr_"+r+"' class='list-group-item'></li>");y.append("<h5 class='list-group-item-heading text-warning'>"+x.children().eq(1).text()+"[<a href=\"javascript:order.dealer.removeDealerNew('"+r+"');\">删除</a>]</h5>");y.append("<p class='list-group-item-text'>"+x.children().eq(2).text()+"</p>");y.append("<p ></p>");var z=$('<div class="row"> </div>');var u=$('<div class="col-xs-6" style="width:33%"> </div>');OrderInfo.codeInfos.developmentObjId=p;var t=$('<select id="dealerType_'+p+'" name="dealerType_'+r+'"  class="selectpicker show-tick form-control" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+r+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){t.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});u.append(t);z.append(u);var q=$('<div class="col-xs-6" style="width:33%"><input type="text" onclick="javascript:order.dealer.showDealer(0,\'dealer\',\''+p+'\');" onChange="javascript:this.staffId=OrderInfo.staff.staffId;this.value=OrderInfo.staff.staffName" class="form-control" id="dealer_'+p+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" ></input></div>');z.append(q);var s=$("<div class='col-xs-6' style=\"width:33%\"></div>");var A=$('<select id="dealerChannel_'+p+'" name="dealerChannel_'+r+'" class="selectpicker show-tick form-control styled-select" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){A.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{A.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});s.append(A);z.append(s);y.append(z);y.append("<p ></p>");$("#dealerTbody").append(y);OrderInfo.SEQ.dealerSeq++}});$("#addModal").modal("hide")};var h=function(t,q,x){var y=$(t).parent().parent().parent().parent().parent();var r=q+"_"+OrderInfo.SEQ.dealerSeq;var u=d(q,r);if(u==undefined){return}var w=$('<li name="tr_'+q+'"></li>');var s=$("<dl></dl>");if(OrderInfo.actionFlag!=13){s.append("<dd>"+y.find("dd").eq(0).text()+"</dd>");s.append("<dd>"+y.find("dd").eq(1).text()+"</dd>")}s.append(u);if(order.ysl!=undefined){var v=$('<dd><input type="text" id="dealer_'+r+'" name="dealer_'+q+'" staffId="'+y.find("input").attr("staffId")+'" value="'+y.find("input").attr("value")+'"  data-mini="true"></input></dd>');s.append(v)}else{var v=$('<dd><input type="text" id="dealer_'+r+'" name="dealer_'+q+'" staffId="'+y.find("input").attr("staffId")+'" value="'+y.find("input").attr("value")+'"  data-mini="true"  readonly="readonly"></input></dd>');s.append(v)}var p='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';p+="<button data-mini=\"ture\" onclick=\"order.main.queryStaff('dealer','"+r+"');\">选择</button></div>";p+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';s.append(p);w.append(s);y.after(w);$.jqmRefresh($("#dealerTbody"));OrderInfo.SEQ.dealerSeq++};var l=function(q,p){$("li[name^='tr_"+q+"']").each(function(){$(this).find("dd").eq(0).text(p)})};var d=function(t,q){var s="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var v=this.PARTYPRODUCTRELAROLECD;var u=true;$("select[name='dealerType_"+t+"']").each(function(){if(v==$(this).val()){u=false;return false}});if(u){s=v;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(s==undefined||s==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var r=$("<dd></dd>");var q=t+"_"+OrderInfo.SEQ.dealerSeq;var p=$('<select id="dealerType_'+q+'" name="dealerType_'+t+'"  class="selectpicker show-tick form-control" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+t+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==s){p.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{p.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});r.append(p);return r};var m=function(){$("#addBody").empty();var p=$('<div data-role="content"></div>');var y=$('<table class="searchtable"></table>');y.append('<tr><th>操作</th><th style="width:150px;text-align:center;">号码</th><th style="text-align:center;">发展业务</th></tr>');$.each(AttachOffer.openList,function(){var B=this.prodId;var A="";if(OrderInfo.actionFlag==6){A=OrderInfo.getAccessNumber(B);for(var z=0;z<OrderInfo.oldprodInstInfos.length;z++){if(B==OrderInfo.oldprodInstInfos[z].prodInstId){A=OrderInfo.oldprodInstInfos[z].accNbr}}}else{A=OrderInfo.getAccessNumber(B)}if(A==undefined||A==""){A="未选号"}$.each(this.specList,function(){var D=B+"_"+this.offerSpecId;if(this.isdel!="Y"&&this.isdel!="C"&&$("li[name='tr_"+D+"']")[0]==undefined){var C=$('<tr id="atr_'+D+'" onclick="order.dealer.checkAttach(\''+B+"','"+this.offerSpecId+"');\"></tr>");C.append("<td style='text-align:center'><input type='checkbox' id=\""+D+'" onclick="order.dealer.checkAttach(\''+B+"','"+this.offerSpecId+'\');" name="attach_dealer"/></td>');
C.append("<td style='text-align:center'>"+A+"</td><td style='text-align:center'>"+this.offerSpecName+"</td>");y.append(C)}})});if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){for(var u=0;u<order.ysl.openList.length;u++){if(order.ysl.openList[u].type=="1"){var v="-1";var r=$("#choosedNumSpan").val();if(r==undefined||r==""){r="未选号"}var x="N";var t=$("#dealerTbody").find("tr");t.each(function(){if($(this).attr("name")=="tr_-1_"+order.ysl.openList[u].id){x="Y"}else{x="N"}});if(x=="N"){var q=v+"_"+order.ysl.openList[u].id;var w=$('<tr id="atr_'+q+'" onclick="order.dealer.checkAttach(\''+q+"')\"></tr>");w.append('<td><input type="checkbox" id="'+q+'" onclick="order.dealer.checkAttach(\''+q+'\')" name="attach_dealer"/></td>');w.append("<td style='text-align:center'>"+r+"</td><td>"+order.ysl.openList[u].name+"</td>");y.append(w)}}}}}p.append(y);var s='<div data-role="footer" data-position="inline" data-tap-toggle="false" data-theme="n"> <button data-inline="true" data-icon="next" id="sureAdddealer">确定</button>';s+='<button data-inline="true" data-icon="back" data-rel="back" id="closeAdddealer">取消</button></div>';$("#addBody").append(p);$("#addModel").modal("show");$("#sureAdddealer").off("click").on("click",function(){e()});$("#addModal").modal("show")};var j=function(q,r){var p=$("#"+q+"_"+r);if(p.attr("checked")=="checked"){}else{}};var a=function(p){$(p).parent().parent().parent().parent().parent().remove();$.refresh($("#dealerTbody"))};var f=function(p){$("#tr_"+p).remove()};var i=function(p){$("li[name^='tr_"+p+"']").each(function(){$(this).remove()});$.refresh($("#dealerTbody"))};return{initDealer:c,changeAccNbr:l,showOfferList:m,addProdDealer:h,addAttachDealer:e,checkAttach:j,removeDealer:a,removeAttDealer:i,changeDealer:g,queryStaff:n,showDealer:b,queryChildNode:o,removeDealerNew:f}})();CommonUtils.regNamespace("offerChangeNew");offerChangeNew=(function(){var s=[];var D=0;var Q=function(){OrderInfo.order.step=1;OrderInfo.actionFlag=2;OrderInfo.busitypeflag=2;if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!query.offer.setOffer()){return}}order.service.queryApConfig();query.offer.loadInst();offerChangeNew.searchPack()};var e=function(ac,ab){var ad=OrderInfo.cust.custId;var af=$("#qryStr").val();var Y={qryStr:af,pnLevelId:"",custId:ad};if(ac){var X=$("#select_price").val();if(ec.util.isObj(X)){var aa=X.split("-");if(aa[0]!=null&&aa[0]!=""){Y.priceMin=aa[0]}if(aa[1]!=null&&aa[1]!=""){Y.priceMax=aa[1]}}var ae=$("#select_invoice").val();if(ec.util.isObj(ae)){var W=ae.split("-");if(W[0]!=null&&W[0]!=""){Y.INFLUXMin=W[0]*1024}if(W[1]!=null&&W[1]!=""){Y.INFLUXMax=W[1]*1024}}var V=$("#select_influx").val();if(ec.util.isObj(V)){var Z=V.split("-");if(Z[0]!=null&&Z[0]!=""){Y.INVOICEMin=Z[0]}if(Z[1]!=null&&Z[1]!=""){Y.INVOICEMax=Z[1]}}}offerChangeNew.queryData(Y,ac,ab)};var K=function(Z,W,V){if(OrderInfo.actionFlag==2){var aa=order.prodModify.choosedProdInfo.prodOfferId;if(aa!=undefined){Z.changeGradeProdOfferId=aa}var Y="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.objId!=undefined){Y=Y+","+this.objId}}});if(Y!=""){Y=Y.substring(1,Y.length);Z.prodSpecId=Y}Z.actionFlag=2}else{if(CONST.getAppDesc()==0){Z.prodOfferFlag="4G"}}var X="";if(OrderInfo.provinceInfo.reloadFlag=="N"){X=contextPath+"/token/app/order/offerSpecListSub"}else{if(OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""&&OrderInfo.provinceInfo.prodOfferId!=""&&OrderInfo.provinceInfo.prodOfferId!="undefined"){X=contextPath+"/token/app/order/offerSpecListSub"}else{X=contextPath+"/token/app/order/offerSpecList"}}$.callServiceAsHtmlGet(X,Z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay();$("#search-modal").modal("hide")},done:function(ab){$("#search-modal").modal("hide");if(ab.code!=0){$.alert("提示","<br/>查询失败,稍后重试");return}$.unecOverlay();var ad=$("#offer-list");ad.html(ab.data);if(V&&$.isFunction(V)){V.apply(this,[])}if(OrderInfo.provinceInfo.reloadFlag=="N"){var ac="";$.each(OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="1"){ac=this.busiObj.objId}});offerChangeNew.buyService(ac,"")}else{if(OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""){order.service.buyService(OrderInfo.provinceInfo.prodOfferId,"")}}},fail:function(ab){$.unecOverlay();$("#search-modal").modal("hide");$.alert("提示","套餐加载失败，请稍后再试！")}})};var i=function(V,X){var W=OrderInfo.cust.custId;offerprice=X;if(OrderInfo.cust==undefined||W==undefined||W==""){$.alert("提示","在订购套餐之前请先进行客户定位！")}else{var Z={price:X,specId:V,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};if(OrderInfo.actionFlag==2){offerChangeNew.opeSer(Z)}else{var Y=[{boActionTypeCd:"S1",instId:"",specId:V}];rule.rule.ruleCheck(Y,function(aa){if(ec.util.isObj(aa)){$("#order_prepare").hide();var ab=$("#order").html(aa).show();$.refresh(ab)}else{order.service.opeSer(Z)}})}}};var A=function(aa){var W={offerSpecId:aa.specId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var X=query.offer.queryMainOfferSpec(W);if(!X){return}if(OrderInfo.actionFlag==2){var V=contextPath+"/app/order/queryFeeType";$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");var Y=$.callServiceAsJsonGet(V,W);$.unecOverlay();if(Y.code==0){if(Y.data!=undefined){if("0"==Y.data){var ad=false;if(order.prodModify.choosedProdInfo.feeType=="2100"&&(X.feeType=="2100"||X.feeType=="3100"||X.feeType=="3101"||X.feeType=="3103"||X.feeType=="1202"||X.feeType=="2101")){ad=true}else{if(order.prodModify.choosedProdInfo.feeType=="1200"&&(X.feeType=="1200"||X.feeType=="3100"||X.feeType=="3102"||X.feeType=="3103"||X.feeType=="1202"||X.feeType=="2101")){ad=true}else{if(order.prodModify.choosedProdInfo.feeType=="1201"&&(X.feeType=="1201"||X.feeType=="3101"||X.feeType=="3102"||X.feeType=="3103")){ad=true}}}if(!ad){$.alert("提示","付费类型不一致,无法进行套餐变更。");return}}}}offerChangeNew.offerChangeView();return}var Z=0;var ac=0;var ab="";$("#div_content").empty();$.each(X.offerRoles,function(){var ae=this;if(ae.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){$.each(this.roleObjs,function(){var af=ae.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){if(ae.minQty==0){this.minQty=0;this.dfQty=0}ac=this.maxQty<0?"不限制":this.maxQty;ab+="<div class='form-group'><label for='"+af+"'>副卡数量:"+this.minQty+"-"+ac+"(张)</label><div class='input-group input-group-lg'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.subNum('"+af+"',"+this.minQty+")> - </button></span><input type='text'  readonly='readonly' class='form-control' id='"+af+"' value='"+this.dfQty+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.addNum('"+af+"',"+this.maxQty+",'"+ae.parentOfferRoleId+"')> + </button></span> </div></div>";Z++;return false}})}});var W={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:X,actionFlag:1,type:1};if(Z>0){$("#div_content").append(ab);$("#vice_modal").modal("show");$("#btn_modal").off("click").on("click",function(){order.service.confirm(W)})}else{if(!_setOfferSpec(1)){$.alert("错误提示","请选择一个接入产品");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(W)}}};var F="";var M=function(){s=[];var X=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==2){X++}});var W=1;var ab=0;if(X>1){W=2}if(!m(W,ab)){return}if(OrderInfo.actionFlag==2){var ad=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;var ac=1;var V=1;order.memberChange.newSubPhoneNum="";order.memberChange.oldSubPhoneNum="";$.each(ad,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){order.memberChange.newmembers.flag=true;if(ac==1){order.memberChange.newSubPhoneNum+=this.busiObj.accessNumber;ac++}else{order.memberChange.newSubPhoneNum+=","+this.busiObj.accessNumber}}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"){if(this.busiObj.isComp!=undefined){order.memberChange.oldmembers.flag=true;
if(V==1){order.memberChange.oldSubPhoneNum+=this.busiObj.accessNumber;V++}else{order.memberChange.oldSubPhoneNum+=","+this.busiObj.accessNumber}var af=this.data.ooRoles[0].objInstId;var ae=this.busiObj.instId;order.memberChange.oldmembers.objInstId.push({instId:ae,objInstId:af})}}}});var Y=[];var Z=[];if(order.memberChange.newSubPhoneNum!=""){Y=order.memberChange.newSubPhoneNum.split(",")}if(order.memberChange.oldSubPhoneNum!=""){Z=order.memberChange.oldSubPhoneNum.split(",")}var aa=0;F="";$("#div_content").empty();$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd=="401"){var ae=this;$.each(this.roleObjs,function(){var ah=ae.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){s.push(ah);if(ae.minQty==0){this.minQty=0;this.dfQty=0}var ag=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd=="401"){ag++}});aa=this.maxQty<0?"不限制":this.maxQty-ag;if(aa<0){aa=0}D=aa;F+="<div class='form-group' id='memberTable'><label for='"+ah+"'>副卡数量:"+this.minQty+"-"+aa+"(张)</label><div class='input-group input-group-lg'><label>"+this.objName+"</label><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.subNum('"+ah+"',"+this.minQty+")> - </button></span><input type='text' style='margin-top:10px;' readonly='readonly' class='form-control' id='"+ah+"' value='"+Y.length+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.service.addNum('"+ah+"',"+this.maxQty+",'"+ae.parentOfferRoleId+"')> + </button></span> </div>";if(aa>0){for(var af=0;af<Z.length;af++){if(af==0){F+="<div class='input-group input-group-lg'><label style='width:170px;'>已有移动电话</label><span class='input-group-btn' style='width:40px'></span><input type='text' style='margin-top:10px;' class='form-control' name='oldphonenum' value='"+Z[af]+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick='addNum("+aa+',"")\';> + </button></span> </div>'}else{u(aa,Z[af])}}}F+="</div>"}})}});$("#div_content").append(F);$("#vice_modal").modal("show");G()}};var n=1;var u=function(V,X){var W=$("input[name='oldphonenum']");W=W.length+1;if(W>V){return}n++;F+="<div class='input-group input-group-lg' id='oldnum_"+n+"'><label style='width:170px;'>已有移动电话</label><span class='input-group-btn' style='width:40px'></span><input type='text' style='margin-top:10px;' class='form-control' name='oldphonenum' value='"+X+"'><span class='input-group-btn'><button class='btn btn-default' type='button' onclick=order.memberChange.delNum(\"oldnum_"+n+'")> - </button></span> </div>'};function G(){if(CONST.getAppDesc()==0){if(order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){if(!offerChange.checkOrder()){return}}if(!prod.uim.setProdUim()){return}}var W=0;var V=0;order.memberChange.viceCartNum=0;var X=[];$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd=="401"){if(this.prodInsts!=undefined){var ac=this.prodInsts;for(var ab=0;ab<this.prodInsts.length;ab++){var aa='"'+this.prodInsts[ab].prodInstId+'"';if(aa.indexOf("-")!=-1){X.push(this.prodInsts[ab])}}$.each(X,function(){var ad=this.prodInstId;$.each(ac,function(ae){if(this.prodInstId=ad){ac.splice(ae,1)}})})}}});$.each(s,function(){W=W+Number($("#"+this).val())});$("input[name='oldphonenum']").each(function(){var aa=$.trim($(this).val());if(ec.util.isObj(aa)){V++}});if(W>0){offerChange.newMemberFlag=true;order.service.setOfferSpec()}if(V>0){offerChange.oldMemberFlag=true;if(!order.memberChange.queryofferinfo()){return}}if(parseInt(W)+parseInt(order.memberChange.viceCartNum)>D){$.alert("提示","加装数量已经超过能加装的最大数量【"+D+"】!");return}var Y=order.prodModify.choosedProdInfo;var Z={boActionTypeCd:"S2",boActionTypeName:"套餐变更",actionFlag:"2",offerSpec:OrderInfo.offerSpec,prodId:Y.prodInstId,offerMembers:OrderInfo.offer.offerMemberInfos,oldOfferSpecName:Y.prodOfferName,prodClass:Y.prodClass,appDesc:CONST.getAppDesc(),areaId:order.prodModify.choosedProdInfo.areaId,newnum:parseInt(W),oldnum:parseInt(V),feeTypeMain:Y.feeType};if(V>0){Z.oldprodInstInfos=OrderInfo.oldprodInstInfos;Z.oldofferSpec=OrderInfo.oldofferSpec;Z.oldoffer=OrderInfo.oldoffer}offerChangeNew.buildMainView(Z);$("#vice_modal").modal("hide")}var j=function(V){$.callServiceAsHtml(contextPath+"/token/app/order/mainSub",V,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(W){if(!W){$.unecOverlay();W.data="查询失败,稍后重试"}if(W.code!=0){$.unecOverlay();$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=V.actionFlag;if(OrderInfo.actionFlag==2){setTimeout(function(){$.unecOverlay();offerChangeNew.fillOfferChange(W,V)},800)}else{$.unecOverlay();_callBackBuildView(W,V)}}})};var g=function(Y,W){var ae=OrderInfo.getAccessNumber(Y);var X="-1";if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23||OrderInfo.actionFlag==6){if(ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==Y){X=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{X=order.prodModify.choosedProdInfo.prodOfferInstId}}var ad=$.trim($("#uim_txt_"+Y).val());var Z={instCode:ad,phoneNum:ae,areaId:OrderInfo.getProdAreaId(Y)};var aa=OrderInfo.getProdSpecId(Y);var ac="";if(CONST.getAppDesc()==0){if(J(Y)){ac=prod.uim.getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID)}else{ac=prod.uim.getMktResCd(aa)}if(ec.util.isObj(ac)){}else{return}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(prod.changeUim.is4GProdInst){Z.onlyLTE="1"}}}var ab=W.couponNum;if(ab==undefined||ab==null){ab=1}var V={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:W.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:ab,storeId:W.storeId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:W.terminalCode,terminalCode:W.terminalCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:Y,offerId:X,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){V.cardTypeFlag=W.cardTypeFlag}$("#uim_check_btn_"+Y).attr("disabled",true);$("#uim_release_btn_"+Y).removeClass("disabled");$("#uim_txt_"+Y).attr("disabled",true);if(J(Y)){$("#isMIFI_"+Y).val("yes")}else{$("#isMIFI_"+Y).val("no")}OrderInfo.clearProdUim(Y);OrderInfo.boProd2Tds.push(V);if(OrderInfo.actionFlag==22&&data.baseInfo.cardTypeFlag==1){AttachOffer.queryCardAttachOffer(data.baseInfo.cardTypeFlag)}};var T=function(V,Z){SoOrder.initFillPage();$("#order_prepare").hide();$("#order").html(V.data).show();$("#fillNextStep").off("click").on("click",function(){if(!SoOrder.checkData()){return false}$("#order-content").hide();$("#order-dealer").show();order.dealer.initDealer()});var X=order.prodModify.choosedProdInfo;$("#attach-modal").modal("show");$.each(OrderInfo.offerSpec.offerRoles,function(){var aa=this;if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){var ah="'"+this.prodInstId+"'";if(ah.indexOf("-")==-1){var ae=this.prodInstId;var ag={areaId:OrderInfo.getProdAreaId(ae),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ae,prodSpecId:this.objId,offerSpecId:X.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var ab=query.offer.queryChangeAttachOffer(ag);$("#attach_"+ae).html(ab);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){ag.queryType="1,2";ag.objId=this.objId;ag.objType=this.objType;ag.memberRoleCd=this.roleCd;ag.offerSpecId=OrderInfo.offerSpec.offerSpecId;var ad=query.offer.queryDefMustOfferSpec(ag);CacheData.parseOffer(ad,ae);ag.queryType="1";var ad=query.offer.queryServSpec(ag);CacheData.parseServ(ad,ae)}AttachOffer.showMainRoleProd(ae);if(AttachOffer.isChangeUim(ae)){$("#uimDiv_"+ae).show();I(OrderInfo.mktResInstCode,ae)}}else{var ac=this;var ag={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:ac.objId,offerRoleId:ac.offerRoleId,prodId:ac.prodInstId,queryType:"1,2",objType:ac.objType,objId:ac.objId,memberRoleCd:ac.memberRoleCd};AttachOffer.queryAttachOfferSpec(ag);var af={div_id:"item_order_"+ac.prodInstId,prodId:ac.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:ac.objId,roleCd:aa.roleCd,offerRoleId:aa.offerRoleId,partyId:OrderInfo.cust.custId};
order.main.spec_parm(af)}})}});if(offerChange.oldMemberFlag){for(var W=0;W<OrderInfo.oldprodInstInfos.length;W++){var X=OrderInfo.oldprodInstInfos[W];$.each(OrderInfo.oldoffer,function(){if(this.accNbr==X.accNbr){var aa=this;$.each(aa.offerMemberInfos,function(){var af=this;if(af.objType==CONST.OBJ_TYPE.PROD){var ad=this.objInstId;var ae={areaId:OrderInfo.getProdAreaId(ad),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ad,prodSpecId:af.objId,offerSpecId:X.mainProdOfferInstInfos[0].prodOfferId,offerRoleId:"",acctNbr:af.accessNumber,partyId:X.custId,distributorId:OrderInfo.staff.distributorId,mainOfferSpecId:X.mainProdOfferInstInfos[0].prodOfferId,soNbr:OrderInfo.order.soNbr};if(ec.util.isObj(X.prodBigClass)){ae.prodBigClass=X.prodBigClass}$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==X.accNbr){$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){ae.offerRoleId=this.offerRoleId}})}});var ab=query.offer.queryChangeAttachOffer(ae);$("#attach_"+ad).html(ab);if(ec.util.isObj(af.objId)&&ec.util.isObj(af.objType)&&ec.util.isObj(af.offerRoleId)){ae.queryType="1,2";ae.objId=af.objId;ae.objType=af.objType;ae.memberRoleCd="401";var ac=query.offer.queryDefMustOfferSpec(ae);CacheData.parseOffer(ac);var ac=query.offer.queryServSpec(ae);CacheData.parseServ(ac)}if(ec.util.isArray(OrderInfo.oldofferSpec)){$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==X.accNbr){var ag=this.offerSpec.offerRoles;$.each(ag,function(){if(this.offerRoleId==af.offerRoleId&&af.objType==CONST.OBJ_TYPE.PROD){var ah=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var aj=CacheData.getServBySpecId(ad,this.objId);if(aj!=undefined){var ai=$("#li_"+ad+"_"+aj.servId)}}});return false}})}})}}})}});var Y={};if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){if(this.accNbr==X.accNbr){Y=this}})}if(order.prodModify.choosedProdInfo.is3G=="N"&&X.mainProdOfferInstInfos[0].is3G=="Y"){if(!order.memberChange.checkOrder(X,Y)){return}order.memberChange.checkOfferProd(Y)}}}if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){offerChange.checkOfferProd()}offerChangeNew.initTounch()};function I(Y,Z){var X={instCode:Y};var W=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",X);if(W.code==0){if(W.data.mktResBaseInfo){if(W.data.mktResBaseInfo.statusCd=="1102"){$("#uim_txt_"+Z).val(OrderInfo.mktResInstCode);var V={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:W.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:W.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:Y,ruleId:"",partyId:OrderInfo.cust.custId,prodId:Z,offerId:-1,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(Z);OrderInfo.boProd2Tds.push(V)}else{$.alert("提示","UIM卡不是预占状态，当前为"+W.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}}var z=function(){touch.on(".item","touchstart",function(W){});$(".item").each(function(W){touch.on(this,"swiperight",function(X){$("#carousel-example-generic").carousel("prev")});touch.on(this,"swipeleft",function(X){$("#carousel-example-generic").carousel("next")})});if(OrderInfo.provinceInfo.reloadFlag=="N"){var V=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;$.each(V,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){$("#nbr_btn_"+this.data.boProdAns[0].prodId).val(this.busiObj.accessNumber);var X={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};OrderInfo.boProdAns.push(X);order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).removeClass("disabled");$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);var W={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};OrderInfo.clearProdUim(this.busiObj.instId);OrderInfo.boProd2Tds.push(W);$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected")}});offerChangeNew.showOffer()}};var C=function(V){H(V,OrderInfo.offer);t(V,OrderInfo.offer);AttachOffer.setAttachBusiOrder(V);if(CONST.getAppDesc()==0){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(OrderInfo.boProd2Tds.length>0){var W={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var X=OrderInfo.getProdBusiOrder(W);if(X){V.push(X)}}}})}}};var H=function(V,X){X.offerTypeCd=1;X.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;var W=order.prodModify.choosedProdInfo;OrderInfo.getOfferBusiOrder(V,X,W.prodInstId)};var t=function(ac,ad){var ab=order.prodModify.choosedProdInfo;var W=OrderInfo.offerSpec;var V={areaId:OrderInfo.getProdAreaId(ab.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.SEQ.offerSeq--,objId:W.offerSpecId,offerTypeCd:"1",accessNumber:ab.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};$.each(W.offerRoles,function(){var ae=this;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){var af={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,offerRoleId:ae.offerRoleId,state:"ADD"};V.data.ooRoles.push(af)})}});if(ec.util.isArray(W.offerSpecParams)){V.data.ooParams=[];for(var Z=0;Z<W.offerSpecParams.length;Z++){var X=W.offerSpecParams[Z];var Y={itemSpecId:X.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:X.offerSpecParamId,value:X.value,state:"ADD"};V.data.ooParams.push(Y)}}if(W.ooTimes!=undefined){V.data.ooTimes=[];V.data.ooTimes.push(W.ooTimes)}V.data.busiOrderAttrs=[];var aa=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(aa!=undefined){aa.each(function(){var ae={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};V.data.busiOrderAttrs.push(ae)})}ac.push(V)};var R=function(V){};var h=function(W){if(OrderInfo.actionFlag==3){r()}else{S()}var V=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];
if(V==undefined){return false}if(V.resultCode==0&&ec.util.isObj(V.result)){offerChange.resultOffer=V.result}else{$.alert("预校验规则限制",V.resultMsg);offerChange.resultOffer={};return false}return true};var r=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;var Z=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;for(var Y=0;Y<AttachOffer.openList.length;Y++){var X=AttachOffer.openList[Y];for(var W=0;W<X.specList.length;W++){var V=X.specList[W];if(V.isdel!="Y"&&V.isdel!="C"&&V.ifPackage4G=="Y"){V.offerTypeCd=2;V.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;V.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(Z,V,X.prodId)}}}$.each(Z,function(){this.busiObj.state="ADD"})};var m=function(V,ae){if(V==1){var ad=U();if(ad==undefined){alert("错误提示","无法变更到该套餐");return false}ad.prodInsts=[];var ac=false;$.each(ad.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var af=this;ac=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(af.objId!=this.objId){$.alert("规则限制","新套餐【"+af.offerRoleName+"】角色的规格ID【"+af.objId+"】和旧套餐【"+this.roleName+"】角色的规格ID【"+this.objId+"】不一样");ac=true;return false}af.prodInstId=this.objInstId;af.accessNumber=this.accessNumber;ad.prodInsts.push(af)}});if(ac){return false}}});if(ac){return false}}else{for(var Z=0;Z<OrderInfo.offer.offerMemberInfos.length;Z++){var X=OrderInfo.offer.offerMemberInfos[Z];if(X.objType==CONST.OBJ_TYPE.PROD){var ac=true;for(var Y=0;Y<OrderInfo.offerSpec.offerRoles.length;Y++){var ad=OrderInfo.offerSpec.offerRoles[Y];if(X.roleCd==ad.memberRoleCd){for(var W=0;W<ad.roleObjs.length;W++){var ab=ad.roleObjs[W];if(ab.objType==CONST.OBJ_TYPE.PROD){if(ab.objId!=X.objId){$.alert("规则限制","新套餐【"+ab.offerRoleName+"】角色的规格ID【"+ab.objId+"】和旧套餐【"+X.roleName+"】角色的规格ID【"+X.objId+"】不一样");return false}if(!ec.util.isArray(ad.prodInsts)){ad.prodInsts=[]}var aa=jQuery.extend(true,{},ab);aa.prodInstId=X.objInstId;aa.accessNumber=X.accessNumber;aa.memberRoleCd=X.roleCd;ad.prodInsts.push(aa);if(ad.prodInsts.length>ab.maxQty){$.alert("规则限制","新套餐【"+ad.offerRoleName+"】角色最多可以办理数量为"+ab.maxQty+",而旧套餐数量大于"+ab.maxQty);return false}break}}ac=false;break}}if(ac){alert("旧套餐【"+X.roleName+"】角色在新套餐中不存在，无法变更");return false}}}}return true};var U=function(){for(var X=0;X<OrderInfo.offerSpec.offerRoles.length;X++){var Y=OrderInfo.offerSpec.offerRoles[X];if(Y.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return Y}}for(var X=0;X<OrderInfo.offerSpec.offerRoles.length;X++){var Y=OrderInfo.offerSpec.offerRoles[X];for(var W=0;W<Y.roleObjs.length;W++){var V=Y.roleObjs[W];if(V.objType==CONST.OBJ_TYPE.PROD){return Y}}}};var S=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.cust.areaId;var V=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;H(V,OrderInfo.offer);t(V,OrderInfo.offer)};var o=function(){if(offerChange.resultOffer==undefined){return}var V=offerChange.resultOffer.prodInfos;if(ec.util.isArray(V)){$.each(V,function(){var ab=this.accProdInstId;var Z=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==ab){Z=false;return false}});if(Z){return true}if(ab!=this.prodInstId){var ac=CacheData.getServ(ab,this.prodInstId);if(this.state=="DEL"){if(ac!=undefined){var ad=$("#li_"+ab+"_"+this.prodInstId);if(ec.util.isObj(ad)){var Y=$("#span_"+ab+"_"+this.prodInstId);var aa=$("#span_remove_"+ab+"_"+this.prodInstId);if(ec.util.isObj(Y)){Y.addClass("del")}if(ec.util.isObj(aa)){aa.hide()}ad.removeAttr("onclick");ac.isdel="Y"}}}else{if(this.state=="ADD"){if(ac!=undefined){var ad=$("#li_"+ab+"_"+this.prodInstId);if(ec.util.isObj(ad)){var Y=$("#span_"+ab+"_"+this.prodInstId);var aa=$("#span_remove_"+ab+"_"+this.prodInstId);if(ec.util.isObj(Y)){Y.removeClass("del")}if(ec.util.isObj(aa)){aa.hide()}ad.removeAttr("onclick");ac.isdel="N"}}else{var X=CacheData.getServSpec(ab,this.productId);if(X!=undefined){var ad=$("#li_"+ab+"_"+this.productId);if(ec.util.isObj(ad)){var Y=$("#span_"+ab+"_"+this.productId);var aa=$("#span_remove_"+ab+"_"+this.productId);if(ec.util.isObj(Y)){Y.removeClass("del")}if(ec.util.isObj(aa)){aa.hide()}ad.removeAttr("onclick");X.isdel="N"}$("#del_"+ab+"_"+this.productId).hide()}else{if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(ab,this.productId)}}}}}}})}var W=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(W)){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){var X=this.objInstId;$.each(W,function(){if(this.memberInfo==undefined){return true}var ab=CacheData.getOffer(X,this.prodOfferInstId);var Z=true;$.each(this.memberInfo,function(){if(X==this.accProdInstId){if(ec.util.isObj(ab)){this.prodId=this.accProdInstId}Z=false;return false}});if(Z){return true}if(this.state=="DEL"){if(ab!=undefined){var ad=$("#li_"+X+"_"+this.prodOfferInstId);if(ec.util.isObj(ad)){var Y=$("#span_"+X+"_"+this.prodOfferInstId);var aa=$("#span_remove_"+X+"_"+this.prodOfferInstId);if(ec.util.isObj(Y)){Y.addClass("del")}if(ec.util.isObj(aa)){aa.hide()}ad.removeAttr("onclick");ab.isdel="N"}ab.isdel="Y";if(this.isRepeat!="Y"){this.isRepeat="Y"}else{ab.isRepeat="Y"}}}else{if(this.state=="ADD"){if(ab!=undefined){var ad=$("#li_"+X+"_"+this.prodOfferInstId);if(ec.util.isObj(ad)){var Y=$("#span_"+X+"_"+this.prodOfferInstId);var aa=$("#span_remove_"+X+"_"+this.prodOfferInstId);if(ec.util.isObj(Y)){Y.removeClass("del")}if(ec.util.isObj(aa)){aa.hide()}ad.removeAttr("onclick");ab.isdel="N"}}else{var ac=CacheData.getOfferSpec(X,this.prodOfferId);if(ac!=undefined){var ad=$("#li_"+X+"_"+this.prodOfferId);if(ec.util.isObj(ad)){var Y=$("#span_"+X+"_"+this.prodOfferId);var aa=$("#span_remove_"+X+"_"+this.prodOfferId);if(ec.util.isObj(Y)){Y.removeClass("del")}if(ec.util.isObj(aa)){aa.hide()}ad.removeAttr("onclick");ac.isdel="N"}}else{if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(X,this.prodOfferId)}}}}}})})}}};var N=function(){var Y=OrderInfo.provinceInfo.reloadFlag;var W=OrderInfo.reloadOrderInfo;var ac="0";var V=W.resultMsg;if(ac=="0"){var ad=W.orderList.custOrderList;var aa=W.orderList.orderListInfo;if(ad!=null&&ad!=""){if(ad!=null&&ad.length>0){$(ad).each(function(ae,af){$(af.busiOrder).each(function(al,ag){var ao=ag.boActionType.boActionTypeCd;var ah="";var ak=ag.data;var ap;var an;if(ao=="7"){an=ak.boServs;if(an!=null){$(an).each(function(ar,aq){ah=aq.state})}}var aj=ag.busiObj;if(ao=="7"){var ai=aj.instId;var am=ak.boServOrders;$(ak.boServs).each(function(ar,aq){var au=aq.servId;var at=aq.state;if(at=="DEL"){p(ai,au)}})}})});$(ad).each(function(ae,af){$(af.busiOrder).each(function(aD,av){var aj=av.boActionType.boActionTypeCd;var ak="";var aH=av.data;var ap;var aE;if(aj=="7"){aE=aH.boServs;if(aE!=null){$(aE).each(function(aK,aJ){ak=aJ.state})}}else{ap=aH.ooOwners;if(ap!=null){$(ap).each(function(aK,aJ){ak=aJ.state;return false})}}var aG=av.busiObj;if(aj=="S2"&&aG.offerTypeCd=="2"){var aC=aG.instId;if(ak=="DEL"){var ai="";for(var aB=0;aB<OrderInfo.oldoffer.length;aB++){var aI=OrderInfo.oldoffer[aB];for(var aD=0;aD<aI.offerMemberInfos.length;aD++){var aF=aI.offerMemberInfos[aD];if(aF.accessNumber==av.busiObj.accessNumber){ai=aF.objInstId;break}}}$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.accessNumber==av.busiObj.accessNumber){ai=this.objInstId;return false}});B(ai,aC)}}else{if(aj=="7"){var aC=aG.instId;var ag=aH.boServOrders;$(aH.boServs).each(function(aK,aJ){var aM=aJ.servId;var aL=aJ.state;if(aL=="ADD"){$(ag).each(function(aN,aO){var aQ=aO.servSpecId;var aP=aO.servSpecName;y(aC,aQ,aP,"N")})}})}else{if(aj=="S1"){var au=aG.objId;var at=aG.accessNumber;var ar=aG.objName;var az=null;var aA=this.busiObj.offerTypeCd;var al=aH.ooRoles;var an=aH.busiOrderAttrs;var ax=av.data;$(aH.ooRoles).each(function(aK,aJ){az=aJ.prodId;return false
});if(aG.offerTypeCd=="2"){d(az,au,al);if(av.boActionType.actionClassCd=="1200"&&av.boActionType.boActionTypeCd=="S1"&&av.busiObj.offerTypeCd=="2"){if(ax.bo2Coupons!=undefined){for(var aD=0;aD<ax.bo2Coupons.length;aD++){var aw=ax.bo2Coupons[aD];if(aw.num==undefined){aw.num=aD+1}$("#terminalText_"+aw.prodId+"_"+aw.attachSepcId+"_"+aw.num).val(aw.couponInstanceNumber);offerChangeNew.checkTerminalCode(aw.prodId,aw.attachSepcId,aw.num,"0")}}}}if(av.data.busiOrderAttrs!=undefined){var aq={};var ao={};var am={};$.each(av.data.busiOrderAttrs,function(){if(this.role=="40020005"){aq.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aq.staffid=this.value;aq.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aq.staffname=this.value}}aq.objInstId=au;aq.accessNumber=at;aq.objName=ar;aq.prodId=az;aq.offerTypeCd=aA}else{if(this.role=="40020006"){ao.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){ao.staffid=this.value;ao.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){ao.staffname=this.value}}ao.objInstId=au;ao.accessNumber=at;ao.objName=ar;ao.prodId=az;ao.offerTypeCd=aA}else{if(this.role=="40020007"){am.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){am.staffid=this.value;am.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){am.staffname=this.value}}am.objInstId=au;am.accessNumber=at;am.objName=ar;am.prodId=az;am.offerTypeCd=aA}}}});if(ec.util.isObj(aq.role)){OrderInfo.reloadProdInfo.dealerlist.push(aq)}if(ec.util.isObj(ao.role)){OrderInfo.reloadProdInfo.dealerlist.push(ao)}if(ec.util.isObj(am.role)){OrderInfo.reloadProdInfo.dealerlist.push(am)}}}else{if(aj=="14"){var aw=av.data.bo2Coupons;for(var aD=0;aD<aw.length;aD++){if(aw[aD].state=="ADD"){var ah=aw[aD].couponInstanceNumber;var ay=aw[aD].prodId;$("#uim_txt_"+ay).val(ah);offerChangeNew.checkUim(ay,aw[aD])}}}}}}})})}}$.each(AttachOffer.openServList,function(){var ae=this;$.each(this.servSpecList,function(){var ag=this;var af=false;var ai=ad[0];$.each(ai.busiOrder,function(){var al=this;if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(ag.servSpecId==this.data.boServOrders[0].servSpecId&&ae.prodId==this.busiObj.instId){af=true;return false}}});if(!af){var ah=$("#li_"+ae.prodId+"_"+this.servSpecId).find("span");var aj=CacheData.getServSpec(ae.prodId,this.servSpecId);if(aj==undefined){return}ah.addClass("del");aj.isdel="Y";AttachOffer.showHideUim(1,ae.prodId,this.servSpecId);var ak=CacheData.getServBySpecId(ae.prodId,this.servSpecId);if(ec.util.isObj(ak)){ah.addClass("del");ak.isdel="Y"}}})});if(aa!=null&&ad!=null){var Z=aa.custOrderAttrs;var X=aa.isTemplateOrder;var ab=aa.templateOrderName;$(Z).each(function(af,ag){var ae=ag.itemSpecId;if(ae=="111111118"){var ah=ag.value;if(ah!=null&&ah!=""){OrderInfo.reloadProdInfo.orderMark=this.value}}});if(X=="Y"){$("#isTemplateOrder").click();SoOrder.showTemplateOrderName();$("#templateOrderName").val(ab)}}}};var P=function(W,X,V){if(X!=undefined){$.each(X.offerRoles,function(){$.each(this.roleObjs,function(){var Y=W+"_"+this.objId;$(V).each(function(aa,ab){var Z=ab.prodId+"_"+ab.objId;if(Y==Z){this.selQty=1;return false}else{this.selQty=2}})})})}};var y=function(aa,ac,V,af){var W=CacheData.getServSpec(aa,ac);if(W==undefined){var ab={objId:ac,servSpecId:ac,servSpecName:V,ifParams:af,isdel:"C"};var ae={prodSpecId:ac};if(af=="Y"){var Y=query.prod.prodSpecParamQuery(ae);if(Y==undefined||Y.result==undefined){return}ab.prodSpecParams=Y.result.prodSpecParams;if(ac==CONST.YZFservSpecId){var ad=$("select[name='pay_type_-1']").val();if(ad==undefined){ad=order.prodModify.choosedProdInfo.feeType}if(ad==CONST.PAY_TYPE.AFTER_PAY){for(var X=0;X<ab.prodSpecParams.length;X++){var Z=ab.prodSpecParams[X];Z.setValue=""}}else{for(var X=0;X<ab.prodSpecParams.length;X++){var Z=ab.prodSpecParams[X];if(Z.value!=""){Z.setValue=Z.value}else{if(!!Z.valueRange[0]&&Z.valueRange[0].value!=""){Z.setValue=Z.valueRange[0].value}}}}}}CacheData.setServSpec(aa,ab);W=ab}L(aa,W)};var L=function(X,aa,V){var Z=aa.servSpecId;var Y=CacheData.getExcDepServParam(X,Z);if(Y.orderedServSpecIds.length==0){AttachOffer.addOpenServList(X,Z,aa.servSpecName,aa.ifParams)}else{var W=query.offer.queryExcludeDepend(Y);if(W!=undefined){E(W.result,X,aa)}}};var E=function(ad,Y,V){var Z=V.servSpecId;var X=ad.servSpec.exclude;var ab=ad.servSpec.depend;var ac=ad.servSpec.related;var aa="";var W={excludeServ:[],dependServ:[],relatedServ:[]};if(ec.util.isArray(X)){$.each(X,function(){var ag=CacheData.getServList(Y);var ae=true;if(ag!=undefined){for(var af=0;af<ag.length;af++){if(ag[af].isdel=="Y"){if(ag[af].servSpecId==this.servSpecId){ae=false;break}}}}if(ae){aa+="需要关闭：   "+this.servSpecName+"<br>";W.excludeServ.push(this)}})}if(ec.util.isArray(ab)){$.each(ab,function(){aa+="需要开通：   "+this.servSpecName+"<br>";W.dependServ.push(this)})}if(ec.util.isArray(ac)){$.each(ac,function(){aa+="需要开通：   "+this.servSpecName+"<br>";W.relatedServ.push(this)})}if(aa==""){AttachOffer.addOpenServList(Y,Z,V.servSpecName,V.ifParams)}else{if(OrderInfo.provinceInfo.reloadFlag=="N"){AttachOffer.addOpenServList(Y,Z,V.servSpecName,V.ifParams);AttachOffer.excludeAddServ(Y,Z,W)}else{$.confirm("开通： "+V.servSpecName,aa,{yesdo:function(){AttachOffer.addOpenServList(Y,Z,V.servSpecName,V.ifParams);AttachOffer.excludeAddServ(Y,Z,W)},no:function(){}})}}};var w=function(){if("lj"==buyChk.buyType){OrderInfo.actionFlag=13;$("#treaty").hide();$("#agreementFie").hide();$("#phonenumberFie").hide()}else{if("hy"==buyChk.buyType){OrderInfo.actionFlag=14;$("#phonenumberFie").show()}}};var d=function(Y,Z,W){var V=l(Y,Z);if(V==undefined){return}var X=CacheData.getOfferProdStr(Y,V,0);q(Y,V);x(Y,V)};var k=function(Y,Z,W){var V=l(Y,Z);if(V==undefined){return}var X=CacheData.getOfferProdStr(Y,V,0);CacheData.setServ2OfferSpec(Y,V);AttachOffer.checkOfferExcludeDepend(Y,V)};var q=function(W,X,V){if(X!=undefined){$.each(X.offerRoles,function(){$.each(this.roleObjs,function(){var Y=W+"_"+this.objId;$(V).each(function(aa,ab){var Z=ab.prodId+"_"+ab.objId;if(Y==Z){this.selQty=1;return false}else{this.selQty=2}})})})}};var x=function(W,Y){var Z=Y.offerSpecId;var X=CacheData.getExcDepOfferParam(W,Z);var V=query.offer.queryExcludeDepend(X);if(V!=undefined){f(V.result,W,Z,Y.offerSpecName)}};var f=function(ak,ad,ai,W){var ae="";var aa={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(ak!=""){var Y=ak.offerSpec.exclude;var X=ak.offerSpec.depend;var ag=ak.offerSpec.defaultList;if(ec.util.isArray(Y)){for(var ac=0;ac<Y.length;ac++){var aj=CacheData.getOfferList(ad);var af=true;if(aj!=undefined){for(var ab=0;ab<aj.length;ab++){if(aj[ab].isdel=="Y"){if(aj[ab].offerSpecId==Y[ac].offerSpecId){af=false;break}}}}if(af){ae+="需要关闭：   "+Y[ac].offerSpecName+"<br>";aa.excludeOffer.push(Y[ac].offerSpecId)}}}if(X!=undefined&&ec.util.isArray(X.offerInfos)){for(var ac=0;ac<X.offerInfos.length;ac++){ae+="需要开通： "+X.offerInfos[ac].offerSpecName+"<br>";aa.dependOffer.dependOffers.push(X.offerInfos[ac].offerSpecId)}}if(X!=undefined&&ec.util.isArray(X.offerGrpInfos)){for(var ac=0;ac<X.offerGrpInfos.length;ac++){var V=X.offerGrpInfos[ac];aa.dependOffer.offerGrpInfos.push(V);ae+="需要开通： 开通"+V.minQty+"-"+V.maxQty+"个以下业务:<br>";if(V.subOfferSpecInfos!="undefined"&&V.subOfferSpecInfos.length>0){for(var ab=0;ab<V.subOfferSpecInfos.length;ab++){var ah=V.subOfferSpecInfos[ab];var Z=CacheData.getOfferSpec(ad,ah.offerSpecId);if(ec.util.isObj(Z)){if(Z.isdel!="Y"&&Z.isdel!="C"){ae+='<input id="'+ah.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"}else{ae+='<input id="'+ah.offerSpecId+'" checked="checked" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"}}else{var Z=CacheData.getOfferBySpecId(ad,ah.offerSpecId);if(ec.util.isObj(Z)){if(Z.isdel!="Y"&&Z.isdel!="C"){ae+='<input id="'+ah.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"
}else{ae+='<input id="'+ah.offerSpecId+'" checked="checked" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"}}else{ae+='<input id="'+ah.offerSpecId+'" checked="checked" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"}}}}}}if(ec.util.isArray(ag)){for(var ac=0;ac<ag.length;ac++){ae+="需要开通： "+ag[ac].offerSpecName+"<br>";aa.defaultOffer.push(ag[ac].offerSpecId)}}}AttachOffer.addOpenList(ad,ai)};var c=function(W,Y){var Z=Y.offerSpecId;var X=CacheData.getExcDepOfferParam(W,Z);var V=query.offer.queryExcludeDepend(X);if(V!=undefined){b(V.result,W,Z,Y.offerSpecName)}};var b=function(ak,ad,ai,W){var ae="";var aa={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(ak!=""){var Y=ak.offerSpec.exclude;var X=ak.offerSpec.depend;var ag=ak.offerSpec.defaultList;if(ec.util.isArray(Y)){for(var ac=0;ac<Y.length;ac++){var aj=CacheData.getOfferList(ad);var af=true;if(aj!=undefined){for(var ab=0;ab<aj.length;ab++){if(aj[ab].isdel=="Y"){if(aj[ab].offerSpecId==Y[ac].offerSpecId){af=false;break}}}}if(af){ae+="需要关闭：   "+Y[ac].offerSpecName+"<br>";aa.excludeOffer.push(Y[ac].offerSpecId)}}}if(X!=undefined&&ec.util.isArray(X.offerInfos)){for(var ac=0;ac<X.offerInfos.length;ac++){ae+="需要开通： "+X.offerInfos[ac].offerSpecName+"<br>";aa.dependOffer.dependOffers.push(X.offerInfos[ac].offerSpecId)}}if(X!=undefined&&ec.util.isArray(X.offerGrpInfos)){for(var ac=0;ac<X.offerGrpInfos.length;ac++){var V=X.offerGrpInfos[ac];aa.dependOffer.offerGrpInfos.push(V);ae+="需要开通： 开通"+V.minQty+"-"+V.maxQty+"个以下业务:<br>";if(V.subOfferSpecInfos!="undefined"&&V.subOfferSpecInfos.length>0){for(var ab=0;ab<V.subOfferSpecInfos.length;ab++){var ah=V.subOfferSpecInfos[ab];var Z=CacheData.getOfferSpec(ad,ah.offerSpecId);if(ec.util.isObj(Z)){if(Z.isdel!="Y"&&Z.isdel!="C"){ae+='<input id="'+ah.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"}else{ae+='<input id="'+ah.offerSpecId+'" checked="checked" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"}}else{var Z=CacheData.getOfferBySpecId(ad,ah.offerSpecId);if(ec.util.isObj(Z)){if(Z.isdel!="Y"&&Z.isdel!="C"){ae+='<input id="'+ah.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"}else{ae+='<input id="'+ah.offerSpecId+'" checked="checked" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"}}else{ae+='<input id="'+ah.offerSpecId+'" checked="checked" type="checkbox" name="'+V.grpId+'" value="'+ah.offerSpecId+'">'+ah.offerSpecName+"</input><br>"}}}}}}if(ec.util.isArray(ag)){for(var ac=0;ac<ag.length;ac++){ae+="需要开通： "+ag[ac].offerSpecName+"<br>";aa.defaultOffer.push(ag[ac].offerSpecId)}}}AttachOffer.addOpenList(ad,ai)};var p=function(W,Y){var X=CacheData.getServ(W,Y);var V=$("#li_"+W+"_"+X.servId).find("span");if("13409244"==X.servSpecId){$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能")}else{V.addClass("del");X.isdel="Y"}};var B=function(aa,X){var ac=$("#li_"+aa+"_"+X).find("span");if(ac.attr("class")=="del"){}else{var ad=CacheData.getOffer(aa,X);if(!ec.util.isArray(ad.offerMemberInfos)){var V={prodId:aa,areaId:OrderInfo.getProdAreaId(aa),offerId:X};if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var Z=0;Z<OrderInfo.oldprodInstInfos.length;Z++){if(aa==OrderInfo.oldprodInstInfos[Z].prodInstId){V.areaId=OrderInfo.oldprodInstInfos[Z].areaId;V.acctNbr=OrderInfo.oldprodInstInfos[Z].accNbr}}}else{V.acctNbr=OrderInfo.getAccessNumber(aa)}var Y=query.offer.queryOfferInst(V);if(Y==undefined){return}var W=[];$.each(Y.offerMemberInfos,function(){var af=this.objInstId;var ae=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==af){ae=true;return false}});if(ae){W.push(this)}});ad.offerMemberInfos=Y.offerMemberInfos=W;ad.offerSpec=Y.offerSpec}var ab="";if(ad.offerSpec!=undefined){ab=CacheData.getOfferProdStr(aa,ad,1)}else{ab="退订【"+ac.text()+"】可选包"}ad.isdel="Y";ac.addClass("del");O(aa,ad)}};var O=function(W,V){$.each(V.offerMemberInfos,function(){var Z=this.objInstId;if($("#check_"+W+"_"+Z).attr("checked")=="checked"){var X=CacheData.getServ(W,Z);if(ec.util.isObj(X)){X.isdel="Y";var Y=$("#li_"+W+"_"+Z);Y.removeClass("canshu").addClass("canshu2");Y.find("span").addClass("del")}}})};var v=function(ae,Z,ab,al){var ae=ae;var Z=Z;var ab=ab;var al=al;if(al==undefined){al=0}AttachOffer.filterAttach2Coupons(ae,Z,ab);var W=ae+"_"+Z;var aj=[];var an=[];$("#"+W+"  option").each(function(){aj.push($(this).val())});$("#group_"+W+"  option").each(function(){an.push($(this).val())});var ag=aj.join("|");var af=an.join("|");if((ag==undefined||$.trim(ag)=="")&&(af==undefined||$.trim(af)=="")){$.alert("信息提示","终端规格不能为空！");return}var X=$("#terminalText_"+W+"_"+ab).val();if(X==undefined||$.trim(X)==""){$.alert("信息提示","终端串码不能为空！");return}if(AttachOffer.checkData(W,X)){return}var Y={instCode:X,flag:al,mktResId:ag};var ao=query.prod.checkTerminal(Y);if(ao==undefined){return}var V="";for(var am=0;am<AttachOffer.openList.length;am++){var ad=AttachOffer.openList[am];for(var ak=0;ak<ad.specList.length;ak++){var aa=ad.specList[ak];if(aa.isdel!="Y"&&aa.isdel!="C"&&ec.util.isArray(aa.agreementInfos)){if(aa.agreementInfos[0].activtyType==2){V="2"}}}}if(ao.statusCd==CONST.MKTRES_STATUS.USABLE||(ao.statusCd==CONST.MKTRES_STATUS.HAVESALE&&V=="2")){var ai=0;var ah="";if(ec.util.isArray(ao.mktAttrList)){$.each(ao.mktAttrList,function(){if(this.attrId=="65010058"){ai=this.attrValue}else{if(this.attrId=="60010004"){ah=this.attrValue}}})}$("#terminalName_"+ab).html("终端规格："+ao.mktResName+",终端颜色："+ah+",合约价格："+ai+"元");$("#terminalDesc_"+ab).css("display","block");var ac={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:ao.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:ao.mktResStoreId,storeName:"1",agentId:1,apCharge:ai,couponInstanceNumber:ao.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:ae,offerId:-1,attachSepcId:Z,state:"ADD",relaSeq:"",num:ab};if(ao.statusCd==CONST.MKTRES_STATUS.HAVESALE&&V=="2"){ac.couponSource="2"}if(CONST.getAppDesc()==0){ac.termTypeFlag=ao.termTypeFlag}OrderInfo.attach2Coupons.push(ac)}else{if(ao.statusCd==CONST.MKTRES_STATUS.HAVESALE){$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}else{$.alert("提示",ao.message)}}};var J=function(Z){var Y=(Math.abs(Z)-1);if(AttachOffer.openServList.length>Y){var X=AttachOffer.openServList[Y].servSpecList;for(var W=0;W<X.length;W++){var V=X[W];if(V.isdel!="Y"&&V.isdel!="C"){if(V.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true}}}}return false};var l=function(W,X){var V=CacheData.getOfferSpec(W,X);if(V==undefined){V=query.offer.queryAttachOfferSpec(W,X);if(!V){return}CacheData.setOfferSpec(W,V)}return V};var a=function(X){var W="";if(offerChange.resultOffer==undefined){return W}var V=offerChange.resultOffer.prodInfos;if(ec.util.isArray(V)){var Y="";$.each(V,function(){if(X!=this.accProdInstId){return true}if(X!=this.prodInstId){var aa=CacheData.getServ(X,this.prodInstId);var Z=CacheData.getServSpec(X,this.productId);if(this.state=="DEL"){if(aa!=undefined){Y+='<li id="li_'+X+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+X+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+aa.servSpecName+"</span></li>"}else{if(Z!=undefined){Y+='<li id="li_'+X+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+X+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+Z.servSpecName+"</span></li>"}else{if(this.productName!=undefined&&this.productName!=""){Y+='<li id="li_'+X+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+X+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+this.productName+"</span></li>"
}}}}else{if(this.state=="ADD"){if(aa!=undefined){Y+='<li id="li_'+X+"_"+this.prodInstId+'"><dd id="del_'+X+"_"+this.prodInstId+'" class="delete"></dd><span>'+aa.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(Z!=undefined){Y+='<li id="li_'+X+"_"+this.prodInstId+'"><dd id="del_'+X+"_"+this.prodInstId+'" class="delete"></dd><span>'+Z.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(this.productName!=undefined&&this.productName!=""){Y+='<li id="li_'+X+"_"+this.prodInstId+'"><dd id="del_'+X+"_"+this.prodInstId+'" class="delete"></dd><span>'+this.productName+'</span><dd class="mustchoose"></dd></li>'}}}}}}});if(Y==""){W=""}else{W="<div class='fs_choosed'>订购4G流量包，需订购和取消如下功能产品：<br><ul>"+Y+"</ul></div><br>"}}};return{checkTerminalCode:v,chkState:w,checkUim:g,closeServ:p,delOffer:B,opeSer:A,showOffer:N,initTounch:z,buildMainView:j,buyService:i,queryData:K,searchPack:e,init:Q,offerChangeView:M,changeOffer:C,changeTab:R,checkOrder:h,checkAttachOffer:a,fillOfferChange:T,checkOfferProd:o,getChangeInfo:S,setChangeOfferSpec:m}})();