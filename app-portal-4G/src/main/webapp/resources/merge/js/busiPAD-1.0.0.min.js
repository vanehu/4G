CommonUtils.regNamespace("order","memberChange");order.memberChange=function(){var E={};var L=[];var u=false;var R=1;var o=1;var d="";var t;var N;var C;var w={};var c={objInstId:[]};var A={accessNumbers:[]};var y={accessNumbers:[]};var m={};var F=0;var X=false;var f=false;var r=false;var O=[];var q=[];var H=function(){if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){$.alert("提示","停机产品不允许受理！");return}L=[];R=1;o=1;OrderInfo.busitypeflag=3;OrderInfo.actionFlag=6;OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldprodAcctInfos=[];OrderInfo.oldAddNumList=[];OrderInfo.viceOfferSpec=[];$("#order_fill_content").empty();OrderInfo.order.step=0;order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show();$("#order_confirm").hide();order.prepare.createorderlonger();if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"){$.alert("提示","3G套餐不允许做主副卡成员变更业务！","information");return}var ag=a();if(order.memberChange.reloadFlag=="N"){if(!P()){return}var ah=order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;var ai=true;$.each(ah,function(){if(this.itemSpecId=="30010024"){if(this.value!="3"){ai=false;return false}}});if(!ai){$.alert("提示","不是主副卡成员变更受理流水号，请重试！");return}var ak=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;var Y=1;order.memberChange.newSubPhoneNum="";order.memberChange.oldSubPhoneNum="";$.each(ak,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="3"){order.memberChange.delmembers.flag=true;order.memberChange.delmembers.accessNumbers.push({nbr:this.busiObj.accessNumber})}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){order.memberChange.newmembers.flag=true;if(Y==1){order.memberChange.newSubPhoneNum+=this.busiObj.accessNumber;Y++}else{order.memberChange.newSubPhoneNum+=","+this.busiObj.accessNumber}}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"){if(this.busiObj.offerTypeCd=="1"){order.memberChange.oldmembers.flag=true;if(Y==1){order.memberChange.oldSubPhoneNum+=this.busiObj.accessNumber;Y++}else{order.memberChange.oldSubPhoneNum+=","+this.busiObj.accessNumber}}var am=this.data.ooRoles[0].objInstId;var al=this.busiObj.instId;order.memberChange.oldmembers.objInstId.push({instId:al,objInstId:am})}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="1"){order.memberChange.changemembers.flag=true;order.memberChange.changemembers.accessNumbers.push({nbr:this.busiObj.accessNumber,specId:this.busiObj.objId,name:this.busiObj.objName})}}}}})}var ac=[];var af=[];if(order.memberChange.newSubPhoneNum!=""){ac=order.memberChange.newSubPhoneNum.split(",")}if(order.memberChange.oldSubPhoneNum!=""){af=order.memberChange.oldSubPhoneNum.split(",")}var aa={offerSpecId:order.prodModify.choosedProdInfo.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var Z=query.offer.queryMainOfferSpec(aa);if(!Z){return}var ae=true;$.each(Z.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){ae=false;return false}});if(ae){$.alert("错误","你选择的套餐不是主副卡套餐，不能进行主副卡成员变更");return}if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!query.offer.setOffer()){return}}var ad=0;var aj=true;$("#main_title").text(OrderInfo.offerSpec.offerSpecName);SoOrder.initFillPage();var ab=query.offer.queryMemberHtml(aa);SoOrder.step(0,ab);$.jqmRefresh($("#order_tab_panel_content"));$.each(Z.offerRoles,function(an){var ap=this;if(an==0){$("#firstHtml").html('<label for="money">'+ap.offerRoleName+"：</label>")}else{if(an==1){$("#secondHtml").html('<label for="recommend">'+ap.offerRoleName+"：</label>")}}if(ap.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#objHtml").html(this.objName)}});$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ap.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){$("#accessNumberHtml").html(this.accessNumber);return}})}else{$.each(ap.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){this.minQty=0;this.dfQty=0;viceMinQty=0;viceMaxQty=this.maxQty;numId=ap.offerRoleId+"_"+this.objId}});var al=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ap.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){al++}});$.each(this.roleObjs,function(){var ar=ap.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){L.push(ar);if(ap.minQty==0){this.minQty=0;this.dfQty=0}var aq=this.maxQty<0?"不限制":this.maxQty;aq=aq-al;F=aq;if(aq>0){if(ac.length==0&&af.length==0){$("#pointsHtml").html('<input type="range" id="'+ar+'" value="'+ac.length+'" min="'+this.minQty+'" max="'+aq+'" readonly="readonly">')}else{if(ac.length>aq){$.alert("规则限制","newSubPhoneNum的角色成员数量总和不能超过"+aq);aj=false;return false}else{$("#pointsHtml").html('<input type="text" id="'+ar+'" value="'+ac.length+'" readonly="readonly">')}}$("#limitHtml").html("(仅含本地语音）"+this.minQty+"-"+aq+"（张）")}$.jqmRefresh($("#order_tab_panel_content"));ad++}});if(ag){var ao="";$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var aq=this.maxQty<0?"不限制":this.maxQty;aq=aq-al;if(aq>0){var at="";if(ac.length==0&&af.length==0){ao+='<div class="ui-block-a">';ao+='<div class="ui-grid-c">';ao+='<div class="ui-block-a">';ao+='<label for="recommend">已有移动电话：</label>';ao+="</div>";ao+='<div class="ui-block-b">';ao+='<input type="text" id="oldphonenum_1">';ao+="</div>";ao+='<div class="ui-block-c">';ao+='<button data-mini="ture" onclick="order.memberChange.addNum(\''+aq+"','')\">+</button>";ao+="</div>";ao+='<div class="ui-block-d">';ao+="</div>";ao+="</div>";ao+="</div>"}else{if(af.length>aq){$.alert("规则限制","oldSubPhoneNum的角色成员数量总和不能超过"+aq);aj=false;return false}else{for(var ar=0;ar<af.length;ar++){if(ar==0){ao+='<div class="ui-block-a">';ao+='<div class="ui-grid-c">';ao+='<div class="ui-block-a">';ao+='<label for="recommend">已有移动电话：</label>';ao+="</div>";ao+='<div class="ui-block-b">';ao+='<input type="text" id="oldphonenum_1" value=\''+af[ar]+'\' readonly="readonly">';ao+="</div>";ao+='<div class="ui-block-c">';ao+='<button data-mini="ture" onclick="order.memberChange.addNum(\''+aq+"','')\">+</button>";ao+="</div>";ao+='<div class="ui-block-d">';ao+="</div>";ao+="</div>";ao+="</div>"}else{order.memberChange.addNum(aq,af[ar])}}}}}}});$("#oldnum_1").html(ao)}var am="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ap.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){am+='<div class="ui-grid-a" id="li_viceCard_new_'+this.accessNumber+'" del="N" knew="N" objId="'+this.objId+'" objInstId="'+this.objInstId+'"  objType="'+this.objType+'" offerMemberId="'+this.offerMemberId+'" offerRoleId="'+this.offerRoleId+'" accessNumber="'+this.accessNumber+'">';am+='<div class="ui-block-a">';am+='<div class="ui-grid-c">';am+='<div class="ui-block-a">';am+="</div>";am+='<div class="ui-block-b" id="label_viceCard_new_'+this.accessNumber+'" style="height:53px;line-height:53px;padding-left:18px;">';am+=this.accessNumber;am+="</div>";am+='<div class="ui-block-c">';am+='<button data-mini="ture" id="button_viceCard_new_'+this.accessNumber+'" accNbr="'+this.accessNumber+'" onclick="order.memberChange.removeOtherCard(\''+this.accessNumber+"');\">拆副卡</button>";am+="</div>";if(ag){am+='<div class="ui-block-d">';am+='<button data-mini="ture" accNbr="'+this.accessNumber+'" onclick="order.service.offerDialog(\'viceCard_new_'+this.accessNumber+"')\">保留>>选择新套餐</button>";am+="</div>"}am+="</div>";am+="</div>";am+='<div class="ui-block-b" style="height:53px;line-height:53px;padding-left:18px;"><span id=\'viceCard_new_'+this.accessNumber+"'></span></div>";am+="</div>"}});$("#other_member").html(am);$("#other_member").show()}});if(order.memberChange.reloadFlag=="Y"){$("#memeberChange .btna_o:last").click(function(){M()})}else{if(order.memberChange.reloadFlag=="N"){order.memberChange.submit()}}$.jqmRefresh($("#order_tab_panel_content"))
};function a(){var aa=OrderInfo.staff.soAreaId.substring(0,3)+"0000";var Y={areaid:aa};$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var Z=$.callServiceAsJsonGet(contextPath+"/pad/offer/areaidJurisdiction",Y);$.unecOverlay();if(Z.code==0){if(Z.data=="ON"){return true}else{return false}}else{return false}}function P(){var Y=OrderInfo.provinceInfo.provIsale;var Z={provTransId:Y,backFlag:"Y"};$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var aa=$.callServiceAsJsonGet(contextPath+"/accessToken/queryOrderInfos",Z);$.unecOverlay();if(aa.code==0){order.memberChange.rejson=aa.data;return true}else{if(aa.code==1002){$.alert("错误",aa.data);return false}else{$.alertM(aa.data);return false}}}var G=function(Z,aa){if(R>=Z){return}o++;R++;var Y='<div class="ui-grid-a" id=\'oldnum_'+o+'\'><div class="ui-block-a"><div class="ui-grid-c"><div class="ui-block-a"><label for="recommend">已有移动电话：</label></div><div class="ui-block-b"><input type="text" id="oldphonenum_'+o+'"></div><div class="ui-block-c"><button data-mini="ture" onclick="order.memberChange.delNum(\'oldnum_'+o+'\')">-</button></div><div class="ui-block-d"></div></div></div></div>';$("#maincard_member_div").append(Y);$.jqmRefresh($("#order_tab_panel_content"))};var h=function(Y){o--;R--;$("#"+Y).remove()};var T=[];var n=function(Z){var Y=true;$.each(OrderInfo.offerSpec.offerRoles,function(){var ab=this;if(ab.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var aa=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ab.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){aa++}});$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var ac=this.maxQty<0?"不限制":this.maxQty;if(ac>0&&(ac-aa-Z)<0){$.alert("提示","加装数量已经超过能加装的最大数量【"+ac+"】!");Y=false;return false}}})}});return Y};var i=function(){OrderInfo.oldAddNumList=[];OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldAddNumList=[];T=[];var Y=true;if(OrderInfo.actionFlag==1&&OrderInfo.provinceInfo.reloadFlag=="N"){var ah=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;for(var ac=0;ac<ah.length;ac++){if(ah[ac].boActionType.actionClassCd=="1200"&&ah[ac].boActionType.boActionTypeCd=="S2"&&ah[ac].busiObj.offerTypeCd=="1"){var aa=ah[ac].busiObj.accessNumber;OrderInfo.oldAddNumList.push({accNbr:aa})}}}else{for(var ac=1;ac<=o;ac++){var ad=$.trim($("#oldphonenum_"+ac).val());if(ec.util.isObj(ad)){if(ec.util.isArray(OrderInfo.oldAddNumList)){if(!Y){return false}$.each(OrderInfo.oldAddNumList,function(){if(ad==this.accNbr){Y=false;$.alert("提示",ad+"重复，请重新输入！");return false}});if(Y){OrderInfo.oldAddNumList.push({accNbr:ad})}}else{OrderInfo.oldAddNumList.push({accNbr:ad})}}}}if(!Y){return false}if(OrderInfo.oldAddNumList.length==0){$.alert("提示","请输入手机号码!");return false}var ae=true;for(var ac=0;ac<OrderInfo.oldAddNumList.length;ac++){for(var ag=0;ag<OrderInfo.offer.offerMemberInfos.length;ag++){if(OrderInfo.oldAddNumList[ac].accNbr==OrderInfo.offer.offerMemberInfos[ag].accessNumber){$.alert("提示",OrderInfo.oldAddNumList[ac].accNbr+"号码重复，请重新输入！");ae=false;return false}}if(OrderInfo.provinceInfo.mergeFlag=="0"){var Z={acctNbr:OrderInfo.oldAddNumList[ac].accNbr,identityCd:"",identityNum:"",partyName:"",diffPlace:"local",areaId:OrderInfo.staff.soAreaId,queryType:"",queryTypeValue:"",prodClass:"12"};var ab=$.callServiceAsJson(contextPath+"/cust/queryoffercust",Z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});if(ab.code==0){$.unecOverlay();if(ab.data.custInfos.length==0){$.alert("提示","抱歉，没有定位到"+OrderInfo.oldAddNumList[ac].accNbr+"客户，请尝试其他客户。");ae=false;return false}var af=ab.data.custInfos[0].custId;if(OrderInfo.actionFlag!=1&&af!=OrderInfo.cust.custId){ae=false;$.alert("提示",OrderInfo.oldAddNumList[ac].accNbr+"和主卡的客户不一致！");return false}T.push({accNbr:OrderInfo.oldAddNumList[ac].accNbr,custId:af})}else{ae=false;$.unecOverlay();$.alertM(ab.data);return false}}else{var ai=OrderInfo.staff.soAreaId;ae=order.cust.mgr.queryCustCompreInfo(OrderInfo.oldAddNumList[ac].accNbr,ai,3,"OLD");if(!ae){break}}}if(ae){if(OrderInfo.provinceInfo.mergeFlag=="0"){return e()}else{if(n(order.memberChange.viceCartNum)){return I()}}}};var l=function(){OrderInfo.oldAddNumList=[];OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldAddNumList=[];T=[];var ac=true;for(var ab=1;ab<=o;ab++){var aa=$.trim($("#oldphonenum_"+ab).val());if(ec.util.isObj(aa)){if(ec.util.isArray(OrderInfo.oldAddNumList)){if(!ac){return false}$.each(OrderInfo.oldAddNumList,function(){if(aa==this.accNbr){ac=false;$.alert("提示",aa+"重复，请重新输入！");return false}});if(ac){OrderInfo.oldAddNumList.push({accNbr:aa})}}else{OrderInfo.oldAddNumList.push({accNbr:aa})}}}if(!ac){return}if(OrderInfo.oldAddNumList.length==0){$.alert("提示","请输入手机号码!");return}var af=true;for(var ab=0;ab<OrderInfo.oldAddNumList.length;ab++){for(var Z=0;Z<OrderInfo.offer.offerMemberInfos.length;Z++){if(OrderInfo.oldAddNumList[ab].accNbr==OrderInfo.offer.offerMemberInfos[Z].accessNumber){$.alert("提示",OrderInfo.oldAddNumList[ab].accNbr+"号码重复，请重新输入！");af=false;return}}var ae={acctNbr:OrderInfo.oldAddNumList[ab].accNbr,identityCd:"",identityNum:"",partyName:"",diffPlace:"local",areaId:$("#p_cust_areaId").val(),queryType:"",queryTypeValue:""};var Y=$.callServiceAsJson(contextPath+"/cust/queryoffercust",ae,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});if(Y.code==0){$.unecOverlay();if(Y.data.custInfos.length==0){$.alert("提示","抱歉，没有定位到"+OrderInfo.oldAddNumList[ab].accNbr+"客户，请尝试其他客户。");af=false;return}var ad=Y.data.custInfos[0].custId;if(ad!=OrderInfo.cust.custId){af=false;$.alert("提示",OrderInfo.oldAddNumList[ab].accNbr+"和主卡的客户不一致！");return}T.push({accNbr:OrderInfo.oldAddNumList[ab].accNbr,custId:ad})}else{af=false;$.unecOverlay();$.alertM(Y.data);return}}if(af){return e()}};var e=function(){var Y=true;for(var ab=0;ab<T.length;ab++){var ae={};ae.custId=T[ab].custId;ae.acctNbr=T[ab].accNbr;ae.areaId=$("#p_cust_areaId").val();ae.pageSize="";ae.curPage="";ae.DiffPlaceFlag="local";if(ae.custId==null||ae.custId==""){Y=false;$.alert("提示",T[ab].accNbr+"无法查询已订购产品");return false}var Z=$.callServiceAsJson(contextPath+"/cust/offerorderprod",ae,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});if(Z.code==0){$.unecOverlay();var ad=Z.data;for(var aa=0;aa<ad.length;aa++){if(ad[aa].accNbr==T[ab].accNbr){var ac=ad[aa];ac.custId=T[ab].custId;if(ac.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){Y=false;$.alert("提示",T[ab].accNbr+"不是在用产品！");return false}if(OrderInfo.actionFlag!=1&&ac.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){Y=false;$.alert("提示",T[ab].accNbr+"和主卡的付费类型不一致！");return false}if(ac.productId=="280000000"){$.alert("提示",T[ab].accNbr+"是无线宽带，不能纳入！");return false}OrderInfo.oldprodInstInfos.push(ac);break}}}else{Y=false;$.unecOverlay();$.alertM(Z.data);return false}}if(Y){return z()}};var I=function(){var Y=true;for(var Z=0;Z<OrderInfo.oldprodInstInfos.length;Z++){var ab=OrderInfo.oldprodInstInfos[Z].mainProdOfferInstInfos[0].prodOfferId;if(ec.util.isObj(ab)){var aa={offerSpecId:ab,offerTypeCd:1,partyId:OrderInfo.oldprodInstInfos[Z].custId,accNbr:OrderInfo.oldprodInstInfos[Z].accNbr};if(!query.offer.queryMainOfferSpec(aa)){Y=false;return false}}}if(Y){return B()}};var z=function(){var af=true;var ad=0;var ah=[];for(var ag=0;ag<OrderInfo.oldprodInstInfos.length;ag++){if(ec.util.isArray(ah)){for(var ac in ah){if(OrderInfo.oldprodInstInfos[ag].accNbr==ah[ac].accessNumber){$.alert("提示","号码【"+OrderInfo.oldprodInstInfos[ag].accNbr+"】与【"+ah[ac].accNbr+"】为同一套餐下的实例成员，不能重复加装!");return false}}}var Z={offerId:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferId,acctNbr:OrderInfo.oldprodInstInfos[ag].accNbr,areaId:OrderInfo.oldprodInstInfos[ag].areaId,distributorId:""};var ab=query.offer.queryOfferInst(Z);if(ab&&ab.code==CONST.CODE.SUCC_CODE){var ae=true;if(ec.util.isArray(ab.offerMemberInfos)){CacheData.sortOffer(ab);var ai=0;
for(var ac=0;ac<ab.offerMemberInfos.length;ac++){var aa=ab.offerMemberInfos[ac];aa.prodClass=OrderInfo.oldprodInstInfos[ag].prodClass;if(aa.objType==""){af=false;$.alert("提示","销售品实例构成 "+aa.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(aa.objType==CONST.OBJ_TYPE.PROD){if(aa.accessNumber==""){af=false;$.alert("提示","销售品实例构成 "+aa.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}ai++;ad++;ah.push({accNbr:OrderInfo.oldprodInstInfos[ag].accNbr,accessNumber:aa.accessNumber})}}if(aa.objInstId==OrderInfo.oldprodInstInfos[ag].prodInstId){ae=false}}if(ae){af=false;$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+OrderInfo.oldprodInstInfos[ag].accNbr+"】，无法继续受理，请业务后台核实");return false}var Y={offerMemberInfos:ab.offerMemberInfos,offerId:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferId,offerSpecName:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferName,accNbr:OrderInfo.oldprodInstInfos[ag].accNbr};OrderInfo.oldoffer.push(Y)}else{af=false;$.alert("提示",OrderInfo.oldprodInstInfos[ag].accNbr+"查询销售品实例构成，没有返回成员实例无法继续受理");return false}}}order.memberChange.viceCartNum=ad;if(af&&n(ad)){return I()}};var B=function(){var aa=true;OrderInfo.boProd2OldTds=[];for(var ab=0;ab<OrderInfo.oldprodInstInfos.length;ab++){var Y=OrderInfo.oldprodInstInfos[ab];var ac=query.prod.getTerminalInfo(Y);if(ac==undefined){aa=false;return false}var af=OrderInfo.oldprodInstInfos[ab].mainProdOfferInstInfos[0].prodOfferInstId;var Z=OrderInfo.oldprodInstInfos[ab].prodInstId;j(af,Z,ac);if(ac.is4GCard=="Y"){Y.prodClass=CONST.PROD_CLASS.FOUR}else{Y.prodClass=CONST.PROD_CLASS.THREE}}if(aa){var ae=true;if(OrderInfo.order.soNbr==null||OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}for(var ab=0;ab<OrderInfo.oldprodInstInfos.length;ab++){var Y=OrderInfo.oldprodInstInfos[ab];if(Y==undefined||Y.prodInstId==undefined){ae=false;$.alert("提示",OrderInfo.oldprodInstInfos[ab].accNbr+"未获取到老用户产品相关信息，无法办理二次业务！");return false}var ad={areaId:Y.areaId,acctNbr:Y.accNbr,custId:Y.custId,soNbr:OrderInfo.order.soNbr,instId:Y.prodInstId,type:"2",queryType:"1,2,3,4,5",acctNbr:"",data:[]};if(!S(ad,Y)){ae=false;return false}}if(ae){return v()}}};var j=function(Y,aa,Z){var ab={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:Z.couponId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:Z.couponInsNumber,terminalCode:Z.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:aa,offerId:Y,state:"DEL",relaSeq:"",id:0,isOld:"T",is4GCard:Z.is4GCard};OrderInfo.boProd2OldTds.push(ab)};var S=function(ad,Y){var ac=OrderInfo.provinceInfo.mergeFlag;for(var ab=0;ab<OrderInfo.oldoffer.length;ab++){if(OrderInfo.oldoffer[ab].accNbr==Y.accNbr){if(ec.util.isArray(OrderInfo.oldoffer[ab].offerMemberInfos)){var Z=true;$.each(OrderInfo.oldoffer[ab].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.accessNumber==Y.accNbr){instflag=false;Z=false;return}});if(Z){if(ac!=null&&ac!=""&&ac!="undefined"&&ac=="1"){ad.data.push({accessNbr:Y.accNbr,instId:Y.prodInstId});return query.offer.invokeLoadInstSub(ad)}else{return query.offer.invokeLoadInst(ad)}}else{var aa=true;if(ac!=null&&ac!=""&&ac!="undefined"&&ac=="1"){$.each(OrderInfo.oldoffer[ab].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){ad.data.push({accessNbr:this.accessNumber,instId:this.objInstId})}});if(ad!=null){if(!query.offer.invokeLoadInstSub(ad)){aa=false;return false}}}else{$.each(OrderInfo.oldoffer[ab].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){ad.acctNbr=this.accessNumber;ad.instId=this.objInstId;if(!query.offer.invokeLoadInst(ad)){aa=false;return false}}})}return aa}}else{if(ac!=null&&ac!=""&&ac!="undefined"&&ac=="1"){ad.data.push({accessNbr:Y.accNbr,instId:Y.prodInstId});return query.offer.invokeLoadInstSub(ad)}else{return query.offer.invokeLoadInst(ad)}}}}};var v=function(){rule.rule.init();var Y=true;for(var ab=0;ab<OrderInfo.oldprodInstInfos.length;ab++){var ac=OrderInfo.oldprodInstInfos[ab];var ah={boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:ac.mainProdOfferInstInfos[0].prodOfferInstId,prodId:ac.prodInstId};if(ac.mainProdOfferInstInfos[0].prodOfferId!=""){ah.specId=ac.mainProdOfferInstInfos[0].prodOfferId}var af=[];af.push(ah);var ad={areaId:OrderInfo.staff.soAreaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:ac.custId,soNbr:OrderInfo.order.soNbr,boInfos:af,prodInfo:ac};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var aa=$.callServiceAsJson(contextPath+"/rule/prepare",ad);$.unecOverlay();if(aa!=undefined&&aa.code==0){var ag=aa.data;if(ag==null){Y=false;$.alert("提示","规则校验异常，请联系管理人员！");return false}if(ag.ruleType=="portal"){if(ag.resultCode=="0"){Y=false;$.alert("提示",ag.resultMsg);return false}}var Z=ag.result.resultInfo;if(Z!=undefined&&Z.length>0){U();var ae="";$("#ruleTable").html("");$.each(Z,function(aj,ai){ae+="<tr>";ae+="<th>"+ai.resultCode+"</th>";ae+="<th>"+ai.ruleDesc+"</th>";ae+="<th>"+rule.rule.getRuleLevelName(ai.ruleLevel)+"</th>";ae+="<th>"+rule.rule.getRuleImgClass(ai.ruleLevel)+"</th>";ae+="</tr>"});Y=false;setTimeout(function(){$("#ruleTable").append(ae);$.jqmRefresh($("#order_tab_panel_content"))},100);return false}}else{Y=false;$.alertM(aa.data);return false}}if(Y){return true}};var U=function(){$.callServiceAsHtmlGet(contextPath+"/pad/order/rulecreate",{},{done:function(Z){if(!Z||!Z.data){return}var Y=$.popup("#div_rule_create",Z.data,{cache:true,width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){}})}})};var V=function(){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");var aa={memberChange:"Y",type:1,boActionTypeName:"主副卡成员变更",viceCardNum:parseInt(OrderInfo.oldAddNumList.length),offerNum:1,actionFlag:6,offerSpec:OrderInfo.oldofferSpec,prodInstInfos:OrderInfo.oldprodInstInfos,offer:OrderInfo.oldoffer,addflag:"ADD",oldnum:parseInt(OrderInfo.oldAddNumList.length)};var Y=order.prodModify.choosedProdInfo;var Z=[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:Y.prodOfferInstId,specId:Y.prodOfferId,prodId:E.objInstId}];if(rule.rule.ruleCheck(Z)){order.main.buildMainView(aa)}order.memberChange.closeDialog()};var J=function(){OrderInfo.oldAddNumList=[];OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldprodAcctInfos=[];var ad=0;var ao=$("#maincard_member_tbody .othermember .ui-grid-a");$.each(ao,function(){var ap=$(this).attr("accessnumber");if(order.memberChange.delmembers.flag){$.each(order.memberChange.delmembers.accessNumbers,function(){if(this.nbr==ap){$("#label_viceCard_new_"+ap).attr({style:"height:53px;line-height:53px;padding-left:18px;text-decoration:line-through"});$("#li_viceCard_new_"+ap).attr("del","Y").attr("knew","N");document.getElementById("button_viceCard_new_"+ap).innerHTML="不 拆"}})}if(order.memberChange.changemembers.flag){$.each(order.memberChange.changemembers.accessNumbers,function(){if(this.nbr==ap){order.service.choosedOffer("tcnum"+1,this.specId,"","viceCard_new_"+this.nbr,this.name)}})}});var ak=false;$.each(ao,function(){if($(this).attr("del")=="Y"||$(this).attr("knew")=="Y"){ak=true;return false}});$.each(L,function(){ad=ad+Number($("#"+this).val())});var Y=0;for(var ac=1;ac<=o;ac++){var aj=$.trim($("#oldphonenum_"+ac).val());if(ec.util.isObj(aj)){Y++}}if(!(ak)&&ad<=0&&Y<=0){$.alert("提示","没有对副卡进行操作。");return}var ag=order.prodModify.choosedProdInfo;var an=[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:ag.prodOfferInstId,specId:ag.prodOfferId,prodId:E.objInstId}];if(!rule.rule.ruleCheck(an)){return}var al={};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
if(ad>0){order.memberChange.newMemberFlag=true;var ab={prodId:ag.prodInstId,acctNbr:ag.accNbr,prodSpecId:ag.productId,areaId:ag.areaId};var af=query.offer.queryProdInstParam(ab);if(af&&af.prodSpecParams){OrderInfo.prodInstAttrs=af.prodSpecParams}al={memberChange:"Y",type:1,boActionTypeName:"主副卡成员变更",feeTypeMain:ag.feeType,offerNum:1,custId:OrderInfo.cust.custId,actionFlag:6,accessNumber:E.accessNumber,offerSpec:OrderInfo.offerSpec,newnum:parseInt(ad)};order.service.setOfferSpec()}else{order.memberChange.newMemberFlag=false}if(Y>0){order.memberChange.oldMemberFlag=true;if(!order.memberChange.queryofferinfo()){return}al.memberChange="Y";al.type=1;al.offerNum=1;al.actionFlag=6;al.oldprodInstInfos=OrderInfo.oldprodInstInfos;al.oldofferSpec=OrderInfo.oldofferSpec;al.oldoffer=OrderInfo.oldoffer;al.oldnum=Y}else{order.memberChange.oldMemberFlag=false}if(parseInt(ad)+parseInt(order.memberChange.viceCartNum)>F&&order.memberChange.reloadFlag!="N"){$.alert("提示","加装数量已经超过能加装的最大数量【"+F+"】!");return}if(ak){var aa=[];$.each(ao,function(aq,ap){if($(this).attr("knew")=="Y"||$(this).attr("del")=="Y"){aa.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerRoleId:$(this).attr("addRoleId"),offerSpecId:$(this).attr("addSpecId"),offerMemberId:$(this).attr("offerMemberId"),del:$(this).attr("del"),accessNumber:$(this).attr("accessNumber"),offerSpecName:$(this).attr("addSpecName"),roleName:"基础移动电话",knew:$(this).attr("knew")})}});order.memberChange.viceparams=aa;var ae=[];$.each(ao,function(aq,ap){if($(this).attr("del")=="Y"||$(this).attr("knew")=="Y"){ae.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerMemberId:$(this).attr("offerMemberId"),offerRoleId:$(this).attr("offerRoleId"),state:"DEL"})}});order.memberChange.ooRoless=ae;OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,21,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");var ai="removeProd";var am=CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;var Z={boActionTypeCd:am,submitFlag:ai,viceParam:aa,ooRoles:ae};var ab={areaId:OrderInfo.staff.areaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,boInfos:[]};ab.boInfos=an;if(!k()){return}var ah=order.prodModify.choosedProdInfo;al.boActionTypeCd=am;al.actionFlag="6";al.prodId=ah.prodInstId;al.offerMembers=OrderInfo.offer.offerMemberInfos;al.oldOfferSpecName=ah.prodOfferName;al.prodClass=ah.prodClass;al.appDesc=CONST.getAppDesc();al.submitFlag=ai;al.viceParam=aa;al.ooRoles=ae;order.memberChange.changeMemberFlag=true}else{order.memberChange.changeMemberFlag=false}order.main.buildMainView(al);order.memberChange.closeDialog()};var k=function(){return prod.uim.setProdUim()};var b=function(){var aa={code:"old_memberchange"};var Z=contextPath+"/order/getSimulateData";$.ecOverlay("<strong>正在查询公共数据查询的服务中,请稍后....</strong>");var Y=$.callServiceAsJsonGet(Z,aa);$.unecOverlay();if(Y.code==0){if(Y.data!=undefined){if("Y"==Y.data){return false}}}return true};var D=function(Y,ab){var Z=order.prodModify.choosedProdInfo;var aa=false;$.each(ab.viceParam,function(){var ae=this.objInstId;var af={areaId:OrderInfo.getProdAreaId(ae),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ae,prodSpecId:this.objId,offerSpecId:Z.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var ac=query.offer.queryChangeAttachOffer(af);$("#attach_"+ae).html(ac);$.jqmRefresh($("#attach_"+ae));if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){af.queryType="1,2";af.objId=this.objId;af.objType=this.objType;af.memberRoleCd="400";af.offerSpecId=this.offerSpecId;var ad=query.offer.queryDefMustOfferSpec(af);CacheData.parseOffer(ad,ae);var ad=query.offer.queryServSpec(af);CacheData.parseServ(ad,ae)}AttachOffer.showMainMemberRoleProd(ae);AttachOffer.changeLabel(ae,this.objId,"");if(AttachOffer.isChangeUim(ae)){if(!aa){$("#uimDiv_"+ae).show()}else{$("#uimDiv_"+ae).hide()}}aa=true})};var M=function(){if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){order.prodModify.dialogForm.close(order.prodModify.dialog)}};var Q=function(Y){var Z=[];var aa=[];var ab=[];Z=Y.viceParam;aa=Y.ooRoles;ab={viceParam:Z,ooRoles:aa,remark:$("#order_remark").val()};SoOrder.submitOrder(ab)};var g=function(Z,ab){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.cust.areaId;var Y=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;K(Y,ab,Z.prodInstId);x(Y,ab,Z);var aa=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(aa==undefined){return false}if(aa.resultCode==0&&ec.util.isObj(aa.result)){offerChange.resultOffer=aa.result}else{$.alert("预校验规则限制",aa.resultMsg);offerChange.resultOffer={};return false}return true};var K=function(Z,aa,Y){aa.offerTypeCd=1;aa.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;OrderInfo.getOfferBusiOrder(Z,aa,Y)};var x=function(af,ah,ae){var Z=OrderInfo.offerSpec;var ag=W();if(ag==undefined){alert("错误提示","无法加装到该套餐");return false}var Y={areaId:OrderInfo.getProdAreaId(ae.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.SEQ.offerSeq--,objId:Z.offerSpecId,offerTypeCd:"1",accessNumber:ae.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};if(ec.util.isArray(ah.offerMemberInfos)){Y.data.ooRoles=[];$.each(ah.offerMemberInfos,function(){var ai={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerRoleId:ag.offerRoleId,state:"ADD"};if(this.objType!=CONST.OBJ_TYPE.PROD){ai.prodId=prodId}Y.data.ooRoles.push(ai)})}if(ec.util.isArray(Z.offerSpecParams)){Y.data.ooParams=[];for(var ac=0;ac<Z.offerSpecParams.length;ac++){var aa=Z.offerSpecParams[ac];var ab={itemSpecId:aa.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:aa.offerSpecParamId,value:aa.value,state:"ADD"};Y.data.ooParams.push(ab)}}if(Z.ooTimes!=undefined){Y.data.ooTimes=[];Y.data.ooTimes.push(Z.ooTimes)}Y.data.busiOrderAttrs=[];var ad=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(ad!=undefined){ad.each(function(){var ai={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()};Y.data.busiOrderAttrs.push(ai);var aj={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};Y.data.busiOrderAttrs.push(aj)})}af.push(Y)};var W=function(){for(var aa=0;aa<OrderInfo.offerSpec.offerRoles.length;aa++){var ab=OrderInfo.offerSpec.offerRoles[aa];if(ab.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return ab}}for(var aa=0;aa<OrderInfo.offerSpec.offerRoles.length;aa++){var ab=OrderInfo.offerSpec.offerRoles[aa];for(var Z=0;Z<ab.roleObjs.length;Z++){var Y=ab.roleObjs[Z];if(Y.objType==CONST.OBJ_TYPE.PROD){return ab}}}};var p=function(aa){if(offerChange.resultOffer==undefined){return}var Y=offerChange.resultOffer.prodInfos;if(ec.util.isArray(Y)){$.each(Y,function(){var ae=this.accProdInstId;var ad=true;$.each(aa.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==ae){ad=false;return false}});if(ad){return true}if(ae!=this.prodInstId){var af=CacheData.getServ(ae,this.prodInstId);if(this.state=="DEL"){if(af!=undefined){var ac=$("#li_"+ae+"_"+this.prodInstId).find("span");ac.addClass("del");af.isdel="Y";$("#del_"+ae+"_"+this.prodInstId).hide()}}else{if(this.state=="ADD"){if(af!=undefined){$("#del_"+ae+"_"+this.prodInstId).hide()}else{var ab=CacheData.getServSpec(ae,this.productId);if(ab!=undefined){$("#del_"+ae+"_"+this.productId).hide()}else{if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(ae,this.productId)
}}}}}}})}var Z=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(Z)){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){var ab=this.objInstId;$.each(Z,function(){if(this.memberInfo==undefined){return true}var ae=CacheData.getOffer(ab,this.prodOfferInstId);var ad=true;$.each(this.memberInfo,function(){if(ab==this.accProdInstId){if(ec.util.isObj(ae)){this.prodId=this.accProdInstId}ad=false;return false}});if(ad){return true}if(this.state=="DEL"){if(ae!=undefined){var ac=$("#li_"+ab+"_"+this.prodOfferInstId).find("span");ac.addClass("del");ae.isdel="Y";if(this.isRepeat!="Y"){this.isRepeat="Y"}else{ae.isRepeat="Y"}$("#del_"+ab+"_"+this.prodOfferInstId).hide()}}else{if(this.state=="ADD"){if(ae!=undefined){$("#del_"+ab+"_"+this.prodOfferInstId).hide()}else{var af=CacheData.getOfferSpec(ab,this.prodOfferId);if(af!=undefined){$("#del_"+ab+"_"+this.prodOfferId).hide()}else{if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(ab,this.prodOfferId)}}}}}})})}}};var g=function(Z,ab){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.cust.areaId;var Y=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;K(Y,ab,Z.prodInstId);x(Y,ab,Z);var aa=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(aa==undefined){return false}if(aa.resultCode==0&&ec.util.isObj(aa.result)){offerChange.resultOffer=aa.result}else{$.alert("预校验规则限制",aa.resultMsg);offerChange.resultOffer={};return false}return true};var p=function(aa){if(offerChange.resultOffer==undefined){return}var Y=offerChange.resultOffer.prodInfos;if(ec.util.isArray(Y)){$.each(Y,function(){var ae=this.accProdInstId;var ad=true;$.each(aa.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==ae){ad=false;return false}});if(ad){return true}if(ae!=this.prodInstId){var af=CacheData.getServ(ae,this.prodInstId);if(this.state=="DEL"){if(af!=undefined){var ac=$("#li_"+ae+"_"+this.prodInstId).find("span");ac.addClass("del");af.isdel="Y";$("#del_"+ae+"_"+this.prodInstId).hide()}}else{if(this.state=="ADD"){if(af!=undefined){$("#del_"+ae+"_"+this.prodInstId).hide()}else{var ab=CacheData.getServSpec(ae,this.productId);if(ab!=undefined){$("#del_"+ae+"_"+this.productId).hide()}else{if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(ae,this.productId)}}}}}}})}var Z=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(Z)){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){var ab=this.objInstId;$.each(Z,function(){if(this.memberInfo==undefined){return true}var ae=CacheData.getOffer(ab,this.prodOfferInstId);var ad=true;$.each(this.memberInfo,function(){if(ab==this.accProdInstId){if(ec.util.isObj(ae)){this.prodId=this.accProdInstId}ad=false;return false}});if(ad){return true}if(this.state=="DEL"){if(ae!=undefined){var ac=$("#li_"+ab+"_"+this.prodOfferInstId).find("span");ac.addClass("del");ae.isdel="Y";if(this.isRepeat!="Y"){this.isRepeat="Y"}else{ae.isRepeat="Y"}$("#del_"+ab+"_"+this.prodOfferInstId).hide()}}else{if(this.state=="ADD"){if(ae!=undefined){$("#del_"+ab+"_"+this.prodOfferInstId).hide()}else{var af=CacheData.getOfferSpec(ab,this.prodOfferId);if(af!=undefined){$("#del_"+ab+"_"+this.prodOfferId).hide()}else{if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(ab,this.prodOfferId)}}}}}})})}}};var Q=function(Y){var Z=[];var aa=[];var ab=[];Z=Y.viceParam;aa=Y.ooRoles;ab={viceParam:Z,ooRoles:aa,remark:$("#order_remark").val()};SoOrder.submitOrder(ab)};var s=function(Y){var Z=$("#li_viceCard_new_"+Y);if(Z.attr("del")=="N"){$("#label_viceCard_new_"+Y).attr({style:"height:53px;line-height:53px;padding-left:18px;text-decoration:line-through"});Z.attr("del","Y").attr("knew","N");document.getElementById("button_viceCard_new_"+Y).innerHTML="不 拆";$("#button_"+Y).attr("accNbr",Y)}else{$("#label_viceCard_new_"+Y).attr({style:"height:53px;line-height:53px;padding-left:18px;text-decoration:''"});Z.attr("del","N").attr("knew","N");document.getElementById("button_viceCard_new_"+Y).innerHTML="拆副卡";$("#button_"+Y).attr("accNbr","")}};return{idnum:o,showOfferCfgDialog:H,closeDialog:M,submit:J,offerProd:E,ischooseOffer:u,removeAndAdd:Q,queryofferinfo:l,addNum:G,checkOrder:g,checkOfferProd:p,getSimulateData:b,fillmemberChange:D,delNum:h,reloadFlag:d,newSubPhoneNum:t,oldSubPhoneNum:N,mktResInstCode:C,newmembers:w,oldmembers:c,delmembers:A,changemembers:y,rejson:m,removeOtherCard:s,oldMemberFlag:f,newMemberFlag:X,changeMemberFlag:r,viceparams:O,ooRoless:q,queryofferinfoSub:i}}();$(function(){$("#memeberChangeclose").click(function(){order.memberChange.closeDialog()});$("#memeberChange .btna_o:first").click(function(){$("#memeberChange .btna_o:first").removeClass("btna_o").addClass("btna_g");order.memberChange.submit();$("#memeberChange .btna_g:first").removeClass("btna_g").addClass("btna_o")});$("#memeberChange .btna_o:last").click(function(){order.memberChange.closeDialog()})});CommonUtils.regNamespace("CONST");CONST=(function(){var f=-1;var s="10000";var z="20020054";var F={FOUR_G:11,APP:15,LTE:10,UI_LTE:8,ZDYY:14};var W={FLOW:"100",SERV:"10000"};var c={CDMA:235010000,DATA_CARD:280000000,PROD_FUN_4G:"280000020"};var Q={MIFI_ID:"235010076",WIRE_GLOBAL:"13409441"};var i={FEE_TYPE:"10020030",IS_XINKONG:"40010030",PROD_USER:"800000011"};var u={IS_XINKONG_YES:"20",IS_XINKONG_NO:"10"};var O={CREDIT_LIMIT:"30010040",PROTOCOL_NBR:"30020008"};var S={UIM_CHARGE_ITEM_CD:"2014000"};var L={THREE:3,FOUR:4};var M={MUST:"1000",SELECT:"1001",ZDYY:"100004"};var l={CLOSE:"1000",KIP:"1001",CHOOSE:"1002"};var A={REMOVE_PROD:110000,NORMAL_PROD:100000,STOP_PROD:120000,READY_PROD:140001,DONE_PROD:140002,NEW_PROD:130000};var h={AFTER_PAY:1200,BEFORE_PAY:2100,NOLIMIT_PAY:3100,BEFORE_AFTER_PAY:2101,BEFORE_AFTER_QUASIREALTIME_PAY:3103,QUASIREALTIME_AFTER_PAY:3102,AFTER_BEFORE_PAY:1202,QUASIREALTIME_BEFORE_PAY:3101,QUASIREALTIME_PAY:1201};var a={CUST_ACTION:1000,ACCT_ACTION:1100,OFFER_ACTION:1200,PROD_ACTION:1300,MKTRES_ACTION:1600};var m={PROD:2,FUN_PROD:4,SERV:4,OFFER:7};var n={BUY_OFFER:"S1",DEL_OFFER:"S2",ADDOREXIT_COMP:"S3",UPDATE_OFFER:"S3",CUST_CREATE:"C1",CUSTINFOMODIFY:"C2",ACCT_CREATE:"A1",ACCTINFOMODIFY:"A2",NEW_PROD:"1",UPDATE_ACCNBR:"2",REMOVE_PROD:"3",PREMOVE_PROD:"4020200000",SERV_OPEN:"7",PREMOVE_BACK_PROD:"4070100003",BREAK_RULE_REMOVE_PROD:"4020300002",OWE_REMOVE_PROD:"66",NOACTIVE_REMOVE_PROD:"4020400000",DIFF_AREA_CHANGE_CARD:"4040600001",CHANGE_CARD:"14",LOSSREP_PROD:"1171",DISLOSSREP_PROD:"1172",STOPKEEPNUM:"19",DISSTOPKEEPNUM:"20",PRODUCT_PASSWORD:"18",PRODUCT_PASSWORD_RESET:"4040800003",PRODUCT_PARMS:"1179",PRODUCT_INFOS:"4040100000",TRANSFER:"11",ACTIVERETURN:"1020500000",TRANSFERRETURN:"4041700000",ACTIVERETURNTWO:"4070400000",CHANGE_ACCOUNT:"-6",ADD_COMP:"998",REMOVE_COMP:"999",COUPON_SALE:"3010200000",RETURN_COUPON:"3030300000",EXCHANGE_COUPON:"4040800002",CHANGE_FEE_TYPE:"1244",BUY_BACK:"5010100002",BUY_BACK_CHANGE_CARD:"7040100001",BUY_BACK_ORDER_CONTRACT:"3030200000",TERMINAL_RESERVATION:"3010300000",RETURN_TERMINAL:"3030400000"};var v={S1:"订购","1":"新装","3":"拆机","4020300002":"违章拆机","66":"欠费拆机","4020400000":"未激活拆机","1171":"挂失","1172":"解挂","19":"停机保号","20":"停机保号复机","18":"产品密码修改","4040800003":"产品密码重置",C1:"新建客户",C2:"修改客户信息","1179":"修改产品属性",S3:"主副卡成员变更","11":"过户","1020500000":"改客户资料返档","4041700000":"过户返档","-6":"改帐务定制关系",A2:"修改帐户信息","4020200000":"预拆机","4070100003":"预拆机复机","5010100002":"新装返销","2":"改号","7040100001":"补换卡返销","3030200000":"订购合约返销"};var d={OFFER_BUY:"订购销售品",OFFER_DEL:"退订销售品",OFFER_UPDATE:"变更销售品 ",PROD_NEW:"新装",PROD_UPDATE:"变更功能产品",PROD_OPEN:"开通功能产品",PROD_CLOSE:"关闭功能产品"};var r={REMOVE_REASON:"111111122",DEALER:"111111116",DEALER_NAME:"111111120",DEALER_CODE:"111111125",REMARK:"111111118",orderAttrName:"30010020",orderAttrPhoneNbr:"30010025",orderIdentidiesTypeCd:"30010026",orderAttrIdCard:"30010021",orderAttrAddr:"30010022",EXT_CUST_ID:"20900011",COR_CUST_ID:"30010027",EXT_PROD_INST_ID:"30010045",COR_PROD_INST_ID:"30010044",EXT_COUPON_INST_ID:"30010047",COR_COUPON_INST_ID:"30010046",PROV_ISALE:"40010029",THRETOFOUR_ITEM:"111111199",BUSITYPE_FLAG:"30010024",ZCD_ITEM:"111111198",SO_NBR:"111111196",STEP_ORDER_CHARGE_STAFF:"111111197",DELIVERY_TYPE:"800000013",DELIVERY_METHOD:"800000014",DELIVERY_TIME:"800000015",DELIVERY_ADDRESS:"800000016",DELIVERY_POLICY:"800000018",itemSpecID:"800000036"};
var R={FEE_TYPE:"10020030",PROT_NUMBER:"11251741"};var e=function(Y){return v[Y]};var y={COMMON_MEMBER:1,MAIN_CARD:400,VICE_CARD:401,BROADBAND_MAIN_CARD:500,BROADBAND_VICE_CARD:501,CONTENT:99991};var T=[{MEMBER_ROLE_CD:1,MEMBER_ROLE_NAME:"普通成员"},{MEMBER_ROLE_CD:400,MEMBER_ROLE_NAME:"天翼主卡"},{MEMBER_ROLE_CD:401,MEMBER_ROLE_NAME:"天翼副卡"},{MEMBER_ROLE_CD:500,MEMBER_ROLE_NAME:"天翼宽带主卡"},{MEMBER_ROLE_CD:501,MEMBER_ROLE_NAME:"天翼宽带副卡"},{MEMBER_ROLE_CD:600,MEMBER_ROLE_NAME:"基础套餐级可选包"},{MEMBER_ROLE_CD:601,MEMBER_ROLE_NAME:"加装套餐级可选包"},{MEMBER_ROLE_CD:99991,MEMBER_ROLE_NAME:"内容产品"}];var p={SUCC_CODE:"POR-0000",FAIL_CODE:"POR-2004"};var t={busiOrderAttrs:111111122};var j={NEW_PROD:1,ATTACH_OFFER_CHANGE:2,OFFER_CHANGE:5,NEW_PROD:1,NEW_PROD:1};var w={COUPON_SALE:"2007000",COUPON_RESERVATION_SALE:"2007002"};var E={USABLE:"1001",HAVESALE:"1115"};var D={BRAND:60010002,PHONE_TYPE:60010003,COLOR:60010004,TERMINAL_TYPE:60010013,SUPPORT4G:60010023,SUPPORT4NFC:60010024};var P={XIAN_JIN:100000,YIN_HANG:110000,POS:110100,WANG_YIN:110200,TUO_SHOU:110300,ZHI_PIAO:110400,FEN_QI_FU_KUAN:110500,YIN_HANG_DAI_KOU:110600,DI_SAN_FANG_ZHI_FU_PING_TAI:120000,YI_ZHI_FU:120100,ZHI_FU_BAO:120200,TAO_BAO_XIN_YONG_KA:120201,CAI_FU_TONG:120300,QU_DAO_DAI_SHOU:130000,JI_TUAN_DAI_SHOU:130100,ZHENG_QI_DAI_SHOU:130200,ZHANG_WU_DAI_SHOU:140000,HUA_FEI_YU_E:140100,DI_KOU_LEI:150000,DIAN_XIN_KA_DI_KOU:150100,JI_FEN_DI_KOU:150200,TAO_BAO_JI_FEN_DI_KOU:150201,DAI_JIN_QUAN_DI_KOU:150300,HUO_DAO_FU_KUAN:160000,XIAN_JIN_DAO_FU:160100,POS_DAO_FU:160200};var C={SILENT_OLID:"silentOlId"};var V=function(){if(CONST.APP_DESC==-1){o();return CONST.APP_DESC}else{return CONST.APP_DESC}};var o=function(){CONST.APP_DESC=globalAppDesc};var X=/^(180|189|133|134|153|181|108|170|177)\d{8}$/;var K=/^(170)\d{8}$/;var k="100003";var g=381000960;var J=10020034;var H=10020035;var G=10020036;var x={ZQZXDL:100100,GZZXDL:100300,HYKHZXDL:100101,SYKHZXDL:100102,XYKHZXDL:100103,GZZXJL:100301,ZYOUT:110100,ZYINGT:110101,WBT:110102};var I=["381001824","13409900"];var U=["235010013","381001823"];var b={"235010013":"10020047","381001823":"10020047"};var N=function(Z,Y){if(b[Z]==Y){return b[Z]}else{return""}};var q={IS4G:"1",IS3G:"0"};var B={BATCHORDER_QRY_FLAG:"N",BATCHORDER_AUTH_FLAG:"N"};return{BATCHORDER_FLAG:B,APP_DESC:f,OFFER_FAST_FILL:z,setAppDesc:o,BO_ACTION_TYPE:n,ACTION_CLASS_CD:a,PROD_STATUS_CD:A,BUSI_ORDER_ATTR:r,MEMBER_ROLE_CD:y,MEMBER_ROLE_LIST:T,PROD_SPEC:c,PROD_ATTR:i,ACCT_ATTR:O,getBoActionTypeName:e,PAY_TYPE:h,CODE:p,OL_TYPE_CD:F,LABEL:W,PROD_CLASS:L,ITEM_SPEC_ID_CODE:t,EVENT:d,TEMPLATE_TYPE:j,CUST_COUPON_SALE:s,CHARGE_ITEM_CD:w,MKTRES_STATUS:E,ITEM_SPEC:R,OBJ_TYPE:m,ACCT_ITEM_TYPE:S,getAppDesc:V,RELA_TYPE_CD:M,UNSS_PROCESS_MODE:l,TERMINAL_SPEC_ATTR_ID:D,PAYMETHOD_CD:P,DEL_ORDER_FLAG:C,PROD_SPEC_ID:Q,LTE_PHONE_HEAD:X,MVNO_PHONE_HEAD:K,RELATYPECD:k,YZFservSpecId:g,YZFitemSpecId1:J,YZFitemSpecId2:H,YZFitemSpecId3:G,CHANNEL_TYPE_CD:x,GROUP_SERV_SPEC_ID:U,GROUP_PROD_SPEC:I,getGroupServProdMap:N,CHANNEL_TYPE_CD:x,UIMTYPE3G4G:q,PROD_ATTR_VALUE:u}})();$(function(){CONST.getAppDesc()});CommonUtils.regNamespace("query","common");query.common=(function(){var a=function(e,d){var c=contextPath+"/order/queryApConf";var b={CONFIG_PARAM_TYPE:e};if(typeof(d)=="function"){$.callServiceAsJsonGet(c,b,{done:function(f){$.unecOverlay();if(f.code==0){if(f.data){d(f.data)}}else{if(f.code==-2){$.alertM(f.data)}else{$.alert("提示","查询门户层配置信息失败,稍后重试")}}}})}};return{queryApConfig:a}})();CommonUtils.regNamespace("OrderInfo");OrderInfo=(function(){var y=0;var at=0;var h="";var ab="";var ah=[];var B="";var ao="";var Z="";var q={provIsale:"",redirectUri:"",isFee:"1",extCustOrderID:"",reloadFlag:"",prodOfferId:"",prodOfferName:"",mktResInstCode:"",codeMsg:"",mergeFlag:"0"};var al;var i={mainPhoneNum:"",newSubPhoneNum:"",oldSubPhoneNum:"",mktResInstCode:""};var ai=[];var W={prodOfferId:"",cardNum:"",checkMaskList:[],feeType:"",orderMark:"",isReloadFlag:"",reloadFlag:"",objInstId:"",dealerlist:[],paymentAcctTypeCd:"",mailingType:"",bankAcct:"",bankId:"",limitQty:"",paymentMan:"",param1:"",param2:"",param3:"",param7:""};var F={result:{},checkMaskList:[],prodOfferId:"",prodOfferName:"",isReloadFlag:"",paymentAcctTypeCd:"",mailingType:"",bankAcct:"",bankId:"",limitQty:"",paymentMan:"",param1:"",param2:"",param3:"",param7:"",isLastFlag:""};var am=[];var ac={custId:"",partyName:"",vipLevel:"",vipLevelName:"",custFlag:"1100"};var a={staffId:0,channelId:0,channelName:"",areaId:0,areaCode:0,soAreaId:0,soAreaCode:0,distributorId:""};var U={};var A={offerId:"",offerSpecId:"",offerMemberInfos:[]};var s={offerId:"",offerSpecId:"",offerMemberInfos:[]};var u=0;var e="";var O="订购";var x="";var T="";var S=[];var G={};var k=[];var p={};var aa={dealerType:"",soNbr:"",oldSoNbr:"",oldSoId:"",step:0,token:"",templateType:1,dealerTypeList:[]};var m={effTime:""};var t={seq:-1,offerSeq:-1,prodSeq:-1,servSeq:-1,itemSeq:-1,acctSeq:-1,acctCdSeq:-1,paramSeq:-1,atomActionSeq:-1,offerMemberSeq:-1,dealerSeq:1};var Q=function(ay){for(var ax=0;ax<OrderInfo.checkUimData.length;ax++){var az=OrderInfo.checkUimData[ax];if(az.prodId==ay){OrderInfo.checkUimData.splice(ax,1)}}};var ak=function(ay){for(var ax=0;ax<OrderInfo.checkUimData.length;ax++){var az=OrderInfo.checkUimData[ax];if(az.prodId==ay){return az}}return""};var r=function(ax,ay,az){OrderInfo.channelList=[];if($("i[name='channel_iofo_i']").length==0){OrderInfo.channelList=window.parent.OrderInfo.getChannelList()}else{$("i[name='channel_iofo_i']").each(function(){var aC=$(this).attr("channel_Id");var aA=$(this).attr("channel_Name");var aE=$(this).attr("channel_Nbr");var aD=0;if($(this).hasClass("select")){var aD=1}var aB={channelId:aC,channelName:aA,channelNbr:aE,isSelect:aD};OrderInfo.channelList.push(aB)})}return OrderInfo.channelList};var L=[];var I=[];var an=[];var Y=[];var X=[];var av=[];var b=[];var c=[];var ag=[];var o=function(){var ax={orderList:{orderListInfo:{isTemplateOrder:"N",templateType:OrderInfo.order.templateType,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,areaId:OrderInfo.staff.soAreaId,partyId:-1,distributorId:OrderInfo.staff.distributorId,olTypeCd:CONST.OL_TYPE_CD.UI_LTE},custOrderList:[{busiOrder:[]}]}};OrderInfo.orderData=ax;return OrderInfo.orderData};var ap=function(ay){var ax=n(-1);var az={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.CUST_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.CUST_CREATE},data:{boCustInfos:[],boCustIdentities:[],boPartyContactInfo:[]}};if(ec.util.isObj(ax)){az.busiObj.accessNumber=ax}az.data.boCustInfos.push(OrderInfo.boCustInfos);az.data.boCustIdentities.push(OrderInfo.boCustIdentities);if($("#tabProfile0").attr("click")=="0"&&($("#contactName").val()!="")){az.data.boPartyContactInfo.push(OrderInfo.boPartyContactInfo)}if(OrderInfo.boCustProfiles!=undefined&&OrderInfo.boCustProfiles!=""){az.data.boCustProfiles=[];az.data.boCustProfiles=OrderInfo.boCustProfiles}ay.push(az)};var d=function(aE,aF){var ay=$("#acctName").val();var aG=$("#paymentType").val();var aA="";var aC="";var aD="";if(aG==110000){aA=$("#bankId").val();aC=$("#bankAcct").val();aD=$("#paymentMan").val()}var ax={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:aF},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.ACCT_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACCT_CREATE},data:{boAccountInfos:[{partyId:OrderInfo.cust.custId,acctName:ay,acctCd:aF,acctId:aF,businessPassword:"111111",state:"ADD",acctTypeCd:"1"}],boPaymentAccounts:[{paymentAcctTypeCd:aG,bankId:aA,bankAcct:aC,paymentMan:aD,limitQty:"1",state:"ADD"}],boAcct2PaymentAccts:[{priority:"1",state:"ADD"}],boAccountItems:[],boAccountMailings:[]}};var az=n(-1);if(ec.util.isObj(az)){ax.busiObj.accessNumber=az}if($("#paymentType").val()==110000&&$.trim($("#protocalNbr").val())!=""){var aH={itemSpecId:CONST.ACCT_ATTR.PROTOCOL_NBR,value:$.trim($("#protocalNbr").val()),state:"ADD"};ax.data.boAccountItems.push(aH)}if($("#postType").val()!=-1){var aB={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"ADD"};
if($("#postType").val()==11||$("#postType").val()==15){aB.param1=$("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val()}ax.data.boAccountMailings.push(aB)}aE.push(ax)};var au=function(ay,aA,aC){var ax=n(aC);var aB={areaId:OrderInfo.getProdAreaId(aC),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:aA.offerId,objId:aA.offerSpecId,offerTypeCd:aA.offerTypeCd},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:aA.boActionTypeCd},data:{}};if(ec.util.isObj(aA.offerSpecName)){aB.busiObj.objName=aA.offerSpecName}if(ec.util.isObj(ax)){aB.busiObj.accessNumber=ax}if(aA.boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_OFFER){var az=$("li[name='tr_"+aC+"_"+aA.offerSpecId+"']");if(az!=undefined&&az.length>0){aB.data.busiOrderAttrs=[];az.each(function(){var aD={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()};aB.data.busiOrderAttrs.push(aD);var aE={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};aB.data.busiOrderAttrs.push(aE)})}aB.data.ooOwners=[];aB.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"ADD"});if(ec.util.isArray(aA.offerSpecParams)){aB.data.ooParams=[];$.each(aA.offerSpecParams,function(){if(this.setValue==undefined){this.setValue=this.value}if(ec.util.isObj(this.setValue)){var aD={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};aB.data.ooParams.push(aD)}})}if(aA.ooTimes!=undefined){aB.data.ooTimes=[];aB.data.ooTimes.push(aA.ooTimes)}$.each(OrderInfo.attach2Coupons,function(){if(aA.offerSpecId==this.attachSepcId&&aC==this.prodId){this.offerId=aA.offerId;aB.data.bo2Coupons=[];aB.data.bo2Coupons.push(this);return false}});aB.data.ooRoles=[];if(ec.util.isArray(aA.offerRoles)){$.each(aA.offerRoles,function(){var aD=this;$.each(this.roleObjs,function(){var aH={prodId:aC,offerRoleId:aD.offerRoleId,objId:this.objId,objType:this.objType,relaType:this.relaTypeCd,state:"ADD"};var aF=true;if(this.objType==CONST.OBJ_TYPE.PROD){var aG=OrderInfo.getProdSpecId(aC);if(aG==this.objId||aG==""){aH.objInstId=aC}else{return true}}else{if(this.objType==CONST.OBJ_TYPE.SERV){var aI=CacheData.getServBySpecId(aC,this.objId);if(aI!=undefined){aH.objInstId=aI.servId}else{var aE=CacheData.getServSpec(aC,this.objId);if(aE!=undefined&&aE.isdel!="Y"&&aE.isdel!="C"&&aE.servId!=undefined&&aE.servId!=""){aH.objInstId=aE.servId}else{aF=false}}}else{aH.objInstId=OrderInfo.SEQ.offerSeq--}}if(aF){aB.data.ooRoles.push(aH)}})})}ay.push(aB)}else{if(aA.boActionTypeCd==CONST.BO_ACTION_TYPE.DEL_OFFER){aB.data.ooOwners=[];aB.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"DEL"});if(ec.util.isArray(aA.offerMemberInfos)){aB.data.ooRoles=[];$.each(aA.offerMemberInfos,function(){var aD={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerRoleId:this.offerRoleId,state:"DEL"};if(this.objType!=CONST.OBJ_TYPE.PROD){aD.prodId=aC}if(this.offerMemberId!=undefined){aD.offerMemberId=this.offerMemberId}aB.data.ooRoles.push(aD)})}if(aA.isRepeat!="Y"){ay.push(aB)}}else{if(aA.boActionTypeCd==CONST.BO_ACTION_TYPE.UPDATE_OFFER){if(aA.isUpdate=="Y"){aB.data.ooRoles=aA.data}else{if(ec.util.isArray(aA.offerSpec.offerSpecParams)){aB.data.ooParams=[];$.each(aA.offerSpec.offerSpecParams,function(){if(this.isUpdate=="Y"){if(ec.util.isObj(this.value)){var aD={itemSpecId:this.itemSpecId,offerParamId:this.offerParamId,offerSpecParamId:this.offerSpecParamId,value:this.value,state:"DEL"};aB.data.ooParams.push(aD)}if(ec.util.isObj(this.setValue)){var aE={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};aB.data.ooParams.push(aE)}}})}}ay.push(aB)}}}};var H=function(aC){var ay=n(aC.prodId);var aB={areaId:OrderInfo.getProdAreaId(aC.prodId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.getProdSpecId(aC.prodId),instId:aC.prodId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:aC.boActionTypeCd},data:{}};if(ec.util.isObj(aC.isComp)){aB.busiObj.isComp=aC.isComp}if(ec.util.isObj(ay)){aB.busiObj.accessNumber=ay}if(aC.boActionTypeCd==CONST.BO_ACTION_TYPE.PRODUCT_PARMS){if(ec.util.isArray(aC.prodSpecParams)){aB.data.boServOrders=[];aB.data.boServOrders.push({servId:aC.memberId,servSpecId:aC.servSpecId});aB.data.boServItems=[];$.each(aC.prodSpecParams,function(){if(this.isUpdate=="Y"){if(ec.util.isObj(this.value)){var aD={itemSpecId:this.itemSpecId,servId:aC.memberId,value:this.value,state:"DEL"};aB.data.boServItems.push(aD)}if(ec.util.isObj(this.setValue)){var aE={itemSpecId:this.itemSpecId,servId:aC.memberId,value:this.setValue,state:"ADD"};aB.data.boServItems.push(aE)}}})}}else{if(aC.boActionTypeCd==CONST.BO_ACTION_TYPE.SERV_OPEN){var aA="ADD";if(aC.servClose=="Y"){aA="DEL"}else{if(aC.servSpecId==undefined&&aC.objId!=undefined){aC.servSpecId=aC.objId}}var az={servId:aC.servId,servSpecId:aC.servSpecId};if(ec.util.isObj(aC.servSpecName)){az.servSpecName=aC.servSpecName}aB.data.boServOrders=[];aB.data.boServOrders.push(az);aB.data.boServs=[];aB.data.boServs.push({servId:aC.servId,state:aA});if(aC.servClose!="Y"){if(ec.util.isArray(aC.prodSpecParams)){aB.data.boServItems=[];$.each(aC.prodSpecParams,function(){if(this.setValue==undefined){this.setValue=this.value}var aD=$("select[name='pay_type_-1']").val();if(aD==undefined){aD=order.prodModify.choosedProdInfo.feeType}if(aC.servSpecId==CONST.YZFservSpecId&&aD==CONST.PAY_TYPE.AFTER_PAY){this.setValue=""}if(ec.util.isObj(this.setValue)){var aE={itemSpecId:this.itemSpecId,servId:aC.servId,value:this.setValue,state:aA};aB.data.boServItems.push(aE)}})}}}else{if(aC.boActionTypeCd==CONST.BO_ACTION_TYPE.REMOVE_PROD){aB.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}]}else{if(aC.boActionTypeCd==CONST.BO_ACTION_TYPE.CHANGE_CARD||aC.boActionTypeCd==CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD){var ax=OrderInfo.getProdUim(aC.prodId);if(ec.util.isObj(ax.prodId)){aB.data.bo2Coupons=[];aB.data.bo2Coupons.push(ax);aB.data.bo2Coupons.push(OrderInfo.getProdOldUim(aC.prodId))}else{if(OrderInfo.zcd_privilege==0){aB.data.bo2Coupons=[];aB.data.bo2Coupons.push(OrderInfo.getProdOldUim(aC.prodId))}else{return false}}}}}}return aB};var v=function(ax,aA){var ay=order.prodModify.choosedProdInfo;var az={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ay.productId,instId:ay.prodInstId,accessNumber:ay.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};az.data=aA;ax.push(az)};var ar={areaId:0,defaultIdType:"1",businessPassword:"",name:"",partyTypeCd:1,state:"ADD",telNumber:"",addressStr:"",mailAddressStr:""};var D={identidiesTypeCd:"1",identityNum:"",isDefault:"Y",state:"ADD"};var K={contactAddress:"",contactDesc:"",contactEmployer:"",contactGender:"",contactId:"",contactName:"",contactType:"",eMail:"",fax:"",headFlag:"",homePhone:"",mobilePhone:"",officePhone:"",postAddress:"",postcode:"",staffId:0,state:"",statusCd:"100001"};var aw={};var f=function(){OrderInfo.SEQ.seq=-1;OrderInfo.SEQ.offerSeq=-1;OrderInfo.SEQ.prodSeq=-1;OrderInfo.SEQ.servSeq=-1;OrderInfo.SEQ.itemSeq=-1;OrderInfo.SEQ.acctSeq=-1;OrderInfo.SEQ.acctCdSeq=-1;OrderInfo.SEQ.paramSeq=-1;OrderInfo.SEQ.atomActionSeq=-1};var N=function(){OrderInfo.boProdAns=[];OrderInfo.boProd2Tds=[];OrderInfo.bo2Coupons=[];AttachOffer.openList=[];AttachOffer.openedList=[];AttachOffer.openServList=[];AttachOffer.openedServList=[];AttachOffer.openAppList=[];AttachOffer.labelList=[];OrderInfo.confirmList=[];OrderInfo.orderResult={};OrderInfo.order.step=1};var ae=function(ax,aA,aB,az,ay){if(ax!=""&&ax!=undefined){OrderInfo.actionClassCd=ax}if(aA!=""&&aA!=undefined){OrderInfo.boActionTypeCd=aA
}if(aB!=undefined){OrderInfo.actionFlag=aB}if(az!=""&&az!=undefined){OrderInfo.actionTypeName=az}if(ay!=""&&ay!=undefined){OrderInfo.order.templateType=ay}};var R=function(aA){var ax={};for(var ay=0;ay<OrderInfo.boProdAns.length;ay++){var az=OrderInfo.boProdAns[ay];if(az==undefined){continue}else{if(az.prodId==aA){ax=az}}}return ax};var l=function(ay,ax){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==ay){this.an=ax;return false}})})};var z=function(ax){if(ax!=undefined&&ax>0){if(OrderInfo.actionFlag==1){return OrderInfo.cust.areaId}else{var ay=order.prodModify.choosedProdInfo.areaId;if(ay==undefined||ay==""){$.alert("错误提示","产品信息未返回地区ID，请营业后台核实！");return}return ay}}else{if(ec.util.isObj(OrderInfo.cust.areaId)){return OrderInfo.cust.areaId}else{return OrderInfo.staff.soAreaId}}};var aj=function(){var ax=OrderInfo.staff.soAreaId;if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){}else{if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==4||OrderInfo.actionFlag==9){if(ec.util.isObj(OrderInfo.cust.areaId)){ax=OrderInfo.cust.areaId}}else{if(ec.util.isObj(order.prodModify.choosedProdInfo.areaId)){ax=order.prodModify.choosedProdInfo.areaId}}}return ax};var af=function(ay){for(var ax=0;ax<OrderInfo.boProd2OldTds.length;ax++){var az=OrderInfo.boProd2OldTds[ax];if(az.prodId==ay){return az}}return{}};var C=function(ay){for(var ax=0;ax<OrderInfo.boProd2Tds.length;ax++){var az=OrderInfo.boProd2Tds[ax];if(az.prodId==ay){return az}}return{}};var V=function(ay){for(var ax=0;ax<OrderInfo.boProd2Tds.length;ax++){var az=OrderInfo.boProd2Tds[ax];if(az.prodId==ay){OrderInfo.boProd2Tds.splice(ax,1)}}};var P=function(ay){for(var ax=0;ax<OrderInfo.boProd2Tds.length;ax++){var az=OrderInfo.boProd2Tds[ax];if(az.prodId==ay){return az.terminalCode}}return""};var aq=function(aB){var ay=true;for(var aA=0;aA<OrderInfo.bo2Coupons.length;aA++){var az=OrderInfo.bo2Coupons[aA];if(az.prodId==aB){ay=false;return az}}if(ay){var ax={prodId:aB,coupons:[]};OrderInfo.bo2Coupons.push(ax);return ax}};var M=function(aB){var ay=true;for(var aA=0;aA<OrderInfo.bo2Coupons.length;aA++){var az=OrderInfo.bo2Coupons[aA];if(az.prodId==aB){az.coupons=[];return az}}if(ay){var ax={prodId:aB,coupons:[]};OrderInfo.bo2Coupons.push(ax);return ax}};var n=function(aA){var ax="";if(OrderInfo.actionFlag==1){var aB="'"+aA+"'";if(aB.indexOf("-")!=-1){for(var ay=0;ay<OrderInfo.boProdAns.length;ay++){var az=OrderInfo.boProdAns[ay];if(az.prodId==aA){if(az.accessNumber!=undefined){ax=az.accessNumber}}}}else{$.each(OrderInfo.offer.offerMemberInfos,function(aC){if(this.objInstId==aA){ax=this.accessNumber;return false}});if((ax==undefined||ax=="")&&offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==aA){ax=this.accessNumber;return false}})})}}}else{if(OrderInfo.actionFlag==14){for(var ay=0;ay<OrderInfo.boProdAns.length;ay++){var az=OrderInfo.boProdAns[ay];if(az.prodId==aA){if(az.accessNumber!=undefined){ax=az.accessNumber}}}}else{if(OrderInfo.actionFlag==6){for(var ay=0;ay<OrderInfo.boProdAns.length;ay++){var az=OrderInfo.boProdAns[ay];if(az.prodId==aA){if(az.accessNumber!=undefined){ax=az.accessNumber}}}$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==aA){ax=this.accNbr;return false}});$.each(OrderInfo.offer.offerMemberInfos,function(aC){if(this.objInstId==aA){ax=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){var aB="'"+aA+"'";if(aB.indexOf("-")!=-1){for(var ay=0;ay<OrderInfo.boProdAns.length;ay++){var az=OrderInfo.boProdAns[ay];if(az.prodId==aA){if(az.accessNumber!=undefined){ax=az.accessNumber}}}}else{$.each(OrderInfo.offer.offerMemberInfos,function(aC){if(this.objInstId==aA){ax=this.accessNumber;return false}});if((ax==undefined||ax=="")&&offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==aA){ax=this.accessNumber;return false}})})}}}else{if(OrderInfo.actionFlag==35){ax=stepOrder.main.getAccessNumber(aA)}else{if(aA!=undefined&&aA>0){ax=order.prodModify.choosedProdInfo.accNbr}}}}}}return ax};var j=function(aA){var ax="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var ay=0;ay<OrderInfo.boProdAns.length;ay++){var az=OrderInfo.boProdAns[ay];if(az.prodId==aA){if(az.areaCode!=undefined){ax=az.areaCode}}}}else{if(aA!=undefined&&aA>0){ax=order.prodModify.choosedProdInfo.areaCode}}if(ax==undefined||ax==""){ax=OrderInfo.staff.areaCode}return ax};var E=function(ax){var ay="";$.each(OrderInfo.boProdAns,function(){if(this.memberRoleCd==ax){ay=this.accessNumber;return false}});if(ay==undefined||ay==""){ay=OrderInfo.boProdAns[0].accessNumber}return ay};var w=function(ay){var ax="";if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){if(OrderInfo.offer.offerMemberInfos!=undefined){$.each(OrderInfo.offer.offerMemberInfos,function(az){if(this.objInstId==ay){ax=this.roleName;return false}})}}else{if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(aA){var az=this.offerRoleName;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==ay){ax=az;return false}})}})}}return ax};var ad=function(ay){var ax={};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(az){if(this.objInstId==ay){ax=this;ax.accNbr=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==3){ax=order.prodModify.choosedProdInfo}else{$.each(OrderInfo.offerSpec.offerRoles,function(az){if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==ay){ax=this;return false}})}})}}return ax};var J=function(ay){var ax=CONST.PROD_SPEC.CDMA;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==ay){ax=this.objId;return false}})})}else{if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(az){if(this.objInstId==ay){ax=this.objId;return false}})}else{if(ay!=undefined&&ay>0){ax=order.prodModify.choosedProdInfo.productId}}}return ax};var g=function(ax){if(OrderInfo.privilege.effTime==""){var ay={manageCode:ax};return query.offer.checkOperate(ay)}};return{getChannelList:r,channelList:ai,salesCode:Z,terminalCode:ao,mktResInstCode:B,checkUimData:am,getCheckUimData:ak,clearCheckUimData:Q,order:aa,SEQ:t,resetSeq:f,resetData:N,orderResult:G,cust:ac,staff:a,offerSpec:U,offer:A,attach2Coupons:c,boCustInfos:ar,boCustIdentities:D,boPartyContactInfo:K,boCustProfiles:aw,boCusts:L,boProdItems:I,boProdPasswords:an,boProdAns:Y,boProd2Tds:X,bo2Coupons:b,boProd2OldTds:av,clearProdUim:V,orderData:p,getOrderData:o,actionClassCd:u,boActionTypeCd:e,actionFlag:y,actionTypeName:O,initData:ae,getOfferBusiOrder:au,getProdBusiOrder:H,createCust:ap,createAcct:d,getProdAn:R,getProdTd:P,getProdUim:C,getProdOldUim:af,getProdAreaId:z,getProdCoupon:aq,getProdInst:ad,getAccessNumber:n,getAreaCode:j,getAreaId:aj,getOfferRoleName:w,getAccNbrByRoleCd:E,getProdSpecId:J,getPrivilege:g,initProdCoupon:M,setProdAn:l,setProdModifyBusiOrder:v,confirmList:S,businessName:x,password_remark:T,privilege:m,offerProdInst:s,orderlonger:h,busitypeflag:at,checkresult:k,custorderlonger:ab,prodAttrs:ag,provinceInfo:q,reloadOrderInfo:al,reloadProdInfo:W,newOrderInfo:F,newOrderNumInfo:i,oldprodAcctInfos:ah}})();CommonUtils.regNamespace("order","prodModify");order.prodModify=(function(){var authFlag="";var _coupon="";var lteFlag=(CONST.getAppDesc()==0)?true:false;var _ischooseOffer=false;var _choosedProdInfo={};var _profiles=[];var _profileTabLists=[];var _getChooseProdInfo=function(){var prodInfoTr=$("#prodNumberInfo").find("li.userorderlistlibg").find("dl:eq(0)");var prodInfoChildTr=$("#prodNumberInfo").find("div.multidiv").find("li:eq(0)");_choosedProdInfo={accNbr:prodInfoTr.attr("accNbr"),productName:prodInfoTr.attr("productName"),prodStateName:prodInfoTr.attr("prodStateName"),feeTypeName:prodInfoTr.attr("feeTypeName"),prodInstId:prodInfoTr.attr("prodInstId"),extProdInstId:prodInfoTr.attr("extProdInstId"),corProdInstId:prodInfoTr.attr("corProdInstId"),prodStateCd:prodInfoTr.attr("prodStateCd"),productId:prodInfoTr.attr("productId"),feeType:prodInfoTr.attr("feeType"),prodClass:$(prodInfoTr).attr("prodClass"),stopRecordCd:prodInfoTr.attr("stopRecordCd"),stopRecordName:prodInfoTr.attr("stopRecordName"),prodOfferName:prodInfoChildTr.attr("prodOfferName"),custName:prodInfoChildTr.attr("custName"),startDt:prodInfoChildTr.attr("startDt"),endDt:prodInfoChildTr.attr("endDt"),prodOfferId:prodInfoChildTr.attr("prodOfferId"),prodOfferInstId:prodInfoChildTr.attr("prodOfferInstId"),custId:prodInfoChildTr.attr("custId"),is3G:prodInfoChildTr.attr("is3G"),areaCode:prodInfoTr.attr("zoneNumber"),areaId:prodInfoTr.attr("areaId")};
order.prodModify.choosedProdInfo=_choosedProdInfo};var _getCallRuleParam=function(boActionTypeCd,prodId){return{areaId:OrderInfo.staff.areaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,custFlag:OrderInfo.cust.custFlag,boInfos:[{boActionTypeCd:boActionTypeCd,instId:prodId,specId:CONST.PROD_SPEC.CDMA,prodId:prodId}]}};var _updateCheckByChange=function(actionClassCd,boActionTypeCd,prodStatusCd,toprodStatusCd){var data={orderList:{orderListInfo:{isTemplateOrder:"N",templateType:"1",staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,areaId:OrderInfo.staff.areaId,partyId:_choosedProdInfo.custId,olTypeCd:CONST.OL_TYPE_CD.UI_LTE},custOrderList:[{busiOrder:[]}]}};data.orderList.custOrderList[0].busiOrder=[{areaId:OrderInfo.staff.areaId,boActionType:{actionClassCd:actionClassCd,boActionTypeCd:boActionTypeCd},busiObj:{accessNumber:_choosedProdInfo.accNbr,instId:_choosedProdInfo.prodInstId,isComp:"N",objId:CONST.PROD_SPEC.CDMA,offerTypeCd:"1"},busiOrderInfo:{seq:OrderInfo.SEQ.seq},data:{boProdStatuses:[{atomActionId:OrderInfo.SEQ.atomActionSeq--,prodStatusCd:prodStatusCd,state:"DEL"},{atomActionId:OrderInfo.SEQ.atomActionSeq--,prodStatusCd:toprodStatusCd,state:"ADD"}]}}];params=JSON.stringify(data);var url=contextPath+"/order/prodModify/updateCheckByChange";var response=$.callServiceAsJson(url,params,{});var msg="";if(response.code==0){return true}else{if(response.code==-2){$.alertM(response.data);return false}else{msg=response.data;$.alert("提示","预校验失败!失败原因为："+msg);return false}}};var _remark_prodPass=function(){var params={tableName:"SYSTEM",columnName:"REMARK_PRODPASS"};var url=contextPath+"/order/prodModify/queryProdPwdConfig";if(OrderInfo.password_remark==""){var response=$.callServiceAsJson(url,params,{});var msg="";if(response.code==0){OrderInfo.password_remark=response.data}else{if(response.code==-2){$.alertM(response.data);OrderInfo.password_remark="0";return false}else{OrderInfo.password_remark="0";return false}}}};var _showChangeCard=function(){OrderInfo.busitypeflag=13;prod.changeUim.init()};var _showAddComp=function(){var compspecparam={productId:_choosedProdInfo.productId};if(getCompInfo(compspecparam)==""){return}var param={areaId:OrderInfo.staff.areaId,custId:OrderInfo.cust.custId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,boInfos:[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP,instId:_choosedProdInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA}]};var callParam={prodInstId:_choosedProdInfo.prodInstId,productId:_choosedProdInfo.productId};var checkRule=rule.rule.prepare(param,"order.prodModify.addComp",callParam)};var _showRemoveComp=function(){var compspecparam={productId:_choosedProdInfo.productId};if(getCompInfo(compspecparam)==""){return}var param={areaId:OrderInfo.staff.areaId,custId:OrderInfo.cust.custId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,boInfos:[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP,instId:_choosedProdInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA}]};var callParam={prodInstId:_choosedProdInfo.prodInstId,productId:_choosedProdInfo.productId};var checkRule=rule.rule.prepare(param,"order.prodModify.removeComp",callParam)};var _queryOfferSpec=function(){var offerSpecId=_choosedProdInfo.prodOfferId;var offerId=_choosedProdInfo.prodOfferInstId;_offerProd.offerId=offerId;_offerProd.offerSpecId=offerSpecId;if(offerSpecId==undefined||offerSpecId==""){return{}}else{var param={offerSpecId:offerSpecId};var response=$.callServiceAsJson(contextPath+"/order/queryOfferSpec",param);if(response.code==0){if(response.data){_offerSpec=response.data.offerSpec}}}return _offerSpec};var _showLossRepProd=function(){OrderInfo.busitypeflag=5;var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.LOSSREP_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showLossRepProdReg=function(){OrderInfo.busitypeflag=5;var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISLOSSREP_PROD;var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showStopKeepNumProd=function(){OrderInfo.busitypeflag=6;var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.STOPKEEPNUM;inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showStopKeepNumProdReg=function(){OrderInfo.busitypeflag=6;var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISSTOPKEEPNUM;inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showCustInfoModify=function(){if("-1"==OrderInfo.cust.custId){$("#div_cust_create").popup("open");$("#cCustName").val(OrderInfo.boCustInfos.name);$("#cCustIdCard").val(OrderInfo.boCustIdentities.identityNum);$("#partyTypeCd option[value='"+OrderInfo.boCustInfos.partyTypeCd+"']").attr("selected",true);$("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']").attr("selected",true);$("#cAddressStr").val(OrderInfo.boCustInfos.addressStr);order.cust.mgr.identidiesTypeCdChoose($("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']"),"ccCustIdCard");tabProfileFlag="1";$("#contactAddress").val(OrderInfo.boPartyContactInfo.contactAddress);$("#contactDesc").val(OrderInfo.boPartyContactInfo.contactDesc);
$("#contactEmployer").val(OrderInfo.boPartyContactInfo.contactEmployer);$("#contactGender option[value='"+OrderInfo.boPartyContactInfo.contactGender+"']").attr("selected",true);$("#contactName").val(OrderInfo.boPartyContactInfo.contactName);$("#contactType option[value='"+OrderInfo.boPartyContactInfo.contactType+"']").attr("selected",true);$("#eMail").val(OrderInfo.boPartyContactInfo.eMail);$("#fax").val(OrderInfo.boPartyContactInfo.fax);$("#headFlag option[value='"+OrderInfo.boPartyContactInfo.headFlag+"']").attr("selected",true);$("#homePhone").val(OrderInfo.boPartyContactInfo.homePhone);$("#mobilePhone").val(OrderInfo.boPartyContactInfo.mobilePhone);$("#officePhone").val(OrderInfo.boPartyContactInfo.officePhone);$("#postAddress").val(OrderInfo.boPartyContactInfo.postAddress);$("#postcode").val(OrderInfo.boPartyContactInfo.postcode)}else{var submitState="";var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.CUSTINFOMODIFY;submitState="ADD";var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:"",prodOfferName:"",state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,4,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.custInfoModify",callParam);if(checkRule){return}}};var _showActiveReturn=function(){OrderInfo.busitypeflag=12;var submitState="";var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACTIVERETURN;submitState="ADD";var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:"",prodOfferName:"",state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,9,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.custInfoModify",callParam);if(checkRule){return}};var _showAcctInfoModify=function(){var submitState="";var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACCTINFOMODIFY;submitState="ADD";var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:"",prodOfferName:"",state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.ACCT_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.acctInfoModify",callParam);if(checkRule){return}};var _form_custInfomodify_btn=function(){$("#custModifyForm").off("formIsValid").on("formIsValid",function(event){var modifyCustInfo={};modifyCustInfo={custName:$.trim($("#cmCustName").val()),identidiesTypeCd:$("#div_cm_identidiesType  option:selected").val(),custIdCard:$.trim($("#cmCustIdCard").val()),addressStr:$.trim($("#cmAddressStr").val())};var data={};data.boCustInfos=[{areaId:OrderInfo.cust.areaId,name:$("#boCustIdentities").attr("partyName"),norTaxPayerId:"0",partyTypeCd:$("#boCustIdentities").attr("partyTypeCd"),addressStr:$("#boCustIdentities").attr("addressStr"),state:"DEL"},{areaId:OrderInfo.cust.areaId,name:modifyCustInfo.custName,norTaxPayerId:"0",partyTypeCd:$("#cmPartyTypeCd  option:selected").val(),addressStr:modifyCustInfo.addressStr,state:"ADD"}];if(OrderInfo.cust.idCardNumber==""||OrderInfo.cust.idCardNumber==null){data.boCustIdentities=[{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD"}]}else{data.boCustIdentities=[{identidiesTypeCd:OrderInfo.cust.identityCd,identityNum:OrderInfo.cust.idCardNumber,isDefault:"Y",state:"DEL"},{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD"}]}data.boCustProfiles=[];for(var i=0;i<order.prodModify.profiles.length;i++){var profilesObj=order.prodModify.profiles[i];var profilesDel={};var profilesAdd={};profilesDel={partyProfileCatgCd:profilesObj.attrId,profileValue:profilesObj.defaultValue,state:"DEL"};profilesAdd={partyProfileCatgCd:profilesObj.attrId,profileValue:$.trim($("#profiles_"+profilesObj.attrId).val()),state:"ADD"};if(document.getElementById("profiles_"+profilesObj.attrId)&&profilesObj.profileValue!=$.trim($("#profiles_"+profilesObj.attrId).val())){data.boCustProfiles.push(profilesDel);data.boCustProfiles.push(profilesAdd)}}data.boPartyContactInfo=[];var _boPartyContactInfoOld={contactId:$("#modTabProfile0").attr("contactId"),statusCd:"100001",contactName:$("#modTabProfile0").attr("contactName"),headFlag:$("#modTabProfile0").attr("headFlag"),state:"DEL"};var _boPartyContactInfo={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$.trim($("#headFlag  option:selected").val()),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postCode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};if($("#modTabProfile0").attr("click")=="0"){if(_boPartyContactInfoOld.contactId!=""){data.boPartyContactInfo.push(_boPartyContactInfoOld);data.boPartyContactInfo.push(_boPartyContactInfo)}else{data.boPartyContactInfo.push(_boPartyContactInfo)}}SoOrder.submitOrder(data)}).ketchup({bindElement:"custInfoModifyBtn"})};var _partyTypeCdChoose=function(scope){var partyTypeCd=$(scope).val();$("#cm_identidiesTypeCd").empty();_certTypeByPartyType(partyTypeCd);_identidiesTypeCdChoose($("#div_cm_identidiesType").children(":first-child"))};var _partyType=function(partyTypeCd){if(partyTypeCd==1){var identidiesTypeCdHtml='<select id="cmIdentidiesTypeCd" onchange="order.prodModify.identidiesTypeCdChoose(this)"><option value="1" >身份证</option><option value="2">军官证</option></select>'}else{if(partyTypeCd==2){var identidiesTypeCdHtml='<select id="cmIdentidiesTypeCd" onchange="order.prodModify.identidiesTypeCdChoose(this)"><option value="3">护照</option><option value="23">ICP经营许可证</option><option value="39">税务登记号</option></select>'}}$("#div_cm_identidiesType").html(identidiesTypeCdHtml)};var _certTypeByPartyType=function(_partyTypeCd){var params={partyTypeCd:_partyTypeCd};var url=contextPath+"/cust/queryCertType";var response=$.callServiceAsJson(url,params,{});if(response.code==-2){$.alertM(response.data)}if(response.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(response.code==0){var data=response.data;if(data!=undefined&&data.length>0){for(var i=0;i<data.length;i++){var certTypedate=data[i];$("#cm_identidiesTypeCd").append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>")}}}};var _identidiesTypeCdChoose=function(scope){var identidiesTypeCd=$(scope).val();if(identidiesTypeCd==undefined){identidiesTypeCd=$("#div_cm_identidiesType  option:selected").val()}if(identidiesTypeCd==1){$("#cmCustIdCard").attr("placeHolder","请输入合法身份证号码");$("#cmCustIdCard").attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(identidiesTypeCd==2){$("#cmCustIdCard").attr("placeHolder","请输入合法军官证");$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(identidiesTypeCd==3){$("#cmCustIdCard").attr("placeHolder","请输入合法护照");$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#cmCustIdCard").attr("placeHolder","请输入合法证件号码");$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}_form_custInfomodify_btn()};var _custInfoModify=function(callParam){var param={};param.partyName=OrderInfo.cust.partyName;param.custId=OrderInfo.cust.custId;param.idCardNumber=OrderInfo.cust.idCardNumber;
param.boActionTypeName=callParam.boActionTypeName;$.callServiceAsHtml(contextPath+"/order/prodModify/custInfoModify",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(response){if(response.code==-2){$.alertM(response.data);return}if(response.data.indexOf("false")>=0){$.alert("提示","抱歉，查询无返回客户详情信息。");return}var content$=$("#order_fill_content");content$.html(response.data).show();_partyTypeCdChoose($("#cmPartyTypeCd  option:selected"));$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected",true);_identidiesTypeCdChoose($("#cm_identidiesTypeCd option[selected='selected']"));$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();$("#step1").show();$(".ordercon a:first span").text("取 消");_form_custInfomodify_btn()},always:function(){$.unecOverlay()}})};var _lossRepProd=function(callParam){param=_choosedProdInfo;$.extend(param,callParam);$.callServiceAsHtml(contextPath+"/order/prodModify/lossRepProd",param,{before:function(){},done:function(response){var content$=$("#order_prepare");content$.html(response.data).show();$(".ordercon").show();$(".ordertabcon").show();$("#step1").show();$("#custInfo").hide();$(".ordercon a:first span").text("取 消")},always:function(){$.unecOverlay()}});SoOrder.builder(CONST.ACTION_CLASS_CD.PROD_ACTION,param.boActionTypeCd)};var _lossRepProdSubmit=function(param){var data={};data.orderRemark=$.trim($("#order_remark").val());data.boProdStatuses=[{prodStatusCd:8,state:submitState}];SoOrder.submitOrder(data)};var _closeDialog=function(){if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){order.prodModify.dialogForm.close(order.prodModify.dialog)}};var _removeCommit=function(prodStatusCd,boActionType,templateType){var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=prodStatusCd;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:boActionType,boActionTypeName:CONST.getBoActionTypeName(boActionType),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD"};OrderInfo.order.templateType=templateType;var v_actionFlag=0;if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){v_actionFlag=19}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _showMemberWin=function(){_ischooseOffer=false;var viceCount=0;var offerMemberInfos=OrderInfo.offer.offerMemberInfos;$.each($("#delPhoneNumber ul:last li"),function(i,li){$(this).remove()});$.each(offerMemberInfos,function(i,offerMember){if(offerMember.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD&&_choosedProdInfo.accNbr==offerMember.accessNumber){viceCount=0;return false}if(offerMember.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&offerMember.objType==CONST.OBJ_TYPE.PROD){$("#delPhoneNumber ul:first h5").text(offerMember.roleName);$("#delPhoneNumber ul:first li").text(offerMember.accessNumber)}else{if(offerMember.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD&&offerMember.objType==CONST.OBJ_TYPE.PROD){if(offerMember.accessNumber){$("#delPhoneNumber ul:last h5").text(offerMember.roleName);var li=$("<li class='full'>").text(offerMember.accessNumber).appendTo($("#delPhoneNumber ul:last"));var objId=offerMember.objId;var objInstId=offerMember.objInstId;var objType=offerMember.objType;var offerMemberId=offerMember.offerMemberId;var offerRoleId=offerMember.offerRoleId;var accessNumber=offerMember.accessNumber;li.attr("del","Y").attr("accessNumber",accessNumber).attr("objId",objId).attr("objInstId",objInstId).attr("objType",objType).attr("offerMemberId",offerMemberId).attr("offerRoleId",offerRoleId);$("<span  id='viceCard_"+offerMember.accessNumber+"'></span>").appendTo(li);var eleI=$("<i id='plan_no'><a id='' class='purchase' href='javascript:void(0)'>保留>>选择新套餐</a></i>").appendTo(li);eleI.click(function(){order.service.offerDialog("viceCard_"+offerMember.accessNumber)})}}}viceCount++});if(viceCount>1){return true}else{return false}};var _chooseOfferForMember=function(specId,subpage,specName,offerRoleId){$("#"+subpage).html("&nbsp;&nbsp;<span style='color: #327501;'>订购新套餐：</span>"+specName);$("#li_"+subpage).attr("addSpecId",specId).attr("addRoleId",offerRoleId).attr("del","N").attr("addSpecName",specName);_ischooseOffer=true;if(document.getElementById("li_"+subpage)){$("#label_"+subpage).attr({style:"height:53px;line-height:53px;padding-left:18px;text-decoration:''"});$("#li_"+subpage).attr("del","N").attr("knew","Y");document.getElementById("button_"+subpage).innerHTML="拆副卡"}};var _removeAndAdd=function(prodStatusCd,boActionType,templateType){var viceparam=[];$.each($("#delPhoneNumber ul:last li"),function(i,li){viceparam.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerRoleId:$(this).attr("addRoleId"),offerSpecId:$(this).attr("addSpecId"),offerMemberId:$(this).attr("offerMemberId"),accessNumber:$(this).attr("accessNumber"),del:$(this).attr("del")})});var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=prodStatusCd;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);var submitFlag=(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK?"buyBack":"removeAndRetainVice");var callParam={boActionTypeCd:boActionType,boActionTypeName:CONST.getBoActionTypeName(boActionType),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD",submitFlag:submitFlag,viceParam:viceparam};OrderInfo.order.templateType=templateType;var v_actionFlag=0;if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){v_actionFlag=20}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _commonShowDialog=function(){$("#delPhoneNumber .btna_o:last").click(function(){_closeDialog()});ec.form.dialog.createDialog({id:"-delephone",width:480,height:400,initCallBack:function(dialogForm,dialog){order.prodModify.dialogForm=dialogForm;order.prodModify.dialog=dialog},submitCallBack:function(dialogForm,dialog){}})};var _showOweRemoveProd=function(){OrderInfo.busitypeflag=11;var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8)}};var _showRemoveProd=function(){OrderInfo.busitypeflag=8;var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.REMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.REMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1)}};var _showOrderRemoveProd=function(){OrderInfo.busitypeflag=7;
var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.PREMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1)}};var _showCoverOrderRemoveProd=function(){OrderInfo.busitypeflag=0;var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD"};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),"");var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _showBreakRuleRemoveProd=function(){OrderInfo.busitypeflag=9;var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1)}};var _showNoActiveRemoveProd=function(){OrderInfo.busitypeflag=10;var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD;var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD"};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),"");var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _commonPrepare=function(param){$.callServiceAsHtml(contextPath+"/order/prodModifyCommon",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#ordercon").show();$("#ordertabcon").show();order.prepare.step(1);OrderInfo.order.step=1;$("#orderedprod").hide();$("#order_prepare").hide();$(".ordercon a:first span").text("取 消");$(".main_body").css("height","150px");$(".main_body").css("min-height","150px");$("#order_confirm").empty();$("#fillLastStep").click(function(){order.prodModify.cancel()});if(lteFlag){_remark_prodPass();if(OrderInfo.password_remark!=null){if((OrderInfo.password_remark).indexOf("'"+OrderInfo.boActionTypeCd+"'")>=0){$("#orderPassRemarkDiv").show()}}}$("#fillNextStep").unbind("click").bind("click",function(){if(param.submitFlag=="removeAndRetainVice"){_commitRetainVice(param)}else{if(param.submitFlag=="buyBack"){_commitBuyBack(param)}else{if(param.submitFlag=="removeProd"){order.memberChange.removeAndAdd(param)}else{_commonSubmit(param.boActionTypeCd,param.prodStatusCd,param.toprodStatusCd,param.itemSpecId,param.state)}}}OrderInfo.order.step=2});$("#templateOrderDiv").hide();if(param.boActionTypeCd==CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD){$("#templateOrderDiv").show()}},always:function(){$.unecOverlay()}})};var _commitRetainVice=function(param){OrderInfo.actionFlag=7;SoOrder.submitOrder(param.viceParam)};var _commitBuyBack=function(param){OrderInfo.actionFlag=20;var params={viceParam:param.viceParam,remark:$("#order_remark").val()};SoOrder.submitOrder(params)};var _commonSubmit=function(boActionTypeCd,prodStatusCd,toprodStatusCd,itemSpecId,state){if(lteFlag){if((OrderInfo.password_remark).indexOf("'"+OrderInfo.boActionTypeCd+"'")>=0){if(!_prodPassRemark()){return}}}OrderInfo.actionClassCd=CONST.ACTION_CLASS_CD.PROD_ACTION;OrderInfo.boActionTypeCd=boActionTypeCd;if(_isNullParam(prodStatusCd)){prodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}if(_isNullParam(toprodStatusCd)){toprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD}var data={};if(!_isNullParam(prodStatusCd)){data.boProdStatuses=[{prodStatusCd:prodStatusCd,state:"DEL"},{prodStatusCd:toprodStatusCd,state:"ADD"}]}if(!_isNullParam(itemSpecId)){data.busiOrderAttrs=[{itemSpecId:itemSpecId,value:$.trim($("textarea[id^=order_remark]").val())}]}SoOrder.submitOrder(data)};var _prodPassRemark=function(){var param={};param.prodPwd=$.trim($("#remark_password").val());if(param.prodPwd==""){$.alert("提示","抱歉，您输入的密码不能为空，请重新输入!");return false}param.accessNumber=order.prodModify.choosedProdInfo.accNbr;param.areaId=order.prodModify.choosedProdInfo.areaId;var url=contextPath+"/order/prodModify/prodAuth";var response=$.callServiceAsJson(url,param,{before:function(){$.ecOverlay("<strong>产品密码鉴权中,请稍等...</strong>")}});if(response.code!=0||response.data!="true"){$.unecOverlay();$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return false}$.unecOverlay();return true};function _gotoOrderModify(response){var content$=$("#order_fill_content");content$.html(response.data).show();$(".main_div .h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$("#ordercon").show();$("#ordertabcon").show();order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide();$(".ordercon a:first span").text("取 消");$(".main_body").css("height","150px");$(".main_body").css("min-height","150px");$("#order_confirm").empty();$("#fillLastStep").click(function(){order.prodModify.cancel()})}var _spec_parm_change=function(){OrderInfo.busitypeflag=4;OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PARMS,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};var checkRule=rule.rule.prepare(param,"order.prodModify.spec_parm_show",callParam)};var _spec_parm_show=function(){var param={prodInstId:_choosedProdInfo.prodInstId,offerSpecId:_choosedProdInfo.prodOfferId,prodSpecId:_choosedProdInfo.productId,partyId:OrderInfo.cust.custId,acctNbr:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};$.callServiceAsHtmlGet(contextPath+"/order/orderSpecParamChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(response&&response.code==-2){return}if(response&&response.data){if(response.data==0||response.data==1){$.alert("提示","该产品无产品实例属性！")
}else{if(response.data==-1){$.alert("提示","产品实例属性加载异常！")}else{_gotoOrderModify(response)}}}else{$.alert("提示","产品实例属性加载异常")}}})};var _showPasswordChange=function(){OrderInfo.busitypeflag=17;OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};OrderInfo.actionFlag=31;var checkRule=rule.rule.prepare(param,"order.prodModify.spec_password_change",callParam)};var _spec_password_change=function(){var param={accNbr:_choosedProdInfo.accNbr};$.callServiceAsHtmlGet(contextPath+"/order/orderPasswordChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){_gotoOrderModify(response);$("#password_form").bind("formIsValid",_spec_password_change_check).ketchup({bindElement:"btsubmit"})}})};function _spec_password_change_check(){if("none"!=$("#li_password_old").css("display")){if(!$("#password_old").val()){$.alert("操作提示","请输入 原产品密码");return}}if(!$("#password_change1").val()){$.alert("操作提示","请输入 产品密码");return}else{if(!$("#password_change2").val()){$.alert("操作提示","请输入 确认密码");return}else{if($("#password_change1").val()!=$("#password_change2").val()){$.alert("操作提示","两次密码不一致");return}}}var reg=new RegExp("^([0-9]{6})$");if(!reg.test($("#password_change1").val())){$.alert("提示","密码包含非数字或长度不是6位！");return}var param={password_old:$("#password_old").val(),accessNumber:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};$.callServiceAsHtml(contextPath+"/order/orderPasswordCheck",param,{before:function(){$.ecOverlay("<strong>正在提交中,请稍等...</strong>")},done:function(response){if(response&&response.code==-2){return}var data=eval("("+response.data+")");if(data.successed==true||data.successed=="true"){_spec_password_change_save()}else{$.alert("密码校验失败",data.data);$.unecOverlay();return}}})}function _spec_password_change_save(){var boProdPasswords=new Array();var boProdPasswords_del={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:$("#password_old").val(),state:"DEL"};var boProdPasswords_add={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:$("#password_change1").val(),state:"ADD"};boProdPasswords.push(boProdPasswords_del);boProdPasswords.push(boProdPasswords_add);var data={boProdPasswords:boProdPasswords};OrderInfo.actionFlag=31;SoOrder.submitOrder(data)}var _showPasswordReset=function(){OrderInfo.busitypeflag=0;OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};OrderInfo.actionFlag=32;var checkRule=rule.rule.prepare(param,"order.prodModify.spec_password_reset",callParam)};var _spec_password_reset=function(){$.callServiceAsHtmlGet(contextPath+"/order/orderPasswordReset",null,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){_gotoOrderModify(response);$("#password_form").bind("formIsValid",_spec_password_reset_save).ketchup({bindElement:"btsubmit"})}})};function _spec_password_reset_save(){var boProdPasswords=new Array();var boProdPasswords_del={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:"",state:"DEL"};var boProdPasswords_add={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:"111111",state:"ADD"};boProdPasswords.push(boProdPasswords_del);boProdPasswords.push(boProdPasswords_add);var data={boProdPasswords:boProdPasswords};OrderInfo.actionFlag=32;SoOrder.submitOrder(data)}function _shortnum_change(){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PARMS,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};OrderInfo.actionFlag=34;var checkRule=rule.rule.prepare(param,"order.prodModify.shortnum_show",callParam)}function _shortnum_show(id){var param={prodId:_choosedProdInfo.prodInstId,acctNbr:_choosedProdInfo.accNbr};$.callServiceAsHtmlGet(contextPath+"/order/orderShortnumChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(response&&response.code==-2){return}if(response&&response.data){if(response.data==0){$.alert("提示","该产品无短号信息！")}else{if(response.data==-1){$.alert("提示","加载短号信息异常！")}else{_gotoOrderModify(response)}}}else{$.alert("提示","短号加载异常")}}})}function _shortnum_change_val(obj){if($(obj).attr("checkSta")=="2"&&$(obj).val()!=$(obj).attr("changeval")){$(obj).attr("checkSta","0")}}function _shortnum_check(){var shortnum_sel=$("#shortnum_sel").val();var id=$("#ul_"+shortnum_sel).attr("t_id");var shortnum_val=$("#"+id).val();var reg=new RegExp("^[0-9]*$");if(null==shortnum_val||""==shortnum_val){$.alert("提示","请输入新的短号");return}else{if(shortnum_val==$("#"+id).attr("oldval")){$.alert("提示","短号未修改，请修改后再校验");return}else{if(!reg.test(shortnum_val)){$.alert("提示","短号只能为数字，请重新输入！");return}else{if(shortnum_val==$("#"+id).attr("changeval")){if($("#"+id).attr("checkSta")=="2"){$.alert("提示","短号已校验成功，可以使用！");return}else{if($("#"+id).attr("checkSta")=="1"){$.alert("提示","短号未通过校验，请修改再试！");return}}}}}}var param={groupNbr:$("#"+id).attr("groupNbr"),extProdId:$("#"+id).attr("extProdId"),productNbr:"",accNbr:_choosedProdInfo.accNbr,extPordInstId:$("#"+id).attr("extPordInstId"),groupShortNbr:shortnum_val,lanId:$("#"+id).attr("lanId"),checkNbr:$("#"+id).attr("changeval")};var url=contextPath+"/order/checkReleaseShortNum";$.callServiceAsJson(url,param,{before:function(){$.ecOverlay("<strong>短号校验中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(response){$("#"+id).attr("changeval",shortnum_val);if(response.code==0){$("#"+id).attr("checkSta","2");$("#uimCheck").removeClass().addClass("order_check");$.alert("提示",response.data);return}else{$("#"+id).attr("checkSta","1");$.alert("提示",response.data);$("#uimCheck").removeClass().addClass("order_check_error");return}},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！");return}})}function _shortnum_save(){var shortnum_sel=$("#shortnum_sel").val();var id=$("#ul_"+shortnum_sel).attr("t_id");var shortnum_val=$("#"+id).val();if(shortnum_val==$("#"+id).attr("oldval")){$.alert("提示","短号未修改，请修改并校验");return}else{if($("#"+id).attr("checkSta")=="0"){$.alert("提示","短号未校验，请校验后再提交！");return}else{if($("#"+id).attr("checkSta")=="1"){$.alert("提示","短号未通过校验，请修改再试！");return}}}var boProdCompItems=new Array();var boProdCompItems_row={itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"DEL",value:$("#"+id).attr("oldval")};boProdCompItems.push(boProdCompItems_row);boProdCompItems_row={itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"ADD",value:$("#"+id).val()};boProdCompItems.push(boProdCompItems_row);var boProdCompOrders_row={prodCompRelaRoleCd:$("#"+id).attr("prodCompRelaRoleCd"),compProdId:$("#"+id).attr("compProdId"),prodCompId:$("#"+id).attr("prodCompId")};var boProdCompOrders=new Array();boProdCompOrders.push(boProdCompOrders_row);var data={boProdCompItems:boProdCompItems,boProdCompOrders:boProdCompOrders};
OrderInfo.actionFlag=34;SoOrder.submitOrder(data)}var _isNullParam=function(data){return data==undefined||!data};var _changeCard=function(param){$.callServiceAsHtml(contextPath+"/order/changeCard",param,{before:function(){},done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var compspecGrps="";var getCompInfo=function(compspecparam){var grprlue="";var returndata=$.callServiceAsJson(contextPath+"/order/compPspecGrps",compspecparam,{});if(returndata.code==0){if(returndata.data.length!=0){grprlue=returndata.data;compspecGrps=grprlue}return grprlue}else{if(returndata.code==-2){$.alertM(returndata.data);return""}else{$.alert("提示","该产品不是组合产品，请重新选择！");return""}}};var _addComp=function(param){OrderInfo.initData("","",12,"纳入成员");SoOrder.builder();var compparam={};$.callServiceAsHtml(contextPath+"/order/addComp",compparam,{done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();order.prepare.step(1);$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var _removeComp=function(param){OrderInfo.initData("","",12,"退出成员");SoOrder.builder();var compparam={};$.callServiceAsHtml(contextPath+"/order/removeComp",compparam,{done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$(".ordercon").show();$(".ordertabcon").show();order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var _queryRomveAcc=function(){var prodnum=$.trim($("#removeAcc").val());if(prodnum==""){$.alert("提示","请输入需要查询的接入号！");return}else{var params={compProdId:_choosedProdInfo.prodInstId,accessNumber:prodnum}}var removephones=getChoosedMenbr();if(removephones.length!=0){for(var i=0;i<removephones.length;i++){if(prodnum==removephones[i]){$.alert("提示","该号码已经在待退出成员中，请重新选择！");return}}}var url=contextPath+"/order/queryCompmenber";$.callServiceAsJson(url,params,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(response){if(response.code==0){var compProdMemberInfos=response.data;if(compProdMemberInfos.length>0){var prodmenber=compProdMemberInfos[0];var addnbrhtml="<li id='li_"+prodmenber.accessNumber+"' prodInstId='"+prodmenber.prodId+"' phonenumber='"+prodmenber.accessNumber+"' prodCompRelaRoleCd='"+prodmenber.prodCompRelaRoleCd+"' prodCompRelaRoleName='"+prodmenber.prodCompRelaRoleName+"' prodCompId='"+prodmenber.prodCompId+"'><dd class='delete' onclick='order.prodModify.removeCompDelSelect(this);'></dd><span id='addNbr'>"+prodmenber.accessNumber+"</span>";$("#choosed_menbers").append(addnbrhtml)}else{$.alert("提示","该号不在群组成员中，请重新选择！");return}}else{if(response.code==-2){$.alertM(response.data)}else{$.alert("提示",response.data);return}}},always:function(){$.unecOverlay()},fail:function(response){$.unecOverlay();$.alert("提示","套餐加载失败，请稍后再试！")}})};var _orderAttachOffer=function(){OrderInfo.busitypeflag=14;AttachOffer.init()};var _changeOffer=function(){OrderInfo.busitypeflag=2;offerChange.init()};var _showChangeAccount=function(){OrderInfo.busitypeflag=16;var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};var flag=rule.rule.prepare(param,"order.prodModify.changeAccount",callParam);if(flag){return}};var _changeAccount=function(){if(!_choosedProdInfo.prodInstId||!_choosedProdInfo.accNbr){$.alert("提示","产品信息定位异常，请联系管理员");$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}var param={prodId:_choosedProdInfo.prodInstId,acctNbr:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",param,{before:function(){$.ecOverlay("<strong>正在确认当前产品帐户,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(jr){if(jr.code!=0||jr.data.length==0){if(jr.code==-2){$.alertM(jr.data)}else{$.alert("提示","当前产品帐户定位失败，请联系管理员")}$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}var prodAcctInfos=jr.data;$.callServiceAsHtml(contextPath+"/order/preChangeAccount",prodAcctInfos,{before:function(){$.ecOverlay("<strong>当前产品帐户已确认</strong>")},always:function(){$.unecOverlay()},done:function(response){if(!response){response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(response.code!=0){$.alert("提示","查询失败,请稍后重试");return}$("#order_fill_content").html(response.data).show();$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$("#origAccts option:first").attr("selected","selected");acct.acctModify.getBILL_POST()},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})}})};var _showOrigAccts=function(){easyDialog.open({container:"origAcctDialog"});$("#origAcctClose").click(function(){easyDialog.close()})};var _chooseAcct=function(){$("#chooseQueryAcctType").find("option[value=1]").attr("selected","selected");$("#d_query_nbr").show();easyDialog.open({container:"queryAcctDialog"});$("#chooseQueryAcctType").change(function(){if($("#chooseQueryAcctType").val()==1){$("#d_query_cd").hide();$("#d_query_nbr").show()}else{$("#d_query_nbr").hide();$("#d_query_pwd").hide();$("#d_query_cd").show()}});$("#queryAcctClose").click(function(){$("#acctListTab tbody").empty();$("#d_query_cd").hide();$("#d_query_nbr").hide();easyDialog.close()})};var newAcctList=[];var _queryAccount=function(acctSelect){var response;if($("#chooseQueryAcctType").val()==1){if(!CONST.LTE_PHONE_HEAD.test($.trim($("#d_query_nbr input").val()))){$.alert("提示","请输入有效的中国电信手机号");return}var acctQueryParam={accessNumber:$("#d_query_nbr input").val()};response=order.prodModify.returnAccount(acctQueryParam)}else{var acctQueryParam={acctCd:$("#d_query_cd input").val()};response=order.prodModify.returnAccount(acctQueryParam)}$("#acctListTab tbody").empty();if(response.code==0){var returnMap=response.data;if(returnMap.resultCode==0){if(returnMap.accountInfos&&returnMap.accountInfos.length>0){var accountInfos=returnMap.accountInfos;$.each(accountInfos,function(i,accountInfo){var tr=$("<tr></tr>").appendTo($("#acctListTab tbody"));if(accountInfo.name){$("<td class='teleNum'>"+accountInfo.name+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}if(accountInfo.acctId){$("<td acctId='"+accountInfo.acctId+"'>"+accountInfo.accountNumber+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}if(accountInfo.owner){$("<td>"+accountInfo.owner+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}if(accountInfo.accessNumber){$("<td>"+accountInfo.accessNumber+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}tr.click(function(){var newAccount={acctCd:accountInfo.accountNumber,acctId:accountInfo.acctId,acctRelaTypeCd:"1",chargeItemCd:1,percent:"100",priority:"1",prodAcctId:"-1",state:"ADD"};newAcctList.push(newAccount);$("#acctListTab tbody").empty();$("#d_query_cd").hide();$("#d_query_nbr").hide();$("#d_query_pwd").hide();
$("#defineNewAcct").hide();easyDialog.close();var found=false;$.each($(acctSelect).find("option"),function(i,option){if($(option).val()==accountInfo.acctId){found=true;return false}});if(found==false){$("<option>").text(accountInfo.name+" : "+accountInfo.accountNumber).attr("value",accountInfo.acctId).appendTo($(acctSelect))}$(acctSelect).find("option[value=default]").remove();$(acctSelect).find("option[value="+accountInfo.acctId+"]").attr("selected","selected")})})}else{$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+returnMap.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+response.data+"</td></tr>").appendTo($("#acctListTab tbody"))}};var _returnAccount=function(acctQueryParam){acctQueryParam.areaId=_choosedProdInfo.areaId;acctQueryParam.isServiceOpen="Y";var response=$.callServiceAsJson(contextPath+"/order/account",acctQueryParam);if(response.code==-2){$.alertM(response.data);return}return response};var _createAcct=function(){var newAccount={acctCd:-1,acctId:-1,acctRelaTypeCd:"1",chargeItemCd:1,percent:"100",priority:"1",prodAcctId:"-1",state:"ADD"};newAcctList.push(newAccount);$("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>").appendTo($("#newAccts"));$("#newAccts").find("option[value=default]").remove();$("#newAccts").find("option[value=-1]").attr("selected","selected");$("#acctName").val(OrderInfo.cust.partyName);$("#newAccts").parent().find("a:eq(1)").hide();$("#defineNewAcct").show();acct.acctModify.ifCanAdjustBankPayment();acct.acctModify.paymentType();acct.acctModify.billPostType()};var _ifNewAcct=function(acctSelect){if($(acctSelect).val()<0){if(OrderInfo.actionFlag!=2){$("#defineNewAcct").show()}}else{$("#defineNewAcct").hide()}};var _changeAccountSave=function(){if($("#newAccts").val()=="default"){$.alert("提示","请选择新帐户");return}if($("#newAccts").val()<0){if(!SoOrder.checkAcctInfo()){return}}var repick=false;var origAccts=$("#origAccts").find("option");$.each(origAccts,function(i,origAcct){if($("#newAccts").val()==$(origAcct).val()){repick=true;return false}});if(repick==false){var delAcctId=$("#origAccts").val();var origAcct=$("#origAcctList tbody").find("tr[id="+delAcctId+"]");var _acctCd=$(origAcct).find("td:eq(4)").text();var _acctId=$(origAcct).find("td:eq(0)").text();var _chargeItemCd=$(origAcct).find("td:eq(2)").text();var _percent=$(origAcct).find("td:eq(7)").text();var _priority=$(origAcct).find("td:eq(8)").text();if(_priority==""){_priority=1}var _prodAcctId=$(origAcct).find("td:eq(1)").text();var origAcctInfo={acctCd:_acctCd,acctId:_acctId,acctRelaTypeCd:"1",chargeItemCd:_chargeItemCd,percent:_percent,priority:_priority,prodAcctId:_prodAcctId,state:"DEL"};var newAcctInfo;$.each(newAcctList,function(i,newAccount){if(newAccount.acctId==$("#newAccts").val()){newAcctInfo=newAccount;return false}});var _boAccountRelas=[];_boAccountRelas.push(origAcctInfo);_boAccountRelas.push(newAcctInfo);var _busiOrderAttrs=[];var remark=$("#orderRemark").val();_busiOrderAttrs.push({itemSpecId:"111111118",value:remark});var data={boAccountRelas:_boAccountRelas,busiOrderAttrs:_busiOrderAttrs};if($("#newAccts").val()==-1){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,10,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");var busiOrder=[];OrderInfo.createAcct(busiOrder,-1);var acctChangeNode={areaId:_choosedProdInfo.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:_choosedProdInfo.accNbr,instId:_choosedProdInfo.prodInstId,isComp:"N",objId:_choosedProdInfo.productId,offerTypeCd:"1"},boActionType:{actionClassCd:1300,boActionTypeCd:"-6"},data:data};busiOrder.push(acctChangeNode);SoOrder.submitOrder(busiOrder)}else{OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");SoOrder.submitOrder(data)}}else{$.alert("提示","该帐户已经是付费帐户了，请重新选择");return}};var _cancel=function(){$.confirm("信息","确定取消当前操作吗？",{yes:function(){var boProd2Tds=OrderInfo.boProd2Tds;if(boProd2Tds.length>0){for(var n=0;n<boProd2Tds.length;n++){var param={numType:2,numValue:boProd2Tds[n].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",param)}}var boProdAns=OrderInfo.boProdAns;if(boProdAns.length>0){for(var n=0;n<boProdAns.length;n++){if(boProdAns[n].idFlag){continue}var param={numType:1,numValue:boProdAns[n].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",param)}order.service.boProdAn={};order.phoneNumber.resetBoProdAn()}$("#order_fill_content").empty();OrderInfo.order.step=0;order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show();if(OrderInfo.actionFlag==6){$("#order_tab_panel_content").hide()}},no:function(){}},"question")};var compparam="";var _queryCustProd=function(){var hasmeneber=false;var prodnum=$.trim($("#prodnbr").val());if(prodnum==""){$.alert("提示","请输入需要查询的接入号！");return}else{hasmeneber=isExist(prodnum)}if(hasmeneber.flag){if(hasmeneber.data=="1"){var param={};var prodnum=$.trim($("#prodnbr").val());param.acctNbr=prodnum;var url=contextPath+"/cust/queryprodbynbr"}else{$.alert("提示","该产品已经在组合中，请重新选择！");return}}else{return}$.callServiceAsHtmlGet(url,param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(!response){response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(response.code==-2){return}else{if(response.code!=0){$.alert("提示","客户查询失败,稍后重试");return}}var content$=$("#prodinst");content$.html(response.data)}})};var _compChangeTab=function(num){if(num==1){$("#tab_1").addClass("setcon");$("#tab_2").removeClass("setcon");$("#addCompPage").show();$("#releaseShortNum").hide();$("#compopr").show()}else{$("#tab_2").addClass("setcon");$("#tab_1").removeClass("setcon");$("#addCompPage").hide();$("#releaseShortNum").show();$("#compopr").hide()}};var _addToComp=function(obj){var phonenumber=$(obj).parent().parent().children(":first-child").next().text();var productId=$(obj).parent().parent().children(":last-child").text();var prodInstId=$(obj).parent().parent().children().eq(-2).text();var prodStateCd=$(obj).parent().parent().children().eq(-3).text();var linum=$("#choosed_menbers li").length;if(linum>12){$.alert("提示","已经超过了加入的最大数量！");return}if(prodStateCd!="100000"){$.alert("提示","该产品状态不符，不能纳入成员！");return}var addphones=getChoosedMenbr();if(addphones.length!=0){for(var i=0;i<addphones.length;i++){if(phonenumber==addphones[i]){$.alert("提示","该号码已经在待纳入成员中，请重新选择！");return}}}ec.form.dialog.createDialog({id:"-grps",initCallBack:function(dialogForm,dialog){var compdata=compspecGrps;var compPspecCompGrp2Pspecs=compspecGrps[0].compPspecCompGrp2Pspecs;var compPspecCompGrpRelas=compspecGrps[0].compPspecCompGrpRelas;if(compPspecCompGrpRelas==undefined){compPspecCompGrpRelas=[]}var zNodes=[];var menber=[];for(var i=0;i<compPspecCompGrp2Pspecs.length;i++){var grpspec={name:compPspecCompGrp2Pspecs[i].prodSpecName,prodCompRelaRoleCd:compPspecCompGrp2Pspecs[i].prodCompRelaRoleCd,prodCompRelaRoleName:compPspecCompGrp2Pspecs[i].prodCompRelaRoleName,prodSpecId:compPspecCompGrp2Pspecs[i].prodSpecId};menber.push(grpspec)}var childmenber=[];for(var i=0;i<compPspecCompGrpRelas.length;i++){var compPspecCompGrpRelasSpecs=compPspecCompGrpRelas[i];var childSpec=[];for(var j=0;j<compPspecCompGrpRelasSpecs.length;j++){var grpspec={name:compPspecCompGrpRelasSpecs[j].prodSpecName,prodCompRelaRoleCd:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleCd,prodCompRelaRoleName:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleName,prodSpecId:compPspecCompGrpRelasSpecs[j].prodSpecId};childSpec.push(grpspec)}var childrole={name:compPspecCompGrpRelasSpecs[i].compPspecCompGrpName,children:childSpec};childmenber.push(childrole)}var setting={data:{key:{title:"t"},simpleData:{enable:true}},callback:{onClick:onClick}};
if(compPspecCompGrp2Pspecs.length!=0){var node={name:"成员",open:true,children:menber};zNodes.push(node)}if(compPspecCompGrpRelas.length!=0){var node={name:"子组",children:childmenber};zNodes.push(node)}if(compPspecCompGrp2Pspecs.length==0&&compPspecCompGrpRelas.length==0){$.alert("提示","该产品没有成员规则，请重新选择群组产品！");return}var prodCompRelaRoleCd="";var prodCompRelaRoleName="";function onClick(event,treeId,treeNode,clickFlag){prodCompRelaRoleCd="";prodCompRelaRoleName="";var prodSpecId=treeNode.prodSpecId;if(prodSpecId==productId){prodCompRelaRoleCd=treeNode.prodCompRelaRoleCd;prodCompRelaRoleName=treeNode.prodCompRelaRoleName}else{$.alert("提示","不能加入该角色，请重新选择！")}}$.fn.zTree.init($("#rluename"),setting,zNodes);$("#nextstep").click(function(){if(prodCompRelaRoleCd!=""&&prodCompRelaRoleName!=""){$("#dialogtitle").html("设置短号");var shortnumhtml="短号设置：<input type='text' id='shortnumtext' class='inputWidth183px'/>";$("#rluename").html("").html(shortnumhtml);$("#nextstep").hide();$("#submitbtn2").show()}else{$.alert("提示","请选择所需纳入的成员！");return}});$("#submitbtn2").click(function(){var shortnum=$("#shortnumtext").val();var reg=new RegExp("^[0-9]*$");if(shortnum==""){$("#errinfo").html("对不起，请输入短号！");return}if(!reg.test(shortnum)){$("#errinfo").html("短号只能为数字，请重新输入！");return}var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:phonenumber,extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortnum,statusCd:"1102"};var url=contextPath+"/order/checkGroupShortNum";var res=$.callServiceAsJson(url,param,{});if(res.code==0){var addnbrhtml="<li id='li_"+phonenumber+"' prodInstId='"+prodInstId+"' phonenumber='"+phonenumber+"' prodCompRelaRoleCd='"+prodCompRelaRoleCd+"' prodCompRelaRoleName='"+prodCompRelaRoleName+"' productId='"+productId+"' style='width:280px;'><dd class='delete' onclick='order.prodModify.addCompDelSelect(this);'></dd><span id='addNbr' style='display:inline;padding:0 5px 0 22px;'>"+phonenumber+"</span><span style='display:inline;padding:0px;'>[短号：</span><span style='display:inline;padding:0px;' id='shortNumber'>"+shortnum+"</span><span class='modshortnum' onclick='order.prodModify.changeShortNum(this);' style='display:inline;padding:0 25px 0 20px;'></span><span style='display:inline;padding:0px;'>]</span>";$("#choosed_menbers").append(addnbrhtml);dialogForm.close(dialog)}else{if(res.code==-2){$.alertM(res.data)}else{$.alert("提示",res.data)}}})},submitCallBack:function(dialogForm,dialog){},width:400,height:150})};var getChoosedMenbr=function(){var numbers=[];$("#choosed_menbers li").each(function(){var phonenum=$(this).children("span#addNbr").text();numbers.push(phonenum)});return numbers};var boolHasShortNum=function(){var hasshrot=true;$("#choosed_menbers li").each(function(){var phonenum=$(this).children("span#shortNumber").text();if(phonenum==""){hasshrot=false}});return hasshrot};var _changeShortNum=function(obj){var phonenum=$(obj).parent().children("span#addNbr").text();var shortnum=$(obj).parent().children("span#shortNumber").text();ec.form.dialog.createDialog({id:"-shrotnum",initCallBack:function(dialogForm,dialog){$("#shortnumval").val(shortnum);$("#submitbtn3").click(function(){shortnum=$(obj).parent().children("span#shortNumber").text();var newshortnum=$("#shortnumval").val();if(shortnum==newshortnum){dialogForm.close(dialog)}if(shortnum==""&&newshortnum!=""){var result=getOprShortNumInfo(phonenum,newshortnum,"1102");if(result.code==0){$("#li_"+phonenum).children("span#shortNumber").html(newshortnum)}else{if(result.code==-2){$.alertM(result.data);return}else{$.alert("提示","短号预占失败！");return}}dialogForm.close(dialog)}if(shortnum!=""&&newshortnum==""){$.alert("提示","请输入短号！");return}if(shortnum!=""&&newshortnum!=""){var resultremove=getOprShortNumInfo(phonenum,shortnum,"1000");if(resultremove.code==0){$("#li_"+phonenum).children("span#shortNumber").html("")}else{if(resultremove.code==-2){$.alertM(resultremove.data);return}else{$.alert("提示","短号预占失败！");return}}var resultadd=getOprShortNumInfo(phonenum,newshortnum,"1102");if(resultadd.code==0){$("#li_"+phonenum).children("span#shortNumber").html(newshortnum)}else{if(resultadd.code==-2){$.alertM(resultadd.data);return}else{$.alert("提示","预占失败！");return}}dialogForm.close(dialog)}})},submitCallBack:function(dialogForm,dialog){},width:350,height:100})};var getOprShortNumInfo=function(accNbr,shortNbr,statusCd){var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:accNbr,extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortNbr,statusCd:statusCd};var url=contextPath+"/order/checkGroupShortNum";var res=$.callServiceAsJson(url,param,{});return res};var _releaseShortNum=function(){var shortNbr=$("#resshortnum").val();var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:"",extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortNbr,statusCd:"1000"};var url=contextPath+"/order/checkGroupShortNum";var res=$.callServiceAsJson(url,param,{});if(res.code==0){$.alert("提示","短号释放成功！");$("#choosed_menbers li").each(function(){var shortNum=$(this).children("span#shortNumber").text();if(shortNbr==shortNum){$(this).children("span#shortNumber").html("")}})}else{if(res.code==-2){$.alertM(res.data);return}else{$.alert("提示",res.data)}}};var canAddAnother=function(){var phonelist=$("#choosed_menbers").html();phonelist=phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");if(phonelist!=""){var lastspan=$("#choosed_menbers").children(":last-child").children("span").length;if(lastspan<2){return false}else{return true}}else{return true}};var isExist=function(prodnum){var params={compProdId:_choosedProdInfo.prodInstId,accessNumber:prodnum};var url=contextPath+"/order/queryCompmenber";var returndata={};var isexist=$.callServiceAsJson(url,params,{});if(isexist.code==0){returndata.flag=true;var compProdMemberInfos=isexist.data;if(compProdMemberInfos.length>0){returndata.data="0"}else{returndata.data="1"}return returndata}else{if(isexist.code==-2){$.alertM(returndata.data);returndata.flag=false}else{returndata.flag=false;$.alert("提示",isexist.data);return returndata}}};var _addCompSubmit=function(){var phonelist=$("#choosed_menbers").html();phonelist=phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");if(phonelist==""){$.alert("提示","请选择纳入组合的成员！");return}var boolshort=boolHasShortNum();if(!boolshort){$.alert("提示","待加入成员未全部设置短号，请全部设置好后再提交！");return}var busiOrder=[];var addMenbers=[];var prodCompId=-1;$("#choosed_menbers li").each(function(){var prodInstId=$(this).attr("prodInstId");var phonenumber=$(this).attr("phonenumber");var prodCompRelaRoleCd=$(this).attr("prodCompRelaRoleCd");var prodCompRelaRoleName=$(this).attr("prodCompRelaRoleName");var productId=$(this).attr("productId");var shortnum=$(this).children("span#shortNumber").text();addMenbers.push(phonenumber);var compparam={busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:CONST.PROD_SPEC.CDMA,instId:prodInstId,accessNumber:phonenumber},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP},areaId:OrderInfo.staff.areaId,aggreementId:"",data:{boProdCompOrders:[{prodCompRelaRoleCd:prodCompRelaRoleCd,prodCompRelaRoleName:prodCompRelaRoleName,prodCompId:prodCompId,compProdId:_choosedProdInfo.prodInstId}],boProdCompRelas:[{prodCompId:prodCompId,state:"ADD",atomActionId:OrderInfo.SEQ.atomActionSeq--}],boProdSpecs:[{prodSpecId:productId,atomActionId:OrderInfo.SEQ.atomActionSeq--,state:"KIP"}],boProdCompItems:[{itemSpecId:"37906",name:"",prodCompId:prodCompId,state:"ADD",value:shortnum,atomActionId:OrderInfo.SEQ.atomActionSeq--}],busiOrderAttrs:[{itemSpecId:"111111111",value:$("#orderRemark").val()}]}};busiOrder.push(compparam);prodCompId--});OrderInfo.confirmList=[];var comfimProdInfo={name:_choosedProdInfo.productName,accNbr:[_choosedProdInfo.accNbr]};OrderInfo.confirmList.push(comfimProdInfo);var comfimMeneber={name:"纳入成员",accNbr:addMenbers};OrderInfo.confirmList.push(comfimMeneber);SoOrder.submitOrder(busiOrder)
};var _removeCompSubmit=function(){var t=$("#choosed_menbers").html();t=t.replace(/[\r\n]/g,"").replace(/[ ]/g,"");if(t==""){$.alert("提示","请选择退出组合的成员！");return}var busiOrder=[];var addMenbers=[];$("#choosed_menbers li").each(function(){var prodInstId=$(this).attr("prodInstId");var phonenumber=$(this).attr("phonenumber");var prodCompRelaRoleCd=$(this).attr("prodCompRelaRoleCd");var prodCompRelaRoleName=$(this).attr("prodCompRelaRoleName");var prodCompId=$(this).attr("prodCompId");addMenbers.push(phonenumber);var compparam={busiOrderInfo:{seq:-1},busiObj:{objId:CONST.PROD_SPEC.CDMA,instId:prodInstId,accessNumber:phonenumber},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP},areaId:OrderInfo.staff.areaId,aggreementId:"",data:{boProdCompOrders:[{prodCompRelaRoleCd:prodCompRelaRoleCd,prodCompRelaRoleName:prodCompRelaRoleName,prodCompId:prodCompId,compProdId:_choosedProdInfo.prodInstId}],boProdCompRelas:[{prodCompId:prodCompId,state:"DEL"}],busiOrderAttrs:[{itemSpecId:"111111111",value:$("#orderRemark").val()}]}};busiOrder.push(compparam)});OrderInfo.confirmList=[];var comfimProdInfo={name:_choosedProdInfo.productName,accNbr:[_choosedProdInfo.accNbr]};OrderInfo.confirmList.push(comfimProdInfo);var comfimMeneber={name:"退出成员",accNbr:addMenbers};OrderInfo.confirmList.push(comfimMeneber);SoOrder.submitOrder(busiOrder)};var _removeCompDelSelect=function(obj){$.confirm("确认","确定要取消该号码吗?",{yes:function(){var accNbr=$(obj).next().text();$("#li_"+accNbr).remove()},no:function(){}})};var _addCompDelSelect=function(obj){$.confirm("确认","确定要取消该号码吗?",{yes:function(){var accNbr=$(obj).parent().children("span#addNbr").text();var shortnum=$(obj).parent().children("span#shortNumber").text();if(shortnum!=""){var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:accNbr,extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortnum,statusCd:"1000"};var url=contextPath+"/order/checkGroupShortNum";var response=$.callServiceAsJson(url,param,{});if(response.code==0){$("#li_"+accNbr).remove()}else{if(response.code==-2){$.alertM(response.data)}else{alert("删除失败")}}}else{$("#li_"+accNbr).remove()}},no:function(){}})};var _showBuyBack=function(){OrderInfo.busitypeflag=0;var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.BUY_BACK,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_BACK,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BUY_BACK),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};var checkRule=rule.rule.prepare(param,"order.prodModify.showBuyBackDo",callParam)};var _showBuyBackDo=function(){var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.BUY_BACK;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BUY_BACK)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BUY_BACK,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BUY_BACK,1)}};var _setCoupon=function(coupon){_coupon=coupon};var _btnMoreProfile=function(){if($("#modPartyProfile").is(":hidden")){$("#modPartyProfile").show();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrowup");order.prodModify.changeLabel(0)}else{$("#modPartyProfile").hide();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrow");$("#modTabProfile0").attr("click","1");$("#contactName").attr("data-validate","");_form_custInfomodify_btn()}};var _changeLabel=function(labelId){if($("#partyProfile").is(":visible")==false){$("#partyProfile").show()}if(labelId=="0"){$("#modTabProfile0").show();$("#cardtab_mod_0").addClass("setcon");$("#modTabProfile0").attr("click","0");$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(keyup)");_form_custInfomodify_btn()}else{if(($("#modTabProfile0").attr("click")=="0")&&($("#contactName").val()=="")){$.alert("提示","联系人名称不能为空！","information");return}}for(var i=0;i<order.prodModify.profileTabLists.length;i++){var profileTabLists=order.prodModify.profileTabLists[i];var tabProfileNum=profileTabLists.tabProfileNum;var partyProfileCatgTypeCd=profileTabLists.partyProfileCatgTypeCd;if(labelId==partyProfileCatgTypeCd){$("#"+tabProfileNum).show();$("#cardtab_mod_"+partyProfileCatgTypeCd).addClass("setcon");$("#modTabProfile0").hide();$("#cardtab_mod_0").removeClass("setcon")}else{$("#"+tabProfileNum).hide();$("#cardtab_mod_"+partyProfileCatgTypeCd).removeClass("setcon")}}};var _checkProPSW=function(psw){$("#"+psw).blur()};return{changeCard:_changeCard,getChooseProdInfo:_getChooseProdInfo,lossRepProd:_lossRepProd,lossRepProdSubmit:_lossRepProdSubmit,choosedProdInfo:_choosedProdInfo,showLossRepProd:_showLossRepProd,showLossRepProdReg:_showLossRepProdReg,showStopKeepNumProd:_showStopKeepNumProd,showStopKeepNumProdReg:_showStopKeepNumProdReg,showCustInfoModify:_showCustInfoModify,custInfoModify:_custInfoModify,commonPrepare:_commonPrepare,showOweRemoveProd:_showOweRemoveProd,showRemoveProd:_showRemoveProd,showOrderRemoveProd:_showOrderRemoveProd,showCoverOrderRemoveProd:_showCoverOrderRemoveProd,showBreakRuleRemoveProd:_showBreakRuleRemoveProd,showNoActiveRemoveProd:_showNoActiveRemoveProd,spec_parm_change:_spec_parm_change,showChangeCard:_showChangeCard,spec_password_change:_spec_password_change,spec_password_change_save:_spec_password_change_save,showPasswordChange:_showPasswordChange,spec_password_change_check:_spec_password_change_check,getCallRuleParam:_getCallRuleParam,cancel:_cancel,orderAttachOffer:_orderAttachOffer,changeOffer:_changeOffer,shortnum_change:_shortnum_change,shortnum_show:_shortnum_show,shortnum_save:_shortnum_save,spec_parm_show:_spec_parm_show,showAddComp:_showAddComp,addComp:_addComp,addToComp:_addToComp,compChangeTab:_compChangeTab,queryCustProd:_queryCustProd,addCompSubmit:_addCompSubmit,spec_parm_show:_spec_parm_show,showChangeAccount:_showChangeAccount,changeAccount:_changeAccount,showOrigAccts:_showOrigAccts,chooseAcct:_chooseAcct,queryAccount:_queryAccount,returnAccount:_returnAccount,createAcct:_createAcct,ifNewAcct:_ifNewAcct,changeAccountSave:_changeAccountSave,showRemoveComp:_showRemoveComp,removeComp:_removeComp,profiles:_profiles,profileTabLists:_profileTabLists,partyTypeCdChoose:_partyTypeCdChoose,identidiesTypeCdChoose:_identidiesTypeCdChoose,removeCompSubmit:_removeCompSubmit,showPasswordReset:_showPasswordReset,spec_password_reset:_spec_password_reset,spec_password_reset_save:_spec_password_reset_save,queryRomveAcc:_queryRomveAcc,removeCompDelSelect:_removeCompDelSelect,addCompDelSelect:_addCompDelSelect,chooseOfferForMember:_chooseOfferForMember,shortnum_check:_shortnum_check,shortnum_change_val:_shortnum_change_val,changeShortNum:_changeShortNum,releaseShortNum:_releaseShortNum,showActiveReturn:_showActiveReturn,showBuyBack:_showBuyBack,showBuyBackDo:_showBuyBackDo,setCoupon:_setCoupon,lteFlag:lteFlag,btnMoreProfile:_btnMoreProfile,changeLabel:_changeLabel,remark_prodPass:_remark_prodPass,checkProPSW:_checkProPSW}})();CommonUtils.regNamespace("order","cust");order.cust=(function(){var b=function(h,i){var g=$(h).val();$("#"+i).empty();f(g,i)};var c=function(g,i){var h=$(g).val();if(h==1){$("#"+i).attr("placeHolder","请输入合法身份证号码");$("#"+i).attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(h==2){$("#"+i).attr("placeHolder","请输入合法军官证");$("#"+i).attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(h==3){$("#"+i).attr("placeHolder","请输入合法护照");$("#"+i).attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#"+i).attr("placeHolder","请输入合法证件号码");$("#"+i).attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}d();$("#cCustIdCard").attr("disabled",false);$("#cCustName").attr("disabled",false);
$("#cAddressStr").attr("disabled",false)};var f=function(g,l){var t=$("#"+l);var m={partyTypeCd:g};var h=contextPath+"/cust/queryCertType";var n=$.callServiceAsJson(h,m,{});if(n.code==-2){$.alertM(n.data)}if(n.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(n.code==0){var r=n.data;if(r!=undefined&&r.length>0){var v=[];for(var q=0;q<r.length;q++){var p=true;var k=r[q].certTypeCd;for(var o=0;o<v.length;o++){p=p&&r[q].certTypeCd!=v[o].certTypeCd;if(!p){break}}var s=false;if(OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZQZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.GZZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.HYKHZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.SYKHZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.XYKHZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.GZZXJL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZYOUT||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZYINGT||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.WBT||g!="1"){s=true}if(!s&&k=="1"){s=true}if(p&&s){v.push(r[q])}}for(var q=0;q<v.length;q++){var u=v[q];t.append("<option value='"+u.certTypeCd+"' >"+u.name+"</option>")}t.selectmenu().selectmenu("refresh");if(l=="identidiesTypeCd"){c($("#"+l).children(":first-child"),"cCustIdCard")}}}};var d=function(){$("#custCreateForm").off().bind("formIsValid",function(i){var h=contextPath+"/order/createorderlonger";var g=$.callServiceAsJson(h,{});if(g.code==0){OrderInfo.custorderlonger=g.data}a()}).ketchup({bindElement:"createcustsussbtn"})};var a=function(){var l=$("#p_cust_areaId").val();if(l==null||l==""){l=OrderInfo.staff.areaId}var i=$("#p_cust_areaId_val").val();createCustInfo={cAreaId:l,cAreaName:i,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd option:selected").val()),cIdentidiesTypeCd:$.trim($("#identidiesTypeCd option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};diffPlace=$("#DiffPlaceFlag").val();var k={acctNbr:"",identityCd:createCustInfo.cIdentidiesTypeCd,identityNum:createCustInfo.cCustIdCard,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:createCustInfo.cAreaId};var h=contextPath+"/pad/cust/checkIdentity";var g=$.callServiceAsJson(h,k,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});var j="";if(g.code==0){$.unecOverlay();$.confirm("确认","此证件号码已存在,是否确认新建?",{yes:function(){e()},no:function(){}})}else{$.unecOverlay();e()}};var e=function(){createCustInfo={cAreaId:OrderInfo.staff.soAreaId,cAreaName:OrderInfo.staff.soAreaName,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cPartyTypeName:($.trim($("#partyTypeCd  option:selected").val())==1)?"个人客户":"政企客户",cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val()),cMailAddressStr:$.trim($("#cMailAddressStr").val())};var g={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$.trim($("#headFlag  option:selected").val()),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postcode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};OrderInfo.boCustInfos.name=createCustInfo.cCustName;OrderInfo.boCustInfos.areaId=createCustInfo.cAreaId;OrderInfo.boCustInfos.partyTypeCd=createCustInfo.cPartyTypeCd;OrderInfo.boCustInfos.defaultIdType=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustInfos.addressStr=createCustInfo.cAddressStr;OrderInfo.boCustInfos.mailAddressStr=createCustInfo.cMailAddressStr;OrderInfo.boCustIdentities.identidiesTypeCd=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustIdentities.identityNum=createCustInfo.cCustIdCard;OrderInfo.boPartyContactInfo.contactAddress=g.contactAddress,OrderInfo.boPartyContactInfo.contactDesc=g.contactDesc,OrderInfo.boPartyContactInfo.contactEmployer=g.contactEmployer,OrderInfo.boPartyContactInfo.contactGender=g.contactGender,OrderInfo.boPartyContactInfo.contactId=g.contactId,OrderInfo.boPartyContactInfo.contactName=g.contactName,OrderInfo.boPartyContactInfo.contactType=g.contactType,OrderInfo.boPartyContactInfo.eMail=g.eMail,OrderInfo.boPartyContactInfo.fax=g.fax,OrderInfo.boPartyContactInfo.headFlag=g.headFlag,OrderInfo.boPartyContactInfo.homePhone=g.homePhone,OrderInfo.boPartyContactInfo.mobilePhone=g.mobilePhone,OrderInfo.boPartyContactInfo.officePhone=g.officePhone,OrderInfo.boPartyContactInfo.postAddress=g.postAddress,OrderInfo.boPartyContactInfo.postcode=g.postcode,OrderInfo.boPartyContactInfo.staffId=g.staffId,OrderInfo.boPartyContactInfo.state=g.state,OrderInfo.boPartyContactInfo.statusCd=g.statusCd;OrderInfo.cust={custId:-1,partyName:createCustInfo.cCustName,areaId:createCustInfo.cAreaId};OrderInfo.boCustProfiles=[];for(var h=0;h<_partyProfiles.length;h++){var k=_partyProfiles[h];var j=$("#"+k.attrId).val();if(""==j||undefined==j){j==$("#"+k.attrId+"option:selected").val()}var k={partyProfileCatgCd:k.attrId,profileValue:j,state:"ADD"};if(""!=j&&j!=undefined){OrderInfo.boCustProfiles.push(k)}}$("#div_cust_create").popup("close");var l={};l.prodPwd="";l.accessNumber="";l.authFlag="1";authFlag="";l.identityCd=createCustInfo.cIdentidiesTypeCd;l.idCardNumber=createCustInfo.cCustIdCard;l.partyName=createCustInfo.cCustName;l.areaId=createCustInfo.cAreaId;l.areaName=createCustInfo.cAreaName;l.segmentName=createCustInfo.cPartyTypeName;l.identityName=$("#identidiesTypeCd option:selected").text();$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",l,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(i){if(i.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(i.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}_custAuthCallBack(i)},always:function(){$.unecOverlay()}})};return{identidiesTypeCdChoose:c,partyTypeCdChoose:b,certTypeByPartyType:f,custcreateButton:d}})();$(function(){});CommonUtils.regNamespace("order.cust","mgr");order.cust.mgr=(function(){var F=false;var a={};var c={};var P=null;var l=null;var L="0";var m=null;var B="";var J=[];var r=[];var y=function(){return P};var x="";var j=function(){$("#custAuthForm").off("formIsValid").on("formIsValid",function(W,V){var X=a;X.prodPwd=$.trim($("#authPassword").val());X.accessNumber=a.accessNumber;X.authFlag=l;$.callServiceAsHtml(contextPath+"/cust/custAuth",X,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(Y){if(Y.code==-2){return}if(Y.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}try{var aa=$.parseJSON(Y.data);$.alertMore("异常信息",aa.resultMsg,aa.errorStack,"error");return}catch(Z){}P=X;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;u(Y)},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"custAuthbtn"})};var s=function(W,X){var V=$(W).val();$("#"+X).empty();i(V,X);g()};var i=function(X,W){var V=$("#"+W);$.callServiceAsJson(contextPath+"/cust/queryCertType",{partyTypeCd:X},{before:function(){},done:function(Y){if(Y.code==-2){$.alertM(Y.data);return false}if(Y.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(Y.code==0){var ac=Y.data;if(ac!=undefined&&ac.length>0){var ae=[];for(var aa=0;aa<ac.length;aa++){var ad=true;for(var Z=0;Z<ae.length;Z++){ad=ad&&ac[aa].certTypeCd!=ae[Z].certTypeCd;if(!ad){break}}if(ad){ae.push(ac[aa])}}for(var aa=0;aa<ae.length;aa++){var ab=ae[aa];
V.append("<option value='"+ab.certTypeCd+"' >"+ab.name+"</option>")}V.selectmenu().selectmenu("refresh");if(W=="identidiesTypeCd"){f($("#"+W).children(":first-child"),"cCustIdCard")}}}},fail:function(Y){},always:function(){}})};var I=function(V,X){var W=$(V).val();if(W==-1){$("#"+X).attr("placeHolder","请输入接入号码");$("#"+X).attr("data-validate","validate(required:请准确填写接入号码) on(blur)")}else{if(W==1){$("#"+X).attr("placeHolder","请输入身份证号码");$("#"+X).attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(blur)")}else{if(W==2){$("#"+X).attr("placeHolder","请输入军官证");$("#"+X).attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(W==3){$("#"+X).attr("placeHolder","请输入护照");$("#"+X).attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#"+X).attr("placeHolder","请输入证件号码");$("#"+X).attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}}if(W!=-1){$("#isAppointNum").val("0").slider().slider("refresh")}e()};var f=function(V,Y){var W=$(V).val();var X=$("#"+Y);if(W==1){X.attr("placeHolder","请输入合法身份证号码");X.attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(W==2){X.attr("placeHolder","请输入合法军官证");X.attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(W==3){X.attr("placeHolder","请输入合法护照");X.attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{X.attr("placeHolder","请输入合法证件号码");X.attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}g()};var e=function(){$("#custQueryFirstForm").off("formIsValid").on("formIsValid",function(W,Y){var ae="";var ad="";var X="";var V="";var ab="";var aa="";var ac="";ae=$("#p_cust_identityCd").val();ab=$.trim($("#p_cust_identityNum").val());if(order.cust.mgr.fromProvFlag=="1"||(ae!=-1&&CONST.getAppDesc()!=0)){ae=$("#p_cust_identityCd").val();l="1"}else{l="0"}if(ae==-1){V=ab;ab="";ae=""}else{if(ae=="acctCd"||ae=="custNumber"){V="";ab="";ae="";aa=$("#p_cust_identityCd").val();ac=$.trim($("#p_cust_identityNum").val())}}X=$("#DiffPlaceFlag").val();areaId=$("#p_cust_areaId").val();if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");return}var Z={acctNbr:V,identityCd:ae,identityNum:ab,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:X,areaId:areaId,queryType:aa,queryTypeValue:ac};$.callServiceAsHtml(contextPath+"/pad/cust/queryCust",Z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(af){if(af.code==-2){return}Q(af)},fail:function(af){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})}).ketchup({bindElement:"a_user_search"})};var g=function(){$("#custCreateForm").off("formIsValid").on("formIsValid",function(X){var W=contextPath+"/order/createorderlonger";var V=$.callServiceAsJson(W,{});if(V.code==0){OrderInfo.custorderlonger=V.data}n()}).ketchup({bindElement:"btn_cust_create_save"})};var Q=function(V){if(V.data.indexOf("false")>=0){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}var W=$("#div_user_qry_result");W.find("ul").html(V.data);$("#a_cust_qry_back").off("tap").on("tap",function(X){l=""});$.jqmRefresh(W)};var G=function(){window.location.reload();$("#custQueryFirstForm").show();$("#custInfo").hide();$("#p_cust_identityNum").val("");$("#authPassword").val("");l="";OrderInfo.boCusts.partyId="";OrderInfo.boCustInfos.name="";OrderInfo.boCustIdentities.identityNum="";OrderInfo.cust={custId:-1,custName:"",areaId:""};OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId="";OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.cust="";x="";OrderInfo.order.step=0;if((CONST.getAppDesc()!=0)&&($("#custModifyId").is(":hidden"))){$("#a-cust-modify").show()}};var p=function(V){var W=a;W.prodPwd=$.trim($("#authPassword").val());W.authFlag=l;$.callServiceAsHtml(contextPath+"/cust/custAuth",W,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(X){if(X.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}P=W;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;u(X)},always:function(){$.unecOverlay()}})};var K=function(){if(order.cust.mgr.jumpAuthflag!="0"){$.alert("提示","没有跳过校验权限！");return}var V=a;V.authFlag="1";$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",V,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(W){if(W.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}P=V;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;u(W)},always:function(){$.unecOverlay()}})};var u=function(V){if(l=="0"){$("#dlg-chk-auth").popup("close")}$("#custQueryFirstForm").hide();$("#custInfo").html(V.data).show().enhanceWithin();if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){$("#a-cust-modify").hide()}else{$("#a-cust-modify").show();$("#a-cust-modify").off("tap").on("tap",order.prodModify.showCustInfoModify)}$("#a-cust-rechk").off("tap").on("tap",G);$("#a-qry-cust-prod").off("tap").on("tap",T);$("#cCustName").val("");$("#cCustIdCard").val("");main.home.hideMainIco()};var b=function(V){var W=$(V);a={custId:W.attr("custId"),partyName:W.attr("partyName"),idCardNumber:W.attr("idCardNumber"),identityName:W.attr("identityName"),areaName:W.attr("areaName"),areaId:W.attr("areaId"),identityCd:W.attr("identityCd"),addressStr:W.attr("addressStr"),norTaxPayer:W.attr("norTaxPayer"),segmentId:W.attr("segmentId"),segmentName:W.attr("segmentName"),custFlag:W.attr("custFlag"),vipLevel:W.attr("vipLevel"),vipLevelName:W.attr("vipLevelName")};if(l=="0"){if(order.cust.mgr.authType=="00"){$("#custAuthTypeName").html("客户密码：")}else{$("#custAuthTypeName").html("产品密码：")}if(order.cust.mgr.jumpAuthflag=="0"){$("#jumpAuth").show();$("#jumpAuth").off("tap").on("tap",K)}else{$("#jumpAuth").hide()}$("#authPassword").val("");$("#custAuthbtn").off("tap").on("tap",j);$("#dlg-chk-auth").popup("open")}else{p(V)}};var w=function(){var V=$("#p_cust_areaId").val();if(V.indexOf("0000")>0){$.alert("提示","前页受理地区为省级地区无法进行创建,请先选择市级地区！");return}$.callServiceAsHtmlGet(contextPath+"/pad/cust/create.html",{},{done:function(X){if(!X||!X.data){return}var W=$.popup("#div_cust_create",X.data,{cache:true,width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}}});$("#div_cust_create input[type='text']").val("");s($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");v();W.find("div[data-role='collapsible']").collapsible({collapsed:true,collapse:function(Y,Z){$("#contactName").attr("data-validate","");g()},expand:function(Y,Z){$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(blur)").attr("placeholder","请准确填写联系人名称");g()}})}})};var q=function(W){$("#plan2ndDiv tbody tr").removeClass("plan_select2");$("#plan2ndDiv tbody tr").children(":first-child").next().html("");$(W).addClass("plan_select2");var V="<i class='select'></i>";$(W).children(":first-child").next().html(V);order.prodModify.getChooseProdInfo()};_btnQueryCustProdPrepare=function(){$.callServiceAsHtmlGet(contextPath+"/pad/cust/orderProdPrepare.html",{diffPlaceFlag:$("#diffPlaceFlag").val()},{before:function(){},always:function(){},done:function(V){if(!V||V.code!=0){$.alert("提示","已订购业务查询失败,稍后重试");return}$.popup("#dlg_cust_prod",V.data,{width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){},cache:true});$(".ui-panel-inner > .ui-listview").height($(window).height());O(1)}})};var T=function(){if(OrderInfo.cust.custId==-1){$.alert("提示","新建客户无法查询已订购业务！");return}if(x==""){_btnQueryCustProdPrepare();x="1"}else{if(x=="1"){$("#dlg_cust_prod").popup("open",{transition:"slide"});
x="1"}else{$("#dlg_cust_prod").popup("close");x="1"}}};var O=function(X,V){var Y={};if(!a||!$.isPlainObject(a)||$.isEmptyObject(a)){Y.custId=""}else{Y.custId=a.custId;Y.areaId=$("#area").attr("areaId")}if($("#p_cust_identityNum").length==1){Y.acctNbr=$.trim($("#p_cust_identityNum").val());if(CONST.getAppDesc()==0){Y.areaId=$("#p_cust_areaId").val()}}else{if($("#isAppointNum").attr("value")=="1"){Y.acctNbr=$.trim($("#p_cust_identityNum").val());if(CONST.getAppDesc()==0){Y.areaId=$("#p_cust_areaId").val()}}else{Y.acctNbr=""}}Y.pageSize="8";Y.curPage=X;if(!(Y.custId)||Y.custId==""){$.alert("提示","无法查询已订购产品");return}var W=contextPath+"/pad/cust/orderprod";$.callServiceAsHtmlGet(W,Y,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(Z){if(!Z||Z.code!=0){$.alert("提示","查询失败,稍后重试");return}var aa=$("#dlg_cust_prod").find("ul:first");if(X==1){aa.html(Z.data)}else{aa.append(Z.data)}aa.listview().listview("refresh");aa.find("li").off("tap").on("tap",function(){var ab=$(this);if(ab.hasClass("multi")){if(ab.next(".multidiv").is(":hidden")){ab.next(".multidiv").show().siblings(".multidiv").hide()}else{ab.next(".multidiv").hide().siblings(".multidiv").hide()}}k(this,function(){ab.addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg");$("#div_2nd_order").panel("open")})});aa.find("div.multidiv li").off("tap").on("tap",function(){k(this,function(){$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").parent().siblings("li").removeClass("userorderlistlibg");$("#div_2nd_order").panel("open");order.prodModify.getChooseProdInfo()})});aa.find("li:first").trigger("tap").next("div.multidiv li:first").trigger("tap");order.prodModify.getChooseProdInfo()}})};var k=function(W,V){if(1==OrderInfo.order.step&&(!$(W).hasClass("userorderlistlibg"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){t();OrderInfo.order.step=0;V.apply(this,[])},no:function(){}})}else{if(2==OrderInfo.order.step&&(!$(W).hasClass("userorderlistlibg"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();t();OrderInfo.order.step=0;V.apply(this,[])},no:function(){}})}else{V.apply(this,[])}}};var A=function(){order.pad.area.chooseAreaTree("order/prepare","p_cust_areaId_val","p_cust_areaId",3)};var D=function(){order.area.chooseAreaTreeManger("cust/preQueryCust","p_areaId_val","p_areaId",3)};var R=function(){order.area.chooseAreaTreeAll("p_cust_areaId_val","p_cust_areaId",3,"limitProvince")};var d=function(){order.area.chooseAreaTree("order/prepare","p_ncust_areaId_val","p_ncust_areaId",3)};var E=function(){order.area.chooseAreaTree("order/prepare","prodareaName","prodareaid",3);order.prodModify.choosedProdInfo.areaId=$("#prodareaid").val()};var M=function(){$("#p_cust_identityCd").off("change").on("change",function(){I($(this).find("option:selected"),"p_cust_identityNum");$("#p_cust_identityCd").selectmenu().selectmenu("refresh")});i("-1","p_cust_identityCd");$("#isAppointNum").off("change").on("change",U);S();$("#a_user_create").off("tap").on("tap",w);e()};var S=function(){if($("#fromProvFlag").length&&$("#fromProvFlag").val()=="1"){order.cust.mgr.fromProvFlag="1";order.cust.mgr.provIsale=$("#provIsale").val();$("#p_cust_areaId_val").val("");$("#p_cust_areaId").val($("#provAreaId").val());$("#p_cust_identityCd").val($("#provIdentityCd").val());$("#p_cust_identityNum").val($("#provIdentityNum").val());if($("#provIdentityCd").val()!=-1){$("#isAppointNum").attr("checked",false)}$("#a_user_search").click()}else{order.cust.fromProvFlag="0";order.cust.provIsale=null}};var v=function(){$.callServiceAsHtmlGet(contextPath+"/pad/cust/partyProfileSpecList",{},{before:function(){$.ecOverlay("<strong>加载更多属性,请稍等...</strong>")},always:function(){$.unecOverlay()},fail:function(){$.alert("提示","属性加载异常,请稍后重试.");$.unecOverlay()},done:function(W){if(W.code==-2){return}var V=$("#partyProfile").html(W.data);$("#otabs li").on("tap",function(){N($(this))});$.jqmRefresh(V)}})};var h=function(){var X="";var V="";var W="";X=$("#p_cust_identityCd").val();W=$.trim($("#p_cust_identityNum").val());if(W==""){$.alert("提示","请输入证件号码！");return}if(X==1){X=$("#p_cust_identityCd").val()}if(X==-1){V=W;W="";X=""}diffPlace=$("#DiffPlaceFlag").val();areaId=$("#p_areaId").val();var Y={acctNbr:V,identityCd:X,identityNum:W,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:areaId};$.callServiceAsHtmlGet(contextPath+"/cust/queryCustAlone",Y,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(Z){if(Z.code==-2){return}if(!Z){Z.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(Z.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(Z.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctList").html(Z.data).show();$("#acctDetail").hide()},fail:function(Z){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var o=function(W){var V={partyId:W,areaId:$("#p_areaId").val()};$.callServiceAsHtml(contextPath+"/cust/custInfo",V,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(X){if(X.code==-2){return}if(!X){X.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(X.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(X.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctDetail").html(X.data).show();$("#acctList").hide()},fail:function(X){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var H=function(){createCustInfo={cAreaId:OrderInfo.staff.soAreaId,cAreaName:OrderInfo.staff.soAreaName,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cPartyTypeName:($.trim($("#partyTypeCd  option:selected").val())==1)?"个人客户":"政企客户",cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val()),cMailAddressStr:$.trim($("#cMailAddressStr").val())};var V={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$.trim($("#headFlag  option:selected").val()),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postcode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};OrderInfo.boCustInfos.name=createCustInfo.cCustName;OrderInfo.boCustInfos.areaId=createCustInfo.cAreaId;OrderInfo.boCustInfos.partyTypeCd=createCustInfo.cPartyTypeCd;OrderInfo.boCustInfos.defaultIdType=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustInfos.addressStr=createCustInfo.cAddressStr;OrderInfo.boCustInfos.mailAddressStr=createCustInfo.cMailAddressStr;OrderInfo.boCustIdentities.identidiesTypeCd=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustIdentities.identityNum=createCustInfo.cCustIdCard;OrderInfo.boPartyContactInfo.contactAddress=V.contactAddress,OrderInfo.boPartyContactInfo.contactDesc=V.contactDesc,OrderInfo.boPartyContactInfo.contactEmployer=V.contactEmployer,OrderInfo.boPartyContactInfo.contactGender=V.contactGender,OrderInfo.boPartyContactInfo.contactId=V.contactId,OrderInfo.boPartyContactInfo.contactName=V.contactName,OrderInfo.boPartyContactInfo.contactType=V.contactType,OrderInfo.boPartyContactInfo.eMail=V.eMail,OrderInfo.boPartyContactInfo.fax=V.fax,OrderInfo.boPartyContactInfo.headFlag=V.headFlag,OrderInfo.boPartyContactInfo.homePhone=V.homePhone,OrderInfo.boPartyContactInfo.mobilePhone=V.mobilePhone,OrderInfo.boPartyContactInfo.officePhone=V.officePhone,OrderInfo.boPartyContactInfo.postAddress=V.postAddress,OrderInfo.boPartyContactInfo.postcode=V.postcode,OrderInfo.boPartyContactInfo.staffId=V.staffId,OrderInfo.boPartyContactInfo.state=V.state,OrderInfo.boPartyContactInfo.statusCd=V.statusCd;
OrderInfo.cust={custId:-1,partyName:createCustInfo.cCustName,areaId:createCustInfo.cAreaId};OrderInfo.boCustProfiles=[];for(var W=0;W<J.length;W++){var Y=J[W];var X=$("#"+Y.attrId).val();if(""==X||undefined==X){X==$("#"+Y.attrId+"option:selected").val()}var Y={partyProfileCatgCd:Y.attrId,profileValue:X,state:"ADD"};if(""!=X&&X!=undefined){OrderInfo.boCustProfiles.push(Y)}}$("#div_cust_create").popup("close");var Z={};Z.prodPwd="";Z.accessNumber="";Z.authFlag="1";authFlag="";Z.identityCd=createCustInfo.cIdentidiesTypeCd;Z.idCardNumber=createCustInfo.cCustIdCard;Z.partyName=createCustInfo.cCustName;Z.areaId=createCustInfo.cAreaId;Z.areaName=createCustInfo.cAreaName;Z.segmentName=createCustInfo.cPartyTypeName;Z.identityName=$("#identidiesTypeCd option:selected").text();$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",Z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(aa){if(aa.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(aa.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}u(aa)},always:function(){$.unecOverlay()}})};var n=function(){var aa=$("#p_cust_areaId").val();if(aa==null||aa==""){aa=OrderInfo.staff.areaId}var X=$("#p_cust_areaId_val").val();createCustInfo={cAreaId:aa,cAreaName:X,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd option:selected").val()),cIdentidiesTypeCd:$.trim($("#identidiesTypeCd option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};diffPlace=$("#DiffPlaceFlag").val();var Z={acctNbr:"",identityCd:createCustInfo.cIdentidiesTypeCd,identityNum:createCustInfo.cCustIdCard,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:createCustInfo.cAreaId};var W=contextPath+"/pad/cust/checkIdentity";var V=$.callServiceAsJson(W,Z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});var Y="";if(V.code==0){$.unecOverlay();$.confirm("确认","此证件号码已存在,是否确认新建?",{yes:function(){H()},no:function(){}})}else{$.unecOverlay();H()}};var N=function(V){var Y=$(V).attr("tabid");if(Y!="0"&&$("#contactName").val()==""){$("#contactName").blur();return}var W=$(V).index();var X=$("#otabs-body > div");$(V).parent().children("li").attr("class","otab-nav");$(V).attr("class","otab-nav-action");$(V).parent().children("li").find(".ui-input-search").hide();$(V).parent().children("li").find(".ui-select").hide();$(V).children("div").show();X.hide();X.eq(W).show()};var U=function(){if(!F){F=true;if($("#p_cust_identityCd").find("option:selected").val()!=-1){$.alertSync("提示","只能接入号码才能指定号码！","information",function(){$("#isAppointNum").val("0").slider().slider("refresh");F=false})}}};var t=function(){var V=OrderInfo.boProd2Tds;if(V.length>0){for(var Y=0;Y<V.length;Y++){var X={numType:2,numValue:V[Y].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",X)}}var W=OrderInfo.boProdAns;if(W.length>0){for(var Y=0;Y<W.length;Y++){if(W[Y].idFlag){continue}var X={numType:1,numValue:W[Y].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",X)}order.service.boProdAn={};order.phoneNumber.resetBoProdAn()}$("#order_fill_content").empty();order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show()};var C=function(){$("#acctDetail").hide();$("#acctList").show()};var z=function(ab,ah,ae,ad){var V={acctNbr:"",areaId:ah,diffPlace:"local",identidies_type:"",identityCd:"",identityNum:"",olTypeCd:"8",operType:ae,partyName:"",prodClass:"12",queryType:"",queryTypeValue:""};if(ae==1){V.queryTypeValue=ab;V.identidies_type="客户编码";V.queryType="custNumber"}else{V.acctNbr=ab;V.identidies_type="接入号码"}var X=$.callServiceAsJson(contextPath+"/token/pc/cust/queryCustCompreInfo",V);if(X.code==0){if(X.data==null){$.alert("提示","客户架构信息接口无数据返回。");return false}if(X.data.custInfos==undefined){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return false}else{if(!ec.util.isArray(X.data.custInfos)){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return false}}if(X.data.prodInstInfos==undefined&&ae!=1){$.alert("提示","客户下没有可以办理业务的移动用户。");return false}if(X.data.offerMemberInfos==undefined&&ae!=1){$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理。");return false}if(ad=="OLD"){var W=X.data.custInfos;if(OrderInfo.actionFlag!=1&&W[0].custId!=OrderInfo.cust.custId){$.alert("提示",ab+"和主卡的客户不一致！");return false}var ag={};var Y=X.data.prodInstInfos;$.each(Y,function(){if(this.accNbr==ab){ag=this;if(ag.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示",ab+"不是在用产品！");return false}if(OrderInfo.actionFlag!=1&&ag.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){$.alert("提示",ab+"和主卡的付费类型不一致！");return false}if(ag.productId=="280000000"){$.alert("提示",ab+"是无线宽带，不能纳入！");return false}ag.custId=W[0].custId;OrderInfo.oldprodInstInfos.push(ag)}});var ac=true;for(var aa=0;aa<X.data.offerMemberInfos.length;aa++){var Z=X.data.offerMemberInfos[aa];if(Z.objType==""){$.alert("提示","销售品实例构成 "+Z.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(Z.objType==CONST.OBJ_TYPE.PROD){if(Z.accessNumber==""){$.alert("提示","销售品实例构成 "+Z.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(Z.objInstId==ag.prodInstId){ac=false}}if(ac){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+ag.accNbr+"】，无法继续受理，请业务后台核实");return false}var af={offerMemberInfos:X.data.offerMemberInfos,offerId:ag.mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:ag.mainProdOfferInstInfos[0].prodOfferId,offerSpecName:ag.mainProdOfferInstInfos[0].prodOfferName,accNbr:ag.accNbr};OrderInfo.oldoffer.push(af);order.memberChange.viceCartNum=0;$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){order.memberChange.viceCartNum++}})})}else{var W=X.data.custInfos;OrderInfo.cust={addressStr:W[0].addressStr,areaId:W[0].areaId,areaName:W[0].areaName,authFlag:W[0].authType,custFlag:W[0].custFlag,custId:W[0].custId,idCardNumber:W[0].idCardNumber,identityCd:W[0].identityCd,identityName:W[0].identityName,norTaxPayer:"",partyName:W[0].partyName,segmentId:W[0].segmentId,segmentName:W[0].segmentName,vipLevel:W[0].vipLevel,vipLevelName:W[0].vipLevelName};if(ae!=1){var ag=X.data.prodInstInfos;order.prodModify.choosedProdInfo={accNbr:ag[0].accNbr,areaCode:ag[0].zoneNumber,areaId:ag[0].areaId,corProdInstId:ag[0].corProdInstId,custId:ag[0].mainProdOfferInstInfos[0].custId,custName:ag[0].mainProdOfferInstInfos[0].custName,endDt:ag[0].mainProdOfferInstInfos[0].endDt,extProdInstId:ag[0].extProductId,feeType:ag[0].feeType.feeType,feeTypeName:ag[0].feeType.feeTypeName,is3G:ag[0].mainProdOfferInstInfos[0].is3G,prodBigClass:ag[0].prodBigClass,prodClass:ag[0].prodClass,prodInstId:ag[0].prodInstId,prodOfferId:ag[0].mainProdOfferInstInfos[0].prodOfferId,prodOfferInstId:ag[0].mainProdOfferInstInfos[0].prodOfferInstId,prodOfferName:ag[0].mainProdOfferInstInfos[0].prodOfferName,prodStateCd:ag[0].prodStateCd,prodStateName:ag[0].prodStateName,productId:ag[0].productId,productName:ag[0].productName,startDt:ag[0].mainProdOfferInstInfos[0].startDt,stopRecordCd:ag[0].prodStopRecords[0].stopRecordCd,stopRecordName:ag[0].prodStopRecords[0].stopRecordName};var ac=true;for(var aa=0;aa<X.data.offerMemberInfos.length;aa++){var Z=X.data.offerMemberInfos[aa];if(Z.objType==""){$.alert("提示","销售品实例构成 "+Z.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(Z.objType==CONST.OBJ_TYPE.PROD){if(Z.accessNumber==""){$.alert("提示","销售品实例构成 "+Z.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(Z.objInstId==order.prodModify.choosedProdInfo.prodInstId){ac=false}}if(ac){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+order.prodModify.choosedProdInfo.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=X.data.offerMemberInfos;OrderInfo.offer.offerId=order.prodModify.choosedProdInfo.prodOfferInstId;OrderInfo.offer.offerSpecId=order.prodModify.choosedProdInfo.prodOfferId;OrderInfo.offer.offerSpecName=order.prodModify.choosedProdInfo.prodOfferName}}}else{$.alertM(X.data);return false}return true};return{showCustAuth:b,showCustCreate:w,custAuth:p,getCustInfo:y,custReset:G,btnQueryCustProd:O,btnQueryCustProdMore:T,jumpAuth:K,identidiesTypeCdChoose:f,custidentidiesTypeCdChoose:I,choosedCustInfo:a,partyTypeCdChoose:s,chooseArea:A,chooseAllArea:R,newCustChooseArea:d,prodChooseArea:E,init:M,partyProfiles:J,profileTabLists:r,queryCust:h,queryCustDetail:o,changeLabel:N,jumpAuthflag:B,orderBtnflag:x,custCreateButton:g,isAppointNum:U,preQueryCustChooseArea:D,linkSelectPlan:q,back:C,fromProvFlag:L,provIsale:m,queryCustCompreInfo:z}
})();CommonUtils.regNamespace("order.pad","area");order.pad.area=(function(){var f={areaType:"",areaId:"",areaName:"",areaLevel:3,areaLimit:0};var e=function(q,n,p,r,o){f.areaType=q;f.areaId=p;f.areaName=n;f.areaLevel=r;f.areaLimit=!o?"":o;i(contextPath+"/orderQuery/areaTreeManger")};var h=function(p,n,o,q){f.areaType=p;f.areaId=o;f.areaName=n;f.areaLevel=q;i(contextPath+"/orderQuery/area")};var i=function(n){if(!login.windowpub.checkLogin()){return}$.callServiceAsJson(n,{areaType:f.areaType,areaLeve:f.areaLeve,areaLimit:f.areaLimit},{before:function(){$.ecOverlay("地区查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(o){if(o&&o.data&&ec.util.getJSONValByKey(o,"code")==0){var p=o.data;l(p)}else{$.alertM(o.data)}},fail:function(o){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var b=function(r){var t=$(r);var o=f.areaType;var s=t.attr("isAllRegionFlag");var n=t.attr("regionCode");var q=f.areaId;var u=f.areaName;var p=t.attr("showAreaName");if(s=="Y"){if(o=="bill/preQueryBalance"||o=="bill/prePayBalance"||o=="bill/reversewriteoffcash"){if(!n||n==""){$.alert("提示","请选择本地网（地市级）地区");return}}var v=t.attr("commonRegionId");v=(""+v).replace("ch","");$("#"+q).val(v);$("#"+q).attr("areaCode",n);var w=t.attr("showAreaName");w=typeof w!=undefined?w.replace("[受理渠道地区]","").replace("*",""):"请选择地区";$("#"+u).val(w);$("#"+u).attr("title",w);OrderInfo.staff.soAreaId=v;OrderInfo.staff.soAreaCode=n;OrderInfo.staff.soAreaName=p;if(o=="prod/preProdQuery"){if(product.query.areaId!=$("#p_areaId").val()){if($("#custName").val()!=""||$("#num").val()!=""){$.alert("提示","地区已变更，请重新定位产品")}$("#prodList").html("");$("#custName").val("").attr("name","");$("#num").val("");product.query.areaId=$("#p_areaId").val()}}if(o=="acct/preQueryAccount"){if(account.query.areaId!=$("#p_areaId").val()){if($("#custName").val()!=""||$("#num").val()!=""){$.alert("提示","地区已变更，请重新定位帐户")}$("#acctList").html("");$("#custName").val("").attr("name","");$("#num").val("");account.query.areaId=$("#p_areaId").val()}}$("#dlg-select-area").popup("close")}};var l=function(q){var p="";if(q&&$.isArray(q)&&q.length>0){var n="";for(var o=0;o<q.length;o++){n=q[o].regionName;if(q[o].isAllRegionFlag=="Y"){p+='<ul data-role="listview"><li><a href="javascript:;" onclick="javascript:order.pad.area.chooseArea(this);" areaLevel="'+q[o].areaLevel+'" commonRegionId="'+q[o].commonRegionId+'" isAllRegionFlag="'+q[o].isAllRegionFlag+'" isChannelArea="'+q[o].isChannelArea+'" parentNodeId="'+q[o].parentNodeId+'" regionCode="'+q[o].regionCode+'" showAreaName="'+n+'" regionName="'+q[o].regionName+'" data-corners="false">'+q[o].regionName+"</a>";+"</li></ul>"}else{p+='<div data-role="collapsible" data-mini="true" data-corners="false"><h2 onclick="order.pad.area.getAreaChildren(this);" areaLevel="'+q[o].areaLevel+'" commonRegionId="'+q[o].commonRegionId+'" isAllRegionFlag="'+q[o].isAllRegionFlag+'" isChannelArea="'+q[o].isChannelArea+'" parentId="'+q[o].parentId+'" regionName="'+q[o].regionName+'" showAreaName="'+n+'" regionCode="'+q[o].regionCode+'">'+q[o].regionName+'</h2><ul data-role="listview"></ul></div>'}}}else{p+='<ul data-role="listview"><li><a href="#" data-corners="false" >抱歉,没有找到相关地区信息.</a></li></ul>'}$("#dlg-select-area").find("div[data-role='content']").html(p).trigger("create");$("#dlg-select-area").popup("open")};var j=function(s){var t=$(s);var q=t.parent().collapsible("option","collapsed");if(t&&q&&!f.cached){var v=t.attr("commonRegionId");var n=t.attr("regionName");var u=t.attr("areaLevel");var o=f.areaType;var r=t.attr("isChannelArea");if(v=="undefined"){return}if(u<=f.areaLevel){var p={leve:u,parentAreaId:v,areaType:o,areaLimit:f.areaLimit,isChannelArea:r};$.callServiceAsJson(contextPath+"/orderQuery/commonRegionChilden",p,{before:function(){$.ecOverlay("地区查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(x){var A="";if(x&&x.data&&ec.util.getJSONValByKey(x,"code")==0&&$.isArray(x.data)&&x.data.length>0){var B=x.data;var y=t.attr("showAreaName");y=typeof y=="undefined"?"":n;var w="";for(var z=0;z<B.length;z++){w=y==""?B[z].regionName:y+" > "+B[z].regionName;if(B[z].isAllRegionFlag=="Y"){A+='<li><a href="javascript:;" onclick="javascript:order.pad.area.chooseArea(this);" areaLevel="'+B[z].areaLevel+'" commonRegionId="'+B[z].commonRegionId+'" isAllRegionFlag="'+B[z].isAllRegionFlag+'" isChannelArea="'+B[z].isChannelArea+'" parentNodeId="'+B[z].parentNodeId+'" regionCode="'+B[z].regionCode+'" showAreaName="'+w+'" regionName="'+B[z].regionName+'" data-corners="false">'+B[z].regionName+"</a></li>"}else{A+='<li><div data-role="collapsible" data-mini="true" data-corners="false"><h2 onclick="order.pad.area.getAreaChildren(this);" areaLevel="'+B[z].areaLevel+'" commonRegionId="'+B[z].commonRegionId+'" isAllRegionFlag="'+B[z].isAllRegionFlag+'" isChannelArea="'+B[z].isChannelArea+'" parentId="'+B[z].parentId+'" regionName="'+B[z].regionName+'" showAreaName="'+w+'" regionCode="'+B[z].regionCode+'">'+B[z].regionName+'</h2><ul data-role="listview"></ul></div></li>'}w=""}}else{A+='<li><a href="#" data-corners="false">抱歉,没有找到相关地区信息.</a></li>'}t.parent().find("ul").html(A).listview("refresh")}})}}};var g=function(n,p,q,o){if(!login.windowpub.checkLogin()){return}var r=p;var s=n;$.ligerDialog.open({width:350,height:350,title:"请选择地区",url:contextPath+"/orderQuery/areaTreeAll?areaLeve="+q+"&areaLimit="+o,buttons:[{text:"确定",onclick:function(v,t){if(!ztree){return}var u=ztree.getSelected();if(u){if(u.data.isAllRegionFlag=="Y"){$("#"+r).val(u.data.commonRegionId);$("#"+r).attr("areaCode",u.data.regionCode);$("#"+s).val(areaNameVal);t.close()}else{alert("当前地区不可选！")}}else{alert("请选择地区！")}}},{text:"取消",onclick:function(u,t){t.close()}}]})};var m=null;var a;var d;var k=function(n,o){a=o;d=n;m=$.ligerDialog.open({width:400,height:320,title:"请选择地区",url:contextPath+"/orderQuery/tree_flat",buttons:[{text:"取消",onclick:function(q,p){p.close()}}]})};var c=function(o,n){if(m!=null){if(d&&$("#"+d)){$("#"+d).val(o)}if(a&&$("#"+a)){$("#"+a).val(n)}m.close()}};return{areaChecked:c,flatAreaPage:k,chooseAreaTree:h,chooseAreaTreeAll:g,chooseAreaTreeManger:e,chooseArea:b,getAreaChildren:j}})();CommonUtils.regNamespace("rule","rule");rule.rule=(function(){var checkFlag=false;var checkObj={};var _callBackStr="";var _callBackParam={};var _init=function(){$("#ruleBody").html("");$("#ruleclose").click(function(){_closeRuleDiv()});$("#credit").click(function(){_credit()});$("#closedialog").click(function(){_cancel()})};var _prepare=function(param,callBackStr,callBackParam){_init();_callBackStr=callBackStr;_callBackParam=callBackParam;if(!query.offer.loadInst()){return}var inParam={prodInfo:order.prodModify.choosedProdInfo,areaId:param.areaId,staffId:param.staffId,channelId:param.channelId,custId:param.custId,boInfos:param.boInfos,soNbr:OrderInfo.order.soNbr};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var response=$.callServiceAsJson(contextPath+"/rule/prepare",inParam);$.unecOverlay();var checkData=response.data;if(response.code==0){if(checkData==null){$.alert("提示","规则校验异常，请联系管理人员！");return}}else{$.alertM(response.data);return}if(checkData.ruleType=="portal"){if(checkData.resultCode=="0"){$.alert("提示",checkData.resultMsg);return true}}if(checkData.result&&checkData.result.resultInfo){var checkRuleInfo=checkData.result.resultInfo;if(checkRuleInfo!=null&&checkRuleInfo.length>0){$.each(checkRuleInfo,function(i,ruleInfo){$("<tr><td>"+ruleInfo.resultCode+"</td><td>"+ruleInfo.ruleDesc+"</td><td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});easyDialog.open({container:"ruleDiv"})}else{_credit();SoOrder.initFillPage()}}else{_credit();SoOrder.initFillPage()}if(checkData.resultCode!=0){$("#ruleSubmit").hide()}else{checkObj=param;checkFlag=true}};var _getRuleImgClass=function(ruleLevel){if(ruleLevel<4){return"correct"}else{return"error"}};var _getRuleLevelName=function(ruleLevel){if(ruleLevel==0){return"提示级"
}else{if(ruleLevel==1){return"中级"}else{if(ruleLevel==2){return"高级"}else{if(ruleLevel==3){return"特技"}else{if(ruleLevel==4){return"限制级"}}}}}};var _prepareCallBack=function(response){var content$=$("#ruleDiv");content$.html(response.data).show()};var _submit=function(){if(!checkFlag){return}$.callServiceAsHtml(contextPath+checkObj.uri,checkObj.param,checkObj.callObj);easyDialog.close()};var _closeRuleDiv=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _cancel=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _showRuleDiv=function(ruleInfo){};var _credit=function(){eval(_callBackStr+"("+JSON.stringify(_callBackParam)+")")};var _ruleCheck=function(boInfos){if(!query.offer.loadInst()){return false}if(boInfos==undefined){return true}var inParam={areaId:OrderInfo.staff.soAreaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,boInfos:boInfos,prodInfo:order.prodModify.choosedProdInfo};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var response=$.callServiceAsJson(contextPath+"/rule/prepare",inParam);$.unecOverlay();if(response!=undefined&&response.code==0){var checkData=response.data;if(checkData==null){$.alert("提示","规则校验异常，请联系管理人员！");return false}if(checkData.ruleType=="portal"){if(checkData.resultCode=="0"){$.alert("提示",checkData.resultMsg);return false}}var checkRuleInfo=checkData.result.resultInfo;$("#ruleBody").empty();if(checkRuleInfo!=undefined&&checkRuleInfo.length>0){$.each(checkRuleInfo,function(i,ruleInfo){$("<tr><td>"+ruleInfo.resultCode+"</td><td>"+ruleInfo.ruleDesc+"</td><td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});$.popupSmall("#poppopdialog",{width:500,height:300});return false}else{return true}}else{$.alertM(response.data);return}};return{submit:_submit,prepare:_prepare,showRuleDiv:_showRuleDiv,ruleCheck:_ruleCheck,init:_init,getRuleLevelName:_getRuleLevelName,getRuleImgClass:_getRuleImgClass}})();$(function(){});CommonUtils.regNamespace("CacheData");CacheData=(function(){var c=function(L,M){M.isdel="C";var I=true;for(var K=0;K<AttachOffer.openList.length;K++){var J=AttachOffer.openList[K];if(J.prodId==L){I=false;break}}if(I){var J={prodId:L,specList:[]};AttachOffer.openList.push(J)}CacheData.getOfferSpecList(L).push(M)};var i=function(M,J){J.isdel="C";if(J.servSpecId==undefined){J.servSpecId=J.objId}if(J.servSpecName==undefined){J.servSpecName=J.objName}var I=true;for(var L=0;L<AttachOffer.openServList.length;L++){var K=AttachOffer.openServList[L];if(K.prodId==M){I=false;break}}if(I){var K={prodId:M,servSpecList:[]};AttachOffer.openServList.push(K)}CacheData.getServSpecList(M).push(J)};var v=function(I,J){if(J!=undefined){$.each(J.offerRoles,function(){$.each(this.roleObjs,function(){if($("#check_"+I+"_"+this.objId).attr("checked")=="checked"){this.selQty=1}else{this.selQty=2}})})}};var D=function(M,J,I){var L='<form id="paramForm">';if(I==2){if(ec.util.isArray(J.prodSpecParams)){for(var K=0;K<J.prodSpecParams.length;K++){var O=J.prodSpecParams[K];if(O.value==undefined){O.value=""}L+=m(M,O,O.itemSpecId,O.value)}}}else{if(I==3){if(ec.util.isArray(J.prodSpecParams)){for(var K=0;K<J.prodSpecParams.length;K++){var O=J.prodSpecParams[K];if(ec.util.isArray(J.prodInstParams)){$.each(J.prodInstParams,function(){if(this.itemSpecId==O.itemSpecId){O.value=this.value}})}if(O.value==undefined){O.value=""}L+=m(M,O,O.itemSpecId,O.value)}}}else{if(I==1){if(J.offerSpec!=undefined){if(ec.util.isArray(J.offerSpec.offerSpecParams)){var N=J.offerSpec.offerSpecParams;$.each(N,function(){var P=this;if(ec.util.isArray(J.offerParamInfos)){$.each(J.offerParamInfos,function(){if(this.itemSpecId==P.itemSpecId){P.value=this.value}})}L+=m(M,this,this.itemSpecId,this.value)})}}}else{if(ec.util.isArray(J.offerSpecParams)){var N=J.offerSpecParams;$.each(N,function(){L+=m(M,this,this.itemSpecId,this.value)})}}}}L+="</form>";return L};var e=function(K,J){var I=$('<form id="appForm"></form>');if(!!J&&J.length>0){$.each(J,function(){var L=$('<input id="'+K+"_"+this.objId+'" name="'+K+'" type="checkbox">'+this.objName+"</input></br>");if(this.minQty==0){if(this.dfQty>0){L.attr("checked","checked")}}else{if(this.minQty>0){L.attr("checked","checked");L.attr("disabled","disabled")}}I.append(L)})}return I};var m=function(N,P){var K=P.itemSpecId;if(P.setValue==undefined){P.setValue=P.value}var L=P.setValue;var I="";if(ec.util.isArray(P.valueRange)){var M="";if(P.rule.isConstant=="Y"){I=P.name+": <select class='inputWidth183px' id="+N+"_"+K+" disabled='disabled'>"}else{if(P.rule.isOptional=="N"){I=P.name+": <select class='inputWidth183px' id="+N+"_"+K+" data-validate='validate(required,reg:"+P.rule.maskMsg+"("+P.rule.mask+")) on(blur)'><label class='f_red'>*</label><br>"}else{I=P.name+": <select class='inputWidth183px' id="+N+"_"+K+"><br>";M+='<option value="" >请选择</option>'}}for(var J=0;J<P.valueRange.length;J++){var O=P.valueRange[J];if(O.value==P.setValue){M+='<option value="'+O.value+'" selected="selected" >'+O.text+"</option>"}else{M+='<option value="'+O.value+'">'+O.text+"</option>"}}I+=M+"</select><br>"}else{if(P.dataTypeCd==1){if(P.rule==undefined){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="text" value="'+L+'" ><br>'}else{if(P.rule.isConstant=="Y"){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="text" disabled="disabled" value="'+L+'" ><br>'}else{if(P.rule.isOptional=="N"){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="text" mask="'+P.rule.mask+'" maskmsg="'+P.rule.maskMsg+'" value="'+L+'" ><label class="f_red">*</label><br>'}else{I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="text" mask="'+P.rule.mask+'" maskmsg="'+P.rule.maskMsg+'" value="'+L+'" ><br>'}}}}else{if(P.dataTypeCd==8){if(P.rule==undefined){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="password" value="'+L+'" ><br>'}else{if(P.rule.isConstant=="Y"){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="password"  disabled="disabled" value="'+L+'" ><br>'}else{if(P.rule.isOptional=="N"){I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="password" data-validate="validate(required,reg:'+P.rule.maskMsg+"("+P.rule.mask+')) on(blur)" value="'+L+'" ><label class="f_red">*</label><br>'}else{I+=P.name+' : <input id="'+N+"_"+K+'" class="inputWidth183px" type="password" data-validate="validate(reg:'+P.rule.maskMsg+"("+P.rule.mask+')) on(blur)" value="'+L+'" ><br>'}}}}else{if(P.dataTypeCd==4){}}}}return I};var p=function(L,J,I){var K='<form id="paramForm">';var M="";if(I==0){$.each(J.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4){if(this.minQty==0&&this.maxQty>0){M+='<input id="check_'+L+"_"+this.objId+'" type="checkbox" checked="checked">'+this.objName+"<br>"}else{if(this.minQty>0){M+='<input id="check_'+L+"_"+this.objId+'"  type="checkbox" checked="checked" disabled="disabled">'+this.objName+"<br>"}}}})});if(M==""){K="订购【"+J.offerSpecName+"】可选包"}else{K="订购【"+J.offerSpecName+"】可选包，需要开通以下勾选的功能产品：<br>"+M}}else{if(I==1){$.each(J.offerMemberInfos,function(){var N=this;$.each(J.offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(N.objId==this.objId&&this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){var O=N.objInstId;if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE){M+='<input id="check_'+L+"_"+O+'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+"<br>"}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE){M+='<input id="check_'+L+"_"+O+'" type="checkbox" checked="checked">'+this.objName+"<br>"}}}})})});if(M==""){K="退订【"+J.offerSpecName+"】可选包"}else{K="退订【"+J.offerSpecName+"】可选包，需要关闭以下勾选的功能产品：<br>"+M}}else{if(I==2){$.each(J.offerRoles,function(){$.each(this.roleObjs,function(){if(this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE){M+='<input id="check_'+L+"_"+this.objId+'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+"<br>"
}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE){M+='<input id="check_'+L+"_"+this.objId+'" type="checkbox" checked="checked">'+this.objName+"<br>"}}}})});if(M==""){K="取消订购【"+J.offerSpecName+"】可选包"}else{K="取消订购【"+J.offerSpecName+"】可选包，需要取消开通以下勾选的功能产品：<br>"+M}}}}K+="</form>";return K};var F=function(J,L){if(ec.util.isArray(L.offerSpecParams)){for(var I=0;I<L.offerSpecParams.length;I++){var K=L.offerSpecParams[I];if(ec.util.isArray(K.valueRange)){if(K.value==undefined||K.value==""){if(K.rule.isOptional=="N"){return false}}}else{if(K.value==undefined||K.value==""){if(K.rule.isOptional=="N"){return false}}}}}L.isset="Y";return true};var r=function(K,I){if(ec.util.isArray(I.prodSpecParams)){for(var J=0;J<I.prodSpecParams.length;J++){var L=I.prodSpecParams[J];if(ec.util.isArray(L.valueRange)){if(L.value==undefined||L.value==""){if(L.rule.isOptional=="N"){return false}}}else{if(L.value==undefined||L.value==""){if(L.rule.isOptional=="N"){return false}}}}}I.isset="Y";return true};var w=function(K){for(var J=0;J<AttachOffer.openList.length;J++){var I=AttachOffer.openList[J];if(I.prodId==K){return I.specList}}return[]};var u=function(K,L){var I=w(K);if(I!=undefined){for(var J=0;J<I.length;J++){if(I[J].offerSpecId==L){return I[J]}}}};var n=function(L,M,J){var I=u(L,M);if(ec.util.isObj(I)){for(var K=0;K<I.offerSpecParams.length;K++){if(I.offerSpecParams[K].itemSpecId==J){return I.offerSpecParams[K]}}}};var a=function(M,P,J){var Q=u(M,P);if(!!Q.offerRoles){for(var L=0;L<Q.offerRoles.length;L++){var O=Q.offerRoles[L];for(var K=0;K<O.roleObjs.length;K++){var N=O.roleObjs[K];if(N.prodSpecParams!=undefined&&N.prodSpecParams.length>0){for(var I=0;I<N.prodSpecParams.length;I++){if(N.prodSpecParams[I].itemSpecId==J){return N.prodSpecParams[I]}}}}}}};var d=function(J){for(var I=0;I<AttachOffer.openedList.length;I++){var K=AttachOffer.openedList[I];if(K.prodId==J){return K.offerList}}return[]};var x=function(L,I){var J=d(L);if(ec.util.isArray(J)){for(var K=0;K<J.length;K++){if(J[K].offerId==I){return J[K]}}}};var g=function(K,L){var I=d(K);if(ec.util.isArray(I)){for(var J=0;J<I.length;J++){if(I[J].offerSpecId==L){return I[J]}}}};var l=function(M,I,J){var L=x(M,I);if(ec.util.isArray(L.offerSpec.offerSpecParams)){for(var K=0;K<L.offerSpec.offerSpecParams.length;K++){if(L.offerSpec.offerSpecParams[K].itemSpecId==J){return L.offerSpec.offerSpecParams[K]}}}};var H=function(O,M,I){var P=x(O,M);if(ec.util.isArray(P.offerMembers)){for(var N=0;N<P.offerMembers.length;N++){var K=P.offerMembers[N];for(var L=0;L<K.prodParamInfos.length;L++){for(var J=0;J<K.prodParamInfos.length;J++){var Q=K.prodParamInfos[J];if(Q.itemSpecId==I){return Q}}}}}};var z=function(K){for(var J=0;J<AttachOffer.openServList.length;J++){var I=AttachOffer.openServList[J];if(I.prodId==K){return I.servSpecList}}return[]};var b=function(K,L){var I=z(K);if(I!=undefined){for(var J=0;J<I.length;J++){if(I[J].servSpecId==L){return I[J]}}}};var h=function(L,M,J){var I=b(L,M);if(ec.util.isArray(I.prodSpecParams)){for(var K=0;K<I.prodSpecParams.length;K++){if(I.prodSpecParams[K].itemSpecId==J){return I.prodSpecParams[K]}}}};var t=function(J){for(var I=0;I<AttachOffer.openedServList.length;I++){var K=AttachOffer.openedServList[I];if(K.prodId==J){return K.servList}}return[]};var y=function(K,L){var J=t(K);if(ec.util.isArray(J)){for(var I=0;I<J.length;I++){if(J[I].servId==L){return J[I]}}}};var j=function(K,L){var J=t(K);if(ec.util.isArray(J)){for(var I=0;I<J.length;I++){if(J[I].servSpecId==L){return J[I]}}}};var f=function(L,N,I){var M=y(L,N);if(ec.util.isArray(M.prodSpecParams)){for(var J=0;J<M.prodSpecParams.length;J++){var K=M.prodSpecParams[J];if(K.itemSpecId==I){return K}}}};var q=function(K){for(var J=0;J<AttachOffer.openAppList.length;J++){var I=AttachOffer.openAppList[J];if(I.prodId==K){return I.appList}}return[]};var C=function(K){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){for(var I=0;I<OrderInfo.offer.offerMemberInfos.length;I++){var J=OrderInfo.offer.offerMemberInfos[I];if(J.objInstId==K){return J}}}return{}};var k=function(K,M){var L={servSpecId:M,prodId:K,orderedServSpecIds:[]};var I=CacheData.getServSpecList(K);if(ec.util.isArray(I)){$.each(I,function(){if(this.servSpecId!=M&&this.isdel!="Y"&&this.isdel!="C"){L.orderedServSpecIds.push(this.servSpecId)}})}var J=CacheData.getServList(K);if(ec.util.isArray(J)){$.each(J,function(){if(this.servSpecId!=M&&this.isdel!="Y"&&this.isdel!="C"){L.orderedServSpecIds.push(this.servSpecId)}})}return L};var s=function(K,M){var L={prodId:K,offerSpecId:M,orderedOfferSpecIds:[]};var I=CacheData.getOfferList(K);if(ec.util.isArray(I)){$.each(I,function(){if(this.offerSpecId!=M&&this.isdel!="Y"&&this.isdel!="N"){if(this.offerSpecId!=undefined){L.orderedOfferSpecIds.push(this.offerSpecId)}}})}var J=CacheData.getOfferSpecList(K);if(ec.util.isArray(J)){$.each(J,function(){if(this.offerSpecId!=M&&this.isdel!="Y"){if(this.offerSpecId!=undefined){L.orderedOfferSpecIds.push(this.offerSpecId)}}})}return L};var A=function(L,O){if(ec.util.isObj(L)){if(ec.util.isArray(L.result.servSpec)){if(ec.util.isObj(O)){prodId=O}for(var K=0;K<L.result.servSpec.length;K++){var J=L.result.servSpec[K];var M=CacheData.getServBySpecId(prodId,J.servSpecId);var I=CacheData.getServSpec(prodId,J.servSpecId);if(J.ifDault==0){if(ec.util.isObj(M)){var N=$("#del_"+prodId+"_"+M.servId);if(ec.util.isObj(N)){N.removeClass("delete").addClass("mustchoose");N.removeAttr("onclick");M.isdel="N"}}else{if(ec.util.isObj(I)){var N=$("#del_"+prodId+"_"+I.servSpecId);if(ec.util.isObj(N)){N.removeClass("delete").addClass("mustchoose");N.removeAttr("onclick");I.isdel="N"}}else{if(OrderInfo.actionFlag==2){J.isdel="C";CacheData.setServSpec(prodId,J);AttachOffer.addOpenServList(prodId,J.servSpecId,J.servSpecName,J.ifParams)}}}}else{if((OrderInfo.actionFlag==2||OrderInfo.actionFlag==21)&&J.ifDault==1){if(ec.util.isObj(M)){var N=$("#del_"+prodId+"_"+M.servId);if(ec.util.isObj(N)){M.isdel="N"}}else{if(ec.util.isObj(I)){var N=$("#del_"+prodId+"_"+I.servSpecId);if(ec.util.isObj(N)){I.isdel="N"}}else{J.isdel="C";CacheData.setServSpec(prodId,J);AttachOffer.addOpenServList(prodId,J.servSpecId,J.servSpecName,J.ifParams)}}}}}}}};var o=function(L){if(ec.util.isObj(L)){if(ec.util.isArray(L.result.offerSpec)){for(var M=0;M<L.result.offerSpec.length;M++){var J=L.result.offerSpec[M];if(J.ifDault==0){var Q=CacheData.getOfferBySpecId(prodId,J.offerSpecId);if(ec.util.isObj(Q)){var P=$("#del_"+prodId+"_"+J.offerId);if(ec.util.isObj(P)){P.removeClass("delete").addClass("mustchoose");P.removeAttr("onclick");Q.isdel="N"}}var N=CacheData.getOfferSpec(prodId,J.offerSpecId);if(ec.util.isObj(N)){var P=$("#del_"+prodId+"_"+N.offerSpecId);if(ec.util.isObj(P)){P.removeClass("delete").addClass("mustchoose");P.removeAttr("onclick");N.isdel="N"}}else{if(OrderInfo.actionFlag==2){J.isdel="C";CacheData.setOfferSpec(prodId,J);var K=CacheData.getExcDepOfferParam(prodId,J.offerSpecId);AttachOffer.addOpenList(prodId,J.offerSpecId);if(K.orderedOfferSpecIds.length>0){var L=query.offer.queryExcludeDepend(K);if(L!=undefined&&L.result!=undefined){var R=L.result.offerSpec.exclude;if(ec.util.isArray(R)){for(var M=0;M<R.length;M++){var I=R[M];var Q=CacheData.getOfferBySpecId(prodId,I);if(Q!=undefined){var O=$("#li_span_"+prodId+"_"+offerId).parent();O.addClass("deldiv");Q.isdel="Y";var P=$("#del_"+prodId+"_"+Q.offerId);if(ec.util.isObj(P)){P.removeClass("delete").addClass("mustchoose");P.removeAttr("onclick")}}}}}}}}}}}}};var o=function(M,O){if(ec.util.isObj(M)){if(ec.util.isArray(M.result.offerSpec)){for(var N=0;N<M.result.offerSpec.length;N++){var K=M.result.offerSpec[N];if(K.ifDault==0){var S=CacheData.getOfferBySpecId(O,K.offerSpecId);if(ec.util.isObj(S)){var R=$("#del_"+O+"_"+K.offerId);if(ec.util.isObj(R)){R.removeClass("deldiv").addClass("mustchoose");R.removeAttr("onclick");S.isdel="N"}}var P=CacheData.getOfferSpec(O,K.offerSpecId);if(ec.util.isObj(P)){var R=$("#del_"+O+"_"+P.offerSpecId);if(ec.util.isObj(R)){R.removeClass("deldiv").addClass("mustchoose");
R.removeAttr("onclick");P.isdel="N"}}else{if(OrderInfo.actionFlag==2){K.isdel="C";CacheData.setOfferSpec(O,K);var L=CacheData.getExcDepOfferParam(O,K.offerSpecId);AttachOffer.addOpenList(O,K.offerSpecId);if(L.orderedOfferSpecIds.length>0){var J=query.offer.queryExcludeDepend(L);if(J!=undefined&&J.result!=undefined){var T=J.result.offerSpec.exclude;if(ec.util.isArray(T)){for(var N=0;N<T.length;N++){var I=T[N];var S=CacheData.getOfferBySpecId(O,I);if(S!=undefined){var Q=$("#li_span_"+O+"_"+offerId).parent();Q.addClass("deldiv");S.isdel="Y";var R=$("#del_"+O+"_"+S.offerId);if(ec.util.isObj(R)){R.removeClass("deldiv").addClass("mustchoose");R.removeAttr("onclick")}}}}}}}}}}}}};var G=function(I){var J="";if(I>0){if(OrderInfo.offer.offerMemberInfos!=undefined){$.each(OrderInfo.offer.offerMemberInfos,function(K){if(this.objInstId==I){J=this.offerRoleId;return false}})}}else{if(I<0){if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(L){var K=this.offerRoleId;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==I){J=K;return false}})}})}}}return J};var B=function(L){var I=[];for(var J=0;J<L.offerMemberInfos.length;J++){var K=L.offerMemberInfos[J];if(K.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){I.push(K)}}for(var J=0;J<L.offerMemberInfos.length;J++){var K=L.offerMemberInfos[J];if(K.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){I.push(K)}}L.offerMemberInfos=I};var E=function(P){if(P.dependOffer.offerGrpInfos.length>0){var O=P.dependOffer;for(var L=0;L<O.offerGrpInfos.length;L++){var N=O.offerGrpInfos[L];var M=$("input[name="+N.grpId+"]:checked");var I=M.length;O.offerGrpInfos[L].checkLen=I;for(var K=0;K<N.subOfferSpecInfos.length;K++){var J=N.subOfferSpecInfos[K];M.each(function(){if($(this).val()==J.offerSpecId){J.isCheck=true}})}}}};return{setParam:F,setServParam:r,setOfferSpec:c,setServSpec:i,setServ2OfferSpec:v,sortOffer:B,getParamContent:D,getOfferSpecList:w,getOfferSpec:u,getSpecParam:n,getOfferList:d,getOffer:x,getOfferParam:l,getOfferBySpecId:g,getServList:t,getServ:y,getServBySpecId:j,getServSpec:b,getServSpecList:z,getProdInstParam:H,getProdSpecParam:a,getServInstParam:f,getServSpecParam:h,getOfferProdStr:p,getOpenAppList:q,getAppContent:e,getOfferMember:C,getExcDepServParam:k,getExcDepOfferParam:s,getOfferRoleId:G,parseServ:A,parseOffer:o,setOffer2ExcludeOfferSpec:E}})();CommonUtils.regNamespace("query","offer");query.offer=(function(){var y=function(E,D){var C=contextPath+"/offer/queryOfferSpec";if(typeof(D)=="function"){$.callServiceAsJsonGet(C,E,{before:function(){$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>")},done:function(F){$.unecOverlay();if(F.code==0){if(F.data){D(F.data.offerSpec)}}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");var B=$.callServiceAsJsonGet(C,E);$.unecOverlay();if(B.code==0){if(B.data){return B.data.offerSpec}}else{if(B.code==-2){$.alertM(B.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}};var s=function(E,D){var C=contextPath+"/offer/queryOfferInst";if(typeof(D)=="function"){$.callServiceAsJsonGet(C,E,{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(F){$.unecOverlay();if(F.code==0){if(F.data){D(F.data)}}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");var B=$.callServiceAsJsonGet(C,E);$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{if(B.code==-2){$.alertM(B.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}};var t=function(){var B=order.prodModify.choosedProdInfo;var F={offerId:B.prodOfferInstId,offerSpecId:B.prodOfferId,acctNbr:B.accNbr,areaId:B.areaId,distributorId:""};var E=query.offer.queryOfferInst(F);if(E&&E.code==CONST.CODE.SUCC_CODE){var C=true;if(ec.util.isArray(E.offerMemberInfos)){CacheData.sortOffer(E);for(var D=0;D<E.offerMemberInfos.length;D++){var G=E.offerMemberInfos[D];if(G.objType==""){$.alert("提示","销售品实例构成 "+G.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(G.objType==CONST.OBJ_TYPE.PROD){if(G.accessNumber==""){$.alert("提示","销售品实例构成 "+G.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(G.objInstId==B.prodInstId){C=false}}if(C){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+B.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=E.offerMemberInfos;OrderInfo.offer.offerId=B.prodOfferInstId;OrderInfo.offer.offerSpecId=B.prodOfferId;OrderInfo.offer.offerSpecName=B.prodOfferName;return true}else{$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");return false}}};var i=function(E,D){var C=contextPath+"/offer/queryOfferParam";if(typeof(D)=="function"){$.callServiceAsJsonGet(C,E,{before:function(){$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(F){$.unecOverlay();if(F.code==0){if(F.data){D(F.data)}}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}})}else{$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");var B=$.callServiceAsJsonGet(C,E);$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{if(B.code==-2){$.alertM(B.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}};var u=function(E,D){g(E);E.isServiceOpen="Y";var C=contextPath+"/token/pad/offer/queryAttachOffer";if(typeof(D)=="function"){$.callServiceAsHtmlGet(C,{strParam:JSON.stringify(E)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(F){$.unecOverlay();if(F.code==0){if(F.data){D(F.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var B=$.callServiceAsHtmlGet(C,{strParam:JSON.stringify(E)});$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}};var a=function(D){g(D);var C=contextPath+"/offer/queryOpenedAttachAndServ";$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var B=$.callServiceAsJsonGet(C,{strParam:JSON.stringify(D)});$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var A=function(E,D){g(E);E.isServiceOpen="Y";var C=contextPath+"/pad/offer/queryChangeAttachOffer";if(typeof(D)=="function"){$.callServiceAsHtmlGet(C,{strParam:JSON.stringify(E)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(F){$.unecOverlay();if(F.code==0){if(F.data){D(F.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var B=$.callServiceAsHtmlGet(C,{strParam:JSON.stringify(E)});$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{$.alert("提示","查询附属销售品实例失败,稍后重试");return}}};var v=function(D){g(D);var C=contextPath+"/offer/queryServSpecPost";$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");var B=$.callServiceAsJson(C,D);$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{if(B.code==-2){$.alertM(B.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var v=function(D){g(D);var C=contextPath+"/offer/queryServSpecPost";$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");var B=$.callServiceAsJson(C,D);$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{if(B.code==-2){$.alertM(B.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var w=function(E,D){g(E);E.isServiceOpen="Y";var C=contextPath+"/pad/offer/queryAttachSpec";if(typeof(D)=="function"){$.callServiceAsHtmlGet(C,{strParam:JSON.stringify(E)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(F){if(F.code==0){if(F.data){D(F.data)}}else{if(F.code==-2){$.alertM(F.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var B=$.callServiceAsHtmlGet(C,{strParam:JSON.stringify(E)});$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{if(B.code==-2){$.alertM(B.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");
return}}}};var p=function(E,D){g(E);var C=contextPath+"/offer/queryCanBuyAttachSpec";if(typeof(D)=="function"){$.callServiceAsJsonGet(C,{strParam:JSON.stringify(E)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(F){if(F.code==0){if(F.data){D(F.data)}}else{if(F.code==-2){$.alertM(F.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var B=$.callServiceAsJsonGet(C,{strParam:JSON.stringify(E)});$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{if(B.code==-2){$.alertM(B.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var d=function(D){g(D);var C=contextPath+"/offer/queryDefaultAndRequiredOfferSpec";$.ecOverlay("<strong>查询默认必须可选包中，请稍等...</strong>");var B=$.callServiceAsJsonGet(C,D);$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{if(B.code==-2){$.alertM(B.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var k=function(D){g(D);var C=contextPath+"/offer/queryServSpec";$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");var B=$.callServiceAsJsonGet(C,D);$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{if(B.code==-2){$.alertM(B.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var h=function(D){g(D);var C=contextPath+"/offer/queryExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var B=$.callServiceAsJsonGet(C,{strParam:JSON.stringify(D)});$.unecOverlay();if(B.code==0){return B.data}else{if(B.code==-2){$.alertM(B.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var f=function(D){g(D);var C=contextPath+"/offer/queryServExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var B=$.callServiceAsJsonGet(C,{strParam:JSON.stringify(D)});$.unecOverlay();if(B.code==0){return B.data}else{if(B.code==-2){$.alertM(B.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var l=function(D){g(D);var C=contextPath+"/token/pad/offer/searchAttachOfferSpec";$.ecOverlay("<strong>附属销售品查询中，请稍等...</strong>");var B=$.callServiceAsHtmlGet(C,{strParam:JSON.stringify(D)});$.unecOverlay();if(B.code==0){return B.data}else{if(B.code==-2){$.alertM(B.data)}else{$.alert("提示","查询附属销售失败，请稍后重试！")}}};var e=function(D){var C=contextPath+"/order/checkOperate";$.ecOverlay("<strong>受理权限查询中，请稍等...</strong>");var B=$.callServiceAsJsonGet(C,"");$.unecOverlay();if(B.code==0){return B.data}else{if(B.code==-2){$.alertM(B.data)}else{$.alert("提示","受理权限查询失败，请稍后重试！")}}};var z=function(D){var C=contextPath+"/order/orderSubmit";if(OrderInfo.order.token!=""){C=contextPath+"/order/orderSubmit?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var B=$.callServiceAsHtml(C,D);$.unecOverlay();if(!B||B.code!=0){return}return B.data};var r=function(D){var C=contextPath+"/order/orderSubmitComplete";if(OrderInfo.order.token!=""){C=contextPath+"/order/orderSubmitComplete?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var B=$.callServiceAsJson(C,D);$.unecOverlay();if(!B||B.code!=0){return}return B.data};var x=function(C){var B=query.offer.queryOfferSpec(C);if(B==undefined){return false}if(B.offerRoles==undefined){$.alert("错误提示","销售品规格构成查询: 返回的销售品规格构成结构不对！");return false}if(B.offerSpecId==undefined||B.offerSpecId==""){$.alert("错误提示","销售品规格构成查询: 销售品规格ID未返回，无法继续受理！");return false}if(B.offerRoles.length==0){$.alert("错误提示","销售品规格构成查询: 成员角色为空，无法继续受理！");return false}if(B.feeType==undefined||B.feeType==""||B.feeType=="null"){$.alert("错误提示","无付费类型，无法新装！");return false}B=SoOrder.sortOfferSpec(B);if((OrderInfo.actionFlag==6||OrderInfo.actionFlag==2||OrderInfo.actionFlag==1)&&ec.util.isArray(OrderInfo.oldprodInstInfos)){OrderInfo.oldofferSpec.push({offerSpec:B,accNbr:C.accNbr})}else{OrderInfo.offerSpec=B}return B};var q=function(E,H){var G={offerSpecId:H,partyId:OrderInfo.cust.custId,offerTypeCd:2};if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){G.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}if(OrderInfo.actionFlag==3){G.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId}var F=query.offer.queryOfferSpec(G);if(F==undefined||F.offerRoles==undefined){$.alert("提示","返回的销售品规格构成结构不对！");return false}if(F.offerSpecId==undefined||F.offerSpecId==""){$.alert("提示","销售品规格ID未返回，继续受理将出现异常！");return false}if(F.offerSpecName==undefined||F.offerSpecName==""){$.alert("提示","销售品规格名称未返回，继续受理将出现异常！");return false}var C=[];var D=OrderInfo.getProdSpecId(E);var B=false;$.each(F.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objId==D){B=true;return false}});if(B){C.push(this);return false}});F.offerRoles=C;return F};var o=function(D){var C=contextPath+"/order/prodModify/updateCheckByChange";$.ecOverlay("<strong>正在预校验中，请稍等...</strong>");var B=$.callServiceAsJson(C,D);$.unecOverlay();if(B.code==0){return B.data}else{if(B.code==-2){$.alertM(B.data)}else{if(B.data.resultMsg){$.alert("提示","预校验失败!失败原因为："+B.data.resultMsg)}else{$.alert("提示","预校验失败! 集团营业后台未给出原因。")}}}};var m=function(){if(OrderInfo.order.soNbr==null||OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}if(CONST.getAppDesc()!=0){return true}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){return true}if(order.prodModify==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var B=order.prodModify.choosedProdInfo;if(B==undefined||B.prodInstId==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var F={areaId:OrderInfo.getProdAreaId(B.prodInstId),acctNbr:B.accNbr,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,instId:B.prodInstId,type:"2",queryType:"1,2,3,4,5",acctNbr:"",data:[]};var E=OrderInfo.provinceInfo.mergeFlag;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){var C=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.accessNumber==B.accNbr){C=false;return false}});if(C){if(E!=null&&E!=""&&E!="undefined"&&E=="1"){F.data.push({accessNbr:B.accNbr,instId:B.prodInstId});return c(F)}else{return query.offer.invokeLoadInst(F)}return query.offer.invokeLoadInst(F)}else{var D=true;if(E!=null&&E!=""&&E!="undefined"&&E=="1"){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){F.data.push({accessNbr:this.accessNumber,instId:this.objInstId})}});if(F!=null){if(!c(F)){D=false;return false}}}else{$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){F.acctNbr=this.accessNumber;F.instId=this.objInstId;if(!query.offer.invokeLoadInst(F)){D=false;return false}}})}return D}}else{if(E!=null&&E!=""&&E!="undefined"&&E=="1"){F.data.push({accessNbr:B.accNbr,instId:B.prodInstId});return c(F)}else{return query.offer.invokeLoadInst(F)}}};var g=function(C){C.staffId=OrderInfo.staff.staffId;C.channelId=OrderInfo.staff.channelId;C.areaId=OrderInfo.getProdAreaId(C.prodId);C.partyId=OrderInfo.cust.custId;C.distributorId=OrderInfo.staff.distributorId;if(OrderInfo.actionFlag==3){C.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId}else{if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==C.prodId){C.mainOfferSpecId=this.offerSpecId;return false}})}}else{C.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}}if(ec.util.isObj(OrderInfo.order.soNbr)){C.soNbr=OrderInfo.order.soNbr}if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){C.yslflag=order.ysl.yslbean.yslflag}}if(ec.util.isArray(OrderInfo.oldprodInstInfos)){for(var B=0;B<OrderInfo.oldprodInstInfos.length;B++){if(C.acctNbr==OrderInfo.oldprodInstInfos[B].accNbr){C.areaId=OrderInfo.oldprodInstInfos[B].areaId;C.partyId=OrderInfo.oldprodInstInfos[B].custId;C.mainOfferSpecId=OrderInfo.oldprodInstInfos[B].mainProdOfferInstInfos[0].prodOfferId}}}};var j=function(D){order.prepare.createorderlonger();var C=contextPath+"/offer/loadInst";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var B=$.callServiceAsJsonGet(C,D);
$.unecOverlay();if(B.code==0){return true}else{if(B.code==-2){$.alertM(B.data);return false}else{if(B.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",B.msg)}return false}}};var c=function(D){order.prepare.createorderlonger();var C=contextPath+"/token/pad/offer/loadInstNew";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var B=$.callServiceAsJson(C,JSON.stringify(D));$.unecOverlay();if(B.code==0){return true}else{if(B.code==-2){$.alertM(B.data);return false}else{if(B.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",B.msg)}return false}}};var n=function(E,D){g(E);var C=contextPath+"/token/pad/offer/queryMember";if(typeof(D)=="function"){$.callServiceAsHtmlGet(C,{strParam:JSON.stringify(E)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(F){$.unecOverlay();if(F.code==0){if(F.data){D(F.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var B=$.callServiceAsHtmlGet(C,{strParam:JSON.stringify(E)});$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}};var b=function(D){var C=contextPath+"/order/prodInstParam";$.ecOverlay("<strong>查询产品实例属性中，请稍等...</strong>");var B=$.callServiceAsJson(C,D);$.unecOverlay();if(B.code==0){if(B.data){return B.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};return{queryServSpecPost:v,checkOperate:e,loadInst:m,invokeLoadInst:j,setOffer:t,searchAttachOfferSpec:l,queryOfferSpec:y,queryServSpec:k,queryOfferInst:s,queryOfferParam:i,queryAttachOfferHtml:u,queryChangeAttachOffer:A,queryCanBuyAttachSpec:p,queryExcludeDepend:h,queryServExcludeDepend:f,queryAttachSpec:w,queryMainOfferSpec:x,queryAttachOfferSpec:q,queryDefMustOfferSpec:d,orderSubmit:z,orderSubmitComplete:r,updateCheckByChange:o,queryOpenedAttachAndServ:a,queryMemberHtml:n,queryProdInstParam:b,invokeLoadInstSub:c}})();CommonUtils.regNamespace("order","calcharge");order.calcharge=(function(){var d=[];var H=[];var x=0;var g=0;var p=0;var t=0;var m="newOrder";var E=false;var f=false;var A=function(L,K){if($("#div_payitem_"+L)!=undefined&&$("#div_payitem_"+L).html()!=undefined){var M=$("#div_payitem_"+L).html();var J=$("#paydialog").html();var I=$.popup("#div_payitem_choose_"+L,M,{width:600,height:500,contentHeight:400,afterClose:function(){$("#paydialog").html(J)}});order.calcharge.trObj=K}else{$.alert("提示","没有可添加费用项的业务对象！")}};var G=function(Q,N,K,J,O,P,I,M){var R="0";if(OrderInfo.actionFlag==11){R="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){R="2"}}var L={boId:Q,objInstId:I,prodId:M,boActionTypeCd:N,actionFlag:OrderInfo.actionFlag,objType:K,objId:J,itemNum:p,objName:O,actionName:P,refundType:R};$.callServiceAsHtml(contextPath+"/pad/order/getChargeAddByObjId",L,{before:function(){$.ecOverlay("<strong>正在增加收费项,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(S){if(S.code!=0){$.alert("提示","查询失败,稍后重试");return}$("#div_payitem_choose_"+M).popup("close");B(Q,S.data)},fail:function(S){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var B=function(I,J){if(J!=""){$(order.calcharge.trObj).parent().parent().parent().after(J);var K=$("#order_confirm");$.jqmRefresh(K);p--;w()}else{$.alert("提示","没有可添加的费用项");return}};var h=function(J,L,K){if(K=="old"){var I=$("#feeAmount_"+L).val();if(($("#realAmount_"+L).val())*100==0){$("#realAmount_"+L).val(((I/100).toFixed(2))+"")}else{$("#realAmount_"+L).val("0")}var M=($("#realAmount_"+L).val())*100;if(M!=I){$("#chargeModifyReasonCd_"+L).show()}else{$("#chargeModifyReasonCd_"+L).hide()}}else{$(J).parent().parent().parent().remove()}w()};var w=function(){d=[];H=[];var J=0;$("#calTab li").each(function(){var L=$(this).attr("id");if(L!=undefined&&L!=""){L=L.substr(5,L.length);if($("#paymentAmount_"+L)&&$("#paymentAmount_"+L).val()*1==0){}else{var K=($("#realAmount_"+L).val())*1;if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){K=($("#backAmount_"+L).val())*1}J=J+K;k(L)}}});if(OrderInfo.actionFlag==15){var I=0;$("#calTab li").each(function(){var L=$(this).attr("id");if(L!=undefined&&L!=""){if($("#paymentAmount_"+L)&&$("#paymentAmount_"+L).val()*1==0){}else{L=L.substr(5,L.length);var K=($("#backAmount_"+L).val())*1;I=I+K}}});$("#backAmount").val(Number(I).toFixed(2))}$("#realmoney").html(Number(J).toFixed(2));if(OrderInfo.actionFlag==15){order.refund.conBtns()}else{c()}};var r=function(){var K=true;var J=true;var I=true;$("#calTab li").each(function(){var O=$(this).attr("id");if(O!=undefined&&O!=""){O=O.substr(5,O.length);var P=$("#chargeModifyReasonCd_"+O).val();if(P=="1"){if($("#remark_"+O).val()==undefined||$("#remark_"+O).val()==null||$("#remark_"+O).val()==""){K=false}}var N=$("#payMethodCd_"+O).val();var L=$("#terminalNumber").val();var M=$("#serialNumber").val();if(N=="110101"){if(L==undefined||$.trim(L)==""){I=false}if(M==undefined||$.trim(M)==""){I=false}if(L.length>100){J=false}if(M.length>100){J=false}}}});if(!K){$.alert("提示信息","请填写修改原因");return false}if(!I){$.alert("提示信息","pos流水号或者终端号不能为空，请重新输入！");return false}if(!J){$.alert("提示信息","pos流水号或者终端号长度超过100位，请重新输入！");return false}d=[];i();return true};var i=function(){$("#calTab li").each(function(){var aa=$(this).attr("id");if(aa!=undefined&&aa!=""){aa=aa.substr(5,aa.length);var J=($("#realAmount_"+aa).val())*100+"";var P=$("#feeAmount_"+aa).val();var M="";if(P!=undefined&&P!=""){M=P+""}else{M=J}if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){M=$("#feeAmount_"+aa).val()*1+"";J=(0-($("#backAmount_"+aa).val())*100)+""}var I=$("#acctItemTypeId_"+aa).val();var S=$("#objId_"+aa).val();var U=$("#objType_"+aa).val();var V=$("#acctItemId_"+aa).val();var X=$("#boId_"+aa).val();var L=$("#payMethodCd_"+aa).val();var K=$("#objInstId_"+aa).val();var W=$("#prodId_"+aa).val();var Q=$("#boActionType_"+aa).val();var T=$("#paymentAmount_"+aa).val();var R=1;var Y="";if($("#chargeModifyReasonCd_"+aa).parent(".ui-select").parent().is(":hidden")){if(M!=J){Y="其他"}}else{R=$("#chargeModifyReasonCd_"+aa).val();Y=$("#chargeModifyReasonCd_"+aa).find("option:selected").text();if(R=="1"){Y=$("#remark_"+aa).val()}}if(M!=J&&Y==""){Y="其他"}var Z="";var N="";if(L=="110101"){Z=$("#terminalNumber").val();N=$("#serialNumber").val()}var O={realAmount:J,feeAmount:M,paymentAmount:T,acctItemTypeId:I,objId:S,objType:U,acctItemId:V,boId:X,prodId:W,objInstId:K,payMethodCd:L,terminalNo:Z,posSeriaNbr:N,chargeModifyReasonCd:R,remark:Y,boActionType:Q};d.push(O)}})};var l=function(L,O,N){var J={acctItemTypeId:L};var I=contextPath+"/order/queryPayMethodByItem";var K=$.callServiceAsJson(I,J);if(K.code==0){if(K.data!=undefined&&K.data!=null){if(K.data.length>0){var P=K.data;var Q=false;if(OrderInfo.actionFlag==11){if(P[0].limitChange=="N"){return true}}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){if(P[0].limitBuyBack=="N"){return true}}else{if(OrderInfo.actionFlag==15){if(P[0].limitRedo=="N"){Q=true}}else{if(P[0].limitChange=="N"){Q=true}}}}var R=P[0].payMethods;if(R.length>0){if(O){var M='<select  id="changeMethod_'+O+'"  data-native-menu="false">';$.each(R,function(S,T){if(T.payMethodCd==N){M+='<option value="'+T.payMethodCd+'" selected="selected">'+T.payMethodName+"</option>"}else{M+='<option value="'+T.payMethodCd+'">'+T.payMethodName+"</option>"}});M+="</select>";$("#payMethodText_"+O).html(M);$.jqmRefresh($("#payMethodText_"+O));$("#changeMethod_"+O).selectmenu("refresh")}}return Q}else{return false}}else{return false}}else{if(K.code==-2){$.alertM(K.data);return false}else{$.alert("提示","查询付费方式失败!");return false}}};var b=function(I){if($("#chargeModifyReasonCd_"+I).val()=="1"){$("#chargeModifySpan_"+I).hide();$("#chargeModifySpan_"+I).next(".edit").show()}$("#chargeModifyButton_"+I).on("tap",function(){$(this).parents().find(".edit").hide();$("#chargeModifyReasonCd_"+I+" option").each(function(){if($(this).val()=="3"){$(this).attr("selected",true)}});$("#chargeModifyReasonCd_"+I).selectmenu("refresh");$("#chargeModifySpan_"+I).show()
})};var s=function(J,M,K,L){var I=l(J,M,K);if(I){if(j(M)){$("#chargeModifyReasonCd_"+M).change(function(){if($(this).val()=="1"){$(this).parent(".ui-select").parent().hide().next(".edit").show()}});$("#chargeModifyButton_"+M).on("tap",function(){$(this).parents().find(".edit").hide();$("#chargeModifyReasonCd_"+M+" option").each(function(){if($(this).val()=="3"){$(this).attr("selected",true)}});$("#chargeModifyReasonCd_"+M).selectmenu("refresh");$("#chargeModifySpan_"+M).show()});if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20||OrderInfo.actionFlag==15){$("#backAmount_"+M).removeAttr("disabled").focus();$("#backAmount_"+M).parent().removeClass("ui-state-disabled")}else{$("#realAmount_"+M).removeAttr("disabled").focus();$("#realAmount_"+M).parent().removeClass("ui-state-disabled")}}$("#changeMethod_"+M).off("change").on("change",function(){var N=$(this).val();$("#payMethodCd_"+M).val(N);$("#changeMethod_"+M).selectmenu("refresh");if(N=="110101"){$("#posDiv").css("display","inline");$("#posDiv").css("disabled","")}else{$("#posDiv").css("display","none");$("#posDiv").css("disabled","disabled")}})}$(L).removeAttr("onclick").attr("disabled","disabled")};var j=function(O){var N={};var L=contextPath+"/order/queryAuthenticDataRange";var J=$.callServiceAsJson(L,N);if(J.code==0){var K=J.data;var I=false;for(var M=0;M<K.length;M++){if($("#acctItemTypeId_"+O).val()==K[M].dataDimensionName){I=true;break}else{I=false}}if(I){return true}else{$.alert("提示","当前费用项不允许修改!");return false}}else{if(J.code==-2){$.alertM(J.data);return false}else{$.alert("提示","权限数据范围查询失败!");return false}}};var k=function(M){var S=($("#realAmount_"+M).val())*100+"";var Q=$("#feeAmount_"+M).val();var O="";if(Q!=undefined&&Q!=""){O=Q+""}else{O=S}var P=$("#acctItemTypeId_"+M).val();var J=$("#objId_"+M).val();var L=$("#objType_"+M).val();var R=$("#acctItemId_"+M).val();var N=$("#acctItemTypeName_"+M).val();var I=$("#paymentAmount_"+M).val();var K={realmoney:S,feeAmount:O,paymentAmount:I,acctItemTypeId:P,objId:J,objType:L,acctItemId:R,acctItemTypeName:N};H.push(K)};var v=function(M,O,N){var J=$.trim($(M).val());if(J==""){$(M).val("0");order.calcharge.reflashTotal()}else{if(N=="old"){var L=$("#feeAmount_"+O).val();var I=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(J)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");I=false}else{if((J*100>L*1)&&L>0){$.alert("提示","实收费用金额不能高于应收金额！");I=false}else{if((J*100<L*1)&&L<0){$.alert("提示","实收费用金额不能低于应收金额！");I=false}}}if(I){var P=($(M).val())*100;if(P!=L){$("#chargeModifySpan_"+O).show()}else{$("#chargeModifySpan_"+O).hide();$("#chargeModifySpan_"+O).next(".edit").hide()}w()}else{if(t!=""){$(M).val(t)}t=""}}else{if(N=="undo"){var I=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(J)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");I=false}else{if(J<0){$.alert("提示","退费金额不能为负值！");I=false}else{var L=$("#realhidden_"+O).val();var K=J*-1;if(K<L*1){$.alert("提示","退费金额不能高于实收金额！");I=false}}}if(I){var P=($(M).val())*-1;if(P!=0){$("#chargeModifySpan_"+O).show()}else{$("#chargeModifySpan_"+O).hide();$("#chargeModifySpan_"+O).next(".edit").hide()}w()}else{if(t!=""){$(M).val(t)}t=""}}else{if(N=="new"){if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(J)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");if(t!=""){$(M).val(t)}t=""}else{if(J<0){$.alert("提示","实收费用金额不能为负值！")}else{w()}}}}}}};var D=function(I){t=$.trim($(I).val())};var y=function(){$("#toCharge").attr("disabled","disabled");$("#toComplate").attr("disabled","disabled");$("#orderCancel").attr("disabled","disabled");$("#orderCancel").off("tap");$("#toComplate").off("tap");$("#toCharge").off("tap")};var c=function(){$("#orderCancel").removeAttr("disabled");var I=$.trim($("#realmoney").html())*1;if(OrderInfo.actionFlag==11){$("#orderCancel").off("tap").on("tap",function(J){order.undo.orderBack()})}else{$("#orderCancel").off("tap").on("tap",function(J){SoOrder.orderBack()})}if(!E){if(I!=0){$("#toCharge").removeAttr("disabled");$("#toCharge").parent().removeClass("ui-state-disabled");$("#toComplate").attr("disabled","disabled");$("#toCharge").off("tap").on("tap",function(J){o("1")});$("#toComplate").off("tap")}else{$("#toCharge").attr("disabled","disabled");$("#toComplate").removeAttr("disabled");$("#toCharge").off("tap");$("#toComplate").off("tap").on("tap",function(J){F("0",false)})}}else{$("#toCharge").removeAttr("disabled");$("#toComplate").attr("disabled","disabled");$("#toCharge").off("tap");$("#toComplate").off("tap")}};var o=function(I){y();if(E){$.alert("提示","订单已经建档成功,不能重复操作!");return}if(f){return}if(!r()){c();return}f=true;var J=contextPath+"/order/updateChargeInfoForCheck";var K={olId:x,soNbr:OrderInfo.order.soNbr,areaId:OrderInfo.staff.areaId,chargeItems:d,custId:OrderInfo.cust.custId};$.callServiceAsJson(J,K,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(L){if(L.code==0){F(I,true)}else{if(L.code==-2){c();f=false;$.alertM(L.data)}else{c();f=false;if(L.data!=undefined){$.alert("提示",L.data)}else{$.alert("提示","代理商保证金校验失败!")}}}}})};var q=function(M){var K=contextPath+"/order/checkRuleToProv";var N={olId:M.rolId,soNbr:M.rsoNbr,areaId:OrderInfo.staff.areaId,chargeItems:[]};$.ecOverlay("<strong>正在下省校验,请稍等会儿....</strong>");var J=$.callServiceAsJson(K,N);$.unecOverlay();var I;if(J.code==0){var L=J.data;if(L.checkResult!=undefined){OrderInfo.checkresult=L.checkResult}I={code:0}}else{I={code:1,data:J.data}}return I};var F=function(R,Q){if(!Q){y();if(E){$.alert("提示","订单已经建档成功,不能重复操作!");return}if(f){return}if(!r()){c();return}f=true}var N={olId:x,soNbr:OrderInfo.order.soNbr,areaId:OrderInfo.staff.areaId,chargeItems:d};var J=contextPath+"/token/pad/order/chargeSubmit?token="+OrderInfo.order.token;var O=$.callServiceAsJson(J,N,{});var L="";if(O.code==0){E=true;SoOrder.delOrderFin();if(OrderInfo.actionFlag==31){var J=contextPath+"/cust/passwordReset";var P=$.callServiceAsJson(J,null,{})}if(R=="1"){if(OrderInfo.actionFlag==11){L="退费成功"}else{L="收费成功"}}else{L="受理成功"}$("#orderCancel").removeAttr("disabled");$("#printVoucherA").attr("disabled","disabled");$(".ui-icon-plus").remove();$(".ui-icon-gear").remove();$(".ui-icon-delete").remove();$("#calTab li").each(function(){var T=$(this).attr("id");if(T!=undefined&&T!=""){T=T.substr(5,T.length);if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20||OrderInfo.actionFlag==15){$("#backAmount_"+T).attr("disabled","disabled");$("#backAmount_"+T).parent().addClass("ui-state-disabled")}else{$("#realAmount_"+T).attr("disabled","disabled");$("#realAmount_"+T).parent().addClass("ui-state-disabled")}}});if(OrderInfo.actionFlag==11){$("#orderCancel").html("<span>返回首页</span>");$("#orderCancel").off("tap").on("tap",function(T){order.undo.toUndoMain(1)})}else{var K=OrderInfo.provinceInfo.redirectUri;if(K!=null&&K!=undefined&&K!=""){$("#orderCancel").html("返回省份");$("#orderCancel").off("click").on("click",function(T){n()})}else{$("#orderCancel").hide();$("#ordermessage").show();$("#ordermessage").html("订单已"+L)}}SoOrder.updateResState();if(R=="1"){var S=($("#realmoney").html())*1;if(S>0){var M={soNbr:OrderInfo.order.soNbr,billType:0,olId:x,printFlag:-1,areaId:OrderInfo.staff.areaId,acctItemIds:[]};var I=common.print.initPrintInfo(M);if(!I){return}$.confirm("信息提示","收费成功，是否打印发票?",{names:["是","否"],yesdo:function(){var T={soNbr:OrderInfo.order.soNbr,billType:0,olId:x,printFlag:0,areaId:OrderInfo.staff.areaId,acctItemIds:[]};common.print.prepareInvoiceInfo(T);return},no:function(){var T=OrderInfo.provinceInfo.redirectUri;if(T!=null&&T!=undefined&&T!=""){n()}}})}else{e(R,L)}}else{e(R,L)}return}else{if(O.code==-2){c();SoOrder.getToken();f=false;$.alertM(O.data)}else{c();SoOrder.getToken();f=false;if(O.data!=undefined){$.alert("提示",O.data)}else{$.alert("提示","费用信息提交失败!")}}}};var e=function(J,N){var M="";if(J=="1"){if(OrderInfo.actionFlag==11){M="退费结果"}else{M="收费结果"}}else{M="受理结果"}$("#payresultitle").html(M);$("#payresultMsg").html(N);var L=$("#div_payresult").html();var K=$("#paydialog").html();var I=$.popup("#div_payresult_choose",L,{width:400,height:270,contentHeight:150,afterClose:function(){$("#paydialog").html(K);
order.cust.mgr.custReset()}});var O=OrderInfo.provinceInfo.redirectUri;if(O!=null&&O!=""&&O!=undefined){$("#successTip_dialog_comfirm").show();$("#successTip_dialog_comfirm").off("click").on("click",function(P){n()})}if(J=="1"){if(OrderInfo.actionFlag==11){$("#successTip_dialog_inv").show();$("#successTip_dialog_inv").off("tap").on("tap",function(P){u()})}}};var C=function(K,J){var I=$("#payMethodCd_"+K);I.empty();$("select[@id=backpayMethodCd_"+K+"] option").each(function(){var M=$(this).val();if(M!=undefined){var L=$(this).text();if(M.split("_")[1]==$(J).val()){$("<option value='"+M.split("_")[0]+"'>"+L+"</option>").appendTo(I)}}})};var a=function(){window.location.reload()};var z=function(){$("#step1").hide();$("#step2").hide();$("#step3").show();x=OrderInfo.orderResult.olId;g=OrderInfo.orderResult.soNbr;d=[];H=[];p=0;t=0;E=false;f=false;var I="0";if(OrderInfo.actionFlag==11){I="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){I="2"}}var J={olId:x,custVipLevel:OrderInfo.cust.vipLevel,actionFlag:OrderInfo.actionFlag,actionTypeName:encodeURI(OrderInfo.actionTypeName),businessName:encodeURI(OrderInfo.businessName),olNbr:OrderInfo.orderResult.olNbr,soNbr:OrderInfo.order.soNbr,refundType:I,checkResult:JSON.stringify(OrderInfo.checkresult)};$.callServiceAsHtmlGet(contextPath+"/token/pad/order/getChargeList",J,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){},done:function(K){if(K.code!=0){$.alert("提示","收费页面加载失败，请稍后重试");return}SoOrder.getToken();$.unecOverlay();if(OrderInfo.provinceInfo.isFee=="1"){SoOrder.delOrderFin();var N=OrderInfo.provinceInfo.redirectUri;if(N==null||N==""||N==undefined){$.Zebra_Dialog("<div style='width:100%;font-size:15px;'>订单暂存成功</div>",{open_speed:0,keyboard:false,modal:true,overlay_close:false,overlay_opacity:0.5,type:"information",title:"提示",buttons:[]});return}$.alert("提示","订单暂存成功");n()}else{if(OrderInfo.provinceInfo.isFee=="2"){var M=$("#order_confirm").html(K.data).fadeIn();var L=$("#paydialog").html();$("#paydialog").html("");$.jqmRefresh(M);$("#paydialog").html(L);$.each($(".cashier_dd"),function(){var O=$(this).attr("id");var P=$(this);if($.trim($(this).html())==""&&$(".userorderlist")!=undefined){$.each($("#userorderlist li").find("dl:eq(0)"),function(){var R=$(this).attr("prodInstId");var S=$(this).attr("accNbr");var Q=$(this).attr("productName");if(R!=undefined&&S!=undefined){if(O==R){P.html(Q+"&nbsp;-&nbsp;"+S)}}})}});$("#printVoucherA").off("tap").on("tap",function(O){if(!r()){return}var P={olId:x,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:d,areaId:OrderInfo.getAreaId()};common.print.signVoucher(P)});w()}}},fail:function(K){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var u=function(){var I={olId:OrderInfo.order.oldSoId,soNbr:OrderInfo.order.oldSoNbr};$.callServiceAsHtmlGet(contextPath+"/order/invaideInvoice",I,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(J){if(J.code==0){var K=$.parseJSON(J.data);if(K.code==0){$("#successTip_dialog_inv").off("tap");$.alert("提示","作废发票成功！")}else{if(K.code==1){$.alert("提示","作废发票失败！")}else{if(K.code==2){$.alert("提示","未获取到发票信息！")}else{if(K.code==3){$.alert("提示","获取发票失败！")}else{$.alert("提示","作废发票异常！")}}}}}else{if(J.code==-2){}else{$.alert("提示","作废发票异常！")}}},fail:function(J){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var n=function(){var I={provIsale:OrderInfo.provinceInfo.provIsale,extCustOrderID:OrderInfo.orderResult.olId,resultCode:"0",redirectUri:OrderInfo.provinceInfo.redirectUri};$.callServiceAsHtmlGet(contextPath+"/mode/pad/backProvince",I,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(J){if(J.code==0){var K=$.parseJSON(J.data);if(K.code==0){if(K.data.indexOf("&amp;")!=-1){K.data=K.data.replace(/\&amp;/g,"&")}window.location.href=K.data;return}else{if(K.code==1){$.alert("提示",K.data)}}}else{$.alert("提示","页面回调异常！")}},fail:function(J){$.unecOverlay();$.alert("提示","页面回调可能发生异常，请稍后再试！")}})};return{addItems:B,delItems:h,reflashTotal:w,editMoney:v,setGlobeMoney:D,addbusiOrder:A,addSubmit:G,selePaymethod:C,calchargeInit:z,pageFlag:m,changePayMethod:s,bindChargeModifyReason:b,invaideInvoice:u,tochargeSubmit:q,backToProvince:n}})();CommonUtils.regNamespace("order","main");order.main=(function(){var m=function(W){if(W==undefined||!W){W=e()}if(order.memberChange.newMemberFlag&&OrderInfo.actionFlag==6){var V=false;if(W.feeTypeMain=="2100"&&(W.offerSpec.feeType=="2100"||W.offerSpec.feeType=="3100"||W.offerSpec.feeType=="3101"||W.offerSpec.feeType=="3103")){V=true}else{if(W.feeTypeMain=="1200"&&(W.offerSpec.feeType=="1200"||W.offerSpec.feeType=="3100"||W.offerSpec.feeType=="3102"||W.offerSpec.feeType=="3103")){V=true}else{if(W.feeTypeMain=="1201"&&(W.offerSpec.feeType=="1201"||W.offerSpec.feeType=="3101"||W.offerSpec.feeType=="3102"||W.offerSpec.feeType=="3103")){V=true}}}if(!V){$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");return}}$.callServiceAsHtml(contextPath+"/token/pad/order/main",W,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(X){if(!X){X.data="查询失败,稍后重试"}if(X.code!=0){$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=W.actionFlag;if(OrderInfo.actionFlag==2){offerChange.fillOfferChange(X,W);$.jqmRefresh($("#order_fill_content"))}else{if(OrderInfo.actionFlag==6){v(X,W);$.jqmRefresh($("#order_fill_content"))}else{if(OrderInfo.actionFlag==1){J(X,W)}else{B(X,W)}}}},always:function(){$.unecOverlay()}})};var J=function(X,W){order.prepare.showOrderTitle(OrderInfo.actionTypeName,W.offerSpecName,false);SoOrder.initFillPage();var Y=$("#order_fill").html(X.data).fadeIn();$.jqmRefresh(Y);C();n(W);if(W.actionFlag==""){OrderInfo.actionFlag=1}mktRes.phoneNbr.initOffer("-1");g(W);if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==13||OrderInfo.actionFlag==14){$("#acctName").val(OrderInfo.cust.partyName);order.dealer.initDealer()}$("#fillNextStep").off("click").on("click",function(){SoOrder.submitOrder()});if(W.memberChange){$("#orderedprod").hide();$("#order_prepare").hide();$("#productDiv .pdcardcon:first").show();order.prepare.step(1);$("#fillLastStep").off("click").on("click",function(){order.prodModify.cancel()})}else{$("#fillLastStep").off("click").on("click",function(){t()})}if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""){var W={phoneNum:"",prodId:""};W.phoneNum=OrderInfo.newOrderNumInfo.mainPhoneNum;W.prodId="-1";var af=mktRes.phoneNbr.queryPhoneNumber(W);if(af==undefined||af.datamap.undefined||af.datamap.baseInfo==undefined){$("#choosedNum_-1").val("");$("#btn_choosedNum_-1").removeAttr("onclick")}else{if(af&&af.datamap.baseInfo!=undefined){var ab={prodId:W.prodId,accessNumber:af.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:af.datamap.baseInfo.phoneNumId,pnLevelId:af.datamap.baseInfo.phoneLevelId,anTypeCd:af.datamap.baseInfo.pnTypeId,state:"ADD",areaId:af.datamap.baseInfo.areaId,areaCode:af.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:af.datamap.baseInfo.prePrice,minCharge:af.datamap.baseInfo.pnPrice,idFlag:"1"};if(W.prodId&&W.prodId=="-1"){ab.memberRoleCd=CONST.MEMBER_ROLE_CD.MAIN_CARD}$("#choosedNum_-1").val(OrderInfo.newOrderNumInfo.mainPhoneNum);$("#btn_choosedNum_-1").removeAttr("onclick");OrderInfo.boProdAns.push(ab)}}}if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""){var W={phoneNum:"",prodId:""};var ae=$("input[id^='choosedNum_']");var aa=OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");var V=[];$.each(ae,function(){if($(this).attr("id")!="choosedNum_-1"){V.push(this)}});$.each(V,function(ag,aj){W.phoneNum=aa[ag];W.prodId=-2-ag;var ah=mktRes.phoneNbr.queryPhoneNumber(W);if(ah==undefined||ah.datamap.undefined||ah.datamap.baseInfo==undefined){$(aj).val("");$("#btn_choosedNum_"+W.prodId).removeAttr("onclick")}else{if(ah&&ah.datamap.baseInfo!=undefined){var ai={prodId:W.prodId,accessNumber:ah.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:ah.datamap.baseInfo.phoneNumId,pnLevelId:ah.datamap.baseInfo.phoneLevelId,anTypeCd:ah.datamap.baseInfo.pnTypeId,state:"ADD",areaId:ah.datamap.baseInfo.areaId,areaCode:ah.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:ah.datamap.baseInfo.prePrice,minCharge:ah.datamap.baseInfo.pnPrice,idFlag:"1"};
if(W.prodId&&W.prodId!="-1"){ai.memberRoleCd=CONST.MEMBER_ROLE_CD.VICE_CARD}$(aj).val(aa[ag]);$("#btn_choosedNum_"+W.prodId).removeAttr("onclick");OrderInfo.boProdAns.push(ai)}}})}if(OrderInfo.actionFlag&&OrderInfo.actionFlag=="1"){var ac=$("div[id^='uimDiv_']");$.each(ac,function(ag,ai){var ah=$(ai).attr("id");if(ah.indexOf("-")!=-1){$(ai).show()}})}p();if(OrderInfo.acct&&OrderInfo.acct.acctCd!=null&&OrderInfo.acct.acctCd!=""){E()}if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){$("#dealerTbody").empty();var ad=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;$.each(ad,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){var aD=this.busiObj.instId;var aG=this.busiObj.accessNumber;var az=this.data.bo2Coupons[0].terminalCode;var ax=this.data.boProdFeeTypes[0].feeType;var aN=this.data.boProdPasswords[0].prodPwTypeCd;var aj=this.data.boProdPasswords[0].pwd;var al="20";if(this.data.boProdItems&&this.data.boProdItems[0].itemSpecId){var aB=this.data.boProdItems[0].itemSpecId;if(aB=="40010030"){al=this.data.boProdItems[0].value}var ar={};ar.itemSpecId=aB;ar.prodId=aD;ar.isCheckMask=al;OrderInfo.reloadProdInfo.checkMaskList.push(ar);$("#"+aB+"_"+aD+"").find("option[value='"+al+"']").attr("selected","selected")}$("#choosedNum_"+aD).val(aG);var aw={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};OrderInfo.boProdAns.push(aw);OrderInfo.reloadProdInfo.feeType=ax;$("#idtype").find("option[value='"+ax+"']").attr("selected","selected");$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);var aq={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};OrderInfo.clearProdUim(this.busiObj.instId);OrderInfo.boProd2Tds.push(aq)}if(this.boActionType.actionClassCd!=1300&&this.boActionType.boActionTypeCd!="1"){if(this.data.busiOrderAttrs!=undefined){var ag=[];var aL={};var aJ={};var aH={};var ay=this.busiObj.objId;var aG=this.busiObj.accessNumber;var aF=this;$.each(this.data.busiOrderAttrs,function(){if(this.role=="40020005"){aL.role=this.role;aL.offerSpecId=ay;aL.accessNumber=aG;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aL.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aL.staffname=this.value}}if(aF.busiObj.objName!=undefined){aL.objName=aF.busiObj.objName}if(aF.boActionType.actionClassCd==1200&&aF.boActionType.boActionTypeCd=="S1"){if(aF.data.ooRoles&&aF.data.ooRoles[0].prodId){aL.prodId=aF.data.ooRoles[0].prodId}}}else{if(this.role=="40020006"){aJ.role=this.role;aJ.offerSpecId=ay;aJ.accessNumber=aG;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aJ.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aJ.staffname=this.value}}if(aF.busiObj.objName!=undefined){aJ.objName=aF.busiObj.objName}if(aF.boActionType.actionClassCd==1200&&aF.boActionType.boActionTypeCd=="S1"){if(aF.data.ooRoles&&aF.data.ooRoles[0].prodId){aJ.prodId=aF.data.ooRoles[0].prodId}}}else{if(this.role=="40020007"){aH.role=this.role;aH.offerSpecId=ay;aH.accessNumber=aG;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aH.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aH.staffname=this.value}}if(aF.busiObj.objName!=undefined){aH.objName=aF.busiObj.objName}if(aF.boActionType.actionClassCd==1200&&aF.boActionType.boActionTypeCd=="S1"){if(aF.data.ooRoles&&aF.data.ooRoles[0].prodId){aJ.prodId=aF.data.ooRoles[0].prodId}}}}}});if(ec.util.isObj(aL.role)){ag.push(aL)}if(ec.util.isObj(aJ.role)){ag.push(aJ)}if(ec.util.isObj(aH.role)){ag.push(aH)}var aA="";if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.instId=="-1"){for(var aO=0;aO<ag.length;aO++){var aA=ag[aO].offerSpecId;var av=$("<li id='tr_"+aA+"' name='tr_"+aA+"'></li>");var ah=$("<dl></dl>");var at=$("<dd> </dd>");var aE=$('<fieldset data-role="fieldcontain"></fieldset>');if(aO==0){OrderInfo.SEQ.dealerSeq=OrderInfo.SEQ.dealerSeq-1}var aC=aA+"_"+OrderInfo.SEQ.dealerSeq;var aM=$('<select id="dealerType_'+aC+'" name="dealerType_'+aA+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+aA+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(ag[aO].role==this.PARTYPRODUCTRELAROLECD){aM.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}else{aM.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});aE.append(aM);at.append(aE);var ap="主套餐";ah.append("<dd>"+ap+"</dd>");ah.append("<dd>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</dd>");ah.append(at);var ai=$('<dd><input type="text" id="dealer_'+aC+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');ah.append(ai);var au='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';au+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+aC+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';if(aO==0){au+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+aA+',1)" class="ui-btn ui-shadow ui-corner-all ui-mini">添加</button></div></div></dd>'}else{au+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.removeDealer(this);" class="ui-btn ui-shadow ui-corner-all ui-mini">删除</button></div></div></dd>'}ah.append(au);var ao=$("<dd></dd>");var am=$('<select id="dealerChannel_'+aC+'" name="dealerChannel_'+aA+'" class="inputWidth183px" onclick=a=this.value;></select>');if(OrderInfo.provinceInfo.reloadFlag=="N"){var aP=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;var aQ="";for(var aK=0;aK<aP.length;aK++){if(aP[aK].boActionType.actionClassCd=="1200"&&aP[aK].boActionType.boActionTypeCd=="S1"&&aP[aK].busiObj.offerTypeCd=="1"){var ak=aP[aK].data.busiOrderAttrs;for(var aI=0;aI<ak.length;aI++){if(ak[aI].channelNbr!=undefined){aQ=ak[aI].channelNbr;break}}}}for(var aK=0;aK<OrderInfo.channelList.length;aK++){if(OrderInfo.channelList[aK].channelNbr==aQ){am.append("<option value='"+OrderInfo.channelList[aK].channelNbr+"' selected ='selected'>"+OrderInfo.channelList[aK].channelName+"</option>")}else{am.append("<option value='"+OrderInfo.channelList[aK].channelNbr+"'>"+OrderInfo.channelList[aK].channelName+"</option>")}}}ao.append(am);ao.append('<label class="f_red">*</label>');ah.append(ao);
av.append(ah);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(av);$.jqmRefresh($("#dealerTbody"))}}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.instId!="-1"){for(var aO=0;aO<ag.length;aO++){var aA=ag[aO].prodId+"_"+ag[aO].offerSpecId;var av=$("<li id='tr_"+aA+"' name='tr_"+aA+"'></li>");var ah=$("<dl></dl>");var at=$("<dd> </dd>");var aE=$('<fieldset data-role="fieldcontain"></fieldset>');var aC=aA+"_"+OrderInfo.SEQ.dealerSeq;var aM=$('<select id="dealerType_'+aC+'" name="dealerType_'+aA+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+aA+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(ag[aO].role==this.PARTYPRODUCTRELAROLECD){aM.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}else{aM.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});aE.append(aM);at.append(aE);var ap=ag[aO].accessNumber;ah.append("<dd>"+ap+"</dd>");ah.append("<dd>"+ag[aO].objName+"</dd>");ah.append(at);var ai=$('<dd><input type="text" id="dealer_'+aC+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');ah.append(ai);var au="";if(aO==0){au='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';au+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+aC+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';au+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+aA+'\')" class=" ui-btn ui-shadow ui-corner-all ui-mini">添加</button></div>'}else{au='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';au+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+aC+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>'}au+='<div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);" class=" ui-btn ui-shadow ui-corner-all ui-mini">删除</button></div></div></dd>';ah.append(au);av.append(ah);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(av);$("#dealerType_"+aC).selectmenu().selectmenu("refresh");$("#dealer_"+aC).textinput()}}}}}if(this.data.boAccountRelas!=undefined){var an=this.data.boAccountRelas[0].acctId;$("#acctSelect").find("option[value="+an+"]").attr("selected","selected");$("#order_remark").text(OrderInfo.reloadProdInfo.orderMark)}});order.main.newProdReload();var Z=OrderInfo.reloadOrderInfo.orderList.orderListInfo.custOrderAttrs;$.each(Z,function(){if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){OrderInfo.reloadProdInfo.orderMark=this.value}});$.each(AttachOffer.openList,function(){var ag=this;$.each(this.specList,function(){var ai=this;var ah=false;$.each(ad,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){if(this.busiObj.objId==ai.offerSpecId){ah=true;return false}}});if(!ah){AttachOffer.delOfferSpecReload(ag.prodId,this.offerSpecId)}})});$.each(AttachOffer.openServList,function(){var ag=this;$.each(this.servSpecList,function(){var ai=this;var ah=false;$.each(ad,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(ai.servSpecId==this.data.boServOrders[0].servSpecId&&ag.prodId==this.busiObj.instId){ah=true;return false}}});if(!ah){AttachOffer.closeServSpecReload(ag.prodId,this.servSpecId,this.servSpecName,this.ifParams)}})})}};var B=function(X,W){order.prepare.showOrderTitle(OrderInfo.actionTypeName,W.offerSpecName,false);SoOrder.initFillPage();var Y=$("#order_fill").html(X.data).fadeIn();$.jqmRefresh(Y);C();n(W);if(W.actionFlag==""){OrderInfo.actionFlag=1}mktRes.phoneNbr.initOffer("-1");g(W);if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==13||OrderInfo.actionFlag==14){$("#acctName").val(OrderInfo.cust.partyName);order.dealer.initDealer()}$("#fillNextStep").off("click").on("click",function(){SoOrder.submitOrder()});if(W.memberChange){$("#orderedprod").hide();$("#order_prepare").hide();$("#productDiv .pdcardcon:first").show();order.prepare.step(1);$("#fillLastStep").off("click").on("click",function(){order.prodModify.cancel()})}else{$("#fillLastStep").off("click").on("click",function(){t()})}if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""){var W={phoneNum:"",prodId:""};W.phoneNum=OrderInfo.newOrderNumInfo.mainPhoneNum;W.prodId="-1";var af=mktRes.phoneNbr.queryPhoneNumber(W);if(af==undefined||af.datamap.undefined||af.datamap.baseInfo==undefined){$("#choosedNum_-1").val("");$("#btn_choosedNum_-1").removeAttr("onclick")}else{if(af&&af.datamap.baseInfo!=undefined){var ab={prodId:W.prodId,accessNumber:af.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:af.datamap.baseInfo.phoneNumId,pnLevelId:af.datamap.baseInfo.phoneLevelId,anTypeCd:af.datamap.baseInfo.pnTypeId,state:"ADD",areaId:af.datamap.baseInfo.areaId,areaCode:af.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:af.datamap.baseInfo.prePrice,minCharge:af.datamap.baseInfo.pnPrice,idFlag:"1"};if(W.prodId&&W.prodId=="-1"){ab.memberRoleCd=CONST.MEMBER_ROLE_CD.MAIN_CARD}$("#choosedNum_-1").val(OrderInfo.newOrderNumInfo.mainPhoneNum);$("#btn_choosedNum_-1").removeAttr("onclick");OrderInfo.boProdAns.push(ab)}}}if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""){var W={phoneNum:"",prodId:""};var ae=$("input[id^='choosedNum_']");var aa=OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");var V=[];$.each(ae,function(){if($(this).attr("id")!="choosedNum_-1"){V.push(this)}});$.each(V,function(ag,aj){W.phoneNum=aa[ag];W.prodId=-2-ag;var ah=mktRes.phoneNbr.queryPhoneNumber(W);if(ah==undefined||ah.datamap.undefined||ah.datamap.baseInfo==undefined){$(aj).val("");$("#btn_choosedNum_"+W.prodId).removeAttr("onclick")}else{if(ah&&ah.datamap.baseInfo!=undefined){var ai={prodId:W.prodId,accessNumber:ah.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:ah.datamap.baseInfo.phoneNumId,pnLevelId:ah.datamap.baseInfo.phoneLevelId,anTypeCd:ah.datamap.baseInfo.pnTypeId,state:"ADD",areaId:ah.datamap.baseInfo.areaId,areaCode:ah.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:ah.datamap.baseInfo.prePrice,minCharge:ah.datamap.baseInfo.pnPrice,idFlag:"1"};if(W.prodId&&W.prodId!="-1"){ai.memberRoleCd=CONST.MEMBER_ROLE_CD.VICE_CARD}$(aj).val(aa[ag]);$("#btn_choosedNum_"+W.prodId).removeAttr("onclick");OrderInfo.boProdAns.push(ai)}}})}if(OrderInfo.actionFlag&&OrderInfo.actionFlag=="1"){var ac=$("div[id^='uimDiv_']");$.each(ac,function(ag,ah){$(ah).show()})}p();if(OrderInfo.acct&&OrderInfo.acct.acctCd!=null&&OrderInfo.acct.acctCd!=""){E()}if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){$("#dealerTbody").empty();var ad=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;$.each(ad,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){var ay=this.busiObj.instId;var ao=this.busiObj.accessNumber;var aI=this.data.bo2Coupons[0].terminalCode;var at=this.data.boProdFeeTypes[0].feeType;var aH=this.data.boProdPasswords[0].prodPwTypeCd;var al=this.data.boProdPasswords[0].pwd;var au="20";if(this.data.boProdItems&&this.data.boProdItems[0].itemSpecId){var aG=this.data.boProdItems[0].itemSpecId;if(aG=="40010030"){au=this.data.boProdItems[0].value}var aC={};aC.itemSpecId=aG;aC.prodId=ay;aC.isCheckMask=au;OrderInfo.reloadProdInfo.checkMaskList.push(aC);$("#"+aG+"_"+ay+"").find("option[value='"+au+"']").attr("selected","selected")}$("#choosedNum_"+ay).val(ao);var aA={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};
OrderInfo.boProdAns.push(aA);OrderInfo.reloadProdInfo.feeType=at;$("#idtype").find("option[value='"+at+"']").attr("selected","selected");$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);var an={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};OrderInfo.clearProdUim(this.busiObj.instId);OrderInfo.boProd2Tds.push(an)}if(this.boActionType.actionClassCd!=1300&&this.boActionType.boActionTypeCd!="1"){if(this.data.busiOrderAttrs!=undefined){var aJ=[];var am={};var ak={};var ai={};var aj=this.busiObj.objId;var ao=this.busiObj.accessNumber;var ar=this;$.each(this.data.busiOrderAttrs,function(){if(this.role=="40020005"){am.role=this.role;am.offerSpecId=aj;am.accessNumber=ao;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){am.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){am.staffname=this.value}}if(ar.busiObj.objName!=undefined){am.objName=ar.busiObj.objName}if(ar.boActionType.actionClassCd==1200&&ar.boActionType.boActionTypeCd=="S1"){if(ar.data.ooRoles&&ar.data.ooRoles[0].prodId){am.prodId=ar.data.ooRoles[0].prodId}}}else{if(this.role=="40020006"){ak.role=this.role;ak.offerSpecId=aj;ak.accessNumber=ao;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){ak.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){ak.staffname=this.value}}if(ar.busiObj.objName!=undefined){ak.objName=ar.busiObj.objName}if(ar.boActionType.actionClassCd==1200&&ar.boActionType.boActionTypeCd=="S1"){if(ar.data.ooRoles&&ar.data.ooRoles[0].prodId){ak.prodId=ar.data.ooRoles[0].prodId}}}else{if(this.role=="40020007"){ai.role=this.role;ai.offerSpecId=aj;ai.accessNumber=ao;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){ai.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){ai.staffname=this.value}}if(ar.busiObj.objName!=undefined){ai.objName=ar.busiObj.objName}if(ar.boActionType.actionClassCd==1200&&ar.boActionType.boActionTypeCd=="S1"){if(ar.data.ooRoles&&ar.data.ooRoles[0].prodId){ak.prodId=ar.data.ooRoles[0].prodId}}}}}});if(ec.util.isObj(am.role)){aJ.push(am)}if(ec.util.isObj(ak.role)){aJ.push(ak)}if(ec.util.isObj(ai.role)){aJ.push(ai)}var ag="";if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.instId=="-1"){for(var aF=0;aF<aJ.length;aF++){var ag=aJ[aF].offerSpecId;var aq=$("<li id='tr_"+ag+"' name='tr_"+ag+"'></li>");var ax=$("<dl></dl>");var aw=$("<dd> </dd>");var az=$('<fieldset data-role="fieldcontain"></fieldset>');if(aF==0){OrderInfo.SEQ.dealerSeq=OrderInfo.SEQ.dealerSeq-1}var ap=ag+"_"+OrderInfo.SEQ.dealerSeq;var aD=$('<select id="dealerType_'+ap+'" name="dealerType_'+ag+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+ag+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(aJ[aF].role==this.PARTYPRODUCTRELAROLECD){aD.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}else{aD.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});az.append(aD);aw.append(az);var aB="主套餐";ax.append("<dd>"+aB+"</dd>");ax.append("<dd>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</dd>");ax.append(aw);var aE=$('<dd><input type="text" id="dealer_'+ap+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');ax.append(aE);var ah='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';ah+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+ap+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';if(aF==0){ah+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+ag+',1)" class="ui-btn ui-shadow ui-corner-all ui-mini">添加</button></div></div></dd>'}else{ah+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.removeDealer(this);" class="ui-btn ui-shadow ui-corner-all ui-mini">删除</button></div></div></dd>'}ax.append(ah);aq.append(ax);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(aq);$("#dealerType_"+ap).selectmenu().selectmenu("refresh");$("#dealer_"+ap).textinput()}}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.instId!="-1"){for(var aF=0;aF<aJ.length;aF++){var ag=aJ[aF].prodId+"_"+aJ[aF].offerSpecId;var aq=$("<li id='tr_"+ag+"' name='tr_"+ag+"'></li>");var ax=$("<dl></dl>");var aw=$("<dd> </dd>");var az=$('<fieldset data-role="fieldcontain"></fieldset>');var ap=ag+"_"+OrderInfo.SEQ.dealerSeq;var aD=$('<select id="dealerType_'+ap+'" name="dealerType_'+ag+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+ag+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(aJ[aF].role==this.PARTYPRODUCTRELAROLECD){aD.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}else{aD.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});az.append(aD);aw.append(az);var aB=aJ[aF].accessNumber;ax.append("<dd>"+aB+"</dd>");ax.append("<dd>"+aJ[aF].objName+"</dd>");ax.append(aw);var aE=$('<dd><input type="text" id="dealer_'+ap+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');ax.append(aE);var ah="";if(aF==0){ah='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';ah+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+ap+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';ah+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+ag+'\')" class=" ui-btn ui-shadow ui-corner-all ui-mini">添加</button></div>'}else{ah='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';ah+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+ap+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>'}ah+='<div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);" class=" ui-btn ui-shadow ui-corner-all ui-mini">删除</button></div></div></dd>';ax.append(ah);aq.append(ax);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(aq);$("#dealerType_"+ap).selectmenu().selectmenu("refresh");$("#dealer_"+ap).textinput()}}}}}if(this.data.boAccountRelas!=undefined){var av=this.data.boAccountRelas[0].acctId;$("#acctSelect").find("option[value="+av+"]").attr("selected","selected");$("#order_remark").text(OrderInfo.reloadProdInfo.orderMark)}});order.main.newProdReload();var Z=OrderInfo.reloadOrderInfo.orderList.orderListInfo.custOrderAttrs;$.each(Z,function(){if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){OrderInfo.reloadProdInfo.orderMark=this.value
}});$.each(AttachOffer.openList,function(){var ag=this;$.each(this.specList,function(){var ai=this;var ah=false;$.each(ad,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){if(this.busiObj.objId==ai.offerSpecId){ah=true;return false}}});if(!ah){AttachOffer.delOfferSpecReload(ag.prodId,this.offerSpecId)}})});$.each(AttachOffer.openServList,function(){var ag=this;$.each(this.servSpecList,function(){var ai=this;var ah=false;$.each(ad,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(ai.servSpecId==this.data.boServOrders[0].servSpecId&&ag.prodId==this.busiObj.instId){ah=true;return false}}});if(!ah){AttachOffer.closeServSpecReload(ag.prodId,this.servSpecId,this.servSpecName,this.ifParams)}})})}};var p=function(){var af=OrderInfo.provinceInfo.codeMsg;if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="Y"){if(OrderInfo.provinceInfo.codeMsg&&af!=null&&af!=""){$.alert("提示",af)}else{var ae=OrderInfo.newOrderNumInfo.mktResInstCode;if(OrderInfo.newOrderNumInfo.mktResInstCode&&ae!=null&&ae!=""&&ae!="null"){var ad=ae.split(",");if(ad!=null&&ad.length>0){for(var ab=0;ab<=ad.length;ab++){var Y=ad[ab];if(Y!=null&&Y!=""){var V=Y.split("_");if(V!=null&&V.length==2){var ac=V[0];var X=V[1];var aa={instCode:X};var Z=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",aa);if(Z.code==0){if(Z.data&&Z.data.mktResBaseInfo){if(Z.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_"+ac).attr("disabled",true);$("#uim_check_btn_"+ac).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+ac).attr("disabled",false);$("#uim_release_btn_"+ac).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+ac).val(X);var W={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:Z.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:Z.data.mktResBaseInfo.qty,storeId:Z.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:Z.data.mktResBaseInfo.instCode,terminalCode:Z.data.mktResBaseInfo.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:ac,offerId:"-1",state:"ADD",relaSeq:""};OrderInfo.clearProdUim(ac);OrderInfo.boProd2Tds.push(W)}else{$.alert("提示","UIM卡["+X+"]不是预占状态，当前为"+Z.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","没有查询到相应的UIM卡["+X+"]信息")}}else{if(Z.code==-2){$.alert(Z.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}}}}}};var v=function(V,aa){order.prepare.showOrderTitle(OrderInfo.actionTypeName,aa.offerSpecName,false);SoOrder.initFillPage();$("#deal_package").css("display","none");$("#order_prod_list").css("display","none");$("#order_tab_panel_content").html(V.data);$.jqmRefresh($("#order_tab_panel_content"));n(aa);F();if(CONST.getAppDesc()==0&&OrderInfo.actionFlag==6){$("#orderAttrDiv").show();f()}if(aa.actionFlag==""){OrderInfo.actionFlag=1}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==13||OrderInfo.actionFlag==14){h(0);order.dealer.initDealer()}if(order.memberChange.oldMemberFlag){h(1);P(aa)}if(order.memberChange.newMemberFlag){g(aa)}if(order.memberChange.changeMemberFlag){D(aa)}if(OrderInfo.actionFlag==1){$("#templateOrderDiv").show()}G();$("#fillNextStep").off("click").on("click",function(){order.memberChange.removeAndAdd(aa)});if(aa.memberChange){$("#orderedprod").hide();$("#order_prepare").hide();$("#productDiv .pdcardcon:first").show();order.prepare.step(1);$("#fillLastStep").off("click").on("click",function(){order.prodModify.cancel()})}else{$("#fillLastStep").off("click").on("click",function(){t()})}if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""){var aa={phoneNum:"",prodId:""};aa.phoneNum=OrderInfo.newOrderNumInfo.mainPhoneNum;aa.prodId="-1";var af=order.phoneNumber.queryPhoneNumber(aa);if(af==undefined||af.datamap==undefined||af.datamap.baseInfo==undefined){$("#choosedNum_-1").html("");$("#choosedNum_-1").removeAttr("onclick")}else{if(af&&af.datamap.baseInfo!=undefined){var ai={prodId:aa.prodId,accessNumber:af.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:af.datamap.baseInfo.phoneNumId,pnLevelId:af.datamap.baseInfo.phoneLevelId,anTypeCd:af.datamap.baseInfo.pnTypeId,state:"ADD",areaId:af.datamap.baseInfo.areaId,areaCode:af.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:af.datamap.baseInfo.prePrice,minCharge:af.datamap.baseInfo.pnPrice,idFlag:"1"};if(aa.prodId&&aa.prodId=="-1"){ai.memberRoleCd=CONST.MEMBER_ROLE_CD.MAIN_CARD}$("#choosedNum_-1").html(OrderInfo.newOrderNumInfo.mainPhoneNum);$("#choosedNum_-1").removeAttr("onclick");OrderInfo.boProdAns.push(ai)}}}if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""){var aa={phoneNum:"",prodId:""};var ag=$("div[id^='choosedNum_']");var am=OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");var ae=[];$.each(ag,function(){if($(this).attr("id")!="choosedNum_-1"){ae.push(this)}});$.each(ae,function(aq,au){aa.phoneNum=am[aq];aa.prodId=-2-aq;var ar=order.phoneNumber.queryPhoneNumber(aa);if(ar==undefined||ar.datamap==undefined||ar.datamap.baseInfo==undefined){$(au).html("");$(au).removeAttr("onclick")}else{if(ar&&ar.datamap.baseInfo!=undefined){var at={prodId:aa.prodId,accessNumber:ar.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:ar.datamap.baseInfo.phoneNumId,pnLevelId:ar.datamap.baseInfo.phoneLevelId,anTypeCd:ar.datamap.baseInfo.pnTypeId,state:"ADD",areaId:ar.datamap.baseInfo.areaId,areaCode:ar.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:ar.datamap.baseInfo.prePrice,minCharge:ar.datamap.baseInfo.pnPrice,idFlag:"1"};if(aa.prodId&&aa.prodId!="-1"){at.memberRoleCd=CONST.MEMBER_ROLE_CD.VICE_CARD}$(au).html(am[aq]);$(au).removeAttr("onclick");OrderInfo.boProdAns.push(at)}}})}if(order.memberChange.newSubPhoneNum!=""&&order.memberChange.reloadFlag=="Y"){var an=order.memberChange.newSubPhoneNum.split(",");for(var ak=0;ak<an.length;ak++){if(an[ak]!=""&&an[ak]!=null&&an[ak]!="null"){$("#choosedNum_-"+(ak+1)).removeAttr("onclick");var aa={phoneNum:an[ak]};var ap=mktRes.phoneNbr.queryPhoneNumber(aa);if(ap.datamap.baseInfo){$("#choosedNum_-"+(ak+1)).val(an[ak]);var al={prodId:"-"+(ak+1),accessNumber:ap.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:ap.datamap.baseInfo.phoneNumId,pnLevelId:ap.datamap.baseInfo.phoneLevelId,anTypeCd:ap.datamap.baseInfo.pnTypeId,state:"ADD",areaId:ap.datamap.baseInfo.areaId,areaCode:ap.datamap.baseInfo.zoneNumber,memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,preStore:ap.datamap.baseInfo.prePrice,minCharge:ap.datamap.baseInfo.pnPrice};OrderInfo.boProdAns.push(al);order.dealer.changeAccNbr("-"+(ak+1),an[ak])}}}}if(order.memberChange.mktResInstCode!=""&&order.memberChange.mktResInstCode!=undefined&&order.memberChange.reloadFlag=="Y"){var W="-1";if(ec.util.isArray(OrderInfo.oldprodInstInfos)){if(ec.util.isArray(OrderInfo.viceprodInstInfos)&&OrderInfo.oldMvFlag){$.each(OrderInfo.viceprodInstInfos,function(){if(this.prodInstId==prodId){W=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){W=this.mainProdOfferInstInfos[0].prodOfferInstId}})}}else{W=order.prodModify.choosedProdInfo.prodOfferInstId}var ac=order.memberChange.mktResInstCode.split(",");for(var ah=0;ah<ac.length;ah++){if(ac[ah]!=""&&ac[ah]!=null&&ac[ah]!="null"){var aj=ac[ah].split("_");var Y=aj[0];var Z=aj[1];var an=order.memberChange.newSubPhoneNum.split(",");for(var ak=0;ak<an.length;ak++){if(an[ak]==Y){$("#uim_txt_-"+(ak+1)).attr("disabled",true);var X={instCode:Z};var V=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",X);if(V.code==0){if(V.data.mktResBaseInfo){if(V.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_-"+(ak+1)).attr("disabled",true);$("#uim_check_btn_-"+(ak+1)).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_-"+(ak+1)).attr("disabled",false);$("#uim_release_btn_-"+(ak+1)).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_-"+(ak+1)).val(Z);var ad={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:V.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:V.data.mktResBaseInfo.qty,storeId:V.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:Z,terminalCode:Z,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-(ak+1),offerId:W,state:"ADD",relaSeq:""};
OrderInfo.clearProdUim(-(ak+1));OrderInfo.boProd2Tds.push(ad)}else{$.alert("提示","UIM卡不是预占状态，当前为"+V.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(V.code==-2){$.alertM(V.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}}}if(order.memberChange.reloadFlag=="N"){$("#dealerTbody").empty();var ao=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;$.each(ao,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="3"){}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){$("#choosedNum_"+this.data.boProdAns[0].prodId).val(this.busiObj.accessNumber);$.jqmRefresh($("#order_tab_panel_content"));var aK={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};OrderInfo.boProdAns.push(aK);order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);var aC={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};OrderInfo.clearProdUim(this.busiObj.instId);OrderInfo.boProd2Tds.push(aC);$("#pwd_"+this.busiObj.instId).val(this.data.boProdPasswords[0].pwd);$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected")}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"){}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="1"){}}}}if(this.data.busiOrderAttrs!=undefined){var aQ=[];var aB={};var aA={};var az={};$.each(this.data.busiOrderAttrs,function(){if(this.role=="40020005"){aB.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aB.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aB.staffname=this.value}}}else{if(this.role=="40020006"){aA.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aA.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aA.staffname=this.value}}}else{if(this.role=="40020007"){az.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){az.staffid=this.value}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){az.staffname=this.value}}}}}});if(ec.util.isObj(aB.role)){aQ.push(aB)}if(ec.util.isObj(aA.role)){aQ.push(aA)}if(ec.util.isObj(az.role)){aQ.push(az)}var au="";var aw="";if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){au=this.busiObj.instId}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd!="1"){au=this.data.ooRoles[0].prodId+"_"+this.busiObj.objId;aw="DEL"}}var ar=this.busiObj.accessNumber;for(var aP=0;aP<aQ.length;aP++){var aD;if(aP==0){aD=$("<li id='tr_"+au+"' name='tr_"+au+"'></li>")}else{aD=$("<li name='tr_"+au+"'></li>")}var aI=$("<dl></dl>");var aH=$("<dd></dd>");var aJ=$('<fieldset data-role="fieldcontain"></fieldset>');var aE=au+"_"+OrderInfo.SEQ.dealerSeq;var aN=$('<select id="dealerType_'+aE+'" name="dealerType_'+au+'" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+au+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(aQ[aP].role==this.PARTYPRODUCTRELAROLECD){aN.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected>"+this.NAME+"</option>")}else{aN.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});aJ.append(aN);aH.append(aJ);aI.append("<dd>"+ar+"</dd>");if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){aI.append("<dd>移动电话（仅含本地语音）</dd>")}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){aI.append("<dd>"+this.busiObj.objName+"</dd>")}}aI.append(aH);var aO;if(aw=="DEL"){aO=$('<dd><input type="text" id="dealer_'+aE+'" staffId="'+aQ[aP].staffid+'" value="'+aQ[aP].staffname+'" data-mini="true" readonly="readonly" ></input></dd>')}else{aO=$('<dd><input type="text" id="dealer_'+aE+'" staffId="'+aQ[aP].staffid+'" value="'+aQ[aP].staffname+'" data-mini="true" readonly="readonly" ></input></dd>')}aI.append(aO);if(aP==0){if(aw=="DEL"){var av='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';av+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+aE+"');\">选择</button></div>";av+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+au+',1)">添加</button></div>';av+='<div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>'}else{var av='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';av+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+aE+"');\">选择</button></div>";av+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+au+',1)">添加</button></div></dd>'}}else{if(aP==1){var av='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';av+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+aE+"');\">选择</button></div>";av+='<div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>'}}aI.append(av);var aq=$("<dd></dd>");var at=$('<select id="dealerChannel_'+aE+'" name="dealerChannel_'+au+'" class="inputWidth183px" onclick=a=this.value;></select>');if(order.memberChange.reloadFlag=="N"){var aF=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;var ay="";for(var aM=0;aM<aF.length;aM++){if(aF[aM].boActionType.actionClassCd=="1300"&&aF[aM].boActionType.boActionTypeCd=="1"){var ax=aF[aM].data.busiOrderAttrs;for(var aL=0;aL<ax.length;aL++){if(ax[aL].channelNbr!=undefined){ay=ax[aL].channelNbr;break}}}}for(var aM=0;aM<OrderInfo.channelList.length;aM++){if(OrderInfo.channelList[aM].channelNbr==ay){at.append("<option value='"+OrderInfo.channelList[aM].channelNbr+"' selected ='selected'>"+OrderInfo.channelList[aM].channelName+"</option>")}else{at.append("<option value='"+OrderInfo.channelList[aM].channelNbr+"'>"+OrderInfo.channelList[aM].channelName+"</option>")}}}else{$.each(OrderInfo.channelList,function(){if(this.isSelect==1){at.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")
}else{at.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}})}aq.append(at);aq.append('<label class="f_red">*</label>');aI.append(aq);aD.append(aI);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(aD);$.jqmRefresh($("#dealerTbody"))}}if(this.data.boAccountRelas!=undefined){var aG=this.data.boAccountRelas[0].acctId;$("#acctSelect").find("option[value="+aG+"]").attr("selected","selected")}});var ab=order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;$.each(ab,function(){if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){$("#order_remark").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrName){$("#orderAttrName").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrPhoneNbr){$("#orderAttrPhoneNbr").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderIdentidiesTypeCd){$("#orderIdentidiesTypeCd").find("option[value="+this.value+"]").attr("selected","selected")}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrIdCard){$("#orderAttrIdCard").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrAddr){$("#orderAttrAddr").val(this.value)}});order.main.reload()}};var x=function(){var V=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;$.each(V,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){var X=this;$.each(AttachOffer.openList,function(){if(this.prodId==X.data.ooRoles[0].prodId){var Z=false;$.each(this.specList,function(){if(this.offerSpecId==X.busiObj.objId){Z=true;return false}});if(!Z){AttachOffer.addOfferSpec(this.prodId,X.busiObj.objId);if(X.data.bo2Coupons!=undefined){for(var ac=0;ac<X.data.bo2Coupons.length;ac++){var ab=X.data.bo2Coupons[ac];if(ac==0){$("#terminalText_"+ab.prodId+"_"+ab.attachSepcId+"_"+ab.num).val(ab.couponInstanceNumber);AttachOffer.checkTerminalCode($("#terminalBtn_"+ab.prodId+"_"+ab.attachSepcId+"_"+ab.num))}else{AttachOffer.addAndDelTerminal($("#terminalAddBtn_"+ab.prodId+"_"+ab.attachSepcId));$("#terminalText_"+ab.prodId+"_"+ab.attachSepcId+"_"+ab.num).val(ab.couponInstanceNumber);AttachOffer.checkTerminalCode($("#terminalBtn_"+ab.prodId+"_"+ab.attachSepcId+"_"+ab.num))}var aa={couponUsageTypeCd:ab.couponUsageTypeCd,inOutTypeId:ab.inOutTypeId,inOutReasonId:ab.inOutReasonId,saleId:ab.saleId,couponId:ab.couponId,couponinfoStatusCd:ab.couponinfoStatusCd,chargeItemCd:ab.chargeItemCd,couponNum:ab.couponNum,storeId:ab.storeId,storeName:ab.storeName,agentId:ab.agentId,apCharge:ab.apCharge,couponInstanceNumber:ab.couponInstanceNumber,ruleId:ab.ruleId,partyId:ab.partyId,prodId:ab.prodId,offerId:ab.offerId,attachSepcId:ab.attachSepcId,state:ab.state,relaSeq:ab.relaSeq,num:ab.num};OrderInfo.attach2Coupons.push(aa)}}}}})}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){var X=this;var W=false;$.each(AttachOffer.openServList,function(){if(this.prodId==X.data.boServOrders[0].servId){$.each(this.servSpecList,function(){if(this.servSpecId==X.data.boServOrders[0].servSpecId){W=true;return false}})}});if(!W){var Y="N";if(X.data.boServItems!=undefined){Y="Y"}AttachOffer.openServSpecReload(this.busiObj.instId,X.data.boServOrders[0].servSpecId,X.data.boServOrders[0].servSpecName,Y)}}}})};var k=function(Y){for(var V=0;V<OrderInfo.oldoffer.length;V++){for(var W=0;W<OrderInfo.oldoffer[V].offerMemberInfos.length;W++){var X=OrderInfo.oldoffer[V].offerMemberInfos[W];if(X.objInstId==Y){return X}}}return{}};var g=function(V){$.each(OrderInfo.offerSpec.offerRoles,function(){var Y=this;if(Y.prodInsts!=undefined&&Y.prodInsts!=null){for(var W=0;W<this.prodInsts.length;W++){var X=this.prodInsts[W];var aa={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:X.objId,offerRoleId:X.offerRoleId,prodId:X.prodInstId,queryType:"1,2",objType:X.objType,objId:X.objId,memberRoleCd:X.memberRoleCd};AttachOffer.queryAttachOfferSpec(aa);var Z={ul_id:"item_order_"+X.prodInstId,prodId:X.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:X.objId,roleCd:Y.roleCd,offerRoleId:Y.offerRoleId,partyId:OrderInfo.cust.custId,actionFlag:OrderInfo.actionFlag};if(OrderInfo.actionFlag=="6"){order.main.spec_member_parm(Z)}else{order.main.spec_parm(Z)}}}});if(offerChange.oldMemberFlag){order.main.loadAttachOffer()}};var z=function(V){$.each(OrderInfo.offerSpec.offerRoles,function(){var W=this;if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){var Y="'"+this.prodInstId+"'";if(Y.indexOf("-")==-1){var ai=this.prodInstId;var ab={areaId:OrderInfo.getProdAreaId(ai),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ai,prodSpecId:this.objId,offerSpecId:prodInfo.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var aj=this.accessNumber;var ap=query.offer.queryChangeAttachOffer(ab);$("#attach_"+ai).html(ap);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){ab.queryType="1,2";ab.objId=this.objId;ab.objType=this.objType;ab.memberRoleCd=this.roleCd;ab.offerSpecId=OrderInfo.offerSpec.offerSpecId;var ao=query.offer.queryDefMustOfferSpec(ab);CacheData.parseOffer(ao,ai);ab.queryType="1";var ao=query.offer.queryServSpec(ab);CacheData.parseServ(ao,ai)}AttachOffer.showMainRoleProd(ai);if(AttachOffer.isChangeUim(ai)){if(OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""&&OrderInfo.mktResInstCode!="null"){var ac=OrderInfo.mktResInstCode.split(",");if(ac!=null&&ac.length>0){var al="";var af="";var ad="0";for(var am=0;am<ac.length;am++){var Z=ac[am].split("_");if(Z!=null&&Z.length==2){var ah=Z[0];var ag=Z[1];if(al!=null&&al!=""){if(al==ah||af==ag){ad="1";break}}else{al=ah;af=ag}}}if(ad=="1"){$.alert("提示","传入的UIM参数中存在重复数据,参数为["+OrderInfo.mktResInstCode+"]")}else{var X="";for(var am=0;am<ac.length;am++){var Z=ac[am].split("_");if(Z!=null&&Z.length==2){var ak=Z[0];var an=Z[1];if(ak==aj){X=an}}}if(X!=null&&X!=""&&X!="null"){cleckUim(X,ai);$("#uim_check_btn_"+ai).hide();$("#uim_release_btn_"+ai).hide()}}}}num++;$("#uimDiv_"+ai).show()}}else{var aa=this;var ab={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:aa.objId,offerRoleId:aa.offerRoleId,prodId:aa.prodInstId,queryType:"1,2",objType:aa.objType,objId:aa.objId,memberRoleCd:aa.memberRoleCd};AttachOffer.queryAttachOfferSpec(ab);var ae={ul_id:"item_order_"+aa.prodInstId,prodId:aa.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:aa.objId,roleCd:W.roleCd,offerRoleId:W.offerRoleId,partyId:OrderInfo.cust.custId,actionFlag:OrderInfo.actionFlag};order.main.spec_member_parm(ae)}})}})};var a=function(V){$(".paymethodChange").each(function(){if($(this).attr("id")!=$(V).attr("id")){$(this).val($(V).val())}})};var U=function(X){if($("#isTemplateOrder").attr("checked")=="checked"){var W=$('select[name="pay_type_-1"]').val();if(X&&$(X).val()){if($(X).val()=="0"&&W!="2100"){$.alert("提示","您选择批开活卡模板，付费方式需改成'预付费'！");$("html").scrollTop(0);return false}}else{var V=$("#templateOrderDiv select").val();if(V){if(V=="0"&&W!="2100"){$.alert("提示","您选择批开活卡模板，付费方式需改成预付费！");$("html").scrollTop(0);return false}}}}return true};var n=function(V){if(V.feeType!=undefined&&V.feeType&&V.feeType!=CONST.PAY_TYPE.NOLIMIT_PAY){$("input[name^=pay_type_][value="+V.feeType+"]").attr("checked","checked");$("input[name^=pay_type_]").attr("disabled","disabled")}};var h=function(V){if(OrderInfo.actionFlag==6||(OrderInfo.actionFlag==2&&offerChange.oldMemberFlag==true)){var aa={};if(V==1){for(var X=0;X<OrderInfo.oldprodInstInfos.length;X++){aa.prodId=OrderInfo.oldprodInstInfos[X].prodInstId;aa.acctNbr=OrderInfo.oldprodInstInfos[X].accNbr;aa.areaId=OrderInfo.oldprodInstInfos[X].areaId;var Z=$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",aa);if(Z.code==-2){$.alertM(Z.data);return}var W=Z.data;W[0].accessNumber=OrderInfo.oldprodInstInfos.accNbr;OrderInfo.oldprodAcctInfos.push({prodAcctInfos:W})}}else{aa.prodId=order.prodModify.choosedProdInfo.prodInstId;aa.acctNbr=order.prodModify.choosedProdInfo.accNbr;
aa.areaId=order.prodModify.choosedProdInfo.areaId;var Z=$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",aa);if(Z.code==-2){$.alertM(Z.data);return}var W=Z.data;var Y=$("#acctSelect");$("#accountDiv").find("label:eq(0)").text("主卡帐户：");$.each(W,function(ab,ac){Y.append("<option value='"+ac.acctId+"' acctcd='"+ac.acctCd+"'>"+ac.name+" : "+ac.acctCd+"</option>")});Y.selectmenu().selectmenu("refresh");$("#accountDiv").find("button:eq(0)").hide()}}else{H()}};var A=function(){$(".ordertabcon:first").show();$(".ordertab li:first").addClass("setorder");$(".ordertab li").each(function(V){$(this).click(function(){var W=$(this).attr("order");if(W>1){$(".order_copy").show()}else{$(".order_copy").hide()}$(this).addClass("setorder").siblings().removeClass("setorder");$(this).parents(".ordernav").parent().siblings(".ordercon").find(".ordertabcon").eq(V).show().siblings().hide()})})};var C=function(){$(".many li").bind("click",function(){var V=$(this).index();var W=$("#tabs-body .ordercona");$(this).parent().children("li").attr("class","tab-nav");$(this).attr("class","tab-nav-action");W.hide();W.eq(V).show()})};var f=function(){order.cust.partyTypeCdChoose($("#orderPartyTypeCd").children(":first-child"),"orderIdentidiesTypeCd");order.cust.identidiesTypeCdChoose($("#orderIdentidiesTypeCd").children(":first-child"),"orderAttrIdCard")};var G=function(){$("#acctQueryForm").bind("formIsValid",function(W,V){var X;if($("#chooseQueryAcctType").val()==1){if(!CONST.LTE_PHONE_HEAD.test($.trim($("#d_query_nbr input").val()))){$.alert("提示","请输入有效的中国电信手机号");return}X={accessNumber:$("#d_query_nbr input").val()}}else{if($("#chooseQueryAcctType").val()==2){X={acctCd:$("#d_query_cd input").val()}}else{X={custId:OrderInfo.cust.custId,isServiceOpen:"Y"}}}$.callServiceAsJson(contextPath+"/order/account",X,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(Y){$("#acctListTab tbody").empty();if(Y.code==-2){$.alertM(Y.data);return}if(Y.code==0){var Z=Y.data;if(Z.resultCode==0){if(Z.accountInfos&&Z.accountInfos.length>0){$("#acctPageDiv").empty();common.page.init("acctPageDiv",5,"pageId","queryAccount",Z.accountInfos)}else{$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+Z.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+Y.data+"</td</tr>").appendTo($("#acctListTab tbody"))}}})}).ketchup({bindElement:"querAcctBtn"});$("#zhanghuclose").click(function(){easyDialog.close();$(document).removeJEventListener("queryAccount")});$(this).addJEventListener("queryAccount",function(V){j(V)});$("#chooseQueryAcctType").change(function(){if($(this).val()==1){$("#d_query_cd").remove();$("#querAcctBtn").parent().before("<dd id='d_query_nbr'>&nbsp;<input type='text' data-validate='validate(required:接入号不能为空) on(keyup blur)' value='' class='inputWidth150px'></dd>")}else{if($(this).val()==2){$("#d_query_nbr").remove();$("#querAcctBtn").parent().before("<dd id='d_query_cd'>&nbsp;<input type='text' data-validate='validate(required:合同号不能为空) on(keyup blur)' value='' class='inputWidth150px' ></dd>")}else{$("#d_query_cd").remove();$("#d_query_nbr").remove()}}});$("#chooseQueryAcctType").change();$("#acctSelect").change(function(){if($(this).val()==-1){$(this).parent().find("a:eq(1)").hide();if(OrderInfo.actionFlag!=2){$("#defineNewAcct").show()}}else{$(this).parent().find("a:eq(1)").show();$("#defineNewAcct").hide()}})};var j=function(V){$("#acctListTab tbody").empty();$.each(V,function(W,Y){var X=$("<tr></tr>").appendTo($("#acctListTab tbody"));if(Y.name){$("<td class='teleNum'>"+Y.name+"</td>").appendTo(X)}else{$("<td></td>").appendTo(X)}if(Y.acctId){$("<td acctId='"+Y.acctId+"'>"+Y.accountNumber+"</td>").appendTo(X)}else{$("<td></td>").appendTo(X)}if(Y.owner){$("<td>"+Y.owner+"</td>").appendTo(X)}else{$("<td></td>").appendTo(X)}if(Y.accessNumber){$("<td>"+Y.accessNumber+"</td>").appendTo(X)}else{$("<td></td>").appendTo(X)}X.click(function(){var aa=false;var Z=$("#acctSelect").find("option");$.each(Z,function(ac,ab){if(ab.value==Y.acctId){$("#acctSelect").find("option[value="+ab.value+"]").attr("selected","selected");aa=true;return false}});$(this).dispatchJEvent("chooseAcct",Y);easyDialog.close();$("#defineNewAcct").hide()})})};function q(V){$.callServiceAsHtmlGet(contextPath+"/pad/order/orderSpecParam",V,{done:function(Y){if(Y&&Y.code==-2){return}else{if(Y&&(Y.data==0||Y.data=="0")){return}}$("#"+V.ul_id).after(Y.data);$("div[name='spec_params']").each(function(){$.jqmRefresh($(this))});N(V.prodId,$("#"+V.ul_id));N(V.prodId,$("#"+V.ul_id));var ab=$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+V.prodId);if(ab.length==1){if(OrderInfo.actionFlag!=1&&OrderInfo.actionFlag!=14){$(ab).attr("disabled","disabled");$(ab).parent().find("a").addClass("ui-state-disabled")}else{$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+V.prodId+" option[value=' ']").remove();$(ab).val("20");if(OrderInfo.offerSpec.feeType==CONST.PAY_TYPE.BEFORE_PAY){$(ab).attr("disabled","disabled");$(ab).parent().find("a").addClass("ui-state-disabled")}}$(ab).selectmenu().selectmenu("refresh")}if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){$.each(OrderInfo.reloadProdInfo.checkMaskList,function(){$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+this.prodId+"").find("option[value='"+this.isCheckMask+"']").attr("selected",true);$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+this.prodId+"").selectmenu("refresh",true)});var X=$("[id^='dealerType_']");var Z=$("#paytype_prod_id");var W=$("#paytype_prod_id").find("option");for(var aa=0;aa<W.length;aa++){if($(W[aa]).val()==OrderInfo.reloadProdInfo.feeType){Z[0].selectedIndex=aa;Z.slider("refresh");order.main.feeTypeCascadeChange(Z,"-1");break}}}},fail:function(W){$.unecOverlay()}})}function L(){if(!i("order_spc_update")){return}var W=new Array();var X=0;$("#order_spc_update input").each(function(){if($(this).attr("id")!="order_remark"&&$(this).attr("id")!="isTemplateOrder"&&$(this).attr("id")!="templateOrderName"&&$(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var ab={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};W.push(ab);X++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var aa={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};W.push(aa);X++}if($(this).val()!=null&&$(this).val()!=""){var Z={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};W.push(Z);X++}}}}}});$("#order_spc_update select").each(function(){if($(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var ab={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};W.push(ab);X++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var aa={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};W.push(aa);X++}if($(this).val()!=null&&$(this).val()!=""){var Z={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};W.push(Z);X++}}}}}});var V;if($("#order_remark").val()){V=[{atomActionId:OrderInfo.SEQ.atomActionSeq--,itemSpecId:CONST.ITEM_SPEC_ID_CODE.busiOrderAttrs,value:$("#order_remark").val()}];X++}if(X<1){$.alert("提示","您未修改订单属性");return}var Y={boProdItems:W};if(V){Y.busiOrderAttrs=V}OrderInfo.actionFlag=33;SoOrder.submitOrder(Y)}function i(W){var V=true;$("#"+W).find("input").each(function(){if(V){V=w(this)
}});return V}function w(Z){if($(Z).attr("check_option")=="N"){if($(Z).val()==null||$(Z).val()==""){$.alert("提示",$(Z).attr("check_name")+" 尚未填写");return false}}if($(Z).attr("check_type")=="check"){var V=$(Z).attr("check_len");if(V>0){if($(Z).val().length>V){$.alert("提示",$(Z).attr("check_name")+" 长度过长(<"+V+")");return false}}var W=$(Z).attr("check_mask");if(W!=null&&$(Z).val()!=null&&$(Z).val()!=""){var Y=new RegExp(W);if(!Y.test($(Z).val())){$.alert("提示",$(Z).attr("check_name")+" 校验失败："+$(Z).attr("check_mess"));return false}}var X=$(Z).val().length;if(X>0&&$(Z).attr("dataType")=="3"){if(!/^[0-9]+$/.test($(Z).val())){$.alert("提示",$(Z).attr("check_name")+" 非数字，请修改");return false}}else{if(X>0&&$(Z).attr("dataType")=="5"){if(!/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test($(Z).val())){$.alert("提示",$(Z).attr("check_name")+" 非小数，请修改");return false}}else{if(X>0&&($(Z).attr("dataType")=="4"||$(Z).attr("dataType")=="16")){}}}}return true}var y=function(V){if(V&&V.page){o(V.page,V.scroll)}};var K=function(W,V){$.callServiceAsHtmlGet(contextPath+"/pad/staffMgr/getStaffListPrepare",{dealerId:W,objInstId:V},{done:function(Y){var X=$.popup("#div_staff_dialog",Y.data,{cache:true,width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){}});$("#btn_staff_select_chk").off("tap").on("tap",function(){R(V)});$("#a_order_staff_qry").off("tap").on("tap",function(){o(1)})}})};var o=function(W,V){var X={dealerId:$("#dealer_id").val(),qrySalesCode:$("#qrySalesCode").val(),staffName:$("#qryStaffName").val(),staffCode:$("#qryStaffCode").val(),staffCode2:$("#qryStaffCode").val(),salesCode:$("#qrySalesCode").val(),pageIndex:W,objInstId:$("#objInstId").val(),pageSize:10};$.callServiceAsHtml(contextPath+"/pad/staffMgr/getStaffList",X,{before:function(){if(W==1){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}},always:function(){if(W==1){$.unecOverlay()}},done:function(Y){var Z="";if(!Y){Z=""}else{Z=Y.data}var aa=$("#div_order_dealer_list");if(W==1){aa.html(Z)}else{aa.find("tbody").append(Z)}aa.find("tr").each(function(){$(this).off("tap").on("tap",function(ab){$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg")})});if(V&&$.isFunction(V)){V.apply(this,[])}}})};var R=function(W){var V=$("#div_order_dealer_list tr.userorderlistlibg");V.each(function(){$("#dealer_"+W).val($(this).attr("staffName")).attr("staffId",$(this).attr("staffId"))});if(V.length>0){$("#div_staff_dialog").popup("close")}else{$.alert("提示","请先选择协销人！")}};var I=function(){$("#acctDialog .contract_list td").text("帐户查询");$("#acctDialog .selectList").show();easyDialog.open({container:"acctDialog"});$("#acctPageDiv").show();var V="chooseAcct";var W=$("#acctSelect");if(!W.hasJEventListener(V)){W.addJEventListener(V,function(Y){var X=false;$.each(W.find("option"),function(Z,aa){if($(aa).val()==Y.acctId){X=true;return false}});if(X==false){$("<option>").text(Y.name+" : "+Y.accountNumber).attr("value",Y.acctId).attr("acctcd",Y.accountNumber).appendTo(W)}W.find("option[value="+Y.acctId+"]").attr("selected","selected");if(Y.acctId>0){$("#account").find("a:eq(1)").show()}})}$("#acctListTab tbody").empty();$("#acctPageDiv").empty()};var H=function(){$("#acctSelect").append("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>");$("#acctSelect").find("option[value='-1']").attr("selected","selected");$("#acctName").val(OrderInfo.cust.partyName);if(OrderInfo.actionFlag!=2){$("#defineNewAcct").show()}$("#account").find("a:gt(0)").hide();window.setTimeout("order.main.showNewAcct()",0)};var E=function(){var V;V={acctCd:OrderInfo.acct.acctCd,isServiceOpen:"Y"};V.areaId=OrderInfo.getAreaId();$.callServiceAsJson(contextPath+"/order/account",V,{before:function(){},always:function(){},done:function(W){if(W.code==-2){$.alertM(W.data);return}if(W.code==0){var X=W.data;if(X.resultCode==0){if(X.accountInfos&&X.accountInfos.length>0){$.each(X.accountInfos,function(Y,Z){if(Z.acctId!=null&&Z.acctId!=""){OrderInfo.acct={acctId:Z.acctId,acctcd:Z.accountNumber,name:Z.name};return false}})}else{$.alert("提示","没有查询到帐户合同号对应的帐户信息")}}else{$.alertM(X.resultMsg)}}else{$.alertM(W.data)}}})};var c=function(){acct.acctModify.ifCanAdjustBankPayment();acct.acctModify.getBILL_POST(function(){acct.acctModify.paymentType();acct.acctModify.billPostType()})};var s=function(){var W=$("#acctSelect");if(!W.val()){$.alert("提示","请选择一个帐户");return}if(W.val()==-1){$.alert("提示","该帐户是新建帐户");return}$("#acctDialog .contract_list td").text("帐户信息");$("#acctDialog .selectList").hide();$("#acctPageDiv").hide();$("#acctListTab tbody").empty();easyDialog.open({container:"acctDialog"});var V={acctCd:W.find("option:selected").attr("acctcd"),isServiceOpen:"Y"};$.callServiceAsJson(contextPath+"/order/account",V,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(X){if(X.code==-2){$.alertM(X.data);return}if(X.code==0){j(X.data.accountInfos)}else{$("<tr><td colspan=4>"+X.data+"</td</tr>").appendTo($("#acctListTab tbody"))}$("#acctListTab tr").off("click")}})};var t=function(){$.confirm("信息","确定回到上一步吗？",{yes:function(){var X=OrderInfo.boProdAns;var W=order.service.boProdAn;var V=OrderInfo.boProd2Tds;if(V.length>0){for(var Z=0;Z<V.length;Z++){var Y={numType:2,numValue:V[Z].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",Y,{done:function(){}})}}if(X.length>0){for(var Z=0;Z<X.length;Z++){if(X[Z].idFlag){continue}var Y={numType:1,numValue:X[Z].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",Y)}}mktRes.phoneNbr.resetBoProdAn();$("#order_fill").empty();$("#order_prepare").show();$("#order_fill_content").empty();$("#order_tab_panel_content").show()},no:function(){}},"question")};var e=function(){return{boActionTypeCd:S1,boActionTypeName:"订购",offerSpecId:1234,offerSpecName:"乐享3G-129套餐",feeType:1200,viceCardNum:3,offerNum:3,type:1,terminalInfo:{terminalName:"IPhone5",terminalCode:"46456457345"},offerRoles:[{offerRoleId:1234,offerRoleName:"主卡",memberRoleCd:"0",roleObjs:[{offerRoleId:1,objId:CONST.PROD_SPEC.CDMA,objName:"CDMA",objType:2}]},{offerRoleId:2345,offerRoleName:"副卡",memberRoleCd:"1"}]}};var O=function(W){var V=T();$("#"+W).val(V)};var T=function(){var Z="";var Y="";var X="";var W=0;for(var V=0;V<6;V++){do{if(Z.length>0){Y=Z.substring(Z.length-1,Z.length)}W=parseInt(Math.random()*9+1);X=""+W;if(Z.length==5){if(d(Z+X)){continue}}}while(Y==X);Z=Z+X}if(Z.length!=6){return null}return Z};var d=function(Y){var V=0;if(Y&&Y.length==6){for(var W=0;W<5;W++){var Z=parseInt(Y.substring(W,W+1));var X=parseInt(Y.substring(W+1,W+2));V=V+(Z-X)}if(V==5||V==-5){return true}else{return false}}else{return false}};var r=function(X,V){var W=$("#"+X).val();return Q(W,V)};var Q=function(Z,W){var Y="<div style='text-indent:0px;'>密码设置规则：<br/>1、密码必须为六位全数字；<br/>2、密码不能与接入号中的信息重复；<br/>3、密码不能包含连续相同的数字；<br/>4、密码不能是连续的六位数字。</div>";var X=new RegExp("^([0-9]{6})$");if(Z==null){$.alertMore("提示","","密码不可为空！",Y,"");return false}else{if(!X.test(Z)){$.alertMore("提示","","密码包含非数字或长度不是6位",Y,"");return false}}if(W!=null&&W.indexOf(Z)>=0){$.alertMore("提示","","密码不能与接入号中的信息重复，请修改！",Y,"");return false}for(var V=0;V<5;V++){lastOneS=Z.substring(V,V+1);thisOneS=Z.substring(V+1,V+2);if(lastOneS==thisOneS){$.alertMore("提示","","密码中包含连续相同数字，请修改！",Y,"");return false}}if(d(Z)){$.alertMore("提示","","密码不可是连续6位数字，请修改！",Y,"");return false}return true};var b=function(Y,W){var V=$(Y).val();var X=$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+W);if(V==CONST.PAY_TYPE.BEFORE_PAY){$(X).val("20").attr("disabled","disabled");$(X).parent().find("a").addClass("ui-state-disabled")}else{$(X).val("20").removeAttr("disabled");$(X).parent().find("a").removeClass("ui-state-disabled")}$(X).selectmenu().selectmenu("refresh")};var P=function(Y){for(var V=0;V<OrderInfo.oldprodInstInfos.length;V++){var W=OrderInfo.oldprodInstInfos[V];$.each(OrderInfo.oldoffer,function(){if(this.accNbr==W.accNbr){var Z=this;$.each(Z.offerMemberInfos,function(){var ae=this;
if(ae.objType==CONST.OBJ_TYPE.PROD){var ac=this.objInstId;var ad={areaId:OrderInfo.getProdAreaId(ac),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ac,prodSpecId:ae.objId,offerSpecId:W.mainProdOfferInstInfos[0].prodOfferId,offerRoleId:"",acctNbr:ae.accessNumber,partyId:W.custId,distributorId:OrderInfo.staff.distributorId,mainOfferSpecId:W.mainProdOfferInstInfos[0].prodOfferId,soNbr:OrderInfo.order.soNbr};if(ec.util.isObj(W.prodBigClass)){ad.prodBigClass=W.prodBigClass}$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==W.accNbr){$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){ad.offerRoleId=this.offerRoleId}})}});var aa=query.offer.queryChangeAttachOffer(ad);$("#attach_"+ac).html(aa);$.jqmRefresh($("#attach_"+ac));if(ec.util.isObj(ae.objId)&&ec.util.isObj(ae.objType)&&ec.util.isObj(ae.offerRoleId)){ad.queryType="1,2";ad.objId=ae.objId;ad.objType=ae.objType;ad.memberRoleCd="401";var ab=query.offer.queryDefMustOfferSpec(ad);CacheData.parseOffer(ab);var ab=query.offer.queryServSpec(ad);CacheData.parseServ(ab)}if(ec.util.isArray(OrderInfo.oldofferSpec)){$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==W.accNbr){var af=this.offerSpec.offerRoles;$.each(af,function(){if(this.offerRoleId==ae.offerRoleId&&ae.objType==CONST.OBJ_TYPE.PROD){var ag=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var ai=CacheData.getServBySpecId(ac,this.objId);if(ai!=undefined){var ah=$("#li_"+ac+"_"+ai.servId);if(this.minQty==1){ah.append('<dd class="mustchoose"></dd>')}ah.append('<dd id="jue_'+ac+"_"+ai.servId+'" class="jue2" title="'+ag.offerRoleName+'"></dd>')}}});return false}})}})}AttachOffer.changeLabel(ac,W.productId,"")}})}});var X={};if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){if(this.accNbr==W.accNbr){X=this}})}if(order.prodModify.choosedProdInfo.is3G=="N"&&W.mainProdOfferInstInfos[0].is3G=="Y"){if(!order.memberChange.checkOrder(W,X)){return}order.memberChange.checkOfferProd(X)}}};var D=function(X){var V=order.prodModify.choosedProdInfo;var W=false;$.each(X.viceParam,function(){var aa=this.objInstId;var ab={areaId:OrderInfo.getProdAreaId(aa),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:aa,prodSpecId:this.objId,offerSpecId:V.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var Y=query.offer.queryChangeAttachOffer(ab);$("#attach_"+aa).html(Y);$.jqmRefresh($("#attach_"+aa));if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){ab.queryType="1,2";ab.objId=this.objId;ab.objType=this.objType;ab.memberRoleCd="400";ab.offerSpecId=this.offerSpecId;var Z=query.offer.queryDefMustOfferSpec(ab);CacheData.parseOffer(Z,aa);var Z=query.offer.queryServSpec(ab);CacheData.parseServ(Z,aa)}AttachOffer.showMainMemberRoleProd(aa);AttachOffer.changeLabel(aa,this.objId,"");if(AttachOffer.isChangeUim(aa)){if(!W){$("#uimDiv_"+aa).show()}else{$("#uimDiv_"+aa).hide()}}W=true})};function S(ab,ad,V,ag){var W=CacheData.getServSpec(ab,ad);if(W==undefined){var ac={objId:ad,servSpecId:ad,servSpecName:V,ifParams:ag,isdel:"C"};var af={prodSpecId:ad};if(ag=="Y"){var Z=query.prod.prodSpecParamQuery(af);if(Z==undefined||Z.result==undefined){return}ac.prodSpecParams=Z.result.prodSpecParams;if(ad==CONST.YZFservSpecId){var ae=$("select[name='pay_type_-1']").val();if(ae==undefined){ae=order.prodModify.choosedProdInfo.feeType}if(ae==CONST.PAY_TYPE.AFTER_PAY){for(var Y=0;Y<ac.prodSpecParams.length;Y++){var aa=ac.prodSpecParams[Y];aa.setValue=""}}else{for(var Y=0;Y<ac.prodSpecParams.length;Y++){var aa=ac.prodSpecParams[Y];if(aa.value!=""){aa.setValue=aa.value}else{if(!!aa.valueRange[0]&&aa.valueRange[0].value!=""){aa.setValue=aa.valueRange[0].value}}}}}}CacheData.setServSpec(ab,ac);W=ac}var ad=W.servSpecId;var X=CacheData.getExcDepServParam(ab,ad);AttachOffer.addOpenServList(ab,ad,W.servSpecName,W.ifParams)}var l=function(){if(order.memberChange.reloadFlag=="N"){var V=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;$.each(V,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){var W=this;var Z=false;$.each(AttachOffer.openList,function(){if(this.prodId==W.data.ooRoles[0].prodId){$.each(this.specList,function(){if(this.offerSpecId==W.busiObj.objId){Z=true;return false}})}});if(!Z){AttachOffer.addOpenList(W.data.ooRoles[0].prodId,W.busiObj.objId);if(W.data.ooParams!=undefined){if(W.data.ooParams.length>0){var ah=W.data.ooParams[0];var ac=CacheData.getOfferSpec(ah.offerParamId,ah.offerSpecParamId);if(!!ac.offerSpecParams){for(var am=0;am<ac.offerSpecParams.length;am++){var ab=ac.offerSpecParams[am];var X=CacheData.getSpecParam(ah.offerParamId,ah.offerSpecParamId,ab.itemSpecId);if(X.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){X.setValue=$("#select1").val()}else{X.setValue=ah.value}}}if(ac.offerRoles!=undefined&&ac.offerRoles.length>0){for(var am=0;am<ac.offerRoles.length;am++){var aj=ac.offerRoles[am];for(var al=0;al<aj.roleObjs.length;al++){var aa=aj.roleObjs[al];if(!!aa.prodSpecParams){for(var ak=0;ak<aa.prodSpecParams.length;ak++){var ae=aa.prodSpecParams[ak];var an=CacheData.getProdSpecParam(ah.offerParamId,ah.offerSpecParamId,ae.itemSpecId);an.value=ah.value}}}}}$("#can_"+ah.offerParamId+"_"+ah.offerSpecParamId).removeClass("canshu").addClass("canshu2");var af=CacheData.getOfferSpec(ah.offerParamId,ah.offerSpecParamId);af.isset="Y"}}if(W.data.bo2Coupons!=undefined){var ag=W.data.bo2Coupons[0];$("#terminalText_"+ag.prodId+"_"+ag.attachSepcId+"_"+ag.num).val(ag.couponInstanceNumber);var ad={couponUsageTypeCd:ag.couponUsageTypeCd,inOutTypeId:ag.inOutTypeId,inOutReasonId:ag.inOutReasonId,saleId:ag.saleId,couponId:ag.couponId,couponinfoStatusCd:ag.couponinfoStatusCd,chargeItemCd:ag.chargeItemCd,couponNum:ag.couponNum,storeId:ag.storeId,storeName:ag.storeName,agentId:ag.agentId,apCharge:ag.apCharge,couponInstanceNumber:ag.couponInstanceNumber,ruleId:ag.ruleId,partyId:ag.partyId,prodId:ag.prodId,offerId:ag.offerId,attachSepcId:ag.attachSepcId,state:ag.state,relaSeq:ag.relaSeq,num:ag.num};OrderInfo.attach2Coupons.push(ad)}}}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"&&this.busiObj.offerTypeCd=="2"){var W=this;var Y="";$.each(order.memberChange.oldmembers.objInstId,function(){if(this.instId==W.busiObj.instId){Y=this.objInstId;return false}});AttachOffer.delOffer(Y,this.busiObj.instId,"reload")}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(this.data.boServs[0].state=="ADD"){var W=this;var Z=false;$.each(AttachOffer.openServList,function(){if(this.prodId==W.data.boServOrders[0].servId){$.each(this.servSpecList,function(){if(this.servSpecId==W.data.boServOrders[0].servSpecId){Z=true;return false}})}});if(!Z){var ai="N";if(W.data.boServItems!=undefined){ai="Y"}S(this.busiObj.instId,W.data.boServOrders[0].servSpecId,W.data.boServOrders[0].servSpecName,ai);if(ai=="Y"){var ac=CacheData.getServSpec(this.busiObj.instId,W.data.boServOrders[0].servSpecId);if(!!ac.prodSpecParams){for(var am=0;am<ac.prodSpecParams.length;am++){var ab=ac.prodSpecParams[am];var X=CacheData.getServSpecParam(this.busiObj.instId,W.data.boServOrders[0].servSpecId,ab.itemSpecId);$.each(W.data.boServItems,function(){if(X.itemSpecId==this.itemSpecId){X.setValue=this.value}})}}$("#can_"+this.busiObj.instId+"_"+W.data.boServOrders[0].servSpecId,ab.itemSpecId).removeClass("canshu").addClass("canshu2");var af=CacheData.getServSpec(this.busiObj.instId,W.data.boServOrders[0].servSpecId,ab.itemSpecId);af.isset="Y"}}}else{if(this.data.boServs[0].state=="DEL"){AttachOffer.closeServ(this.busiObj.instId,this.data.boServOrders[0].servId,"reload")}}}}}});$.each(AttachOffer.openList,function(){var W=this;$.each(this.specList,function(){var Y=this;var X=false;$.each(V,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){if(this.busiObj.objId==Y.offerSpecId){X=true;
return false}}});if(!X){AttachOffer.delOfferSpec(W.prodId,this.offerSpecId,"reload")}})});$.each(AttachOffer.openServList,function(){var W=this;$.each(this.servSpecList,function(){var Y=this;var X=false;$.each(V,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(Y.servSpecId==this.data.boServOrders[0].servSpecId&&W.prodId==this.busiObj.instId){X=true;return false}}});if(!X){var Z=$("#li_"+W.prodId+"_"+this.servSpecId).find("span");var aa=CacheData.getServSpec(W.prodId,this.servSpecId);if(aa==undefined){return}Z.addClass("del");aa.isdel="Y";AttachOffer.showHideUim(1,W.prodId,this.servSpecId);var ab=CacheData.getServBySpecId(W.prodId,this.servSpecId);if(ec.util.isObj(ab)){Z.addClass("del");ab.isdel="Y"}}})});$.each(V,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="14"){var W=this.busiObj.instId;$("#uim_check_btn_"+W).attr("disabled",true);$("#uim_check_btn_"+W).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+W).attr("disabled",false);$("#uim_release_btn_"+W).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+W).attr("disabled",true);$.each(this.data.bo2Coupons,function(){if(this.state=="ADD"){$("#uim_txt_"+W).val(this.terminalCode);var X={couponUsageTypeCd:this.couponUsageTypeCd,cardTypeFlag:this.cardTypeFlag,inOutTypeId:this.inOutTypeId,inOutReasonId:this.inOutReasonId,saleId:this.saleId,couponId:this.couponId,couponinfoStatusCd:this.couponinfoStatusCd,chargeItemCd:this.chargeItemCd,couponNum:this.couponNum,storeId:this.storeId,storeName:this.storeName,agentId:this.agentId,apCharge:this.apCharge,couponInstanceNumber:this.couponInstanceNumber,terminalCode:this.terminalCode,ruleId:this.ruleId,partyId:this.partyId,prodId:this.prodId,offerId:this.offerId,state:this.state,relaSeq:this.relaSeq};OrderInfo.clearProdUim(W);OrderInfo.boProd2Tds.push(X)}})}})}};function u(V){$.callServiceAsHtmlGet(contextPath+"/token/pad/order/orderSpecParam",V,{done:function(X){if(X&&X.code==-2){if(V.prodId!=-1&&V.prodId!="-1"){$("#"+V.ul_id).append("<li><label> </label></li>")}return}else{if(X&&(X.data==0||X.data=="0")){if(V.prodId!=-1&&V.prodId!="-1"){$("#"+V.ul_id).append("<li><label> </label></li>")}return}}$("#"+V.ul_id).append(X.data);var Z='<div class="optional"> 可选包/功能产品 <a href="#optional_'+V.prodId+'" data-role="button" data-icon="optional" data-iconpos="notext" data-theme="i" class="ui-link ui-btn ui-btn-i ui-icon-optional ui-btn-icon-notext ui-shadow ui-corner-all">可选包/功能产品</a> </div>';$("#"+V.ul_id).append(Z);$.jqmRefresh($("#order_tab_panel_content"));N(V.prodId,$("#"+V.ul_id));var ab=$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+V.prodId);if(ab.length==1){if(OrderInfo.actionFlag==6||(OrderInfo.actionFlag==2&&offerChange.newMemberFlag)){var Y=false;if(OrderInfo.prodInstAttrs&&OrderInfo.prodInstAttrs.length){$.each(OrderInfo.prodInstAttrs,function(){if(this.itemSpecId==CONST.PROD_ATTR.IS_XINKONG){$(ab).val(this.value);Y=true}})}if(Y){$(ab).attr("disabled","disabled")}else{$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+V.prodId+" option[value='']").remove();$(ab).val("20");if(OrderInfo.offerSpec.feeType==CONST.PAY_TYPE.BEFORE_PAY){$(ab).attr("disabled","disabled")}}}else{if(OrderInfo.actionFlag!=1&&OrderInfo.actionFlag!=14){$(ab).attr("disabled","disabled")}else{$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+V.prodId+" option[value='']").remove();$(ab).val("20");if(OrderInfo.offerSpec.feeType==CONST.PAY_TYPE.BEFORE_PAY){$(ab).attr("disabled","disabled")}}}}$.each(OrderInfo.newOrderInfo.checkMaskList,function(){$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+this.prodId+"").find("option[value='"+this.isCheckMask+"']").attr("selected","selected")});if(OrderInfo.newOrderInfo.isReloadFlag=="N"){var aa=$("select[name='pay_type_-1']").find("option:selected").val();if(aa=="2100"){order.main.feeTypeCascadeChange($("select[name='pay_type_-1']"),"-1")}}if(order.memberChange.reloadFlag=="N"||OrderInfo.newOrderInfo.isReloadFlag=="N"){var W="";if(order.memberChange.rejson&&order.memberChange.rejson.orderList&&order.memberChange.rejson.orderList.custOrderList[0].busiOrder){W=order.memberChange.rejson.orderList.custOrderList[0].busiOrder}else{if(OrderInfo.newOrderInfo.result&&OrderInfo.newOrderInfo.result.orderList.custOrderList[0].busiOrder){W=OrderInfo.newOrderInfo.result.orderList.custOrderList[0].busiOrder}}$.each(W,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){var ac=this.data.boProdItems;$("[name=prodSpec_"+this.busiObj.instId+"]").each(function(){var ag=this.tagName;var ae=$(this).attr("id").split("_")[0];var ad=$(this).attr("id");for(var af=0;af<ac.length;af++){if(ac[af].itemSpecId==ae&&ad.split("_")[1]==ac[af].prodSpecItemId){if(ag=="SELECT"){$("#"+ad+" option[value='"+ac[af].value+"']").attr("selected","selected")}else{$("#"+ad).val(ac[af].value)}}}})}})}},fail:function(W){$.unecOverlay()}})}var F=function(){if(order.cust.fromProvFlag=="1"&&ec.util.isObj(order.cust.provIsale)){$("#orderProvAttrIsale").val(order.cust.provIsale)}};var M=function(ak,ac,aa){var ag=ak.orderList.custOrderList[0].busiOrder;var ai="";var W="";var ah="";var Z="";var Y="";var X="";var V="";var aj="";var ae="";var ab="";var af="";var ad="";$.each(AttachOffer.openList,function(am,al){$.each(al.specList,function(ao,an){if(!order.service.compareOrder(ag,an.offerSpecId,al.prodId)){AttachOffer.delOfferSpecReload(al.prodId,an.offerSpecId)}})});$.each(AttachOffer.openServList,function(al,am){$.each(am.servSpecList,function(ao,an){var aq=an.servSpecId;var ap=an.servSpecName;if(!order.service.compareServOrder(ag,aq,am.prodId)){AttachOffer.closeServSpecReload(am.prodId,aq,ap,an.ifParams)}})});$.each(ag,function(ar,aB){if(aB.boActionType.actionClassCd==1300&&aB.boActionType.boActionTypeCd=="1"){var aI=aB.busiObj.instId;var ay=aB.busiObj.accessNumber;var aU=aB.data.bo2Coupons[0].terminalCode;var aD=aB.data.boProdFeeTypes[0].feeType;var aP=aB.data.boProdPasswords[0].prodPwTypeCd;var at=aB.data.boProdPasswords[0].pwd;var aE="20";if(aB.data.boProdItems&&aB.data.boProdItems[0].itemSpecId){var aO=aB.data.boProdItems[0].itemSpecId;if(aO=="40010030"){aE=aB.data.boProdItems[0].value}var aL={};aL.itemSpecId=aO;aL.prodId=aI;aL.isCheckMask=aE;OrderInfo.newOrderInfo.checkMaskList.push(aL);$("#"+aO+"_"+aI+"").find("option[value='"+aE+"']").attr("selected","selected")}$("#nbr_btn_"+aI).html(ay+"<u></u>");var aK={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};OrderInfo.boProdAns.push(aK);order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);$("#uim_txt_"+aI).attr("disabled",true);$("#uim_txt_"+aI).val(aU);$("#uim_check_btn_"+aI).attr("disabled",true);$("#uim_check_btn_"+aI).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+aI).attr("disabled",false);$("#uim_release_btn_"+aI).removeClass("disablepurchase").addClass("purchase");var aw={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};
OrderInfo.clearProdUim(this.busiObj.instId);OrderInfo.boProd2Tds.push(aw);var al=$("select[name='pay_type_"+aI+"']");$(al).find("option[value='"+aD+"']").attr("selected","selected");$("#pwd_"+aI).val(at)}if(aB.boActionType.actionClassCd==1100&&aB.boActionType.boActionTypeCd=="A1"){if(aB.data.boAccountInfos.length>0){ai=aB.data.boAccountInfos[0].acctCd;W=aB.data.boAccountInfos[0].acctName;OrderInfo.newOrderInfo.acctCd=ai;OrderInfo.newOrderInfo.acctName=W}if(aB.data.boAccountMailings&&aB.data.boAccountMailings.length>0){Z=aB.data.boAccountMailings[0].mailingType;Y=aB.data.boAccountMailings[0].param1;X=aB.data.boAccountMailings[0].param2;V=aB.data.boAccountMailings[0].param3;aj=aB.data.boAccountMailings[0].param7;OrderInfo.newOrderInfo.mailingType=Z;OrderInfo.newOrderInfo.param1=Y;OrderInfo.newOrderInfo.param2=X;OrderInfo.newOrderInfo.param3=V;OrderInfo.newOrderInfo.param7=aj}if(aB.data.boPaymentAccounts&&aB.data.boPaymentAccounts.length>0){ae=aB.data.boPaymentAccounts[0].bankAcct;ab=aB.data.boPaymentAccounts[0].bankId;limitQty=aB.data.boPaymentAccounts[0].limitQty;af=aB.data.boPaymentAccounts[0].paymentMan;ad=aB.data.boPaymentAccounts[0].paymentAcctTypeCd;OrderInfo.newOrderInfo.bankAcct=ae;OrderInfo.newOrderInfo.bankId=ab;OrderInfo.newOrderInfo.limitQty=limitQty;OrderInfo.newOrderInfo.paymentMan=af;OrderInfo.newOrderInfo.paymentAcctTypeCd=ad}}else{if(aB.boActionType.actionClassCd=="1300"&&aB.boActionType.boActionTypeCd=="1"){if(aB.data.boAccountRelas&&aB.data.boAccountRelas.length>0){ai=aB.data.boAccountRelas[0].acctCd;ah=aB.data.boAccountRelas[0].acctId}}else{ai=""}}var aC=AttachOffer.openList;var aT=$.extend(true,[],AttachOffer.openList);var an=AttachOffer.openServList;var aS=$.extend(true,[],AttachOffer.openServList);var aH=[];var ax=[];if(aB.boActionType.actionClassCd=="1200"&&aB.boActionType.boActionTypeCd=="S1"){var am=aB;$.each(AttachOffer.openList,function(){if(this.prodId==am.data.ooRoles[0].prodId){var aV=false;$.each(this.specList,function(){if(this.offerSpecId==am.busiObj.objId){aV=true;return false}});if(!aV){AttachOffer.addOfferSpecReload(this.prodId,am.busiObj.objId);if(am.data.bo2Coupons!=undefined){for(var aY=0;aY<am.data.bo2Coupons.length;aY++){var aX=am.data.bo2Coupons[aY];if(aY==0){$("#terminalText_"+aX.prodId+"_"+aX.attachSepcId+"_"+aX.num).val(aX.couponInstanceNumber);AttachOffer.checkTerminalCodeReload($("#terminalBtn_"+aX.prodId+"_"+aX.attachSepcId+"_"+aX.num))}else{AttachOffer.addAndDelTerminal($("#terminalAddBtn_"+aX.prodId+"_"+aX.attachSepcId));$("#terminalText_"+aX.prodId+"_"+aX.attachSepcId+"_"+aX.num).val(aX.couponInstanceNumber);AttachOffer.checkTerminalCodeReload($("#terminalBtn_"+aX.prodId+"_"+aX.attachSepcId+"_"+aX.num))}var aW={couponUsageTypeCd:aX.couponUsageTypeCd,inOutTypeId:aX.inOutTypeId,inOutReasonId:aX.inOutReasonId,saleId:aX.saleId,couponId:aX.couponId,couponinfoStatusCd:aX.couponinfoStatusCd,chargeItemCd:aX.chargeItemCd,couponNum:aX.couponNum,storeId:aX.storeId,storeName:aX.storeName,agentId:aX.agentId,apCharge:aX.apCharge,couponInstanceNumber:aX.couponInstanceNumber,ruleId:aX.ruleId,partyId:aX.partyId,prodId:aX.prodId,offerId:aX.offerId,attachSepcId:aX.attachSepcId,state:aX.state,relaSeq:aX.relaSeq,num:aX.num};OrderInfo.attach2Coupons.push(aW)}}}}});if(am.data.ooRoles[0].prodId>0){AttachOffer.addOfferSpecReload(am.data.ooRoles[0].prodId,am.busiObj.objId)}}else{if(aB.boActionType.actionClassCd=="1300"&&aB.boActionType.boActionTypeCd=="7"){if(aB.data.boServs[0].state=="ADD"){var am=aB;$.each(AttachOffer.openServList,function(){if(this.prodId==am.busiObj.instId){var aV=false;$.each(this.servSpecList,function(){if(this.servSpecId==am.data.boServOrders[0].servSpecId){aV=true;return false}});if(!aV){var aW="N";if(am.data.boServItems!=undefined){aW="Y"}AttachOffer.openServSpecReload(this.prodId,am.data.boServOrders[0].servSpecId,am.data.boServOrders[0].servSpecName,aW)}}});if(am.busiObj.instId>0){var aJ="N";if(am.data.boServItems!=undefined){aJ="Y"}AttachOffer.openServSpecReload(am.busiObj.instId,am.data.boServOrders[0].servSpecId,am.data.boServOrders[0].servSpecName,aJ)}}}}if(ai!=""&&ai!=-1){var aR={acctCd:ai,isServiceOpen:"Y"};$.callServiceAsJson(contextPath+"/order/account",aR,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(aV){if(aV.code==-2){$.alertM(aV.data);return}if(aV.code==0){var aY=aV.data.accountInfos;var aW=aV.data;var aX=false;if(aW.resultCode==0){if(aW.accountInfos&&aW.accountInfos.length>0){$("#accountDiv").find("label:eq(0)").text("主卡帐户：");$.each(aV.data.accountInfos,function(a0,aZ){if(ah==aZ.acctId){aY=aZ;$("<option>").text(aZ.name+" : "+aZ.accountNumber).attr("value",aZ.acctId).attr("acctcd",aZ.accountNumber).appendTo($("#acctSelect"));$("#acctSelect").find("option[value="+aZ.acctId+"]").attr("selected","selected");aX=true;return false}});$("#accountDiv").find("a:eq(0)").hide();$("#acctSelect").find("option[value='-1']").remove();$("#acctSelect").parent().find("a:eq(1)").show();$("#defineNewAcct").hide()}else{$.alert("提示","没有查询到帐户合同号对应的帐户信息")}}else{$.alertM(aW.resultMsg)}$(this).dispatchJEvent("chooseAcct",aY);$("#defineNewAcct").hide()}else{$("<tr><td colspan=4>"+aV.data+"</td</tr>").appendTo($("#acctListTab tbody"))}$("#acctListTab tr").off("click")}})}var ap=ak.orderList.orderListInfo;var aG=ap.isTemplateOrder;var av=ap.custOrderAttrs;var aq="";var az="";var aN="";var ao="1";var aF="";var aQ="";var aM="";$.each(av,function(aV,aW){if(aW.itemSpecId=="111111118"){aq=aW.value}else{if(aW.itemSpecId=="30010020"){az=aW.value}else{if(aW.itemSpecId=="30010025"){aN=aW.value}else{if(aW.itemSpecId=="30010026"){aF=aW.value}else{if(aW.itemSpecId=="30010021"){aQ=aW.value}else{if(aW.itemSpecId=="30010022"){aM=aW.value}}}}}}});$("#order_remark").val(aq);if(aG=="Y"){$("#isTemplateOrder").css("checked",true);var au=ap.templateOrderName;var aA=ap.templateType;$(".template_info_name").show();$(".template_info_type").show();$("#isActivation").removeAttr("checked");$("#isActivation").attr("disabled","disabled");$("#templateOrderName").val(au);$("#template_info_type").find("option[value='"+aA+"']").attr("selected",true)}$("#orderAttrName").val(az);$("#orderPartyTypeCd").find("option[value='"+ao+"']").attr("selected",true);$("#orderAttrPhoneNbr").val(aN);$("#orderIdentidiesTypeCd").find("option[value='"+aF+"']").attr("selected",true);$("#orderAttrIdCard").val(aQ);$("#orderAttrAddr").val(aM)});$("#dealerTbody").empty();order.service.dealDevelopingPerson(ag,OrderInfo.newOrderInfo.prodOfferId,OrderInfo.newOrderInfo.prodOfferName)};function N(V,X){var W=CONST.PROD_ATTR.PROD_USER+"_"+V;if($("#"+W).length>0){if(OrderInfo.actionFlag==1){$("#"+W).attr({readonly:"readonly",disabled:"disabled"}).hide();$("#"+W).attr({readonly:"readonly",disabled:"disabled"}).parent().parent().parent().parent().hide();$("#choose_user_btn_"+V).off("click").hide();$("#choose_user_btn_"+V).parent().hide();if(OrderInfo.actionFlag==6||OrderInfo.actionFlag==2){$("#MEMBERDIV_"+V).hide()}}if(OrderInfo.actionFlag==6){$("#MEMBERDIV_"+V).hide()}}}return{buildMainView:m,spec_parm:q,spec_member_parm:u,check_parm:i,queryScroll:y,queryStaff:K,queryStaffPage:o,setStaff:R,chooseAcct:I,check_parm_self:w,createAcct:H,createAcctWithId:E,showNewAcct:c,acctDetail:s,spec_parm_change_save:L,paymethodChange:a,templateTypeCheck:U,lastStep:t,genRandPass6:T,genRandPass6Input:O,passwordCheckInput:r,passwordCheckVal:Q,checkIncreace6:d,feeTypeCascadeChange:b,newProdReload:x,loadAttachOffer:P,reload:l,initAcct:h}})();CommonUtils.regNamespace("order","dealer");order.dealer=(function(){var b=function(F){if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:"40020005",NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:"40020006",NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:"40020007",NAME:"第三发展人"}]}else{$.ecOverlay("<strong>正在查询发展人类型中,请稍后....</strong>");var l=$.callServiceAsJson(contextPath+"/order/queryPartyProfileSpecList",null);$.unecOverlay();if(l.code==0){OrderInfo.order.dealerTypeList=l.data}else{if(l.code==-2){$.alertM(l.data);
return}else{$.alert("信息提示",l.msg);return}}if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){OrderInfo.getChannelList()}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==14){var o=OrderInfo.offerSpec.offerSpecId;var u=$("<li id='tr_"+o+"' name='tr_"+o+"'></li>");var y=$("<dl></dl>");var x=$("<dd> </dd>");var z=$('<fieldset data-role="fieldcontain"></fieldset>');var v=o+"_"+OrderInfo.SEQ.dealerSeq;var D=$('<select id="dealerType_'+v+'" name="dealerType_'+o+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+o+"',a)\"></select>");if(order.ysl!=undefined){D.append("<option value='40020005'>第一发展人</option>");D.append("<option value='40020006'>第二发展人</option>");D.append("<option value='40020007'>第三发展人</option>")}else{$.each(OrderInfo.order.dealerTypeList,function(){D.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")})}z.append(D);x.append(z);var B="主套餐";y.append("<dd>"+B+"</dd>");y.append("<dd>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</dd>");y.append(x);if(OrderInfo.salesCode!=null&&OrderInfo.salesCode!=""&&OrderInfo.salesCode!="null"&&OrderInfo.salesCode!=undefined){var t={dealerId:"",areaId:"",currentAreaAllName:"",staffName:"",staffCode:OrderInfo.salesCode,staffCode2:OrderInfo.salesCode,salesCode:"",pageIndex:1,objInstId:o,pageSize:10};var q=contextPath+"/token/pad/staffMgr/getStaffList";$.ecOverlay("<strong>正在查询发展人的服务中,请稍后....</strong>");var l=$.callServiceAsJson(q,t);$.unecOverlay();var m=l.code;if(m==0){var G=l.data.result;OrderInfo.staff.staffId=G[0].staffId;OrderInfo.staff.staffName=G[0].staffName}}if(order.ysl!=undefined){var E=$('<dd><input type="text" id="dealer_'+v+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true"></input></dd>');y.append(E)}else{var E=$('<dd><input type="text" id="dealer_'+v+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');y.append(E)}var p='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';p+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+v+"');\">选择</button></div>";p+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+o+',1)">添加</button></div></div></dd>';y.append(p);var k=$("<dd></dd>");var n=$('<select id="dealerChannel_'+v+'" name="dealerChannel_'+o+'" class="inputWidth183px" onclick=a=this.value;></select>');if(OrderInfo.provinceInfo.reloadFlag=="N"){var w=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;var s="";for(var C=0;C<w.length;C++){if(w[C].boActionType.actionClassCd=="1200"&&w[C].boActionType.boActionTypeCd=="S1"&&w[C].busiObj.offerTypeCd=="1"){var r=w[C].data.busiOrderAttrs;for(var A=0;A<r.length;A++){if(r[A].channelNbr!=undefined){s=r[A].channelNbr;break}}}}for(var C=0;C<OrderInfo.channelList.length;C++){if(OrderInfo.channelList[C].channelNbr==s){n.append("<option value='"+OrderInfo.channelList[C].channelNbr+"' selected ='selected'>"+OrderInfo.channelList[C].channelName+"</option>")}else{n.append("<option value='"+OrderInfo.channelList[C].channelNbr+"'>"+OrderInfo.channelList[C].channelName+"</option>")}}}else{$.each(OrderInfo.channelList,function(){if(this.isSelect==1){n.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{n.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}})}k.append(n);k.append('<label class="f_red">*</label>');y.append(k);u.append(y);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(u);$.jqmRefresh($("#dealerTbody"))}if(OrderInfo.actionFlag==6){if(OrderInfo.salesCode!=null&&OrderInfo.salesCode!=""&&OrderInfo.salesCode!="null"&&OrderInfo.salesCode!=undefined){var t={dealerId:"",areaId:"",currentAreaAllName:"",staffName:"",staffCode:OrderInfo.salesCode,staffCode2:OrderInfo.salesCode,salesCode:"",pageIndex:1,objInstId:o,pageSize:10};var q=contextPath+"/token/pad/staffMgr/getStaffList";$.ecOverlay("<strong>正在查询发展人的服务中,请稍后....</strong>");var l=$.callServiceAsJson(q,t);$.unecOverlay();var m=l.code;if(m==0){var G=l.data.result;OrderInfo.staff.staffId=G[0].staffId;OrderInfo.staff.staffName=G[0].staffName}}if(order.memberChange.newMemberFlag){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var J=this.prodInstId;var T=$("<li id='tr_"+J+"' name='tr_"+J+"'></li>");var O=$("<dl></dl>");var R=$("<dd></dd>");var X=$('<fieldset data-role="fieldcontain"></fieldset>');var K=J+"_"+OrderInfo.SEQ.dealerSeq;var N=$('<select id="dealerType_'+K+'" name="dealerType_'+J+'" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+J+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){N.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});X.append(N);R.append(X);var M="未选号";if(this.accNbr!=undefined&&this.accNbr!=""){M=prodInst.accNbr}O.append("<dd>"+M+"</dd>");O.append("<dd>"+this.objName+"</dd>");O.append(R);var S=$('<dd><input type="text" id="dealer_'+K+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');O.append(S);var H='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';H+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+K+"');\">选择</button></div>";H+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+J+',1)">添加</button></div></div></dd>';O.append(H);var L=$("<dd></dd>");var W=$('<select id="dealerChannel_'+K+'" name="dealerChannel_'+J+'" class="inputWidth183px" onclick=a=this.value;></select>');if(order.memberChange.reloadFlag=="N"){var V=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;var U="";for(var Q=0;Q<V.length;Q++){if(V[Q].boActionType.actionClassCd=="1300"&&V[Q].boActionType.boActionTypeCd=="1"){var I=V[Q].data.busiOrderAttrs;for(var P=0;P<I.length;P++){if(I[P].channelNbr!=undefined){U=I[P].channelNbr;break}}}}for(var Q=0;Q<OrderInfo.channelList.length;Q++){if(OrderInfo.channelList[Q].channelNbr==U){W.append("<option value='"+OrderInfo.channelList[Q].channelNbr+"' selected ='selected'>"+OrderInfo.channelList[Q].channelName+"</option>")}else{W.append("<option value='"+OrderInfo.channelList[Q].channelNbr+"'>"+OrderInfo.channelList[Q].channelName+"</option>")}}}else{$.each(OrderInfo.channelList,function(){if(this.isSelect==1){W.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{W.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}})}L.append(W);L.append('<label class="f_red">*</label>');O.append(L);T.append(O);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(T);$.jqmRefresh($("#dealerTbody"))})})}if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){var I=this.offerSpecId;var R=$("<li id='tr_"+I+"' name='tr_"+I+"'></li>");var N=$("<dl></dl>");var O=$("<dd></dd>");var T=$('<fieldset data-role="fieldcontain"></fieldset>');var J=I+"_"+OrderInfo.SEQ.dealerSeq;var P=true;$.each(OrderInfo.order.dealerTypeList,function(){var U=this.PARTYPRODUCTRELAROLECD;$("select[name='dealerType_"+I+"']").each(function(){if(U==$(this).val()){P=false}})});if(!P){return}var M=$('<select id="dealerType_'+J+'" name="dealerType_'+I+'" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+I+"',a)\"></select>");if(order.ysl!=undefined){M.append("<option value='40020005'>第一发展人</option>");M.append("<option value='40020006'>第二发展人</option>");M.append("<option value='40020007'>第三发展人</option>")}else{$.each(OrderInfo.order.dealerTypeList,function(){M.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")
})}T.append(M);O.append(T);var L="主套餐";N.append("<dd>"+L+"</dd>");N.append("<dd>"+this.offerSpecName+"包含接入产品）</dd>");N.append(O);if(order.ysl!=undefined){var Q=$('<dd><input type="text" id="dealer_'+J+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true"></input></dd>')}else{var Q=$('<dd><input type="text" id="dealer_'+J+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly"></input></dd>')}N.append(Q);var H='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';H+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+J+"');\">选择</button></div>";H+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+I+',1)">添加</button></div></div></dd>';N.append(H);var K=$("<dd></dd>");var S=$('<select id="dealerChannel_'+J+'" name="dealerChannel_'+I+'" class="inputWidth183px" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){S.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{S.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});K.append(S);K.append('<label class="f_red">*</label>');N.append(K);R.append(N);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(R);$.jqmRefresh($("#dealerTbody"))})}}if(OrderInfo.actionFlag==13){var o=$("#mktResId").val();var u=$("<li id='tr_"+o+"' name='tr_"+o+"'></li>");var y=$("<dl></dl>");var x=$("<dd></dd>");var z=$('<fieldset data-role="fieldcontain"></fieldset>');var v=o+"_"+OrderInfo.SEQ.dealerSeq;var D=$('<select id="dealerType_'+v+'" name="dealerType_'+o+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+o+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){D.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});z.append(D);x.append(z);y.append(x);var E=$('<dd><input type="text" id="dealer_'+v+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');y.append(E);var p='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';p+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+v+"');\">选择</button></div>";p+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+o+',1)">添加</button></div></div></dd>';y.append(p);u.append(y);OrderInfo.SEQ.dealerSeq++;$("#dealerMktTbody").append(u);$.jqmRefresh($("#dealerMktTbody"))}if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){var I=this.offerSpecId;var Q=$("<li id='tr_"+I+"' name='tr_"+I+"'></li>");var M=$("<dl></dl>");var N=$("<dd></dd>");var R=$('<fieldset data-role="fieldcontain"></fieldset>');var J=I+"_"+OrderInfo.SEQ.dealerSeq;var O=true;$.each(OrderInfo.order.dealerTypeList,function(){var S=this.PARTYPRODUCTRELAROLECD;$("select[name='dealerType_"+I+"']").each(function(){if(S==$(this).val()){O=false}})});if(!O){return}var L=$('<select id="dealerType_'+J+'" name="dealerType_'+I+'" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+I+"',a)\"></select>");if(order.ysl!=undefined){L.append("<option value='40020005'>第一发展人</option>");L.append("<option value='40020006'>第二发展人</option>");L.append("<option value='40020007'>第三发展人</option>")}else{$.each(OrderInfo.order.dealerTypeList,function(){L.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")})}R.append(L);N.append(R);var K="主套餐";M.append("<dd>"+K+"</dd>");M.append("<dd>"+this.offerSpecName+"包含接入产品）</dd>");M.append(N);if(order.ysl!=undefined){var P=$('<dd><input type="text" id="dealer_'+J+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true"></input></dd>')}else{var P=$('<dd><input type="text" id="dealer_'+J+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly"></input></dd>')}M.append(P);var H='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';H+="<button data-mini=\"ture\" onclick=\"javascript:order.main.queryStaff('dealer','"+J+"');\">选择</button></div>";H+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+I+',1)">添加</button></div></div></dd>';M.append(H);Q.append(M);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(Q);$.jqmRefresh($("#dealerTbody"))})}}};var e=function(k,n,m){var l=0;$("select[name="+n+"]").each(function(){if($(this).val()==$(k).val()){l++}});if(l>1){$.alert("信息提示","每个业务的发展人类型不能重复");$(k).val(m)}};var d=function(){$("input[name=attach_dealer]:checked").each(function(){var m=$(this).attr("id");var r=m.split("_")[0];if($("#tr_"+m)[0]==undefined){var l=m+"_"+OrderInfo.SEQ.dealerSeq;var s=c(m,l);if(s==undefined){return false}var t=$("#atr_"+m);var v=$('<li name="tr_'+m+'"></li>');var p=$("<dl></dl>");p.append("<dd>"+t.children().eq(1).text()+"</dd>");p.append("<dd>"+t.children().eq(2).text()+"</dd>");p.append(s);var x=$("#tr_"+r).find("input");var q=1;var o="";if(x[0]==undefined){q=OrderInfo.staff.staffId;o=OrderInfo.staff.staffName}else{q=x.attr("staffId");o=x.attr("value")}if(order.ysl!=undefined){var u=$('<dd><input type="text" id="dealer_'+l+'" name="dealer_'+m+'" staffId="'+q+'" value="'+o+'"  data-mini="true"></input></dd>');p.append(u)}else{var u=$('<dd><input type="text" id="dealer_'+l+'" name="dealer_'+m+'" staffId="'+q+'" value="'+o+'"  data-mini="true"  readonly="readonly"></input></dd>');p.append(u)}var k='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';k+="<button data-mini=\"ture\" onclick=\"order.main.queryStaff('dealer','"+l+"');\">选择</button></div>";k+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+m+"')\">添加</button></div>";k+=' <div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';p.append(k);var n=$("<dd></dd>");var w=$('<select id="dealerChannel_'+l+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){w.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{w.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});n.append(w);n.append('<label class="f_red">*</label>');p.append(n);v.append(p);$("#dealerTbody").append(v);$.jqmRefresh($("#dealerTbody"));OrderInfo.SEQ.dealerSeq++}});$("#div_attach_choose").popup("close")};var f=function(q,l,u){var v=$(q).parent().parent().parent().parent().parent();var m=l+"_"+OrderInfo.SEQ.dealerSeq;var r=c(l,m);if(r==undefined){return}var t=$('<li name="tr_'+l+'"></li>');var p=$("<dl></dl>");if(OrderInfo.actionFlag!=13){p.append("<dd>"+v.find("dd").eq(0).text()+"</dd>");p.append("<dd>"+v.find("dd").eq(1).text()+"</dd>")}p.append(r);if(order.ysl!=undefined){var s=$('<dd><input type="text" id="dealer_'+m+'" name="dealer_'+l+'" staffId="'+v.find("input").attr("staffId")+'" value="'+v.find("input").attr("value")+'"  data-mini="true"></input></dd>');p.append(s)}else{var s=$('<dd><input type="text" id="dealer_'+m+'" name="dealer_'+l+'" staffId="'+v.find("input").attr("staffId")+'" value="'+v.find("input").attr("value")+'"  data-mini="true"  readonly="readonly"></input></dd>');p.append(s)}var k='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';k+="<button data-mini=\"ture\" onclick=\"order.main.queryStaff('dealer','"+m+"');\">选择</button></div>";k+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';p.append(k);var o=$("<dd></dd>");var w=v.find("dd select[name='dealerChannel_"+l+"']").clone();
$(w).attr("id","dealerChannel_"+m);$(w).empty();var n="";$(v.find("dd select[name='dealerChannel_"+l+"']")).find("option").each(function(){var x=$(this).val();var y=$(this).html();if(this.selected==true){n+="<option value='"+x+"' selected ='selected'>"+y+"</option>"}else{n+="<option value='"+x+"'>"+y+"</option>"}});$(w).append(n);o.append(w);o.append('<label class="f_red">*</label>');p.append(o);t.append(p);v.after(t);$.jqmRefresh($("#dealerTbody"));OrderInfo.SEQ.dealerSeq++};var i=function(l,k){$("li[name^='tr_"+l+"']").each(function(){$(this).find("dd").eq(0).text(k)})};var c=function(p,l){var o="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var r=this.PARTYPRODUCTRELAROLECD;var q=true;$("select[name='dealerType_"+p+"']").each(function(){if(r==$(this).val()){q=false;return false}});if(q){o=r;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(o==undefined||o==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var n=$("<dd></dd>");var m=$('<fieldset data-role="fieldcontain"></fieldset>');var l=p+"_"+OrderInfo.SEQ.dealerSeq;var k=$('<select id="dealerType_'+l+'" name="dealerType_'+p+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+p+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==o){k.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{k.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});m.append(k);n.append(m);return n};var j=function(){$("#attach_pop").empty();var s=$('<div id="div_attach_choose"  data-role="popup" data-transition="slideup" data-corners="false" data-overlay-theme="b" class="popwindow" data-dismissible="false"></div>');s.append('<div data-role="header" data-theme="t"> <a href="#" id="order_dealer_btn" data-role="button" data-icon="back" data-rel="back" data-iconpos="notext" class="ui-btn-right">返回</a><h1>发展人管理</h1></div>');var l=$('<div data-role="content"></div>');var v=$('<table class="searchtable"></table>');v.append("<tr><th>操作</th><th>号码</th><th>发展业务</th></tr>");$.each(AttachOffer.openList,function(){var y=this.prodId;var x=OrderInfo.getAccessNumber(y);if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var w=0;w<OrderInfo.oldprodInstInfos.length;w++){if(y==OrderInfo.oldprodInstInfos[w].prodInstId){x=OrderInfo.oldprodInstInfos[w].accNbr}}}else{x=OrderInfo.getAccessNumber(y)}if(x==undefined||x==""){x="未选号"}$.each(this.specList,function(){var A=y+"_"+this.offerSpecId;if(this.isdel!="Y"&&this.isdel!="C"&&$("li[name='tr_"+A+"']")[0]==undefined){var z=$('<tr id="atr_'+A+'" onclick="order.dealer.checkAttach(\''+A+"')\"></tr>");z.append('<td><input type="checkbox" id="'+A+'" onclick="order.dealer.checkAttach(\''+A+'\')" name="attach_dealer"/></td>');z.append("<td>"+x+"</td><td>"+this.offerSpecName+"</td>");v.append(z)}})});if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){for(var q=0;q<order.ysl.openList.length;q++){if(order.ysl.openList[q].type=="1"){var r="-1";var n=$("#choosedNumSpan").val();if(n==undefined||n==""){n="未选号"}var u="N";var p=$("#dealerTbody").find("tr");p.each(function(){if($(this).attr("name")=="tr_-1_"+order.ysl.openList[q].id){u="Y"}else{u="N"}});if(u=="N"){var m=r+"_"+order.ysl.openList[q].id;var t=$('<tr id="atr_'+m+'" onclick="order.dealer.checkAttach(\''+m+"')\"></tr>");t.append('<td><input type="checkbox" id="'+m+'" onclick="order.dealer.checkAttach(\''+m+'\')" name="attach_dealer"/></td>');t.append("<td>"+n+"</td><td>"+order.ysl.openList[q].name+"</td>");v.append(t)}}}}}l.append(v);var o='<div data-role="footer" data-position="inline" data-tap-toggle="false" data-theme="n"> <button data-inline="true" data-icon="next" id="sureAdddealer">确定</button>';o+='<button data-inline="true" data-icon="back" data-rel="back" id="closeAdddealer">取消</button></div>';s.append(l);s.append(o);var k=$.popup("#div_attach_choose",s,{width:800,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){}});$("#sureAdddealer").off("tap").on("tap",function(){d()});$("#closeAdddealer").off("tap").on("tap",function(){$("#div_attach_choose").popup("close")});if(OrderInfo.provinceInfo!=undefined&&OrderInfo.provinceInfo.prodOfferId!=undefined&&OrderInfo.provinceInfo.prodOfferId!=""){$("#order_dealer_btn").tap(function(){$("#div_attach_choose").popup("close")})}};var h=function(l){var k=$("#"+l);if(k.attr("checked")=="checked"){k.attr("checked",false)}else{k.attr("checked",true)}};var a=function(k){$(k).parent().parent().parent().parent().parent().remove();$.jqmRefresh($("#dealerTbody"))};var g=function(k){$("li[name^='tr_"+k+"']").each(function(){$(this).remove()});$.jqmRefresh($("#dealerTbody"))};return{initDealer:b,changeAccNbr:i,showOfferList:j,addProdDealer:f,addAttachDealer:d,checkAttach:h,removeDealer:a,removeAttDealer:g,changeDealer:e}})();CommonUtils.regNamespace("mktRes","terminal");mktRes.terminal=(function(g){var w="";var B=10;var x={};var k={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false};_initBuyChk=function(){k={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false}};var s=function(){if("lj"==k.buyType){OrderInfo.actionFlag=13;g("#treaty").hide();g("#agreementFie").hide();g("#phonenumberFie").hide();g("#dealerMktDiv").show()}else{if("hy"==k.buyType){OrderInfo.actionFlag=14;g("#dealerMktDiv").hide();g("#phonenumberFie").show()}}};var c=function(E,D){g("#choosedNumSpan").html(E);k.numFlag=true;k.numLevel=D;s();g("#treaty").show()};var o=function(D){if(D&&D.page&&D.page>=1){q(D.page,D.scroll)}};var q=function(F,D){var E=contextPath+"/pad/mktRes/terminal/list";var G=i(F);g.callServiceAsHtml(E,G,{before:function(){if(F==1){g.ecOverlay("<strong>查询中,请稍等...</strong>")}},always:function(){if(F==1){g.unecOverlay()}},done:function(H){if(H.code!=0){g.alert("提示","<br/>查询失败,稍后重试");return}var I=g("#div_terminal_list");if(F==1){I.html(H.data)}else{I.find("ul").append(H.data).listview("refresh")}g.jqmRefresh(I);if(D&&g.isFunction(D)){D.apply(this,[])}I.find("div.phone").off("tap").on("tap",function(){g(this).addClass("choose").parents().siblings().find("div.phone").removeClass("choose")});if(OrderInfo.busitypeflag==1){g("#btn_enter_prev").show();g("#btn_enter_prev").off("tap").on("tap",function(){g("#ul_busi_area").show();g("#order_prepare").empty()})}g("#btn_enter_terminal_detail").off("tap").on("tap",function(){var J=I.find("div.choose");if(J.length==1){l(J)}else{g.alert("提示","请先选择一款终端,再进入下一步操作.")}})}})};var i=function(K){var E=ec.util.defaultStr(g("#select_brand").val());var M=ec.util.defaultStr(g("#select_phone_type").val());var L=g("#select_price").find("option:selected");var I=L.attr("minPrice");var F=L.attr("maxPrice");var G=g("#input_phone_name").val();var H=ec.util.defaultStr(g("#select_by_type").val());if(I!=""){I=parseInt(I)*100}if(F!=""){F=parseInt(F)*100}var D=[];if(E!=""&&E!="无限"){var J={attrId:CONST.TERMINAL_SPEC_ATTR_ID.BRAND,attrValue:E};D.push(J)}if(M!=""&&M!="无限"){var J={attrId:CONST.TERMINAL_SPEC_ATTR_ID.PHONE_TYPE,attrValue:M};D.push(J)}return{mktResCd:"",mktResName:G,mktResType:"",minPrice:I,maxPrice:F,contractFlag:H,pageInfo:{pageIndex:K,pageSize:B},attrList:D}};var e=function(E,D){g(E).removeClass("selected");g(D).addClass("selected")};var y=function(H,F,G,D){g("#commCond").val(D);g("#commCond").off("keydown").on("keydown",function(J){var I=document.all?window.event:J;if(I.keyCode==13){g("#btn_term_search").click()}});var E=false;
g("#termManf_small a").each(function(){if(g(this).attr("val")==H){g(this).addClass("selected");E=true}else{g(this).removeClass("selected")}});if(!E){g("#termManf_all a").each(function(){if(g(this).attr("val")==H){g(this).addClass("selected")}else{g(this).removeClass("selected")}})}g("#priceArea a").removeClass("selected");g("#priceArea a[minPrice='"+F+"'][maxPrice='"+G+"']").addClass("selected")};var C=function(G){var D=G.data.length;var N;var I;var E;for(var H=0;H<D;H++){if(G.data[H].PHONE_BRAND){var J=g("#select_brand");N=G.data[H].PHONE_BRAND;for(var F=0;F<N.length;F++){var K=(N[F].COLUMN_VALUE_NAME).replace(/\"/g,"");J.append("<option value='"+K+"'>"+K+"</option>")}J.selectmenu("refresh")}if(G.data[H].PHONE_PRICE_AREA){var J=g("#select_price");I=G.data[H].PHONE_PRICE_AREA;for(var F=0;F<I.length;F++){var M=(I[F].COLUMN_VALUE_NAME).replace(/\"/g,"");var L=M.split("-");if(L.length!=1){minPrice=L[0];maxPrice=L[1]}else{L=L.toString();minPrice=L.substring(0,L.length-2);maxPrice='""'}J.append("<option minPrice="+minPrice+" maxPrice="+maxPrice+">"+M+"</option>");J.selectmenu().selectmenu("refresh")}}if(G.data[H].PHONE_TYPE){var J=g("#select_phone_type");E=G.data[H].PHONE_TYPE;for(var F=0;F<E.length;F++){var O=(E[F].COLUMN_VALUE_NAME).replace(/\"/g,"");J.append("<option value="+O+">"+O+"</option>")}J.selectmenu().selectmenu("refresh")}}};var t=function(){var E={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var D=contextPath+"/order/queryApConf";g.callServiceAsJsonGet(D,E,{done:C})};var a=function(){_initBuyChk();k.buyType="hy";s()};var A=function(){_initBuyChk();k.buyType="lj";s()};var l=function(E){var F={mktResTypeCd:g(E).attr("mktResTypeCd"),mktResCd:g(E).attr("mktResCd"),mktResId:g(E).attr("mktResId"),brand:g(E).attr("brand"),phoneType:g(E).attr("phoneType"),phoneColor:g(E).attr("phoneColor"),mktName:g(E).attr("mktName"),mktPrice:g(E).attr("mktPrice"),mktPicA:g(E).attr("mktPicA")};if(CONST.getAppDesc()==0){F.mktSpecCode=g(E).attr("mktSpecCode");F.pageInfo={pageIndex:1,pageSize:B};F.attrList=[];F.is4G="yes"}var D=contextPath+"/pad/mktRes/terminal/detail";g.callServiceAsHtml(D,F,{before:function(){g.ecOverlay("<strong>查询中,请稍等...</strong>")},always:function(){g.unecOverlay()},done:function(G){if(!G||G.code!=0){g.alert("提示","<br/>处理失败，请稍后重试！");return}var H=g("#div_terminal").html(G.data);H.find(".phonedetails.ui-grid-a > .ui-block-b").width(g(window).width()-342-20-10);_initBuyChk();g("#cNumA").click(function(){var I=OrderInfo.cust.custId;if(OrderInfo.cust==undefined||I==undefined||I==""){g.alert("提示","在选号码之前请先进行客户定位或者新建客户！");return}s();mktRes.phoneNbr.phoneNumDialog("terminal","Y1","01")});g("#chkTsnA").off("click").on("click",function(){u("#tsn")});g("#purchaseTermA").off("click").on("click",function(){j()});g("#btn_terminal_back").off("click").on("click",function(){order.prepare.commonTab(contextPath+"/pad/mktRes/terminal/prepare.html","order_tab_panel_terminal")});OrderInfo.actionFlag=13;order.dealer.initDealer();g.jqmRefresh(H)}})};var n=function(H){var L=g(H).attr("p_pic");var D=g(H).attr("mktResName");var I=g(H).attr("mktSalePrice");var J=g(H).attr("mktNormalSalePrice");var K=g(H).attr("mktResId");var E=g(H).attr("mktResTypeCd");var G=g(H).attr("mktSpecCode");g("#term_pic_id").attr("src",L);g("#mkt_resname_id").html(D);g("#mkt_saleprice_id").html(I+" 元");g("#mktResId").val(K);g("#mktResName").val(D);g("#price").val(J);g("#mktResType").val(E);g("#mktSpecCode").val(G);var F=k.buyType;_initBuyChk();k.buyType=F;s();g("#tsn_hid").val("");g("#tsn").val("");x={}};var p=function(E){if(E==1){k.hyType="cfsj"}else{k.hyType="gjsf"}k.hyFlag=true;s();if(!k.numFlag){g.alert("提示","请先选号！");return}var F={mktResCd:g("#mktResId").val(),agreementType:E};var D=contextPath+"/pad/mktRes/terminal/mktplan";g.callServiceAsHtmlGet(D,F,{before:function(){},always:function(){},done:function(G){if(!G){g.alert("提示","<br/>处理失败，请稍后重试！");return}if(G.code!=0){if(G.code==1006){g.alert("提示","<br/>查询不到，请稍后重试")}else{g.alert("提示","<br/>查询失败，请稍后重试")}return}g("#terminalMain").hide();g("#div_offer").show();g("#gjhyContent").html(G.data);g(".many li").bind("click",function(){var H=g(this).index();var I=g("#tabs-body .ordercona");g(this).parent().children("li").attr("class","tab-nav");g(this).attr("class","tab-nav-action");I.hide();I.eq(H).show()});g(".userorderlist li.multi").on("tap",function(){if(g(this).next(".multidiv").is(":hidden")){g(this).next(".multidiv").show().siblings(".multidiv").hide()}else{g(this).next(".multidiv").hide().siblings(".multidiv").hide()}});g(".userorderlist > li").on("tap",function(){g(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").siblings().find("li").removeClass("userorderlistlibg");g("#orderlistmenu").panel("open")});g(".userorderlist .multidiv li").on("tap",function(){g(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").parents().siblings("li").removeClass("userorderlistlibg");g("#orderlistmenu").panel("open")});g("#otabs li").bind("click",function(){var H=g(this).index();var I=g("#otabs-body > div");g(this).parent().children("li").attr("class","otab-nav");g(this).attr("class","otab-nav-action");g(this).parent().children("li").find(".ui-input-search").hide();g(this).parent().children("li").find(".ui-select").hide();g(this).children("div").show();I.hide();I.eq(H).show()});g("#phone_warp_id .otabs-body > div").hide();g("#phone_warp_id .otabs-body > div").eq(0).show();g.jqmRefresh(g("#phone_warp_id"));g("#contract_nav_agreement li").off("click").on("click",function(H){f(this,g(this).attr("itemIndex"))});g("#phone_warp_id .otabs-body tr:gt(0)").off("click").on("click",function(H){r(this)});g("#hy_nav_confirm_a").off("click").on("click",function(H){m()})}})};var f=function(D,E){if(g(D).hasClass("current")){return}g("#contract_nav_agreement li").removeClass("current");g("#tab_"+E).addClass("current");g(".contract_tab_content").hide();g("#tab_content_"+E).show()};var r=function(D){if(g(D).hasClass("plan_select")){g(D).removeClass("bg plan_select").next("#plan2ndTr").hide();return false}g("#phone_warp_id .otabs-body tr").filter(".plan_select").removeClass("bg plan_select").next("#plan2ndTr").hide();g(D).addClass("bg").addClass("plan_select");var F=g(D).attr("offerSpecId");var E=g(D).attr("agreementType");b(D,F,E)};var b=function(E,K,G){var L=g(E).next("#plan2ndTr");if(L.length>0){L.show();return}var D=order.service.queryPackForTerm(K,G,"");if(typeof(D)=="undefined"||D==null){g.alert("提示","<br/>未查到套餐，请稍后再试！");return}if(D.code==-2){g.alertM(D.data);g.unecOverlay();return}if(D.code!=0||D.data.code!="POR-0000"){g.alert("提示","<br/>未查到合适套餐，请稍后再试！");return}var J="";J+="<tr id='plan2ndTr' class='nocolor'>";J+="<td class='nopadding' colspan='7'>";J+="<div id='plan2ndDiv' class='plan_second_list cashier_tr'>";J+="  <table class='contract_list'>";J+="  <thead>";J+="    <tr>";J+="      <td class='borderLTB'>&nbsp;</td><td>套餐名称</td><td>价格</td>";J+="      <td>流量</td><td>语音分钟数</td><td>WIFI时长</td><td>点对点短信</td>";J+="      <td>点对点彩信</td><td>套餐外流量</td><td>套餐外通话分钟数</td>";J+="    </tr>";J+="  </thead>";J+="  <tbody>";var I=D.data.prodOfferInfos;if(I.length==0){g.alert("提示","<br/>未查到套餐，请稍后再试！")}for(var F=0;F<I.length;F++){var H=I[F];J+="    <tr offerSpecId='"+H.offerSpecId+"' ";J+="   offerSpecName='"+H.offerSpecName+"' ";J+="   price='"+H.price+"' >";J+="      <td></td>";J+="      <td style='width:240px;'>"+ec.util.defaultStr(H.offerSpecName)+"</td>";J+="      <td>"+ec.util.defaultStr(H.price)+"</td>";var M="";if(H.inFlux>=1024){M=H.inFlux/1024+"G"}else{M=H.inFlux+"M"}J+="      <td>"+ec.util.defaultStr(M)+"</td>";J+="      <td>"+ec.util.defaultStr(H.inVoice)+"</td>";J+="      <td>"+ec.util.defaultStr(H.inWIFI)+"</td>";J+="      <td>"+ec.util.defaultStr(H.inSMS)+"</td>";J+="      <td>"+ec.util.defaultStr(H.inMMS)+"</td>";J+="      <td style='width:140px;'>"+ec.util.defaultStr(H.outFlux)+"</td>";J+="      <td>"+ec.util.defaultStr(H.outVoice)+"</td>";J+="    </tr>"}J+="  </tbody>";J+="  </table>";J+="</div>";J+="</td>";J+="</tr>";
g(E).after(J);g("#plan2ndDiv tbody tr").off("click").on("click",function(N){h(this);N.stopPropagation()})};var h=function(F){g("#plan2ndDiv tbody tr").removeClass("plan_select2");g("#plan2ndDiv tbody tr").children(":first-child").html("");var G=g(F).attr("offerSpecId");var E=z(G,F);if(E){g(F).addClass("plan_select2");var D="<i class='terminalSelect'></i>";g(F).children(":first").html(D)}};var z=function(F,E){var D={price:g(E).attr("price"),id:"tcnum1",specId:F,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};order.service.opeSer(D);return true};var v=function(P,I){k.hyOfferSpecQty=0;k.hyOfferSpecFt=0;var K=g(I).data("__offerSpec");if(typeof(K)=="undefined"){var G={offerSpecId:Number(P)};var D=contextPath+"/order/queryOfferSpec";var H=g.callServiceAsJson(D,G);K=H.data.offerSpec;g(I).data("__offerSpec",K);if(typeof(H)=="undefined"||H==null){g.alert("提示","<br/>未查到销售品构成，请稍后再试！");return false}if(H.code!="0"||!H.isjson){g.alert("提示","<br/>未查到销售品构成，请稍后再试！");return false}if(H.data.code!="POR-0000"){g.alert("提示","<br/>未查到销售品构成，请稍后再试！");return false}}var F=SoOrder.sortOfferSpec(K);var L=F.offerRoles;k.hyOfferRoles=L;var J;var N=0;var M=0;for(J=0;J<L.length;J++){var O=L[J];if(CONST.MEMBER_ROLE_CD.VICE_CARD==L[J].memberRoleCd){if(O.roleObjs){g.each(O.roleObjs,function(){if(this.objType==2){N=this.maxQty<0?"不限制":this.maxQty;M=this.minQty<0?"0":this.minQty}})}}else{L[J].selectQty=1}}F.offerRoles=L;OrderInfo.offerSpec=F;k.hyOfferSpecFt=F.feeType;if(N==0){return true}var E=g("#termOfferSpecViceLi");E.find("input").val(M);E.find(".addinfo").html("&nbsp;&nbsp;&nbsp;"+M+"-"+N+"（张） ");E.find("a:first").off("click").on("click",function(R){var Q=parseInt(E.find("input").val());if(Q<=M){g.alert("提示","副卡数量已经达到最小值，不能再减少。");return}else{E.find("input").val(Q-1)}});E.find("a:last").off("click").on("click",function(R){var Q=parseInt(E.find("input").val());if(Q>=N){g.alert("提示","副卡数量已经达到最大值，不能再增加。");return}else{E.find("input").val(Q+1)}});easyDialog.open({container:"termOfferSpec"});g("#termOfferSpecClose").off("click").on("click",function(Q){easyDialog.close()});g("#termOfferSpecCancel").off("click").on("click",function(Q){easyDialog.close()});g("#termOfferSpecConfirm").off("click").on("click",function(R){var Q=E.find("input").val();k.hyOfferSpecQty=Q;for(J=0;J<L.length;J++){if(CONST.MEMBER_ROLE_CD.VICE_CARD==L[J].memberRoleCd){L[J].selectQty=Q}else{L[J].selectQty=1}}OrderInfo.offerSpec.offerRoles=L;easyDialog.close()});return true};var m=function(){var E=g("#plan2ndDiv tbody tr[class='plan_select2']");if(E.length!=1){g.alert("提示","请选择一个套餐！");return}var D=E.parents("#plan2ndTr").prev();if(D.length!=1){g.alert("提示","请选择一个合约！");return}mktRes.terminal.offerSpecId=D.attr("offerSpecId");k.hyFlag=true;k.hyOfferSpecId=E.attr("offerSpecId");k.hyOfferSpecName=E.attr("offerSpecName");s();g("#agreementFie").show();g("#choosedOfferPlan").html(D.attr("offerSpecName"));g("#terminalMain").attr("style","display:block");g("#div_offer").attr("style","display:none")};var d=function(H,K,D){var E={offerSpecId:K,prodId:H};var J=[];var I=AttachOffer.getSpecList(H);if(I!=undefined){for(var G=0;G<I.length;G++){if(I[G].offerSpecId!=K&&I[G].isdel!="Y"){J.push(I[G].offerSpecId)}}}var L=AttachOffer.getOfferList(H);if(L!=undefined){for(var G=0;G<L.length;G++){if(L[G].offerSpecId!=K&&L[G].isdel!="Y"){J.push(L[G].offerSpecId)}}}if(J.length>0){E.orderedOfferSpecIds=J}var F=g.callServiceAsJsonGet(contextPath+"/offer/queryExcludeDepend",{strParam:JSON.stringify(E)},{});if(F.code==0){AttachOffer.parseRuleData(F.data,K,H,D);return true}else{if(F.code==1){g.alert("提示","<strong>"+F.errorsList[0].msg+"("+F.errorsList[0].code+")</strong>")}else{g.alert("提示","数据查询异常，请稍后重试！")}}return false};var u=function(H){x={};k.tsnFlag=false;s();g("#tsn_hid").val("");var D=g(H).val();if(D==""){return}var F={instCode:D,mktResTypeCd:g("#mktResType").val(),orderNo:""};if(CONST.getAppDesc()==0){var G=g("#mktSpecCode").val();if(g.trim(G)==""){g.alert("提示","营销资源返回的规格存货编码为空！");return}if(G.length>=22){G=G.substring(0,22)}F.mktSpecCode=G}else{F.mktResId=g("#mktResId").val()}var E=contextPath+"/mktRes/terminal/checkTerminal";g.callServiceAsJson(E,F,{done:function(I){if(I&&I.code==-2){g.alertM(I.data)}else{if(I&&I.data&&I.data.code==0){if(I.data.statusCd==CONST.MKTRES_STATUS.USABLE){g.alert("提示","<br/>此终端串号可以使用");k.tsnFlag=true;s();g("#tsn_hid").val(D);x=I.data}else{g.alert("提示",I.data.message)}}else{if(I&&I.data&&I.data.message&&I.data.code==1){g.alert("提示",I.data.message)}else{g.alert("提示","<br/>校验失败，请稍后重试！")}}}}})};var j=function(){if("lj"==k.buyType){if(!k.tsnFlag){g.alert("提示","<br/>请先校验终端串号。");return}var F=g("#price").val()/100;var I=[{couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:x.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:x.mktResStoreId,storeName:"1",agentId:1,apCharge:F,couponInstanceNumber:x.instCode,ruleId:"",partyId:CONST.CUST_COUPON_SALE,prodId:0,offerId:0,state:"ADD",relaSeq:""}];if((OrderInfo.cust.custId)&&OrderInfo.cust.custId!=""){I[0].partyId=OrderInfo.cust.custId}OrderInfo.actionTypeName="订购";OrderInfo.businessName=g("#mktResName").val();var E={};E.busiObj={instId:x.mktResId};E.boActionType={actionClassCd:CONST.ACTION_CLASS_CD.MKTRES_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.COUPON_SALE};E.coupons=I;var H=g("#dealerMktDiv li[name='li_"+g("#mktResId").val()+"']");if(H.length>0){E.dealers=[];H.each(function(){var J={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:g(this).find("select").val(),value:g(this).find("input").attr("staffid")};E.dealers.push(J)})}SoOrder.getTokenSynchronize();SoOrder.submitOrder(E);return}else{if("hy"==k.buyType){if(!k.tsnFlag){g.alert("提示","<br/>请先校验终端串号。");return}if(!(OrderInfo.cust.custId)||OrderInfo.cust.custId==""){g.alert("提示","<br/>在订购套餐之前请先进行客户定位！");return}if(k.hyType==""){g.alert("提示","<br/>请选择合约!");return}}else{return}}var D={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:x.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:x.mktResStoreId,storeName:"1",agentId:1,apCharge:g("#price").val()/100,couponInstanceNumber:x.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-1,offerId:-1,attachSepcId:mktRes.terminal.offerSpecId,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){D.termTypeFlag=x.termTypeFlag}OrderInfo.attach2Coupons=[];OrderInfo.attach2Coupons.push(D);var G={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:OrderInfo.offerSpec,offerSpecId:k.hyOfferSpecId,offerSpecName:k.hyOfferSpecName,viceCardNum:Number(k.hyOfferSpecQty),feeType:k.hyOfferSpecFt,offerNum:1,type:2,actionFlag:OrderInfo.actionFlag,terminalInfo:{terminalName:g("#mktResName").val(),terminalCode:g("#tsn_hid").val()},offerRoles:k.hyOfferRoles};OrderInfo.actionTypeName="订购";SoOrder.builder();order.main.buildMainView(G)};return{btnQueryTerminal:q,initInParam:y,queryApConfig:t,selectTerminal:l,setNumber:c,offerSpecId:w,selectColor:n,scroll:o,hyClick:a,ljClick:A,selectHy:p}})(jQuery);CommonUtils.regNamespace("mktRes","phoneNbr");var phoneNum_level="";var selectedObj=null;var _queryFlag="0";mktRes.phoneNbr=(function(){var d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",areaCode:"",memberRoleCd:""};var v=function(){d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",areaCode:"",memberRoleCd:""}};var g=0;var x="";var r=[];var f=contextPath+"/pad/mktRes/phonenumber/list";var c="";var o=function(A){selectedObj=null;A=h(A);A.isReserveFlag=_queryFlag;if(_queryFlag=="1"){A.queryFlag="3"}$.callServiceAsHtmlGet(f,A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(C){if(!C||C.code!=0){C.data="查询失败,稍后重试"}var D=$("#div_number_list");D.html(C.data).fadeIn();$.jqmRefresh(D);$("#btnSwitchNbr").off("tap").on("tap",function(){o({})});$(".numberlist .ui-grid-b").on("tap",function(){var E=$(this);E.addClass("numlistbg").siblings().removeClass("numlistbg").parents().siblings().find(".ui-grid-b").removeClass("numlistbg");
if(selectedObj==E){return}selectedObj=E;g=$(selectedObj).attr("ispurchased")});var B=$("#subPage").val();if(B=="number"&&OrderInfo.busitypeflag==1){$("#btn_enter_prev").show();$("#btn_enter_prev").off("tap").on("tap",function(){$("#ul_busi_area").show();$("#order_prepare").empty()})}$("#btn_enter_phoneNum_next").off("tap").on("tap",function(){z()})},fail:function(B){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var m=function(D){var B=contextPath+"/pad/mktRes/phone/numberlist";var C={areaId:OrderInfo.getAreaId(),phoneNumber:D.phoneNum};var A=$.callServiceAsJson(B,C);if(A&&A.code==0){if(A.data){return A.data}}else{if(A.code==-2){$.alertM(A.data)}else{$.alert("提示","查询号码信息失败,稍后重试")}}};var b=function(){var A=$.trim($("#idCode").val());if(A==""){$.alert("提示","请先输入身份证号码!");return}if(!a(A)){$.alert("提示","身份证号码输入有误!");return}var C=$("#p_cust_areaId").val();var B={identityId:A,areaId:C};$.callServiceAsHtmlGet(contextPath+"/pad/mktRes/phonenumber/listByIdentity",B,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(D){if(!D||D.code!=0){D.data="查询失败,稍后重试"}var E=$("#div_number_list");E.html(D.data).fadeIn();$.jqmRefresh(E)},fail:function(D){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var e=function(N){c=$(N).attr("numberVal");var O=CONST.MEMBER_ROLE_CD.MAIN_CARD;var J=$("#subFlag").val();if(J=="Y2"){O=CONST.MEMBER_ROLE_CD.VICE_CARD}var G=$("#subnum").val();var U=$("#subPage").val();var F=c.split("_")[2];if(order.service.offerprice!=""){var W=parseInt(F);var L=parseInt(order.service.offerprice);if(L<W){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var I=c.split("_")[0];var V=c.split("_")[3];var S=x;if(x==""){S=c.split("_")[5]}var X=c.split("_")[5];var P=c.split("_")[6];var Q=$("#p_cust_areaId").val();if(Q==null||Q==""){Q=OrderInfo.staff.areaId}var A=$(N).attr("zoneNumber");if(A==null||A==""){A=OrderInfo.staff.areaCode}if(I){var C=false;var B="";var M="";if(U=="terminal"||U=="number"){B=d.accessNumber;M=d.anTypeCd}else{if(U=="offer"){for(var R=0;R<OrderInfo.boProdAns.length;R++){if(OrderInfo.boProdAns[R].prodId==G){B=OrderInfo.boProdAns[R].accessNumber;M=OrderInfo.boProdAns[R].anTypeCd;break}}for(var R=0;R<OrderInfo.boProdAns.length;R++){if(OrderInfo.boProdAns[R].prodId!=G){if(OrderInfo.boProdAns[R].accessNumber==I){$.alert("提示","你已经选择了该号码,请选择其它号码!");return}}}}}if(B!=""){C=true;for(var R=0;R<r.length;R++){if(r[R]==B){C=false;break}}if(C){var E=contextPath+"/mktRes/phonenumber/purchase";var T={oldPhoneNumber:B,oldAnTypeCd:M};$.callServiceAsJson(E,T,{})}}r.push(I);if(U=="number"){var K=$("#order_fill_content");K.html("");d.accessNumber=I;d.anTypeCd=V;d.level=S;d.org_level=X;d.anId=P;d.areaId=Q;d.areaCode=A;d.memberRoleCd=O;d.idFlag=0;order.service.boProdAn=d;q()}else{if(U=="terminal"){mktRes.terminal.setNumber(I,S);d.accessNumber=I;d.anTypeCd=V;d.level=S;d.org_level=X;d.anId=P;d.areaId=Q;d.areaCode=A;d.memberRoleCd=O;d.idFlag=0;order.service.boProdAn=d;$("#div_phoneNbr_choose").popup("close")}else{if(U=="offer"){d.anTypeCd=V;d.anId=P;d.accessNumber=I;d.level=S;d.org_level=X;d.areaId=Q;d.areaCode=A;$("#choosedNum_"+G).val(I);var D=false;if(OrderInfo.boProdAns.length>0){for(var R=0;R<OrderInfo.boProdAns.length;R++){if(OrderInfo.boProdAns[R].prodId==G){OrderInfo.boProdAns[R].accessNumber=I;OrderInfo.boProdAns[R].anTypeCd=V;OrderInfo.boProdAns[R].pnLevelId=S;OrderInfo.boProdAns[R].anId=P;OrderInfo.boProdAns[R].areaId=Q;OrderInfo.boProdAns[R].areaCode=A;OrderInfo.boProdAns[R].memberRoleCd=O;OrderInfo.boProdAns[R].idFlag=0;D=true;OrderInfo.setProdAn(OrderInfo.boProdAns[R]);order.dealer.changeAccNbr(G,I);break}}}if(!D){var H={prodId:G,accessNumber:I,anChooseTypeCd:"2",anId:P,anTypeCd:V,pnLevelId:S,state:"ADD",areaId:Q,areaCode:A,memberRoleCd:O,idFlag:0,preStore:preStoreFare,minCharge:F};OrderInfo.boProdAns.push(H)}$("#div_phoneNbr_choose").popup("close");if(G=="-1"){OrderInfo.boCustInfos.telNumber=I}}}}}else{$.alert("提示","号码格式不正确!")}};var p=function(A){if(d.accessNumber!=""){$("#choosedNum_"+A).val(d.accessNumber);order.dealer.changeAccNbr(A,d.accessNumber);var B=false;if(OrderInfo.boProdAns.length>0){for(var C=0;C<OrderInfo.boProdAns.length;C++){if(OrderInfo.boProdAns[C].prodId==A){OrderInfo.boProdAns[C].accessNumber=d.accessNumber;OrderInfo.boProdAns[C].anTypeCd=d.anTypeCd;OrderInfo.boProdAns[C].anId=d.anId;OrderInfo.boProdAns[C].pnLevelId=d.level;OrderInfo.boProdAns[C].areaId=d.areaId;OrderInfo.boProdAns[C].memberRoleCd=d.memberRoleCd;if(d.idFlag){OrderInfo.boProdAns[C].idFlag=d.idFlag}OrderInfo.setProdAn(OrderInfo.boProdAns[C]);order.dealer.changeAccNbr(A,phoneNumber);B=true;break}}}if(!B){var D={prodId:A,accessNumber:d.accessNumber,anChooseTypeCd:"2",anId:d.anId,pnLevelId:d.level,anTypeCd:d.anTypeCd,state:"ADD",areaId:d.areaId,areaCode:d.areaCode,memberRoleCd:d.memberRoleCd};if(d.idFlag){D.idFlag=d.idFlag}OrderInfo.boProdAns.push(D)}if(A=="-1"){OrderInfo.boCustInfos.telNumber=d.accessNumber}}};var q=function(){var A={numsubflag:"number"};$.callServiceAsHtmlGet(contextPath+"/pad/order/prodoffer/prepare",A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(B){if(!B||B.code!=0){B.data="查询失败,稍后重试"}var C=$("#order_prepare").html(B.data).fadeIn();$.jqmRefresh(C);order.prepare.initOffer();order.service.searchPack()},fail:function(B){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var t=function(L,P){c=$(L).attr("numberVal");var M=CONST.MEMBER_ROLE_CD.MAIN_CARD;var I=$("#subFlag").val();if(I=="Y2"){M=CONST.MEMBER_ROLE_CD.VICE_CARD}var G=$("#subnum").val();var R=$("#subPage").val();var C=c.split("_")[1];var F=c.split("_")[2];var N=$("#p_cust_areaId").val();if(N==null||N==""){N=OrderInfo.staff.areaId}var A=$(L).attr("zoneNumber");if(A==null||A==""){A=OrderInfo.staff.areaCode}if(order.service.offerprice!=""){var U=parseInt(F);var J=parseInt(order.service.offerprice);if(J<U){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var H=c.split("_")[0];var T=c.split("_")[3];if(H){var Q=$("#p_cust_areaId").val();var S={};if(P){S={phoneNumber:H,actionType:"E",anTypeCd:T,areaId:Q,attrList:[{attrId:"65010036",attrValue:P}]}}else{S={phoneNumber:H,actionType:"E",anTypeCd:T,areaId:Q}}var D=false;var B="";var K="";if(R=="terminal"||R=="number"){B=d.accessNumber;K=d.anTypeCd;if(B==H){$.alert("提示","号码已经被预占,请选择其它号码!");return}else{d={}}}else{if(R=="offer"){for(var O=0;O<OrderInfo.boProdAns.length;O++){if(OrderInfo.boProdAns[O].prodId==G){B=OrderInfo.boProdAns[O].accessNumber;K=OrderInfo.boProdAns[O].anTypeCd;break}}for(var O=0;O<OrderInfo.boProdAns.length;O++){if(OrderInfo.boProdAns[O].accessNumber==H){$.alert("提示","号码已经被预占,请选择其它号码!");return}}}}if(B&&B!=""){D=true;for(var O=0;O<r.length;O++){if(r[O]==B){D=false;break}}if(D){if(P){S={newPhoneNumber:H,oldPhoneNumber:B,newAnTypeCd:T,oldAnTypeCd:K,areaId:Q,attrList:[{attrId:"65010036",attrValue:P}]}}else{S={newPhoneNumber:H,oldPhoneNumber:B,newAnTypeCd:T,oldAnTypeCd:K,areaId:Q}}}}var E=contextPath+"/app/mktRes/phonenumber/purchase";$.callServiceAsJson(E,S,{before:function(){$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(V){if(V.code==0){if(x==""){x=V.data.phoneLevelId}if(R=="number"){var Y=$("#order_fill_content");Y.html("");d.accessNumber=H;d.anTypeCd=T;d.level=x;d.org_level=V.data.phoneLevelId;d.anId=V.data.phoneNumId;d.areaId=N;d.areaCode=A;d.memberRoleCd=M;d.preStore=C;d.minCharge=F;order.service.boProdAn=d;q()}else{if(R=="terminal"){mktRes.terminal.setNumber(H,V.data.phoneLevelId);d.accessNumber=H;d.anTypeCd=T;d.level=x;d.org_level=V.data.phoneLevelId;d.anId=V.data.phoneNumId;d.areaId=N;d.areaCode=A;d.memberRoleCd=M;d.preStore=C;d.minCharge=F;order.service.boProdAn=d;$("#div_phoneNbr_choose").popup("close")}else{if(R=="offer"){$("#choosedNum_"+G).val(H);d.accessNumber=H;d.level=x;d.org_level=V.data.phoneLevelId;d.areaId=N;d.anTypeCd=T;d.preStore=C;d.minCharge=F;d.anId=V.data.phoneNumId;var W=false;if(OrderInfo.boProdAns.length>0){for(var X=0;
X<OrderInfo.boProdAns.length;X++){if(OrderInfo.boProdAns[X].prodId==G){OrderInfo.boProdAns[X].accessNumber=H;OrderInfo.boProdAns[X].anTypeCd=T;OrderInfo.boProdAns[X].pnLevelId=x;OrderInfo.boProdAns[X].anId=V.data.phoneNumId;OrderInfo.boProdAns[X].areaId=N;OrderInfo.boProdAns[X].areaCode=A;OrderInfo.boProdAns[X].memberRoleCd=M;OrderInfo.boProdAns[X].preStore=C;OrderInfo.boProdAns[X].minCharge=F;W=true;if(OrderInfo.offerSpec.offerRoles!=undefined){OrderInfo.setProdAn(OrderInfo.boProdAns[X])}order.dealer.changeAccNbr(G,H);break}}}if(!W){var aa={prodId:G,accessNumber:H,anChooseTypeCd:"2",anId:V.data.phoneNumId,pnLevelId:x,anTypeCd:T,state:"ADD",areaId:N,areaCode:A,memberRoleCd:M,preStore:C,minCharge:F};OrderInfo.boProdAns.push(aa);if(OrderInfo.offerSpec.offerRoles!=undefined){OrderInfo.setProdAn(aa)}order.dealer.changeAccNbr(G,H)}if(G=="-1"){OrderInfo.boCustInfos.telNumber=H}$("#div_phoneNbr_choose").popup("close")}}}}else{if(V.code==-2){$.alertM(V.data)}else{var Z="";if(V.data!=undefined&&V.data.msg!=undefined){Z=V.data.msg}else{Z="号码["+H+"]预占失败"}$.alert("提示","号码预占失败，可能原因:"+Z)}}},fail:function(V){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})}else{$.alert("提示","号码格式不正确!")}};var h=function(C){var D=$("#passyz").val();var I="";if(OrderInfo.cust==undefined||OrderInfo.cust.custId==undefined||OrderInfo.cust.custId==""){I=$("#p_cust_areaId").val()}else{I=OrderInfo.getAreaId()}var J=$.trim($("#pnHead option:selected").val());var K=$.trim($("#pnEnd").val());if(K=="最后四位"){K=""}var L="";var G="";var B="";var F=$.trim($("#preStore option:selected").val());var A=F.split("-");if(A.length==2){G=A[0];B=A[1]}else{A=A.toString();G=A.substring(0,A.length-2);B=""}var H=$.trim($("#nbrPool option:selected").val());var E=$.trim($("#pnCharacterId option:selected").val());return{pnHead:J,pnEnd:K,goodNumFlag:E,maxPrePrice:B,minPrePrice:G,pnLevelId:"",pageSize:"16",phoneNum:L,areaId:I,poolId:H,queryFlag:D}};var a=function(E){E=E.toUpperCase();if(!(/(^\d{15}$)|(^\d{17}([0-9]|X)$)/.test(E))){return false}var F,K;F=E.length;if(F==15){K=new RegExp(/^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/);var J=E.match(K);var C=new Date("19"+J[2]+"/"+J[3]+"/"+J[4]);var B;B=(C.getYear()==Number(J[2]))&&((C.getMonth()+1)==Number(J[3]))&&(C.getDate()==Number(J[4]));if(!B){return false}else{var H=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var I=new Array("1","0","X","9","8","7","6","5","4","3","2");var G=0,D;E=E.substr(0,6)+"19"+E.substr(6,E.length-6);for(D=0;D<17;D++){G+=E.substr(D,1)*H[D]}E+=I[G%11];return E}}if(F==18){K=new RegExp(/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/);var J=E.match(K);var C=new Date(J[2]+"/"+J[3]+"/"+J[4]);var B;B=(C.getFullYear()==Number(J[2]))&&((C.getMonth()+1)==Number(J[3]))&&(C.getDate()==Number(J[4]));if(!B){return false}else{var A;var H=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var I=new Array("1","0","X","9","8","7","6","5","4","3","2");var G=0,D;for(D=0;D<17;D++){G+=E.substr(D,1)*H[D]}A=I[G%11];if(A!=E.substr(17,1)){return false}return E}}return false};var k=function(){var A=contextPath+"/pad/mktRes/phonenumber/prepare";var B={};$.callServiceAsHtmlGet(A,B,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(C){if(!C){C.data="选号页面加载异常,稍后重试"}if(C.code!=0){$.alert("提示","查询失败,稍后重试");return}var D=$("#order_tab_panel_content");D.html(C.data);$.jqmRefresh(D);d={accessNumber:"",level:"",anId:"",anTypeCd:""};j()}})};var j=function(){selectedObj=null;x="";s();u();n();var A={};o(A);$("#searchmore").on("tap",function(){var B=$(this);$("#moresearch").slideToggle(400);B.toggleClass("ui-icon-plus");B.toggleClass("ui-icon-minus")});$("#form_phonenumber_qry").find("select").off("change").on("change",function(){o(A);$(this).selectmenu("refresh")});$("#idCode").off("keydown").on("keydown",function(C){var B=document.all?window.event:C;if(B.keyCode==13){b(A)}});$("#pnEnd").off("keydown").on("keydown",function(C){var B=document.all?window.event:C;if(B.keyCode==13){o(A)}})};var y=function(E){var C;var I;var A;if(E.data){var B=E.data.length;for(var G=0;G<B;G++){if(E.data[G].PHONE_NUMBER_PRESTORE){C=E.data[G].PHONE_NUMBER_PRESTORE;for(var D=0;D<C.length;D++){var F=C[D].COLUMN_VALUE_NAME.replace(/\"/g,"");F=F.replace(/\"/g,"");$("#preStore").append("<option  value="+F+">"+F+"</option>")}$("#preStore").selectmenu("refresh")}}for(var G=0;G<B;G++){if(E.data[G].PHONE_NUMBER_SEGMENT){I=E.data[G].PHONE_NUMBER_SEGMENT;for(var D=0;D<I.length;D++){var H=I[D].COLUMN_VALUE_NAME;H=H.replace(/\"/g,"");$("#pnHead").append("<option  value="+H+">"+H+"</option>")}$("#pnHead").selectmenu("refresh")}}for(var G=0;G<B;G++){if(E.data[G].PHONE_NUMBER_FEATURE){A=E.data[G].PHONE_NUMBER_FEATURE;for(var D=0;D<A.length;D++){var K=(A[D].COLUMN_VALUE_NAME).replace(/\"/g,"");var J=(A[D].COLUMN_VALUE).replace(/\"/g,"");$("#pnCharacterId").append("<option value="+J+">"+K+"</option>")}$("#pnCharacterId").selectmenu("refresh")}}}};var s=function(){var B={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var A=contextPath+"/order/queryApConf";$.callServiceAsJsonGet(A,B,{done:y})};var u=function(){var C=contextPath+"/mktRes/phonenumber/queryPhoneNbrPool";var E={};var A=$.callServiceAsJson(C,E);if(A.code==0){if(A.data){var B=A.data.phoneNbrPoolList;var D=$("#nbrPool");if(B!=null){$.each(B,function(){var F=$('<option value="'+this.poolId+'">'+this.poolName+"</option>");D.append(F);D.selectmenu("refresh")})}}}else{if(A.code==-2){$.alertM(A.data)}else{$.alert("提示","号池加载失败，请稍后再试！")}}};var n=function(E){var B=contextPath+"/mktRes/phonenumber/queryPnLevelProdOffer";var D="";if(order.ysl!=undefined||E!=undefined){D=$("#_session_staff_info").attr("areaid")}else{D=$("#p_cust_areaId").val()}D=D.substring(0,3)+"0000";var C={areaId:D};var A=$.callServiceAsJson(B,C)};var l=function(){if(selectedObj==undefined||selectedObj==null){$.alert("提示","请先选择号码！");return}var B=$(selectedObj).attr("numberVal");var E=B.split("_")[5];var C=B.split("_")[0];var D=$("#p_cust_areaId").val();if(D==null||D==""){D=OrderInfo.staff.areaId}var A=contextPath+"/mktRes/qryPhoneNbrLevelInfoList";$.ligerDialog.open({width:560,height:350,allowClose:false,title:"设置号码等级（"+C+"）",url:A+"?pnLevelId="+x+"&areaId="+D+"&org_level="+E,buttons:[{text:"确定",onclick:function(G,F){var H=phoneNum_level.split("_");F.close();$(".select_nbr_li").each(function(){if($(this).hasClass("select")){var J=$(this).attr("numberval").split("_");var I;if(phoneNum_level!=undefined&&phoneNum_level!=""&&J[5]!=H[0]){I="<span style='float:left;margin-left:10px;'>预存<span class='orange'>"+J[1]+"</span>元<br/>保底<span class='orange'>"+J[2]+"</span>元</span><span style='float:right;margin-right:10px;'>预存<span class='orange'>"+H[1]+"</span>元<br/>保底<span class='orange'>"+H[2]+"</span>元</span><span style='width: 15px; display: table; height: 30px; padding-top: 10px;'><img  src='"+contextPath+"/image/common/levelArrow.png'></span>"}else{I="<span style='padding-left:10px;'>预存<span class='orange'>"+J[1]+"</span>元</span> <span style='padding-left:10px;'> 保底<span class='orange'>"+J[2]+"</span>元</span>"}$(this).find("div").html(I)}});x=H[0]}},{text:"关闭",onclick:function(G,F){F.close()}}]})};var z=function(){if(selectedObj==undefined||selectedObj==null){$.alert("提示","请先选择号码！");return}if(g==1){e(selectedObj)}else{var A=$(selectedObj).attr("numberVal").split("_")[7];if(A=="1"){$("#dlg-phonenumber-pwd").show();$("#phoneNbrSurebtn").off("tap").on("tap",function(B){w()});$("#phoneNbrCancelbtn").off("tap").on("tap",function(B){$("#dlg-phonenumber-pwd").hide()})}else{t(selectedObj)}}};var w=function(){var A=$("#pree_password_text").val();if($.trim(A)==""){$.alert("提示","预占密码不能为空！")}else{$("#dlg-phonenumber-pwd").hide();$("#pree_password_text").val("");t(selectedObj,A)}};var i=function(A,D,B){var E={subPage:A};var C=contextPath+"/pad/mktRes/phonenumber/prepare";$.callServiceAsHtmlGet(C,E,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(G){if(!G){G.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'
}if(G.code!=0){$.alert("提示","查询失败,稍后重试");return}var F=$.popup("#div_phoneNbr_choose",G.data,{width:$(window).width()-50,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){}});$("#moresearch").width($(window).width()-50-60);$("#idCode").parent().css("float","left");$("#pnEnd").parent().css("float","left");$(".search").css("position","fixed");$(".search").css("top","50px");$(".numbertitle").css("top","90px");$("#subPage").val(A);$("#subFlag").val(D);$("#subnum").val(B);if(OrderInfo.provinceInfo!=undefined&&OrderInfo.provinceInfo.prodOfferId!=undefined&&OrderInfo.provinceInfo.prodOfferId!=""){$("#phone_num_btn").tap(function(){$("#div_phoneNbr_choose").popup("close")})}mktRes.phoneNbr.initPhonenumber();$("#nbrPool-button").css({width:"65px",padding:"5px 40px 6px 20px"});$("#pnCharacterId-button").css({width:"35px",padding:"5px 40px 6px 20px"});$("#preStore-button").css({width:"35px",padding:"5px 40px 6px 20px"})}})};return{qryPhoneNbrLevelInfoList:l,endSelectNum:z,phoneNumDialog:i,btnQueryPhoneNumber:o,queryApConfig:s,initPhonenumber:j,boProdAn:d,resetBoProdAn:v,btnIBydentityQuery:b,initOffer:p,initPage:k,preePassword:w,queryPhoneNbrPool:u,queryFlag:_queryFlag,queryPnLevelProdOffer:n,queryPhoneNumber:m}})();CommonUtils.regNamespace("prod","uim");prod.uim=(function(){var d=function(j){var p=OrderInfo.getAccessNumber(j);var h="-1";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14||(OrderInfo.actionFlag==2&&offerChange.newMemberFlag)){if(p==""){$.alert("提示","校验UIM卡前请先选号!");return false}}if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23||OrderInfo.actionFlag==6){h=order.prodModify.choosedProdInfo.prodOfferInstId}var o=$.trim($("#uim_txt_"+j).val());if(o==undefined||o==""){$.alert("提示","UIM卡不能为空!");return false}var k={instCode:o,phoneNum:p};var l=OrderInfo.getProdSpecId(j);var n="";if(CONST.getAppDesc()==0){if(b(j)){n=c(CONST.PROD_SPEC_ID.MIFI_ID)}else{n=c(l)}if(ec.util.isObj(n)){}else{$.alert("提示","查询卡类型失败！");return}}var i=query.prod.checkUim(k);if(i==undefined||i.baseInfo==undefined){return false}var m=i.baseInfo.qty;if(m==undefined||m==null){m=1}var g={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:i.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:m,storeId:i.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:i.baseInfo.mktResInstCode,terminalCode:i.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:j,offerId:h,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){g.cardTypeFlag=i.baseInfo.cardTypeFlag}$("#uim_check_btn_"+j).attr("disabled",true);$("#uim_release_btn_"+j).attr("disabled",false);$("#uim_txt_"+j).attr("disabled",true);if(b(j)){$("#isMIFI_"+j).val("yes")}else{$("#isMIFI_"+j).val("no")}OrderInfo.clearProdUim(j);OrderInfo.boProd2Tds.push(g)};var b=function(l){var k=(Math.abs(l)-1);if(AttachOffer.openServList.length>k){var i=AttachOffer.openServList[k].servSpecList;for(var h=0;h<i.length;h++){var g=i[h];if(g.isdel!="Y"&&g.isdel!="C"){if(g.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true}}}}return false};var c=function(i){var j={prodSpecId:i};var h=contextPath+"/mktRes/uim/getMktResCd";$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");var g=$.callServiceAsJson(h,j);$.unecOverlay();if(g.code=="0"){return g.data}else{return""}};var f=function(h){var g=$.trim($("#uim_txt_"+h).val());if(g==undefined||g==""){$.alert("提示","UIM卡不能为空!");return false}var j={numType:2,numValue:g};var i=$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",j);if(i.code==-2){$.alertM(i.data);return}if(i.code==-1){$.alert("提示",i.data);return}$.alert("提示","成功释放UIM卡："+g);$("#uim_check_btn_"+h).attr("disabled",false);$("#uim_release_btn_"+h).attr("disabled",true);$("#uim_txt_"+h).attr("disabled",false);$("#uim_txt_"+h).val("");OrderInfo.clearProdUim(h)};var a=function(g,i,h){var j={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:h.couponId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:h.couponInsNumber,terminalCode:h.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:i,offerId:g,state:"DEL",relaSeq:"",id:0,isOld:"T"};OrderInfo.boProd2OldTds.push(j);order.prodModify.choosedProdInfo.extCouponInstanceId=h.extCouponInstanceId;order.prodModify.choosedProdInfo.corCouponInstanceId=h.corCouponInstanceId};var e=function(){OrderInfo.boProd2OldTds=[];var h=true;if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){var g=order.prodModify.choosedProdInfo;var i=query.prod.getTerminalInfo(g);if(i==undefined){return false}a(g.prodOfferInstId,g.prodInstId,i);if(i.is4GCard=="Y"){g.prodClass=CONST.PROD_CLASS.FOUR}else{g.prodClass=CONST.PROD_CLASS.THREE}}else{var g={};$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){g.prodInstId=this.objInstId;g.accNbr=this.accessNumber;var k=query.prod.getTerminalInfo(g);if(k==undefined){h=false;return false}a(this.offerId,this.objInstId,k);if(k.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}var j=order.prodModify.choosedProdInfo;if(j!=undefined&&j.prodInstId==this.objInstId){j.prodClass=this.prodClass}}})}return h};return{getMktResCd:c,checkUim:d,releaseUim:f,setProdUim:e}})();CommonUtils.regNamespace("query","prod");query.prod=(function(){var i=function(m){g(m);var l=contextPath+"/prod/prodSpecParamQuery";$.ecOverlay("<strong>正在查询产品规格属性中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,m);$.unecOverlay();if(k.code==0){if(k.data){return k.data}}else{if(k.code==-2){$.alertM(k.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var j=function(m){g(m);var l=contextPath+"/prod/prodInstParamQuery";$.ecOverlay("<strong>正在查询产品实例属性中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,m);$.unecOverlay();if(k.code==0){if(k.data){return k.data}}else{if(k.code==-2){$.alertM(k.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var a=function(k){var m={prodId:k.prodInstId,areaId:OrderInfo.getProdAreaId(k.prodInstId),acctNbr:k.accNbr,isServiceOpen:"Y"};$.ecOverlay("<strong>正在查询产品下终端实例数据中,请稍后....</strong>");var l=$.callServiceAsJson(contextPath+"/token/pad/order/queryTerminalInfo",m,{});$.unecOverlay();if(l.code==0){return l.data}else{if(l.code==-2){$.alertM(l.data)}else{$.alert("错误提示","接口未返回号码["+m.acctNbr+"]产品原UIM卡数据，无法继续受理！")}}};var c=function(n,m){n.isServiceOpen="Y";var l=contextPath+"/order/account";if(typeof(m)=="function"){$.callServiceAsJsonGet(l,n,{before:function(){$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>")},done:function(o){$.unecOverlay();if(o.code==0){m(o.data)}else{if(o.code==-2){$.alertM(o.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,n);$.unecOverlay();if(k.code==0){if(k.data){return k.data.offerSpec}}else{if(k.code==-2){$.alertM(k.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}};var e=function(m){var l=contextPath+"/mktRes/terminal/checkTerminal";$.ecOverlay("<strong>终端校验中,请稍后....</strong>");var k=$.callServiceAsJson(l,m);$.unecOverlay();if(k.code==-2){$.alertM(k.data)}else{if(k.data&&k.data.code==0){return k.data}else{if(k.data.code==1){$.alert("提示",k.data.message)}else{$.alert("提示","<br/>校验失败，请稍后重试！")}}}};var f=function(n){var l=contextPath+"/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");var k=$.callServiceAsJson(l,n);$.unecOverlay();if(k.code==0){$.alert("提示","UIM卡校验成功!");return k.data}else{if(typeof k==undefined){$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常")}else{if(k.code==-2){$.alertM(k.data)}else{var m="";if(k.data!=undefined&&k.data.msg!=undefined){m=k.data.msg}else{m="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡校验失败，可能原因:"+m)}}}};var h=function(n){var l=contextPath+"/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>");var k=$.callServiceAsJson(l,n);$.unecOverlay();
if(k.code==0){$.alert("提示","UIM卡释放成功!");return k.data}else{if(typeof k==undefined){$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常")}else{if(k.code==-2){$.alertM(k.data)}else{var m="";if(k.data!=undefined&&k.data.msg!=undefined){m=k.data.msg}else{m="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡释放失败，可能原因:"+m)}}}};var d=function(){var l=order.prodModify.choosedProdInfo;var k=a(l);if(k==undefined){return}var m={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:k.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:k.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:l.prodInstId,offerId:l.prodOfferInstId,state:"DEL",relaSeq:"",id:0,isOld:"T"};return m};var b=function(l){var n={prodId:l.prodInstId,prodSpecId:l.productId,offerSpecId:l.prodOfferId,acctNbr:l.accNbr};var m=query.offer.queryOpenedAttachAndServ(n);if(m&&m.result&&m.result.servLists){var k=false;$.each(m.result.servLists,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G){k=true}});return k}return false};var g=function(k){k.staffId=OrderInfo.staff.staffId;k.channelId=OrderInfo.staff.channelId;k.partyId=OrderInfo.cust.custId;k.areaId=OrderInfo.getProdAreaId(k.prodId);k.distributorId=OrderInfo.staff.distributorId;if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){k.soNbr=OrderInfo.order.soNbr}};return{checkUim:f,releaseUim:h,getTerminalInfo:a,prodSpecParamQuery:i,prodInstParamQuery:j,getOldUim:d,queryAcct:c,checkTerminal:e,checkIs4GProdInst:b}})();CommonUtils.regNamespace("common","print");common.print=(function(e){var o=function(J){var L=e("a[olId="+J+"]").attr("ifPrint");if(CONST.getAppDesc()==0&&"N"==L){var G=e("#tab_orderList tr[olId="+J+"]");var K="";var y=[];var A="false";for(var D=0;D<G.length;D++){var I=G[D];var F=e(I).attr("actionClass");if(F=="1600"){continue}A=e(I).attr("newProdFlag");if(A=="true"){break}var z=e(I).attr("objInstId");if(z==undefined||z==""){e.alert("提示","objInstId为空，请核查接口返回的数据！");return false}var E=e(I).attr("accessNumber");if(E==undefined||E==""){e.alert("提示","accessNumber为空，请核查接口返回的数据！");return false}}for(var D=0;A=="false"&&D<G.length;D++){var I=G[D];var F=e(I).attr("actionClass");if(F=="1600"){continue}var z=e(I).attr("objInstId");var E=e(I).attr("accessNumber");if(e.inArray(z,y)>=0){continue}K=e(I).attr("areaId");OrderInfo.orderResult.olNbr=e(I).attr("olNbr");var H="";OrderInfo.order.soNbr=UUID.getDataId();var B={areaId:K,acctNbr:E,custId:H,soNbr:OrderInfo.order.soNbr,instId:z,type:"2"};var C=query.offer.invokeLoadInst(B);if(!C){return false}y.push(z)}e("a[olId="+J+"]").attr("ifPrint","Y")}if(OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olId=J;return true};var r=function(z,B){if(!o(z)){return}var A={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr};var y=new Array(3);if(ec.util.browser.versions.android){y[0]="order/sign/downVoucher"}else{y[0]="print/iosVoucher"}y[1]="voucherInfo";y[2]=JSON.stringify(A);MyPlugin.printShow(y,function(C){},function(C){})};var t=function(A){var z="1";A.PcFlag=z;var y=contextPath+"/order/sign/previewForSign";e.callServiceAsJson(y,A,{before:function(){e.ecOverlay("<strong>生成回执预览的html,请稍等会儿....</strong>")},always:function(){e.unecOverlay()},done:function(B){if(B.code==0){SignPlugin.datasign(B.data,JSON.stringify(A),function(){},function(){})}else{if(B.code==-2){e.alertM(B.data)}else{e.alert("提示","生成回执预览的html失败!")}}},fail:function(B){e.unecOverlay();e.alert("提示","服务忙，请稍后再试！")}})};var v=function(y,A){if(!o(y)){return}var z={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:A};common.print.printVoucher(z)};var q=function(z){var y=new Array(3);if(ec.util.browser.versions.android){y[0]="print/voucher"}else{y[0]="print/iosVoucher"}y[1]="voucherInfo";y[2]=JSON.stringify(z);MyPlugin.printShow(y,function(A){},function(A){})};var g=function(M,z,L){var E=e("a[olId="+M+"]").attr("ifInvoice");var N=e("a[olId="+M+"]").attr("areaId");if(CONST.getAppDesc()==0&&"N"==E){var I=e("#tab_orderList tr[olId="+M+"]");var y=[];var B="false";for(var F=0;F<I.length;F++){var K=I[F];var H=e(K).attr("actionClass");if(H=="1600"){continue}B=e(K).attr("newProdFlag");if(B=="true"){break}var A=e(K).attr("objInstId");if(A==undefined||A==""){e.alert("提示","objInstId为空，请核查接口返回的数据！");return}var G=e(K).attr("accessNumber");if(G==undefined||G==""){e.alert("提示","accessNumber为空，请核查接口返回的数据！");return}}for(var F=0;B=="false"&&F<I.length;F++){var K=I[F];var H=e(K).attr("actionClass");if(H=="1600"){continue}var A=e(K).attr("objInstId");var G=e(K).attr("accessNumber");if(e.inArray(A,y)>=0){continue}N=e(K).attr("areaId");OrderInfo.orderResult.olNbr=e(K).attr("olNbr");var J="";OrderInfo.order.soNbr=UUID.getDataId();var C={areaId:N,acctNbr:G,custId:J,soNbr:OrderInfo.order.soNbr,instId:A,type:"2"};var D=query.offer.invokeLoadInst(C);if(!D){return}y.push(A)}e("a[olId="+M+"]").attr("ifInvoice","Y")}if(OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olNbr=z;OrderInfo.orderResult.olId=M;var C={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,billType:0,printFlag:L,areaId:N,acctItemIds:[]};common.print.prepareInvoiceInfo(C)};var d=function(C){e.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");var z=contextPath+"/print/getInvoiceItems";var y=e.callServiceAsJson(z,C,{});e.unecOverlay();if(!y){e.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return false}if(y.code==-2){e.alertM(y.data);return false}if(y.code!=0){e.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return false}if(y.data.resultCode!="0"){e.alert("提示",y.data.resultMsg);return false}if(y.data.chargeItems==undefined||y.data.chargeItems.length==0){e.alert("提示","没有可打印的费用项");return false}else{var A=0;for(;A<y.data.chargeItems.length;A++){var B=y.data.chargeItems[A];if(B.paymentAmount!=0){break}}if(A==y.data.chargeItems.length){e.alert("提示","没有可打印的费用项");return false}}return y};var i=function(){var A={staffId:OrderInfo.staff.staffId,areaId:OrderInfo.staff.areaId,custSoNbr:OrderInfo.orderResult.olNbr,custOrderId:OrderInfo.orderResult.olId,invoiceType:"100"};var z=contextPath+"/print/getInvoiceInfo";var y=e.callServiceAsJson(z,A,{});if(!y){return false}if(y.code==-2){e.alertM(y.data);return false}if(y.code!=0){return false}if(y.data.invoiceInfos!=undefined&&y.data.invoiceInfos instanceof Array&&y.data.invoiceInfos.length>0){}else{return false}return y};var l=function(y){if(OrderInfo.cust.norTaxPayer=="Y"){e.alert("提示","客户为一般纳税人，请到省份CRM系统打印专用增值税发票！");e.confirm("提示信息","客户为一般纳税人，专用增值税发票需要到省份CRM系统打印。是否只打印普通发票?",{yes:function(){f(y)},no:function(){return}},"question")}else{f(y)}};var f=function(F){var C=d(F);if(!C){return}var A=i();if(!A){}else{var L=A.data.invoiceInfos;if(ec.util.isArray(L[0].invoiceInfos)){e("#invoiceNbrInp").val(L[0].invoiceInfos[0].invoiceNbr);e("#invoiceNumInp").val(L[0].invoiceInfos[0].invoiceNum)}else{e("#invoiceNbrInp").val(L[0].invoiceNbr);e("#invoiceNumInp").val(L[0].invoiceNum)}}var Q=C.data.invoiceInfos;if(Q!=undefined&&Q instanceof Array&&Q.length>0){}else{var U={soNbr:OrderInfo.order.soNbr,billType:0,olId:F.olId,printFlag:-1,areaId:OrderInfo.staff.areaId,acctItemIds:[]};var B=common.print.initPrintInfo(U);if(!B){return}if(F.printFlag==1){e.alert("信息","此购物车对应的发票未打印过，请到发票补打页面。");return}C=d(F);if(!C){return}}common.print.oldInvoiceFlag="0";if(n(C.data.invoiceInfos,F.printFlag)){return}var E=contextPath+"/print/getInvoiceTemplates";var I={areaId:OrderInfo.staff.areaId};var M=e.callServiceAsJson(E,I,{});if(M.code==-2){e.alertM(M.data);return}else{if(M.code!=0){e.alert("提示",ec.util.defaultStr(M.data,"获取打印模板出错"));return}else{var z=M.data;if(z.resultCode!="POR-0000"){e.alert("提示",ec.util.defaultStr(z.resultMsg,"获取打印模板异常"));return}if(z.length==0){e.alert("提示","没有获取到可用的打印模板");return}var K="";var S=z.tempList;if(typeof S!=undefined&&S.length>0){K+="<option selected='selected' value="+S[0].templateId+">"+S[0].templateName+"</option>";
for(var N=1;N<S.length;N++){var R=S[N];K+="<option value="+R.templateId+">"+R.templateName+"</option>"}}e("#tempListSel").html(K)}}var O="";var T=C.data.prodInfo;if(T!=undefined&&T.length>0){O+="<option selected='selected' value="+T[0].accessNumber+">"+T[0].accessNumber+"</option>";for(var N=1;N<T.length;N++){var H=T[N];O+="<option value="+H.accessNumber+">"+H.accessNumber+"</option>"}}e("#acceNbrSel").html(O);var J="";J+="<div id='invoiceContDiv'>";J+="  <table class='searchtable'>";J+="    <tr>";J+="      <th>是否打印</th><th>费用名称</th><th>费用(元)</th><th>税金(元)</th><th>付费方式</th>";J+="    </tr>";var D=C.data.chargeItems;for(var N=0;N<D.length;N++){var P=D[N];if(N==0){e("#invoiceTitleInp").val(P.custName)}if(P.paymentAmount==0){continue}J+="    <tr acctItemId="+P.acctItemId+" acctItemTypeId="+P.acctItemTypeId+" ";J+="        acctItemTypeName='"+P.acctItemTypeName+"' boActionType='"+P.boActionType+"' ";J+="        boActionType='"+P.boActionType+"' boId="+P.boId+" feeAmount="+P.feeAmount+" ";J+="        invoiceId="+P.invoiceId+" objId="+P.objId+" objType="+P.objType+" ";J+="        payMethodCd="+P.payMethodCd+" payMethodName="+P.payMethodName+" ";J+="        realAmount="+P.realAmount+" ";J+="        tax="+P.tax+" taxRate="+P.taxRate+" >";if(a(P)){J+="      <td><input type='checkbox' name='invoiceItemsChkBox' checked='checked'/></td>"}else{J+="      <td><input type='checkbox' name='invoiceItemsChkBox' disabled='disabled'/></td>"}J+="      <td>"+P.acctItemTypeName+"</td>";J+="      <td>"+(P.realAmount/100).toFixed(2)+"</td>";J+="      <td>"+(P.tax/100).toFixed(2)+"</td>";J+="      <td>"+P.payMethodName+"</td>";J+="    </tr>"}J+="  </table>";J+="</div>";e("#invoiceItemsContDiv").html(J);var G=e("#div_printInvoice").html();e("#div_printInvoice").html("");var y=e.popup("#div_printInvoice_prepare",G,{width:e(window).width()-200,height:e(window).height(),contentHeight:e(window).height()-120,afterClose:function(){e("#div_printInvoice").html(G)}});e("#billType").off("change").on("change",function(V){if(e("#billType").val()=="0"){e("#invoiceNbrNumDl").show();e("#titleDt").html("发票抬头：");e("#tempDt").html("发票模板：");F.billType=0}else{e("#invoiceNbrNumDl").hide();e("#titleDt").html("票据抬头：");e("#tempDt").html("票据模板：");F.billType=1}});e("#invoiceItemsConfirm").off("tap").on("tap",function(V){if(common.print.oldInvoiceFlag!="0"){e.alert("信息","存在未作废发票，请先确定作废发票");return}j(F,C.data)});e("#invoiceItemsConCancel").off("tap").on("tap",function(V){e("#div_printInvoice_prepare").popup("close")})};var m=function(E){var z=contextPath+"/print/getInvoiceItems";var B=e.callServiceAsJson(z,E);if(!B){e.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(B.code==-2){e.alertM(B.data);return}if(B.code!=0){e.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(B.data.resultCode!="0"){e.alert("提示",B.data.resultMsg);return}if(B.data.chargeItems==undefined||B.data.chargeItems.length==0){e.alert("提示","没有可打印的费用项");return}var y=u(E,B.data);var A=y.invoiceInfos;var D={invoiceInfos:A};var C=h(D,E.printFlag);if(C==false){return false}A=p(A,C.data.invoiceIds,"0");return A};var c=function(y){if(y=="-1"){return"初始打印"}else{if(y=="0"){return"正常打印"}else{if(y=="1"){return"重打"}else{if(y=="2"){return"补打"}else{return"未知操作"}}}}};var n=function(A,z){if(A!=undefined&&A instanceof Array&&A.length>0){for(var y=0;y<A.length;y++){if(!A[y]){e.alert("信息","接口返回的发票信息不是有效值，请确认。");return true}if(A[y].printFlag=="-1"){if(z=="0"||z=="2"){}else{e.alert("信息","此购物车对应的发票未打印过，请到发票补打页面。");return true}}else{if(A[y].printFlag=="0"){if(A[y].billType=="1"){return false}if(z=="1"){b(A,z)}else{e.alert("信息","此购物车对应的发票正常打印过，只允许重打。");return true}}else{if(A[y].printFlag=="1"||A[y].printFlag=="2"){if(z=="1"){b(A,z)}else{e.alert("信息","此购物车对应的发票已打印过，只允许重打。");return true}}else{e.alert("信息","发票信息中打印标识值不规范");return true}}}}return false}else{if(z=="0"){return false}else{e.alert("信息","此购物车没有对应的发票信息，不能进行补打或重打");return true}}};var b=function(C,A){if(C!=undefined&&C instanceof Array&&C.length>0){var y='<ul data-role="listview" style="min-width:380px;min-height: 140px">';y+="<li>存在未作废发票，请先作废发票：</li>";var B=[];for(var z=0;z<C.length;z++){var D=C[z];if(e.inArray(D.invoiceId,B)>=0){}else{y+="<li>发票代码："+D.invoiceNbr+";发票号码："+D.invoiceNum+"</li>";B.push(D.invoiceId)}}y+="</ul>";if(B.length>0){common.print.oldInvoiceFlag="1";e("#invalidInvoiceInfoDiv").html(y);e.jqmRefresh(e("#invalidInvoiceInfoDiv"));e("#dlg-invalid-invoice").popup("open");e("#invalidInvoiceConfirm").off("tap").on("tap",function(){common.print.oldInvoiceFlag="0";e("#dlg-invalid-invoice").popup("close")})}return false}else{return false}};var a=function(y){var z=y.payMethodCd;if(z==CONST.PAYMETHOD_CD.ZHANG_WU_DAI_SHOU){return false}return true};var s=function(z){try{if(z.billType!=1){if(e("#invoiceNbrInp").val()==""){e.alert("提示","请输入发票代码");return true}if(!/^\d{0,12}$/.test(e("#invoiceNbrInp").val())){e.alert("提示","请输入正确的发票代码");return true}if(e("#invoiceNumInp").val()==""){e.alert("提示","请输入发票号码");return true}if(!/^\d{0,12}$/.test(e("#invoiceNumInp").val())){e.alert("提示","请输入正确的发票号码");return true}}if(e("#invoiceTitleInp").val()==""){e.alert("提示","请输入发票抬头");return true}if(e("#invoiceContDiv tbody input:checked").length<1){e.alert("提示","请选择要打印的费用项");return true}}catch(y){return true}return false};var u=function(y,D){var L=[];var H={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"100",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:y.billType,printFlag:y.printFlag,invoiceId:0};var A=false;var C=0;var M=0;var J=0;var G=[];var z="";var E=D.chargeItems;for(var B=0;B<E.length;B++){var I=E[B];H.acctItemIds.push({acctItemId:I.acctItemId});if(I.objType=="2"){H.instanceType=I.objType;H.instanceId=I.objId;H.paymethod=I.payMethodCd;A=true}else{if(!A&&I.objType=="7"){H.instanceType=I.objType;H.instanceId=I.objId;H.paymethod=I.payMethodCd}}C+=parseInt(I.feeAmount);M+=parseInt(I.realAmount);J+=parseInt(I.tax);z=I.payMethodName}H.amount=C;H.realPay=M;H.tax=J;H.account=M;H.accountUpper=ec.util.atoc(M);H.invoiceNbr=0;H.invoiceNum="0";var F=D.prodInfo;if(F!=undefined&&F.length>0){H.acctNbr=F[0].accessNumber}L.push(H);var K={payMethodName:z,items:G,invoiceInfos:L};return K};var k=function(y,D){var I=[];var F={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"100",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:y.billType,printFlag:y.printFlag,invoiceId:0};F.invoiceId=D.invoiceInfos[0].invoiceId;F.billType=e("#billType").val();if(F.billType=="0"){F.invoiceType="100"}else{F.invoiceType="200"}var A=false;var C=0;var J=0;var G=0;var E=[];var z="";var B=x(D);F.acctItemIds=[];e("#invoiceContDiv tbody input:checked").parent().parent().parent().each(function(){F.acctItemIds.push({acctItemId:e(this).attr("acctItemId")});if(e(this).attr("objType")=="2"){F.instanceType=e(this).attr("objType");F.instanceId=e(this).attr("objId");F.paymethod=e(this).attr("payMethodCd");A=true}else{if(!A&&e(this).attr("objType")=="7"){F.instanceType=e(this).attr("objType");F.instanceId=e(this).attr("objId");F.paymethod=e(this).attr("payMethodCd")}}C+=parseInt(e(this).attr("feeAmount"));J+=parseInt(e(this).attr("realAmount"));G+=parseInt(e(this).attr("tax"));var L="";var K=e(this).attr("boId");for(var M=0;M<B.length;M++){if(K==B[M].boId){L=B[M].accessNumber}}E.push({itemName:e(this).attr("acctItemTypeName"),charge:parseInt(e(this).attr("realAmount")),tax:parseInt(e(this).attr("tax")),acceNumber:L});
z=e(this).attr("payMethodName")});if(OrderInfo.actionFlag==11){F.printFlag=0}F.amount=C;F.realPay=J;F.tax=G;F.account=J;F.accountUpper=ec.util.atoc(J);F.invoiceNbr=e("#invoiceNbrInp").val();F.invoiceNum=""+e("#invoiceNumInp").val();F.acctNbr=e("#acceNbrSel option:selected").val();I.push(F);var H={payMethodName:z,items:E,invoiceInfos:I};return H};var x=function(E){var B=[];var F=E.chargeItems;var G=E.prodInfo;for(var C=0;C<F.length;C++){var I=F[C].boId;for(var z=0;z<G.length;z++){var D=G[z].accessNumber;var H=G[z].busiOrders;for(var y=0;y<H.length;y++){if(H[y].boId==I){var A={boId:I,accessNumber:D};B.push(A)}}}}return B};var j=function(E,B){if(s(E)){return}if(!B.invoiceInfos[0]){e.alert("提示","集团营业受理后台接口返回缺少发票信息，请确认。");return}var y=k(E,B);var A=y.invoiceInfos;var D={invoiceInfos:A};var C=h(D,E.printFlag);if(C==false){return}var z={partyName:e("#invoiceTitleInp").val(),templateId:e("#tempListSel :selected").val(),prodInfo:B.prodInfo,items:y.items,payMethod:y.payMethodName,invoiceInfos:A};w(z);if(OrderInfo.cust.norTaxPayer!="Y"){e("#div_printInvoice_prepare").popup("close")}return};var h=function(A,z){e.ecOverlay("<strong>正在提交中,请稍等会儿....</strong>");var y=e.callServiceAsJson(contextPath+"/print/saveInvoiceInfo",A);e.unecOverlay();if(y.code==-2){e.alertM(y.data);return false}else{if(y.code!=0||y.data.resultCode!="0"){e.alert("提示",c(z)+"调用集团发票打印处理接口失败，请稍后重试");return false}}return y};var p=function(B,A,z){for(var y=0;y<B.length;y++){B[y].invoiceId=A[y];B[y].printFlag=z}return B};var w=function(z){var y=new Array(3);if(ec.util.browser.versions.android){y[0]="print/invoice"}else{y[0]="print/iosInvoice"}y[1]="invoiceParam";y[2]=encodeURI(JSON.stringify(z));MyPlugin.printShow(y,function(A){},function(A){})};return{preVoucher:v,printVoucher:q,preInvoice:g,initPrintInfo:m,prepareInvoiceInfo:l,saveInvoiceInfo:j,chkInput:s,printInvoice:w,preSign:r,signVoucher:t}})(jQuery);$(function(){});CommonUtils.regNamespace("order","prepare");order.prepare=(function(){var e=function(){$("#ul_busi_area li").each(function(){$(this).off("tap").on("tap",function(t){OrderInfo.actionFlag=1;var q=$(this).attr("url");var r=$(this).attr("for");if(r=="order_tab_panel_phonenumber"){var s=OrderInfo.cust.custId;if(OrderInfo.cust==undefined||s==undefined||s==""){$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");return}}b(q,r);t.stopPropagation()})});var k=$("#diffPlaceFlag").val();if(k=="diff"){$("#order_prepare").hide();$("#nothreelinks").show()}var m=$("#mktResHidId").attr("mktResCd");var n=$("#offerSpecHidId").val();if(m&&m.length>0){var l=contextPath+"/pad/mktRes/terminal/prepare";var p={};var j=$.callServiceAsHtmlGet(l,p);var o=$("#div_public_info");o.html(j.data);mktRes.terminal.selectTerminal($("#mktResHidId"));$("#order_prepare").hide();order.prepare.step(1);a("","购手机",true);o.show()}else{if(n&&n.length>0){var l=contextPath+"/order/prodoffer/prepare";var p={prodOfferId:n};var j=$.callServiceAsHtmlGet(l,p);var o=$("#order_tab_panel_content");o.html(j.data);$("#order_prepare").hide();order.prepare.step(1);a("","办套餐",true);o.show();order.service.initSpec();order.prodOffer.init()}}};var b=function(j,k){$.callServiceAsHtmlGet(j,{},{before:function(){$.ecOverlay("<strong>查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(n){if(!n||n.code!=0){$.alert("提示","查询失败,稍后重试");return}if(order.cust.mgr.orderBtnflag=="1"){order.cust.mgr.btnQueryCustProdMore()}order.prepare.step(1);main.home.hideMainAllIco();var p=$("#order_prepare").html(n.data).fadeIn();$.jqmRefresh(p);$("#navbar").slideUp(500);if(k=="order_tab_panel_terminal"){a("","购手机",true);order.service.releaseFlag=1;order.prepare.createorderlonger();OrderInfo.busitypeflag=1;mktRes.terminal.queryApConfig();mktRes.terminal.initInParam("","","","","");mktRes.terminal.btnQueryTerminal(1);$("#form_terminal_qry").off("submit").on("submit",function(q){q.preventDefault();mktRes.terminal.btnQueryTerminal(1)}).find("select").off("change").on("change",function(){mktRes.terminal.btnQueryTerminal(1);$(this).selectmenu("refresh")})}else{if(k=="order_tab_panel_phonenumber"){a("","选号码",true);order.service.releaseFlag=1;order.prepare.createorderlonger();OrderInfo.busitypeflag=1;mktRes.phoneNbr.initPhonenumber()}else{if(k=="order_tab_panel_offer"){a("","办套餐",true);if(order.service.releaseFlag==0){order.service.releaseFlag=2}order.prepare.createorderlonger();OrderInfo.busitypeflag=1;f();if(OrderInfo.provinceInfo.reloadFlag=="N"){var m=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;var l="";for(var o=0;o<m.length;o++){if(m[o].boActionType.actionClassCd=="1200"&&m[o].boActionType.boActionTypeCd=="S2"&&m[o].busiObj.offerTypeCd=="1"){l=m[o].busiObj.objId}}if(l!=null&&l!=""){order.service.buyService("tcnum1",l,"")}}else{if(OrderInfo.provinceInfo.prodOfferId!=undefined&&OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""&&OrderInfo.provinceInfo.prodOfferId!="null"){order.service.buyService("tcnum1",OrderInfo.provinceInfo.prodOfferId,"")}else{order.service.searchPack()}}mktRes.phoneNbr.resetBoProdAn()}}}}})};var f=function(){query.common.queryApConfig("PROD_AND_OFFER",function(j){if(ec.util.isArray(j)){$.each(j,function(){if(this.OFFER_PRICE){$.each(this.OFFER_PRICE,function(){$("#select_price").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g,"")+"</option>")});$("#select_price").selectmenu("refresh")}else{if(this.OFFER_INFLUX){$.each(this.OFFER_INFLUX,function(){$("#select_influx").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g,"")+"</option>")});$("#select_influx").selectmenu("refresh")}else{if(this.OFFER_INVOICE){$.each(this.OFFER_INVOICE,function(){$("#select_invoice").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g,"")+"</option>")});$("#select_invoice").selectmenu("refresh")}}}})}});$("#form_prodOffer_qry").off("submit").on("submit",function(j){j.preventDefault();order.service.searchPack()}).find("select").off("change").on("change",function(){order.service.searchPack();$(this).selectmenu("refresh")})};var h=function(j){if(j==undefined||!j){j=1}if(1==j){OrderInfo.order.step=0}$.each($("div[id^=step]"),function(l,k){if(j==(l+1)){$(this).show()}else{$(this).hide()}})};var g=function(){$("div[id^=step]").hide()};var a=function(k,j,l){};var d=function(){$("#orderTitleDiv").hide()};var i=function(){var j=order.service.boProdAn;if(j.accessNumber&&!j.idFlag){var k={numType:1,numValue:j.accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",k,{done:function(){}});order.service.boProdAn={}}mktRes.phoneNbr.resetBoProdAn();d();$("#step1").hide();$("#main_div").hide();$("#order_prepare").show();if(OrderInfo.actionFlag!=6){$("#order_tab_panel_content").html("")}if(OrderInfo.actionFlag==2){$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup")}};var c=function(){var k=contextPath+"/order/createorderlonger";var j=$.callServiceAsJson(k,{});if(j.code==0){OrderInfo.orderlonger=j.data}};return{tabChange:e,commonTab:b,step:h,hideStep:g,showOrderTitle:a,hideOrderTitle:d,backToInit:i,createorderlonger:c,initOffer:f}})();$(function(){order.prepare.tabChange()});CommonUtils.regNamespace("order","prepare");order.prepare=(function(){var e=function(){$("#ul_busi_area li").each(function(){$(this).off("tap").on("tap",function(t){OrderInfo.actionFlag=1;var q=$(this).attr("url");var r=$(this).attr("for");if(r=="order_tab_panel_phonenumber"){var s=OrderInfo.cust.custId;if(OrderInfo.cust==undefined||s==undefined||s==""){$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");return}}b(q,r);t.stopPropagation()})});var k=$("#diffPlaceFlag").val();if(k=="diff"){$("#order_prepare").hide();$("#nothreelinks").show()}var m=$("#mktResHidId").attr("mktResCd");var n=$("#offerSpecHidId").val();if(m&&m.length>0){var l=contextPath+"/pad/mktRes/terminal/prepare";var p={};var j=$.callServiceAsHtmlGet(l,p);var o=$("#div_public_info");o.html(j.data);mktRes.terminal.selectTerminal($("#mktResHidId"));$("#order_prepare").hide();
order.prepare.step(1);a("","购手机",true);o.show()}else{if(n&&n.length>0){var l=contextPath+"/order/prodoffer/prepare";var p={prodOfferId:n};var j=$.callServiceAsHtmlGet(l,p);var o=$("#order_tab_panel_content");o.html(j.data);$("#order_prepare").hide();order.prepare.step(1);a("","办套餐",true);o.show();order.service.initSpec();order.prodOffer.init()}}};var b=function(j,k){$.callServiceAsHtmlGet(j,{},{before:function(){$.ecOverlay("<strong>查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(l){if(!l||l.code!=0){$.alert("提示","查询失败,稍后重试");return}if(order.cust.mgr.orderBtnflag=="1"){order.cust.mgr.btnQueryCustProdMore()}order.prepare.step(1);main.home.hideMainAllIco();var m=$("#order_prepare").html(l.data).fadeIn();$.jqmRefresh(m);$("#navbar").slideUp(500);if(k=="order_tab_panel_terminal"){a("","购手机",true);order.service.releaseFlag=1;order.prepare.createorderlonger();OrderInfo.busitypeflag=1;mktRes.terminal.queryApConfig();mktRes.terminal.initInParam("","","","","");mktRes.terminal.btnQueryTerminal(1);$("#form_terminal_qry").off("submit").on("submit",function(n){n.preventDefault();mktRes.terminal.btnQueryTerminal(1)}).find("select").off("change").on("change",function(){mktRes.terminal.btnQueryTerminal(1);$(this).selectmenu("refresh")})}else{if(k=="order_tab_panel_phonenumber"){a("","选号码",true);order.service.releaseFlag=1;order.prepare.createorderlonger();OrderInfo.busitypeflag=1;mktRes.phoneNbr.initPhonenumber()}else{if(k=="order_tab_panel_offer"){a("","办套餐",true);if(order.service.releaseFlag==0){order.service.releaseFlag=2}order.prepare.createorderlonger();OrderInfo.busitypeflag=1;f();order.service.searchPack();mktRes.phoneNbr.resetBoProdAn();if($("#mainPhoneNum").val()!=undefined&&$("#mainPhoneNum").val()!=""){OrderInfo.newOrderNumInfo.mainPhoneNum=$("#mainPhoneNum").val()}if($("#newSubPhoneNum").val()!=undefined&&$("#newSubPhoneNum").val()!=""){OrderInfo.newOrderNumInfo.newSubPhoneNum=$("#newSubPhoneNum").val()}if(OrderInfo.provinceInfo.reloadFlag!="N"&&OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""&&OrderInfo.provinceInfo.prodOfferId!="null"){order.service.buyService("",OrderInfo.provinceInfo.prodOfferId,"")}if(OrderInfo.provinceInfo.reloadFlag=="N"&&OrderInfo.reloadProdInfo.prodOfferId!=null&&OrderInfo.reloadProdInfo.prodOfferId!=""&&OrderInfo.reloadProdInfo.prodOfferId!="null"){order.service.buyService("",OrderInfo.reloadProdInfo.prodOfferId,"")}}}}}})};var f=function(){query.common.queryApConfig("PROD_AND_OFFER",function(j){if(ec.util.isArray(j)){$.each(j,function(){if(this.OFFER_PRICE){$.each(this.OFFER_PRICE,function(){$("#select_price").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g,"")+"</option>")});$("#select_price").selectmenu("refresh")}else{if(this.OFFER_INFLUX){$.each(this.OFFER_INFLUX,function(){$("#select_influx").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g,"")+"</option>")});$("#select_influx").selectmenu("refresh")}else{if(this.OFFER_INVOICE){$.each(this.OFFER_INVOICE,function(){$("#select_invoice").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g,"")+"</option>")});$("#select_invoice").selectmenu("refresh")}}}})}});$("#form_prodOffer_qry").off("submit").on("submit",function(j){j.preventDefault();order.service.searchPack()}).find("select").off("change").on("change",function(){order.service.searchPack();$(this).selectmenu("refresh")})};var h=function(j){if(j==undefined||!j){j=1}if(1==j){OrderInfo.order.step=0}$.each($("div[id^=step]"),function(l,k){if(j==(l+1)){$(this).show()}else{$(this).hide()}})};var g=function(){$("div[id^=step]").hide()};var a=function(k,j,l){};var d=function(){$("#orderTitleDiv").hide()};var i=function(){var j=order.service.boProdAn;if(j.accessNumber&&!j.idFlag){var k={numType:1,numValue:j.accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",k,{done:function(){}});order.service.boProdAn={}}mktRes.phoneNbr.resetBoProdAn();d();$("#step1").hide();$("#main_div").hide();$("#order_prepare").show();if(OrderInfo.actionFlag!=6){$("#order_tab_panel_content").html("")}if(OrderInfo.actionFlag==2){$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup")}};var c=function(){var k=contextPath+"/order/createorderlonger";var j=$.callServiceAsJson(k,{});if(j.code==0){OrderInfo.orderlonger=j.data}};return{tabChange:e,commonTab:b,step:h,hideStep:g,showOrderTitle:a,hideOrderTitle:d,backToInit:i,createorderlonger:c,initOffer:f}})();$(function(){order.prepare.tabChange()});CommonUtils.regNamespace("order","prodOffer");order.prodOffer=(function(d){var c=function(){order.prodOffer.queryApConfig()};var a=function(){var f={CONFIG_PARAM_TYPE:"PROD_AND_OFFER"};var e=contextPath+"/order/queryApConf";d.callServiceAsJsonGet(e,f,{done:b})};var b=function(k){var r;var o;var h;var e="<a href='javascript:void(0);' class='selected' val='' >不限</a>";var m="<a href='javascript:void(0);' class='selected' val='' >不限</a>";var p="<a href='javascript:void(0);' class='selected' val='' >不限</a>";if(k.data){var g=k.data.length;for(var n=0;n<g;n++){if(k.data[n].OFFER_PRICE){r=k.data[n].OFFER_PRICE;for(var l=0;l<r.length;l++){var f=r[l].COLUMN_VALUE;var q=r[l].COLUMN_VALUE_NAME;e=e+"<a href='javascript:void(0);' val='"+f+"'>"+q+"</a>"}d("#price_basic").html(e);d("#price_basic a").each(function(){d(this).off("click").on("click",function(i){d("#price_basic a").each(function(){d(this).removeClass("selected")});d(this).addClass("selected");i.stopPropagation();order.service.searchPack(1)})})}else{if(k.data[n].OFFER_INFLUX){o=k.data[n].OFFER_INFLUX;for(var l=0;l<o.length;l++){var f=o[l].COLUMN_VALUE;var q=o[l].COLUMN_VALUE_NAME;m=m+"<a href='javascript:void(0);' val='"+f+"'>"+q+"</a>"}d("#influx_basic").html(m);d("#influx_basic a").each(function(){d(this).off("click").on("click",function(i){d("#influx_basic a").each(function(){d(this).removeClass("selected")});d(this).addClass("selected");i.stopPropagation();order.service.searchPack(1)})})}else{if(k.data[n].OFFER_INVOICE){h=k.data[n].OFFER_INVOICE;for(var l=0;l<h.length;l++){var f=h[l].COLUMN_VALUE;var q=h[l].COLUMN_VALUE_NAME;p=p+"<a href='javascript:void(0);' val='"+f+"'>"+q+"</a>"}d("#invoice_basic").html(p);d("#invoice_basic a").each(function(){d(this).off("click").on("click",function(i){d("#invoice_basic a").each(function(){d(this).removeClass("selected")});d(this).addClass("selected");i.stopPropagation();order.service.searchPack(1)})})}}}}}};return{init:c,queryApConfig:a}})(jQuery);$(function(){});CommonUtils.regNamespace("AttachOffer");AttachOffer=(function(){var _openList=[];var _openedList=[];var _openServList=[];var _openedServList=[];var _openAppList=[];var _changeList=[];var _labelList=[];var checkedReserveNbr="";var checkedReserveCode="";var checkedOfferSpec=[];var _init=function(){var prodInfo=order.prodModify.choosedProdInfo;if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=3;if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!query.offer.setOffer()){return}}if(!rule.rule.ruleCheck()){return}var param={offerSpecId:prodInfo.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};if(ec.util.isObj(prodInfo.prodOfferId)){if(!query.offer.queryMainOfferSpec(param)){return}}else{OrderInfo.offerSpec={}}if(CONST.getAppDesc()==0){if(!prod.uim.setProdUim()){return}}AttachOffer.queryAttachOffer()};var _queryAttachOffer=function(){var prodInfo=order.prodModify.choosedProdInfo;var prodId=prodInfo.prodInstId;var param={prodId:prodId,prodSpecId:prodInfo.productId,offerSpecId:prodInfo.prodOfferId,acctNbr:prodInfo.accNbr};if(ec.util.isObj(prodInfo.prodBigClass)){param.prodBigClass=prodInfo.prodBigClass}SoOrder.initFillPage();var data=query.offer.queryAttachOfferHtml(param);$("#dlg_cust_prod").popup("close");$("#navbar").slideUp(500);SoOrder.step(0,data);$.jqmRefresh($("#order_tab_panel_content"));$("#fillNextStep").off("click").on("click",function(){SoOrder.submitOrder()
});$("#fillLastStep").off("click").on("click",function(){_lastStep()});var member=CacheData.getOfferMember(prodId);if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){param.queryType="1,2";param.objId=member.objId;param.objType=member.objType;param.offerRoleId=member.offerRoleId;param.memberRoleCd=member.roleCd;var data=query.offer.queryDefMustOfferSpec(param);CacheData.parseOffer(data,prodId);var data=query.offer.queryServSpec(param);CacheData.parseServ(data)}if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){var member=CacheData.getOfferMember(prodId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==member.offerRoleId&&member.objType==CONST.OBJ_TYPE.PROD){var offerRole=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(this.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>')}}});return false}})}AttachOffer.changeLabel(prodId,prodInfo.productId,"");order.dealer.initDealer();_querrOldOrderInfo()};var _changeLabel=function(prodId,prodSpecId,labelId){if(labelId==""){labelId=$("#attachType_"+prodId).val()}$("#attachSearch_div_"+prodId+" ul").each(function(){$(this).hide()});var $ul=$("#ul_"+prodId+"_"+labelId);if($ul[0]==undefined){var queryType="3";if(prodId>0){queryType=""}if(labelId==CONST.LABEL.SERV){var param={prodId:prodId,prodSpecId:prodSpecId,queryType:queryType,labelId:labelId};var data=query.offer.queryServSpec(param);var $ul=$('<ul id="ul_'+prodId+"_"+labelId+'" class="optionallist noorder" data-role="listview" data-inset="false" style="height:413px"></ul>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.servSpec)){var servList=CacheData.getServList(prodId);var servSpecList=CacheData.getServSpecList(prodId);var i=0;var html="";$.each(data.result.servSpec,function(){var servSpecId=this.servSpecId;var flag=true;$.each(servList,function(){if(this.servSpecId==servSpecId&&this.isDel!="C"){flag=false;return false}});$.each(servSpecList,function(){if(this.servSpecId==servSpecId){flag=false;return false}});if(flag){html='<li id="li_'+prodId+"_"+this.servSpecId+'"><div class="block">';html+=this.servSpecName+"<span></span><span>";html+='<a href="javascript:AttachOffer.openServSpec('+prodId+","+this.servSpecId+",'"+this.servSpecName+"','"+this.ifParams+'\')" class="abtn03 icon-buy">&nbsp;</a></span>';html+="</span>";if(i%2==1){html+="</div></li>";$ul.append(html)}i++}})}}$("#attachSearch_div_"+prodId).append($ul);$.jqmRefresh($("#attachSearch_div_"+prodId))}else{var param={prodSpecId:prodSpecId,offerSpecIds:[],queryType:queryType,prodId:prodId,partyId:OrderInfo.cust.custId,labelId:labelId,ifCommonUse:""};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){if(this.prodInstId==prodId){param.acctNbr=this.accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}})}else{if(OrderInfo.actionFlag==3){var prodInfo=order.prodModify.choosedProdInfo;param.acctNbr=prodInfo.accNbr;if(!ec.util.isObj(prodInfo.prodOfferId)){prodInfo.prodOfferId=""}var offerRoleId=CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;if(offerRoleId==undefined){offerRoleId=""}param.offerRoleId=offerRoleId;param.offerSpecIds.push(prodInfo.prodOfferId)}else{param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}}}query.offer.queryCanBuyAttachSpec(param,function(data){var $ul=$('<ul id="ul_'+prodId+"_"+labelId+'" class="optionallist noorder" data-role="listview" data-inset="false"  style="height:413px"></ul>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.offerSpecList)){var offerList=CacheData.getOfferList(prodId);var offerSpecList=CacheData.getOfferSpecList(prodId);var i=0;var html="";$.each(data.result.offerSpecList,function(){var offerSpecId=this.offerSpecId;var flag=true;$.each(offerList,function(){if(this.offerSpecId==offerSpecId&&this.isDel!="C"){flag=false;return false}});$.each(offerSpecList,function(){if(this.offerSpecId==offerSpecId){flag=false;return false}});if(flag){html='<li id="li_'+prodId+"_"+this.offerSpecId+'"><div class="block">';html+=this.offerSpecName+"<span></span><span>";html+='<a href="javascript:AttachOffer.addOfferSpec('+prodId+","+this.offerSpecId+')" class="abtn03 icon-buy">&nbsp;</a></span>';html+="</span>";if(i%2==1){html+="</div></li>";$ul.append(html)}i++}})}}$("#attachSearch_div_"+prodId).append($ul);$.jqmRefresh($("#attachSearch_div_"+prodId))})}}else{$("#ul_"+prodId+"_"+labelId).show()}};var _querrOldOrderInfo=function(){var isReload=OrderInfo.provinceInfo.reloadFlag;var orderInfo=OrderInfo.reloadOrderInfo;if(isReload=="N"){if(orderInfo==null||orderInfo==""||orderInfo==undefined){$.alert("订单数据为空，重载失败!");return}var resultCode=orderInfo.resultCode;var resultMsg=orderInfo.resultMsg;if(resultCode=="0"){var custOrderList=orderInfo.result.orderList.custOrderList;var orderListInfo=orderInfo.result.orderList.orderListInfo;if(custOrderList!=null&&custOrderList!=""){if(custOrderList!=null&&custOrderList.length>0){$(custOrderList).each(function(i,custOrder){$(custOrder.busiOrder).each(function(i,busiOrder){var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;var state="";var data=busiOrder.data;var ooOwners;var boServs;if(boActionTypeCd=="7"){boServs=data.boServs;if(boServs!=null){$(boServs).each(function(i,boServ){state=boServ.state})}}var busiObj=busiOrder.busiObj;if(boActionTypeCd=="7"){var instId=busiObj.instId;var boServOrders=data.boServOrders;$(data.boServs).each(function(i,boServ){var servId=boServ.servId;var state=boServ.state;if(state=="DEL"){_closeServSub(instId,servId)}})}})});$(custOrderList).each(function(i,custOrder){$(custOrder.busiOrder).each(function(i,busiOrder){var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;var state="";var data=busiOrder.data;var ooOwners;var boServs;if(boActionTypeCd=="7"){boServs=data.boServs;if(boServs!=null){$(boServs).each(function(i,boServ){state=boServ.state})}}else{ooOwners=data.ooOwners;if(ooOwners!=null){$(ooOwners).each(function(i,ooOwner){state=ooOwner.state;return false})}}var busiObj=busiOrder.busiObj;if(boActionTypeCd=="S2"){var instId=busiObj.instId;$(data.ooRoles).each(function(i,ooRole){var objInstId=ooRole.objInstId;if(state=="DEL"){_delOfferSub(objInstId,instId)}})}else{if(boActionTypeCd=="7"){var instId=busiObj.instId;var boServOrders=data.boServOrders;$(data.boServs).each(function(i,boServ){var servId=boServ.servId;var state=boServ.state;if(state=="ADD"){$(boServOrders).each(function(i2,boServOrder){var servSpecId=boServOrder.servSpecId;var servSpecName=boServOrder.servSpecName;_openServSpecSub(instId,servSpecId,servSpecName,"N")})}})}else{if(boActionTypeCd=="S1"){var objId=busiObj.objId;var accessNumber=busiObj.accessNumber;var objName=busiObj.objName;var prodId=null;var ooRoles=data.ooRoles;var busiOrderAttrs=data.busiOrderAttrs;$(data.ooRoles).each(function(i,ooRole){prodId=ooRole.prodId;return false});var isNeedAdd=false;var roleCode="";$(busiOrderAttrs).each(function(i,busiOrderAttr){var itemSpecId=busiOrderAttr.itemSpecId;if(itemSpecId=="111111116"){roleCode=busiOrderAttr.role;isNeedAdd=true;return false}});if(isNeedAdd){_addAttachDealerSub(prodId+"_"+objId,accessNumber,objName,roleCode)}_addOfferSpecSub(prodId,objId,ooRoles);var bo2Coupons=data.bo2Coupons;if(bo2Coupons!=null&&bo2Coupons!=null&&bo2Coupons.length>0){$(bo2Coupons).each(function(i,bo2Coupon){var prodId=bo2Coupon.prodId;var attachSepcId=bo2Coupon.attachSepcId;var num=bo2Coupon.num;var couponInstanceNumber=bo2Coupon.couponInstanceNumber;$("#terminalText_"+prodId+"_"+attachSepcId).val(couponInstanceNumber);
_checkTerminalCodeSub(prodId,attachSepcId)})}}}}})});$(custOrderList).each(function(i,custOrder){$(custOrder.busiOrder).each(function(i,busiOrder){var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;var data=busiOrder.data;var ooOwners;var boServs;if(boActionTypeCd=="14"){var bo2Coupons=data.bo2Coupons;if(bo2Coupons!=null&&bo2Coupons!=null&&bo2Coupons.length>0){$(bo2Coupons).each(function(i,bo2Coupon){var prodId=bo2Coupon.prodId;var attachSepcId=bo2Coupon.attachSepcId;var couponInstanceNumber=bo2Coupon.couponInstanceNumber;var state=bo2Coupon.state;if(state=="ADD"){_uimCardInfoSearch(couponInstanceNumber,prodId,bo2Coupon)}})}}})})}}if(orderListInfo!=null&&custOrderList!=null){var custOrderAttrs=orderListInfo.custOrderAttrs;var isTemplateOrder=orderListInfo.isTemplateOrder;var templateOrderName=orderListInfo.templateOrderName;$(custOrderAttrs).each(function(i,custOrderAttr){var itemSpecId=custOrderAttr.itemSpecId;if(itemSpecId=="111111118"){var value=custOrderAttr.value;if(value!=null&&value!=""){$("#order_remark").html(value)}}});if(isTemplateOrder=="Y"){$("#isTemplateOrder").click();SoOrder.showTemplateOrderName();$("#templateOrderName").val(templateOrderName)}}}}};var _uimCardInfoSearch=function(instCode,prodId,bo2Coupon){$("#uim_txt_"+prodId).val(instCode);var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:bo2Coupon.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:bo2Coupon.storeId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:instCode,terminalCode:instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:bo2Coupon.offerId,state:"ADD",relaSeq:""};if(bo2Coupon.cardTypeFlag!=null&&bo2Coupon.cardTypeFlag!=""){coupon.cardTypeFlag=bo2Coupon.cardTypeFlag}$("#uim_check_btn_"+prodId).attr("disabled",true);$("#uim_release_btn_"+prodId).removeAttr("disabled");$("#uim_txt_"+prodId).attr("disabled",true);if(getIsMIFICheck(prodId)){$("#isMIFI_"+prodId).val("yes")}else{$("#isMIFI_"+prodId).val("no")}OrderInfo.clearProdUim(prodId);OrderInfo.boProd2Tds.push(coupon)};var _closeServSub=function(prodId,servId){var serv=CacheData.getServ(prodId,servId);var $div=$("#li_span_"+prodId+"_"+servId).parent();if($div.attr("class")=="block deldiv"){_openServ(prodId,serv)}else{var uim=OrderInfo.getProdUim(prodId);if(serv.servSpecId=="280000020"&&(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)&&uim.cardTypeFlag=="1"){$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");return}$div.addClass("deldiv");serv.isdel="Y"}};var _delOfferSub=function(prodId,offerId){var $div=$("#li_span_"+prodId+"_"+offerId).parent();if($div.attr("class")=="block deldiv"){AttachOffer.addOffer(prodId,offerId,$div.text())}else{var offer=_getOffer(prodId,offerId);if(offer==undefined){return}if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=query.offer.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}var content="";if(offer.offerSpec!=undefined){content=CacheData.getOfferProdStr(prodId,offer,1)}else{content="退订【"+$div.text()+"】可选包"}offer.isdel="Y";$div.addClass("deldiv");delServByOffer(prodId,offer)}};var _getOffer=function(prodId,offerId){var offerList=_getOfferList(prodId);if(ec.util.isArray(offerList)){for(var i=0;i<offerList.length;i++){if(offerList[i].offerId==offerId){return offerList[i]}}}};var _getOfferList=function(prodId){for(var i=0;i<AttachOffer.openedList.length;i++){var opened=AttachOffer.openedList[i];if(opened.prodId==prodId){return opened.offerList}}return[]};var _openServSpecSub=function(prodId,servSpecId,specName,ifParams){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDependSub(prodId,servSpec)};var _checkServExcludeDependSub=function(prodId,serv,flag){var servSpecId=serv.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserServDataSub(data.result,prodId,serv)}}};var paserServDataSub=function(result,prodId,serv){var servSpecId=serv.servSpecId;var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";var param={excludeServ:[],dependServ:[],relatedServ:[]};if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";param.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.dependServ.push(this)})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.relatedServ.push(this)})}if(content==""){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);excludeAddServ(prodId,servSpecId,param)}};var _addAttachDealerSub=function(id,accessNumbe,objName,roleCode){var prodId=id.split("_")[0];if($("#tr_"+id)[0]==undefined){var objId=id+"_"+OrderInfo.SEQ.dealerSeq;var $tdType=_getDealerTypeSub(id,objId);if($tdType==undefined){return false}var $tr=$("#atr_"+id);var $li=$('<li name="tr_'+id+'"></li>');var $dl=$("<dl></dl>");$dl.append("<dd>"+accessNumbe+"</dd>");$dl.append("<dd>"+objName+"</dd>");$dl.append($tdType);var dealer=$("#tr_"+prodId).find("input");var staffId=1;var staffName="";if(dealer[0]==undefined){staffId=OrderInfo.staff.staffId;staffName=OrderInfo.staff.staffName}else{staffId=dealer.attr("staffId");staffName=dealer.attr("value")}if(order.ysl!=undefined){var $dd=$('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'"  data-mini="true"></input></dd>');$dl.append($dd)}else{var $dd=$('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'"  data-mini="true"  readonly="readonly"></input></dd>');$dl.append($dd)}var $button='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';$button+="<button data-mini=\"ture\" onclick=\"order.main.queryStaff('dealer','"+objId+"');\">选择</button></div>";$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+id+"')\">添加</button></div>";$button+=' <div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';$dl.append($button);$li.append($dl);$("#dealerTbody").append($li);$.jqmRefresh($("#dealerTbody"));OrderInfo.SEQ.dealerSeq++}};var _getDealerTypeSub=function(objInstId,objId){var dealerType="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var dealerTypeId=this.PARTYPRODUCTRELAROLECD;var flag=true;$("select[name='dealerType_"+objInstId+"']").each(function(){if(dealerTypeId==$(this).val()){flag=false;return false}});if(flag){dealerType=dealerTypeId;return false}})}else{$.alert("信息提示","没有发展人类型");
return}if(dealerType==undefined||dealerType==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var $tdType=$("<dd></dd>");var $field=$('<fieldset data-role="fieldcontain"></fieldset>');var objId=objInstId+"_"+OrderInfo.SEQ.dealerSeq;var $select=$('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==dealerType){$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});$field.append($select);$tdType.append($field);return $tdType};var _addOfferSpecSub=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);_setServ2OfferSpecSub(prodId,newSpec);_checkOfferExcludeDependSub(prodId,newSpec)};var _setServ2OfferSpecSub=function(prodId,offerSpec,roles){if(offerSpec!=undefined){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var nowProd=prodId+"_"+this.objId;$(roles).each(function(i,role){var oldProd=role.prodId+"_"+role.objId;if(nowProd==oldProd){this.selQty=1;return false}else{this.selQty=2}})})})}};var _checkOfferExcludeDependSub=function(prodId,offerSpec){var offerSpecId=offerSpec.offerSpecId;var param=CacheData.getExcDepOfferParam(prodId,offerSpecId);var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserOfferDataSub(data.result,prodId,offerSpecId,offerSpec.offerSpecName)}};var paserOfferDataSub=function(result,prodId,offerSpecId,specName){var content="";var param={excludeOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(result!=""){var exclude=result.offerSpec.exclude;var depend=result.offerSpec.depend;if(ec.util.isArray(exclude)){for(var i=0;i<exclude.length;i++){var offerList=CacheData.getOfferList(prodId);var flag=true;if(offerList!=undefined){for(var j=0;j<offerList.length;j++){if(offerList[j].isdel=="Y"){if(offerList[j].offerSpecId==exclude[i].offerSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+exclude[i].offerSpecName+"<br>";param.excludeOffer.push(exclude[i].offerSpecId)}}}if(depend!=undefined&&ec.util.isArray(depend.offerInfos)){for(var i=0;i<depend.offerInfos.length;i++){content+="需要开通： "+depend.offerInfos[i].offerSpecName+"<br>";param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId)}}if(depend!=undefined&&ec.util.isArray(depend.offerGrpInfos)){for(var i=0;i<depend.offerGrpInfos.length;i++){var offerGrpInfo=depend.offerGrpInfos[i];param.dependOffer.offerGrpInfos.push(offerGrpInfo);content+="需要开通： 开通"+offerGrpInfo.minQty+"-"+offerGrpInfo.maxQty+"个以下业务:<br>";if(offerGrpInfo.subOfferSpecInfos!="undefined"&&offerGrpInfo.subOfferSpecInfos.length>0){for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){var subOfferSpec=offerGrpInfo.subOfferSpecInfos[j];content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}}}}var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);content=content+serContent;AttachOffer.addOpenList(prodId,offerSpecId)};var _checkTerminalCodeSub=function(prodId,offerSpecId){var flag="0";for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId){OrderInfo.attach2Coupons.splice(i,1);break}}var objInstId=prodId+"_"+offerSpecId;var resIdArray=[];var terminalGroupIdArray=[];$("#terminalSel_"+objInstId+"  option").each(function(){resIdArray.push($(this).val())});$("#group_"+objInstId+"  option").each(function(){terminalGroupIdArray.push($(this).val())});var resId=resIdArray.join("|");var terminalGroupId=terminalGroupIdArray.join("|");if((resId==undefined||$.trim(resId)=="")&&(terminalGroupId==undefined||$.trim(terminalGroupId)=="")){$.alert("信息提示","终端规格不能为空！");return}var instCode=$("#terminalText_"+objInstId).val();if(instCode==undefined||$.trim(instCode)==""){$.alert("信息提示","终端串码不能为空！");return}if(_checkData(objInstId,instCode)){return}var param={instCode:instCode,flag:flag,mktResId:""};var data=query.prod.checkTerminal(param);if(data==undefined){return}var activtyType="";for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"&&ec.util.isArray(spec.agreementInfos)){if(spec.agreementInfos[0].activtyType==2){activtyType="2"}}}}if(data.statusCd==CONST.MKTRES_STATUS.USABLE||(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2")){$("#terminalSel_"+objInstId).val(data.mktResId);var mktPrice=0;var mktColor="";if(ec.util.isArray(data.mktAttrList)){$.each(data.mktAttrList,function(){if(this.attrId=="65010058"){mktPrice=this.attrValue}else{if(this.attrId=="60010004"){mktColor=this.attrValue}}})}$("#terminalName").html(data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");$("#terminalDesc").css("display","block");var coupon={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:data.mktResStoreId,storeName:"1",agentId:1,apCharge:mktPrice,couponInstanceNumber:data.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId+"",offerId:-1,attachSepcId:offerSpecId+"",state:"ADD",relaSeq:"",num:"1"};if(CONST.getAppDesc()==0){coupon.termTypeFlag=data.termTypeFlag}OrderInfo.attach2Coupons.push(coupon)}else{$.alert("提示",data.message)}};var _filterAttach2Coupons=function(prodId,offerSpecId,num){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId&&attach2Coupon.num==num){OrderInfo.attach2Coupons.splice(i,1);$("#terminalName_"+num).html("");break}}};var _checkData=function(objInstId,terminalCode){var $input=$("input[id^=terminalText_"+objInstId+"]");var num=0;$input.each(function(){var instCode=$.trim(this.value);if(ec.util.isObj(instCode)&&terminalCode==instCode){num++}});if(num>=2){$.alert("信息提示","终端串码重复了，请填写不同的串码。");return true}return false};var _releaseUim=function(prodId){var cardNo=$.trim($("#uim_txt_"+prodId).val());if(cardNo==undefined||cardNo==""){$.alert("提示","UIM卡不能为空!");return false}var param={numType:2,numValue:cardNo};var jr=$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",param);if(jr.code==-2){$.alertM(jr.data);return}if(jr.code==-1){$.alert("提示",jr.data);return}$("#uim_check_btn_"+prodId).attr("disabled",false);$("#uim_release_btn_"+prodId).attr("disabled",true);$("#uim_txt_"+prodId).attr("disabled",false);$("#uim_txt_"+prodId).val("");OrderInfo.clearProdUim(prodId)};var _checkUim=function(prodId){var phoneNumber=OrderInfo.getAccessNumber(prodId);var offerId="-1";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(phoneNumber==""){$.alert("提示","校验UIM卡前请先选号!");return false}}if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23||OrderInfo.actionFlag==6){offerId=order.prodModify.choosedProdInfo.prodOfferInstId}var cardNo=$.trim($("#uim_txt_"+prodId).val());if(cardNo==undefined||cardNo==""){$.alert("提示","UIM卡不能为空!");return false}var inParam={instCode:cardNo,phoneNum:phoneNumber};var prodSpecId=OrderInfo.getProdSpecId(prodId);var mktResCd="";if(CONST.getAppDesc()==0){if(getIsMIFICheck(prodId)){mktResCd=getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID)}else{mktResCd=getMktResCd(prodSpecId)}if(ec.util.isObj(mktResCd)){}else{$.alert("提示","查询卡类型失败！");return}}var data=_checkUimSub(inParam);if(data==undefined||data.baseInfo==undefined){return false}var couponNum=data.baseInfo.qty;if(couponNum==undefined||couponNum==null){couponNum=1
}var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:couponNum,storeId:data.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:data.baseInfo.mktResInstCode,terminalCode:data.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:offerId,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){coupon.cardTypeFlag=data.baseInfo.cardTypeFlag}$("#uim_check_btn_"+prodId).attr("disabled",true);$("#uim_release_btn_"+prodId).attr("disabled",false);$("#uim_txt_"+prodId).attr("disabled",true);if(getIsMIFICheck(prodId)){$("#isMIFI_"+prodId).val("yes")}else{$("#isMIFI_"+prodId).val("no")}OrderInfo.clearProdUim(prodId);OrderInfo.boProd2Tds.push(coupon)};var getMktResCd=function(prodSpecId){var param={prodSpecId:prodSpecId};var url=contextPath+"/mktRes/uim/getMktResCd";$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");var response=$.callServiceAsJson(url,param);$.unecOverlay();if(response.code=="0"){return response.data}else{return""}};var getIsMIFICheck=function(prodId){var prodIdTmp=(Math.abs(prodId)-1);if(AttachOffer.openServList.length>prodIdTmp){var specList=AttachOffer.openServList[prodIdTmp].servSpecList;for(var j=0;j<specList.length;j++){var spec=specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"){if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true}}}}return false};var _checkUimSub=function(param,prodId){var url=contextPath+"/app/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");var response=$.callServiceAsJson(url,param);$.unecOverlay();if(response.code==0){isRightCheck="Y";$("#uim_check_btn_"+prodId).attr("disabled","disabled");$("#uim_release_btn_"+prodId).removeAttr("disabled");return response.data}else{if(typeof response==undefined){$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常")}else{if(response.code==-2){$.alertM(response.data)}else{var msg="";if(response.data!=undefined&&response.data.msg!=undefined){msg=response.data.msg}else{msg="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡校验失败，可能原因:"+msg)}}}};var _queryAttachOfferSpec=function(param){var data=query.offer.queryAttachSpec(param);if(data){$("#attach_"+param.prodId).html(data);$.jqmRefresh($("#attach_"+param.prodId));_showMainRoleProd(param.prodId);var servSpecIds=[];if(AttachOffer.openServList!=null&&AttachOffer.openServList!=undefined){$.each(AttachOffer.openServList,function(){if(this.prodId==param.prodId){var servSpecList=this.servSpecList;if(servSpecList!=null&&servSpecList!=undefined){$.each(servSpecList,function(){if(this.servSpecId!=null&&this.servSpecId!=undefined){servSpecIds.push(this.servSpecId)}})}}})}param.servSpecIds=servSpecIds;var queryData=query.offer.queryServSpecPost(param);if(queryData!=null&&queryData.resultCode==0){if(queryData.result.offerList!=null&&queryData.result.offerList!=undefined){$.each(queryData.result.offerList,function(){AttachOffer.addOpenList(param.prodId,this.offerSpecId)})}}AttachOffer.changeLabel(param.prodId,param.prodSpecId,"");if(param.prodId==-1&&OrderInfo.actionFlag==14){AttachOffer.addOpenList(param.prodId,mktRes.terminal.offerSpecId)}}};var _changeOfferS=function(obj,prodId){var val=$(obj).val();if(val=="0"){$("#open_ul_"+prodId).show();$("#open_serv_ul_"+prodId).hide()}else{$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).show()}};var _changeOfferOrdered=function(obj,prodId){var val=$(obj).val();if(val=="0"){$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).hide();$("#order_ul_"+prodId).show();$("#serv_ul_"+prodId).hide()}else{if(val=="1"){$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).hide();$("#order_ul_"+prodId).hide();$("#serv_ul_"+prodId).show()}else{if(val=="2"){$("#open_ul_"+prodId).show();$("#open_serv_ul_"+prodId).hide();$("#order_ul_"+prodId).hide();$("#serv_ul_"+prodId).hide()}else{if(val=="3"){$("#open_ul_"+prodId).hide();$("#open_serv_ul_"+prodId).show();$("#order_ul_"+prodId).hide();$("#serv_ul_"+prodId).hide()}}}}};var _showApp=function(prodId){var appList=CacheData.getOpenAppList(prodId);var content=CacheData.getAppContent(prodId,appList);$.confirm("增值业务设置： ",content[0].innerHTML,{yes:function(){$.each(appList,function(){if($("#"+prodId+"_"+this.objId).attr("checked")=="checked"){this.dfQty=1}else{this.dfQty=0}})},no:function(){}})};var getProdInst=function(prodId){for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(ec.util.isArray(offerRole.prodInsts)){for(var j=0;j<offerRole.prodInsts.length;j++){if(offerRole.prodInsts[j].prodInstId==prodId){return offerRole.prodInsts[j]}}}}};var _showMainRoleProd=function(prodId){var prodInst=getProdInst(prodId);var app={prodId:prodId,appList:[]};AttachOffer.openAppList.push(app);for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(roleObj.objType==CONST.OBJ_TYPE.SERV){if(prodInst.objId==roleObj.parentProdId&&prodInst.componentTypeCd.substring(0,1)==roleObj.componentTypeCd.substring(0,1)){app.appList.push(roleObj);if(roleObj.servSpecId==undefined){roleObj.servSpecId=roleObj.objId}if(roleObj.servSpecName==undefined){roleObj.servSpecName=roleObj.objName}}}}if(app.appList.length>0){var $li=$('<li id="li_'+prodId+"_"+offerRole.offerRoleId+'"></li>');var $div=$('<div class="block"></div>');$div.append(offerRole.offerRoleName);$div.append("<span></span>");var $span=$("<span></span>");$span.append('<a href="javascript:void(0);" class="abtn03 icon-nodel">&nbsp;</a>');$span.append('<a id="can_'+prodId+"_"+offerRole.offerRoleId+'" class="abtn01" onclick="AttachOffer.showApp('+prodId+');">构</a>');$div.append($span);$li.append($div);$("#open_app_ul_"+prodId).append($li);$("#open_app_ul_"+prodId).listview()}}else{if(offerRole.prodInsts==undefined){continue}$.each(offerRole.prodInsts,function(){if(this.prodInstId==prodId){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldspan1=$("#li_span1_"+prodId+"_"+servSpecId);var $oldspan2=$("#li_span2_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(roleObj.minQty==1){$oldspan2.append('<a href="javascript:void(0);" class="abtn03 icon-nodel">&nbsp;</a>')}$oldspan1.append('<a id="jue_'+prodId+"_"+servSpecId+'" class="ui-link" title="'+offerRole.offerRoleName+'" href="javascript:void(0);">角</a>');continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldspan1=$("#li_span1_"+prodId+"_"+serv.servId);var $oldspan2=$("#li_span2_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){$oldspan2.append('<a href="javascript:void(0);" class="abtn03 icon-nodel">&nbsp;</a>')}$oldspan1.append('<a id="jue_'+prodId+"_"+serv.servId+'" class="ui-link" title="'+offerRole.offerRoleName+'" href="javascript:void(0);">角</a>');continue}if(roleObj.dfQty>0){CacheData.setServSpec(prodId,roleObj);spec=roleObj;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');var $div=$('<div class="block"></div>');$div.append(spec.servSpecName);var $span1=$("<span></span>");$span1.append('<a id="jue_'+prodId+"_"+servSpecId+'" class="ui-link" title="'+offerRole.offerRoleName+'" href="javascript:void(0);">角</a>');$div.append($span1);var $span=$("<span></span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$span.append('<a id="can_'+prodId+"_"+servSpecId+'" class="abtn01" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');">参</dd>')}else{$span.append('<a id="can_'+prodId+"_"+servSpecId+'" class="abtn01" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');">参</dd>')}}if(roleObj.minQty==0){$span.append('<a class="abtn02 icon-del" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+"')\">&nbsp;</a>")
}else{$span.append('<a href="javascript:void(0);" class="abtn03 icon-nodel">&nbsp;</a>')}$div.append($span);$li.append($div);$("#open_serv_ul_"+prodId).append($li);$("#open_serv_ul_"+prodId).listview();spec.isdel="N"}}}}})}}};var _searchAttachOfferSpec=function(prodId,offerSpecId,prodSpecId){var param={prodId:prodId,prodSpecId:prodSpecId,offerSpecIds:[offerSpecId],ifCommonUse:""};var offerSepcName=$("#search_text_"+prodId).val();if(offerSepcName.replace(/\ /g,"")==""){alert("请输入查询条件")}else{param.offerSpecName=offerSepcName;var data=query.offer.searchAttachOfferSpec(param);if(data!=undefined){$("#attachSearch_div_"+prodId+" ul").each(function(){$(this).hide()});$("#attachSearch_div_"+prodId).append(data)}}};var _dbClickAttachType=function(prodId){$("#attachType_"+prodId).dblclick()};var _selectAttachOffer=function(prodId,offerSpecId){$("#attach_div_"+prodId).hide();_addAttOffer(prodId,offerSpecId)};var _selectServ=function(prodId,servSpecId,specName,ifParams){$("#attach_div_"+prodId).hide();_openServSpec(prodId,servSpecId,specName,ifParams)};var _closeAttachSearch=function(prodId){$("#attach_div_"+prodId).hide()};var _delOfferSpec=function(prodId,offerSpecId){var $div=$("#li_span_"+prodId+"_"+offerSpecId).parent();if($div.attr("class")=="block deldiv"){AttachOffer.addOfferSpec(prodId,offerSpecId)}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);var content=CacheData.getOfferProdStr(prodId,spec,2);$.confirm("信息确认",content,{yes:function(){$div.addClass("deldiv");spec.isdel="Y";delServSpec(prodId,spec);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#terminalDiv_"+prodId).hide();$("#terminalUl_"+prodId+"_"+offerSpecId).remove();spec.isTerminal=0},no:function(){}})}};var _delOfferSpecReload=function(prodId,offerSpecId){var $div=$("#li_span_"+prodId+"_"+offerSpecId).parent();if($div.attr("class")=="block deldiv"){AttachOffer.addOfferSpec(prodId,offerSpecId)}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);var content=CacheData.getOfferProdStr(prodId,spec,2);$div.addClass("deldiv");spec.isdel="Y";delServSpec(prodId,spec);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#terminalDiv_"+prodId).hide();$("#terminalUl_"+prodId+"_"+offerSpecId).remove();spec.isTerminal=0}};var _lastStep=function(){$.confirm("信息","确定要取消吗？",{yes:function(){var boProd2Tds=OrderInfo.boProd2Tds;if(boProd2Tds.length>0){for(var n=0;n<boProd2Tds.length;n++){var param={numType:2,numValue:boProd2Tds[n].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",param,{done:function(){}})}}$("#order_tab_panel_content").hide();order.prepare.step(1)},no:function(){}},"question")};var _delOffer=function(prodId,offerId){var $div=$("#li_span_"+prodId+"_"+offerId).parent();if($div.attr("class")=="block deldiv"){AttachOffer.addOffer(prodId,offerId,$div.text())}else{var offer=CacheData.getOffer(prodId,offerId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=query.offer.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}var content="";if(offer.offerSpec!=undefined){content=CacheData.getOfferProdStr(prodId,offer,1)}else{content="退订【"+$div.text()+"】可选包"}$.confirm("信息确认",content,{yes:function(){offer.isdel="Y";$div.addClass("deldiv");delServByOffer(prodId,offer)},no:function(){}})}};var _closeServSpec=function(prodId,servSpecId,specName,ifParams){var $div=$("#li_span_"+prodId+"_"+servSpecId).parent();if($div.attr("class")=="block deldiv"){AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams)}else{$.confirm("信息确认","取消开通【"+specName+"】功能产品",{yesdo:function(){var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}$div.addClass("deldiv");spec.isdel="Y";_showHideUim(1,prodId,servSpecId);var serv=CacheData.getServBySpecId(prodId,servSpecId);if(ec.util.isObj(serv)){$div.addClass("deldiv");serv.isdel="Y"}},no:function(){}})}};var _closeServSpecReload=function(prodId,servSpecId,specName,ifParams){var $div=$("#li_span_"+prodId+"_"+servSpecId).parent();if($div.attr("class")=="block deldiv"){AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams)}else{var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}$div.addClass("deldiv");spec.isdel="Y";_showHideUim(1,prodId,servSpecId);var serv=CacheData.getServBySpecId(prodId,servSpecId);if(ec.util.isObj(serv)){$div.addClass("deldiv");serv.isdel="Y"}}};var _closeServ=function(prodId,servId){var serv=CacheData.getServ(prodId,servId);var $div=$("#li_span_"+prodId+"_"+servId).parent();if($div.attr("class")=="block deldiv"){_openServ(prodId,serv)}else{$.confirm("信息确认","关闭【"+$div.text()+"】功能产品",{yesdo:function(){$div.addClass("deldiv");serv.isdel="Y"},no:function(){}})}};var _openServSpec=function(prodId,servSpecId,specName,ifParams){$.confirm("信息确认","开通【"+specName+"】功能产品",{yesdo:function(){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDepend(prodId,servSpec)},no:function(){}})};var _openServSpecReload=function(prodId,servSpecId,specName,ifParams){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDepend(prodId,servSpec)};var _openServ=function(prodId,serv){$.confirm("信息确认","取消关闭【"+serv.servSpecName+"】功能产品",{yesdo:function(){if(serv!=undefined){if(serv.servSpecId==""){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.removeClass("del");serv.isdel="N"}else{_checkServExcludeDepend(prodId,serv)}}},no:function(){}})};var _checkOfferExcludeDepend=function(prodId,offerSpec){var offerSpecId=offerSpec.offerSpecId;var param=CacheData.getExcDepOfferParam(prodId,offerSpecId);var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName)}};var _checkServExcludeDepend=function(prodId,serv,flag){var servSpecId=serv.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserServData(data.result,prodId,serv)}}};var _addSearchOfferSpec=function(prodId,offerSpecId){$("#attachType_"+prodId).dblclick();AttachOffer.addOfferSpec(prodId,offerSpecId)};var _addOfferSpec=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){CacheData.setServ2OfferSpec(prodId,newSpec);_checkOfferExcludeDepend(prodId,newSpec)}else{$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)},no:function(){}})}};var _addOfferSpecByCheck=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)}})};var delServSpec=function(prodId,offerSpec){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var servSpecId=this.objId;
if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){var spec=CacheData.getServSpec(prodId,servSpecId);if(ec.util.isObj(spec)){spec.isdel="Y";var $li=$("#li_"+prodId+"_"+servSpecId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del");_showHideUim(1,prodId,servSpecId)}}})})};var delServByOffer=function(prodId,offer){$.each(offer.offerMemberInfos,function(){var servId=this.objInstId;if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){var serv=CacheData.getServ(prodId,servId);if(ec.util.isObj(serv)){serv.isdel="Y";var $li=$("#li_"+prodId+"_"+servId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del")}}})};var _addOffer=function(prodId,offerId,specName){$.confirm("信息确认","取消退订【"+specName+"】可选包",{yesdo:function(){var offer=CacheData.getOffer(prodId,offerId);if(offer!=undefined){if(offer.offerSpecId==""){$("#li_"+prodId+"_"+offerSpecId).find("div").removeClass("deldiv");offer.isdel="N"}else{_checkOfferExcludeDepend(prodId,offer)}}},no:function(){}})};var _addAttOffer=function(prodId,offerSpecId,specName){_addOfferSpec(prodId,offerSpecId)};var paserOfferData=function(result,prodId,offerSpecId,specName){var content="";var param={excludeOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(result!=""){var exclude=result.offerSpec.exclude;var depend=result.offerSpec.depend;if(ec.util.isArray(exclude)){for(var i=0;i<exclude.length;i++){var offerList=CacheData.getOfferList(prodId);var flag=true;if(offerList!=undefined){for(var j=0;j<offerList.length;j++){if(offerList[j].isdel=="Y"){if(offerList[j].offerSpecId==exclude[i].offerSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+exclude[i].offerSpecName+"<br>";param.excludeOffer.push(exclude[i].offerSpecId)}}}if(depend!=undefined&&ec.util.isArray(depend.offerInfos)){for(var i=0;i<depend.offerInfos.length;i++){content+="需要开通： "+depend.offerInfos[i].offerSpecName+"<br>";param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId)}}if(depend!=undefined&&ec.util.isArray(depend.offerGrpInfos)){for(var i=0;i<depend.offerGrpInfos.length;i++){var offerGrpInfo=depend.offerGrpInfos[i];param.dependOffer.offerGrpInfos.push(offerGrpInfo);content+="需要开通： 开通"+offerGrpInfo.minQty+"-"+offerGrpInfo.maxQty+"个以下业务:<br>";if(offerGrpInfo.subOfferSpecInfos!="undefined"&&offerGrpInfo.subOfferSpecInfos.length>0){for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){var subOfferSpec=offerGrpInfo.subOfferSpecInfos[j];content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}}}}var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);content=content+serContent;if(content==""){AttachOffer.addOpenList(prodId,offerSpecId)}else{content="<div style='max-height:300px;overflow:auto;'>"+content+"</div>";$.confirm("订购： "+specName,content,{yes:function(){CacheData.setOffer2ExcludeOfferSpec(param)},yesdo:function(){excludeAddattch(prodId,offerSpecId,param);excludeAddServ(prodId,"",paramObj)},no:function(){}})}};var paserServData=function(result,prodId,serv){var servSpecId=serv.servSpecId;var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";var param={excludeServ:[],dependServ:[],relatedServ:[]};if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";param.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.dependServ.push(this)})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.relatedServ.push(this)})}if(content==""){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{if(OrderInfo.provinceInfo.reloadFlag!=""&&OrderInfo.provinceInfo.reloadFlag=="N"){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);excludeAddServ(prodId,servSpecId,param)}else{$.confirm("开通： "+serv.servSpecName,content,{yesdo:function(){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);excludeAddServ(prodId,servSpecId,param)},no:function(){}})}}};var excludeAddServ=function(prodId,servSpecId,param){if(ec.util.isArray(param.excludeServ)){for(var i=0;i<param.excludeServ.length;i++){var excludeServSpecId=param.excludeServ[i].servSpecId;var spec=CacheData.getServSpec(prodId,excludeServSpecId);if(spec!=undefined){var $span=$("#li_"+prodId+"_"+excludeServSpecId).find("span");$span.addClass("del");spec.isdel="Y"}else{var serv=CacheData.getServBySpecId(prodId,excludeServSpecId);if(serv!=undefined){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.addClass("del");serv.isdel="Y"}}}}if(ec.util.isArray(param.dependServ)){for(var i=0;i<param.dependServ.length;i++){var servSpec=param.dependServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}if(ec.util.isArray(param.relatedServ)){for(var i=0;i<param.relatedServ.length;i++){var servSpec=param.relatedServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}};var excludeAddattch=function(prodId,specId,param){if(param.dependOffer.offerGrpInfos.length>0){var dependOffer=param.dependOffer;for(var i=0;i<dependOffer.offerGrpInfos.length;i++){var offerGrpInfo=dependOffer.offerGrpInfos[i];var len=offerGrpInfo.checkLen;if(len>=offerGrpInfo.minQty&&len<=offerGrpInfo.maxQty){$.each(offerGrpInfo.subOfferSpecInfos,function(){if(this.isCheck){AttachOffer.addOpenList(prodId,this.offerSpecId)}})}else{if(len<offerGrpInfo.minQty){$.alert("提示信息","依赖组至少选中"+offerGrpInfo.minQty+"个！");return}else{if(len>offerGrpInfo.maxQty){$.alert("提示信息","依赖组至多选中"+offerGrpInfo.maxQty+"个！");return}else{$.alert("错误信息","依赖组选择出错！");return}}}}}AttachOffer.addOpenList(prodId,specId);if(param.excludeOffer.length>0){for(var i=0;i<param.excludeOffer.length;i++){var excludeSpecId=param.excludeOffer[i];var spec=CacheData.getOfferSpec(prodId,excludeSpecId);if(spec!=undefined){var $div=$("#li_span_"+prodId+"_"+excludeSpecId).parent();$div.addClass("deldiv");var $span=$("#li_"+prodId+"_"+excludeSpecId).find("span");$span.addClass("del");spec.isdel="Y";$("#terminalUl_"+prodId+"_"+excludeSpecId).remove();$("li[name=tr_"+prodId+"_"+excludeSpecId+"]").remove()}var offer=CacheData.getOfferBySpecId(prodId,excludeSpecId);if(offer!=undefined){var $div=$("#li_span_"+prodId+"_"+excludeSpecId).parent();$div.addClass("deldiv");var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.addClass("del");offer.isdel="Y"}}}if(param.dependOffer.dependOffers.length>0){for(var i=0;i<param.dependOffer.dependOffers.length;i++){var offerSpecId=param.dependOffer.dependOffers[i];AttachOffer.addOpenList(prodId,offerSpecId)}}};var _addOpenList=function(prodId,offerSpecId){var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(offer!=undefined){$("#li_"+prodId+"_"+offer.offerId).find("div").removeClass("deldiv");offer.isdel="N";return}var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}if(newSpec.isdel=="C"){var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();var $li=$('<li id="li_'+prodId+"_"+offerSpecId+'" class="ui-li-static ui-body-inherit ui-last-child"></li>');var $div=$('<div class="block"></div>');$div.append(newSpec.offerSpecName+"<span></span>");var $span=$('<span id="li_span_'+prodId+"_"+offerSpecId+'"></span>');if(newSpec.ifParams){if(CacheData.setParam(prodId,newSpec)){$span.append('<a href="javascript:void(0);" id="can_'+prodId+"_"+offerSpecId+'" isset="N" class="abtn01" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');">参</a>')}else{$span.append('<a href="javascript:void(0);" id="can_'+prodId+"_"+offerSpecId+'" isset="Y" class="abtn03" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');">参</a>')
}}if(newSpec.ifShowTime=="Y"){$li.append('<a href="javascript:void(0);" class="abtn01" id="time_'+prodId+"_"+offerSpecId+'" isset="N" onclick="AttachOffer.showTime('+prodId+","+offerSpecId+",'"+newSpec.offerSpecName+"');\">时</a>")}if(newSpec.ifDault==0){$span.append('<a href="javascript:void(0);" class="abtn03 icon-nodel ui-link">&nbsp;</a>')}else{$span.append('<a href="javascript:void(0);" class="abtn02 icon-del" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+');">&nbsp;</a>')}$div.append($span).appendTo($li);$("#open_ul_"+prodId).append($li);newSpec.isdel="N"}else{if((newSpec.isdel=="Y")){$("#li_"+prodId+"_"+offerSpecId).find("div").removeClass("deldiv");newSpec.isdel="N"}else{var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();var $li=$('<li id="li_'+prodId+"_"+offerSpecId+'"></li>');if(newSpec.ifDault==0){$li.append('<dd class="mustchoose"></dd>')}else{$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+')"></dd>')}$li.append("<span>"+newSpec.offerSpecName+"</span>");if(newSpec.ifParams){if(CacheData.setParam(prodId,newSpec)){$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}}if(newSpec.ifShowTime=="Y"){$li.append('<dd class="time" id="time_'+prodId+"_"+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+","+offerSpecId+",'"+newSpec.offerSpecName+"');\"></dd>")}$("#open_ul_"+prodId).append($li)}}if(newSpec!=undefined){$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty!=2){var ifParams="N";if(ec.util.isArray(this.prodSpecParams)){ifParams="Y"}_addOpenServList(prodId,this.objId,this.objName,ifParams);if(this.minQty>0){_minQtyFileter(prodId,this.objId)}}})})}if(ec.util.isArray(newSpec.agreementInfos)){var objInstId=prodId+"_"+newSpec.offerSpecId;$("#terminalDiv").append('<input id="terminalText_'+objInstId+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />');var $ul=$('<ul id="terminalUl_'+objInstId+'" class="fillin show" style="margin-left:0px;padding-left:0px;"></ul>');var $sel=$('<select id="terminalSel_'+objInstId+'"></select>');var $li1=$('<li class="full"><label style=""><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+"</span></label></li>");var $li2=$('<li style="display:none;"><label> 可选终端规格：</label></li>');$.each(newSpec.agreementInfos,function(){var $option=$('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+"</option>");$sel.append($option)});$li2.append($sel).append('<label class="f_red">*</label>');var $li3="";if(OrderInfo.actionFlag==2){$li3=$('<label>终端校验：</label><input id="terminalText_'+objInstId+'" type="text" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" style="width:210px;height:30px; display: inline-block; margin-right: 20px;" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><label><input type="checkbox" id="if_p_reserveCode" onclick="AttachOffer.changereserveCode()">使用预约码：</label><input id="reserveCode" type="text" disabled="disabled" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" maxlength="50" placeholder="请输入预约码" style="background-color: #E8E8E8;width:50%;height:45px;"/><input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+","+newSpec.offerSpecId+')" value="校验" class="ui-btn ui-shadow ui-corner-all ui-mini" style="width:50px;display: inline-block"></input>')}else{$li3=$('<label>终端校验：</label><input id="terminalText_'+objInstId+'" type="text" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" style="width:50%;height:45px;" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><label><input type="checkbox" id="if_p_reserveCode" onclick="AttachOffer.changereserveCode()">使用预约码：</label><input id="reserveCode" type="text" disabled="disabled" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" maxlength="50" placeholder="请输入预约码" style="background-color: #E8E8E8;width:50%;height:45px;"/><input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+","+newSpec.offerSpecId+')" value="校验" class="ui-btn ui-shadow ui-corner-all ui-mini" style="width:50%;"></input>')}var $div=$("#terminalDiv_"+prodId);$("#terminalDiv_"+prodId).css("display","none");var $li4=$('<li id="terminalDesc" style="display:none;white-space:nowrap;"><label> 终端规格：</label><label id="terminalName"></label></li>');$ul.append($li1).append($li2).append($li3).append($li4).appendTo($div);if(OrderInfo.terminalCode!=null&&OrderInfo.terminalCode!=""&&OrderInfo.terminalCode!="null"&&OrderInfo.provinceInfo.reloadFlag=="Y"){var accessNum=OrderInfo.getAccessNumber(prodId);if(accessNum!=""&&accessNum!=null&&accessNum!=undefined){var terminalCodeArray=OrderInfo.terminalCode.split(",");for(var k=0;k<terminalCodeArray.length;k++){if(terminalCodeArray[k].indexOf(accessNum)!=-1){var terminalCode=terminalCodeArray[k].split("_")[1];$("#terminalText_"+objInstId).val(terminalCode);break}}}}$div.show();newSpec.isTerminal=1;if(OrderInfo.actionFlag==14){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var coupon=OrderInfo.attach2Coupons[i];if(prodId==coupon.prodId){$("#terminalSel_"+objInstId).val(coupon.couponId);$("#terminalSel_"+objInstId).attr("disabled",true);$("#terminalText_"+objInstId).val(coupon.couponInstanceNumber);$("#terminalText_"+objInstId).attr("disabled",true);$("#terminalBtn_"+objInstId).hide()}}}}};var _changereserveCode=function(){if(document.getElementById("if_p_reserveCode").checked){$("#reserveCode").css("background-color","white").attr("disabled",false)}else{$("#reserveCode").css("background-color","#E8E8E8").attr("disabled",true)}};var _checkTerminalCode=function(prodId,offerSpecId){var flag="0";for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId){OrderInfo.attach2Coupons.splice(i,1);break}}var objInstId=prodId+"_"+offerSpecId;var resIdArray=[];var terminalGroupIdArray=[];$("#terminalSel_"+objInstId+"  option").each(function(){resIdArray.push($(this).val())});$("#group_"+objInstId+"  option").each(function(){terminalGroupIdArray.push($(this).val())});var resId=resIdArray.join("|");var terminalGroupId=terminalGroupIdArray.join("|");if((resId==undefined||$.trim(resId)=="")&&(terminalGroupId==undefined||$.trim(terminalGroupId)=="")){$.alert("信息提示","终端规格不能为空！");return}var instCode=$("#terminalText_"+objInstId).val();if(instCode==undefined||$.trim(instCode)==""){$.alert("信息提示","终端串码不能为空！");return}if(document.getElementById("if_p_reserveCode").checked){var reserveCode=$("#reserveCode").val();if(reserveCode==""){$.alert("信息提示","请输入终端预约码！");return}}if(_checkData(objInstId,instCode)){return}var param={instCode:instCode,flag:flag,mktResId:"",termGroup:""};var data=query.prod.checkTerminal(param);if(data==undefined){return}var activtyType="";for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"&&ec.util.isArray(spec.agreementInfos)){if(spec.agreementInfos[0].activtyType==2){activtyType="2"}}}}if(data.statusCd==CONST.MKTRES_STATUS.USABLE||(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2")){$("#terminalSel_"+objInstId).val(data.mktResId);var price=$("#terminalSel_"+objInstId).find("option:selected").attr("price");var mktPrice=0;var mktColor="";if(ec.util.isArray(data.mktAttrList)){$.each(data.mktAttrList,function(){if(this.attrId=="65010058"){mktPrice=this.attrValue
}else{if(this.attrId=="60010004"){mktColor=this.attrValue}}})}$("#terminalName").html(data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");$("#terminalDesc").css("display","block");var coupon={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:data.mktResStoreId,storeName:"1",agentId:1,apCharge:mktPrice,couponInstanceNumber:data.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:-1,attachSepcId:offerSpecId,state:"ADD",relaSeq:"",num:"1"};if(CONST.getAppDesc()==0){coupon.termTypeFlag=data.termTypeFlag}if(document.getElementById("if_p_reserveCode").checked){var custId=OrderInfo.cust.custId;var identityTypeCd="";var identityNum="";if(custId==-1){identityTypeCd=OrderInfo.boCustIdentities.identidiesTypeCd;identityNum=OrderInfo.boCustIdentities.identityNum}var param={reserveCode:reserveCode,couponId:data.mktResId,terminalPrice:mktPrice,custId:custId,identityTypeCd:identityTypeCd,identityNum:identityNum};var url=contextPath+"/mktRes/terminal/queryCouponReserveCodeCheck ";$.callServiceAsJson(url,param,{before:function(){},always:function(){},done:function(response){if(response&&response.code==-2){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[];$.alertM(response.data);return}else{if(response&&response.data&&response.data.code==0){if(response.data.buyFlag!=null&&response.data.buyFlag=="Y"){var content="您购买的终端和预约的终端不一致，请确认是否需要购买该终端？";$.confirm("信息确认",content,{yes:function(){},yesdo:function(){if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})})}checkedReserveNbr=response.data.couponInfo.reserveNbr;coupon.sourceId=checkedReserveNbr;OrderInfo.termReserveFlag=CONST.OL_TYPE_CD.ZDYY;OrderInfo.attach2Coupons.push(coupon);if(response.data.offerSpec.length>0){checkedOfferSpec=response.data.offerSpec;var content='<form id="promotionForm"><table>';var selectStr="";var optionStr="";selectStr=selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>";$.each(response.data.offerSpec,function(){var offerSpec=this;optionStr+='<option value="'+this.offerSpecId+'">'+this.offerSpecName+"</option>"});selectStr+=optionStr+"</select></td></tr>";content+=selectStr;var offerSpecId;$.confirm("促销包选择",content,{yes:function(){},no:function(){}});$("#promotionForm").bind("formIsValid",function(event,form){offerSpecId=$("#"+checkedReserveNbr+" option:selected").val();$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove();AttachOffer.selectAttachOffer(prodId,offerSpecId)}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}},no:function(){}})}else{if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})})}checkedReserveNbr=response.data.couponInfo.reserveNbr;coupon.sourceId=checkedReserveNbr;OrderInfo.termReserveFlag=CONST.OL_TYPE_CD.ZDYY;OrderInfo.attach2Coupons.push(coupon);if(response.data.offerSpec.length>0){checkedOfferSpec=response.data.offerSpec;var content='<form id="promotionForm"><table>';var selectStr="";var optionStr="";selectStr=selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>";$.each(response.data.offerSpec,function(){var offerSpec=this;optionStr+='<option value="'+this.offerSpecId+'">'+this.offerSpecName+"</option>"});selectStr+=optionStr+"</select></td></tr>";content+=selectStr;var offerSpecId;$.confirm("促销包选择",content,{yes:function(){},no:function(){}});$("#promotionForm").bind("formIsValid",function(event,form){offerSpecId=$("#"+checkedReserveNbr+" option:selected").val();$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove();AttachOffer.selectAttachOffer(prodId,offerSpecId)}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{$.alert("信息提示",data.message)}}}else{if(response&&response.data&&response.data.message&&response.data.code==1){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[];$.alert("提示",response.data.message);return}else{$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[];$.alert("提示","<br/>终端预约码校验失败，请稍后重试！");return}}}}})}else{$.alert("信息提示",data.message);OrderInfo.attach2Coupons.push(coupon)}}else{if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}else{$.alert("提示",data.message)}}};var _setSpec=function(prodId,offerSpecId){var newSpec=CacheData.getOfferSpec(prodId,offerSpecId);if(newSpec==undefined){newSpec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!newSpec){return}CacheData.setOfferSpec(prodId,newSpec)}return newSpec};var _addOpenServList=function(prodId,servSpecId,servSpecName,ifParams){var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){$("#li_"+prodId+"_"+serv.servId).find("div").removeClass("deldiv");serv.isdel="N";return}var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:servSpecName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams}CacheData.setServSpec(prodId,newSpec);spec=newSpec}if(spec.isdel=="C"){$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'" class="ui-li-static ui-body-inherit ui-last-child"></li>');var $div=$('<div class="block"></div>');$div.append(servSpecName+"<span></span>");var $span=$('<span id="li_span_'+prodId+"_"+servSpecId+'"></span>');if(spec.ifDault==0){$span.append('<a href="javascript:void(0);" class="abtn03 icon-nodel ui-link">&nbsp;</a>')}else{$span.append('<a href="javascript:void(0);" class="abtn02 icon-del" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+servSpecName+"','"+ifParams+"');\">&nbsp;</a>")}if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="abtn01" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="abtn02" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$div.append($span).appendTo($li).appendTo($("#open_serv_ul_"+prodId));
spec.isdel="N"}else{$("#li_span_"+prodId+"_"+servSpecId).parent().removeClass("deldiv")}spec.isdel="N";_showHideUim(0,prodId,servSpecId)};var _showMainParam=function(){var content=CacheData.getParamContent(-1,OrderInfo.offerSpec,0);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){}).ketchup({bindElement:"easyDialogYesBtn"})};var _showParam=function(prodId,offerSpecId,flag){if(flag==1){var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offer.offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=query.offer.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}if(!offer.isGetParam){var param={offerTypeCd:"2",offerId:offer.offerId,offerSpecId:offer.offerSpecId};var offerParam=query.offer.queryOfferParam(param);if(offerParam==undefined){return}else{offer.offerParamInfos=offerParam.offerParamInfos;offer.isGetParam=true}}var content=CacheData.getParamContent(prodId,offer,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var isset=false;$.each(offer.offerSpec.offerSpecParams,function(){var itemInfo=CacheData.getOfferParam(prodId,offer.offerId,this.itemSpecId);itemInfo.setValue=$("#"+prodId+"_"+this.itemSpecId).val();if(itemInfo.value!=itemInfo.setValue){itemInfo.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+offer.offerId).removeClass("abtn03").addClass("abtn01");offer.isset="Y";offer.update="Y"}else{$("#can_"+prodId+"_"+offer.offerId).removeClass("abtn01").addClass("abtn03");offer.isset="N";offer.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);if(spec==undefined){spec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!spec){return}}var content=CacheData.getParamContent(prodId,spec,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){if(!paramInputCheck()){return}if(!!spec.offerSpecParams){for(var i=0;i<spec.offerSpecParams.length;i++){var param=spec.offerSpecParams[i];var itemSpec=CacheData.getSpecParam(prodId,offerSpecId,param.itemSpecId);itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}if(spec.offerRoles!=undefined&&spec.offerRoles.length>0){for(var i=0;i<spec.offerRoles.length;i++){var offerRole=spec.offerRoles[i];for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(!!roleObj.prodSpecParams){for(var k=0;k<roleObj.prodSpecParams.length;k++){var prodParam=roleObj.prodSpecParams[k];var prodItem=CacheData.getProdSpecParam(prodId,offerSpecId,prodParam.itemSpecId);prodItem.value=$("#"+prodId+"_"+prodParam.itemSpecId).val()}}}}}$("#can_"+prodId+"_"+offerSpecId).removeClass("abtn03").addClass("abtn01");var attchSpec=CacheData.getOfferSpec(prodId,offerSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var paramInputCheck=function(){var pass=true;$("#paramForm").find("input[type=text]").each(function(){var mask=$(this).attr("mask");var maskmsg=$(this).attr("maskmsg");if(mask!=null&&mask!=""&&mask.substring(0,1)=="/"&&mask.substring(mask.length-1,mask.length)=="/"){if(!eval(mask).test($(this).val())){$.alert("提示",maskmsg);pass=false;return false}}});return pass};var _showServParam=function(prodId,servSpecId,flag){if(flag==1){var serv=CacheData.getServBySpecId(prodId,servSpecId);var param={prodId:serv.servId,ifServItem:"Y"};if(!serv.isGetParamSpec){param.prodSpecId=serv.servSpecId;var dataSepc=query.prod.prodSpecParamQuery(param);if(dataSepc==undefined){return}else{serv.prodSpecParams=dataSepc.result.prodSpecParams;serv.isGetParamSpec=true}}if(!serv.isGetParamInst){var data=query.prod.prodInstParamQuery(param);if(data==undefined){return}else{serv.prodInstParams=data.result.prodInstParams;serv.isGetParamInst=true}}var content=CacheData.getParamContent(prodId,serv,3);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var isset=false;$.each(serv.prodSpecParams,function(){var prodItem=CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);prodItem.setValue=$("#"+prodId+"_"+this.itemSpecId).val();if(prodItem.value!=prodItem.setValue){prodItem.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+serv.servId).removeClass("abtn03").addClass("abtn01");serv.isset="Y";serv.update="Y"}else{$("#can_"+prodId+"_"+serv.servId).removeClass("abtn01").addClass("abtn02");serv.isset="N";serv.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}var content=CacheData.getParamContent(prodId,spec,2);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){if(!!spec.prodSpecParams){for(var i=0;i<spec.prodSpecParams.length;i++){var param=spec.prodSpecParams[i];var itemSpec=CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}$("#can_"+prodId+"_"+servSpecId).removeClass("abtn03").addClass("abtn01");var attchSpec=CacheData.getServSpec(prodId,servSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var _showTime=function(prodId,offerSpecId,offerSpecName){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(offerSpecName+"--生失效设置");var spec=CacheData.getOfferSpec(prodId,offerSpecId);_initTime(spec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setAttachTime(prodId,offerSpecId)});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showStartTime=function(){var strDate=DateUtil.Format("yyyy年MM月dd日",new Date());var endDate=$("#endDt").val();if(endDate==""){$.calendar({minDate:strDate})}else{$.calendar({minDate:strDate,maxDate:endDate})}};var _showEndTime=function(){var strDate=$("#startDt").val();if(strDate==""){strDate=DateUtil.Format("yyyy年MM月dd日",new Date())}$.calendar({minDate:strDate})};var _initTime=function(spec){if(spec!=undefined&&spec.ooTimes!=undefined){var ooTime=spec.ooTimes;$("input[name=startTimeType][value='"+ooTime.startType+"']").attr("checked","checked");$("input[name=endTimeType][value='"+ooTime.endType+"']").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("");if(ooTime.startType==4){$("#startDt").val(ooTime.startDt)}if(ooTime.endType==4){$("#endDt").val(ooTime.endDt)}else{if(ooTime.endType==5){$("#endTime").val(ooTime.effTime);$("#endTimeUnit").val(ooTime.effTimeUnitCd)}}}else{$("input[name=startTimeType][value=1]").attr("checked","checked");$("input[name=endTimeType][value=1]").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("")}};var _showOfferTime=function(){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(OrderInfo.offerSpec.offerSpecName+"-生失效设置");_initTime(OrderInfo.offerSpec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setMainTime()});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showMainMember=function(){$("#memberName").text(OrderInfo.offerSpec.offerSpecName+"-构成");$("#main_member_div").empty();$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');
$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)});$("#main_member_div").append('<div class="clear"></div>')}else{$.each(offerRole.prodInsts,function(){var prodId=this.prodInstId;var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)}});$("#main_member_div").append('<div class="clear"></div>')})}});easyDialog.open({container:"div_member_dialog"});$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(offerRole.prodInsts,function(){var prodInst=this;$.each(offerRole.roleObjs,function(){var servSpecId=this.objId;if(this.minQty>0){$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked");$(this).attr("disabled","disabled")}})}});if(!!prodInst.servInsts){$.each(prodInst.servInsts,function(){var servSpecId=this.objId;$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked")}})})}})});$("#memberSpan").off("click").on("click",function(){_setMainMember()})};var _setMainMember=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(this.prodInsts,function(){var prodInst=this;prodInst.servInsts=[];$("input[name='serv_check_"+this.prodInstId+"']:checked").each(function(){var servSpecId=$(this).attr("servSpecId");$.each(offerRole.roleObjs,function(){if(this.objId==servSpecId){prodInst.servInsts.push(this)}})})})});easyDialog.close()};var _getTime=function(){var ooTime={state:"ADD"};var startRadio=$("input[name=startTimeType]:checked").attr("value");ooTime.startType=startRadio;if(startRadio==1){ooTime.isDefaultStart="Y"}else{if(startRadio==2){}else{if(startRadio==3){ooTime.startTime=1;ooTime.startTimeUnitCd=7}else{if(startRadio==4){if($("#startDt").val()==""){$.alert("提示","指定生效时间不能为空!");return}ooTime.startDt=$("#startDt").val()}}}}var endRadio=$("input[name=endTimeType]:checked").attr("value");ooTime.endType=endRadio;if(endRadio==1){ooTime.isDefaultEnd="Y"}else{if(endRadio==4){if($("#endDt").val()==""){$.alert("提示","指定失效时间不能为空!");return}ooTime.endDt=$("#endDt").val()}else{if(endRadio==5){var end=$("#endTime").val();if(end==""){$.alert("提示","有效时长不能为空!");return}if(isNaN(end)){$.alert("提示","有效时长必须为数字!");return}if(end<=0){$.alert("提示","有效时长必须大于0!");return}ooTime.effTime=end;ooTime.effTimeUnitCd=$("#endTimeUnit").val()}}}return ooTime};var _setMainTime=function(){var ooTime=_getTime();if(ooTime==undefined){return}OrderInfo.offerSpec.ooTimes=ooTime;$("#mainTime").removeClass("time").addClass("time2");easyDialog.close()};var _setAttachTime=function(prodId,offerSpecId){var ooTime=_getTime();if(ooTime==undefined){return}var spec=CacheData.getOfferSpec(prodId,offerSpecId);spec.ooTimes=ooTime;$("#time_"+prodId+"_"+offerSpecId).removeClass("time").addClass("time2");easyDialog.close()};var _changeLabel1=function(prodId,prodSpecId,obj){var labelId=$(obj).val();_changeLabel(prodId,prodSpecId,labelId)};var _changeLabel1x=function(prodId,prodSpecId,obj){var labelId="search";_changeLabel(prodId,prodSpecId,labelId)};var _showHideUim=function(flag,prodId,servSpecId){if(CONST.getAppDesc()==0&&servSpecId==CONST.PROD_SPEC.PROD_FUN_4G){var prodClass=order.prodModify.choosedProdInfo.prodClass;if(OrderInfo.actionFlag==2){prodClass=CacheData.getOfferMember(prodId).prodClass;if(prodClass==undefined&&offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==prodId){prodClass=this.prodClass}})})}}if(flag==0){if(prodClass==CONST.PROD_CLASS.THREE){$("#uimDiv_"+prodId).show();var actionFalg=OrderInfo.actionFlag;var instCode=OrderInfo.provinceInfo.mktResInstCode;var codeMsg=OrderInfo.provinceInfo.codeMsg;if(actionFalg=="3"&&OrderInfo.provinceInfo.reloadFlag=="Y"){if(codeMsg!=null&&codeMsg!=""){$.alert("提示",codeMsg)}else{if(instCode!=null&&instCode!=""){$("#uim_txt_"+prodId).val(instCode);$("#uim_check_btn_"+prodId).hide();$("#uim_release_btn_"+prodId).hide();$("#uim_txt_"+prodId).attr("disabled",true);var uimParam={instCode:instCode};var response=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);if(response.code==0){if(response.data.mktResBaseInfo){var statusCd=response.data.mktResBaseInfo.statusCd;if(statusCd=="1102"){var offerId="";if(ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){offerId=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{offerId=order.prodModify.choosedProdInfo.prodOfferInstId}_packageCouponInfo(prodId,offerId,response,instCode)}else{$.alert("提示","UIM卡不是预占状态，当前为"+statusCd)}}else{$.alert("提示","查询不到UIM卡["+instCode+"]信息")}}else{if(response.code==-2){$.alertM(response.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}if(order.memberChange.mktResInstCode!=""&&order.memberChange.mktResInstCode!=undefined&&order.memberChange.reloadFlag=="Y"){var offerId="-1";if(ec.util.isArray(OrderInfo.oldprodInstInfos)){if(ec.util.isArray(OrderInfo.viceprodInstInfos)&&OrderInfo.oldMvFlag){$.each(OrderInfo.viceprodInstInfos,function(){if(this.prodInstId==prodId){offerId=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){offerId=this.mainProdOfferInstInfos[0].prodOfferInstId}})}}else{offerId=order.prodModify.choosedProdInfo.prodOfferInstId}var mktResInstCodesize=order.memberChange.mktResInstCode.split(",");for(var u=0;u<mktResInstCodesize.length;u++){if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null"){var nbrAndUimCode=mktResInstCodesize[u].split("_");var _accNbr=nbrAndUimCode[0];var _uimCode=nbrAndUimCode[1];var oldSubPhoneNumsize=order.memberChange.oldSubPhoneNum.split(",");for(var n=0;n<oldSubPhoneNumsize.length;n++){if(oldSubPhoneNumsize[n]==_accNbr){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.accessNumber==_accNbr){$("#uim_txt_"+this.objInstId).attr("disabled",true);var uimParam={instCode:_uimCode};var response=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);if(response.code==0){if(response.data.mktResBaseInfo){if(response.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_"+this.objInstId).attr("disabled",true);$("#uim_check_btn_"+this.objInstId).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+this.objInstId).attr("disabled",false);$("#uim_release_btn_"+this.objInstId).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+this.objInstId).val(_uimCode);var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:response.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:response.data.mktResBaseInfo.qty,storeId:response.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:_uimCode,terminalCode:_uimCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:this.objInstId,offerId:offerId,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(-(n+1));OrderInfo.boProd2Tds.push(coupon)}else{$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(response.code==-2){$.alertM(response.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}})
})}}}}}if((OrderInfo.actionFlag==2||OrderInfo.actionFlag==1)&&OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""&&OrderInfo.mktResInstCode!="null"&&OrderInfo.provinceInfo.reloadFlag=="Y"){var offerId="-1";$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){offerId=this.mainProdOfferInstInfos[0].prodOfferInstId}});var mktResInstCodesize=order.memberChange.mktResInstCode.split(",");for(var u=0;u<mktResInstCodesize.length;u++){if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null"){var nbrAndUimCode=mktResInstCodesize[u].split("_");var _accNbr=nbrAndUimCode[0];var _uimCode=nbrAndUimCode[1];var oldSubPhoneNumsize=order.memberChange.oldSubPhoneNum.split(",");for(var n=0;n<oldSubPhoneNumsize.length;n++){if(oldSubPhoneNumsize[n]==_accNbr){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.accessNumber==_accNbr){var uimParam={instCode:_uimCode};var response=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);if(response.code==0){if(response.data.mktResBaseInfo){if(response.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_"+this.objInstId).attr("disabled",true);$("#uim_release_btn_"+this.objInstId).attr("disabled",false);$("#uim_release_btn_"+this.objInstId).removeClass("disabled");$("#uim_txt_"+this.objInstId).attr("disabled",true);$("#uim_txt_"+this.objInstId).val(_uimCode);var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:response.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:response.data.mktResBaseInfo.qty,storeId:response.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:_uimCode,terminalCode:_uimCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:this.objInstId,offerId:offerId,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(this.objInstId);OrderInfo.boProd2Tds.push(coupon)}else{$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(response.code==-2){$.alertM(response.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}})})}}}}}}}else{if(flag==1){if(prodClass==CONST.PROD_CLASS.THREE){$("#uimDiv_"+prodId).hide()}}}}};var _packageCouponInfo=function(prodId,offerId,response,instCode){var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:response.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:response.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:instCode,terminalCode:instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:offerId,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(prodId);OrderInfo.boProd2Tds.push(coupon)};var _isChangeUim=function(objId){if(CONST.getAppDesc()==0){var prodClass=order.prodModify.choosedProdInfo.prodClass;var prodId=order.prodModify.choosedProdInfo.prodInstId;if(OrderInfo.actionFlag==2){var member=CacheData.getOfferMember(objId);prodClass=member.prodClass;prodId=member.objInstId}else{if(OrderInfo.actionFlag==6){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==objId){prodClass=this.prodClass;prodId=this.prodInstId}});$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==prodId){var member=CacheData.getOfferMember(objId);prodClass=member.prodClass;prodId=member.objInstId}})}}if(prodClass==CONST.PROD_CLASS.THREE){var servSpec=CacheData.getServSpec(prodId,CONST.PROD_SPEC.PROD_FUN_4G);if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){return true}}}return false};var _setAttachBusiOrder=function(busiOrders){$.each(AttachOffer.openServList,function(){var prodId=this.prodId;$.each(this.servSpecList,function(){if(this.isdel!="Y"&&this.isdel!="C"){SoOrder.createServ(this,prodId,0,busiOrders)}})});$.each(AttachOffer.openedServList,function(){var prodId=this.prodId;$.each(this.servList,function(){if(this.isdel=="Y"){SoOrder.createServ(this,prodId,1,busiOrders)}else{if(this.update=="Y"){SoOrder.createServ(this,prodId,2,busiOrders)}}})});for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"){SoOrder.createAttOffer(spec,open.prodId,0,busiOrders)}}}for(var i=0;i<AttachOffer.openedList.length;i++){var opened=AttachOffer.openedList[i];for(var j=0;j<opened.offerList.length;j++){var offer=opened.offerList[j];if(offer.isdel=="Y"){SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}else{if(offer.update=="Y"){SoOrder.createAttOffer(offer,opened.prodId,2,busiOrders)}}}}$.each(AttachOffer.openAppList,function(){var prodId=this.prodId;$.each(this.appList,function(){if(this.dfQty==1){SoOrder.createServ(this,prodId,0,busiOrders)}})})};var _setChangeList=function(prodId){AttachOffer.changeList=[];var prodInfos=offerChange.resultOffer.prodInfos;if(ec.util.isArray(prodInfos)){$.each(prodInfos,function(){if(prodId!=this.accProdInstId){return true}if(prodId!=this.prodInstId){var param={prodInstId:prodId};var serv=CacheData.getServ(prodId,this.prodInstId);var servSpec=CacheData.getServSpec(prodId,this.productId);if(this.state=="DEL"){if(serv!=undefined&&serv.isdel!="Y"){param.objId=this.prodInstId;param.status=(serv.isdel!=undefined?serv.isdel:"N");param.objIdType=1;serv.isdel="Y";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){param.objId=this.productId;param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(serv!=undefined&&serv.isdel=="Y"){param.objId=this.prodInstId;param.status=serv.isdel;param.objIdType=1;serv.isdel="N";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel=="Y"){param.objId=this.productId;param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(serv==undefined&&servSpec==undefined){param.objId=this.productId;param.status="Y";param.objIdType=2;AttachOffer.changeList.push(param);if(this.productId!=undefined&&this.productId!=""){var newSerSpec={objId:this.productId,servSpecId:this.productId,servSpecName:this.productName,ifParams:"N",isdel:"N"};CacheData.setServSpec(prodId,newSerSpec);var servSpec=CacheData.getServSpec(prodId,this.productId);servSpec.isdel="N"}}}}}}}})}var offers=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(offers)){$.each(offers,function(){if(this.memberInfo==undefined){return true}var flag=true;$.each(this.memberInfo,function(){if(ec.util.isObj(this.accProdInstId)&&prodId==this.accProdInstId){flag=false;return false}});if(flag){return true}var param={prodInstId:prodId};var offer=CacheData.getOffer(prodId,this.prodOfferInstId);var offerSpec=CacheData.getOfferSpec(prodId,this.prodOfferId);if(this.state=="DEL"){if(offer!=undefined&&offer.isdel!="Y"){param.objId=this.prodOfferInstId;param.status=(offer.isdel!=undefined?offer.isdel:"N");param.objIdType=3;offer.isdel="Y";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(offer!=undefined&&offer.isdel=="Y"){param.objId=this.prodOfferInstId;param.status=offer.isdel;param.objIdType=3;offer.isdel="N";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel=="Y"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(offer==undefined&&offerSpec==undefined){param.objId=this.prodOfferId;param.status="Y";param.objIdType=4;AttachOffer.changeList.push(param);if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){var newOfferSpec=_setSpec(prodId,this.prodOfferId);newOfferSpec.isdel="N"}}}}}}})}};var _reductionChangList=function(prodId){$.each(AttachOffer.changeList,function(){if(this.prodInstId==prodId){if(this.objIdType==1){var serv=CacheData.getServ(prodId,this.objId);
if(serv!=undefined){serv.isdel=this.status}}else{if(this.objIdType==2){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec!=undefined){servSpec.isdel=this.status}}else{if(this.objIdType==3){var offer=CacheData.getOffer(prodId,this.objId);if(offer!=undefined){offer.isdel=this.status}}else{if(this.objIdType==4){var offerSpec=CacheData.getOfferSpec(prodId,this.objId);if(offerSpec!=undefined){offerSpec.isdel=this.status}}}}}}})};var _servExDepReByRoleObjs=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);paramObj.excludeServ=[];paramObj.dependServ=[];paramObj.relatedServ=[];var globContent="";$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec==undefined){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv==undefined){var newServSpec={objId:this.objId,servSpecId:this.objId,servSpecName:this.objName,ifParams:this.isCompParam,prodSpecParams:this.prodSpecParams,isdel:"C"};CacheData.setServSpec(prodId,newServSpec);servSpec=newServSpec}else{servSpec=serv}}var servSpecId=servSpec.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){}else{var data=query.offer.queryExcludeDepend(param);var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);if(content!=""){content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);globContent+=(content+"<br>")}}}})});return globContent};var paramObj={excludeServ:[],dependServ:[],relatedServ:[]};var paserServDataByObjs=function(result,prodId,serv,newSpec){var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";paramObj.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.dependServ.push(this)}})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.relatedServ.push(this)}})}return content};var _filterServ=function(servSpecId,newSpec){var flag=false;$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){if(servSpecId==this.objId){flag=true;return false}}})});if(!flag){if(ec.util.isArray(paramObj.dependServ)){for(var i=0;i<paramObj.dependServ.length;i++){if(servSpecId==paramObj.dependServ[i].servSpecId){flag=true;break}}}if(!flag){if(ec.util.isArray(paramObj.relatedServ)){for(var i=0;i<paramObj.relatedServ.length;i++){if(servSpecId==paramObj.relatedServ[i].servSpecId){flag=true;break}}}}}return flag};var _minQtyFileter=function(prodId,servSpecId){var serv=CacheData.getServBySpecId(prodId,servSpecId);var $li;if(serv!=undefined){$li=$("#li_"+prodId+"_"+serv.servId)}else{$li=$("#li_"+prodId+"_"+servSpecId)}if($li!=undefined){$li.find(".delete").remove();$li.append('<dd class="mustchoose"></dd>')}};var _showMainMemberRoleProd=function(prodId){for(var i=0;i<OrderInfo.viceOfferSpec.length;i++){var offerSpec=OrderInfo.viceOfferSpec[i];if(prodId==offerSpec.prodId){for(var j=0;j<offerSpec.offerRoles.length;j++){var offerRole=offerSpec.offerRoles[j];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldLi=$("#li_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}if(roleObj.dfQty>0){var servSpec=jQuery.extend(true,{},roleObj);CacheData.setServSpec(prodId,servSpec);spec=servSpec;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');if(roleObj.minQty==0){$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+"')\"></dd>")}else{$li.append('<dd class="mustchoose"></dd>')}$li.append("<span>"+spec.servSpecName+"</span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$li.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');$("#open_serv_ul_"+prodId).append($li);spec.isdel="N";_showHideUim(0,prodId,servSpecId)}}}}}}}};var _delServSpec=function(prodId,offerSpec){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var servSpecId=this.objId;if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){var spec=CacheData.getServSpec(prodId,servSpecId);if(ec.util.isObj(spec)){spec.isdel="Y";var $li=$("#li_"+prodId+"_"+servSpecId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del");_showHideUim(1,prodId,servSpecId)}}})})};return{excludeAddattch:excludeAddattch,delOfferSub:_delOfferSub,excludeAddServ:excludeAddServ,checkTerminalCodeSub:_checkTerminalCodeSub,addOffer:_addOffer,addOfferSpec:_addOfferSpec,addOpenList:_addOpenList,addOpenServList:_addOpenServList,addOfferSpecByCheck:_addOfferSpecByCheck,closeAttachSearch:_closeAttachSearch,changeLabel:_changeLabel,changeLabel1:_changeLabel1,changeList:_changeList,closeServ:_closeServ,closeServSpec:_closeServSpec,delOffer:_delOffer,delOfferSpec:_delOfferSpec,labelList:_labelList,isChangeUim:_isChangeUim,init:_init,openList:_openList,openedList:_openedList,openServList:_openServList,openedServList:_openedServList,openServSpec:_openServSpec,openAppList:_openAppList,queryAttachOffer:_queryAttachOffer,queryAttachOfferSpec:_queryAttachOfferSpec,showParam:_showParam,showServParam:_showServParam,showTime:_showTime,setAttachTime:_setAttachTime,searchAttachOfferSpec:_searchAttachOfferSpec,selectAttachOffer:_selectAttachOffer,showOfferTime:_showOfferTime,showMainParam:_showMainParam,showMainMember:_showMainMember,selectServ:_selectServ,showStartTime:_showStartTime,showEndTime:_showEndTime,setAttachBusiOrder:_setAttachBusiOrder,showApp:_showApp,showHideUim:_showHideUim,showMainRoleProd:_showMainRoleProd,checkTerminalCode:_checkTerminalCode,checkOfferExcludeDepend:_checkOfferExcludeDepend,checkServExcludeDepend:_checkServExcludeDepend,servExDepReByRoleObjs:_servExDepReByRoleObjs,setChangeList:_setChangeList,reductionChangList:_reductionChangList,filterServ:_filterServ,changeOfferS:_changeOfferS,changeOfferOrdered:_changeOfferOrdered,openServSpecReload:_openServSpecReload,closeServSpecReload:_closeServSpecReload,delOfferSpecReload:_delOfferSpecReload,showMainMemberRoleProd:_showMainMemberRoleProd,addSearchOfferSpec:_addSearchOfferSpec,dbClickAttachType:_dbClickAttachType,changereserveCode:_changereserveCode,delServSpec:_delServSpec}})();CommonUtils.regNamespace("offerChange");offerChange=(function(){var g={};var f=0;var d=false;var l=false;var h=function(){var w=order.prodModify.choosedProdInfo;
if(w.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=2;if(!query.offer.setOffer()){return}var x=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,instId:w.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:w.prodInstId},{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,instId:w.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:w.prodInstId}];if(!rule.rule.ruleCheck(x)){return}$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var v=$.callServiceAsHtmlGet(contextPath+"/pad/order/prodoffer/prepare",{});$.unecOverlay();if(v.code!=0){$.alert("提示","查询失败,稍后重试");return}SoOrder.step(0,v.data);order.prepare.initOffer();order.service.searchPack();$("#dlg_cust_prod").popup("close");$("#navbar").slideUp(500);$.jqmRefresh($("#order_tab_panel_content"))};var t=function(){var w=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==2){w++}});var z=1;var v=0;if(w>1){z=2}if(!q(z,v)){return}if(CONST.getAppDesc()==0){if(order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){if(!offerChange.checkOrder()){return}}if(!prod.uim.setProdUim()){return}}var x=order.prodModify.choosedProdInfo;var y={boActionTypeCd:"S2",boActionTypeName:"套餐变更",actionFlag:"2",offerSpec:OrderInfo.offerSpec,prodId:x.prodInstId,offerMembers:OrderInfo.offer.offerMemberInfos,oldOfferSpecName:x.prodOfferName,prodClass:x.prodClass,appDesc:CONST.getAppDesc()};order.main.buildMainView(y)};var m=function(v,A){SoOrder.initFillPage();$("#order_tab_panel_content").hide();$("#order_fill_content").show();$("#order_fill_content").html(v.data);$("#tabs-body .ordercona").eq(0).show();$("#fillNextStep").off("click").on("click",function(){SoOrder.submitOrder()});$("#fillLastStep").off("click").on("click",function(){order.main.lastStep()});var L=order.prodModify.choosedProdInfo;var I=false;$.each(OrderInfo.offerSpec.offerRoles,function(){var N=this;if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){var P="'"+this.prodInstId+"'";if(P.indexOf("-")==-1){var Z=this.prodInstId;var S={areaId:OrderInfo.getProdAreaId(Z),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:Z,prodSpecId:this.objId,offerSpecId:L.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var aa=this.accessNumber;var ag=query.offer.queryChangeAttachOffer(S);$("#attach_"+Z).html(ag);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){S.queryType="1,2";S.objId=this.objId;S.objType=this.objType;S.memberRoleCd=this.roleCd;S.offerSpecId=OrderInfo.offerSpec.offerSpecId;var af=query.offer.queryDefMustOfferSpec(S);CacheData.parseOffer(af,Z);S.queryType="1";var af=query.offer.queryServSpec(S);CacheData.parseServ(af,Z)}AttachOffer.showMainRoleProd(Z);if(AttachOffer.isChangeUim(Z)){if(OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""&&OrderInfo.mktResInstCode!="null"){var T=OrderInfo.mktResInstCode.split(",");if(T!=null&&T.length>0){var ac="";var W="";var U="0";for(var ad=0;ad<T.length;ad++){var Q=T[ad].split("_");if(Q!=null&&Q.length==2){var Y=Q[0];var X=Q[1];if(ac!=null&&ac!=""){if(ac==Y||W==X){U="1";break}}else{ac=Y;W=X}}}if(U=="1"){$.alert("提示","传入的UIM参数中存在重复数据,参数为["+OrderInfo.mktResInstCode+"]")}else{var O="";for(var ad=0;ad<T.length;ad++){var Q=T[ad].split("_");if(Q!=null&&Q.length==2){var ab=Q[0];var ae=Q[1];if(ab==aa){O=ae}}}if(O!=null&&O!=""&&O!="null"){e(O,Z);$("#uim_check_btn_"+Z).hide();$("#uim_release_btn_"+Z).hide()}}}}f++;$("#uimDiv_"+Z).show()}}else{var R=this;var S={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:R.objId,offerRoleId:R.offerRoleId,prodId:R.prodInstId,queryType:"1,2",objType:R.objType,objId:R.objId,memberRoleCd:R.memberRoleCd};AttachOffer.queryAttachOfferSpec(S);var V={ul_id:"item_order_"+R.prodInstId,prodId:R.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:R.objId,roleCd:N.roleCd,offerRoleId:N.offerRoleId,partyId:OrderInfo.cust.custId,actionFlag:OrderInfo.actionFlag};order.main.spec_member_parm(V)}})}});if(offerChange.oldMemberFlag){for(var J=0;J<OrderInfo.oldprodInstInfos.length;J++){var L=OrderInfo.oldprodInstInfos[J];$.each(OrderInfo.oldoffer,function(){if(this.accNbr==L.accNbr){var N=this;$.each(N.offerMemberInfos,function(){var S=this;if(S.objType==CONST.OBJ_TYPE.PROD){var Q=this.objInstId;var R={areaId:OrderInfo.getProdAreaId(Q),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:Q,prodSpecId:S.objId,offerSpecId:L.mainProdOfferInstInfos[0].prodOfferId,offerRoleId:"",acctNbr:S.accessNumber,partyId:L.custId,distributorId:OrderInfo.staff.distributorId,mainOfferSpecId:L.mainProdOfferInstInfos[0].prodOfferId,soNbr:OrderInfo.order.soNbr};if(ec.util.isObj(L.prodBigClass)){R.prodBigClass=L.prodBigClass}$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==L.accNbr){$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){R.offerRoleId=this.offerRoleId}})}});var O=query.offer.queryChangeAttachOffer(R);$("#attach_"+Q).html(O);if(ec.util.isObj(S.objId)&&ec.util.isObj(S.objType)&&ec.util.isObj(S.offerRoleId)){R.queryType="1,2";R.objId=S.objId;R.objType=S.objType;R.memberRoleCd="401";var P=query.offer.queryDefMustOfferSpec(R);CacheData.parseOffer(P,Q);var P=query.offer.queryServSpec(R);CacheData.parseServ(P,Q)}if(ec.util.isArray(OrderInfo.oldofferSpec)){$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==L.accNbr){var T=this.offerSpec.offerRoles;$.each(T,function(){if(this.offerRoleId==S.offerRoleId&&S.objType==CONST.OBJ_TYPE.PROD){var U=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var W=CacheData.getServBySpecId(Q,this.objId);if(W!=undefined){var V=$("#li_"+Q+"_"+W.servId)}}});return false}})}})}}})}});var G={};if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){if(this.accNbr==L.accNbr){G=this}})}if(order.prodModify.choosedProdInfo.is3G=="N"&&L.mainProdOfferInstInfos[0].is3G=="Y"){if(!order.memberChange.checkOrder(L,G)){return}order.memberChange.checkOfferProd(G)}}}if(offerChange.newMemberFlag==true||offerChange.oldMemberFlag==true){order.main.initAcct(0);order.main.initAcct(1)}order.dealer.initDealer();if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){offerChange.checkOfferProd()}if(order.memberChange.newSubPhoneNum!=""&&OrderInfo.provinceInfo.reloadFlag=="Y"){var K=order.memberChange.newSubPhoneNum.split(",");for(var F=0;F<K.length;F++){if(K[F]!=""&&K[F]!=null&&K[F]!="null"){var A={phoneNum:K[F]};var M=order.phoneNumber.queryPhoneNumber(A);if(M.datamap.baseInfo){$("#nbr_btn_-"+(F+1)).val(K[F]);var H={prodId:"-"+(F+1),accessNumber:M.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:M.datamap.baseInfo.phoneNumId,pnLevelId:M.datamap.baseInfo.phoneLevelId,anTypeCd:M.datamap.baseInfo.pnTypeId,state:"ADD",areaId:M.datamap.baseInfo.areaId,areaCode:M.datamap.baseInfo.zoneNumber,memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,preStore:M.datamap.baseInfo.prePrice,minCharge:M.datamap.baseInfo.pnPrice};OrderInfo.boProdAns.push(H);order.dealer.changeAccNbr("-"+(F+1),K[F])}}}}if(OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""&&OrderInfo.mktResInstCode!="null"&&OrderInfo.provinceInfo.reloadFlag=="Y"){var w="-1";var B=OrderInfo.mktResInstCode.split(",");for(var D=0;D<B.length;D++){if(B[D]!=""&&B[D]!=null&&B[D]!="null"){var E=B[D].split("_");var y=E[0];var z=E[1];var K=order.memberChange.newSubPhoneNum.split(",");for(var F=0;F<K.length;F++){if(K[F]==y){var x={instCode:z};var v=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",x);if(v.code==0){if(v.data.mktResBaseInfo){if(v.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_-"+(F+1)).attr("disabled",true);$("#uim_release_btn_-"+(F+1)).attr("disabled",false);$("#uim_release_btn_-"+(F+1)).removeClass("disabled");$("#uim_txt_-"+(F+1)).attr("disabled",true);
$("#uim_txt_-"+(F+1)).val(z);var C={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:v.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:v.data.mktResBaseInfo.qty,storeId:v.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:z,terminalCode:z,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-(F+1),offerId:w,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(-(F+1));OrderInfo.boProd2Tds.push(C)}else{$.alert("提示","UIM卡不是预占状态，当前为"+v.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(v.code==-2){$.alertM(v.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}}}};function e(y,z){var x={instCode:y};var w=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",x);if(w.code==0){if(w.data.mktResBaseInfo){if(w.data.mktResBaseInfo.statusCd=="1102"){$("#uim_txt_"+z).val(y);var v={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:w.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:w.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:y,ruleId:"",partyId:OrderInfo.cust.custId,prodId:z,offerId:-1,attachSepcId:OrderInfo.offerSpec.offerSpecId,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(z);OrderInfo.boProd2Tds.push(v)}else{$.alert("提示","UIM卡["+y+"]不是预占状态，当前为"+w.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM卡["+y+"]信息")}}else{if(w.code==-2){$.alertM(w.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}var o=function(v){n(v,OrderInfo.offer);p(v,OrderInfo.offer);AttachOffer.setAttachBusiOrder(v);if(CONST.getAppDesc()==0){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(OrderInfo.boProd2Tds.length>0){var w={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var x=OrderInfo.getProdBusiOrder(w);if(x){v.push(x)}}}})}}};var n=function(v,x){x.offerTypeCd=1;x.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;var w=order.prodModify.choosedProdInfo;OrderInfo.getOfferBusiOrder(v,x,w.prodInstId)};var p=function(E,x){var I=u();var C=order.prodModify.choosedProdInfo;var w=OrderInfo.offerSpec;var D={areaId:OrderInfo.getProdAreaId(C.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.SEQ.offerSeq--,objId:w.offerSpecId,offerTypeCd:"1",accessNumber:C.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};$.each(w.offerRoles,function(){var O=this;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){var P='"'+this.prodInstId+'"';if(P.indexOf("-")==-1){var Q={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,offerRoleId:O.offerRoleId,state:"ADD"};D.data.ooRoles.push(Q)}})}});if(offerChange.oldMemberFlag){var K="";for(var L=0;L<OrderInfo.offerSpec.offerRoles.length;L++){var I=OrderInfo.offerSpec.offerRoles[L];if(I.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){K=I.offerRoleId;break}}for(var G=0;G<OrderInfo.oldprodInstInfos.length;G++){var F=OrderInfo.oldprodInstInfos[G];var y={areaId:F.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:F.mainProdOfferInstInfos[0].prodOfferId,instId:F.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:F.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var N=-1;for(var L=0;L<OrderInfo.oldoffer.length;L++){if(OrderInfo.oldoffer[L].accNbr==F.accNbr){$.each(OrderInfo.oldoffer[L].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var O={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:N,offerRoleId:K,state:"ADD"};D.data.ooRoles.push(O);var P={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};y.data.ooRoles.push(P);--N}})}}E.push(y)}if(CONST.getAppDesc()==0){for(var L=0;L<OrderInfo.oldoffer.length;L++){$.each(OrderInfo.oldoffer[L].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var O={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var P=OrderInfo.getProdBusiOrder(O);if(P){E.push(P)}}}})}}}if(offerChange.newMemberFlag){for(var L=0;L<OrderInfo.offerSpec.offerRoles.length;L++){var I=OrderInfo.offerSpec.offerRoles[L];if(I.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(I.prodInsts!=undefined&&I.prodInsts.length>0){for(var J=0;J<I.prodInsts.length;J++){var z=I.prodInsts[J];var H='"'+z.prodInstId+'"';if(z.memberRoleCd=="401"&&H.indexOf("-")!=-1){var B={objId:z.objId,objInstId:z.prodInstId,objType:z.objType,offerMemberId:OrderInfo.SEQ.offerMemberSeq--,offerRoleId:z.offerRoleId,state:"ADD"};D.data.ooRoles.push(B);E.push(SoOrder.createProd(z.prodInstId,z.objId))}}}}}}if(ec.util.isArray(w.offerSpecParams)){D.data.ooParams=[];for(var L=0;L<w.offerSpecParams.length;L++){var A=w.offerSpecParams[L];var v={itemSpecId:A.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:A.offerSpecParamId,value:A.value,state:"ADD"};D.data.ooParams.push(v)}}if(w.ooTimes!=undefined){D.data.ooTimes=[];D.data.ooTimes.push(w.ooTimes)}D.data.busiOrderAttrs=[];var M=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(M!=undefined){M.each(function(){var O={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()};D.data.busiOrderAttrs.push(O);var P={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};D.data.busiOrderAttrs.push(P)})}E.push(D)};var u=function(){for(var x=0;x<OrderInfo.offerSpec.offerRoles.length;x++){var y=OrderInfo.offerSpec.offerRoles[x];if(y.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return y}}for(var x=0;x<OrderInfo.offerSpec.offerRoles.length;x++){var y=OrderInfo.offerSpec.offerRoles[x];for(var w=0;w<y.roleObjs.length;w++){var v=y.roleObjs[w];if(v.objType==CONST.OBJ_TYPE.PROD){return y}}}};var c=function(v){};var k=function(w){if(OrderInfo.actionFlag==3){j()}else{r()}var v=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(v==undefined){return false}if(v.resultCode==0&&ec.util.isObj(v.result)){offerChange.resultOffer=v.result}else{$.alert("预校验规则限制",v.resultMsg);offerChange.resultOffer={};return false}return true};var j=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;var z=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;for(var y=0;y<AttachOffer.openList.length;y++){var x=AttachOffer.openList[y];for(var w=0;w<x.specList.length;w++){var v=x.specList[w];if(v.isdel!="Y"&&v.isdel!="C"&&v.ifPackage4G=="Y"){v.offerTypeCd=2;v.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;v.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(z,v,x.prodId)}}}$.each(z,function(){this.busiObj.state="ADD"})};var q=function(v,E){if(v==1){var D=u();if(D==undefined){alert("错误提示","无法变更到该套餐");return false}D.prodInsts=[];var C=false;$.each(D.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var F=this;C=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(F.objId!=this.objId){$.alert("规则限制","新套餐【"+F.offerRoleName+"】角色的规格ID【"+F.objId+"】和旧套餐【"+this.roleName+"】角色的规格ID【"+this.objId+"】不一样");
C=true;return false}F.prodInstId=this.objInstId;F.accessNumber=this.accessNumber;D.prodInsts.push(F)}});if(C){return false}}});if(C){return false}}else{for(var z=0;z<OrderInfo.offer.offerMemberInfos.length;z++){var x=OrderInfo.offer.offerMemberInfos[z];if(x.objType==CONST.OBJ_TYPE.PROD){var C=true;for(var y=0;y<OrderInfo.offerSpec.offerRoles.length;y++){var D=OrderInfo.offerSpec.offerRoles[y];if(x.roleCd==D.memberRoleCd){for(var w=0;w<D.roleObjs.length;w++){var B=D.roleObjs[w];if(B.objType==CONST.OBJ_TYPE.PROD){if(B.objId!=x.objId){$.alert("规则限制","新套餐【"+B.offerRoleName+"】角色的规格ID【"+B.objId+"】和旧套餐【"+x.roleName+"】角色的规格ID【"+x.objId+"】不一样");return false}if(!ec.util.isArray(D.prodInsts)){D.prodInsts=[]}var A=jQuery.extend(true,{},B);A.prodInstId=x.objInstId;A.accessNumber=x.accessNumber;D.prodInsts.push(A);if(D.prodInsts.length>B.maxQty){$.alert("规则限制","新套餐【"+D.offerRoleName+"】角色最多可以办理数量为"+B.maxQty+",而旧套餐数量大于"+B.maxQty);return false}break}}C=false;break}}if(C){$.alert("规则限制","旧套餐【"+x.roleName+"】角色在新套餐中不存在，无法变更");return false}}}}return true};var u=function(){for(var x=0;x<OrderInfo.offerSpec.offerRoles.length;x++){var y=OrderInfo.offerSpec.offerRoles[x];if(y.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return y}}for(var x=0;x<OrderInfo.offerSpec.offerRoles.length;x++){var y=OrderInfo.offerSpec.offerRoles[x];for(var w=0;w<y.roleObjs.length;w++){var v=y.roleObjs[w];if(v.objType==CONST.OBJ_TYPE.PROD){return y}}}};var r=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.cust.areaId;var v=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;n(v,OrderInfo.offer);p(v,OrderInfo.offer)};var a=function(){if(offerChange.resultOffer==undefined){return}var v=offerChange.resultOffer.prodInfos;if(ec.util.isArray(v)){$.each(v,function(){var A=this.accProdInstId;var z=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==A){z=false;return false}});if(z){return true}if(A!=this.prodInstId){var B=CacheData.getServ(A,this.prodInstId);if(this.state=="DEL"){if(B!=undefined){var y=$("#li_"+A+"_"+this.prodInstId).find("span");y.addClass("del");B.isdel="Y";$("#del_"+A+"_"+this.prodInstId).hide()}}else{if(this.state=="ADD"){if(B!=undefined){$("#del_"+A+"_"+this.prodInstId).hide()}else{var x=CacheData.getServSpec(A,this.productId);if(x!=undefined){$("#del_"+A+"_"+this.productId).hide()}else{if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(A,this.productId)}}}}}}})}var w=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(w)){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){var x=this.objInstId;$.each(w,function(){if(this.memberInfo==undefined){return true}var A=CacheData.getOffer(x,this.prodOfferInstId);var z=true;$.each(this.memberInfo,function(){if(x==this.accProdInstId){if(ec.util.isObj(A)){this.prodId=this.accProdInstId}z=false;return false}});if(z){return true}if(this.state=="DEL"){if(A!=undefined){var y=$("#li_"+x+"_"+this.prodOfferInstId).find("span");y.addClass("del");A.isdel="Y";$("#del_"+x+"_"+this.prodOfferInstId).hide()}}else{if(this.state=="ADD"){if(A!=undefined){$("#del_"+x+"_"+this.prodOfferInstId).hide()}else{var B=CacheData.getOfferSpec(x,this.prodOfferId);if(B!=undefined){$("#del_"+x+"_"+this.prodOfferId).hide()}else{if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(x,this.prodOfferId)}}}}}})})}}};var b=function(y){var x="";if(offerChange.resultOffer==undefined){return x}var v=offerChange.resultOffer.prodInfos;if(ec.util.isArray(v)){var z="";$.each(v,function(){if(y!=this.accProdInstId){return true}if(y!=this.prodInstId){var B=CacheData.getServ(y,this.prodInstId);var A=CacheData.getServSpec(y,this.productId);if(this.state=="DEL"){if(B!=undefined){z+='<li id="li_'+y+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+y+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+B.servSpecName+"</span></li>"}else{if(A!=undefined){z+='<li id="li_'+y+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+y+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+A.servSpecName+"</span></li>"}else{if(this.productName!=undefined&&this.productName!=""){z+='<li id="li_'+y+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+y+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+this.productName+"</span></li>"}}}}else{if(this.state=="ADD"){if(B!=undefined){z+='<li id="li_'+y+"_"+this.prodInstId+'"><dd id="del_'+y+"_"+this.prodInstId+'" class="delete"></dd><span>'+B.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(A!=undefined){z+='<li id="li_'+y+"_"+this.prodInstId+'"><dd id="del_'+y+"_"+this.prodInstId+'" class="delete"></dd><span>'+A.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(this.productName!=undefined&&this.productName!=""){z+='<li id="li_'+y+"_"+this.prodInstId+'"><dd id="del_'+y+"_"+this.prodInstId+'" class="delete"></dd><span>'+this.productName+'</span><dd class="mustchoose"></dd></li>'}}}}}}});if(z==""){x=""}else{x="<div class='fs_choosed'>订购4G流量包，需订购和取消如下功能产品：<br><ul>"+z+"</ul></div><br>"}}var w=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(w)){var z="";$.each(w,function(){if(this.memberInfo==undefined){return true}var A=true;$.each(this.memberInfo,function(){if(ec.util.isObj(this.accProdInstId)&&y==this.accProdInstId){A=false;return false}});if(A){return true}var B=CacheData.getOffer(y,this.prodOfferInstId);var C=CacheData.getOfferSpec(y,this.prodOfferId);if(this.state=="DEL"){if(B!=undefined){z+='<li id="li_'+y+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+y+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+B.offerSpecName+"</span></li>"}else{if(C!=undefined){z+='<li id="li_'+y+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+y+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+C.offerSpecName+"</span></li>"}else{if(this.prodOfferName!=undefined&&this.prodOfferName!=""){z+='<li id="li_'+y+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+y+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+this.prodOfferName+"</span></li>"}}}}else{if(this.state=="ADD"){if(B!=undefined){z+='<li id="li_'+y+"_"+this.prodOfferInstId+'"><dd id="del_'+y+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+B.offerSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(C!=undefined){z+='<li id="li_'+y+"_"+this.prodOfferInstId+'"><dd id="del_'+y+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+C.offerSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(this.prodOfferName!=undefined&&this.prodOfferName!=""){z+='<li id="li_'+y+"_"+this.prodOfferInstId+'"><dd id="del_'+y+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+this.prodOfferName+'</span><dd class="mustchoose"></dd></li>'}}}}}});if(z!=""){x+="<div class='fs_choosed'>订购4G流量包，需开通和关闭如下可选包：<br><ul>"+z+"</ul></div>"}}return x};var i=function(){$(".many li").bind("click",function(){var v=$(this).index();var w=$("#tabs-body .ordercona");$(this).parent().children("li").attr("class","tab-nav");$(this).attr("class","tab-nav-action");w.hide();w.eq(v).show()})};var s=function(){if($("#orderProvAttrIsale")){$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale)}var w=contextPath+"/order/provOrderAttrFlag";$.ecOverlay("<strong>正在查询是否显示省内订单属性,请稍后....</strong>");var v=$.callServiceAsJsonGet(w,{});$.unecOverlay();if(v.code==0){if(v.data!=undefined){if("0"==v.data){$("#orderProvAttrDiv").show();if(order.memberChange.reloadFlag=="N"){var x=order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;
$.each(x,function(){if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.PROV_ISALE){$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale)}})}}}}};return{initOfferLabel:i,init:h,changeOffer:o,offerChangeView:t,changeTab:c,checkOrder:k,checkAttachOffer:b,fillOfferChange:m,resultOffer:g,checkOfferProd:a,getChangeInfo:r,setChangeOfferSpec:q,initOrderProvAttr:s,newMemberFlag:d,oldMemberFlag:l}})();CommonUtils.regNamespace("SoOrder");SoOrder=(function(){var R=function(){if(query.offer.loadInst()){SoOrder.initFillPage();return true}else{return false}};var u="";var l=function(){SoOrder.initOrderData();SoOrder.step(1);OrderInfo.order.step=1;G()};var F=function(){OrderInfo.resetSeq();OrderInfo.resetData();OrderInfo.orderResult={};OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.getAreaId()};var s=function(){var Y=contextPath+"/token/pc/order/getCheckOperatSpec";var X=$.callServiceAsJson(Y,{});OrderInfo.zcd_privilege=X.data};var w=function(Y){s();if(L(Y)){var X=contextPath+"/token/pad/order/orderSubmit";if(OrderInfo.order.token!=""){X=contextPath+"/token/pad/order/orderSubmit?token="+OrderInfo.order.token}$.callServiceAsJson(X,JSON.stringify(OrderInfo.orderData),{before:function(){$.ecOverlay("<strong>订单提交中，请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(ac){G();if(ac.code==0){var ae=ac.data;var Z=ae.result.ruleInfos;if(Z!=undefined&&Z.length>0){var ab="";$.each(ae.result.ruleInfos,function(){ab+=this.ruleDesc+"<br/>"});$.alert("提示",ab);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq()}else{if(ae.checkRule!=undefined){var aa=order.calcharge.tochargeSubmit(ac.data);if(aa.code==0){var ad=I(ac.data);B(ad)}else{ac.data.provCheckError="Y";if(aa.data.resultMsg!=undefined&&$.trim(aa.data.resultMsg)!=""){ac.data.provCheckErrorMsg=aa.data.resultMsg}else{if(aa.data.errMsg!=undefined&&$.trim(aa.data.errMsg)!=""){ac.data.provCheckErrorMsg=aa.data.errMsg;if(aa.data.errCode){ac.data.provCheckErrorMsg="【错误编码："+aa.data.errCode+"】"+ac.data.provCheckErrorMsg}if(aa.data.errData){ac.data.provCheckErrorData=aa.data.errData;ac.data.provCheckErrorMsg+=","+ac.data.provCheckErrorData}if(aa.data.paramMap){ac.data.provCheckErrorMsg+="【入参："+aa.data.paramMap+"】"}}else{ac.data.provCheckErrorMsg="未返回错误信息，可能是下省请求超时，请返回填单页面并稍后重试订单提交。"}}var ad=I(ac.data);B(ad)}}else{var ad=I(ac.data);B(ad)}}}else{$.alertM(ac.data);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq()}}})}};var I=function(Z){var Y=contextPath+"/token/pad/order/gotosubmitOrder";$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var X=$.callServiceAsHtml(Y,JSON.stringify(Z));$.unecOverlay();return X.data};var L=function(ab){if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){if(OrderInfo.actionFlag==18&&ab.boActionType.actionClassCd==CONST.ACTION_CLASS_CD.OFFER_ACTION){}else{query.offer.loadInst()}a(ab);if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){OrderInfo.orderData.orderList.orderListInfo.soNbr=OrderInfo.order.soNbr}return true}var aj=[];var ak=[];var Y="N";if(q()){Y="Y"}ak.push({itemSpecId:CONST.BUSI_ORDER_ATTR.THRETOFOUR_ITEM,value:Y});ak.push({itemSpecId:"111111113",value:OrderInfo.orderlonger});ak.push({itemSpecId:"30010024",value:OrderInfo.busitypeflag});ak.push({itemSpecId:"30010050",value:OrderInfo.custorderlonger});if(OrderInfo.zcd_privilege=="0"){ak.push({itemSpecId:CONST.BUSI_ORDER_ATTR.ZCD_ITEM,value:0})}if(ec.util.isObj(OrderInfo.order.soNbr)){ak.push({itemSpecId:CONST.BUSI_ORDER_ATTR.SO_NBR,value:OrderInfo.order.soNbr})}order.cust.provIsale=$.trim($("#orderProvAttrIsale").val());if(ec.util.isObj(order.cust.provIsale)){order.cust.fromProvFlag="1";ak.push({itemSpecId:CONST.BUSI_ORDER_ATTR.PROV_ISALE,value:order.cust.provIsale})}else{order.cust.fromProvFlag="0"}if(!P()){return false}var af=$("#order_remark").val();if(ec.util.isObj(af)){ak.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:af})}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){A(aj)}else{if(OrderInfo.actionFlag==2){offerChange.changeOffer(aj)}else{if(OrderInfo.actionFlag==3){M(aj);if(aj.length==0){$.alert("提示","没有做任何业务，无法提交");return false}}else{if(OrderInfo.actionFlag==4){V(aj,ab)}else{if(OrderInfo.actionFlag==5){m(aj,ab)}else{if(OrderInfo.actionFlag==6){x(aj)}else{if(OrderInfo.actionFlag==7){J(aj,ab)}else{if(OrderInfo.actionFlag==8){i(aj,ab)}else{if(OrderInfo.actionFlag==9){v(aj,ab)}else{if(OrderInfo.actionFlag==10){aj=ab}else{if(OrderInfo.actionFlag==11){aj=ab}else{if(OrderInfo.actionFlag==12){aj=ab}else{if(OrderInfo.actionFlag==16){f(aj)}else{if(OrderInfo.actionFlag==19){g(aj,ab,"N")}else{if(OrderInfo.actionFlag==20){J(aj,ab)}else{if(OrderInfo.actionFlag==21){U(aj,ab)}else{if(OrderInfo.actionFlag==22){aj=ab}else{if(OrderInfo.actionFlag==23){aj=ab;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.staff.areaId;var ad=$("#custInfos").attr("corCustId");if(ec.util.isObj(ad)){var ai={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_CUST_ID,value:ad};ak.push(ai)}var an=$("#custInfos").attr("extCustId");if(ec.util.isObj(an)){var ah={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_CUST_ID,value:an};ak.push(ah)}var Z=order.prodModify.choosedProdInfo.extProdInstId;if(ec.util.isObj(Z)){var ag={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_PROD_INST_ID,value:Z};ak.push(ag)}var am=order.prodModify.choosedProdInfo.corProdInstId;if(ec.util.isObj(am)){var ae={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_PROD_INST_ID,value:am};ak.push(ae)}var X=order.prodModify.choosedProdInfo.extCouponInstanceId;if(ec.util.isObj(X)){var ac={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_COUPON_INST_ID,value:X};ak.push(ac)}var al=order.prodModify.choosedProdInfo.corCouponInstanceId;if(ec.util.isObj(al)){var aa={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_COUPON_INST_ID,value:al};ak.push(aa)}}else{g(aj,ab,"N")}}}}}}}}}}}}}}}}}}OrderInfo.orderData.orderList.orderListInfo.custOrderAttrs=ak;OrderInfo.orderData.orderList.orderListInfo.extCustOrderId=OrderInfo.provinceInfo.provIsale;OrderInfo.orderData.orderList.custOrderList[0].busiOrder=aj;OrderInfo.orderData.orderList.orderListInfo.extCustOrderId=OrderInfo.provinceInfo.provIsale;if($("#isTemplateOrder").attr("checked")=="checked"){OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="Y";OrderInfo.orderData.orderList.orderListInfo.templateOrderName=$("#templateOrderName").val();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){OrderInfo.orderData.orderList.orderListInfo.templateType=$("#templateOrderDiv").find("select").val()}else{if(OrderInfo.actionFlag==2){OrderInfo.orderData.orderList.orderListInfo.templateType=5}else{if(OrderInfo.actionFlag==3){OrderInfo.orderData.orderList.orderListInfo.templateType=2}}}}else{OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="N"}if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){OrderInfo.orderData.orderList.orderListInfo.soNbr=OrderInfo.order.soNbr}return true};var a=function(Z){var aa=Z.coupons;OrderInfo.getOrderData();var X=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;if(OrderInfo.cust.custId==-1){OrderInfo.createCust(X)}else{if(OrderInfo.cust.custId!=undefined&&OrderInfo.cust.custId!=""){OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId}else{OrderInfo.orderData.orderList.orderListInfo.partyId=CONST.CUST_COUPON_SALE}}if(OrderInfo.actionFlag==18){OrderInfo.orderData.orderList.orderListInfo.partyId=aa[0].partyId}var Y={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:Z.busiObj,boActionType:Z.boActionType,data:{bo2Coupons:[]}};Y.data.bo2Coupons=aa;if(Z.dealers){Y.data.busiOrderAttrs=Z.dealers}X.push(Y)};var B=function(ae){SoOrder.step(2,ae);SoOrder.delOrderBegin();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">套餐名称：</div><div class="ui-block-b">'+OrderInfo.offerSpec.offerSpecName+"</div></div>");var ah=$("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName);
$("#tital").append(ah);$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+this.offerRoleName+'号码：</div><div class="ui-block-b">'+OrderInfo.getProdAn(this.prodInstId).accessNumber+"</div></div>")})});if(offerChange.oldMemberFlag){for(var ad=0;ad<OrderInfo.oldoffer.length;ad++){for(var af=0;af<OrderInfo.oldoffer[ad].offerMemberInfos.length;af++){var ac=OrderInfo.oldoffer[ad].offerMemberInfos[af];if(ac.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">纳入副卡号码：</div><div class="ui-block-b">'+ac.accessNumber+"</div></div> ")}}}}}else{if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#order_prepare").hide();$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端名称：</div><div class="ui-block-b">'+OrderInfo.businessName+"</div></div>");var X=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;var Z=undefined;if(OrderInfo.actionFlag==13){for(var af=0;af<X.length;af++){var ai=X[af].boActionType;if(ai.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&ai.boActionTypeCd==CONST.BO_ACTION_TYPE.COUPON_SALE){Z=X[af].data.bo2Coupons}}$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端串码：</div><div class="ui-block-b">'+Z[0].couponInstanceNumber+"</div></div>")}else{if(OrderInfo.actionFlag==17){for(var af=0;af<X.length;af++){var ai=X[af].boActionType;if(ai.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&ai.boActionTypeCd==CONST.BO_ACTION_TYPE.RETURN_COUPON){Z=X[af].data.bo2Coupons}}$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端串码：</div><div class="ui-block-b">'+Z[0].couponInstanceNumber+"</div></div>")}else{if(OrderInfo.actionFlag==18){for(var af=0;af<X.length;af++){var ai=X[af].boActionType;if(ai.boActionTypeCd==CONST.BO_ACTION_TYPE.EXCHANGE_COUPON){Z=X[af].data.bo2Coupons}}var Y=null;var aa=null;if(Z[0].state=="DEL"){Y=Z[0];aa=Z[1]}else{Y=Z[1];aa=Z[0]}$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">旧终端串码：</div><div class="ui-block-b">'+Y.couponInstanceNumber+"</div></div>");$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新终端串码：</div><div class="ui-block-b">'+aa.couponInstanceNumber+"</div></div>")}}}var ah=$("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName);$("#tital").append(ah)}else{var ag=order.prodModify.choosedProdInfo;$("#order_tab_panel_content").hide();$("#orderTbody").append('<div class="ui-grid-a" id="offerSpecName"><div class="ui-block-a">套餐名称：</div><div class="ui-block-b">'+ag.prodOfferName+"</div></div>");$("#orderTbody").append('<div class="ui-grid-a" id="accNbrTr"><div class="ui-block-a">手机号码：</div><div class="ui-block-b">'+ag.accNbr+"</div></div>");if(OrderInfo.actionFlag==2){if(OrderInfo.provinceInfo.reloadFlag=="N"){$("#order_tab_panel_content").show()}else{if(OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""){$("#order_tab_panel_content").show()}else{$("#order_tab_panel_content").hide()}}OrderInfo.actionTypeName="套餐变更";$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新套餐名称：</div><div class="ui-block-b">'+OrderInfo.offerSpec.offerSpecName+"</div></div>");$("#accNbrTr").hide();for(var af=0;af<OrderInfo.offer.offerMemberInfos.length;af++){var ac=OrderInfo.offer.offerMemberInfos[af];if(ac.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+ac.roleName+'号码：</div><div class="ui-block-b">'+ac.accessNumber+"</div></div>")}}if(offerChange.newMemberFlag){$.each(OrderInfo.boProdAns,function(){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">加装移动电话号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")})}if(offerChange.oldMemberFlag){for(var ad=0;ad<OrderInfo.oldoffer.length;ad++){for(var af=0;af<OrderInfo.oldoffer[ad].offerMemberInfos.length;af++){var ac=OrderInfo.oldoffer[ad].offerMemberInfos[af];if(ac.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">纳入副卡号码：</div><div class="ui-block-b">'+ac.accessNumber+"</div></div> ")}}}}}else{if(OrderInfo.actionFlag==3){OrderInfo.actionTypeName="订购/退订可选包与功能产品"}else{if(OrderInfo.actionFlag==4||OrderInfo.actionFlag==8){$("#offerSpecName").hide();$("#accNbrTr").hide()}else{if(OrderInfo.actionFlag==5){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.isRemove=="Y"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除副卡号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}else{$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==6){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}});$.each(OrderInfo.boProdAns,function(){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">纳入副卡号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div> ")});if(ec.util.isArray(OrderInfo.oldAddNumList)){for(var af=0;af<OrderInfo.oldAddNumList.length;af++){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">纳入副卡号码：</div><div class="ui-block-b">'+OrderInfo.oldAddNumList[af].accNbr+"</div></div> ")}}OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==7){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div> ")}else{var ak="";var al=this.accessNumber;$.each(u,function(am,an){if(an.accessNumber==al&&an.del=="N"){ak="N"}});if(ak=="N"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}else{$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div> ")}}}});OrderInfo.actionTypeName=CONST.getBoActionTypeName(OrderInfo.boActionTypeCd)}else{if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新套餐名称：</div><div class="ui-block-b">'+this.offerSpecName+"</div></div> ")})}$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var al="";var ak="";var am=this.objInstId;$.each(u,function(an,ao){if(ao.objInstId==am&&ao.knew=="Y"){al="Y"}if(ao.objInstId==am&&ao.del=="Y"){ak="Y"}});if(al=="Y"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}else{if(ak=="Y"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}}}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==20){$("#accNbrTr").hide();for(var af=0;af<OrderInfo.offer.offerMemberInfos.length;af++){var ac=OrderInfo.offer.offerMemberInfos[af];if(ac.objType==CONST.OBJ_TYPE.PROD){if(ac.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+ac.roleName+'号码：</div><div class="ui-block-b">'+ac.accessNumber+"</div></div> ")}else{$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+ac.roleName+'号码：</div><div class="ui-block-b">'+ac.accessNumber+"</div></div>")
}}}OrderInfo.actionTypeName="返销"}else{if(OrderInfo.actionFlag==12){$("#accNbrTr").hide();for(var af=0;af<OrderInfo.confirmList.length;af++){var ag=OrderInfo.confirmList[af];for(var ad=0;ad<ag.accNbr.length;ad++){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+ag.name+'：</div><div class="ui-block-b">'+ag.accNbr[ad]+"</div></div>")}}}else{if(OrderInfo.actionFlag==16){OrderInfo.actionTypeName="改号";$.each(OrderInfo.boProdAns,function(){if(this.state=="ADD"){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")}})}else{if(OrderInfo.actionFlag==0&&OrderInfo.actionTypeName=="拆机"){$("#accNbrTr").hide();var aj="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&this.objInstId==order.prodModify.choosedProdInfo.prodInstId){aj="Y"}});if(aj=="Y"){$.each(OrderInfo.offer.offerMemberInfos,function(){$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+"</div></div>")})}OrderInfo.actionTypeName="拆机"}}}}}}}}}}}var ah=$("<span>"+OrderInfo.actionTypeName+"</span>");$("#tital").append(ah)}}var ab=true;if($("#ruleTbody tr").length>0){$("#ruleTbody tr").each(function(){var ak=$(this).attr("ruleLevel");if(ak=="1"){ab=false;return false}})}if(ab){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){N()}else{if(OrderInfo.actionFlag==2){W()}else{if(OrderInfo.actionFlag==3){d()}else{if(OrderInfo.actionFlag==6){n()}else{if(OrderInfo.actionFlag==21&&order.memberChange.getSimulateData()){T()}else{if(OrderInfo.orderResult.autoBoInfos!=undefined&&OrderInfo.orderResult.autoBoInfos.length>0){$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));$.each(OrderInfo.orderResult.autoBoInfos,function(){$("#chooseTable").append($('<tr><td width="50%">'+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))})}}}}}}}};var S=function(X,Z){for(var Y=1;Y<4;Y++){$("#step"+Y).hide()}$("#step"+X).show()};var D=function(X,Y){if(X==0){$("#orderedprod").hide();$("#order_prepare").hide();$("#order_fill_content").hide();$("#order_tab_panel_content").html(Y).show();X++}else{if(X==1){$("#order_prepare").hide();$("#order_confirm").hide();$("#order_fill").show()}else{if(X==2){if($("#a-cust-modify")[0]){$("#a-cust-modify").attr("style","display: none;")}$("#order_fill").hide();$("#order_fill_content").hide();$("#order_confirm").html(Y).show();$.jqmRefresh($("#order_confirm"))}}}};var N=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr>"));k(this.prodInstId)})});if(offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#chooseTable").append($('<tr><th width="50%">业务名称(已有移动电话)</th><th>业务动作</th></tr>'));k(this.objInstId)}})})}};var n=function(){if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.roleName+")</th><th>业务动作</th></tr>"));k(this.objInstId)}})})}else{$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr>"));$.each(this.prodInsts,function(){k(this.prodInstId)})}})}};var W=function(){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.roleName+")</th><th>业务动作</th></tr>"));k(this.objInstId)}});if(offerChange.oldMemberFlag){var X=0;$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd==401){var Y=this.prodInsts;if(Y!=undefined&&Y!=null){$.each(this.prodInsts,function(){var Z='"'+this.prodInstId+'"';if(Z.indexOf("-")!=-1){if(X==0){X="chooseTable_"+this.prodInstId}else{$("#"+X).after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));X="chooseTable_"+this.prodInstId}k(this.prodInstId)}})}}})}if(offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){k(this.objInstId)}})})}};var T=function(){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){$("#chooseTable").append($('<tr><th width="50%">业务名称(基础移动电话)</th><th>业务动作</th></tr>'));k(this.prodId)})}};var d=function(){var X=order.prodModify.choosedProdInfo;if(X==undefined||X.prodInstId==undefined){return true}$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));k(X.prodInstId)};var k=function(ac){var ab=CacheData.getOfferSpecList(ac);var Y=CacheData.getOfferList(ac);var X=CacheData.getServSpecList(ac);var aa=CacheData.getServList(ac);var Z=CacheData.getOpenAppList(ac);if(ab!=undefined&&ab.length>0){$.each(ab,function(){if(this.isdel!="Y"&&this.isdel!="C"){if(ec.util.isObj(this.counts)){for(var ad=0;ad<this.counts;ad++){$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_BUY+"</td></tr>"))}}else{$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_BUY+"</td></tr>"))}}})}if(Y!=undefined&&Y.length>0){$.each(Y,function(){if(this.isdel=="Y"){if(ec.util.isObj(this.counts)){for(var ae=0;ae<this.counts;ae++){$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_DEL+"</td></tr>"))}}else{$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_DEL+"</td></tr>"))}}else{if(this.update=="Y"){$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_UPDATE+"</td></tr>"))}else{if(ec.util.isObj(this.orderCount)&&ec.util.isObj(this.counts)){if(this.orderCount<this.counts){for(var ad=0;ad<(this.counts-this.orderCount);ad++){$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_BUY+"</td></tr>"))}}}}}})}if(X!=undefined&&X.length>0){$.each(X,function(){if(this.isdel!="Y"&&this.isdel!="C"){$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.servSpecName+'</td><td align="center">'+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(aa!=undefined&&aa.length>0){$.each(aa,function(){if(this.isdel=="Y"){$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.servSpecName+'</td><td align="center">'+CONST.EVENT.PROD_CLOSE+"</td></tr>"))}else{if(this.update=="Y"){$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.servSpecName+'</td><td align="center">'+CONST.EVENT.PROD_UPDATE+"</td></tr>"))}}})}if(Z!=undefined&&Z.length>0){$.each(Z,function(){if(this.dfQty==1){$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.servSpecName+'</td><td align="center">'+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(OrderInfo.orderResult.autoBoInfos!=undefined){$.each(OrderInfo.orderResult.autoBoInfos,function(){if(this.instAccessNumber==OrderInfo.getAccessNumber(ac)){$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.specName+'</td><td align="center">'+this.boActionTypeName+"</td></tr>"))}})}};var z=function(){if(CONST.getAppDesc()==0&&OrderInfo.actionFlag==3){var aa=order.prodModify.choosedProdInfo.prodClass;var Z=order.prodModify.choosedProdInfo.prodInstId;var Y=CacheData.getOfferSpecList(Z);var X=false;if(ec.util.isArray(Y)){$.each(Y,function(){if(this.ifPackage4G=="Y"&&this.isdel!="Y"&&this.isdel!="C"){X=true;return false}})}if(X&&aa==CONST.PROD_CLASS.THREE){AttachOffer.reductionChangList(Z)
}}SoOrder.delOrderFin();$("#order_tab_panel_content").show();if(OrderInfo.actionFlag==2){$("#order_tab_panel_content").hide();$("#order_fill_content").show();$("#order_prepare").show()}if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#order_fill_content").show();$("#order_prepare").show()}$("#order_confirm").hide();OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();SoOrder.delOrder();G();$("#order_fill").show();if(CONST.getAppDesc()!=0){if($("#a-cust-modify")[0]){$("#a-cust-modify").show()}}};var H=function(){var X=OrderInfo.orderResult.olId;if(X!=0&&X!=undefined){var Y={olId:X,areaId:OrderInfo.getAreaId()};$.callServiceAsJsonGet(contextPath+"/order/delOrder",Y,{done:function(Z){if(Z.code==0){if(Z.data.resultCode==0){$.alert("提示","购物车作废成功！")}}else{if(Z.code==-2){$.alertM(Z.data)}else{$.alert("提示","购物车作废失败！")}}},fail:function(Z){$.alert("提示","信息","请求可能发生异常，请稍后再试")}})}};var O=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,OrderInfo.orderResult.olId);$("a[href^='/']").off("mousedown").on("mousedown",function(){SoOrder.delOrderSilent();window.location.href=this.href});$(window).off("unload").on("unload",function(){SoOrder.delOrderSilent()})};var C=function(){var ab=$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID);$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);if(ab!=0&&ab!=undefined&&ab!=null){var ad={olId:ab,areaId:OrderInfo.getAreaId(),flag:"U"};var X=$.callServiceAsJsonGet(contextPath+"/order/delOrder",ad);var ac=[];for(var aa=0;aa<OrderInfo.boProdAns.length;aa++){var Z={accNbr:OrderInfo.boProdAns[aa].accessNumber,accNbrType:1,action:"UPDATE"};ac.push(Z)}if(ac.length>0){var Y=contextPath+"/common/updateResState";$.callServiceAsJsonGet(Y,{strParam:JSON.stringify(ac)},{done:function(ae){if(ae.code==0){if(ae.data){}}}})}OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();G();SoOrder.delOrderFin()}};var y=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);$("a[href^='/']").off("mousedown");$(window).off("unload")};var m=function(X,Z){var Y=order.prodModify.choosedProdInfo;var aa={offerSpecId:Y.prodOfferId,offerId:Y.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:Z};OrderInfo.getOfferBusiOrder(X,aa,Z[0].objInstId);$.each(Z,function(){var ab={prodId:this.objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};X.push(OrderInfo.getProdBusiOrder(ab));$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.objInstId==prodId){this.isRemove="Y";return false}})})};var U=function(ai,ac){var X="";var aj=ac.viceParam;u=aj;var af=ac.ooRoles;var ah=order.prodModify.choosedProdInfo;var Z={offerSpecId:ah.prodOfferId,offerId:ah.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:ac.ooRoles};$.each(OrderInfo.offer.offerMemberInfos,function(ak){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){X=this.objInstId;return false}});OrderInfo.getOfferBusiOrder(ai,Z,X);for(var ad=0;ad<aj.length;ad++){if(aj[ad].knew=="Y"){var Y=aj[ad];var ae={areaId:ah.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:Y.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};for(var ab=0;ab<OrderInfo.offer.offerMemberInfos.length;ab++){var aa=OrderInfo.offer.offerMemberInfos[ab];if(aa.objInstId==Y.objInstId){var af={objId:aa.objId,objInstId:aa.objInstId,objType:aa.objType,offerRoleId:Y.offerRoleId,state:"ADD"};ae.data.ooRoles.push(af);break}}ai.push(ae)}else{var ag={prodId:aj[ad].objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};ai.push(OrderInfo.getProdBusiOrder(ag))}}};var g=function(af,ab,Z){var ad=order.prodModify.choosedProdInfo;var ac=OrderInfo.boActionTypeCd;var Y=ad.productId;var aa=ad.prodInstId;var ae=OrderInfo.actionClassCd;if(ac==CONST.BO_ACTION_TYPE.ADDOREXIT_COMP){Y=ad.prodOfferId;aa=ad.prodOfferInstId;ae=CONST.ACTION_CLASS_CD.OFFER_ACTION}var X={areaId:OrderInfo.getProdAreaId(ad.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:Y,instId:aa,isComp:Z,accessNumber:ad.accNbr,offerTypeCd:"1"},boActionType:{actionClassCd:ae,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};X.data=ab;af.push(X)};var A=function(aa){if(OrderInfo.cust.custId==-1){OrderInfo.createCust(aa)}var Y=-1;if(OrderInfo.acct!=undefined&&OrderInfo.acct.acctId!=undefined&&OrderInfo.acct.acctId!=null&&OrderInfo.acct.acctId!=""){Y=OrderInfo.acct.acctId}if(Y<0&&Y!=undefined){OrderInfo.createAcct(aa,Y)}var ab=p(aa);for(var Z=0;Z<ab.data.ooRoles.length;Z++){var X=ab.data.ooRoles[Z];if(X.objType==2&&X.memberRoleCd!=undefined){aa.push(o(X.objInstId,X.objId))}}AttachOffer.setAttachBusiOrder(aa)};var G=function(){var X=$.callServiceAsHtmlGet(contextPath+"/common/getToken");OrderInfo.order.token=X.data};var c=function(){var X=$.callServiceAsHtmlGet(contextPath+"/common/getToken");OrderInfo.order.token=X.data};var x=function(ag){var aq=order.prodModify.choosedProdInfo;var af={areaId:aq.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aq.prodOfferId,instId:aq.prodOfferInstId,accessNumber:aq.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP},data:{ooRoles:[]}};if(order.memberChange.oldMemberFlag){var am="";for(var an=0;an<OrderInfo.offerSpec.offerRoles.length;an++){var ak=OrderInfo.offerSpec.offerRoles[an];if(ak.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){am=ak.offerRoleId;break}}for(var ai=0;ai<OrderInfo.oldprodInstInfos.length;ai++){var ah=OrderInfo.oldprodInstInfos[ai];var Y={areaId:ah.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ah.mainProdOfferInstInfos[0].prodOfferId,instId:ah.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:ah.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var ar=-1;for(var an=0;an<OrderInfo.oldoffer.length;an++){if(OrderInfo.oldoffer[an].accNbr==ah.accNbr){$.each(OrderInfo.oldoffer[an].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var at={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:ar,offerRoleId:am,state:"ADD"};af.data.ooRoles.push(at);var au={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};Y.data.ooRoles.push(au);--ar}})}}ag.push(Y)}if(CONST.getAppDesc()==0){for(var an=0;an<OrderInfo.oldoffer.length;an++){$.each(OrderInfo.oldoffer[an].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var at={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var au=OrderInfo.getProdBusiOrder(at);if(au){ag.push(au)}}}})}}}if(order.memberChange.newMemberFlag){for(var an=0;an<OrderInfo.offerSpec.offerRoles.length;an++){var ak=OrderInfo.offerSpec.offerRoles[an];if(ak.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(ak.prodInsts!=undefined&&ak.prodInsts.length>0){for(var al=0;al<ak.prodInsts.length;al++){var aa=ak.prodInsts[al];var ab={objId:aa.objId,objInstId:aa.prodInstId,objType:aa.objType,offerMemberId:OrderInfo.SEQ.offerMemberSeq--,offerRoleId:aa.offerRoleId,state:"ADD"};af.data.ooRoles.push(ab);ag.push(o(aa.prodInstId,aa.objId))}}}}}if(order.memberChange.changeMemberFlag){var ad=order.memberChange.viceparams;var Z=order.memberChange.ooRoless;var aq=order.prodModify.choosedProdInfo;$.each(Z,function(){af.data.ooRoles.push(this)});for(var an=0;
an<ad.length;an++){if(ad[an].knew=="Y"){var X=ad[an];var ae="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==X.objInstId){ae=this.accessNumber}});var ao={areaId:aq.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:X.offerSpecId,objName:X.offerSpecName,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};if(ec.util.isObj(ae)){ao.busiObj.accessNumber=ae}for(var al=0;al<OrderInfo.offer.offerMemberInfos.length;al++){var aj=OrderInfo.offer.offerMemberInfos[al];if(aj.objInstId==X.objInstId){var Z={objId:aj.objId,objInstId:aj.objInstId,objType:aj.objType,offerRoleId:X.offerRoleId,state:"ADD"};ao.data.ooRoles.push(Z);break}}var ap=$("li[name='tr_"+X.offerSpecId+"']");if(ap!=undefined){ao.data.busiOrderAttrs=[];ap.each(function(){var at={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+X.offerSpecId+"']").val()};ao.data.busiOrderAttrs.push(at);var au={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};ao.data.busiOrderAttrs.push(au)})}ag.push(ao)}else{var ac={prodId:ad[an].objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};ag.push(OrderInfo.getProdBusiOrder(ac))}}if(order.memberChange.getSimulateData()){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){var at=this.prodId;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(at==this.objInstId&&this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var au={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var av=OrderInfo.getProdBusiOrder(au);if(av){ag.push(av)}}}})}})}}}AttachOffer.setAttachBusiOrder(ag);ag.push(af)};var J=function(al,am){var an=am;var ae="";var Y=true;var ak=CONST.ACTION_CLASS_CD.OFFER_ACTION;var aj=CONST.BO_ACTION_TYPE.DEL_OFFER;var Z=CONST.ACTION_CLASS_CD.OFFER_ACTION;var ai=CONST.BO_ACTION_TYPE.BUY_OFFER;if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){ak=CONST.ACTION_CLASS_CD.PROD_ACTION;aj=CONST.BO_ACTION_TYPE.BUY_BACK;Z=CONST.ACTION_CLASS_CD.OFFER_ACTION;ai=CONST.BO_ACTION_TYPE.BUY_OFFER;v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.BUY_BACK;an=am.viceParam;ae=am.remark}else{if(OrderInfo.actionFlag==7){v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.REMOVE_PROD}}for(var ad=0;ad<an.length;ad++){var aa=an[ad];if(aa.del=="N"){Y=false}}if(Y){u=an;var X={areaId:OrderInfo.getProdAreaId(order.prodModify.choosedProdInfo.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,objId:order.prodModify.choosedProdInfo.productId,instId:order.prodModify.choosedProdInfo.prodInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:order.prodModify.choosedProdInfo.prodStateCd,state:"DEL"},{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};al.push(X);for(var ad=0;ad<an.length;ad++){var aa=an[ad];var X={areaId:OrderInfo.getProdAreaId(aa.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:aa.accessNumber,objId:aa.objId,instId:aa.objInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};al.push(X)}return}if(OrderInfo.actionFlag==7){u=an;var ah=order.prodModify.choosedProdInfo;var X={areaId:OrderInfo.getProdAreaId(ah.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ah.prodOfferId,instId:ah.prodOfferInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:ak,boActionTypeCd:aj},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"DEL"}]}};for(var ad=0;ad<OrderInfo.offer.offerMemberInfos.length;ad++){var ac=OrderInfo.offer.offerMemberInfos[ad];var ag={objId:ac.objId,objInstId:ac.objInstId,objType:ac.objType,offerMemberId:ac.offerMemberId,offerRoleId:ac.offerRoleId,state:"DEL"};X.data.ooRoles.push(ag)}al.push(X)}else{var ah=order.prodModify.choosedProdInfo;var X={areaId:OrderInfo.getProdAreaId(ah.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ah.productId,instId:ah.prodInstId,accessNumber:ah.accNbr,isComp:"N"},boActionType:{actionClassCd:ak,boActionTypeCd:aj},data:{boProdStatuses:[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};al.push(X)}for(var ad=0;ad<an.length;ad++){var aa=an[ad];if(aa.del=="N"){var af={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aa.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:Z,boActionTypeCd:ai},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};for(var ab=0;ab<OrderInfo.offer.offerMemberInfos.length;ab++){var ac=OrderInfo.offer.offerMemberInfos[ab];if(ac.objInstId==aa.objInstId){var ag={objId:ac.objId,objInstId:ac.objInstId,objType:ac.objType,offerRoleId:aa.offerRoleId,state:"ADD"};af.data.ooRoles.push(ag);break}}al.push(af)}else{var X={areaId:OrderInfo.getProdAreaId(aa.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:aa.accessNumber,objId:aa.objId,instId:aa.objInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};al.push(X)}}};var M=function(Y){AttachOffer.setAttachBusiOrder(Y);var Z=order.prodModify.choosedProdInfo;if(AttachOffer.isChangeUim(Z.prodInstId)){if(OrderInfo.boProd2Tds.length>0){var X={prodId:Z.prodInstId,prodSpecId:Z.productId,isComp:"N",accessNumber:Z.accNbr,boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};Y.push(OrderInfo.getProdBusiOrder(X))}}};var V=function(X,Z){var Y={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};Y.data=Z;X.push(Y)};var v=function(Y,aa){var Z={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};Z.data=aa;Y.push(Z);var X={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,objId:order.prodModify.choosedProdInfo.productId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACTIVERETURNTWO},data:{}};X.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.READY_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.DONE_PROD,state:"ADD"}];Y.push(X)};var i=function(X,Z){var Y={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};
Y.data=Z;X.push(Y)};var p=function(aj){var X={areaId:OrderInfo.getProdAreaId(-1),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.offerSpec.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[],busiOrderAttrs:[]}};var ac=OrderInfo.getAccessNumber(-1);if(ec.util.isObj(ac)){X.busiObj.accessNumber=ac}$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var an={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,memberRoleCd:this.memberRoleCd,offerRoleId:this.offerRoleId,state:"ADD"};X.data.ooRoles.push(an);var am=this.prodInstId;if(this.servInsts!=undefined&&this.servInsts.length>0){$.each(this.servInsts,function(){var ao={objId:this.objId,objInstId:OrderInfo.SEQ.servSeq--,objType:this.objType,prodId:am,offerRoleId:this.offerRoleId,state:"ADD"};X.data.ooRoles.push(ao)})}})});if(offerChange.oldMemberFlag){var ad="";for(var af=0;af<OrderInfo.offerSpec.offerRoles.length;af++){var ak=OrderInfo.offerSpec.offerRoles[af];if(ak.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ad=ak.offerRoleId;break}}for(var Z=0;Z<OrderInfo.oldprodInstInfos.length;Z++){var aa=OrderInfo.oldprodInstInfos[Z];var Y={areaId:aa.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aa.mainProdOfferInstInfos[0].prodOfferId,instId:aa.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:aa.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var ai=-1;for(var af=0;af<OrderInfo.oldoffer.length;af++){if(OrderInfo.oldoffer[af].accNbr==aa.accNbr){$.each(OrderInfo.oldoffer[af].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var am={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:ai,offerRoleId:ad,state:"ADD"};X.data.ooRoles.push(am);var an={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};Y.data.ooRoles.push(an);--ai}})}}aj.push(Y)}if(CONST.getAppDesc()==0){for(var af=0;af<OrderInfo.oldoffer.length;af++){$.each(OrderInfo.oldoffer[af].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var am={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var an=OrderInfo.getProdBusiOrder(am);if(an){aj.push(an)}}}})}}}var ag=OrderInfo.offerSpec.offerSpecParams;if(ag!=undefined&&ag.length>0){X.data.ooParams=[];for(var af=0;af<ag.length;af++){var ab=ag[af];var ae={itemSpecId:ab.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:ab.offerSpecParamId,value:ab.value,state:"ADD"};X.data.ooParams.push(ae)}}if(OrderInfo.offerSpec.ooTimes!=undefined){X.data.ooTimes=[];X.data.ooTimes.push(OrderInfo.offerSpec.ooTimes)}var al={partyId:OrderInfo.cust.custId,state:"ADD"};X.data.ooOwners.push(al);var ah=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(ah!=undefined){ah.each(function(){var am={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()};X.data.busiOrderAttrs.push(am);var an={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};X.data.busiOrderAttrs.push(an)})}aj.push(X);return X};var o=function(ad,aj){var X={areaId:OrderInfo.getProdAreaId(ad),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aj,instId:ad,isComp:"N"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:"1"},data:{boProdFeeTypes:[],boProdSpecs:[{prodSpecId:aj,state:"ADD"}],boCusts:[],boProdItems:[],boProdPasswords:[],boProdAns:[],bo2Coupons:[],boAccountRelas:[],boProdStatuses:[],busiOrderAttrs:[]}};var aa=CONST.PROD_STATUS_CD.NORMAL_PROD;X.data.boProdStatuses.push({state:"ADD",prodStatusCd:aa});var Y=OrderInfo.boProdAns;for(var ac=0;ac<Y.length;ac++){if(Y[ac].prodId==ad){X.data.boProdAns.push(Y[ac]);X.busiObj.accessNumber=Y[ac].accessNumber;break}}var ah=OrderInfo.boProd2Tds;for(var ac=0;ac<ah.length;ac++){if(ah[ac].prodId==ad){X.data.bo2Coupons.push(ah[ac]);break}}X.data.boCusts.push({partyId:OrderInfo.cust.custId,partyProductRelaRoleCd:"0",state:"ADD"});var af=$("#pwd_"+ad).val();if(af=="******"){af=order.main.genRandPass6()}var ab={prodPwTypeCd:2,pwd:af,state:"ADD"};X.data.boProdPasswords.push(ab);$("[name=prodSpec_"+ad+"]").each(function(){var al=$(this).attr("id").split("_")[0];var an=$.trim($(this).val());if(an!=""&&an!=undefined){var am={itemSpecId:al,prodSpecItemId:OrderInfo.SEQ.itemSeq--,state:"ADD",value:an};X.data.boProdItems.push(am)}});var ag=$('select[name="pay_type_-1"]').val();if(ag!=undefined){X.data.boProdFeeTypes.push({feeType:ag,state:"ADD"})}var ae;if(OrderInfo.actionFlag==6){ae=$("li[name='tr_"+ad+"']")}else{ae=$("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']")}if(ae!=undefined){ae.each(function(){var al={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};if(OrderInfo.actionFlag==6){al.channelNbr=$(this).find("select[name ='dealerChannel_"+ad+"']").val()}else{al.channelNbr=$(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()}X.data.busiOrderAttrs.push(al);var am={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};X.data.busiOrderAttrs.push(am)})}var ai=-1;if(OrderInfo.acct!=undefined&&OrderInfo.acct.acctId!=undefined&&OrderInfo.acct.acctId!=null&&OrderInfo.acct.acctId!=""){ai=OrderInfo.acct.acctId}var ak=-1;if(ai==undefined){ai=-1;ak=-1}else{if(ai<0){ak=ai}else{ak=OrderInfo.acct.acctcd}}var Z={acctId:ai,acctCd:ak,acctRelaTypeCd:"1",chargeItemCd:"0",percent:"100",priority:"1",state:"ADD"};X.data.boAccountRelas.push(Z);return X};var E=function(aa,Z,X,Y){if(X==1){aa.offerTypeCd=2;aa.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;OrderInfo.getOfferBusiOrder(Y,aa,Z)}else{if(X==2){if(aa.offerSpec.offerSpecParams!=undefined&&aa.offerSpec.offerSpecParams.length>0){aa.offerTypeCd=2;aa.boActionTypeCd=CONST.BO_ACTION_TYPE.UPDATE_OFFER;OrderInfo.getOfferBusiOrder(Y,aa,Z)}}else{aa.offerTypeCd=2;aa.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;aa.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(Y,aa,Z)}}};var Q=function(Y,aa,X,Z){Y.prodId=aa;if(X==1){Y.servClose="Y";Y.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;Z.push(OrderInfo.getProdBusiOrder(Y))}else{if(X==2){if(Y.prodSpecParams!=undefined&&Y.prodSpecParams.length>0){Y.boActionTypeCd=CONST.BO_ACTION_TYPE.PRODUCT_PARMS;Y.memberId=Y.servId;Z.push(OrderInfo.getProdBusiOrder(Y))}}else{Y.servId=OrderInfo.SEQ.servSeq--;Y.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;Z.push(OrderInfo.getProdBusiOrder(Y))}}};var f=function(X){var Y={};Y.boProdAns=OrderInfo.boProdAns;OrderInfo.setProdModifyBusiOrder(X,Y)};var P=function(){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14||(OrderInfo.actionFlag==2&&offerChange.newMemberFlag)){if(OrderInfo.cust.custId==""){$.alert("提示","客户信息不能为空！");return false}if(OrderInfo.order.dealerTypeList==undefined||OrderInfo.order.dealerTypeList.length==0){$.alert("提示","发展人类型不能为空！");return false}if(ec.util.isArray(OrderInfo.oldprodAcctInfos)){for(var aB=0;aB<OrderInfo.oldprodAcctInfos.length;aB++){var ah=OrderInfo.oldprodAcctInfos[aB].prodAcctInfos[0].acctId;var aj=$("#acctSelect option:selected").val();if(ah!=aj){$.alert("提示","副卡和主卡的账户不一致！");return false}}}if(offerChange.oldMemberFlag){var ai=$('select[name="pay_type_-1"]').val();$.each(OrderInfo.oldprodInstInfos,function(){if(this.feeType.feeType!=ai){$.alert("提示",this.accNbr+"和主卡的付费类型不一致！");
return false}})}if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){for(var az=0;az<OrderInfo.offerSpec.offerRoles.length;az++){var aC=OrderInfo.offerSpec.offerRoles[az].prodInsts;if(aC!=undefined&&aC!=null&&aC!=""){var au=OrderInfo.offerSpec.offerRoles[az];for(var av=0;av<au.prodInsts.length;av++){var ad=au.prodInsts[av];if(OrderInfo.actionFlag==2){var aq='"'+ad.prodInstId+'"';if(ad.memberRoleCd=="401"&&aq.indexOf("-")!=-1){var aw=OrderInfo.getProdAn(ad.prodInstId).accessNumber;if(aw==undefined||aw==""){$.alert("信息提示","【接入产品("+au.offerRoleName+")】号码不能为空！");return false}if(OrderInfo.getProdTd(ad.prodInstId)==""){$.alert("信息提示","【接入产品("+au.offerRoleName+")】UIM卡不能为空！");$("#uim_txt_"+ad.prodInstId).css("border-color","red");return false}var X=$("#pwd_"+ad.prodInstId).val();if(X!="******"&&X!=undefined&&X!=null&&X!=""){var aw=OrderInfo.getProdAn(ad.prodInstId).accessNumber;if(!order.main.passwordCheckVal(X,aw)){return false}}}}else{var aw=OrderInfo.getProdAn(ad.prodInstId).accessNumber;if(aw==undefined||aw==""){$.alert("信息提示","【接入产品("+au.offerRoleName+")】号码不能为空！");return false}if(OrderInfo.getProdTd(ad.prodInstId)==""){$.alert("信息提示","【接入产品("+au.offerRoleName+")】UIM卡不能为空！");$("#uim_txt_"+ad.prodInstId).css("border-color","red");return false}}var ay=false;$("[name='pay_type_-1']").each(function(){if($(this).val()!=undefined&&$(this).val()!=null&&$(this).val()!=""){ay=true}});if(!ay){$.alert("信息提示","没有配置付费类型，无法提交");return false}var aa=true;var ag=null;$(OrderInfo.prodAttrs).each(function(){var aD=this.isOptional;var aF=this.id;if(aD=="N"&&aF){var aE=$.trim($("#"+aF).val());if(aE==""||aE==undefined){ag=this.name;aa=false}}});if(!aa){$.alert("信息提示","没有配置产品属性("+ag+")，无法提交");return false}if(!order.main.templateTypeCheck()){return false}}}}}var ar=true;if(order.memberChange.oldMemberFlag){for(var az=0;az<OrderInfo.oldoffer.length;az++){$.each(OrderInfo.oldoffer[az].offerMemberInfos,function(){var aE=this;if(aE.objType==CONST.OBJ_TYPE.PROD){if(AttachOffer.isChangeUim(aE.objInstId)){var aD=OrderInfo.getProdTd(aE.objInstId);if(aD==""){$.alert("提示","加装移动电话"+aE.accessNumber+" UIM卡不能为空！");ar=false;return false}}}});if(!ar){break}}if(!ar){return}}var ak=$("#acctSelect").val();if(ak==undefined||$.trim(ak)==""){$.alert("提示","请新建或者查询选择一个可用帐户");return false}if(ak<0){if(!r()){return false}}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==3||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var az=0;az<AttachOffer.openList.length;az++){var ac=AttachOffer.openList[az].specList;var an=OrderInfo.getOfferRoleName(AttachOffer.openList[az].prodId);for(var av=0;av<ac.length;av++){var af=ac[av];if(af.isdel!="Y"&&af.isdel!="C"){if(af.ifParams){if(af.isset!="Y"){$.alert("提示",an+" "+af.offerSpecName+"：参数未设置");return false}}}}}for(var az=0;az<AttachOffer.openServList.length;az++){var ac=AttachOffer.openServList[az].servSpecList;var an=OrderInfo.getOfferRoleName(AttachOffer.openServList[az].prodId);for(var av=0;av<ac.length;av++){var af=ac[av];if(af.isdel!="Y"&&af.isdel!="C"){if(af.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){if("no"==$("#isMIFI_-"+(az+1)).val()){$.alert("提示","要开通"+af.servSpecName+"功能，请选择4G上网卡-全球卡（MIFI卡）！");$("#uim_txt_-"+(az+1)).css("border-color","red");return false}}if(af.ifParams=="Y"){if(af.isset!="Y"){$.alert("提示",an+" "+af.servSpecName+"：参数未设置");return false}}}}}for(var az=0;az<AttachOffer.openList.length;az++){var ac=AttachOffer.openList[az].specList;var at=AttachOffer.openList[az].prodId;var an=OrderInfo.getOfferRoleName(at);for(var av=0;av<ac.length;av++){var af=ac[av];if(af.isdel!="Y"&&af.isdel!="C"){if(af.isTerminal==1){var ay=true;$.each(OrderInfo.attach2Coupons,function(){if(af.offerSpecId==this.attachSepcId&&at==this.prodId){ay=false;return false}});if(ay){$.alert("提示",an+" "+af.offerSpecName+"：终端信息未填写");return false}}}}}}if(CONST.getAppDesc()==0){if(OrderInfo.actionFlag==2){for(var az=0;az<OrderInfo.offer.offerMemberInfos.length;az++){var Z=OrderInfo.offer.offerMemberInfos[az];if(Z.objType==CONST.OBJ_TYPE.PROD){if(AttachOffer.isChangeUim(Z.objInstId)){var ae=OrderInfo.getProdTd(Z.objInstId);if(ae==""){$.alert("提示",Z.roleName+" UIM卡不能为空！");return false}}}}var ar=true;if(offerChange.oldMemberFlag){for(var az=0;az<OrderInfo.oldoffer.length;az++){$.each(OrderInfo.oldoffer[az].offerMemberInfos,function(){var aE=this;if(aE.objType==CONST.OBJ_TYPE.PROD){if(AttachOffer.isChangeUim(aE.objInstId)){var aD=OrderInfo.getProdTd(aE.objInstId);if(aD==""){$.alert("提示","加装移动电话"+aE.accessNumber+" UIM卡不能为空！");ar=false;return false}}}});if(!ar){break}}if(!ar){return}}}else{if(OrderInfo.actionFlag==3){if(AttachOffer.isChangeUim()){if(OrderInfo.boProd2Tds.length==0){$.alert("提示","UIM卡不能为空！");return false}}}}}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(OrderInfo.boProd2OldTds.length==0){$.alert("提示","原UIM卡信息为空！");return false}if(OrderInfo.boProd2Tds.length==0){$.alert("提示","UIM卡不能为空！");return false}}if(CONST.getAppDesc()==0){for(var az=0;az<AttachOffer.openServList.length;az++){var ac=AttachOffer.openServList[az].servSpecList;var ay=false;var ap=false;$.each(ac,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G&&this.isdel!="Y"&&this.isdel!="C"){ay=true;return false}});var at=AttachOffer.openServList[az].prodId;var am="";if(AttachOffer.openList[az]!=undefined){var Y=AttachOffer.openList[az].specList;for(var av=0;av<Y.length;av++){var af=Y[av];if(af.isdel!="Y"&&af.isdel!="C"){if(af.isTerminal==1){$.each(OrderInfo.attach2Coupons,function(){if(at==this.prodId){ap=true;if(ec.util.isObj(this.termTypeFlag)){am=this.termTypeFlag}return false}})}}}}var an=OrderInfo.getOfferRoleName(at);if(ap&&am==""){$.alert("信息提示",an+"中,营销资源未返回终端机型，无法判断是3G终端还是4G终端!");return false}if(ay){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){var ab=OrderInfo.getProdUim(at);if(ab.cardTypeFlag=="2"){$.alert("信息提示",an+"中UIM卡是3G卡，无法提交");return false}if(ap&&am=="2"){$.alert("信息提示",an+"中终端是3G机型，无法提交");return false}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){var ao=OrderInfo.getProdOldUim(at);if(ao.is4GCard!="Y"){var ab=OrderInfo.getProdUim(at);if(ab.cardTypeFlag=="2"){$.alert("信息提示",an+"中UIM卡是3G卡，无法提交");return false}}if(ap&&am=="2"){$.alert("信息提示",an+"中终端是3G机型，无法提交");return false}}}}else{if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(ap){var ab=OrderInfo.getProdUim(at);if(ab.cardTypeFlag!=am){var ax=ab.cardTypeFlag=="1"?"4G卡":"3G卡";var aA=am=="1"?"4G机型":"3G机型";$.alert("信息提示",an+"中UIM卡是"+ax+" 终端是"+aA+"，无法提交");return false}}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){if(ap){var al=OrderInfo.getProdUim(at);if(ec.util.isObj(al)&&ec.util.isObj(al.cardTypeFlag)){if(al.cardTypeFlag=="2"&&am=="1"){$.alert("信息提示",an+"中UIM卡是3G卡 终端是4G机型，无法提交");return false}if(al.cardTypeFlag=="1"&&am=="2"){$.alert("信息提示",an+"中UIM卡是4G卡 终端是3G机型，无法提交");return false}}else{var ao=OrderInfo.getProdOldUim(at);if(ec.util.isObj(ao.is4GCard)){if(ao.is4GCard!="Y"){if(am=="1"){$.alert("信息提示",an+"中UIM卡是3G卡 终端是4G机型，无法提交");return false}}else{if(am=="2"){$.alert("信息提示",an+"中UIM卡是4G卡 终端是3G机型，无法提交");return false}}}}}}}}}}return true};var r=function(){if($.trim($("#acctName").val())==""){$.alert("提示","帐户名称不能为空");return false}if($("#paymentType").val()==110000){if($("#bankId").val()==""||$.trim($("#bankAcct").val())==""||$.trim($("#paymentMan").val())==""){$.alert("提示","若选择银行支付请填写必要的银行支付信息");return false}}if($("#postType").val()!=-1){if($.trim($("#postAddress").val())==""){$.alert("提示","若选择投递账单请填写必要的账单投递信息");return false}if($("#postType").val()==13){var X=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;if(X.test($("#postAddress").val())==false){$.alert("提示","若选择 Email 投递帐单请输入有效的 Email 地址");return false}}}return true};var b=function(){var aa=[];for(var Z=0;Z<OrderInfo.boProdAns.length;Z++){var Y={accNbr:OrderInfo.boProdAns[Z].accessNumber,accNbrType:1,action:"UPDATE"};aa.push(Y)}for(var Z=0;Z<OrderInfo.boProd2Tds.length;Z++){var Y={accNbr:OrderInfo.boProd2Tds[Z].terminalCode,accNbrType:2,action:"UPDATE"};
aa.push(Y)}if(aa.length>0){var X=contextPath+"/common/updateResState";$.callServiceAsJsonGet(X,{strParam:JSON.stringify(aa)},{done:function(ab){if(ab.code==0){if(ab.data){}}}})}};var j=function(X){if($("#isTemplateOrder").attr("checked")=="checked"){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$(".template_info_type").show();$("#isActivation").removeAttr("checked");$("#isActivation").attr("disabled","disabled")}$(".template_info_name").show()}else{$(".template_info_name").hide();$(".template_info_type").hide();$("#templateOrderName").val("");$("#isActivation").removeAttr("disabled")}};var e=function(){if($("#isActivation").attr("checked")=="checked"){$("#isTemplateOrder").removeAttr("checked");$("#isTemplateOrder").attr("disabled","disabled");$(".template_info_name").hide();$(".template_info_type").hide();$("#templateOrderName").val("")}else{$("#isTemplateOrder").removeAttr("disabled")}};var t=function(aa){var Y=[];for(var X=0;X<aa.offerRoles.length;X++){var Z=aa.offerRoles[X];if(Z.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){Y.push(Z)}}for(var X=0;X<aa.offerRoles.length;X++){var Z=aa.offerRoles[X];if(Z.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){Y.push(Z)}}aa.offerRoles=Y;return aa};var h=function(){var X=false;var ab=order.prodModify.choosedProdInfo.prodClass;var aa=order.prodModify.choosedProdInfo.prodInstId;var Y=CacheData.getOfferSpecList(aa);if(ec.util.isArray(Y)){$.each(Y,function(){if(this.ifPackage4G=="Y"&&this.isdel!="Y"&&this.isdel!="C"){X=true;return false}})}if(CONST.getAppDesc()==0&&X&&ab==CONST.PROD_CLASS.THREE&&OrderInfo.actionFlag==3){if(offerChange.checkOrder()){var Z=offerChange.checkAttachOffer(aa);if(Z!=""){if(P()){$("#offer_serv").html(Z);easyDialog.open({container:"offer_dialog"})}}else{SoOrder.submitOrder()}}}else{SoOrder.submitOrder()}};var K=function(){var X=order.prodModify.choosedProdInfo.prodInstId;AttachOffer.setChangeList(X);SoOrder.submitOrder();easyDialog.close()};var q=function(){var ab=order.prodModify.choosedProdInfo.is3G;if(OrderInfo.actionFlag==2){var Z=OrderInfo.offerSpec.is3G;if(ec.util.isObj(ab)){if(ec.util.isObj(Z)){if(ab=="Y"&&Z=="N"){return true}}}}else{if(OrderInfo.actionFlag==3){if(ec.util.isObj(ab)){if(ab=="Y"){for(var aa=0;aa<AttachOffer.openServList.length;aa++){var Y=AttachOffer.openServList[aa].servSpecList;var X=false;$.each(Y,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G&&this.isdel!="Y"&&this.isdel!="C"){X=true;return false}});if(X){return true}}}}}}return false};return{builder:R,createAttOffer:E,createServ:Q,delOrder:H,delAndNew:J,getOrderInfo:L,getToken:G,getTokenSynchronize:c,initFillPage:l,initOrderData:F,orderBack:z,step:D,showStep:S,submitOrder:w,checkAcctInfo:r,showTemplateOrderName:j,sortOfferSpec:t,updateResState:b,delOrderBegin:O,delOrderSilent:C,delOrderFin:y,showActivation:e,checkOrder:h,orderPrepare:K,createProd:o}})();CommonUtils.regNamespace("prod","changeUim");prod.changeUim=(function(){var c=function(){var f=order.prodModify.choosedProdInfo;var j={areaId:OrderInfo.staff.soAreaId,custId:OrderInfo.cust.custId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,boInfos:[{boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD,instId:f.prodInstId,specId:CONST.PROD_SPEC.CDMA}]};var g=$("#DiffPlaceFlag").val();var k=22;var e="";var i="";if(g=="diff"){k=23;e=CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD;i="异地补换卡";var h=f.areaId;if(h==undefined||h==""){$.alert("提示","营业后台未返回产品归属地区，无法办理异地补换卡业务！");return false}}else{e=CONST.BO_ACTION_TYPE.CHANGE_CARD;i="补换卡"}var d={prodId:f.prodInstId};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,e,k,i,"");rule.rule.prepare(j,"prod.changeUim.initFillPage",d);$("#dlg_cust_prod").popup("close")};var b=function(e){if(!prod.uim.setProdUim()){return false}var d=order.prodModify.choosedProdInfo;$.callServiceAsHtml(contextPath+"/pad/prod/changeCard",e,{before:function(){},done:function(g){$("#order_tab_panel_content").html(g.data).show();$.jqmRefresh($("#order_tab_panel_content"));$("#fillLastStep").click(function(){order.prodModify.cancel()});$("#nothreelinks").css("display","none");$(".ordercon").show();$(".ordertabcon").show();$(".ordertitle").append(d.productName+"-"+d.accNbr);order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide();if($("#DiffPlaceFlag").val()=="diff"){$("#uim_txt_"+d.prodInstId).css("display","none");$("#uim_check_btn_"+d.prodInstId).css("display","none");$("#uim_release_btn_"+d.prodInstId).css("display","none");$("#uim_lable").text("写卡：")}var h=OrderInfo.actionFlag;if(h=="22"||h=="23"){var f=$("div[id^='uimDiv_']");$.each(f,function(i,j){$(j).show()})}},always:function(){$.unecOverlay()}})};var a=function(){var d=order.prodModify.choosedProdInfo;var f={prodId:d.prodInstId,boActionTypeCd:OrderInfo.boActionTypeCd,remark:$("#orderRemark").val()};var e=[];e.push(OrderInfo.getProdBusiOrder(f));SoOrder.submitOrder(e)};return{init:c,initFillPage:b,submit:a}})();CommonUtils.regNamespace("order","uiCusts");order.uiCusts=(function(){var aR=0;var f=[];var ai=false;var y=false;var R="";var L=1;var av=1;var aB=0;var ao=false;var A={};var c={};var q=null;var aa=null;var aj="0";var ae=null;var aO="";var v=[];var aI=[];var aT=function(){return q};var aC="";var Z={provIsale:"",redirectUri:"",isFee:"",reloadFlag:""};var k;var S=function(aU){$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>"+aU+"</div>")};var ar=function(aV){var aU='<table class="contract_list rule">';aU+='<thead><tr> <td colspan="2">提示</td></tr></thead></table>';aU+='<div id="rules_div" height="height:140px;">';aU+='<table width="100%" height="120px;" border="0" cellspacing="0" cellpadding="0">';aU+="<tr>";aU+='<td align="right"></td>';aU+='<td><div class="rule_font" style="width:100%;font-size:15px; text-align:center;">'+aV+"</div></td>";aU+="</tr>";aU+="</table>";aU+="</div>";easyDialog.open({container:"packageTip_dialog"});$("#infoTipContent").html("");$("#infoTipContent").html(aU)};var aQ=function(){OrderInfo.busitypeflag=2;var aW=OrderInfo.provinceInfo.reloadFlag;var aV=contextPath+"/order/createorderlonger";var aU=$.callServiceAsJson(aV,{});if(aU.code==0){OrderInfo.custorderlonger=aU.data}if(OrderInfo.provinceInfo.mergeFlag=="0"){T()}else{var aX=$("#custAreaId_").val();if(order.cust.mgr.queryCustCompreInfo(OrderInfo.provinceInfo.mainPhoneNum,aX,2,"")){aP()}}};var T=function(){var aZ="";var aW="";var a1="";var aV="";var aY="";var aU="";var aX="";aZ=$("#p_cust_identityCd").val();aY=OrderInfo.provinceInfo.mainPhoneNum;if(order.cust.mgr.fromProvFlag=="1"||(aZ!=-1&&CONST.getAppDesc()!=0)){aZ=$("#p_cust_identityCd").val();aa="1"}else{aa="0"}if(aZ==-1){aV=aY;aY="";aZ=""}else{if(aZ=="acctCd"||aZ=="custNumber"){aV="";aY="";aZ="";aU=$("#p_cust_identityCd").val();aX=$.trim($("#p_cust_identityNum").val())}}a1=$("#DiffPlaceFlag").val();areaId=$("#p_cust_areaId").val();if(areaId==null||areaId==""||areaId=="null"||areaId=="undefined"){$.alert("提示","用于客户定位的地市为空，请重试!");return}if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");return}var a0={acctNbr:aV,identityCd:aZ,identityNum:aY,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:a1,areaId:areaId,queryType:aU,queryTypeValue:aX};$.callServiceAsHtml(contextPath+"/token/pad/cust/queryCustSub",a0,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(a2){if(a2.code==-2){return}w(a2)},fail:function(a2){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})};var w=function(aU){if(aU.data.indexOf("false")>=0){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}var aV=$("#div_user_qry_result");aV.find("ul").html(aU.data);$("#a_cust_qry_back").off("tap").on("tap",function(aW){aa=""});$.jqmRefresh(aV)};var Q=function(aU){var aV=$(aU);A={custId:aV.attr("custId"),partyName:aV.attr("partyName"),idCardNumber:aV.attr("idCardNumber"),identityName:aV.attr("identityName"),areaName:aV.attr("areaName"),areaId:aV.attr("areaId"),identityCd:aV.attr("identityCd"),addressStr:aV.attr("addressStr"),norTaxPayer:aV.attr("norTaxPayer"),segmentId:aV.attr("segmentId"),segmentName:aV.attr("segmentName"),custFlag:aV.attr("custFlag"),vipLevel:aV.attr("vipLevel"),vipLevelName:aV.attr("vipLevelName")};
if(aa=="0"){if(order.cust.mgr.authType=="00"){$("#custAuthTypeName").html("客户密码：")}else{$("#custAuthTypeName").html("产品密码：")}if(order.cust.mgr.jumpAuthflag=="0"){$("#jumpAuth").show();$("#jumpAuth").off("tap").on("tap",ak)}else{$("#jumpAuth").hide()}$("#authPassword").val("");$("#custAuthbtn").off("tap").on("tap",aM);ak()}else{X(aU)}};var ak=function(){if(order.cust.mgr.jumpAuthflag!="0"){$.alert("提示","没有跳过校验权限！");return}var aU=A;aU.authFlag="1";$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",aU,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(aV){if(aV.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}q=aU;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=A.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=A.norTaxPayer;OrderInfo.cust=A;J(aV)},always:function(){$.unecOverlay()}})};var J=function(aU){if(aa=="0"){$("#dlg-chk-auth").popup("close")}$("#custQueryFirstForm").hide();$("#custInfo").html(aU.data).show().enhanceWithin();if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){$("#a-cust-modify").hide()}else{$("#a-cust-modify").show();$("#a-cust-modify").off("tap").on("tap",order.prodModify.showCustInfoModify)}$("#a-cust-rechk").off("tap").on("tap",H);$("#a-qry-cust-prod").off("tap").on("tap",ag);$("#cCustName").val("");$("#cCustIdCard").val("");main.home.hideMainIco();ag()};var ag=function(){if(OrderInfo.cust.custId==-1){$.alert("提示","新建客户无法查询已订购业务！");return}if(aC==""){_btnQueryCustProdPrepare();aC="1"}else{if(aC=="1"){$("#dlg_cust_prod").popup("open",{transition:"slide"});aC="1"}else{$("#dlg_cust_prod").popup("close");aC="1"}}};_btnQueryCustProdPrepare=function(){$.callServiceAsHtmlGet(contextPath+"/token/pad/cust/orderProdPrepare.html",{diffPlaceFlag:$("#diffPlaceFlag").val()},{before:function(){},always:function(){},done:function(aU){if(!aU||aU.code!=0){$.alert("提示","已订购业务查询失败,稍后重试");return}$.popup("#dlg_cust_prod",aU.data,{width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){},cache:true});$(".ui-panel-inner > .ui-listview").height($(window).height());N(1)}})};var N=function(aW,aU){var aX={};if(!A||!$.isPlainObject(A)||$.isEmptyObject(A)){aX.custId=""}else{aX.custId=A.custId;aX.areaId=$("#area").attr("areaId")}if($("#accNbrQuery").length==1){aX.acctNbr=$.trim($("#accNbrQuery").val());if(CONST.getAppDesc()==0){aX.areaId=$("#p_cust_areaId").val()}}else{if($("#isAppointNum").attr("value")=="1"){aX.acctNbr=$.trim($("#p_cust_identityNum").val());if(CONST.getAppDesc()==0){aX.areaId=$("#p_cust_areaId").val()}}else{aX.acctNbr=""}}aX.pageSize="8";aX.curPage=aW;if(!(aX.custId)||aX.custId==""){$.alert("提示","无法查询已订购产品");return}aX.acctNbr=OrderInfo.provinceInfo.mainPhoneNum;var aV=contextPath+"/pad/cust/orderProdSub";$.callServiceAsHtmlGet(aV,aX,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(aY){if(!aY||aY.code!=0){$.alert("提示","查询失败,稍后重试");return}var aZ=$("#dlg_cust_prod").find("ul:first");if(aW==1){aZ.html(aY.data)}else{aZ.append(aY.data)}aZ.listview().listview("refresh");aZ.find("li").off("tap").on("tap",function(){var a0=$(this);if(a0.hasClass("multi")){if(a0.next(".multidiv").is(":hidden")){a0.next(".multidiv").show().siblings(".multidiv").hide()}else{a0.next(".multidiv").hide().siblings(".multidiv").hide()}}ab(this,function(){a0.addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg");$("#div_2nd_order").panel("open")})});aZ.find("div.multidiv li").off("tap").on("tap",function(){ab(this,function(){$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").parent().siblings("li").removeClass("userorderlistlibg");$("#div_2nd_order").panel("open");order.prodModify.getChooseProdInfo()})});aZ.find("li:first").trigger("tap").next("div.multidiv li:first").trigger("tap");order.prodModify.getChooseProdInfo();if($("#searchInfos_")&&$("#searchInfos_").val()=="0"){aP()}}})};var aM=function(){$("#custAuthForm").off("formIsValid").on("formIsValid",function(aV,aU){var aW=A;aW.prodPwd=$.trim($("#authPassword").val());aW.accessNumber=A.accessNumber;aW.authFlag=aa;$.callServiceAsHtml(contextPath+"/cust/custAuth",aW,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(aX){if(aX.code==-2){return}if(aX.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}try{var aZ=$.parseJSON(aX.data);$.alertMore("异常信息",aZ.resultMsg,aZ.errorStack,"error");return}catch(aY){}q=aW;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=A.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=A.norTaxPayer;OrderInfo.cust=A;J(aX)},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"custAuthbtn"})};var ac=function(aV,aW){var aU=$(aV).val();u(aU,aW);e()};var u=function(aW,aV){var aU=$("#"+aV);$.callServiceAsJson(contextPath+"/cust/queryCertType",{partyTypeCd:aW},{before:function(){},done:function(aX){if(aX.code==-2){$.alertM(aX.data);return false}if(aX.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(aX.code==0){var a1=aX.data;if(a1!=undefined&&a1.length>0){var a3=[];for(var aZ=0;aZ<a1.length;aZ++){var a2=true;for(var aY=0;aY<a3.length;aY++){a2=a2&&a1[aZ].certTypeCd!=a3[aY].certTypeCd;if(!a2){break}}if(a2){a3.push(a1[aZ])}}for(var aZ=0;aZ<a3.length;aZ++){var a0=a3[aZ];aU.append("<option value='"+a0.certTypeCd+"' >"+a0.name+"</option>")}aU.selectmenu().selectmenu("refresh");if(aV=="identidiesTypeCd"){aL($("#"+aV).children(":first-child"),"cCustIdCard")}}}},fail:function(aX){},always:function(){}})};var aK=function(aU,aW){var aV=$(aU).val();if(aV==-1){$("#"+aW).attr("placeHolder","请输入接入号码");$("#"+aW).attr("data-validate","validate(required:请准确填写接入号码) on(blur)")}else{if(aV==1){$("#"+aW).attr("placeHolder","请输入身份证号码");$("#"+aW).attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(blur)")}else{if(aV==2){$("#"+aW).attr("placeHolder","请输入军官证");$("#"+aW).attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(aV==3){$("#"+aW).attr("placeHolder","请输入护照");$("#"+aW).attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#"+aW).attr("placeHolder","请输入证件号码");$("#"+aW).attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}}if(aV!=-1){$("#isAppointNum").val("0").slider().slider("refresh")}T()};var aL=function(aU,aX){var aV=$(aU).val();var aW=$("#"+aX);if(aV==1){aW.attr("placeHolder","请输入合法身份证号码");aW.attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(aV==2){aW.attr("placeHolder","请输入合法军官证");aW.attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(aV==3){aW.attr("placeHolder","请输入合法护照");aW.attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{aW.attr("placeHolder","请输入合法证件号码");aW.attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}e()};var e=function(){$("#custCreateForm").off("formIsValid").on("formIsValid",function(aW){var aV=contextPath+"/order/createorderlonger";var aU=$.callServiceAsJson(aV,{});if(aU.code==0){OrderInfo.custorderlonger=aU.data}aH()}).ketchup({bindElement:"btn_cust_create_save"})};var H=function(){window.location.reload();$("#custQueryFirstForm").show();$("#custInfo").hide();$("#p_cust_identityNum").val("");$("#authPassword").val("");aa="";OrderInfo.boCusts.partyId="";OrderInfo.boCustInfos.name="";OrderInfo.boCustIdentities.identityNum="";OrderInfo.cust={custId:-1,custName:"",areaId:""};OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId="";OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.cust="";aC="";OrderInfo.order.step=0;if((CONST.getAppDesc()!=0)&&($("#custModifyId").is(":hidden"))){$("#a-cust-modify").show()}};var X=function(aU){var aV=A;aV.prodPwd=$.trim($("#authPassword").val());aV.authFlag=aa;$.callServiceAsHtml(contextPath+"/cust/custAuth",aV,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")
},done:function(aW){if(aW.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}q=aV;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=A.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=A.norTaxPayer;OrderInfo.cust=A;J(aW)},always:function(){$.unecOverlay()}})};var h=function(){var aU=$("#p_cust_areaId").val();if(aU.indexOf("0000")>0){$.alert("提示","前页受理地区为省级地区无法进行创建,请先选择市级地区！");return}$.callServiceAsHtmlGet(contextPath+"/pad/cust/create.html",{},{done:function(aW){if(!aW||!aW.data){return}var aV=$.popup("#div_cust_create",aW.data,{cache:true,width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}}});$("#div_cust_create input[type='text']").val("");ac($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");af();aV.find("div[data-role='collapsible']").collapsible({collapsed:true,collapse:function(aX,aY){$("#contactName").attr("data-validate","");e()},expand:function(aX,aY){$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(blur)").attr("placeholder","请准确填写联系人名称");e()}})}})};var aG=function(aV){$("#plan2ndDiv tbody tr").removeClass("plan_select2");$("#plan2ndDiv tbody tr").children(":first-child").next().html("");$(aV).addClass("plan_select2");var aU="<i class='select'></i>";$(aV).children(":first-child").next().html(aU);order.prodModify.getChooseProdInfo()};var ab=function(aV,aU){if(1==OrderInfo.order.step&&(!$(aV).hasClass("userorderlistlibg"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){b();OrderInfo.order.step=0;aU.apply(this,[])},no:function(){}})}else{if(2==OrderInfo.order.step&&(!$(aV).hasClass("userorderlistlibg"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();b();OrderInfo.order.step=0;aU.apply(this,[])},no:function(){}})}else{aU.apply(this,[])}}};var am=function(){order.pad.area.chooseAreaTree("order/prepare","p_cust_areaId_val","p_cust_areaId",3)};var W=function(){order.area.chooseAreaTreeManger("cust/preQueryCust","p_areaId_val","p_areaId",3)};var al=function(){order.area.chooseAreaTreeAll("p_cust_areaId_val","p_cust_areaId",3,"limitProvince")};var P=function(){order.area.chooseAreaTree("order/prepare","p_ncust_areaId_val","p_ncust_areaId",3)};var m=function(){order.area.chooseAreaTree("order/prepare","prodareaName","prodareaid",3);order.prodModify.choosedProdInfo.areaId=$("#prodareaid").val()};var an=function(){$("#p_cust_identityCd").off("change").on("change",function(){aK($(this).find("option:selected"),"p_cust_identityNum");$("#p_cust_identityCd").selectmenu().selectmenu("refresh")});u("-1","p_cust_identityCd");$("#isAppointNum").off("change").on("change",aq);d();$("#a_user_create").off("tap").on("tap",h);T()};var d=function(){if($("#fromProvFlag").length&&$("#fromProvFlag").val()=="1"){order.cust.mgr.fromProvFlag="1";order.cust.mgr.provIsale=$("#provIsale").val();$("#p_cust_areaId_val").val("");$("#p_cust_areaId").val($("#provAreaId").val());$("#p_cust_identityCd").val($("#provIdentityCd").val());$("#p_cust_identityNum").val($("#provIdentityNum").val());if($("#provIdentityCd").val()!=-1){$("#isAppointNum").attr("checked",false)}$("#a_user_search").click()}else{order.cust.fromProvFlag="0";order.cust.provIsale=null}};var af=function(){$.callServiceAsHtmlGet(contextPath+"/pad/cust/partyProfileSpecList",{},{before:function(){$.ecOverlay("<strong>加载更多属性,请稍等...</strong>")},always:function(){$.unecOverlay()},fail:function(){$.alert("提示","属性加载异常,请稍后重试.");$.unecOverlay()},done:function(aV){if(aV.code==-2){return}var aU=$("#partyProfile").html(aV.data);$("#otabs li").on("tap",function(){p($(this))});$.jqmRefresh(aU)}})};var Y=function(){var aW="";var aU="";var aV="";aW=$("#p_cust_identityCd").val();aV=$.trim($("#p_cust_identityNum").val());if(aV==""){$.alert("提示","请输入证件号码！");return}if(aW==1){aW=$("#p_cust_identityCd").val()}if(aW==-1){aU=OrderInfo.provinceInfo.mainPhoneNum;aV="";aW=""}diffPlace=$("#DiffPlaceFlag").val();areaId=$("#p_areaId").val();var aX={acctNbr:aU,identityCd:aW,identityNum:aV,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:areaId};$.callServiceAsHtmlGet(contextPath+"/cust/queryCustAlone",aX,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(aY){if(aY.code==-2){return}if(!aY){aY.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(aY.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(aY.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctList").html(aY.data).show();$("#acctDetail").hide()},fail:function(aY){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var t=function(aV){var aU={partyId:aV,areaId:$("#p_areaId").val()};$.callServiceAsHtml(contextPath+"/cust/custInfo",aU,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(aW){if(aW.code==-2){return}if(!aW){aW.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(aW.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(aW.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctDetail").html(aW.data).show();$("#acctList").hide()},fail:function(aW){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var aE=function(){createCustInfo={cAreaId:OrderInfo.staff.soAreaId,cAreaName:OrderInfo.staff.soAreaName,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cPartyTypeName:($.trim($("#partyTypeCd  option:selected").val())==1)?"个人客户":"政企客户",cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val()),cMailAddressStr:$.trim($("#cMailAddressStr").val())};var aU={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$.trim($("#headFlag  option:selected").val()),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postcode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};OrderInfo.boCustInfos.name=createCustInfo.cCustName;OrderInfo.boCustInfos.areaId=createCustInfo.cAreaId;OrderInfo.boCustInfos.partyTypeCd=createCustInfo.cPartyTypeCd;OrderInfo.boCustInfos.defaultIdType=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustInfos.addressStr=createCustInfo.cAddressStr;OrderInfo.boCustInfos.mailAddressStr=createCustInfo.cMailAddressStr;OrderInfo.boCustIdentities.identidiesTypeCd=createCustInfo.cIdentidiesTypeCd;OrderInfo.boCustIdentities.identityNum=createCustInfo.cCustIdCard;OrderInfo.boPartyContactInfo.contactAddress=aU.contactAddress,OrderInfo.boPartyContactInfo.contactDesc=aU.contactDesc,OrderInfo.boPartyContactInfo.contactEmployer=aU.contactEmployer,OrderInfo.boPartyContactInfo.contactGender=aU.contactGender,OrderInfo.boPartyContactInfo.contactId=aU.contactId,OrderInfo.boPartyContactInfo.contactName=aU.contactName,OrderInfo.boPartyContactInfo.contactType=aU.contactType,OrderInfo.boPartyContactInfo.eMail=aU.eMail,OrderInfo.boPartyContactInfo.fax=aU.fax,OrderInfo.boPartyContactInfo.headFlag=aU.headFlag,OrderInfo.boPartyContactInfo.homePhone=aU.homePhone,OrderInfo.boPartyContactInfo.mobilePhone=aU.mobilePhone,OrderInfo.boPartyContactInfo.officePhone=aU.officePhone,OrderInfo.boPartyContactInfo.postAddress=aU.postAddress,OrderInfo.boPartyContactInfo.postcode=aU.postcode,OrderInfo.boPartyContactInfo.staffId=aU.staffId,OrderInfo.boPartyContactInfo.state=aU.state,OrderInfo.boPartyContactInfo.statusCd=aU.statusCd;
OrderInfo.cust={custId:-1,partyName:createCustInfo.cCustName,areaId:createCustInfo.cAreaId};OrderInfo.boCustProfiles=[];for(var aV=0;aV<v.length;aV++){var aX=v[aV];var aW=$("#"+aX.attrId).val();if(""==aW||undefined==aW){aW==$("#"+aX.attrId+"option:selected").val()}var aX={partyProfileCatgCd:aX.attrId,profileValue:aW,state:"ADD"};if(""!=aW&&aW!=undefined){OrderInfo.boCustProfiles.push(aX)}}$("#div_cust_create").popup("close");var aY={};aY.prodPwd="";aY.accessNumber="";aY.authFlag="1";authFlag="";aY.identityCd=createCustInfo.cIdentidiesTypeCd;aY.idCardNumber=createCustInfo.cCustIdCard;aY.partyName=createCustInfo.cCustName;aY.areaId=createCustInfo.cAreaId;aY.areaName=createCustInfo.cAreaName;aY.segmentName=createCustInfo.cPartyTypeName;aY.identityName=$("#identidiesTypeCd option:selected").text();$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",aY,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(aZ){if(aZ.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(aZ.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}J(aZ)},always:function(){$.unecOverlay()}})};var aH=function(){var aZ=$("#p_cust_areaId").val();if(aZ==null||aZ==""){aZ=OrderInfo.staff.areaId}var aW=$("#p_cust_areaId_val").val();createCustInfo={cAreaId:aZ,cAreaName:aW,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd option:selected").val()),cIdentidiesTypeCd:$.trim($("#identidiesTypeCd option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};diffPlace=$("#DiffPlaceFlag").val();var aY={acctNbr:"",identityCd:createCustInfo.cIdentidiesTypeCd,identityNum:createCustInfo.cCustIdCard,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:createCustInfo.cAreaId};var aV=contextPath+"/pad/cust/checkIdentity";var aU=$.callServiceAsJson(aV,aY,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});var aX="";if(aU.code==0){$.unecOverlay();$.confirm("确认","此证件号码已存在,是否确认新建?",{yes:function(){aE()},no:function(){}})}else{$.unecOverlay();aE()}};var p=function(aU){var aX=$(aU).attr("tabid");if(aX!="0"&&$("#contactName").val()==""){$("#contactName").blur();return}var aV=$(aU).index();var aW=$("#otabs-body > div");$(aU).parent().children("li").attr("class","otab-nav");$(aU).attr("class","otab-nav-action");$(aU).parent().children("li").find(".ui-input-search").hide();$(aU).parent().children("li").find(".ui-select").hide();$(aU).children("div").show();aW.hide();aW.eq(aV).show()};var aq=function(){if(!ao){ao=true;if($("#p_cust_identityCd").find("option:selected").val()!=-1){$.alertSync("提示","只能接入号码才能指定号码！","information",function(){$("#isAppointNum").val("0").slider().slider("refresh");ao=false})}}};var b=function(){var aU=OrderInfo.boProd2Tds;if(aU.length>0){for(var aX=0;aX<aU.length;aX++){var aW={numType:2,numValue:aU[aX].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",aW)}}var aV=OrderInfo.boProdAns;if(aV.length>0){for(var aX=0;aX<aV.length;aX++){if(aV[aX].idFlag){continue}var aW={numType:1,numValue:aV[aX].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",aW)}order.service.boProdAn={};order.phoneNumber.resetBoProdAn()}$("#order_fill_content").empty();order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show()};var aS=function(){$("#acctDetail").hide();$("#acctList").show()};var aP=function(){if(OrderInfo.provinceInfo.reloadFlag=="N"){var aW=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;var aV="";for(var aU=0;aU<aW.length;aU++){if(aW[aU].boActionType.actionClassCd=="1200"&&aW[aU].boActionType.boActionTypeCd=="S1"&&aW[aU].busiObj.offerTypeCd=="1"){aV=aW[aU].busiObj.objId;break}}OrderInfo.provinceInfo.prodOfferId=aV;order.uiCusts.offerinit(aV,null);aA()}else{if(OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""){order.uiCusts.offerinit(OrderInfo.provinceInfo.prodOfferId,null)}else{order.uiCusts.initSub()}}};var ad=function(aZ,aV){var aY="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var a1=this.PARTYPRODUCTRELAROLECD;var a0=true;$("select[name='dealerType_"+aZ+"']").each(function(){if(a1==$(this).val()){a0=false;return false}});if(a0){aY=a1;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(aY==undefined||aY==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var aX=$("<dd></dd>");var aW=$('<fieldset data-role="fieldcontain"></fieldset>');var aV=aZ+"_"+OrderInfo.SEQ.dealerSeq;var aU=$('<select id="dealerType_'+aV+'" name="dealerType_'+aZ+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+aZ+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==aY){aU.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{aU.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});aW.append(aU);aX.append(aW);return aX};var ay=function(){var aV=order.prodModify.choosedProdInfo;if(aV.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=2;if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!query.offer.setOffer()){return}}var aW=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,instId:aV.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:aV.prodInstId},{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,instId:aV.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:aV.prodInstId}];if(!rule.rule.ruleCheck(aW)){return}$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var aU=$.callServiceAsHtmlGet(contextPath+"/pad/order/prodoffer/prepare",{});$.unecOverlay();if(aU.code!=0){$.alert("提示","查询失败,稍后重试");return}SoOrder.step(0,aU.data);order.prepare.initOffer();order.uiCusts.searchPack();$("#dlg_cust_prod").popup("close");$("#navbar").slideUp(500);$.jqmRefresh($("#order_tab_panel_content"))};var U=function(aV,aX){var aU=order.prodModify.choosedProdInfo;if(aU.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=2;if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!query.offer.setOffer()){return}}var aW=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,instId:aU.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:aU.prodInstId},{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,instId:aU.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:aU.prodInstId}];if(!rule.rule.ruleCheck(aW)){return}$("#dlg_cust_prod").popup("close");$("#navbar").slideUp(500);$.jqmRefresh($("#order_tab_panel_content"));order.uiCusts.buyService(aV,aX)};var ax=function(aV,a1){var a5=OrderInfo.cust.custId;var a2=$("#searchtext").val();if(a2=="请输入您要搜索的套餐名称或首字母简拼"){a2=""}var a4="";if(a4==undefined&&a4==null){a4=""}var aW={qryStr:a2,pnLevelId:a4,custId:a5};var aZ=$.trim($("#select_price").val());if(ec.util.isObj(aZ)){var a0=aZ.split("-");if(a0[0]!=null&&a0[0]!=""){aW.priceMin=a0[0]}if(a0[1]!=null&&a0[1]!=""){aW.priceMax=a0[1]}}var a3=$.trim($("#select_influx").val());if(ec.util.isObj(a3)){var aU=a3.split("-");if(aU[0]!=null&&aU[0]!=""){aW.INFLUXMin=aU[0]*1024}if(aU[1]!=null&&aU[1]!=""){aW.INFLUXMax=aU[1]*1024}}var aX=$.trim($("#select_invoice").val());if(ec.util.isObj(aX)){var aY=aX.split("-");if(aY[0]!=null&&aY[0]!=""){aW.INVOICEMin=aY[0]}if(aY[1]!=null&&aY[1]!=""){aW.INVOICEMax=aY[1]}}j(aW,a1)};var j=function(aW,aU){if(OrderInfo.actionFlag==2){var aX=order.prodModify.choosedProdInfo.prodOfferId;if(aX!=undefined){aW.changeGradeProdOfferId=aX}}else{if(CONST.getAppDesc()==0){aW.prodOfferFlag="4G"}}var aV=contextPath+"/token/pad/order/offerSpecList";$.callServiceAsHtmlGet(aV,aW,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()
},done:function(aY){if(aY.code!=0){$.alert("提示","<br/>查询失败,稍后重试");return}var aZ=$("#div_offer_list");aZ.html(aY.data);$.jqmRefresh(aZ);if(aU&&$.isFunction(aU)){aU.apply(this,[])}$("#ul_offer_list li").off("tap").on("tap",function(){$(this).addClass("pakeagelistlibg").siblings().removeClass("pakeagelistlibg")});if(OrderInfo.busitypeflag==1){$("#btn_enter_prev").show();$("#btn_enter_prev").off("tap").on("tap",function(){$("#ul_busi_area").show();$("#order_prepare").empty()})}$("#btn_enter_offerlist_next").off("tap").on("tap",function(){if($("#ul_offer_list .pakeagelistlibg").length==1){var a0=$("#ul_offer_list .pakeagelistlibg").find("dl");order.uiCusts.buyService(a0.attr("offerSpecId"),a0.attr("price"))}else{$.alert("提示","请先选择一个套餐,再进入下一步操作.")}})},always:function(){$.unecOverlay()},fail:function(aY){$.unecOverlay();$.alert("提示","套餐加载失败，请稍后再试！")}})};var I=function(aU,aW){OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldAddNumList=[];var aV=OrderInfo.cust.custId;offerprice=aW;if(OrderInfo.cust==undefined||aV==undefined||aV==""){$.alert("提示","在订购套餐之前请先进行客户定位！");return}var aY={price:aW,specId:aU,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};if(OrderInfo.actionFlag==2){order.uiCusts.opeSer(aY)}else{var aX=[{boActionTypeCd:"S1",instId:"",specId:aU}];if(rule.rule.ruleCheck(aX)){order.service.opeSer(aY)}}};var F=function(aX){var aZ={offerSpecId:aX.specId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var aY=query.offer.queryMainOfferSpec(aZ);if(!aY){return}if(OrderInfo.actionFlag==2){var aV=contextPath+"/order/queryFeeType";$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");var aU=$.callServiceAsJsonGet(aV,aZ);$.unecOverlay();if(aU.code==0){if(aU.data!=undefined){if("0"==aU.data){var aW=false;if(order.prodModify.choosedProdInfo.feeType=="2100"&&(aY.feeType=="2100"||aY.feeType=="3100"||aY.feeType=="3101"||aY.feeType=="3103"||aY.feeType=="1202"||aY.feeType=="2101")){aW=true}else{if(order.prodModify.choosedProdInfo.feeType=="1200"&&(aY.feeType=="1200"||aY.feeType=="3100"||aY.feeType=="3102"||aY.feeType=="3103"||aY.feeType=="1202"||aY.feeType=="2101")){aW=true}else{if(order.prodModify.choosedProdInfo.feeType=="1201"&&(aY.feeType=="1201"||aY.feeType=="3101"||aY.feeType=="3102"||aY.feeType=="3103")){aW=true}}}if(!aW){$.alert("提示","付费类型不一致,无法进行套餐变更。");return}}}}order.uiCusts.offerChangeView(aX,aY);if(OrderInfo.provinceInfo.reloadFlag=="Y"){if(OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""){$("#dlg-memberRole-num-popup").removeClass("ui-popup-hidden");$("#dlg-memberRole-num-popup").removeClass("ui-popup-truncate");$("#dlg-memberRole-num-popup").removeClass("slideup")}}return}};var az=function(a4,aY){var a1=[];var a3=[];if(order.memberChange.newSubPhoneNum!=null&&order.memberChange.newSubPhoneNum!=""){a1=order.memberChange.newSubPhoneNum.split(",")}if(order.memberChange.oldSubPhoneNum!=null&&order.memberChange.oldSubPhoneNum!=""){a3=order.memberChange.oldSubPhoneNum.split(",")}var a2=0;if(OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""){var aW='<div id="dlg-memberRole-num" data-role="popup" data-transition="slideup" data-corners="false" data-overlay-theme="b" style="width: 800px; height: 450px;margin-left:300px;" class="popwindow" data-dismissible="false"><div data-role="header" data-position="inline" data-tap-toggle="false" data-theme="t"><a href="#" data-role="button" data-icon="back" data-rel="back" data-iconpos="notext" class="ui-btn-right">返回</a><h1>'+OrderInfo.offerSpec.offerSpecName+"</h1></div>"}else{var aW='<div id="dlg-memberRole-num" data-role="popup" data-transition="slideup" data-corners="false" data-overlay-theme="b" style="width: 800px; height: 450px;" class="popwindow" data-dismissible="false"><div data-role="header" data-position="inline" data-tap-toggle="false" data-theme="t"><a href="#" data-role="button" data-icon="back" data-rel="back" data-iconpos="notext" class="ui-btn-right">返回</a><h1>'+OrderInfo.offerSpec.offerSpecName+"</h1></div>"}var a6=$("<div></div>");var aX=$('<div style="height: 400px;" data-role="content"></div>');var a0=$('<ul id="ul1" data-role="listview" class="develist"></ul>');var a8=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd=="401"){a8++}});var a5=0;$.each(aY.offerRoles,function(){var a9=this;if(a9.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#objHtml").html(this.objName)}});$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==a9.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){$("#accessNumberHtml").html(this.accessNumber);return}})}else{$.each(this.roleObjs,function(){var bb="";var bd=a9.offerRoleId+"_"+this.objId;if(R==""){R=bd}if(this.objType==CONST.OBJ_TYPE.PROD){f.push(bd);if(a9.minQty==0){this.minQty=0;this.dfQty=0}a5=this.maxQty<0?"不限制":this.maxQty;a5=a5-a8;aB=a5;if(a5>0){var bc=$("<li></li>");var ba=$("<dl></dl>");ba.append("<dd></dd><dd><span style='color: #5a9203;'>"+a9.offerRoleName+" :</span>"+this.objName+" :</dd><dd><div class='ui-grid-b addnum'> <div class='ui-block-a' align='center'><a class='abtn01' href='javascript:order.service.subNum(\""+bd+'",'+this.minQty+");'>-</a></div><div class='ui-block-b'><input id='"+bd+"' type='text' value='"+this.dfQty+"' style='width:22px' readonly='readonly'></div><div class='ui-block-c' align='center'><a class='abtn01'  href='javascript:order.service.addNum(\""+bd+'",'+a5+',"'+a9.parentOfferRoleId+"\");'>+</a></div></div></dd><dd>"+this.minQty+"-"+a5+"（张） </dd>");bc.append(ba);a0.append(bc);a2++}}});$.each(this.roleObjs,function(){var bc=this;if(this.objType==CONST.OBJ_TYPE.PROD){a5=this.maxQty<0?"不限制":this.maxQty;a5=a5-a8;aB=a5;if(a5>0){if(a1.length==0&&a3.length==0){var bf=$('<li id="li'+av+'"></li>');var bb=$("<dl></dl>");var bd="<dd></dd>";bd+="<dd><span style='color: #5a9203;'>已有移动电话 :</span>移动电话（仅含本地语音） :</dd>";bd+='<dd style="width:150px;">';bd+="";bd+="";bd+="</div>";bd+='<div class="">';bd+='<input  name="oldphonenum" type="text" id="oldphonenum_1">';bd+="</div>";bd+='<div class="">';bd+="</dd>";bd+="<dd>";bd+='<button data-mini="ture" onclick="order.uiCusts.addLi('+a5+')">+</button>';bd+="</div>";bd+='<div class="ui-block-d">';bd+="</div>";bd+="</div>";bd+="</div></dd>";bb.append(bd);bf.append(bb);a0.append(bf)}else{if(a3.length>a5){$.alert("规则限制","oldSubPhoneNum的角色成员数量总和不能超过"+a5);errorflag=false;return false}else{for(var ba=0;ba<a3.length;ba++){var be="li"+av;var bf=$('<li id="'+be+'"></li>');var bb=$("<dl></dl>");var bd="<dd></dd>";bd+="<dd><span style='color: #5a9203;'>已有移动电话 :</span>移动电话（仅含本地语音） :</dd>";bd+='<dd style="width:150px;">';bd+="";bd+="";bd+="</div>";bd+='<div class="">';bd+='<input type="text" value="'+a3[ba]+'" name="oldphonenum" id="oldphonenum_1" readonly="readonly">';bd+="</div>";bd+='<div class="">';bd+="</dd>";bd+="<dd>";bd+="</div>";bd+='<div class="ui-block-d">';bd+="</div>";bd+="</div>";bd+="</div></dd>";bb.append(bd);bf.append(bb);a0.append(bf);$.jqmRefresh($("#dlg-memberRole-num"))}}}}}})}});var a7=' <div data-role="footer" data-position="inline" data-tap-toggle="false" data-theme="n"><button id="memberRoleNumConfirm1"  data-inline="true"  data-icon="check">确认</button></div>';aX.append(a0);aX.append(a7);a6.append(aX);aW+=a6.html()+"</div>";if(a2>=1){if(OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""){var aV=$.popup("#dlg-memberRole-num",aW,{width:800,height:450,contentHeight:400,afterClose:function(){}});$("#dlg-memberRole-num-popup").removeClass("ui-popup-hidden");$("#dlg-memberRole-num-popup").removeClass("ui-popup-truncate");$("#dlg-memberRole-num-popup").removeClass("slideup")}else{var aV=$.popup("#dlg-memberRole-num",aW,{width:800,height:450,contentHeight:400,afterClose:function(){}});$("#dlg-memberRole-num-popup").removeClass("ui-popup-hidden");$("#dlg-memberRole-num-popup").removeClass("ui-popup-truncate");$("#dlg-memberRole-num-popup").removeClass("slideup")}$("#memberRoleNumConfirm1").off("tap").on("tap",function(){var ba=$("#"+R).val();
ba=ba*1;var a9=0;$("input[name='oldphonenum']").each(function(){if(this.value!=null&&this.value!=""&&this.value.length==11){a9+=1}});if((ba+a9)>a5){$.alert("提示","新装副卡和纳入老成员数量超过最大值"+a5);return}else{if(OrderInfo.provinceInfo.prodOfferId!=null&&OrderInfo.provinceInfo.prodOfferId!=""){$("#dlg-memberRole-num-popup").addClass("ui-popup-hidden")}else{$("#dlg-memberRole-num").popup("close")}o(ba,a9)}});$("#memberRoleNumCancel").off("tap").on("tap",function(){$("#dlg-memberRole-num").popup("close")});if(OrderInfo.provinceInfo.reloadFlag=="N"){$("#memberRoleNumCancel").off("tap").on("tap",function(){$("#dlg-memberRole-num").popup("close")});var aZ=$("#"+R).val();aZ=aZ*1;var aU=0;$("input[name='oldphonenum']").each(function(){if(this.value!=null&&this.value!=""&&this.value.length==11){aU+=1}});o(aZ,aU)}$("#dlg-memberRole-num-popup").removeClass("ui-popup-hidden");$("#dlg-memberRole-num-popup").removeClass("ui-popup-truncate")}else{if(!order.service.setOfferSpec(1)){$.alert("错误提示","请选择一个接入产品");return}}};function o(aV,aU){if(CONST.getAppDesc()==0){if(order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){if(!offerChange.checkOrder()){return}}if(!prod.uim.setProdUim()){return}}OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldAddNumList=[];order.memberChange.viceCartNum=0;var aW=[];$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd=="401"){if(this.prodInsts!=undefined){var a1=this.prodInsts;for(var a0=0;a0<this.prodInsts.length;a0++){var aZ='"'+this.prodInsts[a0].prodInstId+'"';if(aZ.indexOf("-")!=-1){aW.push(this.prodInsts[a0])}}$.each(aW,function(){var a2=this.prodInstId;$.each(a1,function(a3){if(this.prodInstId=a2){a1.splice(a3,1)}})})}}});if(aV>0){offerChange.newMemberFlag=true;order.memberChange.newMemberFlag=true;order.service.setOfferSpec()}if(aU>0){offerChange.oldMemberFlag=true;order.memberChange.oldMemberFlag=true;if(!order.memberChange.queryofferinfoSub()){return}}if(parseInt(aV)+parseInt(order.memberChange.viceCartNum)>aB){$.alert("提示","加装数量已经超过能加装的最大数量【"+aB+"】!");return}var aX=order.prodModify.choosedProdInfo;var aY={boActionTypeCd:"S2",boActionTypeName:"套餐变更",actionFlag:"2",offerSpec:OrderInfo.offerSpec,prodId:aX.prodInstId,offerMembers:OrderInfo.offer.offerMemberInfos,oldOfferSpecName:aX.prodOfferName,prodClass:aX.prodClass,appDesc:CONST.getAppDesc(),areaId:order.prodModify.choosedProdInfo.areaId,newnum:aV,oldnum:aU,feeTypeMain:aX.feeType};if(aU>0){aY.oldprodInstInfos=OrderInfo.oldprodInstInfos;aY.oldofferSpec=OrderInfo.oldofferSpec;aY.oldoffer=OrderInfo.oldoffer}$("#dlg-memberRole-num").popup("close");order.uiCusts.buildMainView(aY)}var E=function(aU){aU="li"+aU;$("ul li[id="+aU+"]").remove();L--;av--};var g=function(aU){if(L>=aU){return}av++;L++;var aY="li"+av;var aX=$('<li class="ui-li-static ui-body-inherit ui-last-child" id="'+aY+'"></li>');var aV=$("<dl></dl>");var aW="<dd></dd>";aW+="<dd><span style='color: #5a9203;'>已有移动电话 :</span>移动电话（仅含本地语音） :</dd>";aW+='<dd style="width:150px;">';aW+="";aW+="";aW+="</div>";aW+='<div class="">';aW+='<input name="oldphonenum" type="text" id="oldphonenum_'+av+'">';aW+="</div>";aW+='<div class="">';aW+="</dd>";aW+="<dd>";aW+='<button data-mini="ture" onclick="order.uiCusts.delLi('+av+')">-</button>';aW+="</div>";aW+='<div class="ui-block-d">';aW+="</div>";aW+="</div>";aW+="</div></dd>";aV.append(aW);aX.append(aV);$("#ul1").append(aX);$.jqmRefresh($("#dlg-memberRole-num"))};var aF=function(aW,aX){var aV=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==2){aV++}});var aY=1;var aU=0;if(aV>1){aY=2}if(!offerChange.setChangeOfferSpec(aY,aU)){return}az(aW,aX);if(OrderInfo.provinceInfo.reloadFlag=="N"){$("#dlg-memberRole-num-popup").addClass("ui-popup-hidden")}};var G=function(aV){if(aV==undefined||!aV){aV=_getTestParam()}if(OrderInfo.actionFlag==2){if(aV.newnum>0||aV.oldnum>0){var aU=false;if(aV.feeTypeMain=="2100"&&(aV.offerSpec.feeType=="2100"||aV.offerSpec.feeType=="3100"||aV.offerSpec.feeType=="3101"||aV.offerSpec.feeType=="3103")){aU=true}else{if(aV.feeTypeMain=="1200"&&(aV.offerSpec.feeType=="1200"||aV.offerSpec.feeType=="3100"||aV.offerSpec.feeType=="3102"||aV.offerSpec.feeType=="3103")){aU=true}else{if(aV.feeTypeMain=="1201"&&(aV.offerSpec.feeType=="1201"||aV.offerSpec.feeType=="3101"||aV.offerSpec.feeType=="3102"||aV.offerSpec.feeType=="3103")){aU=true}}}}}$.callServiceAsHtml(contextPath+"/token/pad/order/mainSub",aV,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(aW){if(!aW){$.unecOverlay();aW.data="查询失败,稍后重试"}if(aW.code!=0){$.unecOverlay();$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=aV.actionFlag;if(OrderInfo.actionFlag==2){setTimeout(function(){$.unecOverlay();offerChange.fillOfferChange(aW,aV);$.jqmRefresh($("#order_fill_content"))},800)}else{$.unecOverlay();_callBackBuildView(aW,aV)}}})};var aA=function(){var aZ=OrderInfo.reloadOrderInfo;var aV=aZ.orderList.custOrderList;var aU=aZ.orderList.orderListInfo;if(aV!=null&&aV!=""){if(aV!=null&&aV.length>0){$(aV).each(function(a0,a1){$(a1.busiOrder).each(function(a7,a2){var ba=a2.boActionType.boActionTypeCd;var a3="";var a6=a2.data;var bb;var a9;if(ba=="7"){a9=a6.boServs;if(a9!=null){$(a9).each(function(bd,bc){a3=bc.state})}}var a5=a2.busiObj;if(ba=="7"){var a4=a5.instId;var a8=a6.boServOrders;$(a6.boServs).each(function(bd,bc){var bf=bc.servId;var be=bc.state;if(be=="DEL"){ap(a4,bf)}})}})});$(aV).each(function(a0,a1){$(a1.busiOrder).each(function(bl,bd){var a4=bd.boActionType.boActionTypeCd;var a5="";var bo=bd.data;var a8;var bm;if(a4=="7"){bm=bo.boServs;if(bm!=null){$(bm).each(function(br,bq){a5=bq.state})}}else{a8=bo.ooOwners;if(a8!=null){$(a8).each(function(br,bq){a5=bq.state;return false})}}var bp=bd.busiObj;if(a4=="S2"){var bk=bp.instId;var bi=bp.offerTypeCd;$(bo.ooRoles).each(function(br,bq){var bs=bq.objInstId;a5=bq.state;if(bi=="2"){if(a5=="DEL"){ah(bs,bk)}}})}else{if(a4=="7"){var bk=bp.instId;var a2=bo.boServOrders;$(bo.boServs).each(function(br,bq){var bt=bq.servId;var bs=bq.state;if(bs=="DEL"){ap(bk,bt)}else{if(bs=="ADD"){$(a2).each(function(bu,bv){var bx=bv.servSpecId;var bw=bv.servSpecName;aN(bk,bx,bw,"N")})}}})}else{if(a4=="S1"){var bf=bd.data;var bc=bp.objId;var bb=bp.accessNumber;var ba=bp.objName;var bj=null;var a6=bo.ooRoles;var a7=bo.busiOrderAttrs;$(bo.ooRoles).each(function(br,bq){bj=bq.prodId;return false});var bn=false;var bh="";$(a7).each(function(bs,bq){var br=bq.itemSpecId;if(br=="111111116"){bh=bq.role;bn=true;return false}});if(bd.boActionType.actionClassCd=="1200"&&bd.boActionType.boActionTypeCd=="S1"&&bd.busiObj.offerTypeCd=="2"){var bc=bp.objId;var bb=bp.accessNumber;var ba=bp.objName;var bj=null;var a6=bo.ooRoles;$(bo.ooRoles).each(function(br,bq){bj=bq.prodId;return false});l(bj,bc,a6)}if(bd.boActionType.actionClassCd=="1200"&&bd.boActionType.boActionTypeCd=="S1"&&bd.busiObj.offerTypeCd=="2"){if(bf.bo2Coupons!=undefined){for(var bl=0;bl<bf.bo2Coupons.length;bl++){var be=bf.bo2Coupons[bl];var a9={couponUsageTypeCd:be.couponUsageTypeCd,inOutTypeId:be.inOutTypeId,inOutReasonId:be.inOutReasonId,saleId:be.saleId,couponId:be.couponId,couponinfoStatusCd:be.couponinfoStatusCd,chargeItemCd:be.chargeItemCd,couponNum:be.couponNum,storeId:be.storeId,storeName:be.storeName,agentId:be.agentId,apCharge:be.apCharge,couponInstanceNumber:be.couponInstanceNumber,ruleId:be.ruleId,partyId:be.partyId,prodId:be.prodId,offerId:be.offerId,attachSepcId:be.attachSepcId,state:be.state,relaSeq:be.relaSeq,num:be.num};OrderInfo.attach2Coupons.push(a9);$("#terminalText_"+be.prodId+"_"+be.attachSepcId).val(be.couponInstanceNumber);AttachOffer.checkTerminalCodeSub(be.prodId,be.attachSepcId)}}}}else{if(a4=="14"){var be=bd.data.bo2Coupons;for(var bl=0;bl<be.length;bl++){if(be[bl].state=="ADD"){var a3=be[bl].couponInstanceNumber;var bg=be[bl].prodId;$("#uim_txt_"+bg).val(a3);order.uiCusts.checkUim(bg,be[bl])}}}}}}})})}}$.each(AttachOffer.openServList,function(){var a0=this;$.each(this.servSpecList,function(){var a2=this;var a1=false;
var a4=aV[0];$.each(a4.busiOrder,function(){var a7=this;if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(a2.servSpecId==this.data.boServOrders[0].servSpecId&&a0.prodId==this.busiObj.instId){a1=true;return false}}});if(!a1){var a3=$("#li_span_"+a0.prodId+"_"+this.servSpecId).parent();var a5=CacheData.getServSpec(a0.prodId,this.servSpecId);if(a5==undefined){return}a3.addClass("deldiv");a5.isdel="Y";AttachOffer.showHideUim(1,a0.prodId,this.servSpecId);var a6=CacheData.getServBySpecId(a0.prodId,this.servSpecId);if(ec.util.isObj(a6)){a3.addClass("deldiv");a5.isdel="Y"}}})});if(aU!=null&&aV!=null){var aW=aU.custOrderAttrs;var aX=aU.isTemplateOrder;var aY=aU.templateOrderName;$(aW).each(function(a1,a2){var a0=a2.itemSpecId;if(a0=="111111118"){var a3=a2.value;if(a3!=null&&a3!=""){$("#order_remark").html(a3)}}});if(aX=="Y"){$("#isTemplateOrder").click();SoOrder.showTemplateOrderName();$("#templateOrderName").val(aY)}}};var aN=function(aZ,a1,aU,a4){var aV=CacheData.getServSpec(aZ,a1);if(aV==undefined){var a0={objId:a1,servSpecId:a1,servSpecName:aU,ifParams:a4,isdel:"C"};var a3={prodSpecId:a1};if(a4=="Y"){var aX=query.prod.prodSpecParamQuery(a3);if(aX==undefined||aX.result==undefined){return}a0.prodSpecParams=aX.result.prodSpecParams;if(a1==CONST.YZFservSpecId){var a2=$("select[name='pay_type_-1']").val();if(a2==undefined){a2=order.prodModify.choosedProdInfo.feeType}if(a2==CONST.PAY_TYPE.AFTER_PAY){for(var aW=0;aW<a0.prodSpecParams.length;aW++){var aY=a0.prodSpecParams[aW];aY.setValue=""}}else{for(var aW=0;aW<a0.prodSpecParams.length;aW++){var aY=a0.prodSpecParams[aW];if(aY.value!=""){aY.setValue=aY.value}else{if(!!aY.valueRange[0]&&aY.valueRange[0].value!=""){aY.setValue=aY.valueRange[0].value}}}}}}CacheData.setServSpec(aZ,a0);aV=a0}i(aZ,aV)};var n=function(aV,aX){var aY=aX.offerSpecId;var aW=CacheData.getExcDepOfferParam(aV,aY);var aU=query.offer.queryExcludeDepend(aW);if(aU!=undefined){a(aU.result,aV,aY,aX.offerSpecName)}};var O=function(a2,aX,aU){var aY=aU.servSpecId;var aW=a2.servSpec.exclude;var a0=a2.servSpec.depend;var a1=a2.servSpec.related;var aZ="";var aV={excludeServ:[],dependServ:[],relatedServ:[]};if(ec.util.isArray(aW)){$.each(aW,function(){var a5=CacheData.getServList(aX);var a3=true;if(a5!=undefined){for(var a4=0;a4<a5.length;a4++){if(a5[a4].isdel=="Y"){if(a5[a4].servSpecId==this.servSpecId){a3=false;break}}}}if(a3){aV.excludeServ.push(this)}})}aV.dependServ.push(this);aV.relatedServ.push(this);if(aZ==""){AttachOffer.addOpenServList(aX,aY,aU.servSpecName,aU.ifParams)}else{$.confirm("开通： "+aU.servSpecName,aZ,{yesdo:function(){AttachOffer.addOpenServList(aX,aY,aU.servSpecName,aU.ifParams);AttachOffer.excludeAddServ(aX,aY,aV)},no:function(){}})}};var l=function(aX,aY,aV){var aU=M(aX,aY);if(aU==undefined){return}var aW=CacheData.getOfferProdStr(aX,aU,0);V(aX,aU);s(aX,aU)};var V=function(aV,aW,aU){if(aW!=undefined){$.each(aW.offerRoles,function(){$.each(this.roleObjs,function(){var aX=aV+"_"+this.objId;$(aU).each(function(aZ,a0){var aY=a0.prodId+"_"+a0.objId;if(aX==aY){this.selQty=1;return false}else{this.selQty=2}})})})}};var s=function(aV,aX){var aY=aX.offerSpecId;var aW=CacheData.getExcDepOfferParam(aV,aY);var aU=query.offer.queryExcludeDepend(aW);if(aU!=undefined){a(aU.result,aV,aY,aX.offerSpecName)}};var a=function(a8,a1,a6,aV){var a2="";var aY={excludeOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(a8!=""){var aX=a8.offerSpec.exclude;var aW=a8.offerSpec.depend;if(ec.util.isArray(aX)){for(var a0=0;a0<aX.length;a0++){var a7=CacheData.getOfferList(a1);var a3=true;if(a7!=undefined){for(var aZ=0;aZ<a7.length;aZ++){if(a7[aZ].isdel=="Y"){if(a7[aZ].offerSpecId==aX[a0].offerSpecId){a3=false;break}}}}if(a3){a2+="需要关闭：   "+aX[a0].offerSpecName+"<br>";aY.excludeOffer.push(aX[a0].offerSpecId)}}}if(aW!=undefined&&ec.util.isArray(aW.offerInfos)){for(var a0=0;a0<aW.offerInfos.length;a0++){a2+="需要开通： "+aW.offerInfos[a0].offerSpecName+"<br>";aY.dependOffer.dependOffers.push(aW.offerInfos[a0].offerSpecId)}}if(aW!=undefined&&ec.util.isArray(aW.offerGrpInfos)){for(var a0=0;a0<aW.offerGrpInfos.length;a0++){var aU=aW.offerGrpInfos[a0];aY.dependOffer.offerGrpInfos.push(aU);a2+="需要开通： 开通"+aU.minQty+"-"+aU.maxQty+"个以下业务:<br>";if(aU.subOfferSpecInfos!="undefined"&&aU.subOfferSpecInfos.length>0){for(var aZ=0;aZ<aU.subOfferSpecInfos.length;aZ++){var a5=aU.subOfferSpecInfos[aZ];a2+='<input id="'+a5.offerSpecId+'" type="checkbox" name="'+aU.grpId+'" value="'+a5.offerSpecId+'">'+a5.offerSpecName+"</input><br>"}}}}}var a4=at(a1,a6);a2=a2+a4;if(a2==""){AttachOffer.addOpenList(a1,a6)}else{a2="<div style='max-height:300px;overflow:auto;'>"+a2+"</div>";CacheData.setOffer2ExcludeOfferSpec(aY);AttachOffer.excludeAddattch(a1,a6,aY);AttachOffer.excludeAddServ(a1,"",K)}};var at=function(aW,aX){var aU=M(aW,aX);K.excludeServ=[];K.dependServ=[];K.relatedServ=[];var aV="";$.each(aU.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){var aY=CacheData.getServSpec(aW,this.objId);if(aY==undefined){var a4=CacheData.getServBySpecId(aW,this.objId);if(a4==undefined){var a1={objId:this.objId,servSpecId:this.objId,servSpecName:this.objName,ifParams:this.isCompParam,prodSpecParams:this.prodSpecParams,isdel:"C"};CacheData.setServSpec(aW,a1);aY=a1}else{aY=a4}}var a3=aY.servSpecId;var a2=CacheData.getExcDepServParam(aW,a3);if(a2.orderedServSpecIds.length==0){}else{var a0=query.offer.queryExcludeDepend(a2);var aZ=paserServDataByObjs(a0.result,aW,aY,aU);if(aZ!=""){aZ=("开通【"+aY.servSpecName+"】功能产品：<br>"+aZ);aV+=(aZ+"<br>")}}}})});return aV};var M=function(aV,aW){var aU=CacheData.getOfferSpec(aV,aW);if(aU==undefined){aU=query.offer.queryAttachOfferSpec(aV,aW);if(!aU){return}CacheData.setOfferSpec(aV,aU)}return aU};var K={excludeServ:[],dependServ:[],relatedServ:[]};var aw=function(aX,aV){var a5=OrderInfo.getAccessNumber(aX);var aW="-1";if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23||OrderInfo.actionFlag==6){if(ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==aX){aW=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{aW=order.prodModify.choosedProdInfo.prodOfferInstId}}var a4=$.trim($("#uim_txt_"+aX).val());var aY={instCode:a4,phoneNum:a5,areaId:OrderInfo.getProdAreaId(aX)};var a0=OrderInfo.getProdSpecId(aX);var a3="";if(CONST.getAppDesc()==0){if(C(aX)){a3=prod.uim.getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID)}else{a3=prod.uim.getMktResCd(a0)}if(ec.util.isObj(a3)){}else{return}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(prod.changeUim.is4GProdInst){aY.onlyLTE="1"}}}var a2={prodId:aX,isWireBusi:"",isWireUIM:false,wireType:0,uimCode:aV.couponInstanceNumber,uimName:""};if(a2.isWireUIM){if(a0==CONST.PROD_SPEC.CDMA){a2.isWireBusi=1}}else{if(a0==CONST.PROD_SPEC.DATA_CARD){a2.isWireBusi=2}}OrderInfo.clearCheckUimData(aX);OrderInfo.checkUimData.push(a2);var a1=aV.couponNum;if(a1==undefined||a1==null){a1=1}var aU={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:aV.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:a1,storeId:aV.storeId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:aV.terminalCode,terminalCode:aV.terminalCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:aX,offerId:aW,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){aU.cardTypeFlag=aV.cardTypeFlag}$("#uim_check_btn_"+aX).attr("disabled",true);$("#uim_check_btn_"+aX).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+aX).attr("disabled",false);$("#uim_release_btn_"+aX).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+aX).attr("disabled",true);if(C(aX)){$("#isMIFI_"+aX).val("yes")}else{$("#isMIFI_"+aX).val("no")}OrderInfo.clearProdUim(aX);OrderInfo.boProd2Tds.push(aU);if(OrderInfo.actionFlag==22&&aV.cardTypeFlag==1&&order.prodModify.choosedProdInfo.productId!="280000000"){AttachOffer.queryCardAttachOffer(aV.cardTypeFlag)}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(a2.isWireUIM&&a2.wireType=="02"&&a0==CONST.PROD_SPEC.DATA_CARD){AttachOffer.addOpenServList(aX,CONST.PROD_SPEC_ID.WIRE_GLOBAL,"天翼宽带-国际及港澳台数据漫游","N");
var aZ=$("#li_"+aX+"_"+CONST.PROD_SPEC_ID.WIRE_GLOBAL);if(aZ.length>0){aZ.find("dd").removeClass("delete").addClass("mustchoose").attr("onclick","")}}}};var C=function(aY){var aX=(Math.abs(aY)-1);if(AttachOffer.openServList.length>aX){var aW=AttachOffer.openServList[aX].servSpecList;for(var aV=0;aV<aW.length;aV++){var aU=aW[aV];if(aU.isdel!="Y"&&aU.isdel!="C"){if(aU.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true}}}}return false};var D=function(aV){for(var aU=0;aU<AttachOffer.openedList.length;aU++){var aW=AttachOffer.openedList[aU];if(aW.prodId==aV){return aW.offerList}}return[]};var B=function(aX,aU){var aV=D(aX);if(ec.util.isArray(aV)){for(var aW=0;aW<aV.length;aW++){if(aV[aW].offerId==aU){return aV[aW]}}}};var ah=function(aY,aW){var a0=$("#li_span_"+aY+"_"+aW).parent();if(a0.attr("class")=="block deldiv"){AttachOffer.addOffer(aY,aW,$span.text())}else{var a1=CacheData.getOffer(aY,aW);if(!ec.util.isArray(a1.offerMemberInfos)){var aU={prodId:aY,areaId:OrderInfo.getProdAreaId(aY),offerId:aW};if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var aX=0;aX<OrderInfo.oldprodInstInfos.length;aX++){if(aY==OrderInfo.oldprodInstInfos[aX].prodInstId){aU.areaId=OrderInfo.oldprodInstInfos[aX].areaId;aU.acctNbr=OrderInfo.oldprodInstInfos[aX].accNbr}}}else{aU.acctNbr=OrderInfo.getAccessNumber(aY)}var a2=order.uiCusts.queryOfferInst(aU);if(a2==undefined){return}var aV=[];$.each(a2.offerMemberInfos,function(){var a4=this.objInstId;var a3=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==a4){a3=true;return false}});if(a3){aV.push(this)}});a1.offerMemberInfos=a2.offerMemberInfos=aV;a1.offerSpec=a2.offerSpec}var aZ="";if(a1.offerSpec!=undefined){aZ=CacheData.getOfferProdStr(aY,a1,1)}a1.isdel="Y";$span.addClass("del");r(aY,a1)}};var aJ=function(aX,aW){var aV=contextPath+"/offer/queryOfferInst";if(typeof(aW)=="function"){$.callServiceAsJsonGet(aV,aX,{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(aY){$.unecOverlay();if(aY.code==0){if(aY.data){aW(aY.data)}}else{if(aY.code==-2){$.alertM(aY.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");var aU=$.callServiceAsJsonGet(aV,aX);$.unecOverlay();if(aU.code==0){if(aU.data){return aU.data}}else{if(aU.code==-2){$.alertM(aU.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}};var r=function(aV,aU){$.each(aU.offerMemberInfos,function(){var aY=this.objInstId;if($("#check_"+aV+"_"+aY).attr("checked")=="checked"){var aW=CacheData.getServ(aV,aY);if(ec.util.isObj(aW)){aW.isdel="Y";var aX=$("#li_"+aV+"_"+aY);aX.removeClass("canshu").addClass("canshu2");aX.find("span").addClass("del")}}})};var ap=function(aW,aY){var aU=$("#li_span_"+aW+"_"+aY).parent();var aX=CacheData.getServ(aW,aY);if(aX!=undefined&&aX!=""){var aU=$("#li_span_"+aW+"_"+aY).parent();var aV=OrderInfo.getProdUim(aW);if(aX.servSpecId=="280000020"&&(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)&&aV.cardTypeFlag=="1"){$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");return}aU.addClass("deldiv");aX.isdel="Y"}};var x=function(aV,aW){if(aW!=undefined){if(aW.servSpecId==""){var aU=$("#li_"+aV+"_"+aW.servId).find("span");aU.removeClass("del");aW.isdel="N"}else{i(aV,aW)}}};var aD=function(aW,aZ,aU){var aY=aZ.servSpecId;var aX=CacheData.getExcDepServParam(aW,aY);if(aX.orderedServSpecIds.length==0){AttachOffer.addOpenServList(aW,aY,aZ.servSpecName,aZ.ifParams)}else{var aV=query.offer.queryExcludeDepend(aX);if(aV!=undefined){au(aV.result,aW,aZ)}}};var au=function(a2,aX,aU){var aY=aU.servSpecId;var aW=a2.servSpec.exclude;var a0=a2.servSpec.depend;var a1=a2.servSpec.related;var aZ="";var aV={excludeServ:[],dependServ:[],relatedServ:[]};if(ec.util.isArray(aW)){$.each(aW,function(){var a5=CacheData.getServList(aX);var a3=true;if(a5!=undefined){for(var a4=0;a4<a5.length;a4++){if(a5[a4].isdel=="Y"){if(a5[a4].servSpecId==this.servSpecId){a3=false;break}}}}if(a3){aZ+="需要关闭：   "+this.servSpecName+"<br>";aV.excludeServ.push(this)}})}if(ec.util.isArray(a0)){$.each(a0,function(){aZ+="需要开通：   "+this.servSpecName+"<br>";aV.dependServ.push(this)})}if(ec.util.isArray(a1)){$.each(a1,function(){aZ+="需要开通：   "+this.servSpecName+"<br>";aV.relatedServ.push(this)})}if(aZ==""){AttachOffer.addOpenServList(aX,aY,aU.servSpecName,aU.ifParams)}else{AttachOffer.addOpenServList(aX,aY,aU.servSpecName,aU.ifParams);AttachOffer.excludeAddServ(aX,aY,aV)}};var i=function(aW,aZ,aU){var aY=aZ.servSpecId;var aX=CacheData.getExcDepServParam(aW,aY);if(aX.orderedServSpecIds.length==0){AttachOffer.addOpenServList(aW,aY,aZ.servSpecName,aZ.ifParams)}else{var aV=query.offer.queryExcludeDepend(aX);if(aV!=undefined){O(aV.result,aW,aZ)}}};var z=function(aW,a5,a6,a3){var a1=aW.split("_")[0];if($("#tr_"+aW)[0]==undefined){var aV=aW+"_"+OrderInfo.SEQ.dealerSeq;var a2=ad(aW,aV);if(a2==undefined){return false}var a4=$("#atr_"+aW);var a8=$('<li name="tr_'+aW+'"></li>');var aZ=$("<dl></dl>");aZ.append("<dd>"+a5+"</dd>");aZ.append("<dd>"+a6+"</dd>");aZ.append(a2);var ba=$("#tr_"+a1).find("input");var a0=1;var aY="";if(ba[0]==undefined){a0=OrderInfo.staff.staffId;aY=OrderInfo.staff.staffName}else{a0=ba.attr("staffId");aY=ba.attr("value")}if(order.ysl!=undefined){var a7=$('<dd><input type="text" id="dealer_'+aV+'" name="dealer_'+aW+'" staffId="'+a0+'" value="'+aY+'"  data-mini="true"></input></dd>');aZ.append(a7)}else{var a7=$('<dd><input type="text" id="dealer_'+aV+'" name="dealer_'+aW+'" staffId="'+a0+'" value="'+aY+'"  data-mini="true"  readonly="readonly"></input></dd>');aZ.append(a7)}var aU='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';aU+="<button data-mini=\"ture\" onclick=\"order.main.queryStaff('dealer','"+aV+"');\">选择</button></div>";aU+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+aW+"')\">添加</button></div>";aU+=' <div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';aZ.append(aU);var aX=$("<dd></dd>");var a9=$('<select id="dealerChannel_'+aV+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){a9.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{a9.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});aX.append(a9);aX.append('<label class="f_red">*</label>');aZ.append(aX);a8.append(aZ);$("#dealerTbody").append(a8);$.jqmRefresh($("#dealerTbody"));OrderInfo.SEQ.dealerSeq++}};return{initSub:ay,addAttachDealerSub:z,checkServExcludeDependSub:aD,openServ:x,closeServSub:ap,queryOfferInst:aJ,getOfferList:D,delServByOffer:r,getOffer:B,delOfferSub:ah,getIsMIFICheck:C,checkUim:aw,setSpec:M,servExDepReByRoleObjs:at,checkOfferExcludeDependSub:s,setServ2OfferSpecSub:V,addOfferSpecSub:l,checkServExcludeDepend:i,openServSpecSub:aN,opeSer:F,showoffer:aP,loadData:aA,buildMainView:G,offerChangeView:aF,buyService:I,queryData:j,searchPack:ax,offerinit:U,packageQuery:aQ,showCustAuth:Q,showCustCreate:h,custAuth:X,getCustInfo:aT,custReset:H,btnQueryCustProd:N,btnQueryCustProdMore:ag,jumpAuth:ak,identidiesTypeCdChoose:aL,custidentidiesTypeCdChoose:aK,choosedCustInfo:A,partyTypeCdChoose:ac,chooseArea:am,chooseAllArea:al,newCustChooseArea:P,prodChooseArea:m,init:an,partyProfiles:v,profileTabLists:aI,queryCust:Y,queryCustDetail:t,changeLabel:p,jumpAuthflag:aO,orderBtnflag:aC,custCreateButton:e,isAppointNum:aq,preQueryCustChooseArea:W,linkSelectPlan:aG,back:aS,fromProvFlag:aj,provIsale:ae,addLi:g,delLi:E}})();$(function(){});CommonUtils.regNamespace("main","home");main.home=(function(){var g=[];var f=[];var h=function(p){var o={};if(p){o={bulletinId:p}}$.callServiceAsHtmlGet(contextPath+"/pad/main/notice",$.param(o),{before:function(){if(!$.isEmptyObject(o)){$.ecOverlay("公告查询中,请稍等...</strong>")}},always:function(){if(!$.isEmptyObject(o)){$.unecOverlay()}},done:function(v){if(!$.isEmptyObject(o)){$.popup("#dlg_notice_detail",v.data,{transition:"slidedown"});
return}if(!v&&!(v.data)){return}$("#div_notice").html(v.data);var t=$("#input_interval_time").val();if(t==""){t=3000}var s=40;var r="slow";var q=null;var x=$("#span_scroll_notice");var w=function(){q=setInterval(function(){if(x.scrollTop()>=$("#span_notice_body").outerHeight()){x.scrollTop(x.scrollTop()-$("#span_notice_body").outerHeight())}x.animate({scrollTop:x.scrollTop()+s+"px"},r,function(){})},t)};var u=function(){window.clearInterval(q)};$("#span_notice_hide").html($("#span_notice_body").html());x.bind("mouseover",function(){u()});x.bind("mouseout",function(){w()});$("#span_notice_body a").on("tap",function(){h($(this).attr("nid"))});$("#span_notice_hide a").on("tap",function(){h($(this).attr("nid"))});w()}})};var c=function(){$.callServiceAsHtmlGet(contextPath+"/pad/menu/mainShortcut.html",{},{before:function(){$("#ul_quick_set").animate({"margin-left":"1400px"},500)},done:function(o){var p=$("#ul_quick_set");p.html(o.data).delay(1000).animate({"margin-left":"0px"},1500);p.find("li[ctrl='add']").off("tap").on("tap",function(){$(this).off("tap").on("tap",b)});p.find("li[ctrl!='add']").off("tap").on("tap",function(){window.location.href=$(this).attr("url")})}})};var i=function(){$("#div_notice").hide();$("#div_user_info").hide();$("#div_quick_set").hide();$("#ul_quick_set").hide()};var n=function(){$("#div_notice").hide();$("#ul_busi_area").hide();$("#div_user_info").hide();$("#div_quick_set").hide();$("#ul_quick_set").hide()};var b=function(){var o=$.callServiceAsJson(contextPath+"/staff/login/isLogin");if(o.code!=0){login.windowpub.alertLoginWindow(o.data);return}$.callServiceAsHtmlGet(contextPath+"/pad/menu/configPrepare.html",{},{before:function(){$.ecOverlay("<strong>查询菜单中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(p){if(!p||!p.data){$.alert("提示","抱歉,没有找到可供配置的菜单信息.");return}$.popup("#dlg_shortcut_quickset",p.data,{width:$(window).width()-200,height:$(window).height(),contentHeight:$(window).height()-120,afterClose:function(){c()}});$("#dlg_shortcut_quickset li").each(function(){var q=$(this);q.off("tap").on("tap",function(){if($("#dlg_shortcut_quickset li.set").length>=8&&!q.hasClass("set")){$.alert("提示","最多允许添加8个图标,请取消已选图标后再添加！");return}q.toggleClass("set");var r={};if(q.hasClass("set")){r={resourceId:q.attr("rid"),actionType:"ADD"}}else{r={resourceId:q.attr("rid"),actionType:"DEL"}}l(r)})})}})};var l=function(o){var p=contextPath+"/menu/setShortcut";var q=o;$.callServiceAsJson(p,q,{before:function(){$.ecOverlay("保存中,请稍等...")},always:function(){$.unecOverlay()},done:function(r){if(r.code!=0){$.alertM(r.data)}},fail:function(r){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var a=function(){$.callServiceAsJson(contextPath+"/staff/login/padloginout",{},{done:function(o){if(o.code==0){MyPlugin.exitSystem([],function(p){},function(p){})}},fail:function(o){MyPlugin.exitSystem([],function(p){},function(p){})}})};var e=function(){$("#a_logobar").off("tap").on("tap",function(){$("#navbar").slideToggle(400)});$("#a_logobar").off("taphold").on("taphold",function(){window.location.href=contextPath+"/pad/main/home"})};var d=function(){h();c();j();m()};var m=function(){var o=$("#_session_staff_info");OrderInfo.staff={staffId:o.attr("staffId"),staffCode:o.attr("staffCode"),staffName:o.attr("staffName"),channelId:o.attr("channelId"),channelName:o.attr("channelName"),areaId:o.attr("areaId"),areaCode:o.attr("areaCode"),areaName:o.attr("areaName"),areaAllName:o.attr("areaAllName"),orgId:o.attr("orgId"),distributorId:o.attr("partnerId"),operatorsId:o.attr("operatorsId"),operatorsName:o.attr("operatorsName"),operatorsNbr:o.attr("operatorsNbr"),soAreaId:o.attr("areaId"),soAreaCode:o.attr("areaCode"),soAreaName:o.attr("areaName"),soAreaAllName:o.attr("areaAllName")}};var j=function(){$("#a_sys_exit").off("tap").on("tap",a);$("#a_channel_exchange").off("tap").on("tap",function(){$("#dlg-exchange-channel").popup("open");$("#dlg-exchange-channel li").on("tap",function(){k($(this).find("a"))})});e();$("#div_quick_set a").off("tap").on("tap",b);order.cust.mgr.init()};var k=function(o){$.confirm("信息","您当前正在进行渠道切换的操作，点击确定按钮，将清除当前页所有数据！",{yes:function(){var p=contextPath+"/staffMgr/setCurrentChannel";var r={channelId:$(o).attr("cnlid")};var q=$.callServiceAsJson(p,r);if(q.code==0){$("#dlg-exchange-channel").popup("close");if(!$("#dlg-exchange-channel").hasClass("ui-page-active")){window.location.reload()}}else{$.alert("提示","渠道设定异常，请稍后再试")}},no:function(){$("#dlg-exchange-channel").popup("close")}})};return{saveShortcut:l,hideMainIco:i,hideMainAllIco:n,mainInit:d}})();$(function(){main.home.mainInit()});