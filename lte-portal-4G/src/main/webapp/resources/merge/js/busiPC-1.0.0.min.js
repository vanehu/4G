CommonUtils.regNamespace("order","writeCard");var ty_plugin=null;var productId="";var g_realWriteCard=true;if($.browser.msie){try{ty_plugin=new ActiveXObject("HBW0001.HBW0001Ctrl.1")}catch(e){}}order.writeCard=(function(){var f={busiComponentCode:"",session:{staffId:"",staffSerial:"",staffAreaId:"",staffAreaName:"",staffName:"",staffNumber:"",channelId:"",channelName:""},renderTo:"",params:{switchId:"",phoneNumber:"",lanId:"",dstOrgId:"",dstSysId:"",scene:"",terminalCode:""},config:{rscAreaId:"",cardAreaId:"",isUnLoad:true}};var l="";var h=false;var k=false;var p="";var b="N";var r=[];var j=null;var n={iccid:"",imsi:"",imsig:"",data:"",dataLength:"0",state:"N",prodId:""};this._cardDllInfoJson={dllId:"",dllName:"","":"",password:"",factoryCode:""};var s={serialNumber:"",factoryCode:"",cardTypeId:"",cardName:"",materialId:"",canWrite:"N"};var g;var o=function(u){var t=OrderInfo.getAccessNumber(u);if(t==""){$.alert("提示","请选择号码!","confirmation");return}ec.form.dialog.createDialog({id:"-card"+u,width:350,initCallBack:function(){$("#write_card_phone_number"+u).val(t);g=document.getElementById("ocx"+u);$("#btnReadCard"+u).click(function(){$("#btnReadCard"+u).attr("disabled","disabled");if(!order.writeCard.readCard(u)){$("#serialNum"+u).val("");$("#cardTypeId"+u).val("")}else{$.alert("提示","成功读卡!","confirmation")}$("#btnReadCard"+u).removeAttr("disabled")});$("#btnWriteCard"+u).click(function(){$("#btnWriteCard"+u).attr("disabled","disabled");var v=order.writeCard.writeCard(u);if(!v){return}$("#btnWriteCard"+u).removeAttr("disabled");if(v){$.modal.close()}})},submitCallBack:function(w,v){}})};var a=function(x){h=true;if(!g_realWriteCard){var u=new Date();n.imsi="1111111111111"+u.getMilliseconds();n.iccid="89860314105350023801";if(n.iccid.length==20){n.iccid=n.iccid.substr(0,n.iccid.length-1)}$("#serialNum"+x).val(n.iccid);$("#serialNum").val("33333333333"+u.getMilliseconds());s.cardTypeId=("33333333333"+u.getMilliseconds()).substr(5,5);if(!m()){return false}if(ec.util.isObj(s.cardTypeId)){if(prod.changeUim.is4GProdInst&&(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)){if(CONST.UIMTYPE3G4G.IS3G==prod.uim.getCardType("","",s.serialNumber)){$.alert("信息提示","您已开通了【4G（LTE）上网】功能产品，而UIM卡是3G卡，请使用4G的白卡！");return false}}}return true}var A=null;try{A=ec.util.defaultStr(g.strGetICCID())}catch(B){$.alert("提示","加载读卡插件失败,请检查是否已正确安装插件!错误信息："+B.message,"error");return false}var v=A.substring(A.length-4,A.length);if(v==""){$.alert("提示","读取卡失败!请确认卡连接是否正常!");return false}if(x==undefined){if(v!=""&&v!="FFFF"){$.alert("提示","卡片已有数据,不能重复写入!");return false}}var D=A;var y="";var I=ec.util.defaultStr(g.GetEmptyCardFile());var E=I.substring(I.length-5,I.length);if(E!=""&&E!="FFFF"){$("#selUim").val("2");var z=contextPath+"/mktRes/writeCard/getAsciiToHex";var C=I.substring(I.length-4,I.length);var t={asciiFStr:C};var w=$.callServiceAsJson(z,t);var H=I.substring(0,I.length-4)+w.data.asciiStr;$("#uim_txt_"+x).val(H);$("#resultCardAsciiFStr").val(H);$("#resultCardNo").val(I);$("#selUimType").val("3");$("#uim_lable").attr("disabled",true);y=I;factoryCode=I.substring(I.length-2,I.length)}var G=OrderInfo.getProdAreaId(x);if(ec.util.defaultStr(y)!=""){s.serialNumber=y;s.factoryCode=factoryCode;s.cardTypeId=y.substr(5,5)}if(!m()){return false}if(ec.util.isObj(s.cardTypeId)){if(prod.changeUim.is4GProdInst&&(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)){if(CONST.UIMTYPE3G4G.IS3G==prod.uim.getCardType("","",s.serialNumber)){$.alert("信息提示","您已开通了【4G（LTE）上网】功能产品，而UIM卡是3G卡，请使用4G的白卡！");return false}}}if(D=="FFFFFFFFFFFFFFFFFFFF"||D=="00000000000000000000"){s.canWrite="Y";$("#btnWriteCard"+x).css("display","");$("#serialNum"+x).val(s.serialNumber);$("#iccid"+x).val(n.iccid);$("#imsi"+x).val(n.imsi);$("#cardTypeId"+x).val(s.cardTypeId)}else{s.canWrite="N";if(f.params.scene=="1"){$("#btnWriteCard"+x).css("display","none")}if(y!=null){$("#serialNum"+x).val(s.serialNumber);$("#cardTypeId"+x).val(s.cardTypeId)}else{var F=D.substring(0,19);$("#serialNum"+x).val(F)}}return true};var c=function(B){k=false;productId=B;if(!g_realWriteCard){k=true;$.alert("提示","写卡成功!","confirmation");$("#uim_txt_"+B).val(n.iccid);var v={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:"10",couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:"1",storeId:"8230010",storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:"8230007407312006106",ruleId:"",partyId:OrderInfo.cust.custId,prodId:B,state:"ADD",relaSeq:""};if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){v.offerId="-1"}else{v.offerId=order.prodModify.choosedProdInfo.prodOfferInstId}OrderInfo.clearProdUim(B);OrderInfo.boProd2Tds.push(v);return true}if(!h){$.alert("提示","请先读卡!","error");return false}if(!a()){$.alert("提示","写卡前验证读卡验证时读卡失败，请确认设备是否连接好!","error");return false}var F=$("#pesn").val();if(F!=undefined&&F!=""&&F!=null){cardType=s.serialNumber.substr(6,2);if(cardType!="10"){$.alert("提示","黑莓手机终端配套的手机卡必须是支持EVDO的CG双模卡，请换支持EVDO的CG双模卡进行写卡!","error");return false}}if(!q()){return false}var w=g.DisConnectReader();if(w!="0"){$.alert("提示","写卡之前,断开写卡器失败!","error");return false}var C=g.GetRandNum();if(C.length!=16){$.alert("提示","写卡异常:获取随机数失败！"+result,"error");return false}var E=C;if(E.length!=16){$.alert("提示","写卡异常:从卡商组件获取随机数不是8字节长的随机数！","error");return false}if(_cardDllInfoJson.dllPassword==""){$.alert("提示","写卡异常(组件鉴权密码不可为空)，请检查！","error");return false}var t=null;serviceName=contextPath+"/mktRes/writeCard/authCode";try{var x={randomNum:E,dllPassword:_cardDllInfoJson.password,factoryCode:_cardDllInfoJson.factoryCode,authCodeType:_cardDllInfoJson.authcodeType};var A=$.callServiceAsJson(serviceName,x);var z;if(A.code==0){z=A.data}else{$.alertM(A.data);return false}var u=z.code;if(u!=null&&u=="POR-0000"){t=z.authCode}else{$.alert("提示","用获取的随机数生成鉴权码失败！","error");return false}}catch(D){$.alert("提示","用获取的随机数生成鉴权码异常!"+D.message,"error");return false}var y=g.Authentication(t);var G=y;if(G!="0"){$.alert("提示","鉴权失败！"+y,"error");return false}if(!_applyResourceData(B)){return false}k=true;var H=g.YXPersonalize(t,"",1,n.data,"");if(H!="0"){$.alert("提示","写卡失败，请将白卡取出！错误编码="+H+"详细错误请联系卡商["+_cardDllInfoJson.remark+"]确认","error");_completeWriteCard("1",H);return false}else{if(_completeWriteCard("00000000",H)){$.alert("提示","恭喜，您已经成功写卡！");$("#uim_check_btn_"+B).attr("disabled",true);$("#uim_check_btn_"+B).removeClass("purchase").addClass("disablepurchase");return true}else{$.alert("提示","写卡成功，但卡资源下发异常","error");return false}}return false};var q=function(){_cardDllInfoJson={authcodeType:"",dllId:"",dllName:"",dllVersion:"",password:"",factoryCode:""};var v=s.serialNumber;if(v!=undefined){var u=s.factoryCode;if(!_getCardDllInfo(u)){alert("提示","不能把厂商写卡组件下载到本机客户端!","error");return false}var t=_updateOrLoadDll();if(!t){return false}return true}else{$.alert("提示","卡序列号值(serialNum="+v+")不符合规范!","error");return false}};var i=function(C){if(confirm("请你确定，你是否有权限进行清除卡数据操作！！")){if(!a(C)){$.alert("提示","清卡前验证读卡验证时读卡失败，请确认设备是否连接好","error");return false}if(!q(C)){return false}var D=j.TyJsRps_CheckData();var B=D.substring(D.length-4,D.length);if(B!="0000"){$.alert("提示","卡片合法性检测失败，请检查卡是否正确插入写卡设备中！","error");return false}var y=D.substr(0,1);if(y!=0){$.alert("提示","您插入的是成品卡，可以进行清卡操作！","error")}else{$.alert("提示","您插入的不是成品卡，不可以进行清卡操作！","error");return false}var D=j.TyJsRps_GetRandNum();var B=D.substring(D.length-4,D.length);if(B!="0000"){$.alert("提示","获取随机数失败！","error");return false}randomNum=D.substring(0,D.length-5);if(randomNum.length!=16){$.alert("提示","从卡商组件获取随机数不是8字节长的随机数！","error");return false}var t=null;var u=new bss.serviceframework.ajax.client({timeout:40000,timeoutHandle:function(){$.alert("提示","超时","error");return false}});var z="bss.writeCard.writeCardFacade.getAuthCode";var u=new bss.serviceframework.ajax.client({timeout:40000,timeoutHandle:function(){$.alert("提示","超时","error");return false}});try{var w=u.callServiceAsJson(z,{randomNum:randomNum,dllInfo:_cardDllInfoJson});var v=w.getBodyAsJson();var A=v.flag;if(A!=null&&A=="0"){t=v.authCode
}else{$.alert("提示","利用组件鉴权密码对随机数进行3DES加密失败！","error")}}catch(x){$.alert("提示","请求组件鉴权密码对随机数进行3DES加密失败!","error");return false}var D=j.TyJsRps_ClearCard(t);var B=D.substring(D.length-4,D.length);if(B!="0000"){alert("清除卡数据失败！");return false}else{alert("除卡数据成功！")}var D=j.TyJsRps_CheckData();var B=D.substring(D.length-4,D.length);if(B!="0000"){$.alert("提示","卡片合法性检测失败，请检查卡是否正确插入写卡设备中！","error");return false}var y=D.substr(0,1);if(y==0){}_unloadDll(C);return true}};_getCardDllInfo=function(w,B){_cardDllInfoJson=null;try{if(w!=undefined){var z=$("#writeCardNewDLL").val();if(z=="ON"){var y=contextPath+"/mktRes/writeCard/cardDllInfo";var u={factoryCode:w,cardType:"newCard"};var t;var v=$.callServiceAsJson(y,u);if(v.code==0){t=v.data.cardDllInfo}else{$.alertM(v.data);return false}var A=t.dllId;if(A==undefined||A==null||A==""){$.alert("提示","卡商(编码="+w+")获取不到对应的组件信息！","error");return false}_cardDllInfoJson=t}else{var y=contextPath+"/mktRes/writeCard/cardDllInfo";var u={factoryCode:w,cardType:"oldCard"};var t;var v=$.callServiceAsJson(y,u);if(v.code==0){t=v.data.cardDllInfo}else{$.alertM(v.data);return false}var A=t.dllId;if(A==undefined||A==null||A==""){$.alert("提示","卡商(编码="+w+")获取不到对应的组件信息！","error");return false}_cardDllInfoJson=t}return true}else{$.alert("提示","卡商编码值不可为空！","error");return false}}catch(x){$.alert("提示","获取卡商组件信息时异常!"+x.message,"error");return false}};_updateOrLoadDll=function(){var w=new ActiveXObject("Scripting.FileSystemObject");try{w.GetFile("C:\\WINDOWS\\system32\\"+_cardDllInfoJson.dllName+".DLL");var v=contextPath+"/mktRes/writeCard/writecardLog";var y={factoryCode:_cardDllInfoJson.factoryCode,authCodeType:_cardDllInfoJson.authCodeType,version:_cardDllInfoJson.dllName,serviceCode:OrderInfo.busitypeflag,isUpdate:"0",cardSource:_cardDllInfoJson.remark};$.callServiceAsJson(v,y)}catch(x){$("#cardupdate").attr("href",contextPath+"/card/"+_cardDllInfoJson.dllName+".dll");$("#writeTitle").html("写卡组件更新");$("#rcard").hide();$("#dllName").html(_cardDllInfoJson.dllName+".DLL");$("#cardt").show();var v=contextPath+"/mktRes/writeCard/writecardLog";var y={factoryCode:_cardDllInfoJson.factoryCode,authCodeType:_cardDllInfoJson.authCodeType,version:_cardDllInfoJson.dllName,serviceCode:OrderInfo.busitypeflag,isUpdate:"1",cardSource:_cardDllInfoJson.remark};$.callServiceAsJson(v,y);return false}var z=g.TransferDll(_cardDllInfoJson.dllName+".DLL");if(z!="0"){$.alert("提示","您插入白卡的卡商写卡组件不存在，请将组件下载保存到C:\\WINDOWS\\system32 目录下！","error");var u=contextPath+"/card/"+_cardDllInfoJson.dllName+".DLL";location.href=u;return false}var t=g.GetDllVersion();if(t!=_cardDllInfoJson.dllVersion){$.alert("提示","您当前使用的卡组件版本为["+t+"]，请下载更新至最新的版本["+_cardDllInfoJson.dllVersion+"]后重新写卡。");return false}return true};_applyResourceData=function(w){n={iccid:"",imsi:"",data:"",dataLength:"0",state:"N",prodId:""};var z=contextPath+"/mktRes/writeCard/cardInfo";try{var x=OrderInfo.getAreaCode(w);if(x==undefined||x==""){x=OrderInfo.staff.areaCode}var u={factoryCode:_cardDllInfoJson.factoryCode,authCodeType:_cardDllInfoJson.authCodeType,hmUimid:"",cardNo:s.cardTypeId,phoneNumber:OrderInfo.getAccessNumber(w),areaId:OrderInfo.getProdAreaId(w),areaCode:x,fromAreaCode:OrderInfo.staff.areaCode};var B;var v=$.callServiceAsJson(z,u);if(v.code==0){B=v.data.cardInfo;l=v.data.TransactionID}else{$.alertM(v.data);return false}var A=B.flag;if(A!=undefined&&A=="0"){n={iccid:"",imsi:"",imsig:"",data:"",state:"Y",uimid:"",sid:"",accolc:"",nid:"",akey:"",pin1:"",pin2:"",puk1:"",puk2:"",imsilte:"",prodId:""};n.iccid=B.iccid;n.imsi=B.imsi;n.imsig=B.imsig;n.uimid=B.uimid;n.sid=B.sid;n.accolc=B.accolc;n.nid=B.nid;n.akey=B.akey;n.pin2=B.pin2;n.pin1=B.pin1;n.puk1=B.puk1;n.puk2=B.puk2;n.imsilte=B.imsilte;n.data=B.data;n.dataLength=B.dataLength;n.prodId=w;return true}else{var t=B.msg;if(t!=undefined){$.alert("提示","请求可写卡的资源数据失败:"+t,"error")}else{$.alert("提示","请求可写卡的资源数据失败","error")}return false}}catch(y){$.alert("提示","请求可写卡的资源数据异常!"+y.message,"error");return false}};_completeWriteCard=function(D,A){var x=contextPath+"/mktRes/writeCard/completeWriteCard";var z={areaId:OrderInfo.getProdAreaId(n.prodId),InoutInfo:{ApplyNo:"001",InoutId:"",BillType:"2",SaleNo:"",BatchId:"",OperationType:"1100",MktResStoreId:"",ChannelId:OrderInfo.staff.channelId,AreaId:OrderInfo.getProdAreaId(n.prodId),StaffId:OrderInfo.staff.staffId},MktResInstInfos:[{MktResInstInfo:{BaseInfo:{MktResTypeCd:"",StatusCd:"2",MktResId:"",MktResCd:s.cardTypeId,MktResInstCode:s.serialNumber,SalesPrice:"0",CostPrice:"0",Quantity:"1",Unit:"101"},AttrList:[{AttrId:"60020005",AttrValue:n.iccid},{AttrId:"60020002",AttrValue:n.imsi},{AttrId:"60020003",AttrValue:n.imsig},{AttrId:"60020004",AttrValue:n.imsilte},{AttrId:"65010026",AttrValue:n.pin1},{AttrId:"65010027",AttrValue:n.pin2},{AttrId:"65010028",AttrValue:n.puk1},{AttrId:"65010029",AttrValue:n.puk2},{AttrId:"65010030",AttrValue:n.adm},{AttrId:"65010033",AttrValue:n.uimid},{AttrId:"65010035",AttrValue:n.akey},{AttrId:"65010037",AttrValue:n.nid},{AttrId:"65010038",AttrValue:n.accolc},{AttrId:"60029003",AttrValue:OrderInfo.staff.channelId},{AttrId:"60029004",AttrValue:_cardDllInfoJson.remark},{AttrId:"60029005",AttrValue:g.GetDllVersion()},{AttrId:"65010019",AttrValue:OrderInfo.getProdAreaId(n.prodId)}]}}]};var t={imsi:n.imsi,iccserial:s.serialNumber,iccid:n.iccid,resultCode:D,resultMessage:"写卡器返回结果编码"+A,phoneNumber:OrderInfo.getAccessNumber(n.prodId),cardType:s.cardTypeId,eventType:"2",areaId:OrderInfo.getProdAreaId(n.prodId),serviceCode:OrderInfo.busitypeflag,TransactionID:l,remark:_cardDllInfoJson.remark,srInParam:z};try{var v;var u=$.callServiceAsJson(x,t);v=u.data;if(!u){$.alert("提示","<br/>调用卡资源回填到卡管系统异常,请稍后重试。");return}if(u.code==-2){$.alertM(u.data);return}else{if(u.code!=0){$.alert("提示","<br/>调用卡资源回填到卡管系统异常,请稍后重试。");return}}if(v.code!=0){$.alert("提示","调用卡资源回填到卡管系统异常！"+v.message,"error");return}if(u.code==0){var C=OrderInfo.getAccessNumber(n.prodId);var y={instCode:$("#resultCardAsciiFStr").val(),phoneNum:C,remark:$("#selUimType").val(),areaId:OrderInfo.getProdAreaId(n.prodId)};var B=contextPath+"/mktRes/writeCard/intakeSerialNumber";$.callServiceAsJson(B,y)}_backFillOrderCardInfo(v.result);return true}catch(w){$.alert("提示","调用卡资源回填到卡管系统异常！"+w.message,"error");return false}};_backFillOrderCardInfo=function(F){if(n.iccid.length==20){n.iccid=n.iccid.substr(0,n.iccid.length-1)}$("#uim_txt_"+n.prodId).val($("#resultCardAsciiFStr").val());var u={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:F.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:"1",storeId:F.mktStoreId,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:s.serialNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:n.prodId,offerId:"",state:"ADD",cardTypeFlag:2,uimType:"2",relaSeq:""};if(ec.util.isObj(s.cardTypeId)){var A=prod.uim.getCardType("","",s.serialNumber);if(CONST.UIMTYPE3G4G.IS4G==A){u.cardTypeFlag=1}if(prod.changeUim.is4GProdInst&&(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)){if(CONST.UIMTYPE3G4G.IS3G==A){$.alert("信息提示","您已开通了【4G（LTE）上网】功能产品，而UIM卡是3G卡，请使用4G的白卡！");return false}}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){u.offerId="-1"}else{u.offerId=order.prodModify.choosedProdInfo.prodOfferInstId}OrderInfo.clearProdUim(n.prodId);OrderInfo.boProd2Tds.push(u);if((OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)&&u.cardTypeFlag==1&&order.prodModify.choosedProdInfo.productId!="280000000"){AttachOffer.openServList=[];AttachOffer.openList=[];AttachOffer.queryCardAttachOffer(u.cardTypeFlag)}if(OrderInfo.actionFlag!=1&&order.prodModify.choosedProdInfo.prodClass=="3"&&u.cardTypeFlag==1){$("#isShow_"+prodId).show();var D=OrderInfo.getProdSpecId(prodId);var v={prodSpecId:D,offerSpecIds:[],queryType:"3",prodId:productId,partyId:OrderInfo.cust.custId,ifCommonUse:"",if3Up4:"Y"};var C=order.prodModify.choosedProdInfo;var w=C.accNbr;v.acctNbr=w;if(!ec.util.isObj(C.prodOfferId)){C.prodOfferId=""}var x=CacheData.getOfferMember(C.prodInstId).offerRoleId;
if(x==undefined){x=""}v.offerRoleId=x;v.offerSpecIds.push(C.prodOfferId);var z=query.offer.queryCanBuyAttachSpec(v);if(z!=undefined&&z.resultCode=="0"&&z.result.offerSpecList.length>0){var B='<form id="promotionForm"><table>';var t="";var y="";t=t+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+w+"><br>";$.each(z.result.offerSpecList,function(){var G=this;y+='<option value="'+this.offerSpecId+'">'+this.offerSpecName+"</option>"});t+=y+"</select></td></tr>";B+=t;var E;$.confirm("促销包选择",B,{yes:function(){},no:function(){}});$("#promotionForm").bind("formIsValid",function(H,G){E=$("#"+w+" option:selected").val();$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove();AttachOffer.selectAttachOffer(productId,E)}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}}};var m=function(){var t=$.callServiceAsJson(contextPath+"/mktRes/writeCard/getCardType",{});if(t.code==0){if(t.data){_4GCARDS=[];for(var u=0;u<t.data.length;u++){if(t.data[u].COLUMN_VALUE!="00311"){_4GCARDS.push(t.data[u].COLUMN_VALUE)}}return true}}else{$.alertM(t.data);return false}return false};return{writeReadCard:o,readCard:a,writeCard:c,getCardType:m}})();CommonUtils.regNamespace("order","area");var ztree=null;var areaType=null;var areaNameVal="";order.area=(function(){var g=function(r,o,q,s,p){l(r,o,q,s,contextPath+"/orderQuery/areaTreeManger",null,p)};var j=function(q,o,p,s,r){l(q,o,p,s,contextPath+"/orderQuery/areaTree",r)};var f=function(r,o,q,s,p){l(r,o,q,s,contextPath+"/orderQuery/areaTreeQueryManger",null,p)};var l=function(s,u,r,v,p,x,q){if(!login.windowpub.checkLogin()){return}var w=r;var t=u;var o=p+"?areaType="+s+"&areaLeve="+v+"&areaLimit="+q;$.ligerDialog.open({width:350,height:350,title:"请选择地区(*不可选)",url:o,buttons:[{text:"确定",onclick:function(C,z){if(!ztree){return}var B=ztree.getSelected();if(B){if(B.data.isAllRegionFlag=="Y"||r=="p_password_areaId"){if(s=="bill/preQueryBalance"||s=="bill/prePayBalance"||s=="bill/reversewriteoffcash"){if(!B.data.regionCode||B.data.regionCode==""){$.alert("提示","请选择本地网（地市级）地区");return}}var A=B.data.commonRegionId;A=(""+A).replace("ch","");$("#"+w).val(A);$("#"+w).attr("areaCode",B.data.regionCode);var y=areaNameVal.split(">");if(y.length>2){$("#"+t).val($.trim(y[1])+" > "+$.trim(y[2]))}else{$("#"+t).val(areaNameVal)}if(x){x(A,B.data.regionCode,areaNameVal)}z.close();obj=areaNameVal;if(s=="prod/preProdQuery"){if(product.query.areaId!=$("#p_areaId").val()){if($("#custName").val()!=""||$("#num").val()!=""){$.alert("提示","地区已变更，请重新定位产品")}$("#prodList").html("");$("#custName").val("").attr("name","");$("#num").val("");product.query.areaId=$("#p_areaId").val()}}if(s=="acct/preQueryAccount"){if(account.query.areaId!=$("#p_areaId").val()){if($("#custName").val()!=""||$("#num").val()!=""){$.alert("提示","地区已变更，请重新定位帐户")}$("#acctList").html("");$("#custName").val("").attr("name","");$("#num").val("");account.query.areaId=$("#p_areaId").val()}}}else{alert("当前地区不可选！")}}else{alert("请选择地区！")}}},{text:"取消",onclick:function(z,y){y.close()}}]})};var i=function(o,q,r,p){if(q!="p_password_areaId"){if(!login.windowpub.checkLogin()){return}}var s=q;var t=o;$.ligerDialog.open({width:350,height:350,title:"请选择地区",url:contextPath+"/orderQuery/areaTreeAll?areaLeve="+r+"&areaLimit="+p,buttons:[{text:"确定",onclick:function(w,u){if(!ztree){return}var v=ztree.getSelected();if(v){if(v.data.isAllRegionFlag=="Y"||q=="p_password_areaId"){$("#"+s).val(v.data.commonRegionId);$("#"+s).attr("areaCode",v.data.regionCode);$("#"+t).val(areaNameVal);u.close()}else{alert("当前地区不可选！")}}else{alert("请选择地区！")}}},{text:"取消",onclick:function(v,u){u.close()}}]})};var k=function(o,q,s,p,r){if(!login.windowpub.checkLogin()){return}var t=q;var u=o;$.ligerDialog.open({width:350,height:350,title:"请选择地区",url:contextPath+"/orderQuery/areaTreeAll?areaLeve="+s+"&areaLimit="+p+"&areaId="+r,buttons:[{text:"确定",onclick:function(x,v){if(!ztree){return}var w=ztree.getSelected();if(w){if(w.data.isAllRegionFlag=="Y"||q=="p_staff_areaId"){$("#"+t).val(w.data.commonRegionId);$("#"+t).attr("areaCode",w.data.regionCode);$("#"+u).val(areaNameVal);v.close()}else{}}else{}}},{text:"取消",onclick:function(w,v){v.close()}}]})};var n=null;var a;var c;var m=function(o,p){a=p;c=o;n=$.ligerDialog.open({width:400,height:320,title:"请选择地区",url:contextPath+"/orderQuery/tree_flat",buttons:[{text:"取消",onclick:function(r,q){q.close()}}]})};var b=function(p,o){if(n!=null){if(c&&$("#"+c)){$("#"+c).val(p)}if(a&&$("#"+a)){$("#"+a).val(o)}n.close()}};var h=function(){$.unecOverlay();$("#dic_mess").hide();$("#commonRegionTree").show()};return{areaChecked:b,flatAreaPage:m,chooseAreaTree:j,chooseAreaTreeAll:i,chooseAreaTreeCurrent:k,chooseAreaTreeManger:g,dicInitEnd:h,chooseAreaTreeQueryManger:f}})();CommonUtils.regNamespace("prod","changeUim");prod.changeUim=(function(){var b=null;var g=function(){var k=order.prodModify.choosedProdInfo;var n={areaId:OrderInfo.staff.soAreaId,custId:OrderInfo.cust.custId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,boInfos:[{boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD,instId:k.prodInstId,specId:CONST.PROD_SPEC.CDMA}]};var j=$("#DiffPlaceFlag").val();var o=22;var i="";var m="";if(j=="diff"){o=23;i=CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD;n.boInfos[0].boActionTypeCd=CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD;m="异地补换卡";var l=k.areaId;if(l==undefined||l==""){$.alert("提示","营业后台未返回产品归属地区，无法办理异地补换卡业务！");return false}}else{i=CONST.BO_ACTION_TYPE.CHANGE_CARD;m="补换卡"}var h={prodId:k.prodInstId};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,i,o,m,"");rule.rule.prepare(n,"prod.changeUim.initFillPage",h)};var c=function(i){if(!prod.uim.setProdUim()){return false}var h=order.prodModify.choosedProdInfo;$.callServiceAsHtml(contextPath+"/prod/changeCard",i,{before:function(){},done:function(j){$("#order_fill_content").html(j.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$("#nothreelinks").css("display","none");$(".ordercon").show();$(".ordertabcon").show();$(".h2_title").append(h.productName+"-"+h.accNbr);order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide();if($("#DiffPlaceFlag").val()=="diff"){$("#uim_txt_"+h.prodInstId).css("display","none");$("#uim_check_btn_"+h.prodInstId).css("display","none");$("#uim_release_btn_"+h.prodInstId).css("display","none");$("#uim_lable").text("写卡：")}order.dealer.initDealer()},always:function(){$.unecOverlay()}});prod.changeUim.is4GProdInst=query.prod.checkIs4GProdInst(h)};var a=function(){var h=order.prodModify.choosedProdInfo;var j={prodId:h.prodInstId,boActionTypeCd:OrderInfo.boActionTypeCd,remark:$("#order_remark").val()};var i=[];i.push(OrderInfo.getProdBusiOrder(j));AttachOffer.setAttachBusiOrder(i);SoOrder.submitOrder(i)};var f=function(h){$("#selUimType").val($(h).val())};return{init:g,initFillPage:c,submit:a,is4GProdInst:b,changeUimSel:f}})();CommonUtils.regNamespace("acct","acctModify");acct.acctModify=(function(){var m={};var c={};var g={};var j=function(){var u=order.prodModify.getCallRuleParam(CONST.BO_ACTION_TYPE.ACCTINFOMODIFY,order.prodModify.choosedProdInfo.prodInstId);var s={boActionTypeCd:CONST.BO_ACTION_TYPE.ACCTINFOMODIFY,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ACCTINFOMODIFY),accessNumber:order.prodModify.choosedProdInfo.accNbr,prodOfferName:order.prodModify.choosedProdInfo.prodOfferName};var t=rule.rule.prepare(u,"acct.acctModify.acctInfoModify",s);if(t){return}OrderInfo.initData(CONST.ACTION_CLASS_CD.ACCT_ACTION,CONST.BO_ACTION_TYPE.ACCTINFOMODIFY,10,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ACCTINFOMODIFY),"")};var k=function(){if(!order.prodModify.choosedProdInfo.prodInstId||!order.prodModify.choosedProdInfo.accNbr){$.alert("提示","产品信息定位异常，请联系管理员");$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}var s={prodId:order.prodModify.choosedProdInfo.prodInstId,acctNbr:order.prodModify.choosedProdInfo.accNbr};$.callServiceAsHtml(contextPath+"/order/prodModify/acctInfoModify",s,{before:function(){$.ecOverlay("<strong>正在确认当前产品帐户,请稍等...</strong>")
},always:function(){$.unecOverlay()},done:function(t){if(t.code!=0){$.alert("提示","无法确认当前产品帐户，请联系管理员");$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}$("#order_fill_content").html(t.data).show();$(".h2_title").append(order.prodModify.choosedProdInfo.productName+"-"+order.prodModify.choosedProdInfo.accNbr);i("#acctInfoList tr",$("#acctInfoList").children(":first-child"));$("#acctInfoList tr").each(function(){$(this).off("click").on("click",function(u){i("#acctInfoList tr",this);u.stopPropagation()})});$("#fillLastStep").click(function(){order.prodModify.cancel()})}})};var i=function(s,w){$(s).removeClass("plan_select");$(s).children(":first-child").html("");$(w).addClass("plan_select");$(w).children(":first").html("<i class='select'></i>");var y={acctId:w.attr("id")};var t=$.callServiceAsHtml(contextPath+"/order/prodModify/queryAcctDetailInfo",y);if(t.code!=0){$("#acctInfoDetail").html("账户信息加载失败").show();return}$("#acctInfoDetail").html(t.data).show();r();var u=$("#postType option:not(:first)");$.each(u,function(z,A){if($(A).val()==$("#postType option:first").val()){$(A).remove();return false}});var v=$("#billContent option:not(:first)");$.each(v,function(A,z){if($(z).val()==$("#billContent option:first").val()){$(z).remove();return false}});var x=$("#postCycle option:not(:first)");$.each(x,function(A,z){if($(z).val()==$("#postCycle option:first").val()){$(z).remove();return false}});q();l();if($("#billContent").val()==14){$("#receipt").show()}m={acctCd:$("#acctInfoList .plan_select td:eq(0)").attr("id"),acctName:$("#acctName").val(),acctTypeCd:"1",partyId:$("#partyId").val(),prodId:order.prodModify.choosedProdInfo.prodInstId,state:"DEL"};c={bankAcct:$("#bankAcct").val(),bankId:$("#bankId").val(),limitQty:"1",paymentAcctTypeCd:$("#paymentType").val(),paymentAccountId:$("#paymentType").attr("name"),paymentMan:$("#paymentMan").val(),state:"DEL"};if($("#postType").val()!=-1){g={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"DEL"};if($("#postType").val()==11||$("#postType").val()==15){g.param1=$("#postAddress").val()+","+$("#zipCode").val()+","+$("#consignee").val()}}else{g={}}};var n=function(){var s=$.callServiceAsJson(contextPath+"/acct/ifCanAdjustBankPayment",{});if(s.data=="0"){$("#paymentType").append("<option value='110000'>银行</option>")}};var r=function(u){var t={CONFIG_PARAM_TYPE:"BILL_POST"};var s=contextPath+"/order/queryApConf";var x=$.callServiceAsJsonGet(s,t);if(x.code==0&&x.data){for(var y=0;y<x.data.length;y++){if(x.data[y].BILL_POST_TYPE){$.each(x.data[y].BILL_POST_TYPE,function(z,A){$("<option>").attr("value",A.COLUMN_VALUE).text(A.COLUMN_VALUE_NAME).appendTo($("#postType"))})}else{if(x.data[y].BILL_POST_CONTENT){$.each(x.data[y].BILL_POST_CONTENT,function(A,z){$("<option>").attr("value",z.COLUMN_VALUE).text(z.COLUMN_VALUE_NAME).appendTo($("#billContent"))})}else{if(x.data[y].BILL_POST_CYCLE){$.each(x.data[y].BILL_POST_CYCLE,function(A,z){$("<option>").attr("value",z.COLUMN_VALUE).text(z.COLUMN_VALUE_NAME).appendTo($("#postCycle"))})}}}}if(u){u()}}if(OrderInfo.newOrderInfo.isReloadFlag=="N"&&OrderInfo.newOrderInfo.acctCd=="-1"){$("#acctName").val(OrderInfo.newOrderInfo.acctName);$("#paymentType").find("option[value='"+OrderInfo.newOrderInfo.paymentAcctTypeCd+"']").attr("selected","selected")}if(OrderInfo.newOrderInfo.isReloadFlag=="N"){$("#postType").find("option[value='"+OrderInfo.newOrderInfo.mailingType+"']").attr("selected","selected");if(OrderInfo.newOrderInfo.mailingType!=""&&OrderInfo.newOrderInfo.mailingType!=-1){l();$("#postAddress").show();$("#billContent").show();$("#postCycle").show();if($("#postType").val()==11||$("#postType").val()==15){var w=OrderInfo.newOrderInfo.param1.split(",");for(var v=0;v<w.length;v++){if(v==0){$("#postAddress").val(w[v])}else{if(v==1){$("#zipCode").val(w[v])}else{if(v==2){$("#consignee").val(w[v])}}}}}else{$("#postAddress").val(OrderInfo.newOrderInfo.param1)}$("#billContent").find("option[value='"+OrderInfo.newOrderInfo.param7+"']").attr("selected","selected");$("#postCycle").find("option[value='"+OrderInfo.newOrderInfo.param3+"']").attr("selected","selected")}}};var q=function(){if($("#paymentType").val()==100000){$(".bank").hide();$("#paymentType").parent().addClass("full")}else{$(".bank").show();$("#paymentType").parent().removeClass("full")}};var l=function(){if($("#postType").val()==-1){$(".billPost").hide();$("#postType").parent().addClass("full");$("#billContent").find("option[value=11]").attr("selected","selected");$("#postType").find("option[value=12]").show();$("#postType").find("option[value=13]").show();$("#postType").find("option[value=14]").show();$("#receipt").hide()}else{$(".billPost").show();$("#postType").parent().removeClass("full");if($("#postType").val()==12){$("#postAddress").attr("placeHolder","请输入有效的传真号码")}else{if($("#postType").val()==13){$("#postAddress").attr("placeHolder","请输入有效的Email地址")}else{if($("#postType").val()==14){$("#postAddress").attr("placeHolder","请输入有效的手机号")}else{$("#postAddress").attr("placeHolder","请输入准确的收件地址")}}}}};var h=function(){if($("#billContent").val()==14){if($("#postType").val()==12||$("#postType").val()==13||$("#postType").val()==14){$("#postType").find("option[value=11]").attr("selected","selected");$("#postAddress").val("");$("#postAddress").attr("placeHolder","请输入准确的收件地址")}$("#postType").find("option[value=12]").hide();$("#postType").find("option[value=13]").hide();$("#postType").find("option[value=14]").hide();$("#receipt").fadeIn("slow")}else{$("#postType").find("option[value=12]").show();$("#postType").find("option[value=13]").show();$("#postType").find("option[value=14]").show();$("#receipt").fadeOut("slow")}};var a=function(){order.area.chooseAreaTreeAll("p_bank_areaId_val","p_bank_areaId",3)};var b=function(t){var s;var u=1;if(t==0){s={name:"",bankId:"",simpleSpell:"",commonRegionId:""}}if(t>0){u=t;s={name:$("#p_bandkname").val(),bankId:"",simpleSpell:$("#p_simpleSpell").val(),commonRegionId:$("#p_bank_areaId").val()}}var v={bank:s,curPage:u,pageSize:10};$.callServiceAsHtml(contextPath+"/acct/getBankList",v,{before:function(){$.ecOverlay("<strong>银行查询中,请稍等....</strong>")},always:function(){$.unecOverlay()},done:function(w){if(!w){w.data=""}$("#div_bank_dialog").html(w.data);$("#bank_list tr").each(function(){$(this).off("click").on("click",function(x){o("#bank_list tr",this);x.stopPropagation()})});easyDialog.open({container:"div_bank_dialog"})}})};var o=function(s,t){$(s).removeClass("plan_select");$(s).children(":first-child").html("");$(t).addClass("plan_select");$(t).children(":first").html("<i class='select'></i>")};var p=function(){var s=$("#bank_list .plan_select");$("#bankId").val($(s).attr("id"));$("#bankName").val($(s).find("td:eq(2)").text());if(s.length>0){easyDialog.close()}else{$.alert("操作提示","请选择银行！")}};var f=function(){if(!SoOrder.checkAcctInfo()){return}var w={areaId:order.prodModify.choosedProdInfo.areaId,boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.ACCT_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACCTINFOMODIFY},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:$("#acctInfoList .plan_select").attr("id"),isComp:"N",objId:"",offerTypeCd:"1"},busiOrderInfo:{seq:OrderInfo.SEQ.seq--},data:{boAccountInfos:[],boAcct2PaymentAccts:[],boAccountItems:[],boPaymentAccounts:[],boAccountMailings:[]}};var v={acctCd:$("#acctInfoList .plan_select td:eq(0)").attr("id"),acctName:$("#acctName").val(),acctTypeCd:"1",partyId:$("#partyId").val(),prodId:order.prodModify.choosedProdInfo.prodInstId,state:"ADD"};w.data.boAccountInfos.push(m);w.data.boAccountInfos.push(v);var x={priority:"1",paymentAccountId:$("#paymentType").attr("name"),state:"ADD"};w.data.boAcct2PaymentAccts.push(x);var s={bankAcct:"",bankId:"",limitQty:"1",paymentAcctTypeCd:$("#paymentType").val(),paymentAccountId:$("#paymentType").attr("name"),paymentMan:"",state:"ADD"};
if($("#paymentType").val()==110000){s.bankAcct=$("#bankAcct").val();s.bankId=$("#bankId").val();s.paymentMan=$("#paymentMan").val()}w.data.boPaymentAccounts.push(c);w.data.boPaymentAccounts.push(s);if(g.mailingType){w.data.boAccountMailings.push(g)}if($("#postType").val()!=-1){var u={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"ADD"};if($("#postType").val()==11||$("#postType").val()==15){u.param1=$("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val()}w.data.boAccountMailings.push(u)}var t=[];t.push(w);SoOrder.submitOrder(t)};return{showAcctInfoModify:j,acctInfoModify:k,ifCanAdjustBankPayment:n,getBILL_POST:r,paymentType:q,billPostType:l,billContent:h,queryAllArea:a,queryBank:b,fillBankInfo:p,acctInfoModify_Submit:f}})();CommonUtils.regNamespace("common","area");common.area=(function(i){var b={"8110000":[{id:8110000,name:"东城区"},{id:8110000,name:"西城区"},{id:8110000,name:"朝阳区"},{id:8110000,name:"丰台区"},{id:8110000,name:"石景山区"},{id:8110000,name:"海淀区"},{id:8110000,name:"门头沟区"},{id:8110000,name:"房山区"},{id:8110000,name:"通州区"},{id:8110000,name:"顺义区"},{id:8110000,name:"昌平区"},{id:8110000,name:"大兴区"},{id:8110000,name:"怀柔区"},{id:8110000,name:"平谷区"},{id:8110000,name:"密云县"},{id:8110000,name:"延庆县"}],"8310000":[{id:8310000,name:"黄浦区"},{id:8310000,name:"徐汇区"},{id:8310000,name:"长宁区"},{id:8310000,name:"静安区"},{id:8310000,name:"普陀区"},{id:8310000,name:"闸北区"},{id:8310000,name:"虹口区"},{id:8310000,name:"杨浦区"},{id:8310000,name:"闵行区"},{id:8310000,name:"宝山区"},{id:8310000,name:"嘉定区"},{id:8310000,name:"浦东新区"},{id:8310000,name:"金山区"},{id:8310000,name:"松江区"},{id:8310000,name:"青浦区"},{id:8310000,name:"奉贤区"},{id:8310000,name:"崇明县"}],"8120000":[{id:8120000,name:"和平区"},{id:8120000,name:"河东区"},{id:8120000,name:"河西区"},{id:8120000,name:"南开区"},{id:8120000,name:"河北区"},{id:8120000,name:"红桥区"},{id:8120000,name:"东丽区"},{id:8120000,name:"西青区"},{id:8120000,name:"津南区"},{id:8120000,name:"北辰区"},{id:8120000,name:"武清区"},{id:8120000,name:"宝坻区"},{id:8120000,name:"滨海新区"},{id:8120000,name:"宁河县"},{id:8120000,name:"静海县"},{id:8120000,name:"蓟县"}],"8500000":[{id:8500000,name:"万州区"},{id:8500000,name:"涪陵区"},{id:8500000,name:"渝中区"},{id:8500000,name:"大渡口区"},{id:8500000,name:"江北区"},{id:8500000,name:"沙坪坝区"},{id:8500000,name:"九龙坡区"},{id:8500000,name:"南岸区"},{id:8500000,name:"北碚区"},{id:8500000,name:"万盛区"},{id:8500000,name:"双桥区"},{id:8500000,name:"渝北区"},{id:8500000,name:"巴南区"},{id:8500000,name:"黔江区"},{id:8500000,name:"长寿区"},{id:8500000,name:"江津区"},{id:8500000,name:"合川区"},{id:8500000,name:"永川区"},{id:8500000,name:"南川区"},{id:8500000,name:"綦江县"},{id:8500000,name:"潼南县"},{id:8500000,name:"铜梁县"},{id:8500000,name:"大足县"},{id:8500000,name:"荣昌县"},{id:8500000,name:"璧山县"},{id:8500000,name:"梁平县"},{id:8500000,name:"城口县"},{id:8500000,name:"丰都县"},{id:8500000,name:"垫江县"},{id:8500000,name:"武隆县"},{id:8500000,name:"忠县"},{id:8500000,name:"开县"},{id:8500000,name:"云阳县"},{id:8500000,name:"奉节县"},{id:8500000,name:"巫山县"},{id:8500000,name:"巫溪县"},{id:8500000,name:"石柱土家族自治县"},{id:8500000,name:"秀山土家族苗族自治县"},{id:8500000,name:"酉阳土家族苗族自治县"},{id:8500000,name:"彭水苗族土家族自治县"}],"8130000":[{id:8130100,name:"石家庄市"},{id:8130200,name:"唐山市"},{id:8130300,name:"秦皇岛市"},{id:8130400,name:"邯郸市"},{id:8130500,name:"邢台市"},{id:8130600,name:"保定市"},{id:8130700,name:"张家口市"},{id:8130800,name:"承德市"},{id:8130900,name:"沧州市"},{id:8131000,name:"廊坊市"},{id:8131100,name:"衡水市"}],"8140000":[{id:8140100,name:"太原市"},{id:8140200,name:"大同市"},{id:8140300,name:"阳泉市"},{id:8140400,name:"长治市"},{id:8140500,name:"晋城市"},{id:8140600,name:"朔州市"},{id:8140700,name:"晋中市"},{id:8140800,name:"运城市"},{id:8140900,name:"忻州市"},{id:8141000,name:"临汾市"},{id:8141100,name:"吕梁市"}],"8410000":[{id:8410100,name:"郑州市"},{id:8410200,name:"开封市"},{id:8410300,name:"洛阳市"},{id:8410400,name:"平顶山市"},{id:8410500,name:"安阳市"},{id:8410600,name:"鹤壁市"},{id:8410700,name:"新乡市"},{id:8410800,name:"焦作市"},{id:8410900,name:"濮阳市"},{id:8411000,name:"许昌市"},{id:8411100,name:"漯河市"},{id:8411200,name:"三门峡市"},{id:8411300,name:"南阳市"},{id:8411400,name:"商丘市"},{id:8411500,name:"信阳市"},{id:8411600,name:"周口市"},{id:8411700,name:"驻马店市"},{id:8419001,name:"济源市"}],"8210000":[{id:8210100,name:"沈阳市"},{id:8210200,name:"大连市"},{id:8210300,name:"鞍山市"},{id:8210400,name:"抚顺市"},{id:8210500,name:"本溪市"},{id:8210600,name:"丹东市"},{id:8210700,name:"锦州市"},{id:8210800,name:"营口市"},{id:8210900,name:"阜新市"},{id:8211000,name:"辽阳市"},{id:8211100,name:"盘锦市"},{id:8211200,name:"铁岭市"},{id:8211300,name:"朝阳市"},{id:8211400,name:"葫芦岛市"}],"8220000":[{id:8220100,name:"长春市"},{id:8220200,name:"吉林市"},{id:8220300,name:"四平市"},{id:8220400,name:"辽源市"},{id:8220500,name:"通化市"},{id:8220600,name:"白山市"},{id:8220700,name:"松原市"},{id:8220800,name:"白城市"},{id:8222400,name:"延边朝鲜族自治州"}],"8230000":[{id:8230100,name:"哈尔滨市"},{id:8230200,name:"齐齐哈尔市"},{id:8230300,name:"鸡西市"},{id:8230400,name:"鹤岗市"},{id:8230500,name:"双鸭山市"},{id:8230600,name:"大庆市"},{id:8230700,name:"伊春市"},{id:8230800,name:"佳木斯市"},{id:8230900,name:"七台河市"},{id:8231000,name:"牡丹江市"},{id:8231100,name:"黑河市"},{id:8231200,name:"绥化市"},{id:8232700,name:"大兴安岭地区"}],"8150000":[{id:8150100,name:"呼和浩特市"},{id:8150200,name:"包头市"},{id:8150300,name:"乌海市"},{id:8150400,name:"赤峰市"},{id:8150500,name:"通辽市"},{id:8150600,name:"鄂尔多斯市"},{id:8150700,name:"呼伦贝尔市"},{id:8150800,name:"巴彦淖尔市"},{id:8150900,name:"乌兰察布市"},{id:8152200,name:"兴安盟"},{id:8152500,name:"锡林郭勒盟"},{id:8152900,name:"阿拉善盟"}],"8320000":[{id:8320100,name:"南京市"},{id:8320200,name:"无锡市"},{id:8320300,name:"徐州市"},{id:8320400,name:"常州市"},{id:8320500,name:"苏州市"},{id:8320600,name:"南通市"},{id:8320700,name:"连云港市"},{id:8320800,name:"淮安市"},{id:8320900,name:"盐城市"},{id:8321000,name:"扬州市"},{id:8321100,name:"镇江市"},{id:8321200,name:"泰州市"},{id:8321300,name:"宿迁市"}],"8370000":[{id:8370100,name:"济南市"},{id:8370200,name:"青岛市"},{id:8370300,name:"淄博市"},{id:8370400,name:"枣庄市"},{id:8370500,name:"东营市"},{id:8370600,name:"烟台市"},{id:8370700,name:"潍坊市"},{id:8370800,name:"济宁市"},{id:8370900,name:"泰安市"},{id:8371000,name:"威海市"},{id:8371100,name:"日照市"},{id:8371200,name:"莱芜市"},{id:8371300,name:"临沂市"},{id:8371400,name:"德州市"},{id:8371500,name:"聊城市"},{id:8371600,name:"滨州市"},{id:8371700,name:"菏泽市"}],"8340000":[{id:8340100,name:"合肥市"},{id:8340200,name:"芜湖市"},{id:8340300,name:"蚌埠市"},{id:8340400,name:"淮南市"},{id:8340500,name:"马鞍山市"},{id:8340600,name:"淮北市"},{id:8340700,name:"铜陵市"},{id:8340800,name:"安庆市"},{id:8341000,name:"黄山市"},{id:8341100,name:"滁州市"},{id:8341200,name:"阜阳市"},{id:8341300,name:"宿州市"},{id:8341500,name:"六安市"},{id:8341600,name:"亳州市"},{id:8341700,name:"池州市"},{id:8341800,name:"宣城市"}],"8330000":[{id:8330100,name:"杭州市"},{id:8330200,name:"宁波市"},{id:8330300,name:"温州市"},{id:8330400,name:"嘉兴市"},{id:8330500,name:"湖州市"},{id:8330600,name:"绍兴市"},{id:8330700,name:"金华市"},{id:8330800,name:"衢州市"},{id:8330900,name:"舟山市"},{id:8331000,name:"台州市"},{id:8331100,name:"丽水市"}],"8350000":[{id:8350100,name:"福州市"},{id:8350200,name:"厦门市"},{id:8350300,name:"莆田市"},{id:8350400,name:"三明市"},{id:8350500,name:"泉州市"},{id:8350600,name:"漳州市"},{id:8350700,name:"南平市"},{id:8350800,name:"龙岩市"},{id:8350900,name:"宁德市"}],"8420000":[{id:8420100,name:"武汉市"},{id:8420200,name:"黄石市"},{id:8420300,name:"十堰市"},{id:8420500,name:"宜昌市"},{id:8420600,name:"襄阳市"},{id:8420700,name:"鄂州市"},{id:8420800,name:"荆门市"},{id:8420900,name:"孝感市"},{id:8421000,name:"荆州市"},{id:8421100,name:"黄冈市"},{id:8421200,name:"咸宁市"},{id:8421300,name:"随州市"},{id:8422800,name:"恩施土家族苗族自治州"},{id:8429004,name:"仙桃市"},{id:8429005,name:"潜江市"},{id:8429006,name:"天门市"},{id:8429021,name:"神农架林区"}],"8430000":[{id:8430100,name:"长沙市"},{id:8430200,name:"株洲市"},{id:8430300,name:"湘潭市"},{id:8430400,name:"衡阳市"},{id:8430500,name:"邵阳市"},{id:8430600,name:"岳阳市"},{id:8430700,name:"常德市"},{id:8430800,name:"张家界市"},{id:8430900,name:"益阳市"},{id:8431000,name:"郴州市"},{id:8431100,name:"永州市"},{id:8431200,name:"怀化市"},{id:8431300,name:"娄底市"},{id:8433100,name:"湘西土家族苗族自治州"}],"8440000":[{id:8440100,name:"广州市"},{id:8440200,name:"韶关市"},{id:8440300,name:"深圳市"},{id:8440400,name:"珠海市"},{id:8440500,name:"汕头市"},{id:8440600,name:"佛山市"},{id:8440700,name:"江门市"},{id:8440800,name:"湛江市"},{id:8440900,name:"茂名市"},{id:8441200,name:"肇庆市"},{id:8441300,name:"惠州市"},{id:8441400,name:"梅州市"},{id:8441500,name:"汕尾市"},{id:8441600,name:"河源市"},{id:8441700,name:"阳江市"},{id:8441800,name:"清远市"},{id:8441900,name:"东莞市"},{id:8442000,name:"中山市"},{id:8445100,name:"潮州市"},{id:8445200,name:"揭阳市"},{id:8445300,name:"云浮市"}],"8450000":[{id:8450100,name:"南宁市"},{id:8450200,name:"柳州市"},{id:8450300,name:"桂林市"},{id:8450400,name:"梧州市"},{id:8450500,name:"北海市"},{id:8450600,name:"防城港市"},{id:8450700,name:"钦州市"},{id:8450800,name:"贵港市"},{id:8450900,name:"玉林市"},{id:8451000,name:"百色市"},{id:8451100,name:"贺州市"},{id:8451200,name:"河池市"},{id:8451300,name:"来宾市"},{id:8451400,name:"崇左市"}],"8360000":[{id:8360100,name:"南昌市"},{id:8360200,name:"景德镇市"},{id:8360300,name:"萍乡市"},{id:8360400,name:"九江市"},{id:8360500,name:"新余市"},{id:8360600,name:"鹰潭市"},{id:8360700,name:"赣州市"},{id:8360800,name:"吉安市"},{id:8360900,name:"宜春市"},{id:8361000,name:"抚州市"},{id:8361100,name:"上饶市"}],"8510000":[{id:8510100,name:"成都市"},{id:8510300,name:"自贡市"},{id:8510400,name:"攀枝花市"},{id:8510500,name:"泸州市"},{id:8510600,name:"德阳市"},{id:8510700,name:"绵阳市"},{id:8510800,name:"广元市"},{id:8510900,name:"遂宁市"},{id:8511000,name:"内江市"},{id:8511100,name:"乐山市"},{id:8511300,name:"南充市"},{id:8511400,name:"眉山市"},{id:8511500,name:"宜宾市"},{id:8511600,name:"广安市"},{id:8511700,name:"达州市"},{id:8511800,name:"雅安市"},{id:8511900,name:"巴中市"},{id:8512000,name:"资阳市"},{id:8513200,name:"阿坝藏族羌族自治州"},{id:8513300,name:"甘孜藏族自治州"},{id:8513400,name:"凉山彝族自治州"}],"8460000":[{id:8460100,name:"海口市"},{id:8460200,name:"三亚市"},{id:8460300,name:"三沙市"},{id:8469001,name:"五指山市"},{id:8469002,name:"琼海市"},{id:8469003,name:"儋州市"},{id:8469005,name:"文昌市"},{id:8469006,name:"万宁市"},{id:8469007,name:"东方市"},{id:8469021,name:"定安县"},{id:8469022,name:"屯昌县"},{id:8469023,name:"澄迈县"},{id:8469024,name:"临高县"},{id:8469025,name:"白沙黎族自治县"},{id:8469026,name:"昌江黎族自治县"},{id:8469027,name:"乐东黎族自治县"},{id:8469028,name:"陵水黎族自治县"},{id:8469029,name:"保亭黎族苗族自治县"},{id:8469030,name:"琼中黎族苗族自治县"},{id:8469031,name:"西沙群岛"},{id:8469032,name:"南沙群岛"},{id:8469033,name:"中沙群岛的岛礁及其海域"}],"8520000":[{id:8520100,name:"贵阳市"},{id:8520200,name:"六盘水市"},{id:8520300,name:"遵义市"},{id:8520400,name:"安顺市"},{id:8522200,name:"铜仁地区"},{id:8522300,name:"黔西南布依族苗族自治州"},{id:8522400,name:"毕节地区"},{id:8522600,name:"黔东南苗族侗族自治州"},{id:8522700,name:"黔南布依族苗族自治州"}],"8530000":[{id:8530100,name:"昆明市"},{id:8530300,name:"曲靖市"},{id:8530400,name:"玉溪市"},{id:8530500,name:"保山市"},{id:8530600,name:"昭通市"},{id:8530700,name:"丽江市"},{id:8530800,name:"普洱市"},{id:8530900,name:"临沧市"},{id:8532300,name:"楚雄彝族自治州"},{id:8532500,name:"红河哈尼族彝族自治州"},{id:8532600,name:"文山壮族苗族自治州"},{id:8532800,name:"西双版纳傣族自治州"},{id:8532900,name:"大理白族自治州"},{id:8533100,name:"德宏傣族景颇族自治州"},{id:8533300,name:"怒江傈僳族自治州"},{id:8533400,name:"迪庆藏族自治州"}],"8540000":[{id:8540100,name:"拉萨市"},{id:8542100,name:"昌都地区"},{id:8542200,name:"山南地区"},{id:8542300,name:"日喀则地区"},{id:8542400,name:"那曲地区"},{id:8542500,name:"阿里地区"},{id:8542600,name:"林芝地区"}],"8610000":[{id:8610100,name:"西安市"},{id:8610200,name:"铜川市"},{id:8610300,name:"宝鸡市"},{id:8610400,name:"咸阳市"},{id:8610500,name:"渭南市"},{id:8610600,name:"延安市"},{id:8610700,name:"汉中市"},{id:8610800,name:"榆林市"},{id:8610900,name:"安康市"},{id:8611000,name:"商洛市"}],"8620000":[{id:8620100,name:"兰州市"},{id:8620200,name:"嘉峪关市"},{id:8620300,name:"金昌市"},{id:8620400,name:"白银市"},{id:8620500,name:"天水市"},{id:8620600,name:"武威市"},{id:8620700,name:"张掖市"},{id:8620800,name:"平凉市"},{id:8620900,name:"酒泉市"},{id:8621000,name:"庆阳市"},{id:8621100,name:"定西市"},{id:8621200,name:"陇南市"},{id:8622900,name:"临夏回族自治州"},{id:8623000,name:"甘南藏族自治州"}],"8630000":[{id:8630100,name:"西宁市"},{id:8632100,name:"海东地区"},{id:8632200,name:"海北藏族自治州"},{id:8632300,name:"黄南藏族自治州"},{id:8632500,name:"海南藏族自治州"},{id:8632600,name:"果洛藏族自治州"},{id:8632700,name:"玉树藏族自治州"},{id:8632800,name:"海西蒙古族藏族自治州"}],"8640000":[{id:8640100,name:"银川市"},{id:8640200,name:"石嘴山市"},{id:8640300,name:"吴忠市"},{id:8640400,name:"固原市"},{id:8640500,name:"中卫市"}],"8650000":[{id:8650100,name:"乌鲁木齐市"},{id:8650200,name:"克拉玛依市"},{id:8652100,name:"吐鲁番地区"},{id:8652200,name:"哈密地区"},{id:8652300,name:"昌吉回族自治州"},{id:8652700,name:"博尔塔拉蒙古自治州"},{id:8652800,name:"巴音郭楞蒙古自治州"},{id:8652900,name:"阿克苏地区"},{id:8653000,name:"克孜勒苏柯尔克孜自治州"},{id:8653100,name:"喀什地区"},{id:8653200,name:"和田地区"},{id:8654000,name:"伊犁哈萨克自治州"},{id:8654200,name:"塔城地区"},{id:8654300,name:"阿勒泰地区"},{id:8659001,name:"石河子市"},{id:8659002,name:"阿拉尔市"},{id:8659003,name:"图木舒克市"},{id:8659004,name:"五家渠市"}]};
var f=function(l,n,k){var m=k;var o=new Date();o.setTime(o.getTime()+m*24*60*60*1000);document.cookie=l+"="+escape(n)+";expires="+o.toGMTString()+";path=/;"};var a=function(l){var k=document.cookie.match(new RegExp("(^| )"+l+"=([^;]*)(;|$)"));if(k!=null){return unescape(k[2])}return null};var g=function(l){var k="";if(l==1){k="stock_province_item"}else{if(l==2){k="stock_city_item"}}return k};var j=function(m){var n=i(m).attr("data-value");var p=i(m).html();var k=i("#ctc-area div.mt ul.tab li[data-index=0] em").html();i("#ctc-area div.mt ul.tab li[data-index=1] em").html(p);i("#store-selector-text").html(k+p).attr("area-id",n);i("#store-selector").removeClass("hover");var l=n+"-"+k+"-"+p;f("login_area_id",l,30);var o=i(m).parent().parent().parent().attr("data-area");o=new Number(o)+1;if(o=="2"){}};var c=function(k){var r=2;var l=g(r);if(l&&r){i("#"+l).html("");var p=["<ul class='area-list'>"];var q=[];var n=[];if(k&&k.length>0){for(var o=0,m=k.length;o<m;o++){k[o].name=k[o].name.replace(" ","");if(k[o].name.length>12){n.push("<li class='longer-area'><a href='#none' data-value='"+k[o].id+"'>"+k[o].name+"</a></li>")}else{if(k[o].name.length>5){q.push("<li class='long-area'><a href='#none' data-value='"+k[o].id+"'>"+k[o].name+"</a></li>")}else{p.push("<li><a href='#none' data-value='"+k[o].id+"'>"+k[o].name+"</a></li>")}}}}else{p.push("<li><a href='#none' data-value='"+currentAreaInfo.currentFid+"'> </a></li>")}p.push(q.join(""));p.push(n.join(""));p.push("</ul>");i("#"+l).html(p.join(""));i("#"+l).find("a").click(function(){j(this)})}};var h=function(){i("#ctc-area div.mt ul.tab li[data-index=0]").addClass("curr").find("a").addClass("hover");i("#stock_city_item").hide();i("#stock_province_item").show();i("#store-selector").off("mouseover").on("mouseover",function(){i("#store-selector").addClass("hover")});i("#store-selector").off("mouseout").on("mouseout",function(){i("#store-selector").removeClass("hover")});i("#ctc-area div.mt ul.tab li").off("click").on("click",function(){i("#ctc-area div.mt ul.tab li").removeClass("curr").find("a").removeClass("hover");i(this).addClass("curr").find("a").addClass("hover");var l=i(this).attr("data-index");if(l=="0"){i("#stock_city_item").hide();i("#stock_province_item").show()}else{if(l=="1"){i("#stock_province_item").hide();i("#stock_city_item").show()}}});i("#stock_province_item a").off("click").on("click",function(){var n=i(this).attr("data-value");if(n=="8110000"||n=="8310000"||n=="8120000"||n=="8500000"){var l=i(this).html();var o="";i("#ctc-area div.mt ul.tab li[data-index=0] em").html(l);i("#ctc-area div.mt ul.tab li[data-index=1] em").html(o);i("#store-selector-text").html(l+o).attr("area-id",n);i("#store-selector").removeClass("hover");c(b[n]);var m=n+"-"+l+"-"+o;f("login_area_id",m,30);return}i("#store-selector").off("mouseout");c(b[n+""]);i("#ctc-area div.mt ul.tab li").removeClass("curr");i("#ctc-area div.mt ul.tab li a").removeClass("hover");i("#ctc-area div.mt ul.tab li[data-index=0] em").html(i(this).html());i("#ctc-area div.mt ul.tab li[data-index=1] em").html("请选择");i("#ctc-area div.mt ul.tab li[data-index=1]").addClass("curr").find("a").addClass("hover");i("#stock_province_item").hide();i("#stock_city_item").show()});i("#stock_city_item a").off("click").on("click",function(){j(this)});var k=a("login_area_id");if(!!k&&k!=""){k=k.split("-");i("#store-selector-text").attr("area-id",k[0]).html(k[1]+k[2]);i("#ctc-area div.mt ul.tab li[data-index=0] em").html(k[1]);i("#ctc-area div.mt ul.tab li[data-index=1] em").html(k[2]);c(b[k[0].substring(0,3)+"0000"])}};return{init:h}})(jQuery);$(function(){common.area.init()});CommonUtils.regNamespace("common","arraypage");common.arraypage=(function(){var i={};var n=10;var b="pageChangeListener";var g={};var c="";var l="";var k=function(u,q,r,t,p){if(!u){$.alert("提示","分页DivId不能为空!");return}l=u;if(!q||q<0){i.pageSize=n}else{i.pageSize=q}i.totalSize=p.length;i.curPage=1;if(!t){t=b}c=t;g=p;var s=Math.ceil(i.totalSize/i.pageSize);i.totalPage=s;common.arraypage.turnToPage(i.curPage)};var f=function(r){var p=[];for(var q=(r-1)*i.pageSize+1;q<r*i.pageSize+1;q++){if(q>i.totalSize){break}p.push(g[q-1])}return p};var h=function(x){var z="",s="";if(x==1){z='<span class="disabled">上一页</span>'}else{z='<a href="javascript:void(0);" onclick="common.arraypage.turnPrePage()">上一页</a>'}var w="";var p='<span class="spanDot">...</span>';if(i.totalPage<=5){for(var t=1;t<=i.totalPage;t++){if(i.curPage==t){w+='<span class="curr">'+t+"</span>"}else{w+='<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">'+t+"</a>"}}}else{if(i.curPage<=5){for(var t=1;t<=7;t++){if(i.curPage==t){w+='<span class="curr">'+t+"</span>"}else{w+='<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">'+t+"</a>"}}w+=p}else{w+='<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">1</a>';w+='<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">2</a>';w+=p;var q=i.curPage-2;var r=i.curPage+2;if(r>i.totalPage){r=i.totalPage;q=r-4;if(i.curPage-q<2){q=q-1}}else{if(r+1==i.totalPage){r=i.totalPage}}for(var t=q;t<=r;t++){if(i.curPage==t){w+='<span class="curr">'+t+"</span>"}else{w+='<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">'+t+"</a>"}}if(r!=i.totalPage){w+=p}}}if(i.curPage==i.totalPage){s='<span class="disabled">下一页</span>'}else{s='<a href="javascript:void(0);" onclick="common.arraypage.turnNextPage()">下一页</a>'}var u='<span class="totalText">当前第<span class="currPageNum">'+i.curPage+'</span>页<span class="totalInfoSplitStr">/</span>共<span class="totalPageNum">'+i.totalPage+"</span>页</span>";var v="";v='<span class="goPageBox">&nbsp;转到<span class="arraypage_gopage_wrap"><input type="text" onkeydown="if(event.keyCode==13){common.arraypage.turnToPage(parseInt($.trim($(this).val())))}" class="arraypage_btn_go_input"/>页</span></span>';var y='<div class="arraypage_cls">';y+=z+w+s+'<span class="infoTextAndGoPageBtnWrap">'+u+v+'</span><a href="javascript:void(0);"onclick="common.arraypage.gopage()" class="arraypage_btn_go">确定</span>';$("#"+l).empty();$("#"+l).html(y)};var m=function(){$(this).dispatchJEvent(c,f(--i.curPage));h(i.curPage)};var o=function(){$(this).dispatchJEvent(c,f(++i.curPage));h(i.curPage)};var a=function(){var p=parseInt($.trim($("#"+l).find("input").val()));j(p)};var j=function(p){if(p<0||p>i.totalPage||p==undefined||isNaN(p)){return}$(this).dispatchJEvent(c,f(p));i.curPage=p;h(i.curPage)};return{init:k,turnPrePage:m,turnNextPage:o,gopage:a,turnToPage:j}})();CommonUtils.regNamespace("busi","common");busi.common=(function(){var a=function(){i("",2)};var l=function(p){var t;var o="";var n=p.data;var m=$("#province_list").val();if(""==m){if(n.length>0){$("#province_list").off("change").on("change",function(){i($("#province_list").val(),3)});t=$("#province_list").html("");var s=($("#p_current_area").val()).substr(0,3)+"0000";for(var q=0;q<n.length;q++){if(n[q].commonRegionId==s){o=o+"<option  selected='selected' value='"+n[q].commonRegionId+"' zone_number='"+n[q].zoneNumber+"' name='"+n[q].regionName+"'>"+n[q].regionName+"</option>"}else{o=o+"<option value='"+n[q].commonRegionId+"' zone_number='"+n[q].zoneNumber+"' name='"+n[q].regionName+"'>"+n[q].regionName+"</option>"}}t.html(o);m=$("#province_list").val();if(m!=""){i($("#province_list").val(),3)}}}else{t=$("#city_list").html("");if(n.length>0){var r=$("#p_current_area").val();for(var q=0;q<n.length;q++){if(n[q].commonRegionId==r){o=o+"<option  selected='selected' value='"+n[q].commonRegionId+"' zone_number='"+n[q].zoneNumber+"' name='"+n[q].regionName+"'>"+n[q].regionName+"</option>"}else{o=o+"<option value='"+n[q].commonRegionId+"' zone_number='"+n[q].zoneNumber+"' name='"+n[q].regionName+"'>"+n[q].regionName+"</option>"}}t.html(o);$("#city_list").show()}else{$("#city_list").hide()}}};var i=function(m,n){var o={upRegionId:m,areaLevel:n};
$.callServiceAsJson(contextPath+"/orderQuery/areaTreeAllChilden",o,{before:function(){$.ecOverlay("地区信息加载中，请稍候...")},always:function(){$.unecOverlay()},done:function(p){try{if(p.code==0){if(!p.data){$.alert("提示","没有地区信息返回,请重试。")}else{l(p)}}else{$.alert("提示","地区信息加载异常，请稍后再试.")}}catch(q){$.alert("提示","地区信息加载异常，请稍后再试.")}},fail:function(p){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var f=function(r,q,n){if(typeof n=="undefined"&&!$.isFunction(n)){throw new Error("无效的回调函数")}var o="";if(r=="area"){o="地区"}else{if(r=="channel"){o="渠道"}else{$.alert("提示","数据异常");return}}var p={rangeType:r};var m=contextPath+"/staffMgr/getAuthRange";$.callServiceAsJsonGet(m,p,{before:function(){$.ecOverlay(o+"信息加载中，请稍候...")},always:function(){$.unecOverlay()},done:function(s){try{if(s.code==0){if(!s.data){$.alert("提示","没有"+o+"信息返回,请重试。")}else{ec.form.dialog.createDialog({id:q,title:"选择"+o,width:630,height:"",initCallBack:function(v,u){$("#ec-dialog-form-container"+q+" .ec-dialog-form-bottom-button").attr("ifshow","false");b(v,u);k(s,r);j(n)},submitCallBack:function(v,u){}})}}else{$.alert("提示",o+"信息加载异常，请稍后再试.")}}catch(t){$.alert("提示",o+"信息加载异常，请稍后再试.")}},fail:function(s){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var h;var c;var b=function(n,m){h=n;c=m};var k=function(n,r){var q=n.data;var p="";for(var o=0;o<q.length;o++){var m=q[o];p+="<div class='rangeInput'><input type='radio' value='"+m.ID+"' name='rdo_range_data' rangename='"+m.NAME+"' ";if(r=="area"){p+="areacode='"+m.AREA_CODE+"'"}p+="/>"+m.NAME+"</div>"}$("#range_data").html(p)};var j=function(m){$("#range_data").on("click",function(o){var n=$(o.target);n.find("input[name='rdo_range_data']").attr("checked",true);m.apply(this);h.close(c)})};var g=function(n){param={attrSpecCode:n};var m=contextPath+"/staffMgr/getCTGMainData";var o=$.callServiceAsJson(m,param,{});if(o.code==0){return o.data}else{if(o.code==-2){$.alertM(o.data);return}else{$.alert("提示","调用主数据接口失败！");return}}};return{queryAllArea:a,qryRangeData:f,queryCTGMainData:g}})();CommonUtils.regNamespace("common","errorPage");common.errorPage=(function(f){var c=function(h,j,g){var i=g;var k=new Date();k.setTime(k.getTime()+i*24*60*60*1000);document.cookie=h+"="+escape(j)+";expires="+k.toGMTString()+";path=/;"};var b=function(h){var g=document.cookie.match(new RegExp("(^| )"+h+"=([^;]*)(;|$)"));if(g!=null){return unescape(g[2])}return null};var a=function(){try{if(errorJson==undefined||errorJson==""){return}var g=errorJson;if(g&&typeof g.data!="undefined"&&typeof g.code!="undefined"){if(g.code==-2){f.alertM(g.data);return}}}catch(h){}};return{showError:a}})(jQuery);$(function(){common.errorPage.showError()});CommonUtils.regNamespace("common","page");common.page=(function(){var l={};var r=5;var c="changePage";var j="page";var k={};var f="";var g={};var o={};var p={};var i={};var n=function(A,u,v,z,t){if(!u||u<0){l.pageSize=r}else{l.pageSize=u}l.totalSize=t.length;l.curPage=1;if(!z){z=c}f=z;k=t;var w=$("<div class='paging' id="+v+"><span class='pageUpGray'>上一页</span><label></label><span class='nextPageGrayOrange'>下一页</span><label class='marginTop4'></label><label class='marginTop4'>跳转至</label><input type='text' class='inputW20H20'/><label class='marginTop4'>页</label><a class='determineBtn' href='#'>跳转</a>");$("#"+A).append(w);var y=Math.ceil(l.totalSize/l.pageSize);if(y>0){for(var x=0;x<y;x++){$("<a class='fontBlueB' href='#'>"+(x+1)+"</a>").appendTo(w.find("label:first"))}}l.totalPage=y;o=w.find("span:eq(0)");o.click(function(){common.page.turnPrePage()});p=w.find("span:eq(1)");p.click(function(){common.page.turnNextPage()});g=w;i=g.find("label:eq(0)");$.each(i.find("a"),function(C,B){$(this).click(function(){common.page.turnToPage(parseInt($.trim($(this).text())))})});g.find("a:last").click(function(){var B=$.trim(g.find("input").val());if(!/^\d+$/g.test(B)){$.alert("提示","请正确输入要跳转的页数");return}if(B<1||B>l.totalPage){$.alert("提示","超过搜索范围");return}common.page.turnToPage(parseInt(B))});common.page.turnFirstPage()};var q=function(){if(l.curPage==1){$.alert("提示","已经到第一页");return}else{$(this).dispatchJEvent(f,b(--l.curPage));if(l.curPage==1){o.removeClass("pageUpOrange").addClass("pageUpGray").attr("disabled","disabled")}else{p.removeClass("nextPageGray").addClass("nextPageGrayOrange").removeAttr("disabled")}a(l.curPage)}};var s=function(){if(l.curPage==l.totalPage){$.alert("提示","已经到最后一页");p.removeClass("nextPageGrayOrange").addClass("nextPageGray");return}else{$(this).dispatchJEvent(f,b(++l.curPage));if(l.curPage==l.totalPage){p.removeClass("nextPageGrayOrange").addClass("nextPageGray").attr("disabled","disabled")}else{o.removeClass("pageUpGray").addClass("pageUpOrange").removeAttr("disabled")}a(l.curPage)}};var b=function(v){var t=[];for(var u=(v-1)*l.pageSize+1;u<v*l.pageSize+1;u++){if(u>l.totalSize){break}t.push(k[u-1])}return t};var h=function(){var t=[];for(var u=1;u<l.pageSize+1;u++){if(u>l.totalSize){break}t.push(k[u-1])}o.attr("disabled","disabled");$(this).dispatchJEvent(f,t);a(1)};var a=function(t){$.each(i.find("a"),function(v,u){if(t==parseInt($.trim($(this).text()))){$(this).addClass("pagingSelect")}else{$(this).removeClass("pagingSelect")}})};var m=function(t){$(this).dispatchJEvent(f,b(t));a(t);l.curPage=t};return{init:n,turnPrePage:q,turnNextPage:s,turnFirstPage:h,turnToPage:m}})();CommonUtils.regNamespace("order","cust");order.cust=(function(){var a={};var ac={};var C=null;var Q=null;var Y="0";var n=null;var q=[];var H="";var V=[];var t=[];var Z={};var J=false;var E=function(){return C};var D="";var S=function(){$("#custAuthForm").bind("formIsValid",function(aj,ai){var ak=a;ak.prodPwd=$.trim($("#authPassword").val());ak.accessNumber=a.accessNumber;ak.authFlag=Q;$.callServiceAsHtml(contextPath+"/cust/custAuth",ak,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(al){if(al.code==-2){return}if(al.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}try{var an=$.parseJSON(al.data);$.alertMore("异常信息",an.resultMsg,an.errorStack,"error");return}catch(am){}if(!order.cust.queryForChooseUser){C=ak;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;y(al)}else{order.main.showChooseUserDialog(ak)}},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"custAuthbtn"});$("#custAuthFormID").bind("formIsValid",function(aj,ai){var ak=a;ak.pCustIdentityCd=$("#p_cust_identityCd").val();ak.identityNum=base64encode($.trim($("#authIDTD").val()));ak.custId=a.custId;ak.authFlag=Q;$.callServiceAsHtml(contextPath+"/cust/custAuth",ak,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(al){if(al.code==-2){return}if(al.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的身份证号有误，请重新输入。");return}try{var an=$.parseJSON(al.data);$.alertMore("异常信息",an.resultMsg,an.errorStack,"error");return}catch(am){}if(!order.cust.queryForChooseUser){C=ak;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;y(al)}else{order.main.showChooseUserDialog(ak)}},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"custAuthbtnID"});$("#useraddclose").off("click").on("click",function(ai){easyDialog.close();$("#cCustName").val("");$("#cCustIdCard").val("");$("#discontactName").val("");$("#dishomePhone").val("");$("#disofficePhone").val("");$("#dismobilePhone").val("");Q="";if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}});$("#custresetBtn").off("click").on("click",function(ai){if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}$("#btncustreset").click()})};var u=function(aj,ak){var ai=$(aj).val();$("#"+ak).empty();m(ai,ak)};var m=function(ai,al){var am={partyTypeCd:ai};var aj=contextPath+"/cust/queryCertType";var an=$.callServiceAsJson(aj,am,{});if(an.code==-2){$.alertM(an.data)}if(an.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");
return}if(an.code==0){var aq=an.data;if(aq!=undefined&&aq.length>0){var av=[];for(var ar=0;ar<aq.length;ar++){var ap=true;var ak=aq[ar].certTypeCd;for(var ao=0;ao<av.length;ao++){ap=ap&&aq[ar].certTypeCd!=av[ao].certTypeCd;if(!ap){break}}var at=false;if(OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZQZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.GZZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.HYKHZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.SYKHZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.XYKHZXDL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.GZZXJL||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZYOUT||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZYINGT||OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.WBT||ai!="1"){at=true}if(!at&&ak=="1"){at=true}if(ap&&at){av.push(aq[ar])}}for(var ar=0;ar<av.length;ar++){var au=av[ar];$("#"+al).append("<option value='"+au.certTypeCd+"' >"+au.name+"</option>")}if(al=="identidiesTypeCd"&&OrderInfo.staff.idType=="OFF"){$("#"+al+" option[value='1']").remove();$("#readCertBtnCreate").hide()}}}};var U=function(ai,ak){var aj=$(ai).val();if(aj==-1){$("#"+ak).attr("placeHolder","请输入接入号码");$("#"+ak).attr("data-validate","validate(required:请准确填写接入号码) on(keyup)")}else{if(aj==1){$("#"+ak).attr("placeHolder","请输入身份证号码");$("#"+ak).attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(keyup)")}else{if(aj==2){$("#"+ak).attr("placeHolder","请输入军官证");$("#"+ak).attr("data-validate","validate(required:请准确填写军官证) on(keyup)")}else{if(aj==3){$("#"+ak).attr("placeHolder","请输入护照");$("#"+ak).attr("data-validate","validate(required:请准确填写护照) on(keyup)")}else{$("#"+ak).attr("placeHolder","请输入证件号码");$("#"+ak).attr("data-validate","validate(required:请准确填写证件号码) on(keyup)")}}}}if(aj!=-1){$("#isAppointNum").attr("checked",false)}if(ak=="p_cust_identityNum_choose"){W()}else{h()}$("#p_cust_identityNum").attr("disabled",false)};var i=function(ai,ak){var aj=$(ai).val();if(aj==1){$("#"+ak).attr("placeHolder","请输入合法身份证号码");$("#"+ak).attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(aj==2){$("#"+ak).attr("placeHolder","请输入合法军官证");$("#"+ak).attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(aj==3){$("#"+ak).attr("placeHolder","请输入合法护照");$("#"+ak).attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#"+ak).attr("placeHolder","请输入合法证件号码");$("#"+ak).attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}x();$("#cCustIdCard").attr("disabled",false);$("#cCustName").attr("disabled",false);$("#cAddressStr").attr("disabled",false)};var h=function(){$("#custQueryFirstForm").off().bind("formIsValid",function(aj,am){var ak=contextPath+"/order/createorderlonger";var ap=$.callServiceAsJson(ak,{});if(ap.code==0){OrderInfo.custorderlonger=ap.data}var au="";var at="";var al="";var ai="";var aq="";var ao="";var ar="";au=$("#p_cust_identityCd").val();aq=$.trim($("#p_cust_identityNum").val());if(order.cust.fromProvFlag=="1"||(au!=-1&&CONST.getAppDesc()!=0)){au=$("#p_cust_identityCd").val();Q="1"}else{Q="0"}if(au==-1){ai=aq;aq="";au=""}else{if(au=="acctCd"||au=="custNumber"){ai="";aq="";au="";ao=$("#p_cust_identityCd").val();ar=$.trim($("#p_cust_identityNum").val())}}al=$("#DiffPlaceFlag").val();areaId=$("#p_cust_areaId").val();if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");return}var an={acctNbr:ai,identityCd:au,identityNum:aq,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:al,areaId:areaId,queryType:ao,queryTypeValue:ar,identidies_type:$("#p_cust_identityCd  option:selected").text()};$.callServiceAsHtml(contextPath+"/cust/queryCust",an,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(av){if(av.code==-2){return}ad(av)},fail:function(av){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})}).ketchup({bindElement:"usersearchbtn"})};var x=function(){$("#custCreateForm").off().bind("formIsValid",function(ak){var aj=contextPath+"/order/createorderlonger";var ai=$.callServiceAsJson(aj,{});if(ai.code==0){OrderInfo.custorderlonger=ai.data}o()}).ketchup({bindElement:"createcustsussbtn"})};var ad=function(ai){if(ai.data.indexOf("showVerificationcode")>=0){$("#vali_code_input").val("");$("#validatecodeImg").css({width:"80px",height:"32px"}).attr("src",contextPath+"/validatecode/codeimg.jpg?"+Math.floor(Math.random()*100)).fadeIn();easyDialog.open({container:"Verificationcode_div"});return}if(ai.data.indexOf("false")>=0){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}var aj=$("#custList");aj.html(ai.data).show();$(".userclose").off("click").on("click",function(ak){Q="";$(".usersearchcon").hide()});if($("#custListTable").attr("custInfoSize")=="1"){$(".usersearchcon").hide()}};var P=function(){if((0!=OrderInfo.order.step)||(0==OrderInfo.order.step&&OrderInfo.actionFlag==2)){window.location.reload()}if($("#subPage").val()=="number"){window.location.reload()}$("#custQryDiv").show();$("#custInfo").hide();$("#p_cust_identityNum").val("");$("#authPassword").val("");Q="";OrderInfo.boCusts.partyId="";OrderInfo.boCustInfos.name="";OrderInfo.boCustIdentities.identityNum="";OrderInfo.cust={custId:-1,custName:"",areaId:""};OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId="";OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.cust="";order.cust.orderBtnflag="";OrderInfo.order.step=0;if((CONST.getAppDesc()!=0)&&($("#custModifyId").is(":hidden"))){$("#custModifyId").show()}};var r=function(ai){var aj=a;aj.prodPwd=$.trim($("#authPassword").val());aj.authFlag=Q;$.callServiceAsHtml(contextPath+"/cust/custAuth",aj,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(ak){if(ak.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(!order.cust.queryForChooseUser){C=aj;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;y(ak)}else{order.main.showChooseUserDialog(aj)}},always:function(){$.unecOverlay()}})};var X=function(){if(order.cust.jumpAuthflag!="0"){$.alert("提示","没有跳过校验权限！");return}var ai=a;ai.authFlag="1";$.callServiceAsHtml(contextPath+"/cust/custAuth",ai,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(aj){if(aj.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(!order.cust.queryForChooseUser){C=ai;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;y(aj)}else{order.main.showChooseUserDialog(ai)}},always:function(){$.unecOverlay()}})};var y=function(ai){if(Q=="0"){easyDialog.close()}$("#custList").hide();$("#custQryDiv").hide();if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}var aj=$("#custInfo");aj.html(ai.data).show();if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){$("#custModifyId").attr("style","display: none;")}else{$("#custModifyId").attr("style","")}$("#cCustName").val("");$("#cCustIdCard").val("");main.home.hideMainIco()};var c=function(ak){a={custId:$(ak).find("td:eq(3)").text(),partyName:$(ak).find("td:eq(0)").text(),idCardNumber:$(ak).find("td:eq(4)").text(),identityName:$(ak).attr("identityName"),areaName:$(ak).attr("areaName"),areaId:$(ak).attr("areaId"),identityCd:$(ak).attr("identityCd"),addressStr:$(ak).attr("addressStr"),norTaxPayer:$(ak).attr("norTaxPayer"),segmentId:$(ak).attr("segmentId"),segmentName:$(ak).attr("segmentName"),custFlag:$(ak).attr("custFlag"),vipLevel:$(ak).attr("vipLevel"),vipLevelName:$(ak).attr("vipLevelName")};$(ak).attr("selected","selected");$(ak).siblings().each(function(){$(this).removeAttr("selected")});var al=false;for(var ai=0;ai<=CacheData.getGovCertType().length;ai++){if(a.identityCd==CacheData.getGovCertType()[ai]){al=true;
break}}if(order.cust.queryForChooseUser&&al){$.alert("提示","使用人必须是公众客户，请重新定位。");return false}if(Q=="0"){if(order.cust.authType=="00"){$("#custAuthTypeName").html("客户密码：")}else{$("#custAuthTypeName").html("产品密码：")}var aj=$("#p_cust_identityCd").val();if("1"==aj){$("#authIDTD").attr("disabled",false);easyDialog.open({container:"authID",callback:function(){order.cust.queryForChooseUser=false}})}else{easyDialog.open({container:"auth",callback:function(){order.cust.queryForChooseUser=false}})}if(order.cust.jumpAuthflag=="0"){$("#jumpAuth").off("click").on("click",function(){order.cust.jumpAuth()});$("#jumpAuth").show();$("#jumpAuthID").show()}$("#authClose").off("click").on("click",function(am){easyDialog.close();$("#authPassword").val("")});$("#authIDClose").off("click").on("click",function(am){easyDialog.close();$("#authIDTD").val("")})}else{r(ak)}};var A=function(ai){var aj=$("#p_cust_areaId").val();if(aj.indexOf("0000")>0){$.alert("提示","前页受理地区为省级地区无法进行创建,请先选择市级地区！");return}tabProfileFlag="1";u($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");j("identidiesTypeCd","1");i($("#identidiesTypeCd  option:selected").length?$("#identidiesTypeCd  option:selected"):$("#identidiesTypeCd").children(":first-child"),"cCustIdCard");x();z();$("#partyProfile").attr("style","display:none");easyDialog.open({container:"user_add"})};var j=function(aj,ai){if($("#"+aj+"  option:selected").val()!=ai){$("#"+aj+"  option").each(function(){if($(this).val()==ai){$(this).attr("selected","selected")}else{$(this).removeAttr("selected")}})}};var ab=function(aj){var ak={};if(a==null){ak.custId=""}else{ak.custId=a.custId;ak.areaId=$("#area").attr("areaId")}if(document.getElementById("accNbrQuery")){ak.acctNbr=$.trim($("#accNbrQuery").val());if(CONST.getAppDesc()==0){ak.areaId=$("#p_cust_areaId").val()}}else{if($("#isAppointNum").attr("checked")=="checked"){ak.acctNbr=$.trim($("#p_cust_identityNum").val());if(CONST.getAppDesc()==0){ak.areaId=$("#p_cust_areaId").val()}}else{ak.acctNbr=""}}if(document.getElementById("custPageSize")){ak.pageSize=$.trim($("#custPageSize").val());if(!(/^[1-9]\d*$/.test(ak.pageSize))&&(ak.pageSize!="")){$.alert("提示信息","页码格式不正确，必须为有效数字。");return false}if(ak.pageSize>15){$.alert("提示信息","页数大小不能超过15。");return false}}else{ak.pageSize=""}ak.curPage=aj;ak.DiffPlaceFlag=$("#DiffPlaceFlag").val();if(ak.custId==null||ak.custId==""){$.alert("提示","无法查询已订购产品");return}var ai=contextPath+"/cust/orderprod";$.callServiceAsHtmlGet(ai,ak,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(al){if(!al){al.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(al.code==-2){return}else{if(al.code!=0){$.alert("提示","查询失败,稍后重试");return}}var am=$("#orderedprod");am.html(al.data);$("#phoneNumListtbody tr").off("click").on("click",function(an){var ao=this;if(1==OrderInfo.order.step&&(!$(ao).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){v();g(ao);OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(ao).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();v();g(ao);OrderInfo.order.step=0},no:function(){null}})}else{g(this)}}});$("#plan2ndDiv tbody tr").each(function(){$(this).off("click").on("click",function(ao){var an=this;if(1==OrderInfo.order.step&&(!$(an).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){v();order.cust.linkSelectPlan(an);ao.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(an).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();v();order.cust.linkSelectPlan(an);ao.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{order.cust.linkSelectPlan(this);ao.stopPropagation()}}})});$("#phoneNumListtbody").children(":first-child").next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();$("#phoneNumListtbody").children(":first-child").click()}})};var g=function(aj){$("#is3GCheckbox").off().change(function(){order.prodModify.getChooseProdInfo()});$("#phoneNumListtbody tr").filter(".plan_select").children(":first-child").html("");$("#phoneNumListtbody tr").filter(".plan_select").removeClass("plan_select").next("#plan2ndTr").hide();$(aj).addClass("plan_select").next("#plan2ndTr").show();var ai="<i class='select'></i>";$(aj).children(":first-child").html(ai);$(aj).next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click()};var s=function(aj){$("#plan2ndDiv tbody tr").removeClass("plan_select2");$("#plan2ndDiv tbody tr").children(":first-child").next().html("");$(aj).addClass("plan_select2");var ai="<i class='select'></i>";$(aj).children(":first-child").next().html(ai);order.prodModify.getChooseProdInfo()};var ag=function(aj){if(OrderInfo.cust.custId==-1){$.alert("提示","新建客户无法查询已订购产品！");return}var ai=1;$("#prodDetail").hide();$("#prodInfo").hide();$("#prodList").show();$("#orderContent").show();if(order.cust.orderBtnflag==""){main.home.hideMainIco();ab(ai);$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{if(order.cust.orderBtnflag=="0"||$("#orderedprod").is(":hidden")){$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{$("#orderedprod").hide();$("#arroworder").removeClass();$("#arroworder").addClass("arrow");order.cust.orderBtnflag="0";$("#orderbutton").css({height:"24px","border-bottom":"1px solid #4f7d3f"})}}};var G=function(){order.area.chooseAreaTree("/order/prepare","p_cust_areaId_val","p_cust_areaId",3,function(aj,ai,ak){OrderInfo.staff.soAreaId=aj;OrderInfo.staff.soAreaName=ak;OrderInfo.staff.soAreaCode=ai;$("#order_prepare").show();$("#order_tab_panel_content").hide();$("#step1").hide()})};var b=function(){order.area.chooseAreaTree("/order/prepare","p_cust_areaId_val_choose","p_cust_areaId_choose",3,function(aj,ai,ak){OrderInfo.staff.soAreaId=aj;OrderInfo.staff.soAreaName=ak;OrderInfo.staff.soAreaCode=ai})};var L=function(){order.area.chooseAreaTreeManger("cust/preQueryCust","p_areaId_val","p_areaId",3)};var ae=function(){order.area.chooseAreaTreeAll("p_cust_areaId_val","p_cust_areaId",3,"limitProvince")};var B=function(){order.area.chooseAreaTreeCurrent("p_staff_areaId_val","p_staff_areaId",3,"limitProvince",$("#p_staff_areaId").val().substring(0,3)+"0000")};var f=function(){order.area.chooseAreaTree("/order/prepare","p_ncust_areaId_val","p_ncust_areaId",3)};var K=function(){order.area.chooseAreaTree("/order/prepare","prodareaName","prodareaid",3);order.prodModify.choosedProdInfo.areaId=$("#prodareaid").val()};var k=function(){m("-1","p_cust_identityCd");m("-1","p_cust_identityCd_choose");U($("#p_cust_identityCd").children(":first-child"),"p_cust_identityNum");af()};var af=function(){if($("#fromProvFlag").length&&$("#fromProvFlag").val()=="1"){order.cust.fromProvFlag="1";order.cust.provIsale=$("#provIsale").val();$("#p_cust_areaId_val").val("");$("#p_cust_areaId").val($("#provAreaId").val());$("#p_cust_identityCd").val($("#provIdentityCd").val());$("#p_cust_identityNum").val($("#provIdentityNum").val());if($("#provIdentityCd").val()!=-1){$("#isAppointNum").attr("checked",false)}$("#usersearchbtn").click()}else{order.cust.fromProvFlag="0";order.cust.provIsale=null}};var z=function(){var ai={};$.callServiceAsHtmlGet(contextPath+"/cust/partyProfileSpecList",ai,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")
},always:function(){$.unecOverlay()},done:function(aj){if(aj.code==-2){return}$("#partyProfile").html(aj.data)}})};var w=function(){if($("#partyProfile").is(":hidden")){$("#partyProfile").show();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrowup");order.cust.changeLabel(0)}else{$("#partyProfile").hide();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrow");$("#tabProfile0").attr("click","1");$("#contactName").attr("data-validate","");x()}};var l=function(){var ak="";var ai="";var aj="";ak=$("#p_cust_identityCd").val();aj=$.trim($("#p_cust_identityNum").val());if(aj==""){$.alert("提示","请输入证件号码！");return}if(ak==1){ak=$("#p_cust_identityCd").val()}if(ak==-1){ai=aj;aj="";ak=""}diffPlace=$("#DiffPlaceFlag").val();areaId=$("#p_areaId").val();var al={acctNbr:ai,identityCd:ak,identityNum:aj,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:areaId};$.callServiceAsHtmlGet(contextPath+"/cust/queryCustAlone",al,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(am){if(am.code==-2){return}if(!am){am.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(am.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(am.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctList").html(am.data).show();$("#acctDetail").hide()},fail:function(am){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var p=function(aj){var ai={partyId:aj,areaId:$("#p_areaId").val()};$.callServiceAsHtml(contextPath+"/cust/custInfo",ai,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(ak){if(ak.code==-2){return}if(!ak){ak.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(ak.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(ak.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctDetail").html(ak.data).show();$("#acctList").hide()},fail:function(ak){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var T=function(ai){var aj={};aj.partyName=OrderInfo.cust.partyName;aj.custId=OrderInfo.cust.custId;aj.idCardNumber=OrderInfo.cust.idCardNumber;$.callServiceAsHtml(contextPath+"/cust/mvnoCustCreate",aj,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(ak){if(ak.code==-2){return}var al=$("#order_fill_content");al.html(ak.data).show();u($("#cmPartyTypeCd").children(":first-child"),"cc_identidiesTypeCd");i($("#div_cm_identidiesType").children(":first-child"),"ccCustIdCard");$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();$("#step1").show();$(".ordercon a:first span").text("取 消");_form_custInfomodify_btn()},always:function(){$.unecOverlay()}})};var R=function(){var ak=true;$("#user_add  input").each(function(){var aq=/[^\x00-\xFF]/g;var ap=$(this).attr("maxlength");var ao=$(this).val().replace(aq,"..").length;if(ao>ap){$.alert("提示",$(this).attr("id")+"字符超长！,请限制在"+ap+"字符！(中文算两个字符！)");ak=false;return false}});if(!ak){return false}ac={cAreaId:OrderInfo.staff.soAreaId,cAreaName:OrderInfo.staff.soAreaName,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cPartyTypeName:($.trim($("#partyTypeCd  option:selected").val())==1)?"个人客户":"政企客户",cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val()),cMailAddressStr:$.trim($("#cMailAddressStr").val())};var ai={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$.trim($("#headFlag  option:selected").val()),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postcode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};OrderInfo.boCustInfos.name=ac.cCustName;OrderInfo.boCustInfos.areaId=ac.cAreaId;OrderInfo.boCustInfos.partyTypeCd=ac.cPartyTypeCd;OrderInfo.boCustInfos.defaultIdType=ac.cIdentidiesTypeCd;OrderInfo.boCustInfos.addressStr=ac.cAddressStr;OrderInfo.boCustInfos.mailAddressStr=ac.cMailAddressStr;OrderInfo.boCustIdentities.identidiesTypeCd=ac.cIdentidiesTypeCd;OrderInfo.boCustIdentities.identityNum=ac.cCustIdCard;OrderInfo.boPartyContactInfo.contactAddress=ai.contactAddress,OrderInfo.boPartyContactInfo.contactDesc=ai.contactDesc,OrderInfo.boPartyContactInfo.contactEmployer=ai.contactEmployer,OrderInfo.boPartyContactInfo.contactGender=ai.contactGender,OrderInfo.boPartyContactInfo.contactId=ai.contactId,OrderInfo.boPartyContactInfo.contactName=ai.contactName,OrderInfo.boPartyContactInfo.contactType=ai.contactType,OrderInfo.boPartyContactInfo.eMail=ai.eMail,OrderInfo.boPartyContactInfo.fax=ai.fax,OrderInfo.boPartyContactInfo.headFlag=ai.headFlag,OrderInfo.boPartyContactInfo.homePhone=ai.homePhone,OrderInfo.boPartyContactInfo.mobilePhone=ai.mobilePhone,OrderInfo.boPartyContactInfo.officePhone=ai.officePhone,OrderInfo.boPartyContactInfo.postAddress=ai.postAddress,OrderInfo.boPartyContactInfo.postcode=ai.postcode,OrderInfo.boPartyContactInfo.staffId=ai.staffId,OrderInfo.boPartyContactInfo.state=ai.state,OrderInfo.boPartyContactInfo.statusCd=ai.statusCd;OrderInfo.cust={custId:-1,partyName:ac.cCustName,areaId:ac.cAreaId};OrderInfo.boCustProfiles=[];for(var aj=0;aj<order.cust.partyProfiles.length;aj++){var am=order.cust.partyProfiles[aj];var al=$("#"+am.attrId).val();if(""==al||undefined==al){al==$("#"+am.attrId+"option:selected").val()}var am={partyProfileCatgCd:am.attrId,profileValue:al,state:"ADD"};if(""!=al&&al!=undefined){OrderInfo.boCustProfiles.push(am)}}easyDialog.close();var an={};an.prodPwd="";an.accessNumber="";an.authFlag="1";Q="";an.identityCd=ac.cIdentidiesTypeCd;an.idCardNumber=ac.cCustIdCard;an.partyName=ac.cCustName;an.areaId=ac.cAreaId;an.areaName=ac.cAreaName;an.segmentName=ac.cPartyTypeName;an.identityName=$("#identidiesTypeCd  option:selected").text();$.callServiceAsHtml(contextPath+"/cust/custAuth",an,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(ao){if(ao.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(ao.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}y(ao)},always:function(){$.unecOverlay()}})};var o=function(){if(!ec.util.isObj($.trim($("#identidiesTypeCd  option:selected").val()))){$.alert("提示","证件类型不能为空！","information");return}var an=$("#p_cust_areaId").val();if(an==null||an==""){an=OrderInfo.staff.areaId}var ak=$("#p_cust_areaId_val").val();ac={cAreaId:an,cAreaName:ak,cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};diffPlace=$("#DiffPlaceFlag").val();var am={acctNbr:"",identityCd:ac.cIdentidiesTypeCd,identityNum:ac.cCustIdCard,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:ac.cAreaId};var aj=contextPath+"/cust/checkIdentity";var ai=$.callServiceAsJson(aj,am,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});var al="";if(ai.code==0){$.unecOverlay();$.confirm("确认","此证件号码已存在,是否确认新建?",{yes:function(){R()},no:function(){}})}else{$.unecOverlay();R()}};var aa=function(ak){if($("#partyProfile").is(":visible")==false){$("#partyProfile").show()}if(ak=="0"){$("#tabProfile0").show();$("#cardtab_pro_0").addClass("setcon");$("#tabProfile0").attr("click","0");
$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(blur)").attr("placeholder","请准确填写联系人名称");x()}else{if(($("#tabProfile0").attr("click")=="0")&&($("#contactName").val()=="")){$.alert("提示","联系人名称不能为空！","information");return}}for(var aj=0;aj<order.cust.profileTabLists.length;aj++){var am=order.cust.profileTabLists[aj];var ai=am.tabProfileNum;var al=am.partyProfileCatgTypeCd;if(ak==al){$("#"+ai).show();$("#cardtab_pro_"+al).addClass("setcon");$("#tabProfile0").hide();$("#cardtab_pro_0").removeClass("setcon")}else{$("#"+ai).hide();$("#cardtab_pro_"+al).removeClass("setcon")}}};var ah=function(ai){ai=ai||"p_cust_identityCd";if($("#"+ai).val()!=-1){$.alert("提示","只能接入号码才能指定号码！","information");$("#isAppointNum").attr("checked",false);return}};var v=function(){var ai=OrderInfo.boProd2Tds;if(ai.length>0){for(var al=0;al<ai.length;al++){var ak={numType:2,numValue:ai[al].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",ak)}}var aj=OrderInfo.boProdAns;if(aj.length>0){for(var al=0;al<aj.length;al++){if(aj[al].idFlag){continue}var ak={numType:1,numValue:aj[al].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",ak)}order.service.boProdAn={};order.phoneNumber.resetBoProdAn()}$("#order_fill_content").empty();order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show()};var I=function(){$("#acctDetail").hide();$("#acctList").show()};var O=function(){var ai=cert.readCert();if(ai.resultFlag!=0){$.alert("提示",ai.errorMsg);return}$("#p_cust_identityCd").val(1);U($("#p_cust_identityCd").children(":first-child"),"p_cust_identityNum");$("#p_cust_identityNum").val(ai.resultContent.certNumber);$("#p_cust_identityNum").attr("disabled",true);$("#usersearchbtn").click()};var N=function(){var ai=cert.readCert();if(ai.resultFlag!=0){$.alert("提示",ai.errorMsg);return}$("#partyTypeCd").val(1);u($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");$("#identidiesTypeCd").val(1);i($("#identidiesTypeCd").children(":first-child"),"cCustIdCard");$("#cCustIdCard").val(ai.resultContent.certNumber);$("#cCustIdCard").attr("disabled",true);$("#cCustName").val(ai.resultContent.partyName);$("#cCustName").attr("disabled",true);$("#cAddressStr").val(ai.resultContent.certAddress);$("#cAddressStr").attr("disabled",true)};var M=function(){var ai=cert.readCert();if(ai.resultFlag!=0){$.alert("提示",ai.errorMsg);return}$("#authIDTD").val(ai.resultContent.certNumber);$("#authIDTD").attr("disabled",true);$("#custAuthbtnID").click()};var W=function(){$("#custQueryForChooseForm").off().bind("formIsValid",function(aj,al){var ar="";var aq="";var ak="";var ai="";var ao="";var an="";var ap="";ar=$("#p_cust_identityCd_choose").val();ao=$.trim($("#p_cust_identityNum_choose").val());Q="0";if(ar==-1){ai=ao;ao="";ar=""}else{if(ar=="acctCd"||ar=="custNumber"){ai="";ao="";ar="";an=$("#p_cust_identityCd").val();ap=$.trim($("#p_cust_identityNum_choose").val())}}ak=$("#DiffPlaceFlag_choose").val();areaId=$("#p_cust_areaId_choose").val();if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");return}var am={acctNbr:ai,identityCd:ar,identityNum:ao,partyName:"",custQueryType:$("#custQueryType_choose").val(),diffPlace:ak,areaId:areaId,queryType:an,queryTypeValue:ap,identidies_type:$("#p_cust_identityCd_choose  option:selected").text()};$.callServiceAsHtml(contextPath+"/cust/queryCust",am,{before:function(){$.ecOverlay("<strong>正在查询中，请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(at){if(at.code==-2){return}if(at.data.indexOf("false")>=0){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}order.cust.jumpAuthflag=$(at.data).find("#jumpAuthflag").val();order.cust.showCustAuth($(at.data).find("#custInfos"))},fail:function(at){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")}})}).ketchup({bindElement:"userSearchForChooseBtn"})};var F=function(ao,av,ar,aq){var ai={acctNbr:"",areaId:av,diffPlace:"local",identidies_type:"",identityCd:"",identityNum:"",olTypeCd:"8",operType:ar,partyName:"",prodClass:"12",queryType:"",queryTypeValue:""};if(ar==1){ai.queryTypeValue=ao;ai.identidies_type="客户编码";ai.queryType="custNumber"}else{ai.acctNbr=ao;ai.identidies_type="接入号码"}$.ecOverlay("<strong>正在查询客户架构信息中,请稍等...</strong>");var ak=$.callServiceAsJson(contextPath+"/token/pc/cust/queryCustCompreInfo",ai);$.unecOverlay();if(ak.code==0){if(ak.data==null){$.alert("提示","客户架构信息接口无数据返回。");return false}if(ak.data.custInfos==undefined){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return false}else{if(!ec.util.isArray(ak.data.custInfos)){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return false}}if(ak.data.prodInstInfos==undefined&&ar!=1){$.alert("提示","客户下没有可以办理业务的移动用户。");return false}if(ak.data.offerMemberInfos==undefined&&ar!=1){$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理。");return false}if(aq=="OLD"){var aj=ak.data.custInfos;if(OrderInfo.actionFlag!=1&&aj[0].custId!=OrderInfo.cust.custId){$.alert("提示",ao+"和主卡的客户不一致！");return false}var au={};var al=ak.data.prodInstInfos;$.each(al,function(){if(this.accNbr==ao){au=this;if(au.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示",ao+"不是在用产品！");return false}if(OrderInfo.actionFlag!=1&&au.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){$.alert("提示",ao+"和主卡的付费类型不一致！");return false}if(au.productId=="280000000"){$.alert("提示",ao+"是无线宽带，不能纳入！");return false}au.custId=aj[0].custId;OrderInfo.oldprodInstInfos.push(au)}});var ap=true;for(var an=0;an<ak.data.offerMemberInfos.length;an++){var am=ak.data.offerMemberInfos[an];if(am.objType==""){$.alert("提示","销售品实例构成 "+am.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(am.objType==CONST.OBJ_TYPE.PROD){if(am.accessNumber==""){$.alert("提示","销售品实例构成 "+am.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(am.objInstId==au.prodInstId){ap=false}}if(ap){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+au.accNbr+"】，无法继续受理，请业务后台核实");return false}var at={offerMemberInfos:ak.data.offerMemberInfos,offerId:au.mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:au.mainProdOfferInstInfos[0].prodOfferId,offerSpecName:au.mainProdOfferInstInfos[0].prodOfferName,accNbr:au.accNbr};OrderInfo.oldoffer.push(at);order.memberChange.viceCartNum=0;$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){order.memberChange.viceCartNum++}})})}else{var aj=ak.data.custInfos;OrderInfo.cust={addressStr:aj[0].addressStr,areaId:aj[0].areaId,areaName:aj[0].areaName,authFlag:aj[0].authType,custFlag:aj[0].custFlag,custId:aj[0].custId,idCardNumber:aj[0].idCardNumber,identityCd:aj[0].identityCd,identityName:aj[0].identityName,norTaxPayer:"",partyName:aj[0].partyName,segmentId:aj[0].segmentId,segmentName:aj[0].segmentName,vipLevel:aj[0].vipLevel,vipLevelName:aj[0].vipLevelName};if(ar!=1){var au=ak.data.prodInstInfos;order.prodModify.choosedProdInfo={accNbr:au[0].accNbr,areaCode:au[0].zoneNumber,areaId:au[0].areaId,corProdInstId:au[0].corProdInstId,custId:au[0].mainProdOfferInstInfos[0].custId,custName:au[0].mainProdOfferInstInfos[0].custName,endDt:au[0].mainProdOfferInstInfos[0].endDt,extProdInstId:au[0].extProductId,feeType:au[0].feeType.feeType,feeTypeName:au[0].feeType.feeTypeName,is3G:au[0].mainProdOfferInstInfos[0].is3G,prodBigClass:au[0].prodBigClass,prodClass:au[0].prodClass,prodInstId:au[0].prodInstId,prodOfferId:au[0].mainProdOfferInstInfos[0].prodOfferId,prodOfferInstId:au[0].mainProdOfferInstInfos[0].prodOfferInstId,prodOfferName:au[0].mainProdOfferInstInfos[0].prodOfferName,prodStateCd:au[0].prodStateCd,prodStateName:au[0].prodStateName,productId:au[0].productId,productName:au[0].productName,startDt:au[0].mainProdOfferInstInfos[0].startDt,stopRecordCd:au[0].prodStopRecords[0].stopRecordCd,stopRecordName:au[0].prodStopRecords[0].stopRecordName};var ap=true;for(var an=0;an<ak.data.offerMemberInfos.length;an++){var am=ak.data.offerMemberInfos[an];if(am.objType==""){$.alert("提示","销售品实例构成 "+am.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(am.objType==CONST.OBJ_TYPE.PROD){if(am.accessNumber==""){$.alert("提示","销售品实例构成 "+am.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
return false}}}if(am.objInstId==order.prodModify.choosedProdInfo.prodInstId){ap=false}}if(ap){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+order.prodModify.choosedProdInfo.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=ak.data.offerMemberInfos;OrderInfo.offer.offerId=order.prodModify.choosedProdInfo.prodOfferInstId;OrderInfo.offer.offerSpecId=order.prodModify.choosedProdInfo.prodOfferId;OrderInfo.offer.offerSpecName=order.prodModify.choosedProdInfo.prodOfferName}}}else{$.alertM(ak.data);return false}return true};return{form_valid_init:S,showCustAuth:c,showCustCreate:A,custAuth:r,getCustInfo:E,custReset:P,btnQueryCustProd:ab,btnQueryCustProdMore:ag,jumpAuth:X,identidiesTypeCdChoose:i,custidentidiesTypeCdChoose:U,choosedCustInfo:a,partyTypeCdChoose:u,chooseArea:G,chooseAllArea:ae,chooseStaffArea:B,newCustChooseArea:f,prodChooseArea:K,initDic:k,btnMoreProfile:w,partyProfiles:V,profileTabLists:t,queryCust:l,queryCustDetail:p,mvnoCustCreate:T,changeLabel:aa,jumpAuthflag:H,orderBtnflag:D,custcreateButton:x,isAppointNum:ah,preQueryCustChooseArea:L,linkSelectPlan:s,back:I,readCert:O,readCertWhenCreate:N,readCertWhenAuth:M,fromProvFlag:Y,provIsale:n,chooseAreaForChooseUser:b,certTypeByPartyType:m,bindCustQueryForChoose:W,tmpChooseUserInfo:Z,queryForChooseUser:J,queryCustCompreInfo:F}})();$(function(){order.cust.initDic()});CommonUtils.regNamespace("uiAttachOffer");uiAttachOffer=(function(){var _openList=[];var _openedList=[];var _openServList=[];var _openedServList=[];var _openAppList=[];var _changeList=[];var _labelList=[];var isRightCheck="N";var totalNums=0;var _init=function(){var prodInfo=order.prodModify.choosedProdInfo;if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){order.uiCust.showPackageDialog("客户无可用产品,无法操作!");return}OrderInfo.actionFlag=3;if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!uiOfferQuery.setOffer()){return}}var boInfos=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,instId:prodInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:prodInfo.prodInstId},{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,instId:prodInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:prodInfo.prodInstId}];if(!rule.rule.ruleCheck(boInfos)){return}var param={offerSpecId:prodInfo.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};if(ec.util.isObj(prodInfo.prodOfferId)){if(!query.offer.queryMainOfferSpec(param)){return}}else{OrderInfo.offerSpec={}}if(CONST.getAppDesc()==0){if(!prod.uim.setProdUim()){return}}uiAttachOffer.queryAttachOffer()};var _queryAttachOffer=function(){var prodInfo=order.prodModify.choosedProdInfo;var prodId=prodInfo.prodInstId;var param={prodId:prodId,prodSpecId:prodInfo.productId,offerSpecId:prodInfo.prodOfferId,acctNbr:prodInfo.accNbr};if(ec.util.isObj(prodInfo.prodBigClass)){param.prodBigClass=prodInfo.prodBigClass}var data=uiOfferQuery.queryAttachOfferHtml(param);SoOrder.initFillPage();$("#order_fill_content").html(data).show();$("#step1").hide();var member=CacheData.getOfferMember(prodId);if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){param.queryType="1,2";param.objId=member.objId;param.objType=member.objType;param.offerRoleId=member.offerRoleId;param.memberRoleCd=member.roleCd;var data=query.offer.queryDefMustOfferSpec(param);CacheData.parseOffer(data);var data=query.offer.queryServSpec(param);CacheData.parseServ(data)}if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){var member=CacheData.getOfferMember(prodId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==member.offerRoleId&&member.objType==CONST.OBJ_TYPE.PROD){var offerRole=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(this.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>')}}});return false}})}uiAttachOffer.changeLabel(prodId,prodInfo.productId,"");order.dealer.initDealer();_querrOldOrderInfo()};var _querrOldOrderInfo=function(){var isReload=order.uiCust.packageInfo.reloadFlag;var orderInfo=order.uiCust.orderInfo;if(isReload=="N"){var resultCode=orderInfo.resultCode;var resultMsg=orderInfo.resultMsg;if(resultCode=="0"){var custOrderList=orderInfo.result.orderList.custOrderList;var orderListInfo=orderInfo.result.orderList.orderListInfo;if(custOrderList!=null&&custOrderList!=""){if(custOrderList!=null&&custOrderList.length>0){$(custOrderList).each(function(i,custOrder){$(custOrder.busiOrder).each(function(i,busiOrder){var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;var state="";var data=busiOrder.data;var ooOwners;var boServs;if(boActionTypeCd=="7"){boServs=data.boServs;if(boServs!=null){$(boServs).each(function(i,boServ){state=boServ.state})}}var busiObj=busiOrder.busiObj;if(boActionTypeCd=="7"){var instId=busiObj.instId;var boServOrders=data.boServOrders;$(data.boServs).each(function(i,boServ){var servId=boServ.servId;var state=boServ.state;if(state=="DEL"){_closeServSub(instId,servId)}})}})});$(custOrderList).each(function(i,custOrder){$(custOrder.busiOrder).each(function(i,busiOrder){var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;var state="";var data=busiOrder.data;var ooOwners;var boServs;if(boActionTypeCd=="7"){boServs=data.boServs;if(boServs!=null){$(boServs).each(function(i,boServ){state=boServ.state})}}else{ooOwners=data.ooOwners;if(ooOwners!=null){$(ooOwners).each(function(i,ooOwner){state=ooOwner.state;return false})}}var busiObj=busiOrder.busiObj;if(boActionTypeCd=="S2"){var instId=busiObj.instId;$(data.ooRoles).each(function(i,ooRole){var objInstId=ooRole.objInstId;if(state=="DEL"){_delOfferSub(objInstId,instId)}})}else{if(boActionTypeCd=="7"){var instId=busiObj.instId;var boServOrders=data.boServOrders;$(data.boServs).each(function(i,boServ){var servId=boServ.servId;var state=boServ.state;if(state=="ADD"){$(boServOrders).each(function(i2,boServOrder){var servSpecId=boServOrder.servSpecId;var servSpecName=boServOrder.servSpecName;_openServSpecSub(instId,servSpecId,servSpecName,"N")})}})}else{if(boActionTypeCd=="S1"){var objId=busiObj.objId;var accessNumber=busiObj.accessNumber;var objName=busiObj.objName;var prodId=null;var ooRoles=data.ooRoles;var busiOrderAttrs=data.busiOrderAttrs;$(data.ooRoles).each(function(i,ooRole){prodId=ooRole.prodId;return false});var isNeedAdd=false;var roleCode="";$(busiOrderAttrs).each(function(i,busiOrderAttr){var itemSpecId=busiOrderAttr.itemSpecId;if(itemSpecId=="111111120"){roleCode=busiOrderAttr.role;isNeedAdd=true;return false}});if(isNeedAdd){_addAttachDealerSub(prodId+"_"+objId,accessNumber,objName,roleCode)}_addOfferSpecSub(prodId,objId,ooRoles);var bo2Coupons=data.bo2Coupons;if(bo2Coupons!=null&&bo2Coupons!=null&&bo2Coupons.length>0){$(bo2Coupons).each(function(i,bo2Coupon){var prodId=bo2Coupon.prodId;var attachSepcId=bo2Coupon.attachSepcId;var num=bo2Coupon.num;var couponInstanceNumber=bo2Coupon.couponInstanceNumber;if(num>1){$("#terminalAddBtn_"+prodId+"_"+attachSepcId).click()}$("#terminalText_"+prodId+"_"+attachSepcId+"_"+num).val(couponInstanceNumber);_checkTerminalCodeSub($("#terminalBtn_"+prodId+"_"+attachSepcId+"_"+num))})}}}}})});$(custOrderList).each(function(i,custOrder){$(custOrder.busiOrder).each(function(i,busiOrder){var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;var data=busiOrder.data;var ooOwners;var boServs;if(boActionTypeCd=="14"){var bo2Coupons=data.bo2Coupons;if(bo2Coupons!=null&&bo2Coupons!=null&&bo2Coupons.length>0){$(bo2Coupons).each(function(i,bo2Coupon){var prodId=bo2Coupon.prodId;var attachSepcId=bo2Coupon.attachSepcId;var couponInstanceNumber=bo2Coupon.couponInstanceNumber;var state=bo2Coupon.state;if(state=="ADD"){_uimCardInfoSearch(couponInstanceNumber,prodId,bo2Coupon)}})}}})})}}if(orderListInfo!=null&&custOrderList!=null){var custOrderAttrs=orderListInfo.custOrderAttrs;var isTemplateOrder=orderListInfo.isTemplateOrder;
var templateOrderName=orderListInfo.templateOrderName;$(custOrderAttrs).each(function(i,custOrderAttr){var itemSpecId=custOrderAttr.itemSpecId;if(itemSpecId=="111111118"){var value=custOrderAttr.value;if(value!=null&&value!=""){$("#order_remark").html(value)}}});if(isTemplateOrder=="Y"){$("#isTemplateOrder").click();SoOrder.showTemplateOrderName();$("#templateOrderName").val(templateOrderName)}}}}};var _uimCardInfoSearch=function(instCode,prodId,bo2Coupon){$("#uim_txt_"+prodId).val(instCode);var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:bo2Coupon.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:bo2Coupon.storeId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:instCode,terminalCode:instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:bo2Coupon.offerId,state:"ADD",relaSeq:""};if(bo2Coupon.cardTypeFlag!=null&&bo2Coupon.cardTypeFlag!=""){coupon.cardTypeFlag=bo2Coupon.cardTypeFlag}$("#uim_check_btn_"+prodId).attr("disabled",true);$("#uim_check_btn_"+prodId).attr("class","disablepurchase");$("#uim_release_btn_"+prodId).removeAttr("disabled");$("#uim_release_btn_"+prodId).attr("class","purchase");$("#uim_txt_"+prodId).attr("disabled",true);if(getIsMIFICheck(prodId)){$("#isMIFI_"+prodId).val("yes")}else{$("#isMIFI_"+prodId).val("no")}OrderInfo.clearProdUim(prodId);OrderInfo.boProd2Tds.push(coupon)};var _delOfferSub=function(prodId,offerId){var $span=$("#li_"+prodId+"_"+offerId).find("span");if($span.attr("class")=="del"){}else{var offer=_getOffer(prodId,offerId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offerId};if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.areaId=OrderInfo.oldprodInstInfos[i].areaId;param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr}}}else{param.acctNbr=OrderInfo.getAccessNumber(prodId)}var data=uiOfferQuery.queryOfferInst(param);if(data==undefined){return}var offerMemberInfos=[];$.each(data.offerMemberInfos,function(){var prodInstId=this.objInstId;var flag=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==prodInstId){flag=true;return false}});if(flag){offerMemberInfos.push(this)}});offer.offerMemberInfos=data.offerMemberInfos=offerMemberInfos;offer.offerSpec=data.offerSpec}var content="";if(offer.offerSpec!=undefined){content=CacheData.getOfferProdStr(prodId,offer,1)}offer.isdel="Y";$span.addClass("del");delServByOffer(prodId,offer)}};var _getOffer=function(prodId,offerId){var offerList=_getOfferList(prodId);if(ec.util.isArray(offerList)){for(var i=0;i<offerList.length;i++){if(offerList[i].offerId==offerId){return offerList[i]}}}};var _getOfferList=function(prodId){for(var i=0;i<AttachOffer.openedList.length;i++){var opened=AttachOffer.openedList[i];if(opened.prodId==prodId){return opened.offerList}}return[]};var _closeServSub=function(prodId,servId){var serv=CacheData.getServ(prodId,servId);var $span=$("#li_"+prodId+"_"+serv.servId).find("span");if($span.attr("class")=="del"){_openServ(prodId,serv)}else{if("13409244"==serv.servSpecId){$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能")}else{var uim=OrderInfo.getProdUim(prodId);if(serv.servSpecId=="280000020"&&(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)&&uim.cardTypeFlag=="1"){$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");return}$span.addClass("del");serv.isdel="Y"}}};var _addOfferSpecSub=function(prodId,offerSpecId,roles){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);_setServ2OfferSpecSub(prodId,newSpec);_checkOfferExcludeDependSub(prodId,newSpec)};var _checkTerminalCodeSub=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var num=$(obj).attr("num");var flag=$(obj).attr("flag");if(flag==undefined){flag=0}_filterAttach2Coupons(prodId,offerSpecId,num);var objInstId=prodId+"_"+offerSpecId;var resIdArray=[];var terminalGroupIdArray=[];$("#"+objInstId+"  option").each(function(){resIdArray.push($(this).val())});$("#group_"+objInstId+"  option").each(function(){terminalGroupIdArray.push($(this).val())});var resId=resIdArray.join("|");var terminalGroupId=terminalGroupIdArray.join("|");if((resId==undefined||$.trim(resId)=="")&&(terminalGroupId==undefined||$.trim(terminalGroupId)=="")){$.alert("信息提示","终端规格不能为空！");return}var instCode=$("#terminalText_"+objInstId+"_"+num).val();if(instCode==undefined||$.trim(instCode)==""){$.alert("信息提示","终端串码不能为空！");return}if(_checkData(objInstId,instCode)){return}var param={instCode:instCode,flag:flag,mktResId:resId,termGroup:terminalGroupId};var data=query.prod.checkTerminal(param);if(data==undefined){return}var activtyType="";for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"&&ec.util.isArray(spec.agreementInfos)){if(spec.agreementInfos[0].activtyType==2){activtyType="2"}}}}if(data.statusCd==CONST.MKTRES_STATUS.USABLE||(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2")){var mktPrice=0;var mktColor="";if(ec.util.isArray(data.mktAttrList)){$.each(data.mktAttrList,function(){if(this.attrId=="65010058"){mktPrice=this.attrValue}else{if(this.attrId=="60010004"){mktColor=this.attrValue}}})}$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");$("#terminalDesc_"+num).css("display","block");var coupon={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:data.mktResStoreId,storeName:"1",agentId:1,apCharge:mktPrice,couponInstanceNumber:data.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:-1,attachSepcId:offerSpecId,state:"ADD",relaSeq:"",num:num};if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2"){coupon.couponSource="2"}if(CONST.getAppDesc()==0){coupon.termTypeFlag=data.termTypeFlag}OrderInfo.attach2Coupons.push(coupon)}else{if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}else{$.alert("提示",data.message)}}};var _setServ2OfferSpecSub=function(prodId,offerSpec,roles){if(offerSpec!=undefined){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var nowProd=prodId+"_"+this.objId;$(roles).each(function(i,role){var oldProd=role.prodId+"_"+role.objId;if(nowProd==oldProd){this.selQty=1;return false}else{this.selQty=2}})})})}};var _checkOfferExcludeDependSub=function(prodId,offerSpec){var offerSpecId=offerSpec.offerSpecId;var param=CacheData.getExcDepOfferParam(prodId,offerSpecId);var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserOfferDataSub(data.result,prodId,offerSpecId,offerSpec.offerSpecName)}};var paserOfferDataSub=function(result,prodId,offerSpecId,specName){var content="";var param={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(result!=""){var exclude=result.offerSpec.exclude;var depend=result.offerSpec.depend;var defaultOffer=result.offerSpec.defaultList;if(ec.util.isArray(exclude)){for(var i=0;i<exclude.length;i++){var offerList=CacheData.getOfferList(prodId);var flag=true;if(offerList!=undefined){for(var j=0;j<offerList.length;j++){if(offerList[j].isdel=="Y"){if(offerList[j].offerSpecId==exclude[i].offerSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+exclude[i].offerSpecName+"<br>";param.excludeOffer.push(exclude[i].offerSpecId)}}}if(depend!=undefined&&ec.util.isArray(depend.offerInfos)){for(var i=0;i<depend.offerInfos.length;i++){content+="需要开通： "+depend.offerInfos[i].offerSpecName+"<br>";param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId)}}if(depend!=undefined&&ec.util.isArray(depend.offerGrpInfos)){for(var i=0;i<depend.offerGrpInfos.length;i++){var offerGrpInfo=depend.offerGrpInfos[i];
param.dependOffer.offerGrpInfos.push(offerGrpInfo);content+="需要开通： 开通"+offerGrpInfo.minQty+"-"+offerGrpInfo.maxQty+"个以下业务:<br>";if(offerGrpInfo.subOfferSpecInfos!="undefined"&&offerGrpInfo.subOfferSpecInfos.length>0){for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){var subOfferSpec=offerGrpInfo.subOfferSpecInfos[j];var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}else{var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}else{content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}}}}}if(ec.util.isArray(defaultOffer)){for(var i=0;i<defaultOffer.length;i++){content+="需要开通： "+defaultOffer[i].offerSpecName+"<br>";param.defaultOffer.push(defaultOffer[i].offerSpecId)}}}var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);content=content+serContent;AttachOffer.addOpenList(prodId,offerSpecId)};var _setOffer2ExcludeOfferSpecSub=function(param){if(param.dependOffer.offerGrpInfos.length>0){var dependOffer=param.dependOffer;for(var i=0;i<dependOffer.offerGrpInfos.length;i++){var offerGrpInfo=dependOffer.offerGrpInfos[i];var $offerSpecs=$("input[name="+offerGrpInfo.grpId+"]:checked");var len=$offerSpecs.length;dependOffer.offerGrpInfos[i].checkLen=len;for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){var subOfferSpecInfo=offerGrpInfo.subOfferSpecInfos[j];$offerSpecs.each(function(){if($(this).val()==subOfferSpecInfo.offerSpecId){subOfferSpecInfo.isCheck=true}})}}}};var _addAttachDealerSub=function(id,accessNumbe,objName,roleCode){var prodId=id.split("_")[0];if($("#tr_"+id)[0]==undefined){var objId=id+"_"+OrderInfo.SEQ.dealerSeq;var $tdType=_getDealerTypeSub(id,objId);if($tdType==undefined){return false}var $tr=$("#atr_"+id);var $newTr=$('<tr name="tr_'+id+'"></tr>');$newTr.append("<td>"+accessNumbe+"</td>");$newTr.append("<td>"+objName+"</td>");$newTr.append($tdType);var dealer=$("#tr_"+prodId).find("input");var staffId=1;var staffName="";if(dealer[0]==undefined){staffId=OrderInfo.staff.staffId;staffName=OrderInfo.staff.staffName}else{staffId=dealer.attr("staffId");staffName=dealer.attr("value")}if(order.ysl!=undefined){var $td=$('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" style="margin-left:45px;"></input></td>')}else{var $td=$('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>')}$td.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+objId+"');\">选择</a>");$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+id+'\')">添加</a><label class="f_red">*</label>');$newTr.append($td);if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){OrderInfo.getChannelList()}var $tdChannel=$("<td></td>");var $channelSelect=$('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(dealerlist[d].channelNbr==this.channelNbr){$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});$tdChannel.append($channelSelect);$tdChannel.append('<label class="f_red">*</label>');$tr.append($tdChannel);$("#dealerTbody").append($newTr);if(roleCode!=null&&roleCode!=""){$("#dealerType_"+id+"_"+OrderInfo.SEQ.dealerSeq).val(roleCode)}OrderInfo.SEQ.dealerSeq++}};var _getDealerTypeSub=function(objInstId,objId){var dealerType="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var dealerTypeId=this.PARTYPRODUCTRELAROLECD;var flag=true;$("select[name='dealerType_"+objInstId+"']").each(function(){if(dealerTypeId==$(this).val()){flag=false;return false}});if(flag){dealerType=dealerTypeId;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(dealerType==undefined||dealerType==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var $td=$("<td></td>");var $select=$('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==dealerType){$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});$td.append($select);$td.append('<label class="f_red">*</label>');return $td};var _openServSpecSub=function(prodId,servSpecId,specName,ifParams){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams;if(servSpecId==CONST.YZFservSpecId){var feeType=$("select[name='pay_type_-1']").val();if(feeType==undefined){feeType=order.prodModify.choosedProdInfo.feeType}if(feeType==CONST.PAY_TYPE.AFTER_PAY){for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];prodSpecParam.setValue=""}}else{for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];if(prodSpecParam.value!=""){prodSpecParam.setValue=prodSpecParam.value}else{if(!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!=""){prodSpecParam.setValue=prodSpecParam.valueRange[0].value}}}}}}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDependSub(prodId,servSpec)};var _checkServExcludeDependSub=function(prodId,serv,flag){var servSpecId=serv.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserServDataSub(data.result,prodId,serv)}}};var paserServDataSub=function(result,prodId,serv){var servSpecId=serv.servSpecId;var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";var param={excludeServ:[],dependServ:[],relatedServ:[]};
if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";param.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.dependServ.push(this)})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.relatedServ.push(this)})}if(content==""){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);excludeAddServ(prodId,servSpecId,param)}};var _queryAttachOfferSpec=function(param){query.offer.queryAttachSpec(param,function(data){if(data){$("#attach_"+param.prodId).html(data);_showMainRoleProd(param.prodId);uiAttachOffer.changeLabel(param.prodId,param.prodSpecId,"");if(param.prodId==-1&&OrderInfo.actionFlag==14){uiAttachOffer.addOpenList(param.prodId,mktRes.terminal.offerSpecId)}}})};var _showApp=function(prodId){var appList=CacheData.getOpenAppList(prodId);var content=CacheData.getAppContent(prodId,appList);$.confirm("增值业务设置： ",content[0].innerHTML,{yes:function(){$.each(appList,function(){if($("#"+prodId+"_"+this.objId).attr("checked")=="checked"){this.dfQty=1}else{this.dfQty=0}})},no:function(){}})};var getProdInst=function(prodId){for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(ec.util.isArray(offerRole.prodInsts)){for(var j=0;j<offerRole.prodInsts.length;j++){if(offerRole.prodInsts[j].prodInstId==prodId){return offerRole.prodInsts[j]}}}}};var _showMainRoleProd=function(prodId){var prodInst=getProdInst(prodId);var app={prodId:prodId,appList:[]};uiAttachOffer.openAppList.push(app);for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(roleObj.objType==CONST.OBJ_TYPE.SERV){if(prodInst.objId==roleObj.parentProdId&&prodInst.componentTypeCd.substring(0,1)==roleObj.componentTypeCd.substring(0,1)){app.appList.push(roleObj);if(roleObj.servSpecId==undefined){roleObj.servSpecId=roleObj.objId}if(roleObj.servSpecName==undefined){roleObj.servSpecName=roleObj.objName}}}}if(app.appList.length>0){var $li=$('<li id="li_'+prodId+"_"+offerRole.offerRoleId+'"></li>');$li.append('<dd class="mustchoose" ></dd>');$li.append("<span>"+offerRole.offerRoleName+"</span>");$li.append('<dd id="can_'+prodId+"_"+offerRole.offerRoleId+'" class="gou2" onclick="AttachOffer.showApp('+prodId+');"></dd>');$("#open_app_ul_"+prodId).append($li)}}else{if(offerRole.prodInsts==undefined){continue}$.each(offerRole.prodInsts,function(){if(this.prodInstId==prodId){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldLi=$("#li_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(roleObj.dfQty==0&&spec.ifDault==1){var $span=$oldLi.find("span");$span.addClass("del");spec.isdel="Y"}}if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}if(roleObj.dfQty>0){var servSpec=jQuery.extend(true,{},roleObj);CacheData.setServSpec(prodId,servSpec);spec=servSpec;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');if(roleObj.minQty==0){$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+"')\"></dd>")}else{$li.append('<dd class="mustchoose"></dd>')}$li.append("<span>"+spec.servSpecName+"</span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$li.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');$("#open_serv_ul_"+prodId).append($li);spec.isdel="N";_showHideUim(0,prodId,servSpecId)}}}}})}}};var _showMainMemberRoleProd=function(prodId){for(var i=0;i<OrderInfo.viceOfferSpec.length;i++){var offerSpec=OrderInfo.viceOfferSpec[i];if(prodId==offerSpec.prodId){for(var j=0;j<offerSpec.offerRoles.length;j++){var offerRole=offerSpec.offerRoles[j];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldLi=$("#li_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}if(roleObj.dfQty>0){var servSpec=jQuery.extend(true,{},roleObj);CacheData.setServSpec(prodId,servSpec);spec=servSpec;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');if(roleObj.minQty==0){$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+"')\"></dd>")}else{$li.append('<dd class="mustchoose"></dd>')}$li.append("<span>"+spec.servSpecName+"</span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$li.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');$("#open_serv_ul_"+prodId).append($li);spec.isdel="N";_showHideUim(0,prodId,servSpecId)}}}}}}}};var _searchAttachOfferSpec=function(prodId,offerSpecId,prodSpecId){var param={prodId:prodId,prodSpecId:prodSpecId,offerSpecIds:[offerSpecId],ifCommonUse:""};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){if(this.prodInstId==prodId){param.acctNbr=this.accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}})}else{if(OrderInfo.actionFlag==3){var prodInfo=order.prodModify.choosedProdInfo;param.acctNbr=prodInfo.accNbr;if(!ec.util.isObj(prodInfo.prodOfferId)){prodInfo.prodOfferId=""}var offerRoleId=CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;if(offerRoleId==undefined){offerRoleId=""}param.offerRoleId=offerRoleId;param.offerSpecIds.push(prodInfo.prodOfferId)
}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.viceOfferSpec,function(){var offerSpecId=this.offerSpecId;var accessNumber=this.accessnumber;if(this.prodId==prodId){$.each(this.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||this.memberRoleCd=="1"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){param.acctNbr=accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(offerSpecId);return false}})}})}})}else{if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr;$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){param.offerSpecIds.push(this.offerSpec.offerSpecId);$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){param.offerRoleId=this.offerRoleId}})}})}}}else{param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}}}}}var offerSepcName=$("#search_text_"+prodId).val();if(offerSepcName.replace(/\ /g,"")==""){$.alert("提示","请输入查询条件！");return}param.offerSpecName=offerSepcName;var data=query.offer.searchAttachOfferSpec(param);if(data!=undefined){$("#attach_div_"+prodId).html(data).show()}};var _selectAttachOffer=function(prodId,offerSpecId){$("#attach_div_"+prodId).hide();_addAttOffer(prodId,offerSpecId)};var _selectServ=function(prodId,servSpecId,specName,ifParams){$("#attach_div_"+prodId).hide();_openServSpec(prodId,servSpecId,specName,ifParams)};var _closeAttachSearch=function(prodId){$("#attach_div_"+prodId).hide()};var _delOfferSpec=function(prodId,offerSpecId){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.addOfferSpec(prodId,offerSpecId)}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);var content=CacheData.getOfferProdStr(prodId,spec,2);$.confirm("信息确认",content,{yes:function(){$span.addClass("del");spec.isdel="Y";delServSpec(prodId,spec);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#terminalUl_"+prodId+"_"+offerSpecId).remove();spec.isTerminal=0},no:function(){}})}};var _delOffer=function(prodId,offerId){var $span=$("#li_"+prodId+"_"+offerId).find("span");if($span.attr("class")=="del"){AttachOffer.addOffer(prodId,offerId,$span.text())}else{var offer=CacheData.getOffer(prodId,offerId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offerId};if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.areaId=OrderInfo.oldprodInstInfos[i].areaId;param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr}}}else{param.acctNbr=OrderInfo.getAccessNumber(prodId)}var data=uiOfferQuery.queryOfferInst(param);if(data==undefined){return}var offerMemberInfos=[];$.each(data.offerMemberInfos,function(){var prodInstId=this.objInstId;var flag=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==prodInstId){flag=true;return false}});if(flag){offerMemberInfos.push(this)}});offer.offerMemberInfos=data.offerMemberInfos=offerMemberInfos;offer.offerSpec=data.offerSpec}var content="";if(offer.offerSpec!=undefined){content=CacheData.getOfferProdStr(prodId,offer,1)}else{content="退订【"+$span.text()+"】可选包"}$.confirm("信息确认",content,{yes:function(){offer.isdel="Y";$span.addClass("del");delServByOffer(prodId,offer)},no:function(){}})}};var _closeServSpec=function(prodId,servSpecId,specName,ifParams){var $span=$("#li_"+prodId+"_"+servSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams)}else{$.confirm("信息确认","取消开通【"+$span.text()+"】功能产品",{yesdo:function(){var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}$span.addClass("del");spec.isdel="Y";_showHideUim(1,prodId,servSpecId);var serv=CacheData.getServBySpecId(prodId,servSpecId);if(ec.util.isObj(serv)){$span.addClass("del");serv.isdel="Y"}},no:function(){}})}};var _closeServ=function(prodId,servId){var serv=CacheData.getServ(prodId,servId);var $span=$("#li_"+prodId+"_"+serv.servId).find("span");if($span.attr("class")=="del"){_openServ(prodId,serv)}else{if("13409244"==serv.servSpecId){$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能")}else{var uim=OrderInfo.getProdUim(prodId);if(serv.servSpecId=="280000020"&&(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)&&uim.cardTypeFlag=="1"){$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");return}$.confirm("信息确认","关闭【"+$span.text()+"】功能产品",{yesdo:function(){$span.addClass("del");serv.isdel="Y"},no:function(){}})}}};var _openServSpec=function(prodId,servSpecId,specName,ifParams){$.confirm("信息确认","开通【"+specName+"】功能产品",{yesdo:function(){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams;if(servSpecId==CONST.YZFservSpecId){var feeType=$("select[name='pay_type_-1']").val();if(feeType==undefined){feeType=order.prodModify.choosedProdInfo.feeType}if(feeType==CONST.PAY_TYPE.AFTER_PAY){for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];prodSpecParam.setValue=""}}else{for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];if(prodSpecParam.value!=""){prodSpecParam.setValue=prodSpecParam.value}else{if(!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!=""){prodSpecParam.setValue=prodSpecParam.valueRange[0].value}}}}}}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDepend(prodId,servSpec)},no:function(){}})};var _openServ=function(prodId,serv){$.confirm("信息确认","取消关闭【"+serv.servSpecName+"】功能产品",{yesdo:function(){if(serv!=undefined){if(serv.servSpecId==""){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.removeClass("del");serv.isdel="N"}else{_checkServExcludeDepend(prodId,serv)}}},no:function(){}})};var _checkOfferExcludeDepend=function(prodId,offerSpec){var offerSpecId=offerSpec.offerSpecId;var param=CacheData.getExcDepOfferParam(prodId,offerSpecId);var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName)}};var _checkServExcludeDepend=function(prodId,serv,flag){var servSpecId=serv.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserServData(data.result,prodId,serv)}}};var _addOfferSpec=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)},no:function(){}})};var _addOfferSpecByCheck=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)}})};var delServSpec=function(prodId,offerSpec){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var servSpecId=this.objId;if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){var spec=CacheData.getServSpec(prodId,servSpecId);
if(ec.util.isObj(spec)){spec.isdel="Y";var $li=$("#li_"+prodId+"_"+servSpecId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del");_showHideUim(1,prodId,servSpecId)}}})})};var delServByOffer=function(prodId,offer){$.each(offer.offerMemberInfos,function(){var servId=this.objInstId;if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){var serv=CacheData.getServ(prodId,servId);if(ec.util.isObj(serv)){serv.isdel="Y";var $li=$("#li_"+prodId+"_"+servId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del")}}})};var _addOffer=function(prodId,offerId){var specName=$("#li_"+prodId+"_"+offerId).find("span").text();$.confirm("信息确认","取消退订【"+specName+"】可选包",{yesdo:function(){var offer=CacheData.getOffer(prodId,offerId);if(offer!=undefined){if(offer.offerSpecId==""){var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.removeClass("del");offer.isdel="N"}else{_checkOfferExcludeDepend(prodId,offer)}}},no:function(){}})};var _addAttOffer=function(prodId,offerSpecId,specName){_addOfferSpec(prodId,offerSpecId)};var paserOfferData=function(result,prodId,offerSpecId,specName){var content="";var param={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(result!=""){var exclude=result.offerSpec.exclude;var depend=result.offerSpec.depend;var defaultOffer=result.offerSpec.defaultList;if(ec.util.isArray(exclude)){for(var i=0;i<exclude.length;i++){var offerList=CacheData.getOfferList(prodId);var flag=true;if(offerList!=undefined){for(var j=0;j<offerList.length;j++){if(offerList[j].isdel=="Y"){if(offerList[j].offerSpecId==exclude[i].offerSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+exclude[i].offerSpecName+"<br>";param.excludeOffer.push(exclude[i].offerSpecId)}}}if(depend!=undefined&&ec.util.isArray(depend.offerInfos)){for(var i=0;i<depend.offerInfos.length;i++){content+="需要开通： "+depend.offerInfos[i].offerSpecName+"<br>";param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId)}}if(depend!=undefined&&ec.util.isArray(depend.offerGrpInfos)){for(var i=0;i<depend.offerGrpInfos.length;i++){var offerGrpInfo=depend.offerGrpInfos[i];param.dependOffer.offerGrpInfos.push(offerGrpInfo);content+="需要开通： 开通"+offerGrpInfo.minQty+"-"+offerGrpInfo.maxQty+"个以下业务:<br>";if(offerGrpInfo.subOfferSpecInfos!="undefined"&&offerGrpInfo.subOfferSpecInfos.length>0){for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){var subOfferSpec=offerGrpInfo.subOfferSpecInfos[j];var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}else{var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}}}}}if(ec.util.isArray(defaultOffer)){for(var i=0;i<defaultOffer.length;i++){content+="需要开通： "+defaultOffer[i].offerSpecName+"<br>";param.defaultOffer.push(defaultOffer[i].offerSpecId)}}}var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);content=content+serContent;if(content==""){AttachOffer.addOpenList(prodId,offerSpecId)}else{content="<div style='max-height:300px;overflow:auto;'>"+content+"</div>";$.confirm("订购： "+specName,content,{yes:function(){CacheData.setOffer2ExcludeOfferSpec(param)},yesdo:function(){excludeAddattch(prodId,offerSpecId,param);excludeAddServ(prodId,"",paramObj)},no:function(){}})}};var paserServData=function(result,prodId,serv){var servSpecId=serv.servSpecId;var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";var param={excludeServ:[],dependServ:[],relatedServ:[]};if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";param.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.dependServ.push(this)})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.relatedServ.push(this)})}if(content==""){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{$.confirm("开通： "+serv.servSpecName,content,{yesdo:function(){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);excludeAddServ(prodId,servSpecId,param)},no:function(){}})}};var excludeAddServ=function(prodId,servSpecId,param){if(ec.util.isArray(param.excludeServ)){for(var i=0;i<param.excludeServ.length;i++){var excludeServSpecId=param.excludeServ[i].servSpecId;var spec=CacheData.getServSpec(prodId,excludeServSpecId);if(spec!=undefined){var $span=$("#li_"+prodId+"_"+excludeServSpecId).find("span");$span.addClass("del");spec.isdel="Y"}else{var serv=CacheData.getServBySpecId(prodId,excludeServSpecId);if(serv!=undefined){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.addClass("del");serv.isdel="Y"}}}}if(ec.util.isArray(param.dependServ)){for(var i=0;i<param.dependServ.length;i++){var servSpec=param.dependServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}if(ec.util.isArray(param.relatedServ)){for(var i=0;i<param.relatedServ.length;i++){var servSpec=param.relatedServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}};var excludeAddattch=function(prodId,specId,param){if(param.dependOffer.offerGrpInfos.length>0){var dependOffer=param.dependOffer;for(var i=0;i<dependOffer.offerGrpInfos.length;i++){var offerGrpInfo=dependOffer.offerGrpInfos[i];var len=offerGrpInfo.checkLen;if(len>=offerGrpInfo.minQty&&len<=offerGrpInfo.maxQty){$.each(offerGrpInfo.subOfferSpecInfos,function(){if(this.isCheck){AttachOffer.addOpenList(prodId,this.offerSpecId)}})}else{if(len<offerGrpInfo.minQty){$.alert("提示信息","依赖组至少选中"+offerGrpInfo.minQty+"个！");return}else{if(len>offerGrpInfo.maxQty){$.alert("提示信息","依赖组至多选中"+offerGrpInfo.maxQty+"个！");return}else{$.alert("错误信息","依赖组选择出错！");return}}}}}AttachOffer.addOpenList(prodId,specId);if(param.excludeOffer.length>0){for(var i=0;i<param.excludeOffer.length;i++){var excludeSpecId=param.excludeOffer[i];var spec=CacheData.getOfferSpec(prodId,excludeSpecId);if(spec!=undefined){var $span=$("#li_"+prodId+"_"+excludeSpecId).find("span");$span.addClass("del");spec.isdel="Y";$("#terminalUl_"+prodId+"_"+excludeSpecId).remove()}var offer=CacheData.getOfferBySpecId(prodId,excludeSpecId);if(offer!=undefined){var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.addClass("del");offer.isdel="Y"}}}if(param.dependOffer.dependOffers.length>0){for(var i=0;i<param.dependOffer.dependOffers.length;i++){var offerSpecId=param.dependOffer.dependOffers[i];AttachOffer.addOpenList(prodId,offerSpecId)}}if(param.defaultOffer.length>0){for(var i=0;
i<param.defaultOffer.length;i++){var offerSpecId=param.defaultOffer[i];AttachOffer.addOpenList(prodId,offerSpecId)}}};var _addOpenList=function(prodId,offerSpecId){if(!_manyPhoneFilter(prodId,offerSpecId)){return}var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(offer!=undefined){if(offer.isdel!="Y"){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){offer.counts++;newSpec.counts=offer.counts;if(_ifOrderAgain(newSpec)){offer.counts--;return}if(offer.counts<=2){var $li=$("#li_"+prodId+"_"+offer.offerId);$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu" onclick="AttachOffer.setParam('+prodId+","+offerSpecId+","+1+');"></dd>')}}}else{var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.removeClass("del");offer.isdel="N"}return}var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}if(newSpec.isdel=="C"){if(_ifOrderAgain(newSpec)){return}var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();var $li=$('<li id="li_'+prodId+"_"+offerSpecId+'"></li>');if(newSpec.ifDault==0){$li.append('<dd class="mustchoose"></dd>')}else{$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+')"></dd>')}$li.append("<span>"+newSpec.offerSpecName+"</span>");if(newSpec.ifParams){if(CacheData.setParam(prodId,newSpec)){$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}}if(newSpec.ifShowTime=="Y"){$li.append('<dd class="time" id="time_'+prodId+"_"+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+","+offerSpecId+",'"+newSpec.offerSpecName+"');\"></dd>")}if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu2" onclick="AttachOffer.setParam('+prodId+","+offerSpecId+');"></dd>')}$("#open_ul_"+prodId).append($li);newSpec.isdel="N"}else{if((newSpec.isdel=="Y")){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");$span.removeClass("del");newSpec.isdel="N"}else{if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){newSpec.counts++;if(_ifOrderAgain(newSpec)){newSpec.counts--;return}}else{var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();var $li=$('<li id="li_'+prodId+"_"+offerSpecId+'"></li>');if(newSpec.ifDault==0){$li.append('<dd class="mustchoose"></dd>')}else{$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+')"></dd>')}$li.append("<span>"+newSpec.offerSpecName+"</span>");if(newSpec.ifParams){if(CacheData.setParam(prodId,newSpec)){$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}}if(newSpec.ifShowTime=="Y"){$li.append('<dd class="time" id="time_'+prodId+"_"+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+","+offerSpecId+",'"+newSpec.offerSpecName+"');\"></dd>")}$("#open_ul_"+prodId).append($li)}}}if(newSpec!=undefined){$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty!=2){var ifParams="N";if(ec.util.isArray(this.prodSpecParams)){ifParams="Y"}_addOpenServList(prodId,this.objId,this.objName,ifParams);if(this.minQty>0){_minQtyFileter(prodId,this.objId)}}})})}if(ec.util.isArray(newSpec.agreementInfos)){if(OrderInfo.actionFlag!=14){totalNums=0;_removeAttach2Coupons(prodId,newSpec.offerSpecId);var objInstId=prodId+"_"+newSpec.offerSpecId;var $ul=$('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');var $sel=$('<select id="terminalSel_'+objInstId+'"></select>');var $li1=$('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+"</span></label></li>");var $li2=$('<li style="display:none;"><label> 可选终端规格：</label></li>');$.each(newSpec.agreementInfos,function(){var $option=$('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+"</option>");$sel.append($option)});$li2.append($sel).append('<label class="f_red">*</label>');var minNum=newSpec.agreementInfos[0].minNum;var maxNum=newSpec.agreementInfos[0].maxNum;var $li3=$("<ul></ul>");var isFastOffer=0;if(ec.util.isArray(newSpec.extAttrParams)){$.each(newSpec.extAttrParams,function(){if(this.attrId==CONST.OFFER_FAST_FILL){isFastOffer=1;return false}})}for(var i=0;i<newSpec.agreementInfos.length;i++){var agreementInfo=newSpec.agreementInfos[i];var $ulGroups=$('<ul id="ul_'+objInstId+'" class="fillin show"></ul>');var $liGroups=$('<li class="full"><label> 终端：</label></li>');var $selTerms=$('<select style="display:none;" id="'+objInstId+'"></select>');var $selTermGroups=$('<select style="display:none;" id="group_'+objInstId+'"></select>');if(ec.util.isArray(agreementInfo.terminalGroups)){for(var j=0;j<agreementInfo.terminalGroups.length;j++){var $optionTermGroups=$('<option value="'+agreementInfo.terminalGroups[j].terminalGroupId+'" terminalMaxNum="'+agreementInfo.terminalGroups[j].terminalMaxNum+'" terminalMinNum="'+agreementInfo.terminalGroups[j].terminalMinNum+'">'+agreementInfo.terminalGroups[j].terminalGroupId+"</option>");$selTermGroups.append($optionTermGroups);if(ec.util.isArray(agreementInfo.terminalGroups[j].terminalGroup)){$.each(agreementInfo.terminalGroups[j].terminalGroup,function(){var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+"</option>");$selTerms.append($optionTerms)})}}}if(ec.util.isArray(agreementInfo.terminals)){$.each(agreementInfo.terminals,function(){var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+"</option>");$selTerms.append($optionTerms)})}$liGroups.append($selTerms).append($selTermGroups);if(maxNum>newSpec.agreementInfos[0].minNum){var $strAdd=$('<input id="terminalAddBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="0" onclick="AttachOffer.addAndDelTerminal(this)" value="添加" class="purchase" style="float:left"></input>');var $strDel=$('<input id="terminalDelBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="1" onclick="AttachOffer.addAndDelTerminal(this)" value="删除" class="purchase" style="float:left"></input>');$liGroups.append($strAdd).append($strDel)}$ulGroups.append($liGroups);for(var k=1;k<=minNum;k++){var $liTerminal=$('<li><label>终端校验：</label><input id="terminalText_'+objInstId+"_"+k+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><input id="terminalBtn_'+objInstId+"_"+k+'" type="button" num="'+k+'" flag="'+isFastOffer+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" value="校验" class="purchase" style="float:left"></input></li>');var $li4=$('<li id="terminalDesc_'+k+'" style="white-space:nowrap;"><label></label><label id="terminalName_'+k+'"></label></li>');$ulGroups.append($liTerminal).append($li4)}$li3.append($ulGroups);totalNums+=minNum}var $div=$("#terminalDiv_"+prodId);$ul.append($li1).append($li2).append($li3).appendTo($div);$div.show();if(newSpec.agreementInfos[0].minNum>0){newSpec.isTerminal=1}}else{if(OrderInfo.actionFlag==14){var objInstId=prodId+"_"+newSpec.offerSpecId;var terminalUl=$("#terminalUl_"+objInstId);if(terminalUl.length>0){return}var $ul=$('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');var $sel=$('<select id="terminalSel_'+objInstId+'"></select>');var $li1=$('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+"</span></label></li>");
var $li2=$('<li style="display:none;"><label> 可选终端规格：</label></li>');$.each(newSpec.agreementInfos,function(){var $option=$('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+"</option>");$sel.append($option)});$li2.append($sel).append('<label class="f_red">*</label>');var $li3=$('<li><label>终端校验：</label><input id="terminalText_'+objInstId+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+","+newSpec.offerSpecId+')" value="校验" class="purchase" style="float:left"></input></li>');var $div=$("#terminalDiv_"+prodId);var $li4=$('<li id="terminalDesc" style="display:none;white-space:nowrap;"><label> 终端规格：</label><label id="terminalName"></label></li>');$ul.append($li1).append($li2).append($li3).append($li4).appendTo($div);$div.show();newSpec.isTerminal=1;for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var coupon=OrderInfo.attach2Coupons[i];if(prodId==coupon.prodId){$("#terminalSel_"+objInstId).val(coupon.couponId);$("#terminalSel_"+objInstId).attr("disabled",true);$("#terminalText_"+objInstId).val(coupon.couponInstanceNumber);$("#terminalText_"+objInstId).attr("disabled",true);$("#terminalBtn_"+objInstId).hide()}}}}}};var _checkTerminalCode=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var num=$(obj).attr("num");var flag=$(obj).attr("flag");if(flag==undefined){flag=0}_filterAttach2Coupons(prodId,offerSpecId,num);var objInstId=prodId+"_"+offerSpecId;var resIdArray=[];var terminalGroupIdArray=[];$("#"+objInstId+"  option").each(function(){resIdArray.push($(this).val())});$("#group_"+objInstId+"  option").each(function(){terminalGroupIdArray.push($(this).val())});var resId=resIdArray.join("|");var terminalGroupId=terminalGroupIdArray.join("|");if((resId==undefined||$.trim(resId)=="")&&(terminalGroupId==undefined||$.trim(terminalGroupId)=="")){$.alert("信息提示","终端规格不能为空！");return}var instCode=$("#terminalText_"+objInstId+"_"+num).val();if(instCode==undefined||$.trim(instCode)==""){$.alert("信息提示","终端串码不能为空！");return}if(_checkData(objInstId,instCode)){return}var param={instCode:instCode,flag:flag,mktResId:resId};var data=query.prod.checkTerminal(param);if(data==undefined){return}var activtyType="";for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"&&ec.util.isArray(spec.agreementInfos)){if(spec.agreementInfos[0].activtyType==2){activtyType="2"}}}}if(data.statusCd==CONST.MKTRES_STATUS.USABLE||(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2")){$.alert("信息提示",data.message);var mktPrice=0;var mktColor="";if(ec.util.isArray(data.mktAttrList)){$.each(data.mktAttrList,function(){if(this.attrId=="65010058"){mktPrice=this.attrValue}else{if(this.attrId=="60010004"){mktColor=this.attrValue}}})}$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");$("#terminalDesc_"+num).css("display","block");var coupon={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:data.mktResStoreId,storeName:"1",agentId:1,apCharge:mktPrice,couponInstanceNumber:data.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:-1,attachSepcId:offerSpecId,state:"ADD",relaSeq:"",num:num};if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2"){coupon.couponSource="2"}if(CONST.getAppDesc()==0){coupon.termTypeFlag=data.termTypeFlag}OrderInfo.attach2Coupons.push(coupon)}else{if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}else{$.alert("提示",data.message)}}};var _setSpec=function(prodId,offerSpecId){var newSpec=CacheData.getOfferSpec(prodId,offerSpecId);if(newSpec==undefined){newSpec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!newSpec){return}CacheData.setOfferSpec(prodId,newSpec)}return newSpec};var _addOpenServList=function(prodId,servSpecId,servSpecName,ifParams){var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){$("#li_"+prodId+"_"+serv.servId).find("span").removeClass("del");serv.isdel="N";return}var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:servSpecName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams}CacheData.setServSpec(prodId,newSpec);spec=newSpec}if(spec.isdel=="C"){$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');if(spec.ifDault==0){$li.append('<dd class="mustchoose"></dd>')}else{$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+servSpecName+"','"+ifParams+"')\"></dd>")}$li.append("<span>"+spec.servSpecName+"</span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$("#open_serv_ul_"+prodId).append($li)}else{$("#li_"+prodId+"_"+servSpecId).find("span").removeClass("del")}spec.isdel="N";_showHideUim(0,prodId,servSpecId)};var _showMainParam=function(){var content=CacheData.getParamContent(-1,OrderInfo.offerSpec,0);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){}).ketchup({bindElement:"easyDialogYesBtn"})};var _showParam=function(prodId,offerSpecId,flag){if(flag==1){var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offer.offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=uiOfferQuery.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}if(!offer.isGetParam){var param={offerTypeCd:"2",offerId:offer.offerId,offerSpecId:offer.offerSpecId};var offerParam=query.offer.queryOfferParam(param);if(offerParam==undefined){return}else{offer.offerParamInfos=offerParam.offerParamInfos;offer.isGetParam=true}}var content=CacheData.getParamContent(prodId,offer,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});order.protocolnbr.init();$("#paramForm").bind("formIsValid",function(event,form){if(!paramInputCheck()){return}var isset=false;$.each(offer.offerSpec.offerSpecParams,function(){var itemInfo=CacheData.getOfferParam(prodId,offer.offerId,this.itemSpecId);if(itemInfo.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){itemInfo.setValue=$("#select1").val()}else{itemInfo.setValue=$("#"+prodId+"_"+this.itemSpecId).val()}if(itemInfo.value!=itemInfo.setValue){itemInfo.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu").addClass("canshu2");offer.isset="Y";offer.update="Y"}else{$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu2").addClass("canshu");offer.isset="N";offer.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);if(spec==undefined){spec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!spec){return}}var content=CacheData.getParamContent(prodId,spec,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});order.protocolnbr.init();$("#paramForm").bind("formIsValid",function(event,form){if(!paramInputCheck()){return
}if(!!spec.offerSpecParams){for(var i=0;i<spec.offerSpecParams.length;i++){var param=spec.offerSpecParams[i];var itemSpec=CacheData.getSpecParam(prodId,offerSpecId,param.itemSpecId);if(itemSpec.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){itemSpec.setValue=$("#select1").val()}else{itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}}if(spec.offerRoles!=undefined&&spec.offerRoles.length>0){for(var i=0;i<spec.offerRoles.length;i++){var offerRole=spec.offerRoles[i];for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(!!roleObj.prodSpecParams){for(var k=0;k<roleObj.prodSpecParams.length;k++){var prodParam=roleObj.prodSpecParams[k];var prodItem=CacheData.getProdSpecParam(prodId,offerSpecId,prodParam.itemSpecId);prodItem.value=$("#"+prodId+"_"+prodParam.itemSpecId).val()}}}}}$("#can_"+prodId+"_"+offerSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getOfferSpec(prodId,offerSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var _showServParam=function(prodId,servSpecId,flag){if(flag==1){var serv=CacheData.getServBySpecId(prodId,servSpecId);var param={prodId:serv.servId,ifServItem:"Y"};if(!serv.isGetParamSpec){param.prodSpecId=serv.servSpecId;var dataSepc=query.prod.prodSpecParamQuery(param);if(dataSepc==undefined){return}else{serv.prodSpecParams=dataSepc.result.prodSpecParams;serv.isGetParamSpec=true}}if(!serv.isGetParamInst){var data=query.prod.prodInstParamQuery(param);if(data==undefined){return}else{serv.prodInstParams=data.result.prodInstParams;serv.isGetParamInst=true}}var content=CacheData.getParamContent(prodId,serv,3);if(OrderInfo.isGroupProSpecId(serv.servSpecId)){ec.form.dialog.createDialog({id:"-group",width:"370",height:"440",initCallBack:function(dialogForm,dialog){AttachOffer.dialogForm=dialogForm;AttachOffer.dialog=dialog;$("#div_group").empty();$("#div_group").append(content);$("#div_group_btn").empty();var str='<a href="javascript:void(0)" id="ok_btn" class="btn_h30"><span>确认</span></a><a href="javascript:void(0);" id="cancel_btn" class="btn_h30" style="margin-left:20px;"><span>取消</span></a>';$("#div_group_btn").append(str);$("#ok_btn").off("click").on("click",function(event){_groupInistOkBtn(prodId,servSpecId)});$("#cancel_btn").off("click").on("click",function(event){_closeDialog()})},submitCallBack:function(dialogForm,dialog){},closeCallBack:function(dialogForm,dialog){}});return}$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var isset=false;$.each(serv.prodSpecParams,function(){var prodItem=CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);prodItem.setValue=$("#"+prodId+"_"+this.itemSpecId).val();if(prodItem.value!=prodItem.setValue){prodItem.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");serv.isset="Y";serv.update="Y"}else{$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");serv.isset="N";serv.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}var content=CacheData.getParamContent(prodId,spec,2);if(OrderInfo.isGroupProSpecId(spec.servSpecId)){ec.form.dialog.createDialog({id:"-group",width:"370",height:"440",initCallBack:function(dialogForm,dialog){AttachOffer.dialogForm=dialogForm;AttachOffer.dialog=dialog;$("#div_group").empty();$("#div_group").append(content);$("#div_group_btn").empty();var str='<a href="javascript:void(0)" id="ok_btn" class="btn_h30"><span>确认</span></a><a href="javascript:void(0);" id="cancel_btn" class="btn_h30" style="margin-left:20px;"><span>取消</span></a>';$("#div_group_btn").append(str);$("#ok_btn").off("click").on("click",function(event){_groupOkBtn(prodId,servSpecId)});$("#cancel_btn").off("click").on("click",function(event){_closeDialog()})},submitCallBack:function(dialogForm,dialog){},closeCallBack:function(dialogForm,dialog){}});return}$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){if(!!spec.prodSpecParams){for(var i=0;i<spec.prodSpecParams.length;i++){var param=spec.prodSpecParams[i];var itemSpec=CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getServSpec(prodId,servSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var _groupOkBtn=function(prodId,servSpecId){var spec=CacheData.getServSpec(prodId,servSpecId);var flag=true;if(!!spec.prodSpecParams){for(var i=0;i<spec.prodSpecParams.length;i++){var param=spec.prodSpecParams[i];var itemSpec=CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val();if(!ec.util.isObj(itemSpec.setValue)){$.alert("信息提示",param.name+"不能为空");flag=false;break}}}if(flag){$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getServSpec(prodId,servSpecId);attchSpec.isset="Y";easyDialog.close()}};var _groupInistOkBtn=function(prodId,servSpecId){var serv=CacheData.getServBySpecId(prodId,servSpecId);var isset=false;$.each(serv.prodSpecParams,function(){var prodItem=CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);prodItem.setValue=$("#"+prodId+"_"+this.itemSpecId).val();if(prodItem.value!=prodItem.setValue){prodItem.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");serv.isset="Y";serv.update="Y"}else{$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");serv.isset="N";serv.update="N"}_closeDialog()};var _closeDialog=function(){if(AttachOffer.dialogForm!=undefined&&AttachOffer.dialog!=undefined){AttachOffer.dialogForm.close(AttachOffer.dialog)}};var paramInputCheck=function(){var pass=true;$("#paramForm").find("input[type=text]").each(function(){var mask=$(this).attr("mask");var maskmsg=$(this).attr("maskmsg");if(mask!=null&&mask!=""&&mask.substring(0,1)=="/"&&mask.substring(mask.length-1,mask.length)=="/"){if(!eval(mask).test($(this).val())){$.alert("提示",maskmsg);pass=false;return false}}});return pass};var _showTime=function(prodId,offerSpecId,offerSpecName){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(offerSpecName+"--生失效设置");var spec=CacheData.getOfferSpec(prodId,offerSpecId);_initTime(spec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setAttachTime(prodId,offerSpecId)});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showStartTime=function(){var strDate=DateUtil.Format("yyyy年MM月dd日",new Date());var endDate=$("#endDt").val();if(endDate==""){$.calendar({minDate:strDate})}else{$.calendar({minDate:strDate,maxDate:endDate})}};var _showEndTime=function(){var strDate=$("#startDt").val();if(strDate==""){strDate=DateUtil.Format("yyyy年MM月dd日",new Date())}$.calendar({minDate:strDate})};var _initTime=function(spec){if(spec!=undefined&&spec.ooTimes!=undefined){var ooTime=spec.ooTimes;$("input[name=startTimeType][value='"+ooTime.startType+"']").attr("checked","checked");$("input[name=endTimeType][value='"+ooTime.endType+"']").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("");if(ooTime.startType==4){$("#startDt").val(ooTime.startDt)}if(ooTime.endType==4){$("#endDt").val(ooTime.endDt)}else{if(ooTime.endType==5){$("#endTime").val(ooTime.effTime);$("#endTimeUnit").val(ooTime.effTimeUnitCd)}}}else{$("input[name=startTimeType][value=1]").attr("checked","checked");$("input[name=endTimeType][value=1]").attr("checked","checked");
$("#startDt").val("");$("#endDt").val("");$("#endTime").val("")}};var _showOfferTime=function(){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(OrderInfo.offerSpec.offerSpecName+"-生失效设置");_initTime(OrderInfo.offerSpec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setMainTime()});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showMainMember=function(){$("#memberName").text(OrderInfo.offerSpec.offerSpecName+"-构成");$("#main_member_div").empty();$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)});$("#main_member_div").append('<div class="clear"></div>')}else{$.each(offerRole.prodInsts,function(){var prodId=this.prodInstId;var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)}});$("#main_member_div").append('<div class="clear"></div>')})}});easyDialog.open({container:"div_member_dialog"});$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(offerRole.prodInsts,function(){var prodInst=this;$.each(offerRole.roleObjs,function(){var servSpecId=this.objId;if(this.minQty>0){$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked");$(this).attr("disabled","disabled")}})}});if(!!prodInst.servInsts){$.each(prodInst.servInsts,function(){var servSpecId=this.objId;$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked")}})})}})});$("#memberSpan").off("click").on("click",function(){_setMainMember()})};var _setMainMember=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(this.prodInsts,function(){var prodInst=this;prodInst.servInsts=[];$("input[name='serv_check_"+this.prodInstId+"']:checked").each(function(){var servSpecId=$(this).attr("servSpecId");$.each(offerRole.roleObjs,function(){if(this.objId==servSpecId){prodInst.servInsts.push(this)}})})})});easyDialog.close()};var _getTime=function(){var ooTime={state:"ADD"};var startRadio=$("input[name=startTimeType]:checked").attr("value");ooTime.startType=startRadio;if(startRadio==1){ooTime.isDefaultStart="Y"}else{if(startRadio==2){}else{if(startRadio==3){ooTime.startTime=1;ooTime.startTimeUnitCd=7}else{if(startRadio==4){if($("#startDt").val()==""){$.alert("提示","指定生效时间不能为空!");return}ooTime.startDt=$("#startDt").val()}}}}var endRadio=$("input[name=endTimeType]:checked").attr("value");ooTime.endType=endRadio;if(endRadio==1){ooTime.isDefaultEnd="Y"}else{if(endRadio==4){if($("#endDt").val()==""){$.alert("提示","指定失效时间不能为空!");return}ooTime.endDt=$("#endDt").val()}else{if(endRadio==5){var end=$("#endTime").val();if(end==""){$.alert("提示","有效时长不能为空!");return}if(isNaN(end)){$.alert("提示","有效时长必须为数字!");return}if(end<=0){$.alert("提示","有效时长必须大于0!");return}ooTime.effTime=end;ooTime.effTimeUnitCd=$("#endTimeUnit").val()}}}return ooTime};var _setMainTime=function(){var ooTime=_getTime();if(ooTime==undefined){return}OrderInfo.offerSpec.ooTimes=ooTime;$("#mainTime").removeClass("time").addClass("time2");easyDialog.close()};var _setAttachTime=function(prodId,offerSpecId){var ooTime=_getTime();if(ooTime==undefined){return}var spec=CacheData.getOfferSpec(prodId,offerSpecId);spec.ooTimes=ooTime;$("#time_"+prodId+"_"+offerSpecId).removeClass("time").addClass("time2");easyDialog.close()};var _changeLabel=function(prodId,prodSpecId,labelId){$.each(AttachOffer.labelList,function(){if(this.prodId==prodId){$.each(this.labels,function(){if(labelId==""){labelId=this.label;$("#tab_"+prodId+"_"+this.label).addClass("setcon")}else{if(labelId==this.label){$("#tab_"+prodId+"_"+this.label).addClass("setcon");$("#ul_"+prodId+"_"+this.label).show()}else{$("#tab_"+prodId+"_"+this.label).removeClass("setcon");$("#ul_"+prodId+"_"+this.label).hide()}}})}});var $ul=$("#ul_"+prodId+"_"+labelId);if($ul[0]==undefined){var queryType="3";if(prodId>0){queryType=""}if(labelId==CONST.LABEL.SERV){var param={prodId:prodId,prodSpecId:prodSpecId,queryType:queryType,labelId:labelId};var data=query.offer.queryServSpec(param);var $ul=$('<ul id="ul_'+prodId+"_"+labelId+'"></ul>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.servSpec)){var servList=CacheData.getServList(prodId);var servSpecList=CacheData.getServSpecList(prodId);$.each(data.result.servSpec,function(){AttachOffer.allOfferList.push(this);var servSpecId=this.servSpecId;var flag=true;$.each(servList,function(){if(this.servSpecId==servSpecId&&this.isDel!="C"){flag=false;return false}});$.each(servSpecList,function(){if(this.servSpecId==servSpecId){flag=false;return false}});if(flag){var $li=$('<li id="li_'+prodId+"_"+this.servSpecId+'"></li>');var $dd=$('<dd class="canchoose" onclick="AttachOffer.openServSpec('+prodId+","+this.servSpecId+",'"+this.servSpecName+"','"+this.ifParams+"')\"></dd>");var $span=$('<span><a href="javascript:AttachOffer.openServSpec('+prodId+","+this.servSpecId+",'"+this.servSpecName+"','"+this.ifParams+"')\">"+this.servSpecName+"</a></span>");var $dd2=$('<dd class="canshu2" onclick="AttachOffer.offerSpecDetail('+prodId+","+this.servSpecId+')"><img src="'+contextPath+'/image/common/more.png"/></dd>');$li.append($dd).append($span).append($dd2).appendTo($ul)}})}}$("#div_"+prodId).append($ul)}else{var param={prodSpecId:prodSpecId,offerSpecIds:[],queryType:queryType,prodId:prodId,partyId:OrderInfo.cust.custId,labelId:labelId,ifCommonUse:""};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){if(this.prodInstId==prodId){param.acctNbr=this.accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}})}else{if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22){var prodInfo=order.prodModify.choosedProdInfo;param.acctNbr=prodInfo.accNbr;if(!ec.util.isObj(prodInfo.prodOfferId)){prodInfo.prodOfferId=""}var offerRoleId=CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;if(offerRoleId==undefined){offerRoleId=""}param.offerRoleId=offerRoleId;param.offerSpecIds.push(prodInfo.prodOfferId)}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.viceOfferSpec,function(){var offerSpecId=this.offerSpecId;var accessNumber=this.accessnumber;if(this.prodId==prodId){$.each(this.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||this.memberRoleCd=="1"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){param.acctNbr=accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(offerSpecId);return false}})}})}})}else{if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr;$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){param.offerSpecIds.push(this.offerSpec.offerSpecId);
$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){param.offerRoleId=this.offerRoleId}})}})}}}else{param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}}}}}query.offer.queryCanBuyAttachSpec(param,function(data){var $ul=$('<ul id="ul_'+prodId+"_"+labelId+'"></ul>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.offerSpecList)){var offerList=CacheData.getOfferList(prodId);var offerSpecList=CacheData.getOfferSpecList(prodId);$.each(data.result.offerSpecList,function(){AttachOffer.allOfferList.push(this);var offerSpecId=this.offerSpecId;var flag=true;var ifOrderAgain=this.ifOrderAgain;$.each(offerList,function(){if(this.offerSpecId==offerSpecId&&this.isDel!="C"&&ifOrderAgain!="Y"){flag=false;return false}});$.each(offerSpecList,function(){if(this.offerSpecId==offerSpecId&&ifOrderAgain!="Y"){flag=false;return false}});if(flag){var $li=$('<li id="li_'+prodId+"_"+this.offerSpecId+'"></li>');if(ec.util.isObj(ifOrderAgain)&&ifOrderAgain=="Y"){$li=$('<li id="li_'+prodId+"_"+this.offerSpecId+"_"+ifOrderAgain+'"></li>')}var $dd=$('<dd class="canchoose" onclick="AttachOffer.addOfferSpec('+prodId+","+this.offerSpecId+')"></dd>');var $span=$('<span><a href="javascript:AttachOffer.addOfferSpec('+prodId+","+this.offerSpecId+')" >'+this.offerSpecName+"</a></span>");var $dd2=$('<dd class="canshu2" onclick="AttachOffer.offerSpecDetail('+prodId+","+this.offerSpecId+')"><img src="'+contextPath+'/image/common/more.png"/></dd>');$li.append($dd).append($span).append($dd2).appendTo($ul)}})}}$("#div_"+prodId).append($ul)})}}};var _showHideUim=function(flag,prodId,servSpecId){if(CONST.getAppDesc()==0&&servSpecId==CONST.PROD_SPEC.PROD_FUN_4G){var prodClass=order.prodModify.choosedProdInfo.prodClass;if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){prodClass=CacheData.getOfferMember(prodId).prodClass}else{if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){prodClass=OrderInfo.oldprodInstInfos[i].prodClass}}}}if(flag==0){if(prodClass==CONST.PROD_CLASS.THREE){$("#title_"+prodId).show();$("#uimDiv_"+prodId).show()}}else{if(flag==1){if(prodClass==CONST.PROD_CLASS.THREE){$("#uimDiv_"+prodId).hide()}}}}};var _isChangeUim=function(objId){if(CONST.getAppDesc()==0){var prodClass=order.prodModify.choosedProdInfo.prodClass;var prodId=order.prodModify.choosedProdInfo.prodInstId;if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){var member=CacheData.getOfferMember(objId);prodClass=member.prodClass;prodId=member.objInstId}else{if(OrderInfo.actionFlag==6&&ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==objId){prodClass=this.prodClass;prodId=this.prodInstId}})}}if(prodClass==CONST.PROD_CLASS.THREE){var servSpec=CacheData.getServSpec(prodId,CONST.PROD_SPEC.PROD_FUN_4G);if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){return true}}}return false};var _setAttachBusiOrder=function(busiOrders){$.each(AttachOffer.openServList,function(){var prodId=this.prodId;$.each(this.servSpecList,function(){if(this.isdel!="Y"&&this.isdel!="C"){SoOrder.createServ(this,prodId,0,busiOrders)}})});$.each(AttachOffer.openedServList,function(){var prodId=this.prodId;$.each(this.servList,function(){if(this.isdel=="Y"){SoOrder.createServ(this,prodId,1,busiOrders)}else{if(this.update=="Y"){SoOrder.createServ(this,prodId,2,busiOrders)}}})});for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"){if(ec.util.isObj(spec.counts)){for(var k=0;k<spec.counts;k++){SoOrder.createAttOffer(spec,open.prodId,0,busiOrders)}}else{SoOrder.createAttOffer(spec,open.prodId,0,busiOrders)}}}}for(var i=0;i<AttachOffer.openedList.length;i++){var opened=AttachOffer.openedList[i];for(var j=0;j<opened.offerList.length;j++){var offer=opened.offerList[j];if(offer.isdel=="Y"){if(ec.util.isObj(offer.counts)){for(var k=0;k<offer.orderCount;k++){offer.offerId=offer.offerIds[k];SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{if(offer.update=="Y"){SoOrder.createAttOffer(offer,opened.prodId,2,busiOrders)}else{if(ec.util.isObj(offer.orderCount)&&ec.util.isObj(offer.counts)){if(offer.orderCount>offer.counts){for(var k=0;k<(offer.orderCount-offer.counts);k++){offer.offerId=offer.offerIds[k];SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{if(offer.orderCount<offer.counts){var spec=CacheData.getOfferSpec(opened.prodId,offer.offerSpecId);for(var k=0;k<(offer.counts-offer.orderCount);k++){SoOrder.createAttOffer(spec,opened.prodId,0,busiOrders)}}}}}}}}$.each(AttachOffer.openAppList,function(){var prodId=this.prodId;$.each(this.appList,function(){if(this.dfQty==1){SoOrder.createServ(this,prodId,0,busiOrders)}})})};var _setChangeList=function(prodId){AttachOffer.changeList=[];var prodInfos=offerChange.resultOffer.prodInfos;if(ec.util.isArray(prodInfos)){$.each(prodInfos,function(){if(prodId!=this.accProdInstId){return true}if(prodId!=this.prodInstId){var param={prodInstId:prodId};var serv=CacheData.getServ(prodId,this.prodInstId);var servSpec=CacheData.getServSpec(prodId,this.productId);if(this.state=="DEL"){if(serv!=undefined&&serv.isdel!="Y"){param.objId=this.prodInstId;param.status=(serv.isdel!=undefined?serv.isdel:"N");param.objIdType=1;serv.isdel="Y";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){param.objId=this.productId;param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(serv!=undefined&&serv.isdel=="Y"){param.objId=this.prodInstId;param.status=serv.isdel;param.objIdType=1;serv.isdel="N";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel=="Y"){param.objId=this.productId;param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(serv==undefined&&servSpec==undefined){param.objId=this.productId;param.status="Y";param.objIdType=2;AttachOffer.changeList.push(param);if(this.productId!=undefined&&this.productId!=""){var newSerSpec={objId:this.productId,servSpecId:this.productId,servSpecName:this.productName,ifParams:"N",isdel:"N"};CacheData.setServSpec(prodId,newSerSpec);var servSpec=CacheData.getServSpec(prodId,this.productId);servSpec.isdel="N"}}}}}}}})}var offers=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(offers)){$.each(offers,function(){if(this.memberInfo==undefined){return true}var flag=true;$.each(this.memberInfo,function(){if(ec.util.isObj(this.accProdInstId)&&prodId==this.accProdInstId){flag=false;return false}});if(flag){return true}var param={prodInstId:prodId};var offer=CacheData.getOffer(prodId,this.prodOfferInstId);var offerSpec=CacheData.getOfferSpec(prodId,this.prodOfferId);if(this.state=="DEL"){if(offer!=undefined&&offer.isdel!="Y"){param.objId=this.prodOfferInstId;param.status=(offer.isdel!=undefined?offer.isdel:"N");param.objIdType=3;offer.isdel="Y";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(offer!=undefined&&offer.isdel=="Y"){param.objId=this.prodOfferInstId;param.status=offer.isdel;param.objIdType=3;offer.isdel="N";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel=="Y"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(offer==undefined&&offerSpec==undefined){param.objId=this.prodOfferId;
param.status="Y";param.objIdType=4;AttachOffer.changeList.push(param);if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){var newOfferSpec=_setSpec(prodId,this.prodOfferId);newOfferSpec.isdel="N"}}}}}}})}};var _reductionChangList=function(prodId){$.each(AttachOffer.changeList,function(){if(this.prodInstId==prodId){if(this.objIdType==1){var serv=CacheData.getServ(prodId,this.objId);if(serv!=undefined){serv.isdel=this.status}}else{if(this.objIdType==2){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec!=undefined){servSpec.isdel=this.status}}else{if(this.objIdType==3){var offer=CacheData.getOffer(prodId,this.objId);if(offer!=undefined){offer.isdel=this.status}}else{if(this.objIdType==4){var offerSpec=CacheData.getOfferSpec(prodId,this.objId);if(offerSpec!=undefined){offerSpec.isdel=this.status}}}}}}})};var _servExDepReByRoleObjs=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);paramObj.excludeServ=[];paramObj.dependServ=[];paramObj.relatedServ=[];var globContent="";$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec==undefined){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv==undefined){var newServSpec={objId:this.objId,servSpecId:this.objId,servSpecName:this.objName,ifParams:this.isCompParam,prodSpecParams:this.prodSpecParams,isdel:"C"};CacheData.setServSpec(prodId,newServSpec);servSpec=newServSpec}else{servSpec=serv}}var servSpecId=servSpec.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){}else{var data=query.offer.queryExcludeDepend(param);var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);if(content!=""){content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);globContent+=(content+"<br>")}}}})});return globContent};var paramObj={excludeServ:[],dependServ:[],relatedServ:[]};var paserServDataByObjs=function(result,prodId,serv,newSpec){var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";paramObj.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.dependServ.push(this)}})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.relatedServ.push(this)}})}return content};var _filterServ=function(servSpecId,newSpec){var flag=false;$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){if(servSpecId==this.objId){flag=true;return false}}})});if(!flag){if(ec.util.isArray(paramObj.dependServ)){for(var i=0;i<paramObj.dependServ.length;i++){if(servSpecId==paramObj.dependServ[i].servSpecId){flag=true;break}}}if(!flag){if(ec.util.isArray(paramObj.relatedServ)){for(var i=0;i<paramObj.relatedServ.length;i++){if(servSpecId==paramObj.relatedServ[i].servSpecId){flag=true;break}}}}}return flag};var _minQtyFileter=function(prodId,servSpecId){var serv=CacheData.getServBySpecId(prodId,servSpecId);var $li;if(serv!=undefined){$li=$("#li_"+prodId+"_"+serv.servId)}else{$li=$("#li_"+prodId+"_"+servSpecId)}if($li!=undefined){$li.find(".delete").remove();$li.append('<dd class="mustchoose"></dd>')}};var _manyPhoneFilter=function(prodId,offerSpecId){if(OrderInfo.actionFlag==14){return true}var newSpec;var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(ec.util.isObj(offer)){newSpec=offer}else{newSpec=_setSpec(prodId,offerSpecId)}if(newSpec==undefined){return false}if(ec.util.isArray(newSpec.agreementInfos)){var num=0;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.objType==CONST.OBJ_TYPE.PROD){num++}})})}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){num++}})}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==prodId){num++}})}}}var minNum=newSpec.agreementInfos[0].minNum;var maxNum=newSpec.agreementInfos[0].maxNum;if(!ec.util.isObj(minNum)){$.alert("信息提示","销售品规格查询，未返回最小合约数，请后台确认。");return false}if(num<minNum){$.alert("信息提示","该合约的最小合约数为"+minNum+"个，而该套餐的成员实例只有"+num+"个，故无法办理该合约。");return false}if(maxNum>num){newSpec.agreementInfos[0].maxNum=num}}return true};var _addAndDelTerminal=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var fag=$(obj).attr("fag");var newSpec;var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(ec.util.isObj(offer)){newSpec=offer}else{newSpec=_setSpec(prodId,offerSpecId)}var objInstId=prodId+"_"+newSpec.offerSpecId;var maxNum=newSpec.agreementInfos[0].maxNum;var minNum=newSpec.agreementInfos[0].minNum;var $ul=$("#ul_"+objInstId);var $li=$("#ul_"+objInstId+" li");var length=$li.length-1;var isFastOffer=0;if(ec.util.isArray(newSpec.extAttrParams)){$.each(newSpec.extAttrParams,function(){if(this.attrId==CONST.OFFER_FAST_FILL){isFastOffer=1;return false}})}if(fag==0){if(totalNums>=maxNum){$.alert("信息提示","终端数已经达到最大，不能再添加了。");return}var $liTerminalAdd=$('<li><label>终端校验：</label><input id="terminalText_'+objInstId+"_"+(length/2+1)+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><input id="terminalBtn_'+objInstId+"_"+(length/2+1)+'" type="button" flag="'+isFastOffer+'" num="'+(length/2+1)+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" value="校验" class="purchase" style="float:left"></input></li>');var $liAdd=$('<li id="terminalDesc_'+(length/2+1)+'" style="white-space:nowrap;"><label></label><label id="terminalName_'+(length/2+1)+'"></label></li>');$ul.append($liTerminalAdd).append($liAdd);totalNums++}else{if(minNum==(length/2)){$.alert("信息提示","终端数已经达到最小，不能再删除了。");return}$li.each(function(index){if(length-1==index){$(this).remove()}else{if(length==index){_filterAttach2Coupons(prodId,offerSpecId,(index/2));$(this).remove()}}});totalNums--}};var _checkData=function(objInstId,terminalCode){var $input=$("input[id^=terminalText_"+objInstId+"]");var num=0;$input.each(function(){var instCode=$.trim(this.value);if(ec.util.isObj(instCode)&&terminalCode==instCode){num++}});if(num>=2){$.alert("信息提示","终端串码重复了，请填写不同的串码。");return true}return false};var _filterAttach2Coupons=function(prodId,offerSpecId,num){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId&&attach2Coupon.num==num){OrderInfo.attach2Coupons.splice(i,1);$("#terminalName_"+num).html("");break}}};var _removeAttach2Coupons=function(prodId,offerSpecId){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId){OrderInfo.attach2Coupons.splice(i,1);i--}}};var _ifOrderAgain=function(newSpec){if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){if(parseInt(newSpec.orderCount)<newSpec.counts){$.alert("信息提示","可选包："+newSpec.offerSpecName+"至多只能订购"+newSpec.orderCount+"次");return true}}};var _setParam=function(prodId,offerSpecId,flag){var newSpec=_setSpec(prodId,offerSpecId);var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);
if(flag==1){newSpec.counts=offer.counts}var content='<form id="paramForm">';content+='次数 : <input id="text_'+prodId+"_"+offerSpecId+'" class="inputWidth183px" type="text" value="'+newSpec.counts+'"><br>';content+="</form>";$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var nums=$("#text_"+prodId+"_"+offerSpecId).val();var reg=/^\+?[1-9][0-9]*$/;if(!reg.test(nums)){$.alert("信息提示","次数只能是正整数。");return}if(parseInt(newSpec.orderCount)<nums){$.alert("信息提示","可选包【"+newSpec.offerSpecName+"】至多只能订购"+newSpec.orderCount+"次");return}if(flag==1&&offer!=undefined){if(offer.orderCount>nums){if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offer.offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=uiOfferQuery.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}}offer.counts=nums}else{newSpec.counts=nums}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})};var _offerSpecDetail=function(prodId,offerSpecId){var offerSpecName="";var summary="";$.each(AttachOffer.allOfferList,function(){if(this.offerSpecId==offerSpecId){offerSpecName=this.offerSpecName;summary=this.summary}else{if(this.servSpecId==offerSpecId){offerSpecName=this.servSpecName;summary=this.summary}}});$("#detail_tbody").empty();var $tr=$("<tr></tr>");$tr.append("<td>"+offerSpecName+'</td><td width="900">'+summary+"</td>");$("#detail_tbody").append($tr);easyDialog.open({container:"div_detail_dialog"})};var _queryCardAttachOffer=function(cardTypeFlag){var prodInfo=order.prodModify.choosedProdInfo;var prodId=prodInfo.prodInstId;var param={prodId:prodId,prodSpecId:prodInfo.productId,offerSpecId:prodInfo.prodOfferId,acctNbr:prodInfo.accNbr};if(ec.util.isObj(prodInfo.prodBigClass)){param.prodBigClass=prodInfo.prodBigClass}var data=uiOfferQuery.queryAttachOfferHtml(param);$("#attach").html(data).show();var temp={boActionTypeCd:"14",cardType:cardTypeFlag=="1"?"4G":"3G",accNbr:prodInfo.accNbr,prodInstId:prodId,prodId:prodId,prodSpecId:prodInfo.productId};var data=query.offer.queryDefMustOfferSpecAndServ(temp);CacheData.parseOffer(data);CacheData.parseServ(data);if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){var member=CacheData.getOfferMember(prodId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==member.offerRoleId&&member.objType==CONST.OBJ_TYPE.PROD){var offerRole=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(this.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>')}}});return false}})}};var _releaseUim=function(prodId){var cardNo=$.trim($("#uim_txt_"+prodId).val());if(cardNo==undefined||cardNo==""){$.alert("提示","UIM卡不能为空!");return false}var param={numType:2,numValue:cardNo};var jr=$.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum",param);if(jr.code==-2){$.alertM(jr.data);return}if(jr.code==-1){$.alert("提示",jr.data);return}if(OrderInfo.actionFlag==22){$("#attach").children().remove()}$("#uim_check_btn_"+prodId).attr("disabled",false);$("#uim_release_btn_"+prodId).attr("disabled",true);$("#uim_txt_"+prodId).attr("disabled",false);$("#uim_txt_"+prodId).val("");OrderInfo.clearProdUim(prodId)};var _checkUim=function(prodId){var phoneNumber=OrderInfo.getAccessNumber(prodId);var offerId="-1";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(phoneNumber==""){$.alert("提示","校验UIM卡前请先选号!");return false}}if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23||OrderInfo.actionFlag==6){if(ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){offerId=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{offerId=order.prodModify.choosedProdInfo.prodOfferInstId}}var cardNo=$.trim($("#uim_txt_"+prodId).val());if(cardNo==undefined||cardNo==""){$.alert("提示","UIM卡不能为空!");return false}var inParam={instCode:cardNo,phoneNum:phoneNumber,areaId:OrderInfo.getProdAreaId(prodId)};var prodSpecId=OrderInfo.getProdSpecId(prodId);var mktResCd="";if(CONST.getAppDesc()==0){if(getIsMIFICheck(prodId)){mktResCd=getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID)}else{mktResCd=getMktResCd(prodSpecId)}if(ec.util.isObj(mktResCd)){}else{$.alert("提示","查询卡类型失败！");return}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(prod.changeUim.is4GProdInst){inParam.onlyLTE="1"}}}var data=_checkUimSub(inParam,prodId);if(data==undefined||data.baseInfo==undefined){return false}var couponNum=data.baseInfo.qty;if(couponNum==undefined||couponNum==null){couponNum=1}var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:couponNum,storeId:data.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:data.baseInfo.mktResInstCode,terminalCode:data.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:offerId,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){coupon.cardTypeFlag=data.baseInfo.cardTypeFlag}$("#uim_check_btn_"+prodId).attr("disabled",true);$("#uim_release_btn_"+prodId).removeClass("disabled");$("#uim_txt_"+prodId).attr("disabled",true);if(getIsMIFICheck(prodId)){$("#isMIFI_"+prodId).val("yes")}else{$("#isMIFI_"+prodId).val("no")}OrderInfo.clearProdUim(prodId);OrderInfo.boProd2Tds.push(coupon);if(OrderInfo.actionFlag==22&&data.baseInfo.cardTypeFlag==1){AttachOffer.queryCardAttachOffer(data.baseInfo.cardTypeFlag)}};var getMktResCd=function(prodSpecId){var param={prodSpecId:prodSpecId};var url=contextPath+"/mktRes/uim/getMktResCd";$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");var response=$.callServiceAsJson(url,param);$.unecOverlay();if(response.code=="0"){return response.data}else{return""}};var getIsMIFICheck=function(prodId){var prodIdTmp=(Math.abs(prodId)-1);if(AttachOffer.openServList.length>prodIdTmp){var specList=AttachOffer.openServList[prodIdTmp].servSpecList;for(var j=0;j<specList.length;j++){var spec=specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"){if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true}}}}return false};var _checkUimSub=function(param,prodId){var url=contextPath+"/app/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");var response=$.callServiceAsJson(url,param);$.unecOverlay();if(response.code==0){isRightCheck="Y";$("#uim_check_btn_"+prodId).removeAttr("class");$("#uim_check_btn_"+prodId).attr("class","disablepurchase");$("#uim_check_btn_"+prodId).attr("disabled","disabled");$("#uim_release_btn_"+prodId).removeAttr("class");$("#uim_release_btn_"+prodId).removeAttr("disabled");$("#uim_release_btn_"+prodId).attr("class","purchase");return response.data}else{if(typeof response==undefined){$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常")}else{if(response.code==-2){$.alertM(response.data)}else{var msg="";if(response.data!=undefined&&response.data.msg!=undefined){msg=response.data.msg}else{msg="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡校验失败，可能原因:"+msg)}}}};return{addOffer:_addOffer,addOfferSpec:_addOfferSpec,addOpenList:_addOpenList,addOpenServList:_addOpenServList,addOfferSpecByCheck:_addOfferSpecByCheck,addAndDelTerminal:_addAndDelTerminal,closeAttachSearch:_closeAttachSearch,changeLabel:_changeLabel,changeList:_changeList,closeServ:_closeServ,closeServSpec:_closeServSpec,checkData:_checkData,delOffer:_delOffer,delOfferSpec:_delOfferSpec,labelList:_labelList,isChangeUim:_isChangeUim,init:_init,openList:_openList,openedList:_openedList,openServList:_openServList,openedServList:_openedServList,openServSpec:_openServSpec,openAppList:_openAppList,queryAttachOffer:_queryAttachOffer,queryAttachOfferSpec:_queryAttachOfferSpec,queryCardAttachOffer:_queryCardAttachOffer,showParam:_showParam,showServParam:_showServParam,showTime:_showTime,setAttachTime:_setAttachTime,searchAttachOfferSpec:_searchAttachOfferSpec,selectAttachOffer:_selectAttachOffer,showOfferTime:_showOfferTime,showMainParam:_showMainParam,showMainMember:_showMainMember,selectServ:_selectServ,showStartTime:_showStartTime,showEndTime:_showEndTime,setAttachBusiOrder:_setAttachBusiOrder,showApp:_showApp,showHideUim:_showHideUim,showMainRoleProd:_showMainRoleProd,checkTerminalCode:_checkTerminalCode,checkOfferExcludeDepend:_checkOfferExcludeDepend,checkServExcludeDepend:_checkServExcludeDepend,servExDepReByRoleObjs:_servExDepReByRoleObjs,setChangeList:_setChangeList,reductionChangList:_reductionChangList,filterServ:_filterServ,setParam:_setParam,showMainMemberRoleProd:_showMainMemberRoleProd,offerSpecDetail:_offerSpecDetail}
})();CommonUtils.regNamespace("order","uiCust");order.uiCust=(function(){var y={};var c={};var t=null;var h=null;var a="0";var j=null;var s=[];var o="";var b=[];var w=[];var r={};var i=false;var g={provIsale:"",redirectUri:"",isFee:"",reloadFlag:""};var A;var l=function(B){$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>"+B+"</div>")};var f=function(C){var B='<table class="contract_list rule">';B+='<thead><tr> <td colspan="2">提示</td></tr></thead></table>';B+='<div id="rules_div" height="height:140px;">';B+='<table width="100%" height="120px;" border="0" cellspacing="0" cellpadding="0">';B+="<tr>";B+='<td align="right"></td>';B+='<td><div class="rule_font" style="width:100%;font-size:15px; text-align:center;">'+C+"</div></td>";B+="</tr>";B+="</table>";B+="</div>";easyDialog.open({container:"packageTip_dialog"});$("#infoTipContent").html("");$("#infoTipContent").html(B)};var u=function(){var K=g.reloadFlag;if(K=="N"){if(order.uiCust.orderInfo==null||order.uiCust.orderInfo==""||order.uiCust.orderInfo=="undefined"){f("二次加载数据信息丢失!");return}var O=order.uiCust.orderInfo.resultCode;var E=order.uiCust.orderInfo.resultMsg;if(O==null||O==""||O=="undefined"){f("二次加载数据信息丢失!");return}if(order.uiCust.orderInfo.result.orderList==null||order.uiCust.orderInfo.result.orderList==""){f(E);return}var N=order.uiCust.orderInfo.result.orderList.orderListInfo.custOrderAttrs;var M="0";$.each(N,function(){if(this.itemSpecId=="30010024"){if(this.value!="14"){M="1"}}});if(M=="1"){f("不是可选包变更受理流水号，请重试!");return}if(O=="-1"||O=="2"){f(E);return}}var C=contextPath+"/order/createorderlonger";var H=$.callServiceAsJson(C,{});if(H.code==0){OrderInfo.custorderlonger=H.data}var P="";var L="";var D="";var B="";var I="";var G="";var J="";P=$("#p_cust_identityCd").val();I=iacc_nbr;if(order.cust.fromProvFlag=="1"||(P!=-1&&CONST.getAppDesc()!=0)){P=$("#p_cust_identityCd").val();h="1"}else{h="0"}if(P==-1){B=I;I="";P=""}else{if(P=="acctCd"||P=="custNumber"){B="";I="";P="";G=$("#p_cust_identityCd").val();J=$.trim($("#p_cust_identityNum").val())}}D=$("#DiffPlaceFlag").val();areaId=$("#custAreaId_").val();if(areaId==null||areaId==""||areaId=="null"||areaId=="undefined"){f("用于客户定位的地市为空，请重试!");return}if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){f("省级地区无法进行定位客户,请选择市级地区!");return}var F={acctNbr:B,identityCd:P,identityNum:I,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:D,areaId:areaId,queryType:G,queryTypeValue:J,identidies_type:$("#p_cust_identityCd  option:selected").text()};$.callServiceAsHtml(contextPath+"/cust/queryCustSub",F,{before:function(){$.ecOverlay("<strong>正在查询客户信息中,请稍候...</strong>")},done:function(Q){if(Q.code==-2){return}q(Q)},fail:function(Q){$.unecOverlay();f("查询失败，请稍后再试!")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})};var q=function(B){if(B.data.indexOf("showVerificationcode")>=0){$("#vali_code_input").val("");$("#validatecodeImg").css({width:"80px",height:"32px"}).attr("src",contextPath+"/validatecode/codeimg.jpg?"+Math.floor(Math.random()*100)).fadeIn();easyDialog.open({container:"Verificationcode_div"});return}if(B.data.indexOf("false")>=0){f("抱歉,没有定位到客户,请尝试其他客户");return}var C=$("#custList");C.html(B.data).show();$(".userclose").off("click").on("click",function(D){h="";$(".usersearchcon").hide()});if($("#custListTable").attr("custInfoSize")=="1"){$(".usersearchcon").hide()}};var n=function(C){$("#main_div_1").show();y={custId:$(C).find("td:eq(3)").text(),partyName:$(C).find("td:eq(0)").text(),idCardNumber:$(C).find("td:eq(4)").text(),identityName:$(C).attr("identityName"),areaName:$(C).attr("areaName"),areaId:$(C).attr("areaId"),identityCd:$(C).attr("identityCd"),addressStr:$(C).attr("addressStr"),norTaxPayer:$(C).attr("norTaxPayer"),segmentId:$(C).attr("segmentId"),segmentName:$(C).attr("segmentName"),custFlag:$(C).attr("custFlag"),vipLevel:$(C).attr("vipLevel"),vipLevelName:$(C).attr("vipLevelName")};if(order.cust.queryForChooseUser&&y.segmentId!=1100){f("使用人必须是公众客户，请重新定位");return false}if(h=="0"){if(order.cust.authType=="00"){$("#custAuthTypeName").html("客户密码：")}else{$("#custAuthTypeName").html("产品密码：")}var B=$("#p_cust_identityCd").val();if("1"==B){$("#authIDTD").attr("disabled",false);easyDialog.open({container:"authID",callback:function(){order.cust.queryForChooseUser=false}})}else{easyDialog.open({container:"auth",callback:function(){order.cust.queryForChooseUser=false}});v()}if(order.cust.jumpAuthflag=="0"){$("#jumpAuth").off("click").on("click",function(){order.cust.jumpAuth()});$("#jumpAuth").show();$("#jumpAuthID").show()}$("#authClose").off("click").on("click",function(D){easyDialog.close();$("#authPassword").val("")});$("#authIDClose").off("click").on("click",function(D){easyDialog.close();$("#authIDTD").val("")})}else{_custAuth(C)}};var v=function(){var B=y;B.authFlag="1";$.callServiceAsHtml(contextPath+"/cust/custAuthSub",B,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(C){if(C.code!=0){f("客户鉴权失败,稍后重试!");return}if(!order.cust.queryForChooseUser){t=B;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=y.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=y.norTaxPayer;OrderInfo.cust=y;p(C)}else{order.main.showChooseUserDialog(B)}},always:function(){$.unecOverlay()}})};var p=function(B){if(h=="0"){easyDialog.close()}$("#custList").hide();$("#custQryDiv").hide();if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}var C=$("#custInfo");C.html(B.data).show();if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){$("#custModifyId").attr("style","display: none;")}else{$("#custModifyId").attr("style","")}$("#cCustName").val("");$("#cCustIdCard").val("");main.home.hideMainIco();k()};var k=function(C){if(OrderInfo.cust.custId==-1){f("新建客户无法查询已订购产品!");return}var B=1;$("#prodDetail").hide();$("#prodInfo").hide();$("#prodList").hide();$("#orderContent").show();if(order.cust.orderBtnflag==""){main.home.hideMainIco();x(B);$("#orderedprod").hide();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{if(order.cust.orderBtnflag=="0"||$("#orderedprod").is(":hidden")){$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{$("#orderedprod").hide();$("#arroworder").removeClass();$("#arroworder").addClass("arrow");order.cust.orderBtnflag="0";$("#orderbutton").css({height:"24px","border-bottom":"1px solid #4f7d3f"})}}};var x=function(C){var D={};if(y==null){D.custId=""}else{D.custId=y.custId;D.areaId=$("#area").attr("areaId")}if(document.getElementById("accNbrQuery")){D.acctNbr=$.trim($("#accNbrQuery").val());if(CONST.getAppDesc()==0){D.areaId=$("#p_cust_areaId").val()}}else{if($("#isAppointNum").attr("checked")=="checked"){D.acctNbr=$.trim($("#p_cust_identityNum").val());if(CONST.getAppDesc()==0){D.areaId=$("#p_cust_areaId").val()}}else{D.acctNbr=""}}D.acctNbr=$("#phoneNum_").val();if(document.getElementById("custPageSize")){D.pageSize=$.trim($("#custPageSize").val());if(!(/^[1-9]\d*$/.test(D.pageSize))&&(D.pageSize!="")){f("获取页面信息失败,请稍后再试!");return false}if(D.pageSize>15){f("获取页面信息失败,请稍后再试!");return false}}else{D.pageSize=""}D.curPage=C;D.DiffPlaceFlag=$("#DiffPlaceFlag").val();if(D.custId==null||D.custId==""){f("无法查询已订购产品,查询失败!");return}var B=contextPath+"/cust/orderprodSub";$.callServiceAsHtmlGet(B,D,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(E){if(!E){E.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'
}if(E.code==-2){return}else{if(E.code!=0){if(E.msg!=null&&E.msg!=""){f(E.msg)}else{f("查询信息失败,请稍后重试!")}return}}var F=$("#orderedprod");F.html(E.data);$("#phoneNumListtbody tr").off("click").on("click",function(G){var H=this;if(1==OrderInfo.order.step&&(!$(H).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){_cancel();m(H);OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(H).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();_cancel();m(H);OrderInfo.order.step=0},no:function(){null}})}else{m(this)}}});$("#plan2ndDiv tbody tr").each(function(){$(this).off("click").on("click",function(H){var G=this;if(1==OrderInfo.order.step&&(!$(G).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){_cancel();order.cust.linkSelectPlan(G);H.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(G).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();_cancel();order.cust.linkSelectPlan(G);H.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{order.cust.linkSelectPlan(this);H.stopPropagation()}}})});$("#phoneNumListtbody").children(":first-child").next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();$("#phoneNumListtbody").children(":first-child").click()}})};var m=function(C){$("#is3GCheckbox").off().change(function(){order.prodModify.getChooseProdInfo()});$("#phoneNumListtbody tr").filter(".plan_select").children(":first-child").html("");$("#phoneNumListtbody tr").filter(".plan_select").removeClass("plan_select").next("#plan2ndTr").hide();$(C).addClass("plan_select").next("#plan2ndTr").show();var B="<i class='select'></i>";$(C).children(":first-child").html(B);$(C).next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();order.uiCust.orderAttachOffer()};var z=function(){OrderInfo.busitypeflag=14;$("#main_div_1").show();uiAttachOffer.init()};return{custQuery:u,queryCallBack:q,btnQueryCustProd:x,showCustAuth:n,orderInfo:A,packageInfo:g,showPackageDialog:f,orderAttachOffer:z}})();$(function(){});CommonUtils.regNamespace("order","uiCusts");order.uiCusts=(function(){var x={};var c={};var s=null;var g=null;var a="0";var i=null;var r=[];var n="";var b=[];var v=[];var q={};var h=false;var y;var k=function(z){$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>"+z+"</div>")};var f=function(A){var z='<table class="contract_list rule">';z+='<thead><tr> <td colspan="2">提示</td></tr></thead></table>';z+='<div id="rules_div" height="height:140px;">';z+='<table width="100%" height="120px;" border="0" cellspacing="0" cellpadding="0">';z+="<tr>";z+='<td align="right"></td>';z+='<td><div class="rule_font" style="width:100%;font-size:15px; text-align:center;">'+A+"</div></td>";z+="</tr>";z+="</table>";z+="</div>";easyDialog.open({container:"packageTip_dialog"});$("#infoTipContent").html("");$("#infoTipContent").html(z)};var t=function(){var A=contextPath+"/order/createorderlonger";var E=$.callServiceAsJson(A,{});if(E.code==0){OrderInfo.custorderlonger=E.data}var I="";var H="";var B="";var z="";var F="";var D="";var G="";I=$("#p_cust_identityCd").val();F=$.trim($("#p_cust_identityNum").val());if(order.uiCusts.fromProvFlag=="1"||(I!=-1&&CONST.getAppDesc()!=0)){I=$("#p_cust_identityCd").val();g="1"}else{g="0"}if(I==-1){z=F;F="";I=""}else{if(I=="acctCd"||I=="custNumber"){z="";F="";I="";D=$("#p_cust_identityCd").val();G=$.trim($("#p_cust_identityNum").val())}}B=$("#DiffPlaceFlag").val();areaId=$("#custAreaId_").val();if(areaId==null||areaId==""||areaId=="null"||areaId=="undefined"){f("用于客户定位的地市为空，请重试!");return}if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){f("省级地区无法进行定位客户,请选择市级地区!");return}var C={acctNbr:z,identityCd:I,identityNum:F,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:B,areaId:areaId,queryType:D,queryTypeValue:G,identidies_type:$("#p_cust_identityCd  option:selected").text()};$.callServiceAsHtml(contextPath+"/token/pc/cust/queryCustSub",C,{before:function(){$.ecOverlay("<strong>正在查询客户信息中,请稍候...</strong>")},done:function(J){if(J.code==-2){return}p(J)},fail:function(J){$.unecOverlay();f("客户定位失败，请稍后再试!")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})};var p=function(z){if(z.data.indexOf("showVerificationcode")>=0){$("#vali_code_input").val("");$("#validatecodeImg").css({width:"80px",height:"32px"}).attr("src",contextPath+"/validatecode/codeimg.jpg?"+Math.floor(Math.random()*100)).fadeIn();easyDialog.open({container:"Verificationcode_div"});return}if(z.data.indexOf("false")>=0){f("抱歉,没有定位到客户,请尝试其他客户");return}var A=$("#custList");A.html(z.data).show();$(".userclose").off("click").on("click",function(B){g="";$(".usersearchcon").hide()});if($("#custListTable").attr("custInfoSize")=="1"){$(".usersearchcon").hide()}};var m=function(A){$("#main_div_1").show();x={custId:$(A).find("td:eq(3)").text(),partyName:$(A).find("td:eq(0)").text(),idCardNumber:$(A).find("td:eq(4)").text(),identityName:$(A).attr("identityName"),areaName:$(A).attr("areaName"),areaId:$(A).attr("areaId"),identityCd:$(A).attr("identityCd"),addressStr:$(A).attr("addressStr"),norTaxPayer:$(A).attr("norTaxPayer"),segmentId:$(A).attr("segmentId"),segmentName:$(A).attr("segmentName"),custFlag:$(A).attr("custFlag"),vipLevel:$(A).attr("vipLevel"),vipLevelName:$(A).attr("vipLevelName")};if(order.uiCusts.queryForChooseUser&&x.segmentId!=1100){f("使用人必须是公众客户，请重新定位");return false}if(g=="0"){if(order.cust.authType=="00"){$("#custAuthTypeName").html("客户密码：")}else{$("#custAuthTypeName").html("产品密码：")}var z=$("#p_cust_identityCd").val();if("1"==z){$("#authIDTD").attr("disabled",false);easyDialog.open({container:"authID",callback:function(){order.uiCusts.queryForChooseUser=false}})}else{easyDialog.open({container:"auth",callback:function(){order.uiCusts.queryForChooseUser=false}});u()}if(order.cust.jumpAuthflag=="0"){$("#jumpAuth").off("click").on("click",function(){order.cust.jumpAuth()});$("#jumpAuth").show();$("#jumpAuthID").show()}$("#authClose").off("click").on("click",function(B){easyDialog.close();$("#authPassword").val("")});$("#authIDClose").off("click").on("click",function(B){easyDialog.close();$("#authIDTD").val("")})}else{_custAuth(A)}};var u=function(){var z=x;z.authFlag="1";$.callServiceAsHtml(contextPath+"/cust/custAuthSub",z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(A){if(A.code!=0){f("客户鉴权失败,稍后重试!");return}if(!order.uiCusts.queryForChooseUser){s=z;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=x.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=x.norTaxPayer;OrderInfo.cust=x;o(A)}else{order.main.showChooseUserDialog(z)}},always:function(){}})};var o=function(z){if(g=="0"){easyDialog.close()}$("#custList").hide();$("#custQryDiv").hide();if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}var A=$("#custInfo");A.html(z.data).show();if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){$("#custModifyId").attr("style","display: none;")}else{$("#custModifyId").attr("style","")}$("#cCustName").val("");$("#cCustIdCard").val("");main.home.hideMainIco();j()};var j=function(A){if(OrderInfo.cust.custId==-1){f("新建客户无法查询已订购产品!");return}var z=1;$("#prodDetail").hide();$("#prodInfo").hide();$("#prodList").hide();$("#orderContent").show();if(order.cust.orderBtnflag==""){main.home.hideMainIco();w(z);$("#orderedprod").hide();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{if(order.cust.orderBtnflag=="0"||$("#orderedprod").is(":hidden")){$("#orderedprod").show();
$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{$("#orderedprod").hide();$("#arroworder").removeClass();$("#arroworder").addClass("arrow");order.cust.orderBtnflag="0";$("#orderbutton").css({height:"24px","border-bottom":"1px solid #4f7d3f"})}}};var w=function(A){var B={};if(x==null){B.custId=""}else{B.custId=x.custId;B.areaId=$("#area").attr("areaId")}if(document.getElementById("accNbrQuery")){B.acctNbr=$.trim($("#accNbrQuery").val());if(CONST.getAppDesc()==0){B.areaId=$("#p_cust_areaId").val()}}else{if($("#isAppointNum").attr("checked")=="checked"){B.acctNbr=$.trim($("#p_cust_identityNum").val());if(CONST.getAppDesc()==0){B.areaId=$("#p_cust_areaId").val()}}else{B.acctNbr=""}}B.acctNbr=OrderInfo.acctNbr;if(document.getElementById("custPageSize")){B.pageSize=$.trim($("#custPageSize").val());if(!(/^[1-9]\d*$/.test(B.pageSize))&&(B.pageSize!="")){f("获取页面信息失败,请稍后再试!");return false}if(B.pageSize>15){f("获取页面信息失败,请稍后再试!");return false}}else{B.pageSize=""}B.curPage=A;B.DiffPlaceFlag=$("#DiffPlaceFlag").val();if(B.custId==null||B.custId==""){f("无法查询已订购产品,查询失败!");return}var z=contextPath+"/cust/orderprodSub";$.callServiceAsHtmlGet(z,B,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(C){if(!C){C.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(C.code==-2){return}else{if(C.code!=0){f("查询信息失败,请稍后重试!");return}}var D=$("#orderedprod");D.html(C.data);$("#phoneNumListtbody tr").off("click").on("click",function(E){var F=this;if(1==OrderInfo.order.step&&(!$(F).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){_cancel();l(F);OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(F).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();_cancel();l(F);OrderInfo.order.step=0},no:function(){null}})}else{l(this)}}});$("#plan2ndDiv tbody tr").each(function(){$(this).off("click").on("click",function(F){var E=this;if(1==OrderInfo.order.step&&(!$(E).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){_cancel();order.cust.linkSelectPlan(E);F.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(E).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();_cancel();order.cust.linkSelectPlan(E);F.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{order.cust.linkSelectPlan(this);F.stopPropagation()}}})});$("#phoneNumListtbody").children(":first-child").next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();$("#phoneNumListtbody").children(":first-child").click()}})};var l=function(A){$("#is3GCheckbox").off().change(function(){order.prodModify.getChooseProdInfo()});$("#phoneNumListtbody tr").filter(".plan_select").children(":first-child").html("");$("#phoneNumListtbody tr").filter(".plan_select").removeClass("plan_select").next("#plan2ndTr").hide();$(A).addClass("plan_select").next("#plan2ndTr").show();var z="<i class='select'></i>";$(A).children(":first-child").html(z);$(A).next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();OrderInfo.busitypeflag=2;$("#custInfo").hide();offerChange.init()};return{fromProvFlag:a,custQuery:t,queryCallBack:p,btnQueryCustProd:w,showCustAuth:m,orderInfo:y,showPackageDialog:f}})();$(function(){});CommonUtils.regNamespace("order","uiCustes");var num=0;var maxNum=0;var _newAddList=[];var showDialogInfo=function(a){$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>"+a+"</div>")};var _showPackageDialog=function(b){var a='<table class="contract_list rule">';a+='<thead><tr> <td colspan="2">提示</td></tr></thead></table>';a+='<div id="rules_div" height="height:140px;">';a+='<table width="100%" height="120px;" border="0" cellspacing="0" cellpadding="0">';a+="<tr>";a+='<td align="right"></td>';a+='<td><div class="rule_font" style="width:100%;font-size:15px; text-align:center;">'+b+"</div></td>";a+="</tr>";a+="</table>";a+="</div>";easyDialog.open({container:"packageTip_dialog"});$("#infoTipContent").html("");$("#infoTipContent").html(a)};order.uiCustes=(function(){var a={};var ae={};var aa;var C=null;var O=null;var X="0";var t=null;var u=[];var E="";var S=[];var v=[];var Y={};var G=false;var a={};var ad=function(){var aj=contextPath+"/order/createorderlonger";var an=$.callServiceAsJson(aj,{});if(an.code==0){OrderInfo.custorderlonger=an.data}var ar="";var aq="";var ak="";var ai="";var ao="";var am="";var ap="";ar=$("#p_cust_identityCd").val();ao=$.trim($("#p_cust_identityNum").val());if(order.uiCustes.fromProvFlag=="1"||(ar!=-1&&CONST.getAppDesc()!=0)){ar=$("#p_cust_identityCd").val();O="1"}else{O="0"}if(ar==-1){ai=ao;ao="";ar=""}else{if(ar=="acctCd"||ar=="custNumber"){ai="";ao="";ar="";am=$("#p_cust_identityCd").val();ap=$.trim($("#p_cust_identityNum").val())}}ak=$("#DiffPlaceFlag").val();areaId=$("#custAreaId_").val();if(areaId==null||areaId==""||areaId=="null"||areaId=="undefined"){_showPackageDialog("用于客户定位的地市为空，请重试!");return}if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){_showPackageDialog("省级地区无法进行定位客户,请选择市级地区!");return}var al={acctNbr:ai,identityCd:ar,identityNum:ao,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:ak,areaId:areaId,queryType:am,queryTypeValue:ap,identidies_type:$("#p_cust_identityCd  option:selected").text()};$.callServiceAsHtml(contextPath+"/token/pc/cust/queryCustSub2",al,{before:function(){$.ecOverlay("<strong>正在查询客户信息中,请稍候...</strong>")},done:function(at){if(at.code==-2){return}af(at)},fail:function(at){$.unecOverlay();_showPackageDialog("客户定位失败，请稍后再试!")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})};var af=function(ai){if(ai.data.indexOf("showVerificationcode")>=0){$("#vali_code_input").val("");$("#validatecodeImg").css({width:"80px",height:"32px"}).attr("src",contextPath+"/validatecode/codeimg.jpg?"+Math.floor(Math.random()*100)).fadeIn();easyDialog.open({container:"Verificationcode_div"});return}if(ai.data.indexOf("false")>=0){_showPackageDialog("抱歉,没有定位到客户,请尝试其他客户");return}var aj=$("#custList");aj.html(ai.data).show();$(".userclose").off("click").on("click",function(ak){O="";$(".usersearchcon").hide()});if($("#custListTable").attr("custInfoSize")=="1"){$(".usersearchcon").hide()}};var b=function(aj){$("#main_div_1").show();a={custId:$(aj).find("td:eq(3)").text(),partyName:$(aj).find("td:eq(0)").text(),idCardNumber:$(aj).find("td:eq(4)").text(),identityName:$(aj).attr("identityName"),areaName:$(aj).attr("areaName"),areaId:$(aj).attr("areaId"),identityCd:$(aj).attr("identityCd"),addressStr:$(aj).attr("addressStr"),norTaxPayer:$(aj).attr("norTaxPayer"),segmentId:$(aj).attr("segmentId"),segmentName:$(aj).attr("segmentName"),custFlag:$(aj).attr("custFlag"),vipLevel:$(aj).attr("vipLevel"),vipLevelName:$(aj).attr("vipLevelName")};if(order.uiCustes.queryForChooseUser&&a.segmentId!=1100){_showPackageDialog("使用人必须是公众客户，请重新定位");return false}if(O=="0"){if(order.cust.authType=="00"){$("#custAuthTypeName").html("客户密码：")}else{$("#custAuthTypeName").html("产品密码：")}var ai=$("#p_cust_identityCd").val();if("1"==ai){$("#authIDTD").attr("disabled",false);easyDialog.open({container:"authID",callback:function(){order.uiCustes.queryForChooseUser=false}})}else{easyDialog.open({container:"auth",callback:function(){order.uiCustes.queryForChooseUser=false}});V()}if(order.cust.jumpAuthflag=="0"){$("#jumpAuth").off("click").on("click",function(){order.cust.jumpAuth()});$("#jumpAuth").show();$("#jumpAuthID").show()}$("#authClose").off("click").on("click",function(ak){easyDialog.close();$("#authPassword").val("")});$("#authIDClose").off("click").on("click",function(ak){easyDialog.close();
$("#authIDTD").val("")})}else{_custAuth(aj)}};var V=function(){var ai=a;ai.authFlag="1";$.callServiceAsHtml(contextPath+"/cust/custAuthSub",ai,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(aj){if(aj.code!=0){_showPackageDialog("客户鉴权失败,稍后重试!");return}if(!order.uiCustes.queryForChooseUser){C=ai;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;A(aj)}else{order.main.showChooseUserDialog(ai)}},always:function(){}})};var A=function(ai){if(O=="0"){easyDialog.close()}$("#custList").hide();$("#custQryDiv").hide();if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}var aj=$("#custInfo");aj.html(ai.data).show();if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){$("#custModifyId").attr("style","display: none;")}else{$("#custModifyId").attr("style","")}$("#cCustName").val("");$("#cCustIdCard").val("");main.home.hideMainIco();ah()};var ah=function(aj){if(OrderInfo.cust.custId==-1){_showPackageDialog("新建客户无法查询已订购产品!");return}var ai=1;$("#prodDetail").hide();$("#prodInfo").hide();$("#prodList").hide();$("#orderContent").show();if(order.cust.orderBtnflag==""){main.home.hideMainIco();Z(ai);$("#orderedprod").hide();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{if(order.cust.orderBtnflag=="0"||$("#orderedprod").is(":hidden")){$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{$("#orderedprod").hide();$("#arroworder").removeClass();$("#arroworder").addClass("arrow");order.cust.orderBtnflag="0";$("#orderbutton").css({height:"24px","border-bottom":"1px solid #4f7d3f"})}}};var Z=function(aj){var ak={};if(a==null){ak.custId=""}else{ak.custId=a.custId;ak.areaId=$("#area").attr("areaId")}if(document.getElementById("accNbrQuery")){ak.acctNbr=$.trim($("#accNbrQuery").val());if(CONST.getAppDesc()==0){ak.areaId=$("#p_cust_areaId").val()}}else{if($("#isAppointNum").attr("checked")=="checked"){ak.acctNbr=$.trim($("#p_cust_identityNum").val());if(CONST.getAppDesc()==0){ak.areaId=$("#p_cust_areaId").val()}}else{ak.acctNbr=""}}ak.acctNbr=OrderInfo.acctNbr;if(document.getElementById("custPageSize")){ak.pageSize=$.trim($("#custPageSize").val());if(!(/^[1-9]\d*$/.test(ak.pageSize))&&(ak.pageSize!="")){_showPackageDialog("获取页面信息失败,请稍后再试!");return false}if(ak.pageSize>15){_showPackageDialog("获取页面信息失败,请稍后再试!");return false}}else{ak.pageSize=""}ak.curPage=aj;ak.DiffPlaceFlag=$("#DiffPlaceFlag").val();if(ak.custId==null||ak.custId==""){_showPackageDialog("无法查询已订购产品,查询失败!");return}var ai=contextPath+"/cust/orderprodSub";$.callServiceAsHtmlGet(ai,ak,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(al){if(!al){al.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(al.code==-2){return}else{if(al.code!=0){_showPackageDialog("查询信息失败,请稍后重试!");return}}var am=$("#orderedprod");am.html(al.data);$("#phoneNumListtbody tr").off("click").on("click",function(an){var ao=this;if(1==OrderInfo.order.step&&(!$(ao).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){_cancel();order.uiCustes.linkQueryOffer(ao);OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(ao).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();_cancel();order.uiCustes.linkQueryOffer(ao);OrderInfo.order.step=0},no:function(){null}})}else{order.uiCustes.linkQueryOffer(this)}}});$("#plan2ndDiv tbody tr").each(function(){$(this).off("click").on("click",function(ao){var an=this;if(1==OrderInfo.order.step&&(!$(an).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){_cancel();order.cust.linkSelectPlan(an);ao.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(an).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();_cancel();order.cust.linkSelectPlan(an);ao.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{order.cust.linkSelectPlan(this);ao.stopPropagation()}}})});$("#phoneNumListtbody").children(":first-child").next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();$("#phoneNumListtbody").children(":first-child").click()}})};var l=function(ai,ak){var aj=OrderInfo.cust.custId;offerprice=ak;if(OrderInfo.cust==undefined||aj==undefined||aj==""){$.alert("提示","在订购套餐之前请先进行客户定位！");return}var al={price:ak,specId:ai,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};if(OrderInfo.actionFlag==2){order.uiCustes.opeSer(al)}};var F=function(an){var ap={offerSpecId:an.specId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var ao=query.offer.queryMainOfferSpec(ap);if(!ao){return}if(OrderInfo.actionFlag==2){var ak=contextPath+"/token/pc/order/queryFeeType";$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");var aj=$.callServiceAsJsonGet(ak,ap);$.unecOverlay();if(aj.code==0){if(aj.data!=undefined){if("0"==aj.data){var am=false;if(order.prodModify.choosedProdInfo.feeType=="2100"&&(ao.feeType=="2100"||ao.feeType=="3100"||ao.feeType=="3101"||ao.feeType=="3103"||ao.feeType=="1202"||ao.feeType=="2101")){am=true}else{if(order.prodModify.choosedProdInfo.feeType=="1200"&&(ao.feeType=="1200"||ao.feeType=="3100"||ao.feeType=="3102"||ao.feeType=="3103"||ao.feeType=="1202"||ao.feeType=="2101")){am=true}else{if(order.prodModify.choosedProdInfo.feeType=="1201"&&(ao.feeType=="1201"||ao.feeType=="3101"||ao.feeType=="3102"||ao.feeType=="3103")){am=true}}}if(!am){$.alert("提示","付费类型不一致,无法进行套餐变更。");return}}}}order.uiCustes.offerChangeView();return}var al=0;var ai=$("#member_tbody");ai.html("");$("#main_title").text(OrderInfo.offerSpec.offerSpecName);$.each(ao.offerRoles,function(){var at=this;var ar=$("<tr style='background:#f8f8f8;'></tr>");var av=$('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'+at.offerRoleName+"</span>&nbsp;&nbsp;</td>");if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){ar.append(av).append($("<td colspan='3'></td>")).appendTo(ai)}else{ar.append(av).appendTo(ai)}$.each(this.roleObjs,function(){var ax=at.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){if(at.minQty==0){this.minQty=0;this.dfQty=0}var aw=this.maxQty<0?"不限制":this.maxQty;ar.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'><a class='add' href='javascript:order.service.subNum(\""+ax+'",'+this.minQty+");'></a><input id='"+ax+"' type='text' value='"+this.dfQty+"' class='numberTextBox width22' readonly='readonly'><a class='add2' href='javascript:order.service.addNum(\""+ax+'",'+this.maxQty+',"'+at.parentOfferRoleId+"\");'> </a></i>"+this.minQty+"-"+aw+"（张） </td>");al++}});var au=$("<tr></tr>");var aq=0;$.each(this.roleObjs,function(){var ay=at.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.SERV){if(aq%4==0){au=$("<tr></tr>");au.appendTo(ai)}var ax=$('<input id="'+ay+'" name="'+at.offerRoleId+'" type="checkbox">'+this.objName+"</input>");if(this.minQty==0){if(this.dfQty>0){ax.attr("checked","checked")}}else{if(this.minQty>0){ax.attr("checked","checked");ax.attr("disabled","disabled")}}var aw=$("<td></td>");
aw.append(ax).appendTo(au);aq++;al++}})});var ap={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:ao,actionFlag:1,type:1};if(al>1){easyDialog.open({container:"member_dialog"});$("#member_btn").off("click").on("click",function(){order.service.confirm(ap)})}else{if(!_setOfferSpec(1)){$.alert("错误提示","请选择一个接入产品");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(ap)}}};var T=function(){_newAddList=[];offerChange.newMemberFlag=false;offerChange.oldMemberFlag=false;var ak=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==2){ak++}});var aj=1;var ap=0;if(ak>1){aj=2}if(!offerChange.setChangeOfferSpec(aj,ap)){return}if(CONST.getAppDesc()==0){if(order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){if(!offerChange.checkOrder()){return}}if(!prod.uim.setProdUim()){return}}if(OrderInfo.actionFlag==2){var ar=OrderInfo.data.orderList.custOrderList[0].busiOrder;var aq=1;var ai=1;order.memberChange.newSubPhoneNum="";order.memberChange.oldSubPhoneNum="";$.each(ar,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){order.memberChange.newmembers.flag=true;if(aq==1){order.memberChange.newSubPhoneNum+=this.busiObj.accessNumber;aq++}else{order.memberChange.newSubPhoneNum+=","+this.busiObj.accessNumber}}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"){if(this.busiObj.isComp!=undefined){order.memberChange.oldmembers.flag=true;if(ai==1){order.memberChange.oldSubPhoneNum+=this.busiObj.accessNumber;ai++}else{order.memberChange.oldSubPhoneNum+=","+this.busiObj.accessNumber}var au=this.data.ooRoles[0].objInstId;var at=this.busiObj.instId;order.memberChange.oldmembers.objInstId.push({instId:at,objInstId:au})}}}});var am=[];var an=[];if(order.memberChange.newSubPhoneNum!=""){am=order.memberChange.newSubPhoneNum.split(",")}if(order.memberChange.oldSubPhoneNum!=""){an=order.memberChange.oldSubPhoneNum.split(",")}var ao=0;var al=$("#member_tbody");al.html("");$("#main_title").text(OrderInfo.offerSpec.offerSpecName);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd=="401"){var au=this;var at=$("<tr style='background:#f8f8f8;'></tr>");var av=$('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'+au.offerRoleName+"</span>&nbsp;&nbsp;</td>");if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){at.append(av).append($("<td colspan='3'></td>")).appendTo(al)}else{at.append(av).appendTo(al)}$.each(this.roleObjs,function(){var az=au.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){_newAddList.push(az);if(au.minQty==0){this.minQty=0;this.dfQty=0}var ay=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd=="401"){ay++}});ao=this.maxQty<0?"不限制":this.maxQty-ay;if(ao<0){ao=0}maxNum=ao;at.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'><a class='add' href='javascript:order.service.subNum(\""+az+'",'+this.minQty+");'></a><input id='"+az+"' type='text' value='"+am.length+"' class='numberTextBox width22' readonly='readonly'><a class='add2' href='javascript:order.service.addNum(\""+az+'",'+ao+',"'+au.parentOfferRoleId+"\");'> </a></i>"+this.minQty+"-"+ao+"（张） </td>");if(ao>0){for(var ax=0;ax<an.length;ax++){if(ax==0){var aw="<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'><td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td><td align='left' colspan='3'><input value='"+an[ax]+"' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' ><a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+ao+',"");\'> </a>'+this.minQty+"-"+ao+"（张）</td></tr>";at.after(aw)}else{order.memberChange.addNum(ao,an[ax])}}}}})}});easyDialog.open({container:"member_dialog"});J()}};function J(){OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldprodAcctInfos=[];OrderInfo.oldAddNumList=[];var aj=0;var ai=0;order.memberChange.viceCartNum=0;var ak=[];$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd=="401"){if(this.prodInsts!=undefined){var ap=this.prodInsts;for(var ao=0;ao<this.prodInsts.length;ao++){var an='"'+this.prodInsts[ao].prodInstId+'"';if(an.indexOf("-")!=-1){ak.push(this.prodInsts[ao])}}$.each(ak,function(){var aq=this.prodInstId;$.each(ap,function(ar){if(this.prodInstId=aq){ap.splice(ar,1)}})})}}});$.each(_newAddList,function(){aj=aj+Number($("#"+this).val())});$("#member_tbody").find("tr[name='oldnbr']").each(function(){var an=$.trim($(this).children("td").eq(1).children("input").val());if(ec.util.isObj(an)){ai++}});if(aj>0){offerChange.newMemberFlag=true;order.service.setOfferSpec()}if(ai>0){offerChange.oldMemberFlag=true;if(!order.memberChange.queryofferinfo()){return}}var al=order.prodModify.choosedProdInfo;var am={boActionTypeCd:"S2",boActionTypeName:"套餐变更",actionFlag:"2",offerSpec:OrderInfo.offerSpec,prodId:al.prodInstId,offerMembers:OrderInfo.offer.offerMemberInfos,oldOfferSpecName:al.prodOfferName,prodClass:al.prodClass,appDesc:CONST.getAppDesc(),areaId:order.prodModify.choosedProdInfo.areaId,newnum:parseInt(aj),oldnum:parseInt(ai)};if(ai>0){am.oldprodInstInfos=OrderInfo.oldprodInstInfos;am.oldofferSpec=OrderInfo.oldofferSpec;am.oldoffer=OrderInfo.oldoffer}order.uiCustes.buildMainView(am);easyDialog.close()}var p=function(aj){if(aj==undefined||!aj){aj=_getTestParam()}if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){if(OrderInfo.actionFlag==6){var ai=false;if(aj.feeTypeMain=="2100"&&(OrderInfo.offerSpec.feeType=="2100"||OrderInfo.offerSpec.feeType=="3100"||OrderInfo.offerSpec.feeType=="3101"||OrderInfo.offerSpec.feeType=="3103")){ai=true}else{if(aj.feeTypeMain=="1200"&&(OrderInfo.offerSpec.feeType=="1200"||OrderInfo.offerSpec.feeType=="3100"||OrderInfo.offerSpec.feeType=="3102"||OrderInfo.offerSpec.feeType=="3103")){ai=true}else{if(aj.feeTypeMain=="1201"&&(OrderInfo.offerSpec.feeType=="1201"||OrderInfo.offerSpec.feeType=="3101"||OrderInfo.offerSpec.feeType=="3102"||OrderInfo.offerSpec.feeType=="3103")){ai=true}}}if(!ai){$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");return}}}$.callServiceAsHtml(contextPath+"/token/pc/order/main",aj,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(ak){if(!ak){ak.data="查询失败,稍后重试"}if(ak.code!=0){$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=aj.actionFlag;if(OrderInfo.actionFlag==2){order.uiCustes.fillOfferChange(ak,aj)}else{if(OrderInfo.actionFlag==21){order.memberChange.fillmemberChange(ak,aj)}else{_callBackBuildView(ak,aj)}}if(CONST.getAppDesc()==1&&(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14)){$("#li_is_activation").show()}},always:function(){$.unecOverlay()}})};var ag=function(ai,al){SoOrder.initFillPage();$("#order_fill_content").html(ai.data);$("#fillNextStep").off("click").on("click",function(){SoOrder.submitOrder()});$("#fillLastStep").off("click").on("click",function(){order.main.lastStep()});var aj=order.prodModify.choosedProdInfo;var ak=false;var am=0;$.each(OrderInfo.offerSpec.offerRoles,function(){var an=this;if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){var av="'"+this.prodInstId+"'";if(av.indexOf("-")==-1){var ar=this.prodInstId;var au={areaId:OrderInfo.getProdAreaId(ar),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ar,prodSpecId:this.objId,offerSpecId:aj.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var ao=query.offer.queryChangeAttachOffer(au);$("#attach_"+ar).html(ao);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){au.queryType="1,2";au.objId=this.objId;au.objType=this.objType;au.memberRoleCd=this.roleCd;au.offerSpecId=OrderInfo.offerSpec.offerSpecId;var aq=query.offer.queryDefMustOfferSpec(au);CacheData.parseOffer(aq);au.queryType="1";var aq=query.offer.queryServSpec(au);CacheData.parseServ(aq)
}AttachOffer.showMainRoleProd(ar);AttachOffer.changeLabel(ar,this.objId,"");if(AttachOffer.isChangeUim(ar)){if(am==0){$("#uimDiv_"+ar).show();am++}else{$("#uimDiv_"+ar)[0].style.display="none"}}}else{var ap=this;var au={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:ap.objId,offerRoleId:ap.offerRoleId,prodId:ap.prodInstId,queryType:"1,2",objType:ap.objType,objId:ap.objId,memberRoleCd:ap.memberRoleCd};AttachOffer.queryAttachOfferSpec(au);var at={ul_id:"item_order_"+ap.prodInstId,prodId:ap.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:ap.objId,roleCd:an.roleCd,offerRoleId:an.offerRoleId,partyId:OrderInfo.cust.custId};order.main.spec_parm(at)}})}});if(offerChange.newMemberFlag){order.main.initAcct(0)}if(offerChange.oldMemberFlag){order.main.initAcct(1);order.main.loadAttachOffer()}$("#zhanghuclose").click(function(){easyDialog.close();$(document).removeJEventListener("queryAccount")});order.dealers.initDealer();K();if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){offerChange.checkOfferProd()}U()};var U=function(){$("#dealerTbody").empty();var aq=OrderInfo.data.orderList.custOrderList[0].busiOrder;$.each(aq,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){$("#nbr_btn_"+this.data.boProdAns[0].prodId).removeClass("selectBoxTwo");$("#nbr_btn_"+this.data.boProdAns[0].prodId).addClass("selectBoxTwoOn");$("#nbr_btn_"+this.data.boProdAns[0].prodId).html(this.busiObj.accessNumber+"<u></u>");var aF={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};OrderInfo.boProdAns.push(aF);order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);var aB={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,cardTypeFlag:this.data.bo2Coupons[0].cardTypeFlag,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};OrderInfo.clearProdUim(this.busiObj.instId);OrderInfo.boProd2Tds.push(aB);$("#pwd_"+this.busiObj.instId).val(this.data.boProdPasswords[0].pwd);$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected")}if(this.data.boAccountRelas!=undefined){var aD=this.data.boAccountRelas[0].acctId;$("#acctSelect").find("option[value="+aD+"]").attr("selected","selected")}if(this.data.busiOrderAttrs!=undefined){var aJ=[];var aA={};var az={};var ay={};$.each(this.data.busiOrderAttrs,function(){if(this.role=="40020005"){aA.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aA.staffid=this.value;aA.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aA.staffname=this.value}}}else{if(this.role=="40020006"){az.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){az.staffid=this.value;az.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){az.staffname=this.value}}}else{if(this.role=="40020007"){ay.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){ay.staffid=this.value;ay.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){ay.staffname=this.value}}}}}});if(ec.util.isObj(aA.role)){aJ.push(aA)}if(ec.util.isObj(az.role)){aJ.push(az)}if(ec.util.isObj(ay.role)){aJ.push(ay)}var av="";var ax="";if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){av=this.busiObj.instId}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="1"){av=this.busiObj.objId}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){av=this.data.ooRoles[0].prodId+"_"+this.busiObj.objId;ax="DEL"}}}var at=this.busiObj.accessNumber;if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="1"){at="主套餐"}for(var aH=0;aH<aJ.length;aH++){var aI;if(aH==0){aI=$("<tr id='tr_"+av+"' name='tr_"+av+"'></tr>")}else{aI=$('<tr name="tr_'+av+'"></tr>')}var aE=$("<td></td>");var aC=av+"_"+OrderInfo.SEQ.dealerSeq;var aG=$('<select id="dealerType_'+aC+'" name="dealerType_'+av+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+av+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(aJ[aH].role==this.PARTYPRODUCTRELAROLECD){aG.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected>"+this.NAME+"</option>")}else{aG.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});aE.append(aG);aE.append('<label class="f_red">*</label>');aI.append("<td>"+at+"</td>");if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){aI.append("<td>移动电话（仅含本地语音）</td>")}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){aI.append("<td>"+this.busiObj.objName+"</td>")}}aI.append(aE);var aw;if(ax=="DEL"){if(aH==0){aw=$('<td><input type="text" id="dealer_'+aC+'" staffId="'+aJ[aH].staffid+'" value="'+aJ[aH].staffname+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>')}else{aw=$('<td><input type="text" id="dealer_'+aC+'" staffId="'+aJ[aH].staffid+'" value="'+aJ[aH].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>')}}else{aw=$('<td><input type="text" id="dealer_'+aC+'" staffId="'+aJ[aH].staffid+'" value="'+aJ[aH].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>')}aw.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+aC+"');\">选择</a>");if(aH==0){if(ax=="DEL"){aw.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>')}aw.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+av+',1)">添加</a><label class="f_red">*</label>')}else{aw.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>')}aI.append(aw);if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){OrderInfo.getChannelList()}var ar=$("<td></td>");var au=$('<select id="dealerChannel_'+aC+'" name="dealerChannel_'+av+'" class="inputWidth183px" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(aJ[aH].channelNbr==this.channelNbr){au.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")
}else{au.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});ar.append(au);ar.append('<label class="f_red">*</label>');aI.append(ar);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(aI)}}});var al=new Array();var ak=OrderInfo.data;var ai=0;var aq=ak.orderList.custOrderList;var ao=ak.orderList.orderListInfo;if(aq!=null&&aq!=""){if(aq!=null&&aq.length>0){$(aq).each(function(ar,at){$(at.busiOrder).each(function(aU,aK){var ay=aK.boActionType.boActionTypeCd;var az="";var aW=aK.data;var aE;var aV;if(ay=="7"){aV=aW.boServs;if(aV!=null){$(aV).each(function(aZ,aY){az=aY.state})}}else{aE=aW.ooOwners;if(aE!=null){$(aE).each(function(aZ,aY){az=aY.state;return false})}}var aX=aK.busiObj;if(ay=="S2"){var aS=aX.instId;var aO=aX.offerTypeCd;$(aW.ooRoles).each(function(aZ,aY){var a0=aY.objInstId;az=aY.state;if(aO=="2"){if(az=="DEL"){r(a0,aS)}}})}else{if(ay=="7"){var aS=aX.instId;var au=aW.boServOrders;$(aW.boServs).each(function(aZ,aY){var a1=aY.servId;var a0=aY.state;if(a0=="DEL"){Q(aS,a1,a0)}else{if(a0=="ADD"){$(au).each(function(a2,a3){var a5=a3.servSpecId;var a4=a3.servSpecName;h(aS,a5,a4,"N")})}}})}else{if(ay=="S1"){var aP=aX.instId;var aC=aK.data.busiOrderAttrs;var aB=aK.data.ooRoles;var aR=aX.offerTypeCd;var aP=aX.instId;var aC=aK.data.busiOrderAttrs;var aB=aK.data.ooRoles;var aM=aK.data;if(aK.boActionType.actionClassCd=="1200"&&aK.boActionType.boActionTypeCd=="S1"&&aK.busiObj.offerTypeCd=="2"){var aJ=aX.objId;var aH=aX.accessNumber;var aG=aX.objName;var aQ=null;var aB=aW.ooRoles;$(aW.ooRoles).each(function(aZ,aY){aQ=aY.prodId;return false});f(aQ,aJ,aB)}if(aK.boActionType.actionClassCd=="1200"&&aK.boActionType.boActionTypeCd=="S1"&&aK.busiObj.offerTypeCd=="2"){if(aM.bo2Coupons!=undefined){if(aM.bo2Coupons.length==1){var aL=aM.bo2Coupons[0];var aQ=aL.prodId;var aD=aL.attachSepcId;var aF="1";var aT="0";$("#terminalText_"+aL.prodId+"_"+aL.attachSepcId+"_"+aF).val(aL.couponInstanceNumber);B(aQ,aD,aF,aT)}else{for(var aU=0;aU<aM.bo2Coupons.length;aU++){if(aU==0){var aL=aM.bo2Coupons[0];var aQ=aL.prodId;var aD=aL.attachSepcId;var aF="1";var aT="0";$("#terminalText_"+aL.prodId+"_"+aL.attachSepcId+"_"+aF).val(aL.couponInstanceNumber);B(aQ,aD,aF,aT)}else{var aL=aM.bo2Coupons[aU];var aQ=aL.prodId;var aD=aL.attachSepcId;var ax=aQ+"_"+aD;var aI=$("#ul_"+ax+" li");var aw=aI.length-1;var aF=aw/2+1;var aA="0";var aT="0";m(aQ,aD,aA);$("#terminalText_"+aQ+"_"+aL.attachSepcId+"_"+aF).val(aL.couponInstanceNumber);B(aQ,aD,aF,aT)}}}}}}else{if(ay=="14"){var aL=aK.data.bo2Coupons;for(var aU=0;aU<aL.length;aU++){if(aL[aU].state=="ADD"){var av=aL[aU].couponInstanceNumber;var aN=aL[aU].prodId;$("#uim_txt_"+aN).val(av);order.uiCustes.checkUim(aN,aL[aU]);al[ai]=aN;ai++;$("#uimDiv_"+aN)[0].style.display="none"}}}}}}})})}}$.each(AttachOffer.openServList,function(){var ar=this;$.each(this.servSpecList,function(){var au=this;var at=false;var aw=aq[0];$.each(aw.busiOrder,function(){var az=this;if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(au.servSpecId==this.data.boServOrders[0].servSpecId&&ar.prodId==this.busiObj.instId){at=true;return false}}});if(!at){var av=$("#li_"+ar.prodId+"_"+this.servSpecId).find("span");var ax=CacheData.getServSpec(ar.prodId,this.servSpecId);if(ax==undefined){return}av.addClass("del");ax.isdel="Y";AttachOffer.showHideUim(1,ar.prodId,this.servSpecId);var ay=CacheData.getServBySpecId(ar.prodId,this.servSpecId);if(ec.util.isObj(ay)){av.addClass("del");ay.isdel="Y"}}})});if(ao!=null&&aq!=null){var an=ao.custOrderAttrs;var am=ao.isTemplateOrder;var ap=ao.templateOrderName;$(an).each(function(at,au){var ar=au.itemSpecId;if(ar=="111111118"){var av=au.value;if(av!=null&&av!=""){$("#order_remark").html(av)}}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrName){$("#orderAttrName").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrPhoneNbr){$("#orderAttrPhoneNbr").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderIdentidiesTypeCd){$("#orderIdentidiesTypeCd").find("option[value="+this.value+"]").attr("selected","selected")}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrIdCard){$("#orderAttrIdCard").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrAddr){$("#orderAttrAddr").val(this.value)}});if(am=="Y"){$("#isTemplateOrder").click();SoOrder.showTemplateOrderName();$("#templateOrderName").val(ap)}}for(var aj=0;aj<al.length;aj++){if(aj==0){$("#uimDiv_"+al[aj])[0].style.display="block"}else{$("#uimDiv_"+al[aj])[0].style.display="none"}}};var q=function(aj,ak){var ai=CacheData.getOfferSpec(aj,ak);if(ai==undefined){ai=query.offer.queryAttachOfferSpec(aj,ak);if(!ai){return}CacheData.setOfferSpec(aj,ai)}return ai};var f=function(al,am,aj){var ai=q(al,am);if(ai==undefined){return}var ak=CacheData.getOfferProdStr(al,ai,0);w(al,ai);D(al,ai)};var D=function(aj,al){var am=al.offerSpecId;var ak=CacheData.getExcDepOfferParam(aj,am);var ai=query.offer.queryExcludeDepend(ak);if(ai!=undefined){g(ai.result,aj,am,al.offerSpecName)}};var g=function(az,aq,ax,aj){var ar="";var an={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(az!=""){var al=az.offerSpec.exclude;var ak=az.offerSpec.depend;var au=az.offerSpec.defaultList;if(ec.util.isArray(al)){for(var ap=0;ap<al.length;ap++){var ay=CacheData.getOfferList(aq);var at=true;if(ay!=undefined){for(var ao=0;ao<ay.length;ao++){if(ay[ao].isdel=="Y"){if(ay[ao].offerSpecId==al[ap].offerSpecId){at=false;break}}}}if(at){ar+="需要关闭：   "+al[ap].offerSpecName+"<br>";an.excludeOffer.push(al[ap].offerSpecId)}}}if(ak!=undefined&&ec.util.isArray(ak.offerInfos)){for(var ap=0;ap<ak.offerInfos.length;ap++){ar+="需要开通： "+ak.offerInfos[ap].offerSpecName+"<br>";an.dependOffer.dependOffers.push(ak.offerInfos[ap].offerSpecId)}}if(ak!=undefined&&ec.util.isArray(ak.offerGrpInfos)){for(var ap=0;ap<ak.offerGrpInfos.length;ap++){var ai=ak.offerGrpInfos[ap];an.dependOffer.offerGrpInfos.push(ai);ar+="需要开通： 开通"+ai.minQty+"-"+ai.maxQty+"个以下业务:<br>";if(ai.subOfferSpecInfos!="undefined"&&ai.subOfferSpecInfos.length>0){for(var ao=0;ao<ai.subOfferSpecInfos.length;ao++){var aw=ai.subOfferSpecInfos[ao];var am=CacheData.getOfferSpec(aq,aw.offerSpecId);if(ec.util.isObj(am)){if(am.isdel!="Y"&&am.isdel!="C"){ar+='<input id="'+aw.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}else{ar+='<input id="'+aw.offerSpecId+'" checked="checked" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}}else{var am=CacheData.getOfferBySpecId(aq,aw.offerSpecId);if(ec.util.isObj(am)){if(am.isdel!="Y"&&am.isdel!="C"){ar+='<input id="'+aw.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}else{ar+='<input id="'+aw.offerSpecId+'" checked="checked" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}}else{ar+='<input id="'+aw.offerSpecId+'" checked="checked" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}}}}}}if(ec.util.isArray(au)){for(var ap=0;ap<au.length;ap++){ar+="需要开通： "+au[ap].offerSpecName+"<br>";an.defaultOffer.push(au[ap].offerSpecId)}}}var av=N(aq,ax);ar=ar+av;AttachOffer.addOpenList(aq,ax)};var Q=function(al,an,ak){var am=CacheData.getServ(al,an);var ai=$("#li_"+al+"_"+am.servId).find("span");if("13409244"==am.servSpecId){$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能")}else{var aj=OrderInfo.getProdUim(al);if(am.servSpecId=="280000020"&&(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)&&aj.cardTypeFlag=="1"){$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");return}ai.addClass("del");am.isdel="Y"}};var w=function(aj,ak,ai){if(ak!=undefined){$.each(ak.offerRoles,function(){$.each(this.roleObjs,function(){var al=aj+"_"+this.objId;$(ai).each(function(an,ao){var am=ao.prodId+"_"+ao.objId;if(al==am){this.selQty=1;return false}else{this.selQty=2
}})})})}};var L=function(am,aj){var al="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var ao=this.PARTYPRODUCTRELAROLECD;var an=true;$("select[name='dealerType_"+am+"']").each(function(){if(ao==$(this).val()){an=false;return false}});if(an){al=ao;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(al==undefined||al==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var ak=$("<td></td>");var ai=$('<select id="dealerType_'+aj+'" name="dealerType_'+am+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+am+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==al){ai.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{ai.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});ak.append(ai);ak.append('<label class="f_red">*</label>');return ak};var i=function(az,aq,ax,aj){var ar="";var an={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(az!=""){var al=az.offerSpec.exclude;var ak=az.offerSpec.depend;var au=az.offerSpec.defaultList;if(ec.util.isArray(al)){for(var ap=0;ap<al.length;ap++){var ay=CacheData.getOfferList(aq);var at=true;if(ay!=undefined){for(var ao=0;ao<ay.length;ao++){if(ay[ao].isdel=="Y"){if(ay[ao].offerSpecId==al[ap].offerSpecId){at=false;break}}}}if(at){ar+="需要关闭：   "+al[ap].offerSpecName+"<br>";an.excludeOffer.push(al[ap].offerSpecId)}}}if(ak!=undefined&&ec.util.isArray(ak.offerInfos)){for(var ap=0;ap<ak.offerInfos.length;ap++){ar+="需要开通： "+ak.offerInfos[ap].offerSpecName+"<br>";an.dependOffer.dependOffers.push(ak.offerInfos[ap].offerSpecId)}}if(ak!=undefined&&ec.util.isArray(ak.offerGrpInfos)){for(var ap=0;ap<ak.offerGrpInfos.length;ap++){var ai=ak.offerGrpInfos[ap];an.dependOffer.offerGrpInfos.push(ai);ar+="需要开通： 开通"+ai.minQty+"-"+ai.maxQty+"个以下业务:<br>";if(ai.subOfferSpecInfos!="undefined"&&ai.subOfferSpecInfos.length>0){for(var ao=0;ao<ai.subOfferSpecInfos.length;ao++){var aw=ai.subOfferSpecInfos[ao];var am=CacheData.getOfferSpec(aq,aw.offerSpecId);if(ec.util.isObj(am)){if(am.isdel!="Y"&&am.isdel!="C"){ar+='<input id="'+aw.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}else{ar+='<input id="'+aw.offerSpecId+'" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}}else{var am=CacheData.getOfferBySpecId(aq,aw.offerSpecId);if(ec.util.isObj(am)){if(am.isdel!="Y"&&am.isdel!="C"){ar+='<input id="'+aw.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}else{ar+='<input id="'+aw.offerSpecId+'" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}}else{ar+='<input id="'+aw.offerSpecId+'" type="checkbox" name="'+ai.grpId+'" value="'+aw.offerSpecId+'">'+aw.offerSpecName+"</input><br>"}}}}}}if(ec.util.isArray(au)){for(var ap=0;ap<au.length;ap++){ar+="需要开通： "+au[ap].offerSpecName+"<br>";an.defaultOffer.push(au[ap].offerSpecId)}}}var av=N(aq,ax);ar=ar+av;if(ar==""){AttachOffer.addOpenList(aq,ax)}else{ar="<div style='max-height:300px;overflow:auto;'>"+ar+"</div>";$.confirm("订购： "+aj,ar,{yes:function(){CacheData.setOffer2ExcludeOfferSpec(an)},yesdo:function(){AttachOffer.excludeAddattch(aq,ax,an);AttachOffer.excludeAddServ(aq,"",P)},no:function(){}})}};var s=function(am,au,ak){if(ak.dependOffer.offerGrpInfos.length>0){var an=ak.dependOffer;for(var al=0;al<an.offerGrpInfos.length;al++){var ai=an.offerGrpInfos[al];var ao=ai.checkLen;if(ao>=ai.minQty&&ao<=ai.maxQty){$.each(ai.subOfferSpecInfos,function(){if(this.isCheck){AttachOffer.addOpenList(am,this.offerSpecId)}})}else{if(ao<ai.minQty){$.alert("提示信息","依赖组至少选中"+ai.minQty+"个！");return}else{if(ao>ai.maxQty){$.alert("提示信息","依赖组至多选中"+ai.maxQty+"个！");return}else{$.alert("错误信息","依赖组选择出错！");return}}}}}AttachOffer.addOpenList(am,au);if(ak.excludeOffer.length>0){for(var al=0;al<ak.excludeOffer.length;al++){var aj=ak.excludeOffer[al];var at=CacheData.getOfferSpec(am,aj);if(at!=undefined){var ap=$("#li_"+am+"_"+aj).find("span");ap.addClass("del");at.isdel="Y";$("#terminalUl_"+am+"_"+aj).remove()}var aq=CacheData.getOfferBySpecId(am,aj);if(aq!=undefined){var ap=$("#li_"+am+"_"+aq.offerId).find("span");ap.addClass("del");aq.isdel="Y"}}}if(ak.dependOffer.dependOffers.length>0){for(var al=0;al<ak.dependOffer.dependOffers.length;al++){var ar=ak.dependOffer.dependOffers[al];AttachOffer.addOpenList(am,ar)}}if(ak.defaultOffer.length>0){for(var al=0;al<ak.defaultOffer.length;al++){var ar=ak.defaultOffer[al];AttachOffer.addOpenList(am,ar)}}};var N=function(ak,al){var ai=q(ak,al);P.excludeServ=[];P.dependServ=[];P.relatedServ=[];var aj="";$.each(ai.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){var am=CacheData.getServSpec(ak,this.objId);if(am==undefined){var at=CacheData.getServBySpecId(ak,this.objId);if(at==undefined){var ap={objId:this.objId,servSpecId:this.objId,servSpecName:this.objName,ifParams:this.isCompParam,prodSpecParams:this.prodSpecParams,isdel:"C"};CacheData.setServSpec(ak,ap);am=ap}else{am=at}}var ar=am.servSpecId;var aq=CacheData.getExcDepServParam(ak,ar);if(aq.orderedServSpecIds.length==0){}else{var ao=query.offer.queryExcludeDepend(aq);var an=paserServDataByObjs(ao.result,ak,am,ai);if(an!=""){an=("开通【"+am.servSpecName+"】功能产品：<br>"+an);aj+=(an+"<br>")}}}})});return aj};var P={excludeServ:[],dependServ:[],relatedServ:[]};var j=function(al,ak){var aj=contextPath+"/offer/queryOfferInst";if(typeof(ak)=="function"){$.callServiceAsJsonGet(aj,al,{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(am){$.unecOverlay();if(am.code==0){if(am.data){ak(am.data)}}else{if(am.code==-2){$.alertM(am.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");var ai=$.callServiceAsJsonGet(aj,al);$.unecOverlay();if(ai.code==0){if(ai.data){return ai.data}}else{if(ai.code==-2){$.alertM(ai.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}};var o=function(ak,aq,ar){var an=ak.split("_")[0];if($("#tr_"+ak)[0]==undefined){var ai=ak+"_"+OrderInfo.SEQ.dealerSeq;var ao=L(ak,ai);if(ao==undefined){return false}var ap=$("#atr_"+ak);var at=$('<tr name="tr_'+ak+'"></tr>');at.append("<td>"+aq+"</td>");at.append("<td>"+ar+"</td>");at.append(ao);var au=$("#tr_"+an).find("input");var am=1;var al="";if(au[0]==undefined){am=OrderInfo.staff.staffId;al=OrderInfo.staff.staffName}else{am=au.attr("staffId");al=au.attr("value")}if(order.ysl!=undefined){var aj=$('<td><input type="text" id="dealer_'+ai+'" name="dealer_'+ak+'" staffId="'+am+'" value="'+al+'" class="inputWidth183px" style="margin-left:45px;"></input></td>')}else{var aj=$('<td><input type="text" id="dealer_'+ai+'" name="dealer_'+ak+'" staffId="'+am+'" value="'+al+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>')}aj.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+ai+"');\">选择</a>");aj.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');aj.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+ak+'\')">添加</a><label class="f_red">*</label>');at.append(aj);$("#dealerTbody").append(at);OrderInfo.SEQ.dealerSeq++}};var K=function(){if($("#orderProvAttrIsale")){$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale)}var aj=contextPath+"/order/provOrderAttrFlag";$.ecOverlay("<strong>正在查询是否显示省内订单属性,请稍后....</strong>");var ai=$.callServiceAsJsonGet(aj,{});
$.unecOverlay();if(ai.code==0){if(ai.data!=undefined){if("0"==ai.data){$("#orderProvAttrDiv").show()}}}};var r=function(am,ak){var ao=$("#li_"+am+"_"+ak).find("span");if(ao.attr("class")=="del"){}else{var ap=ac(am,ak);if(!ec.util.isArray(ap.offerMemberInfos)){var ai={prodId:am,areaId:OrderInfo.getProdAreaId(am),offerId:ak};if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var al=0;al<OrderInfo.oldprodInstInfos.length;al++){if(am==OrderInfo.oldprodInstInfos[al].prodInstId){ai.areaId=OrderInfo.oldprodInstInfos[al].areaId;ai.acctNbr=OrderInfo.oldprodInstInfos[al].accNbr}}}else{ai.acctNbr=OrderInfo.getAccessNumber(am)}var aq=order.uiCustes.queryOfferInst(ai);if(aq==undefined){return}var aj=[];$.each(aq.offerMemberInfos,function(){var at=this.objInstId;var ar=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==at){ar=true;return false}});if(ar){aj.push(this)}});ap.offerMemberInfos=aq.offerMemberInfos=aj;ap.offerSpec=aq.offerSpec}var an="";if(ap.offerSpec!=undefined){an=CacheData.getOfferProdStr(am,ap,1)}ap.isdel="Y";ao.addClass("del");W(am,ap)}};var W=function(aj,ai){$.each(ai.offerMemberInfos,function(){var am=this.objInstId;if($("#check_"+aj+"_"+am).attr("checked")=="checked"){var ak=CacheData.getServ(aj,am);if(ec.util.isObj(ak)){ak.isdel="Y";var al=$("#li_"+aj+"_"+am);al.removeClass("canshu").addClass("canshu2");al.find("span").addClass("del")}}})};var ac=function(al,ai){var aj=order.uiCustes.getOfferList(al);if(ec.util.isArray(aj)){for(var ak=0;ak<aj.length;ak++){if(aj[ak].offerId==ai){return aj[ak]}}}};var z=function(aj,ak){if(ak!=undefined){if(ak.servSpecId==""){var ai=$("#li_"+aj+"_"+ak.servId).find("span");ai.removeClass("del");ak.isdel="N"}else{AttachOffer.checkServExcludeDepend(aj,ak)}}};var h=function(an,ap,ai,at){var aj=CacheData.getServSpec(an,ap);if(aj==undefined){var ao={objId:ap,servSpecId:ap,servSpecName:ai,ifParams:at,isdel:"C"};var ar={prodSpecId:ap};if(at=="Y"){var al=query.prod.prodSpecParamQuery(ar);if(al==undefined||al.result==undefined){return}ao.prodSpecParams=al.result.prodSpecParams;if(ap==CONST.YZFservSpecId){var aq=$("select[name='pay_type_-1']").val();if(aq==undefined){aq=order.prodModify.choosedProdInfo.feeType}if(aq==CONST.PAY_TYPE.AFTER_PAY){for(var ak=0;ak<ao.prodSpecParams.length;ak++){var am=ao.prodSpecParams[ak];am.setValue=""}}else{for(var ak=0;ak<ao.prodSpecParams.length;ak++){var am=ao.prodSpecParams[ak];if(am.value!=""){am.setValue=am.value}else{if(!!am.valueRange[0]&&am.valueRange[0].value!=""){am.setValue=am.valueRange[0].value}}}}}}CacheData.setServSpec(an,ao);aj=ao}R(an,aj)};var I=function(aq,al,ai){var am=ai.servSpecId;var ak=aq.servSpec.exclude;var ao=aq.servSpec.depend;var ap=aq.servSpec.related;var an="";var aj={excludeServ:[],dependServ:[],relatedServ:[]};if(ec.util.isArray(ak)){$.each(ak,function(){var au=CacheData.getServList(al);var ar=true;if(au!=undefined){for(var at=0;at<au.length;at++){if(au[at].isdel=="Y"){if(au[at].servSpecId==this.servSpecId){ar=false;break}}}}if(ar){aj.excludeServ.push(this)}})}if(ec.util.isArray(ao)){$.each(ao,function(){an+="需要开通：   "+this.servSpecName+"<br>";aj.dependServ.push(this)})}if(ec.util.isArray(ap)){$.each(ap,function(){an+="需要开通：   "+this.servSpecName+"<br>";aj.relatedServ.push(this)})}if(an==""){AttachOffer.addOpenServList(al,am,ai.servSpecName,ai.ifParams)}else{AttachOffer.addOpenServList(al,am,ai.servSpecName,ai.ifParams);AttachOffer.excludeAddServ(al,am,aj)}};var R=function(ak,an,ai){var am=an.servSpecId;var al=CacheData.getExcDepServParam(ak,am);if(al.orderedServSpecIds.length==0){AttachOffer.addOpenServList(ak,am,an.servSpecName,an.ifParams)}else{var aj=query.offer.queryExcludeDepend(al);if(aj!=undefined){I(aj.result,ak,an)}}};var x=function(aj){for(var ai=0;ai<AttachOffer.openedList.length;ai++){var ak=AttachOffer.openedList[ai];if(ak.prodId==aj){return ak.offerList}}return[]};var n=function(ak,al){var ai=q(ak,al);if(ai==undefined){return}var aj=CacheData.getOfferProdStr(ak,ai,0);CacheData.setServ2OfferSpec(ak,ai)};var k=function(al,aj){var au=OrderInfo.getAccessNumber(al);var ak="-1";if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23||OrderInfo.actionFlag==6){if(ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==al){ak=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{ak=order.prodModify.choosedProdInfo.prodOfferInstId}}var at=$.trim($("#uim_txt_"+al).val());var am={instCode:at,phoneNum:au,areaId:OrderInfo.getProdAreaId(al)};var ao=OrderInfo.getProdSpecId(al);var ar="";if(CONST.getAppDesc()==0){if(M(al)){ar=prod.uim.getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID)}else{ar=prod.uim.getMktResCd(ao)}if(ec.util.isObj(ar)){}else{return}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(prod.changeUim.is4GProdInst){am.onlyLTE="1"}}}var aq={prodId:al,isWireBusi:"",isWireUIM:false,wireType:0,uimCode:aj.couponInstanceNumber,uimName:""};if(aq.isWireUIM){if(ao==CONST.PROD_SPEC.CDMA){aq.isWireBusi=1}}else{if(ao==CONST.PROD_SPEC.DATA_CARD){aq.isWireBusi=2}}OrderInfo.clearCheckUimData(al);OrderInfo.checkUimData.push(aq);var ap=aj.couponNum;if(ap==undefined||ap==null){ap=1}var ai={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:aj.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:ap,storeId:aj.storeId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:aj.terminalCode,terminalCode:aj.terminalCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:al,offerId:ak,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){ai.cardTypeFlag=aj.cardTypeFlag}$("#uim_check_btn_"+al).attr("disabled",true);$("#uim_check_btn_"+al).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+al).attr("disabled",false);$("#uim_release_btn_"+al).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+al).attr("disabled",true);if(M(al)){$("#isMIFI_"+al).val("yes")}else{$("#isMIFI_"+al).val("no")}OrderInfo.clearProdUim(al);OrderInfo.boProd2Tds.push(ai);if(OrderInfo.actionFlag==22&&aj.cardTypeFlag==1&&order.prodModify.choosedProdInfo.productId!="280000000"){AttachOffer.queryCardAttachOffer(aj.cardTypeFlag)}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(aq.isWireUIM&&aq.wireType=="02"&&ao==CONST.PROD_SPEC.DATA_CARD){AttachOffer.addOpenServList(al,CONST.PROD_SPEC_ID.WIRE_GLOBAL,"天翼宽带-国际及港澳台数据漫游","N");var an=$("#li_"+al+"_"+CONST.PROD_SPEC_ID.WIRE_GLOBAL);if(an.length>0){an.find("dd").removeClass("delete").addClass("mustchoose").attr("onclick","")}}}};var M=function(am){var al=(Math.abs(am)-1);if(AttachOffer.openServList.length>al){var ak=AttachOffer.openServList[al].servSpecList;for(var aj=0;aj<ak.length;aj++){var ai=ak[aj];if(ai.isdel!="Y"&&ai.isdel!="C"){if(ai.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true}}}}return false};var ab=function(al,ak){var aj=$("input[id^=terminalText_"+al+"]");var ai=0;aj.each(function(){var am=$.trim(this.value);if(ec.util.isObj(am)&&ak==am){ai++}});if(ai>=2){$.alert("信息提示","终端串码重复了，请填写不同的串码。");return true}return false};var m=function(ap,au,aw){var aq;var at=CacheData.getOfferBySpecId(ap,au);if(ec.util.isObj(at)){aq=at}else{aq=q(ap,au)}var ai=ap+"_"+aq.offerSpecId;var an=aq.agreementInfos[0].maxNum;var aj=aq.agreementInfos[0].minNum;var ao=$("#ul_"+ai);var ar=$("#ul_"+ai+" li");var al=ar.length-1;var am=0;if(ec.util.isArray(aq.extAttrParams)){$.each(aq.extAttrParams,function(){if(this.attrId==CONST.OFFER_FAST_FILL){am=1;return false}})}if(aw==0){if(AttachOffer.totalNums>=an){$.alert("信息提示","终端数已经达到最大，不能再添加了。");return}var av=$('<li><label>终端校验：</label><input id="terminalText_'+ai+"_"+(al/2+1)+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><input id="terminalBtn_'+ai+"_"+(al/2+1)+'" type="button" flag="'+am+'" num="'+(al/2+1)+'" prodId="'+ap+'" offerSpecId="'+aq.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" value="校验" class="purchase" style="float:left"></input></li>');
var ak=$('<li id="terminalDesc_'+(al/2+1)+'" style="white-space:nowrap;"><label></label><label id="terminalName_'+(al/2+1)+'"></label></li>');ao.append(av).append(ak);AttachOffer.totalNums++}else{if(aj==(al/2)){$.alert("信息提示","终端数已经达到最小，不能再删除了。");return}ar.each(function(ax){if(al-1==ax){$(this).remove()}else{if(al==ax){_filterAttach2Coupons(ap,au,(ax/2));$(this).remove()}}});AttachOffer.totalNums--}};var H=function(al,am,aj){for(var ak=0;ak<OrderInfo.attach2Coupons.length;ak++){var ai=OrderInfo.attach2Coupons[ak];if(am==ai.attachSepcId&&al==ai.prodId&&ai.num==aj){OrderInfo.attach2Coupons.splice(ak,1);$("#terminalName_"+aj).html("");break}}};var y=function(ak){var aj=contextPath+"/mktRes/terminal/checkTerminal";$.ecOverlay("<strong>终端校验中,请稍后....</strong>");var ai=$.callServiceAsJson(aj,ak);$.unecOverlay();if(ai.code==-2){$.alertM(ai.data)}else{if(ai.data&&ai.data.code==0){return ai.data}else{if(ai.data.code==1){$.alert("提示",ai.data.message)}else{$.alert("提示","<br/>校验失败，请稍后重试！")}}}};var B=function(ar,am,ao,az){if(az==undefined){az=0}H(ar,am,ao);var aj=ar+"_"+am;var ax=[];var aB=[];$("#"+aj+"  option").each(function(){ax.push($(this).val())});$("#group_"+aj+"  option").each(function(){aB.push($(this).val())});var au=ax.join("|");var at=aB.join("|");if((au==undefined||$.trim(au)=="")&&(at==undefined||$.trim(at)=="")){$.alert("信息提示","终端规格不能为空！");return}var ak=$("#terminalText_"+aj+"_"+ao).val();if(ak==undefined||$.trim(ak)==""){$.alert("信息提示","终端串码不能为空！");return}if(ab(aj,ak)){return}var al={instCode:ak,flag:az,mktResId:au};var aC=query.prod.checkTerminal(al);if(aC==undefined){return}var ai="";for(var aA=0;aA<AttachOffer.openList.length;aA++){var aq=AttachOffer.openList[aA];for(var ay=0;ay<aq.specList.length;ay++){var an=aq.specList[ay];if(an.isdel!="Y"&&an.isdel!="C"&&ec.util.isArray(an.agreementInfos)){if(an.agreementInfos[0].activtyType==2){ai="2"}}}}if(aC.statusCd==CONST.MKTRES_STATUS.USABLE||(aC.statusCd==CONST.MKTRES_STATUS.HAVESALE&&ai=="2")){var aw=0;var av="";if(ec.util.isArray(aC.mktAttrList)){$.each(aC.mktAttrList,function(){if(this.attrId=="65010058"){aw=this.attrValue}else{if(this.attrId=="60010004"){av=this.attrValue}}})}$("#terminalDesc_"+ao).css("display","block");var ap={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:aC.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:aC.mktResStoreId,storeName:"1",agentId:1,apCharge:aw,couponInstanceNumber:aC.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:ar,offerId:-1,attachSepcId:am,state:"ADD",relaSeq:"",num:ao};if(aC.statusCd==CONST.MKTRES_STATUS.HAVESALE&&ai=="2"){ap.couponSource="2"}if(CONST.getAppDesc()==0){ap.termTypeFlag=aC.termTypeFlag}OrderInfo.attach2Coupons.push(ap)}else{if(aC.statusCd==CONST.MKTRES_STATUS.HAVESALE){$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}else{}}};var c=function(ak){$("#is3GCheckbox").off().change(function(){order.prodModify.getChooseProdInfo()});$("#phoneNumListtbody tr").filter(".plan_select").children(":first-child").html("");$("#phoneNumListtbody tr").filter(".plan_select").removeClass("plan_select").next("#plan2ndTr").hide();$(ak).addClass("plan_select").next("#plan2ndTr").show();var ai="<i class='select'></i>";$(ak).children(":first-child").html(ai);$(ak).next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();OrderInfo.busitypeflag=2;$("#custInfo").hide();OrderInfo.actionFlag=2;if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!query.offer.setOffer()){return}}$("#custInfo").hide();var am;var al=order.prodModify.choosedProdInfo;var aj=order.prodModify.choosedProdInfo.is3G;if(aj=="Y"){am=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,specId:CONST.PROD_SPEC.CDMA},{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,specId:CONST.PROD_SPEC.CDMA}]}else{am=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,instId:al.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:al.prodInstId},{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,instId:al.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:al.prodInstId}]}if(!rule.rule.ruleCheck(am)){return}if(OrderInfo.reloadFlag=="N"){order.uiCustes.buyService(OrderInfo.offid,"")}else{order.service.buyService(OrderInfo.offid,"")}};return{openServ:z,fromProvFlag:X,orderInfo:aa,custQuery:ad,queryCallBack:af,btnQueryCustProd:Z,showCustAuth:b,showPackageDialog:_showPackageDialog,closeServSub:Q,getOfferList:x,openServSpecSub:h,getDealerTypeSub:L,excludeAddattch:s,paserOfferData:i,servExDepReByRoleObjs:N,checkOfferExcludeDependSub:D,setServ2OfferSpecSub:w,setSpec:q,addOfferSpecSub:f,addAttachDealerSub:o,queryOfferInst:j,getOffer:ac,delOfferSub:r,showOffer:U,initOrderProvAttr:K,fillOfferChange:ag,buildMainView:p,offerChangeView:T,opeSer:F,buyService:l,btnQueryCustProd:Z,checkUim:k,linkQueryOffer:c}})();CommonUtils.regNamespace("uiOfferQuery");uiOfferQuery=(function(){var z=function(F,E){F.areaId=OrderInfo.cust.areaId;var D=contextPath+"/offer/queryOfferSpec";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,F,{before:function(){$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>")},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data.offerSpec)}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");var C=$.callServiceAsJsonGet(D,F);$.unecOverlay();if(C.code==0){if(C.data){return C.data.offerSpec}}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}};var t=function(F,E){var D=contextPath+"/offer/queryOfferInst";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,F,{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data)}else{order.uiCust.showPackageDialog("查询销售品实例失败,稍后重试!")}}}})}else{$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");var C=$.callServiceAsJsonGet(D,F);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data)}else{order.uiCust.showPackageDialog("查询销售品实例失败,稍后重试!")}}}};var u=function(){var C=order.prodModify.choosedProdInfo;var G={offerId:C.prodOfferInstId,offerSpecId:C.prodOfferId,acctNbr:C.accNbr,areaId:C.areaId,distributorId:""};var F=t(G);if(F&&F.code==CONST.CODE.SUCC_CODE){var D=true;if(ec.util.isArray(F.offerMemberInfos)){CacheData.sortOffer(F);for(var E=0;E<F.offerMemberInfos.length;E++){var H=F.offerMemberInfos[E];if(H.objType==""){$.alert("提示","销售品实例构成 "+H.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(H.objType==CONST.OBJ_TYPE.PROD){if(H.accessNumber==""){$.alert("提示","销售品实例构成 "+H.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(H.objInstId==C.prodInstId){D=false}}if(D){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+C.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=F.offerMemberInfos;OrderInfo.offer.offerId=C.prodOfferInstId;OrderInfo.offer.offerSpecId=C.prodOfferId;OrderInfo.offer.offerSpecName=C.prodOfferName;return true}else{$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");return false}}};var k=function(F,E){var D=contextPath+"/offer/queryOfferParam";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,F,{before:function(){$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}})}else{$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,F);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}};var v=function(F,E){i(F);F.isServiceOpen="Y";var D=contextPath+"/token/pc/offer/queryAttachOfferSub";if(OrderInfo.actionFlag==22){D=contextPath+"/offer/queryAttachOffer2"}if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍候....</strong>")},always:function(){$.unecOverlay()
},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍候...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}};var a=function(E){i(E);var D=contextPath+"/offer/queryOpenedAttachAndServ";$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(E)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var B=function(F,E){i(F);var D=contextPath+"/offer/queryChangeAttachOffer";if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(G){$.unecOverlay();if(G.code==0){if(G.data){E(G.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品实例失败,稍后重试");return}}};var w=function(F,E){i(F);var D=contextPath+"/offer/queryAttachSpec";if(typeof(E)=="function"){$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(G){if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var q=function(F,E){i(F);var D=contextPath+"/offer/queryCanBuyAttachSpec";if(typeof(E)=="function"){$.callServiceAsJsonGet(D,{strParam:JSON.stringify(F)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(G){if(G.code==0){if(G.data){E(G.data)}}else{if(G.code==-2){$.alertM(G.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(F)});$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var f=function(E){i(E);var D=contextPath+"/offer/queryDefaultAndRequiredOfferSpec";$.ecOverlay("<strong>查询默认必须可选包中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){OrderInfo.isSuccess="Y";if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var c=function(E){i(E);var D=contextPath+"/offer/queryDefaultAndRequiredOfferSpecAndServ";$.ecOverlay("<strong>查询默认必须可选包和功能产品中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){OrderInfo.isSuccess="Y";if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","可订购可选包和功能产品失败,稍后重试");return}}};var m=function(E){i(E);var D=contextPath+"/offer/queryServSpec";$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var j=function(E){i(E);var D=contextPath+"/offer/queryExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(E)});$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var h=function(E){i(E);var D=contextPath+"/offer/queryServExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var C=$.callServiceAsJsonGet(D,{strParam:JSON.stringify(E)});$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var n=function(E){i(E);var D=contextPath+"/offer/searchAttachOfferSpec";$.ecOverlay("<strong>附属销售品查询中，请稍等...</strong>");var C=$.callServiceAsHtmlGet(D,{strParam:encodeURI(JSON.stringify(E),"utf-8")});$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","查询附属销售失败，请稍后重试！")}}};var g=function(E){var D=contextPath+"/order/checkOperate";$.ecOverlay("<strong>受理权限查询中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,"");$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","受理权限查询失败，请稍后重试！")}}};var A=function(E){var D=contextPath+"/order/orderSubmit";if(OrderInfo.order.token!=""){D=contextPath+"/order/orderSubmit?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var C=$.callServiceAsHtml(D,E);$.unecOverlay();if(!C||C.code!=0){return}return C.data};var s=function(E){var D=contextPath+"/order/orderSubmitComplete";if(OrderInfo.order.token!=""){D=contextPath+"/order/orderSubmitComplete?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(!C||C.code!=0){return}return C.data};var y=function(D){var C=query.offer.queryOfferSpec(D);if(C==undefined){return false}if(C.offerRoles==undefined){$.alert("错误提示","销售品规格构成查询: 返回的销售品规格构成结构不对！");return false}if(C.offerSpecId==undefined||C.offerSpecId==""){$.alert("错误提示","销售品规格构成查询: 销售品规格ID未返回，无法继续受理！");return false}if(C.offerRoles.length==0){$.alert("错误提示","销售品规格构成查询: 成员角色为空，无法继续受理！");return false}if(C.feeType==undefined||C.feeType==""||C.feeType=="null"){$.alert("错误提示","无付费类型，无法新装！");return false}C=SoOrder.sortOfferSpec(C);if(OrderInfo.actionFlag==6&&ec.util.isArray(OrderInfo.oldprodInstInfos)){OrderInfo.oldofferSpec.push({offerSpec:C,accNbr:D.accNbr})}else{OrderInfo.offerSpec=C}return C};var r=function(F,I){var H={offerSpecId:I,partyId:OrderInfo.cust.custId,offerTypeCd:2};if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){H.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}if(OrderInfo.actionFlag==3){H.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId}if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==F){H.mainOfferSpecId=this.offerSpecId;return false}})}}var G=query.offer.queryOfferSpec(H);if(G==undefined||G.offerRoles==undefined){$.alert("提示","返回的销售品规格构成结构不对！");return false}if(G.offerSpecId==undefined||G.offerSpecId==""){$.alert("提示","销售品规格ID未返回，继续受理将出现异常！");return false}if(G.offerSpecName==undefined||G.offerSpecName==""){$.alert("提示","销售品规格名称未返回，继续受理将出现异常！");return false}var D=[];var E=OrderInfo.getProdSpecId(F);var C=false;$.each(G.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objId==E){C=true;return false}});if(C){D.push(this);return false}});G.offerRoles=D;return G};var p=function(E){var D=contextPath+"/order/prodModify/updateCheckByChange";$.ecOverlay("<strong>正在预校验中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(C.code==0){return C.data}else{if(C.code==-2){$.alertM(C.data)}else{if(C.data.resultMsg){$.alert("提示","预校验失败!失败原因为："+C.data.resultMsg)}else{$.alert("提示","预校验失败! 集团营业后台未给出原因。")}}}};var o=function(){if(OrderInfo.order.soNbr==null||OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}if(CONST.getAppDesc()!=0){return true}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){return true}if(order.prodModify==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var C=order.prodModify.choosedProdInfo;if(C==undefined||C.prodInstId==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var G={areaId:OrderInfo.getProdAreaId(C.prodInstId),acctNbr:C.accNbr,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,instId:C.prodInstId,type:"2"};
var F=OrderInfo.provinceInfo.mergeFlag;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){var D=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.accessNumber==C.accNbr){D=false;return false}});if(D){if(F!=null&&F!=""&&F!="undefined"&&F=="1"){G.data.push({accessNbr:C.accNbr,instId:C.prodInstId});return query.offer.invokeLoadInstSub(G)}else{return query.offer.invokeLoadInst(G)}}else{var E=true;if(F!=null&&F!=""&&F!="undefined"&&F=="1"){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){G.data.push({accessNbr:this.accessNumber,instId:this.objInstId})}});if(G!=null){if(!query.offer.invokeLoadInstSub(G)){E=false;return false}}}else{$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){G.acctNbr=this.accessNumber;G.instId=this.objInstId;if(!query.offer.invokeLoadInst(G)){E=false;return false}}})}return E}}else{if(F!=null&&F!=""&&F!="undefined"&&F=="1"){G.data.push({accessNbr:C.accNbr,instId:C.prodInstId});return query.offer.invokeLoadInstSub(G)}else{return query.offer.invokeLoadInst(G)}}};var i=function(D){D.staffId=OrderInfo.staff.staffId;D.channelId=OrderInfo.staff.channelId;D.areaId=OrderInfo.getProdAreaId(D.prodId);D.partyId=OrderInfo.cust.custId;D.distributorId=OrderInfo.staff.distributorId;if(OrderInfo.actionFlag==3){D.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId}else{if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==D.prodId){D.mainOfferSpecId=this.offerSpecId;return false}})}}else{D.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}}if(ec.util.isObj(OrderInfo.order.soNbr)){D.soNbr=OrderInfo.order.soNbr}if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){D.yslflag=order.ysl.yslbean.yslflag}}if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var C=0;C<OrderInfo.oldprodInstInfos.length;C++){if(D.acctNbr==OrderInfo.oldprodInstInfos[C].accNbr){D.areaId=OrderInfo.oldprodInstInfos[C].areaId;D.partyId=OrderInfo.oldprodInstInfos[C].custId;D.mainOfferSpecId=OrderInfo.oldprodInstInfos[C].mainProdOfferInstInfos[0].prodOfferId}}}};var l=function(E){order.prepare.createorderlonger();var D=contextPath+"/offer/loadInst";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var C=$.callServiceAsJsonGet(D,E);$.unecOverlay();if(C.code==0){return true}else{if(C.code==-2){$.alertM(C.data);return false}else{if(C.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",C.msg)}return false}}};var x=function(E){var D=contextPath+"/cust/offerorderprod";$.ecOverlay("<strong>查询产品信息中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var b=function(E){var D=contextPath+"/order/prodInstParam";$.ecOverlay("<strong>查询产品实例属性中，请稍等...</strong>");var C=$.callServiceAsJson(D,E);$.unecOverlay();if(C.code==0){if(C.data){return C.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};return{checkOperate:g,loadInst:o,invokeLoadInst:l,setOffer:u,searchAttachOfferSpec:n,queryOfferSpec:z,queryServSpec:m,queryOfferInst:t,queryOfferParam:k,queryAttachOfferHtml:v,queryChangeAttachOffer:B,queryCanBuyAttachSpec:q,queryExcludeDepend:j,queryServExcludeDepend:h,queryAttachSpec:w,queryMainOfferSpec:y,queryAttachOfferSpec:r,queryDefMustOfferSpec:f,queryDefMustOfferSpecAndServ:c,orderSubmit:A,orderSubmitComplete:s,updateCheckByChange:p,queryProduct:x,queryOpenedAttachAndServ:a,queryProdInstParam:b}})();$(function(){$("#bill_list").delegate("ul.main_list_ul","click",function(a){a.preventDefault();ec.agent.page.pageNewLoad($(this).attr("url"));a.stopPropagation()})});$(function(){$("#main_list").delegate("ul.main_list_ul","click",function(a){a.preventDefault();ec.agent.page.pageNewLoad($(this).attr("url"));a.stopPropagation()})});$(function(){$("#main_list").delegate("ul.main_list_ul","click",function(a){a.preventDefault();ec.agent.page.pageNewLoad($(this).attr("url"));a.stopPropagation()})});CommonUtils.regNamespace("main","home");$(function(){});main.home=(function(){var _tabManager={};var _getSelectedTabItem=function(){var tabId=this.tabManager.getSelectedTabItemID();return $(".l-tab-content-item[tabid="+tabId+"]")};var _getSelectedTabName=function(){return $("li.l-selected a").text()};var _addTab=function(tabid,text,url){this.tabManager.addTabItem({tabid:tabid,text:text,url:url});$("#"+tabid).css("min-height","550px");$("#"+tabid).css("height","550px");$(".allsort").removeClass("showme");$("#updateNews").css("margin-left","80px");$("#new").css("margin-left","100px").css("width","90%");$(".homecon").css("width","100%").css("margin-left","0px")};var _backTab=function(funName){var tabItem=main.getSelectedTabItem();$("iframe:last",tabItem).removeAttr("src");$("iframe:first",tabItem).show();if(funName!==undefined){var tabId=this.tabManager.getSelectedTabItemID();var dom=$("#"+tabId).get(0);dom.contentWindow.window.eval(funName)}};var _loadTab=function(url){var tabItem=main.getSelectedTabItem();var iframeloading=$(".l-tab-loading:first",tabItem);var iframe=$("iframe:last",tabItem);$("iframe:first",tabItem).hide();iframe.show();iframeloading.show();iframe.attr("src",url).unbind("load.tab").bind("load.tab",function(){iframeloading.hide()})};var _queryNotice=function(bulletinId){var param="";if(typeof(bulletinId)!="undefined"){param={bulletinId:bulletinId}}$.callServiceAsHtmlGet(contextPath+"/main/notice",param,{done:function(response){if(typeof(bulletinId)!="undefined"){$(".detail").html(response.data);_createNoticeDialog();return}if(!response){response={};response.data='<li><a href="#" class="ft">暂无公告</a></li>'}$(".news").html(response.data);var _hasClass=$(".allsort").hasClass("showme");if(_hasClass){$("#updateNews").css("margin-left","190px");$("#new").css("margin-left","200px").css("width","82%")}var intervalTime=$("#intervalTime").val();if(intervalTime==""){intervalTime=3000}},fail:function(response){$.unecOverlay()}})};var _createNoticeDialog=function(){easyDialog.open({container:"ec-dialog-form-container-notice-items"});document.getElementById("ec-dialog-form-container-notice-items").setAttribute("style","margin-top:40px;display: block;");$("#noticeItemsConCancel").click(function(){easyDialog.close()})};var _queryMainShortcut=function(){$.callServiceAsHtmlGet(contextPath+"/menu/mainshortcut",{done:function(response){$("#faster_ul").html(response.data).show()},fail:function(response){$.unecOverlay()}})};var _hideMainIco=function(){$(".allsort").removeClass("showme");$(".main_quick_div").css("display","none");$("#updateNews").css("margin-left","80px");$("#new").css("margin-left","100px").css("width","90%");$(".homecon").css("width","100%").css("margin-left","0px");$("#div_main_index").removeClass("main_index").addClass("main_div")};var _createDialog=function(){var _hasClass=$(".allsort").hasClass("showme");if(_hasClass){$(".allsort").removeClass("showme")}easyDialog.open({container:"q_menu_dialog"});main.home.getMyList();main.home.getLv1();$("#q_menuclose").off("click").on("click",function(event){easyDialog.close();if(_hasClass){$(".allsort").addClass("showme")}main.home.queryMainShortcut()})};var _getMyList=function(){var param={setShortcut:1};$.callServiceAsHtmlGet(contextPath+"/menu/mainshortcut",param,{always:function(){$.unecOverlay()},done:function(response){$("#shortcut_getmylist").html(response.data).show()},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var _getLv1=function(){var url=contextPath+"/menu/inquireLv1";$.callServiceAsHtmlGet(url,{done:function(response){$("#parentslist").html(response.data).show();$("#first_level a:first").addClass("side_nav_hover");var parentId=$("#first_level").find("a[class=side_nav_hover]").attr("id");main.home.getLv2(parentId)}})};var _changeParent=function(parentId){$("#first_level").find("a[class=side_nav_hover]").removeClass();$("#first_level").find("a[id="+parentId+"]").addClass("side_nav_hover");
main.home.getLv2(parentId)};var _getLv2=function(parentId){var url=contextPath+"/menu/inquireLv2";var param={parentId:parentId};$.callServiceAsHtmlGet(url,param,{before:function(){$.ecOverlay("<strong>菜单查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(response){if(response.data==""){$("#son_list").html("<font style='color:#FA3D03;'>您没有权限添加此菜单</font>").show()}else{$("#son_list").html(response.data).show();$("#shortcut_getmylist").find("li").each(function(){var menuId=$(this).attr("id");var menu$=$("#second_level").find("ul[id="+menuId+"]");if(menu$&&menu$.length>0){menu$.addClass("ul_sel").removeAttr("onclick").css("cursor","auto").find("a.close").show()}})}}})};var _getLv3=function(grandParentId,parentId){var url=contextPath+"/menu/inquireLv3";var param={grandParentId:grandParentId,parentId:parentId};$.callServiceAsHtmlGet(url,param,{before:function(){$.ecOverlay("<strong>菜单查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(response){if(response.data==""){$("#son_list").html("<font style='color:#FA3D03;'>您没有权限添加此菜单</font>").show()}else{$("#son_list").html(response.data).show();$("#shortcut_getmylist").find("li").each(function(){var menuId=$(this).attr("id");var menu$=$("#son_list").find("ul[id="+menuId+"]");if(menu$&&menu$.length>0){menu$.addClass("ul_sel").removeAttr("onclick").css("cursor","auto").find("a.close").show()}})}}})};var _addShortcut=function(resourceId,isDrag){var ul$=$("#son_list").find("ul[id="+resourceId+"]");var dispOrder=1;var shortcutList$=$("#shortcut_getmylist");if(!isDrag){var lis=$("#shortcut_getmylist ul li");var lastEle$=shortcutList$.find("li:last");if(lis.length>=8){$.alert("提示","最多允许添加8个图标,请取消已选图标后再添加！");return}if(lastEle$.length>0){dispOrder=lastEle$.attr("disporder")/1+1}else{dispOrder=1}}else{dispOrder=$("#shortcut_getmylist").find("#"+resourceId).index()+1}var url=contextPath+"/menu/setShortcut";var param={dispOrder:dispOrder,resourceId:resourceId,actionType:"ADD"};$.callServiceAsJson(url,param,{before:function(){$.ecOverlay("添加中...")},always:function(){$.unecOverlay()},done:function(response){if(response.code==0){if(!isDrag){ul$.addClass("ul_sel").removeAttr("onclick").css("cursor","auto").find("a.close").show();var dragAdd$=changeQuickLi(ul$.clone());var darg$=shortcutList$.find("ul").append(dragAdd$.html()).find("#"+dragAdd$.attr("id")).attr("disporder",dispOrder)}}else{if(response.code==-2){$.alertM(response.data)}}},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};function changeQuickLi(ulEle$){ulEle$.find("a").remove();ulEle$.find("div").removeClass("ul_list_img").addClass("quick_top_ul_img");ulEle$.find("li").attr("id",ulEle$.attr("id")).attr("onclick","main.home.deleteShortcut("+ulEle$.attr("id")+")");return ulEle$}var _deleteShortcut=function(resourceId,isDrag){var url=contextPath+"/menu/setShortcut";var param={resourceId:resourceId,actionType:"DEL"};$.callServiceAsJson(url,param,{before:function(){$.ecOverlay("删除中...")},always:function(){$.unecOverlay()},done:function(response){if(response.code==0){var ulEle$=$("#son_list").find("#"+resourceId);if(ulEle$&&ulEle$.length>0){ulEle$.removeClass("ul_sel").attr("onclick","main.home.addShortcut("+resourceId+")").css("cursor","pointer").find("a.close").hide()}if(!isDrag){}$("#shortcut_getmylist ul").find("li[id="+resourceId+"]").remove()}else{if(response.code==-2){$.alertM(response.data)}}},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};function _gotoPrepare(id){$("#mktResTypeCd").val($("#"+id).attr("mktResTypeCd"));$("#mktResCd").val($("#"+id).attr("mktResCd"));$("#mktResId").val($("#"+id).attr("mktResId"));$("#brand").val($("#"+id).attr("brand"));$("#phoneType").val($("#"+id).attr("phoneType"));$("#phoneColor").val($("#"+id).attr("phoneColor"));$("#mktName").val($("#"+id).attr("mktName"));$("#mktPrice").val($("#"+id).attr("mktPrice"));$("#mktPicA").val($("#"+id).attr("mktPicA"));$("#oprepare_form").submit()}function _gotoPrepare2(id){$("#prodOfferId").val(id);$("#oprepare_form2").submit()}var _refreshValidateCodeImg=function(){$("#vali_code_input").val("");$("#validatecodeImg").css({width:"80px",height:"32px"}).attr("src",contextPath+"/validatecode/codeimg.jpg?"+Math.floor(Math.random()*100)).fadeIn()};var _closeVerificationcode=function(){var code=$("#vali_code_input").val().toUpperCase();$.callServiceAsJson(contextPath+"/main/checkVerificationcode?validatecode="+code,{},{before:function(){$.ecOverlay("<strong>验证验证码中,请稍等会儿....</strong>")},done:function(response){if(response.code!=0){$("#vali_code_input").val("");$("#validatecodeImg").css({width:"80px",height:"32px"}).attr("src",contextPath+"/validatecode/codeimg.jpg?"+Math.floor(Math.random()*100)).fadeIn();$.alert("失败","<br>验证码不正确","error")}else{if(response.code==0){easyDialog.close()}}},always:function(){$.unecOverlay()},fail:function(response){$.alert("提示","请求可能发生异常，请稍候")}})};return{tabManager:_tabManager,queryNotice:_queryNotice,queryMainShortcut:_queryMainShortcut,getMyList:_getMyList,getLv1:_getLv1,getLv2:_getLv2,getLv3:_getLv3,createDialog:_createDialog,addShortcut:_addShortcut,deleteShortcut:_deleteShortcut,changeParent:_changeParent,gotoPrepare:_gotoPrepare,gotoPrepare2:_gotoPrepare2,hideMainIco:_hideMainIco,refreshValidateCodeImg:_refreshValidateCodeImg,closeVerificationcode:_closeVerificationcode,getSelectedTabItem:_getSelectedTabItem,getSelectedTabName:_getSelectedTabName,addTab:_addTab,backTab:_backTab,loadTab:_loadTab}})();CommonUtils.regNamespace("order","phoneNumber");var phoneNum_level="";var selectedObj=null;var _queryFlag="0";order.phoneNumber=(function(){var f={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",areaCode:"",memberRoleCd:"",preStore:"",minCharge:""};var B=function(){f={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",areaCode:"",memberRoleCd:"",preStore:"",minCharge:""}};var j=0;var D="";var u=[];var i=contextPath+"/mktRes/phonenumber/list";var c="";var r=function(H){selectedObj=null;H=k(H);H.isReserveFlag=_queryFlag;if(_queryFlag=="1"){H.queryFlag="3"}$.callServiceAsHtml(i,H,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(I){if(I.data.indexOf("showVerificationcode")>=0){$("#vali_code_input").val("");$("#validatecodeImg").css({width:"80px",height:"32px"}).attr("src",contextPath+"/validatecode/codeimg.jpg?"+Math.floor(Math.random()*100)).fadeIn();easyDialog.open({container:"Verificationcode_div"})}if(!I||I.code!=0){I.data="查询失败,稍后重试"}var J=$("#order_phonenumber .phone_warp");J.html(I.data);$("#btnSwitchNbr").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber({})})},fail:function(I){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var p=function(K){var I=contextPath+"/token/pc/mktRes/phone/numberlist";var J={areaId:OrderInfo.getAreaId(),phoneNumber:K.phoneNum};var H=$.callServiceAsJson(I,J);if(H&&H.code==0){if(H.data){return H.data}}else{if(H.code==-2){$.alertM(H.data)}else{$.alert("提示","查询号码信息失败,稍后重试")}}};var b=function(){var H=$.trim($("#idCode").val());if(H==""){$.alert("提示","请先输入身份证号码!");return}if(!a(H)){$.alert("提示","身份证号码输入有误!");return}var J=$("#p_cust_areaId").val();var I={identityId:H,areaId:J};$.callServiceAsHtmlGet(contextPath+"/mktRes/phonenumber/listByIdentity",I,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(K){if(!K||K.code!=0){K.data="查询失败,稍后重试"}var L=$("#order_phonenumber .phone_warp");L.html(K.data)},fail:function(K){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var h=function(V){c=$(V).attr("numberVal");var W=CONST.MEMBER_ROLE_CD.MAIN_CARD;var R=$("#subFlag").val();if(R=="Y2"){W=CONST.MEMBER_ROLE_CD.VICE_CARD}var O=$("#subnum").val();var ac=$("#subPage").val();var J=c.split("_")[1];var N=c.split("_")[2];if(order.service.offerprice!=""){var ae=parseInt(N);var T=parseInt(order.service.offerprice);if(T<ae){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return
}}var Q=c.split("_")[0];var ad=c.split("_")[3];var aa=D;if(D==""){aa=c.split("_")[5]}var af=c.split("_")[5];var X=c.split("_")[6];var Y=$("#p_cust_areaId").val();if(Y==null||Y==""){Y=OrderInfo.staff.areaId}var H=$(V).attr("zoneNumber");if(H==null||H==""){H=OrderInfo.staff.areaCode}if(Q){var K=false;var I="";var U="";if(ac=="terminal"||ac=="number"){I=f.accessNumber;U=f.anTypeCd}else{if(ac=="offer"){for(var Z=0;Z<OrderInfo.boProdAns.length;Z++){if(OrderInfo.boProdAns[Z].prodId==O){I=OrderInfo.boProdAns[Z].accessNumber;U=OrderInfo.boProdAns[Z].anTypeCd;break}}for(var Z=0;Z<OrderInfo.boProdAns.length;Z++){if(OrderInfo.boProdAns[Z].prodId!=O){if(OrderInfo.boProdAns[Z].accessNumber==Q){$.alert("提示","你已经选择了该号码,请选择其它号码!");return}}}}}if(I!=""){K=true;for(var Z=0;Z<u.length;Z++){if(u[Z]==I){K=false;break}}if(K){var M=contextPath+"/mktRes/phonenumber/purchase";var ab={oldPhoneNumber:I,oldAnTypeCd:U};$.callServiceAsJson(M,ab,{})}}u.push(Q);if(ac=="number"){var S=$("#order_fill_content");S.html("");f.accessNumber=Q;f.anTypeCd=ad;f.level=aa;f.org_level=af;f.anId=X;f.areaId=Y;f.areaCode=H;f.memberRoleCd=W;f.idFlag=0;f.preStore=J;f.minCharge=N;order.service.boProdAn=f;t()}else{if(ac=="terminal"){mktRes.terminal.setNumber(Q,aa);f.accessNumber=Q;f.anTypeCd=ad;f.level=aa;f.org_level=af;f.anId=X;f.areaId=Y;f.areaCode=H;f.memberRoleCd=W;f.idFlag=0;f.preStore=J;f.minCharge=N;order.service.boProdAn=f;if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){order.phoneNumber.dialogForm.close(order.phoneNumber.dialog)}}else{if(ac=="offer"){f.anTypeCd=ad;f.anId=X;f.accessNumber=Q;f.level=aa;f.org_level=af;f.areaId=Y;f.areaCode=H;f.preStore=J;f.minCharge=N;$("#nbr_btn_"+O).removeClass("selectBoxTwo");$("#nbr_btn_"+O).addClass("selectBoxTwoOn");$("#nbr_btn_"+O).html(Q+"<u></u>");$("#choosedNumSpan").val(Q);var L=false;if(OrderInfo.boProdAns.length>0){for(var Z=0;Z<OrderInfo.boProdAns.length;Z++){if(OrderInfo.boProdAns[Z].prodId==O){OrderInfo.boProdAns[Z].accessNumber=Q;OrderInfo.boProdAns[Z].anTypeCd=ad;OrderInfo.boProdAns[Z].pnLevelId=aa;OrderInfo.boProdAns[Z].anId=X;OrderInfo.boProdAns[Z].areaId=Y;OrderInfo.boProdAns[Z].areaCode=H;OrderInfo.boProdAns[Z].memberRoleCd=W;OrderInfo.boProdAns[Z].idFlag=0;OrderInfo.boProdAns[Z].preStore=J;OrderInfo.boProdAns[Z].minCharge=N;L=true;OrderInfo.setProdAn(OrderInfo.boProdAns[Z]);order.dealer.changeAccNbr(O,Q);break}}}if(!L){var P={prodId:O,accessNumber:Q,anChooseTypeCd:"2",anId:X,anTypeCd:ad,pnLevelId:aa,state:"ADD",areaId:Y,areaCode:H,memberRoleCd:W,idFlag:0,preStore:J,minCharge:N};OrderInfo.boProdAns.push(P)}if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){order.phoneNumber.dialogForm.close(order.phoneNumber.dialog)}if(O=="-1"){OrderInfo.boCustInfos.telNumber=Q}}}}}else{$.alert("提示","号码格式不正确!")}};var s=function(H){if(f.accessNumber!=""){$("#nbr_btn_"+H).removeClass("selectBoxTwo");$("#nbr_btn_"+H).addClass("selectBoxTwoOn");$("#nbr_btn_"+H).html(f.accessNumber+"<u></u>");order.dealer.changeAccNbr(H,f.accessNumber);var I=false;if(OrderInfo.boProdAns.length>0){for(var J=0;J<OrderInfo.boProdAns.length;J++){if(OrderInfo.boProdAns[J].prodId==H){OrderInfo.boProdAns[J].accessNumber=f.accessNumber;OrderInfo.boProdAns[J].anTypeCd=f.anTypeCd;OrderInfo.boProdAns[J].anId=f.anId;OrderInfo.boProdAns[J].pnLevelId=f.level;OrderInfo.boProdAns[J].areaId=f.areaId;OrderInfo.boProdAns[J].memberRoleCd=f.memberRoleCd;OrderInfo.boProdAns[J].preStore=f.preStore;OrderInfo.boProdAns[J].minCharge=f.minCharge;if(f.idFlag){OrderInfo.boProdAns[J].idFlag=f.idFlag}OrderInfo.setProdAn(OrderInfo.boProdAns[J]);order.dealer.changeAccNbr(H,phoneNumber);I=true;break}}}if(!I){var K={prodId:H,accessNumber:f.accessNumber,anChooseTypeCd:"2",anId:f.anId,pnLevelId:f.level,anTypeCd:f.anTypeCd,state:"ADD",areaId:f.areaId,areaCode:f.areaCode,memberRoleCd:f.memberRoleCd,preStore:f.preStore,minCharge:f.minCharge};if(f.idFlag){K.idFlag=f.idFlag}OrderInfo.boProdAns.push(K)}if(H=="-1"){OrderInfo.boCustInfos.telNumber=f.accessNumber}}};var t=function(){var H={numsubflag:"number"};$.callServiceAsHtmlGet(contextPath+"/order/prodoffer/prepare",H,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(I){if(!I||I.code!=0){I.data="查询失败,稍后重试"}var J=$("#order_tab_panel_content");J.html(I.data);order.service.initSpec();order.prodOffer.init();order.service.searchPack()},fail:function(I){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var x=function(S,X){c=$(S).attr("numberVal");var T=CONST.MEMBER_ROLE_CD.MAIN_CARD;var P=$("#subFlag").val();if(P=="Y2"){T=CONST.MEMBER_ROLE_CD.VICE_CARD}var N=$("#subnum").val();var Z=$("#subPage").val();var K=c.split("_")[1];var M=c.split("_")[2];var U=$("#p_cust_areaId").val();if(U==null||U==""){U=OrderInfo.staff.areaId}var H=$(S).attr("zoneNumber");if(H==null||H==""){H=OrderInfo.staff.areaCode}if(order.service.offerprice!=""){var ac=parseInt(M);var Q=parseInt(order.service.offerprice);if(Q<ac){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var O=c.split("_")[0];var ab=c.split("_")[3];var W=c.split("_")[5];if(O){var Y=$("#p_cust_areaId").val();var aa={};if(X){aa={phoneNumber:O,actionType:"E",anTypeCd:ab,areaId:Y,attrList:[{attrId:"65010036",attrValue:X}]}}else{aa={phoneNumber:O,actionType:"E",anTypeCd:ab,areaId:Y}}var J=false;var I="";var R="";if(Z=="terminal"||Z=="number"){I=f.accessNumber;R=f.anTypeCd;if(I==O){$.alert("提示","号码已经被预占,请选择其它号码!");return}else{f={}}}else{if(Z=="offer"){for(var V=0;V<OrderInfo.boProdAns.length;V++){if(OrderInfo.boProdAns[V].prodId==N){I=OrderInfo.boProdAns[V].accessNumber;R=OrderInfo.boProdAns[V].anTypeCd;break}}for(var V=0;V<OrderInfo.boProdAns.length;V++){if(OrderInfo.boProdAns[V].accessNumber==O){$.alert("提示","号码已经被预占,请选择其它号码!");return}}}}if(I&&I!=""){J=true;for(var V=0;V<u.length;V++){if(u[V]==I){J=false;break}}if(J){if(X){aa={newPhoneNumber:O,oldPhoneNumber:I,newAnTypeCd:ab,oldAnTypeCd:R,areaId:Y,attrList:[{attrId:"65010036",attrValue:X}]}}else{aa={newPhoneNumber:O,oldPhoneNumber:I,newAnTypeCd:ab,oldAnTypeCd:R,areaId:Y}}}}var L=contextPath+"/mktRes/phonenumber/purchase";$.callServiceAsJson(L,aa,{before:function(){$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(ad){if(ad.code==0){if(D==""){D=ad.data.phoneLevelId}if(Z=="number"){var ag=$("#order_fill_content");ag.html("");f.accessNumber=O;f.anTypeCd=ab;f.level=D;f.org_level=ad.data.phoneLevelId;f.anId=ad.data.phoneNumId;f.areaId=U;f.areaCode=H;f.memberRoleCd=T;f.preStore=K;f.minCharge=M;order.service.boProdAn=f;t()}else{if(Z=="terminal"){mktRes.terminal.setNumber(O,ad.data.phoneLevelId);f.accessNumber=O;f.anTypeCd=ab;f.level=D;f.org_level=ad.data.phoneLevelId;f.anId=ad.data.phoneNumId;f.areaId=U;f.areaCode=H;f.memberRoleCd=T;f.preStore=K;f.minCharge=M;order.service.boProdAn=f;if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){order.phoneNumber.dialogForm.close(order.phoneNumber.dialog)}}else{if(Z=="offer"){$("#nbr_btn_"+N).removeClass("selectBoxTwo");$("#nbr_btn_"+N).addClass("selectBoxTwoOn");$("#nbr_btn_"+N).html(O+"<u></u>");$("#choosedNumSpan").val(O);f.accessNumber=O;f.level=D;f.org_level=ad.data.phoneLevelId;f.areaId=U;f.anTypeCd=ab;f.anId=ad.data.phoneNumId;f.preStore=K;f.minCharge=M;var ae=false;if(OrderInfo.boProdAns.length>0){for(var af=0;af<OrderInfo.boProdAns.length;af++){if(OrderInfo.boProdAns[af].prodId==N){OrderInfo.boProdAns[af].accessNumber=O;OrderInfo.boProdAns[af].anTypeCd=ab;OrderInfo.boProdAns[af].pnLevelId=D;OrderInfo.boProdAns[af].anId=ad.data.phoneNumId;OrderInfo.boProdAns[af].areaId=U;OrderInfo.boProdAns[af].areaCode=H;OrderInfo.boProdAns[af].memberRoleCd=T;OrderInfo.boProdAns[af].preStore=K;OrderInfo.boProdAns[af].minCharge=M;ae=true;if(OrderInfo.offerSpec.offerRoles!=undefined){OrderInfo.setProdAn(OrderInfo.boProdAns[af])}order.dealer.changeAccNbr(N,O);break}}}if(!ae){var ai={prodId:N,accessNumber:O,anChooseTypeCd:"2",anId:ad.data.phoneNumId,pnLevelId:D,anTypeCd:ab,state:"ADD",areaId:U,areaCode:H,memberRoleCd:T,preStore:K,minCharge:M};
OrderInfo.boProdAns.push(ai);if(OrderInfo.offerSpec.offerRoles!=undefined){OrderInfo.setProdAn(ai)}order.dealer.changeAccNbr(N,O)}if(N=="-1"){OrderInfo.boCustInfos.telNumber=O}if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){order.phoneNumber.dialogForm.close(order.phoneNumber.dialog)}}}}}else{if(ad.code==-2){$.alertM(ad.data)}else{var ah="";if(ad.data!=undefined&&ad.data.msg!=undefined){ah=ad.data.msg}else{ah="号码["+O+"]预占失败"}$.alert("提示","号码预占失败，可能原因:"+ah)}}},fail:function(ad){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})}else{$.alert("提示","号码格式不正确!")}};var y=function(I,H){g(I,H);r()};var k=function(J){var K=$('input:radio[name="query_flag_01"]:checked').val();var P="";if(OrderInfo.cust==undefined||OrderInfo.cust.custId==undefined||OrderInfo.cust.custId==""){P=$("#p_cust_areaId").val()}else{P=OrderInfo.getAreaId()}var Q=$("#pnHead").find("a.selected").attr("val");var I=$("#pncharacteristic").find("a.selected").attr("val");var R=$.trim($("#pnEnd").val());if(I!=null&&I!=""){R=I}else{if(R=="最后四位"){R=""}}var S=$.trim($("#phoneNum").val());if(S=="任意四位"){S=""}var M="";var N="";var H="";var L=$("#preStore").find("a.selected");if(L.length>0){N=L.attr("Greater");H=L.attr("Less")}var O=$("#nbrPool option:selected").val();if($("#pnCharacterId_basic").css("display")!="none"){M=$("#pnCharacterId_basic a.selected").attr("val")}if($("#pnCharacterId_all").css("display")!="none"){M=$("#pnCharacterId_all a.selected").attr("val")}M=ec.util.defaultStr(M);return{pnHead:Q,pnEnd:R,goodNumFlag:M,maxPrePrice:H,minPrePrice:N,pnLevelId:"",pageSize:"15",phoneNum:S,areaId:P,poolId:O,queryFlag:K}};var g=function(I,H){$(I).each(function(){$(this).removeClass("selected")});$(H).addClass("selected")};var G=function(H){var I={pageIndex:H};order.phoneNumber.btnQueryPhoneNumber(I)};var a=function(L){L=L.toUpperCase();if(!(/(^\d{15}$)|(^\d{17}([0-9]|X)$)/.test(L))){return false}var M,R;M=L.length;if(M==15){R=new RegExp(/^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/);var Q=L.match(R);var J=new Date("19"+Q[2]+"/"+Q[3]+"/"+Q[4]);var I;I=(J.getYear()==Number(Q[2]))&&((J.getMonth()+1)==Number(Q[3]))&&(J.getDate()==Number(Q[4]));if(!I){return false}else{var O=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var P=new Array("1","0","X","9","8","7","6","5","4","3","2");var N=0,K;L=L.substr(0,6)+"19"+L.substr(6,L.length-6);for(K=0;K<17;K++){N+=L.substr(K,1)*O[K]}L+=P[N%11];return L}}if(M==18){R=new RegExp(/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/);var Q=L.match(R);var J=new Date(Q[2]+"/"+Q[3]+"/"+Q[4]);var I;I=(J.getFullYear()==Number(Q[2]))&&((J.getMonth()+1)==Number(Q[3]))&&(J.getDate()==Number(Q[4]));if(!I){return false}else{var H;var O=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var P=new Array("1","0","X","9","8","7","6","5","4","3","2");var N=0,K;for(K=0;K<17;K++){N+=L.substr(K,1)*O[K]}H=P[N%11];if(H!=L.substr(17,1)){return false}return L}}return false};var v=function(){order.area.chooseAreaTree("order/prepare","p_phone_areaId_val","p_phone_areaId",3)};var m=function(){var H=contextPath+"/mktRes/phonenumber/prepare";var I={};$.callServiceAsHtmlGet(H,I,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(J){if(!J){J.data="选号页面加载异常,稍后重试"}if(J.code!=0){$.alert("提示","查询失败,稍后重试");return}var K=$("#order_tab_panel_content");K.html(J.data);f={accessNumber:"",level:"",anId:"",anTypeCd:""};l()}})};var l=function(){if(CONST.getAppDesc()==1){$("#psw_dt").hide();$("#psw_dd").hide()}selectedObj=null;j=0;D="";order.phoneNumber.queryApConfig();z();q();var H={};order.phoneNumber.btnQueryPhoneNumber(H);$("#btnNumSearch").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber(H)});$("#btnNumExistSearch").off("click").on("click",function(I){order.phoneNumber.btnIBydentityQuery(H);I.stopPropagation()})};var w=function(){var I={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var H=contextPath+"/order/queryApConf";$.callServiceAsJsonGet(H,I,{done:E})};var E=function(I){var R;var O;var S;var J='<a href="javascript:void(0);" class="selected" Greater="" Less="">不限</a>';var Y='<a href="javascript:void(0);" class="selected" val="">不限</a>';var N='<a href="javascript:void(0);" class="selected " val="">不限</a>';var P='<a href="javascript:void(0);" class="selected " val="">不限</a>';if(I.data){var L=I.data.length;for(var X=0;X<L;X++){if(I.data[X].PHONE_NUMBER_PRESTORE){R=I.data[X].PHONE_NUMBER_PRESTORE;for(var V=0;V<R.length;V++){var Q=R[V].COLUMN_VALUE_NAME.replace(/\"/g,"");var W;var U;var M=Q.split("-");if(M.length!=1){W=M[0];U=M[1]}else{M=M.toString();W=M.substring(0,M.length-2);U='""'}Q=Q.replace(/\"/g,"");J=J+'<a href="javascript:void(0);" Greater='+W+" Less="+U+">"+Q+"</a>"}$("#preStore").html(J);continue}}for(var X=0;X<L;X++){if(I.data[X].PHONE_NUMBER_SEGMENT){O=I.data[X].PHONE_NUMBER_SEGMENT;for(var V=0;V<O.length;V++){var K=O[V].COLUMN_VALUE_NAME;K=K.replace(/\"/g,"");Y=Y+'<a href="javascript:void(0);" val='+K+">"+K+"</a>"}$("#pnHead").html(Y);continue}}for(var X=0;X<L;X++){if(I.data[X].PHONE_NUMBER_FEATURE){S=I.data[X].PHONE_NUMBER_FEATURE;var aa;if(S.length<=9){aa=S.length}else{aa=9}for(var V=0;V<aa;V++){var Z=(S[V].COLUMN_VALUE_NAME).replace(/\"/g,"");var H=(S[V].COLUMN_VALUE).replace(/\"/g,"");N=N+'<a href="javascript:void(0);" val='+H+">"+Z+"</a>"}if(S.length>9){for(var T=0;T<S.length;T++){var Z=(S[T].COLUMN_VALUE_NAME).replace(/\"/g,"");var H=(S[T].COLUMN_VALUE).replace(/\"/g,"");P=P+'<a href="javascript:void(0);" val='+H+">"+Z+"</a>"}$("#pnCharacterId_more").show();$("#pnCharacterId_more").off("click").on("click",function(ab){A();ab.stopPropagation()})}$("#pnCharacterId_basic").html(N);$("#pnCharacterId_all").html(P);continue}}}$("#pnCharacterId_basic a").each(function(){$(this).off("click").on("click",function(ab){order.phoneNumber.linkQueryPhoneNumber("#pnCharacterId_basic a",this);ab.stopPropagation()})});$("#pnCharacterId_all a").each(function(){$(this).off("click").on("click",function(ab){order.phoneNumber.linkQueryPhoneNumber("#pnCharacterId_all a",this);ab.stopPropagation()})});$("#pnHead a").each(function(){$(this).off("click");$(this).on("click",function(ab){order.phoneNumber.linkQueryPhoneNumber("#pnHead a",this);ab.stopPropagation()})});$("#preStore a").each(function(){$(this).off("click");$(this).on("click",function(ab){order.phoneNumber.linkQueryPhoneNumber("#preStore a",this);ab.stopPropagation()})})};var A=function(){if($("#pnCharacterId_basic").is(":hidden")){$("#pnCharacterId_basic").css("display","");$("#pnCharacterId_all").css("display","none");$("#pnCharacterId_all").parent("dl").css("overflow","inherit")}else{$("#pnCharacterId_basic").css("display","none");$("#pnCharacterId_all").css("display","");$("#pnCharacterId_all").parent("dl").css("overflow","hidden")}};var z=function(){var J=contextPath+"/mktRes/phonenumber/queryPhoneNbrPool";var M={};var H=$.callServiceAsJson(J,M);if(H.code==0){if(H.data){var I=H.data.phoneNbrPoolList;var L=$('<select id="nbrPool" style="width:200px;"></select>');var K=$('<option value="" selected="selected">请选择号池</option>');L.append(K);if(I!=null){$.each(I,function(){var N=$('<option value="'+this.poolId+'">'+this.poolName+"</option>");L.append(N)})}$("#nbrPool").append(L)}}else{if(H.code==-2){$.alertM(H.data)}else{$.alert("提示","号池加载失败，请稍后再试！")}}};var q=function(L){var I=contextPath+"/mktRes/phonenumber/queryPnLevelProdOffer";var K="";K=OrderInfo.cust.areaId;K=K.substring(0,3)+"0000";var J={areaId:K};var H=$.callServiceAsJson(I,J)};var n=function(){if(selectedObj==undefined||selectedObj==null){$.alert("提示","请先选择号码！");return}var I=$(selectedObj).attr("numberVal");var L=I.split("_")[5];var J=I.split("_")[0];var K=$("#p_cust_areaId").val();if(K==null||K==""){K=OrderInfo.staff.areaId}var H=contextPath+"/mktRes/qryPhoneNbrLevelInfoList";$.ligerDialog.open({width:560,height:350,allowClose:false,title:"设置号码等级（"+J+"）",url:H+"?pnLevelId="+D+"&areaId="+K+"&org_level="+L,buttons:[{text:"确定",onclick:function(N,M){var O=phoneNum_level.split("_");M.close();
$(".select_nbr_li").each(function(){if($(this).hasClass("select")){var Q=$(this).attr("numberval").split("_");var P;if(phoneNum_level!=undefined&&phoneNum_level!=""&&Q[5]!=O[0]){P="<span style='float:left;margin-left:10px;'>预存<span class='orange'>"+Q[1]+"</span>元<br/>保底<span class='orange'>"+Q[2]+"</span>元</span><span style='float:right;margin-right:10px;'>预存<span class='orange'>"+O[1]+"</span>元<br/>保底<span class='orange'>"+O[2]+"</span>元</span><span style='width: 15px; display: table; height: 30px; padding-top: 10px;'><img  src='"+contextPath+"/image/common/levelArrow.png'></span>"}else{P="<span style='padding-left:10px;'>预存<span class='orange'>"+Q[1]+"</span>元</span> <span style='padding-left:10px;'> 保底<span class='orange'>"+Q[2]+"</span>元</span>"}$(this).find("div").html(P)}});D=O[0]}},{text:"关闭",onclick:function(N,M){M.close()}}]})};var F=function(){if(selectedObj==undefined||selectedObj==null){$.alert("提示","请先选择号码！");return}if(j==1){h(selectedObj)}else{var H=$(selectedObj).attr("numberVal").split("_")[7];if(H=="1"){easyDialog.open({container:"password_dialog"})}else{x(selectedObj)}}$("#uim_check_btn_"+prodId).attr("disabled",false);$("#uim_check_btn_"+prodId).removeClass("disablepurchase").addClass("purchase");$("#uim_release_btn_"+prodId).attr("disabled",true);$("#uim_release_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");$("#uim_txt_"+prodId).attr("disabled",false);$("#uim_txt_"+prodId).val("")};var o=function(J,I){if(selectedObj==J){return}j=I;selectedObj=J;var H=$(selectedObj).attr("numberVal");D=H.split("_")[5];$(J).siblings().each(function(){$(this).removeClass("select");var L=$(this).attr("numberval").split("_");var K="<span style='padding-left:10px;'>预存<span class='orange'>"+L[1]+"</span>元</span> <span style='padding-left:10px;'> 月保底<span class='orange'>"+L[2]+"</span>元</span>";$(this).find("div").html(K)});$(J).addClass("select")};var C=function(){var H=$("#pree_password_text").val();if($.trim(H)==""){$.alert("提示","预占密码不能为空！")}else{easyDialog.close();$("#pree_password_text").val("");x(selectedObj,H)}};return{qryPhoneNbrLevelInfoList:n,selectNum:o,endSelectNum:F,btnQueryPhoneNumber:r,linkQueryPhoneNumber:y,getIndexPagePhoneNumber:G,queryApConfig:w,initPhonenumber:l,boProdAn:f,resetBoProdAn:B,btnIBydentityQuery:b,initOffer:s,initPage:m,chooseArea:v,preePassword:C,queryPhoneNbrPool:z,queryFlag:_queryFlag,queryPnLevelProdOffer:q,queryPhoneNumber:p}})();CommonUtils.regNamespace("mktRes","terminal");mktRes.terminal=(function(i){var z="";var E=12;var A={};var n={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"cfsj",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false};_initBuyChk=function(){n={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"cfsj",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false}};var v=function(){if("lj"==n.buyType){OrderInfo.actionFlag=13;i("#treaty").hide();i("#sel_number").hide();i("#lj").addClass("selectBoxTwoOn").removeClass("selectBoxTwo");i("#hy").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");if(n.tsnFlag){i("#purchaseTermA").removeClass("btna_g").addClass("btna_o")}i("#dealerMktDiv").show()}else{if("hy"==n.buyType){OrderInfo.actionFlag=14;i("#treaty").show();i("#sel_number").show();i("#lj").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");i("#hy").addClass("selectBoxTwoOn").removeClass("selectBoxTwo");if(n.numFlag&&n.hyFlag&&n.tsnFlag){i("#purchaseTermA").removeClass("btna_g").addClass("btna_o")}else{i("#purchaseTermA").removeClass("btna_o").addClass("btna_g")}if(n.hyFlag){if(n.hyType=="cfsj"){i("#cfsjA").addClass("selectBoxTwoOn").removeClass("selectBoxTwo")}else{i("#gjsfA").addClass("selectBoxTwoOn").removeClass("selectBoxTwo")}}else{i("#cfsjA,#gjsfA").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");i("#choosedOfferPlan").html("")}if(n.numFlag){i("#cNumA").addClass("selectBoxTwoOn").removeClass("selectBoxTwo")}else{i("#cNumA").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");i("#choosedNumSpan").html("")}i("#dealerMktDiv").hide()}}};var b=function(H,G){i("#choosedNumSpan").html(H);n.numFlag=true;n.numLevel=G;v()};var p=function(){};var t=function(H){var G=contextPath+"/mktRes/terminal/list";var I=k(H);i.callServiceAsHtml(G,I,{before:function(){i.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){i.unecOverlay()},done:function(J){if(J.code!=0){i.alert("提示","<br/>查询失败,稍后重试");return}var K=i("#order_term_list");K.show();K.html(J.data).fadeIn()}})};var g=function(H,G){f(H,G);t(1)};var k=function(N){var H="";var P="";var O=i("#priceArea a[class='selected']");var L=O.attr("minPrice");var I=O.attr("maxPrice");var J=i("#commCond").val();if(i("#termManf_small").css("display")!="none"){H=i("#termManf_small a[class='selected']").attr("val")}var K="";if(i("#contractFlag_small").css("display")!="none"){K=i("#contractFlag_small a[class='selected']").attr("val")}if(i("#termManf_all").css("display")!="none"){H=i("#termManf_all a[class='selected']").attr("val")}H=ec.util.defaultStr(H);if(i("#phoneType_small").css("display")!="none"){P=i("#phoneType_small a[class='selected']").attr("val")}if(i("#phoneType_all").css("display")!="none"){P=i("#phoneType_all a[class='selected']").attr("val")}P=ec.util.defaultStr(P);L=ec.util.defaultStr(L);I=ec.util.defaultStr(I);J=ec.util.defaultStr(J);if(L!=""){L=parseInt(L)*100}if(I!=""){I=parseInt(I)*100}var G=[];if(H!=""&&H!="无限"){var M={attrId:CONST.TERMINAL_SPEC_ATTR_ID.BRAND,attrValue:H};G.push(M)}if(P!=""&&P!="无限"){var M={attrId:CONST.TERMINAL_SPEC_ATTR_ID.PHONE_TYPE,attrValue:P};G.push(M)}return{mktResCd:"",mktResName:J,mktResType:"",minPrice:L,maxPrice:I,contractFlag:K,pageInfo:{pageIndex:N,pageSize:E},attrList:G}};var f=function(H,G){i(H).removeClass("selected");i(G).addClass("selected")};var C=function(K,I,J,G){i("#commCond").val(G);i("#commCond").off("keydown").on("keydown",function(M){var L=document.all?window.event:M;if(L.keyCode==13){i("#btn_term_search").click()}});var H=false;i("#termManf_small a").each(function(){if(i(this).attr("val")==K){i(this).addClass("selected");H=true}else{i(this).removeClass("selected")}});if(!H){i("#termManf_all a").each(function(){if(i(this).attr("val")==K){i(this).addClass("selected")}else{i(this).removeClass("selected")}})}i("#priceArea a").removeClass("selected");i("#priceArea a[minPrice='"+I+"'][maxPrice='"+J+"']").addClass("selected")};var F=function(G){var L=G.data.length;var Q;var I;var V;var O='<a href="javascript:void(0);" class="selected " val="">不限</a>';var P='<a href="javascript:void(0);" class="selected " val="">不限</a>';var M='<a href="javascript:void(0);" class="selected" minPrice="" maxPrice="">不限</a>';var J='<a href="javascript:void(0);" class="selected " val="">不限</a>';var N='<a href="javascript:void(0);" class="selected " val="">不限</a>';for(var X=0;X<L;X++){if(G.data[X].PHONE_BRAND){Q=G.data[X].PHONE_BRAND;var K;if(Q.length<=6){K=Q.length}else{K=6}for(var W=0;W<K;W++){var U=(Q[W].COLUMN_VALUE_NAME).replace(/\"/g,"");O=O+'<a href="javascript:void(0);" val='+U+">"+U+"</a>"}if(Q.length>6){for(var S=0;S<Q.length;S++){var U=(Q[S].COLUMN_VALUE_NAME).replace(/\"/g,"");P=P+'<a href="javascript:void(0);" val='+U+">"+U+"</a>"}i("#termManfId_more").show();i("#termManfId_more").off("click").on("click",function(Z){B("#termManf_all","#termManf_small");Z.stopPropagation()});i("#termManfId_more").toggle(function(){i("#termManfId_more a").addClass("btn_less");i("#termManfId_more a").text("收起")},function(){i("#termManfId_more a").removeClass("btn_less");i("#termManfId_more a").text("展开")})}i("#termManf_small").html(O);i("#termManf_all").html(P);continue}}for(var X=0;X<L;X++){if(G.data[X].PHONE_PRICE_AREA){I=G.data[X].PHONE_PRICE_AREA;for(var W=0;W<I.length;W++){var H=(I[W].COLUMN_VALUE_NAME).replace(/\"/g,"");var R=H.split("-");if(R.length!=1){minPrice=R[0];maxPrice=R[1]}else{R=R.toString();minPrice=R.substring(0,R.length-2);maxPrice='""'}M=M+'<a href="javascript:void(0);" minPrice='+minPrice+" maxPrice="+maxPrice+">"+H+"</a>"
}i("#priceArea").html(M);continue}}for(var X=0;X<L;X++){if(G.data[X].PHONE_TYPE){V=G.data[X].PHONE_TYPE;var T;if(V.length<=6){T=V.length}else{T=6}for(var W=0;W<T;W++){var Y=(V[W].COLUMN_VALUE_NAME).replace(/\"/g,"");J=J+'<a href="javascript:void(0);" val='+Y+">"+Y+"</a>"}if(V.length>6){for(var S=0;S<V.length;S++){var Y=(V[S].COLUMN_VALUE_NAME).replace(/\"/g,"");N=N+'<a href="javascript:void(0);" val='+Y+">"+Y+"</a>"}i("#phoneTypeId_more").show();i("#phoneTypeId_more").off("click").on("click",function(Z){B("#phoneType_all","#phoneType_small");Z.stopPropagation()})}i("#phoneType_small").html(J);i("#phoneType_all").html(N);continue}}i("#btn_term_search").off("click").on("click",function(Z){t(1);Z.stopPropagation()});i("#termManf_small a[val!='更多']").off("click").on("click",function(Z){g("#termManf_small a[val!='更多']",this)});i("#termManf_all a[val!='更多']").off("click").on("click",function(Z){g("#termManf_all a[val!='更多']",this)});i("#priceArea a").off("click").on("click",function(Z){g("#priceArea a",this)});i("#contractFlag_small a").off("click").on("click",function(Z){g("#contractFlag_small a",this)});i("#phoneType_small a[val!='更多']").off("click").on("click",function(Z){g("#phoneType_small a[val!='更多']",this)});i("#phoneType_all a[val!='更多']").off("click").on("click",function(Z){g("#phoneType_all a[val!='更多']",this)})};var w=function(){var H={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var G=contextPath+"/order/queryApConf";i.callServiceAsJsonGet(G,H,{done:F})};var B=function(H,G){if(i(H).is(":hidden")){i(H).css("display","");i(G).css("display","none");i(G).parent("dl").css("overflow","auto")}else{i(H).css("display","none");i(G).css("display","");i(G).parent("dl").css("overflow","hidden")}};var o=function(H){var I={mktResTypeCd:i(H).attr("mktResTypeCd"),mktResCd:i(H).attr("mktResCd"),mktResId:i(H).attr("mktResId"),brand:i(H).attr("brand"),phoneType:i(H).attr("phoneType"),phoneColor:i(H).attr("phoneColor"),mktName:i(H).attr("mktName"),mktPrice:i(H).attr("mktPrice"),mktLjPrice:i(H).attr("mktLjPrice"),mktPicA:i(H).attr("mktPicA")};if(CONST.getAppDesc()==0){I.mktSpecCode=i(H).attr("mktSpecCode");I.pageInfo={pageIndex:1,pageSize:20};I.attrList=[];I.is4G="yes"}var G=contextPath+"/mktRes/terminal/detail";i.callServiceAsHtml(G,I,{before:function(){i.ecOverlay("<strong>在处理中,请稍等会儿....</strong>")},always:function(){i.unecOverlay()},done:function(K){if(!K){i.alert("提示","<br/>处理失败，请稍后重试！");return}if(K.code!=0){i.alert("提示","<br/>处理失败，请稍后重试！");return}var J=i("#order_term_detail");i("#order_tab_panel_terminal .order_tab_header").hide();i("#order_term_list").hide();J.show();J.html(K.data).fadeIn();_initBuyChk();i("#hy").click(function(){_initBuyChk();n.buyType="hy";m();v()});i("#lj").click(function(){_initBuyChk();n.buyType="lj";m();v();i("#tsn_hid").val("");i("#tsn").val("");A={}});i("#cNumA").click(function(){var L=OrderInfo.cust.custId;if(OrderInfo.cust==undefined||L==undefined||L==""){i.alert("提示","在选号码之前请先进行客户定位或者新建客户！");return}v();order.prepare.phoneNumDialog("terminal","Y1","01")});i("#cfsjA").click(function(){s(1)});i("#gjsfA").click(function(){s(2)});i("#chkTsnA").click(function(){x("tsn")});i("#purchaseTermA").click(function(){l()});i("#lj").click();OrderInfo.actionFlag=13;order.dealer.initDealer()}})};var r=function(K){i("a[name^='selectBox']").each(function(P){i(this).addClass("selectBoxTwo").removeClass("selectBoxTwoOn")});i(K).addClass("selectBoxTwoOn").removeClass("selectBoxTwo");var O=i(K).attr("p_pic");var G=i(K).attr("mktResName");var L=i(K).attr("mktSalePrice");var M=i(K).attr("mktNormalSalePrice");var N=i(K).attr("mktResId");var H=i(K).attr("mktResTypeCd");var J=i(K).attr("mktSpecCode");if(n.buyType=="hy"){i("#mkt_saleprice_id").html(M/100+" 元")}else{if(n.buyType=="lj"){i("#mkt_saleprice_id").html(L/100+" 元")}}i("#term_pic_id").attr("src",O);i("#mkt_resname_id").html(G);i("#mktResId").val(N);i("#mktResName").val(G);i("#mktLjPrice").val(L);i("#price").val(M);i("#mktResType").val(H);i("#mktSpecCode").val(J);var I=n.buyType;_initBuyChk();n.buyType=I;v();i("#tsn_hid").val("");i("#tsn").val("");A={}};var m=function(){selectColor$=i("a[name='selectBox'][class='selectNumbel selectBoxTwoOn']");if(n.buyType=="hy"){var G=selectColor$.attr("mktNormalSalePrice");i("#mkt_saleprice_id").html(G/100+" 元");i("#mktLjPrice").val(G)}else{if(n.buyType=="lj"){var H=selectColor$.attr("mktSalePrice");i("#mkt_saleprice_id").html(H/100+" 元");i("#mktLjPrice").val(H)}}};var s=function(G){i("#choosedOfferPlan").html("");n.hyFlag=false;if(G==1){n.hyType="cfsj";i("#tsn_hid").val("");i("#tsn").val("");A={}}else{n.hyType="gjsf"}v();if(!n.numFlag){i.alert("提示","请先选号！");return}ec.form.dialog.createDialog({id:"-gjhy",width:980,height:550,initCallBack:function(K,I){var J={mktResCd:i("#mktResId").val(),agreementType:G};var H=contextPath+"/mktRes/terminal/mktplan";i.callServiceAsHtmlGet(H,J,{before:function(){},always:function(){},done:function(L){mktRes.terminal.dialogForm=K;mktRes.terminal.dialog=I;if(!L){i.alert("提示","<br/>处理失败，请稍后重试！");return}if(L.code!=0){if(L.code==1006){i.alert("提示","<br/>查询不到，请稍后重试")}else{i.alert("提示","<br/>查询失败，请稍后重试")}if(mktRes.terminal.dialogForm!=undefined&&mktRes.terminal.dialog!=undefined){mktRes.terminal.dialogForm.close(mktRes.terminal.dialog)}return}i("#gjhyContent").html(L.data);i("#tab_content_0").show();i("#contract_nav_agreement li").off("click").on("click",function(M){h(this,i(this).attr("itemIndex"))});i("#phone_warp_id .contract_tab_content tr:gt(0)").off("click").on("click",function(M){u(this)});i("#hy_nav_confirm_a").off("click").on("click",function(M){q()})}})},submitCallBack:function(I,H){n.hyFlag=true},closeCallBack:function(J,H){v();var I=i("#gjhyContent");I.html("")}})};var h=function(G,H){if(i(G).hasClass("current")){return}i("#contract_nav_agreement li").removeClass("current");i("#tab_"+H).addClass("current");i(".contract_tab_content").hide();i("#tab_content_"+H).show()};var u=function(G){if(i(G).hasClass("plan_select")){i(G).removeClass("bg plan_select").next("#plan2ndTr").hide();return false}i("#phone_warp_id .contract_tab_content tr").filter(".plan_select").removeClass("bg plan_select").next("#plan2ndTr").hide();i(G).addClass("bg").addClass("plan_select");var I=i(G).attr("offerSpecId");var H=i(G).attr("agreementType");a(G,I,H)};var a=function(H,N,J){var O=i(H).next("#plan2ndTr");if(O.length>0){O.show();return}var G=order.service.queryPackForTerm(N,J,"");if(typeof(G)=="undefined"||G==null){i.alert("提示","<br/>未查到套餐，请稍后再试！");return}if(G.code==-2){i.alertM(G.data);i.unecOverlay();return}if(G.code!=0||G.data.code!="POR-0000"){i.alert("提示","<br/>未查到合适套餐，请稍后再试！");return}var M="";M+="<tr id='plan2ndTr' class='nocolor'>";M+="<td class='nopadding' colspan='7'>";M+="<div id='plan2ndDiv' class='plan_second_list cashier_tr'>";M+="  <table class='contract_list'>";M+="  <thead>";M+="    <tr>";M+="      <td class='borderLTB'>&nbsp;</td><td>套餐名称</td><td>价格</td>";M+="      <td>流量</td><td>语音分钟数</td><td>WIFI时长</td><td>点对点短信</td>";M+="      <td>点对点彩信</td><td>套餐外流量</td><td>套餐外通话分钟数</td>";M+="    </tr>";M+="  </thead>";M+="  <tbody>";var L=G.data.prodOfferInfos;if(L.length==0){i.alert("提示","<br/>未查到套餐，请稍后再试！")}for(var I=0;I<L.length;I++){var K=L[I];M+="    <tr offerSpecId='"+K.offerSpecId+"' ";M+="   offerSpecName='"+K.offerSpecName+"' ";M+="   price='"+K.price+"' >";M+="      <td></td>";M+="      <td style='width:240px;'>"+ec.util.defaultStr(K.offerSpecName)+"</td>";M+="      <td>"+ec.util.defaultStr(K.price)+"</td>";var P="";if(K.inFlux>=1024){P=K.inFlux/1024+"G"}else{P=K.inFlux+"M"}M+="      <td>"+ec.util.defaultStr(P)+"</td>";M+="      <td>"+ec.util.defaultStr(K.inVoice)+"</td>";M+="      <td>"+ec.util.defaultStr(K.inWIFI)+"</td>";M+="      <td>"+ec.util.defaultStr(K.inSMS)+"</td>";M+="      <td>"+ec.util.defaultStr(K.inMMS)+"</td>";M+="      <td style='width:140px;'>"+ec.util.defaultStr(K.outFlux)+"</td>";M+="      <td>"+ec.util.defaultStr(K.outVoice)+"</td>";M+="    </tr>"}M+="  </tbody>";M+="  </table>";M+="</div>";M+="</td>";M+="</tr>";i(H).after(M);
i("#plan2ndDiv tbody tr").off("click").on("click",function(Q){j(this);Q.stopPropagation()})};var j=function(I){i("#plan2ndDiv tbody tr").removeClass("plan_select2");i("#plan2ndDiv tbody tr").children(":first-child").html("");var J=i(I).attr("offerSpecId");var H=D(J,I);if(H){i(I).addClass("plan_select2");var G="<i class='terminalSelect'></i>";i(I).children(":first").html(G)}};var D=function(I,H){var G={price:i(H).attr("price"),id:"tcnum1",specId:I,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};order.service.opeSer(G);return true};var y=function(S,L){n.hyOfferSpecQty=0;n.hyOfferSpecFt=0;var N=i(L).data("__offerSpec");if(typeof(N)=="undefined"){var J={offerSpecId:Number(S)};var G=contextPath+"/order/queryOfferSpec";var K=i.callServiceAsJson(G,J);N=K.data.offerSpec;i(L).data("__offerSpec",N);if(typeof(K)=="undefined"||K==null){i.alert("提示","<br/>未查到销售品构成，请稍后再试！");return false}if(K.code!="0"||!K.isjson){i.alert("提示","<br/>未查到销售品构成，请稍后再试！");return false}if(K.data.code!="POR-0000"){i.alert("提示","<br/>未查到销售品构成，请稍后再试！");return false}}var I=SoOrder.sortOfferSpec(N);var O=I.offerRoles;n.hyOfferRoles=O;var M;var Q=0;var P=0;for(M=0;M<O.length;M++){var R=O[M];if(CONST.MEMBER_ROLE_CD.VICE_CARD==O[M].memberRoleCd){if(R.roleObjs){i.each(R.roleObjs,function(){if(this.objType==2){Q=this.maxQty<0?"不限制":this.maxQty;P=this.minQty<0?"0":this.minQty}})}}else{O[M].selectQty=1}}I.offerRoles=O;OrderInfo.offerSpec=I;n.hyOfferSpecFt=I.feeType;if(Q==0){return true}var H=i("#termOfferSpecViceLi");H.find("input").val(P);H.find(".addinfo").html("&nbsp;&nbsp;&nbsp;"+P+"-"+Q+"（张） ");H.find("a:first").off("click").on("click",function(U){var T=parseInt(H.find("input").val());if(T<=P){i.alert("提示","副卡数量已经达到最小值，不能再减少。");return}else{H.find("input").val(T-1)}});H.find("a:last").off("click").on("click",function(U){var T=parseInt(H.find("input").val());if(T>=Q){i.alert("提示","副卡数量已经达到最大值，不能再增加。");return}else{H.find("input").val(T+1)}});easyDialog.open({container:"termOfferSpec"});i("#termOfferSpecClose").off("click").on("click",function(T){easyDialog.close()});i("#termOfferSpecCancel").off("click").on("click",function(T){easyDialog.close()});i("#termOfferSpecConfirm").off("click").on("click",function(U){var T=H.find("input").val();n.hyOfferSpecQty=T;for(M=0;M<O.length;M++){if(CONST.MEMBER_ROLE_CD.VICE_CARD==O[M].memberRoleCd){O[M].selectQty=T}else{O[M].selectQty=1}}OrderInfo.offerSpec.offerRoles=O;easyDialog.close()});return true};var q=function(){var H=i("#plan2ndDiv tbody tr[class='plan_select2']");if(H.length!=1){i.alert("提示","请选择一个套餐！");return}var G=H.parents("#plan2ndTr").prev();if(G.length!=1){i.alert("提示","请选择一个合约！");return}mktRes.terminal.offerSpecId=G.attr("offerSpecId");n.hyFlag=true;n.hyOfferSpecId=H.attr("offerSpecId");n.hyOfferSpecName=H.attr("offerSpecName");v();i("#choosedOfferPlan").html(G.attr("offerSpecName"));if(mktRes.terminal.dialogForm!=undefined&&mktRes.terminal.dialog!=undefined){mktRes.terminal.dialogForm.close(mktRes.terminal.dialog)}};var c=function(K,N,G){var H={offerSpecId:N,prodId:K};var M=[];var L=AttachOffer.getSpecList(K);if(L!=undefined){for(var J=0;J<L.length;J++){if(L[J].offerSpecId!=N&&L[J].isdel!="Y"){M.push(L[J].offerSpecId)}}}var O=AttachOffer.getOfferList(K);if(O!=undefined){for(var J=0;J<O.length;J++){if(O[J].offerSpecId!=N&&O[J].isdel!="Y"){M.push(O[J].offerSpecId)}}}if(M.length>0){H.orderedOfferSpecIds=M}var I=i.callServiceAsJsonGet(contextPath+"/offer/queryExcludeDepend",{strParam:JSON.stringify(H)},{});if(I.code==0){AttachOffer.parseRuleData(I.data,N,K,G);return true}else{if(I.code==1){i.alert("提示","<strong>"+I.errorsList[0].msg+"("+I.errorsList[0].code+")</strong>")}else{i.alert("提示","数据查询异常，请稍后重试！")}}return false};var x=function(K){A={};n.tsnFlag=false;v();i("#tsn_hid").val("");var G=i("#"+K).val();if(G==""){return}var I={instCode:G,mktResTypeCd:i("#mktResType").val(),orderNo:""};if(CONST.getAppDesc()==0){var J=i("#mktSpecCode").val();if(i.trim(J)==""){i.alert("提示","营销资源返回的规格存货编码为空！");return}if(J.length>=22){J=J.substring(0,22)}I.mktSpecCode=J}else{I.mktResId=i("#mktResId").val()}var H=contextPath+"/mktRes/terminal/checkTerminal";i.callServiceAsJson(H,I,{before:function(){},always:function(){},done:function(L){if(L&&L.code==-2){i.alertM(L.data)}else{if(L&&L.data&&L.data.code==0){if(L.data.statusCd==CONST.MKTRES_STATUS.USABLE){i.alert("提示","<br/>此终端串号可以使用");n.tsnFlag=true;v();i("#tsn_hid").val(G);A=L.data}else{if(L.data.statusCd==CONST.MKTRES_STATUS.HAVESALE){if(n.hyType=="gjsf"){i.alert("提示","<br/>此终端串号可以使用");n.tsnFlag=true;v();i("#tsn_hid").val(G);A=L.data;A.couponSourc="2"}else{i.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}}else{i.alert("提示",L.data.message)}}}else{if(L&&L.data&&L.data.message&&L.data.code==1){i.alert("提示",L.data.message)}else{i.alert("提示","<br/>校验失败，请稍后重试！")}}}}})};var l=function(){if("lj"==n.buyType){if(!n.tsnFlag){i.alert("提示","<br/>请先校验终端串号。");return}var L=OrderInfo.staff.soAreaId;if(L.indexOf("0000")>0){i.alert("提示","仅三级和四级地区才能进行裸机购买！");return}var J=i("#mktLjPrice").val()/100;var M=[{couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:A.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:A.mktResStoreId,storeName:"1",agentId:1,apCharge:J,couponInstanceNumber:A.instCode,ruleId:"",partyId:CONST.CUST_COUPON_SALE,prodId:0,offerId:0,state:"ADD",relaSeq:""}];if(OrderInfo.cust.custId!=undefined&&OrderInfo.cust.custId!=""){M[0].partyId=OrderInfo.cust.custId}OrderInfo.actionTypeName="订购";OrderInfo.businessName=i("#mktResName").val();var I={};I.busiObj={instId:A.mktResId};I.boActionType={actionClassCd:CONST.ACTION_CLASS_CD.MKTRES_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.COUPON_SALE};I.coupons=M;var H=i("tr[name='tr_"+i("#mktResId").val()+"']");if(H!=undefined){I.dealers=[];H.each(function(){var N={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:i(this).find("select").val(),value:i(this).find("input").attr("staffid")};I.dealers.push(N)})}SoOrder.getTokenSynchronize();SoOrder.submitOrder(I);return}else{if("hy"==n.buyType){if(!n.numFlag){i.alert("提示","<br/>请先选号。");return}else{if(!n.hyFlag){i.alert("提示","<br/>请先选择合约套餐。");return}else{if(!n.tsnFlag){i.alert("提示","<br/>请先校验终端串号。");return}}}if(OrderInfo.cust.custId==undefined||OrderInfo.cust.custId==""){i.alert("提示","<br/>在订购套餐之前请先进行客户定位！");return}}else{return}}var J=i("#price").val()/100;var G={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:A.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:A.mktResStoreId,storeName:"1",agentId:1,apCharge:J,couponInstanceNumber:A.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-1,offerId:-1,attachSepcId:mktRes.terminal.offerSpecId,state:"ADD",relaSeq:"",couponSource:A.couponSourc};if(CONST.getAppDesc()==0){G.termTypeFlag=A.termTypeFlag}OrderInfo.attach2Coupons=[];OrderInfo.attach2Coupons.push(G);var K={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:OrderInfo.offerSpec,offerSpecId:n.hyOfferSpecId,offerSpecName:n.hyOfferSpecName,viceCardNum:Number(n.hyOfferSpecQty),feeType:n.hyOfferSpecFt,offerNum:1,type:2,actionFlag:OrderInfo.actionFlag,terminalInfo:{terminalName:i("#mktResName").val(),terminalCode:i("#tsn_hid").val()},offerRoles:n.hyOfferRoles};OrderInfo.actionTypeName="订购";SoOrder.builder();order.main.buildMainView(K)};return{init:p,btnQueryTerminal:t,initInParam:C,queryApConfig:w,selectTerminal:o,setNumber:b,offerSpecId:z,selectColor:r}})(jQuery);$(function(){});CommonUtils.regNamespace("AttachOffer");AttachOffer=(function(){var _openList=[];var _openedList=[];var _openServList=[];var _openedServList=[];var _openAppList=[];var _changeList=[];var _labelList=[];var checkedReserveNbr="";var checkedReserveCode="";var checkedOfferSpec=[];var totalNums=0;var _init=function(){var prodInfo=order.prodModify.choosedProdInfo;if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=3;if(!query.offer.setOffer()){return}var boInfos=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,instId:prodInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:prodInfo.prodInstId},{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,instId:prodInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:prodInfo.prodInstId}];
if(!rule.rule.ruleCheck(boInfos)){return}var param={offerSpecId:prodInfo.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};if(ec.util.isObj(prodInfo.prodOfferId)){if(!query.offer.queryMainOfferSpec(param)){return}}else{OrderInfo.offerSpec={}}if(CONST.getAppDesc()==0){if(!prod.uim.setProdUim()){return}}AttachOffer.queryAttachOffer()};var _queryAttachOfferSpec=function(param){var data=query.offer.queryAttachSpec(param);if(data){$("#attach_"+param.prodId).html(data);_showMainRoleProd(param.prodId);var servSpecIds=[];if(AttachOffer.openServList!=null&&AttachOffer.openServList!=undefined){$.each(AttachOffer.openServList,function(){if(this.prodId==param.prodId){var servSpecList=this.servSpecList;if(servSpecList!=null&&servSpecList!=undefined){$.each(servSpecList,function(){if(this.servSpecId!=null&&this.servSpecId!=undefined){servSpecIds.push(this.servSpecId)}})}}})}if(servSpecIds.length>0){param.servSpecIds=servSpecIds;var queryData=query.offer.queryServSpecPost(param);if(queryData!=null&&queryData.resultCode==0){if(queryData.result.offerList!=null&&queryData.result.offerList!=undefined){$.each(queryData.result.offerList,function(){AttachOffer.addOpenList(param.prodId,this.offerSpecId)})}}}AttachOffer.changeLabel(param.prodId,param.prodSpecId,"");if(param.prodId==-1&&OrderInfo.actionFlag==14){AttachOffer.addOpenList(param.prodId,mktRes.terminal.offerSpecId)}}};var _showApp=function(prodId){var appList=CacheData.getOpenAppList(prodId);var content=CacheData.getAppContent(prodId,appList);$.confirm("增值业务设置： ",content[0].innerHTML,{yes:function(){$.each(appList,function(){if($("#"+prodId+"_"+this.objId).attr("checked")=="checked"){this.dfQty=1}else{this.dfQty=0}})},no:function(){}})};var getProdInst=function(prodId){for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(ec.util.isArray(offerRole.prodInsts)){for(var j=0;j<offerRole.prodInsts.length;j++){if(offerRole.prodInsts[j].prodInstId==prodId){return offerRole.prodInsts[j]}}}}};var _showMainRoleProd=function(prodId){var prodInst=getProdInst(prodId);var app={prodId:prodId,appList:[]};AttachOffer.openAppList.push(app);for(var i=0;i<OrderInfo.offerSpec.offerRoles.length;i++){var offerRole=OrderInfo.offerSpec.offerRoles[i];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(roleObj.objType==CONST.OBJ_TYPE.SERV){if(prodInst.objId==roleObj.parentProdId&&prodInst.componentTypeCd.substring(0,1)==roleObj.componentTypeCd.substring(0,1)){app.appList.push(roleObj);if(roleObj.servSpecId==undefined){roleObj.servSpecId=roleObj.objId}if(roleObj.servSpecName==undefined){roleObj.servSpecName=roleObj.objName}}}}if(app.appList.length>0){var $li=$('<li id="li_'+prodId+"_"+offerRole.offerRoleId+'"></li>');$li.append('<dd class="mustchoose" ></dd>');$li.append("<span>"+offerRole.offerRoleName+"</span>");$li.append('<dd id="can_'+prodId+"_"+offerRole.offerRoleId+'" class="gou2" onclick="AttachOffer.showApp('+prodId+');"></dd>');$("#open_app_ul_"+prodId).append($li)}}else{if(offerRole.prodInsts==undefined){continue}$.each(offerRole.prodInsts,function(){if(this.prodInstId==prodId){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldLi=$("#li_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(roleObj.dfQty==0&&spec.ifDault==1){var $span=$oldLi.find("span");$span.addClass("del");spec.isdel="Y"}}if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}if(roleObj.dfQty>0){var servSpec=jQuery.extend(true,{},roleObj);CacheData.setServSpec(prodId,servSpec);spec=servSpec;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');if(roleObj.minQty==0){$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+"')\"></dd>")}else{$li.append('<dd class="mustchoose"></dd>')}$li.append("<span>"+spec.servSpecName+"</span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$li.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');$("#open_serv_ul_"+prodId).append($li);spec.isdel="N";_showHideUim(0,prodId,servSpecId)}}}}})}}};var _showMainMemberRoleProd=function(prodId){for(var i=0;i<OrderInfo.viceOfferSpec.length;i++){var offerSpec=OrderInfo.viceOfferSpec[i];if(prodId==offerSpec.prodId){for(var j=0;j<offerSpec.offerRoles.length;j++){var offerRole=offerSpec.offerRoles[j];if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){for(var k=0;k<offerRole.roleObjs.length;k++){var roleObj=offerRole.roleObjs[k];if(roleObj.objType==CONST.OBJ_TYPE.SERV){var servSpecId=roleObj.objId;var $oldLi=$("#li_"+prodId+"_"+servSpecId);var spec=CacheData.getServSpec(prodId,servSpecId);if(spec!=undefined){if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}var serv=CacheData.getServBySpecId(prodId,servSpecId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(roleObj.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');continue}if(roleObj.dfQty>0){var servSpec=jQuery.extend(true,{},roleObj);CacheData.setServSpec(prodId,servSpec);spec=servSpec;if(ec.util.isArray(spec.prodSpecParams)){spec.ifParams="Y"}$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');if(roleObj.minQty==0){$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+spec.servSpecName+"','"+spec.ifParams+"')\"></dd>")}else{$li.append('<dd class="mustchoose"></dd>')}$li.append("<span>"+spec.servSpecName+"</span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$li.append('<dd id="jue_'+prodId+"_"+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');$("#open_serv_ul_"+prodId).append($li);spec.isdel="N";_showHideUim(0,prodId,servSpecId)}}}}}}}};var _searchAttachOfferSpec=function(prodId,offerSpecId,prodSpecId){var param={prodId:prodId,prodSpecId:prodSpecId,offerSpecIds:[offerSpecId],ifCommonUse:""};if(OrderInfo.actionFlag==2){param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){if(this.prodInstId==prodId){param.acctNbr=this.accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}});var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}for(var i=0;
i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr;$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){param.offerSpecIds.push(this.offerSpec.offerSpecId);$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){param.offerRoleId=this.offerRoleId}})}})}}}else{if(OrderInfo.actionFlag==3){var prodInfo=order.prodModify.choosedProdInfo;param.acctNbr=prodInfo.accNbr;if(!ec.util.isObj(prodInfo.prodOfferId)){prodInfo.prodOfferId=""}var offerRoleId=CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;if(offerRoleId==undefined){offerRoleId=""}param.offerRoleId=offerRoleId;param.offerSpecIds.push(prodInfo.prodOfferId)}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.viceOfferSpec,function(){var offerSpecId=this.offerSpecId;var accessNumber=this.accessnumber;if(this.prodId==prodId){$.each(this.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||this.memberRoleCd=="1"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){param.acctNbr=accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(offerSpecId);return false}})}})}})}else{if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){var oldoffer={};for(var j=0;j<OrderInfo.oldoffer.length;j++){oldoffer=OrderInfo.oldoffer[j];for(var i=0;i<OrderInfo.oldoffer[j].offerMemberInfos.length;i++){var offerMember=OrderInfo.oldoffer[j].offerMemberInfos[i];if(offerMember.objInstId==prodId){param.acctNbr=offerMember.accessNumber;$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==oldoffer.accNbr){param.offerSpecIds.push(this.offerSpec.offerSpecId);$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){param.offerRoleId=this.offerRoleId;return false}})}})}}}}else{param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}}}}}var offerSepcName=$("#search_text_"+prodId).val();if(offerSepcName.replace(/\ /g,"")==""){$.alert("提示","请输入查询条件！");return}param.offerSpecName=offerSepcName;var data=query.offer.searchAttachOfferSpec(param);if(data!=undefined){$("#attach_div_"+prodId).html(data).show()}};var _selectAttachOffer=function(prodId,offerSpecId){$("#attach_div_"+prodId).hide();_addAttOffer(prodId,offerSpecId)};var _selectServ=function(prodId,servSpecId,specName,ifParams){$("#attach_div_"+prodId).hide();_openServSpec(prodId,servSpecId,specName,ifParams)};var _closeAttachSearch=function(prodId){$("#attach_div_"+prodId).hide()};var _queryAttachOffer=function(){var prodInfo=order.prodModify.choosedProdInfo;var prodId=prodInfo.prodInstId;var param={prodId:prodId,prodSpecId:prodInfo.productId,offerSpecId:prodInfo.prodOfferId,acctNbr:prodInfo.accNbr};if(ec.util.isObj(prodInfo.prodBigClass)){param.prodBigClass=prodInfo.prodBigClass}var data=query.offer.queryAttachOfferHtml(param);SoOrder.initFillPage();$("#order_fill_content").html(data).show();var member=CacheData.getOfferMember(prodId);if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){param.queryType="1,2";param.objId=member.objId;param.objType=member.objType;param.offerRoleId=member.offerRoleId;param.memberRoleCd=member.roleCd;var data=query.offer.queryDefMustOfferSpec(param);CacheData.parseOffer(data);var data=query.offer.queryServSpec(param);CacheData.parseServ(data)}if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){var member=CacheData.getOfferMember(prodId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==member.offerRoleId&&member.objType==CONST.OBJ_TYPE.PROD){var offerRole=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(this.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>')}}});return false}})}AttachOffer.changeLabel(prodId,prodInfo.productId,"");order.dealer.initDealer()};var _delOfferSpec=function(prodId,offerSpecId,reflag){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.addOfferSpec(prodId,offerSpecId)}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);if(reflag!=undefined&&reflag=="reload"){$span.addClass("del");spec.isdel="Y";delServSpec(prodId,spec);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#terminalUl_"+prodId+"_"+offerSpecId).remove();spec.isTerminal=0}else{var content=CacheData.getOfferProdStr(prodId,spec,2);$.confirm("信息确认",content,{yes:function(){$span.addClass("del");spec.isdel="Y";delServSpec(prodId,spec);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#terminalUl_"+prodId+"_"+offerSpecId).remove();spec.isTerminal=0},no:function(){}})}}};var _delOffer=function(prodId,offerId,reflag){var $span=$("#li_"+prodId+"_"+offerId).find("span");if($span.attr("class")=="del"){AttachOffer.addOffer(prodId,offerId,$span.text())}else{var offer=CacheData.getOffer(prodId,offerId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offerId};if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){var flag=false;for(var j=0;j<OrderInfo.oldoffer.length;j++){var oldOffer=OrderInfo.oldoffer[j];for(var i=0;i<oldOffer.offerMemberInfos.length;i++){var oldOfferMember=oldOffer.offerMemberInfos[i];if(oldOfferMember.objInstId==prodId){param.acctNbr=oldOfferMember.accessNumber;flag=true;break}}if(flag){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(offer.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){param.areaId=OrderInfo.oldprodInstInfos[i].areaId}}}}}else{param.acctNbr=OrderInfo.getAccessNumber(prodId)}var data=query.offer.queryOfferInst(param);if(data==undefined){return}var offerMemberInfos=[];$.each(data.offerMemberInfos,function(){var prodInstId=this.objInstId;var flag=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==prodInstId){flag=true;return false}});if(flag){offerMemberInfos.push(this)}});offer.offerMemberInfos=data.offerMemberInfos=offerMemberInfos;offer.offerSpec=data.offerSpec}if(reflag!=undefined&&reflag=="reload"){offer.isdel="Y";$span.addClass("del");delServByOffer(prodId,offer)}else{var content="";if(offer.offerSpec!=undefined){content=CacheData.getOfferProdStr(prodId,offer,1)}else{content="退订【"+$span.text()+"】可选包"}$.confirm("信息确认",content,{yes:function(){offer.isdel="Y";$span.addClass("del");delServByOffer(prodId,offer)},no:function(){}})}}};var _closeServSpec=function(prodId,servSpecId,specName,ifParams){var $span=$("#li_"+prodId+"_"+servSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams)}else{$.confirm("信息确认","取消开通【"+$span.text()+"】功能产品",{yesdo:function(){var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}$span.addClass("del");spec.isdel="Y";_showHideUim(1,prodId,servSpecId);var serv=CacheData.getServBySpecId(prodId,servSpecId);if(ec.util.isObj(serv)){$span.addClass("del");serv.isdel="Y"}},no:function(){}})}};var _closeServ=function(prodId,servId,reflag){var serv=CacheData.getServ(prodId,servId);var $span=$("#li_"+prodId+"_"+serv.servId).find("span");if($span.attr("class")=="del"){_openServ(prodId,serv)}else{if("13409244"==serv.servSpecId){$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能")}else{var uim=OrderInfo.getProdUim(prodId);if(serv.servSpecId=="280000020"&&(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23)&&uim.cardTypeFlag=="1"){$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");return}if(reflag!=undefined&&reflag=="reload"){$span.addClass("del");serv.isdel="Y"}else{$.confirm("信息确认","关闭【"+$span.text()+"】功能产品",{yesdo:function(){$span.addClass("del");
serv.isdel="Y"},no:function(){}})}}}};var _openServSpec=function(prodId,servSpecId,specName,ifParams){$.confirm("信息确认","开通【"+specName+"】功能产品",{yesdo:function(){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams;if(servSpecId==CONST.YZFservSpecId){var feeType=$("select[name='pay_type_-1']").val();if(feeType==undefined){feeType=order.prodModify.choosedProdInfo.feeType}if(feeType==CONST.PAY_TYPE.AFTER_PAY){for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];prodSpecParam.setValue=""}}else{for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];if(prodSpecParam.value!=""){prodSpecParam.setValue=prodSpecParam.value}else{if(!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!=""){prodSpecParam.setValue=prodSpecParam.valueRange[0].value}}}}}}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDepend(prodId,servSpec)},no:function(){}})};var _openServ=function(prodId,serv){$.confirm("信息确认","取消关闭【"+serv.servSpecName+"】功能产品",{yesdo:function(){if(serv!=undefined){if(serv.servSpecId==""){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.removeClass("del");serv.isdel="N"}else{_checkServExcludeDepend(prodId,serv)}}},no:function(){}})};var _checkOfferExcludeDepend=function(prodId,offerSpec){var offerSpecId=offerSpec.offerSpecId;var param=CacheData.getExcDepOfferParam(prodId,offerSpecId);var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName)}};var _checkServExcludeDepend=function(prodId,serv,flag){var servSpecId=serv.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{var data=query.offer.queryExcludeDepend(param);if(data!=undefined){paserServData(data.result,prodId,serv)}}};var _addOfferSpec=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)},no:function(){}})};var _addOfferSpecByCheck=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);$.confirm("信息确认",content,{yes:function(){CacheData.setServ2OfferSpec(prodId,newSpec)},yesdo:function(){_checkOfferExcludeDepend(prodId,newSpec)}})};var delServSpec=function(prodId,offerSpec){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var servSpecId=this.objId;if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){var spec=CacheData.getServSpec(prodId,servSpecId);if(ec.util.isObj(spec)){spec.isdel="Y";var $li=$("#li_"+prodId+"_"+servSpecId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del");_showHideUim(1,prodId,servSpecId)}}})})};var delServByOffer=function(prodId,offer){$.each(offer.offerMemberInfos,function(){var servId=this.objInstId;if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){var serv=CacheData.getServ(prodId,servId);if(ec.util.isObj(serv)){serv.isdel="Y";var $li=$("#li_"+prodId+"_"+servId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del")}}})};var _addOffer=function(prodId,offerId){var specName=$("#li_"+prodId+"_"+offerId).find("span").text();$.confirm("信息确认","取消退订【"+specName+"】可选包",{yesdo:function(){var offer=CacheData.getOffer(prodId,offerId);if(offer!=undefined){if(offer.offerSpecId==""){var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.removeClass("del");offer.isdel="N"}else{_checkOfferExcludeDepend(prodId,offer)}}},no:function(){}})};var _addAttOffer=function(prodId,offerSpecId,specName){_addOfferSpec(prodId,offerSpecId)};var paserOfferData=function(result,prodId,offerSpecId,specName){var content="";var param={excludeOffer:[],defaultOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(result!=""){var exclude=result.offerSpec.exclude;var depend=result.offerSpec.depend;var defaultOffer=result.offerSpec.defaultList;if(ec.util.isArray(exclude)){for(var i=0;i<exclude.length;i++){var offerList=CacheData.getOfferList(prodId);var flag=true;if(offerList!=undefined){for(var j=0;j<offerList.length;j++){if(offerList[j].isdel=="Y"){if(offerList[j].offerSpecId==exclude[i].offerSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+exclude[i].offerSpecName+"<br>";param.excludeOffer.push(exclude[i].offerSpecId)}}}if(depend!=undefined&&ec.util.isArray(depend.offerInfos)){for(var i=0;i<depend.offerInfos.length;i++){content+="需要开通： "+depend.offerInfos[i].offerSpecName+"<br>";param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId)}}if(depend!=undefined&&ec.util.isArray(depend.offerGrpInfos)){for(var i=0;i<depend.offerGrpInfos.length;i++){var offerGrpInfo=depend.offerGrpInfos[i];param.dependOffer.offerGrpInfos.push(offerGrpInfo);content+="需要开通： 开通"+offerGrpInfo.minQty+"-"+offerGrpInfo.maxQty+"个以下业务:<br>";if(offerGrpInfo.subOfferSpecInfos!="undefined"&&offerGrpInfo.subOfferSpecInfos.length>0){for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){var subOfferSpec=offerGrpInfo.subOfferSpecInfos[j];var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}else{var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);if(ec.util.isObj(offerSpec)){if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){content+='<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}else{content+='<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+"</input><br>"}}}}}}if(ec.util.isArray(defaultOffer)){for(var i=0;i<defaultOffer.length;i++){content+="需要开通： "+defaultOffer[i].offerSpecName+"<br>";param.defaultOffer.push(defaultOffer[i].offerSpecId)}}}var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);content=content+serContent;if(content==""){AttachOffer.addOpenList(prodId,offerSpecId)}else{content="<div style='max-height:300px;overflow:auto;'>"+content+"</div>";$.confirm("订购： "+specName,content,{yes:function(){CacheData.setOffer2ExcludeOfferSpec(param)},yesdo:function(){excludeAddattch(prodId,offerSpecId,param);excludeAddServ(prodId,"",paramObj)},no:function(){}})}};var paserServData=function(result,prodId,serv){var servSpecId=serv.servSpecId;var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var servOfferList=result.servSpec.offerList;var content="";var param={excludeServ:[],dependServ:[],relatedServ:[],offerListServ:[]};if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);
var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";param.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.dependServ.push(this)})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){content+="需要开通：   "+this.servSpecName+"<br>";param.relatedServ.push(this)})}if(ec.util.isArray(servOfferList)){if(servOfferList.length>0){content+="需要订购：   <br>";$.each(servOfferList,function(){if(this.ifDault===0){content+='<input id="check_open_'+prodId+"_"+this.offerSpecId+'" type="checkbox" checked="checked" disabled="disabled">'+this.offerSpecName+"<br>"}else{content+='<input id="check_open_'+prodId+"_"+this.offerSpecId+'" type="checkbox" checked="checked">'+this.offerSpecName+"<br>"}param.offerListServ.push(this)})}}if(content==""){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams)}else{if(OrderInfo.newOrderInfo.isReloadFlag=="N"){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);excludeAddServ(prodId,servSpecId,param)}else{$.confirm("开通： "+serv.servSpecName,content,{yes:function(){AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);excludeAddServ(prodId,servSpecId,param)},no:function(){}})}}};var excludeAddServ=function(prodId,servSpecId,param){if(ec.util.isArray(param.excludeServ)){for(var i=0;i<param.excludeServ.length;i++){var excludeServSpecId=param.excludeServ[i].servSpecId;var spec=CacheData.getServSpec(prodId,excludeServSpecId);if(spec!=undefined){var $span=$("#li_"+prodId+"_"+excludeServSpecId).find("span");$span.addClass("del");spec.isdel="Y"}else{var serv=CacheData.getServBySpecId(prodId,excludeServSpecId);if(serv!=undefined){var $span=$("#li_"+prodId+"_"+serv.servId).find("span");$span.addClass("del");serv.isdel="Y"}}}}if(ec.util.isArray(param.dependServ)){for(var i=0;i<param.dependServ.length;i++){var servSpec=param.dependServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}if(ec.util.isArray(param.relatedServ)){for(var i=0;i<param.relatedServ.length;i++){var servSpec=param.relatedServ[i];AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams)}}if(ec.util.isArray(param.offerListServ)){for(var i=0;i<param.offerListServ.length;i++){var servSpec=param.offerListServ[i];if($("#check_open_"+prodId+"_"+servSpec.offerSpecId).attr("checked")=="checked"){AttachOffer.addOpenList(prodId,servSpec.offerSpecId)}}}};var excludeAddattch=function(prodId,specId,param){if(param.dependOffer.offerGrpInfos.length>0){var dependOffer=param.dependOffer;for(var i=0;i<dependOffer.offerGrpInfos.length;i++){var offerGrpInfo=dependOffer.offerGrpInfos[i];var len=offerGrpInfo.checkLen;if(len>=offerGrpInfo.minQty&&len<=offerGrpInfo.maxQty){$.each(offerGrpInfo.subOfferSpecInfos,function(){if(this.isCheck){AttachOffer.addOpenList(prodId,this.offerSpecId)}})}else{if(len<offerGrpInfo.minQty){$.alert("提示信息","依赖组至少选中"+offerGrpInfo.minQty+"个！");return}else{if(len>offerGrpInfo.maxQty){$.alert("提示信息","依赖组至多选中"+offerGrpInfo.maxQty+"个！");return}else{$.alert("错误信息","依赖组选择出错！");return}}}}}AttachOffer.addOpenList(prodId,specId);if(param.excludeOffer.length>0){for(var i=0;i<param.excludeOffer.length;i++){var excludeSpecId=param.excludeOffer[i];var spec=CacheData.getOfferSpec(prodId,excludeSpecId);if(spec!=undefined){var $span=$("#li_"+prodId+"_"+excludeSpecId).find("span");$span.addClass("del");spec.isdel="Y";$("#terminalUl_"+prodId+"_"+excludeSpecId).remove()}var offer=CacheData.getOfferBySpecId(prodId,excludeSpecId);if(offer!=undefined){var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.addClass("del");offer.isdel="Y"}}}if(param.dependOffer.dependOffers.length>0){for(var i=0;i<param.dependOffer.dependOffers.length;i++){var offerSpecId=param.dependOffer.dependOffers[i];AttachOffer.addOpenList(prodId,offerSpecId)}}if(param.defaultOffer.length>0){for(var i=0;i<param.defaultOffer.length;i++){var offerSpecId=param.defaultOffer[i];AttachOffer.addOpenList(prodId,offerSpecId)}}};var _addOpenList=function(prodId,offerSpecId){if(!_manyPhoneFilter(prodId,offerSpecId)){return}var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(offer!=undefined){if(offer.isdel!="Y"){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){offer.counts++;newSpec.counts=offer.counts;if(_ifOrderAgain(newSpec)){offer.counts--;return}if(offer.counts<=2){var $li=$("#li_"+prodId+"_"+offer.offerId);$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu" onclick="AttachOffer.setParam('+prodId+","+offerSpecId+","+1+');"></dd>')}}}else{var $span=$("#li_"+prodId+"_"+offer.offerId).find("span");$span.removeClass("del");offer.isdel="N"}return}var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}if(newSpec.isdel=="C"){if(_ifOrderAgain(newSpec)){return}var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();var $li=$('<li id="li_'+prodId+"_"+offerSpecId+'"></li>');if(newSpec.ifDault==0){$li.append('<dd class="mustchoose"></dd>')}else{$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+')"></dd>')}$li.append("<span>"+newSpec.offerSpecName+"</span>");if(newSpec.ifParams){if(CacheData.setParam(prodId,newSpec)){$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}}if(newSpec.ifShowTime=="Y"){$li.append('<dd class="time" id="time_'+prodId+"_"+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+","+offerSpecId+",'"+newSpec.offerSpecName+"');\"></dd>")}if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu2" onclick="AttachOffer.setParam('+prodId+","+offerSpecId+');"></dd>')}$("#open_ul_"+prodId).append($li);newSpec.isdel="N"}else{if((newSpec.isdel=="Y")){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");$span.removeClass("del");newSpec.isdel="N"}else{if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){newSpec.counts++;if(_ifOrderAgain(newSpec)){newSpec.counts--;return}}else{var $spec=$("#li_"+prodId+"_"+offerSpecId);$spec.remove();var $li=$('<li id="li_'+prodId+"_"+offerSpecId+'"></li>');if(newSpec.ifDault==0){$li.append('<dd class="mustchoose"></dd>')}else{$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+","+offerSpecId+')"></dd>')}$li.append("<span>"+newSpec.offerSpecName+"</span>");if(newSpec.ifParams){if(CacheData.setParam(prodId,newSpec)){$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+","+offerSpecId+');"></dd>')}}if(newSpec.ifShowTime=="Y"){$li.append('<dd class="time" id="time_'+prodId+"_"+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+","+offerSpecId+",'"+newSpec.offerSpecName+"');\"></dd>")}$("#open_ul_"+prodId).append($li)}}}if(newSpec!=undefined){$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty!=2){var ifParams="N";if(ec.util.isArray(this.prodSpecParams)){ifParams="Y"}_addOpenServList(prodId,this.objId,this.objName,ifParams);if(this.minQty>0){_minQtyFileter(prodId,this.objId)}}})})}if(ec.util.isArray(newSpec.agreementInfos)){if(OrderInfo.actionFlag!=14){totalNums=0;_removeAttach2Coupons(prodId,newSpec.offerSpecId);var objInstId=prodId+"_"+newSpec.offerSpecId;var $ul=$('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');var $sel=$('<select id="terminalSel_'+objInstId+'"></select>');
var $li1=$('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+"</span></label></li>");var $li2=$('<li style="display:none;"><label> 可选终端规格：</label></li>');$.each(newSpec.agreementInfos,function(){var $option=$('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+"</option>");$sel.append($option)});$li2.append($sel).append('<label class="f_red">*</label>');var minNum=newSpec.agreementInfos[0].minNum;var maxNum=newSpec.agreementInfos[0].maxNum;var $li3=$("<ul></ul>");var isFastOffer=0;if(ec.util.isArray(newSpec.extAttrParams)){$.each(newSpec.extAttrParams,function(){if(this.attrId==CONST.OFFER_FAST_FILL){isFastOffer=1;return false}})}for(var i=0;i<newSpec.agreementInfos.length;i++){var agreementInfo=newSpec.agreementInfos[i];var $ulGroups=$('<ul id="ul_'+objInstId+'" class="fillin show"></ul>');var $liGroups=$('<li class="full"><label> 终端：</label></li>');var $selTerms=$('<select style="display:none;" id="'+objInstId+'"></select>');var $selTermGroups=$('<select style="display:none;" id="group_'+objInstId+'"></select>');if(ec.util.isArray(agreementInfo.terminalGroups)){for(var j=0;j<agreementInfo.terminalGroups.length;j++){var $optionTermGroups=$('<option value="'+agreementInfo.terminalGroups[j].terminalGroupId+'" terminalMaxNum="'+agreementInfo.terminalGroups[j].terminalMaxNum+'" terminalMinNum="'+agreementInfo.terminalGroups[j].terminalMinNum+'">'+agreementInfo.terminalGroups[j].terminalGroupId+"</option>");$selTermGroups.append($optionTermGroups);if(ec.util.isArray(agreementInfo.terminalGroups[j].terminalGroup)){$.each(agreementInfo.terminalGroups[j].terminalGroup,function(){var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+"</option>");$selTerms.append($optionTerms)})}}}if(ec.util.isArray(agreementInfo.terminals)){$.each(agreementInfo.terminals,function(){var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+"</option>");$selTerms.append($optionTerms)})}$liGroups.append($selTerms).append($selTermGroups);if(maxNum>newSpec.agreementInfos[0].minNum){var $strAdd=$('<input id="terminalAddBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="0" onclick="AttachOffer.addAndDelTerminal(this)" value="添加" class="purchase" style="float:left"></input>');var $strDel=$('<input id="terminalDelBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="1" onclick="AttachOffer.addAndDelTerminal(this)" value="删除" class="purchase" style="float:left"></input>');$liGroups.append($strAdd).append($strDel)}$ulGroups.append($liGroups);var minNumArray=new Array();for(var k=1;k<=minNum;k++){var id="terminalText_"+objInstId+"_"+k;minNumArray[k-1]=id;var $liTerminal=$('<li style="width:700px" name="terminalCodeCheckValidLi"><form name="terminalCodeCheckValidForm"><label>终端校验：</label><input id="terminalText_'+objInstId+"_"+k+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><input type="checkbox" id="if_p_reserveCode" onclick="AttachOffer.changereserveCode()"><label>使用预约码：</label><input type="text" class="inputWidth228px inputMargin0" id="reserveCode" value="" disabled="disabled" maxlength="20" placeholder="请输入预约码" style="width:160px;background-color: #E8E8E8;" /><input id="terminalBtn_'+objInstId+"_"+k+'" name="terminalCodeCheckValidBtn" type="button" num="'+k+'" flag="'+isFastOffer+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="" value="校验" class="purchase" style="float:left"></input></form></li>');var $li4=$('<li id="terminalDesc_'+k+'" style="white-space:nowrap;width:700px;"><label></label><label id="terminalName_'+k+'"></label></li>');$ulGroups.append($liTerminal).append($li4)}$li3.append($ulGroups);totalNums+=minNum}var $div=$("#terminalDiv_"+prodId);$ul.append($li1).append($li2).append($li3).appendTo($div);var terminalCode="";if(OrderInfo.terminalCode!=null&&OrderInfo.terminalCode!=""&&OrderInfo.terminalCode!="null"&&OrderInfo.reloadFlag!="N"){var accessNum=OrderInfo.getAccessNumber(prodId);if(accessNum!=""&&accessNum!=null&&accessNum!=undefined){var terminalCodeArray=OrderInfo.terminalCode.split(",");for(var k=0;k<terminalCodeArray.length;k++){if(terminalCodeArray[k].indexOf(accessNum)!=-1){terminalCode=terminalCodeArray[k].split("_")[1];for(var z=0;z<minNumArray.length;z++){if(minNumArray[z].indexOf(prodId)!=-1){$("#"+minNumArray[z]).val(terminalCode);break}}}}}}$div.show();$li3.find("li[name=terminalCodeCheckValidLi]").find("form[name=terminalCodeCheckValidForm]").each(function(){var terminalCodeCheckValidBtn=$(this).find("input[name=terminalCodeCheckValidBtn]");var terminalCodeCheckValidBtnId=terminalCodeCheckValidBtn.attr("id");$(this).off("formIsValid").on("formIsValid",function(event,form){AttachOffer.checkTerminalCode(terminalCodeCheckValidBtn)}).ketchup({bindElement:terminalCodeCheckValidBtnId})});if(newSpec.agreementInfos[0].minNum>0){newSpec.isTerminal=1}}else{if(OrderInfo.actionFlag==14){var objInstId=prodId+"_"+newSpec.offerSpecId;var terminalUl=$("#terminalUl_"+objInstId);if(terminalUl.length>0){return}var $ul=$('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');var $sel=$('<select id="terminalSel_'+objInstId+'"></select>');var $li1=$('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+"</span></label></li>");var $li2=$('<li style="display:none;"><label> 可选终端规格：</label></li>');$.each(newSpec.agreementInfos,function(){var $option=$('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+"</option>");$sel.append($option)});$li2.append($sel).append('<label class="f_red">*</label>');var $li3=$('<li><label>终端校验：</label><input id="terminalText_'+objInstId+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+","+newSpec.offerSpecId+')" value="校验" class="purchase" style="float:left"></input></li>');var $div=$("#terminalDiv_"+prodId);var $li4=$('<li id="terminalDesc" style="display:none;white-space:nowrap;"><label> 终端规格：</label><label id="terminalName"></label></li>');$ul.append($li1).append($li2).append($li3).append($li4).appendTo($div);$div.show();newSpec.isTerminal=1;for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var coupon=OrderInfo.attach2Coupons[i];if(prodId==coupon.prodId){$("#terminalSel_"+objInstId).val(coupon.couponId);$("#terminalSel_"+objInstId).attr("disabled",true);$("#terminalText_"+objInstId).val(coupon.couponInstanceNumber);$("#terminalText_"+objInstId).attr("disabled",true);$("#terminalBtn_"+objInstId).hide()}}}}}};var _changereserveCode=function(){if($("#if_p_reserveCode").attr("checked")){$("#reserveCode").css("background-color","white").attr("disabled",false)}else{$("#reserveCode").css("background-color","#E8E8E8").attr("disabled",true)}};var _checkTerminalCode=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var num=$(obj).attr("num");var flag=$(obj).attr("flag");if(flag==undefined){flag=0}OrderInfo.termReserveFlag="";_filterAttach2Coupons(prodId,offerSpecId,num);var objInstId=prodId+"_"+offerSpecId;var resIdArray=[];var terminalGroupIdArray=[];$("#"+objInstId+"  option").each(function(){resIdArray.push($(this).val())});$("#group_"+objInstId+"  option").each(function(){terminalGroupIdArray.push($(this).val())});var resId=resIdArray.join("|");var terminalGroupId=terminalGroupIdArray.join("|");if((resId==undefined||$.trim(resId)=="")&&(terminalGroupId==undefined||$.trim(terminalGroupId)=="")){$.alert("信息提示","终端规格不能为空！");return}var instCode=$("#terminalText_"+objInstId+"_"+num).val();
if(instCode==undefined||$.trim(instCode)==""){$.alert("信息提示","终端串码不能为空！");return}if($("#if_p_reserveCode").attr("checked")){var reserveCode=$("#reserveCode").val();if(reserveCode==""){$.alert("信息提示","请输入终端预约码！");return}}else{$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[]}if(_checkData(objInstId,instCode)){return}var newSpec=_setSpec(prodId,offerSpecId);var param={instCode:instCode,flag:flag,mktResId:resId,offerSpecId:offerSpecId,offerSpecName:newSpec.offerSpecName};var data=query.prod.checkTerminal(param);if(data==undefined){return}var activtyType="";for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"&&ec.util.isArray(spec.agreementInfos)){if(spec.agreementInfos[0].activtyType==2){activtyType="2"}}}}if(data.statusCd==CONST.MKTRES_STATUS.USABLE||(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2")){var mktPrice=0;var mktColor="";if(ec.util.isArray(data.mktAttrList)){$.each(data.mktAttrList,function(){if(this.attrId=="65010058"){mktPrice=this.attrValue}else{if(this.attrId=="60010004"){mktColor=this.attrValue}}})}$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");$("#terminalDesc_"+num).css("display","block");var coupon={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:data.mktResStoreId,storeName:"1",agentId:1,apCharge:mktPrice,couponInstanceNumber:data.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:-1,attachSepcId:offerSpecId,state:"ADD",relaSeq:"",num:num,attrList:data.mktAttrList};if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2"){coupon.couponSource="2"}if(CONST.getAppDesc()==0){coupon.termTypeFlag=data.termTypeFlag}if($("#if_p_reserveCode").attr("checked")){var custId=OrderInfo.cust.custId;var identityTypeCd="";var identityNum="";if(custId==-1){identityTypeCd=OrderInfo.boCustIdentities.identidiesTypeCd;identityNum=OrderInfo.boCustIdentities.identityNum}var param={reserveCode:reserveCode,couponId:data.mktResId,terminalPrice:mktPrice,custId:custId,identityTypeCd:identityTypeCd,identityNum:identityNum};var url=contextPath+"/mktRes/terminal/queryCouponReserveCodeCheck ";$.callServiceAsJson(url,param,{before:function(){},always:function(){},done:function(response){if(response&&response.code==-2){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[];$.alertM(response.data);return}else{if(response&&response.data&&response.data.code==0){if(response.data.buyFlag!=null&&response.data.buyFlag=="Y"){var content="您购买的终端和预约的终端不一致，请确认是否需要购买该终端？";$.confirm("信息确认",content,{yes:function(){},yesdo:function(){if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})})}checkedReserveNbr=response.data.couponInfo.reserveNbr;coupon.sourceId=checkedReserveNbr;OrderInfo.termReserveFlag=CONST.OL_TYPE_CD.ZDYY;OrderInfo.attach2Coupons.push(coupon);if(response.data.offerSpec.length>0){checkedOfferSpec=response.data.offerSpec;var content='<form id="promotionForm"><table>';var selectStr="";var optionStr="";selectStr=selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>";$.each(response.data.offerSpec,function(){var offerSpec=this;optionStr+='<option value="'+this.offerSpecId+'">'+this.offerSpecName+"</option>"});selectStr+=optionStr+"</select></td></tr>";content+=selectStr;var offerSpecId;$.confirm("促销包选择",content,{yes:function(){},no:function(){}});$("#promotionForm").bind("formIsValid",function(event,form){offerSpecId=$("#"+checkedReserveNbr+" option:selected").val();$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove();AttachOffer.selectAttachOffer(prodId,offerSpecId)}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}},no:function(){}})}else{if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})})}checkedReserveNbr=response.data.couponInfo.reserveNbr;coupon.sourceId=checkedReserveNbr;OrderInfo.termReserveFlag=CONST.OL_TYPE_CD.ZDYY;OrderInfo.attach2Coupons.push(coupon);if(response.data.offerSpec.length>0){checkedOfferSpec=response.data.offerSpec;var content='<form id="promotionForm"><table>';var selectStr="";var optionStr="";selectStr=selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>";$.each(response.data.offerSpec,function(){var offerSpec=this;optionStr+='<option value="'+this.offerSpecId+'">'+this.offerSpecName+"</option>"});selectStr+=optionStr+"</select></td></tr>";content+=selectStr;var offerSpecId;$.confirm("促销包选择",content,{yes:function(){},no:function(){}});$("#promotionForm").bind("formIsValid",function(event,form){offerSpecId=$("#"+checkedReserveNbr+" option:selected").val();$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove();AttachOffer.selectAttachOffer(prodId,offerSpecId)}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{$.alert("信息提示",data.message)}}}else{if(response&&response.data&&response.data.message&&response.data.code==1){$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[];$.alert("提示",response.data.message);return}else{$.each(checkedOfferSpec,function(){var offerSpec=this;var specList=CacheData.getOfferSpecList(prodId);$.each(specList,function(){if(offerSpec.offerSpecId==this.offerSpecId){var $span=$("#li_"+prodId+"_"+this.offerSpecId).find("span");this.isdel="Y";_delServSpec(prodId,this);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#li_"+prodId+"_"+this.offerSpecId).remove()}})});checkedOfferSpec=[];$.alert("提示","<br/>终端预约码校验失败，请稍后重试！");return}}}}})}else{$.alert("信息提示",data.message);OrderInfo.attach2Coupons.push(coupon)}}else{if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}else{$.alert("提示",data.message)}}};var _setSpec=function(prodId,offerSpecId){var newSpec=CacheData.getOfferSpec(prodId,offerSpecId);if(newSpec==undefined){newSpec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!newSpec){return}CacheData.setOfferSpec(prodId,newSpec)}return newSpec};var _addOpenServList=function(prodId,servSpecId,servSpecName,ifParams){var serv=CacheData.getServBySpecId(prodId,servSpecId);
if(serv!=undefined){$("#li_"+prodId+"_"+serv.servId).find("span").removeClass("del");serv.isdel="N";return}var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:servSpecName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams}CacheData.setServSpec(prodId,newSpec);spec=newSpec}if(spec.isdel=="C"){$("#li_"+prodId+"_"+servSpecId).remove();var $li=$('<li id="li_'+prodId+"_"+servSpecId+'"></li>');if(spec.ifDault==0){$li.append('<dd class="mustchoose"></dd>')}else{$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+","+servSpecId+",'"+servSpecName+"','"+ifParams+"')\"></dd>")}$li.append("<span>"+spec.servSpecName+"</span>");if(spec.ifParams=="Y"){if(CacheData.setServParam(prodId,spec)){$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}else{$li.append('<dd id="can_'+prodId+"_"+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+","+servSpecId+');"></dd>')}}$("#open_serv_ul_"+prodId).append($li)}else{$("#li_"+prodId+"_"+servSpecId).find("span").removeClass("del")}spec.isdel="N";_showHideUim(0,prodId,servSpecId)};var _showMainParam=function(){var content=CacheData.getParamContent(-1,OrderInfo.offerSpec,0);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){}).ketchup({bindElement:"easyDialogYesBtn"})};var _showParam=function(prodId,offerSpecId,flag){if(flag==1){var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offer.offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=query.offer.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}if(!offer.isGetParam){var param={offerTypeCd:"2",offerId:offer.offerId,offerSpecId:offer.offerSpecId};var offerParam=query.offer.queryOfferParam(param);if(offerParam==undefined){return}else{offer.offerParamInfos=offerParam.offerParamInfos;offer.isGetParam=true}}var content=CacheData.getParamContent(prodId,offer,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});order.protocolnbr.init();$("#paramForm").bind("formIsValid",function(event,form){if(!paramInputCheck()){return}var isset=false;$.each(offer.offerSpec.offerSpecParams,function(){var itemInfo=CacheData.getOfferParam(prodId,offer.offerId,this.itemSpecId);if(itemInfo.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){itemInfo.setValue=$("#select1").val()}else{itemInfo.setValue=$("#"+prodId+"_"+this.itemSpecId).val()}if(itemInfo.value!=itemInfo.setValue){itemInfo.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu").addClass("canshu2");offer.isset="Y";offer.update="Y"}else{$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu2").addClass("canshu");offer.isset="N";offer.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);if(spec==undefined){spec=query.offer.queryAttachOfferSpec(prodId,offerSpecId);if(!spec){return}}var content=CacheData.getParamContent(prodId,spec,flag);$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});order.protocolnbr.init();$("#paramForm").bind("formIsValid",function(event,form){if(!paramInputCheck()){return}if(!!spec.offerSpecParams){for(var i=0;i<spec.offerSpecParams.length;i++){var param=spec.offerSpecParams[i];var itemSpec=CacheData.getSpecParam(prodId,offerSpecId,param.itemSpecId);if(itemSpec.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){itemSpec.setValue=$("#select1").val()}else{itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}}if(spec.offerRoles!=undefined&&spec.offerRoles.length>0){for(var i=0;i<spec.offerRoles.length;i++){var offerRole=spec.offerRoles[i];for(var j=0;j<offerRole.roleObjs.length;j++){var roleObj=offerRole.roleObjs[j];if(!!roleObj.prodSpecParams){for(var k=0;k<roleObj.prodSpecParams.length;k++){var prodParam=roleObj.prodSpecParams[k];var prodItem=CacheData.getProdSpecParam(prodId,offerSpecId,prodParam.itemSpecId);prodItem.value=$("#"+prodId+"_"+prodParam.itemSpecId).val()}}}}}$("#can_"+prodId+"_"+offerSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getOfferSpec(prodId,offerSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var _showServParam=function(prodId,servSpecId,flag){if(flag==1){var serv=CacheData.getServBySpecId(prodId,servSpecId);var param={prodId:serv.servId,ifServItem:"Y"};if(!serv.isGetParamSpec){param.prodSpecId=serv.servSpecId;var dataSepc=query.prod.prodSpecParamQuery(param);if(dataSepc==undefined){return}else{serv.prodSpecParams=dataSepc.result.prodSpecParams;serv.isGetParamSpec=true}}if(!serv.isGetParamInst){var data=query.prod.prodInstParamQuery(param);if(data==undefined){return}else{serv.prodInstParams=data.result.prodInstParams;serv.isGetParamInst=true}}var content=CacheData.getParamContent(prodId,serv,3);if(OrderInfo.isGroupProSpecId(serv.servSpecId)){ec.form.dialog.createDialog({id:"-group",width:"370",height:"440",initCallBack:function(dialogForm,dialog){AttachOffer.dialogForm=dialogForm;AttachOffer.dialog=dialog;$("#div_group").empty();$("#div_group").append(content);$("#div_group_btn").empty();var str='<a href="javascript:void(0)" id="ok_btn" class="btn_h30"><span>确认</span></a><a href="javascript:void(0);" id="cancel_btn" class="btn_h30" style="margin-left:20px;"><span>取消</span></a>';$("#div_group_btn").append(str);$("#ok_btn").off("click").on("click",function(event){_groupInistOkBtn(prodId,servSpecId)});$("#cancel_btn").off("click").on("click",function(event){_closeDialog()})},submitCallBack:function(dialogForm,dialog){},closeCallBack:function(dialogForm,dialog){}});return}$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var isset=false;$.each(serv.prodSpecParams,function(){var prodItem=CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);prodItem.setValue=$("#"+prodId+"_"+this.itemSpecId).val();if(prodItem.value!=prodItem.setValue){prodItem.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");serv.isset="Y";serv.update="Y"}else{$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");serv.isset="N";serv.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}var content=CacheData.getParamContent(prodId,spec,2);if(OrderInfo.isGroupProSpecId(spec.servSpecId)){ec.form.dialog.createDialog({id:"-group",width:"370",height:"440",initCallBack:function(dialogForm,dialog){AttachOffer.dialogForm=dialogForm;AttachOffer.dialog=dialog;$("#div_group").empty();$("#div_group").append(content);$("#div_group_btn").empty();var str='<a href="javascript:void(0)" id="ok_btn" class="btn_h30"><span>确认</span></a><a href="javascript:void(0);" id="cancel_btn" class="btn_h30" style="margin-left:20px;"><span>取消</span></a>';$("#div_group_btn").append(str);$("#ok_btn").off("click").on("click",function(event){_groupOkBtn(prodId,servSpecId)});$("#cancel_btn").off("click").on("click",function(event){_closeDialog()})},submitCallBack:function(dialogForm,dialog){},closeCallBack:function(dialogForm,dialog){}});return}$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){if(!!spec.prodSpecParams){for(var i=0;i<spec.prodSpecParams.length;
i++){var param=spec.prodSpecParams[i];var itemSpec=CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val()}}$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getServSpec(prodId,servSpecId);attchSpec.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var _groupOkBtn=function(prodId,servSpecId){var spec=CacheData.getServSpec(prodId,servSpecId);var flag=true;if(!!spec.prodSpecParams){for(var i=0;i<spec.prodSpecParams.length;i++){var param=spec.prodSpecParams[i];var itemSpec=CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);itemSpec.setValue=$("#"+prodId+"_"+param.itemSpecId).val();if(!ec.util.isObj(itemSpec.setValue)){$.alert("信息提示",param.name+"不能为空");flag=false;break}}}if(flag){$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");var attchSpec=CacheData.getServSpec(prodId,servSpecId);attchSpec.isset="Y";easyDialog.close()}};var _groupInistOkBtn=function(prodId,servSpecId){var serv=CacheData.getServBySpecId(prodId,servSpecId);var isset=false;$.each(serv.prodSpecParams,function(){var prodItem=CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);prodItem.setValue=$("#"+prodId+"_"+this.itemSpecId).val();if(prodItem.value!=prodItem.setValue){prodItem.isUpdate="Y";isset=true}});if(isset){$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");serv.isset="Y";serv.update="Y"}else{$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");serv.isset="N";serv.update="N"}_closeDialog()};var _closeDialog=function(){if(AttachOffer.dialogForm!=undefined&&AttachOffer.dialog!=undefined){AttachOffer.dialogForm.close(AttachOffer.dialog)}};var paramInputCheck=function(){var pass=true;$("#paramForm").find("input[type=text]").each(function(){var mask=$(this).attr("mask");var maskmsg=$(this).attr("maskmsg");if(mask!=null&&mask!=""&&mask.substring(0,1)=="/"&&mask.substring(mask.length-1,mask.length)=="/"){if(!eval(mask).test($(this).val())){$.alert("提示",maskmsg);pass=false;return false}}});return pass};var _showTime=function(prodId,offerSpecId,offerSpecName){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(offerSpecName+"--生失效设置");var spec=CacheData.getOfferSpec(prodId,offerSpecId);_initTime(spec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setAttachTime(prodId,offerSpecId)});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showStartTime=function(){var strDate=DateUtil.Format("yyyy年MM月dd日",new Date());var endDate=$("#endDt").val();if(endDate==""){$.calendar({minDate:strDate})}else{$.calendar({minDate:strDate,maxDate:endDate})}};var _showEndTime=function(){var strDate=$("#startDt").val();if(strDate==""){strDate=DateUtil.Format("yyyy年MM月dd日",new Date())}$.calendar({minDate:strDate})};var _initTime=function(spec){if(spec!=undefined&&spec.ooTimes!=undefined){var ooTime=spec.ooTimes;$("input[name=startTimeType][value='"+ooTime.startType+"']").attr("checked","checked");$("input[name=endTimeType][value='"+ooTime.endType+"']").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("");if(ooTime.startType==4){$("#startDt").val(ooTime.startDt)}if(ooTime.endType==4){$("#endDt").val(ooTime.endDt)}else{if(ooTime.endType==5){$("#endTime").val(ooTime.effTime);$("#endTimeUnit").val(ooTime.effTimeUnitCd)}}}else{$("input[name=startTimeType][value=1]").attr("checked","checked");$("input[name=endTimeType][value=1]").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("")}};var _showOfferTime=function(){var data=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(OrderInfo.offerSpec.offerSpecName+"-生失效设置");_initTime(OrderInfo.offerSpec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){_setMainTime()});if(data==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var _showMainMember=function(){$("#memberName").text(OrderInfo.offerSpec.offerSpecName+"-构成");$("#main_member_div").empty();$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)});$("#main_member_div").append('<div class="clear"></div>')}else{$.each(offerRole.prodInsts,function(){var prodId=this.prodInstId;var $ul=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var $div=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));$.each(offerRole.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var $li=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var $checkbox=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');$ul.append($checkbox).append($li)}});$("#main_member_div").append('<div class="clear"></div>')})}});easyDialog.open({container:"div_member_dialog"});$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(offerRole.prodInsts,function(){var prodInst=this;$.each(offerRole.roleObjs,function(){var servSpecId=this.objId;if(this.minQty>0){$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked");$(this).attr("disabled","disabled")}})}});if(!!prodInst.servInsts){$.each(prodInst.servInsts,function(){var servSpecId=this.objId;$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){if(servSpecId==$(this).attr("servSpecId")){$(this).attr("checked","checked")}})})}})});$("#memberSpan").off("click").on("click",function(){_setMainMember()})};var _setMainMember=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){var offerRole=this;$.each(this.prodInsts,function(){var prodInst=this;prodInst.servInsts=[];$("input[name='serv_check_"+this.prodInstId+"']:checked").each(function(){var servSpecId=$(this).attr("servSpecId");$.each(offerRole.roleObjs,function(){if(this.objId==servSpecId){prodInst.servInsts.push(this)}})})})});easyDialog.close()};var _getTime=function(){var ooTime={state:"ADD"};var startRadio=$("input[name=startTimeType]:checked").attr("value");ooTime.startType=startRadio;if(startRadio==1){ooTime.isDefaultStart="Y"}else{if(startRadio==2){}else{if(startRadio==3){ooTime.startTime=1;ooTime.startTimeUnitCd=7}else{if(startRadio==4){if($("#startDt").val()==""){$.alert("提示","指定生效时间不能为空!");return}ooTime.startDt=$("#startDt").val()}}}}var endRadio=$("input[name=endTimeType]:checked").attr("value");ooTime.endType=endRadio;if(endRadio==1){ooTime.isDefaultEnd="Y"}else{if(endRadio==4){if($("#endDt").val()==""){$.alert("提示","指定失效时间不能为空!");return}ooTime.endDt=$("#endDt").val()}else{if(endRadio==5){var end=$("#endTime").val();if(end==""){$.alert("提示","有效时长不能为空!");return}if(isNaN(end)){$.alert("提示","有效时长必须为数字!");return}if(end<=0){$.alert("提示","有效时长必须大于0!");return}ooTime.effTime=end;ooTime.effTimeUnitCd=$("#endTimeUnit").val()}}}return ooTime};var _setMainTime=function(){var ooTime=_getTime();if(ooTime==undefined){return}OrderInfo.offerSpec.ooTimes=ooTime;$("#mainTime").removeClass("time").addClass("time2");easyDialog.close()};var _setAttachTime=function(prodId,offerSpecId){var ooTime=_getTime();if(ooTime==undefined){return}var spec=CacheData.getOfferSpec(prodId,offerSpecId);spec.ooTimes=ooTime;
$("#time_"+prodId+"_"+offerSpecId).removeClass("time").addClass("time2");easyDialog.close()};var _changeLabel=function(prodId,prodSpecId,labelId){$.each(AttachOffer.labelList,function(){if(this.prodId==prodId){$.each(this.labels,function(){if(labelId==""){labelId=this.label;$("#tab_"+prodId+"_"+this.label).addClass("setcon")}else{if(labelId==this.label){$("#tab_"+prodId+"_"+this.label).addClass("setcon");$("#ul_"+prodId+"_"+this.label).show()}else{$("#tab_"+prodId+"_"+this.label).removeClass("setcon");$("#ul_"+prodId+"_"+this.label).hide()}}})}});var $ul=$("#ul_"+prodId+"_"+labelId);if($ul[0]==undefined){var queryType="3";if(prodId>0){queryType=""}if(labelId==CONST.LABEL.SERV){var param={prodId:prodId,prodSpecId:prodSpecId,queryType:queryType,labelId:labelId};var data=query.offer.queryServSpec(param);var $ul=$('<ul id="ul_'+prodId+"_"+labelId+'"></ul>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.servSpec)){var servList=CacheData.getServList(prodId);var servSpecList=CacheData.getServSpecList(prodId);$.each(data.result.servSpec,function(){AttachOffer.allOfferList.push(this);var servSpecId=this.servSpecId;var flag=true;$.each(servList,function(){if(this.servSpecId==servSpecId&&this.isDel!="C"){flag=false;return false}});$.each(servSpecList,function(){if(this.servSpecId==servSpecId){flag=false;return false}});if(flag){var $li=$('<li id="li_'+prodId+"_"+this.servSpecId+'"></li>');var $dd=$('<dd class="canchoose" onclick="AttachOffer.openServSpec('+prodId+","+this.servSpecId+",'"+this.servSpecName+"','"+this.ifParams+"')\"></dd>");var $span=$('<span><a href="javascript:AttachOffer.openServSpec('+prodId+","+this.servSpecId+",'"+this.servSpecName+"','"+this.ifParams+"')\">"+this.servSpecName+"</a></span>");var $dd2=$('<dd class="canshu2" onclick="AttachOffer.offerSpecDetail('+prodId+","+this.servSpecId+')"><img src="'+contextPath+'/image/common/more.png"/></dd>');$li.append($dd).append($span).append($dd2).appendTo($ul)}})}}$("#div_"+prodId).append($ul)}else{var param={prodSpecId:prodSpecId,offerSpecIds:[],queryType:queryType,prodId:prodId,partyId:OrderInfo.cust.custId,labelId:labelId,ifCommonUse:""};if(OrderInfo.actionFlag==2){param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr;$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){param.offerSpecIds.push(this.offerSpec.offerSpecId);$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){param.offerRoleId=this.offerRoleId}})}})}}$.each(OrderInfo.offerSpec.offerRoles,function(){if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){if(this.prodInstId==prodId){param.acctNbr=this.accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}})}else{if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22){var prodInfo=order.prodModify.choosedProdInfo;param.acctNbr=prodInfo.accNbr;if(!ec.util.isObj(prodInfo.prodOfferId)){prodInfo.prodOfferId=""}var offerRoleId=CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;if(offerRoleId==undefined){offerRoleId=""}param.offerRoleId=offerRoleId;param.offerSpecIds.push(prodInfo.prodOfferId)}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.viceOfferSpec,function(){var offerSpecId=this.offerSpecId;var accessNumber=this.accessnumber;if(this.prodId==prodId){$.each(this.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||this.memberRoleCd=="1"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){param.acctNbr=accessNumber;param.offerRoleId=this.offerRoleId;param.offerSpecIds.push(offerSpecId);return false}})}})}})}else{if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){var oldoffer={};for(var j=0;j<OrderInfo.oldoffer.length;j++){oldoffer=OrderInfo.oldoffer[j];for(var i=0;i<OrderInfo.oldoffer[j].offerMemberInfos.length;i++){var offerMember=OrderInfo.oldoffer[j].offerMemberInfos[i];if(offerMember.objInstId==prodId){param.acctNbr=offerMember.accessNumber;$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==oldoffer.accNbr){param.offerSpecIds.push(this.offerSpec.offerSpecId);$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){param.offerRoleId=this.offerRoleId;return false}})}})}}}}else{param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);var prodInst=OrderInfo.getProdInst(prodId);if(prodInst){param.offerRoleId=prodInst.offerRoleId}}}}}query.offer.queryCanBuyAttachSpec(param,function(data){var $ul=$('<ul id="ul_'+prodId+"_"+labelId+'"></ul>');if(data!=undefined&&data.resultCode=="0"){if(ec.util.isArray(data.result.offerSpecList)){var offerList=CacheData.getOfferList(prodId);var offerSpecList=CacheData.getOfferSpecList(prodId);$.each(data.result.offerSpecList,function(){AttachOffer.allOfferList.push(this);var offerSpecId=this.offerSpecId;var flag=true;var ifOrderAgain=this.ifOrderAgain;$.each(offerList,function(){if(this.offerSpecId==offerSpecId&&this.isDel!="C"&&ifOrderAgain!="Y"){flag=false;return false}});$.each(offerSpecList,function(){if(this.offerSpecId==offerSpecId&&ifOrderAgain!="Y"){flag=false;return false}});if(flag){var $li=$('<li id="li_'+prodId+"_"+this.offerSpecId+'"></li>');if(ec.util.isObj(ifOrderAgain)&&ifOrderAgain=="Y"){$li=$('<li id="li_'+prodId+"_"+this.offerSpecId+"_"+ifOrderAgain+'"></li>')}var $dd=$('<dd class="canchoose" onclick="AttachOffer.addOfferSpec('+prodId+","+this.offerSpecId+')"></dd>');var $span=$('<span><a href="javascript:AttachOffer.addOfferSpec('+prodId+","+this.offerSpecId+')" >'+this.offerSpecName+"</a></span>");var $dd2=$('<dd class="canshu2" onclick="AttachOffer.offerSpecDetail('+prodId+","+this.offerSpecId+')"><img src="'+contextPath+'/image/common/more.png"/></dd>');$li.append($dd).append($span).append($dd2).appendTo($ul)}})}}$("#div_"+prodId).append($ul)})}}};var _showHideUim=function(flag,prodId,servSpecId){if(CONST.getAppDesc()==0&&servSpecId==CONST.PROD_SPEC.PROD_FUN_4G){var prodClass=order.prodModify.choosedProdInfo.prodClass;if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){prodClass=CacheData.getOfferMember(prodId).prodClass;if(prodClass==undefined&&offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==prodId){prodClass=this.prodClass;return false}})})}}else{if(OrderInfo.actionFlag==6){for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){prodClass=OrderInfo.oldprodInstInfos[i].prodClass}}$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==prodId){prodClass=CacheData.getOfferMember(prodId).prodClass}})}}if(flag==0){if(prodClass==CONST.PROD_CLASS.THREE){$("#title_"+prodId).show();$("#uimDiv_"+prodId).show();var actionFalg=OrderInfo.actionFlag;var instCode=OrderInfo.provinceInfo.mktResInstCode;var codeMsg=OrderInfo.provinceInfo.codeMsg;if(actionFalg=="3"&&order.uiCust.packageInfo.reloadFlag=="Y"){if(codeMsg!=null&&codeMsg!=""){$.alert("提示",codeMsg)}else{if(instCode!=null&&instCode!=""){$("#uim_txt_"+prodId).val(instCode);$("#uim_check_btn_"+prodId).hide();$("#uim_release_btn_"+prodId).hide();$("#uim_txt_"+prodId).attr("disabled",true);var uimParam={instCode:instCode};var response=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);if(response.code==0){if(response.data.mktResBaseInfo){var statusCd=response.data.mktResBaseInfo.statusCd;if(statusCd=="1102"){var offerId="";if(OrderInfo.actionFlag==6){offerId=order.prodModify.choosedProdInfo.prodOfferInstId;$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){offerId=this.mainProdOfferInstInfos[0].prodOfferInstId
}})}else{offerId=order.prodModify.choosedProdInfo.prodOfferInstId}_packageCouponInfo(prodId,offerId,response,instCode)}else{$.alert("提示","UIM卡["+instCode+"]不是预占状态，当前为"+statusCd)}}else{$.alert("提示","查询不到UIM卡["+instCode+"]信息")}}else{if(response.code==-2){$.alertM(response.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}if((order.memberChange.mktResInstCode!=""&&order.memberChange.reloadFlag=="Y")||(OrderInfo.mktResInstCode!=""&&OrderInfo.reloadFlag=="Y")){var nbrlist=[];var nbrflag=true;var offerId=order.prodModify.choosedProdInfo.prodOfferInstId;$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){offerId=this.mainProdOfferInstInfos[0].prodOfferInstId}});var mktResInstCodesize="";if(OrderInfo.actionFlag==2){mktResInstCodesize=OrderInfo.mktResInstCode.split(",")}else{if(OrderInfo.actionFlag==6){mktResInstCodesize=order.memberChange.mktResInstCode.split(",")}}for(var u=0;u<mktResInstCodesize.length;u++){if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null"&&order.memberChange.oldSubPhoneNum!=""){var nbrAndUimCode=mktResInstCodesize[u].split("_");var _accNbr=nbrAndUimCode[0];var _uimCode=nbrAndUimCode[1];var oldSubPhoneNumsize=order.memberChange.oldSubPhoneNum.split(",");var uimflag=false;$.each(nbrlist,function(){if(this==_accNbr){nbrflag=false;return false}else{nbrflag=true}});if(!nbrflag){$.alert("提示","UIM卡"+_uimCode+"对应的号码重复");return}for(var n=0;n<oldSubPhoneNumsize.length;n++){if(oldSubPhoneNumsize[n]==_accNbr){nbrlist.push(oldSubPhoneNumsize[n]);uimflag=true;$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.accessNumber==_accNbr){$("#uim_txt_"+this.objInstId).attr("disabled",true);var uimParam={instCode:_uimCode};var response=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);if(response.code==0){if(response.data.mktResBaseInfo){if(response.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_"+this.objInstId).attr("disabled",true);$("#uim_check_btn_"+this.objInstId).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+this.objInstId).attr("disabled",false);$("#uim_release_btn_"+this.objInstId).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+this.objInstId).val(_uimCode);var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:response.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:response.data.mktResBaseInfo.qty,storeId:response.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:_uimCode,terminalCode:_uimCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:this.objInstId,offerId:offerId,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(this.objInstId);OrderInfo.boProd2Tds.push(coupon)}else{$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(response.code==-2){$.alertM(response.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}})})}}if(!uimflag){$.alert("提示","UIM卡"+_uimCode+"未匹配到接入号")}}}}}}else{if(flag==1){if(prodClass==CONST.PROD_CLASS.THREE){$("#uimDiv_"+prodId).hide()}}}}};var _packageCouponInfo=function(prodId,offerId,response,instCode){var coupon={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:response.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:response.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:instCode,terminalCode:instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:offerId,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(prodId);OrderInfo.boProd2Tds.push(coupon)};var _isChangeUim=function(objId){if(CONST.getAppDesc()==0){var prodClass=order.prodModify.choosedProdInfo.prodClass;var prodId=order.prodModify.choosedProdInfo.prodInstId;if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){var member=CacheData.getOfferMember(objId);if(member.objInstId==undefined&&offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==objId){member=this;return false}})})}prodClass=member.prodClass;prodId=member.objInstId}else{if(OrderInfo.actionFlag==6){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==objId){prodClass=this.prodClass;prodId=this.prodInstId}});$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==prodId){var member=CacheData.getOfferMember(objId);prodClass=member.prodClass;prodId=member.objInstId}})}}if(prodClass==CONST.PROD_CLASS.THREE){var servSpec=CacheData.getServSpec(prodId,CONST.PROD_SPEC.PROD_FUN_4G);if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){return true}}}return false};var _setAttachBusiOrder=function(busiOrders){$.each(AttachOffer.openServList,function(){var prodId=this.prodId;$.each(this.servSpecList,function(){if(this.isdel!="Y"&&this.isdel!="C"){SoOrder.createServ(this,prodId,0,busiOrders)}})});$.each(AttachOffer.openedServList,function(){var prodId=this.prodId;$.each(this.servList,function(){if(this.isdel=="Y"){SoOrder.createServ(this,prodId,1,busiOrders)}else{if(this.update=="Y"){SoOrder.createServ(this,prodId,2,busiOrders)}}})});for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"){if(ec.util.isObj(spec.counts)){for(var k=0;k<spec.counts;k++){SoOrder.createAttOffer(spec,open.prodId,0,busiOrders)}}else{SoOrder.createAttOffer(spec,open.prodId,0,busiOrders)}}}}for(var i=0;i<AttachOffer.openedList.length;i++){var opened=AttachOffer.openedList[i];for(var j=0;j<opened.offerList.length;j++){var offer=opened.offerList[j];if(offer.isdel=="Y"){if(ec.util.isObj(offer.counts)){for(var k=0;k<offer.orderCount;k++){offer.offerId=offer.offerIds[k];SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{if(offer.update=="Y"){SoOrder.createAttOffer(offer,opened.prodId,2,busiOrders)}else{if(ec.util.isObj(offer.orderCount)&&ec.util.isObj(offer.counts)){if(offer.orderCount>offer.counts){for(var k=0;k<(offer.orderCount-offer.counts);k++){offer.offerId=offer.offerIds[k];SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders)}}else{if(offer.orderCount<offer.counts){var spec=CacheData.getOfferSpec(opened.prodId,offer.offerSpecId);for(var k=0;k<(offer.counts-offer.orderCount);k++){SoOrder.createAttOffer(spec,opened.prodId,0,busiOrders)}}}}}}}}$.each(AttachOffer.openAppList,function(){var prodId=this.prodId;$.each(this.appList,function(){if(this.dfQty==1){SoOrder.createServ(this,prodId,0,busiOrders)}})})};var _setChangeList=function(prodId){AttachOffer.changeList=[];var prodInfos=offerChange.resultOffer.prodInfos;if(ec.util.isArray(prodInfos)){$.each(prodInfos,function(){if(prodId!=this.accProdInstId){return true}if(prodId!=this.prodInstId){var param={prodInstId:prodId};var serv=CacheData.getServ(prodId,this.prodInstId);var servSpec=CacheData.getServSpec(prodId,this.productId);if(this.state=="DEL"){if(serv!=undefined&&serv.isdel!="Y"){param.objId=this.prodInstId;param.status=(serv.isdel!=undefined?serv.isdel:"N");param.objIdType=1;serv.isdel="Y";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel!="Y"&&servSpec.isdel!="C"){param.objId=this.productId;param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(serv!=undefined&&serv.isdel=="Y"){param.objId=this.prodInstId;param.status=serv.isdel;param.objIdType=1;serv.isdel="N";AttachOffer.changeList.push(param)}else{if(servSpec!=undefined&&servSpec.isdel=="Y"){param.objId=this.productId;param.status=servSpec.isdel;param.objIdType=2;servSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(serv==undefined&&servSpec==undefined){param.objId=this.productId;param.status="Y";param.objIdType=2;AttachOffer.changeList.push(param);if(this.productId!=undefined&&this.productId!=""){var newSerSpec={objId:this.productId,servSpecId:this.productId,servSpecName:this.productName,ifParams:"N",isdel:"N"};
CacheData.setServSpec(prodId,newSerSpec);var servSpec=CacheData.getServSpec(prodId,this.productId);servSpec.isdel="N"}}}}}}}})}var offers=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(offers)){$.each(offers,function(){if(this.memberInfo==undefined){return true}var flag=true;$.each(this.memberInfo,function(){if(ec.util.isObj(this.accProdInstId)&&prodId==this.accProdInstId){flag=false;return false}});if(flag){return true}var param={prodInstId:prodId};var offer=CacheData.getOffer(prodId,this.prodOfferInstId);var offerSpec=CacheData.getOfferSpec(prodId,this.prodOfferId);if(this.state=="DEL"){if(offer!=undefined&&offer.isdel!="Y"){param.objId=this.prodOfferInstId;param.status=(offer.isdel!=undefined?offer.isdel:"N");param.objIdType=3;offer.isdel="Y";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="Y";AttachOffer.changeList.push(param)}}}else{if(this.state=="ADD"){if(offer!=undefined&&offer.isdel=="Y"){param.objId=this.prodOfferInstId;param.status=offer.isdel;param.objIdType=3;offer.isdel="N";AttachOffer.changeList.push(param)}else{if(offerSpec!=undefined&&offerSpec.isdel=="Y"){param.objId=this.prodOfferId;param.status=offerSpec.isdel;param.objIdType=4;offerSpec.isdel="N";AttachOffer.changeList.push(param)}else{if(offer==undefined&&offerSpec==undefined){param.objId=this.prodOfferId;param.status="Y";param.objIdType=4;AttachOffer.changeList.push(param);if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){var newOfferSpec=_setSpec(prodId,this.prodOfferId);newOfferSpec.isdel="N"}}}}}}})}};var _reductionChangList=function(prodId){$.each(AttachOffer.changeList,function(){if(this.prodInstId==prodId){if(this.objIdType==1){var serv=CacheData.getServ(prodId,this.objId);if(serv!=undefined){serv.isdel=this.status}}else{if(this.objIdType==2){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec!=undefined){servSpec.isdel=this.status}}else{if(this.objIdType==3){var offer=CacheData.getOffer(prodId,this.objId);if(offer!=undefined){offer.isdel=this.status}}else{if(this.objIdType==4){var offerSpec=CacheData.getOfferSpec(prodId,this.objId);if(offerSpec!=undefined){offerSpec.isdel=this.status}}}}}}})};var _servExDepReByRoleObjs=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);paramObj.excludeServ=[];paramObj.dependServ=[];paramObj.relatedServ=[];var globContent="";$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){var servSpec=CacheData.getServSpec(prodId,this.objId);if(servSpec==undefined){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv==undefined){var newServSpec={objId:this.objId,servSpecId:this.objId,servSpecName:this.objName,ifParams:this.isCompParam,prodSpecParams:this.prodSpecParams,isdel:"C"};CacheData.setServSpec(prodId,newServSpec);servSpec=newServSpec}else{servSpec=serv}}var servSpecId=servSpec.servSpecId;var param=CacheData.getExcDepServParam(prodId,servSpecId);if(param.orderedServSpecIds.length==0){}else{var data=query.offer.queryExcludeDepend(param);var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);if(content!=""){content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);globContent+=(content+"<br>")}}}})});return globContent};var paramObj={excludeServ:[],dependServ:[],relatedServ:[]};var paserServDataByObjs=function(result,prodId,serv,newSpec){var servExclude=result.servSpec.exclude;var servDepend=result.servSpec.depend;var servRelated=result.servSpec.related;var content="";if(ec.util.isArray(servExclude)){$.each(servExclude,function(){var servList=CacheData.getServList(prodId);var flag=true;if(servList!=undefined){for(var i=0;i<servList.length;i++){if(servList[i].isdel=="Y"){if(servList[i].servSpecId==this.servSpecId){flag=false;break}}}}if(flag){content+="需要关闭：   "+this.servSpecName+"<br>";paramObj.excludeServ.push(this)}})}if(ec.util.isArray(servDepend)){$.each(servDepend,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.dependServ.push(this)}})}if(ec.util.isArray(servRelated)){$.each(servRelated,function(){if(!AttachOffer.filterServ(this.servSpecId,newSpec)){content+="需要开通：   "+this.servSpecName+"<br>";paramObj.relatedServ.push(this)}})}return content};var _filterServ=function(servSpecId,newSpec){var flag=false;$.each(newSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){if(servSpecId==this.objId){flag=true;return false}}})});if(!flag){if(ec.util.isArray(paramObj.dependServ)){for(var i=0;i<paramObj.dependServ.length;i++){if(servSpecId==paramObj.dependServ[i].servSpecId){flag=true;break}}}if(!flag){if(ec.util.isArray(paramObj.relatedServ)){for(var i=0;i<paramObj.relatedServ.length;i++){if(servSpecId==paramObj.relatedServ[i].servSpecId){flag=true;break}}}}}return flag};var _minQtyFileter=function(prodId,servSpecId){var serv=CacheData.getServBySpecId(prodId,servSpecId);var $li;if(serv!=undefined){$li=$("#li_"+prodId+"_"+serv.servId)}else{$li=$("#li_"+prodId+"_"+servSpecId)}if($li!=undefined){$li.find(".delete").remove();$li.append('<dd class="mustchoose"></dd>')}};var _manyPhoneFilter=function(prodId,offerSpecId){if(OrderInfo.actionFlag==14){return true}var newSpec;var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(ec.util.isObj(offer)){newSpec=offer}else{newSpec=_setSpec(prodId,offerSpecId)}if(newSpec==undefined){return false}if(ec.util.isArray(newSpec.agreementInfos)){var num=0;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.objType==CONST.OBJ_TYPE.PROD){num++}})})}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){num++}})}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==prodId){num++}})}}}var minNum=newSpec.agreementInfos[0].minNum;var maxNum=newSpec.agreementInfos[0].maxNum;if(!ec.util.isObj(minNum)){$.alert("信息提示","销售品规格查询，未返回最小合约数，请后台确认。");return false}if(num<minNum){$.alert("信息提示","该合约的最小合约数为"+minNum+"个，而该套餐的成员实例只有"+num+"个，故无法办理该合约。");return false}if(maxNum>num){newSpec.agreementInfos[0].maxNum=num}}return true};var _addAndDelTerminal=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var fag=$(obj).attr("fag");var newSpec;var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(ec.util.isObj(offer)){newSpec=offer}else{newSpec=_setSpec(prodId,offerSpecId)}var objInstId=prodId+"_"+newSpec.offerSpecId;var maxNum=newSpec.agreementInfos[0].maxNum;var minNum=newSpec.agreementInfos[0].minNum;var $ul=$("#ul_"+objInstId);var $li=$("#ul_"+objInstId+" li");var length=$li.length-1;var isFastOffer=0;if(ec.util.isArray(newSpec.extAttrParams)){$.each(newSpec.extAttrParams,function(){if(this.attrId==CONST.OFFER_FAST_FILL){isFastOffer=1;return false}})}if(fag==0){if(totalNums>=maxNum){$.alert("信息提示","终端数已经达到最大，不能再添加了。");return}var $liTerminalAdd=$('<li style="width:700px;"><label>终端校验：</label><input id="terminalText_'+objInstId+"_"+(length/2+1)+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><input id="terminalBtn_'+objInstId+"_"+(length/2+1)+'" type="button" flag="'+isFastOffer+'" num="'+(length/2+1)+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" value="校验" class="purchase" style="float:left"></input></li>');var $liAdd=$('<li id="terminalDesc_'+(length/2+1)+'" style="white-space:nowrap;width:700px;"><label></label><label id="terminalName_'+(length/2+1)+'"></label></li>');$ul.append($liTerminalAdd).append($liAdd);totalNums++}else{if(minNum==(length/2)){$.alert("信息提示","终端数已经达到最小，不能再删除了。");
return}$li.each(function(index){if(length-1==index){$(this).remove()}else{if(length==index){_filterAttach2Coupons(prodId,offerSpecId,(index/2));$(this).remove()}}});totalNums--}};var _checkData=function(objInstId,terminalCode){var $input=$("input[id^=terminalText_"+objInstId+"]");var num=0;$input.each(function(){var instCode=$.trim(this.value);if(ec.util.isObj(instCode)&&terminalCode==instCode){num++}});if(num>=2){$.alert("信息提示","终端串码重复了，请填写不同的串码。");return true}return false};var _filterAttach2Coupons=function(prodId,offerSpecId,num){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId&&attach2Coupon.num==num){OrderInfo.attach2Coupons.splice(i,1);$("#terminalName_"+num).html("");break}}};var _removeAttach2Coupons=function(prodId,offerSpecId){for(var i=0;i<OrderInfo.attach2Coupons.length;i++){var attach2Coupon=OrderInfo.attach2Coupons[i];if(offerSpecId==attach2Coupon.attachSepcId&&prodId==attach2Coupon.prodId){OrderInfo.attach2Coupons.splice(i,1);i--}}};var _ifOrderAgain=function(newSpec){if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){if(parseInt(newSpec.orderCount)<newSpec.counts){$.alert("信息提示","可选包："+newSpec.offerSpecName+"至多只能订购"+newSpec.orderCount+"次");return true}}};var _setParam=function(prodId,offerSpecId,flag){var newSpec=_setSpec(prodId,offerSpecId);var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);if(flag==1){newSpec.counts=offer.counts}var content='<form id="paramForm">';content+='次数 : <input id="text_'+prodId+"_"+offerSpecId+'" class="inputWidth183px" type="text" value="'+newSpec.counts+'"><br>';content+="</form>";$.confirm("参数设置： ",content,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(event,form){var nums=$("#text_"+prodId+"_"+offerSpecId).val();var reg=/^\+?[1-9][0-9]*$/;if(!reg.test(nums)){$.alert("信息提示","次数只能是正整数。");return}if(parseInt(newSpec.orderCount)<nums){$.alert("信息提示","可选包【"+newSpec.offerSpecName+"】至多只能订购"+newSpec.orderCount+"次");return}if(flag==1&&offer!=undefined){if(offer.orderCount>nums){if(!ec.util.isArray(offer.offerMemberInfos)){var param={prodId:prodId,areaId:OrderInfo.getProdAreaId(prodId),offerId:offer.offerId};param.acctNbr=OrderInfo.getAccessNumber(prodId);var data=query.offer.queryOfferInst(param);if(data==undefined){return}offer.offerMemberInfos=data.offerMemberInfos;offer.offerSpec=data.offerSpec}}offer.counts=nums}else{newSpec.counts=nums}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})};var _offerSpecDetail=function(prodId,offerSpecId){var offerSpecName="";var summary="";$.each(AttachOffer.allOfferList,function(){if(this.offerSpecId==offerSpecId){offerSpecName=this.offerSpecName;summary=this.summary}else{if(this.servSpecId==offerSpecId){offerSpecName=this.servSpecName;summary=this.summary}}});$("#detail_tbody").empty();var $tr=$("<tr></tr>");$tr.append("<td>"+offerSpecName+'</td><td width="900">'+summary+"</td>");$("#detail_tbody").append($tr);easyDialog.open({container:"div_detail_dialog"})};var _queryCardAttachOffer=function(cardTypeFlag){var prodInfo=order.prodModify.choosedProdInfo;var prodId=prodInfo.prodInstId;var param={prodId:prodId,prodSpecId:prodInfo.productId,offerSpecId:prodInfo.prodOfferId,acctNbr:prodInfo.accNbr};if(ec.util.isObj(prodInfo.prodBigClass)){param.prodBigClass=prodInfo.prodBigClass}var data=query.offer.queryAttachOfferHtml(param);$("#attach").html(data).show();var temp={boActionTypeCd:"14",cardType:cardTypeFlag=="1"?"4G":"3G",accNbr:prodInfo.accNbr,prodInstId:prodId,prodId:prodId,prodSpecId:prodInfo.productId};var data=query.offer.queryDefMustOfferSpecAndServ(temp);CacheData.parseOffer(data);CacheData.parseServ(data);if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){var member=CacheData.getOfferMember(prodId);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==member.offerRoleId&&member.objType==CONST.OBJ_TYPE.PROD){var offerRole=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var serv=CacheData.getServBySpecId(prodId,this.objId);if(serv!=undefined){var $oldLi=$("#li_"+prodId+"_"+serv.servId);if(this.minQty==1){$oldLi.append('<dd class="mustchoose"></dd>')}$oldLi.append('<dd id="jue_'+prodId+"_"+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>')}}});return false}})}};var _delOfferSpecReload=function(prodId,offerSpecId){var $span=$("#li_"+prodId+"_"+offerSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.addOfferSpec(prodId,offerSpecId)}else{var spec=CacheData.getOfferSpec(prodId,offerSpecId);var content=CacheData.getOfferProdStr(prodId,spec,2);$span.addClass("del");spec.isdel="Y";delServSpec(prodId,spec);order.dealer.removeAttDealer(prodId+"_"+offerSpecId);$("#terminalUl_"+prodId+"_"+offerSpecId).remove();spec.isTerminal=0}};var _closeServSpecReload=function(prodId,servSpecId,specName,ifParams){var $span=$("#li_"+prodId+"_"+servSpecId).find("span");if($span.attr("class")=="del"){AttachOffer.openServSpecReload(prodId,servSpecId,specName,ifParams)}else{var spec=CacheData.getServSpec(prodId,servSpecId);if(spec==undefined){return}$span.addClass("del");spec.isdel="Y";_showHideUim(1,prodId,servSpecId);var serv=CacheData.getServBySpecId(prodId,servSpecId);if(ec.util.isObj(serv)){$span.addClass("del");serv.isdel="Y"}}};var _addOfferSpecReload=function(prodId,offerSpecId){var newSpec=_setSpec(prodId,offerSpecId);if(newSpec==undefined){return}var content=CacheData.getOfferProdStr(prodId,newSpec,0);CacheData.setServ2OfferSpec(prodId,newSpec);_checkOfferExcludeDepend(prodId,newSpec)};var _openServSpecReload=function(prodId,servSpecId,specName,ifParams){var servSpec=CacheData.getServSpec(prodId,servSpecId);if(servSpec==undefined){var newSpec={objId:servSpecId,servSpecId:servSpecId,servSpecName:specName,ifParams:ifParams,isdel:"C"};var inPamam={prodSpecId:servSpecId};if(ifParams=="Y"){var data=query.prod.prodSpecParamQuery(inPamam);if(data==undefined||data.result==undefined){return}newSpec.prodSpecParams=data.result.prodSpecParams;if(servSpecId==CONST.YZFservSpecId){var feeType=$("select[name='pay_type_-1']").val();if(feeType==undefined){feeType=order.prodModify.choosedProdInfo.feeType}if(feeType==CONST.PAY_TYPE.AFTER_PAY){for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];prodSpecParam.setValue=""}}else{for(var j=0;j<newSpec.prodSpecParams.length;j++){var prodSpecParam=newSpec.prodSpecParams[j];if(prodSpecParam.value!=""){prodSpecParam.setValue=prodSpecParam.value}else{if(!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!=""){prodSpecParam.setValue=prodSpecParam.valueRange[0].value}}}}}}CacheData.setServSpec(prodId,newSpec);servSpec=newSpec}_checkServExcludeDepend(prodId,servSpec)};var _checkTerminalCodeReload=function(obj){var prodId=$(obj).attr("prodId");var offerSpecId=$(obj).attr("offerSpecId");var num=$(obj).attr("num");var flag=$(obj).attr("flag");if(flag==undefined){flag=0}_filterAttach2Coupons(prodId,offerSpecId,num);var objInstId=prodId+"_"+offerSpecId;var resIdArray=[];var terminalGroupIdArray=[];$("#"+objInstId+"  option").each(function(){resIdArray.push($(this).val())});$("#group_"+objInstId+"  option").each(function(){terminalGroupIdArray.push($(this).val())});var resId=resIdArray.join("|");var terminalGroupId=terminalGroupIdArray.join("|");if((resId==undefined||$.trim(resId)=="")&&(terminalGroupId==undefined||$.trim(terminalGroupId)=="")){$.alert("信息提示","终端规格不能为空！");return}var instCode=$("#terminalText_"+objInstId+"_"+num).val();if(instCode==undefined||$.trim(instCode)==""){$.alert("信息提示","终端串码不能为空！");return}if(_checkData(objInstId,instCode)){return}var param={instCode:instCode,flag:flag,mktResId:resId,termGroup:terminalGroupId};var data=query.prod.checkTerminal(param);if(data==undefined){return}var activtyType="";for(var i=0;i<AttachOffer.openList.length;i++){var open=AttachOffer.openList[i];for(var j=0;j<open.specList.length;
j++){var spec=open.specList[j];if(spec.isdel!="Y"&&spec.isdel!="C"&&ec.util.isArray(spec.agreementInfos)){if(spec.agreementInfos[0].activtyType==2){activtyType="2"}}}}if(data.statusCd==CONST.MKTRES_STATUS.USABLE||(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2")){var mktPrice=0;var mktColor="";if(ec.util.isArray(data.mktAttrList)){$.each(data.mktAttrList,function(){if(this.attrId=="65010058"){mktPrice=this.attrValue}else{if(this.attrId=="60010004"){mktColor=this.attrValue}}})}$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");$("#terminalDesc_"+num).css("display","block");var coupon={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:data.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:data.mktResStoreId,storeName:"1",agentId:1,apCharge:mktPrice,couponInstanceNumber:data.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:prodId,offerId:-1,attachSepcId:offerSpecId,state:"ADD",relaSeq:"",num:num};if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE&&activtyType=="2"){coupon.couponSource="2"}if(CONST.getAppDesc()==0){coupon.termTypeFlag=data.termTypeFlag}OrderInfo.attach2Coupons.push(coupon)}else{if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用")}else{$.alert("提示",data.message)}}};var _delServSpec=function(prodId,offerSpec){$.each(offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){var servSpecId=this.objId;if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){var spec=CacheData.getServSpec(prodId,servSpecId);if(ec.util.isObj(spec)){spec.isdel="Y";var $li=$("#li_"+prodId+"_"+servSpecId);$li.removeClass("canshu").addClass("canshu2");$li.find("span").addClass("del");_showHideUim(1,prodId,servSpecId)}}})})};return{excludeAddServ:excludeAddServ,addOffer:_addOffer,addOfferSpec:_addOfferSpec,addOpenList:_addOpenList,addOpenServList:_addOpenServList,addOfferSpecByCheck:_addOfferSpecByCheck,addAndDelTerminal:_addAndDelTerminal,closeAttachSearch:_closeAttachSearch,changeLabel:_changeLabel,changeList:_changeList,closeServ:_closeServ,closeServSpec:_closeServSpec,checkData:_checkData,delOffer:_delOffer,delOfferSpec:_delOfferSpec,labelList:_labelList,isChangeUim:_isChangeUim,init:_init,openList:_openList,openedList:_openedList,openServList:_openServList,openedServList:_openedServList,openServSpec:_openServSpec,openAppList:_openAppList,queryAttachOffer:_queryAttachOffer,queryAttachOfferSpec:_queryAttachOfferSpec,queryCardAttachOffer:_queryCardAttachOffer,showParam:_showParam,showServParam:_showServParam,showTime:_showTime,setAttachTime:_setAttachTime,searchAttachOfferSpec:_searchAttachOfferSpec,selectAttachOffer:_selectAttachOffer,showOfferTime:_showOfferTime,showMainParam:_showMainParam,showMainMember:_showMainMember,selectServ:_selectServ,showStartTime:_showStartTime,showEndTime:_showEndTime,setAttachBusiOrder:_setAttachBusiOrder,showApp:_showApp,showHideUim:_showHideUim,showMainRoleProd:_showMainRoleProd,checkTerminalCode:_checkTerminalCode,checkOfferExcludeDepend:_checkOfferExcludeDepend,checkServExcludeDepend:_checkServExcludeDepend,servExDepReByRoleObjs:_servExDepReByRoleObjs,setChangeList:_setChangeList,reductionChangList:_reductionChangList,filterServ:_filterServ,setParam:_setParam,showMainMemberRoleProd:_showMainMemberRoleProd,offerSpecDetail:_offerSpecDetail,delOfferSpecReload:_delOfferSpecReload,closeServSpecReload:_closeServSpecReload,addOfferSpecReload:_addOfferSpecReload,openServSpecReload:_openServSpecReload,checkTerminalCodeReload:_checkTerminalCodeReload,changereserveCode:_changereserveCode,delServSpec:_delServSpec,setSpec:_setSpec}})();CommonUtils.regNamespace("CacheData");CacheData=(function(){var y=function(Q,R){R.isdel="C";R.counts=1;var N=true;for(var P=0;P<AttachOffer.openList.length;P++){var O=AttachOffer.openList[P];if(O.prodId==Q){N=false;break}}if(N){var O={prodId:Q,specList:[]};AttachOffer.openList.push(O)}CacheData.getOfferSpecList(Q).push(R)};var i=function(R,O){O.isdel="C";if(O.servSpecId==undefined){O.servSpecId=O.objId}if(O.servSpecName==undefined){O.servSpecName=O.objName}var N=true;for(var Q=0;Q<AttachOffer.openServList.length;Q++){var P=AttachOffer.openServList[Q];if(P.prodId==R){N=false;break}}if(N){var P={prodId:R,servSpecList:[]};AttachOffer.openServList.push(P)}CacheData.getServSpecList(R).push(O)};var I=function(N,O){if(O!=undefined){$.each(O.offerRoles,function(){$.each(this.roleObjs,function(){if($("#check_"+N+"_"+this.objId).attr("checked")=="checked"){this.selQty=1}else{this.selQty=2}})})}};var w=function(U){if(U.dependOffer.offerGrpInfos.length>0){var T=U.dependOffer;for(var Q=0;Q<T.offerGrpInfos.length;Q++){var S=T.offerGrpInfos[Q];var R=$("input[name="+S.grpId+"]:checked");var N=R.length;T.offerGrpInfos[Q].checkLen=N;for(var P=0;P<S.subOfferSpecInfos.length;P++){var O=S.subOfferSpecInfos[P];R.each(function(){if($(this).val()==O.offerSpecId){O.isCheck=true}})}}}};var n=function(R,O,N){var Q='<form id="paramForm"><table>';if(N==2){if(ec.util.isArray(O.prodSpecParams)){for(var P=0;P<O.prodSpecParams.length;P++){var T=O.prodSpecParams[P];if(T.value==undefined){T.value=""}Q+=z(R,T,O.servSpecId,T.itemSpecId,T.value)}}}else{if(N==3){if(ec.util.isArray(O.prodSpecParams)){for(var P=0;P<O.prodSpecParams.length;P++){var T=O.prodSpecParams[P];if(ec.util.isArray(O.prodInstParams)){$.each(O.prodInstParams,function(){if(this.itemSpecId==T.itemSpecId){T.value=this.value}})}if(T.value==undefined){T.value=""}Q+=z(R,T,O.servSpecId,T.itemSpecId,T.value)}}}else{if(N==1){if(O.offerSpec!=undefined){if(ec.util.isArray(O.offerSpec.offerSpecParams)){var S=O.offerSpec.offerSpecParams;$.each(S,function(){var U=this;if(ec.util.isArray(O.offerParamInfos)){$.each(O.offerParamInfos,function(){if(this.itemSpecId==U.itemSpecId){U.value=this.value}})}Q+=z(R,this,O.servSpecId,this.itemSpecId,this.value)})}}}else{if(ec.util.isArray(O.offerSpecParams)){var S=O.offerSpecParams;$.each(S,function(){Q+=z(R,this,O.servSpecId,this.itemSpecId,this.value)})}}}}Q+="</table></form>";return Q};var C=function(P,O){var N=$('<form id="appForm"></form>');if(!!O&&O.length>0){$.each(O,function(){var Q=$('<input id="'+P+"_"+this.objId+'" name="'+P+'" type="checkbox">'+this.objName+"</input></br>");if(this.minQty==0){if(this.dfQty>0){Q.attr("checked","checked")}}else{if(this.minQty>0){Q.attr("checked","checked");Q.attr("disabled","disabled")}}N.append(Q)})}return N};var z=function(T,P,Y){var R=P.itemSpecId;if(P.setValue==undefined){P.setValue=P.value}var X=P.setValue;var O="";var Q="";if(!!P.valueRange&&R==11251741){O=O+P.name+": <input id='input1' name='input1' type='text' class='cssINPUT'  style='height: 19px; display: block; float: left; position: absolute; border-right: 0px;'><label class='f_red'>*</label><br>";O=O+"<select id='select1'  name='select1' class='cssINPUT' data-validate='validate(required:请在下拉框中选择协议编码) on(blur)' style='float: left;display: none; height: 27PX; position: absolute; cursor: pointer; margin-left: 2px;  padding: 0px;'>";Q+='<option style="display:none" value=""></option>';for(var S=0;S<P.valueRange.length;S++){var V=P.valueRange[S];if(V.value==P.setValue){Q+='<option value="'+V.value+'" selected="selected" >'+V.text+"</option>"}else{Q+='<option value="'+V.value+'">'+V.text+"</option>"}}O+=Q+"</select><br>";O=O+"<div id='div1' style='position: absolute;top:77px;'></div>";return O}if(!!P.valueRange&&(R==CONST.YZFitemSpecId1||R==CONST.YZFitemSpecId2||R==CONST.YZFitemSpecId3)){var U=$("select[name='pay_type_-1']").val();if(U==undefined){U=order.prodModify.choosedProdInfo.feeType}if(U==CONST.PAY_TYPE.BEFORE_PAY){if(P.rule.isConstant=="Y"){O=O+"<tr><td>"+P.name+": </td><td><select class='inputWidth183px' id="+T+"_"+R+" disabled='disabled'>"}else{if(P.rule.isOptional=="N"){O=O+"<tr><td>"+P.name+": </td><td><select class='inputWidth183px' id="+T+"_"+R+" data-validate='validate(required,reg:"+P.rule.maskMsg+"("+P.rule.mask+")) on(blur)'><label class='f_red'>*</label><br>"
}else{O=O+"<tr><td>"+P.name+": </td><td><select class='inputWidth183px' id="+T+"_"+R+"><br>"}}for(var S=0;S<P.valueRange.length;S++){var V=P.valueRange[S];if(V.value==P.setValue){Q+='<option value="'+V.value+'" selected="selected" >'+V.text+"</option>"}else{Q+='<option value="'+V.value+'">'+V.text+"</option>"}}O+=Q+"</select></td></tr>";return O}else{if(U==CONST.PAY_TYPE.AFTER_PAY){O=O+"<tr><td>"+P.name+":</td><td> <select class='inputWidth183px' id="+T+"_"+R+" disabled='disabled'>";Q+='<option value="" selected="selected">不可选</option>';O+=Q+"</select></td></tr>";return O}}}if(ec.util.isArray(P.valueRange)){if(P.rule.isConstant=="Y"){O=P.name+": <select class='inputWidth183px' id="+T+"_"+R+" disabled='disabled'>"}else{if(P.rule.isOptional=="N"){O=P.name+": <select class='inputWidth183px' id="+T+"_"+R+" data-validate='validate(required,reg:"+P.rule.maskMsg+"("+P.rule.mask+")) on(blur)'><label class='f_red'>*</label><br>"}else{O=P.name+": <select class='inputWidth183px' id="+T+"_"+R+"><br>";Q+='<option value="" >请选择</option>'}}for(var S=0;S<P.valueRange.length;S++){var V=P.valueRange[S];if(V.value==P.setValue){Q+='<option value="'+V.value+'" selected="selected" >'+V.text+"</option>"}else{Q+='<option value="'+V.value+'">'+V.text+"</option>"}}O+=Q+"</select><br>"}else{if(P.dataTypeCd==1){if(P.rule==undefined){O+=P.name+' : <input id="'+T+"_"+R+'" class="inputWidth183px" type="text" value="'+X+'" ><br>'}else{if(P.rule.isConstant=="Y"){O+=P.name+' : <input id="'+T+"_"+R+'" class="inputWidth183px" type="text" disabled="disabled" value="'+X+'" >';if(ec.util.isObj(Y)&&ec.util.isObj(CONST.getGroupServProdMap(Y,R))){var W=CONST.getGroupServProdMap(Y,R);var N=T+"_"+Y+"_"+R;O+='<a class="purchase" href="javascript:order.main.queryGroup('+W+",0,'"+N+"');\">选择</a>"}O+="<br>"}else{if(P.rule.isOptional=="N"){if(OrderInfo.isGroupProSpecId(Y)){O+=P.name+' : <input id="'+T+"_"+R+'" class="inputWidth183px" type="text" mask="'+P.rule.mask+'" maskmsg="'+P.rule.maskMsg+'" value="'+X+'" ><label style="color: #ff0000;float:right;margin-right:40px;">*</label><br>'}else{O+=P.name+' : <input id="'+T+"_"+R+'" class="inputWidth183px" type="text" mask="'+P.rule.mask+'" maskmsg="'+P.rule.maskMsg+'" value="'+X+'" ><label class="f_red">*</label><br>'}}else{O+=P.name+' : <input id="'+T+"_"+R+'" class="inputWidth183px" type="text" mask="'+P.rule.mask+'" maskmsg="'+P.rule.maskMsg+'" value="'+X+'" ><br>'}}}}else{if(P.dataTypeCd==8){if(P.rule==undefined){O+=P.name+' : <input id="'+T+"_"+R+'" class="inputWidth183px" type="password" value="'+X+'" ><br>'}else{if(P.rule.isConstant=="Y"){O+=P.name+' : <input id="'+T+"_"+R+'" class="inputWidth183px" type="password"  disabled="disabled" value="'+X+'" ><br>'}else{if(P.rule.isOptional=="N"){O+=P.name+' : <input id="'+T+"_"+R+'" class="inputWidth183px" type="password" data-validate="validate(required,reg:'+P.rule.maskMsg+"("+P.rule.mask+')) on(blur)" value="'+X+'" ><label class="f_red">*</label><br>'}else{O+=P.name+' : <input id="'+T+"_"+R+'" class="inputWidth183px" type="password" data-validate="validate(reg:'+P.rule.maskMsg+"("+P.rule.mask+')) on(blur)" value="'+X+'" ><br>'}}}}else{if(P.dataTypeCd==4){}}}}return O};var v=function(Q,O,N){var P='<form id="paramForm">';var R="";if(N==0){$.each(O.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4){if(this.minQty==0&&this.maxQty>0&&this.dfQty>0){R+='<input id="check_'+Q+"_"+this.objId+'" type="checkbox" checked="checked">'+this.objName+"<br>"}else{if(this.minQty>0){R+='<input id="check_'+Q+"_"+this.objId+'"  type="checkbox" checked="checked" disabled="disabled">'+this.objName+"<br>"}else{if(this.minQty==0&&this.maxQty>0&&this.dfQty==0){R+='<input id="check_'+Q+"_"+this.objId+'" type="checkbox">'+this.objName+"<br>"}}}}})});if(R==""){P="订购【"+O.offerSpecName+"】可选包"}else{P="订购【"+O.offerSpecName+"】可选包，需要开通以下勾选的功能产品：<br>"+R}}else{if(N==1){$.each(O.offerMemberInfos,function(){var S=this;$.each(O.offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(S.objId==this.objId&&this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){var T=S.objInstId;if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE&&this.minQty<=0){R+='<input id="check_'+Q+"_"+T+'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+"<br>"}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE&&this.minQty<=0){R+='<input id="check_'+Q+"_"+T+'" type="checkbox" checked="checked">'+this.objName+"<br>"}}}})})});if(R==""){P="退订【"+O.offerSpecName+"】可选包"}else{P="退订【"+O.offerSpecName+"】可选包，需要关闭以下勾选的功能产品：<br>"+R}}else{if(N==2){$.each(O.offerRoles,function(){$.each(this.roleObjs,function(){if(this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE&&this.minQty<=0){R+='<input id="check_'+Q+"_"+this.objId+'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+"<br>"}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE&&this.minQty<=0){R+='<input id="check_'+Q+"_"+this.objId+'" type="checkbox" checked="checked">'+this.objName+"<br>"}}}})});if(R==""){P="取消订购【"+O.offerSpecName+"】可选包"}else{P="取消订购【"+O.offerSpecName+"】可选包，需要取消开通以下勾选的功能产品：<br>"+R}}}}P+="</form>";return P};var q=function(O,Q){if(ec.util.isArray(Q.offerSpecParams)){for(var N=0;N<Q.offerSpecParams.length;N++){var P=Q.offerSpecParams[N];if(ec.util.isArray(P.valueRange)){if(P.value==undefined||P.value==""){if(P.rule.isOptional=="N"){return false}}}else{if(P.value==undefined||P.value==""){if(P.rule.isOptional=="N"){return false}}}}}Q.isset="Y";return true};var b=function(P,N){if(ec.util.isArray(N.prodSpecParams)){for(var O=0;O<N.prodSpecParams.length;O++){var Q=N.prodSpecParams[O];if(ec.util.isArray(Q.valueRange)){if(Q.value==undefined||Q.value==""){if(Q.rule.isOptional=="N"){return false}}}else{if(Q.value==undefined||Q.value==""){if(Q.rule.isOptional=="N"){return false}}}}}N.isset="Y";return true};var D=function(P){for(var O=0;O<AttachOffer.openList.length;O++){var N=AttachOffer.openList[O];if(N.prodId==P){return N.specList}}return[]};var h=function(P,Q){var N=D(P);if(N!=undefined){for(var O=0;O<N.length;O++){if(N[O].offerSpecId==Q){return N[O]}}}};var A=function(Q,R,O){var N=h(Q,R);if(ec.util.isObj(N)){for(var P=0;P<N.offerSpecParams.length;P++){if(N.offerSpecParams[P].itemSpecId==O){return N.offerSpecParams[P]}}}};var l=function(R,U,O){var V=h(R,U);if(!!V.offerRoles){for(var Q=0;Q<V.offerRoles.length;Q++){var T=V.offerRoles[Q];for(var P=0;P<T.roleObjs.length;P++){var S=T.roleObjs[P];if(S.prodSpecParams!=undefined&&S.prodSpecParams.length>0){for(var N=0;N<S.prodSpecParams.length;N++){if(S.prodSpecParams[N].itemSpecId==O){return S.prodSpecParams[N]}}}}}}};var m=function(O){for(var N=0;N<AttachOffer.openedList.length;N++){var P=AttachOffer.openedList[N];if(P.prodId==O){return P.offerList}}return[]};var J=function(Q,N){var O=m(Q);if(ec.util.isArray(O)){for(var P=0;P<O.length;P++){if(O[P].offerId==N){return O[P]}}}};var p=function(P,Q){var N=m(P);if(ec.util.isArray(N)){for(var O=0;O<N.length;O++){if(N[O].offerSpecId==Q){return N[O]}}}};var o=function(R,N,O){var Q=J(R,N);if(ec.util.isArray(Q.offerSpec.offerSpecParams)){for(var P=0;P<Q.offerSpec.offerSpecParams.length;P++){if(Q.offerSpec.offerSpecParams[P].itemSpecId==O){return Q.offerSpec.offerSpecParams[P]}}}};var E=function(T,R,N){var U=J(T,R);if(ec.util.isArray(U.offerMembers)){for(var S=0;S<U.offerMembers.length;S++){var P=U.offerMembers[S];for(var Q=0;Q<P.prodParamInfos.length;Q++){for(var O=0;O<P.prodParamInfos.length;O++){var V=P.prodParamInfos[O];if(V.itemSpecId==N){return V}}}}}};var c=function(P){for(var O=0;O<AttachOffer.openServList.length;O++){var N=AttachOffer.openServList[O];if(N.prodId==P){return N.servSpecList}}return[]};var L=function(P,Q){var N=c(P);if(N!=undefined){for(var O=0;O<N.length;O++){if(N[O].servSpecId==Q){return N[O]}}}};var t=function(Q,R,O){var N=L(Q,R);if(ec.util.isArray(N.prodSpecParams)){for(var P=0;P<N.prodSpecParams.length;P++){if(N.prodSpecParams[P].itemSpecId==O){return N.prodSpecParams[P]}}}};var f=function(O){for(var N=0;
N<AttachOffer.openedServList.length;N++){var P=AttachOffer.openedServList[N];if(P.prodId==O){return P.servList}}return[]};var a=function(P,Q){var O=f(P);if(ec.util.isArray(O)){for(var N=0;N<O.length;N++){if(O[N].servId==Q){return O[N]}}}};var F=function(P,Q){var O=f(P);if(ec.util.isArray(O)){for(var N=0;N<O.length;N++){if(O[N].servSpecId==Q){return O[N]}}}};var K=function(Q,S,N){var R=a(Q,S);if(ec.util.isArray(R.prodSpecParams)){for(var O=0;O<R.prodSpecParams.length;O++){var P=R.prodSpecParams[O];if(P.itemSpecId==N){return P}}}};var r=function(P){for(var O=0;O<AttachOffer.openAppList.length;O++){var N=AttachOffer.openAppList[O];if(N.prodId==P){return N.appList}}return[]};var g=function(P){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){for(var N=0;N<OrderInfo.offer.offerMemberInfos.length;N++){var O=OrderInfo.offer.offerMemberInfos[N];if(O.objInstId==P){return O}}}return{}};var x=function(Q){for(var N=0;N<OrderInfo.oldoffer.length;N++){for(var O=0;O<OrderInfo.oldoffer[N].offerMemberInfos.length;O++){var P=OrderInfo.oldoffer[N].offerMemberInfos[O];if(P.objInstId==Q){return P}}}return{}};var s=function(P,R){var Q={servSpecId:R,prodId:P,orderedServSpecIds:[]};var N=CacheData.getServSpecList(P);if(ec.util.isArray(N)){$.each(N,function(){if(this.servSpecId!=R&&this.isdel!="Y"&&this.isdel!="C"){Q.orderedServSpecIds.push(this.servSpecId)}})}var O=CacheData.getServList(P);if(ec.util.isArray(O)){$.each(O,function(){if(this.servSpecId!=R&&this.isdel!="Y"&&this.isdel!="C"){Q.orderedServSpecIds.push(this.servSpecId)}})}return Q};var k=function(P,S){var R={prodId:P,offerSpecId:S,objType:CONST.OBJ_TYPE.PROD,orderedOfferSpecIds:[]};var Q=CacheData.getOfferSpec(P,S);if(ec.util.isObj(Q)){if(ec.util.isArray(Q.offerRoles)){$.each(Q.offerRoles,function(){if(ec.util.isArray(this.roleObjs)){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){R.offerRoleId=this.offerRoleId;R.objId=this.objId;return false}})}})}}else{var N=CacheData.getOfferBySpecId(P,S);if(ec.util.isObj(N)){R.offerRoleId=N.offerRoleId;if(ec.util.isArray(N.offerMemberInfos)){$.each(N.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){R.objId=this.objId;return false}})}}}var O=CacheData.getOfferSpecList(P);if(ec.util.isArray(O)){$.each(O,function(){if(this.offerSpecId!=S&&this.isdel!="Y"){if(this.offerSpecId!=undefined){R.orderedOfferSpecIds.push(this.offerSpecId)}}})}return R};var M=function(Q,T){if(ec.util.isObj(Q)){if(ec.util.isArray(Q.result.servSpec)){if(ec.util.isObj(T)){prodId=T}for(var P=0;P<Q.result.servSpec.length;P++){var O=Q.result.servSpec[P];var R=CacheData.getServBySpecId(prodId,O.servSpecId);var N=CacheData.getServSpec(prodId,O.servSpecId);if(O.ifDault==0||O.ifCanCancelDoublePackage=="N"){if(ec.util.isObj(R)){var S=$("#del_"+prodId+"_"+R.servId);if(ec.util.isObj(S)){S.removeClass("delete").addClass("mustchoose");S.removeAttr("onclick");R.isdel="N"}}else{if(ec.util.isObj(N)){var S=$("#del_"+prodId+"_"+N.servSpecId);if(ec.util.isObj(S)){S.removeClass("delete").addClass("mustchoose");S.removeAttr("onclick");N.isdel="N"}}else{if(OrderInfo.actionFlag==2){O.isdel="C";CacheData.setServSpec(prodId,O);AttachOffer.addOpenServList(prodId,O.servSpecId,O.servSpecName,O.ifParams)}}}}else{if((OrderInfo.actionFlag==2||OrderInfo.actionFlag==21||OrderInfo.actionFlag==22)&&O.ifDault==1){if(ec.util.isObj(R)){var S=$("#del_"+prodId+"_"+R.servId);if(ec.util.isObj(S)){R.isdel="N"}}else{if(ec.util.isObj(N)){var S=$("#del_"+prodId+"_"+N.servSpecId);if(ec.util.isObj(S)){N.isdel="N"}}else{O.isdel="C";CacheData.setServSpec(prodId,O);AttachOffer.addOpenServList(prodId,O.servSpecId,O.servSpecName,O.ifParams)}}}}}}}};var B=function(R,O){if(ec.util.isObj(R)){if(ec.util.isArray(R.result.offerSpec)){if(ec.util.isObj(O)){prodId=O}for(var S=0;S<R.result.offerSpec.length;S++){var P=R.result.offerSpec[S];if(P.ifDault==0||P.ifCanCancelDoublePackage=="N"){var X=CacheData.getOfferBySpecId(prodId,P.offerSpecId);if(ec.util.isObj(X)){var V=$("#del_"+prodId+"_"+X.offerId);if(ec.util.isObj(V)){V.removeClass("delete").addClass("mustchoose");V.removeAttr("onclick");X.isdel="N"}continue}var T=CacheData.getOfferSpec(prodId,P.offerSpecId);if(ec.util.isObj(T)){var V=$("#del_"+prodId+"_"+T.offerSpecId);if(ec.util.isObj(V)){V.removeClass("delete").addClass("mustchoose");V.removeAttr("onclick");T.isdel="N"}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21||OrderInfo.actionFlag==22){P.isdel="C";CacheData.setOfferSpec(prodId,P);var Q=CacheData.getExcDepOfferParam(prodId,P.offerSpecId);AttachOffer.addOpenList(prodId,P.offerSpecId);if(Q.orderedOfferSpecIds.length>0){var W=query.offer.queryExcludeDepend(Q);if(W!=undefined&&W.result!=undefined){var Y=W.result.offerSpec.exclude;if(ec.util.isArray(Y)){for(var S=0;S<Y.length;S++){var N=Y[S];var X=CacheData.getOfferBySpecId(prodId,N);if(X!=undefined){var U=$("#li_"+prodId+"_"+X.offerId).find("span");U.addClass("del");X.isdel="Y";var V=$("#del_"+prodId+"_"+X.offerId);if(ec.util.isObj(V)){V.removeClass("delete").addClass("mustchoose");V.removeAttr("onclick")}}}}}}}}}else{if(OrderInfo.actionFlag==22){P.isdel="C";CacheData.setOfferSpec(prodId,P);AttachOffer.addOpenList(prodId,P.offerSpecId)}}}}}};var u=function(N){var O="";if(N>0){if(OrderInfo.offer.offerMemberInfos!=undefined){$.each(OrderInfo.offer.offerMemberInfos,function(P){if(this.objInstId==N){O=this.offerRoleId;return false}})}}else{if(N<0){if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(Q){var P=this.offerRoleId;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==N){O=P;return false}})}})}}}return O};var H=function(Q){var N=[];for(var O=0;O<Q.offerMemberInfos.length;O++){var P=Q.offerMemberInfos[O];if(P.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){N.push(P)}}for(var O=0;O<Q.offerMemberInfos.length;O++){var P=Q.offerMemberInfos[O];if(P.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){N.push(P)}}Q.offerMemberInfos=N};var G=[];var j=function(){if(G.length==0){var R={partyTypeCd:2};var O=contextPath+"/cust/queryCertType";var N=$.callServiceAsJson(O,R,{});if(N.code==-2){$.alertM(N.data)}if(N.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(N.code==0){var Q=N.data;if(Q!=undefined&&Q.length>0){for(var P=0;P<Q.length;P++){G[P]=Q[P].certTypeCd}}}}return G};return{setParam:q,setServParam:b,setOfferSpec:y,setServSpec:i,setServ2OfferSpec:I,sortOffer:H,setOffer2ExcludeOfferSpec:w,getParamContent:n,getOfferSpecList:D,getOfferSpec:h,getSpecParam:A,getOfferList:m,getOffer:J,getOfferParam:o,getOfferBySpecId:p,getServList:f,getServ:a,getServBySpecId:F,getServSpec:L,getServSpecList:c,getProdInstParam:E,getProdSpecParam:l,getServInstParam:K,getServSpecParam:t,getOfferProdStr:v,getOpenAppList:r,getAppContent:C,getOfferMember:g,getExcDepServParam:s,getExcDepOfferParam:k,getOfferRoleId:u,parseServ:M,parseOffer:B,getOldOfferMember:x,getGovCertType:j}})();CommonUtils.regNamespace("order","calcharge");order.calcharge=(function(){var P=[];var k=[];var l=0;var R=0;var T=0;var M=0;var B="newOrder";var L=false;var m=false;var D=false;var v=[];var i=function(W,V){var U=$("#pro_"+W).html();if(U!=undefined&&U!=""){easyDialog.open({container:"moneyAdd"});$("#addContent").html("");$("#addContent").html(U);$("#moneyclose").off("click").on("click",function(X){easyDialog.close()});order.calcharge.trObj=V}else{$.alert("提示","没有可添加费用项的业务对象！")}};var c=function(ac,Z,W,V,aa,ab,U,Y){var ad="0";if(OrderInfo.actionFlag==11){ad="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){ad="2"}}var X={boId:ac,objInstId:U,prodId:Y,boActionTypeCd:Z,actionFlag:OrderInfo.actionFlag,objType:W,objId:V,itemNum:T,objName:aa,actionName:ab,refundType:ad};$.callServiceAsHtml(contextPath+"/order/getChargeAddByObjId",X,{before:function(){$.ecOverlay("<strong>正在增加收费项,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(ae){if(ae.code!=0){$.alert("提示","查询失败,稍后重试");return}g(ac,ae.data)},fail:function(ae){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var g=function(U,V){easyDialog.close();
if(V!=""){$(order.calcharge.trObj).parent().parent().after(V);T--;n()}else{$.alert("提示","没有可添加的费用项");return}};var A=function(V,X,W){if(W=="old"){var U=$("#feeAmount_"+X).val();if(($("#realAmount_"+X).val())*100==0){$("#realAmount_"+X).val(((U/100).toFixed(2))+"")}else{$("#realAmount_"+X).val("0")}var Y=($("#realAmount_"+X).val())*100;if(Y!=U){$("#chargeModifyReasonCd_"+X).show()}else{$("#chargeModifyReasonCd_"+X).hide()}}else{$(V).parent().parent().remove()}n()};var o=function(X,W,Z,Y){var V=w(W,Z,null);if(V){if(Y=="old"){var U=$("#feeAmount_"+Z).val();if(($("#realAmount_"+Z).val())*100!=0){$("#realAmount_"+Z).val(((U/100).toFixed(2))+"")}else{$("#realAmount_"+Z).val("0")}var aa=($("#realAmount_"+Z).val())*100;if(aa!=U){$("#chargeModifyReasonCd_"+Z).show()}else{$("#chargeModifyReasonCd_"+Z).hide()}}else{$(X).parent().parent().remove()}n()}};var n=function(){P=[];k=[];var V=0;$("#calTab tbody tr").each(function(){var X=$(this).attr("id");if(X!=undefined&&X!=""){X=X.substr(5,X.length);if($("#paymentAmount_"+X)&&$("#paymentAmount_"+X).val()*1==0){}else{var W=($("#realAmount_"+X).val())*1;if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){W=($("#backAmount_"+X).val())*1}V=V+W;C(X)}}});if(OrderInfo.actionFlag==15){var U=0;$("#calTab tbody tr").each(function(){var X=$(this).attr("id");if(X!=undefined&&X!=""){if($("#paymentAmount_"+X)&&$("#paymentAmount_"+X).val()*1==0){}else{X=X.substr(5,X.length);var W=($("#backAmount_"+X).val())*1;U=U+W}}});$("#backAmount").val(Number(U).toFixed(2))}$("#realmoney").val(Number(V).toFixed(2));if(OrderInfo.actionFlag==15){order.refund.conBtns()}else{x()}};var b=function(){var W=true;var V=true;var U=true;$("#calTab tbody tr").each(function(){var aa=$(this).attr("id");if(aa!=undefined&&aa!=""){aa=aa.substr(5,aa.length);var ab=$("#chargeModifyReasonCd_"+aa).val();if(ab=="1"){if($("#remark_"+aa).val()==undefined||$("#remark_"+aa).val()==null||$("#remark_"+aa).val()==""){W=false}}var Z=$("#payMethodCd_"+aa).val();var X=$("#terminalNumber").val();var Y=$("#serialNumber").val();if(Z=="110101"){if(X==undefined||$.trim(X)==""){U=false}if(Y==undefined||$.trim(Y)==""){U=false}if(X.length>100){V=false}if(Y.length>100){V=false}}else{if(Z=="110102"){D=true}}}});if(!W){$.alert("提示信息","请填写修改原因");return false}if(!U){$.alert("提示信息","pos流水号或者终端号不能为空，请重新输入！");return false}if(!V){$.alert("提示信息","pos流水号或者终端号长度超过100位，请重新输入！");return false}P=[];y();return true};var y=function(){$("#calTab tbody tr").each(function(){var am=$(this).attr("id");if(am!=undefined&&am!=""){am=am.substr(5,am.length);var V=($("#realAmount_"+am).val())*100+"";var ab=$("#feeAmount_"+am).val();var Y="";if(ab!=undefined&&ab!=""){Y=ab+""}else{Y=V}if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){Y=$("#feeAmount_"+am).val()*1+"";V=(0-($("#backAmount_"+am).val())*100)+""}var U=$("#acctItemTypeId_"+am).val();var ae=$("#objId_"+am).val();var ag=$("#objType_"+am).val();var ah=$("#acctItemId_"+am).val();var aj=$("#boId_"+am).val();var X=$("#payMethodCd_"+am).val();var W=$("#objInstId_"+am).val();var ai=$("#prodId_"+am).val();var ac=$("#boActionType_"+am).val();var af=$("#paymentAmount_"+am).val();var ad=1;var ak="";if($("#chargeModifyReasonCd_"+am).is(":hidden")){if(Y!=V){ak="其他"}}else{ad=$("#chargeModifyReasonCd_"+am).val();ak=$("#chargeModifyReasonCd_"+am).find("option:selected").text();if(ad=="1"){ak=$("#remark_"+am).val()}}var al="";var Z="";if(X=="110101"){al=$("#terminalNumber").val();Z=$("#serialNumber").val()}var aa={realAmount:V,feeAmount:Y,paymentAmount:af,acctItemTypeId:U,objId:ae,objType:ag,acctItemId:ah,boId:aj,prodId:ai,objInstId:W,payMethodCd:X,terminalNo:al,posSeriaNbr:Z,chargeModifyReasonCd:ad,remark:ak,boActionType:ac};P.push(aa)}})};var N=function(U){var V=$("#changeMethod_"+U).val();$("#payMethodCd_"+U).val(V)};var w=function(Y,ab,aa){var W={acctItemTypeId:Y};var U=contextPath+"/order/queryPayMethodByItem";var X=$.callServiceAsJson(U,W);if(X.code==0){if(X.data!=undefined&&X.data!=null){if(X.data.length>0){var ac=X.data;var ad=false;if(OrderInfo.actionFlag==11){if(ac[0].limitChange=="N"){if(aa=="110102"){ad=false}else{return true}}}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){if(ac[0].limitBuyBack=="N"){return true}}else{if(OrderInfo.actionFlag==15){if(ac[0].limitRedo=="N"){ad=true}}else{if(ac[0].limitChange=="N"){ad=true}}}}var ae=ac[0].payMethods;if(ae.length>0){if(ab){var V="'"+ab+"'";var Z="<select class='txt_cal_edit' id=\"changeMethod_"+ab+'" style="border: 1px solid #DCDCDC;height: 23px;line-height: 23px;padding: 1px; width: 120px;" onchange="order.calcharge.selectChangePayMethodCd('+V+')">';$.each(ae,function(af,ag){if(ag.payMethodCd==aa){Z+='<option value="'+ag.payMethodCd+'" selected="selected">'+ag.payMethodName+"</option>"}else{if(OrderInfo.actionFlag==11&&aa=="110102"){if(ag.payMethodCd=="100000"){Z+='<option value="'+ag.payMethodCd+'">'+ag.payMethodName+"</option>"}}else{Z+='<option value="'+ag.payMethodCd+'">'+ag.payMethodName+"</option>"}}});Z+="</select>";$("#payMethodText_"+ab).html(Z);v.push({trid:ab,payMethod:ae[0].payMethodCd});$("#changeMethod_"+ab).off("change").on("change",function(){for(var ag=0;ag<v.length;ag++){if(v[ag].trid==ab){v[ag].payMethod=$(this).val();break}}var af=0;for(var ag=0;ag<v.length;ag++){if(v[ag].payMethod=="110101"){af++}}if(af>0){$("#posDiv").css("display","inline");$("#posDiv").css("disabled","")}else{$("#posDiv").css("display","none");$("#posDiv").css("disabled","disabled")}})}}return ad}else{return false}}else{return false}}else{if(X.code==-2){$.alertM(X.data);return false}else{$.alert("提示","查询付费方式失败!");return false}}};var f=function(U){if($("#chargeModifyReasonCd_"+U).val()=="1"){$("#remark_"+U).css("display","inline")}else{$("#remark_"+U).css("display","none")}};var r=function(V,Y,W,X){var U=w(V,Y,W);if(U){if(z(Y)){$("#chargeModifyReasonCd_"+Y).off("change").on("change",function(){if($(this).val()=="1"){$("#remark_"+Y).css("display","inline")}else{$("#remark_"+Y).css("display","none")}});if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20||OrderInfo.actionFlag==15){$("#backAmount_"+Y).removeAttr("disabled").css("border","1px solid #DCDCDC").focus()}else{$("#realAmount_"+Y).removeAttr("disabled").css("border","1px solid #DCDCDC").focus()}}}$(X).removeAttr("onclick").removeClass("money_edit").addClass("money_edit_gray")};var z=function(aa){var Z={};var X=contextPath+"/order/queryAuthenticDataRange";var V=$.callServiceAsJson(X,Z);if(V.code==0){var W=V.data;var U=false;for(var Y=0;Y<W.length;Y++){if($("#acctItemTypeId_"+aa).val()==W[Y].dataDimensionName){U=true;break}else{U=false}}if(U){return true}else{$.alert("提示","当前费用项不允许修改!");return false}}else{if(V.code==-2){$.alertM(V.data);return false}else{$.alert("提示","权限数据范围查询失败!");return false}}};var C=function(Y){var ae=($("#realAmount_"+Y).val())*100+"";var ac=$("#feeAmount_"+Y).val();var aa="";if(ac!=undefined&&ac!=""){aa=ac+""}else{aa=ae}var ab=$("#acctItemTypeId_"+Y).val();var V=$("#objId_"+Y).val();var X=$("#objType_"+Y).val();var ad=$("#acctItemId_"+Y).val();var Z=$("#acctItemTypeName_"+Y).val();var U=$("#paymentAmount_"+Y).val();var W={realmoney:ae,feeAmount:aa,paymentAmount:U,acctItemTypeId:ab,objId:V,objType:X,acctItemId:ad,acctItemTypeName:Z};k.push(W)};var q=function(Y,aa,Z){var V=$.trim($(Y).val());if(V==""){$(Y).val("0");order.calcharge.reflashTotal()}else{if(Z=="old"){var X=$("#feeAmount_"+aa).val();var U=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(V)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");U=false}else{if((V*100>X*1)&&V>0){$.alert("提示","实收费用金额不能高于应收金额！");U=false}else{if((V*100<X*1)&&V<0){$.alert("提示","实收费用金额不能低于应收金额！");U=false}}}if(U){var ab=($(Y).val())*100;if(ab!=X){$("#chargeModifyReasonCd_"+aa).show()}else{$("#chargeModifyReasonCd_"+aa).hide();$("#remark_"+aa).hide()}n()}else{if(M!=""){$(Y).val(M)}M=""}}else{if(Z=="undo"){var U=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(V)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");U=false}else{if(V<0){$.alert("提示","退费金额不能为负值！");
U=false}else{var X=$("#realhidden_"+aa).val();var W=V*-1;if(W<X*1){$.alert("提示","退费金额不能高于实收金额！");U=false}}}if(U){var ab=($(Y).val())*-1;var X=$("#realhidden_"+aa).val();if(ab!=0){$("#chargeModifyReasonCd_"+aa).show()}else{$("#chargeModifyReasonCd_"+aa).hide();$("#remark_"+aa).hide()}n()}else{if(M!=""){$(Y).val(M)}M=""}}else{if(Z=="new"){if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(V)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");if(M!=""){$(Y).val(M)}M=""}else{if(V<0){$.alert("提示","实收费用金额不能为负值！")}else{n()}}}}}}};var t=function(U){M=$.trim($(U).val())};var I=function(){$("#toCharge").removeClass("btna_o").addClass("btna_g");$("#toComplate").removeClass("btna_o").addClass("btna_g");$("#orderCancel").removeClass("btna_o").addClass("btna_g");$("#orderCancel").off("click");$("#toComplate").off("click");$("#toCharge").off("click")};var x=function(){$("#orderCancel").removeClass("btna_g").addClass("btna_o");var U=($("#realmoney").val())*1;if(OrderInfo.actionFlag==11){$("#orderCancel").off("click").on("click",function(V){order.undo.orderBack()})}else{if(OrderInfo.actionFlag==35){$("#orderCancel").off("click").on("click",function(V){stepOrder.main.orderCancel()})}else{$("#orderCancel").off("click").on("click",function(V){SoOrder.orderBack()})}}if(!L){if(U!=0){$("#toCharge").removeClass("btna_g").addClass("btna_o");$("#toComplate").removeClass("btna_o").addClass("btna_g");$("#toCharge").off("click").on("click",function(V){if(!h()){return}s("1")});$("#toComplate").off("click")}else{$("#toCharge").removeClass("btna_o").addClass("btna_g");$("#toComplate").removeClass("btna_g").addClass("btna_o");$("#toCharge").off("click");$("#toComplate").off("click").on("click",function(V){if(!h()){return}a("0")})}}else{$("#toCharge").removeClass("btna_o").addClass("btna_g");$("#toComplate").removeClass("btna_o").addClass("btna_g");$("#toCharge").off("click");$("#toComplate").off("click")}};var h=function(){var U=true;$("#calTab tbody tr").each(function(){var X=$(this).attr("id");if(X!=undefined&&X!=""){X=X.substr(5,X.length);var W=$("#payMethodCd_"+X).val();if(W=="110102"){if(OrderInfo.actionFlag=="11"){$.alert("提示","付费方式为在线POS，不允许撤单，请修改为现金方式！");U=false;return}else{var V=$("#realAmount_"+X).val()*1;if(V<=0){$.alert("提示","在线POS的实收费用金额不能小于等于零，请修改！");U=false;return}}}}});return U};var s=function(U){I();if(L){$.alert("提示","订单已经建档成功,不能重复操作!");return}if(m){return}if(!b()){x();return}m=true;var V=contextPath+"/order/updateChargeInfoForCheck";var W=OrderInfo.cust.custId;if(W==""){W=="-1"}var X={olId:l,soNbr:OrderInfo.order.soNbr,areaId:OrderInfo.staff.areaId,chargeItems:P,custId:W,olNbr:OrderInfo.orderResult.olNbr};$.callServiceAsJson(V,X,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(Y){if(Y.code==0){if(D&&E(null,2)){if(Y.data==undefined||Y.data=="undefined"){$.alert("提示","在线POS地址未配置！");return}F();var Z=Y.data+"?result="+base64encode(utf16to8(JSON.stringify(P)))+"&olId="+base64encode(utf16to8(l))+"&soNbr="+base64encode(utf16to8(OrderInfo.orderResult.olNbr));var aa=document.createElement("a");aa.target="_blank";aa.href=Z;document.body.appendChild(aa);aa.click()}else{a(U)}}else{if(Y.code==-2){x();m=false;$.alertM(Y.data)}else{x();m=false;if(Y.data!=undefined){$.alert("提示",Y.data)}else{$.alert("提示","代理商保证金校验失败!")}}}}})};var F=function(){L=true;SoOrder.delOrderFin();if(OrderInfo.actionFlag==31){var U=contextPath+"/cust/passwordReset";var V=$.callServiceAsJson(U,null,{})}$("#orderCancel").removeClass("btna_g").addClass("btna_o");$("#printVoucherA").removeClass("btna_o").addClass("btna_g").off("click");if($("#printVoucherLoc").length>0){$("#printVoucherLoc").removeClass("btna_o").addClass("btna_g").off("click")}$(".charge_add").remove();$(".cash_inp_dis").attr("disabled","disabled");if(OrderInfo.actionFlag==11){$("#orderCancel").html("<span>返回首页</span>");$("#orderCancel").off("click").on("click",function(W){order.undo.toUndoMain(1)})}else{if(OrderInfo.actionFlag==35){$("#orderCancel span").html("继续受理");$("#orderCancel").off("click").on("click",function(W){stepOrder.main.orderBack()}).show()}else{$("#orderCancel").hide()}}SoOrder.updateResState()};var p=function(Y){var W=contextPath+"/token/pc/order/checkRuleToProv";var Z={olId:Y.rolId,soNbr:Y.rsoNbr,areaId:OrderInfo.staff.areaId,chargeItems:[]};$.ecOverlay("<strong>正在下省校验,请稍等会儿....</strong>");var V=$.callServiceAsJson(W,Z);$.unecOverlay();var U;if(V.code==0){var X=V.data;if(X.checkResult!=undefined){OrderInfo.checkresult=X.checkResult}U={code:0}}else{U={code:1,data:V.data}}return U};var a=function(ac){var ad=$("#realmoney").val();if(ad=="0.00"){if(!b()){return}}var Z={olId:l,soNbr:OrderInfo.order.soNbr,areaId:OrderInfo.staff.areaId,chargeItems:P,custOrderAttrs:[]};if(OrderInfo.actionFlag==35){Z.custOrderAttrs.push({itemSpecId:CONST.BUSI_ORDER_ATTR.STEP_ORDER_CHARGE_STAFF,value:OrderInfo.staff.staffCode})}var V=contextPath+"/token/pc/order/chargeSubmit?token="+OrderInfo.order.token;var aa=$.callServiceAsJson(V,Z,{});var X="";if(aa.code==0){L=true;SoOrder.delOrderFin();if(OrderInfo.actionFlag==31){var V=contextPath+"/cust/passwordReset";var ab=$.callServiceAsJson(V,null,{})}if(ac=="1"){if(OrderInfo.actionFlag==11){X="退费成功"}else{X="收费成功"}}else{X="受理成功"}$("#orderCancel").removeClass("btna_g").addClass("btna_o");$("#printVoucherA").removeClass("btna_o").addClass("btna_g").off("click");if($("#printVoucherLoc").length>0){$("#printVoucherLoc").removeClass("btna_o").addClass("btna_g").off("click")}$(".charge_add").remove();$(".cash_inp_dis").attr("disabled","disabled");if(OrderInfo.actionFlag==11){$("#orderCancel").html("<span>返回首页</span>");$("#orderCancel").off("click").on("click",function(ae){order.undo.toUndoMain(1)})}else{if(OrderInfo.actionFlag==35){$("#orderCancel span").html("继续受理");$("#orderCancel").off("click").on("click",function(ae){stepOrder.main.orderBack()}).show()}else{var W=OrderInfo.provinceInfo.redirectUri;if(W!=null&&W!=undefined&&W!=""){$("#orderCancel span").html("返回省份");$("#orderCancel").off("click").on("click",function(ae){S()})}else{$("#ordermessage").show();$("#ordermessage").html("订单已"+X);$("#orderCancel").hide()}}}SoOrder.updateResState();if(ac=="1"){var ad=($("#realmoney").val())*1;if(ad>0){var Y={soNbr:OrderInfo.order.soNbr,billType:0,olId:l,printFlag:-1,areaId:OrderInfo.staff.areaId,acctItemIds:[]};var U=common.print.initPrintInfo(Y);if(!U){return}$.confirm("信息提示","收费成功，是否打印发票?",{names:["是","否"],yesdo:function(){var ae={soNbr:OrderInfo.order.soNbr,billType:0,olId:l,printFlag:0,areaId:OrderInfo.staff.areaId,acctItemIds:[]};common.print.prepareInvoiceInfo(ae);return},no:function(){var ae=OrderInfo.provinceInfo.redirectUri;if(ae!=null&&ae!=undefined&&ae!=""){S()}}})}else{O(ac,X)}}else{O(ac,X)}return}else{if(aa.code==-2){x();SoOrder.getToken();m=false;$.alertM(aa.data)}else{x();SoOrder.getToken();m=false;if(aa.data!=undefined){$.alert("提示",aa.data)}else{$.alert("提示","费用信息提交失败!")}}}};var O=function(U,W){var V='<table class="contract_list rule">';if(U=="1"){if(OrderInfo.actionFlag==11){V+='<thead><tr> <td colspan="2">退费结果</td></tr></thead></table>'}else{V+='<thead><tr> <td colspan="2">收费结果</td></tr></thead></table>'}}else{V+='<thead><tr> <td colspan="2">受理结果</td></tr></thead></table>'}V+='<div id="rules_div">';V+='<table width="100%" border="0" cellspacing="0" cellpadding="0">';V+="<tr>";V+='<td align="right"><i class="rule_icon"></i></td>';V+='<td><span class="rule_font">'+W+"</span></td>";V+="</tr>";V+="</table>";V+="</div>";easyDialog.open({container:"successTip_dialog"});$("#successTipContent").html("");$("#successTipContent").html(V);$(".txt_cal_edit").attr("disabled","disabled");$(".charge_add").remove();var X=OrderInfo.provinceInfo.redirectUri;if(X!=null&&X!=""&&X!=undefined){$("#successTip_dialog_comfirm").show();$("#successTip_dialog_comfirm").off("click").on("click",function(Y){S()})}if(U=="1"){if(OrderInfo.actionFlag==11){$("#successTip_dialog_inv").show();$("#successTip_dialog_inv").off("click").on("click",function(Y){K()});$("#successTip_dialog_inv").css("margin-left","30px");
$("#successTip_dialog_cnt").css("margin-left","30px")}}};var H=function(){if($("#sumitErrorInfo").is(":hidden")){$("#sumitErrorInfo").css("display","")}else{$("#sumitErrorInfo").css("display","none")}};var u=function(W,V){var U=$("#payMethodCd_"+W);U.empty();$("select[@id=backpayMethodCd_"+W+"] option").each(function(){var Y=$(this).val();if(Y!=undefined){var X=$(this).text();if(Y.split("_")[1]==$(V).val()){$("<option value='"+Y.split("_")[0]+"'>"+X+"</option>").appendTo(U)}}})};var J=function(){if($("#successTip_dialog").is(":visible")){easyDialog.close()}if(OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){window.location.href=contextPath+"/mktRes/terminal/exchangePrepare";return}else{if(OrderInfo.actionFlag==8){window.location.href=contextPath+"/cust/mvnoCustCreate";return}}$("#order_confirm,#order_fill_content,#order_tab_panel_content").empty();$("#order_prepare").show();order.cust.custReset();if(OrderInfo.cust.custId==-1){order.cust.custReset()}};var j=function(){$("#step1").hide();$("#step2").hide();$("#step3").show();l=OrderInfo.orderResult.olId;R=OrderInfo.orderResult.soNbr;P=[];k=[];T=0;M=0;L=false;m=false;var U="0";if(OrderInfo.actionFlag==11){U="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){U="2"}}var V={olId:l,custVipLevel:OrderInfo.cust.vipLevel,actionFlag:OrderInfo.actionFlag,actionTypeName:encodeURI(OrderInfo.actionTypeName),businessName:encodeURI(OrderInfo.businessName),olNbr:OrderInfo.orderResult.olNbr,soNbr:OrderInfo.order.soNbr,refundType:U,checkResult:JSON.stringify(OrderInfo.checkresult)};$.callServiceAsHtmlGet(contextPath+"/token/pc/order/getChargeList?token="+OrderInfo.order.token,V,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(W){SoOrder.getToken();if(W.code!=0){$.alert("提示","算费失败，请稍后重试");return}if(OrderInfo.provinceInfo.isFee=="1"){SoOrder.delOrderFin();var Y=OrderInfo.provinceInfo.redirectUri;if(Y==null||Y==""||Y==undefined){$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>订单暂存成功</div>");return}$.alert("提示","订单暂存成功");S()}else{if(OrderInfo.provinceInfo.isFee=="2"){var X=$("#order_confirm");X.html(W.data).show();if(OrderInfo.actionFlag==35){if($("#orderCancel").attr("stepOrderParam")!=1){stepOrder.main.delOrderOperate=false;$("#orderCancel").hide()}else{stepOrder.main.delOrderOperate=true}}if(OrderInfo.actionFlag==1){$("#buytitle").html("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName)}else{if(OrderInfo.actionFlag==11){$("#buytitle").html("撤单");$("#toCharge").html("<span>退费</span>")}else{if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#buytitle").html("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName)}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){$("#buytitle").html("返销");$("#toCharge").html("<span>退费</span>")}else{$("#buytitle").html("<span>"+OrderInfo.actionTypeName+"</span>")}}}}$.each($(".cashier_td"),function(){var Z=$(this).attr("id");var aa=$(this);if($.trim($(this).html())==""&&$("#phoneNumListtbody")!=undefined){$.each($("#phoneNumListtbody tr").find("td:eq(0)"),function(){var ac=$(this).attr("prodInstId");var ad=$(this).attr("accNbr");var ab=$(this).attr("productName");if(ac!=undefined&&ad!=undefined){if(Z==ac){aa.html(ab+"&nbsp;-&nbsp;"+ad)}}})}})}}$("#printVoucherA").off("click").on("click",function(Z){if(!b()){return}var aa={olId:l,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:P,areaId:OrderInfo.getAreaId()};if(Q("_session_pad_flag")=="1"){common.print.signVoucher(aa)}else{if(E(aa,1)){common.print.printVoucher(aa)}else{return}}});$("#printVoucherLoc").off("click").on("click",function(Z){if(!b()){return}var aa={olId:l,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:P,areaId:OrderInfo.getAreaId()};common.print.printVoucher(aa)});n()},fail:function(W){SoOrder.getToken();$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var Q=function(W){var V="";var U=document.cookie.match(new RegExp("(^| )"+W+"=([^;]*)(;|$)"));if(U!=null){V=unescape(U[2])}return V};var G=function(V){if(V.acctItemTypeId=="2090000"||V.acctItemTypeId=="2091000"){return""}if(V.feeAmount==0){return""}var U="<tr>";U+="<td>";V.printTimes=0;if(V.printTimes==0){U+='<input type="checkbox" checked="checked" name="acctItem" value="'}else{U+='<input type="checkbox" disabled="disabled" name="acctItem" value="'}U+=V.acctItemTypeId+"_"+V.objId+'"/>';U+="</td>";U+='<td style="width: 200px">'+V.acctItemTypeName+"</td>";U+="<td>"+(parseFloat(V.realmoney)/100).toFixed(2)+"</td>";U+="</tr>";return U};var K=function(){var U={olId:OrderInfo.order.oldSoId,soNbr:OrderInfo.order.oldSoNbr};$.callServiceAsHtmlGet(contextPath+"/order/invaideInvoice",U,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(V){if(V.code==0){var W=$.parseJSON(V.data);if(W.code==0){$("#successTip_dialog_inv").off("click");$.alert("提示","作废发票成功！")}else{if(W.code==1){$.alert("提示","作废发票失败！")}else{if(W.code==2){$.alert("提示","未获取到发票信息！")}else{if(W.code==3){$.alert("提示","获取发票失败！")}else{$.alert("提示","作废发票异常！")}}}}}else{if(V.code==-2){}else{$.alert("提示","作废发票异常！")}}},fail:function(V){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var E=function(Y,X){var U=false;var Z={typeClass:X,queryType:1};var W=contextPath+"/print/queryConstConfig";$.ecOverlay("<strong>正在查询公共数据查询的服务中,请稍后....</strong>");var V=$.callServiceAsJsonGet(W,Z);$.unecOverlay();if(V.code==0){if(V.data!=undefined){if("Y"==V.data.value){U=true}}}else{if(V.code==-2){$.alertM(V.data);return false}else{$.alert("提示","查询公共数据查询的服务失败,稍后重试");return false}}if(U&&Y!=null){Y.signFlag=3}return true};var S=function(){var U={provIsale:OrderInfo.provinceInfo.provIsale,extCustOrderID:OrderInfo.orderResult.olId,resultCode:"0",redirectUri:OrderInfo.provinceInfo.redirectUri};$.callServiceAsHtmlGet(contextPath+"/mode/pc/backProvince",U,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(V){if(V.code==0){var W=$.parseJSON(V.data);if(W.code==0){if(W.data.indexOf("&amp;")!=-1){W.data=W.data.replace(/\&amp;/g,"&")}window.location.href=W.data;return}else{if(W.code==1){$.alert("提示",W.data)}}}else{$.alert("提示","页面回调异常！")}},fail:function(V){$.unecOverlay();$.alert("提示","页面回调可能发生异常，请稍后再试！")}})};return{addItems:g,delItems:A,reflashTotal:n,editMoney:q,setGlobeMoney:t,conBtns:x,addbusiOrder:i,addSubmit:c,selePaymethod:u,calchargeInit:j,showErrorInfo:H,pageFlag:B,changePayMethod:r,selectChangePayMethodCd:N,bindChargeModifyReason:f,invaideInvoice:K,updateChargeInfoForCheck:s,tochargeSubmit:p,backToEntr:J,backToProvince:S}})();CommonUtils.regNamespace("order","dealer");order.dealer=(function(){var b=function(v){if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:"40020005",NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:"40020006",NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:"40020007",NAME:"第三发展人"}]}else{if(!ec.util.isArray(OrderInfo.order.dealerTypeList)){$.ecOverlay("<strong>正在查询发展人类型中,请稍后....</strong>");var s=$.callServiceAsJson(contextPath+"/order/queryPartyProfileSpecList",null);$.unecOverlay();if(s.code==0){OrderInfo.order.dealerTypeList=s.data}else{if(s.code==-2){$.alertM(s.data);return}else{$.alert("信息提示",s.msg);return}}}if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){OrderInfo.getChannelList()}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==14){var m=OrderInfo.offerSpec.offerSpecId;var u=$("<tr id='tr_"+m+"' name='tr_"+m+"'></tr>");var t=$("<td></td>");var n=m+"_"+OrderInfo.SEQ.dealerSeq;var r=$('<select id="dealerType_'+n+'" name="dealerType_'+m+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+m+"',a)\"></select>");if(order.ysl!=undefined){r.append("<option value='40020005'>第一发展人</option>");r.append("<option value='40020006'>第二发展人</option>");r.append("<option value='40020007'>第三发展人</option>")}else{$.each(OrderInfo.order.dealerTypeList,function(){r.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")
})}t.append(r);t.append('<label class="f_red">*</label>');var q="主套餐";u.append("<td>"+q+"</td>");u.append("<td>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</td>");u.append(t);if(order.ysl!=undefined){var o=$('<td><input type="text" id="dealer_'+n+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px"></input></td>')}else{var o=$('<td><input type="text" id="dealer_'+n+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>')}o.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+n+"');\">选择</a>");o.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+m+',1)">添加</a><label class="f_red">*</label>');u.append(o);var p=$("<td></td>");var w=$('<select id="dealerChannel_'+n+'" name="dealerChannel_'+m+'" class="inputWidth183px" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){w.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{w.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});p.append(w);p.append('<label class="f_red">*</label>');u.append(p);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(u);if(offerChange.newMemberFlag){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var G="'"+this.prodInstId+"'";if(G.indexOf("-")!=-1){var x=this.prodInstId;var E=$("<tr id='tr_"+x+"' name='tr_"+x+"'></tr>");var D=$("<td></td>");var y=x+"_"+OrderInfo.SEQ.dealerSeq;var C=$('<select id="dealerType_'+y+'" name="dealerType_'+x+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+x+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){C.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});D.append(C);D.append('<label class="f_red">*</label>');var B="未选号";if(this.accNbr!=undefined&&this.accNbr!=""){B=prodInst.accNbr}E.append("<td>"+B+"</td>");E.append("<td>"+this.objName+"</td>");E.append(D);var z=$('<td><input type="text" id="dealer_'+y+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');z.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+y+"');\">选择</a>");z.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+x+',1)">添加</a><label class="f_red">*</label>');E.append(z);var A=$("<td></td>");var F=$('<select id="dealerChannel_'+y+'" name="dealerChannel_'+x+'" class="inputWidth183px"  onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){F.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{F.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});A.append(F);A.append('<label class="f_red">*</label>');E.append(A);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(E)}})})}}if(OrderInfo.actionFlag==6){if(order.memberChange.newMemberFlag){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var x=this.prodInstId;var E=$("<tr id='tr_"+x+"' name='tr_"+x+"'></tr>");var D=$("<td></td>");var y=x+"_"+OrderInfo.SEQ.dealerSeq;var C=$('<select id="dealerType_'+y+'" name="dealerType_'+x+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+x+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){C.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});D.append(C);D.append('<label class="f_red">*</label>');var A="未选号";if(this.accNbr!=undefined&&this.accNbr!=""){A=prodInst.accNbr}E.append("<td>"+A+"</td>");E.append("<td>"+this.objName+"</td>");E.append(D);var z=$('<td><input type="text" id="dealer_'+y+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');z.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+y+"');\">选择</a>");z.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+x+',1)">添加</a><label class="f_red">*</label>');E.append(z);var B=$("<td></td>");var F=$('<select id="dealerChannel_'+y+'" name="dealerChannel_'+x+'" class="inputWidth183px"  onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){F.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{F.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});B.append(F);B.append('<label class="f_red">*</label>');E.append(B);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(E)})})}if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){var x=this.offerSpecId;var E=$("<tr id='tr_"+x+"' name='tr_"+x+"'></tr>");var D=$("<td></td>");var y=x+"_"+OrderInfo.SEQ.dealerSeq;var F=true;$.each(OrderInfo.order.dealerTypeList,function(){var H=this.PARTYPRODUCTRELAROLECD;$("select[name='dealerType_"+x+"']").each(function(){if(H==$(this).val()){F=false}})});if(!F){return}var C=$('<select id="dealerType_'+y+'" name="dealerType_'+x+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+x+"',a)\"></select>");if(order.ysl!=undefined){C.append("<option value='40020005'>第一发展人</option>");C.append("<option value='40020006'>第二发展人</option>");C.append("<option value='40020007'>第三发展人</option>")}else{$.each(OrderInfo.order.dealerTypeList,function(){C.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")})}D.append(C);D.append('<label class="f_red">*</label>');var B="主套餐";E.append("<td>"+B+"</td>");E.append("<td>"+this.offerSpecName+"（包含接入产品）</td>");E.append(D);if(order.ysl!=undefined){var z=$('<td><input type="text" id="dealer_'+y+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px"></input></td>')}else{var z=$('<td><input type="text" id="dealer_'+y+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>')}z.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+y+"');\">选择</a>");z.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+x+',1)">添加</a><label class="f_red">*</label>');E.append(z);var A=$("<td></td>");var G=$('<select id="dealerChannel_'+y+'" name="dealerChannel_'+x+'" class="inputWidth183px"  onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(this.isSelect==1){G.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{G.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});A.append(G);A.append('<label class="f_red">*</label>');E.append(A);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(E)})}}if(OrderInfo.actionFlag==13){var m=$("#mktResId").val();var u=$("<tr id='tr_"+m+"' name='tr_"+m+"'></tr>");var t=$("<td></td>");var n=m+"_"+OrderInfo.SEQ.dealerSeq;var r=$('<select id="dealerType_'+n+'" name="dealerType_'+m+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+m+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){r.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});t.append(r);t.append('<label class="f_red">*</label>');u.append(t);var o=$('<td><input type="text" id="dealer_'+n+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');o.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+n+"');\">选择</a>");o.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+m+',1)">添加</a><label class="f_red">*</label>');
u.append(o);OrderInfo.SEQ.dealerSeq++;$("#dealerMktTbody").append(u)}if(OrderInfo.actionFlag==36){var m=OrderInfo.orderAccNbr;var u=$("<tr id='tr_"+m+"' name='tr_"+m+"'></tr>");var t=$("<td></td>");var n=m+"_"+OrderInfo.SEQ.dealerSeq;var r=$('<select id="dealerType_'+n+'" name="dealerType_'+m+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+m+"',a)\"></select>");if(order.ysl!=undefined){r.append("<option value='40020005'>第一发展人</option>");r.append("<option value='40020006'>第二发展人</option>");r.append("<option value='40020007'>第三发展人</option>")}else{$.each(OrderInfo.order.dealerTypeList,function(){r.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")})}t.append(r);t.append('<label class="f_red">*</label>');var q=OrderInfo.orderAccNbr;u.append("<td>"+q+"</td>");u.append("<td>一卡双号订购</td>");u.append(t);if(order.ysl!=undefined){var o=$('<td><input type="text" id="dealer_'+n+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px"></input></td>')}else{var o=$('<td><input type="text" id="dealer_'+n+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>')}o.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+n+"');\">选择</a>");o.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+m+',1)">添加</a><label class="f_red">*</label>');u.append(o);OrderInfo.SEQ.dealerSeq++;$("#dTbody").append(u)}if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){var E=this.offerSpecId;var B=$("<tr id='tr_"+E+"' name='tr_"+E+"'></tr>");var C=$("<td></td>");var A=E+"_"+OrderInfo.SEQ.dealerSeq;var x=true;$.each(OrderInfo.order.dealerTypeList,function(){var F=this.PARTYPRODUCTRELAROLECD;$("select[name='dealerType_"+E+"']").each(function(){if(F==$(this).val()){x=false}})});if(!x){return}var y=$('<select id="dealerType_'+A+'" name="dealerType_'+E+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+E+"',a)\"></select>");if(order.ysl!=undefined){y.append("<option value='40020005'>第一发展人</option>");y.append("<option value='40020006'>第二发展人</option>");y.append("<option value='40020007'>第三发展人</option>")}else{$.each(OrderInfo.order.dealerTypeList,function(){y.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")})}C.append(y);C.append('<label class="f_red">*</label>');var z="主套餐";B.append("<td>"+z+"</td>");B.append("<td>"+this.offerSpecName+"（包含接入产品）</td>");B.append(C);if(order.ysl!=undefined){var D=$('<td><input type="text" id="dealer_'+A+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px"></input></td>')}else{var D=$('<td><input type="text" id="dealer_'+A+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>')}D.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+A+"');\">选择</a>");D.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+E+',1)">添加</a><label class="f_red">*</label>');B.append(D);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(B)})}}};var g=function(m,p,o){var n=0;$("select[name="+p+"]").each(function(){if($(this).val()==$(m).val()){n++}});if(n>1){$.alert("信息提示","每个业务的发展人类型不能重复");$(m).val(o)}};var f=function(){$("input[name=attach_dealer]:checked").each(function(){var o=$(this).attr("id");var r=o.split("_")[0];if($("#tr_"+o)[0]==undefined){var m=o+"_"+OrderInfo.SEQ.dealerSeq;var s=c(o,m);if(s==undefined){return false}var u=$("#atr_"+o);var w=$('<tr name="tr_'+o+'"></tr>');w.append("<td>"+u.children().eq(1).text()+"</td>");w.append("<td>"+u.children().eq(2).text()+"</td>");w.append(s);var x=$("#tr_"+r).find("input");var t=1;var q="";if(x[0]==undefined){t=OrderInfo.staff.staffId;q=OrderInfo.staff.staffName}else{t=x.attr("staffId");q=x.attr("value")}if(order.ysl!=undefined){var n=$('<td><input type="text" id="dealer_'+m+'" name="dealer_'+o+'" staffId="'+t+'" value="'+q+'" class="inputWidth183px" style="margin-left:45px;"></input></td>')}else{var n=$('<td><input type="text" id="dealer_'+m+'" name="dealer_'+o+'" staffId="'+t+'" value="'+q+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>')}n.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+m+"');\">选择</a>");n.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');n.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+o+'\')">添加</a><label class="f_red">*</label>');w.append(n);var p=$("<td></td>");var v=$('<select id="dealerChannel_'+m+'" name="dealerChannel_'+o+'" class="inputWidth183px" onclick=a=this.value;></select>');OrderInfo.getChannelList();$.each(OrderInfo.channelList,function(){if(this.isSelect==1){v.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{v.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});p.append(v);p.append('<label class="f_red">*</label>');w.append(p);$("#dealerTbody").append(w);OrderInfo.SEQ.dealerSeq++}});easyDialog.close()};var h=function(r,t,o){var m=$(r).parent().parent();var n=t+"_"+OrderInfo.SEQ.dealerSeq;var q=c(t,n);if(q==undefined){return}var p=$('<tr name="tr_'+t+'"></tr>');if(OrderInfo.actionFlag!=13){p.append("<td>"+m.find("td").eq(0).text()+"</td>");p.append("<td>"+m.find("td").eq(1).text()+"</td>")}p.append(q);if(order.ysl!=undefined){var s=$('<td><input type="text" id="dealer_'+n+'" name="dealer_'+t+'" staffId="'+m.find("input").attr("staffId")+'" value="'+m.find("input").attr("value")+'" class="inputWidth183px" ></input></td>')}else{var s=$('<td><input type="text" id="dealer_'+n+'" name="dealer_'+t+'" staffId="'+m.find("input").attr("staffId")+'" value="'+m.find("input").attr("value")+'" class="inputWidth183px" readonly="readonly" ></input></td>')}s.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+n+"');\">选择</a>");s.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');p.append(s);m.after(p);OrderInfo.SEQ.dealerSeq++};var k=function(n,m){$("tr[name^='tr_"+n+"']").each(function(){$(this).find("td").eq(0).text(m)})};var c=function(q,n){var p="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var s=this.PARTYPRODUCTRELAROLECD;var r=true;$("select[name='dealerType_"+q+"']").each(function(){if(s==$(this).val()){r=false;return false}});if(r){p=s;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(p==undefined||p==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var o=$("<td></td>");var m=$('<select id="dealerType_'+n+'" name="dealerType_'+q+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+q+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==p){m.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{m.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});o.append(m);o.append('<label class="f_red">*</label>');return o};var l=function(){$("#attach_tbody").empty();$.each(AttachOffer.openList,function(){var v=this.prodId;var u="";if(OrderInfo.actionFlag==6){u=OrderInfo.getAccessNumber(v);for(var t=0;t<OrderInfo.oldprodInstInfos.length;t++){if(v==OrderInfo.oldprodInstInfos[t].prodInstId){u=OrderInfo.oldprodInstInfos[t].accNbr}}}else{u=OrderInfo.getAccessNumber(v)
}if(u==undefined||u==""){u="未选号"}$.each(this.specList,function(){var x=v+"_"+this.offerSpecId;if(this.isdel!="Y"&&this.isdel!="C"&&$("tr[name='tr_"+x+"']")[0]==undefined){var w=$('<tr id="atr_'+x+'" onclick="order.dealer.checkAttach(\''+x+"')\"></tr>");w.append('<td><input type="checkbox" id="'+x+'" onclick="order.dealer.checkAttach(\''+x+'\')" name="attach_dealer"/></td>');w.append("<td>"+u+"</td><td>"+this.offerSpecName+"</td>");$("#attach_tbody").append(w)}})});if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){for(var m=0;m<order.ysl.openList.length;m++){if(order.ysl.openList[m].type=="1"){var q="-1";var n=$("#choosedNumSpan").val();if(n==undefined||n==""){n="未选号"}var r="N";var o=$("#dealerTbody").find("tr");o.each(function(){if($(this).attr("name")=="tr_-1_"+order.ysl.openList[m].id){r="Y"}else{r="N"}});if(r=="N"){var s=q+"_"+order.ysl.openList[m].id;var p=$('<tr id="atr_'+s+'" onclick="order.dealer.checkAttach(\''+s+"')\"></tr>");p.append('<td><input type="checkbox" id="'+s+'" onclick="order.dealer.checkAttach(\''+s+'\')" name="attach_dealer"/></td>');p.append("<td>"+n+"</td><td>"+order.ysl.openList[m].name+"</td>");$("#attach_tbody").append(p)}}}}}easyDialog.open({container:"div_attach_dialog"})};var j=function(o){var n=$("#atr_"+o);var m=$("#"+o);if(m.attr("checked")=="checked"){n.removeClass("plan_select");m.attr("checked",false)}else{n.addClass("plan_select");m.attr("checked",true)}};var a=function(m){$(m).parent().parent().remove()};var i=function(m){$("tr[name^='tr_"+m+"']").each(function(){$(this).remove()})};return{initDealer:b,changeAccNbr:k,showOfferList:l,addProdDealer:h,addAttachDealer:f,checkAttach:j,removeDealer:a,removeAttDealer:i,changeDealer:g}})();CommonUtils.regNamespace("order","entrance");order.entrance=(function(){var c=function(){b()};var b=function(){$("#buyOffer").click(function(){a()});$("#buyTerminal").click(function(){f()});$("#choosePrettyNumber").click(function(){h()})};var a=function(){if(!g()){return}};var f=function(){if(!g()){return}};var h=function(){if(!g()){return}};var g=function(){if(!order.cust.getCustInfo()){$.alert("提示","请先定位客户！");return false}return true};return{init:c,checkIfQueryCust:g}})();$(function(){order.entrance.init()});CommonUtils.regNamespace("order","memberChange");order.memberChange=function(){var F={};var M=[];var u=false;var X=false;var h=false;var s=false;var U=0;var G=0;var p=1;var f="";var t;var O;var C;var w={};var c={objInstId:[]};var A={accessNumbers:[]};var y={accessNumbers:[]};var n={};var P=[];var r=[];var U=0;var I=function(){if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){$.alert("提示","停机产品不允许受理！");return}M=[];p=1;OrderInfo.busitypeflag=3;OrderInfo.actionFlag=6;OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldprodAcctInfos=[];OrderInfo.oldAddNumList=[];OrderInfo.viceOfferSpec=[];$("#order_fill_content").empty();OrderInfo.order.step=0;order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show();$("#order_confirm").hide();order.prepare.createorderlonger();if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"){$.alert("提示","3G套餐不允许做主副卡成员变更业务！","information");return}var ag=order.memberChange.areaidJurisdiction();if(order.memberChange.reloadFlag=="N"){if(!Q()){return}var ah=order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;var aj=true;$.each(ah,function(){if(this.itemSpecId=="30010024"){if(this.value!="3"){aj=false;return false}}});if(!aj){$.alert("提示","不是主副卡成员变更受理流水号，请重试！");return}var al=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;var ai=1;var Y=1;order.memberChange.newSubPhoneNum="";order.memberChange.oldSubPhoneNum="";$.each(al,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="3"){order.memberChange.delmembers.flag=true;order.memberChange.delmembers.accessNumbers.push({nbr:this.busiObj.accessNumber})}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){order.memberChange.newmembers.flag=true;if(ai==1){order.memberChange.newSubPhoneNum+=this.busiObj.accessNumber;ai++}else{order.memberChange.newSubPhoneNum+=","+this.busiObj.accessNumber}}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"){if(this.busiObj.offerTypeCd=="1"){order.memberChange.oldmembers.flag=true;if(Y==1){order.memberChange.oldSubPhoneNum+=this.busiObj.accessNumber;Y++}else{order.memberChange.oldSubPhoneNum+=","+this.busiObj.accessNumber}}var an=this.data.ooRoles[0].objInstId;var am=this.busiObj.instId;order.memberChange.oldmembers.objInstId.push({instId:am,objInstId:an})}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="1"){order.memberChange.changemembers.flag=true;order.memberChange.changemembers.accessNumbers.push({nbr:this.busiObj.accessNumber,specId:this.busiObj.objId,name:this.busiObj.objName})}}}}})}var ac=[];var af=[];if(order.memberChange.newSubPhoneNum!=""){ac=order.memberChange.newSubPhoneNum.split(",")}if(order.memberChange.oldSubPhoneNum!=""){af=order.memberChange.oldSubPhoneNum.split(",")}var aa={offerSpecId:order.prodModify.choosedProdInfo.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var Z=query.offer.queryMainOfferSpec(aa);if(!Z){return}var ae=true;$.each(Z.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){ae=false;return false}});if(ae){$.alert("错误","你选择的套餐不是主副卡套餐，不能进行主副卡成员变更");return}if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!query.offer.setOffer()){return}}var ad=0;var ak=true;var ab=$("#maincard_member_tbody");ab.html("");$("#main_title").text(OrderInfo.offerSpec.offerSpecName);$.each(Z.offerRoles,function(){var ao=this;var an=$("<tr style='background:#f8f8f8;'></tr>");var ap=$('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'+ao.offerRoleName+"</span>&nbsp;&nbsp;</td>");if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){an.append(ap).append($("<td colspan='3'></td>")).appendTo(ab)}else{an.append(ap).appendTo(ab)}if(ao.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){an.append("<td align='center' colspan='2' class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>"+this.objName+"</span>&nbsp;&nbsp;</td>")}});$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ao.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){an.append("<td align='left' colspan='1' class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>"+this.accessNumber+"</span>&nbsp;&nbsp;</td>");return}})}else{$.each(ao.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){this.minQty=0;this.dfQty=0;viceMinQty=0;viceMaxQty=this.maxQty;numId=ao.offerRoleId+"_"+this.objId}});var am=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ao.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){am++}});$.each(this.roleObjs,function(){var au=ao.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){M.push(au);if(ao.minQty==0){this.minQty=0;this.dfQty=0}var aq=this.maxQty<0?"不限制":this.maxQty;aq=aq-am;G=aq;if(aq>0){var at="";var ar="";if(ac.length==0&&af.length==0){at="<a class='add' href='javascript:order.service.subNum(\""+au+'",'+this.minQty+");'></a>";ar="<a class='add2' href='javascript:order.service.addNum(\""+au+'",'+aq+");'> </a>"}else{if(ac.length>aq){$.alert("规则限制","newSubPhoneNum的角色成员数量总和不能超过"+aq);ak=false;return false}}an.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'>"+at+"<input id='"+au+"' type='text' value='"+ac.length+"' class='numberTextBox width22' readonly='readonly'>"+ar+"</i>"+this.minQty+"-"+aq+"（张） </td>")}ad++}});if(ag!=""&&ag.flag=="ON"&&ag.net_vice_card=="0"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var ar=this.maxQty<0?"不限制":this.maxQty;
ar=ar-am;if(ar>0){var au="";if(ac.length==0&&af.length==0){au="<a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+ar+',"");\'> </a>';var aq="<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'><td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td><td align='left' colspan='3'><input value='' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' >"+au+this.minQty+"-"+ar+"（张）</td></tr>";an.after(aq)}else{if(af.length>ar){$.alert("规则限制","oldSubPhoneNum的角色成员数量总和不能超过"+ar);ak=false;return false}else{for(var at=0;at<af.length;at++){if(at==0){var aq="<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'><td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td><td align='left' colspan='3'><input value='"+af[at]+"' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' readonly='readonly'>"+this.minQty+"-"+ar+"（张）</td></tr>";an.after(aq)}else{order.memberChange.addNum(ar,af[at])}}}}}}})}$.each(OrderInfo.offer.offerMemberInfos,function(){var at=$("<tr></tr>");if(this.offerRoleId==ao.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){var ar=$("<td colspan='4' id=\"li_viceCard_new_"+this.accessNumber+'"></td>').text(this.accessNumber).appendTo(at);ar.attr("del","N").attr("knew","N").attr("objId",this.objId).attr("objInstId",this.objInstId).attr("objType",this.objType).attr("offerMemberId",this.offerMemberId).attr("offerRoleId",this.offerRoleId).attr("accessNumber",this.accessNumber);var au=$("<i id='plan_no'><a id='' accNbr='"+this.accessNumber+"' class='purchase' href='javascript:void(0)'>拆副卡</a></i>").appendTo(ar);au.click(function(){if(($(this).parent().attr("del")=="N")){$(this).parent().css("text-decoration","line-through").attr("del","Y").attr("knew","N");$(this).find("a").text("不 拆")}else{$(this).parent().css("text-decoration","").attr("del","N").attr("knew","N");$(this).find("a").text("拆副卡");$("#viceCard_new_"+$(this).find("a").attr("accNbr")).html("")}});$("<span  id='viceCard_new_"+this.accessNumber+"'></span>").appendTo(ar);if(ag!=""&&ag.flag=="ON"){var aq=$("<i id='plan_no_remain'><a id='' accNbr='"+this.accessNumber+"' class='purchase' href='javascript:void(0)'>保留>>选择新套餐</a></i>").appendTo(ar);aq.click(function(){order.service.offerDialog("viceCard_new_"+$(this).find("a").attr("accNbr"))})}}an.after(at)})}});if(order.memberChange.reloadFlag=="Y"){$("#memeberChange .btna_o:last").click(function(){N()});if(ak){ec.form.dialog.createDialog({id:"-memeberChange",width:580,height:400,initCallBack:function(an,am){order.prodModify.dialogForm=an;order.prodModify.dialog=am},submitCallBack:function(an,am){}})}}else{if(order.memberChange.reloadFlag=="N"){order.memberChange.submit()}}};var a=function(){var aa=OrderInfo.staff.soAreaId.substring(0,3)+"0000";var Y={areaid:aa};$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var Z=$.callServiceAsJsonGet(contextPath+"/offer/areaidJurisdiction",Y);$.unecOverlay();if(Z.code==0){return Z.data}else{return""}};function Q(){var Y=OrderInfo.provinceInfo.provIsale;var Z={provTransId:Y,backFlag:"Y"};$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var aa=$.callServiceAsJsonGet(contextPath+"/accessToken/queryOrderInfos",Z);$.unecOverlay();if(aa.code==0){order.memberChange.rejson=aa.data;return true}else{if(aa.code==1002){$.alert("错误",aa.data);return false}else{$.alertM(aa.data);return false}}}var H=function(Z,ae){var ac="";if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==1){ac="member_tbody"}else{ac="maincard_member_tbody"}var ab=$("#"+ac).find("tr[name='oldnbr']");ab=ab.length+1;if(ab>Z){return}p++;var ad="";var aa="";if(ae==""){ad="<a style='margin-top:15px' class='add' href='javascript:order.memberChange.delNum(\"oldnum_"+p+"\");'> </a>"}else{aa="readonly='readonly'"}var Y="<tr style='background:#f8f8f8;' id='oldnum_"+p+"' name='oldnbr'><td  class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td><td align='left' colspan='3'><input value='"+ae+"' style='margin-top:10px' class='numberTextBox' id='oldphonenum_"+p+"' type='text' "+aa+">"+ad+"</td></tr>";if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==1){$("#member_tbody").append(Y)}else{$("#maincard_member_tbody").append(Y)}};var j=function(Y){$("#"+Y).remove()};var T=[];var m=function(){OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldAddNumList=[];T=[];var ad=true;var Z="";if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==1){Z="member_tbody"}else{Z="maincard_member_tbody"}var ac=OrderInfo.newOrderInfo.isReloadFlag;$("#"+Z).find("tr[name='oldnbr']").each(function(){var af=$.trim($(this).children("td").eq(1).children("input").val());if(ec.util.isObj(af)){if(ec.util.isArray(OrderInfo.oldAddNumList)){if(!ad){return false}$.each(OrderInfo.oldAddNumList,function(){if(af==this.accNbr){ad=false;$.alert("提示",af+"重复，请重新输入！");return false}});if(ad){OrderInfo.oldAddNumList.push({accNbr:af})}}else{OrderInfo.oldAddNumList.push({accNbr:af})}}});if(!ad){return false}if(OrderInfo.oldAddNumList.length==0){$.alert("提示","请输入手机号码!");return false}var ae=true;for(var ab=0;ab<OrderInfo.oldAddNumList.length;ab++){for(var Y=0;Y<OrderInfo.offer.offerMemberInfos.length;Y++){if(OrderInfo.oldAddNumList[ab].accNbr==OrderInfo.offer.offerMemberInfos[Y].accessNumber){$.alert("提示",OrderInfo.oldAddNumList[ab].accNbr+"号码重复，请重新输入！");ae=false;return false}}if(OrderInfo.provinceInfo.mergeFlag=="0"){ae=E(OrderInfo.oldAddNumList[ab].accNbr,T);if(!ae){break}}else{var aa=$("#p_cust_areaId_choose").val();ae=order.cust.queryCustCompreInfo(OrderInfo.oldAddNumList[ab].accNbr,aa,3,"OLD");if(!ae){break}}}if(ae){if(OrderInfo.provinceInfo.mergeFlag=="0"){return g()}else{if(o(order.memberChange.viceCartNum)){return J()}}}};var E=function(Z,aa){var ac={acctNbr:Z,identityCd:"",identityNum:"",partyName:"",diffPlace:"local",areaId:$("#p_cust_areaId").val(),queryType:"",queryTypeValue:""};var Y=$.callServiceAsJson(contextPath+"/cust/queryoffercust",ac,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});if(Y.code==0){$.unecOverlay();if(Y.data.custInfos.length==0){$.alert("提示","抱歉，没有定位到"+Z+"客户，请尝试其他客户。");return false}var ab=Y.data.custInfos[0].custId;if(OrderInfo.actionFlag!=1&&ab!=OrderInfo.cust.custId){$.alert("提示",Z+"和主卡的客户不一致！");return false}aa.push({accNbr:Z,custId:ab})}else{$.unecOverlay();$.alertM(Y.data);return false}return true};var g=function(){var Y=true;for(var ab=0;ab<T.length;ab++){var ae={};ae.custId=T[ab].custId;ae.acctNbr=T[ab].accNbr;ae.areaId=$("#p_cust_areaId").val();ae.pageSize="";ae.curPage="";ae.DiffPlaceFlag="local";if(ae.custId==null||ae.custId==""){Y=false;$.alert("提示",T[ab].accNbr+"无法查询已订购产品");return false}var Z=$.callServiceAsJson(contextPath+"/cust/offerorderprod",ae,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});if(Z.code==0){$.unecOverlay();var ad=Z.data;if(!ec.util.isArray(ad)){$.alert("提示",T[ab].accNbr+"无法查询已订购产品");return false}for(var aa=0;aa<ad.length;aa++){if(ad[aa].accNbr==T[ab].accNbr){var ac=ad[aa];ac.custId=T[ab].custId;if(ac.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){Y=false;$.alert("提示",T[ab].accNbr+"不是在用产品！");return}if(OrderInfo.actionFlag!=1&&ac.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){Y=false;$.alert("提示",T[ab].accNbr+"和主卡的付费类型不一致！");return}if(ac.productId=="280000000"){$.alert("提示",T[ab].accNbr+"是无线宽带，不能纳入！");return false}OrderInfo.oldprodInstInfos.push(ac);break}}}else{Y=false;$.unecOverlay();$.alertM(Z.data);return false}}if(Y){return z()}};var J=function(){var Y=true;for(var Z=0;Z<OrderInfo.oldprodInstInfos.length;Z++){var ab=OrderInfo.oldprodInstInfos[Z].mainProdOfferInstInfos[0].prodOfferId;if(ec.util.isObj(ab)){var aa={offerSpecId:ab,offerTypeCd:1,partyId:OrderInfo.oldprodInstInfos[Z].custId,accNbr:OrderInfo.oldprodInstInfos[Z].accNbr};if(!query.offer.queryMainOfferSpec(aa)){Y=false;
return false}}}if(Y){return B()}};var z=function(){var af=true;var ad=0;var ah=[];for(var ag=0;ag<OrderInfo.oldprodInstInfos.length;ag++){if(ec.util.isArray(ah)){for(var ac in ah){if(OrderInfo.oldprodInstInfos[ag].accNbr==ah[ac].accessNumber){$.alert("提示","号码【"+OrderInfo.oldprodInstInfos[ag].accNbr+"】与【"+ah[ac].accNbr+"】为同一套餐下的实例成员，不能重复加装!");return false}}}var Z={offerId:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferId,acctNbr:OrderInfo.oldprodInstInfos[ag].accNbr,areaId:OrderInfo.oldprodInstInfos[ag].areaId,distributorId:""};var ab=query.offer.queryOfferInst(Z);if(ab&&ab.code==CONST.CODE.SUCC_CODE){var ae=true;if(ec.util.isArray(ab.offerMemberInfos)){CacheData.sortOffer(ab);var ai=0;for(var ac=0;ac<ab.offerMemberInfos.length;ac++){var aa=ab.offerMemberInfos[ac];aa.prodClass=OrderInfo.oldprodInstInfos[ag].prodClass;if(aa.objType==""){af=false;$.alert("提示","销售品实例构成 "+aa.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(aa.objType==CONST.OBJ_TYPE.PROD){if(aa.accessNumber==""){af=false;$.alert("提示","销售品实例构成 "+aa.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}ai++;ad++;ah.push({accNbr:OrderInfo.oldprodInstInfos[ag].accNbr,accessNumber:aa.accessNumber})}}if(aa.objInstId==OrderInfo.oldprodInstInfos[ag].prodInstId){ae=false}}if(ae){af=false;$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+OrderInfo.oldprodInstInfos[ag].accNbr+"】，无法继续受理，请业务后台核实");return false}var Y={offerMemberInfos:ab.offerMemberInfos,offerId:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferInstId,offerSpecId:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferId,offerSpecName:OrderInfo.oldprodInstInfos[ag].mainProdOfferInstInfos[0].prodOfferName,accNbr:OrderInfo.oldprodInstInfos[ag].accNbr};OrderInfo.oldoffer.push(Y)}else{af=false;$.alert("提示",OrderInfo.oldprodInstInfos[ag].accNbr+"查询销售品实例构成，没有返回成员实例无法继续受理");return false}}}order.memberChange.viceCartNum=ad;if(af&&o(ad)){return J()}};var o=function(Z){var Y=true;$.each(OrderInfo.offerSpec.offerRoles,function(){var ab=this;if(ab.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var aa=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==ab.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){aa++}});$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var ac=this.maxQty<0?"不限制":this.maxQty;if(ac>0&&(ac-aa-Z)<0){$.alert("提示","加装数量已经超过能加装的最大数量【"+ac+"】!");Y=false;return}}})}});return Y};var B=function(){var Z=true;$.each(OrderInfo.oldoffer,function(){var ae=this;var ad={};$.each(ae.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){ad.prodInstId=this.objInstId;ad.accNbr=this.accessNumber;var af=query.prod.getTerminalInfo(ad);if(af==undefined){Z=false;return false}k(this.offerId,this.objInstId,af);if(af.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}}})});if(Z){var ac=true;if(OrderInfo.order.soNbr==null||OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}for(var aa=0;aa<OrderInfo.oldprodInstInfos.length;aa++){var Y=OrderInfo.oldprodInstInfos[aa];if(Y==undefined||Y.prodInstId==undefined){ac=false;$.alert("提示",OrderInfo.oldprodInstInfos[aa].accNbr+"未获取到老用户产品相关信息，无法办理二次业务！");return false}var ab={areaId:Y.areaId,acctNbr:Y.accNbr,custId:Y.custId,soNbr:OrderInfo.order.soNbr,instId:Y.prodInstId,type:"2",queryType:"1,2,3,4,5",acctNbr:"",data:[]};if(!S(ab,Y)){ac=false;return false}}if(ac){return v()}}};var k=function(Y,aa,Z){if(ec.util.isArray(OrderInfo.boProd2OldTds)){$.each(OrderInfo.boProd2OldTds,function(){if(this.prodId==aa){$(this).remove()}})}var ab={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:Z.couponId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:Z.couponInsNumber,terminalCode:Z.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:aa,offerId:Y,state:"DEL",relaSeq:"",id:0,isOld:"T",is4GCard:Z.is4GCard};OrderInfo.boProd2OldTds.push(ab)};var S=function(ad,Y){var ac=OrderInfo.provinceInfo.mergeFlag;for(var ab=0;ab<OrderInfo.oldoffer.length;ab++){if(OrderInfo.oldoffer[ab].accNbr==Y.accNbr){if(ec.util.isArray(OrderInfo.oldoffer[ab].offerMemberInfos)){var Z=true;$.each(OrderInfo.oldoffer[ab].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.accessNumber==Y.accNbr){instflag=false;Z=false;return false}});if(Z){if(ac!=null&&ac!=""&&ac!="undefined"&&ac=="1"){ad.data.push({accessNbr:Y.accNbr,instId:Y.prodInstId});return query.offer.invokeLoadInstSub(ad)}else{return query.offer.invokeLoadInst(ad)}}else{var aa=true;if(ac!=null&&ac!=""&&ac!="undefined"&&ac=="1"){$.each(OrderInfo.oldoffer[ab].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){ad.data.push({accessNbr:this.accessNumber,instId:this.objInstId})}});if(ad!=null){if(!query.offer.invokeLoadInstSub(ad)){aa=false;return false}}}else{$.each(OrderInfo.oldoffer[ab].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){ad.acctNbr=this.accessNumber;ad.instId=this.objInstId;if(!query.offer.invokeLoadInst(ad)){aa=false;return false}}})}return aa}}else{if(ac!=null&&ac!=""&&ac!="undefined"&&ac=="1"){ad.data.push({accessNbr:Y.accNbr,instId:Y.prodInstId});return query.offer.invokeLoadInstSub(ad)}else{return query.offer.invokeLoadInst(ad)}}}}};var v=function(){rule.rule.init();var Y=true;for(var ab=0;ab<OrderInfo.oldprodInstInfos.length;ab++){var ac=OrderInfo.oldprodInstInfos[ab];var ag={boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:ac.mainProdOfferInstInfos[0].prodOfferInstId,prodId:ac.prodInstId};if(ac.mainProdOfferInstInfos[0].prodOfferId!=""){ag.specId=ac.mainProdOfferInstInfos[0].prodOfferId}var ae=[];ae.push(ag);var ad={areaId:OrderInfo.staff.soAreaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:ac.custId,soNbr:OrderInfo.order.soNbr,boInfos:ae,prodInfo:ac};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var aa=$.callServiceAsJson(contextPath+"/rule/prepare",ad);$.unecOverlay();if(aa!=undefined&&aa.code==0){var af=aa.data;if(af==null){Y=false;$.alert("提示","规则校验异常，请联系管理人员！");return false}if(af.ruleType=="portal"){if(af.resultCode=="0"){Y=false;$.alert("提示",af.resultMsg);return false}}var Z=af.result.resultInfo;if(Z!=undefined&&Z.length>0){$.each(Z,function(ai,ah){$("<tr><td>"+ah.resultCode+"</td><td>"+ah.ruleDesc+"</td><td>"+rule.rule.getRuleLevelName(ah.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+rule.rule.getRuleImgClass(ah.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});easyDialog.open({container:"ruleDiv"});Y=false;return false}}else{Y=false;$.alertM(aa.data);return false}}if(Y){return true}};var V=function(){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");param={memberChange:"Y",type:1,boActionTypeName:"主副卡成员变更",viceCardNum:parseInt(OrderInfo.oldAddNumList.length),offerNum:1,actionFlag:6,oldofferSpec:OrderInfo.oldofferSpec,oldprodInstInfos:OrderInfo.oldprodInstInfos,oldoffer:OrderInfo.oldoffer,addflag:"ADD",oldnum:parseInt(OrderInfo.oldAddNumList.length)};var Y=order.prodModify.choosedProdInfo;var Z=[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:Y.prodOfferInstId,specId:Y.prodOfferId,prodId:F.objInstId}];if(rule.rule.ruleCheck(Z)){order.main.buildMainView(param)}order.memberChange.closeDialog()};var K=function(){OrderInfo.oldAddNumList=[];OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldprodAcctInfos=[];order.memberChange.viceCartNum=0;var ad=0;var Y=0;var an=$("#maincard_member_tbody tr[style!='background:#f8f8f8;'] td[colspan='4']");for(var ac=0;ac<an.length;ac++){if(order.memberChange.delmembers.flag){$.each(order.memberChange.delmembers.accessNumbers,function(){if(this.nbr==$(an[ac]).attr("accessnumber")){$(an[ac]).css("text-decoration","line-through").attr("del","Y").attr("knew","N");
$(an[ac]).find("a").text("不 拆")}})}if(order.memberChange.changemembers.flag){$.each(order.memberChange.changemembers.accessNumbers,function(){if(this.nbr==$(an[ac]).attr("accessnumber")){order.service.choosedOffer("tcnum"+1,this.specId,"","viceCard_new_"+this.nbr,this.name)}})}}var aj=false;for(var ac=0;ac<an.length;ac++){if($(an[ac]).attr("del")=="Y"||$(an[ac]).attr("knew")=="Y"){aj=true;break}}$.each(M,function(){ad=ad+Number($("#"+this).val())});$("#maincard_member_tbody").find("tr[name='oldnbr']").each(function(){var ao=$.trim($(this).children("td").eq(1).children("input").val());if(ec.util.isObj(ao)){Y++}});if(!(aj)&&ad<=0&&Y<=0){$.alert("提示","没有对副卡进行操作。");return}var ag=order.prodModify.choosedProdInfo;var am=[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:ag.prodOfferInstId,specId:ag.prodOfferId,prodId:F.objInstId}];if(!rule.rule.ruleCheck(am)){return}var ak={boActionTypeName:"主副卡成员变更"};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");if(ad>0){var ab={prodId:ag.prodInstId,acctNbr:ag.accNbr,prodSpecId:ag.productId,areaId:ag.areaId};var af=query.offer.queryProdInstParam(ab);if(af&&af.prodSpecParams){OrderInfo.prodInstAttrs=af.prodSpecParams}ak.memberChange="Y";ak.type=1;ak.feeTypeMain=ag.feeType;ak.offerNum=1;ak.custId=OrderInfo.cust.custId;ak.actionFlag=6;ak.accessNumber=F.accessNumber;ak.offerSpec=OrderInfo.offerSpec;ak.newnum=ad;order.service.setOfferSpec();order.memberChange.newMemberFlag=true}else{order.memberChange.newMemberFlag=false}if(Y>0){if(!order.memberChange.queryofferinfo()){return}order.memberChange.oldMemberFlag=true;ak.memberChange="Y";ak.type=1;ak.offerNum=1;ak.actionFlag=6;ak.oldofferSpec=OrderInfo.oldofferSpec;ak.oldprodInstInfos=OrderInfo.oldprodInstInfos;ak.oldoffer=OrderInfo.oldoffer;ak.oldnum=Y}else{order.memberChange.oldMemberFlag=false}if(parseInt(ad)+parseInt(order.memberChange.viceCartNum)>G&&order.memberChange.reloadFlag!="N"){$.alert("提示","加装数量已经超过能加装的最大数量【"+G+"】!");return}if(aj){var aa=[];$.each(an,function(ap,ao){if($(this).attr("knew")=="Y"||$(this).attr("del")=="Y"){aa.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerRoleId:$(this).attr("addRoleId"),offerSpecId:$(this).attr("addSpecId"),offerMemberId:$(this).attr("offerMemberId"),del:$(this).attr("del"),accessNumber:$(this).attr("accessNumber"),offerSpecName:$(this).attr("addSpecName"),roleName:"基础移动电话",knew:$(this).attr("knew")})}});order.memberChange.viceparams=aa;var ae=[];$.each(an,function(ap,ao){if($(this).attr("del")=="Y"||$(this).attr("knew")=="Y"){ae.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerMemberId:$(this).attr("offerMemberId"),offerRoleId:$(this).attr("offerRoleId"),state:"DEL"})}});order.memberChange.ooRoless=ae;var ai="removeProd";var al=CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;var Z={boActionTypeCd:al,submitFlag:ai,viceParam:aa,ooRoles:ae};var ab={areaId:OrderInfo.staff.areaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,boInfos:[]};ab.boInfos=am;if(!l()){return}var ah=order.prodModify.choosedProdInfo;ak.boActionTypeCd=al;ak.actionFlag="6";ak.prodId=ah.prodInstId;ak.offerMembers=OrderInfo.offer.offerMemberInfos;ak.oldOfferSpecName=ah.prodOfferName;ak.prodClass=ah.prodClass;ak.appDesc=CONST.getAppDesc();ak.submitFlag=ai;ak.viceParam=aa;ak.ooRoles=ae;order.memberChange.changeMemberFlag=true}else{order.memberChange.changeMemberFlag=false}order.main.buildMainView(ak);order.memberChange.closeDialog()};var l=function(){return prod.uim.setProdUim()};var b=function(){var aa={code:"old_memberchange"};var Z=contextPath+"/order/getSimulateData";$.ecOverlay("<strong>正在查询公共数据查询的服务中,请稍后....</strong>");var Y=$.callServiceAsJsonGet(Z,aa);$.unecOverlay();if(Y.code==0){if(Y.data!=undefined){if("Y"==Y.data){return false}}}return true};var D=function(Y,ab){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType=="2"){var ad=this.objInstId;var ae={areaId:OrderInfo.getProdAreaId(ad),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ad,prodSpecId:this.objId,offerSpecId:order.prodModify.choosedProdInfo.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var ac=query.offer.queryMainCartAttachOffer(ae)}});var Z=order.prodModify.choosedProdInfo;var aa=false;$.each(ab.viceParam,function(){var ae=this.objInstId;var af={areaId:OrderInfo.getProdAreaId(ae),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ae,prodSpecId:this.objId,offerSpecId:Z.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var ac=query.offer.queryChangeAttachOffer(af);$("#attach_"+ae).html(ac);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){af.queryType="1,2";af.objId=this.objId;af.objType=this.objType;af.memberRoleCd="400";af.offerSpecId=this.offerSpecId;var ad=query.offer.queryDefMustOfferSpec(af);CacheData.parseOffer(ad,ae);var ad=query.offer.queryServSpec(af);CacheData.parseServ(ad,ae)}AttachOffer.showMainMemberRoleProd(ae);AttachOffer.changeLabel(ae,this.objId,"");if(AttachOffer.isChangeUim(ae)){if(!aa){$("#uimDiv_"+ae).show()}else{$("#uimDiv_"+ae).hide()}}aa=true})};var N=function(){if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){order.prodModify.dialogForm.close(order.prodModify.dialog)}};var R=function(Y){var Z=[];var aa=[];var ab=[];Z=Y.viceParam;aa=Y.ooRoles;ab={viceParam:Z,ooRoles:aa,remark:$("#order_remark").val()};SoOrder.submitOrder(ab)};var i=function(Z,ab){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.cust.areaId;var Y=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;L(Y,ab,Z.prodInstId);x(Y,ab,Z);var aa=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(aa==undefined){return false}if(aa.resultCode==0&&ec.util.isObj(aa.result)){offerChange.resultOffer=aa.result}else{$.alert("预校验规则限制",aa.resultMsg);offerChange.resultOffer={};return false}return true};var L=function(Z,aa,Y){aa.offerTypeCd=1;aa.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;OrderInfo.getOfferBusiOrder(Z,aa,Y)};var x=function(af,ah,ae){var Z=OrderInfo.offerSpec;var ag=W();if(ag==undefined){alert("错误提示","无法加装到该套餐");return false}var Y={areaId:OrderInfo.getProdAreaId(ae.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.SEQ.offerSeq--,objId:Z.offerSpecId,offerTypeCd:"1",accessNumber:ae.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};if(ec.util.isArray(ah.offerMemberInfos)){Y.data.ooRoles=[];$.each(ah.offerMemberInfos,function(){var ai={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerRoleId:ag.offerRoleId,state:"ADD"};if(this.objType!=CONST.OBJ_TYPE.PROD){ai.prodId=prodId}Y.data.ooRoles.push(ai)})}if(ec.util.isArray(Z.offerSpecParams)){Y.data.ooParams=[];for(var ac=0;ac<Z.offerSpecParams.length;ac++){var aa=Z.offerSpecParams[ac];var ab={itemSpecId:aa.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:aa.offerSpecParamId,value:aa.value,state:"ADD"};Y.data.ooParams.push(ab)}}if(Z.ooTimes!=undefined){Y.data.ooTimes=[];Y.data.ooTimes.push(Z.ooTimes)}Y.data.busiOrderAttrs=[];var ad=$("tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(ad!=undefined){ad.each(function(){var ai={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()};Y.data.busiOrderAttrs.push(ai);var aj={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};
Y.data.busiOrderAttrs.push(aj)})}af.push(Y)};var W=function(){for(var aa=0;aa<OrderInfo.offerSpec.offerRoles.length;aa++){var ab=OrderInfo.offerSpec.offerRoles[aa];if(ab.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return ab}}for(var aa=0;aa<OrderInfo.offerSpec.offerRoles.length;aa++){var ab=OrderInfo.offerSpec.offerRoles[aa];for(var Z=0;Z<ab.roleObjs.length;Z++){var Y=ab.roleObjs[Z];if(Y.objType==CONST.OBJ_TYPE.PROD){return ab}}}};var q=function(aa){if(offerChange.resultOffer==undefined){return}var Y=offerChange.resultOffer.prodInfos;if(ec.util.isArray(Y)){$.each(Y,function(){var ae=this.accProdInstId;var ad=true;$.each(aa.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==ae){ad=false;return false}});if(ad){return true}if(ae!=this.prodInstId){var af=CacheData.getServ(ae,this.prodInstId);if(this.state=="DEL"){if(af!=undefined){var ac=$("#li_"+ae+"_"+this.prodInstId).find("span");ac.addClass("del");af.isdel="Y";$("#del_"+ae+"_"+this.prodInstId).hide()}}else{if(this.state=="ADD"){if(af!=undefined){$("#del_"+ae+"_"+this.prodInstId).hide()}else{var ab=CacheData.getServSpec(ae,this.productId);if(ab!=undefined){$("#del_"+ae+"_"+this.productId).hide()}else{if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(ae,this.productId)}}}}}}})}var Z=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(Z)){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){var ab=this.objInstId;$.each(Z,function(){if(this.memberInfo==undefined){return true}var ae=CacheData.getOffer(ab,this.prodOfferInstId);var ad=true;$.each(this.memberInfo,function(){if(ab==this.accProdInstId){if(ec.util.isObj(ae)){this.prodId=this.accProdInstId}ad=false;return false}});if(ad){return true}if(this.state=="DEL"){if(ae!=undefined){var ac=$("#li_"+ab+"_"+this.prodOfferInstId).find("span");ac.addClass("del");ae.isdel="Y";if(this.isRepeat!="Y"){this.isRepeat="Y"}else{ae.isRepeat="Y"}$("#del_"+ab+"_"+this.prodOfferInstId).hide()}}else{if(this.state=="ADD"){if(ae!=undefined){$("#del_"+ab+"_"+this.prodOfferInstId).hide()}else{var af=CacheData.getOfferSpec(ab,this.prodOfferId);if(af!=undefined){$("#del_"+ab+"_"+this.prodOfferId).hide()}else{if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(ab,this.prodOfferId)}}}}}})})}}};return{showOfferCfgDialog:I,closeDialog:N,submit:K,offerProd:F,ischooseOffer:u,removeAndAdd:R,queryofferinfo:m,addNum:H,checkOrder:i,checkOfferProd:q,getSimulateData:b,fillmemberChange:D,delNum:j,reloadFlag:f,newSubPhoneNum:t,oldSubPhoneNum:O,mktResInstCode:C,newmembers:w,oldmembers:c,delmembers:A,changemembers:y,rejson:n,newMemberFlag:X,oldMemberFlag:h,changeMemberFlag:s,viceCartNum:U,viceparams:P,ooRoless:r,areaidJurisdiction:a,viceCartNum:U}}();$(function(){$("#memeberChangeclose").click(function(){order.memberChange.closeDialog()});$("#memeberChange .btna_o:first").click(function(){$("#memeberChange .btna_o:first").removeClass("btna_o").addClass("btna_g");order.memberChange.submit();$("#memeberChange .btna_g:first").removeClass("btna_g").addClass("btna_o")});$("#memeberChange .btna_o:last").click(function(){order.memberChange.closeDialog()})});CommonUtils.regNamespace("order","dealers");order.dealers=(function(){var b=function(F){$("#dealerTbody").html("");var H=OrderInfo.data;var x="";for(var C=0;C<H.orderList.custOrderList[0].busiOrder.length;C++){x=H.orderList.custOrderList[0].busiOrder[C];if(x.boActionType.actionClassCd=="1200"&&x.boActionType.boActionTypeCd=="S1"&&x.busiObj.offerTypeCd=="1"){break}}var E=x.data;var w=x.busiObj.objId;var v=x.busiObj.accessNumber;if(!ec.util.isArray(OrderInfo.order.dealerTypeList)){$.ecOverlay("<strong>正在查询发展人类型中,请稍后....</strong>");var o=$.callServiceAsJson(contextPath+"/order/queryPartyProfileSpecList",null);$.unecOverlay();if(o.code==0){OrderInfo.order.dealerTypeList=o.data}else{if(o.code==-2){$.alertM(o.data);return}else{$.alert("信息提示",o.msg);return}}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==14){var z=OrderInfo.dealers;var q=E.ooRoles;var s=E.busiOrderAttrs;var t=E.ooOwners;for(var C=0;C<s.length;C++){if(s.length==1){var p=w;var G=$("<tr id='tr_"+p+"' name='tr_"+p+"'></tr>");var y=$("<td></td>");var w=p+"_"+OrderInfo.SEQ.dealerSeq;var D=$('<select id="dealerType_'+w+'" name="dealerType_'+p+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+p+"',a)\"></select>");if(order.ysl!=undefined){D.append("<option value='40020005'>第一发展人</option>");D.append("<option value='40020006'>第二发展人</option>");D.append("<option value='40020007'>第三发展人</option>")}else{$.each(OrderInfo.order.dealerTypeList,function(){D.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")})}y.append(D);y.append('<label class="f_red">*</label>');var B="主套餐";G.append("<td>"+B+"</td>");G.append("<td>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</td>");G.append(y);if(order.ysl!=undefined){var r=$('<td><input type="text" id="dealer_'+w+'" staffId="'+s[C-1].value+'" value="'+s[C].value+'" class="inputWidth183px"></input></td>')}else{var r=$('<td><input type="text" id="dealer_'+w+'" staffId="'+s[C-1].value+'" value="'+s[C].value+'" class="inputWidth183px" readonly="readonly" ></input></td>')}r.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+w+"');\">选择</a>");r.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+p+',1)">添加</a><label class="f_red">*</label>');G.append(r);$("#dealerTbody").append(G);break}else{if(C%2!=0){var A=OrderInfo.offerSpec.offerSpecId;var u=s[C].value;h(A+"_"+w,u)}}}}};var n=function(s,p){var r="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var u=this.PARTYPRODUCTRELAROLECD;var t=true;$("select[name='dealerType_"+s+"']").each(function(){if(u==$(this).val()){t=false;return false}});if(t){r=u;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(r==undefined||r==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var q=$("<td></td>");var o=$('<select id="dealerType_'+p+'" name="dealerType_'+s+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+s+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==r){o.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{o.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});q.append(o);q.append('<label class="f_red">*</label>');return q};var h=function(q,x){var r="主套餐";var u=q.split("_")[0];if($("#tr_"+q)[0]==undefined){var o=q+"_"+OrderInfo.SEQ.dealerSeq;var v=n(q,o);if(v==undefined){return false}var w=$("#atr_"+q);var y=$('<tr name="tr_'+q+'"></tr>');y.append("<td>"+r+"</td>");y.append("<td>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</td>");y.append(v);var z=$("#tr_"+u).find("input");var t=1;var s="";if(z[0]==undefined){t=OrderInfo.staff.staffId;s=OrderInfo.staff.staffName}else{t=z.attr("staffId");s=z.attr("value")}if(order.ysl!=undefined){var p=$('<td><input type="text" id="dealer_'+o+'" name="dealer_'+q+'" staffId="'+t+'" value="'+x+'" class="inputWidth183px" style="margin-left:45px;"></input></td>')}else{var p=$('<td><input type="text" id="dealer_'+o+'" name="dealer_'+q+'" staffId="'+t+'" value="'+x+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>')}p.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+o+"');\">选择</a>");p.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');p.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+q+'\')">添加</a><label class="f_red">*</label>');
y.append(p);$("#dealerTbody").append(y);OrderInfo.SEQ.dealerSeq++}};var g=function(o,r,q){var p=0;$("select[name="+r+"]").each(function(){if($(this).val()==$(o).val()){p++}});if(p>1){$.alert("信息提示","每个业务的发展人类型不能重复");$(o).val(q)}};var f=function(){$("input[name=attach_dealer]:checked").each(function(){var q=$(this).attr("id");var s=q.split("_")[0];if($("#tr_"+q)[0]==undefined){var o=q+"_"+OrderInfo.SEQ.dealerSeq;var t=c(q,o);if(t==undefined){return false}var v=$("#atr_"+q);var w=$('<tr name="tr_'+q+'"></tr>');w.append("<td>"+v.children().eq(1).text()+"</td>");w.append("<td>"+v.children().eq(2).text()+"</td>");w.append(t);var x=$("#tr_"+s).find("input");var u=1;var r="";if(x[0]==undefined){u=OrderInfo.staff.staffId;r=OrderInfo.staff.staffName}else{u=x.attr("staffId");r=x.attr("value")}if(order.ysl!=undefined){var p=$('<td><input type="text" id="dealer_'+o+'" name="dealer_'+q+'" staffId="'+u+'" value="'+r+'" class="inputWidth183px" style="margin-left:45px;"></input></td>')}else{var p=$('<td><input type="text" id="dealer_'+o+'" name="dealer_'+q+'" staffId="'+u+'" value="'+r+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>')}p.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+o+"');\">选择</a>");p.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');p.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+q+'\')">添加</a><label class="f_red">*</label>');w.append(p);$("#dealerTbody").append(w);OrderInfo.SEQ.dealerSeq++}});easyDialog.close()};var i=function(t,v,q){var o=$(t).parent().parent();var p=v+"_"+OrderInfo.SEQ.dealerSeq;var s=c(v,p);if(s==undefined){return}var r=$('<tr name="tr_'+v+'"></tr>');if(OrderInfo.actionFlag!=13){r.append("<td>"+o.find("td").eq(0).text()+"</td>");r.append("<td>"+o.find("td").eq(1).text()+"</td>")}r.append(s);if(order.ysl!=undefined){var u=$('<td><input type="text" id="dealer_'+p+'" name="dealer_'+v+'" staffId="'+o.find("input").attr("staffId")+'" value="'+o.find("input").attr("value")+'" class="inputWidth183px" ></input></td>')}else{var u=$('<td><input type="text" id="dealer_'+p+'" name="dealer_'+v+'" staffId="'+o.find("input").attr("staffId")+'" value="'+o.find("input").attr("value")+'" class="inputWidth183px" readonly="readonly" ></input></td>')}u.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+p+"');\">选择</a>");u.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');r.append(u);o.after(r);OrderInfo.SEQ.dealerSeq++};var l=function(p,o){$("tr[name^='tr_"+p+"']").each(function(){$(this).find("td").eq(0).text(o)})};var c=function(s,p){var r="";if(order.ysl!=undefined){OrderInfo.order.dealerTypeList=[{PARTYPRODUCTRELAROLECD:40020005,NAME:"第一发展人"},{PARTYPRODUCTRELAROLECD:40020006,NAME:"第二发展人"},{PARTYPRODUCTRELAROLECD:40020007,NAME:"第三发展人"}]}if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var u=this.PARTYPRODUCTRELAROLECD;var t=true;$("select[name='dealerType_"+s+"']").each(function(){if(u==$(this).val()){t=false;return false}});if(t){r=u;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(r==undefined||r==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var q=$("<td></td>");var o=$('<select id="dealerType_'+p+'" name="dealerType_'+s+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+s+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==r){o.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{o.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});q.append(o);q.append('<label class="f_red">*</label>');return q};var m=function(){$("#attach_tbody").empty();$.each(AttachOffer.openList,function(){var x=this.prodId;var w="";if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){for(var v=0;v<OrderInfo.oldprodInstInfos.length;v++){if(x==OrderInfo.oldprodInstInfos[v].prodInstId){w=OrderInfo.oldprodInstInfos[v].accNbr}}}else{w=OrderInfo.getAccessNumber(x)}if(w==undefined||w==""){w="未选号"}$.each(this.specList,function(){var z=x+"_"+this.offerSpecId;if(this.isdel!="Y"&&this.isdel!="C"&&$("tr[name='tr_"+z+"']")[0]==undefined){var y=$('<tr id="atr_'+z+'" onclick="order.dealer.checkAttach(\''+z+"')\"></tr>");y.append('<td><input type="checkbox" id="'+z+'" onclick="order.dealer.checkAttach(\''+z+'\')" name="attach_dealer"/></td>');y.append("<td>"+w+"</td><td>"+this.offerSpecName+"</td>");$("#attach_tbody").append(y)}})});if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){for(var o=0;o<order.ysl.openList.length;o++){if(order.ysl.openList[o].type=="1"){var s="-1";var p=$("#choosedNumSpan").val();if(p==undefined||p==""){p="未选号"}var t="N";var q=$("#dealerTbody").find("tr");q.each(function(){if($(this).attr("name")=="tr_-1_"+order.ysl.openList[o].id){t="Y"}else{t="N"}});if(t=="N"){var u=s+"_"+order.ysl.openList[o].id;var r=$('<tr id="atr_'+u+'" onclick="order.dealer.checkAttach(\''+u+"')\"></tr>");r.append('<td><input type="checkbox" id="'+u+'" onclick="order.dealer.checkAttach(\''+u+'\')" name="attach_dealer"/></td>');r.append("<td>"+p+"</td><td>"+order.ysl.openList[o].name+"</td>");$("#attach_tbody").append(r)}}}}}easyDialog.open({container:"div_attach_dialog"})};var k=function(q){var p=$("#atr_"+q);var o=$("#"+q);if(o.attr("checked")=="checked"){p.removeClass("plan_select");o.attr("checked",false)}else{p.addClass("plan_select");o.attr("checked",true)}};var a=function(o){$(o).parent().parent().remove()};var j=function(o){$("tr[name^='tr_"+o+"']").each(function(){$(this).remove()})};return{getDealerTypeSub:n,addAttachDealerSub:h,initDealer:b,changeAccNbr:l,showOfferList:m,addProdDealer:i,addAttachDealer:f,checkAttach:k,removeDealer:a,removeAttDealer:j,changeDealer:g}})();CommonUtils.regNamespace("offerChange");offerChange=(function(){var j={};var i=0;var u=0;var c=[];var g=false;var o=false;var k=function(){var A=order.prodModify.choosedProdInfo;if(A.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=2;if(OrderInfo.provinceInfo.mergeFlag=="0"){if(!query.offer.setOffer()){return}}var B=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,instId:A.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:A.prodInstId},{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,instId:A.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:A.prodInstId}];if(!rule.rule.ruleCheck(B)){return}$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var z=$.callServiceAsHtmlGet(contextPath+"/token/pc/order/prodoffer/prepares",{});$.unecOverlay();if(z.code!=0){$.alert("提示","查询失败,稍后重试");return}SoOrder.step(0,z.data);$("#search").bind("click",function(){order.service.searchPack()});order.prodOffer.init();order.service.searchPack()};var x=function(){c=[];offerChange.newMemberFlag=false;offerChange.oldMemberFlag=false;var D=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==2){D++}});var F=1;var C=0;if(D>1){F=2}if(!t(F,C)){return}if(OrderInfo.actionFlag==2){var B=[];var E=[];if(order.memberChange.newSubPhoneNum!=""){B=order.memberChange.newSubPhoneNum.split(",")}if(order.memberChange.oldSubPhoneNum!=""){E=order.memberChange.oldSubPhoneNum.split(",")}var A=0;var z=$("#member_tbody");z.html("");$("#main_title").text(OrderInfo.offerSpec.offerSpecName);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd=="401"){var H=this;var G=$("<tr style='background:#f8f8f8;'></tr>");var I=$('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'+H.offerRoleName+"</span>&nbsp;&nbsp;</td>");if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){G.append(I).append($("<td colspan='3'></td>")).appendTo(z)}else{G.append(I).appendTo(z)}$.each(this.roleObjs,function(){var M=H.offerRoleId+"_"+this.objId;
if(this.objType==CONST.OBJ_TYPE.PROD){c.push(M);if(H.minQty==0){this.minQty=0;this.dfQty=0}var L=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd=="401"){L++}});A=this.maxQty<0?"不限制":this.maxQty-L;if(A<0){A=0}u=A;G.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'><a class='add' href='javascript:order.service.subNum(\""+M+'",'+this.minQty+");'></a><input id='"+M+"' type='text' value='"+B.length+"' class='numberTextBox width22' readonly='readonly'><a class='add2' href='javascript:order.service.addNum(\""+M+'",'+A+',"'+H.parentOfferRoleId+"\");'> </a></i>"+this.minQty+"-"+A+"（张） </td>");if(A>0){if(E.length==0){var J="<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'><td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td><td align='left' colspan='3'><input value='' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' ><a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+A+',"");\'> </a>'+this.minQty+"-"+A+"（张）</td></tr>";G.after(J)}else{for(var K=0;K<E.length;K++){if(K==0){var J="<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'><td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td><td align='left' colspan='3'><input value='"+E[K]+"' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' ><a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+A+',"");\'> </a>'+this.minQty+"-"+A+"（张）</td></tr>";G.after(J)}else{order.memberChange.addNum(A,E[K])}}}}}})}});easyDialog.open({container:"member_dialog"})}};var l=function(){if(CONST.getAppDesc()==0){if(order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){if(!offerChange.checkOrder()){return}}if(!prod.uim.setProdUim()){return}}OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldprodAcctInfos=[];OrderInfo.oldAddNumList=[];var A=0;var z=0;order.memberChange.viceCartNum=0;var B=[];$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd=="401"){if(this.prodInsts!=undefined){var G=this.prodInsts;for(var F=0;F<this.prodInsts.length;F++){var E='"'+this.prodInsts[F].prodInstId+'"';if(E.indexOf("-")!=-1){B.push(this.prodInsts[F])}}$.each(B,function(){var H=this.prodInstId;$.each(G,function(I){if(this.prodInstId=H){G.splice(I,1)}})})}}});$.each(c,function(){A=A+Number($("#"+this).val())});$("#member_tbody").find("tr[name='oldnbr']").each(function(){var E=$.trim($(this).children("td").eq(1).children("input").val());if(ec.util.isObj(E)){z++}});if(A>0){offerChange.newMemberFlag=true;order.service.setOfferSpec()}if(z>0){offerChange.oldMemberFlag=true;if(!order.memberChange.queryofferinfo()){return}}if(parseInt(A)+parseInt(order.memberChange.viceCartNum)>u){$.alert("提示","加装数量已经超过能加装的最大数量【"+u+"】!");return}var C=order.prodModify.choosedProdInfo;var D={boActionTypeCd:"S2",boActionTypeName:"套餐变更",actionFlag:"2",offerSpec:OrderInfo.offerSpec,prodId:C.prodInstId,offerMembers:OrderInfo.offer.offerMemberInfos,oldOfferSpecName:C.prodOfferName,prodClass:C.prodClass,appDesc:CONST.getAppDesc(),areaId:order.prodModify.choosedProdInfo.areaId,newnum:parseInt(A),oldnum:parseInt(z)};if(z>0){D.oldprodInstInfos=OrderInfo.oldprodInstInfos;D.oldofferSpec=OrderInfo.oldofferSpec;D.oldoffer=OrderInfo.oldoffer}order.main.buildMainView(D);$("#member_dialog").hide();$("#overlay").hide()};var p=function(z,E){SoOrder.initFillPage();$("#order_fill_content").html(z.data);$("#fillNextStep").off("click").on("click",function(){SoOrder.submitOrder()});$("#fillNextStep1").off("click").on("click",function(){SoOrder.submitOrder()});$("#fillLastStep").off("click").on("click",function(){order.main.lastStep()});var Q=order.prodModify.choosedProdInfo;var O=false;$.each(OrderInfo.offerSpec.offerRoles,function(){var S=this;if(ec.util.isArray(this.prodInsts)){$.each(this.prodInsts,function(){var V="'"+this.prodInstId+"'";if(V.indexOf("-")==-1){var ag=this.prodInstId;var Y={areaId:OrderInfo.getProdAreaId(ag),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ag,prodSpecId:this.objId,offerSpecId:Q.prodOfferId,offerRoleId:this.offerRoleId,acctNbr:this.accessNumber};var ah=this.accessNumber;var an=query.offer.queryChangeAttachOffer(Y);$("#attach_"+ag).html(an);if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){Y.queryType="1,2";Y.objId=this.objId;Y.objType=this.objType;Y.memberRoleCd=this.roleCd;Y.offerSpecId=OrderInfo.offerSpec.offerSpecId;var am=query.offer.queryDefMustOfferSpec(Y);CacheData.parseOffer(am);Y.queryType="1";var am=query.offer.queryServSpec(Y);CacheData.parseServ(am)}AttachOffer.showMainRoleProd(ag);var ac=[];if(AttachOffer.openServList!=null&&AttachOffer.openServList!=undefined){$.each(AttachOffer.openServList,function(){if(this.prodId==Y.prodId){var ao=this.servSpecList;if(ao!=null&&ao!=undefined){$.each(ao,function(){if(this.servSpecId!=null&&this.servSpecId!=undefined){ac.push(this.servSpecId)}})}}})}if(ac.length>0){Y.queryType="1,2";Y.servSpecIds=ac;var T=query.offer.queryServSpecPost(Y);if(T!=null&&T.resultCode==0){if(T.result.offerList!=null&&T.result.offerList!=undefined){$.each(T.result.offerList,function(){AttachOffer.addOpenList(Y.prodId,this.offerSpecId)})}}}AttachOffer.changeLabel(ag,this.objId,"");if(AttachOffer.isChangeUim(ag)){if(OrderInfo.mktResInstCode!=undefined&&OrderInfo.mktResInstCode!="null"&&OrderInfo.mktResInstCode!=null&&OrderInfo.mktResInstCode!=""){var Z=OrderInfo.mktResInstCode.split(",");if(Z!=null&&Z.length>0){var aj="";var ad="";var aa="0";for(var ak=0;ak<Z.length;ak++){var W=Z[ak].split("_");if(W!=null&&W.length==2){var af=W[0];var ae=W[1];if(aj!=null&&aj!=""){if(aj==af||ad==ae){aa="1";break}}else{aj=af;ad=ae}}}if(aa=="1"){$.alert("提示","传入的UIM参数中存在重复数据,参数为["+OrderInfo.mktResInstCode+"]")}else{var U="";for(var ak=0;ak<Z.length;ak++){var W=Z[ak].split("_");if(W!=null&&W.length==2){var ai=W[0];var al=W[1];if(ai==ah){U=al}}}if(U!=null&&U!=""&&U!="null"){h(U,ag);$("#uim_check_btn_"+ag).hide();$("#uim_release_btn_"+ag).hide()}}}}i++;if(!O){$("#uimDiv_"+ag).show()}else{$("#uimDiv_"+ag).hide()}}O=true}else{var X=this;var Y={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:X.objId,offerRoleId:X.offerRoleId,prodId:X.prodInstId,queryType:"1,2",objType:X.objType,objId:X.objId,memberRoleCd:X.memberRoleCd};AttachOffer.queryAttachOfferSpec(Y);var ab={ul_id:"item_order_"+X.prodInstId,prodId:X.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:X.objId,roleCd:S.roleCd,offerRoleId:S.offerRoleId,partyId:OrderInfo.cust.custId};order.main.spec_parm(ab)}})}});if(offerChange.newMemberFlag){order.main.initAcct(0)}if(offerChange.oldMemberFlag){order.main.initAcct(1);order.main.loadAttachOffer()}$("#zhanghuclose").click(function(){easyDialog.close();$(document).removeJEventListener("queryAccount")});order.dealer.initDealer();w();if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"&&OrderInfo.offerSpec.is3G=="N"){offerChange.checkOfferProd()}var K=[];var I=true;if(order.memberChange.newSubPhoneNum!=""&&OrderInfo.reloadFlag=="Y"){var P=order.memberChange.newSubPhoneNum.split(",");for(var M=0;M<P.length;M++){if(P[M]!=""&&P[M]!=null&&P[M]!="null"){$.each(K,function(){if(this==P[M]){I=false;return false}else{I=true}});if(I){K.push(P[M]);$("#nbr_btn_-"+(M+1)).removeAttr("onclick");$("#nbr_btn_-"+(M+1)).removeClass("selectBoxTwo");$("#nbr_btn_-"+(M+1)).addClass("selectBoxTwoOn");var E={phoneNum:P[M]};var R=order.phoneNumber.queryPhoneNumber(E);if(R.datamap.baseInfo){$("#nbr_btn_-"+(M+1)).html(P[M]+"<u></u>");var N={prodId:"-"+(M+1),accessNumber:R.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:R.datamap.baseInfo.phoneNumId,pnLevelId:R.datamap.baseInfo.phoneLevelId,anTypeCd:R.datamap.baseInfo.pnTypeId,state:"ADD",areaId:R.datamap.baseInfo.areaId,areaCode:R.datamap.baseInfo.zoneNumber,memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,preStore:R.datamap.baseInfo.prePrice,minCharge:R.datamap.baseInfo.pnPrice};
OrderInfo.boProdAns.push(N);order.dealer.changeAccNbr("-"+(M+1),P[M])}}else{$.alert("提示","号码"+P[M]+"重复输入")}}}}if(OrderInfo.mktResInstCode!=""&&OrderInfo.reloadFlag=="Y"){K=[];I=true;var A="-1";var G=OrderInfo.mktResInstCode.split(",");for(var J=0;J<G.length;J++){if(G[J]!=""&&G[J]!=null&&G[J]!="null"&&order.memberChange.newSubPhoneNum!=""){var L=G[J].split("_");var C=L[0];var D=L[1];var P=order.memberChange.newSubPhoneNum.split(",");var F=false;$.each(K,function(){if(this==C){I=false;return false}else{I=true}});if(!I){$.alert("提示","UIM卡"+D+"对应的号码重复");return}for(var M=0;M<P.length;M++){if(P[M]==C){K.push(P[M]);F=true;$("#uim_txt_-"+(M+1)).attr("disabled",true);var B={instCode:D};var z=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",B);if(z.code==0){if(z.data.mktResBaseInfo){if(z.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_-"+(M+1)).attr("disabled",true);$("#uim_check_btn_-"+(M+1)).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_-"+(M+1)).attr("disabled",false);$("#uim_release_btn_-"+(M+1)).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_-"+(M+1)).val(D);var H={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:z.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:z.data.mktResBaseInfo.qty,storeId:z.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:D,terminalCode:D,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-(M+1),offerId:A,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(-(M+1));OrderInfo.boProd2Tds.push(H)}else{$.alert("提示","UIM卡不是预占状态，当前为"+z.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(z.code==-2){$.alertM(z.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}break}}if(!F){$.alert("提示","UIM卡"+D+"未匹配到接入号")}}}}if(OrderInfo.provinceInfo.salesCode!=""&&OrderInfo.reloadFlag=="Y"){order.main.queryDealer()}};function h(C,D){var B={instCode:C};var A=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",B);if(A.code==0){if(A.data.mktResBaseInfo){if(A.data.mktResBaseInfo.statusCd=="1102"){$("#uim_txt_"+D).val(C);var z={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:A.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:A.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:C,ruleId:"",partyId:OrderInfo.cust.custId,prodId:D,offerId:-1,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(D);OrderInfo.boProd2Tds.push(z)}else{$.alert("提示","UIM卡["+C+"]不是预占状态，当前为"+A.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM卡["+C+"]信息")}}else{if(A.code==-2){$.alertM(A.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}var r=function(z){q(z,OrderInfo.offer);s(z,OrderInfo.offer);AttachOffer.setAttachBusiOrder(z);if(CONST.getAppDesc()==0){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var A={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var B=OrderInfo.getProdBusiOrder(A);if(B){z.push(B)}}}})}}};var q=function(z,B){B.offerTypeCd=1;B.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;var A=order.prodModify.choosedProdInfo;OrderInfo.getOfferBusiOrder(z,B,A.prodInstId)};var s=function(I,B){var G=order.prodModify.choosedProdInfo;var A=OrderInfo.offerSpec;var H={areaId:OrderInfo.getProdAreaId(G.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.SEQ.offerSeq--,objName:A.offerSpecName,objId:A.offerSpecId,offerTypeCd:"1",accessNumber:G.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};$.each(A.offerRoles,function(){var S=this;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){var T='"'+this.prodInstId+'"';if(T.indexOf("-")==-1){var U={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,offerRoleId:S.offerRoleId,state:"ADD"};H.data.ooRoles.push(U)}})}});if(offerChange.oldMemberFlag){var O="";for(var P=0;P<OrderInfo.offerSpec.offerRoles.length;P++){var M=OrderInfo.offerSpec.offerRoles[P];if(M.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){O=M.offerRoleId;break}}for(var K=0;K<OrderInfo.oldprodInstInfos.length;K++){var J=OrderInfo.oldprodInstInfos[K];var C={areaId:J.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:J.mainProdOfferInstInfos[0].prodOfferId,instId:J.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:J.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var R=-1;for(var P=0;P<OrderInfo.oldoffer.length;P++){if(OrderInfo.oldoffer[P].accNbr==J.accNbr){$.each(OrderInfo.oldoffer[P].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var S={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:R,offerRoleId:O,state:"ADD"};H.data.ooRoles.push(S);var T={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};C.data.ooRoles.push(T);--R}})}}I.push(C)}if(CONST.getAppDesc()==0){for(var P=0;P<OrderInfo.oldoffer.length;P++){$.each(OrderInfo.oldoffer[P].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var S={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var T=OrderInfo.getProdBusiOrder(S);if(T){I.push(T)}}}})}}}if(offerChange.newMemberFlag){for(var P=0;P<OrderInfo.offerSpec.offerRoles.length;P++){var M=OrderInfo.offerSpec.offerRoles[P];if(M.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(M.prodInsts!=undefined&&M.prodInsts.length>0){for(var N=0;N<M.prodInsts.length;N++){var D=M.prodInsts[N];var L='"'+D.prodInstId+'"';if(D.memberRoleCd=="401"&&L.indexOf("-")!=-1){var F={objId:D.objId,objInstId:D.prodInstId,objType:D.objType,offerMemberId:OrderInfo.SEQ.offerMemberSeq--,offerRoleId:D.offerRoleId,state:"ADD"};H.data.ooRoles.push(F);I.push(SoOrder.createProd(D.prodInstId,D.objId))}}}}}}if(ec.util.isArray(A.offerSpecParams)){H.data.ooParams=[];for(var P=0;P<A.offerSpecParams.length;P++){var E=A.offerSpecParams[P];var z={itemSpecId:E.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:E.offerSpecParamId,value:E.value,state:"ADD"};H.data.ooParams.push(z)}}if(A.ooTimes!=undefined){H.data.ooTimes=[];H.data.ooTimes.push(A.ooTimes)}H.data.busiOrderAttrs=[];var Q=$("tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(Q!=undefined){Q.each(function(){var S={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()};H.data.busiOrderAttrs.push(S);var T={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};H.data.busiOrderAttrs.push(T)})}I.push(H)};var f=function(A){$.each($("#tab_"+A).parent().find("li"),function(){$(this).removeClass("setcon");$("#attach_tab_"+$(this).attr("prodId")).hide();$("#uimDiv_"+$(this).attr("prodId")).hide();$("#change_"+$(this).attr("prodId")).hide();$("#newProd_"+$(this).attr("prodId")).hide()});$("#tab_"+A).addClass("setcon");$("#attach_tab_"+A).show();$("#change_"+A).show();if(AttachOffer.isChangeUim(A)){$("#title_"+A).show();$("#uimDiv_"+A).show()}if(OrderInfo.actionFlag==6||OrderInfo.actionFlag==2){var z=false;
if(OrderInfo.actionFlag==6){$.each(order.memberChange.viceparams,function(){if(this.objInstId==A){z=true;return false}})}if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==A){z=true;return false}})}if(z){$("#accountDiv").hide();$("#orderAttrDiv").hide();$("#orderProvAttrDiv").show()}else{$("#accountDiv").show();$("#orderProvAttrDiv").hide();var B="'"+A+"'";if(B.indexOf("-")!=-1){$("#newProd_"+A).show();$("#orderAttrDiv").show()}else{$("#orderAttrDiv").hide()}}}};var n=function(A){if(OrderInfo.actionFlag==3){m()}else{v()}var z=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(z==undefined){return false}if(z.resultCode==0&&ec.util.isObj(z.result)){offerChange.resultOffer=z.result}else{$.alert("预校验规则限制",z.resultMsg);offerChange.resultOffer={};return false}return true};var m=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;var D=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;for(var C=0;C<AttachOffer.openList.length;C++){var B=AttachOffer.openList[C];for(var A=0;A<B.specList.length;A++){var z=B.specList[A];if(z.isdel!="Y"&&z.isdel!="C"&&z.ifPackage4G=="Y"){z.offerTypeCd=2;z.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;z.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(D,z,B.prodId)}}}$.each(D,function(){this.busiObj.state="ADD"})};var t=function(z,I){if(z==1){var H=y();if(H==undefined){alert("错误提示","无法变更到该套餐");return false}H.prodInsts=[];var G=false;$.each(H.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var J=this;G=false;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(J.objId!=this.objId){$.alert("规则限制","新套餐【"+J.offerRoleName+"】角色的规格ID【"+J.objId+"】和旧套餐【"+this.roleName+"】角色的规格ID【"+this.objId+"】不一样");G=true;return false}J.prodInstId=this.objInstId;J.accessNumber=this.accessNumber;J.memberRoleCd=this.roleCd;H.prodInsts.push(J)}});if(G){return false}}});if(G){return false}}else{for(var D=0;D<OrderInfo.offer.offerMemberInfos.length;D++){var B=OrderInfo.offer.offerMemberInfos[D];if(B.objType==CONST.OBJ_TYPE.PROD){var G=true;for(var C=0;C<OrderInfo.offerSpec.offerRoles.length;C++){var H=OrderInfo.offerSpec.offerRoles[C];if(B.roleCd==H.memberRoleCd){for(var A=0;A<H.roleObjs.length;A++){var F=H.roleObjs[A];if(F.objType==CONST.OBJ_TYPE.PROD){if(F.objId!=B.objId){$.alert("规则限制","新套餐【"+F.offerRoleName+"】角色的规格ID【"+F.objId+"】和旧套餐【"+B.roleName+"】角色的规格ID【"+B.objId+"】不一样");return false}if(!ec.util.isArray(H.prodInsts)){H.prodInsts=[]}var E=jQuery.extend(true,{},F);E.prodInstId=B.objInstId;E.accessNumber=B.accessNumber;E.memberRoleCd=B.roleCd;H.prodInsts.push(E);if(H.prodInsts.length>F.maxQty){$.alert("规则限制","新套餐【"+H.offerRoleName+"】角色最多可以办理数量为"+F.maxQty+",而旧套餐数量大于"+F.maxQty);return false}break}}G=false;break}}if(G){$.alert("规则限制","旧套餐【"+B.roleName+"】角色在新套餐中不存在，无法变更");return false}}}}return true};var y=function(){for(var B=0;B<OrderInfo.offerSpec.offerRoles.length;B++){var C=OrderInfo.offerSpec.offerRoles[B];if(C.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return C}}for(var B=0;B<OrderInfo.offerSpec.offerRoles.length;B++){var C=OrderInfo.offerSpec.offerRoles[B];for(var A=0;A<C.roleObjs.length;A++){var z=C.roleObjs[A];if(z.objType==CONST.OBJ_TYPE.PROD){return C}}}};var v=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.cust.areaId;var z=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;q(z,OrderInfo.offer);s(z,OrderInfo.offer)};var a=function(){if(offerChange.resultOffer==undefined){return}var z=offerChange.resultOffer.prodInfos;if(ec.util.isArray(z)){$.each(z,function(){var F=this.accProdInstId;var D=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==F){D=false;return false}});if(D){return true}if(F!=this.prodInstId){var G=CacheData.getServ(F,this.prodInstId);if(this.state=="DEL"){if(G!=undefined){var C=$("#li_"+F+"_"+this.prodInstId).find("span");C.addClass("del");G.isdel="Y";$("#del_"+F+"_"+this.prodInstId).hide()}}else{if(this.state=="ADD"){if(G!=undefined){$("#del_"+F+"_"+this.prodInstId).hide()}else{var B=CacheData.getServSpec(F,this.productId);if(B!=undefined){$("#del_"+F+"_"+this.productId).hide()}else{var E=this.productName;if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(F,this.productId,this.productName,this.ifParams)}}}}}}})}var A=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(A)){if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){var B=this.objInstId;$.each(A,function(){if(this.memberInfo==undefined){return true}var E=CacheData.getOffer(B,this.prodOfferInstId);var D=true;$.each(this.memberInfo,function(){if(B==this.accProdInstId){if(ec.util.isObj(E)){this.prodId=this.accProdInstId}D=false;return false}});if(D){return true}if(this.state=="DEL"){if(E!=undefined){var C=$("#li_"+B+"_"+this.prodOfferInstId).find("span");C.addClass("del");E.isdel="Y";if(this.isRepeat!="Y"){this.isRepeat="Y"}else{E.isRepeat="Y"}$("#del_"+B+"_"+this.prodOfferInstId).hide()}}else{if(this.state=="ADD"){if(E!=undefined){$("#del_"+B+"_"+this.prodOfferInstId).hide()}else{var F=CacheData.getOfferSpec(B,this.prodOfferId);if(F!=undefined){$("#del_"+B+"_"+this.prodOfferId).hide()}else{if(ec.util.isObj(this.prodOfferId)&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(B,this.prodOfferId)}}}}}})})}}};var b=function(C){var B="";if(offerChange.resultOffer==undefined){return B}var z=offerChange.resultOffer.prodInfos;if(ec.util.isArray(z)){var D="";$.each(z,function(){if(C!=this.accProdInstId){return true}if(C!=this.prodInstId){var F=CacheData.getServ(C,this.prodInstId);var E=CacheData.getServSpec(C,this.productId);if(this.state=="DEL"){if(F!=undefined){D+='<li id="li_'+C+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+F.servSpecName+"</span></li>"}else{if(E!=undefined){D+='<li id="li_'+C+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+E.servSpecName+"</span></li>"}else{if(this.productName!=undefined&&this.productName!=""){D+='<li id="li_'+C+"_"+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span class="del">'+this.productName+"</span></li>"}}}}else{if(this.state=="ADD"){if(F!=undefined){D+='<li id="li_'+C+"_"+this.prodInstId+'"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span>'+F.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(E!=undefined){D+='<li id="li_'+C+"_"+this.prodInstId+'"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span>'+E.servSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(this.productName!=undefined&&this.productName!=""){D+='<li id="li_'+C+"_"+this.prodInstId+'"><dd id="del_'+C+"_"+this.prodInstId+'" class="delete"></dd><span>'+this.productName+'</span><dd class="mustchoose"></dd></li>'}}}}}}});if(D==""){B=""}else{B="<div class='fs_choosed'>订购4G流量包，需订购和取消如下功能产品：<br><ul>"+D+"</ul></div><br>"}}var A=offerChange.resultOffer.prodOfferInfos;if(ec.util.isArray(A)){var D="";$.each(A,function(){if(this.memberInfo==undefined){return true}var E=true;$.each(this.memberInfo,function(){if(ec.util.isObj(this.accProdInstId)&&C==this.accProdInstId){E=false;return false}});if(E){return true}var F=CacheData.getOffer(C,this.prodOfferInstId);var G=CacheData.getOfferSpec(C,this.prodOfferId);if(this.state=="DEL"){if(F!=undefined){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+F.offerSpecName+"</span></li>"
}else{if(G!=undefined){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+G.offerSpecName+"</span></li>"}else{if(this.prodOfferName!=undefined&&this.prodOfferName!=""){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span class="del">'+this.prodOfferName+"</span></li>"}}}}else{if(this.state=="ADD"){if(F!=undefined){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+F.offerSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(G!=undefined){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+G.offerSpecName+'</span><dd class="mustchoose"></dd></li>'}else{if(this.prodOfferName!=undefined&&this.prodOfferName!=""){D+='<li id="li_'+C+"_"+this.prodOfferInstId+'"><dd id="del_'+C+"_"+this.prodOfferInstId+'" class="delete"></dd><span>'+this.prodOfferName+'</span><dd class="mustchoose"></dd></li>'}}}}}});if(D!=""){B+="<div class='fs_choosed'>订购4G流量包，需开通和关闭如下可选包：<br><ul>"+D+"</ul></div>"}}return B};var w=function(){if($("#orderProvAttrIsale")){$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale)}var A=contextPath+"/order/provOrderAttrFlag";$.ecOverlay("<strong>正在查询是否显示省内订单属性,请稍后....</strong>");var z=$.callServiceAsJsonGet(A,{});$.unecOverlay();if(z.code==0){if(z.data!=undefined){if("0"==z.data){$("#orderProvAttrDiv").show();if(order.memberChange.reloadFlag=="N"){var B=order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;$.each(B,function(){if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.PROV_ISALE){$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale)}})}}}}};return{init:k,changeOffer:r,offerChangeView:x,changeTab:f,checkOrder:n,checkAttachOffer:b,fillOfferChange:p,resultOffer:j,checkOfferProd:a,getChangeInfo:v,initOrderProvAttr:w,setChangeOfferSpec:t,offerChangeConfirm:l}})();CommonUtils.regNamespace("query","offer");query.offer=(function(){var C=function(I,H){I.areaId=OrderInfo.cust.areaId;var G=contextPath+"/token/pc/offer/queryOfferSpec";if(typeof(H)=="function"){$.callServiceAsJsonGet(G,I,{before:function(){$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>")},done:function(J){$.unecOverlay();if(J.code==0){if(J.data){H(J.data.offerSpec)}}else{if(J.code==-2){$.alertM(J.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");var F=$.callServiceAsJsonGet(G,I);$.unecOverlay();if(F.code==0){if(F.data){return F.data.offerSpec}}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}};var v=function(I,H){var G=contextPath+"/offer/queryOfferInst";if(typeof(H)=="function"){$.callServiceAsJsonGet(G,I,{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(J){$.unecOverlay();if(J.code==0){if(J.data){H(J.data)}}else{if(J.code==-2){$.alertM(J.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");var F=$.callServiceAsJsonGet(G,I);$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}};var t=function(G){j(G);G.isServiceOpen="Y";var F=contextPath+"/offer/queryMainCartAttachOffer";$.callServiceAsJsonGet(F,G,{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(H){$.unecOverlay();if(H.code==0){if(H.data){var I=H.data.result.offerLists}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})};var w=function(){var F=order.prodModify.choosedProdInfo;var J={offerId:F.prodOfferInstId,offerSpecId:F.prodOfferId,acctNbr:F.accNbr,areaId:F.areaId,distributorId:""};var I=query.offer.queryOfferInst(J);if(I&&I.code==CONST.CODE.SUCC_CODE){var G=true;if(ec.util.isArray(I.offerMemberInfos)){CacheData.sortOffer(I);for(var H=0;H<I.offerMemberInfos.length;H++){var K=I.offerMemberInfos[H];if(K.objType==""){$.alert("提示","销售品实例构成 "+K.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(K.objType==CONST.OBJ_TYPE.PROD){if(K.accessNumber==""){$.alert("提示","销售品实例构成 "+K.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(K.objInstId==F.prodInstId){G=false}}if(G){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+F.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=I.offerMemberInfos;OrderInfo.offer.offerId=F.prodOfferInstId;OrderInfo.offer.offerSpecId=F.prodOfferId;OrderInfo.offer.offerSpecName=F.prodOfferName;return true}else{$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");return false}}};var l=function(I,H){var G=contextPath+"/offer/queryOfferParam";if(typeof(H)=="function"){$.callServiceAsJsonGet(G,I,{before:function(){$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(J){$.unecOverlay();if(J.code==0){if(J.data){H(J.data)}}else{if(J.code==-2){$.alertM(J.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}})}else{$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");var F=$.callServiceAsJsonGet(G,I);$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}};var x=function(I,H){j(I);var G=contextPath+"/offer/queryAttachOffer";if(OrderInfo.actionFlag==22){G=contextPath+"/offer/queryAttachOffer2"}if(typeof(H)=="function"){$.callServiceAsHtmlGet(G,{strParam:JSON.stringify(I)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(J){$.unecOverlay();if(J.code==0){if(J.data){H(J.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var F=$.callServiceAsHtmlGet(G,{strParam:JSON.stringify(I)});$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}};var a=function(H){j(H);var G=contextPath+"/offer/queryOpenedAttachAndServ";$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var F=$.callServiceAsJsonGet(G,{strParam:JSON.stringify(H)});$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var E=function(I,H){j(I);I.isServiceOpen="Y";var G=contextPath+"/token/pc/offer/queryChangeAttachOffer";if(typeof(H)=="function"){$.callServiceAsHtmlGet(G,{strParam:JSON.stringify(I)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(J){$.unecOverlay();if(J.code==0){if(J.data){H(J.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var F=$.callServiceAsHtmlGet(G,{strParam:JSON.stringify(I)});$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{$.alert("提示","查询附属销售品实例失败,稍后重试");return}}};var z=function(I,H){j(I);I.isServiceOpen="Y";var G=contextPath+"/token/pc/offer/queryAttachSpec";if(typeof(H)=="function"){$.callServiceAsHtmlGet(G,{strParam:JSON.stringify(I)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(J){if(J.code==0){if(J.data){H(J.data)}}else{if(J.code==-2){$.alertM(J.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var F=$.callServiceAsHtmlGet(G,{strParam:JSON.stringify(I)});$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{if(F.code==-2){$.alertM(F.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var r=function(I,H){j(I);var G=contextPath+"/offer/queryCanBuyAttachSpec";if(typeof(H)=="function"){$.callServiceAsJsonGet(G,{strParam:JSON.stringify(I)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(J){if(J.code==0){if(J.data){H(J.data)}}else{if(J.code==-2){$.alertM(J.data);
return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var F=$.callServiceAsJsonGet(G,{strParam:JSON.stringify(I)});$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{if(F.code==-2){$.alertM(F.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var g=function(H){j(H);var G=contextPath+"/offer/queryDefaultAndRequiredOfferSpec";$.ecOverlay("<strong>查询默认必须可选包中，请稍等...</strong>");var F=$.callServiceAsJsonGet(G,H);$.unecOverlay();if(F.code==0){OrderInfo.isSuccess="Y";if(F.data){return F.data}}else{if(F.code==-2){$.alertM(F.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var c=function(H){j(H);var G=contextPath+"/offer/queryDefaultAndRequiredOfferSpecAndServ";$.ecOverlay("<strong>查询默认必须可选包和功能产品中，请稍等...</strong>");var F=$.callServiceAsJsonGet(G,H);$.unecOverlay();if(F.code==0){OrderInfo.isSuccess="Y";if(F.data){return F.data}}else{if(F.code==-2){$.alertM(F.data);return}else{$.alert("提示","可订购可选包和功能产品失败,稍后重试");return}}};var n=function(H){j(H);var G=contextPath+"/offer/queryServSpec";$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");var F=$.callServiceAsJsonGet(G,H);$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{if(F.code==-2){$.alertM(F.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var k=function(H){j(H);var G=contextPath+"/offer/queryExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var F=$.callServiceAsJsonGet(G,{strParam:JSON.stringify(H)});$.unecOverlay();if(F.code==0){return F.data}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var i=function(H){j(H);var G=contextPath+"/offer/queryServExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var F=$.callServiceAsJsonGet(G,{strParam:JSON.stringify(H)});$.unecOverlay();if(F.code==0){return F.data}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var o=function(H){j(H);var G=contextPath+"/offer/searchAttachOfferSpec";$.ecOverlay("<strong>附属销售品查询中，请稍等...</strong>");var F=$.callServiceAsHtmlGet(G,{strParam:encodeURI(JSON.stringify(H),"utf-8")});$.unecOverlay();if(F.code==0){return F.data}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","查询附属销售失败，请稍后重试！")}}};var h=function(H){var G=contextPath+"/order/checkOperate";$.ecOverlay("<strong>受理权限查询中，请稍等...</strong>");var F=$.callServiceAsJsonGet(G,"");$.unecOverlay();if(F.code==0){return F.data}else{if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","受理权限查询失败，请稍后重试！")}}};var D=function(H){var G=contextPath+"/order/orderSubmit";if(OrderInfo.order.token!=""){G=contextPath+"/order/orderSubmit?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var F=$.callServiceAsHtml(G,H);$.unecOverlay();if(!F||F.code!=0){return}return F.data};var u=function(H){var G=contextPath+"/order/orderSubmitComplete";if(OrderInfo.order.token!=""){G=contextPath+"/order/orderSubmitComplete?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var F=$.callServiceAsJson(G,H);$.unecOverlay();if(!F||F.code!=0){return}return F.data};var B=function(G){var F=query.offer.queryOfferSpec(G);if(F==undefined){return false}if(F.offerRoles==undefined){$.alert("错误提示","销售品规格构成查询: 返回的销售品规格构成结构不对！");return false}if(F.offerSpecId==undefined||F.offerSpecId==""){$.alert("错误提示","销售品规格构成查询: 销售品规格ID未返回，无法继续受理！");return false}if(F.offerRoles.length==0){$.alert("错误提示","销售品规格构成查询: 成员角色为空，无法继续受理！");return false}if(F.feeType==undefined||F.feeType==""||F.feeType=="null"){$.alert("错误提示","无付费类型，无法新装！");return false}F=SoOrder.sortOfferSpec(F);if((OrderInfo.actionFlag==6||OrderInfo.actionFlag==2||OrderInfo.actionFlag==1)&&ec.util.isArray(OrderInfo.oldprodInstInfos)){OrderInfo.oldofferSpec.push({offerSpec:F,accNbr:G.accNbr})}else{OrderInfo.offerSpec=F}return F};var s=function(I,L){var K={offerSpecId:L,partyId:OrderInfo.cust.custId,offerTypeCd:2};if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){K.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}if(OrderInfo.actionFlag==3){K.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId}if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==I){K.mainOfferSpecId=this.offerSpecId;return false}})}}var J=query.offer.queryOfferSpec(K);if(J==undefined||J.offerRoles==undefined){$.alert("提示","返回的销售品规格构成结构不对！");return false}if(J.offerSpecId==undefined||J.offerSpecId==""){$.alert("提示","销售品规格ID未返回，继续受理将出现异常！");return false}if(J.offerSpecName==undefined||J.offerSpecName==""){$.alert("提示","销售品规格名称未返回，继续受理将出现异常！");return false}var G=[];var H=OrderInfo.getProdSpecId(I);var F=false;$.each(J.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objId==H){F=true;return false}});if(F){G.push(this);return false}});J.offerRoles=G;return J};var q=function(H){var G=contextPath+"/order/prodModify/updateCheckByChange";$.ecOverlay("<strong>正在预校验中，请稍等...</strong>");var F=$.callServiceAsJson(G,H);$.unecOverlay();if(F.code==0){return F.data}else{if(F.code==-2){$.alertM(F.data)}else{if(F.data.resultMsg){$.alert("提示","预校验失败!失败原因为："+F.data.resultMsg)}else{$.alert("提示","预校验失败! 集团营业后台未给出原因。")}}}};var p=function(){if(OrderInfo.order.soNbr==null||OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}if(CONST.getAppDesc()!=0){return true}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){return true}if(order.prodModify==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var F=order.prodModify.choosedProdInfo;if(F==undefined||F.prodInstId==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var J={areaId:OrderInfo.getProdAreaId(F.prodInstId),acctNbr:F.accNbr,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,instId:F.prodInstId,type:"2",queryType:"1,2,3,4,5",acctNbr:"",data:[]};var I=OrderInfo.provinceInfo.mergeFlag;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){var G=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.accessNumber==F.accNbr){G=false;return false}});if(G){if(I!=null&&I!=""&&I!="undefined"&&I=="1"){J.data.push({accessNbr:F.accNbr,instId:F.prodInstId});return f(J)}else{return query.offer.invokeLoadInst(J)}}else{var H=true;if(I!=null&&I!=""&&I!="undefined"&&I=="1"){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){J.data.push({accessNbr:this.accessNumber,instId:this.objInstId})}});if(J!=null){if(!f(J)){H=false;return false}}}else{$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){J.acctNbr=this.accessNumber;J.instId=this.objInstId;if(!query.offer.invokeLoadInst(J)){H=false;return false}}})}return H}}else{if(I!=null&&I!=""&&I!="undefined"&&I=="1"){J.data.push({accessNbr:F.accNbr,instId:F.prodInstId});return f(J)}else{return query.offer.invokeLoadInst(J)}}};var j=function(G){G.staffId=OrderInfo.staff.staffId;G.channelId=OrderInfo.staff.channelId;G.areaId=OrderInfo.getProdAreaId(G.prodId);G.partyId=OrderInfo.cust.custId;G.distributorId=OrderInfo.staff.distributorId;if(OrderInfo.actionFlag==3){G.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId}else{if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==G.prodId){G.mainOfferSpecId=this.offerSpecId;return false}})}}else{G.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}}if(ec.util.isObj(OrderInfo.order.soNbr)){G.soNbr=OrderInfo.order.soNbr}if(order.ysl!=undefined){if(order.ysl.yslbean.yslflag!=undefined){G.yslflag=order.ysl.yslbean.yslflag}}if(OrderInfo.actionFlag==6||OrderInfo.actionFlag==2){for(var F=0;F<OrderInfo.oldprodInstInfos.length;F++){if(G.acctNbr==OrderInfo.oldprodInstInfos[F].accNbr){G.areaId=OrderInfo.oldprodInstInfos[F].areaId;G.partyId=OrderInfo.oldprodInstInfos[F].custId;G.mainOfferSpecId=OrderInfo.oldprodInstInfos[F].mainProdOfferInstInfos[0].prodOfferId
}}if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){if(this.prodId==G.prodId){G.mainOfferSpecId=this.offerSpecId;return false}})}}};var f=function(H){order.prepare.createorderlonger();var G=contextPath+"/token/pc/offer/loadInstNew";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var F=$.callServiceAsJson(G,JSON.stringify(H));$.unecOverlay();if(F.code==0){return true}else{if(F.code==-2){$.alertM(F.data);return false}else{if(F.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",F.msg)}return false}}};var m=function(H){order.prepare.createorderlonger();var G=contextPath+"/offer/loadInst";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var F=$.callServiceAsJsonGet(G,H);$.unecOverlay();if(F.code==0){return true}else{if(F.code==-2){$.alertM(F.data);return false}else{if(F.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",F.msg)}return false}}};var A=function(H){var G=contextPath+"/cust/offerorderprod";$.ecOverlay("<strong>查询产品信息中，请稍等...</strong>");var F=$.callServiceAsJson(G,H);$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var b=function(H){var G=contextPath+"/order/prodInstParam";$.ecOverlay("<strong>查询产品实例属性中，请稍等...</strong>");var F=$.callServiceAsJson(G,H);$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}};var y=function(H){j(H);var G=contextPath+"/offer/queryServSpecPost";$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");var F=$.callServiceAsJson(G,H);$.unecOverlay();if(F.code==0){if(F.data){return F.data}}else{if(F.code==-2){$.alertM(F.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};return{checkOperate:h,loadInst:p,invokeLoadInst:m,setOffer:w,searchAttachOfferSpec:o,queryOfferSpec:C,queryServSpec:n,queryOfferInst:v,queryOfferParam:l,queryAttachOfferHtml:x,queryChangeAttachOffer:E,queryCanBuyAttachSpec:r,queryExcludeDepend:k,queryServExcludeDepend:i,queryAttachSpec:z,queryMainOfferSpec:B,queryAttachOfferSpec:s,queryDefMustOfferSpec:g,queryDefMustOfferSpecAndServ:c,orderSubmit:D,orderSubmitComplete:u,updateCheckByChange:q,queryProduct:A,queryOpenedAttachAndServ:a,queryMainCartAttachOffer:t,queryProdInstParam:b,invokeLoadInstSub:f,queryServSpecPost:y}})();CommonUtils.regNamespace("order","service");order.service=(function(){var H="";var j=false;var u=false;var i=[];var z=0;var m=function(L){var S=OrderInfo.cust.custId;var Q=$("#searchtext").val();if(Q=="请输入您要搜索的套餐名称或首字母简拼"){Q=""}var R="";var I=$("#numsubflag").val();if((R==undefined&&R==null)||I=="number"){R=""}var T=$("#subpageFlag").val();var N={subPage:T,qryStr:Q,pnLevelId:R,custId:S,PageIndex:L,PageSize:10};if($("#price_basic").css("display")!="none"){var M=$("#price_basic a.selected").attr("val");if(M!=null&&M!=""){var P=M.split("-");if(P[0]!=null&&P[0]!=""){N.priceMin=P[0]}if(P[1]!=null&&P[1]!=""){N.priceMax=P[1]}}}if($("#influx_basic").css("display")!="none"){var U=$("#influx_basic a.selected").attr("val");if(U!=null&&U!=""){var K=U.split("-");if(K[0]!=null&&K[0]!=""){N.INFLUXMin=K[0]*1024}if(K[1]!=null&&K[1]!=""){N.INFLUXMax=K[1]*1024}}}if($("#invoice_basic").css("display")!="none"){var J=$("#invoice_basic a.selected").attr("val");if(J!=null&&J!=""){var O=J.split("-");if(O[0]!=null&&O[0]!=""){N.INVOICEMin=O[0]}if(O[1]!=null&&O[1]!=""){N.INVOICEMax=O[1]}}}q(N)};var b=function(J){var I={prodOfferId:J,pnLevelId:"",PageIndex:1,PageSize:10};q(I)};var q=function(K){if(OrderInfo.actionFlag==2){var L=order.prodModify.choosedProdInfo.prodOfferId;if(L!=undefined){K.changeGradeProdOfferId=L}var J="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.objId!=undefined){J=J+","+this.objId}}});if(J!=""){J=J.substring(1,J.length);K.prodSpecId=J}}else{if(CONST.getAppDesc()==0){K.prodOfferFlag="4G"}}var I=contextPath+"/token/pc/order/offerSpecList";$.callServiceAsHtmlGet(I,K,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(N){if(!N){N.data='<li><a href="#" class="ft">暂无套餐</a></li>'}if(N.code==-2){return}else{if(N.code!=0){$.alert("提示","response.code");return}}var M=OrderInfo.newOrderInfo.isReloadFlag;if(M!="N"){jQuery("#service_detial").html(N.data).fadeIn();var O=10;var R=$("#offerlistcont").children().size();if(R==0){var T="<img width='25' height='25' src='"+contextPath+"/image/icon/tip.png'>抱歉，没有找到相关的套餐。";$("#errinfo").html(T);$("#page_navigation").html("")}else{var P=Math.ceil(R/O);$("#current_page").val(0);$("#show_per_page").val(O);var S='<label><span class="pageUpGray" onclick="order.service.previous();">上一页</span></label><label>';var Q=0;while(P>Q){S+='<a class="page_link" href="javascript:order.service.go_to_page('+Q+')" longdesc="'+Q+'">'+(Q+1)+"</a>";Q++}S+='</label><label><span class="nextPageGrayOrange" onclick="order.service.next();">下一页</span></label>';$("#page_navigation").html(S);$("#page_navigation .page_link:first").addClass("pagingSelect");$("#offerlistcont").children().css("display","none");$("#offerlistcont").children().slice(0,O).css("display","table-row");if($(".pagingSelect").next(".page_link").length==false){$(".nextPageGrayOrange").removeClass("nextPageGrayOrange").addClass("nextPageGray")}}}},always:function(){$.unecOverlay()},fail:function(M){$.unecOverlay();$.alert("提示","套餐加载失败，请稍后再试！")}})};var w=function(L,M,I){var N={aoId:L,agreementType:M,numLevel:I};var K=contextPath+"/order/queryPackForTerm";var J=$.callServiceAsJson(K,N,{});return J};var x=function(I,K){var J=OrderInfo.cust.custId;offerprice=K;if(OrderInfo.cust==undefined||J==undefined||J==""){$.alert("提示","在订购套餐之前请先进行客户定位！");return}var M={price:K,specId:I,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};if(OrderInfo.actionFlag==2){order.service.opeSer(M)}else{var L=[{boActionTypeCd:"S1",instId:"",specId:I}];if(rule.rule.ruleCheck(L)){order.service.opeSer(M)}}};var a=function(O){OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldprodAcctInfos=[];OrderInfo.oldAddNumList=[];i=[];var J={offerSpecId:O.specId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var K=query.offer.queryMainOfferSpec(J);if(!K){return}if(OrderInfo.actionFlag==2){var I=contextPath+"/token/pc/order/queryFeeType";$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");var L=$.callServiceAsJsonGet(I,J);$.unecOverlay();if(L.code==0){if(L.data!=undefined){if("0"==L.data){var Q=false;if(order.prodModify.choosedProdInfo.feeType=="2100"&&(K.feeType=="2100"||K.feeType=="3100"||K.feeType=="3101"||K.feeType=="3103"||K.feeType=="1202"||K.feeType=="2101")){Q=true}else{if(order.prodModify.choosedProdInfo.feeType=="1200"&&(K.feeType=="1200"||K.feeType=="3100"||K.feeType=="3102"||K.feeType=="3103"||K.feeType=="1202"||K.feeType=="2101")){Q=true}else{if(order.prodModify.choosedProdInfo.feeType=="1201"&&(K.feeType=="1201"||K.feeType=="3101"||K.feeType=="3102"||K.feeType=="3103")){Q=true}}}if(!Q){$.alert("提示","付费类型不一致,无法进行套餐变更。");return}}}}offerChange.offerChangeView();return}var P=order.memberChange.areaidJurisdiction();var N=0;var M=$("#member_tbody");M.html("");$("#main_title").text(OrderInfo.offerSpec.offerSpecName);$.each(K.offerRoles,function(){var T=this;var S=$("<tr style='background:#f8f8f8;'></tr>");var V=$('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'+T.offerRoleName+"</span>&nbsp;&nbsp;</td>");if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){S.append(V).append($("<td colspan='3'></td>")).appendTo(M)}else{S.append(V).appendTo(M)}$.each(this.roleObjs,function(){var aa=T.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){if(T.memberRoleCd=="401"){i.push(aa)}if(T.minQty==0){this.minQty=0;this.dfQty=0}var W=this.maxQty<0?"不限制":this.maxQty;z=W;var X=this.minQty;if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""&&T.memberRoleCd=="401"){var Y=OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");var Z=Y.length;this.dfQty=Z;this.minQty=Z;this.maxQty=Z;W=Z}if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""&&OrderInfo.newOrderNumInfo.newSubPhoneNum==""&&T.memberRoleCd=="401"){this.maxQty=0;
W=0}S.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'><a class='add' href='javascript:order.service.subNum(\""+aa+'",'+this.minQty+");'></a><input id='"+aa+"' type='text' value='"+this.dfQty+"' class='numberTextBox width22' readonly='readonly'><a class='add2' href='javascript:order.service.addNum(\""+aa+'",'+this.maxQty+',"'+T.parentOfferRoleId+"\");'> </a></i>"+this.minQty+"-"+W+"（张） </td>");N++}});var U=$("<tr></tr>");var R=0;$.each(this.roleObjs,function(){var Y=T.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.SERV){if(R%4==0){U=$("<tr></tr>");U.appendTo(M)}var X=$('<input id="'+Y+'" name="'+T.offerRoleId+'" type="checkbox">'+this.objName+"</input>");if(this.minQty==0){if(this.dfQty>0){X.attr("checked","checked")}}else{if(this.minQty>0){X.attr("checked","checked");X.attr("disabled","disabled")}}var W=$("<td></td>");W.append(X).appendTo(U);R++;N++}});if(T.memberRoleCd=="401"&&P!=""&&P.net_vice_card=="0"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var W=this.maxQty<0?"不限制":this.maxQty;var Y=this.minQty;var aa=OrderInfo.oldSubPhoneNum.oldSubPhoneNum;if(this.maxQty!=0){var ab=OrderInfo.oldSubPhoneNum.oldSubPhoneNum;var Z="<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'><td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td><td align='left' colspan='3'><input value='' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' ><a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+W+',"");\'> </a>'+Y+"-"+W+"（张）</td></tr>";M.append(Z);if(aa!=null&&aa!=""){var ab=aa.split(",");if(ab!=null&&ab.length>0){for(var X=0;X<ab.length;X++){if(X==0){$("#oldphonenum_1").val(ab[X])}else{order.memberChange.addNum(W,"");$("#oldphonenum_"+(X+1)).val(ab[X])}}}}}}})}});var J={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:K,actionFlag:1,type:1};if(N>1){easyDialog.open({container:"member_dialog"});$("#member_btn").off("click").on("click",function(){order.service.confirm(J)})}else{if(!g(1)){$.alert("错误提示","请选择一个接入产品");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(J)}}};var C=function(K){order.memberChange.viceCartNum=0;$.each(OrderInfo.offerSpec.offerRoles,function(){this.prodInsts=[]});var J=0;$.each(i,function(){J=J+Number($("#"+this).val())});var I=0;$("#member_tbody").find("tr[name='oldnbr']").each(function(){var L=$.trim($(this).children("td").eq(1).children("input").val());if(ec.util.isObj(L)){I++}});if(!g()){$.alert("错误提示","请选择一个接入产品");return}if(J>0){order.service.newMemberFlag=true;K.newnum=J}else{order.service.newMemberFlag=false}if(I>0){order.service.oldMemberFlag=true;if(!order.memberChange.queryofferinfo()){return}K.oldprodInstInfos=OrderInfo.oldprodInstInfos;K.oldofferSpec=OrderInfo.oldofferSpec;K.oldoffer=OrderInfo.oldoffer;K.oldnum=I}else{order.service.oldMemberFlag=false}if(parseInt(J)+parseInt(order.memberChange.viceCartNum)>z){$.alert("提示","加装数量已经超过能加装的最大数量【"+z+"】---!");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(K)}else{mktRes.terminal.newnum=J;mktRes.terminal.oldnum=I}jQuery("#easyDialogBox").hide();jQuery("#overlay").hide()};var g=function(J){var K=-1;var I=false;$.each(OrderInfo.offerSpec.offerRoles,function(){var L=this;if(L.prodInsts==undefined){L.prodInsts=[]}$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var M=0;if(J==1){M=1}else{M=$("#"+L.offerRoleId+"_"+this.objId).val()}if(M==undefined||M==""){M=0}for(var O=0;O<M;O++){var N=jQuery.extend(true,{},this);N.prodInstId=K--;if(M>1){N.offerRoleName=L.offerRoleName+(O+1)}else{N.offerRoleName=L.offerRoleName}N.memberRoleCd=L.memberRoleCd;L.prodInsts.push(N);I=true}L.selQty=M}else{if(this.minQty==0&&OrderInfo.actionFlag==1){if($("#"+L.offerRoleId+"_"+this.objId).attr("checked")=="checked"){this.dfQty=1}else{this.dfQty=0}}}})});return I};var o=function(I,P,N){if(ec.util.isObj(N)){var R=0;var M=[];var J=0;$.each(OrderInfo.offerSpec.offerRoles,function(){var S=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var T=S.offerRoleId+"_"+this.objId;if(ec.util.isObj(S.parentOfferRoleId)&&N==S.parentOfferRoleId){M.push(S);J=S.parentMaxQty;R+=Number($("#"+T).val())}}})});if(J>0){if(R>=J){if(ec.util.isArray(M)){var O="【";for(var K=0;K<M.length;K++){var Q=M[K];O+=Q.offerRoleName+","}O=O.substr(0,O.lastIndexOf(","));O+="】角色成员数量总和不能超过"+J;$.alert("规则限制",O);return}}}}var L=Number($("#"+I).val());if(P<0){L+=1;$("#"+I).val(L)}else{if(L<P){L+=1;$("#"+I).val(L)}}};var F=function(K,J){var I=Number($("#"+K).val());if(I>J){I-=1;$("#"+K).val(I)}};var r=function(J){var I=Number($("#"+J).val());I+=1;$("#"+J).val(I)};var l=function(J){var I=Number($("#"+J).val());I-=1;$("#"+J).val(I)};var n=function(){new_page=parseInt($("#current_page").val())-1;if($(".pagingSelect").prev(".page_link").length==true){G(new_page)}};var k=function(){new_page=parseInt($("#current_page").val())+1;if($(".pagingSelect").next(".page_link").length==true){G(new_page)}};var G=function(J){var I=parseInt($("#show_per_page").val());start_from=J*I;end_on=start_from+I;$("#offerlistcont").children().css("display","none").slice(start_from,end_on).css("display","table-row");$(".page_link[longdesc="+J+"]").addClass("pagingSelect").siblings(".pagingSelect").removeClass("pagingSelect");$("#current_page").val(J);if($(".pagingSelect").prev(".page_link").length==true){$(".pageUpGray").removeClass("pageUpGray").addClass("pageUpOrange")}else{$(".pageUpOrange").removeClass("pageUpOrange").addClass("pageUpGray")}if($(".pagingSelect").next(".page_link").length==true){$(".nextPageGray").removeClass("nextPageGray").addClass("nextPageGrayOrange")}else{$(".nextPageGrayOrange").removeClass("nextPageGrayOrange").addClass("nextPageGray")}};var c=0;var f={};var s=function(){$("#search").off("click").on("click",function(){order.service.searchPack()})};var A=function(I){var K={};var J=contextPath+"/order/prodoffer/prepare?subPage="+I;$.callServiceAsHtmlGet(J,K,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(L){if(!L){L.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>页面显示失败,稍后重试</strong></div>'}if(L.code!=0){$.alert("提示","页面显示失败,稍后重试");return}var M=$("#offerspecContent");M.html(L.data);order.prepare.backToInit();s();order.prodOffer.queryApConfig();order.service.searchPack();$("#chooseofferspecclose").click(function(){p()});easyDialog.open({container:"chooseofferspec"})}})};var p=function(){if(!$("#chooseofferspec").is(":hidden")){easyDialog.close()}};var h=function(K,V,S,T,I){var M={offerSpecId:V};var O=$.callServiceAsJson(contextPath+"/order/queryOfferSpec",M);if(O.code==0){if(O.data){var N="";var J=O.data.offerSpec;if(J&&J.offerRoles){var U=J.offerRoles;for(var P=0;P<U.length;P++){if(U[P].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||U[P].memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(U[P].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){N=U[P].offerRoleId;break}}else{N=U[P].offerRoleId;break}}}if(N!=""){p();var R=$("#li_"+T).attr("objinstid");var Q=$("#li_"+T).attr("accessnumber");for(var P=0;P<OrderInfo.viceOfferSpec.length;P++){var L=OrderInfo.viceOfferSpec[P];if(R==L.prodId){OrderInfo.viceOfferSpec.splice(P,1);break}}J.prodId=R;J.accessnumber=Q;OrderInfo.viceOfferSpec.push(J);order.prodModify.chooseOfferForMember(V,T,I,N)}else{$.alert("提示","无法选择套餐，套餐规格查询失败！")}}}else{if(O.code==-2){$.alertM(O.data)}else{$.alert("提示","套餐详细加载失败，请稍后再试！")}}};var y=function(I,K,M,L){var J=OrderInfo.cust.custId;offerprice=K;if(OrderInfo.cust==undefined||J==undefined||J==""){$.alert("提示","在订购套餐之前请先进行客户定位！");return}var O={price:K,specId:I,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.soAreaId};if(OrderInfo.actionFlag==2){order.service.opeSer(O)}else{var N=[{boActionTypeCd:"S1",instId:"",specId:I}];if(rule.rule.ruleCheck(N)){order.service.opeSerReload(O,M);
if(typeof L=="function"){L()}}}};var B=function(P,I){var K={offerSpecId:P.specId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var L=query.offer.queryMainOfferSpec(K);if(!L){return}if(OrderInfo.actionFlag==2){var J=contextPath+"/token/pc/order/queryFeeType";$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");var M=$.callServiceAsJsonGet(J,K);$.unecOverlay();if(M.code==0){if(M.data!=undefined){if("0"==M.data){var Q=false;if(order.prodModify.choosedProdInfo.feeType=="2100"&&(L.feeType=="2100"||L.feeType=="3100"||L.feeType=="3101"||L.feeType=="3103"||L.feeType=="1202"||L.feeType=="2101")){Q=true}else{if(order.prodModify.choosedProdInfo.feeType=="1200"&&(L.feeType=="1200"||L.feeType=="3100"||L.feeType=="3102"||L.feeType=="3103"||L.feeType=="1202"||L.feeType=="2101")){Q=true}else{if(order.prodModify.choosedProdInfo.feeType=="1201"&&(L.feeType=="1201"||L.feeType=="3101"||L.feeType=="3102"||L.feeType=="3103")){Q=true}}}if(!Q){$.alert("提示","付费类型不一致,无法进行套餐变更。");return}}}}offerChange.offerChangeView();return}if(OrderInfo.newOrderInfo.isReloadFlag=="N"){OrderInfo.newOrderInfo.prodOfferName=L.offerSpecName}var O=0;var N=$("#member_tbody");N.html("");$("#main_title").text(OrderInfo.offerSpec.offerSpecName);$.each(L.offerRoles,function(){var T=this;var S=$("<tr style='background:#f8f8f8;'></tr>");var W=$('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'+T.offerRoleName+"</span>&nbsp;&nbsp;</td>");if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){S.append(W).append($("<td colspan='3'></td>")).appendTo(N)}else{S.append(W).appendTo(N)}$.each(this.roleObjs,function(){var ab=T.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){if(T.memberRoleCd=="401"){i.push(ab)}if(T.minQty==0){this.minQty=0;this.dfQty=0}if(I&&T.memberRoleCd=="401"){this.dfQty=I}var X=this.maxQty<0?"不限制":this.maxQty;z=X;var Y=this.minQty;if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""&&T.memberRoleCd=="401"){var Z=OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");var aa=Z.length;this.dfQty=aa;this.minQty=aa;this.maxQty=aa;X=aa}if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""&&OrderInfo.newOrderNumInfo.newSubPhoneNum==""&&T.memberRoleCd=="401"){this.maxQty=0;X=0}S.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'><a class='add' href='javascript:order.service.subNum(\""+ab+'",'+this.minQty+");'></a><input id='"+ab+"' type='text' value='"+this.dfQty+"' class='numberTextBox width22' readonly='readonly'><a class='add2' href='javascript:order.service.addNum(\""+ab+'",'+this.maxQty+',"'+T.parentOfferRoleId+"\");'> </a></i>"+this.minQty+"-"+X+"（张） </td>");O++}});var U=$("<tr></tr>");var R=0;$.each(this.roleObjs,function(){var Z=T.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.SERV){if(R%4==0){U=$("<tr></tr>");U.appendTo(N)}var Y=$('<input id="'+Z+'" name="'+T.offerRoleId+'" type="checkbox">'+this.objName+"</input>");if(this.minQty==0){if(this.dfQty>0){Y.attr("checked","checked")}}else{if(this.minQty>0){Y.attr("checked","checked");Y.attr("disabled","disabled")}}var X=$("<td></td>");X.append(Y).appendTo(U);R++;O++}});var V=order.memberChange.areaidJurisdiction();if(T.memberRoleCd=="401"&&V!=""&&V.net_vice_card=="0"){$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var Y=this.maxQty<0?"不限制":this.maxQty;var ab=this.minQty;var ad="";var X=OrderInfo.newOrderInfo.result;var aa=X.orderList.custOrderList[0].busiOrder;$.each(aa,function(ag,ah){if(ah.boActionType.actionClassCd==1200&&ah.boActionType.boActionTypeCd=="S2"&&ah.busiObj.offerTypeCd=="1"){var af=ah.busiObj.accessNumber;OrderInfo.oldAddNumList.push({accNbr:af});ad+=af+","}});if(this.maxQty!=0){var ae=OrderInfo.oldSubPhoneNum.oldSubPhoneNum;var ac="<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'><td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td><td align='left' colspan='3'><input value='' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' ><a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+Y+',"");\'> </a>'+ab+"-"+Y+"（张）</td></tr>";N.append(ac);if(ad!=null&&ad!=""){var ae=ad.split(",");if(ae!=null&&ae.length>0){for(var Z=0;Z<ae.length;Z++){if(ae[Z]!=null&&ae[Z]!=""){if(Z==0){$("#oldphonenum_1").val(ae[Z])}else{order.memberChange.addNum(Y,"");$("#oldphonenum_"+(Z+1)).val(ae[Z])}}}}}}}})}});var K={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:L,actionFlag:1,type:1};if(O>1){easyDialog.open({container:"member_dialog"});order.service.confirm(K)}else{if(!g(1)){$.alert("错误提示","请选择一个接入产品");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(K)}}};var E=function(X,P,N){var T=X.orderList.custOrderList[0].busiOrder;var V="";var J="";var U="";var M="";var L="";var K="";var I="";var W="";var R="";var O="";var S="";var Q="";$.each(AttachOffer.openList,function(Z,Y){$.each(Y.specList,function(ab,aa){if(!order.service.compareOrder(T,aa.offerSpecId,Y.prodId)){AttachOffer.delOfferSpecReload(Y.prodId,aa.offerSpecId)}})});$.each(AttachOffer.openServList,function(Y,Z){$.each(Z.servSpecList,function(ab,aa){var ad=aa.servSpecId;var ac=aa.servSpecName;if(!order.service.compareServOrder(T,ad,Z.prodId)){AttachOffer.closeServSpecReload(Z.prodId,ad,ac,aa.ifParams)}})});$.each(T,function(ae,an){if(an.boActionType.actionClassCd==1300&&an.boActionType.boActionTypeCd=="1"){var av=an.busiObj.instId;var ak=an.busiObj.accessNumber;var aH=an.data.bo2Coupons[0].terminalCode;var ap=an.data.boProdFeeTypes[0].feeType;var aC=an.data.boProdPasswords[0].prodPwTypeCd;var af=an.data.boProdPasswords[0].pwd;var aq="20";if(an.data.boProdItems&&an.data.boProdItems[0].itemSpecId){var aB=an.data.boProdItems[0].itemSpecId;if(aB=="40010030"){aq=an.data.boProdItems[0].value}var ay={};ay.itemSpecId=aB;ay.prodId=av;ay.isCheckMask=aq;OrderInfo.newOrderInfo.checkMaskList.push(ay);$("#"+aB+"_"+av+"").find("option[value='"+aq+"']").attr("selected","selected")}$("#nbr_btn_"+av).html(ak+"<u></u>");var ax={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};OrderInfo.boProdAns.push(ax);order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);$("#uim_txt_"+av).attr("disabled",true);$("#uim_txt_"+av).val(aH);$("#uim_check_btn_"+av).attr("disabled",true);$("#uim_check_btn_"+av).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+av).attr("disabled",false);$("#uim_release_btn_"+av).removeClass("disablepurchase").addClass("purchase");var ai={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};OrderInfo.clearProdUim(this.busiObj.instId);
OrderInfo.boProd2Tds.push(ai);var Y=$("select[name='pay_type_"+av+"']");$(Y).find("option[value='"+ap+"']").attr("selected","selected");$("#pwd_"+av).val(af)}if(an.boActionType.actionClassCd==1100&&an.boActionType.boActionTypeCd=="A1"){if(an.data.boAccountInfos.length>0){V=an.data.boAccountInfos[0].acctCd;J=an.data.boAccountInfos[0].acctName;OrderInfo.newOrderInfo.acctCd=V;OrderInfo.newOrderInfo.acctName=J}if(an.data.boAccountMailings&&an.data.boAccountMailings.length>0){M=an.data.boAccountMailings[0].mailingType;L=an.data.boAccountMailings[0].param1;K=an.data.boAccountMailings[0].param2;I=an.data.boAccountMailings[0].param3;W=an.data.boAccountMailings[0].param7;OrderInfo.newOrderInfo.mailingType=M;OrderInfo.newOrderInfo.param1=L;OrderInfo.newOrderInfo.param2=K;OrderInfo.newOrderInfo.param3=I;OrderInfo.newOrderInfo.param7=W}if(an.data.boPaymentAccounts&&an.data.boPaymentAccounts.length>0){R=an.data.boPaymentAccounts[0].bankAcct;O=an.data.boPaymentAccounts[0].bankId;limitQty=an.data.boPaymentAccounts[0].limitQty;S=an.data.boPaymentAccounts[0].paymentMan;Q=an.data.boPaymentAccounts[0].paymentAcctTypeCd;OrderInfo.newOrderInfo.bankAcct=R;OrderInfo.newOrderInfo.bankId=O;OrderInfo.newOrderInfo.limitQty=limitQty;OrderInfo.newOrderInfo.paymentMan=S;OrderInfo.newOrderInfo.paymentAcctTypeCd=Q}}else{if(an.boActionType.actionClassCd=="1300"&&an.boActionType.boActionTypeCd=="1"){if(an.data.boAccountRelas&&an.data.boAccountRelas.length>0){V=an.data.boAccountRelas[0].acctCd;U=an.data.boAccountRelas[0].acctId}}else{V=""}}var ao=AttachOffer.openList;var aG=$.extend(true,[],AttachOffer.openList);var aa=AttachOffer.openServList;var aF=$.extend(true,[],AttachOffer.openServList);var au=[];var aj=[];if(an.boActionType.actionClassCd=="1200"&&an.boActionType.boActionTypeCd=="S1"){var Z=an;$.each(AttachOffer.openList,function(){if(this.prodId==Z.data.ooRoles[0].prodId){var aI=false;$.each(this.specList,function(){if(this.offerSpecId==Z.busiObj.objId){aI=true;return false}});if(!aI){AttachOffer.addOfferSpecReload(this.prodId,Z.busiObj.objId);if(Z.data.bo2Coupons!=undefined){for(var aL=0;aL<Z.data.bo2Coupons.length;aL++){var aK=Z.data.bo2Coupons[aL];if(aL==0){$("#terminalText_"+aK.prodId+"_"+aK.attachSepcId+"_"+aK.num).val(aK.couponInstanceNumber);AttachOffer.checkTerminalCodeReload($("#terminalBtn_"+aK.prodId+"_"+aK.attachSepcId+"_"+aK.num))}else{AttachOffer.addAndDelTerminal($("#terminalAddBtn_"+aK.prodId+"_"+aK.attachSepcId));$("#terminalText_"+aK.prodId+"_"+aK.attachSepcId+"_"+aK.num).val(aK.couponInstanceNumber);AttachOffer.checkTerminalCodeReload($("#terminalBtn_"+aK.prodId+"_"+aK.attachSepcId+"_"+aK.num))}var aJ={couponUsageTypeCd:aK.couponUsageTypeCd,inOutTypeId:aK.inOutTypeId,inOutReasonId:aK.inOutReasonId,saleId:aK.saleId,couponId:aK.couponId,couponinfoStatusCd:aK.couponinfoStatusCd,chargeItemCd:aK.chargeItemCd,couponNum:aK.couponNum,storeId:aK.storeId,storeName:aK.storeName,agentId:aK.agentId,apCharge:aK.apCharge,couponInstanceNumber:aK.couponInstanceNumber,ruleId:aK.ruleId,partyId:aK.partyId,prodId:aK.prodId,offerId:aK.offerId,attachSepcId:aK.attachSepcId,state:aK.state,relaSeq:aK.relaSeq,num:aK.num};OrderInfo.attach2Coupons.push(aJ)}}}}});if(Z.data.ooRoles[0].prodId>0){AttachOffer.addOfferSpecReload(Z.data.ooRoles[0].prodId,Z.busiObj.objId)}}else{if(an.boActionType.actionClassCd=="1300"&&an.boActionType.boActionTypeCd=="7"){if(an.data.boServs[0].state=="ADD"){var Z=an;$.each(AttachOffer.openServList,function(){if(this.prodId==Z.busiObj.instId){var aI=false;$.each(this.servSpecList,function(){if(this.servSpecId==Z.data.boServOrders[0].servSpecId){aI=true;return false}});if(!aI){var aJ="N";if(Z.data.boServItems!=undefined){aJ="Y"}AttachOffer.openServSpecReload(this.prodId,Z.data.boServOrders[0].servSpecId,Z.data.boServOrders[0].servSpecName,aJ)}}});if(Z.busiObj.instId>0){var aw="N";if(Z.data.boServItems!=undefined){aw="Y"}AttachOffer.openServSpecReload(Z.busiObj.instId,Z.data.boServOrders[0].servSpecId,Z.data.boServOrders[0].servSpecName,aw)}}}}if(V!=""&&V!=-1){var aE={acctCd:V,isServiceOpen:"Y"};$.callServiceAsJson(contextPath+"/token/pc/order/account",aE,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(aI){if(aI.code==-2){$.alertM(aI.data);return}if(aI.code==0){var aL=aI.data.accountInfos;var aJ=aI.data;var aK=false;if(aJ.resultCode==0){if(aJ.accountInfos&&aJ.accountInfos.length>0){$("#accountDiv").find("label:eq(0)").text("主卡帐户：");$.each(aI.data.accountInfos,function(aN,aM){if(U==aM.acctId){aL=aM;$("<option>").text(aM.name+" : "+aM.accountNumber).attr("value",aM.acctId).attr("acctcd",aM.accountNumber).appendTo($("#acctSelect"));$("#acctSelect").find("option[value="+aM.acctId+"]").attr("selected","selected");aK=true;return false}});$("#accountDiv").find("a:eq(0)").hide();$("#acctSelect").find("option[value='-1']").remove();$("#acctSelect").parent().find("a:eq(1)").show();$("#defineNewAcct").hide()}else{$.alert("提示","没有查询到帐户合同号对应的帐户信息")}}else{$.alertM(aJ.resultMsg)}$(this).dispatchJEvent("chooseAcct",aL);$("#defineNewAcct").hide()}else{$("<tr><td colspan=4>"+aI.data+"</td</tr>").appendTo($("#acctListTab tbody"))}$("#acctListTab tr").off("click")}})}var ac=X.orderList.orderListInfo;var at=ac.isTemplateOrder;var ah=ac.custOrderAttrs;var ad="";var al="";var aA="";var ab="1";var ar="";var aD="";var az="";$.each(ah,function(aI,aJ){if(aJ.itemSpecId=="111111118"){ad=aJ.value}else{if(aJ.itemSpecId=="30010020"){al=aJ.value}else{if(aJ.itemSpecId=="30010025"){aA=aJ.value}else{if(aJ.itemSpecId=="30010026"){ar=aJ.value}else{if(aJ.itemSpecId=="30010021"){aD=aJ.value}else{if(aJ.itemSpecId=="30010022"){az=aJ.value}}}}}}});$("#order_remark").val(ad);if(at=="Y"){$("#isTemplateOrder").css("checked",true);var ag=ac.templateOrderName;var am=ac.templateType;$(".template_info_name").show();$(".template_info_type").show();$("#isActivation").removeAttr("checked");$("#isActivation").attr("disabled","disabled");$("#templateOrderName").val(ag);$("#template_info_type").find("option[value='"+am+"']").attr("selected",true)}$("#orderAttrName").val(al);$("#orderPartyTypeCd").find("option[value='"+ab+"']").attr("selected",true);$("#orderAttrPhoneNbr").val(aA);$("#orderIdentidiesTypeCd").find("option[value='"+ar+"']").attr("selected",true);$("#orderAttrIdCard").val(aD);$("#orderAttrAddr").val(az)});$("#dealerTbody").empty();order.service.dealDevelopingPerson(T,OrderInfo.newOrderInfo.prodOfferId,OrderInfo.newOrderInfo.prodOfferName)};var t=function(M,L,N){var I=false;var J=M.length;var K=0;while(K<J){if(M[K].boActionType.actionClassCd==1200&&M[K].boActionType.boActionTypeCd=="S1"){if(M[K].data.ooRoles&&M[K].data.ooRoles.length>0&&M[K].data.ooRoles[0].prodId==N&&M[K].busiObj.objId==L){return true}}K++}return I};var v=function(L,N,M){var I=false;var J=L.length;var K=0;while(K<J){if(L[K].boActionType.actionClassCd==1300&&L[K].boActionType.boActionTypeCd=="7"){if(L[K].busiObj.instId==M&&L[K].data.boServOrders[0].servSpecId==N){return true}}K++}return I};var D=function(J,K,I){$.each(J,function(U,L){if(L.boActionType.actionClassCd!=1300&&L.boActionType.boActionTypeCd!="1"){if(L.data.busiOrderAttrs!=undefined){var V=[];var ab={};var aa={};var Z={};$.each(L.data.busiOrderAttrs,function(){if(this.role=="40020005"){ab.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){ab.staffid=this.value;ab.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){ab.staffname=this.value}}if(L.boActionType.actionClassCd==1200&&L.boActionType.boActionTypeCd=="S1"&&L.busiObj.instId==-1){ab.prodId=L.busiObj.instId}}else{if(this.role=="40020006"){aa.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aa.staffid=this.value;aa.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aa.staffname=this.value}}if(L.boActionType.actionClassCd==1200&&L.boActionType.boActionTypeCd=="S1"&&L.busiObj.instId==-1){aa.prodId=L.busiObj.instId}}else{if(this.role=="40020007"){Z.role=this.role;
if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){Z.staffid=this.value;Z.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){Z.staffname=this.value}}if(L.boActionType.actionClassCd==1200&&L.boActionType.boActionTypeCd=="S1"&&L.busiObj.instId==-1){Z.prodId=L.busiObj.instId}}}}});if(ec.util.isObj(ab.role)){V.push(ab)}if(ec.util.isObj(aa.role)){V.push(aa)}if(ec.util.isObj(Z.role)){V.push(Z)}var N="";if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){N=this.data.ooRoles[0].prodId+"_"+this.busiObj.objId}var X=this.busiObj.accessNumber;for(var W=0;W<V.length;W++){if(V[W].prodId&&V[W].prodId=="-1"){var N=K;var T=$("<tr id='tr_"+N+"' name='tr_"+N+"'></tr>");var S=$("<td></td>");var M=N+"_"+OrderInfo.SEQ.dealerSeq;var R=$('<select id="dealerType_'+M+'" name="dealerType_'+N+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+N+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(V[W].role==this.PARTYPRODUCTRELAROLECD){R.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}else{R.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});S.append(R);S.append('<label class="f_red">*</label>');var Q="主套餐";T.append("<td>"+Q+"</td>");T.append("<td>"+I+"（包含接入产品）</td>");T.append(S);var O=$('<td><input type="text" id="dealer_'+M+'" staffId="'+V[W].staffid+'" value="'+V[W].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>');O.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+M+"');\">选择</a>");if(W==0){O.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+N+',1)">添加</a><label class="f_red">*</label>')}else{O.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>')}T.append(O);if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){OrderInfo.getChannelList()}var P=$("<td></td>");var Y=$('<select id="dealerChannel_'+M+'" name="dealerChannel_'+N+'" class="inputWidth183px" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(V[W].channelNbr==this.channelNbr){Y.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{Y.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});P.append(Y);P.append('<label class="f_red">*</label>');T.append(P);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(T)}else{var T=$('<tr name="tr_'+N+'"></tr>');var S=$("<td></td>");var M=N+"_"+OrderInfo.SEQ.dealerSeq;var R=$('<select id="dealerType_'+M+'" name="dealerType_'+N+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+N+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(V[W].role==this.PARTYPRODUCTRELAROLECD){R.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected>"+this.NAME+"</option>")}else{R.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});S.append(R);S.append('<label class="f_red">*</label>');T.append("<td>"+X+"</td>");if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){T.append("<td>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</td>")}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){T.append("<td>"+this.busiObj.objName+"</td>")}}T.append(S);var O=$('<td><input type="text" id="dealer_'+M+'" staffId="'+V[W].staffid+'" value="'+V[W].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>');O.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+M+"');\">选择</a>");if(W==0){O.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');O.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+N+'\')">添加</a><label class="f_red">*</label>')}else{O.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>')}T.append(O);if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){OrderInfo.getChannelList()}var P=$("<td></td>");var Y=$('<select id="dealerChannel_'+M+'" name="dealerChannel_'+N+'" class="inputWidth183px" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(V[W].channelNbr==this.channelNbr){Y.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{Y.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});P.append(Y);P.append('<label class="f_red">*</label>');T.append(P);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(T)}}}}})};return{searchPack:m,queryPackForTerm:w,addNum:o,subNum:F,addNumNoLim:r,subNumNoLim:l,opeSer:a,buyService:x,previous:n,next:k,go_to_page:G,releaseFlag:c,boProdAn:f,offerprice:H,initSpec:s,searchPackById:b,offerDialog:A,choosedOffer:h,setOfferSpec:g,confirm:C,queryData:q,buyServiceReload:y,opeSerReload:B,callBackBuildOrder:E,compareOrder:t,compareServOrder:v,dealDevelopingPerson:D,oldMemberFlag:u,newMemberFlag:j}})();CommonUtils.regNamespace("OrderInfo");OrderInfo=(function(){var aG="";var aD="";var aa="";var aN="";var ak="";var x="";var s=new Array();var C={provIsale:"",redirectUri:"",isFee:"1",extCustOrderID:"",reloadFlag:"",prodOfferId:"",prodOfferName:"",mktResInstCode:"",codeMsg:"",mergeFlag:"0",salesCode:""};var o={mainPhoneNum:"",newSubPhoneNum:"",mktResInstCode:""};var c={oldSubPhoneNum:""};var Q={result:{},checkMaskList:[],prodOfferId:"",prodOfferName:"",isReloadFlag:"",paymentAcctTypeCd:"",mailingType:"",bankAcct:"",bankId:"",limitQty:"",paymentMan:"",param1:"",param2:"",param3:"",param7:"",isLastFlag:""};var K=0;var a="N";var aL=0;var n="";var ao="";var j="";var ap={custId:"",partyName:"",vipLevel:"",vipLevelName:"",custFlag:"1100"};var b={staffId:0,channelId:0,channelName:"",areaId:0,areaCode:0,soAreaId:0,soAreaCode:0,distributorId:""};var ai={};var M={offerId:"",offerSpecId:"",offerMemberInfos:[]};var U=[];var ay=[];var aq=[];var p=[];var aw=[];var t=0;var h=[];var D={offerId:"",offerSpecId:"",offerMemberInfos:[]};var G=0;var k="";var ab="订购";var J="";var ah="";var ag=[];var R={};var r=[];var B={};var az=[];var an={dealerType:"",soNbr:"",oldSoNbr:"",oldSoId:"",step:0,token:"",templateType:1,dealerTypeList:[]};var v={effTime:""};var E={seq:-1,offerSeq:-1,prodSeq:-1,servSeq:-1,itemSeq:-1,acctSeq:-1,acctCdSeq:-1,paramSeq:-1,atomActionSeq:-1,offerMemberSeq:-1,dealerSeq:1};var Y=[];var T=[];var aF=[];var am=[];var al=[];var aO=[];var f=[];var g=[];var av=[];var ad=[];var aC=[];var aE=[];var z=function(){var aQ={orderList:{orderListInfo:{isTemplateOrder:"N",templateType:OrderInfo.order.templateType,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,areaId:OrderInfo.staff.soAreaId,partyId:-1,distributorId:OrderInfo.staff.distributorId,olTypeCd:CONST.OL_TYPE_CD.UI_LTE},custOrderList:[{busiOrder:[]}]}};OrderInfo.orderData=aQ;return OrderInfo.orderData};var aH=function(aR){var aQ=y(-1);var aS={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.CUST_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.CUST_CREATE},data:{boCustInfos:[],boCustIdentities:[],boPartyContactInfo:[]}};if(ec.util.isObj(aQ)){aS.busiObj.accessNumber=aQ}aS.data.boCustInfos.push(OrderInfo.boCustInfos);aS.data.boCustIdentities.push(OrderInfo.boCustIdentities);if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(OrderInfo.boPartyContactInfo.contactName==""){var aT=OrderInfo.boCustInfos.name;OrderInfo.boPartyContactInfo.contactName=aT;OrderInfo.boPartyContactInfo.mobilePhone=aQ}aS.data.boPartyContactInfo.push(OrderInfo.boPartyContactInfo)}if(OrderInfo.boCustProfiles!=undefined&&OrderInfo.boCustProfiles!=""){aS.data.boCustProfiles=[];aS.data.boCustProfiles=OrderInfo.boCustProfiles}aR.push(aS)};var i=function(aX,aY){var aR=$("#acctName").val();
var aZ=$("#paymentType").val();var aT="";var aV="";var aW="";if(aZ==110000){aT=$("#bankId").val();aV=$("#bankAcct").val();aW=$("#paymentMan").val()}var aQ={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:aY},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.ACCT_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACCT_CREATE},data:{boAccountInfos:[{partyId:OrderInfo.cust.custId,acctName:aR,acctCd:aY,acctId:aY,businessPassword:"111111",state:"ADD",acctTypeCd:"1"}],boPaymentAccounts:[{paymentAcctTypeCd:aZ,bankId:aT,bankAcct:aV,paymentMan:aW,limitQty:"1",state:"ADD"}],boAcct2PaymentAccts:[{priority:"1",state:"ADD"}],boAccountItems:[],boAccountMailings:[]}};var aS=y(-1);if(ec.util.isObj(aS)){aQ.busiObj.accessNumber=aS}if($("#paymentType").val()==110000&&$.trim($("#protocalNbr").val())!=""){var a0={itemSpecId:CONST.ACCT_ATTR.PROTOCOL_NBR,value:$.trim($("#protocalNbr").val()),state:"ADD"};aQ.data.boAccountItems.push(a0)}if($("#postType").val()!=-1){var aU={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"ADD"};if($("#postType").val()==11||$("#postType").val()==15){aU.param1=$("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val()}aQ.data.boAccountMailings.push(aU)}aX.push(aQ)};var aM=function(aR,aT,aV){var aQ=y(aV);var aU={areaId:OrderInfo.getProdAreaId(aV),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:aT.offerId,objId:aT.offerSpecId,offerTypeCd:aT.offerTypeCd},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:aT.boActionTypeCd},data:{}};if(ec.util.isObj(aT.offerSpecName)){aU.busiObj.objName=aT.offerSpecName}if(ec.util.isObj(aQ)){aU.busiObj.accessNumber=aQ}if(aT.boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_OFFER){var aS=$("tr[name='tr_"+aV+"_"+aT.offerSpecId+"']");if(aS!=undefined&&aS.length>0){aU.data.busiOrderAttrs=[];aS.each(function(){var aW={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+aV+"_"+aT.offerSpecId+"']").val()};aU.data.busiOrderAttrs.push(aW);var aX={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};aU.data.busiOrderAttrs.push(aX)})}aU.data.ooOwners=[];aU.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"ADD"});if(ec.util.isArray(aT.offerSpecParams)){aU.data.ooParams=[];$.each(aT.offerSpecParams,function(){if(this.setValue==undefined){this.setValue=this.value}if(ec.util.isObj(this.setValue)){var aW={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};aU.data.ooParams.push(aW)}})}if(aT.ooTimes!=undefined){aU.data.ooTimes=[];aU.data.ooTimes.push(aT.ooTimes)}$.each(OrderInfo.attach2Coupons,function(){if(aT.offerSpecId==this.attachSepcId&&aV==this.prodId){aU.data.bo2Coupons=[];return false}});$.each(OrderInfo.attach2Coupons,function(){if(aT.offerSpecId==this.attachSepcId&&aV==this.prodId){this.offerId=aT.offerId;aU.data.bo2Coupons.push(this)}});aU.data.ooRoles=[];if(ec.util.isArray(aT.offerRoles)){$.each(aT.offerRoles,function(){var aW=this;$.each(this.roleObjs,function(){var a0={prodId:aV,offerRoleId:aW.offerRoleId,objId:this.objId,objType:this.objType,relaType:this.relaTypeCd,state:"ADD"};var aY=true;if(this.objType==CONST.OBJ_TYPE.PROD){var aZ=OrderInfo.getProdSpecId(aV);if(aZ==this.objId||aZ==""){a0.objInstId=aV}else{return true}}else{if(this.objType==CONST.OBJ_TYPE.SERV){var a1=CacheData.getServBySpecId(aV,this.objId);if(a1!=undefined){a0.objInstId=a1.servId}else{var aX=CacheData.getServSpec(aV,this.objId);if(aX!=undefined&&aX.isdel!="Y"&&aX.isdel!="C"&&aX.servId!=undefined&&aX.servId!=""){a0.objInstId=aX.servId}else{aY=false}}}else{a0.objInstId=OrderInfo.SEQ.offerSeq--}}if(aY){aU.data.ooRoles.push(a0)}})})}aR.push(aU)}else{if(aT.boActionTypeCd==CONST.BO_ACTION_TYPE.DEL_OFFER){aU.data.ooOwners=[];aU.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"DEL"});if(ec.util.isArray(aT.offerMemberInfos)){aU.data.ooRoles=[];$.each(aT.offerMemberInfos,function(){var aW={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerRoleId:this.offerRoleId,state:"DEL"};if(this.objType!=CONST.OBJ_TYPE.PROD){aW.prodId=aV}if(this.offerMemberId!=undefined){aW.offerMemberId=this.offerMemberId}aU.data.ooRoles.push(aW)})}if(aT.isRepeat!="Y"){aR.push(aU)}}else{if(aT.boActionTypeCd==CONST.BO_ACTION_TYPE.UPDATE_OFFER){if(aT.isUpdate=="Y"){aU.data.ooRoles=aT.data}else{if(ec.util.isArray(aT.offerSpec.offerSpecParams)){aU.data.ooParams=[];$.each(aT.offerSpec.offerSpecParams,function(){if(this.isUpdate=="Y"){if(ec.util.isObj(this.value)){var aW={itemSpecId:this.itemSpecId,offerParamId:this.offerParamId,offerSpecParamId:this.offerSpecParamId,value:this.value,state:"DEL"};aU.data.ooParams.push(aW)}if(ec.util.isObj(this.setValue)){var aX={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};aU.data.ooParams.push(aX)}}})}}aR.push(aU)}}}};var S=function(aV){var aR=y(aV.prodId);var aU={areaId:OrderInfo.getProdAreaId(aV.prodId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.getProdSpecId(aV.prodId),instId:aV.prodId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:aV.boActionTypeCd},data:{}};if(ec.util.isObj(aV.isComp)){aU.busiObj.isComp=aV.isComp}if(ec.util.isObj(aR)){aU.busiObj.accessNumber=aR}if(aV.boActionTypeCd==CONST.BO_ACTION_TYPE.PRODUCT_PARMS){if(ec.util.isArray(aV.prodSpecParams)){aU.data.boServOrders=[];aU.data.boServOrders.push({servId:aV.memberId,servSpecId:aV.servSpecId});aU.data.boServItems=[];$.each(aV.prodSpecParams,function(){if(this.isUpdate=="Y"){if(ec.util.isObj(this.value)){var aW={itemSpecId:this.itemSpecId,servId:aV.memberId,value:this.value,state:"DEL"};aU.data.boServItems.push(aW)}if(ec.util.isObj(this.setValue)){var aX={itemSpecId:this.itemSpecId,servId:aV.memberId,value:this.setValue,state:"ADD"};aU.data.boServItems.push(aX)}}})}}else{if(aV.boActionTypeCd==CONST.BO_ACTION_TYPE.SERV_OPEN){var aT="ADD";if(aV.servClose=="Y"){aT="DEL"}else{if(aV.servSpecId==undefined&&aV.objId!=undefined){aV.servSpecId=aV.objId}}var aS={servId:aV.servId,servSpecId:aV.servSpecId};if(ec.util.isObj(aV.servSpecName)){aS.servSpecName=aV.servSpecName}aU.data.boServOrders=[];aU.data.boServOrders.push(aS);aU.data.boServs=[];aU.data.boServs.push({servId:aV.servId,state:aT});if(aV.servClose!="Y"){if(ec.util.isArray(aV.prodSpecParams)){aU.data.boServItems=[];$.each(aV.prodSpecParams,function(){if(this.setValue==undefined){this.setValue=this.value}var aW=$("select[name='pay_type_-1']").val();if(aW==undefined){aW=order.prodModify.choosedProdInfo.feeType}if(aV.servSpecId==CONST.YZFservSpecId&&aW==CONST.PAY_TYPE.AFTER_PAY){this.setValue=""}if(ec.util.isObj(this.setValue)){var aX={itemSpecId:this.itemSpecId,servId:aV.servId,value:this.setValue,state:aT};aU.data.boServItems.push(aX)}})}}}else{if(aV.boActionTypeCd==CONST.BO_ACTION_TYPE.REMOVE_PROD){aU.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}]}else{if(aV.boActionTypeCd==CONST.BO_ACTION_TYPE.CHANGE_CARD||aV.boActionTypeCd==CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD){var aQ=OrderInfo.getProdUim(aV.prodId);if(ec.util.isObj(aQ.prodId)){aU.data.bo2Coupons=[];aU.data.bo2Coupons.push(aQ);aU.data.bo2Coupons.push(OrderInfo.getProdOldUim(aV.prodId))}else{if(OrderInfo.zcd_privilege==0){aU.data.bo2Coupons=[];aU.data.bo2Coupons.push(OrderInfo.getProdOldUim(aV.prodId))}else{return false}}}}}}return aU};var H=function(aQ,aT){var aR=order.prodModify.choosedProdInfo;var aS={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aR.productId,instId:aR.prodInstId,accessNumber:aR.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};
aS.data=aT;aQ.push(aS)};var aK={areaId:0,defaultIdType:"1",businessPassword:"",name:"",partyTypeCd:1,state:"ADD",telNumber:"",addressStr:"",mailAddressStr:""};var O={identidiesTypeCd:"1",identityNum:"",isDefault:"Y",state:"ADD"};var W={contactAddress:"",contactDesc:"",contactEmployer:"",contactGender:"",contactId:"",contactName:"",contactType:"",eMail:"",fax:"",headFlag:"",homePhone:"",mobilePhone:"",officePhone:"",postAddress:"",postcode:"",staffId:0,state:"",statusCd:"100001"};var aP={};var l=function(){OrderInfo.SEQ.seq=-1;OrderInfo.SEQ.offerSeq=-1;OrderInfo.SEQ.prodSeq=-1;OrderInfo.SEQ.servSeq=-1;OrderInfo.SEQ.itemSeq=-1;OrderInfo.SEQ.acctSeq=-1;OrderInfo.SEQ.acctCdSeq=-1;OrderInfo.SEQ.paramSeq=-1;OrderInfo.SEQ.atomActionSeq=-1};var Z=function(){OrderInfo.boProdAns=[];OrderInfo.boProd2Tds=[];OrderInfo.bo2Coupons=[];AttachOffer.openList=[];AttachOffer.openedList=[];AttachOffer.openServList=[];AttachOffer.openedServList=[];AttachOffer.openAppList=[];AttachOffer.labelList=[];AttachOffer.allOfferList=[];OrderInfo.confirmList=[];OrderInfo.orderResult={};OrderInfo.order.step=1};var at=function(aQ,aT,aU,aS,aR){if(aQ!=""&&aQ!=undefined){OrderInfo.actionClassCd=aQ}if(aT!=""&&aT!=undefined){OrderInfo.boActionTypeCd=aT}if(aU!=undefined){OrderInfo.actionFlag=aU}if(aS!=""&&aS!=undefined){OrderInfo.actionTypeName=aS}if(aR!=""&&aR!=undefined){OrderInfo.order.templateType=aR}};var af=function(aT){var aQ={};for(var aR=0;aR<OrderInfo.boProdAns.length;aR++){var aS=OrderInfo.boProdAns[aR];if(aS==undefined){continue}else{if(aS.prodId==aT){aQ=aS}}}return aQ};var u=function(aR,aQ){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==aR){this.an=aQ;return false}})})};var L=function(aQ){try{if(stepOrder.main.isStepOrder){return stepOrder.main.areaId}}catch(aR){}if(aQ!=undefined&&aQ>0){var aS=order.prodModify.choosedProdInfo.areaId;if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&order.service.oldMemberFlag){if(ec.util.isObj(OrderInfo.cust.areaId)){aS=OrderInfo.cust.areaId}else{aS=OrderInfo.staff.soAreaId}}if(aS==undefined||aS==""){$.alert("错误提示","产品信息未返回地区ID，请营业后台核实！");return}return aS}else{if(aQ!=undefined&&aQ<0&&OrderInfo.actionFlag==6){var aS=order.prodModify.choosedProdInfo.areaId;if(aS==undefined||aS==""){$.alert("错误提示","产品信息未返回地区ID，请营业后台核实！");return}return aS}if(ec.util.isObj(OrderInfo.cust.areaId)){return OrderInfo.cust.areaId}else{return OrderInfo.staff.soAreaId}}};var aA=function(){var aQ=OrderInfo.staff.soAreaId;if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18||OrderInfo.actionFlag==35){}else{if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==4||OrderInfo.actionFlag==9){if(ec.util.isObj(OrderInfo.cust.areaId)){aQ=OrderInfo.cust.areaId}}else{if(ec.util.isObj(order.prodModify.choosedProdInfo.areaId)){aQ=order.prodModify.choosedProdInfo.areaId}}}return aQ};var au=function(aR){for(var aQ=0;aQ<OrderInfo.boProd2OldTds.length;aQ++){var aS=OrderInfo.boProd2OldTds[aQ];if(aS.prodId==aR){return aS}}return{}};var N=function(aR){for(var aQ=0;aQ<OrderInfo.boProd2Tds.length;aQ++){var aS=OrderInfo.boProd2Tds[aQ];if(aS.prodId==aR){return aS}}return{}};var aj=function(aR){for(var aQ=0;aQ<OrderInfo.boProd2Tds.length;aQ++){var aS=OrderInfo.boProd2Tds[aQ];if(aS.prodId==aR){OrderInfo.boProd2Tds.splice(aQ,1)}}};var ae=function(aR){for(var aQ=0;aQ<OrderInfo.checkUimData.length;aQ++){var aS=OrderInfo.checkUimData[aQ];if(aS.prodId==aR){OrderInfo.checkUimData.splice(aQ,1)}}};var aB=function(aR){for(var aQ=0;aQ<OrderInfo.checkUimData.length;aQ++){var aS=OrderInfo.checkUimData[aQ];if(aS.prodId==aR){return aS}}return""};var ac=function(aR){for(var aQ=0;aQ<OrderInfo.boProd2Tds.length;aQ++){var aS=OrderInfo.boProd2Tds[aQ];if(aS.prodId==aR){return aS.terminalCode}}return""};var aJ=function(aU){var aR=true;for(var aT=0;aT<OrderInfo.bo2Coupons.length;aT++){var aS=OrderInfo.bo2Coupons[aT];if(aS.prodId==aU){aR=false;return aS}}if(aR){var aQ={prodId:aU,coupons:[]};OrderInfo.bo2Coupons.push(aQ);return aQ}};var X=function(aU){var aR=true;for(var aT=0;aT<OrderInfo.bo2Coupons.length;aT++){var aS=OrderInfo.bo2Coupons[aT];if(aS.prodId==aU){aS.coupons=[];return aS}}if(aR){var aQ={prodId:aU,coupons:[]};OrderInfo.bo2Coupons.push(aQ);return aQ}};var y=function(aT){var aQ="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){$.each(OrderInfo.oldoffer,function(){var aU=this;$.each(aU.offerMemberInfos,function(){if(this.objInstId==aT){aQ=this.accessNumber;return false}})})}else{for(var aR=0;aR<OrderInfo.boProdAns.length;aR++){var aS=OrderInfo.boProdAns[aR];if(aS.prodId==aT){if(aS.accessNumber!=undefined){aQ=aS.accessNumber}}}}}else{if(OrderInfo.actionFlag==6||OrderInfo.actionFlag==2){for(var aR=0;aR<OrderInfo.boProdAns.length;aR++){var aS=OrderInfo.boProdAns[aR];if(aS.prodId==aT){if(aS.accessNumber!=undefined){aQ=aS.accessNumber}}}$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==aT){aQ=this.accNbr;return false}});$.each(OrderInfo.offer.offerMemberInfos,function(aU){if(this.objInstId==aT){aQ=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==21){$.each(OrderInfo.offer.offerMemberInfos,function(aU){if(this.objInstId==aT){aQ=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==35){aQ=stepOrder.main.getAccessNumber(aT)}else{if(aT!=undefined&&aT>0){aQ=order.prodModify.choosedProdInfo.accNbr}}}}}return aQ};var q=function(aT){var aQ="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var aR=0;aR<OrderInfo.boProdAns.length;aR++){var aS=OrderInfo.boProdAns[aR];if(aS.prodId==aT){if(aS.areaCode!=undefined){aQ=aS.areaCode}}}}else{if(aT!=undefined&&aT>0){aQ=order.prodModify.choosedProdInfo.areaCode}}if(aQ==undefined||aQ==""){aQ=OrderInfo.staff.areaCode}return aQ};var P=function(aQ){var aR="";$.each(OrderInfo.boProdAns,function(){if(this.memberRoleCd==aQ){aR=this.accessNumber;return false}});if(aR==undefined||aR==""){aR=OrderInfo.boProdAns[0].accessNumber}return aR};var I=function(aR){var aQ="";if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){if(OrderInfo.offer.offerMemberInfos!=undefined){$.each(OrderInfo.offer.offerMemberInfos,function(aS){if(this.objInstId==aR){aQ=this.roleName;return false}})}$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==aR){aQ=this.roleName;return false}})});if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(aT){var aS=this.offerRoleName;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==aR){aQ=aS;return false}})}})}}else{if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(aT){var aS=this.offerRoleName;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==aR){aQ=aS;return false}})}})}}return aQ};var ar=function(aR){var aQ={};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(aS){if(this.objInstId==aR){aQ=this;aQ.accNbr=this.accessNumber;return false}});$.each(OrderInfo.offerSpec.offerRoles,function(aS){if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==aR){aQ=this;return false}})}});$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==aR){aQ=this;aQ.accNbr=this.accessNumber;return false}})})}else{if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22){aQ=order.prodModify.choosedProdInfo}else{$.each(OrderInfo.offerSpec.offerRoles,function(aS){if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==aR){aQ=this;return false}})}})}}return aQ};var V=function(aR){var aQ=CONST.PROD_SPEC.CDMA;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==aR){aQ=this.objId;return false}})})}else{if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(aS){if(this.objInstId==aR){aQ=this.objId;
return false}});if(offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objInstId==aR){aQ=this.objId;return false}})})}if(offerChange.newMemberFlag){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==aR){aQ=this.objId;return false}})})}}else{if(aR!=undefined&&aR>0){if(ec.util.isArray(OrderInfo.oldprodInstInfos)&&OrderInfo.actionFlag==6){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==aR){aQ=this.productId}})}else{aQ=order.prodModify.choosedProdInfo.productId}}}}return aQ};var m=function(aQ){if(OrderInfo.privilege.effTime==""){var aR={manageCode:aQ};return query.offer.checkOperate(aR)}};var w=function(aT,aQ){if(!OrderInfo.choosedUserInfos){OrderInfo.choosedUserInfos=[]}var aR=-1;for(var aS=0;aS<OrderInfo.choosedUserInfos.length;aS++){if(OrderInfo.choosedUserInfos[aS].prodId==aT){aR=aS;break}}if(aR==-1){OrderInfo.choosedUserInfos.push({prodId:aT,custInfo:aQ})}else{OrderInfo.choosedUserInfos[aR].custInfo=aQ}};var F=function(aR){if(!!OrderInfo.choosedUserInfos&&OrderInfo.choosedUserInfos.length){for(var aQ=0;aQ<OrderInfo.choosedUserInfos.length;aQ++){if(OrderInfo.choosedUserInfos[aQ].prodId==aR){return OrderInfo.choosedUserInfos[aQ].custInfo}}}return null};var aI=function(){order.cust.queryForChooseUser=false;order.cust.tmpChooseUserInfo={};OrderInfo.choosedUserInfos=[]};_newofferSpecName="";var ax=function(aR){for(var aQ=0;aQ<CONST.GROUP_SERV_SPEC_ID.length;aQ++){if(CONST.GROUP_SERV_SPEC_ID[aQ]==aR){return true}}return false};var A=function(aQ,aR,aS){OrderInfo.channelList=[];if($("i[name='channel_iofo_i']").length==0){OrderInfo.channelList=window.parent.OrderInfo.getChannelList()}else{$("i[name='channel_iofo_i']").each(function(){var aV=$(this).attr("channel_Id");var aT=$(this).attr("channel_Name");var aX=$(this).attr("channel_Nbr");var aW=0;if($(this).hasClass("select")){var aW=1}var aU={channelId:aV,channelName:aT,channelNbr:aX,isSelect:aW};OrderInfo.channelList.push(aU)})}return OrderInfo.channelList};return{terminalCode:aG,mktResInstCode:aD,order:an,SEQ:E,resetSeq:l,resetData:Z,orderResult:R,cust:ap,staff:b,offerSpec:ai,offer:M,attach2Coupons:g,boCustInfos:aK,boCustIdentities:O,boPartyContactInfo:W,boCustProfiles:aP,boCusts:Y,boProdItems:T,boProdPasswords:aF,boProdAns:am,boProd2Tds:al,bo2Coupons:f,boProd2OldTds:aO,clearProdUim:aj,clearCheckUimData:ae,getCheckUimData:aB,orderData:B,getOrderData:z,actionClassCd:G,boActionTypeCd:k,actionFlag:K,isSuccess:a,actionTypeName:ab,initData:at,getOfferBusiOrder:aM,getProdBusiOrder:S,createCust:aH,createAcct:i,getProdAn:af,getProdTd:ac,getProdUim:N,getProdOldUim:au,getProdAreaId:L,getProdCoupon:aJ,getProdInst:ar,getAccessNumber:y,getAreaCode:q,getAreaId:aA,getOfferRoleName:I,getAccNbrByRoleCd:P,getProdSpecId:V,getPrivilege:m,initProdCoupon:X,setProdAn:u,setProdModifyBusiOrder:H,confirmList:ag,businessName:J,password_remark:ah,privilege:v,offerProdInst:D,orderlonger:n,busitypeflag:aL,checkresult:r,custorderlonger:ao,prodAttrs:av,zcd_privilege:j,oldprodInstInfos:ay,oldofferSpec:aq,oldoffer:p,oldprodAcctInfos:aw,oldAddNumList:U,newofferSpecName:_newofferSpecName,viceOfferSpec:h,prodInstAttrs:ad,isGroupProSpecId:ax,choosedUserInfos:aC,updateChooseUserInfos:w,getChooseUserInfo:F,resetChooseUserInfo:aI,checkUimData:aE,provinceInfo:C,newOrderInfo:Q,newOrderNumInfo:o,surplusNum:t,oldSubPhoneNum:c,channelList:az,getChannelList:A}})();CommonUtils.regNamespace("order","main");order.main=(function(){var o=function(aa){if(aa==undefined||!aa){aa=g()}if(order.memberChange.newMemberFlag&&OrderInfo.actionFlag==6){var Z=false;if(aa.feeTypeMain=="2100"&&(OrderInfo.offerSpec.feeType=="2100"||OrderInfo.offerSpec.feeType=="3100"||OrderInfo.offerSpec.feeType=="3101"||OrderInfo.offerSpec.feeType=="3103")){Z=true}else{if(aa.feeTypeMain=="1200"&&(OrderInfo.offerSpec.feeType=="1200"||OrderInfo.offerSpec.feeType=="3100"||OrderInfo.offerSpec.feeType=="3102"||OrderInfo.offerSpec.feeType=="3103")){Z=true}else{if(aa.feeTypeMain=="1201"&&(OrderInfo.offerSpec.feeType=="1201"||OrderInfo.offerSpec.feeType=="3101"||OrderInfo.offerSpec.feeType=="3102"||OrderInfo.offerSpec.feeType=="3103")){Z=true}}}if(!Z){$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");return}}$.callServiceAsHtml(contextPath+"/token/pc/order/main",aa,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(ab){if(!ab){ab.data="查询失败,稍后重试"}if(ab.code!=0){$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=aa.actionFlag;if(OrderInfo.actionFlag==2){offerChange.fillOfferChange(ab,aa)}else{if(OrderInfo.actionFlag==21){order.memberChange.fillmemberChange(ab,aa)}else{z(ab,aa)}}if(CONST.getAppDesc()==1&&(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14)){$("#li_is_activation").show()}},always:function(){$.unecOverlay()}})};var z=function(Z,af){order.prepare.showOrderTitle(OrderInfo.actionTypeName,af.offerSpecName,false);SoOrder.initFillPage();$("#deal_package").css("display","none");$("#order_prod_list").css("display","none");$("#order_fill_content").html(Z.data);y();A();p(af);H();if(CONST.getAppDesc()==0){$("#orderAttrDiv").show();h()}if(af.actionFlag==""){OrderInfo.actionFlag=1}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==13||OrderInfo.actionFlag==14){order.main.initAcct(0);order.dealer.initDealer()}if(OrderInfo.actionFlag==6){if(order.memberChange.newMemberFlag){i(af)}if(order.memberChange.oldMemberFlag){j(1);R(af)}if(order.memberChange.changeMemberFlag){order.memberChange.fillmemberChange(Z,af)}}else{if(order.service.oldMemberFlag){order.main.initAcct(1)}i(af)}if(OrderInfo.actionFlag==1){$("#templateOrderDiv").show()}G();order.phoneNumber.initOffer("-1");if(OrderInfo.actionFlag==1&&OrderInfo.newOrderInfo.isLastFlag=="true"){$("#fillLastStep").show()}$("#fillNextStep").off("click").on("click",function(){SoOrder.submitOrder()});if(af.memberChange){$("#orderedprod").hide();$("#order_prepare").hide();$("#productDiv .pdcardcon:first").show();order.prepare.step(1);$("#fillLastStep").off("click").on("click",function(){order.prodModify.cancel()})}else{$("#fillLastStep").off("click").on("click",function(){u()})}r();if(OrderInfo.acct&&OrderInfo.acct.acctCd!=null&&OrderInfo.acct.acctCd!=""){C()}if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""){var af={phoneNum:"",prodId:""};af.phoneNum=OrderInfo.newOrderNumInfo.mainPhoneNum;af.prodId="-1";var am=order.phoneNumber.queryPhoneNumber(af);if(am==undefined||am.datamap==undefined||am.datamap.baseInfo==undefined){$("#nbr_btn_-1").html("<u></u>");$("#nbr_btn_-1").removeAttr("onclick")}else{if(am&&am.datamap.baseInfo!=undefined){var ar={prodId:af.prodId,accessNumber:am.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:am.datamap.baseInfo.phoneNumId,pnLevelId:am.datamap.baseInfo.phoneLevelId,anTypeCd:am.datamap.baseInfo.pnTypeId,state:"ADD",areaId:am.datamap.baseInfo.areaId,areaCode:am.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:am.datamap.baseInfo.prePrice,minCharge:am.datamap.baseInfo.pnPrice,idFlag:"1"};if(af.prodId&&af.prodId=="-1"){ar.memberRoleCd=CONST.MEMBER_ROLE_CD.MAIN_CARD}$("#nbr_btn_-1").html(OrderInfo.newOrderNumInfo.mainPhoneNum+"<u></u>");$("#nbr_btn_-1").removeAttr("onclick");OrderInfo.boProdAns.push(ar)}}}if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""){var af={phoneNum:"",prodId:""};var ap=$("a[id^='nbr_btn_']");var aw=OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");var al=[];$.each(ap,function(){if($(this).attr("id")!="nbr_btn_-1"){al.push(this)}});$.each(al,function(aA,aD){af.phoneNum=aw[aA];af.prodId=-2-aA;var aB=order.phoneNumber.queryPhoneNumber(af);if(aB==undefined||aB.datamap==undefined||aB.datamap.baseInfo==undefined){$(aD).html("<u></u>");$(aD).removeAttr("onclick")}else{if(aB&&aB.datamap.baseInfo!=undefined){var aC={prodId:af.prodId,accessNumber:aB.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:aB.datamap.baseInfo.phoneNumId,pnLevelId:aB.datamap.baseInfo.phoneLevelId,anTypeCd:aB.datamap.baseInfo.pnTypeId,state:"ADD",areaId:aB.datamap.baseInfo.areaId,areaCode:aB.datamap.baseInfo.zoneNumber,memberRoleCd:"",preStore:aB.datamap.baseInfo.prePrice,minCharge:aB.datamap.baseInfo.pnPrice,idFlag:"1"};
if(af.prodId&&af.prodId!="-1"){aC.memberRoleCd=CONST.MEMBER_ROLE_CD.VICE_CARD}$(aD).html(aw[aA]+"<u></u>");$(aD).removeAttr("onclick");OrderInfo.boProdAns.push(aC)}}})}if(OrderInfo.newOrderInfo.isReloadFlag=="N"){var am=OrderInfo.newOrderInfo.result;var ab=OrderInfo.newOrderInfo.prodOfferId;var aj=OrderInfo.newOrderInfo.prodOfferName;order.service.callBackBuildOrder(am,ab,aj)}var at=[];var an=true;if(order.memberChange.newSubPhoneNum!=""&&order.memberChange.reloadFlag=="Y"){var ax=order.memberChange.newSubPhoneNum.split(",");for(var au=0;au<ax.length;au++){if(ax[au]!=""&&ax[au]!=null&&ax[au]!="null"){$.each(at,function(){if(this==ax[au]){an=false;return false}else{an=true}});if(an){at.push(ax[au]);$("#nbr_btn_-"+(au+1)).removeAttr("onclick");$("#nbr_btn_-"+(au+1)).removeClass("selectBoxTwo");$("#nbr_btn_-"+(au+1)).addClass("selectBoxTwoOn");var af={phoneNum:ax[au]};var az=order.phoneNumber.queryPhoneNumber(af);if(az.datamap.baseInfo){$("#nbr_btn_-"+(au+1)).html(ax[au]+"<u></u>");var av={prodId:"-"+(au+1),accessNumber:az.datamap.baseInfo.phoneNumber,anChooseTypeCd:"2",anId:az.datamap.baseInfo.phoneNumId,pnLevelId:az.datamap.baseInfo.phoneLevelId,anTypeCd:az.datamap.baseInfo.pnTypeId,state:"ADD",areaId:az.datamap.baseInfo.areaId,areaCode:az.datamap.baseInfo.zoneNumber,memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,preStore:az.datamap.baseInfo.prePrice,minCharge:az.datamap.baseInfo.pnPrice};OrderInfo.boProdAns.push(av);order.dealer.changeAccNbr("-"+(au+1),ax[au])}}else{$.alert("提示","号码"+ax[au]+"重复输入")}}}}if(order.memberChange.mktResInstCode!=""&&order.memberChange.reloadFlag=="Y"){at=[];an=true;var aa="-1";aa=order.prodModify.choosedProdInfo.prodOfferInstId;$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==prodId){aa=this.mainProdOfferInstInfos[0].prodOfferInstId}});var ai=order.memberChange.mktResInstCode.split(",");for(var ao=0;ao<ai.length;ao++){if(ai[ao]!=""&&ai[ao]!=null&&ai[ao]!="null"&&order.memberChange.newSubPhoneNum!=""){var aq=ai[ao].split("_");var ad=aq[0];var ae=aq[1];var ax=order.memberChange.newSubPhoneNum.split(",");var ag=false;$.each(at,function(){if(this==ad){an=false;return false}else{an=true}});if(!an){$.alert("提示","UIM卡"+ae+"对应的号码重复");return}for(var au=0;au<ax.length;au++){if(ax[au]==ad){at.push(ax[au]);ag=true;$("#uim_txt_-"+(au+1)).attr("disabled",true);var ac={instCode:ae};var Z=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",ac);if(Z.code==0){if(Z.data.mktResBaseInfo){if(Z.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_-"+(au+1)).attr("disabled",true);$("#uim_check_btn_-"+(au+1)).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_-"+(au+1)).attr("disabled",false);$("#uim_release_btn_-"+(au+1)).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_-"+(au+1)).val(ae);var ak={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:Z.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:Z.data.mktResBaseInfo.qty,storeId:Z.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:ae,terminalCode:ae,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-(au+1),offerId:aa,state:"ADD",relaSeq:""};OrderInfo.clearProdUim(-(au+1));OrderInfo.boProd2Tds.push(ak)}else{$.alert("提示","UIM卡不是预占状态，当前为"+Z.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","查询不到UIM信息")}}else{if(Z.code==-2){$.alertM(Z.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}break}}if(!ag){$.alert("提示","UIM卡"+ae+"未匹配到接入号")}}}}if(OrderInfo.provinceInfo.salesCode!=""&&(OrderInfo.newOrderInfo.isReloadFlag!="N"||order.memberChange.reloadFlag=="Y")){order.main.queryDealer()}if(order.memberChange.reloadFlag=="N"){$("#dealerTbody").empty();var ay=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;$.each(ay,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="3"){}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){$("#nbr_btn_"+this.data.boProdAns[0].prodId).removeClass("selectBoxTwo");$("#nbr_btn_"+this.data.boProdAns[0].prodId).addClass("selectBoxTwoOn");$("#nbr_btn_"+this.data.boProdAns[0].prodId).html(this.busiObj.accessNumber+"<u></u>");var aN={prodId:this.data.boProdAns[0].prodId,accessNumber:this.data.boProdAns[0].accessNumber,anChooseTypeCd:this.data.boProdAns[0].anChooseTypeCd,anId:this.data.boProdAns[0].anId,pnLevelId:this.data.boProdAns[0].pnLevelId,anTypeCd:this.data.boProdAns[0].anTypeCd,state:this.data.boProdAns[0].state,areaId:this.data.boProdAns[0].areaId,areaCode:this.data.boProdAns[0].areaCode,memberRoleCd:this.data.boProdAns[0].memberRoleCd,preStore:this.data.boProdAns[0].preStore,minCharge:this.data.boProdAns[0].minCharge};OrderInfo.boProdAns.push(aN);order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);var aJ={couponUsageTypeCd:this.data.bo2Coupons[0].couponUsageTypeCd,inOutTypeId:this.data.bo2Coupons[0].inOutTypeId,inOutReasonId:this.data.bo2Coupons[0].inOutReasonId,saleId:this.data.bo2Coupons[0].saleId,couponId:this.data.bo2Coupons[0].couponId,couponinfoStatusCd:this.data.bo2Coupons[0].couponinfoStatusCd,chargeItemCd:this.data.bo2Coupons[0].chargeItemCd,couponNum:this.data.bo2Coupons[0].couponNum,storeId:this.data.bo2Coupons[0].storeId,storeName:this.data.bo2Coupons[0].storeName,agentId:this.data.bo2Coupons[0].agentId,apCharge:this.data.bo2Coupons[0].apCharge,couponInstanceNumber:this.data.bo2Coupons[0].couponInstanceNumber,terminalCode:this.data.bo2Coupons[0].terminalCode,ruleId:this.data.bo2Coupons[0].ruleId,partyId:this.data.bo2Coupons[0].partyId,prodId:this.data.bo2Coupons[0].prodId,offerId:this.data.bo2Coupons[0].offerId,state:this.data.bo2Coupons[0].state,relaSeq:this.data.bo2Coupons[0].relaSeq};OrderInfo.clearProdUim(this.busiObj.instId);OrderInfo.boProd2Tds.push(aJ);$("#pwd_"+this.busiObj.instId).val(this.data.boProdPasswords[0].pwd);$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected")}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"){}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="1"){}}}}if(this.data.busiOrderAttrs!=undefined){var aR=[];var aI={};var aH={};var aG={};$.each(this.data.busiOrderAttrs,function(){if(this.role=="40020005"){aI.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aI.staffid=this.value;aI.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aI.staffname=this.value}}}else{if(this.role=="40020006"){aH.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aH.staffid=this.value;aH.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aH.staffname=this.value}}}else{if(this.role=="40020007"){aG.role=this.role;if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){aG.staffid=this.value;aG.channelNbr=this.channelNbr}else{if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){aG.staffname=this.value}}}}}});if(ec.util.isObj(aI.role)){aR.push(aI)}if(ec.util.isObj(aH.role)){aR.push(aH)}if(ec.util.isObj(aG.role)){aR.push(aG)}var aD="";var aF="";if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){aD=this.busiObj.instId}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){aD=this.data.ooRoles[0].prodId+"_"+this.busiObj.objId;aF="DEL"}}var aB=this.busiObj.accessNumber;
for(var aP=0;aP<aR.length;aP++){var aQ;if(aP==0){aQ=$("<tr id='tr_"+aD+"' name='tr_"+aD+"'></tr>")}else{aQ=$('<tr name="tr_'+aD+'"></tr>')}var aM=$("<td></td>");var aK=aD+"_"+OrderInfo.SEQ.dealerSeq;var aO=$('<select id="dealerType_'+aK+'" name="dealerType_'+aD+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+aD+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(aR[aP].role==this.PARTYPRODUCTRELAROLECD){aO.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected>"+this.NAME+"</option>")}else{aO.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});aM.append(aO);aM.append('<label class="f_red">*</label>');aQ.append("<td>"+aB+"</td>");if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){aQ.append("<td>移动电话（仅含本地语音）</td>")}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"){aQ.append("<td>"+this.busiObj.objName+"</td>")}}aQ.append(aM);var aE;if(aF=="DEL"){if(aP==0){aE=$('<td><input type="text" id="dealer_'+aK+'" staffId="'+aR[aP].staffid+'" value="'+aR[aP].staffname+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>')}else{aE=$('<td><input type="text" id="dealer_'+aK+'" staffId="'+aR[aP].staffid+'" value="'+aR[aP].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>')}}else{aE=$('<td><input type="text" id="dealer_'+aK+'" staffId="'+aR[aP].staffid+'" value="'+aR[aP].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>')}aE.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+aK+"');\">选择</a>");if(aP==0){if(aF=="DEL"){aE.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>')}aE.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+aD+',1)">添加</a><label class="f_red">*</label>')}else{aE.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>')}aQ.append(aE);if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){OrderInfo.getChannelList()}var aA=$("<td></td>");var aC=$('<select id="dealerChannel_'+aK+'" name="dealerChannel_'+aD+'" class="inputWidth183px" onclick=a=this.value;></select>');$.each(OrderInfo.channelList,function(){if(aR[aP].channelNbr==this.channelNbr){aC.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>")}else{aC.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>")}});aA.append(aC);aA.append('<label class="f_red">*</label>');aQ.append(aA);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(aQ)}}if(this.data.boAccountRelas!=undefined){var aL=this.data.boAccountRelas[0].acctId;$("#acctSelect").find("option[value="+aL+"]").attr("selected","selected")}});var ah=order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;$.each(ah,function(){if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){$("#order_remark").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrName){$("#orderAttrName").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrPhoneNbr){$("#orderAttrPhoneNbr").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderIdentidiesTypeCd){$("#orderIdentidiesTypeCd").find("option[value="+this.value+"]").attr("selected","selected")}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrIdCard){$("#orderAttrIdCard").val(this.value)}if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrAddr){$("#orderAttrAddr").val(this.value)}});order.main.reload()}};function U(af,ah,Z,ak){var aa=CacheData.getServSpec(af,ah);if(aa==undefined){var ag={objId:ah,servSpecId:ah,servSpecName:Z,ifParams:ak,isdel:"C"};var aj={prodSpecId:ah};if(ak=="Y"){var ad=query.prod.prodSpecParamQuery(aj);if(ad==undefined||ad.result==undefined){return}ag.prodSpecParams=ad.result.prodSpecParams;if(ah==CONST.YZFservSpecId){var ai=$("select[name='pay_type_-1']").val();if(ai==undefined){ai=order.prodModify.choosedProdInfo.feeType}if(ai==CONST.PAY_TYPE.AFTER_PAY){for(var ac=0;ac<ag.prodSpecParams.length;ac++){var ae=ag.prodSpecParams[ac];ae.setValue=""}}else{for(var ac=0;ac<ag.prodSpecParams.length;ac++){var ae=ag.prodSpecParams[ac];if(ae.value!=""){ae.setValue=ae.value}else{if(!!ae.valueRange[0]&&ae.valueRange[0].value!=""){ae.setValue=ae.valueRange[0].value}}}}}}CacheData.setServSpec(af,ag);aa=ag}var ah=aa.servSpecId;var ab=CacheData.getExcDepServParam(af,ah);AttachOffer.addOpenServList(af,ah,aa.servSpecName,aa.ifParams)}function D(ab,ac){var Z=_setSpec(ab,ac);if(Z==undefined){return}var aa=CacheData.getOfferProdStr(ab,Z,0);$.confirm("信息确认",aa,{yes:function(){CacheData.setServ2OfferSpec(ab,Z)},yesdo:function(){_checkOfferExcludeDepend(ab,Z)},no:function(){}})}var R=function(ac){for(var Z=0;Z<OrderInfo.oldprodInstInfos.length;Z++){var aa=OrderInfo.oldprodInstInfos[Z];$.each(OrderInfo.oldoffer,function(){if(this.accNbr==aa.accNbr){var ad=this;$.each(ad.offerMemberInfos,function(){var ai=this;if(ai.objType==CONST.OBJ_TYPE.PROD){var ag=this.objInstId;var ah={areaId:OrderInfo.getProdAreaId(ag),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:ag,prodSpecId:ai.objId,offerSpecId:aa.mainProdOfferInstInfos[0].prodOfferId,offerRoleId:"",acctNbr:ai.accessNumber,partyId:aa.custId,distributorId:OrderInfo.staff.distributorId,mainOfferSpecId:aa.mainProdOfferInstInfos[0].prodOfferId,soNbr:OrderInfo.order.soNbr};if(ec.util.isObj(aa.prodBigClass)){ah.prodBigClass=aa.prodBigClass}$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==aa.accNbr){$.each(this.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD||this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){ah.offerRoleId=this.offerRoleId}})}});var ae=query.offer.queryChangeAttachOffer(ah);$("#attach_"+ag).html(ae);if(ec.util.isObj(ai.objId)&&ec.util.isObj(ai.objType)&&ec.util.isObj(ai.offerRoleId)){ah.queryType="1,2";ah.objId=ai.objId;ah.objType=ai.objType;ah.memberRoleCd="401";var af=query.offer.queryDefMustOfferSpec(ah);CacheData.parseOffer(af);var af=query.offer.queryServSpec(ah);CacheData.parseServ(af)}if(ec.util.isArray(OrderInfo.oldofferSpec)){$.each(OrderInfo.oldofferSpec,function(){if(this.accNbr==aa.accNbr){var aj=this.offerSpec.offerRoles;$.each(aj,function(){if(this.offerRoleId==ai.offerRoleId&&ai.objType==CONST.OBJ_TYPE.PROD){var ak=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var am=CacheData.getServBySpecId(ag,this.objId);if(am!=undefined){var al=$("#li_"+ag+"_"+am.servId);if(this.minQty==1){al.append('<dd class="mustchoose"></dd>')}al.append('<dd id="jue_'+ag+"_"+am.servId+'" class="jue2" title="'+ak.offerRoleName+'"></dd>')}}});return false}})}})}AttachOffer.changeLabel(ag,aa.productId,"")}})}});var ab={};if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){if(this.accNbr==aa.accNbr){ab=this}})}if(order.prodModify.choosedProdInfo.is3G=="N"&&aa.mainProdOfferInstInfos[0].is3G=="Y"){if(!order.memberChange.checkOrder(aa,ab)){return}order.memberChange.checkOfferProd(ab)}}};var E=function(aa){if(CONST.getAppDesc()==0){var ac=OrderInfo.oldprodInstInfos.prodClass;var ab=OrderInfo.oldprodInstInfos.prodInstId;if(ac==CONST.PROD_CLASS.THREE){var Z=CacheData.getServSpec(ab,CONST.PROD_SPEC.PROD_FUN_4G);if(Z!=undefined&&Z.isdel!="Y"&&Z.isdel!="C"){return true}}}return false};var m=function(ac){for(var Z=0;Z<OrderInfo.oldoffer.length;Z++){for(var aa=0;aa<OrderInfo.oldoffer[Z].offerMemberInfos.length;aa++){var ab=OrderInfo.oldoffer[Z].offerMemberInfos[aa];if(ab.objInstId==ac){return ab}}}return{}};var i=function(Z){$.each(OrderInfo.offerSpec.offerRoles,function(){var ac=this;for(var aa=0;aa<this.prodInsts.length;aa++){var ab=this.prodInsts[aa];var ae={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:ab.objId,offerRoleId:ab.offerRoleId,prodId:ab.prodInstId,queryType:"1,2",objType:ab.objType,objId:ab.objId,memberRoleCd:ab.memberRoleCd};AttachOffer.queryAttachOfferSpec(ae);
var ad={ul_id:"item_order_"+ab.prodInstId,prodId:ab.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:ab.objId,roleCd:ac.roleCd,offerRoleId:ac.offerRoleId,partyId:OrderInfo.cust.custId};order.main.spec_parm(ad)}});if(order.service.oldMemberFlag){order.main.loadAttachOffer()}};var a=function(Z){$(".paymethodChange").each(function(){if($(this).attr("id")!=$(Z).attr("id")){$(this).val($(Z).val())}})};var Y=function(Z){if($("#isTemplateOrder").attr("checked")=="checked"){}return true};var p=function(Z){if(Z.feeType!=undefined&&Z.feeType&&Z.feeType!=CONST.PAY_TYPE.NOLIMIT_PAY){$("input[name^=pay_type_][value="+Z.feeType+"]").attr("checked","checked");$("input[name^=pay_type_]").attr("disabled","disabled")}};var j=function(Z){if((OrderInfo.actionFlag==1||OrderInfo.actionFlag==13||OrderInfo.actionFlag==14)&&Z==0){I();return}if(OrderInfo.actionFlag==6||OrderInfo.actionFlag==2){var ad={};if(Z==1){for(var ab=0;ab<OrderInfo.oldprodInstInfos.length;ab++){ad.prodId=OrderInfo.oldprodInstInfos[ab].prodInstId;ad.acctNbr=OrderInfo.oldprodInstInfos[ab].accNbr;ad.areaId=OrderInfo.oldprodInstInfos[ab].areaId;var ac=$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",ad);if(ac.code==-2){$.alertM(ac.data);return}var aa=ac.data;aa[0].accessNumber=OrderInfo.oldprodInstInfos.accNbr;OrderInfo.oldprodAcctInfos.push({prodAcctInfos:aa})}}else{ad.prodId=order.prodModify.choosedProdInfo.prodInstId;ad.acctNbr=order.prodModify.choosedProdInfo.accNbr;ad.areaId=order.prodModify.choosedProdInfo.areaId;var ac=$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",ad);if(ac.code==-2){$.alertM(ac.data);return}var aa=ac.data;$("#accountDiv").find("label:eq(0)").text("主卡帐户：");$.each(aa,function(ae,af){$("<option>").text(af.name+" : "+af.acctCd).attr("value",af.acctId).attr("acctcd",af.acctCd).appendTo($("#acctSelect"))});$("#accountDiv").find("a:eq(0)").hide()}}else{I()}};var y=function(){$(".ordertabcon:first").show();$(".ordertab li:first").addClass("setorder");$(".ordertab li").each(function(Z){$(this).click(function(){var aa=$(this).attr("order");if(aa>1){$(".order_copy").show()}else{$(".order_copy").hide()}$(this).addClass("setorder").siblings().removeClass("setorder");$(this).parents(".ordernav").parent().siblings(".ordercon").find(".ordertabcon").eq(Z).show().siblings().hide()})})};var r=function(){var ai=OrderInfo.provinceInfo.codeMsg;if(ai!=null&&ai!=""){$.alert("提示",ai)}else{var ah=OrderInfo.newOrderNumInfo.mktResInstCode;if(OrderInfo.newOrderNumInfo.mktResInstCode&&ah!=null&&ah!=""){var ah=OrderInfo.newOrderNumInfo.mktResInstCode.split(",");for(var af=0;af<=ah.length;af++){var ac=ah[af];if(ac!=null&&ac!=""){var Z=ac.split("_");if(Z!=null&&Z.length==2){var ag=Z[0];var ab=Z[1];var ae={instCode:ab};var ad=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",ae);if(ad.code==0){if(ad.data&&ad.data.mktResBaseInfo){if(ad.data.mktResBaseInfo.statusCd=="1102"){$("#uim_check_btn_"+ag).attr("disabled",true);$("#uim_check_btn_"+ag).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+ag).attr("disabled",false);$("#uim_release_btn_"+ag).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+ag).val(ab);var aa={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:ad.data.mktResBaseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:ad.data.mktResBaseInfo.qty,storeId:ad.data.mktResBaseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:ad.data.mktResBaseInfo.instCode,terminalCode:ad.data.mktResBaseInfo.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:ag,offerId:"-1",state:"ADD",relaSeq:""};OrderInfo.clearProdUim(ag);OrderInfo.boProd2Tds.push(aa)}else{$.alert("提示","UIM卡["+ab+"]不是预占状态，当前为"+ad.data.mktResBaseInfo.statusCd)}}else{$.alert("提示","没有查询到相应的UIM卡["+ab+"]信息")}}else{if(ad.code==-2){$.alert(ad.data)}else{$.alert("提示","UIM信息查询接口出错,稍后重试")}}}}}}}};var A=function(){$.each($(".pdcard"),function(Z,aa){$(this).find("li:first").addClass("setcon");if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each($(this).find("li"),function(ac,ab){$(this).click(function(){$(this).addClass("setcon").siblings().removeClass("setcon");$(this).parent().parent().next(".cardtabcon").find(".pdcardcon").eq(ac).show().siblings().hide()})})}})};var h=function(){order.cust.partyTypeCdChoose($("#orderPartyTypeCd").children(":first-child"),"orderIdentidiesTypeCd");order.cust.identidiesTypeCdChoose($("#orderIdentidiesTypeCd").children(":first-child"),"orderAttrIdCard")};var H=function(){if(order.cust.fromProvFlag=="1"&&ec.util.isObj(order.cust.provIsale)){$("#orderProvAttrIsale").val(order.cust.provIsale)}};var G=function(){$("#acctQueryForm").bind("formIsValid",function(aa,Z){var ab;if($("#chooseQueryAcctType").val()==1){if(!CONST.LTE_PHONE_HEAD.test($.trim($("#d_query_nbr input").val()))){$.alert("提示","请输入有效的中国电信手机号");return}ab={accessNumber:$("#d_query_nbr input").val()}}else{if($("#chooseQueryAcctType").val()==2){if($.trim($("#d_query_cd input").val())==null||$.trim($("#d_query_cd input").val())==""){$.alert("提示","请输入合同号");return}ab={acctCd:$("#d_query_cd input").val()}}else{ab={custId:OrderInfo.cust.custId,isServiceOpen:"Y"}}}ab.areaId=OrderInfo.getAreaId();$.callServiceAsJson(contextPath+"/token/pc/order/account",ab,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(ac){$("#acctListTab tbody").empty();if(ac.code==-2){$.alertM(ac.data);return}if(ac.code==0){var ad=ac.data;if(ad.resultCode==0){if(ad.accountInfos&&ad.accountInfos.length>0){$("#acctPageDiv").empty();common.page.init("acctPageDiv",5,"pageId","queryAccount",ad.accountInfos)}else{$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+ad.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+ac.data+"</td</tr>").appendTo($("#acctListTab tbody"))}}})}).ketchup({bindElement:"querAcctBtn"});$("#zhanghuclose").click(function(){easyDialog.close();$(document).removeJEventListener("queryAccount")});$(this).addJEventListener("queryAccount",function(Z){l(Z)});$("#chooseQueryAcctType").change(function(){if($(this).val()==1){$("#d_query_cd").remove();$("#querAcctBtn").parent().before("<dd id='d_query_nbr'>&nbsp;<input type='text' data-validate='validate(required:接入号不能为空) on(keyup blur)' value='' class='inputWidth150px'></dd>")}else{if($(this).val()==2){$("#d_query_nbr").remove();$("#querAcctBtn").parent().before("<dd id='d_query_cd'>&nbsp;<input type='text' data-validate='validate(required:合同号不能为空) on(keyup blur)' value='' class='inputWidth150px' ></dd>")}else{$("#d_query_cd").remove();$("#d_query_nbr").remove()}}});$("#chooseQueryAcctType").change();$("#acctSelect").change(function(){if($(this).val()==-1){$(this).parent().find("a:eq(1)").hide();$("#defineNewAcct").show()}else{$(this).parent().find("a:eq(1)").show();$("#defineNewAcct").hide()}})};var l=function(Z){$("#acctListTab tbody").empty();$.each(Z,function(aa,ac){var ab=$("<tr></tr>").appendTo($("#acctListTab tbody"));if(ac.name){$("<td class='teleNum'>"+ac.name+"</td>").appendTo(ab)}else{$("<td></td>").appendTo(ab)}if(ac.acctId){$("<td acctId='"+ac.acctId+"'>"+ac.accountNumber+"</td>").appendTo(ab)}else{$("<td></td>").appendTo(ab)}if(ac.owner){$("<td>"+ac.owner+"</td>").appendTo(ab)}else{$("<td></td>").appendTo(ab)}if(ac.accessNumber){$("<td>"+ac.accessNumber+"</td>").appendTo(ab)}else{$("<td></td>").appendTo(ab)}ab.click(function(){var ae=false;var ad=$("#acctSelect").find("option");$.each(ad,function(ag,af){if(af.value==ac.acctId){$("#acctSelect").find("option[value="+af.value+"]").attr("selected","selected");ae=true;return false}});$(this).dispatchJEvent("chooseAcct",ac);easyDialog.close();$("#defineNewAcct").hide()})})};var N=function(Z){};function s(Z){$.callServiceAsHtmlGet(contextPath+"/order/orderSpecParam",Z,{done:function(ab){if(ab&&ab.code==-2){if(Z.prodId!=-1&&Z.prodId!="-1"){$("#"+Z.ul_id).append("<li><label> </label></li>")
}return}else{if(ab&&(ab.data==0||ab.data=="0")){if(Z.prodId!=-1&&Z.prodId!="-1"){$("#"+Z.ul_id).append("<li><label> </label></li>")}return}}$("#"+Z.ul_id).append(ab.data);P(Z.prodId,$("#"+Z.ul_id));var ae=$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+Z.prodId);if(ae.length==1){if(OrderInfo.actionFlag==6){var ac=false;if(OrderInfo.prodInstAttrs&&OrderInfo.prodInstAttrs.length){$.each(OrderInfo.prodInstAttrs,function(){if(this.itemSpecId==CONST.PROD_ATTR.IS_XINKONG){$(ae).val(this.value);ac=true}})}if(ac){$(ae).attr("disabled","disabled")}else{$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+Z.prodId+" option[value='']").remove();$(ae).val("20");if(OrderInfo.offerSpec.feeType==CONST.PAY_TYPE.BEFORE_PAY){$(ae).attr("disabled","disabled")}}}else{if(OrderInfo.actionFlag!=1&&OrderInfo.actionFlag!=14){$(ae).attr("disabled","disabled")}else{$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+Z.prodId+" option[value='']").remove();$(ae).val("20");if(OrderInfo.offerSpec.feeType==CONST.PAY_TYPE.BEFORE_PAY){$(ae).attr("disabled","disabled")}}}}$.each(OrderInfo.newOrderInfo.checkMaskList,function(){$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+this.prodId+"").find("option[value='"+this.isCheckMask+"']").attr("selected","selected")});if(OrderInfo.newOrderInfo.isReloadFlag=="N"){var ad=$("select[name='pay_type_-1']").find("option:selected").val();if(ad=="2100"){order.main.feeTypeCascadeChange($("select[name='pay_type_-1']"),"-1")}}if(order.memberChange.reloadFlag=="N"||OrderInfo.newOrderInfo.isReloadFlag=="N"||OrderInfo.reloadFlag=="N"){var aa="";if(order.memberChange.rejson&&order.memberChange.rejson.orderList&&order.memberChange.rejson.orderList.custOrderList[0].busiOrder){aa=order.memberChange.rejson.orderList.custOrderList[0].busiOrder}else{if(OrderInfo.newOrderInfo.result&&OrderInfo.newOrderInfo.result.orderList){aa=OrderInfo.newOrderInfo.result.orderList.custOrderList[0].busiOrder}else{if(OrderInfo.data&&OrderInfo.data.orderList){aa=OrderInfo.data.orderList.custOrderList[0].busiOrder}}}$.each(aa,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="1"){if(this.data.boProdItems){var af=this.data.boProdItems;$("[name=prodSpec_"+this.busiObj.instId+"]").each(function(){var aj=this.tagName;var ah=$(this).attr("id").split("_")[0];var ag=$(this).attr("id");for(var ai=0;ai<af.length;ai++){if(af[ai].itemSpecId==ah&&ag.split("_")[1]==af[ai].prodSpecItemId){if(aj=="SELECT"){$("#"+ag+" option[value='"+af[ai].value+"']").attr("selected","selected")}else{$("#"+ag).val(af[ai].value)}}}})}}})}},fail:function(aa){$.unecOverlay()}})}function P(ab,ad){var ac=CONST.PROD_ATTR.PROD_USER+"_"+ab;if($("#"+ac).length>0){var Z=true;if(OrderInfo.cust&&OrderInfo.cust.custId&&OrderInfo.cust.custId!="-1"){if(OrderInfo.cust.segmentId=="1000"){Z=false}}else{if(OrderInfo.boCustInfos&&OrderInfo.boCustInfos.partyTypeCd=="2"){Z=false}}if(!Z){for(var aa=0;aa<OrderInfo.prodAttrs.length;aa++){if(OrderInfo.prodAttrs[aa].id==ac){OrderInfo.prodAttrs[aa].isOptional="N";break}}$("#"+ac).attr({check_option:"N",readonly:"readonly",disabled:"disabled"}).show();$("#choose_user_btn_"+ab).off("click").on("click",function(){order.main.toChooseUser(ab)}).show()}else{$("#"+ac).attr({readonly:"readonly",disabled:"disabled"}).hide();$("#choose_user_btn_"+ab).off("click").hide();$("#choose_user_btn_"+ab).parent().hide()}}}function Q(Z){order.cust.queryForChooseUser=true;order.cust.bindCustQueryForChoose();$("#chooseUserBtn").off("click").on("click",function(){if(!!order.cust.tmpChooseUserInfo&&order.cust.tmpChooseUserInfo.custId){OrderInfo.updateChooseUserInfos(Z,order.cust.tmpChooseUserInfo);$("#"+CONST.PROD_ATTR.PROD_USER+"_"+Z+"_name").val(order.cust.tmpChooseUserInfo.partyName);$("#"+CONST.PROD_ATTR.PROD_USER+"_"+Z).val(order.cust.tmpChooseUserInfo.custId);order.cust.tmpChooseUserInfo={};easyDialog.close();$("#chooseUserList").hide()}else{$.alert("提示","请定位客户作为使用人");return false}});V(null,Z)}function V(Z,aa){Z=Z||OrderInfo.getChooseUserInfo(aa);if(Z!=null&&Z.custId){order.cust.tmpChooseUserInfo=Z;$("#chooseUserInfoName").html(Z.partyName);$("#chooseUserInfoNum").html(Z.identityName+"/"+Z.idCardNumber);$("#chooseUserInfoAreaName").html(Z.areaName);$("#chooseUserList").show()}else{$("#chooseUserInfo td").html("");$("#chooseUserList").hide()}$("#p_cust_identityCd_choose option:first").attr("selected","selected");$("#p_cust_identityNum_choose").val("");order.cust.custidentidiesTypeCdChoose($("#p_cust_identityCd_choose"),"p_cust_identityNum_choose");if($.ketchup){$.ketchup.hideAllErrorContainer($("#custQueryForChooseForm"))}easyDialog.open({container:"choose_user_dialog",callback:function(){order.cust.queryForChooseUser=false;if($.ketchup){$.ketchup.hideAllErrorContainer($("#custQueryForChooseForm"))}}})}function M(){if(!k("order_spc_update")){return}var aa=new Array();var ab=0;$("#order_spc_update input").each(function(){if($(this).attr("id")!="order_remark"&&$(this).attr("id")!="isTemplateOrder"&&$(this).attr("id")!="templateOrderName"&&$(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var af={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};aa.push(af);ab++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var ae={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};aa.push(ae);ab++}if($(this).val()!=null&&$(this).val()!=""){var ad={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};aa.push(ad);ab++}}}}}});$("#order_spc_update select").each(function(){if($(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var af={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};aa.push(af);ab++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var ae={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};aa.push(ae);ab++}if($(this).val()!=null&&$(this).val()!=""){var ad={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};aa.push(ad);ab++}}}}}});var Z;if($("#order_remark").val()){Z=[{atomActionId:OrderInfo.SEQ.atomActionSeq--,itemSpecId:CONST.ITEM_SPEC_ID_CODE.busiOrderAttrs,value:$("#order_remark").val()}];ab++}if(ab<1){$.alert("提示","您未修改订单属性");return}var ac={boProdItems:aa};if(Z){ac.busiOrderAttrs=Z}OrderInfo.actionFlag=33;SoOrder.submitOrder(ac)}function k(aa){var Z=true;$("#"+aa).find("input").each(function(){if(Z){Z=x(this)}});return Z}function x(ad){if($(ad).attr("check_option")=="N"){if($(ad).val()==null||$(ad).val()==""){$.alert("提示",$(ad).attr("check_name")+" 尚未填写");return false}}if($(ad).attr("check_type")=="check"){var Z=$(ad).attr("check_len");if(Z>0){if($(ad).val().length>Z){$.alert("提示",$(ad).attr("check_name")+" 长度过长(<"+Z+")");return false}}var aa=$(ad).attr("check_mask");if(aa!=null&&$(ad).val()!=null&&$(ad).val()!=""){var ac=new RegExp(aa);if(!ac.test($(ad).val())){$.alert("提示",$(ad).attr("check_name")+" 校验失败："+$(ad).attr("check_mess"));return false}}var ab=$(ad).val().length;if(ab>0&&$(ad).attr("dataType")=="3"){if(!/^[0-9]+$/.test($(ad).val())){$.alert("提示",$(ad).attr("check_name")+" 非数字，请修改");return false}}else{if(ab>0&&$(ad).attr("dataType")=="5"){if(!/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test($(ad).val())){$.alert("提示",$(ad).attr("check_name")+" 非小数，请修改");return false}}else{if(ab>0&&($(ad).attr("dataType")=="4"||$(ad).attr("dataType")=="16")){}}}}return true}$("staff_dialog_close").onclick=function(){easyDialog.close()
};function q(Z){L(Z,$("#dealer_id").val(),$("#objInstId").val())}function L(aa,Z,ac){if(aa==0){$("#p_staff_areaId").val("");$("#p_staff_areaId_val").val("")}var ab={dealerId:Z,areaId:$("#p_staff_areaId").val(),currentAreaAllName:"",staffName:$("#qryStaffName").val(),staffCode:$("#qryStaffCode").val(),salesCode:$("#qrySalesCode").val(),pageIndex:aa,objInstId:ac,pageSize:10};$.callServiceAsHtml(contextPath+"/staffMgr/getStaffList",ab,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(ad){if(!ad){ad.data=""}$("#div_staff_dialog").html(ad.data);$("#staff_list_body tr").each(function(){$(this).off("click").on("click",function(ae){w("#staff_list_body tr",this);ae.stopPropagation()})});easyDialog.open({container:"div_staff_dialog"})}})}var w=function(ab,aa){$(ab).removeClass("plan_select");$(ab).children(":first-child").html("");$(aa).addClass("plan_select");var Z="<i class='select'></i>";$(aa).children(":first").html(Z)};function T(aa){var Z=$("#staff_list_body .plan_select");if(Z.length<=0){$.alert("操作提示","请选择 协销人！");return}Z.each(function(){var ac=$(this).find("td select[name='channel_list']");$("#dealerChannel_"+aa).empty();var ab="";if(ac.length<=0){$.each(OrderInfo.channelList,function(){if(this.isSelect==1){ab+="<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>"}})}else{$(ac).find("option").each(function(){var ad=$(this).val();var ae=$(this).html();if(this.selected==true){ab+="<option value='"+ad+"' selected ='selected'>"+ae+"</option>"}else{ab+="<option value='"+ad+"'>"+ae+"</option>"}})}$("#dealerChannel_"+aa).append(ab);$("#dealer_"+aa).val($(this).attr("staffName")).attr("staffId",$(this).attr("staffId"))});easyDialog.close()}var J=function(){$("#acctDialog .contract_list td").text("帐户查询");$("#acctDialog .selectList").show();easyDialog.open({container:"acctDialog"});$("#acctPageDiv").show();if(OrderInfo.cust.custId<0){$("#chooseQueryAcctType option[value=0]").remove();$("#chooseQueryAcctType").val(1);$("#d_query_cd").remove();$("#d_query_nbr").remove();$("#querAcctBtn").parent().before("<dd id='d_query_nbr'>&nbsp;<input type='text' data-validate='validate(required:接入号不能为空) on(keyup blur)' value='' class='inputWidth150px'></dd>")}var Z="chooseAcct";var aa=$("#acctSelect");if(!aa.hasJEventListener(Z)){aa.addJEventListener(Z,function(ac){var ab=false;$.each(aa.find("option"),function(ad,ae){if($(ae).val()==ac.acctId){ab=true;return false}});if(ab==false){$("<option>").text(ac.name+" : "+ac.accountNumber).attr("value",ac.acctId).attr("acctcd",ac.accountNumber).appendTo(aa)}aa.find("option[value="+ac.acctId+"]").attr("selected","selected");if(ac.acctId>0){$("#account").find("a:eq(1)").show()}})}$("#acctListTab tbody").empty();$("#acctPageDiv").empty()};var I=function(){$("#acctSelect").append("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>");$("#acctSelect").find("option[value='-1']").attr("selected","selected");$("#acctName").val(OrderInfo.cust.partyName);$("#defineNewAcct").show();$("#account").find("a:gt(0)").hide();window.setTimeout("order.main.showNewAcct()",0)};var C=function(){var Z;Z={acctCd:OrderInfo.acct.acctCd,isServiceOpen:"Y"};Z.areaId=OrderInfo.getAreaId();$.callServiceAsJson(contextPath+"/token/pc/order/account",Z,{before:function(){},always:function(){},done:function(aa){if(aa.code==-2){$.alertM(aa.data);return}if(aa.code==0){var ab=aa.data;if(ab.resultCode==0){if(ab.accountInfos&&ab.accountInfos.length>0){$("#accountDiv").find("label:eq(0)").text("主卡帐户：");$.each(ab.accountInfos,function(ac,ad){$("<option>").text(ad.name+" : "+ad.accountNumber).attr("value",ad.acctId).attr("acctcd",ad.accountNumber).appendTo($("#acctSelect"));if(ac==0){$("#acctSelect").find("option[value="+ad.acctId+"]").attr("selected","selected")}});$("#acctSelect").find("option[value='-1']").remove();$("#accountDiv").find("a:eq(0)").hide();$("#acctSelect").parent().find("a:eq(1)").show();$("#defineNewAcct").hide()}else{$.alert("提示","没有查询到帐户合同号对应的帐户信息")}}else{$.alertM(ab.resultMsg)}}else{$.alertM(aa.data)}}})};var c=function(){acct.acctModify.ifCanAdjustBankPayment();acct.acctModify.getBILL_POST(function(){acct.acctModify.paymentType();acct.acctModify.billPostType()})};var v=function(){var aa=$("#acctSelect");if(!aa.val()){$.alert("提示","请选择一个帐户");return}if(aa.val()==-1){$.alert("提示","该帐户是新建帐户");return}$("#acctDialog .contract_list td").text("帐户信息");$("#acctDialog .selectList").hide();$("#acctPageDiv").hide();$("#acctListTab tbody").empty();easyDialog.open({container:"acctDialog"});var Z={acctCd:aa.find("option:selected").attr("acctcd"),isServiceOpen:"Y"};$.callServiceAsJson(contextPath+"/token/pc/order/account",Z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(ab){if(ab.code==-2){$.alertM(ab.data);return}if(ab.code==0){l(ab.data.accountInfos)}else{$("<tr><td colspan=4>"+ab.data+"</td</tr>").appendTo($("#acctListTab tbody"))}$("#acctListTab tr").off("click")}})};var u=function(){$.confirm("信息","确定回到上一步吗？",{yes:function(){OrderInfo.resetChooseUserInfo();var ab=OrderInfo.boProdAns;var aa=order.service.boProdAn;var Z=OrderInfo.boProd2Tds;if(Z.length>0){for(var ad=0;ad<Z.length;ad++){var ac={numType:2,numValue:Z[ad].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",ac,{done:function(){}})}}if(ab.length>0){for(var ad=0;ad<ab.length;ad++){if(ab[ad].idFlag!=undefined&&ab[ad].idFlag=="0"){continue}var ac={numType:1,numValue:ab[ad].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",ac)}}order.phoneNumber.resetBoProdAn();$("#order_fill_content").empty();order.prepare.showOrderTitle();$("#order_tab_panel_content").show();order.prepare.step(1)},no:function(){}},"question")};var g=function(){return{boActionTypeCd:S1,boActionTypeName:"订购",offerSpecId:1234,offerSpecName:"乐享3G-129套餐",feeType:1200,viceCardNum:3,offerNum:3,type:1,terminalInfo:{terminalName:"IPhone5",terminalCode:"46456457345"},offerRoles:[{offerRoleId:1234,offerRoleName:"主卡",memberRoleCd:"0",roleObjs:[{offerRoleId:1,objId:CONST.PROD_SPEC.CDMA,objName:"CDMA",objType:2}]},{offerRoleId:2345,offerRoleName:"副卡",memberRoleCd:"1"}]}};var O=function(aa){var Z=X();$("#"+aa).val(Z)};var X=function(){var ad="";var ac="";var ab="";var aa=0;for(var Z=0;Z<6;Z++){do{if(ad.length>0){ac=ad.substring(ad.length-1,ad.length)}aa=parseInt(Math.random()*9+1);ab=""+aa;if(ad.length==5){if(f(ad+ab)){continue}}}while(ac==ab);ad=ad+ab}if(ad.length!=6){return null}return ad};var f=function(ac){var Z=0;if(ac&&ac.length==6){for(var aa=0;aa<5;aa++){var ad=parseInt(ac.substring(aa,aa+1));var ab=parseInt(ac.substring(aa+1,aa+2));Z=Z+(ad-ab)}if(Z==5||Z==-5){return true}else{return false}}else{return false}};var t=function(ab,Z){var aa=$("#"+ab).val();return S(aa,Z)};var S=function(ad,aa){var ac="<div style='text-indent:0px;'>密码设置规则：<br/>1、密码必须为六位全数字；<br/>2、密码不能与接入号中的信息重复；<br/>3、密码不能包含连续相同的数字；<br/>4、密码不能是连续的六位数字。</div>";var ab=new RegExp("^([0-9]{6})$");if(ad==null){$.alertMore("提示","","密码不可为空！",ac,"");return false}else{if(!ab.test(ad)){$.alertMore("提示","","密码包含非数字或长度不是6位",ac,"");return false}}if(aa!=null&&aa.indexOf(ad)>=0){$.alertMore("提示","","密码不能与接入号中的信息重复，请修改！",ac,"");return false}for(var Z=0;Z<5;Z++){lastOneS=ad.substring(Z,Z+1);thisOneS=ad.substring(Z+1,Z+2);if(lastOneS==thisOneS){$.alertMore("提示","","密码中包含连续相同数字，请修改！",ac,"");return false}}if(f(ad)){$.alertMore("提示","","密码不可是连续6位数字，请修改！",ac,"");return false}return true};var b=function(ac,ab){var aa=$(ac).val();if(aa==CONST.PAY_TYPE.BEFORE_PAY){if((OrderInfo.actionFlag==1||OrderInfo.actionFlag==3||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14)&&CacheData.getServSpec(-1,381000960)!=null){var Z=CacheData.getServSpec(-1,381000960);if(Z.isdel==undefined||Z.isdel!="Y"){$.confirm("信息确认","您已选择开通【翼支付交费助手】功能产品，如果修改付费类型为预付费，其属性将赋为默认值！",{yesdo:function(){for(var ad=0;ad<Z.prodSpecParams.length;ad++){var ae=Z.prodSpecParams[ad];ae.setValue=ae.value
}},no:function(){$(ac).find("option[value='1200']").attr("selected",true);$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+ab).val("20").removeAttr("disabled")}})}}$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+ab).val("20").attr("disabled","disabled")}else{if((OrderInfo.actionFlag==1||OrderInfo.actionFlag==3||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14)&&CacheData.getServSpec(-1,381000960)!=null){var Z=CacheData.getServSpec(-1,381000960);if(Z.isdel==undefined||Z.isdel!="Y"){$.confirm("信息确认","您已选择开通【翼支付交费助手】功能产品，如果修改付费类型为后付费，将置空其选择属性，且属性不再可选！！",{yesdo:function(){for(var ad=0;ad<Z.prodSpecParams.length;ad++){var ae=Z.prodSpecParams[ad];ae.setValue=""}},no:function(){$(ac).find("option[value='2100']").attr("selected",true);$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+ab).val("20").attr("disabled","disabled")}})}}$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+ab).val("20").removeAttr("disabled")}};var n=function(){if(order.memberChange.reloadFlag=="N"){var Z=order.memberChange.rejson.orderList.custOrderList[0].busiOrder;$.each(Z,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){var aa=this;var ad=false;$.each(AttachOffer.openList,function(){if(this.prodId==aa.data.ooRoles[0].prodId){$.each(this.specList,function(){if(this.offerSpecId==aa.busiObj.objId){ad=true;return false}})}});if(!ad){AttachOffer.addOpenList(aa.data.ooRoles[0].prodId,aa.busiObj.objId);if(aa.data.ooParams!=undefined){if(aa.data.ooParams.length>0){var al=aa.data.ooParams[0];var ag=CacheData.getOfferSpec(al.offerParamId,al.offerSpecParamId);if(!!ag.offerSpecParams){for(var aq=0;aq<ag.offerSpecParams.length;aq++){var af=ag.offerSpecParams[aq];var ab=CacheData.getSpecParam(al.offerParamId,al.offerSpecParamId,af.itemSpecId);if(ab.itemSpecId==CONST.ITEM_SPEC.PROT_NUMBER){ab.setValue=$("#select1").val()}else{ab.setValue=al.value}}}if(ag.offerRoles!=undefined&&ag.offerRoles.length>0){for(var aq=0;aq<ag.offerRoles.length;aq++){var an=ag.offerRoles[aq];for(var ap=0;ap<an.roleObjs.length;ap++){var ae=an.roleObjs[ap];if(!!ae.prodSpecParams){for(var ao=0;ao<ae.prodSpecParams.length;ao++){var ai=ae.prodSpecParams[ao];var ar=CacheData.getProdSpecParam(al.offerParamId,al.offerSpecParamId,ai.itemSpecId);ar.value=al.value}}}}}$("#can_"+al.offerParamId+"_"+al.offerSpecParamId).removeClass("canshu").addClass("canshu2");var aj=CacheData.getOfferSpec(al.offerParamId,al.offerSpecParamId);aj.isset="Y"}}if(aa.data.bo2Coupons!=undefined){var ak=aa.data.bo2Coupons[0];$("#terminalText_"+ak.prodId+"_"+ak.attachSepcId+"_"+ak.num).val(ak.couponInstanceNumber);var ah={couponUsageTypeCd:ak.couponUsageTypeCd,inOutTypeId:ak.inOutTypeId,inOutReasonId:ak.inOutReasonId,saleId:ak.saleId,couponId:ak.couponId,couponinfoStatusCd:ak.couponinfoStatusCd,chargeItemCd:ak.chargeItemCd,couponNum:ak.couponNum,storeId:ak.storeId,storeName:ak.storeName,agentId:ak.agentId,apCharge:ak.apCharge,couponInstanceNumber:ak.couponInstanceNumber,ruleId:ak.ruleId,partyId:ak.partyId,prodId:ak.prodId,offerId:ak.offerId,attachSepcId:ak.attachSepcId,state:ak.state,relaSeq:ak.relaSeq,num:ak.num};OrderInfo.attach2Coupons.push(ah)}}}else{if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S2"&&this.busiObj.offerTypeCd=="2"){var aa=this;var ac="";$.each(order.memberChange.oldmembers.objInstId,function(){if(this.instId==aa.busiObj.instId){ac=this.objInstId;return false}});AttachOffer.delOffer(ac,this.busiObj.instId,"reload")}else{if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(this.data.boServs[0].state=="ADD"){var aa=this;var ad=false;$.each(AttachOffer.openServList,function(){if(this.prodId==aa.data.boServOrders[0].servId){$.each(this.servSpecList,function(){if(this.servSpecId==aa.data.boServOrders[0].servSpecId){ad=true;return false}})}});if(!ad){var am="N";if(aa.data.boServItems!=undefined){am="Y"}U(this.busiObj.instId,aa.data.boServOrders[0].servSpecId,aa.data.boServOrders[0].servSpecName,am);if(am=="Y"){var ag=CacheData.getServSpec(this.busiObj.instId,aa.data.boServOrders[0].servSpecId);if(!!ag.prodSpecParams){for(var aq=0;aq<ag.prodSpecParams.length;aq++){var af=ag.prodSpecParams[aq];var ab=CacheData.getServSpecParam(this.busiObj.instId,aa.data.boServOrders[0].servSpecId,af.itemSpecId);$.each(aa.data.boServItems,function(){if(ab.itemSpecId==this.itemSpecId){ab.setValue=this.value}})}}$("#can_"+this.busiObj.instId+"_"+aa.data.boServOrders[0].servSpecId,af.itemSpecId).removeClass("canshu").addClass("canshu2");var aj=CacheData.getServSpec(this.busiObj.instId,aa.data.boServOrders[0].servSpecId,af.itemSpecId);aj.isset="Y"}}}else{if(this.data.boServs[0].state=="DEL"){AttachOffer.closeServ(this.busiObj.instId,this.data.boServOrders[0].servId,"reload")}}}}}});$.each(AttachOffer.openList,function(){var aa=this;$.each(this.specList,function(){var ac=this;var ab=false;$.each(Z,function(){if(this.boActionType.actionClassCd=="1200"&&this.boActionType.boActionTypeCd=="S1"&&this.busiObj.offerTypeCd=="2"){if(this.busiObj.objId==ac.offerSpecId){ab=true;return false}}});if(!ab){AttachOffer.delOfferSpec(aa.prodId,this.offerSpecId,"reload")}})});$.each(AttachOffer.openServList,function(){var aa=this;$.each(this.servSpecList,function(){var ac=this;var ab=false;$.each(Z,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="7"){if(ac.servSpecId==this.data.boServOrders[0].servSpecId&&aa.prodId==this.busiObj.instId){ab=true;return false}}});if(!ab){var ad=$("#li_"+aa.prodId+"_"+this.servSpecId).find("span");var ae=CacheData.getServSpec(aa.prodId,this.servSpecId);if(ae==undefined){return}ad.addClass("del");ae.isdel="Y";AttachOffer.showHideUim(1,aa.prodId,this.servSpecId);var af=CacheData.getServBySpecId(aa.prodId,this.servSpecId);if(ec.util.isObj(af)){ad.addClass("del");af.isdel="Y"}}})});$.each(Z,function(){if(this.boActionType.actionClassCd=="1300"&&this.boActionType.boActionTypeCd=="14"){var aa=this.busiObj.instId;$("#uim_check_btn_"+aa).attr("disabled",true);$("#uim_check_btn_"+aa).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+aa).attr("disabled",false);$("#uim_release_btn_"+aa).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+aa).attr("disabled",true);$.each(this.data.bo2Coupons,function(){if(this.state=="ADD"){$("#uim_txt_"+aa).val(this.terminalCode);var ab={couponUsageTypeCd:this.couponUsageTypeCd,cardTypeFlag:this.cardTypeFlag,inOutTypeId:this.inOutTypeId,inOutReasonId:this.inOutReasonId,saleId:this.saleId,couponId:this.couponId,couponinfoStatusCd:this.couponinfoStatusCd,chargeItemCd:this.chargeItemCd,couponNum:this.couponNum,storeId:this.storeId,storeName:this.storeName,agentId:this.agentId,apCharge:this.apCharge,couponInstanceNumber:this.couponInstanceNumber,terminalCode:this.terminalCode,ruleId:this.ruleId,partyId:this.partyId,prodId:this.prodId,offerId:this.offerId,state:this.state,relaSeq:this.relaSeq};OrderInfo.clearProdUim(aa);OrderInfo.boProd2Tds.push(ab)}})}})}};var W=function(Z){B($("#queryType").val(),Z,$("#id").val())};function B(aa,Z,ac){var ab={custId:"",curPage:Z,pageSize:10,acctNbr:$("#accessNbr").val(),areaId:OrderInfo.getAreaId(),lanId:OrderInfo.getAreaId(),extCustId:"",BIZID:$("#BIZID").val(),areaNbr:"",prodClass:"12",queryTypeTmp:aa,objInstId:ac};$.callServiceAsHtml(contextPath+"/offer/getGroupList",ab,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(ad){if(ad.code==-2){$.alertM(ad.data);return}$("#div_staff_dialog").html(ad.data);$("#group_list_body tr").each(function(){$(this).off("click").on("click",function(ae){w("#group_list_body tr",this);ae.stopPropagation()})});easyDialog.open({container:"div_staff_dialog"})}})}var K=function(aa){var Z=$("#group_list_body .plan_select");Z.each(function(){$("#"+aa).val($(this).attr("accessNumber"))});if(Z.length>0){easyDialog.close()}else{$.alert("操作提示","请选择群！")}};function F(){var Z={dealerId:"",areaId:OrderInfo.staff.soAreaId.substring(0,3)+"0000",currentAreaAllName:"",staffName:"",staffCode:OrderInfo.provinceInfo.salesCode,salesCode:"",pageIndex:1,objInstId:"",pageSize:10};
$.callServiceAsJson(contextPath+"/token/pc/cust/getDealerList",Z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(aa){if(aa.code==0){var ad=aa.data;var ab=ad[0].staffName;var ac=ad[0].staffId;$("#dealerTbody").find("tr").each(function(){var af=$(this).children("td").eq(3).children("input");var ae=af.attr("id");$("#"+ae).attr("value",ab);$("#"+ae).attr("staffid",ac);return false})}else{$.alertM(aa.data)}}})}return{buildMainView:o,copyOrder:N,spec_parm:s,check_parm:k,queryStaff:L,queryStaffPage:q,setStaff:T,chooseAcct:J,check_parm_self:x,createAcct:I,createAcctWithId:C,showNewAcct:c,acctDetail:v,spec_parm_change_save:M,paymethodChange:a,templateTypeCheck:Y,lastStep:u,genRandPass6:X,genRandPass6Input:O,passwordCheckInput:t,passwordCheckVal:S,checkIncreace6:f,feeTypeCascadeChange:b,isChangeUim:E,loadAttachOffer:R,queryGroupPage:W,queryGroup:B,setGroup:K,getOfferMember:m,toChooseUser:Q,showChooseUserDialog:V,reload:n,initAcct:j,queryDealer:F}})();CommonUtils.regNamespace("order","prodModify");order.prodModify=(function(){var boActionTypeCd="";var authFlag="";var _coupon="";var lteFlag=(CONST.getAppDesc()==0)?true:false;var _ischooseOffer=false;var _choosedProdInfo={};var _profiles=[];var _profileTabLists=[];var _getChooseProdInfo=function(){var prodInfoTr=$("#phoneNumListtbody tr[class='plan_select']").find("td:eq(0)");if(prodInfoTr.attr("accNbr")==undefined){prodInfoTr=$("#phoneNumListtbody tr[class='bg plan_select']").find("td:eq(0)")}var prodInfoChildTr=$("#subphoneNumListtbody tr[class='plan_select2']").find("td:eq(0)");_choosedProdInfo={accNbr:prodInfoTr.attr("accNbr"),productName:prodInfoTr.attr("productName"),prodStateName:prodInfoTr.attr("prodStateName"),feeTypeName:prodInfoTr.attr("feeTypeName"),prodInstId:prodInfoTr.attr("prodInstId"),extProdInstId:prodInfoTr.attr("extProdInstId"),corProdInstId:prodInfoTr.attr("corProdInstId"),prodStateCd:prodInfoTr.attr("prodStateCd"),productId:prodInfoTr.attr("productId"),feeType:prodInfoTr.attr("feeType"),prodClass:$(prodInfoTr).attr("prodClass"),stopRecordCd:prodInfoTr.attr("stopRecordCd"),stopRecordName:prodInfoTr.attr("stopRecordName"),prodOfferName:prodInfoChildTr.attr("prodOfferName"),custName:prodInfoChildTr.attr("custName"),startDt:prodInfoChildTr.attr("startDt"),endDt:prodInfoChildTr.attr("endDt"),prodOfferId:prodInfoChildTr.attr("prodOfferId"),prodOfferInstId:prodInfoChildTr.attr("prodOfferInstId"),custId:prodInfoChildTr.attr("custId"),is3G:prodInfoChildTr.attr("is3G"),areaCode:prodInfoTr.attr("zoneNumber"),areaId:prodInfoTr.attr("areaId")};order.prodModify.choosedProdInfo=_choosedProdInfo};var _getCallRuleParam=function(boActionTypeCd,prodId){return{areaId:OrderInfo.staff.areaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,custFlag:OrderInfo.cust.custFlag,boInfos:[{boActionTypeCd:boActionTypeCd,instId:prodId,specId:CONST.PROD_SPEC.CDMA,prodId:prodId}]}};var _updateCheckByChange=function(actionClassCd,boActionTypeCd,prodStatusCd,toprodStatusCd){var data={orderList:{orderListInfo:{isTemplateOrder:"N",templateType:"1",staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,areaId:OrderInfo.staff.areaId,partyId:_choosedProdInfo.custId,olTypeCd:CONST.OL_TYPE_CD.UI_LTE},custOrderList:[{busiOrder:[]}]}};data.orderList.custOrderList[0].busiOrder=[{areaId:OrderInfo.staff.areaId,boActionType:{actionClassCd:actionClassCd,boActionTypeCd:boActionTypeCd},busiObj:{accessNumber:_choosedProdInfo.accNbr,instId:_choosedProdInfo.prodInstId,isComp:"N",objId:CONST.PROD_SPEC.CDMA,offerTypeCd:"1"},busiOrderInfo:{seq:OrderInfo.SEQ.seq},data:{boProdStatuses:[{atomActionId:OrderInfo.SEQ.atomActionSeq--,prodStatusCd:prodStatusCd,state:"DEL"},{atomActionId:OrderInfo.SEQ.atomActionSeq--,prodStatusCd:toprodStatusCd,state:"ADD"}]}}];params=JSON.stringify(data);var url=contextPath+"/token/pc/order/prodModify/updateCheckByChange";var response=$.callServiceAsJson(url,params,{});var msg="";if(response.code==0){return true}else{if(response.code==-2){$.alertM(response.data);return false}else{if(response.data.resultMsg){$.alert("提示","预校验失败!失败原因为："+response.data.resultMsg)}else{$.alert("提示","预校验失败! 集团营业后台未给出原因。")}}}};var _remark_prodPass=function(){var params={tableName:"SYSTEM",columnName:"REMARK_PRODPASS"};var url=contextPath+"/order/prodModify/queryProdPwdConfig";if(OrderInfo.password_remark==""){var response=$.callServiceAsJson(url,params,{});var msg="";if(response.code==0){OrderInfo.password_remark=response.data}else{if(response.code==-2){$.alertM(response.data);OrderInfo.password_remark="0";return false}else{OrderInfo.password_remark="0";return false}}}};var _showChangeCard=function(){if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){$.alert("提示","停机产品不允许受理！");return}OrderInfo.busitypeflag=13;prod.changeUim.init()};var _showAddComp=function(){var compspecparam={productId:_choosedProdInfo.productId};if(getCompInfo(compspecparam)==""){return}var param={areaId:OrderInfo.staff.areaId,custId:OrderInfo.cust.custId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,boInfos:[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP,instId:_choosedProdInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA}]};var callParam={prodInstId:_choosedProdInfo.prodInstId,productId:_choosedProdInfo.productId};var checkRule=rule.rule.prepare(param,"order.prodModify.addComp",callParam)};var _showRemoveComp=function(){var compspecparam={productId:_choosedProdInfo.productId};if(getCompInfo(compspecparam)==""){return}var param={areaId:OrderInfo.staff.areaId,custId:OrderInfo.cust.custId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,boInfos:[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP,instId:_choosedProdInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA}]};var callParam={prodInstId:_choosedProdInfo.prodInstId,productId:_choosedProdInfo.productId};var checkRule=rule.rule.prepare(param,"order.prodModify.removeComp",callParam)};var _queryOfferSpec=function(){var offerSpecId=_choosedProdInfo.prodOfferId;var offerId=_choosedProdInfo.prodOfferInstId;_offerProd.offerId=offerId;_offerProd.offerSpecId=offerSpecId;if(offerSpecId==undefined||offerSpecId==""){return{}}else{var param={offerSpecId:offerSpecId};var response=$.callServiceAsJson(contextPath+"/order/queryOfferSpec",param);if(response.code==0){if(response.data){_offerSpec=response.data.offerSpec}}}return _offerSpec};var _showLossRepProd=function(){OrderInfo.busitypeflag=5;var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.LOSSREP_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showLossRepProdReg=function(){OrderInfo.busitypeflag=5;var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISLOSSREP_PROD;var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};
OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showStopKeepNumProd=function(){OrderInfo.busitypeflag=6;var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.STOPKEEPNUM;inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showStopKeepNumProdReg=function(){OrderInfo.busitypeflag=6;var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISSTOPKEEPNUM;inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showCustInfoModify=function(){if("-1"==OrderInfo.cust.custId){$("#cCustName").val(OrderInfo.boCustInfos.name);$("#cCustIdCard").val(OrderInfo.boCustIdentities.identityNum);$("#partyTypeCd option[value='"+OrderInfo.boCustInfos.partyTypeCd+"']").attr("selected",true);$("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']").attr("selected",true);$("#cAddressStr").val(OrderInfo.boCustInfos.addressStr);order.cust.identidiesTypeCdChoose($("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']"),"ccCustIdCard");tabProfileFlag="1";$("#contactAddress").val(OrderInfo.boPartyContactInfo.contactAddress);$("#contactDesc").val(OrderInfo.boPartyContactInfo.contactDesc);$("#contactEmployer").val(OrderInfo.boPartyContactInfo.contactEmployer);$("#contactGender option[value='"+OrderInfo.boPartyContactInfo.contactGender+"']").attr("selected",true);$("#contactName").val(OrderInfo.boPartyContactInfo.contactName);$("#contactType option[value='"+OrderInfo.boPartyContactInfo.contactType+"']").attr("selected",true);$("#eMail").val(OrderInfo.boPartyContactInfo.eMail);$("#fax").val(OrderInfo.boPartyContactInfo.fax);$("#headFlag option[value='"+OrderInfo.boPartyContactInfo.headFlag+"']").attr("selected",true);$("#homePhone").val(OrderInfo.boPartyContactInfo.homePhone);$("#mobilePhone").val(OrderInfo.boPartyContactInfo.mobilePhone);$("#officePhone").val(OrderInfo.boPartyContactInfo.officePhone);$("#postAddress").val(OrderInfo.boPartyContactInfo.postAddress);$("#postcode").val(OrderInfo.boPartyContactInfo.postcode);easyDialog.open({container:"user_add"})}else{var submitState="";var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.CUSTINFOMODIFY;submitState="ADD";var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:"",prodOfferName:"",state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,4,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.custInfoModify",callParam);if(checkRule){return}}};var _showActiveReturn=function(){if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){$.alert("提示","停机产品不允许受理！");return}OrderInfo.busitypeflag=12;var submitState="";var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACTIVERETURN;submitState="ADD";var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:"",prodOfferName:"",state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,9,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.custInfoModify",callParam);if(checkRule){return}};var _showAcctInfoModify=function(){var submitState="";var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACCTINFOMODIFY;submitState="ADD";var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:"",prodOfferName:"",state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.ACCT_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.acctInfoModify",callParam);if(checkRule){return}};var _form_custInfomodify_btn=function(){$("#custModifyForm").off("formIsValid").on("formIsValid",function(event){var modifyCustInfo={};modifyCustInfo={custName:$.trim($("#cmCustName").val()),identidiesTypeCd:$("#div_cm_identidiesType  option:selected").val(),custIdCard:$.trim($("#cmCustIdCard").val()),addressStr:$.trim($("#cmAddressStr").val())};var data={};data.boCustInfos=[{areaId:OrderInfo.cust.areaId,name:$("#boCustIdentities").attr("partyName"),norTaxPayerId:"0",partyTypeCd:$("#boCustIdentities").attr("partyTypeCd"),addressStr:$("#boCustIdentities").attr("addressStr"),state:"DEL"},{areaId:OrderInfo.cust.areaId,name:modifyCustInfo.custName,norTaxPayerId:"0",partyTypeCd:$("#cmPartyTypeCd  option:selected").val(),addressStr:modifyCustInfo.addressStr,state:"ADD"}];if(OrderInfo.cust.idCardNumber==""||OrderInfo.cust.idCardNumber==null){data.boCustIdentities=[{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD"}]}else{data.boCustIdentities=[{identidiesTypeCd:OrderInfo.cust.identityCd,identityNum:OrderInfo.cust.idCardNumber,isDefault:"Y",state:"DEL"},{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD"}]}data.boCustProfiles=[];for(var i=0;i<order.prodModify.profiles.length;i++){var profilesObj=order.prodModify.profiles[i];var profilesDel={};var profilesAdd={};profilesDel={partyProfileCatgCd:profilesObj.attrId,profileValue:profilesObj.defaultValue,state:"DEL"};profilesAdd={partyProfileCatgCd:profilesObj.attrId,profileValue:$.trim($("#profiles_"+profilesObj.attrId).val()),state:"ADD"};if(document.getElementById("profiles_"+profilesObj.attrId)&&profilesObj.profileValue!=$.trim($("#profiles_"+profilesObj.attrId).val())){data.boCustProfiles.push(profilesDel);data.boCustProfiles.push(profilesAdd)}}data.boPartyContactInfo=[];var _boPartyContactInfoOld={contactId:$("#modTabProfile0").attr("contactId"),statusCd:"100001",contactName:$("#modTabProfile0").attr("contactName"),headFlag:$("#modTabProfile0").attr("headFlag"),state:"DEL"};var _boPartyContactInfo={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$.trim($("#headFlag  option:selected").val()),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postCode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};
if($("#modTabProfile0").attr("click")=="0"){if(_boPartyContactInfoOld.contactId!=""){data.boPartyContactInfo.push(_boPartyContactInfoOld);data.boPartyContactInfo.push(_boPartyContactInfo)}else{data.boPartyContactInfo.push(_boPartyContactInfo)}}SoOrder.submitOrder(data)}).ketchup({bindElement:"custInfoModifyBtn"})};var _partyTypeCdChoose=function(scope){var partyTypeCd=$(scope).val();$("#cm_identidiesTypeCd").empty();_certTypeByPartyType(partyTypeCd);_identidiesTypeCdChoose($("#div_cm_identidiesType").children(":first-child"))};var _partyType=function(partyTypeCd){if(partyTypeCd==1){var identidiesTypeCdHtml='<select id="cmIdentidiesTypeCd" onchange="order.prodModify.identidiesTypeCdChoose(this)"><option value="1" >身份证</option><option value="2">军官证</option></select>'}else{if(partyTypeCd==2){var identidiesTypeCdHtml='<select id="cmIdentidiesTypeCd" onchange="order.prodModify.identidiesTypeCdChoose(this)"><option value="3">护照</option><option value="23">ICP经营许可证</option><option value="39">税务登记号</option></select>'}}$("#div_cm_identidiesType").html(identidiesTypeCdHtml)};var _certTypeByPartyType=function(_partyTypeCd){var params={partyTypeCd:_partyTypeCd};var url=contextPath+"/cust/queryCertType";var response=$.callServiceAsJson(url,params,{});if(response.code==-2){$.alertM(response.data)}if(response.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(response.code==0){var data=response.data;if(data!=undefined&&data.length>0){for(var i=0;i<data.length;i++){var certTypedate=data[i];$("#cm_identidiesTypeCd").append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>")}}}};var _identidiesTypeCdChoose=function(scope){var identidiesTypeCd=$(scope).val();if(identidiesTypeCd==undefined){identidiesTypeCd=$("#div_cm_identidiesType  option:selected").val()}if(identidiesTypeCd==1){$("#cmCustIdCard").attr("placeHolder","请输入合法身份证号码");$("#cmCustIdCard").attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(identidiesTypeCd==2){$("#cmCustIdCard").attr("placeHolder","请输入合法军官证");$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(identidiesTypeCd==3){$("#cmCustIdCard").attr("placeHolder","请输入合法护照");$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#cmCustIdCard").attr("placeHolder","请输入合法证件号码");$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}_form_custInfomodify_btn()};var _custInfoModify=function(callParam){var param={};param.partyName=OrderInfo.cust.partyName;param.custId=OrderInfo.cust.custId;param.idCardNumber=OrderInfo.cust.idCardNumber;param.boActionTypeName=callParam.boActionTypeName;param.areaId=OrderInfo.getAreaId();$.callServiceAsHtml(contextPath+"/order/prodModify/custInfoModify",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(response){if(response.code==-2){$.alertM(response.data);return}if(response.data.indexOf("false")>=0){$.alert("提示","抱歉，查询无返回客户详情信息。");return}var content$=$("#order_fill_content");content$.html(response.data).show();_partyTypeCdChoose($("#cmPartyTypeCd  option:selected"));$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected",true);_identidiesTypeCdChoose($("#cm_identidiesTypeCd option[selected='selected']"));$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();$("#step1").show();$(".ordercon a:first span").text("取 消");_form_custInfomodify_btn()},always:function(){$.unecOverlay()}})};var _lossRepProd=function(callParam){param=_choosedProdInfo;$.extend(param,callParam);$.callServiceAsHtml(contextPath+"/order/prodModify/lossRepProd",param,{before:function(){},done:function(response){var content$=$("#order_prepare");content$.html(response.data).show();$(".ordercon").show();$(".ordertabcon").show();$("#step1").show();$("#custInfo").hide();$(".ordercon a:first span").text("取 消")},always:function(){$.unecOverlay()}});SoOrder.builder(CONST.ACTION_CLASS_CD.PROD_ACTION,param.boActionTypeCd)};var _lossRepProdSubmit=function(param){var data={};data.orderRemark=$.trim($("#order_remark").val());data.boProdStatuses=[{prodStatusCd:8,state:submitState}];SoOrder.submitOrder(data)};var _closeDialog=function(){if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){order.prodModify.dialogForm.close(order.prodModify.dialog)}};var _removeCommit=function(prodStatusCd,boActionType,templateType){var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=prodStatusCd;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:boActionType,boActionTypeName:CONST.getBoActionTypeName(boActionType),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD"};OrderInfo.order.templateType=templateType;var v_actionFlag=0;if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK||boActionType==CONST.BO_ACTION_TYPE.BUY_BACK_CHANGE_CARD||boActionType==CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){v_actionFlag=19}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _showMemberWin=function(){if(OrderInfo.busitypeflag==7||OrderInfo.busitypeflag==8||OrderInfo.busitypeflag==9||OrderInfo.busitypeflag==10||OrderInfo.busitypeflag==11){return false}_ischooseOffer=false;var viceCount=0;var offerMemberInfos=OrderInfo.offer.offerMemberInfos;$.each($("#delPhoneNumber ul:last li"),function(i,li){$(this).remove()});$.each(offerMemberInfos,function(i,offerMember){if(offerMember.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD&&_choosedProdInfo.accNbr==offerMember.accessNumber){viceCount=0;return false}if(offerMember.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&offerMember.objType==CONST.OBJ_TYPE.PROD){$("#delPhoneNumber ul:first h5").text(offerMember.roleName);$("#delPhoneNumber ul:first li").text(offerMember.accessNumber)}else{if(offerMember.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD&&offerMember.objType==CONST.OBJ_TYPE.PROD){if(offerMember.accessNumber){$("#delPhoneNumber ul:last h5").text(offerMember.roleName);var li=$("<li class='full'>").text(offerMember.accessNumber).appendTo($("#delPhoneNumber ul:last"));var objId=offerMember.objId;var objInstId=offerMember.objInstId;var objType=offerMember.objType;var offerMemberId=offerMember.offerMemberId;var offerRoleId=offerMember.offerRoleId;var accessNumber=offerMember.accessNumber;li.attr("del","Y").attr("accessNumber",accessNumber).attr("objId",objId).attr("objInstId",objInstId).attr("objType",objType).attr("offerMemberId",offerMemberId).attr("offerRoleId",offerRoleId);$("<span  id='viceCard_"+offerMember.accessNumber+"'></span>").appendTo(li);var eleI=$("<i id='plan_no'><a id='' class='purchase' href='javascript:void(0)'>保留>>选择新套餐</a></i>").appendTo(li);eleI.click(function(){order.service.offerDialog("viceCard_"+offerMember.accessNumber)})}}}viceCount++});if(viceCount>1){return true}else{return false}};var _chooseOfferForMember=function(specId,subpage,specName,offerRoleId){OrderInfo.newofferSpecName=specName;$("#"+subpage).html("&nbsp;&nbsp;<span style='color: #327501;'>订购新套餐：</span>"+specName);$("#"+subpage).parent().attr("addSpecId",specId).attr("addRoleId",offerRoleId).attr("del","N").attr("addSpecName",specName);_ischooseOffer=true;if(document.getElementById("li_"+subpage)){$("#li_"+subpage).css("text-decoration","").attr("del","N").attr("knew","Y");$("#li_"+subpage).find("i:first-child").find("a").text("拆副卡")}};var _removeAndAdd=function(prodStatusCd,boActionType,templateType){var viceparam=[];$.each($("#delPhoneNumber ul:last li"),function(i,li){viceparam.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerRoleId:$(this).attr("addRoleId"),offerSpecId:$(this).attr("addSpecId"),offerMemberId:$(this).attr("offerMemberId"),accessNumber:$(this).attr("accessNumber"),del:$(this).attr("del")})
});var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=prodStatusCd;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);var submitFlag=(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK?"buyBack":"removeAndRetainVice");var callParam={boActionTypeCd:boActionType,boActionTypeName:CONST.getBoActionTypeName(boActionType),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD",submitFlag:submitFlag,viceParam:viceparam};OrderInfo.order.templateType=templateType;var v_actionFlag=0;if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){v_actionFlag=20}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _commonShowDialog=function(){$("#delPhoneNumber .btna_o:last").click(function(){_closeDialog()});ec.form.dialog.createDialog({id:"-delephone",width:480,height:400,initCallBack:function(dialogForm,dialog){order.prodModify.dialogForm=dialogForm;order.prodModify.dialog=dialog},submitCallBack:function(dialogForm,dialog){}})};var _showOweRemoveProd=function(){OrderInfo.busitypeflag=11;var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8)}};var _showRemoveProd=function(){OrderInfo.busitypeflag=8;var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.REMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.REMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1)}};var _showOrderRemoveProd=function(){OrderInfo.busitypeflag=7;var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.PREMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1)}};var _showCoverOrderRemoveProd=function(){OrderInfo.busitypeflag=0;var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD"};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),"");var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _showBreakRuleRemoveProd=function(){OrderInfo.busitypeflag=9;var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1)}};var _showNoActiveRemoveProd=function(){OrderInfo.busitypeflag=10;var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD;var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD"};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),"");var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _commonPrepare=function(param){$.callServiceAsHtml(contextPath+"/order/prodModifyCommon",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#ordercon").show();$("#ordertabcon").show();order.prepare.step(1);OrderInfo.order.step=1;$("#orderedprod").hide();$("#order_prepare").hide();$(".ordercon a:first span").text("取 消");$(".main_body").css("height","150px");$(".main_body").css("min-height","150px");$("#order_confirm").empty();$("#fillLastStep").click(function(){order.prodModify.cancel()});if(lteFlag){_remark_prodPass();if(OrderInfo.password_remark!=null){if((OrderInfo.password_remark).indexOf("'"+OrderInfo.boActionTypeCd+"'")>=0){$("#orderPassRemarkDiv").show()}}}$("#fillNextStep").unbind("click").bind("click",function(){if(param.submitFlag=="removeAndRetainVice"){_commitRetainVice(param)}else{if(param.submitFlag=="buyBack"){_commitBuyBack(param)}else{if(param.submitFlag=="removeProd"){order.memberChange.removeAndAdd(param)}else{_commonSubmit(param.boActionTypeCd,param.prodStatusCd,param.toprodStatusCd,param.itemSpecId,param.state)}}}OrderInfo.order.step=2});$("#templateOrderDiv").hide();if(param.boActionTypeCd==CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD){$("#templateOrderDiv").show()}},always:function(){$.unecOverlay()}})};var _commitRetainVice=function(param){OrderInfo.actionFlag=7;SoOrder.submitOrder(param.viceParam)};var _commitBuyBack=function(param){OrderInfo.actionFlag=20;var params={viceParam:param.viceParam,remark:$("#order_remark").val()};SoOrder.submitOrder(params)};var _commonSubmit=function(boActionTypeCd,prodStatusCd,toprodStatusCd,itemSpecId,state){if(lteFlag){if((OrderInfo.password_remark).indexOf("'"+OrderInfo.boActionTypeCd+"'")>=0){if(!_prodPassRemark()){return}}}OrderInfo.actionClassCd=CONST.ACTION_CLASS_CD.PROD_ACTION;OrderInfo.boActionTypeCd=boActionTypeCd;if(_isNullParam(prodStatusCd)){prodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD
}if(_isNullParam(toprodStatusCd)){toprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD}var data={};if(!_isNullParam(prodStatusCd)){if(boActionTypeCd!=null&&boActionTypeCd!=""){if(boActionTypeCd!=CONST.BO_ACTION_TYPE.BUY_BACK_CHANGE_CARD&&boActionTypeCd!=CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){data.boProdStatuses=[{prodStatusCd:prodStatusCd,state:"DEL"},{prodStatusCd:toprodStatusCd,state:"ADD"}]}if(boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){data.ooRoles=[{objId:OrderInfo.offer.offerMemberInfos[0].objId,objInstId:OrderInfo.offer.offerMemberInfos[0].objInstId,objType:OrderInfo.offer.offerMemberInfos[0].objType,offerRoleId:OrderInfo.offer.offerMemberInfos[0].offerRoleId,state:"DEL",roleName:OrderInfo.offer.offerMemberInfos[0].roleName}]}}else{data.boProdStatuses=[{prodStatusCd:prodStatusCd,state:"DEL"},{prodStatusCd:toprodStatusCd,state:"ADD"}]}}if(!_isNullParam(itemSpecId)){data.busiOrderAttrs=[{itemSpecId:itemSpecId,value:$.trim($("textarea[id^=order_remark]").val())}]}SoOrder.submitOrder(data)};var _prodPassRemark=function(){var param={};param.prodPwd=$.trim($("#remark_password").val());if(param.prodPwd==""){$.alert("提示","抱歉，您输入的密码不能为空，请重新输入!");return false}param.accessNumber=order.prodModify.choosedProdInfo.accNbr;param.areaId=order.prodModify.choosedProdInfo.areaId;var url=contextPath+"/order/prodModify/prodAuth";var response=$.callServiceAsJson(url,param,{before:function(){$.ecOverlay("<strong>产品密码鉴权中,请稍等...</strong>")}});if(response.code!=0||response.data!="true"){$.unecOverlay();$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return false}$.unecOverlay();return true};function _gotoOrderModify(response){var content$=$("#order_fill_content");content$.html(response.data).show();$(".main_div .h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$("#ordercon").show();$("#ordertabcon").show();order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide();$(".ordercon a:first span").text("取 消");$(".main_body").css("height","150px");$(".main_body").css("min-height","150px");$("#order_confirm").empty();$("#fillLastStep").click(function(){order.prodModify.cancel()})}var _spec_parm_user_change=function(){var valid=false;if(OrderInfo.cust&&OrderInfo.cust.custId&&OrderInfo.cust.custId!="-1"){valid=OrderInfo.cust.segmentId=="1000"}if(!valid){$.alert("提示","非政企客户不能办理修改使用人业务");return}OrderInfo.busitypeflag=4;OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PARMS,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};rule.rule.prepare(param,"order.prodModify.spec_parm_user_show",callParam)};var _spec_parm_user_show=function(){var param={prodInstId:_choosedProdInfo.prodInstId,offerSpecId:_choosedProdInfo.prodOfferId,prodSpecId:_choosedProdInfo.productId,partyId:OrderInfo.cust.custId,acctNbr:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};$.callServiceAsHtmlGet(contextPath+"/order/orderSpecParamUserChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(response&&response.code==-2){return}if(response&&response.data){if(response.data==0||response.data==1){$.alert("提示","该产品无使用人产品实例属性！")}else{if(response.data==-1){$.alert("提示","产品实例属性加载异常！")}else{_gotoOrderModify(response)}}}else{$.alert("提示","产品实例属性加载异常")}}})};var _spec_parm_change=function(){OrderInfo.busitypeflag=4;OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PARMS,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};var checkRule=rule.rule.prepare(param,"order.prodModify.spec_parm_show",callParam)};var _spec_parm_show=function(){var param={prodInstId:_choosedProdInfo.prodInstId,offerSpecId:_choosedProdInfo.prodOfferId,prodSpecId:_choosedProdInfo.productId,partyId:OrderInfo.cust.custId,acctNbr:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};$.callServiceAsHtmlGet(contextPath+"/order/orderSpecParamChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(response&&response.code==-2){return}if(response&&response.data){if(response.data==0||response.data==1){$.alert("提示","该产品无产品实例属性！")}else{if(response.data==-1){$.alert("提示","产品实例属性加载异常！")}else{_gotoOrderModify(response)}}}else{$.alert("提示","产品实例属性加载异常")}}})};var _showPasswordChange=function(){OrderInfo.busitypeflag=17;OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};OrderInfo.actionFlag=31;var checkRule=rule.rule.prepare(param,"order.prodModify.spec_password_change",callParam)};var _spec_password_change=function(){var param={accNbr:_choosedProdInfo.accNbr};$.callServiceAsHtmlGet(contextPath+"/order/orderPasswordChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){_gotoOrderModify(response);$("#password_form").bind("formIsValid",_spec_password_change_check).ketchup({bindElement:"btsubmit"})}})};function _spec_password_change_check(){if("none"!=$("#li_password_old").css("display")){if(!$("#password_old").val()){$.alert("操作提示","请输入 原产品密码");return}}if(!$("#password_change1").val()){$.alert("操作提示","请输入 产品密码");return}else{if(!$("#password_change2").val()){$.alert("操作提示","请输入 确认密码");return}else{if($("#password_change1").val()!=$("#password_change2").val()){$.alert("操作提示","两次密码不一致");return}}}var reg=new RegExp("^([0-9]{6})$");if(!reg.test($("#password_change1").val())){$.alert("提示","密码包含非数字或长度不是6位！");return}var param={password_old:$("#password_old").val(),accessNumber:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};$.callServiceAsHtml(contextPath+"/order/orderPasswordCheck",param,{before:function(){$.ecOverlay("<strong>正在提交中,请稍等...</strong>")},done:function(response){if(response&&response.code==-2){return}var data=eval("("+response.data+")");if(data.successed==true||data.successed=="true"){_spec_password_change_save()}else{$.alert("密码校验失败",data.data);$.unecOverlay();return}}})}function _spec_password_change_save(){var boProdPasswords=new Array();var boProdPasswords_del={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:$("#password_old").val(),state:"DEL"};var boProdPasswords_add={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:$("#password_change1").val(),state:"ADD"};boProdPasswords.push(boProdPasswords_del);boProdPasswords.push(boProdPasswords_add);var data={boProdPasswords:boProdPasswords};OrderInfo.actionFlag=31;SoOrder.submitOrder(data)}var _showPasswordReset=function(){OrderInfo.busitypeflag=0;OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};
OrderInfo.actionFlag=32;var checkRule=rule.rule.prepare(param,"order.prodModify.spec_password_reset",callParam)};var _spec_password_reset=function(){$.callServiceAsHtmlGet(contextPath+"/order/orderPasswordReset",null,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){_gotoOrderModify(response);$("#password_form").bind("formIsValid",_spec_password_reset_save).ketchup({bindElement:"btsubmit"})}})};function _spec_password_reset_save(){var boProdPasswords=new Array();var boProdPasswords_del={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:"",state:"DEL"};var boProdPasswords_add={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:"111111",state:"ADD"};boProdPasswords.push(boProdPasswords_del);boProdPasswords.push(boProdPasswords_add);var data={boProdPasswords:boProdPasswords};OrderInfo.actionFlag=32;SoOrder.submitOrder(data)}function _shortnum_change(){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PARMS,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};OrderInfo.actionFlag=34;var checkRule=rule.rule.prepare(param,"order.prodModify.shortnum_show",callParam)}function _shortnum_show(id){var param={prodId:_choosedProdInfo.prodInstId,acctNbr:_choosedProdInfo.accNbr};$.callServiceAsHtmlGet(contextPath+"/order/orderShortnumChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(response&&response.code==-2){return}if(response&&response.data){if(response.data==0){$.alert("提示","该产品无短号信息！")}else{if(response.data==-1){$.alert("提示","加载短号信息异常！")}else{_gotoOrderModify(response)}}}else{$.alert("提示","短号加载异常")}}})}function _shortnum_change_val(obj){if($(obj).attr("checkSta")=="2"&&$(obj).val()!=$(obj).attr("changeval")){$(obj).attr("checkSta","0")}}function _shortnum_check(){var shortnum_sel=$("#shortnum_sel").val();var id=$("#ul_"+shortnum_sel).attr("t_id");var shortnum_val=$("#"+id).val();var reg=new RegExp("^[0-9]*$");if(null==shortnum_val||""==shortnum_val){$.alert("提示","请输入新的短号");return}else{if(shortnum_val==$("#"+id).attr("oldval")){$.alert("提示","短号未修改，请修改后再校验");return}else{if(!reg.test(shortnum_val)){$.alert("提示","短号只能为数字，请重新输入！");return}else{if(shortnum_val==$("#"+id).attr("changeval")){if($("#"+id).attr("checkSta")=="2"){$.alert("提示","短号已校验成功，可以使用！");return}else{if($("#"+id).attr("checkSta")=="1"){$.alert("提示","短号未通过校验，请修改再试！");return}}}}}}var param={groupNbr:$("#"+id).attr("groupNbr"),extProdId:$("#"+id).attr("extProdId"),productNbr:"",accNbr:_choosedProdInfo.accNbr,extPordInstId:$("#"+id).attr("extPordInstId"),groupShortNbr:shortnum_val,lanId:$("#"+id).attr("lanId"),checkNbr:$("#"+id).attr("changeval")};var url=contextPath+"/order/checkReleaseShortNum";$.callServiceAsJson(url,param,{before:function(){$.ecOverlay("<strong>短号校验中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(response){$("#"+id).attr("changeval",shortnum_val);if(response.code==0){$("#"+id).attr("checkSta","2");$("#uimCheck").removeClass().addClass("order_check");$.alert("提示",response.data);return}else{$("#"+id).attr("checkSta","1");$.alert("提示",response.data);$("#uimCheck").removeClass().addClass("order_check_error");return}},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！");return}})}function _shortnum_save(){var shortnum_sel=$("#shortnum_sel").val();var id=$("#ul_"+shortnum_sel).attr("t_id");var shortnum_val=$("#"+id).val();if(shortnum_val==$("#"+id).attr("oldval")){$.alert("提示","短号未修改，请修改并校验");return}else{if($("#"+id).attr("checkSta")=="0"){$.alert("提示","短号未校验，请校验后再提交！");return}else{if($("#"+id).attr("checkSta")=="1"){$.alert("提示","短号未通过校验，请修改再试！");return}}}var boProdCompItems=new Array();var boProdCompItems_row={itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"DEL",value:$("#"+id).attr("oldval")};boProdCompItems.push(boProdCompItems_row);boProdCompItems_row={itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"ADD",value:$("#"+id).val()};boProdCompItems.push(boProdCompItems_row);var boProdCompOrders_row={prodCompRelaRoleCd:$("#"+id).attr("prodCompRelaRoleCd"),compProdId:$("#"+id).attr("compProdId"),prodCompId:$("#"+id).attr("prodCompId")};var boProdCompOrders=new Array();boProdCompOrders.push(boProdCompOrders_row);var data={boProdCompItems:boProdCompItems,boProdCompOrders:boProdCompOrders};OrderInfo.actionFlag=34;SoOrder.submitOrder(data)}var _isNullParam=function(data){return data==undefined||!data};var _changeCard=function(param){$.callServiceAsHtml(contextPath+"/order/changeCard",param,{before:function(){},done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var compspecGrps="";var getCompInfo=function(compspecparam){var grprlue="";var returndata=$.callServiceAsJson(contextPath+"/order/compPspecGrps",compspecparam,{});if(returndata.code==0){if(returndata.data.length!=0){grprlue=returndata.data;compspecGrps=grprlue}return grprlue}else{if(returndata.code==-2){$.alertM(returndata.data);return""}else{$.alert("提示","该产品不是组合产品，请重新选择！");return""}}};var _addComp=function(param){OrderInfo.initData("","",12,"纳入成员");SoOrder.builder();var compparam={};$.callServiceAsHtml(contextPath+"/order/addComp",compparam,{done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();order.prepare.step(1);$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var _removeComp=function(param){OrderInfo.initData("","",12,"退出成员");SoOrder.builder();var compparam={};$.callServiceAsHtml(contextPath+"/order/removeComp",compparam,{done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$(".ordercon").show();$(".ordertabcon").show();order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var _queryRomveAcc=function(){var prodnum=$.trim($("#removeAcc").val());if(prodnum==""){$.alert("提示","请输入需要查询的接入号！");return}else{var params={compProdId:_choosedProdInfo.prodInstId,accessNumber:prodnum}}var removephones=getChoosedMenbr();if(removephones.length!=0){for(var i=0;i<removephones.length;i++){if(prodnum==removephones[i]){$.alert("提示","该号码已经在待退出成员中，请重新选择！");return}}}var url=contextPath+"/order/queryCompmenber";$.callServiceAsJson(url,params,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(response){if(response.code==0){var compProdMemberInfos=response.data;if(compProdMemberInfos.length>0){var prodmenber=compProdMemberInfos[0];var addnbrhtml="<li id='li_"+prodmenber.accessNumber+"' prodInstId='"+prodmenber.prodId+"' phonenumber='"+prodmenber.accessNumber+"' prodCompRelaRoleCd='"+prodmenber.prodCompRelaRoleCd+"' prodCompRelaRoleName='"+prodmenber.prodCompRelaRoleName+"' prodCompId='"+prodmenber.prodCompId+"'><dd class='delete' onclick='order.prodModify.removeCompDelSelect(this);'></dd><span id='addNbr'>"+prodmenber.accessNumber+"</span>";
$("#choosed_menbers").append(addnbrhtml)}else{$.alert("提示","该号不在群组成员中，请重新选择！");return}}else{if(response.code==-2){$.alertM(response.data)}else{$.alert("提示",response.data);return}}},always:function(){$.unecOverlay()},fail:function(response){$.unecOverlay();$.alert("提示","套餐加载失败，请稍后再试！")}})};var _orderAttachOffer=function(){OrderInfo.busitypeflag=14;AttachOffer.init()};var _changeOffer=function(){OrderInfo.busitypeflag=2;OrderInfo.oldprodInstInfos=[];OrderInfo.oldofferSpec=[];OrderInfo.oldoffer=[];OrderInfo.oldAddNumList=[];offerChange.init()};var _showChangeAccount=function(){OrderInfo.busitypeflag=16;var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};var flag=rule.rule.prepare(param,"order.prodModify.changeAccount",callParam);if(flag){return}};var _changeAccount=function(){if(!_choosedProdInfo.prodInstId||!_choosedProdInfo.accNbr){$.alert("提示","产品信息定位异常，请联系管理员");$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}var param={prodId:_choosedProdInfo.prodInstId,acctNbr:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",param,{before:function(){$.ecOverlay("<strong>正在确认当前产品帐户,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(jr){if(jr.code!=0||jr.data.length==0){if(jr.code==-2){$.alertM(jr.data)}else{$.alert("提示","当前产品帐户定位失败，请联系管理员")}$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}var prodAcctInfos=jr.data;$.callServiceAsHtml(contextPath+"/order/preChangeAccount",prodAcctInfos,{before:function(){$.ecOverlay("<strong>当前产品帐户已确认</strong>")},always:function(){$.unecOverlay()},done:function(response){if(!response){response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(response.code!=0){$.alert("提示","查询失败,请稍后重试");return}$("#order_fill_content").html(response.data).show();$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$("#origAccts option:first").attr("selected","selected");acct.acctModify.getBILL_POST()},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})}})};var _showOrigAccts=function(){easyDialog.open({container:"origAcctDialog"});$("#origAcctClose").click(function(){easyDialog.close()})};var _chooseAcct=function(){$("#chooseQueryAcctType").find("option[value=1]").attr("selected","selected");$("#d_query_nbr").show();easyDialog.open({container:"queryAcctDialog"});$("#chooseQueryAcctType").change(function(){if($("#chooseQueryAcctType").val()==1){$("#d_query_cd").hide();$("#d_query_nbr").show()}else{$("#d_query_nbr").hide();$("#d_query_pwd").hide();$("#d_query_cd").show()}});$("#queryAcctClose").click(function(){$("#acctListTab tbody").empty();$("#d_query_cd").hide();$("#d_query_nbr").hide();easyDialog.close()})};var newAcctList=[];var _queryAccount=function(acctSelect){var response;if($("#chooseQueryAcctType").val()==1){if(!CONST.LTE_PHONE_HEAD.test($.trim($("#d_query_nbr input").val()))){$.alert("提示","请输入有效的中国电信手机号");return}var acctQueryParam={accessNumber:$("#d_query_nbr input").val()};response=order.prodModify.returnAccount(acctQueryParam)}else{var acctQueryParam={acctCd:$("#d_query_cd input").val()};response=order.prodModify.returnAccount(acctQueryParam)}$("#acctListTab tbody").empty();if(response.code==0){var returnMap=response.data;if(returnMap.resultCode==0){if(returnMap.accountInfos&&returnMap.accountInfos.length>0){var accountInfos=returnMap.accountInfos;$.each(accountInfos,function(i,accountInfo){var tr=$("<tr></tr>").appendTo($("#acctListTab tbody"));if(accountInfo.name){$("<td class='teleNum'>"+accountInfo.name+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}if(accountInfo.acctId){$("<td acctId='"+accountInfo.acctId+"'>"+accountInfo.accountNumber+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}if(accountInfo.owner){$("<td>"+accountInfo.owner+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}if(accountInfo.accessNumber){$("<td>"+accountInfo.accessNumber+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}tr.click(function(){var newAccount={acctCd:accountInfo.accountNumber,acctId:accountInfo.acctId,acctRelaTypeCd:"1",chargeItemCd:1,percent:"100",priority:"1",prodAcctId:"-1",state:"ADD"};newAcctList.push(newAccount);$("#acctListTab tbody").empty();$("#d_query_cd").hide();$("#d_query_nbr").hide();$("#d_query_pwd").hide();$("#defineNewAcct").hide();easyDialog.close();var found=false;$.each($(acctSelect).find("option"),function(i,option){if($(option).val()==accountInfo.acctId){found=true;return false}});if(found==false){$("<option>").text(accountInfo.name+" : "+accountInfo.accountNumber).attr("value",accountInfo.acctId).appendTo($(acctSelect))}$(acctSelect).find("option[value=default]").remove();$(acctSelect).find("option[value="+accountInfo.acctId+"]").attr("selected","selected")})})}else{$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+returnMap.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+response.data+"</td></tr>").appendTo($("#acctListTab tbody"))}};var _returnAccount=function(acctQueryParam){acctQueryParam.areaId=_choosedProdInfo.areaId;acctQueryParam.isServiceOpen="Y";var response=$.callServiceAsJson(contextPath+"/token/pc/order/account",acctQueryParam);if(response.code==-2){$.alertM(response.data);return}return response};var _createAcct=function(){var newAccount={acctCd:-1,acctId:-1,acctRelaTypeCd:"1",chargeItemCd:1,percent:"100",priority:"1",prodAcctId:"-1",state:"ADD"};newAcctList.push(newAccount);$("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>").appendTo($("#newAccts"));$("#newAccts").find("option[value=default]").remove();$("#newAccts").find("option[value=-1]").attr("selected","selected");$("#acctName").val(OrderInfo.cust.partyName);$("#newAccts").parent().find("a:eq(1)").hide();$("#defineNewAcct").show();acct.acctModify.ifCanAdjustBankPayment();acct.acctModify.paymentType();acct.acctModify.billPostType()};var _ifNewAcct=function(acctSelect){if($(acctSelect).val()<0){$("#defineNewAcct").show()}else{$("#defineNewAcct").hide()}};var _changeAccountSave=function(){if($("#newAccts").val()=="default"){$.alert("提示","请选择新帐户");return}if($("#newAccts").val()<0){if(!SoOrder.checkAcctInfo()){return}}var repick=false;var origAccts=$("#origAccts").find("option");$.each(origAccts,function(i,origAcct){if($("#newAccts").val()==$(origAcct).val()){repick=true;return false}});if(repick==false){var delAcctId=$("#origAccts").val();var origAcct=$("#origAcctList tbody").find("tr[id="+delAcctId+"]");var _acctCd=$(origAcct).find("td:eq(4)").text();var _acctId=$(origAcct).find("td:eq(0)").text();var _chargeItemCd=$(origAcct).find("td:eq(2)").text();var _percent=$(origAcct).find("td:eq(7)").text();var _priority=$(origAcct).find("td:eq(8)").text();if(_priority==""){_priority=1}var _prodAcctId=$(origAcct).find("td:eq(1)").text();var origAcctInfo={acctCd:_acctCd,acctId:_acctId,acctRelaTypeCd:"1",chargeItemCd:_chargeItemCd,percent:_percent,priority:_priority,prodAcctId:_prodAcctId,state:"DEL"};var newAcctInfo;$.each(newAcctList,function(i,newAccount){if(newAccount.acctId==$("#newAccts").val()){newAcctInfo=newAccount;return false}});var _boAccountRelas=[];_boAccountRelas.push(origAcctInfo);_boAccountRelas.push(newAcctInfo);var _busiOrderAttrs=[];var remark=$("#orderRemark").val();_busiOrderAttrs.push({itemSpecId:"111111118",value:remark});var data={boAccountRelas:_boAccountRelas,busiOrderAttrs:_busiOrderAttrs};
if($("#newAccts").val()==-1){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,10,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");var busiOrder=[];OrderInfo.createAcct(busiOrder,-1);var acctChangeNode={areaId:_choosedProdInfo.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:_choosedProdInfo.accNbr,instId:_choosedProdInfo.prodInstId,isComp:"N",objId:_choosedProdInfo.productId,offerTypeCd:"1"},boActionType:{actionClassCd:1300,boActionTypeCd:"-6"},data:data};busiOrder.push(acctChangeNode);SoOrder.submitOrder(busiOrder)}else{OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");SoOrder.submitOrder(data)}}else{$.alert("提示","该帐户已经是付费帐户了，请重新选择");return}};var _cancel=function(){$.confirm("信息","确定取消当前操作吗？",{yes:function(){OrderInfo.resetChooseUserInfo();var boProd2Tds=OrderInfo.boProd2Tds;if(boProd2Tds.length>0){for(var n=0;n<boProd2Tds.length;n++){var param={numType:2,numValue:boProd2Tds[n].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",param)}}var boProdAns=OrderInfo.boProdAns;if(boProdAns.length>0){for(var n=0;n<boProdAns.length;n++){if(boProdAns[n].idFlag){continue}var param={numType:1,numValue:boProdAns[n].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",param)}order.service.boProdAn={};order.phoneNumber.resetBoProdAn()}$("#order_fill_content").empty();OrderInfo.order.step=0;order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show()},no:function(){}},"question")};var compparam="";var _queryCustProd=function(){var hasmeneber=false;var prodnum=$.trim($("#prodnbr").val());if(prodnum==""){$.alert("提示","请输入需要查询的接入号！");return}else{hasmeneber=isExist(prodnum)}if(hasmeneber.flag){if(hasmeneber.data=="1"){var param={};var prodnum=$.trim($("#prodnbr").val());param.acctNbr=prodnum;var url=contextPath+"/cust/queryprodbynbr"}else{$.alert("提示","该产品已经在组合中，请重新选择！");return}}else{return}$.callServiceAsHtmlGet(url,param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(!response){response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(response.code==-2){return}else{if(response.code!=0){$.alert("提示","客户查询失败,稍后重试");return}}var content$=$("#prodinst");content$.html(response.data)}})};var _compChangeTab=function(num){if(num==1){$("#tab_1").addClass("setcon");$("#tab_2").removeClass("setcon");$("#addCompPage").show();$("#releaseShortNum").hide();$("#compopr").show()}else{$("#tab_2").addClass("setcon");$("#tab_1").removeClass("setcon");$("#addCompPage").hide();$("#releaseShortNum").show();$("#compopr").hide()}};var _addToComp=function(obj){var phonenumber=$(obj).parent().parent().children(":first-child").next().text();var productId=$(obj).parent().parent().children(":last-child").text();var prodInstId=$(obj).parent().parent().children().eq(-2).text();var prodStateCd=$(obj).parent().parent().children().eq(-3).text();var linum=$("#choosed_menbers li").length;if(linum>12){$.alert("提示","已经超过了加入的最大数量！");return}if(prodStateCd!="100000"){$.alert("提示","该产品状态不符，不能纳入成员！");return}var addphones=getChoosedMenbr();if(addphones.length!=0){for(var i=0;i<addphones.length;i++){if(phonenumber==addphones[i]){$.alert("提示","该号码已经在待纳入成员中，请重新选择！");return}}}ec.form.dialog.createDialog({id:"-grps",initCallBack:function(dialogForm,dialog){var compdata=compspecGrps;var compPspecCompGrp2Pspecs=compspecGrps[0].compPspecCompGrp2Pspecs;var compPspecCompGrpRelas=compspecGrps[0].compPspecCompGrpRelas;if(compPspecCompGrpRelas==undefined){compPspecCompGrpRelas=[]}var zNodes=[];var menber=[];for(var i=0;i<compPspecCompGrp2Pspecs.length;i++){var grpspec={name:compPspecCompGrp2Pspecs[i].prodSpecName,prodCompRelaRoleCd:compPspecCompGrp2Pspecs[i].prodCompRelaRoleCd,prodCompRelaRoleName:compPspecCompGrp2Pspecs[i].prodCompRelaRoleName,prodSpecId:compPspecCompGrp2Pspecs[i].prodSpecId};menber.push(grpspec)}var childmenber=[];for(var i=0;i<compPspecCompGrpRelas.length;i++){var compPspecCompGrpRelasSpecs=compPspecCompGrpRelas[i];var childSpec=[];for(var j=0;j<compPspecCompGrpRelasSpecs.length;j++){var grpspec={name:compPspecCompGrpRelasSpecs[j].prodSpecName,prodCompRelaRoleCd:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleCd,prodCompRelaRoleName:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleName,prodSpecId:compPspecCompGrpRelasSpecs[j].prodSpecId};childSpec.push(grpspec)}var childrole={name:compPspecCompGrpRelasSpecs[i].compPspecCompGrpName,children:childSpec};childmenber.push(childrole)}var setting={data:{key:{title:"t"},simpleData:{enable:true}},callback:{onClick:onClick}};if(compPspecCompGrp2Pspecs.length!=0){var node={name:"成员",open:true,children:menber};zNodes.push(node)}if(compPspecCompGrpRelas.length!=0){var node={name:"子组",children:childmenber};zNodes.push(node)}if(compPspecCompGrp2Pspecs.length==0&&compPspecCompGrpRelas.length==0){$.alert("提示","该产品没有成员规则，请重新选择群组产品！");return}var prodCompRelaRoleCd="";var prodCompRelaRoleName="";function onClick(event,treeId,treeNode,clickFlag){prodCompRelaRoleCd="";prodCompRelaRoleName="";var prodSpecId=treeNode.prodSpecId;if(prodSpecId==productId){prodCompRelaRoleCd=treeNode.prodCompRelaRoleCd;prodCompRelaRoleName=treeNode.prodCompRelaRoleName}else{$.alert("提示","不能加入该角色，请重新选择！")}}$.fn.zTree.init($("#rluename"),setting,zNodes);$("#nextstep").click(function(){if(prodCompRelaRoleCd!=""&&prodCompRelaRoleName!=""){$("#dialogtitle").html("设置短号");var shortnumhtml="短号设置：<input type='text' id='shortnumtext' class='inputWidth183px'/>";$("#rluename").html("").html(shortnumhtml);$("#nextstep").hide();$("#submitbtn2").show()}else{$.alert("提示","请选择所需纳入的成员！");return}});$("#submitbtn2").click(function(){var shortnum=$("#shortnumtext").val();var reg=new RegExp("^[0-9]*$");if(shortnum==""){$("#errinfo").html("对不起，请输入短号！");return}if(!reg.test(shortnum)){$("#errinfo").html("短号只能为数字，请重新输入！");return}var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:phonenumber,extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortnum,statusCd:"1102"};var url=contextPath+"/order/checkGroupShortNum";var res=$.callServiceAsJson(url,param,{});if(res.code==0){var addnbrhtml="<li id='li_"+phonenumber+"' prodInstId='"+prodInstId+"' phonenumber='"+phonenumber+"' prodCompRelaRoleCd='"+prodCompRelaRoleCd+"' prodCompRelaRoleName='"+prodCompRelaRoleName+"' productId='"+productId+"' style='width:280px;'><dd class='delete' onclick='order.prodModify.addCompDelSelect(this);'></dd><span id='addNbr' style='display:inline;padding:0 5px 0 22px;'>"+phonenumber+"</span><span style='display:inline;padding:0px;'>[短号：</span><span style='display:inline;padding:0px;' id='shortNumber'>"+shortnum+"</span><span class='modshortnum' onclick='order.prodModify.changeShortNum(this);' style='display:inline;padding:0 25px 0 20px;'></span><span style='display:inline;padding:0px;'>]</span>";$("#choosed_menbers").append(addnbrhtml);dialogForm.close(dialog)}else{if(res.code==-2){$.alertM(res.data)}else{$.alert("提示",res.data)}}})},submitCallBack:function(dialogForm,dialog){},width:400,height:150})};var getChoosedMenbr=function(){var numbers=[];$("#choosed_menbers li").each(function(){var phonenum=$(this).children("span#addNbr").text();numbers.push(phonenum)});return numbers};var boolHasShortNum=function(){var hasshrot=true;$("#choosed_menbers li").each(function(){var phonenum=$(this).children("span#shortNumber").text();if(phonenum==""){hasshrot=false}});return hasshrot};var _changeShortNum=function(obj){var phonenum=$(obj).parent().children("span#addNbr").text();var shortnum=$(obj).parent().children("span#shortNumber").text();ec.form.dialog.createDialog({id:"-shrotnum",initCallBack:function(dialogForm,dialog){$("#shortnumval").val(shortnum);$("#submitbtn3").click(function(){shortnum=$(obj).parent().children("span#shortNumber").text();
var newshortnum=$("#shortnumval").val();if(shortnum==newshortnum){dialogForm.close(dialog)}if(shortnum==""&&newshortnum!=""){var result=getOprShortNumInfo(phonenum,newshortnum,"1102");if(result.code==0){$("#li_"+phonenum).children("span#shortNumber").html(newshortnum)}else{if(result.code==-2){$.alertM(result.data);return}else{$.alert("提示","短号预占失败！");return}}dialogForm.close(dialog)}if(shortnum!=""&&newshortnum==""){$.alert("提示","请输入短号！");return}if(shortnum!=""&&newshortnum!=""){var resultremove=getOprShortNumInfo(phonenum,shortnum,"1000");if(resultremove.code==0){$("#li_"+phonenum).children("span#shortNumber").html("")}else{if(resultremove.code==-2){$.alertM(resultremove.data);return}else{$.alert("提示","短号预占失败！");return}}var resultadd=getOprShortNumInfo(phonenum,newshortnum,"1102");if(resultadd.code==0){$("#li_"+phonenum).children("span#shortNumber").html(newshortnum)}else{if(resultadd.code==-2){$.alertM(resultadd.data);return}else{$.alert("提示","预占失败！");return}}dialogForm.close(dialog)}})},submitCallBack:function(dialogForm,dialog){},width:350,height:100})};var getOprShortNumInfo=function(accNbr,shortNbr,statusCd){var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:accNbr,extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortNbr,statusCd:statusCd};var url=contextPath+"/order/checkGroupShortNum";var res=$.callServiceAsJson(url,param,{});return res};var _releaseShortNum=function(){var shortNbr=$("#resshortnum").val();var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:"",extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortNbr,statusCd:"1000"};var url=contextPath+"/order/checkGroupShortNum";var res=$.callServiceAsJson(url,param,{});if(res.code==0){$.alert("提示","短号释放成功！");$("#choosed_menbers li").each(function(){var shortNum=$(this).children("span#shortNumber").text();if(shortNbr==shortNum){$(this).children("span#shortNumber").html("")}})}else{if(res.code==-2){$.alertM(res.data);return}else{$.alert("提示",res.data)}}};var canAddAnother=function(){var phonelist=$("#choosed_menbers").html();phonelist=phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");if(phonelist!=""){var lastspan=$("#choosed_menbers").children(":last-child").children("span").length;if(lastspan<2){return false}else{return true}}else{return true}};var isExist=function(prodnum){var params={compProdId:_choosedProdInfo.prodInstId,accessNumber:prodnum};var url=contextPath+"/order/queryCompmenber";var returndata={};var isexist=$.callServiceAsJson(url,params,{});if(isexist.code==0){returndata.flag=true;var compProdMemberInfos=isexist.data;if(compProdMemberInfos.length>0){returndata.data="0"}else{returndata.data="1"}return returndata}else{if(isexist.code==-2){$.alertM(returndata.data);returndata.flag=false}else{returndata.flag=false;$.alert("提示",isexist.data);return returndata}}};var _addCompSubmit=function(){var phonelist=$("#choosed_menbers").html();phonelist=phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");if(phonelist==""){$.alert("提示","请选择纳入组合的成员！");return}var boolshort=boolHasShortNum();if(!boolshort){$.alert("提示","待加入成员未全部设置短号，请全部设置好后再提交！");return}var busiOrder=[];var addMenbers=[];var prodCompId=-1;$("#choosed_menbers li").each(function(){var prodInstId=$(this).attr("prodInstId");var phonenumber=$(this).attr("phonenumber");var prodCompRelaRoleCd=$(this).attr("prodCompRelaRoleCd");var prodCompRelaRoleName=$(this).attr("prodCompRelaRoleName");var productId=$(this).attr("productId");var shortnum=$(this).children("span#shortNumber").text();addMenbers.push(phonenumber);var compparam={busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:CONST.PROD_SPEC.CDMA,instId:prodInstId,accessNumber:phonenumber},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP},areaId:OrderInfo.staff.areaId,aggreementId:"",data:{boProdCompOrders:[{prodCompRelaRoleCd:prodCompRelaRoleCd,prodCompRelaRoleName:prodCompRelaRoleName,prodCompId:prodCompId,compProdId:_choosedProdInfo.prodInstId}],boProdCompRelas:[{prodCompId:prodCompId,state:"ADD",atomActionId:OrderInfo.SEQ.atomActionSeq--}],boProdSpecs:[{prodSpecId:productId,atomActionId:OrderInfo.SEQ.atomActionSeq--,state:"KIP"}],boProdCompItems:[{itemSpecId:"37906",name:"",prodCompId:prodCompId,state:"ADD",value:shortnum,atomActionId:OrderInfo.SEQ.atomActionSeq--}],busiOrderAttrs:[{itemSpecId:"111111111",value:$("#orderRemark").val()}]}};busiOrder.push(compparam);prodCompId--});OrderInfo.confirmList=[];var comfimProdInfo={name:_choosedProdInfo.productName,accNbr:[_choosedProdInfo.accNbr]};OrderInfo.confirmList.push(comfimProdInfo);var comfimMeneber={name:"纳入成员",accNbr:addMenbers};OrderInfo.confirmList.push(comfimMeneber);SoOrder.submitOrder(busiOrder)};var _removeCompSubmit=function(){var t=$("#choosed_menbers").html();t=t.replace(/[\r\n]/g,"").replace(/[ ]/g,"");if(t==""){$.alert("提示","请选择退出组合的成员！");return}var busiOrder=[];var addMenbers=[];$("#choosed_menbers li").each(function(){var prodInstId=$(this).attr("prodInstId");var phonenumber=$(this).attr("phonenumber");var prodCompRelaRoleCd=$(this).attr("prodCompRelaRoleCd");var prodCompRelaRoleName=$(this).attr("prodCompRelaRoleName");var prodCompId=$(this).attr("prodCompId");addMenbers.push(phonenumber);var compparam={busiOrderInfo:{seq:-1},busiObj:{objId:CONST.PROD_SPEC.CDMA,instId:prodInstId,accessNumber:phonenumber},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP},areaId:OrderInfo.staff.areaId,aggreementId:"",data:{boProdCompOrders:[{prodCompRelaRoleCd:prodCompRelaRoleCd,prodCompRelaRoleName:prodCompRelaRoleName,prodCompId:prodCompId,compProdId:_choosedProdInfo.prodInstId}],boProdCompRelas:[{prodCompId:prodCompId,state:"DEL"}],busiOrderAttrs:[{itemSpecId:"111111111",value:$("#orderRemark").val()}]}};busiOrder.push(compparam)});OrderInfo.confirmList=[];var comfimProdInfo={name:_choosedProdInfo.productName,accNbr:[_choosedProdInfo.accNbr]};OrderInfo.confirmList.push(comfimProdInfo);var comfimMeneber={name:"退出成员",accNbr:addMenbers};OrderInfo.confirmList.push(comfimMeneber);SoOrder.submitOrder(busiOrder)};var _removeCompDelSelect=function(obj){$.confirm("确认","确定要取消该号码吗?",{yes:function(){var accNbr=$(obj).next().text();$("#li_"+accNbr).remove()},no:function(){}})};var _addCompDelSelect=function(obj){$.confirm("确认","确定要取消该号码吗?",{yes:function(){var accNbr=$(obj).parent().children("span#addNbr").text();var shortnum=$(obj).parent().children("span#shortNumber").text();if(shortnum!=""){var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:accNbr,extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortnum,statusCd:"1000"};var url=contextPath+"/order/checkGroupShortNum";var response=$.callServiceAsJson(url,param,{});if(response.code==0){$("#li_"+accNbr).remove()}else{if(response.code==-2){$.alertM(response.data)}else{alert("删除失败")}}}else{$("#li_"+accNbr).remove()}},no:function(){}})};var _showBuyBack=function(){if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){$.alert("提示","停机产品不允许受理！");return}OrderInfo.busitypeflag=0;var queryParam={objInstId:_choosedProdInfo.prodInstId,queryType:"1",areaId:OrderInfo.staff.areaId};var url=contextPath+"/order/queryOrderItemDetailForResale";$.callServiceAsHtmlGet(url,queryParam,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(!response||response.code!=0){response.data="查询失败,稍后重试"}var objList=eval("("+response.data+")");if(objList.data==null){$.alert("提示","无法返销，不符合可以返销的规则，上一次购物车操作不是新装、订购合约或者补换卡中的一种。");return}for(var i=0;i<objList.data.length;i++){if(objList.data[i].boActionTypeCd==CONST.BO_ACTION_TYPE.NEW_PROD){boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_BACK;OrderInfo.boRelas=[{relaTypeCd:CONST.RELATYPECD,relaBoId:objList.data[i].orderItemId}];OrderInfo.orderItemCd=objList.data[i].orderItemCd;OrderInfo.buyBack_orderItemObjId=objList.data[i].orderItemObjId;
OrderInfo.buyBack_orderItemObjInstId=objList.data[i].orderItemObjInstId;break}}if(boActionTypeCd!=CONST.BO_ACTION_TYPE.BUY_BACK){for(var i=0;i<objList.data.length;i++){if(objList.data[i].boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_OFFER){boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT;OrderInfo.boRelas=[{relaTypeCd:CONST.RELATYPECD,relaBoId:objList.data[i].orderItemId}];OrderInfo.orderItemCd=objList.data[i].orderItemCd;OrderInfo.buyBack_orderItemObjId=objList.data[i].orderItemObjId;OrderInfo.buyBack_orderItemObjInstId=objList.data[i].orderItemObjInstId;break}else{if(objList.data[i].boActionTypeCd==CONST.BO_ACTION_TYPE.CHANGE_CARD){boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_BACK_CHANGE_CARD;OrderInfo.boRelas=[{relaTypeCd:CONST.RELATYPECD,relaBoId:objList.data[i].orderItemId}];OrderInfo.orderItemCd=objList.data[i].orderItemCd;OrderInfo.buyBack_orderItemObjId=objList.data[i].orderItemObjId;OrderInfo.buyBack_orderItemObjInstId=objList.data[i].orderItemObjInstId}else{$.alert("提示","当前业务动作类型【"+objList.data[i].boActionTypeCd+"】不能返销！");return}}}}var param=_getCallRuleParam(boActionTypeCd,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:boActionTypeCd,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BUY_BACK),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};var checkRule=rule.rule.prepare(param,"order.prodModify.showBuyBackDo",callParam)},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var _showBuyBackDo=function(){var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var orderItemId="";if(!query.offer.setOffer()){return}_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,boActionTypeCd,1)};var _setCoupon=function(coupon){_coupon=coupon};var _btnMoreProfile=function(){if($("#modPartyProfile").is(":hidden")){$("#modPartyProfile").show();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrowup");order.prodModify.changeLabel(0)}else{$("#modPartyProfile").hide();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrow");$("#modTabProfile0").attr("click","1");$("#contactName").attr("data-validate","");_form_custInfomodify_btn()}};var _changeLabel=function(labelId){if($("#partyProfile").is(":visible")==false){$("#partyProfile").show()}if(labelId=="0"){$("#modTabProfile0").show();$("#cardtab_mod_0").addClass("setcon");$("#modTabProfile0").attr("click","0");$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(keyup)");_form_custInfomodify_btn()}else{if(($("#modTabProfile0").attr("click")=="0")&&($("#contactName").val()=="")){$.alert("提示","联系人名称不能为空！","information");return}}for(var i=0;i<order.prodModify.profileTabLists.length;i++){var profileTabLists=order.prodModify.profileTabLists[i];var tabProfileNum=profileTabLists.tabProfileNum;var partyProfileCatgTypeCd=profileTabLists.partyProfileCatgTypeCd;if(labelId==partyProfileCatgTypeCd){$("#"+tabProfileNum).show();$("#cardtab_mod_"+partyProfileCatgTypeCd).addClass("setcon");$("#modTabProfile0").hide();$("#cardtab_mod_0").removeClass("setcon")}else{$("#"+tabProfileNum).hide();$("#cardtab_mod_"+partyProfileCatgTypeCd).removeClass("setcon")}}};var _checkProPSW=function(psw){$("#"+psw).blur()};var _showNumberOrder=function(){if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){$.alert("提示","停机产品不允许受理！");return}var param={mainAccNbr:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};var boInfos=[{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,instId:_choosedProdInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:_choosedProdInfo.prodInstId}];if(!rule.rule.ruleCheck(boInfos)){return}$.callServiceAsHtml(contextPath+"/order/cardNumberOrder",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#ordercon").show();$("#ordertabcon").show();order.prepare.step(1);OrderInfo.order.step=1;$("#orderedprod").hide();$("#order_prepare").hide();$(".ordercon a:first span").text("取 消");$(".main_body").css("height","150px");$(".main_body").css("min-height","150px");$("#order_confirm").empty();$("#fillLastStep").click(function(){order.prodModify.cancel()});$("#queryAccNbrList").unbind("click").bind("click",function(){var param={areaId:$("#areaId").val(),scene:"ADD",preHandle:"C",mainAccNbr:$("#mainAccNbr").val(),virtualAreaId:$("#p_areaId").val(),soChannelId:OrderInfo.staff.channelId};$.callServiceAsHtml(contextPath+"/order/queryAccNbrList",param,{before:function(){$.ecOverlay("虚号号码查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(response){order.prepare.step(2);OrderInfo.order.step=2;$("#order_fill_content").hide();var content$=$("#order_confirm");content$.html(response.data).show();OrderInfo.actionFlag=36;OrderInfo.orderAccNbr=_choosedProdInfo.accNbr;order.dealer.initDealer()},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})})},always:function(){$.unecOverlay()}})};var _orderAccNbr=function(){var virtualAccNbr=$("input[name='virtualAccNbr']:checked").val();if(virtualAccNbr==null||virtualAccNbr==""||virtualAccNbr==undefined){$.alert("提示","请选择一个虚号号码！");return}var mainAccNbr=$("#mainAccNbr").val();var param={areaId:$("#areaId").val(),virtualAreaId:$("#virtualAreaId").val(),scene:"ADD",preHandle:"F",extCustOrderId:$("#extCustOrderId").val(),mainAccNbr:mainAccNbr,virtualAccNbr:virtualAccNbr,pageType:"orderAccNber",busiOrderAttrs:[]};var $tr=$("tr[name='tr_"+mainAccNbr+"']");if($tr!=undefined){$tr.each(function(){var dealer={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+mainAccNbr+"']").val()};param.busiOrderAttrs.push(dealer);var dealer_name={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};param.busiOrderAttrs.push(dealer_name)})}_exchangeAccNbr(param)};var _showNumberUnOrder=function(){if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){$.alert("提示","停机产品不允许受理！");return}var param={mainAccNbr:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};var boInfos=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,instId:_choosedProdInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:_choosedProdInfo.prodInstId}];if(!rule.rule.ruleCheck(boInfos)){return}$.callServiceAsHtml(contextPath+"/order/queryVirtualInfo",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#ordercon").show();$("#ordertabcon").show();order.prepare.step(2);OrderInfo.order.step=2;$("#orderedprod").hide();$("#order_prepare").hide();$(".ordercon a:first span").text("取 消");$(".main_body").css("height","150px");$(".main_body").css("min-height","150px");$("#order_confirm").empty();$("#fillLastStep").click(function(){order.prodModify.cancel()});$("#undoAccNbr").unbind("click").bind("click",function(){var param={areaId:$("#areaId").val(),scene:"DEL",preHandle:"C",extCustOrderId:$("#extCustOrderId").val(),mainAccNbr:$("#mainAccNbr").val(),virtualAreaId:$("#virtualAreaId").val(),virtualAccNbr:$("#virtualAccNbr").val(),pageType:"unOrderAccNber"};_exchangeAccNbr(param)})},always:function(){$.unecOverlay()}})};var _exchangeAccNbr=function(param){$.callServiceAsHtml(contextPath+"/order/exchangeAccNbr",param,{before:function(){$.ecOverlay("订单确认中，请稍等...")},always:function(){$.unecOverlay()},done:function(response){order.prepare.step(3);OrderInfo.order.step=3;$("#order_fill_content").hide();var content$=$("#order_confirm");content$.html(response.data).show();$("#successTip_dialog_cnt").off("click").on("click",function(event){order.calcharge.backToEntr()})},fail:function(response){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var _chooseAccNbrArea=function(){order.area.chooseAreaTreeQueryManger("javascript:order.prodModify.showNumberOrder()","p_areaId_val","p_areaId",3)
};return{changeCard:_changeCard,getChooseProdInfo:_getChooseProdInfo,lossRepProd:_lossRepProd,lossRepProdSubmit:_lossRepProdSubmit,choosedProdInfo:_choosedProdInfo,showLossRepProd:_showLossRepProd,showLossRepProdReg:_showLossRepProdReg,showStopKeepNumProd:_showStopKeepNumProd,showStopKeepNumProdReg:_showStopKeepNumProdReg,showCustInfoModify:_showCustInfoModify,custInfoModify:_custInfoModify,commonPrepare:_commonPrepare,showOweRemoveProd:_showOweRemoveProd,showRemoveProd:_showRemoveProd,showOrderRemoveProd:_showOrderRemoveProd,showCoverOrderRemoveProd:_showCoverOrderRemoveProd,showBreakRuleRemoveProd:_showBreakRuleRemoveProd,showNoActiveRemoveProd:_showNoActiveRemoveProd,spec_parm_change:_spec_parm_change,showChangeCard:_showChangeCard,spec_password_change:_spec_password_change,spec_password_change_save:_spec_password_change_save,showPasswordChange:_showPasswordChange,spec_password_change_check:_spec_password_change_check,getCallRuleParam:_getCallRuleParam,cancel:_cancel,orderAttachOffer:_orderAttachOffer,changeOffer:_changeOffer,shortnum_change:_shortnum_change,shortnum_show:_shortnum_show,shortnum_save:_shortnum_save,spec_parm_show:_spec_parm_show,showAddComp:_showAddComp,addComp:_addComp,addToComp:_addToComp,compChangeTab:_compChangeTab,queryCustProd:_queryCustProd,addCompSubmit:_addCompSubmit,spec_parm_show:_spec_parm_show,showChangeAccount:_showChangeAccount,changeAccount:_changeAccount,showOrigAccts:_showOrigAccts,chooseAcct:_chooseAcct,queryAccount:_queryAccount,returnAccount:_returnAccount,createAcct:_createAcct,ifNewAcct:_ifNewAcct,changeAccountSave:_changeAccountSave,showRemoveComp:_showRemoveComp,removeComp:_removeComp,profiles:_profiles,profileTabLists:_profileTabLists,partyTypeCdChoose:_partyTypeCdChoose,identidiesTypeCdChoose:_identidiesTypeCdChoose,removeCompSubmit:_removeCompSubmit,showPasswordReset:_showPasswordReset,spec_password_reset:_spec_password_reset,spec_password_reset_save:_spec_password_reset_save,queryRomveAcc:_queryRomveAcc,removeCompDelSelect:_removeCompDelSelect,addCompDelSelect:_addCompDelSelect,chooseOfferForMember:_chooseOfferForMember,shortnum_check:_shortnum_check,shortnum_change_val:_shortnum_change_val,changeShortNum:_changeShortNum,releaseShortNum:_releaseShortNum,showActiveReturn:_showActiveReturn,showBuyBack:_showBuyBack,showBuyBackDo:_showBuyBackDo,setCoupon:_setCoupon,lteFlag:lteFlag,btnMoreProfile:_btnMoreProfile,changeLabel:_changeLabel,remark_prodPass:_remark_prodPass,checkProPSW:_checkProPSW,showNumberOrder:_showNumberOrder,orderAccNbr:_orderAccNbr,showNumberUnOrder:_showNumberUnOrder,exchangeAccNbr:_exchangeAccNbr,chooseAccNbrArea:_chooseAccNbrArea,spec_parm_user_change:_spec_parm_user_change,spec_parm_user_show:_spec_parm_user_show}})();CommonUtils.regNamespace("order","prepare");order.prepare=(function(){var j=function(){$("#order_quick_nav li").each(function(){$(this).off("click").on("click",function(y){OrderInfo.actionFlag=1;var v=$(this).attr("url");var w=$(this).attr("for");if(w=="order_tab_panel_phonenumber"){var x=OrderInfo.cust.custId;if(OrderInfo.cust==undefined||x==undefined||x==""){$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");return}}g(v,w);y.stopPropagation()})});$("#order_nav li").each(function(){$(this).off("click").on("click",function(y){OrderInfo.actionFlag=1;var v=$(this).attr("url");var w=$(this).attr("for");if(w=="order_tab_panel_phonenumber"){var x=OrderInfo.cust.custId;if(OrderInfo.cust==undefined||x==undefined||x==""){$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");return}}g(v,w);y.stopPropagation()})});var p=$("#diffPlaceFlag").val();if(p=="diff"){$("#order_prepare").hide();$("#nothreelinks").show()}var r=$("#mktResHidId").attr("mktResCd");var s=$("#offerSpecHidId").val();if(r&&r.length>0){var q=contextPath+"/mktRes/terminal/prepare";var u={};var o=$.callServiceAsHtmlGet(q,u);var t=$("#order_tab_panel_content");t.html(o.data);mktRes.terminal.selectTerminal($("#mktResHidId"));$("#order_prepare").hide();order.prepare.step(1);a("","购手机",true);t.show()}else{if(s&&s.length>0){var q=contextPath+"/order/prodoffer/prepare";var u={prodOfferId:s};var o=$.callServiceAsHtmlGet(q,u);var t=$("#order_tab_panel_content");t.html(o.data);$("#order_prepare").hide();order.prepare.step(1);a("","办套餐",true);t.show();order.service.initSpec();order.prodOffer.init()}}};var g=function(o,p){var q={};$.callServiceAsHtmlGet(o,q,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(r){if(!r){r.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(r.code!=0){$.alert("提示","查询失败,稍后重试");return}if(order.cust.orderBtnflag=="1"){order.cust.btnQueryCustProdMore()}main.home.hideMainIco();$("#order_prepare").hide();$("#order_fill_content").hide();$("#orderedprod").hide();order.prepare.step(1);var s=$("#order_tab_panel_content");s.html(r.data).show();if(p=="order_tab_panel_terminal"){a("","购手机",true);order.service.releaseFlag=1;order.prepare.createorderlonger();OrderInfo.busitypeflag=1;mktRes.terminal.queryApConfig();mktRes.terminal.initInParam("","","","","");mktRes.terminal.btnQueryTerminal(1)}else{if(p=="order_tab_panel_phonenumber"){a("","选号码",true);order.service.releaseFlag=1;order.prepare.createorderlonger();OrderInfo.busitypeflag=1;order.phoneNumber.initPhonenumber()}else{if(p=="order_tab_panel_offer"){a("","办套餐",true);if(order.service.releaseFlag==0){order.service.releaseFlag=2}order.prepare.createorderlonger();OrderInfo.busitypeflag=1;order.service.initSpec();order.prodOffer.init();order.service.searchPack();order.phoneNumber.resetBoProdAn()}}}}})};var f=function(p,r,q){var o=["15%"];if($.browser.mozilla){o=["15%"]}ec.form.dialog.createDialog({id:"-phonenumber",width:970,height:440,position:o,initCallBack:function(v,t){var u={subPage:p};var s=contextPath+"/token/pc/mktRes/phonenumber/prepare";$.callServiceAsHtmlGet(s,u,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(w){if(!w){w.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(w.code!=0){$.alert("提示","查询失败,稍后重试");return}order.phoneNumber.dialogForm=v;order.phoneNumber.dialog=t;var x=$("#phonenumberContent");x.html(w.data);$("#subPage").val(p);$("#subFlag").val(r);$("#subnum").val(q);order.phoneNumber.initPhonenumber()}})},submitCallBack:function(t,s){}})};var b=function(o,s,p){if(c(s,p)){return}var r=$.trim($("#uim_"+p).val());if(r==""){$.alert("提示","UIM卡不能为空!");return}param={oldInstCode:r,phoneNum:""};var q=contextPath+"/mktRes/uim/checkUim";$.callServiceAsJson(q,param,{before:function(){$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(t){if(t.code==0){$.alert("提示","UIM卡释放成功!");$("#uim_btn_"+p).attr("unable","false");$("#uim_btn_"+p).removeClass("disablepurchase").addClass("purchase");$("#uimrelease_btn_"+p).attr("unable","true");$("#uimrelease_btn_"+p).removeClass("purchase").addClass("disablepurchase");$("#uim_"+p).removeAttr("disabled");$("#uim_"+p).val("");for(var v=0;v<OrderInfo.boProd2Tds.length;v++){if(OrderInfo.boProd2Tds[v].prodId==p){OrderInfo.boProd2Tds.splice(v,1)}}for(var v=0;v<OrderInfo.bo2Coupons.length;v++){if(OrderInfo.bo2Coupons[v].prodId==p){var x=OrderInfo.bo2Coupons[v].coupons;if(x.length>0){for(var u=0;u<x.length;u++){if(x[u].couponInstanceNumber==r){OrderInfo.bo2Coupons[v].coupons.splice(u,1);sonExist=true;break}}}else{OrderInfo.bo2Coupons[v].coupons=[]}}}}else{if(typeof t==undefined){$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常")}else{if(t.code==-2){$.alertM(t.data)}else{var w="";if(t.data!=undefined&&t.data.msg!=undefined){w=t.data.msg}else{w="卡号["+r+"]释放失败"}$.alert("提示","UIM卡释放失败，可能原因:"+w)}}}},fail:function(t){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var c=function(p,o){if(p=="0"){if($("#uim_btn_"+o).attr("unable")=="true"){return true}else{return false}}else{if(p=="1"){if($("#uimrelease_btn_"+o).attr("unable")=="true"){return true
}else{return false}}else{return true}}};var k=function(w,t,z){if(c(t,z)){return}var x=$.trim($("#uim_"+z).val());if(x==""){$.alert("提示","UIM卡不能为空!");return}for(var r=0;r<OrderInfo.boProd2Tds.length;r++){if(OrderInfo.boProd2Tds[r].terminalCode==x){$.alert("提示","UIM卡已经被预占,请输入其它号码!");return}}var v="";for(var r=0;r<OrderInfo.boProd2Tds.length;r++){if(OrderInfo.boProd2Tds[r].prodId==z){v=OrderInfo.boProd2Tds[r].terminalCode;break}}var y="";for(var r=0;r<OrderInfo.boProdAns.length;r++){if(OrderInfo.boProdAns[r].prodId==z){y=OrderInfo.boProdAns[r].accessNumber;break}}var s=-1;var q=-1;if(OrderInfo.actionFlag==3){var u=order.prodModify.choosedProdInfo;y=u.accNbr;s=u.prodInstId;q=u.prodOfferInstId}if(y==""){$.alert("提示","校验UIM卡前请先选号!");return}var p={instCode:x,phoneNum:y};if(v!=""){p={oldInstCode:v,phoneNum:y,newInstCode:x}}var o=contextPath+"/mktRes/uim/checkUim";$.callServiceAsJson(o,p,{before:function(){$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(G){if(G.code==0){$.alert("提示","UIM卡校验成功!");if(w=="offer"){$("#uim_btn_"+z).attr("unable","true");$("#uim_btn_"+z).removeClass("purchase").addClass("disablepurchase");$("#uimrelease_btn_"+z).attr("unable","false");$("#uimrelease_btn_"+z).removeClass("disablepurchase").addClass("purchase");$("#uim_"+z).attr("disabled",true)}var J=false;for(var I=0;I<OrderInfo.boProd2Tds.length;I++){if(OrderInfo.boProd2Tds[I].prodId==z){OrderInfo.boProd2Tds[I].terminalCode=x;OrderInfo.boProd2Tds[I].couponId=G.data.baseInfo.mktResId;J=true;break}}if(!J){var E={prodId:z,anTypeCd:"",deviceModelId:0,maintainTypeCd:"1",ownerTypeCd:"",state:"",terminalCode:x,terminalDevId:"",terminalDevSpecId:"",couponId:G.data.baseInfo.mktResId,anId:0};OrderInfo.boProd2Tds.push(E)}J=false;var A=G.data.baseInfo.qty;if(A==undefined||A==null){A=1}var B={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:G.data.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:A,storeId:G.data.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:G.data.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:s,offerId:q,state:"ADD",relaSeq:""};for(var I=0;I<OrderInfo.bo2Coupons.length;I++){var K=false;if(OrderInfo.bo2Coupons[I].prodId==z){var D=OrderInfo.bo2Coupons[I].coupons;if(D.length>0){for(var H=0;H<D.length;H++){if(D[H].couponInstanceNumber==v){OrderInfo.bo2Coupons[I].coupons[H]=B;K=true;break}}}else{OrderInfo.bo2Coupons[I].coupons.push(B)}if(!K){OrderInfo.bo2Coupons[I].coupons.push(B)}J=true;break}}if(!J){var F=[];F.push(B);var L={prodId:z,coupons:F};OrderInfo.bo2Coupons.push(L)}}else{if(typeof G==undefined){$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常")}else{if(G.code==-2){$.alertM(G.data)}else{var C="";if(G.data!=undefined&&G.data.msg!=undefined){C=G.data.msg}else{C="卡号["+x+"]预占失败"}$.alert("提示","UIM卡校验失败，可能原因:"+C)}}}},fail:function(A){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var m=function(o){if(o==undefined||!o){o=1}if(1==o){OrderInfo.order.step=0;if($("#deal_package").length>0&&$("#order_prod_list").length>0&&$("#old_offerSpecId").val()==null){$("#deal_package").css("display","block");$("#order_prod_list").css("display","block")}if($("#deal_package").length>0&&$("#order_prod_list").length>0&&$("#old_offerSpecId").val()!=null&&$("#old_offerSpecId").val()!=""){$("#deal_package").css("display","block");$("#order_prod_list").css("display","block");order.service.buyService($("#old_offerSpecId").val(),'${(price)?default("")}')}}$.each($("div[id^=step]"),function(q,p){if(o==(q+1)){$(this).show()}else{$(this).hide()}})};var l=function(){$("div[id^=step]").hide()};var a=function(p,o,q){};var i=function(){$("#orderTitleDiv").hide()};var n=function(){var o=order.service.boProdAn;if(o.idFlag!=undefined&&o.idFlag=="0"){}else{if(o.accessNumber){var p={numType:1,numValue:o.accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",p,{done:function(){}})}}order.service.boProdAn={};order.phoneNumber.resetBoProdAn();i();$("#step1").hide();$("#main_div").hide();$("#order_prepare").show();$("#order_tab_panel_content").html("");if(OrderInfo.actionFlag==2){$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup")}};var h=function(){var p=contextPath+"/order/createorderlonger";var o=$.callServiceAsJson(p,{});if(o.code==0){OrderInfo.orderlonger=o.data}};return{tabChange:j,phoneNumDialog:f,checkUIM:k,step:m,hideStep:l,showOrderTitle:a,hideOrderTitle:i,backToInit:n,releaseUIM:b,createorderlonger:h}})();$(function(){order.prepare.tabChange()});CommonUtils.regNamespace("order","prodOffer");order.prodOffer=(function(f){var c=function(){order.prodOffer.queryApConfig()};var a=function(){var h={CONFIG_PARAM_TYPE:"PROD_AND_OFFER"};var g=contextPath+"/order/queryApConf";f.callServiceAsJsonGet(g,h,{done:b})};var b=function(m){var t;var q;var l;var g="<a href='javascript:void(0);' class='selected' val='' >不限</a>";var o="<a href='javascript:void(0);' class='selected' val='' >不限</a>";var r="<a href='javascript:void(0);' class='selected' val='' >不限</a>";if(m.data){var k=m.data.length;for(var p=0;p<k;p++){if(m.data[p].OFFER_PRICE){t=m.data[p].OFFER_PRICE;for(var n=0;n<t.length;n++){var h=t[n].COLUMN_VALUE;var s=t[n].COLUMN_VALUE_NAME;g=g+"<a href='javascript:void(0);' val='"+h+"'>"+s+"</a>"}f("#price_basic").html(g);f("#price_basic a").each(function(){f(this).off("click").on("click",function(i){f("#price_basic a").each(function(){f(this).removeClass("selected")});f(this).addClass("selected");i.stopPropagation();order.service.searchPack(1)})})}else{if(m.data[p].OFFER_INFLUX){q=m.data[p].OFFER_INFLUX;for(var n=0;n<q.length;n++){var h=q[n].COLUMN_VALUE;var s=q[n].COLUMN_VALUE_NAME;o=o+"<a href='javascript:void(0);' val='"+h+"'>"+s+"</a>"}f("#influx_basic").html(o);f("#influx_basic a").each(function(){f(this).off("click").on("click",function(i){f("#influx_basic a").each(function(){f(this).removeClass("selected")});f(this).addClass("selected");i.stopPropagation();order.service.searchPack(1)})})}else{if(m.data[p].OFFER_INVOICE){l=m.data[p].OFFER_INVOICE;for(var n=0;n<l.length;n++){var h=l[n].COLUMN_VALUE;var s=l[n].COLUMN_VALUE_NAME;r=r+"<a href='javascript:void(0);' val='"+h+"'>"+s+"</a>"}f("#invoice_basic").html(r);f("#invoice_basic a").each(function(){f(this).off("click").on("click",function(i){f("#invoice_basic a").each(function(){f(this).removeClass("selected")});f(this).addClass("selected");i.stopPropagation();order.service.searchPack(1)})})}}}}}};return{init:c,queryApConfig:a}})(jQuery);$(function(){});CommonUtils.regNamespace("order","protocolnbr");order.protocolnbr=(function(){var a="input1";var c="select1";var i=0;var b=0;var h=0;var g=function(){a="input1";c="select1";i=200;b=i-20;h=$("#div1").height()-41;var j=$("input[id=input1]").offset();$("#"+c).change(function(){var k=$("#"+c).find("option:selected").text();$("#"+a).val(k)}).click(function(){$("#select_div_on_key"+c).remove()}).css({display:"block",width:i+"px","z-index":1,clip:"rect(0px "+i+"px 51px 151px)"});$("#"+a).keyup(function(){f()}).click(function(){f()}).css({"z-index":2,width:b+"px"})};var f=function(){var n=$("#"+a);var q=n.val();var l=n.offset();var k=n.width()+20;var p=l.top+n.height()-100+7;var s=l.left-200+2;var o="<div class='select_div_list' id='select_div_on_key"+c+"' style='width:"+k+"px;top:"+p+"px;left:"+s+"px;'><ul class='select_div_list_ul'>";$("#"+c).find("option").each(function(){var t=$(this);var u=new RegExp("^"+q,"i");if(u.test(t.val())){o+="<li val='"+t.val()+"' ht='"+encodeURIComponent(t.html())+"'>"+t.html().replace(q,"<span class='selectSPAN'>"+q+"</span>")+"</li>"}});o+="</ul></div>";var m=$("#select_div_on_key"+c);m.remove();$("#div1").append(o);var m=$("#select_div_on_key"+c);var r=m.find("ul").height();var j=r>h?h:r;m.css({height:j+"px"});m.find("li").hover(function(){$(this).css({"background-color":"#316ac5"})},function(){$(this).css({"background-color":"white"})});m.find("li").click(function(){var v=$(this);
var u=v.attr("val");var t=v.attr("ht");t=decodeURIComponent(t);$("#"+a).val(t);$("#"+c).val(u);m.remove()})};return{showSelectCombo:f,init:g}})();CommonUtils.regNamespace("SoOrder");SoOrder=(function(){var U=function(){if(query.offer.loadInst()){SoOrder.initFillPage();return true}else{return false}};var x="";var n=function(){SoOrder.initOrderData();SoOrder.step(1);OrderInfo.order.step=1;J()};var I=function(){OrderInfo.resetSeq();OrderInfo.resetData();OrderInfo.orderResult={};OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.getAreaId();OrderInfo.resetChooseUserInfo()};var u=function(){var ab=contextPath+"/token/pc/order/getCheckOperatSpec";var aa=$.callServiceAsJson(ab,{});OrderInfo.zcd_privilege=aa.data};var z=function(ab){u();if(O(ab)){var aa=contextPath+"/token/pc/order/orderSubmit";if(OrderInfo.order.token!=""){aa=contextPath+"/token/pc/order/orderSubmit?token="+OrderInfo.order.token}$.callServiceAsJson(aa,JSON.stringify(OrderInfo.orderData),{before:function(){$.ecOverlay("<strong>订单提交中，请稍等...</strong>")},always:function(){},done:function(af){$.unecOverlay();J();if(af.code==0){var ai=af.data;if(ai.result.ruleInfos!=undefined&&ai.result.ruleInfos.length>0){var ae="";$.each(ai.result.ruleInfos,function(){ae+=this.ruleDesc+"<br/>"});$.alert("提示",ae);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq()}else{if(ai.checkRule!=undefined){var ah=af.data;var ad={olId:ah.rolId,soNbr:ah.rsoNbr,areaId:OrderInfo.staff.areaId,chargeItems:[]};var ac=contextPath+"/token/pc/order/checkRuleToProv";$.callServiceAsJson(ac,ad,{before:function(){$.ecOverlay("<strong>正在下省校验中,请稍候...</strong>")},always:function(){},done:function(aj){$.unecOverlay();var ak;if(aj.code==0){var am=aj.data;if(am.checkResult!=undefined){OrderInfo.checkresult=am.checkResult}var al=L(af.data);E(al)}else{ai.provCheckError="Y";if(aj.data&&aj.data.resultMsg!=undefined&&$.trim(aj.data.resultMsg)!=""){ai.provCheckErrorMsg=aj.data.resultMsg}else{if(aj.data.errMsg!=undefined&&$.trim(aj.data.errMsg)!=""){ai.provCheckErrorMsg=aj.data.errMsg;if(aj.data.errCode){ai.provCheckErrorMsg="【错误编码："+aj.data.errCode+"】"+ai.provCheckErrorMsg}if(aj.data.errData){ai.provCheckErrorData=aj.data.errData;ai.provCheckErrorMsg+=","+ai.provCheckErrorData}if(aj.data.paramMap){ai.provCheckErrorMsg+="【入参："+aj.data.paramMap+"】"}}else{ai.provCheckErrorMsg="未返回错误信息，可能是下省请求超时，请返回填单页面并稍后重试订单提交。"}}var al=L(ai);E(al)}},fail:function(aj){$.unecOverlay();$.alert("提示","下省校验失败")}})}else{var ag=L(af.data);E(ag)}}}else{$.alertM(af.data);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq()}}})}};var L=function(ac){var ab=contextPath+"/token/pc/order/gotosubmitOrder";$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var aa=$.callServiceAsHtml(ab,JSON.stringify(ac));$.unecOverlay();return aa.data};var O=function(aw){if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){if(OrderInfo.actionFlag==18&&aw.boActionType.actionClassCd==CONST.ACTION_CLASS_CD.OFFER_ACTION){}else{query.offer.loadInst()}a(aw);if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){OrderInfo.orderData.orderList.orderListInfo.soNbr=OrderInfo.order.soNbr}return true}var af=[];var ac=[];var ab="N";if(s()){ab="Y"}ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.THRETOFOUR_ITEM,value:ab});ac.push({itemSpecId:"111111113",value:OrderInfo.orderlonger});ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.BUSITYPE_FLAG,value:OrderInfo.busitypeflag});ac.push({itemSpecId:"30010050",value:OrderInfo.custorderlonger});if(OrderInfo.zcd_privilege==="0"){ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.ZCD_ITEM,value:0})}if(ec.util.isObj(OrderInfo.order.soNbr)){ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.SO_NBR,value:OrderInfo.order.soNbr})}if($("#orderProvAttrIsale").length){order.cust.provIsale=$.trim($("#orderProvAttrIsale").val())}if(ec.util.isObj(order.cust.provIsale)){order.cust.fromProvFlag="1";ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.PROV_ISALE,value:order.cust.provIsale})}else{order.cust.fromProvFlag="0"}if(!S()){return false}var ao=$("#order_remark").val();if(ec.util.isObj(ao)){ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:ao})}if(CONST.getAppDesc()==0){var ae=$.trim($("#orderAttrName").val());var ah=$("#orderIdentidiesTypeCd  option:selected").val();var av=$.trim($("#orderAttrIdCard").val());var ar=$.trim($("#orderAttrAddr").val());var at=$.trim($("#orderAttrPhoneNbr").val());if(ec.util.isObj(ae)&&ec.util.isObj(av)&&ec.util.isObj(at)){if(ec.util.isObj(ae)){ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.orderAttrName,value:ae})}if(ec.util.isObj(av)){ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.orderIdentidiesTypeCd,value:ah});ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.orderAttrIdCard,value:av})}if(ec.util.isObj(at)){ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.orderAttrPhoneNbr,value:at})}if(ec.util.isObj(ar)){ac.push({itemSpecId:CONST.BUSI_ORDER_ATTR.orderAttrAddr,value:ar})}}else{if(ec.util.isObj(ae)||ec.util.isObj(av)||ec.util.isObj(at)){if(!ec.util.isObj(ae)){$.alert("提示","经办人姓名为空，经办人姓名、联系人号码、证件号码必须同时为空或不为空，因此无法提交！");return false}if(!ec.util.isObj(at)){$.alert("提示","联系人号码为空，经办人姓名、联系人号码、证件号码必须同时为空或不为空，因此无法提交！");return false}if(!ec.util.isObj(av)){$.alert("提示","证件号码为空，经办人姓名、联系人号码、证件号码必须同时为空或不为空，因此无法提交！");return false}}}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){D(af)}else{if(OrderInfo.actionFlag==2){offerChange.changeOffer(af)}else{if(OrderInfo.actionFlag==3){P(af);if(af.length==0){$.alert("提示","没有做任何业务，无法提交");return false}}else{if(OrderInfo.actionFlag==4){Y(af,aw)}else{if(OrderInfo.actionFlag==5){o(af,aw)}else{if(OrderInfo.actionFlag==6){A(af)}else{if(OrderInfo.actionFlag==7){M(af,aw)}else{if(OrderInfo.actionFlag==8){k(af,aw)}else{if(OrderInfo.actionFlag==9){y(af,aw)}else{if(OrderInfo.actionFlag==10){af=aw}else{if(OrderInfo.actionFlag==11){af=aw}else{if(OrderInfo.actionFlag==12){af=aw}else{if(OrderInfo.actionFlag==16){h(af)}else{if(OrderInfo.actionFlag==19){OrderInfo.actionClassCd=OrderInfo.orderItemCd;i(af,aw,"N")}else{if(OrderInfo.actionFlag==20){M(af,aw)}else{if(OrderInfo.actionFlag==21){X(af,aw)}else{if(OrderInfo.actionFlag==22){af=aw}else{if(OrderInfo.actionFlag==23){af=aw;OrderInfo.orderData.orderList.orderListInfo.areaId=OrderInfo.staff.areaId;var ad=$("#custInfos").attr("corCustId");if(ec.util.isObj(ad)){var ap={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_CUST_ID,value:ad};ac.push(ap)}var am=$("#custInfos").attr("extCustId");if(ec.util.isObj(am)){var an={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_CUST_ID,value:am};ac.push(an)}var au=order.prodModify.choosedProdInfo.extProdInstId;if(ec.util.isObj(au)){var al={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_PROD_INST_ID,value:au};ac.push(al)}var aa=order.prodModify.choosedProdInfo.corProdInstId;if(ec.util.isObj(aa)){var ak={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_PROD_INST_ID,value:aa};ac.push(ak)}var aq=order.prodModify.choosedProdInfo.extCouponInstanceId;if(ec.util.isObj(aq)){var aj={itemSpecId:CONST.BUSI_ORDER_ATTR.EXT_COUPON_INST_ID,value:aq};ac.push(aj)}var ag=order.prodModify.choosedProdInfo.corCouponInstanceId;if(ec.util.isObj(ag)){var ai={itemSpecId:CONST.BUSI_ORDER_ATTR.COR_COUPON_INST_ID,value:ag};ac.push(ai)}}else{i(af,aw,"N")}}}}}}}}}}}}}}}}}}OrderInfo.orderData.orderList.orderListInfo.custOrderAttrs=ac;OrderInfo.orderData.orderList.orderListInfo.extCustOrderId=OrderInfo.provinceInfo.provIsale;OrderInfo.orderData.orderList.custOrderList[0].busiOrder=af;if($("#isTemplateOrder").attr("checked")=="checked"){OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="Y";OrderInfo.orderData.orderList.orderListInfo.templateOrderName=$("#templateOrderName").val();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){OrderInfo.orderData.orderList.orderListInfo.templateType=$("#templateOrderDiv").find("select").val()}else{if(OrderInfo.actionFlag==2){OrderInfo.orderData.orderList.orderListInfo.templateType=5}else{if(OrderInfo.actionFlag==3){OrderInfo.orderData.orderList.orderListInfo.templateType=2
}}}}else{OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="N"}if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){OrderInfo.orderData.orderList.orderListInfo.soNbr=OrderInfo.order.soNbr}return true};var a=function(ac){var ad=ac.coupons;OrderInfo.getOrderData();var aa=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;if(OrderInfo.cust.custId==-1){OrderInfo.createCust(aa)}else{if(OrderInfo.cust.custId!=undefined&&OrderInfo.cust.custId!=""){OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId}else{OrderInfo.orderData.orderList.orderListInfo.partyId=CONST.CUST_COUPON_SALE}}if(OrderInfo.actionFlag==18){OrderInfo.orderData.orderList.orderListInfo.partyId=ad[0].partyId}var ab={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:ac.busiObj,boActionType:ac.boActionType,data:{bo2Coupons:[]}};ab.data.bo2Coupons=ad;if(ac.dealers){ab.data.busiOrderAttrs=ac.dealers}aa.push(ab)};var E=function(ah){SoOrder.step(2,ah);SoOrder.delOrderBegin();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$("#orderTbody").append("<tr><td >套餐名称：</td><td>"+OrderInfo.offerSpec.offerSpecName+"</td></tr>");var ak=$("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName+"<span class='showhide'></span>");$("#tital").append(ak);$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){$("#orderTbody").append("<tr ><td>"+this.offerRoleName+"号码：</td><td>"+OrderInfo.getProdAn(this.prodInstId).accessNumber+"</td></tr> ")})});if(order.service.oldMemberFlag){for(var ag=0;ag<OrderInfo.oldoffer.length;ag++){for(var ai=0;ai<OrderInfo.oldoffer[ag].offerMemberInfos.length;ai++){var af=OrderInfo.oldoffer[ag].offerMemberInfos[ai];if(af.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+af.accessNumber+"</td></tr> ")}}}}}else{if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#orderedprod").hide();$("#order_prepare").hide();$("#order_tab_panel_content").hide();$("#orderTbody").append("<tr><td >终端名称：</td><td>"+OrderInfo.businessName+"</td></tr>");var aa=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;var ac=undefined;if(OrderInfo.actionFlag==13){for(var ai=0;ai<aa.length;ai++){var al=aa[ai].boActionType;if(al.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&al.boActionTypeCd==CONST.BO_ACTION_TYPE.COUPON_SALE){ac=aa[ai].data.bo2Coupons}}$("#orderTbody").append("<tr><td >终端串码：</td><td>"+ac[0].couponInstanceNumber+"</td></tr>")}else{if(OrderInfo.actionFlag==17){for(var ai=0;ai<aa.length;ai++){var al=aa[ai].boActionType;if(al.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&al.boActionTypeCd==CONST.BO_ACTION_TYPE.RETURN_COUPON){ac=aa[ai].data.bo2Coupons}}$("#orderTbody").append("<tr><td >终端串码：</td><td>"+ac[0].couponInstanceNumber+"</td></tr>")}else{if(OrderInfo.actionFlag==18){for(var ai=0;ai<aa.length;ai++){var al=aa[ai].boActionType;if(al.boActionTypeCd==CONST.BO_ACTION_TYPE.EXCHANGE_COUPON){ac=aa[ai].data.bo2Coupons}}var ab=null;var ad=null;if(ac[0].state=="DEL"){ab=ac[0];ad=ac[1]}else{ab=ac[1];ad=ac[0]}$("#orderTbody").append("<tr><td >旧终端串码：</td><td>"+ab.couponInstanceNumber+"</td></tr>");$("#orderTbody").append("<tr><td >新终端串码：</td><td>"+ad.couponInstanceNumber+"</td></tr>")}}}var ak=$("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName+"<span class='showhide'></span>");$("#tital").append(ak)}else{var aj=order.prodModify.choosedProdInfo;$("#orderTbody").append("<tr id='offerSpecName'><td >套餐名称：</td><td>"+aj.prodOfferName+"</td></tr>");$("#orderTbody").append("<tr id='accNbrTr'><td>手机号码：</td><td>"+aj.accNbr+"</td></tr> ");if(OrderInfo.actionFlag==2){OrderInfo.actionTypeName="套餐变更";$("#orderTbody").append("<tr><td >新套餐名称：</td><td>"+OrderInfo.offerSpec.offerSpecName+"</td></tr>");$("#accNbrTr").hide();for(var ai=0;ai<OrderInfo.offer.offerMemberInfos.length;ai++){var af=OrderInfo.offer.offerMemberInfos[ai];if(af.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append("<tr ><td>"+af.roleName+"号码：</td><td>"+af.accessNumber+"</td></tr> ")}}if(offerChange.newMemberFlag){$.each(OrderInfo.boProdAns,function(){$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+this.accessNumber+"</td></tr> ")})}if(offerChange.oldMemberFlag){for(var ag=0;ag<OrderInfo.oldoffer.length;ag++){for(var ai=0;ai<OrderInfo.oldoffer[ag].offerMemberInfos.length;ai++){var af=OrderInfo.oldoffer[ag].offerMemberInfos[ai];if(af.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+af.accessNumber+"</td></tr> ")}}}}}else{if(OrderInfo.actionFlag==3){OrderInfo.actionTypeName="订购/退订可选包与功能产品"}else{if(OrderInfo.actionFlag==4||OrderInfo.actionFlag==8){$("#offerSpecName").hide();$("#accNbrTr").hide()}else{if(OrderInfo.actionFlag==5){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.isRemove=="Y"){$("#orderTbody").append("<tr ><td>拆除副卡号码：</td><td>"+this.accessNumber+"</td></tr> ")}else{$("#orderTbody").append("<tr ><td>"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==6){$("#accNbrTr").hide();if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){$("#orderTbody").append("<tr><td >新套餐名称：</td><td>"+this.offerSpecName+"</td></tr>")})}$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append("<tr ><td>"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}});$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var ao="";var an="";var ap=this.objInstId;$.each(x,function(aq,ar){if(ar.objInstId==ap&&ar.knew=="Y"){ao="Y"}if(ar.objInstId==ap&&ar.del=="Y"){an="Y"}});if(ao=="Y"){$("#orderTbody").append("<tr ><td>订购"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}else{if(an=="Y"){$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}}}}});$.each(OrderInfo.boProdAns,function(){$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+this.accessNumber+"</td></tr> ")});if(ec.util.isArray(OrderInfo.oldAddNumList)){for(var ai=0;ai<OrderInfo.oldAddNumList.length;ai++){$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+OrderInfo.oldAddNumList[ai].accNbr+"</td></tr> ")}}OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==7){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}else{var an="";var ao=this.accessNumber;$.each(x,function(ap,aq){if(aq.accessNumber==ao&&aq.del=="N"){an="N"}});if(an=="N"){$("#orderTbody").append("<tr ><td>订购"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}else{$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}}}});OrderInfo.actionTypeName=CONST.getBoActionTypeName(OrderInfo.boActionTypeCd)}else{if(OrderInfo.actionFlag==21){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){$("#orderTbody").append("<tr><td >新套餐名称：</td><td>"+this.offerSpecName+"</td></tr>")})}$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var ao="";var an="";var ap=this.objInstId;$.each(x,function(aq,ar){if(ar.objInstId==ap&&ar.knew=="Y"){ao="Y"}if(ar.objInstId==ap&&ar.del=="Y"){an="Y"}});if(ao=="Y"){$("#orderTbody").append("<tr ><td>订购"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}else{if(an=="Y"){$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}}}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==20){$("#accNbrTr").hide();for(var ai=0;
ai<OrderInfo.offer.offerMemberInfos.length;ai++){var af=OrderInfo.offer.offerMemberInfos[ai];if(af.objType==CONST.OBJ_TYPE.PROD){if(af.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append("<tr ><td>拆除"+af.roleName+"号码：</td><td>"+af.accessNumber+"</td></tr> ")}else{$("#orderTbody").append("<tr ><td>订购"+af.roleName+"号码：</td><td>"+af.accessNumber+"</td></tr> ")}}}OrderInfo.actionTypeName="返销"}else{if(OrderInfo.actionFlag==12){$("#accNbrTr").hide();for(var ai=0;ai<OrderInfo.confirmList.length;ai++){var aj=OrderInfo.confirmList[ai];for(var ag=0;ag<aj.accNbr.length;ag++){$("#orderTbody").append("<tr><td >"+aj.name+"：</td><td>"+aj.accNbr[ag]+"</td></tr>")}}}else{if(OrderInfo.actionFlag==16){OrderInfo.actionTypeName="改号";$.each(OrderInfo.boProdAns,function(){if(this.state=="ADD"){$("#orderTbody").append("<tr id='accNbrTr'><td>新号码：</td><td>"+this.accessNumber+"</td></tr> ")}})}else{if(OrderInfo.actionFlag==0&&OrderInfo.actionTypeName=="拆机"){$("#accNbrTr").hide();var am="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&this.objInstId==order.prodModify.choosedProdInfo.prodInstId){am="Y"}});if(am=="Y"){$.each(OrderInfo.offer.offerMemberInfos,function(){$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")})}OrderInfo.actionTypeName="拆机"}}}}}}}}}}}var ak=$("<span>"+OrderInfo.actionTypeName+"</span>");$("#tital").append(ak)}}var ae=true;if($("#ruleTbody tr").length>0){$("#ruleTbody tr").each(function(){var an=$(this).attr("ruleLevel");if(an=="1"){ae=false;return false}})}if(ae){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){Q()}else{if(OrderInfo.actionFlag==2){Z()}else{if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22){f()}else{if(OrderInfo.actionFlag==6){p()}else{if(OrderInfo.actionFlag==21&&order.memberChange.getSimulateData()){W()}else{if(OrderInfo.orderResult.autoBoInfos!=undefined&&OrderInfo.orderResult.autoBoInfos.length>0){$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));$.each(OrderInfo.orderResult.autoBoInfos,function(){$("#chooseTable").append($('<tr><td width="50%">'+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))})}}}}}}}};var V=function(aa,ac){for(var ab=1;ab<4;ab++){$("#step"+ab).hide()}$("#step"+aa).show()};var G=function(aa,ac){if(aa==0){$("#orderedprod").hide();$("#order_prepare").hide();$("#order_fill_content").hide();$("#order_tab_panel_content").html(ac).show();aa++}else{if(aa==1){$("#orderedprod").hide();$("#order_prepare").hide();$("#order_tab_panel_content").hide();$("#order_confirm").hide();$("#order_fill_content").show()}else{if(aa==2){$("#custModifyId").attr("style","display: none;");$("#main_conetent").hide();$("#order_fill_content").hide();$("#order_tab_panel_content").hide();$("#order_confirm").html(ac).show()}}}for(var ab=1;ab<4;ab++){$("#step"+ab).hide()}$("#step"+aa).show()};var Q=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr>"));m(this.prodInstId)})})};var p=function(){if(ec.util.isArray(OrderInfo.oldoffer)){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.roleName+")</th><th>业务动作</th></tr>"));m(this.objInstId)}})})}else{$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr>"));$.each(this.prodInsts,function(){m(this.prodInstId)})}})}};var Z=function(){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.roleName+")</th><th>业务动作</th></tr>"));m(this.objInstId)}});$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd==401){$.each(this.prodInsts,function(){var aa='"'+this.prodInstId+'"';if(aa.indexOf("-")!=-1){m(this.prodInstId)}})}});if(offerChange.oldMemberFlag){$.each(OrderInfo.oldoffer,function(){$.each(this.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){m(this.objInstId)}})})}};var W=function(){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){$("#chooseTable").append($('<tr><th width="50%">业务名称(基础移动电话)</th><th>业务动作</th></tr>'));m(this.prodId)})}};var f=function(){var aa=order.prodModify.choosedProdInfo;if(aa==undefined||aa.prodInstId==undefined){return true}$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));m(aa.prodInstId)};var m=function(af){var ae=CacheData.getOfferSpecList(af);var ab=CacheData.getOfferList(af);var aa=CacheData.getServSpecList(af);var ad=CacheData.getServList(af);var ac=CacheData.getOpenAppList(af);if(ae!=undefined&&ae.length>0){$.each(ae,function(){if(this.isdel!="Y"&&this.isdel!="C"){if(ec.util.isObj(this.counts)){for(var ag=0;ag<this.counts;ag++){$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_BUY+"</td></tr>"))}}else{$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_BUY+"</td></tr>"))}}})}if(ab!=undefined&&ab.length>0){$.each(ab,function(){if(this.isdel=="Y"){if(ec.util.isObj(this.counts)){for(var ah=0;ah<this.counts;ah++){$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_DEL+"</td></tr>"))}}else{$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_DEL+"</td></tr>"))}}else{if(this.update=="Y"){$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_UPDATE+"</td></tr>"))}else{if(ec.util.isObj(this.orderCount)&&ec.util.isObj(this.counts)){if(this.orderCount<this.counts){for(var ag=0;ag<(this.counts-this.orderCount);ag++){$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_BUY+"</td></tr>"))}}}}}})}if(aa!=undefined&&aa.length>0){$.each(aa,function(){if(this.isdel!="Y"&&this.isdel!="C"){$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(ad!=undefined&&ad.length>0){$.each(ad,function(){if(this.isdel=="Y"){$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_CLOSE+"</td></tr>"))}else{if(this.update=="Y"){$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_UPDATE+"</td></tr>"))}}})}if(ac!=undefined&&ac.length>0){$.each(ac,function(){if(this.dfQty==1){$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(OrderInfo.orderResult.autoBoInfos!=undefined){$.each(OrderInfo.orderResult.autoBoInfos,function(){if(this.instAccessNumber==OrderInfo.getAccessNumber(af)){$("#chooseTable").append($('<tr><td width="50%">'+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))}for(var ag=0;ag<OrderInfo.oldprodInstInfos.length;ag++){if(this.instAccessNumber==OrderInfo.oldprodInstInfos[ag].accNbr&&OrderInfo.oldprodInstInfos[ag].prodInstId==af){$("#chooseTable").append($('<tr><td width="50%">'+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))}}})}};var C=function(){if(CONST.getAppDesc()==0&&OrderInfo.actionFlag==3){var ad=order.prodModify.choosedProdInfo.prodClass;var ac=order.prodModify.choosedProdInfo.prodInstId;var ab=CacheData.getOfferSpecList(ac);var aa=false;if(ec.util.isArray(ab)){$.each(ab,function(){if(this.ifPackage4G=="Y"&&this.isdel!="Y"&&this.isdel!="C"){aa=true;return false}})}if(aa&&ad==CONST.PROD_CLASS.THREE){AttachOffer.reductionChangList(ac)}}SoOrder.delOrderFin();$("#order_fill_content").show();$("#main_conetent").show();if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#order_tab_panel_content").show()
}$("#order_confirm").hide();SoOrder.showStep(1);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();SoOrder.delOrder();J();if(CONST.getAppDesc()!=0){$("#custModifyId").show()}};var K=function(aa){if(aa==undefined){aa=OrderInfo.orderResult.olId}if(aa!=0&&aa!=undefined){var ab={olId:aa,areaId:OrderInfo.getAreaId()};$.callServiceAsJsonGet(contextPath+"/token/pc/order/delOrder",ab,{done:function(ac){if(ac.code==0){if(ac.data.resultCode==0){$.alert("提示","购物车作废成功！")}}else{if(ac.code==-2){$.alertM(ac.data)}else{$.alert("提示","购物车作废失败！")}}},fail:function(ac){$.alert("提示","信息","请求可能发生异常，请稍后再试")}})}};var R=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,OrderInfo.orderResult.olId);$("a[href^='/']").off("mousedown").on("mousedown",function(){SoOrder.delOrderSilent();window.location.href=this.href});$(window).off("unload").on("unload",function(){SoOrder.delOrderSilent()})};var F=function(){var ae=$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID);$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);if(ae!=0&&ae!=undefined&&ae!=null){var ag={olId:ae,areaId:OrderInfo.getAreaId(),flag:"U"};var aa=$.callServiceAsJsonGet(contextPath+"token/pc/order/delOrder",ag);var af=[];for(var ad=0;ad<OrderInfo.boProdAns.length;ad++){var ac={accNbr:OrderInfo.boProdAns[ad].accessNumber,accNbrType:1,action:"UPDATE"};af.push(ac)}if(af.length>0){var ab=contextPath+"/common/updateResState";$.callServiceAsJsonGet(ab,{strParam:JSON.stringify(af)},{done:function(ah){if(ah.code==0){if(ah.data){}}}})}OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();J();SoOrder.delOrderFin()}};var B=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);$("a[href^='/']").off("mousedown");$(window).off("unload")};var o=function(aa,ac){var ab=order.prodModify.choosedProdInfo;var ad={offerSpecId:ab.prodOfferId,offerId:ab.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:ac};OrderInfo.getOfferBusiOrder(aa,ad,ac[0].objInstId);$.each(ac,function(){var ae={prodId:this.objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};aa.push(OrderInfo.getProdBusiOrder(ae));$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.objInstId==prodId){this.isRemove="Y";return false}})})};var X=function(an,af){var aa="";var ao=af.viceParam;x=ao;var ak=af.ooRoles;var am=order.prodModify.choosedProdInfo;var ac={offerSpecId:am.prodOfferId,offerId:am.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:af.ooRoles};$.each(OrderInfo.offer.offerMemberInfos,function(ap){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){aa=this.objInstId;return false}});OrderInfo.getOfferBusiOrder(an,ac,aa);for(var ag=0;ag<ao.length;ag++){if(ao[ag].knew=="Y"){var ab=ao[ag];var ah="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==ab.objInstId){ah=this.accessNumber}});var aj={areaId:am.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ab.offerSpecId,objName:ab.offerSpecName,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};if(ec.util.isObj(ah)){aj.busiObj.accessNumber=ah}for(var ae=0;ae<OrderInfo.offer.offerMemberInfos.length;ae++){var ad=OrderInfo.offer.offerMemberInfos[ae];if(ad.objInstId==ab.objInstId){var ak={objId:ad.objId,objInstId:ad.objInstId,objType:ad.objType,offerRoleId:ab.offerRoleId,state:"ADD"};aj.data.ooRoles.push(ak);break}}var ai=$("tr[name='tr_"+ab.offerSpecId+"']");if(ai!=undefined){aj.data.busiOrderAttrs=[];ai.each(function(){var ap={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+ab.offerSpecId+"']").val()};aj.data.busiOrderAttrs.push(ap);var aq={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};aj.data.busiOrderAttrs.push(aq)})}an.push(aj)}else{var al={prodId:ao[ag].objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};an.push(OrderInfo.getProdBusiOrder(al))}}if(order.memberChange.getSimulateData()){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){var ap=this.prodId;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(ap==this.objInstId&&this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var aq={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var ar=OrderInfo.getProdBusiOrder(aq);if(ar){an.push(ar)}}}})}})}AttachOffer.setAttachBusiOrder(an)}};var i=function(aj,af,ad){var ah=order.prodModify.choosedProdInfo;var ag=OrderInfo.boActionTypeCd;var ac=ah.productId;var ae=ah.prodInstId;var ai=OrderInfo.actionClassCd;var ab="1";if(ag==CONST.BO_ACTION_TYPE.ADDOREXIT_COMP){ac=ah.prodOfferId;ae=ah.prodOfferInstId;ai=CONST.ACTION_CLASS_CD.OFFER_ACTION}if(ag==CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){ac=OrderInfo.buyBack_orderItemObjId;ae=OrderInfo.buyBack_orderItemObjInstId;ab="2"}var aa={areaId:OrderInfo.getProdAreaId(ah.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ac,instId:ae,isComp:ad,accessNumber:ah.accNbr,offerTypeCd:ab},boActionType:{actionClassCd:ai,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};if(ag==CONST.BO_ACTION_TYPE.BUY_BACK_CHANGE_CARD||ag==CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){aa.boRelas=OrderInfo.boRelas}aa.data=af;aj.push(aa)};var D=function(ad){if(OrderInfo.cust.custId==-1){OrderInfo.createCust(ad)}var ab=$("#acctSelect").find("option:selected").attr("value");if(ab<0&&ab!=undefined){OrderInfo.createAcct(ad,ab)}var ae=r(ad);for(var ac=0;ac<ae.data.ooRoles.length;ac++){var aa=ae.data.ooRoles[ac];if(aa.objType==2&&aa.memberRoleCd!=undefined){ad.push(q(aa.objInstId,aa.objId))}}AttachOffer.setAttachBusiOrder(ad)};var J=function(){var aa=$.callServiceAsHtmlGet(contextPath+"/token/pc/common/getToken");OrderInfo.order.token=aa.data};var c=function(){var aa=$.callServiceAsHtmlGet(contextPath+"/token/pc/common/getToken");OrderInfo.order.token=aa.data};var A=function(ak){var av=order.prodModify.choosedProdInfo;var aj={areaId:av.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:av.prodOfferId,instId:av.prodOfferInstId,accessNumber:av.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP},data:{ooRoles:[]}};if(ec.util.isArray(OrderInfo.oldprodInstInfos)){var aq="";for(var ar=0;ar<OrderInfo.offerSpec.offerRoles.length;ar++){var ao=OrderInfo.offerSpec.offerRoles[ar];if(ao.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){aq=ao.offerRoleId;break}}var ab=(OrderInfo.hasMainCarFlag)?CONST.BO_ACTION_TYPE.DEL_OFFER:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;for(var am=0;am<OrderInfo.oldprodInstInfos.length;am++){var al=OrderInfo.oldprodInstInfos[am];var ac={areaId:al.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:al.mainProdOfferInstInfos[0].prodOfferId,instId:al.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:al.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var aw=-1;for(var ar=0;ar<OrderInfo.oldoffer.length;ar++){if(OrderInfo.oldoffer[ar].accNbr==al.accNbr){$.each(OrderInfo.oldoffer[ar].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var ax={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:aw,offerRoleId:aq,state:"ADD"};aj.data.ooRoles.push(ax);var ay={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};
ac.data.ooRoles.push(ay);--aw}})}}ak.push(ac)}if(CONST.getAppDesc()==0){for(var ar=0;ar<OrderInfo.oldoffer.length;ar++){$.each(OrderInfo.oldoffer[ar].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var ax={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var ay=OrderInfo.getProdBusiOrder(ax);if(ay){ak.push(ay)}}}})}}}if(order.memberChange.newMemberFlag){for(var ar=0;ar<OrderInfo.offerSpec.offerRoles.length;ar++){var ao=OrderInfo.offerSpec.offerRoles[ar];if(ao.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(ao.prodInsts!=undefined&&ao.prodInsts.length>0){for(var ap=0;ap<ao.prodInsts.length;ap++){var ae=ao.prodInsts[ap];var af={objId:ae.objId,objInstId:ae.prodInstId,objType:ae.objType,offerMemberId:OrderInfo.SEQ.offerMemberSeq--,offerRoleId:ae.offerRoleId,state:"ADD"};aj.data.ooRoles.push(af);ak.push(q(ae.prodInstId,ae.objId))}}}}}if(order.memberChange.changeMemberFlag){var ah=order.memberChange.viceparams;var ad=order.memberChange.ooRoless;var av=order.prodModify.choosedProdInfo;$.each(ad,function(){aj.data.ooRoles.push(this)});for(var ar=0;ar<ah.length;ar++){if(ah[ar].knew=="Y"){var aa=ah[ar];var ai="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==aa.objInstId){ai=this.accessNumber}});var at={areaId:av.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aa.offerSpecId,objName:aa.offerSpecName,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};if(ec.util.isObj(ai)){at.busiObj.accessNumber=ai}for(var ap=0;ap<OrderInfo.offer.offerMemberInfos.length;ap++){var an=OrderInfo.offer.offerMemberInfos[ap];if(an.objInstId==aa.objInstId){var ad={objId:an.objId,objInstId:an.objInstId,objType:an.objType,offerRoleId:aa.offerRoleId,state:"ADD"};at.data.ooRoles.push(ad);break}}var au=$("tr[name='tr_"+aa.offerSpecId+"']");if(au!=undefined){at.data.busiOrderAttrs=[];au.each(function(){var ax={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};at.data.busiOrderAttrs.push(ax);var ay={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};at.data.busiOrderAttrs.push(ay)})}ak.push(at)}else{var ag={prodId:ah[ar].objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};ak.push(OrderInfo.getProdBusiOrder(ag))}}if(order.memberChange.getSimulateData()){if(ec.util.isArray(OrderInfo.viceOfferSpec)){$.each(OrderInfo.viceOfferSpec,function(){var ax=this.prodId;if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){$.each(OrderInfo.offer.offerMemberInfos,function(){if(ax==this.objInstId&&this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var ay={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var az=OrderInfo.getProdBusiOrder(ay);if(az){ak.push(az)}}}})}})}}}AttachOffer.setAttachBusiOrder(ak);ak.push(aj)};var M=function(ao,ap){var aq=ap;var ah="";var ab=true;var an=CONST.ACTION_CLASS_CD.OFFER_ACTION;var am=CONST.BO_ACTION_TYPE.DEL_OFFER;var ac=CONST.ACTION_CLASS_CD.OFFER_ACTION;var al=CONST.BO_ACTION_TYPE.BUY_OFFER;if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){an=CONST.ACTION_CLASS_CD.PROD_ACTION;am=CONST.BO_ACTION_TYPE.BUY_BACK;ac=CONST.ACTION_CLASS_CD.OFFER_ACTION;al=CONST.BO_ACTION_TYPE.BUY_OFFER;v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.BUY_BACK;aq=ap.viceParam;ah=ap.remark}else{if(OrderInfo.actionFlag==7){v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.REMOVE_PROD}}for(var ag=0;ag<aq.length;ag++){var ad=aq[ag];if(ad.del=="N"){ab=false}}if(ab){x=aq;var aa={areaId:OrderInfo.getProdAreaId(order.prodModify.choosedProdInfo.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,objId:order.prodModify.choosedProdInfo.productId,instId:order.prodModify.choosedProdInfo.prodInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:order.prodModify.choosedProdInfo.prodStateCd,state:"DEL"},{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};ao.push(aa);for(var ag=0;ag<aq.length;ag++){var ad=aq[ag];var aa={areaId:OrderInfo.getProdAreaId(ad.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:ad.accessNumber,objId:ad.objId,instId:ad.objInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};ao.push(aa)}return}if(OrderInfo.actionFlag==7){x=aq;var ak=order.prodModify.choosedProdInfo;var aa={areaId:OrderInfo.getProdAreaId(ak.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ak.prodOfferId,instId:ak.prodOfferInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:an,boActionTypeCd:am},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"DEL"}]}};for(var ag=0;ag<OrderInfo.offer.offerMemberInfos.length;ag++){var af=OrderInfo.offer.offerMemberInfos[ag];var aj={objId:af.objId,objInstId:af.objInstId,objType:af.objType,offerMemberId:af.offerMemberId,offerRoleId:af.offerRoleId,state:"DEL"};aa.data.ooRoles.push(aj)}ao.push(aa)}else{var ak=order.prodModify.choosedProdInfo;var aa={areaId:OrderInfo.getProdAreaId(ak.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ak.productId,instId:ak.prodInstId,accessNumber:ak.accNbr,isComp:"N"},boActionType:{actionClassCd:an,boActionTypeCd:am},data:{boProdStatuses:[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};ao.push(aa)}for(var ag=0;ag<aq.length;ag++){var ad=aq[ag];if(ad.del=="N"){var ai={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ad.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:ac,boActionTypeCd:al},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};for(var ae=0;ae<OrderInfo.offer.offerMemberInfos.length;ae++){var af=OrderInfo.offer.offerMemberInfos[ae];if(af.objInstId==ad.objInstId){var aj={objId:af.objId,objInstId:af.objInstId,objType:af.objType,offerRoleId:ad.offerRoleId,state:"ADD"};ai.data.ooRoles.push(aj);break}}ao.push(ai)}else{var aa={areaId:OrderInfo.getProdAreaId(ad.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:ad.accessNumber,objId:ad.objId,instId:ad.objInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};ao.push(aa)}}};var P=function(ab){AttachOffer.setAttachBusiOrder(ab);var ac=order.prodModify.choosedProdInfo;if(AttachOffer.isChangeUim(ac.prodInstId)){if(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0){var aa={prodId:ac.prodInstId,prodSpecId:ac.productId,isComp:"N",accessNumber:ac.accNbr,boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};
ab.push(OrderInfo.getProdBusiOrder(aa))}}};var Y=function(aa,ac){var ab={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};ab.data=ac;aa.push(ab)};var y=function(ab,ad){var ac={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};ac.data=ad;ab.push(ac);var aa={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,objId:order.prodModify.choosedProdInfo.productId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACTIVERETURNTWO},data:{}};aa.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.READY_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.DONE_PROD,state:"ADD"}];ab.push(aa)};var k=function(aa,ac){var ab={areaId:OrderInfo.getAreaId(),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};ab.data=ac;aa.push(ab)};var r=function(am){var aa={areaId:OrderInfo.getProdAreaId(-1),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.offerSpec.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[],busiOrderAttrs:[]}};var af=OrderInfo.getAccessNumber(-1);if(ec.util.isObj(af)){aa.busiObj.accessNumber=af}$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var aq={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,memberRoleCd:this.memberRoleCd,offerRoleId:this.offerRoleId,state:"ADD"};aa.data.ooRoles.push(aq);var ap=this.prodInstId;if(this.servInsts!=undefined&&this.servInsts.length>0){$.each(this.servInsts,function(){var ar={objId:this.objId,objInstId:OrderInfo.SEQ.servSeq--,objType:this.objType,prodId:ap,offerRoleId:this.offerRoleId,state:"ADD"};aa.data.ooRoles.push(ar)})}})});if(order.service.oldMemberFlag){var ag="";for(var ai=0;ai<OrderInfo.offerSpec.offerRoles.length;ai++){var an=OrderInfo.offerSpec.offerRoles[ai];if(an.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ag=an.offerRoleId;break}}for(var ac=0;ac<OrderInfo.oldprodInstInfos.length;ac++){var ad=OrderInfo.oldprodInstInfos[ac];var ab={areaId:ad.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ad.mainProdOfferInstInfos[0].prodOfferId,instId:ad.mainProdOfferInstInfos[0].prodOfferInstId,accessNumber:ad.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER},data:{ooRoles:[]}};var al=-1;for(var ai=0;ai<OrderInfo.oldoffer.length;ai++){if(OrderInfo.oldoffer[ai].accNbr==ad.accNbr){$.each(OrderInfo.oldoffer[ai].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var ap={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:al,offerRoleId:ag,state:"ADD"};aa.data.ooRoles.push(ap);var aq={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerMemberId:this.offerMemberId,offerRoleId:this.offerRoleId,state:"DEL"};ab.data.ooRoles.push(aq);--al}})}}am.push(ab)}if(CONST.getAppDesc()==0){for(var ai=0;ai<OrderInfo.oldoffer.length;ai++){$.each(OrderInfo.oldoffer[ai].offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){var ap={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var aq=OrderInfo.getProdBusiOrder(ap);if(aq){am.push(aq)}}}})}}}var aj=OrderInfo.offerSpec.offerSpecParams;if(aj!=undefined&&aj.length>0){aa.data.ooParams=[];for(var ai=0;ai<aj.length;ai++){var ae=aj[ai];var ah={itemSpecId:ae.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:ae.offerSpecParamId,value:ae.value,state:"ADD"};aa.data.ooParams.push(ah)}}if(OrderInfo.offerSpec.ooTimes!=undefined){aa.data.ooTimes=[];aa.data.ooTimes.push(OrderInfo.offerSpec.ooTimes)}var ao={partyId:OrderInfo.cust.custId,state:"ADD"};aa.data.ooOwners.push(ao);var ak=$("#dealerTbody tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");if(ak!=undefined){ak.each(function(){var ap={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()};aa.data.busiOrderAttrs.push(ap);var aq={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};aa.data.busiOrderAttrs.push(aq)})}am.push(aa);return aa};var q=function(ai,ao){var ab={areaId:OrderInfo.getProdAreaId(ai),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ao,instId:ai,isComp:"N"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:"1"},data:{boProdFeeTypes:[],boProdSpecs:[{prodSpecId:ao,state:"ADD"}],boCusts:[],boProdItems:[],boProdPasswords:[],boProdAns:[],bo2Coupons:[],boAccountRelas:[],boProdStatuses:[],busiOrderAttrs:[]}};var ae=CONST.PROD_STATUS_CD.NORMAL_PROD;if($("#isActivation").attr("checked")=="checked"){ae=CONST.PROD_STATUS_CD.DONE_PROD}else{if($("#isTemplateOrder").attr("checked")=="checked"){if($("#templateOrderDiv").find("select").val()==0){ae=CONST.PROD_STATUS_CD.READY_PROD}}}ab.data.boProdStatuses.push({state:"ADD",prodStatusCd:ae});var ac=OrderInfo.boProdAns;for(var ah=0;ah<ac.length;ah++){if(ac[ah].prodId==ai){ab.data.boProdAns.push(ac[ah]);ab.busiObj.accessNumber=ac[ah].accessNumber;break}}var am=OrderInfo.boProd2Tds;for(var ah=0;ah<am.length;ah++){if(am[ah].prodId==ai){ab.data.bo2Coupons.push(am[ah]);break}}ab.data.boCusts.push({partyId:OrderInfo.cust.custId,partyProductRelaRoleCd:"0",state:"ADD"});var ak=$("#pwd_"+ai).val();if(ak=="******"){ak=order.main.genRandPass6()}var af={prodPwTypeCd:2,pwd:ak,state:"ADD"};ab.data.boProdPasswords.push(af);$("[name=prodSpec_"+ai+"]").each(function(){var aq=$(this).attr("id").split("_")[0];var at=false;for(var ar=0;ar<ab.data.boProdItems.length;ar++){if(ab.data.boProdItems[ar].itemSpecId==aq){at=true;break}}if(!at){var av=$.trim($(this).val());if(av!=""&&av!=undefined){var au={itemSpecId:aq,prodSpecItemId:OrderInfo.SEQ.itemSeq--,state:"ADD",value:av};ab.data.boProdItems.push(au)}}});var al=$('select[name="pay_type_-1"]').val();if(al!=undefined){ab.data.boProdFeeTypes.push({feeType:al,state:"ADD"})}var aj;var ag;if(OrderInfo.actionFlag==6){ag=ai;aj=$("tr[name='tr_"+ai+"']")}else{ag=OrderInfo.offerSpec.offerSpecId;aj=$("#dealerTbody tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']")}if(aj!=undefined){aj.each(function(){var aq={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid"),channelNbr:$(this).find("select[name ='dealerChannel_"+ag+"']").val()};ab.data.busiOrderAttrs.push(aq);var ar={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER_NAME,role:$(this).find("select").val(),value:$(this).find("input").attr("value")};ab.data.busiOrderAttrs.push(ar)})}var aa=$("#acctSelect").find("option:selected");var an=aa.attr("value");var ap=-1;if(an==undefined){an=-1;ap=-1}else{if(an<0){ap=an}else{ap=aa.attr("acctcd")}}var ad={acctId:an,acctCd:ap,acctRelaTypeCd:"1",chargeItemCd:"0",percent:"100",priority:"1",state:"ADD"};ab.data.boAccountRelas.push(ad);return ab};var H=function(ad,ac,aa,ab){if(aa==1){ad.offerTypeCd=2;ad.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;OrderInfo.getOfferBusiOrder(ab,ad,ac)
}else{if(aa==2){if(ad.offerSpec.offerSpecParams!=undefined&&ad.offerSpec.offerSpecParams.length>0){ad.offerTypeCd=2;ad.boActionTypeCd=CONST.BO_ACTION_TYPE.UPDATE_OFFER;OrderInfo.getOfferBusiOrder(ab,ad,ac)}}else{ad.offerTypeCd=2;ad.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;ad.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(ab,ad,ac)}}};var T=function(ab,ad,aa,ac){ab.prodId=ad;if(aa==1){ab.servClose="Y";ab.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;ac.push(OrderInfo.getProdBusiOrder(ab))}else{if(aa==2){if(ab.prodSpecParams!=undefined&&ab.prodSpecParams.length>0){ab.boActionTypeCd=CONST.BO_ACTION_TYPE.PRODUCT_PARMS;ab.memberId=ab.servId;ac.push(OrderInfo.getProdBusiOrder(ab))}}else{ab.servId=OrderInfo.SEQ.servSeq--;ab.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;ac.push(OrderInfo.getProdBusiOrder(ab))}}};var h=function(aa){var ab={};ab.boProdAns=OrderInfo.boProdAns;OrderInfo.setProdModifyBusiOrder(aa,ab)};var S=function(){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14||(OrderInfo.actionFlag==2&&offerChange.newMemberFlag)){if(OrderInfo.cust.custId==""){$.alert("提示","客户信息不能为空！");return false}if(OrderInfo.order.dealerTypeList==undefined||OrderInfo.order.dealerTypeList.length==0){$.alert("提示","发展人类型不能为空！");return false}if(ec.util.isArray(OrderInfo.oldprodAcctInfos)){for(var aM=0;aM<OrderInfo.oldprodAcctInfos.length;aM++){var ai=OrderInfo.oldprodAcctInfos[aM].prodAcctInfos[0].acctId;var ak=$("#acctSelect option:selected").val();if(ai!=ak){$.alert("提示","副卡和主卡的账户不一致！");return false}}}if(order.service.oldMemberFlag){var af=$('select[name="pay_type_-1"]').val();var aC=0;var aH="";$.each(OrderInfo.oldprodInstInfos,function(){if(this.feeType.feeType!=af){aC=1;aH=this.accNbr;return}});if(aC==1){}}if(!(order.memberChange.oldMemberFlag&&!order.memberChange.newMemberFlag&&!order.memberChange.changeMemberFlag)&&!(!order.memberChange.oldMemberFlag&&!order.memberChange.newMemberFlag&&order.memberChange.changeMemberFlag)){for(var aI=0;aI<OrderInfo.offerSpec.offerRoles.length;aI++){var aJ=OrderInfo.offerSpec.offerRoles[aI];var al=OrderInfo.offerSpec.offerRoles[aI].prodInsts;if(al!=undefined&&al!=null&&al!=""){for(var aG=0;aG<aJ.prodInsts.length;aG++){var ap=aJ.prodInsts[aG];if(OrderInfo.actionFlag==2){var au='"'+ap.prodInstId+'"';if(ap.memberRoleCd=="401"&&au.indexOf("-")!=-1){var am=OrderInfo.getProdAn(ap.prodInstId).accessNumber;var aA=$("#pwd_"+ap.prodInstId).val();if(aA!="******"){if(!order.main.passwordCheckVal(aA,am)){return false}}if(am==undefined||am==""){$.alert("信息提示","【接入产品("+aJ.offerRoleName+")】号码不能为空！");return false}if(OrderInfo.getProdTd(ap.prodInstId)==""&&(OrderInfo.zcd_privilege!=0||OrderInfo.actionFlag==14)){$.alert("信息提示","【接入产品("+aJ.offerRoleName+")】UIM卡不能为空！");$("#uim_txt_"+ap.prodInstId).css("border-color","red");return false}}}else{var am=OrderInfo.getProdAn(ap.prodInstId).accessNumber;var aA=$("#pwd_"+ap.prodInstId).val();if(aA!="******"){if(!order.main.passwordCheckVal(aA,am)){return false}}if(am==undefined||am==""){$.alert("信息提示","【接入产品("+aJ.offerRoleName+")】号码不能为空！");return false}if(OrderInfo.getProdTd(ap.prodInstId)==""&&(OrderInfo.zcd_privilege!=0||OrderInfo.actionFlag==14)){$.alert("信息提示","【接入产品("+aJ.offerRoleName+")】UIM卡不能为空！");$("#uim_txt_"+ap.prodInstId).css("border-color","red");return false}}var ay=false;$("[name='pay_type_-1']").each(function(){if($(this).val()!=undefined&&$(this).val()!=null&&$(this).val()!=""){ay=true}});if(!ay){$.alert("信息提示","没有配置付费类型，无法提交");return false}var ar=false;var az=false;var ag=null;var aB=null;$(OrderInfo.prodAttrs).each(function(){var aO=this.id;if(!ar){if(this.isOptional=="N"&&aO){var aN=$.trim($("#"+aO).val());if(aN==""||aN==undefined){ag=this.name;ar=true}}}if(!az){if($("[id='"+aO+"']").length>1){aB=this.name;az=true}}});if(ar){$.alert("信息提示","没有配置产品属性("+ag+")，无法提交");return false}if(az){$.alert("信息提示","产品属性("+aB+")重复，无法提交");return false}if(!order.main.templateTypeCheck()){return false}}}}}var aa=true;if(order.memberChange.oldMemberFlag||offerChange.oldMemberFlag){for(var aI=0;aI<OrderInfo.oldoffer.length;aI++){$.each(OrderInfo.oldoffer[aI].offerMemberInfos,function(){var aO=this;if(aO.objType==CONST.OBJ_TYPE.PROD){if(AttachOffer.isChangeUim(aO.objInstId)){var aN=OrderInfo.getProdTd(aO.objInstId);if(aN==""){$.alert("提示","加装移动电话"+aO.accessNumber+" UIM卡不能为空！");aa=false;return false}}}});if(!aa){break}}if(!aa){return}}var aj=$("#acctSelect").val();if(aj==undefined||$.trim(aj)==""){$.alert("提示","请新建或者查询选择一个可用帐户");return false}if(aj<0){if(!t()){return false}}}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(OrderInfo.boProd2OldTds.length==0){$.alert("提示","原UIM卡信息为空！");return false}if(OrderInfo.boProd2Tds.length==0&&OrderInfo.zcd_privilege!=0){$.alert("提示","UIM卡不能为空！");return false}if(OrderInfo.actionFlag==22&&OrderInfo.boProd2Tds[0].cardTypeFlag==1&&order.prodModify.choosedProdInfo.productId!="280000000"&&OrderInfo.isSuccess=="N"){$.alert("提示","可选包加载失败！不能正常受理业务！");return false}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==3||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14||OrderInfo.actionFlag==21||OrderInfo.actionFlag==22){for(var aI=0;aI<OrderInfo.checkUimData.length;aI++){var ao=OrderInfo.checkUimData[aI];if(ao.isWireBusi==1){$.alert("提示","选择的UIM卡为【"+ao.uimCode+"+"+ao.uimName+"】，无法办理移动电话产品，请使用普通UIM卡办理业务。");return false}else{if(ao.isWireBusi==2){$.alert("提示","选择的UIM卡为【"+ao.uimCode+"+"+ao.uimName+"】，无法办理天翼宽带-无线上网产品，请使用数据卡类型的UIM卡办理业务。");return false}}}for(var aI=0;aI<AttachOffer.openList.length;aI++){var aw=AttachOffer.openList[aI].specList;var an=OrderInfo.getOfferRoleName(AttachOffer.openList[aI].prodId);for(var aG=0;aG<aw.length;aG++){var ah=aw[aG];if(ah.isdel!="Y"&&ah.isdel!="C"){if(ah.ifParams){if(ah.isset!="Y"){$.alert("提示",an+" "+ah.offerSpecName+"：参数未设置");return false}}}}}for(var aI=0;aI<AttachOffer.openServList.length;aI++){var aw=AttachOffer.openServList[aI].servSpecList;var an=OrderInfo.getOfferRoleName(AttachOffer.openServList[aI].prodId);for(var aG=0;aG<aw.length;aG++){var ah=aw[aG];if(ah.isdel!="Y"&&ah.isdel!="C"){if(ah.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){if("no"==$("#isMIFI_-"+(aI+1)).val()){$.alert("提示","要开通"+ah.servSpecName+"功能，请选择4G上网卡-全球卡（MIFI卡）！");$("#uim_txt_-"+(aI+1)).css("border-color","red");return false}}if(ah.ifParams=="Y"){if(ah.isset!="Y"){$.alert("提示",an+" "+ah.servSpecName+"：参数未设置");return false}}}}}for(var aI=0;aI<AttachOffer.openList.length;aI++){var aw=AttachOffer.openList[aI].specList;var aD=AttachOffer.openList[aI].prodId;var an=OrderInfo.getOfferRoleName(aD);for(var aG=0;aG<aw.length;aG++){var ah=aw[aG];if(ah.isdel!="Y"&&ah.isdel!="C"){if(ah.isTerminal==1){var aL=ah.agreementInfos[0].minNum;var aq=ah.agreementInfos[0].maxNum;var av=0;var ay=true;var ad=false;var ax=$("input[id^=terminalText_"+aD+"_"+ah.offerSpecId+"]");ax.each(function(){var aO=false;var aN=$.trim(this.value);if(ec.util.isObj(aN)){var aP=aD+"_"+ah.offerSpecId;if(AttachOffer.checkData(aP,aN)){ad=true;return false}$.each(OrderInfo.attach2Coupons,function(){if(ah.offerSpecId==this.attachSepcId&&aD==this.prodId){var aQ=this.couponInstanceNumber;if($.trim(aQ)==aN){av++;aO=true;ay=false;return false}}})}if(!aO){ay=true;return false}});if(ad){return false}if(av<aL){$.alert("提示",an+" "+ah.offerSpecName+"：合约终端数必须不小于"+aL);return false}if(ay){$.alert("提示",an+" "+ah.offerSpecName+"：终端信息未填写全");return false}}}}if(CONST.getAppDesc()==0){if(OrderInfo.actionFlag==2){for(var aI=0;aI<OrderInfo.offer.offerMemberInfos.length;aI++){var aE=OrderInfo.offer.offerMemberInfos[aI];if(aE.objType==CONST.OBJ_TYPE.PROD){if(AttachOffer.isChangeUim(aE.objInstId)){var ac=OrderInfo.getProdTd(aE.objInstId);if(ac==""){$.alert("提示",aE.roleName+" UIM卡不能为空！");return false}}}}}else{if(OrderInfo.actionFlag==3){if(AttachOffer.isChangeUim()){if(OrderInfo.boProd2Tds.length==0){$.alert("提示","UIM卡不能为空！");return false}}}else{if(OrderInfo.actionFlag==6){if(ec.util.isArray(OrderInfo.viceOfferSpec)){var ay=false;$.each(OrderInfo.viceOfferSpec,function(){var aO=this.prodId;
for(var aN=0;aN<OrderInfo.offer.offerMemberInfos.length;aN++){var aQ=OrderInfo.offer.offerMemberInfos[aN];if(aO==aQ.objInstId&&aQ.objType==CONST.OBJ_TYPE.PROD){if(AttachOffer.isChangeUim(aQ.objInstId)){var aP=OrderInfo.getProdTd(aQ.objInstId);if(aP==""){$.alert("提示","基础移动电话 "+aQ.accessNumber+" UIM卡不能为空！");ay=true;return false}}}}});if(ay){return false}}}}}}}if(CONST.getAppDesc()==0){if(OrderInfo.getAreaId()==null||OrderInfo.getAreaId().indexOf("811")!=0){for(var aI=0;aI<AttachOffer.openServList.length;aI++){var aw=AttachOffer.openServList[aI].servSpecList;var ay=false;var ae=false;$.each(aw,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G&&this.isdel!="Y"&&this.isdel!="C"){ay=true;return false}});var aD=AttachOffer.openServList[aI].prodId;var aK=[];if(AttachOffer.openList[aI]!=undefined){var aF=AttachOffer.openList[aI].specList;for(var aG=0;aG<aF.length;aG++){var ah=aF[aG];if(ah.isdel!="Y"&&ah.isdel!="C"){if(ah.isTerminal==1){$.each(OrderInfo.attach2Coupons,function(){if(aD==this.prodId){ae=true;if(ec.util.isObj(this.termTypeFlag)){var aN={termTypeFlag:this.termTypeFlag};aK.push(aN)}}})}}}}var an=OrderInfo.getOfferRoleName(aD);if(ae&&!ec.util.isArray(aK)&&OrderInfo.zcd_privilege!=0){$.alert("信息提示",an+"中,营销资源未返回终端机型，无法判断是3G终端还是4G终端!");return false}if(ay){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||order.memberChange.newMemberFlag||order.memberChange.oldMemberFlag){var ab=OrderInfo.getProdUim(aD);if(ab.cardTypeFlag=="2"){$.alert("信息提示","您已开通【4G（LTE）上网】功能产品，不能使用3G卡，故无法提交");return false}if(v(aK,ae)){$.alert("信息提示","您已开通【4G（LTE）上网】功能产品，不能使用3G终端，故无法提交");return false}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3||order.memberChange.changeMemberFlag){var at=OrderInfo.getProdOldUim(aD);if(at.is4GCard!="Y"){var ab=OrderInfo.getProdUim(aD);if(ab.cardTypeFlag=="2"){$.alert("信息提示","您已开通【4G（LTE）上网】功能产品，不能使用3G卡，故无法提交");return false}}if(v(aK,ae)){$.alert("信息提示","您已开通【4G（LTE）上网】功能产品，不能使用3G终端，故无法提交");return false}}}}else{}}}}}return true};var v=function(ac,ab){var aa=false;$.each(ac,function(){if(ab&&this.termTypeFlag=="2"){aa=true;return false}});return aa};var t=function(){if($.trim($("#acctName").val())==""){$.alert("提示","帐户名称不能为空");return false}if($("#paymentType").val()==110000){if($("#bankId").val()==""||$.trim($("#bankAcct").val())==""||$.trim($("#paymentMan").val())==""){$.alert("提示","若选择银行支付请填写必要的银行支付信息");return false}}if($("#postType").val()!=-1){if($.trim($("#postAddress").val())==""){$.alert("提示","若选择投递账单请填写必要的账单投递信息");return false}if($("#postType").val()==13){var aa=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;if(aa.test($("#postAddress").val())==false){$.alert("提示","若选择 Email 投递帐单请输入有效的 Email 地址");return false}}}return true};var b=function(){var ad=[];for(var ac=0;ac<OrderInfo.boProdAns.length;ac++){var ab={accNbr:OrderInfo.boProdAns[ac].accessNumber,accNbrType:1,action:"UPDATE"};ad.push(ab)}for(var ac=0;ac<OrderInfo.boProd2Tds.length;ac++){var ab={accNbr:OrderInfo.boProd2Tds[ac].terminalCode,accNbrType:2,action:"UPDATE"};ad.push(ab)}if(ad.length>0){var aa=contextPath+"/common/updateResState";$.callServiceAsJsonGet(aa,{strParam:JSON.stringify(ad)},{done:function(ae){if(ae.code==0){if(ae.data){}}}})}};var l=function(aa){if($("#isTemplateOrder").attr("checked")=="checked"){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$(".template_info_type").show();$("#isActivation").removeAttr("checked");$("#isActivation").attr("disabled","disabled")}$(".template_info_name").show()}else{$(".template_info_name").hide();$(".template_info_type").hide();$("#templateOrderName").val("");$("#isActivation").removeAttr("disabled")}};var g=function(){if($("#isActivation").attr("checked")=="checked"){$("#isTemplateOrder").removeAttr("checked");$("#isTemplateOrder").attr("disabled","disabled");$(".template_info_name").hide();$(".template_info_type").hide();$("#templateOrderName").val("")}else{$("#isTemplateOrder").removeAttr("disabled")}};var w=function(ad){var ab=[];for(var aa=0;aa<ad.offerRoles.length;aa++){var ac=ad.offerRoles[aa];if(ac.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){ab.push(ac)}}for(var aa=0;aa<ad.offerRoles.length;aa++){var ac=ad.offerRoles[aa];if(ac.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){ab.push(ac)}}ad.offerRoles=ab;return ad};var j=function(){var aa=false;var ae=order.prodModify.choosedProdInfo.prodClass;var ad=order.prodModify.choosedProdInfo.prodInstId;var ab=CacheData.getOfferSpecList(ad);if(ec.util.isArray(ab)){$.each(ab,function(){if(this.ifPackage4G=="Y"&&this.isdel!="Y"&&this.isdel!="C"){aa=true;return false}})}if(CONST.getAppDesc()==0&&aa&&ae==CONST.PROD_CLASS.THREE&&OrderInfo.actionFlag==3){if(offerChange.checkOrder()){var ac=offerChange.checkAttachOffer(ad);if(ac!=""){if(S()){$("#offer_serv").html(ac);easyDialog.open({container:"offer_dialog"})}}else{SoOrder.submitOrder()}}}else{SoOrder.submitOrder()}};var N=function(){var aa=order.prodModify.choosedProdInfo.prodInstId;AttachOffer.setChangeList(aa);SoOrder.submitOrder();easyDialog.close()};var s=function(){var ae=order.prodModify.choosedProdInfo.is3G;if(OrderInfo.actionFlag==2){var ac=OrderInfo.offerSpec.is3G;if(ec.util.isObj(ae)){if(ec.util.isObj(ac)){if(ae=="Y"&&ac=="N"){return true}}}}else{if(OrderInfo.actionFlag==3){if(ec.util.isObj(ae)){if(ae=="Y"){for(var ad=0;ad<AttachOffer.openServList.length;ad++){var ab=AttachOffer.openServList[ad].servSpecList;var aa=false;$.each(ab,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G&&this.isdel!="Y"&&this.isdel!="C"){aa=true;return false}});if(aa){return true}}}}}}return false};return{builder:U,createAttOffer:H,createServ:T,delOrder:K,delAndNew:M,getOrderInfo:O,getToken:J,getTokenSynchronize:c,initFillPage:n,initOrderData:I,orderBack:C,step:G,showStep:V,submitOrder:z,checkAcctInfo:t,showTemplateOrderName:l,sortOfferSpec:w,updateResState:b,delOrderBegin:R,delOrderSilent:F,delOrderFin:B,showActivation:g,checkOrder:j,orderPrepare:N,getCheckOperatSpec:u,createProd:q}})();CommonUtils.regNamespace("common","print");common.print=(function(h){var s=function(N){var P=h("a[olId="+N+"]").attr("ifPrint");if(CONST.getAppDesc()==0&&"N"==P){var K=h("#tab_orderList tr[olId="+N+"]");var O="";var C=[];var E="false";for(var H=0;H<K.length;H++){var M=K[H];var J=h(M).attr("actionClass");if(J=="1600"){continue}E=h(M).attr("newProdFlag");if(E=="true"){break}var D=h(M).attr("objInstId");if(D==undefined||D==""){h.alert("提示","objInstId为空，请核查接口返回的数据！");return false}var I=h(M).attr("accessNumber");if(I==undefined||I==""){h.alert("提示","accessNumber为空，请核查接口返回的数据！");return false}}for(var H=0;E=="false"&&H<K.length;H++){var M=K[H];var J=h(M).attr("actionClass");if(J=="1600"){continue}var D=h(M).attr("objInstId");var I=h(M).attr("accessNumber");if(h.inArray(D,C)>=0){continue}O=h(M).attr("areaId");OrderInfo.orderResult.olNbr=h(M).attr("olNbr");var L="";OrderInfo.order.soNbr=UUID.getDataId();var F={areaId:O,acctNbr:I,custId:L,soNbr:OrderInfo.order.soNbr,instId:D,type:"2"};var G=query.offer.invokeLoadInst(F);if(!G){h.alert("提示","加载订单回执信息失败");return false}C.push(D)}h("a[olId="+N+"]").attr("ifPrint","Y")}if(OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olId=N;return true};var v=function(D,F){s(D);var E={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr};if(g("_session_pad_flag")=="1"){var C=new Array(3);if(ec.util.browser.versions.android){C[0]="order/sign/downVoucher"}else{C[0]="print/iosVoucher"}C[1]="voucherInfo";C[2]=JSON.stringify(E);MyPlugin.printShow(C,function(G){},function(G){})}else{h("<form>",{id:"voucherForm",style:"display:none;",target:"_blank",method:"POST",action:contextPath+"/order/sign/downVoucher"}).append(h("<input>",{id:"voucherInfo",name:"voucherInfo",type:"hidden",value:JSON.stringify(E)})).appendTo("body").submit()}};var x=function(E){var D="0";if(g("_session_pad_flag")=="1"){D="1"}else{h.alert("提示","目前只支持客户端的数字签名,请在客户端登录!");return}E.PcFlag=D;var C=contextPath+"/order/sign/previewForSign";
h.callServiceAsJson(C,E,{before:function(){h.ecOverlay("<strong>生成回执预览的html,请稍等会儿....</strong>")},always:function(){h.unecOverlay()},done:function(F){if(F.code==0){if(D=="1"){SignPlugin.datasign(F.data,JSON.stringify(E),function(){},function(){})}}else{if(F.code==-2){h.alertM(F.data)}else{h.alert("提示","生成回执预览的html失败!")}}},fail:function(F){h.unecOverlay();h.alert("提示","服务忙，请稍后再试！")}})};var z=function(C,E){if(!s(C)){return}var D={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:E};common.print.printVoucher(D)};var u=function(D){h("#voucherForm").remove();if(g("_session_pad_flag")=="1"){var C=new Array(3);if(ec.util.browser.versions.android){C[0]="/token/pc/print/voucher"}else{C[0]="print/iosVoucher"}C[1]="voucherInfo";C[2]=JSON.stringify(D);MyPlugin.printShow(C,function(E){},function(E){})}else{h("<form>",{id:"voucherForm",style:"display:none;",target:"_blank",method:"POST",action:contextPath+"/token/pc/print/voucher"}).append(h("<input>",{id:"voucherInfo",name:"voucherInfo",type:"hidden",value:JSON.stringify(D)})).appendTo("body").submit()}};var j=function(Q,D,P){var I=h("a[olId="+Q+"]").attr("ifInvoice");var R=h("a[olId="+Q+"]").attr("areaId");if(CONST.getAppDesc()==0&&"N"==I){var M=h("#tab_orderList tr[olId="+Q+"]");var C=[];var F="false";for(var J=0;J<M.length;J++){var O=M[J];var L=h(O).attr("actionClass");if(L=="1600"){continue}F=h(O).attr("newProdFlag");if(F=="true"){break}var E=h(O).attr("objInstId");if(E==undefined||E==""){h.alert("提示","objInstId为空，请核查接口返回的数据！");return}var K=h(O).attr("accessNumber");if(K==undefined||K==""){h.alert("提示","accessNumber为空，请核查接口返回的数据！");return}}for(var J=0;F=="false"&&J<M.length;J++){var O=M[J];var L=h(O).attr("actionClass");if(L=="1600"){continue}var E=h(O).attr("objInstId");var K=h(O).attr("accessNumber");if(h.inArray(E,C)>=0){continue}R=h(O).attr("areaId");OrderInfo.orderResult.olNbr=h(O).attr("olNbr");var N="";OrderInfo.order.soNbr=UUID.getDataId();var G={areaId:R,acctNbr:K,custId:N,soNbr:OrderInfo.order.soNbr,instId:E,type:"2"};var H=query.offer.invokeLoadInst(G);if(!H){return}C.push(E)}h("a[olId="+Q+"]").attr("ifInvoice","Y")}if(OrderInfo.order.soNbr==undefined||OrderInfo.order.soNbr==""){OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olNbr=D;OrderInfo.orderResult.olId=Q;var G={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,billType:0,printFlag:P,areaId:R,acctItemIds:[]};common.print.prepareInvoiceInfo(G)};var o=function(){if(common.print.dialogForm!=undefined&&common.print.dialog!=undefined){common.print.dialogForm.close(common.print.dialog)}};var f=function(G){h.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");var D=contextPath+"/print/getInvoiceItems";var C=h.callServiceAsJson(D,G,{});h.unecOverlay();if(!C){h.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return false}if(C.code==-2){h.alertM(C.data);return false}if(C.code!=0){h.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return false}if(C.data.resultCode!="0"){h.alert("提示",C.data.resultMsg);return false}if(C.data.chargeItems==undefined||C.data.chargeItems.length==0){h.alert("提示","没有可打印的费用项");return false}else{var E=0;for(;E<C.data.chargeItems.length;E++){var F=C.data.chargeItems[E];if(F.paymentAmount!=0){break}}if(E==C.data.chargeItems.length){h.alert("提示","没有可打印的费用项");return false}}return C};var l=function(E){var F={staffId:OrderInfo.staff.staffId,areaId:OrderInfo.staff.areaId,custSoNbr:OrderInfo.orderResult.olNbr,custOrderId:OrderInfo.orderResult.olId,invoiceType:E};var D=contextPath+"/print/getInvoiceInfo";var C=h.callServiceAsJson(D,F,{});if(!C){return false}if(C.code==-2){h.alertM(C.data);return false}if(C.code!=0){return false}if(C.data.invoiceInfos!=undefined&&C.data.invoiceInfos instanceof Array&&C.data.invoiceInfos.length>0){}else{return false}return C};var p=function(C){if(OrderInfo.cust.norTaxPayer=="Y"){h.alert("提示","客户为一般纳税人，请到省份CRM系统打印专用增值税发票！");h.confirm("提示信息","客户为一般纳税人，专用增值税发票需要到省份CRM系统打印。是否只打印普通发票?",{yes:function(){i(C)},no:function(){return}},"question")}else{i(C)}};var i=function(H){var E=f(H);if(!E){return}I(100);function I(W){var Y=l(W);if(Y){var X=Y.data.invoiceInfos;if(ec.util.isArray(X[0].invoiceInfos)){h("#invoiceNbrInp").val(X[0].invoiceInfos[0].invoiceNbr);h("#invoiceNumInp").val(X[0].invoiceInfos[0].invoiceNum)}else{h("#invoiceNbrInp").val(X[0].invoiceNbr);h("#invoiceNumInp").val(X[0].invoiceNum)}}}var R=E.data.invoiceInfos;if(R!=undefined&&R instanceof Array&&R.length>0){}else{var V={soNbr:OrderInfo.order.soNbr,billType:0,olId:H.olId,printFlag:-1,areaId:OrderInfo.staff.areaId,acctItemIds:[]};var D=common.print.initPrintInfo(V);if(!D){return}if(H.printFlag==1){h.alert("信息","此购物车对应的发票未打印过，请到发票补打页面。");return}E=f(H);if(!E){return}}common.print.oldInvoiceFlag="0";if(r(E.data.invoiceInfos,H.printFlag)){return}var G=contextPath+"/print/getInvoiceTemplates";var K={areaId:OrderInfo.staff.areaId};var N=h.callServiceAsJson(G,K,{});if(N.code==-2){h.alertM(N.data);return}else{if(N.code!=0){h.alert("提示",ec.util.defaultStr(N.data,"获取打印模板出错"));return}else{var C=N.data;if(C.resultCode!="POR-0000"){h.alert("提示",ec.util.defaultStr(C.resultMsg,"获取打印模板异常"));return}if(C.length==0){h.alert("提示","没有获取到可用的打印模板");return}var M="";var T=C.tempList;if(typeof T!=undefined&&T.length>0){M+="<option selected='selected' value="+T[0].templateId+">"+T[0].templateName+"</option>";for(var O=1;O<T.length;O++){var S=T[O];M+="<option value="+S.templateId+">"+S.templateName+"</option>"}}h("#tempListSel").html(M)}}var P="";var U=E.data.prodInfo;if(U!=undefined&&U.length>0){P+="<option selected='selected' value="+U[0].accessNumber+">"+U[0].accessNumber+"</option>";for(var O=1;O<U.length;O++){var J=U[O];P+="<option value="+J.accessNumber+">"+J.accessNumber+"</option>"}}h("#acceNbrSel").html(P);var L="";L+="<div id='invoiceContDiv' class='plan_second_list cashier_tr'>";L+="  <table class='contract_list'>";L+="  <thead>";L+="    <tr>";L+="      <td>是否打印</td><td>费用名称</td><td>费用(元)</td><td>税金(元)</td><td>付费方式</td>";L+="    </tr>";L+="  </thead>";L+="  <tbody>";var F=E.data.chargeItems;for(var O=0;O<F.length;O++){var Q=F[O];if(O==0){h("#invoiceTitleInp").val(Q.custName)}if(Q.paymentAmount==0){continue}L+="    <tr acctItemId="+Q.acctItemId+" acctItemTypeId="+Q.acctItemTypeId+" ";L+="        acctItemTypeName='"+Q.acctItemTypeName+"' boActionType='"+Q.boActionType+"' ";L+="        boActionType='"+Q.boActionType+"' boId="+Q.boId+" feeAmount="+Q.feeAmount+" ";L+="        invoiceId="+Q.invoiceId+" objId="+Q.objId+" objType="+Q.objType+" ";L+="        payMethodCd="+Q.payMethodCd+" payMethodName="+Q.payMethodName+" ";L+="        realAmount="+Q.realAmount+" ";L+="        tax="+Q.tax+" taxRate="+Q.taxRate+" >";if(a(Q)){L+="      <td><input type='checkbox' name='invoiceItemsChkBox' checked='checked'/></td>"}else{L+="      <td><input type='checkbox' name='invoiceItemsChkBox' disabled='disabled'/></td>"}L+="      <td>"+Q.acctItemTypeName+"</td>";L+="      <td>"+(Q.realAmount/100).toFixed(2)+"</td>";L+="      <td>"+(Q.tax/100).toFixed(2)+"</td>";L+="      <td>"+Q.payMethodName+"</td>";L+="    </tr>"}L+="  </tbody>";L+="  </table>";L+="</div>";h("#invoiceItemsContDiv").html(L);h("#ec-dialog-form-content").css("height","auto");h("input[name=billType]").off("click").on("click",function(W){if(h("input[name=billType]:checked").val()=="0"){h("#invoiceNbrNumDl").show();h("#titleDt").html("发票抬头：");h("#tempDt").html("发票模板：");h("#codeTitleDt").html("发票代码：");h("#numTitleDt").html("发票号码：");H.billType=0;I(100)}else{h("#invoiceNbrNumDl").hide();h("#titleDt").html("票据抬头：");h("#tempDt").html("票据模板：");h("#codeTitleDt").html("票据代码：");h("#numTitleDt").html("票据号码：");H.billType=1;I(200)}});h("#invoiceItemsConfirm").off("click").on("click",function(W){if(common.print.oldInvoiceFlag!="0"){h.alert("信息","存在未作废发票，请先确定作废发票");return}m(H,E.data)});ec.form.dialog.createDialog({id:"-invoice-items",width:580,zIndex:1100,initCallBack:function(X,W){common.print.dialogForm=X;common.print.dialog=W;h("#invoiceItemsConCancel").off("click").on("click",function(Y){common.print.closePrintDialog()
})},submitCallBack:function(X,W){},closeCallBack:function(X,W){}})};var q=function(I){var D=contextPath+"/print/getInvoiceItems";var F=h.callServiceAsJson(D,I);if(!F){h.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(F.code==-2){h.alertM(F.data);return}if(F.code!=0){h.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(F.data.resultCode!="0"){h.alert("提示",F.data.resultMsg);return}if(F.data.chargeItems==undefined||F.data.chargeItems.length==0){h.alert("提示","没有可打印的费用项");return}var C=y(I,F.data);var E=C.invoiceInfos;var H={invoiceInfos:E};var G=k(H,I.printFlag);if(G==false){return false}E=t(E,G.data.invoiceIds,"0");return E};var c=function(C){if(C=="-1"){return"初始打印"}else{if(C=="0"){return"正常打印"}else{if(C=="1"){return"重打"}else{if(C=="2"){return"补打"}else{return"未知操作"}}}}};var r=function(E,D){if(E!=undefined&&E instanceof Array&&E.length>0){for(var C=0;C<E.length;C++){if(!E[C]){h.alert("信息","接口返回的发票信息不是有效值，请确认。");return true}if(E[C].printFlag=="-1"){if(D=="0"||D=="2"){}else{h.alert("信息","此购物车对应的发票未打印过，请到发票补打页面。");return true}}else{if(E[C].printFlag=="0"){if(E[C].billType=="1"){return false}if(D=="1"){b(E,D)}else{h.alert("信息","此购物车对应的发票正常打印过，只允许重打。");return true}}else{if(E[C].printFlag=="1"||E[C].printFlag=="2"){if(D=="1"){b(E,D)}else{h.alert("信息","此购物车对应的发票已打印过，只允许重打。");return true}}else{h.alert("信息","发票信息中打印标识值不规范");return true}}}}return false}else{if(D=="0"){return false}else{h.alert("信息","此购物车没有对应的发票信息，不能进行补打或重打");return true}}};var b=function(H,F){if(H!=undefined&&H instanceof Array&&H.length>0){h("#invalidInvoiceDiv").remove();var E="";E+='<div class="easyDialogdiv" style="width:481px;height:300px;" id="invalidInvoiceDiv">';E+='  <div class="easyDialogclose" id="invalidInvoiceClose"></div>';E+='  <h5 class="s_title">存在未作废发票，请先作废发票</h5>';E+='  <div class="form-content" id="infoDiv">';E+="  </div>";E+='  <div align="center" style="margin: 20px auto;">';E+='    <a id="invalidInvoiceConfirm" class="btna_o" href="javascript:void(0)"><span >确认</span></a>';E+='    <a id="invalidInvoiceCancel" class="btna_o" style="margin-left:20px;" href="javascript:void(0)"><span>取消</span></a>';E+="  </div>";E+="</div>";h("body").append(E);var C="";var G=[];for(var D=0;D<H.length;D++){var I=H[D];if(h.inArray(I.invoiceId,G)>=0){}else{C+='<div class="marginAndFont">发票代码：'+I.invoiceNbr+"; 发票号码："+I.invoiceNum+"</div><br>";G.push(I.invoiceId)}}if(G.length>0){common.print.oldInvoiceFlag="1";h("#infoDiv").html(C);easyDialog.open({container:"invalidInvoiceDiv"});h("#invalidInvoiceConfirm").off("click").on("click",function(){common.print.oldInvoiceFlag="0";easyDialog.close()});h("#invalidInvoiceCancel").off("click").on("click",function(){easyDialog.close()})}return false}else{return false}};var a=function(C){var D=C.payMethodCd;if(D==CONST.PAYMETHOD_CD.ZHANG_WU_DAI_SHOU){return false}return true};var w=function(D){try{if(D.billType!=1){if(h("#invoiceNbrInp").val()==""){h.alert("提示","请输入发票代码");return true}if(!/^\d{0,12}$/.test(h("#invoiceNbrInp").val())){h.alert("提示","请输入正确的发票代码");return true}if(h("#invoiceNumInp").val()==""){h.alert("提示","请输入发票号码");return true}if(!/^\d{0,12}$/.test(h("#invoiceNumInp").val())){h.alert("提示","请输入正确的发票号码");return true}}if(h("#invoiceTitleInp").val()==""){h.alert("提示","请输入发票抬头");return true}if(h("#invoiceContDiv tbody input:checked").length<1){h.alert("提示","请选择要打印的费用项");return true}}catch(C){return true}return false};var y=function(C,H){var P=[];var L={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"100",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:C.billType,printFlag:C.printFlag,invoiceId:0};var E=false;var G=0;var Q=0;var N=0;var K=[];var D="";var I=H.chargeItems;for(var F=0;F<I.length;F++){var M=I[F];L.acctItemIds.push({acctItemId:M.acctItemId});if(M.objType=="2"){L.instanceType=M.objType;L.instanceId=M.objId;L.paymethod=M.payMethodCd;E=true}else{if(!E&&M.objType=="7"){L.instanceType=M.objType;L.instanceId=M.objId;L.paymethod=M.payMethodCd}}G+=parseInt(M.feeAmount);Q+=parseInt(M.realAmount);N+=parseInt(M.tax);D=M.payMethodName}L.amount=G;L.realPay=Q;L.tax=N;L.account=Q;L.accountUpper=ec.util.atoc(Q);L.invoiceNbr=0;L.invoiceNum="0";var J=H.prodInfo;if(J!=undefined&&J.length>0){L.acctNbr=J[0].accessNumber}P.push(L);var O={payMethodName:D,items:K,invoiceInfos:P};return O};var n=function(C,H){var M=[];var J={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"100",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:C.billType,printFlag:C.printFlag,invoiceId:0};J.invoiceId=H.invoiceInfos[0].invoiceId;J.billType=h("input[name='billType']:checked").val();if(J.billType=="0"){J.invoiceType="100"}else{J.invoiceType="200"}var E=false;var G=0;var N=0;var K=0;var I=[];var D="";var F=B(H);J.acctItemIds=[];h("#invoiceContDiv tbody input:checked").parent().parent().each(function(){J.acctItemIds.push({acctItemId:h(this).attr("acctItemId")});if(h(this).attr("objType")=="2"){J.instanceType=h(this).attr("objType");J.instanceId=h(this).attr("objId");J.paymethod=h(this).attr("payMethodCd");E=true}else{if(!E&&h(this).attr("objType")=="7"){J.instanceType=h(this).attr("objType");J.instanceId=h(this).attr("objId");J.paymethod=h(this).attr("payMethodCd")}}G+=parseInt(h(this).attr("feeAmount"));N+=parseInt(h(this).attr("realAmount"));K+=parseInt(h(this).attr("tax"));var P="";var O=h(this).attr("boId");for(var Q=0;Q<F.length;Q++){if(O==F[Q].boId){P=F[Q].accessNumber}}I.push({itemName:h(this).attr("acctItemTypeName"),charge:parseInt(h(this).attr("realAmount")),tax:parseInt(h(this).attr("tax")),acceNumber:P});D=h(this).attr("payMethodName")});if(OrderInfo.actionFlag==11){J.printFlag=0}J.amount=G;J.realPay=N;J.tax=K;J.account=N;J.accountUpper=ec.util.atoc(N);J.invoiceNbr=h("#invoiceNbrInp").val();J.invoiceNum=""+h("#invoiceNumInp").val();J.acctNbr=h("#acceNbrSel option:selected").val();M.push(J);var L={payMethodName:D,items:I,invoiceInfos:M};return L};var B=function(I){var F=[];var J=I.chargeItems;var K=I.prodInfo;for(var G=0;G<J.length;G++){var M=J[G].boId;for(var D=0;D<K.length;D++){var H=K[D].accessNumber;var L=K[D].busiOrders;for(var C=0;C<L.length;C++){if(L[C].boId==M){var E={boId:M,accessNumber:H};F.push(E)}}}}return F};var m=function(I,F){if(w(I)){return}if(!F.invoiceInfos[0]){h.alert("提示","集团营业受理后台接口返回缺少发票信息，请确认。");return}var C=n(I,F);var E=C.invoiceInfos;var H={invoiceInfos:E};var G=k(H,I.printFlag);if(G==false){return}var D={partyName:h("#invoiceTitleInp").val(),templateId:h("#tempListSel :selected").val(),prodInfo:F.prodInfo,items:C.items,payMethod:C.payMethodName,invoiceInfos:E};A(D);if(OrderInfo.cust.norTaxPayer!="Y"){common.print.closePrintDialog()}return};var k=function(E,D){h.ecOverlay("<strong>正在提交中,请稍等会儿....</strong>");var C=h.callServiceAsJson(contextPath+"/print/saveInvoiceInfo",E);h.unecOverlay();if(C.code==-2){h.alertM(C.data);return false}else{if(C.code!=0||C.data.resultCode!="0"){h.alert("提示",c(D)+"调用集团发票打印处理接口失败，请稍后重试");return false}}return C};var t=function(F,E,D){for(var C=0;C<F.length;C++){F[C].invoiceId=E[C];F[C].printFlag=D}return F};var g=function(E){var D="";var C=document.cookie.match(new RegExp("(^| )"+E+"=([^;]*)(;|$)"));if(C!=null){D=unescape(C[2])}return D};var A=function(D){h("#invoiceForm").remove();if(g("_session_pad_flag")=="1"){var C=new Array(3);if(ec.util.browser.versions.android){C[0]="print/invoice"}else{C[0]="print/iosInvoice"}C[1]="invoiceParam";
C[2]=encodeURI(JSON.stringify(D));MyPlugin.printShow(C,function(E){},function(E){})}else{h("<form>",{id:"invoiceForm",style:"display:none;",target:"_blank",method:"POST",action:contextPath+"/print/invoice"}).append(h("<input>",{id:"invoiceParam",name:"invoiceParam",type:"hidden",value:encodeURI(JSON.stringify(D))})).appendTo("body").submit()}};return{preVoucher:z,printVoucher:u,preInvoice:j,initPrintInfo:q,closePrintDialog:o,prepareInvoiceInfo:p,saveInvoiceInfo:m,chkInput:w,printInvoice:A,preSign:v,signVoucher:x}})(jQuery);$(function(){});CommonUtils.regNamespace("product","query");product.query=(function(){var g="";var k=function(){$("#accurate").attr("checked","checked");$("#num").attr("disabled",false);$("#custName").attr("disabled",true);$("#accurate").change(function(){if($("#accurate").attr("checked")){$("#num").attr("disabled",false);$("#custName").attr("disabled",true)}else{$("#num").attr("disabled",true);$("#custName").attr("disabled",false)}});$(".easyDialogclose").click(function(){easyDialog.close()})};var a=function(){order.area.chooseAreaTreeManger("prod/preProdQuery","p_areaId_val","p_areaId",3)};var i=function(){if($("#p_areaId_val").val()!=""){if($("#p_areaId").val().substring(3,7)=="0000"){$.alert("提示","请选择本地网（地市级）地区进行查询");return}}else{$.alert("提示","请先选择所属地区再进行客户查询");return}easyDialog.open({container:"d_cust"});$("#cust").val("");$("#custlist").html("")};var n=function(){var o={attrSpecCode:"PTY-0004"};$.callServiceAsJson(contextPath+"/staffMgr/getCTGMainData",o,{done:function(q){if(q.code==0){var s=q.data;if(s!=undefined&&s.length>0){for(var r=0;r<s.length;r++){var p=s[r];$("#cust_id_type").append("<option value='"+p.attrValueCode+"' >"+p.attrValueName+"</option>")}}}else{if(q.code==-2){$.alertM(q.data);return}else{$.alert("提示","调用主数据接口失败！");return}}}})};var l=function(p){var o=$(p).val();if(o==0){$("#cust").attr("placeHolder","请输入有效的中国电信手机号");$("#cust").attr("data-validate","validate(isTelecomSection:请输入有效的中国电信号码) on(blur)")}else{if(o==1){$("#cust").attr("placeHolder","请输入合法的身份证号码");$("#cust").attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(blur)")}else{if(o==2){$("#cust").attr("placeHolder","请输入合法的军官证");$("#cust").attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(o==3){$("#cust").attr("placeHolder","请输入合法的护照");$("#cust").attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#cust").attr("placeHolder","请输入合法的证件号码");$("#cust").attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}}$("#cust").val("");b()};var b=function(){$("#custQueryForm").off().bind("formIsValid",function(s,r){var o="";var q="";var p="";if($("#cust_id_type").val()==0){o=$("#cust").val()}else{p=$("#cust_id_type").val();q=$("#cust").val()}var t={acctNbr:o,identityCd:p,identityNum:q,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:"maybe",areaId:$("#p_areaId").val(),query:"prod"};$.callServiceAsHtml(contextPath+"/cust/queryCust",t,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(u){if(u.code!=0){$.alert("提示","查询失败,稍后重试");return}if(u.data.indexOf("false")>=0){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}$("#custlist").html(u.data).show()},fail:function(u){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")}})}).ketchup({bindElement:"bt_cust_query"})};var j=function(p){var q=$(p).find("td:eq(0)").text();var o=$(p).find("td:eq(3)").text();$("#custName").val(q).attr("name",o);easyDialog.close()};var c=function(s){var r=1;if(s>0){r=s}var q=12;var t={curPage:r,pageSize:q,areaId:$("#p_areaId").val()};if($("#accurate").attr("checked")){if($("#p_areaId_val").val()!=""){if($("#p_areaId").val().substring(3,7)=="0000"){$.alert("提示","请选择本地网（地市级）地区进行查询");return}}else{$.alert("提示","请先选择所属地区再进行客户查询");return}var p=$.trim($("#num").val());var o=/^(180|189|133|134|153|181|108|170|177)\d{8}$/.test(p);if(o==false){$.alert("提示","若要进行精确查询，请输入有效的中国电信手机号");return}t.acctNbr=p}else{if($("#custName").val()==""){$.alert("提示","请先定位客户再进行查询");return}var u=$("#custName").attr("name");t.custId=u;t.acctNbr=""}$.callServiceAsHtmlGet(contextPath+"/prod/prodQuery",t,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(v){if(!v){v.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(v.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(v.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#prodList").html(v.data).show();$("#prodDetail").hide()},fail:function(v){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var h=function(o,q,p){var r={prodId:o,acctNbr:q,areaId:p};$.callServiceAsHtmlGet(contextPath+"/prod/prodDetailQuery",r,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(s){if(!s){s.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(s.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(s.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#prodDetail").html(s.data).show();$("#prodInfo h2").html("产品详情");$("#prodInfo").show();$("#prodList").hide();$("#orderedprod").hide();$("#orderContent").hide()},fail:function(s){$.unecOverlay();$.alert("提示","请求可能发生异常，请稍后再试！")}})};var m=function(o){$("#acct_tab").find("li[class=setcon]").removeClass();$("#acct_tab_"+o).addClass("setcon");$("#acct_div").find("div[class=show]").removeClass().hide();$("#acct_div_"+o).addClass("show").show()};var f=function(){$("#prodDetail").hide();$("#prodInfo").hide();$("#prodList").show();$("#orderedprod").show();$("#orderContent").show()};return{init:k,areaId:g,chooseArea:a,showQueryCust:i,initCustIdType:n,changeCustIdType:l,queryCust:b,chooseCust:j,queryProduct:c,queryProdDetail:h,changeAcct:m,back:f}})();$(function(){product.query.init();product.query.initCustIdType();product.query.queryCust()});CommonUtils.regNamespace("prod","transferModify");prod.transferModify=(function(){var b="";var w={};var s="";var k={};var x=function(){OrderInfo.busitypeflag=15;var C="";s=CONST.BO_ACTION_TYPE.TRANSFER;C="ADD";var D=order.prodModify.getCallRuleParam(s,order.prodModify.choosedProdInfo.prodInstId);var A={boActionTypeCd:s,boActionTypeName:CONST.getBoActionTypeName(s),accessNumber:"",prodOfferName:"",state:C};var B=rule.rule.prepare(D,"prod.transferModify.custTransfer",A);if(B){return}};var q=function(){OrderInfo.busitypeflag=0;var C="";s=CONST.BO_ACTION_TYPE.TRANSFERRETURN;C="ADD";var D=order.prodModify.getCallRuleParam(s,order.prodModify.choosedProdInfo.prodInstId);var A={boActionTypeCd:s,boActionTypeName:CONST.getBoActionTypeName(s),accessNumber:"",prodOfferName:"",state:C};var B=rule.rule.prepare(D,"prod.transferModify.custTransfer",A);if(B){return}};var y=function(){var D=$("#litransCustId").attr("transCustId");var K=-1;if(D!=""){K=D}var N=$("#litransCustId").attr("transCustName");var G=$("#litransCustId").attr("transAddressStr");var M=$("#div_tra_identidiesTypeCd option:selected").val();var B=$("#litransidCardNumber").attr("transidCardNumber");if(D==OrderInfo.cust.custId){$.alert("提示","同一客户，无需过户，请确认！","information");return}if(B==undefined||D==undefined){$.alert("提示","未定位目标客户，请先定位！","information");return}if(!$("#acctSelect").val()){$.alert("提示","请新建或者查询选择一个可用帐户");return}if($("#acctSelect").val()<0){if(!SoOrder.checkAcctInfo()){return}}var O=$("#acctSelect").val();var P=-1;if(O>0){P=$("#acctSelect").find("option:selected").attr("acctcd")}SoOrder.builder();var J={prodId:order.prodModify.choosedProdInfo.prodInstId,acctNbr:order.prodModify.choosedProdInfo.accNbr,areaId:order.prodModify.choosedProdInfo.areaId};var F=$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",J);if(F.code!=0||F.data.length==0){if(F.code==-2){$.alertM(F.data)}else{$.alert("提示","当前产品帐户定位失败，请联系管理员")}return}var H=F.data[0];var Q=true;if(H.acctId==O){Q=false}if(H.priority==""){H.priority=1}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,s,10,CONST.getBoActionTypeName(s),"");
var A=[];if(D==""){var E={areaId:order.prodModify.choosedProdInfo.areaId,boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.CUST_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.CUST_CREATE},busiObj:{instId:-1},busiOrderInfo:{seq:OrderInfo.SEQ.seq--},data:{boCustIdentities:[{identidiesTypeCd:M,identityNum:B,defaultIdType:M,state:"ADD"}],boCustInfos:[{areaId:order.prodModify.choosedProdInfo.areaId,businessPassword:"111111",name:N,addressStr:G,partyTypeCd:1,state:"ADD"}]}};A.push(E)}var C={areaId:order.prodModify.choosedProdInfo.areaId,boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:s},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,isComp:"N",objId:order.prodModify.choosedProdInfo.productId,offerTypeCd:"1"},busiOrderInfo:{seq:OrderInfo.SEQ.seq--},data:{boCusts:[{partyId:order.prodModify.choosedProdInfo.custId,partyProductRelaRoleCd:0,state:"DEL"},{partyId:K,partyProductRelaRoleCd:0,state:"ADD"}],busiOrderAttrs:[{itemSpecId:"111111118",value:$("#order_remark").val()}]}};A.push(C);if(s==CONST.BO_ACTION_TYPE.TRANSFERRETURN){var L={areaId:order.prodModify.choosedProdInfo.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,objId:order.prodModify.choosedProdInfo.productId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACTIVERETURNTWO},data:{}};L.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.READY_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.DONE_PROD,state:"ADD"}];A.push(L)}if($("#acctSelect").val()==-1){OrderInfo.createAcct(A,-1)}if(Q){var I={areaId:order.prodModify.choosedProdInfo.areaId,boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,isComp:"N",objId:order.prodModify.choosedProdInfo.productId,offerTypeCd:"1"},busiOrderInfo:{seq:OrderInfo.SEQ.seq--},data:{boAccountRelas:[{acctCd:H.acctCd,acctId:H.acctId,acctRelaTypeCd:1,chargeItemCd:H.chargeItemCd,percent:H.percent,priority:H.priority,prodAcctId:H.prodAcctId,state:"DEL"},{acctCd:P,acctId:O,acctRelaTypeCd:1,chargeItemCd:1,percent:100,priority:1,prodAcctId:-1,state:"ADD"}]}};A.push(I);SoOrder.submitOrder(A)}else{$.confirm("提示信息","只更换了所属客户，而没有更换付费帐户<br/>确定吗？",{yes:function(){SoOrder.submitOrder(A)},no:function(){return}},"question")}};var a=function(B){var A=$(B).val();$("#div_tra_identidiesTypeCd").empty();v(A);c($("#div_tra_identidiesTypeCd").children(":first-child"))};var g=function(A){if(A=="1"){var B='<select id="tra_IdentidiesTypeCd" onchange="order.transferModify.identidiesTypeCdChoose(this)"><option value="1" >身份证</option><option value="2">军官证</option></select>'}else{if(A=="2"){var B='<select id="tra_IdentidiesTypeCd" onchange="order.transferModify.identidiesTypeCdChoose(this)"><option value="3">护照</option><option value="23">ICP经营许可证</option><option value="39">税务登记号</option></select>'}}$("#div_tra_identidiesTypeCd").html(B)};var c=function(A){var B=$(A).val();if(B==1||B=="undefined"){$("#transfercCustIdCard").attr("placeHolder","请输入合法身份证号码");$("#transfercCustIdCard").attr("data-validate","validate(idCardCheck:请输入合法身份证号码) on(blur)")}else{if(B==2){$("#transfercCustIdCard").attr("placeHolder","请输入合法军官证");$("#transfercCustIdCard").attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(B==3){$("#transfercCustIdCard").attr("placeHolder","请输入合法护照");$("#transfercCustIdCard").attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#transfercCustIdCard").attr("placeHolder","请输入合法证件号码");$("#transfercCustIdCard").attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}h()};var t=function(){$("#custTransferForm").off("formIsValid").on("formIsValid",function(B){var D="";var A="";var C="";D=$("#p_cust_tra_identityCd").val();C=$.trim($("#TransferNum").val());if(C==""){$.alert("提示","请输入证件号码！");return}if($("#TransferNum").val().length<14){authFlag="0"}else{authFlag="1"}if(D==1){D=$("#p_cust_tra_identityCd").val()}if(D==-1){A=C;C="";D=""}var E={acctNbr:A,identityCd:D,identityNum:C,partyName:"",custQueryType:$("#custQueryType").val()};$.callServiceAsHtml(contextPath+"/order/prodModify/transferQueryCust",E,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(F){if(F.code!=0){$.alert("提示","查询失败,稍后重试");return}o(F)},fail:function(F){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})}).ketchup({bindElement:"custTransferBtn"})};var f=function(){$("#transCustAuthForm").unbind("click").bind("formIsValid",function(B,A){var C=w;C.prodPwd=$.trim($("#transAuthPassword").val());C.authFlag=authFlag;$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",C,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(D){if(D.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(D.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}p(D)},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"transCustAuthbtn"})};var h=function(){$("#ransferCustCreateForm").unbind("click").bind("formIsValid",function(B){var A={cCustName:$.trim($("#transfercCustName").val()),cCustIdCard:$.trim($("#transfercCustIdCard").val()),cAddressStr:$.trim($("#transfercAddressStr").val())};easyDialog.close();var C={};C.prodPwd="";C.accessNumber="";C.authFlag="1";authFlag="";C.idCardNumber=A.cCustIdCard;C.partyName=A.cCustName;C.identityName=$("#div_tra_identidiesTypeCd option:selected").text();C.addressStr=A.cAddressStr;$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",C,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(D){if(D.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(D.data.indexOf("false")>=0){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}p(D)},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"ransferAddcustsussbtn"})};var o=function(A){if(A.data.indexOf("false")>=0){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}var B=$("#custTransferList");B.html(A.data).show();$(".userclose").off("click").on("click",function(C){authFlag="";$(".usersearchtranscon").hide()});$(".usersearchtranscon").show();f()};var n=function(A){w={custId:$(A).find("td:eq(3)").text(),partyName:$(A).find("td:eq(0)").text(),idCardNumber:$(A).attr("idCardNumber"),identityName:$(A).attr("identityName"),areaName:$(A).attr("areaName")};if($("#TransferNum").val().length<14){easyDialog.open({container:"Transferauth"});$("#transAuthClose").off("click").on("click",function(B){easyDialog.close();authFlag="";$("#transAuthPassword").val("")})}else{j(A)}};var j=function(A){var B=w;B.prodPwd=$.trim($("#transAuthPassword").val());B.authFlag=authFlag;$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",B,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(C){if(C.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}custInfo=B;p(C)},always:function(){$.unecOverlay()}})};var p=function(A){if(authFlag=="0"){easyDialog.close()}if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}var B=$("#custTransferInfo");B.html(A.data).show();$("#custTransferList").hide();$(".usersearchtranscon").hide();if($("#litransCustId").attr("transCustId")==""){$("#TransferNum").val("");w.custId=-1;b=$.trim($("#transfercCustName").val())}else{b=$("#litransCustId").attr("transcustname")}r();$("#accountDiv").show()};var m=function(A){easyDialog.open({container:"transfer_cust_add"});a($("#div_tra_partyTypeCd").children(":first-child"));$("#usercreateclose").off("click").on("click",function(B){easyDialog.close();$("#transfercCustName").val("");$("#transfercCustIdCard").val("");authFlag="";if($.ketchup){$.ketchup.hideAllErrorContainer($("#ransferCustCreateForm"))}});h()};var u=function(){var A=w;A.authFlag="1";$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")
},done:function(B){if(B.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}p(B)},always:function(){$.unecOverlay()}})};var r=function(){if($("#litransCustId").attr("transCustId")==""){l()}else{var C={custId:$("#litransCustId").attr("transCustId")};var A=order.prodModify.returnAccount(C);if(A.code==0){var B=A.data;if(B.resultCode==0){if(B.accountInfos&&B.accountInfos.length>0){$.each(B.accountInfos,function(D,F){var E=false;$.each($("#acctSelect option"),function(G,H){if($(H).val()==F.acctId){E=true;return false}});if(!E){$("<option>").text(F.name+" : "+F.accountNumber).attr("value",F.acctId).attr("acctcd",F.accountNumber).appendTo($("#acctSelect"))}$("#acctSelect").find("option[value="+F.acctId+"]").attr("selected","selected")});$("#defineNewAcct").hide()}else{l()}}else{$.alert("提示","客户的帐户定位失败，请联系管理员，若要办理新装业务请稍后再试或者新建帐户。错误细节："+B.resultMsg)}}else{$.alert("提示",A.data)}}};var l=function(){var A=false;if($("#acctSelect option").size()>0){$.each($("#acctSelect option"),function(B,C){if($(C).val()==-1){A=true;return false}});if(!A){order.main.createAcct()}else{$("#acctSelect").find("option[value=-1]").attr("selected","selected");$("#defineNewAcct").show()}}else{order.main.createAcct()}};var z=function(A){var B=A;B.custName=OrderInfo.cust.custName;B.custId=OrderInfo.cust.custId;B.accessNumber=order.prodModify.choosedProdInfo.accNbr;$.callServiceAsHtml(contextPath+"/order/prodModify/custTransfer",B,{done:function(C){$("#order_fill_content").html(C.data).show();$(".h2_title").append(order.prodModify.choosedProdInfo.productName+"-"+order.prodModify.choosedProdInfo.accNbr);$("#fillLastStep").click(function(){order.prodModify.cancel()});i();t()}})};var i=function(){var A={attrSpecCode:"PTY-0004"};$.callServiceAsJson(contextPath+"/staffMgr/getCTGMainData",A,{done:function(C){if(C.code==0){var E=C.data;if(E!=undefined&&E.length>0){for(var D=0;D<E.length;D++){var B=E[D];$("#p_cust_tra_identityCd").append("<option value='"+B.attrValueCode+"' >"+B.attrValueName+"</option>")}}}else{if(C.code==-2){$.alertM(C.data);return}else{$.alert("提示","调用主数据接口失败！");return}}}})};var v=function(G){var F={partyTypeCd:G};var B=contextPath+"/cust/queryCertType";var A=$.callServiceAsJson(B,F,{});if(A.code==-2){$.alertM(A.data)}if(A.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(A.code==0){var E=A.data;if(E!=undefined&&E.length>0){for(var C=0;C<E.length;C++){var D=E[C];$("#div_tra_identidiesTypeCd").append("<option value='"+D.certTypeCd+"' >"+D.name+"</option>")}}}};return{showCustTransfer:x,custTransfer:z,showCustCreate:m,custTransfer_Submit:y,jumpAuth:u,partyTypeCdChoose:a,identidiesTypeCdChoose:c,showCustTransferReturn:q,showCustAuth:n}})();CommonUtils.regNamespace("prod","uim");prod.uim=(function(){var g=function(n){var v=OrderInfo.getAccessNumber(n);var l="-1";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(v==""){$.alert("提示","校验UIM卡前请先选号!");return false}}if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23||OrderInfo.actionFlag==6){if(ec.util.isArray(OrderInfo.oldprodInstInfos)){$.each(OrderInfo.oldprodInstInfos,function(){if(this.prodInstId==n){l=this.mainProdOfferInstInfos[0].prodOfferInstId}})}else{l=order.prodModify.choosedProdInfo.prodOfferInstId}}var k=$("#selUimType").val();var u=$.trim($("#uim_txt_"+n).val());if(u==undefined||u==""){$.alert("提示","UIM卡不能为空!");return false}var o={instCode:u,selUimType:k,phoneNum:v,serialNumberCode:$.trim($("#uim_txt_"+n).val()),areaId:OrderInfo.getProdAreaId(n)};var q=OrderInfo.getProdSpecId(n);var t="";if(CONST.getAppDesc()==0){if(c(n)){t=f(CONST.PROD_SPEC_ID.MIFI_ID)}else{t=f(q)}if(ec.util.isObj(t)){}else{$.alert("提示","查询卡类型失败！");return}if(OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){if(prod.changeUim.is4GProdInst){o.onlyLTE="1"}}}var m=query.prod.checkUim(o);if(m==undefined||m.baseInfo==undefined){return false}else{var s={prodId:n,isWireBusi:"",isWireUIM:false,wireType:0,uimCode:m.baseInfo.mktResInstCode,uimName:m.baseInfo.mktResName};$.each(m.attrList,function(){if(this.attrId=="60020007"){s.isWireUIM=true;s.wireType=this.attrValue;return false}});if(s.isWireUIM){if(q==CONST.PROD_SPEC.CDMA){s.isWireBusi=1}}else{if(q==CONST.PROD_SPEC.DATA_CARD){s.isWireBusi=2}}OrderInfo.clearCheckUimData(n);OrderInfo.checkUimData.push(s)}var r=m.baseInfo.qty;if(r==undefined||r==null){r=1}var j={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:m.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:r,storeId:m.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:m.baseInfo.mktResInstCode,terminalCode:m.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:n,offerId:l,state:"ADD",relaSeq:""};if(CONST.getAppDesc()==0){j.cardTypeFlag=m.baseInfo.cardTypeFlag}$("#uim_check_btn_"+n).attr("disabled",true);$("#uim_check_btn_"+n).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+n).attr("disabled",false);$("#uim_release_btn_"+n).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+n).attr("disabled",true);if(c(n)){$("#isMIFI_"+n).val("yes")}else{$("#isMIFI_"+n).val("no")}OrderInfo.clearProdUim(n);OrderInfo.boProd2Tds.push(j);if(OrderInfo.actionFlag==22&&m.baseInfo.cardTypeFlag==1&&order.prodModify.choosedProdInfo.productId!="280000000"){AttachOffer.queryCardAttachOffer(m.baseInfo.cardTypeFlag)}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){if(s.isWireUIM&&s.wireType=="02"&&q==CONST.PROD_SPEC.DATA_CARD){AttachOffer.addOpenServList(n,CONST.PROD_SPEC_ID.WIRE_GLOBAL,"天翼宽带-国际及港澳台数据漫游","N");var p=$("#li_"+n+"_"+CONST.PROD_SPEC_ID.WIRE_GLOBAL);if(p.length>0){p.find("dd").removeClass("delete").addClass("mustchoose").attr("onclick","")}}}};var c=function(o){var n=(Math.abs(o)-1);if(AttachOffer.openServList.length>n){var m=AttachOffer.openServList[n].servSpecList;for(var l=0;l<m.length;l++){var k=m[l];if(k.isdel!="Y"&&k.isdel!="C"){if(k.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID&&CONST.APP_DESC==0){return true}}}}return false};var f=function(l){var m={prodSpecId:l};var k=contextPath+"/mktRes/uim/getMktResCd";$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");var j=$.callServiceAsJson(k,m);$.unecOverlay();if(j.code=="0"){return j.data}else{return""}};var i=function(m){var l=$.trim($("#uim_txt_"+m).val());if(l==undefined||l==""){$.alert("提示","UIM卡不能为空!");return false}var o={numType:2,numValue:l};var n=$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",o);if(n.code==-2){$.alertM(n.data);return}if(n.code==-1){$.alert("提示",n.data);return}$.alert("提示","成功释放UIM卡："+l);if(OrderInfo.actionFlag==22){$("#attach").children().remove();AttachOffer.openServList=[];AttachOffer.openList=[]}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){var j=OrderInfo.getProdSpecId(m);var k=OrderInfo.getCheckUimData(m);if(k.isWireUIM&&k.wireType=="02"&&j==CONST.PROD_SPEC.DATA_CARD){AttachOffer.closeServSpec(m,CONST.PROD_SPEC_ID.WIRE_GLOBAL,"天翼宽带-国际及港澳台数据漫游","N");var p=$("#li_"+m+"_"+CONST.PROD_SPEC_ID.WIRE_GLOBAL);if(p.length>0){p.find("dd").removeClass("mustchoose").addClass("delete").attr("onclick","AttachOffer.closeServSpec('"+m+"','"+CONST.PROD_SPEC_ID.WIRE_GLOBAL+"','天翼宽带-国际及港澳台数据漫游','N')")}}}$("#uim_check_btn_"+m).attr("disabled",false);$("#uim_check_btn_"+m).removeClass("disablepurchase").addClass("purchase");$("#uim_release_btn_"+m).attr("disabled",true);$("#uim_release_btn_"+m).removeClass("purchase").addClass("disablepurchase");$("#uim_txt_"+m).attr("disabled",false);$("#uim_txt_"+m).val("");OrderInfo.clearCheckUimData(m);OrderInfo.clearProdUim(m)};var a=function(j,l,k){var m={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:k.couponId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:k.couponInsNumber,terminalCode:k.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:l,offerId:j,state:"DEL",relaSeq:"",id:0,isOld:"T",is4GCard:k.is4GCard};
OrderInfo.boProd2OldTds.push(m);order.prodModify.choosedProdInfo.extCouponInstanceId=k.extCouponInstanceId;order.prodModify.choosedProdInfo.corCouponInstanceId=k.corCouponInstanceId};var h=function(){OrderInfo.boProd2OldTds=[];var k=true;if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==23){var j=order.prodModify.choosedProdInfo;var l=query.prod.getTerminalInfo(j);if(l==undefined){return false}a(j.prodOfferInstId,j.prodInstId,l);if(l.is4GCard=="Y"){j.prodClass=CONST.PROD_CLASS.FOUR}else{j.prodClass=CONST.PROD_CLASS.THREE}}else{if(OrderInfo.actionFlag==21){var j={};$.each(OrderInfo.viceOfferSpec,function(){var m=this.prodId;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==m){j.prodInstId=this.objInstId;j.accNbr=this.accessNumber;var n=query.prod.getTerminalInfo(j);if(n==undefined){k=false;return false}a(this.offerId,this.objInstId,n);if(n.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}}})})}else{var j={};$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){j.prodInstId=this.objInstId;j.accNbr=this.accessNumber;var n=query.prod.getTerminalInfo(j);if(n==undefined){k=false;return false}a(this.offerId,this.objInstId,n);if(n.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}var m=order.prodModify.choosedProdInfo;if(m!=undefined&&m.prodInstId==this.objInstId){m.prodClass=this.prodClass}}})}}return k};var b=function(o,p,k){var n={mktResCd:o,mktResId:p,instCode:k};var m=contextPath+"/mktRes/uim/getResCardType";$.ecOverlay("<strong>获取获取卡类型中,请稍等...</strong>");var l=$.callServiceAsJson(m,n);$.unecOverlay();if(l.code==0){var j=l.data;if(ec.util.isObj(j)&&ec.util.isObj(j[0].uimTypeFlag)){return j[0].uimTypeFlag}else{return""}}else{if(l.code==-2){$.alertM(l.data);return""}else{return""}}};return{getMktResCd:f,checkUim:g,releaseUim:i,setProdUim:h,getCardType:b,setOldUim:a}})();CommonUtils.regNamespace("query","common");query.common=(function(){var a=function(g,f){var c=contextPath+"/order/queryApConf";var b={CONFIG_PARAM_TYPE:g};if(typeof(f)=="function"){$.callServiceAsJsonGet(c,b,{done:function(h){$.unecOverlay();if(h.code==0){if(h.data){f(h.data)}}else{if(h.code==-2){$.alertM(h.data)}else{$.alert("提示","查询门户层配置信息失败,稍后重试")}}}})}};return{queryApConfig:a}})();CommonUtils.regNamespace("query","prod");query.prod=(function(){var k=function(o){i(o);var n=contextPath+"/prod/prodSpecParamQuery";$.ecOverlay("<strong>正在查询产品规格属性中,请稍后....</strong>");var m=$.callServiceAsJsonGet(n,o);$.unecOverlay();if(m.code==0){if(m.data){return m.data}}else{if(m.code==-2){$.alertM(m.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var l=function(o){i(o);var n=contextPath+"/prod/prodInstParamQuery";$.ecOverlay("<strong>正在查询产品实例属性中,请稍后....</strong>");var m=$.callServiceAsJsonGet(n,o);$.unecOverlay();if(m.code==0){if(m.data){return m.data}}else{if(m.code==-2){$.alertM(m.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var a=function(m){var o={prodId:m.prodInstId,areaId:OrderInfo.getProdAreaId(m.prodInstId),acctNbr:m.accNbr,isServiceOpen:"Y"};$.ecOverlay("<strong>正在查询产品下终端实例数据中,请稍后....</strong>");var n=$.callServiceAsJson(contextPath+"/token/pc/order/queryTerminalInfo",o,{});$.unecOverlay();if(n.code==0){return n.data}else{if(n.code==-2){$.alertM(n.data)}else{$.alert("错误提示","接口未返回号码["+o.acctNbr+"]产品原UIM卡数据，无法继续受理！")}}};var c=function(p,o){p.isServiceOpen="Y";var n=contextPath+"/token/pc/order/account";if(typeof(o)=="function"){$.callServiceAsJsonGet(n,p,{before:function(){$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>")},done:function(q){$.unecOverlay();if(q.code==0){o(q.data)}else{if(q.code==-2){$.alertM(q.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>");var m=$.callServiceAsJsonGet(n,p);$.unecOverlay();if(m.code==0){if(m.data){return m.data.offerSpec}}else{if(m.code==-2){$.alertM(m.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}};var g=function(o){var n=contextPath+"/mktRes/terminal/checkTerminal";$.ecOverlay("<strong>终端校验中,请稍后....</strong>");var m=$.callServiceAsJson(n,o);$.unecOverlay();if(m.code==-2){$.alertM(m.data)}else{if(m.data&&m.data.code==0){return m.data}else{if(m.data.code==1){$.alert("提示",m.data.message)}else{$.alert("提示","<br/>校验失败，请稍后重试！")}}}};var h=function(p){var n=contextPath+"/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");var m=$.callServiceAsJson(n,p);$.unecOverlay();if(m.code==0){$.alert("提示","UIM卡校验成功!");return m.data}else{if(typeof m==undefined){$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常")}else{if(m.code==-2){$.alertM(m.data)}else{var o="";if(m.data!=undefined&&m.data.msg!=undefined){o=m.data.msg}else{o="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡校验失败，可能原因:"+o)}}}};var j=function(p){var n=contextPath+"/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>");var m=$.callServiceAsJson(n,p);$.unecOverlay();if(m.code==0){$.alert("提示","UIM卡释放成功!");return m.data}else{if(typeof m==undefined){$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常")}else{if(m.code==-2){$.alertM(m.data)}else{var o="";if(m.data!=undefined&&m.data.msg!=undefined){o=m.data.msg}else{o="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡释放失败，可能原因:"+o)}}}};var f=function(){var n=order.prodModify.choosedProdInfo;var m=a(n);if(m==undefined){return}var o={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:m.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:m.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:n.prodInstId,offerId:n.prodOfferInstId,state:"DEL",relaSeq:"",id:0,isOld:"T"};return o};var b=function(n){var p={prodId:n.prodInstId,prodSpecId:n.productId,offerSpecId:n.prodOfferId,acctNbr:n.accNbr};var o=query.offer.queryOpenedAttachAndServ(p);if(o&&o.result&&o.result.servLists){var m=false;$.each(o.result.servLists,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G){m=true}});return m}return false};var i=function(m){m.staffId=OrderInfo.staff.staffId;m.channelId=OrderInfo.staff.channelId;m.partyId=OrderInfo.cust.custId;m.areaId=OrderInfo.getProdAreaId(m.prodId);m.distributorId=OrderInfo.staff.distributorId;if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){m.soNbr=OrderInfo.order.soNbr}};return{checkUim:h,releaseUim:j,getTerminalInfo:a,prodSpecParamQuery:k,prodInstParamQuery:l,getOldUim:f,queryAcct:c,checkTerminal:g,checkIs4GProdInst:b}})();CommonUtils.regNamespace("rule","rule");rule.rule=(function(){var checkFlag=false;var checkObj={};var _callBackStr="";var _callBackParam={};var _init=function(){$("#ruleBody").html("");$("#ruleclose").click(function(){_closeRuleDiv()});$("#credit").click(function(){_credit()});$("#closedialog").click(function(){_cancel()})};var _prepare=function(param,callBackStr,callBackParam){_init();_callBackStr=callBackStr;_callBackParam=callBackParam;if(!query.offer.loadInst()){return}var inParam={prodInfo:order.prodModify.choosedProdInfo,areaId:param.areaId,staffId:param.staffId,channelId:param.channelId,custId:param.custId,boInfos:param.boInfos,soNbr:OrderInfo.order.soNbr};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var response=$.callServiceAsJson(contextPath+"/rule/prepare",inParam);$.unecOverlay();var checkData=response.data;if(response.code==0){if(checkData==null){$.alert("提示","规则校验异常，请联系管理人员！");return}}else{$.alertM(response.data);return}if(checkData.ruleType=="portal"){if(checkData.resultCode=="0"){$.alert("提示",checkData.resultMsg);return true}}if(checkData.result&&checkData.result.resultInfo){var checkRuleInfo=checkData.result.resultInfo;if(checkRuleInfo!=null&&checkRuleInfo.length>0){$.each(checkRuleInfo,function(i,ruleInfo){$("<tr><td>"+ruleInfo.resultCode+"</td><td>"+ruleInfo.ruleDesc+"</td><td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))
});easyDialog.open({container:"ruleDiv"})}else{_credit();SoOrder.initFillPage()}}else{_credit();SoOrder.initFillPage()}if(checkData.resultCode!=0){$("#ruleSubmit").hide()}else{checkObj=param;checkFlag=true}};var _getRuleImgClass=function(ruleLevel){if(ruleLevel<4){return"correct"}else{return"error"}};var _getRuleLevelName=function(ruleLevel){if(ruleLevel==0){return"提示级"}else{if(ruleLevel==1){return"中级"}else{if(ruleLevel==2){return"高级"}else{if(ruleLevel==3){return"特技"}else{if(ruleLevel==4){return"限制级"}}}}}};var _prepareCallBack=function(response){var content$=$("#ruleDiv");content$.html(response.data).show()};var _submit=function(){if(!checkFlag){return}$.callServiceAsHtml(contextPath+checkObj.uri,checkObj.param,checkObj.callObj);easyDialog.close()};var _closeRuleDiv=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _cancel=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _showRuleDiv=function(ruleInfo){};var _credit=function(){eval(_callBackStr+"("+JSON.stringify(_callBackParam)+")");_closeRuleDiv()};var _ruleCheck=function(boInfos){_init();if(!query.offer.loadInst()){return false}if(boInfos==undefined){return true}var inParam={areaId:OrderInfo.staff.soAreaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,boInfos:boInfos,prodInfo:order.prodModify.choosedProdInfo};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var response=$.callServiceAsJson(contextPath+"/rule/prepare",inParam);$.unecOverlay();if(response!=undefined&&response.code==0){var checkData=response.data;if(checkData.result.resultInfo!=undefined&&checkData.result.resultInfo.length>0){var ruleDesc="";$.each(checkData.result.resultInfo,function(){ruleDesc+=this.ruleDesc+"<br/>"});$.alert("提示",ruleDesc);return false}if(checkData==null){$.alert("提示","规则校验异常，请联系管理人员！");return false}if(checkData.ruleType=="portal"){if(checkData.resultCode=="0"){$.alert("提示",checkData.resultMsg);return false}}var checkRuleInfo=checkData.result.resultInfo;if(checkRuleInfo!=undefined&&checkRuleInfo.length>0){$.each(checkRuleInfo,function(i,ruleInfo){$("<tr><td>"+ruleInfo.resultCode+"</td><td>"+ruleInfo.ruleDesc+"</td><td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});easyDialog.open({container:"ruleDiv"});return false}else{return true}}else{$.alertM(response.data);return}};return{submit:_submit,prepare:_prepare,showRuleDiv:_showRuleDiv,ruleCheck:_ruleCheck,init:_init,getRuleLevelName:_getRuleLevelName,getRuleImgClass:_getRuleImgClass}})();$(function(){});