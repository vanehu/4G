/**
 * 写卡
 * 
 * @author xuj
 */
CommonUtils.regNamespace("order", "writeCard");
var ty_plugin = null;
var productId = "";
var g_realWriteCard = true;//true真实写卡，false假写卡
//根据浏览器加载
if ($.browser.msie) {
	try{
		ty_plugin =new ActiveXObject("HBW0001.HBW0001Ctrl.1");
	}catch(e){}
}

order.writeCard = (function(){
	//4G卡
	//var _4GCARDS=["00700","00701","00702","00703","00704","00705","00706","00707","00708","00709","00710","00711","00712","00713","00312","00313","00314","00315","00316","00317"];
	
	var _settings = {
			busiComponentCode:"",
			session: {
				staffId:"",
				staffSerial:"",
				staffAreaId:"",
				staffAreaName:"",
				staffName:"",
				staffNumber:"",
				channelId:"",
				channelName:""
			},
			renderTo:"",
			params: {
				switchId:"",
				phoneNumber:"",
				lanId:"",
				dstOrgId:"",
				dstSysId:"",
				scene:"",
				terminalCode:""
			},
			config: {
				"rscAreaId":"",
				"cardAreaId":"",
				"isUnLoad":true
			//写卡后是否立即卸载动态链接库
			}
		};
	    var _TransactionID = "";
		var _haveReadCard = false;
		var _haveWriteCard = false;
		var g_phoneNumber = '';//'18920099334';//
		var g_subFlag = 'N';//副卡标识 Y|副卡 ;N|主卡.
		var _switchCache = [];
		var ty_plugin = null;
		var _rscJson = {
			"iccid":"",
			"imsi":"",
			"imsig":"",
			"data":"",
			"dataLength":"0",
			"state":"N",
			"prodId":""
		};
	//卡数据资源JSON state:N 为不可用来写卡 Y 为可以
	this._cardDllInfoJson = {
		"dllId":"",
		"dllName":"",
		"":"",
		"password":"",
		"factoryCode":""
	};//动态链接库JSON
	var _cardInfoJson = {
		"serialNumber":"",
		"factoryCode":"",
		"cardTypeId":"",
		"cardName":"",
		"materialId":"",
		"canWrite":"N"
	};
	var ocx;
	var _writeReadCard=function(prodId){
		var phoneNumber = OrderInfo.getAccessNumber(prodId);
		if (phoneNumber==""){
			$.alert("提示",'请选择号码!','confirmation');
			return;
		}
		ec.form.dialog.createDialog({"id":"-card"+prodId,width:350,"initCallBack":function(){			
			$("#write_card_phone_number"+prodId).val(phoneNumber);
			//ActiveX 控件无法用JQUERY方法获取
			ocx = document.getElementById("ocx"+prodId);
			//绑定读卡按钮事件
			$("#btnReadCard"+prodId).click(function(){
				$("#btnReadCard"+prodId).attr("disabled","disabled");
				if (!order.writeCard.readCard(prodId)) {
					$("#serialNum"+prodId).val("");
					$("#cardTypeId"+prodId).val("");
				}else{
					$.alert("提示",'成功读卡!','confirmation');
				}
				$("#btnReadCard"+prodId).removeAttr("disabled");
			});
			$("#btnWriteCard"+prodId).click(function(){
				$("#btnWriteCard"+prodId).attr("disabled","disabled");
				var writeResultFlg=order.writeCard.writeCard(prodId);
				if (!writeResultFlg) {
					//$.alert("提示",'写卡失败!','error');
					return;
				}
				$("#btnWriteCard"+prodId).removeAttr("disabled");
				if (writeResultFlg){//写卡成功
					$.modal.close();
				}

			});
		},"submitCallBack":function(dialogForm,dialog){}});

	};
	
	var _readCard = function(prodId){
		_haveReadCard = true;
		if(!g_realWriteCard){
			var date = new Date();
			_rscJson.imsi = "1111111111111"+date.getMilliseconds();
			_rscJson.iccid = "89860314105350023801";
			if (_rscJson.iccid.length==20){
				_rscJson.iccid = _rscJson.iccid.substr(0,_rscJson.iccid.length-1)
			}
			$("#serialNum"+prodId).val(_rscJson.iccid);
			$("#serialNum").val("33333333333" + date.getMilliseconds());
			_cardInfoJson.cardTypeId = ("33333333333" + date.getMilliseconds()).substr(5,5);
			if(!_getCardType()){
				return false;
			}
			if(ec.util.isObj(_cardInfoJson.cardTypeId)){
				if(prod.changeUim.is4GProdInst&&(OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23)){//判断是否有开通4G功能产品
					//var flag=false;//默认3G卡
					//for(var i=0;i<_4GCARDS.length;i++){
					//	if(_cardInfoJson.cardTypeId==_4GCARDS[i]){//4G卡
					//		flag=true;
					//		break;
					//	}
					//}
					//if(!flag){
					if(CONST.UIMTYPE3G4G.IS3G==prod.uim.getCardType("","",_cardInfoJson.serialNumber)){
						$.alert("信息提示","您已开通了【4G（LTE）上网】功能产品，而UIM卡是3G卡，请使用4G的白卡！");
						return false;
					}
				}
			 }
			return true;
		}
		// 读取ICCID 转
		var iccidResult =null;
		try{
			iccidResult = ec.util.defaultStr(ocx.strGetICCID());
		}catch(e){
			$.alert("提示","加载读卡插件失败,请检查是否已正确安装插件!错误信息："+e.message,"error");
			return false;
		}
		//alert("iccidResult:"+iccidResult);
		var opCode1 = iccidResult.substring(iccidResult.length - 4,iccidResult.length);
		if (opCode1 == '') {
			$.alert("提示","读取卡失败!请确认卡连接是否正常!");
			return false;
		}
		if(prodId == undefined){
			if (opCode1 != '' && opCode1 != "FFFF") {
				$.alert("提示","卡片已有数据,不能重复写入!");
				return false;
			}
		}
		
		//var iccid = iccidResult.substring(0,iccidResult.length-5); 
		var iccid = iccidResult;
		
		//读取空卡序列号
		var serialNum = "";
		var result = ec.util.defaultStr(ocx.GetEmptyCardFile());//读卡器读取结果
		var opCode = result.substring(result.length - 5,result.length);
		//alert("opCode::"+opCode);
		
		// add by wangdan 9/11 start
		/*var columnValue = "";
		try{
			var qryConfigUrl=contextPath+"/mktRes/queryApConf";	
			var jr = $.callServiceAsJsonGet(qryConfigUrl);
			if(jr.code==0 && jr.data){
				for(var n=0;n<jr.data.length;n++){								
					if(jr.data[n].SERIALNUM_FILTER){									
						columnValue = jr.data[n].SERIALNUM_FILTER[0].COLUMN_VALUE;
					}								
										
				}
			}
		}catch(e){
			
		}#13318，所有的白卡都不截取，现直接入库*/
		//end
		if (opCode != '' && opCode != "FFFF") {
			//update by huangjj3 #13318，如果选择的是空白卡，cardNo需要做下逻辑处理
			$("#selUim").val("2");//下拉框选择为空白卡
			var serviceName = contextPath + "/mktRes/writeCard/getAsciiToHex";
			var asciiFStr = result.substring(result.length-4,result.length);
			var param = {
				"asciiFStr":asciiFStr       
			};
			var response = $.callServiceAsJson(serviceName, param);
			
			var selUimCard = result.substring(0,result.length-4)+response.data.asciiStr;
			$("#uim_txt_"+prodId).val(selUimCard);
			$("#resultCardAsciiFStr").val(selUimCard);
			$("#resultCardNo").val(result);
			$("#selUimType").val("3");
			$("#uim_lable").attr("disabled",true);  
			serialNum = result;//#13318，所有的白卡都不截取，现直接入库
			factoryCode = result.substring(result.length - 2,result.length);
			//if(factoryCode==42){
			//	factoryCode=30;
			//}
		}
		var areaId = OrderInfo.getProdAreaId(prodId);
		/*areaId = areaId.substring(0,3) + "0000";
		//不要截取的  add by wangdan 9/11 start
		for(var i=0,nserialnumValues = columnValue.split(",");i< columnValue.length;i++){
			if (areaId == nserialnumValues[i]) {
				serialNum = result;
				break;
			}
		}#13318，所有的白卡都不截取，现直接入库*/
		//end
		//alert("serialNumber:="+_cardInfoJson.serialNumber);
		//如果读取到了空卡序列号就加载卡片信息
		if (ec.util.defaultStr(serialNum) != "") {
			_cardInfoJson.serialNumber = serialNum;
			_cardInfoJson.factoryCode = factoryCode;
			_cardInfoJson.cardTypeId = serialNum.substr(5,5);
			//alert("cardTypeId:"+_cardInfoJson.cardTypeId);
			
			//加载卡片信息
			/*chylg
			if (_initBlankCardTypeInfo() == false) {
				alert("加载卡片信息失败");
				return false;
			} else {
				selectMaterialId = _cardInfoJson.materialId;
				$("#cardType").find("option[value=" + selectMaterialId + "]").attr("selected",
						"selected");
			}
			*/
		}
		
		if(!_getCardType()){
			return false;
		}
		if(ec.util.isObj(_cardInfoJson.cardTypeId)){
			if(prod.changeUim.is4GProdInst&&(OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23)){//判断是否有开通4G功能产品
				//var flag=false;//默认3G卡
				//for(var i=0;i<_4GCARDS.length;i++){
				//	if(_cardInfoJson.cardTypeId==_4GCARDS[i]){//4G卡
				//		flag=true;
				//		break;
				//	}
				//}
				if(CONST.UIMTYPE3G4G.IS3G==prod.uim.getCardType("","",_cardInfoJson.serialNumber)){
					$.alert("信息提示","您已开通了【4G（LTE）上网】功能产品，而UIM卡是3G卡，请使用4G的白卡！");
					return false;
				}
			}
		 }
		//alert("_cardInfoJson:="+JSON.stringify(_cardInfoJson));
		if (iccid == 'FFFFFFFFFFFFFFFFFFFF' || iccid == '00000000000000000000') {
			_cardInfoJson.canWrite = 'Y';
			$("#btnWriteCard"+prodId).css("display","");
			$("#serialNum"+prodId).val(_cardInfoJson.serialNumber);
			$("#iccid"+prodId).val(_rscJson.iccid);
			$("#imsi"+prodId).val(_rscJson.imsi);
			$("#cardTypeId"+prodId).val(_cardInfoJson.cardTypeId);
		} else {//成品卡
			_cardInfoJson.canWrite = 'N';
			//如果是受理中写卡，成品卡隐藏写卡按钮
			if (_settings.params.scene == "1") {
				$("#btnWriteCard"+prodId).css("display","none");
			}
			if (serialNum != null) {//白卡写出的成品卡
				$("#serialNum"+prodId).val(_cardInfoJson.serialNumber);
				$("#cardTypeId"+prodId).val(_cardInfoJson.cardTypeId);
			} else {//厂商生成的成品卡
				var bcdcode = iccid.substring(0,19); //原有成品卡取19位做终端码
				$("#serialNum"+prodId).val(bcdcode);
			}
		}
		return true;
	};
	
	var _writeCard = function(prodId){
		
		_haveWriteCard = false;//false;
		productId = prodId;
		//[start]模拟写卡
        if(!g_realWriteCard){
            _haveWriteCard = true;
            $.alert("提示","写卡成功!","confirmation");
            $("#uim_txt_"+prodId).val(_rscJson.iccid);
            var coupon = {
				couponUsageTypeCd : "3", //物品使用类型
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId :"10", //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD, //物品费用项类型
				couponNum : "1", //物品数量
				storeId : "8230010", //仓库ID
				storeName : "11", //仓库名称
				agentId : 1, //供应商ID
				apCharge : 0, //物品价格
				couponInstanceNumber : "8230007407312006106", //物品实例编码
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId :prodId, //产品ID
				state : "ADD", //动作
				relaSeq : "" //关联序列	
			};
            if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==14){
            	coupon.offerId = "-1";
            }else{
            	coupon.offerId = order.prodModify.choosedProdInfo.prodOfferInstId; //销售品实例ID
            }
    		OrderInfo.clearProdUim(prodId);
            OrderInfo.boProd2Tds.push(coupon);
            return true;
        }
		//[end]模拟写卡

		//写卡之前必须要先读卡
		if (!_haveReadCard) {
			$.alert("提示","请先读卡!","error");
			return false;
		}
		

		//写卡之前再读卡
		if (!_readCard()) {
			$.alert("提示","写卡前验证读卡验证时读卡失败，请确认设备是否连接好!","error");
			return false;
		}

		//if (_cardInfoJson.canWrite != 'Y') {
		//	$.alert("提示","插入的卡片是不是可写的白卡,该卡在库存中状态不是可写卡或者已经是成品卡，请换卡!","error");
		//	return false;
		//}
		//如果是黑莓手机写卡一定要是支持EVDO的CG双模卡
		var hmPesn = $("#pesn").val();
		
		if (hmPesn != undefined && hmPesn != "" && hmPesn != null) {
			cardType = _cardInfoJson.serialNumber.substr(6,2);
			if (cardType != '10') {
				$.alert("提示","黑莓手机终端配套的手机卡必须是支持EVDO的CG双模卡，请换支持EVDO的CG双模卡进行写卡!","error");
				return false;
			}
		}
		//alert("加载动态链接库");
		//加载动态链接库
		if (!_updateCardDll()) { return false; }
		
		//alert("加载动态链接库 end");
		
		//写卡之前必须调用DisConnectReader()函数断开写卡器，江苏恒宝的写卡方式
		var dkResult = ocx.DisConnectReader();
		if (dkResult != "0") {
			$.alert("提示","写卡之前,断开写卡器失败!","error");
			return false;
		}
		//客户端调用插件函数获取随机数
		var getResult = ocx.GetRandNum();
		//alert("随机数="+getResult);
		
		if (getResult.length != 16) {
			$.alert("提示","写卡异常:获取随机数失败！" + result,"error");
			return false;
		}
		var randomNum = getResult;
		//判断是否为8字节长的随机数
		if (randomNum.length != 16) {
			//alert('判断8字节');
			$.alert("提示","写卡异常:从卡商组件获取随机数不是8字节长的随机数！","error");
			return false;
		}
		//判断密码是否为空
		if (_cardDllInfoJson.dllPassword == "") {
			//alert('密码'+_cardDllPassword);
			$.alert("提示","写卡异常(组件鉴权密码不可为空)，请检查！","error");
			return false;
		}
		//alert("用获取的随机数生成鉴权码");
		/*-----------------------------用获取的随机数生成鉴权码 -------------------*/
		var authCode = null;
		serviceName = contextPath + "/mktRes/writeCard/authCode";
		try {
			var param = {
				randomNum:randomNum,
				dllPassword:_cardDllInfoJson.password,
				factoryCode:_cardDllInfoJson.factoryCode,
				authCodeType:_cardDllInfoJson.authcodeType
			};

			var response = $.callServiceAsJson(serviceName, param);
			var authCodeJson;
			if(response.code == 0){
				authCodeJson = response.data;
			}else{
				$.alertM(response.data);
				return false;
			}
			
			var code = authCodeJson.code;
			if (code != null && code == "POR-0000") {
				authCode = authCodeJson.authCode;
				//authCode ='B9488FBC60982B48';
				//alert('鉴权码='+authCode);
			} else {
				$.alert("提示","用获取的随机数生成鉴权码失败！","error");
				return false;
			}
		} catch(e) {
			$.alert("提示","用获取的随机数生成鉴权码异常!" + e.message,"error");
			return false;
		}
		//alert("用获取的随机数生成鉴权码authCode:" + authCode);
		/*-----------------------------用获取的鉴权密钥和生产的随机数生产鉴权码完成 -----------------*/

		//获得鉴权结果
		var auResult = ocx.Authentication(authCode);
		
		var opCode = auResult;
		if (opCode != "0") {
			$.alert("提示","鉴权失败！" + auResult,"error");
			return false;
		}
		/*------------------------准备工作完成，开始调用Active控件写卡----------------------------------------*/
		//先申请资源数据
		//if (!_applyResourceData(scope)){
		if (!_applyResourceData(prodId)) {
			//alert('申请卡数据以后');
			//如果申请资源数据失败
			return false;
		}
		
		//alert("调用组件写卡函数进行写卡");
		
		_haveWriteCard = true;
		//申请资源成功，写卡过程已经开始
		//调用组件写卡函数进行写卡，调用dep接口传入写卡数据。
		//$.alert("提示","写入数据_rscJson.data="+_rscJson.data+"\n\n写卡结果;authCode:"+authCode+";writeCardResult="+writeCardResult,"error");
		//alert("写入数据_rscJson.data="+_rscJson.data+"\n\n写卡结果;writeCardResult="+writeCardResult);
		//return false;
		//_rscJson.data = "89860311805101572698,460036700435919,8097808C,3760,9,FFFF,0bf0ad8280d2b0a0,1234,55900648,85232888,49600368,59EF72FB,460036700435919@mycdma.cn,75d6ecc6632fac57,460036700435919@mycdma.cn,30ffc6952e03ccd0;37623582e5265d5a;cdfd165333f66519,460036700435919@mycdma.cn,e43472656c30e82e;671ab8c55dbdb14f;16a7e838ae5db0fa,e51c11352e62e0ac;98e3ce89414d982a;cac02f2ef7d2544d,,,,";
		//_rscJson.data = "89860313007580411850,460030252801743,805BA245,3619,3,FFFF,123013c243731bc8,1234,51154902,74059570,96831988,90892996,460030252801743@mycdma.cn,059f7bdf8e3f4e12,460030252801743@mycdma.cn,e99eeb2f8c1ddf16;a4316f058ba1aedb;54034ca47e67108c;edfa87035ebe8a18;90719b0fea72386f,460030252801743@mycdma.cn,9aebd4cdfeeccfcb;529995a75de27bf9;f868720e8cc7ee48;5ee4410b4ca89979;9666d03a637b22ee,2479e9c1334e9337;795e86be92e2a431;df518cdb3c732c8f;d6c98a059b44ff3c;edb8698d619dc2d1,204043153514753,3,19e7126871e1eb11a85a4ae90b8daa7c,+316540942000";
		//_rscJson.data = "89860313900100000102,460036531190990,8000A876,13824,0,FFFF,a471b07640a45918,1234,66709721,78778797,85087049,B8C32115,460036531190990@mycdma.cn,63044385d047084c,460036531190990@mycdma.cn,c1d4f3f021172c63,460036531190990@mycdma.cn,5c3a505e7f018f7d,0dc6e3733d291f52,,,";
		//alert("xj:"+_rscJson.data);
		var writeCardResult = ocx.YXPersonalize(authCode,"",1,_rscJson.data,"");
		//alert("writeCardResult:"+writeCardResult);
		if (writeCardResult != "0") {
			//客户端提示：写卡失败时各卡商返回各自定义的错误信息 
			$.alert("提示","写卡失败，请将白卡取出！错误编码=" + writeCardResult+"详细错误请联系卡商["+_cardDllInfoJson.remark+"]确认","error");
			_completeWriteCard("1",writeCardResult);//写卡失败回填
			return false;
		} else {
			//写卡成功
			if (_completeWriteCard("00000000",writeCardResult)) {
				$.alert("提示","恭喜，您已经成功写卡！");
				$("#uim_check_btn_"+prodId).attr("disabled",true);
				$("#uim_check_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
				return true;
			} else {
				$.alert("提示","写卡成功，但卡资源下发异常","error");
				return false;
			}
		}
		return false;
	};
	
	var _updateCardDll = function(){
		
		//先清空组件信息JSON
		_cardDllInfoJson = {
			"authcodeType":"",	
			"dllId":"",
			"dllName":"",
			"dllVersion":"",
			"password":"",
			"factoryCode":""
		};//动态链接库JSON
		var serialNum = _cardInfoJson.serialNumber;
		//alert('serialNum'+serialNum);
		if (serialNum != undefined) {
			// 提取卡商代码
			
			var cardFatctoyCode = _cardInfoJson.factoryCode;
			
			
			// 根据卡商编码获取卡商最新版本插件DLL信息    
			if (!_getCardDllInfo(cardFatctoyCode)) {
				alert("提示","不能把厂商写卡组件下载到本机客户端!","error");
				return false;
			}
			// 加载卡商组件
			var isOk = _updateOrLoadDll();
			if (!isOk) { return false; }
			return true;
		} else {
			$.alert("提示","卡序列号值(serialNum=" + serialNum + ")不符合规范!","error");
			return false;
		}
	};
	var _recycleCard=function(scope){
		if (confirm("请你确定，你是否有权限进行清除卡数据操作！！")) {
			//-----------------------------------------------------------------------------
			if (!_readCard(scope)) {
				$.alert("提示","清卡前验证读卡验证时读卡失败，请确认设备是否连接好","error");
				return false;
			}
			//加载动态链接库
			if (!_updateCardDll(scope)) { return false; }
			// 卡片的合法性检测
			var result = ty_plugin.TyJsRps_CheckData();
			var opCode = result.substring(result.length - 4,result.length);
			if (opCode != "0000") {
				$.alert("提示","卡片合法性检测失败，请检查卡是否正确插入写卡设备中！","error");
				return false;
			}
			
			// 是否白卡: 0|0000--白卡  1|0000--成品卡
			var isblank = result.substr(0,1);
			
			if (isblank != 0) {
				$.alert("提示","您插入的是成品卡，可以进行清卡操作！","error");
			} else {
				$.alert("提示","您插入的不是成品卡，不可以进行清卡操作！","error");
				return false;
			}
			//-----------------------------------------------------------------------------
			
			//客户端调用插件的TyJsRps_GetRandNum函数获取随机数
			var result = ty_plugin.TyJsRps_GetRandNum();
			var opCode = result.substring(result.length - 4,result.length);
			if (opCode != "0000") {
				$.alert("提示","获取随机数失败！","error");
				return false;
			}
			randomNum = result.substring(0,result.length - 5);
			
			//判断是否为8字节长的随机数
			if (randomNum.length != 16) {
				$.alert("提示","从卡商组件获取随机数不是8字节长的随机数！","error");
				return false;
			}
			
			//获取随机数并利用组件鉴权密码进行3DES加密
			var authCode = null;
			var client = new bss.serviceframework.ajax.client( {
				timeout:40000,
				timeoutHandle:function(){
					$.alert("提示","超时","error");
					return false;
				}
			});
			//获取鉴权码
			var serviceName = "bss.writeCard.writeCardFacade.getAuthCode";
			var client = new bss.serviceframework.ajax.client( {
				timeout:40000,
				timeoutHandle:function(){
					$.alert("提示","超时","error");
					return false;
				}
			});
			try {
				var response = client.callServiceAsJson(serviceName, {
					"randomNum":randomNum,
					"dllInfo":_cardDllInfoJson
				});
				var authCodeJson = response.getBodyAsJson();
				var flag = authCodeJson.flag;
				if (flag != null && flag == "0") {
					authCode = authCodeJson.authCode;
				} else {
					$.alert("提示","利用组件鉴权密码对随机数进行3DES加密失败！","error");
				}
			} catch(e) {
				$.alert("提示","请求组件鉴权密码对随机数进行3DES加密失败!","error");
				return false;
			}
			
			//调用组件清卡函数
			var result = ty_plugin.TyJsRps_ClearCard(authCode);
			var opCode = result.substring(result.length - 4,result.length);
			if (opCode != "0000") {
				alert("清除卡数据失败！");
				return false;
			} else {
				alert("除卡数据成功！");
			}
			// 卡片的合法性检测
			var result = ty_plugin.TyJsRps_CheckData();
			var opCode = result.substring(result.length - 4,result.length);
			if (opCode != "0000") {
				$.alert("提示","卡片合法性检测失败，请检查卡是否正确插入写卡设备中！","error");
				return false;
			}
			// 是否白卡: 0|0000--白卡  1|0000--成品卡
			var isblank = result.substr(0,1);
			if (isblank == 0) {
				//调用后台完成数据库中数据的变化操作,暂提供
			}
			//卸载动态链接库
			_unloadDll(scope);
			return true;
		}
	};
	
	_getCardDllInfo=function(factoryCode,scope){
		//先清掉g_cardDllInfoJson
		_cardDllInfoJson = null;
		try {
			if (factoryCode != undefined) {
				var writeCardNewDLL = $("#writeCardNewDLL").val();//写卡新组件开关
				//alert("厂商编码2："+factoryCode);
				if(writeCardNewDLL=='ON'){
					var serviceName = contextPath + "/mktRes/writeCard/cardDllInfo";
					var param = {
						"factoryCode":factoryCode,
						"cardType":"newCard"
					};
					var cardDllInfoJson;
					var response = $.callServiceAsJson(serviceName, param);
					
					if(response.code == 0){
						cardDllInfoJson = response.data.cardDllInfo;
					}else{
						$.alertM(response.data);
						return false;
					}
					//alert("cardDllInfoJson:"+JSON.stringify(cardDllInfoJson));
					var dllId = cardDllInfoJson.dllId;
					if (dllId == undefined || dllId == null || dllId == "") {
						$.alert("提示","卡商(编码=" + factoryCode + ")获取不到对应的组件信息！","error");
						return false;
					}
					_cardDllInfoJson = cardDllInfoJson;
				
				}else{
					var serviceName = contextPath + "/mktRes/writeCard/cardDllInfo";
					var param = {
						"factoryCode":factoryCode,
						"cardType":"oldCard" 
					};
					var cardDllInfoJson;
					var response = $.callServiceAsJson(serviceName, param);
					
					if(response.code == 0){
						cardDllInfoJson = response.data.cardDllInfo;
					}else{
						$.alertM(response.data);
						return false;
					}
					//alert("cardDllInfoJson:"+JSON.stringify(cardDllInfoJson));
					var dllId = cardDllInfoJson.dllId;
					if (dllId == undefined || dllId == null || dllId == "") {
						$.alert("提示","卡商(编码=" + factoryCode + ")获取不到对应的组件信息！","error");
						return false;
					}
					_cardDllInfoJson = cardDllInfoJson;
				}
				
				return true;
			} else {
				$.alert("提示","卡商编码值不可为空！","error");
				return false;
			}
		} catch(e) {
			$.alert("提示","获取卡商组件信息时异常!" + e.message,"error");
			return false;
		}
	};
	_updateOrLoadDll=function(){
		//_cardDllInfoJson = {"dllId":"","dllName":"","dllVersion":"","dllPassword":"","factoryCode":""};//动态链接库JSON
		//先判断组件是否存在
		//alert("_updateOrLoadDll=="+_cardDllInfoJson.dllName);
		var fso = new ActiveXObject('Scripting.FileSystemObject');
		try {
			fso.GetFile("C:\\WINDOWS\\system32\\" + _cardDllInfoJson.dllName + ".DLL");
			var serviceName = contextPath + "/mktRes/writeCard/writecardLog";
			var param = {
					factoryCode:_cardDllInfoJson.factoryCode,
					authCodeType:_cardDllInfoJson.authCodeType,
					version:_cardDllInfoJson.dllName,
					serviceCode:OrderInfo.busitypeflag,
					isUpdate:'0',//表示不需要更新
					cardSource:_cardDllInfoJson.remark
				};
			$.callServiceAsJson(serviceName, param);
		} catch(e) {
			$("#cardupdate").attr("href",contextPath + "/card/"+ _cardDllInfoJson.dllName+".dll");
			$("#writeTitle").html("写卡组件更新");
			$("#rcard").hide();
			$("#dllName").html(_cardDllInfoJson.dllName+".DLL");
			$("#cardt").show();
			var serviceName = contextPath + "/mktRes/writeCard/writecardLog";
			var param = {
					factoryCode:_cardDllInfoJson.factoryCode,
					authCodeType:_cardDllInfoJson.authCodeType,
					version:_cardDllInfoJson.dllName,
					serviceCode:OrderInfo.busitypeflag,
					isUpdate:'1',//表示需要更新
					cardSource:_cardDllInfoJson.remark
				};
			$.callServiceAsJson(serviceName, param);
			//$.alert("提示","您插入白卡的卡商写卡组件不存在，请将组件下载保存到C:\\WINDOWS\\system32 目录下！","error");
			//$.alert("提示","您当前使用的卡组件的版本已更新，请下载更新至最新的版本[" + _cardDllInfoJson.dllVersion + "]后重新写卡。");
			//var url = contextPath + "/card/"+ _cardDllInfoJson.dllName+".DLL";
			//location.href = url;
			return false;
		}
		//alert("fso=="+fso);
		//装载组件
		var loaddll = ocx.TransferDll(_cardDllInfoJson.dllName + ".DLL");
		if (loaddll != '0') {
			$.alert("提示","您插入白卡的卡商写卡组件不存在，请将组件下载保存到C:\\WINDOWS\\system32 目录下！","error");
			var url = contextPath + "/card/"+ _cardDllInfoJson.dllName + ".DLL";
			location.href = url;
			return false;
		}
		//alert("loaddll=="+loaddll);
		// 读取组件版本号
		var version = ocx.GetDllVersion();
		//alert("version: " + version);
		// 组件版本不是最新, 执行更新
		if (version != _cardDllInfoJson.dllVersion) {
//			alert("您插入白卡的卡商写卡组件不是最新版本，请将最新版本组件下载保存到C:\\WINDOWS\\system32 目录下!");
//			var url = contextPath + "/card/"+ _cardDllInfoJson.dllName;
//			location.href = url;
			$.alert("提示","您当前使用的卡组件版本为[" + version + "]，请下载更新至最新的版本[" + _cardDllInfoJson.dllVersion + "]后重新写卡。");
			return false;
		}
		return true;
	};
	
	_applyResourceData=function(prodId){
		//先清空之前的资源数据
			//写卡请求的参数： 手机号码，卡产品编号，归属地区号
			//漫游地区号，登陆工号，工号名称，营业厅标识，营业厅名称
			_rscJson = {
				"iccid":"",
				"imsi":"",
				"data":"",
				"dataLength":"0",
				"state":"N",
				"prodId":""
			};//卡数据资源JSON state:N 为不可用来写卡 Y 为可以

			//请求后返回给客户端的数据直接是可以写卡的暗文
			var serviceName = contextPath + "/mktRes/writeCard/cardInfo";
						
			try {
				//alert(JSON.stringify(order.prodModify.choosedProdInfo));
				// 提取卡商代码
				var areaCode = OrderInfo.getAreaCode(prodId);
				if (areaCode == undefined || areaCode ==""){
					areaCode = OrderInfo.staff.areaCode;
				}
				var param = {
					factoryCode:_cardDllInfoJson.factoryCode,
					authCodeType:_cardDllInfoJson.authCodeType,
					hmUimid:'',//黑莓
					cardNo:_cardInfoJson.cardTypeId,
					phoneNumber:OrderInfo.getAccessNumber(prodId),
					areaId:OrderInfo.getProdAreaId(prodId),
					areaCode:areaCode,//归属地区号
					fromAreaCode:OrderInfo.staff.areaCode//漫游地区号
				};
				var resourceDataJson;
				var response = $.callServiceAsJson(serviceName, param);
				if(response.code == 0){
					resourceDataJson = response.data.cardInfo;
					_TransactionID = response.data.TransactionID;
				}else{
					$.alertM(response.data);
					return false;
				}
				//alert(JSON.stringify(response));
				var flag = resourceDataJson.flag;
				if (flag != undefined && flag == "0") {
					_rscJson = {
						"iccid":"",
						"imsi":"",
						"imsig":"",
						"data":"",
						"state":"Y",
						"uimid":"",
						"sid":"",
						"accolc":"",
						"nid":"",
						"akey":"",
						"pin1":"",
						"pin2":"",
						"puk1":"",
						"puk2":"",
						"imsilte":"",
//						"adm":"",
//						"hrpdupp":"",
//						"hrpdss":"",
//						"imsig":"",
//						"acc":"",
//						"smsp":"",
						"prodId":""
					};
					_rscJson.iccid = resourceDataJson.iccid;
					_rscJson.imsi = resourceDataJson.imsi;
					_rscJson.imsig = resourceDataJson.imsig;
					_rscJson.uimid = resourceDataJson.uimid;
					_rscJson.sid = resourceDataJson.sid;
					_rscJson.accolc = resourceDataJson.accolc;
					_rscJson.nid = resourceDataJson.nid;
					_rscJson.akey = resourceDataJson.akey;
					_rscJson.pin2 = resourceDataJson.pin2;
					_rscJson.pin1 = resourceDataJson.pin1;
					_rscJson.puk1 = resourceDataJson.puk1;
					_rscJson.puk2 = resourceDataJson.puk2;
					_rscJson.imsilte = resourceDataJson.imsilte;
					_rscJson.data = resourceDataJson.data;
					_rscJson.dataLength = resourceDataJson.dataLength;
					_rscJson.prodId = prodId;
					return true;
				} else {
					var msg = resourceDataJson.msg;
					if (msg != undefined) {
						$.alert("提示","请求可写卡的资源数据失败:" + msg,"error");
					} else {
						$.alert("提示","请求可写卡的资源数据失败" ,"error");
					}
					return false;
				}
			} catch(e) {
				$.alert("提示","请求可写卡的资源数据异常!" + e.message ,"error");
				return false;
			}
		};
	_completeWriteCard=function(result,resultCode){
			var serviceName = contextPath + "/mktRes/writeCard/completeWriteCard";
			var srInParam = {
				"areaId": OrderInfo.getProdAreaId(_rscJson.prodId),
			    "InoutInfo": {
			        "ApplyNo": "001",
			        "InoutId": "",
			        "BillType": "2",
			        "SaleNo": "",
			        "BatchId": "",
			        "OperationType": "1100",
			        "MktResStoreId": "",
			        "ChannelId": OrderInfo.staff.channelId,
			        "AreaId": OrderInfo.getProdAreaId(_rscJson.prodId),
			        "StaffId": OrderInfo.staff.staffId
			    },
			    "MktResInstInfos": [
			        {
			            "MktResInstInfo": {
			                "BaseInfo": {
			                    "MktResTypeCd": "",
			                    "StatusCd" : "2",
			                    "MktResId": "",
			                    "MktResCd": _cardInfoJson.cardTypeId,
			                    "MktResInstCode": _cardInfoJson.serialNumber,    //_rscJson.iccid,
			                    "SalesPrice": "0",
			                    "CostPrice": "0",
			                    "Quantity": "1",
			                    "Unit": "101"
			                },
			                
//			                60020005：ICCID
//			                60020002：C-IMSI(3G)
//			                60020003：G-IMSI
//			                60020004:L-IMSI(4G)
//			                65010026:PIN1
//			                65010027:PIN2
//			                65010028:PUK1
//			                65010029:PUK2
//			                65010030:管理密码(ADM)
//			                65010033:UIMID
//			                65010035:AKEY
//			                65010037:NID
//			                65010038:ACCOL
			                
			              "AttrList": [
			                             
								{
								    "AttrId": "60020005",
								    "AttrValue": _rscJson.iccid
								},
								{
								    "AttrId": "60020002",
								    "AttrValue": _rscJson.imsi
								},
								{
								    "AttrId": "60020003",
								    "AttrValue":  _rscJson.imsig
								},
								{
								    "AttrId": "60020004",
								    "AttrValue": _rscJson.imsilte
								},
								{
								    "AttrId": "65010026",
								    "AttrValue": _rscJson.pin1
								},
								{
								    "AttrId": "65010027",
								    "AttrValue": _rscJson.pin2
								},
								{
								    "AttrId": "65010028",
								    "AttrValue": _rscJson.puk1
								},
								{
								    "AttrId": "65010029",
								    "AttrValue": _rscJson.puk2
								},
								{
								    "AttrId": "65010030",
								    "AttrValue": _rscJson.adm
								},
								{
								    "AttrId": "65010033",
								    "AttrValue":  _rscJson.uimid
								},
								{
								    "AttrId": "65010035",
								    "AttrValue": _rscJson.akey
								},  
								{
								    "AttrId": "65010037",
								    "AttrValue": _rscJson.nid
								},
								{
								    "AttrId": "65010038",
								    "AttrValue": _rscJson.accolc
								},
								{
								    "AttrId": "60029003",
								    "AttrValue": OrderInfo.staff.channelId
								},
								{
								    "AttrId": "60029004",
								    "AttrValue": _cardDllInfoJson.remark
								},
								{
								    "AttrId": "60029005",
								    "AttrValue": ocx.GetDllVersion()
								},
								{
								    "AttrId": "65010019",
								    "AttrValue": OrderInfo.getProdAreaId(_rscJson.prodId)
								}
			                ]
			            }
			        }
			    ]
					
			};
			var param = {
				imsi:_rscJson.imsi,     
				iccserial:_cardInfoJson.serialNumber,     
				iccid:_rscJson.iccid,  
				resultCode:result,
				resultMessage:"写卡器返回结果编码"+resultCode,
				phoneNumber:OrderInfo.getAccessNumber(_rscJson.prodId),
				cardType:_cardInfoJson.cardTypeId,
				eventType:"2",
				areaId:OrderInfo.getProdAreaId(_rscJson.prodId),
				serviceCode:OrderInfo.busitypeflag,//新增一个动作表示，用于记日志update by huangjj
				TransactionID:_TransactionID,
				remark:_cardDllInfoJson.remark,
				"srInParam":srInParam
			};
			try {
				
				var eventJson;
				var response = $.callServiceAsJson(serviceName, param);
				eventJson = response.data;
				//alert(JSON.stringify(response));
				
				if (!response) {
					$.alert("提示","<br/>调用卡资源回填到卡管系统异常,请稍后重试。");
					return;
				}
				if(response.code == -2) {
					$.alertM(response.data);
					return;
				} else if(response.code != 0) {
					$.alert("提示","<br/>调用卡资源回填到卡管系统异常,请稍后重试。");
					return;
				}
				//var eventJson = response.data;
				if (eventJson.code != 0) {
					$.alert("提示","调用卡资源回填到卡管系统异常！" + eventJson.message,"error");
					return;
				}
//				var flag = eventJson.code;
//				var msg = eventJson.message;
//				if (flag != "0") {
//					$.alertM(response.data);
//					//$.alert("提示","调用卡资源回填到卡管系统异常！" + msg,"error");
//					return false;
//				}

				if(response.code == 0) {
					 //写卡成功后把卡数据入库便于异常单释放
					var phoneNumber = OrderInfo.getAccessNumber(_rscJson.prodId);
					var inParam = {
							"instCode" : $("#resultCardAsciiFStr").val(),
							"phoneNum" : phoneNumber,
							"remark":$("#selUimType").val(),//
							"areaId"   : OrderInfo.getProdAreaId(_rscJson.prodId)
					};
					var serviceUrl = contextPath + "/mktRes/writeCard/intakeSerialNumber";
					$.callServiceAsJson(serviceUrl, inParam);
				}
				_backFillOrderCardInfo(eventJson.result);
				return true;
			} catch(e) {
				$.alert("提示","调用卡资源回填到卡管系统异常！" + e.message,"error");
				return false;
			}
	};
	_backFillOrderCardInfo=function(result){
		//要求截取前19位编码
		if (_rscJson.iccid.length==20){
			_rscJson.iccid = _rscJson.iccid.substr(0,_rscJson.iccid.length-1);
		}
		 $("#uim_txt_"+_rscJson.prodId).val($("#resultCardAsciiFStr").val());
		 var coupon= {
					couponUsageTypeCd : "3", //物品使用类型
					inOutTypeId : "1",  //出入库类型
					inOutReasonId : 0, //出入库原因
					saleId : 1, //销售类型
					couponId :result.mktResId, //物品ID
					couponinfoStatusCd : "A", //物品处理状态
					chargeItemCd : CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD, //物品费用项类型
					couponNum : "1", //物品数量
					storeId : result.mktStoreId, //仓库ID
					storeName : "11", //仓库名称
					agentId : 1, //供应商ID
					apCharge : 0, //物品价格
					couponInstanceNumber : _cardInfoJson.serialNumber,  //物品实例编码 _rscJson.iccid
					ruleId : "", //物品规则ID
					partyId : OrderInfo.cust.custId, //客户ID
					prodId :_rscJson.prodId, //产品ID
					offerId : "", //销售品实例ID
					state : "ADD", //动作
					cardTypeFlag:2,
					uimType:"2",//标识用于订单成功更新订单状态
					relaSeq : "" //关联序列	
				};
		 if(ec.util.isObj(_cardInfoJson.cardTypeId)) {
			 var uimCardType = prod.uim.getCardType("", "", _cardInfoJson.serialNumber);
			 if (CONST.UIMTYPE3G4G.IS4G == uimCardType) {//4G卡
				 coupon.cardTypeFlag = 1;
			 }
			 //补换卡和异地补换卡增加4g卡不能补3g卡的限制
			 if(prod.changeUim.is4GProdInst&&(OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23)){//判断是否有开通4G功能产品
					if(CONST.UIMTYPE3G4G.IS3G==uimCardType){
						$.alert("信息提示","您已开通了【4G（LTE）上网】功能产品，而UIM卡是3G卡，请使用4G的白卡！");
						return false;
					}
				}
		 }
         if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==14){
         	coupon.offerId = "-1";
         }else{
         	coupon.offerId = order.prodModify.choosedProdInfo.prodOfferInstId; //销售品实例ID
         }
 		 OrderInfo.clearProdUim(_rscJson.prodId);
         OrderInfo.boProd2Tds.push(coupon);
         if((OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23) && coupon.cardTypeFlag==1 && order.prodModify.choosedProdInfo.productId != '280000000'){
        	AttachOffer.openServList = [];
     		AttachOffer.openList = [];
     	    AttachOffer.queryCardAttachOffer(coupon.cardTypeFlag);  //加载附属销售品
      	 }
 		//3转4弹出促销窗口
 		if(OrderInfo.actionFlag!=1 && order.prodModify.choosedProdInfo.prodClass== "3"  && coupon.cardTypeFlag==1){
 			$("#isShow_"+prodId).show();
 			var prodSpecId = OrderInfo.getProdSpecId(prodId);
 			var param = {
 				prodSpecId : prodSpecId,
 				offerSpecIds : [],
 				queryType : "3",
 				prodId : productId,
 				partyId : OrderInfo.cust.custId,
 				ifCommonUse : "",
 				if3Up4:"Y"
 			};
 			var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
 			var accNbr = prodInfo.accNbr;
 			param.acctNbr = accNbr;
 			if(!ec.util.isObj(prodInfo.prodOfferId)){
 				prodInfo.prodOfferId = "";
 			}
 			var offerRoleId = CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;
 			if(offerRoleId==undefined){
 				offerRoleId = "";
 			}
 			param.offerRoleId = offerRoleId;
 			param.offerSpecIds.push(prodInfo.prodOfferId);
 			var data = query.offer.queryCanBuyAttachSpec(param);
 			if(data!=undefined && data.resultCode == "0"&&data.result.offerSpecList.length>0){
 				var content = '<form id="promotionForm"><table>';
 				var selectStr = "";
 				var optionStr = "";
 				selectStr = selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+accNbr+"><br>"; 
 				$.each(data.result.offerSpecList,function(){
 					var offerSpec = this;
 					optionStr +='<option value="'+this.offerSpecId+'">'+this.offerSpecName+'</option>';
 				});
 				selectStr += optionStr + "</select></td></tr>"; 
 				content +=selectStr;
 				var offerSpecId;
 				$.confirm("促销包选择",content,{ 
 					yes:function(){	
 						
 					},
 					no:function(){
 						
 					}
 				});
 				$('#promotionForm').bind('formIsValid', function(event, form) {
 					offerSpecId = $('#'+accNbr+' option:selected').val();
 					$(".ZebraDialog").remove();
 	                $(".ZebraDialogOverlay").remove();
 	                AttachOffer.selectAttachOffer(productId,offerSpecId);
 				}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
 				
 			}
 		}
	};
	var _getCardType=function(){
		var response = $.callServiceAsJson(contextPath + "/mktRes/writeCard/getCardType", {});
		if(response.code == 0){
			if(response.data){
				_4GCARDS=[];
				for(var n=0;n<response.data.length;n++){								
					if(response.data[n].COLUMN_VALUE!="00311"){	
						_4GCARDS.push(response.data[n].COLUMN_VALUE);
					}								
				}
				return true;
			}
		}else{
			$.alertM(response.data);
			return false;
		}
		return false;
	};
	return {
		writeReadCard : _writeReadCard,
		readCard : _readCard,
		writeCard : _writeCard,
		getCardType : _getCardType
	};
})();


CommonUtils.regNamespace("order", "area");

var ztree=null;
var areaType = null ;
var areaNameVal = "" ;

/**
 *地区字典.
 */
order.area = (function(){
	
	//获取查询类维度权限
	var _chooseAreaTreeManger = function(_type,_areaName,_areaId,_areaLeve,_areaLimit){
		_chooseAreaTreeMain(_type,_areaName,_areaId,_areaLeve,contextPath + '/orderQuery/areaTreeManger',null,_areaLimit);
	};
	//获取业务类维度权限
	var _chooseAreaTree = function(_type,_areaName,_areaId,_areaLeve,callBackFun){
		_chooseAreaTreeMain(_type,_areaName,_areaId,_areaLeve,contextPath + '/orderQuery/areaTree',callBackFun);
	};
	//获取一卡双号查询维度权限
	var _chooseAreaTreeQueryManger = function(_type,_areaName,_areaId,_areaLeve,_areaLimit){
		_chooseAreaTreeMain(_type,_areaName,_areaId,_areaLeve,contextPath + '/orderQuery/areaTreeQueryManger',null,_areaLimit);
	};
	var _chooseAreaTreeMain = function(_type,_areaName,_areaId,_areaLeve,url,callBackFun,_areaLimit){
		if(!login.windowpub.checkLogin()){
			return ;
		}
		var areaId = _areaId;
		var areaName = _areaName ;
		var v_url = url + '?areaType='+_type+"&areaLeve="+_areaLeve+"&areaLimit="+_areaLimit;
		$.ligerDialog.open({
			width:350,
			height:350,
			title:'请选择地区(*不可选)',
			url:v_url,
			buttons: [ { text: '确定', onclick: function (item, dialog) { 
						if (!ztree) {
							//alert("无可选地区！");
							return;
						}
						var node=ztree.getSelected();
						if(node){
							if(node.data.isAllRegionFlag=="Y" ||_areaId == "p_password_areaId"){
								//余额查询/支取以及反销账，限制选择本地网，确保areaCode入参
								if(_type=="bill/preQueryBalance" || _type=="bill/prePayBalance" || _type=="bill/reversewriteoffcash"){
									if(!node.data.regionCode || node.data.regionCode==""){
										$.alert("提示", "请选择本地网（地市级）地区");
										return;
									}
								}
								var areaIdTemp = node.data.commonRegionId;
								areaIdTemp = (""+areaIdTemp).replace("ch","");
								$('#'+areaId).val(areaIdTemp);
								$('#'+areaId).attr("areaCode",node.data.regionCode);
								var areaNameVals=areaNameVal.split(">");
								if(areaNameVals.length>2){
									$('#'+areaName).val($.trim(areaNameVals[1])+" > "+$.trim(areaNameVals[2]));
								}else{
									$('#'+areaName).val(areaNameVal);
								}
								if(callBackFun){
									callBackFun(areaIdTemp,node.data.regionCode,areaNameVal);
								}
								dialog.close();
								obj=areaNameVal;
								//产品通用查询页面更改地区时初始化查询条件
								if(_type=="prod/preProdQuery"){
									if(product.query.areaId!=$("#p_areaId").val()){
										if($("#custName").val()!="" || $("#num").val()!=""){
											$.alert("提示","地区已变更，请重新定位产品");
										}
										$("#prodList").html("");
										$("#custName").val("").attr("name", "");
										$("#num").val("");
										product.query.areaId = $("#p_areaId").val();	
									}
								}
								//帐户详情查询页面更改地区时初始化查询条件
								if(_type=="acct/preQueryAccount"){
									if(account.query.areaId!=$("#p_areaId").val()){
										if($("#custName").val()!="" || $("#num").val()!=""){
											$.alert("提示","地区已变更，请重新定位帐户");
										}
										$("#acctList").html("");
										$("#custName").val("").attr("name", "");
										$("#num").val("");
										account.query.areaId = $("#p_areaId").val();	
									}
								}
							}else{
								alert("当前地区不可选！");
								//alert("当前地区不可选！");
							}
						}else{
							alert("请选择地区！");
						}
					} },
			           { text: '取消', onclick: function (item, dialog) { dialog.close(); } } ] 	
		});
	};
	
	//获取全部地区维度
	var _chooseAreaTreeAll = function(_areaName,_areaId,_areaLeve,_areaLimit){
		if(_areaId!="p_password_areaId"){
			if(!login.windowpub.checkLogin()){
				return ;
			}
	    }
		var areaId = _areaId;
		var areaName = _areaName ;
		$.ligerDialog.open({
			width:350,
			height:350,
			title:'请选择地区',
			url:contextPath + '/orderQuery/areaTreeAll?areaLeve='+_areaLeve+"&areaLimit="+_areaLimit,
			buttons: [ { text: '确定', onclick: function (item, dialog) { 
						if(!ztree) {
							return;
						}
						var node=ztree.getSelected();
						if(node){
							if(node.data.isAllRegionFlag=="Y" ||_areaId == "p_password_areaId"){
								$('#'+areaId).val(node.data.commonRegionId);
								$('#'+areaId).attr("areaCode",node.data.regionCode);
								$('#'+areaName).val(areaNameVal);
								dialog.close();
							}else{
								alert("当前地区不可选！");
							}
						}else{
							alert("请选择地区！");
						}
					} },
			           { text: '取消', onclick: function (item, dialog) { dialog.close(); } } ] 	
		});
	};
	//获取制定地区(_currentAreaId)树
	var _chooseAreaTreeCurrent = function(_areaName,_areaId,_areaLeve,_areaLimit,_currentAreaId){
		if(!login.windowpub.checkLogin()){
			return ;
		}
		var areaId = _areaId;
		var areaName = _areaName ;
		$.ligerDialog.open({
			width:350,
			height:350,
			title:'请选择地区',
			url:contextPath + '/orderQuery/areaTreeAll?areaLeve='+_areaLeve+"&areaLimit="+_areaLimit+"&areaId="+_currentAreaId,
			buttons: [ { text: '确定', onclick: function (item, dialog) { 
						if(!ztree) {
							return;
						}
						var node=ztree.getSelected();
						if(node){
							if(node.data.isAllRegionFlag=="Y" || _areaId=="p_staff_areaId"){
								$('#'+areaId).val(node.data.commonRegionId);
								$('#'+areaId).attr("areaCode",node.data.regionCode);
								$('#'+areaName).val(areaNameVal);
								dialog.close();
							}else{
								
							}
						}else{
							
						}
					} },
			           { text: '取消', onclick: function (item, dialog) { dialog.close(); } } ] 	
		});
	};
	//获取计费功能地区维度与省份编码（原计费使用，已弃用）
	var _flatAreaPageDialog=null;
	var nameId;
	var valId;
	var _flatAreaPage = function(val_id,name_id){
		nameId=name_id;
		valId=val_id;
		_flatAreaPageDialog=$.ligerDialog.open({
			width:400,
			height:320,
			title:'请选择地区',
			url:contextPath + '/orderQuery/tree_flat',
			buttons: [ 
			           { text: '取消',onclick: function (item, dialog) { dialog.close(); } } ]
			           
		});
	};
	var _areaChecked=function( val,name){
		if(_flatAreaPageDialog!=null){
			if(valId&&$("#"+valId)){
				$("#"+valId).val(val);
			}
			if(nameId&&$("#"+nameId)){
				$("#"+nameId).val(name);
			}
			_flatAreaPageDialog.close();
		}
	};
	var _dicInitEnd = function(){
		$.unecOverlay();
		$("#dic_mess").hide();
		//alert(111);
		$("#commonRegionTree").show();
	};
	
	return {
		areaChecked:_areaChecked,
		flatAreaPage:_flatAreaPage,
		chooseAreaTree:		_chooseAreaTree,
		chooseAreaTreeAll:	_chooseAreaTreeAll,
		chooseAreaTreeCurrent:	_chooseAreaTreeCurrent,//add by wd 2014/12/14  只 用于发展人选择 弹窗口中的地区选择  
		chooseAreaTreeManger:_chooseAreaTreeManger,
		dicInitEnd:_dicInitEnd,
		chooseAreaTreeQueryManger:_chooseAreaTreeQueryManger //用于一卡双号弹窗选择地区，可以选择全国省市
	};
	
})();


/**
 * 补换卡
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("prod","changeUim");

prod.changeUim = (function() {
	
	var _is4GProdInst = null; //是否是4G产品实例
	
	//初始化
	var _init = function(){
		var prodInfo = order.prodModify.choosedProdInfo;
		//客户级规则校验入参
		var param = {
			"areaId" : OrderInfo.staff.soAreaId, //地区ID
			"custId" : OrderInfo.cust.custId, //客户ID
			"staffId" : OrderInfo.staff.staffId,
			"channelId" : OrderInfo.staff.channelId,
			"boInfos":[{
				"boActionTypeCd": CONST.BO_ACTION_TYPE.CHANGE_CARD,//动作类型
			    "instId" : prodInfo.prodInstId, //实例ID
			    "specId" : CONST.PROD_SPEC.CDMA //产品（销售品）规格ID
			}]
		};
		var area = $("#DiffPlaceFlag").val();
		var actionFlag = 22;
		var areaAtionType = "";
		var opeName = "";
		if(area=="diff"){
			actionFlag = 23;
			areaAtionType = CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD;
			param.boInfos[0].boActionTypeCd = CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD;//异地补换卡，动作类型boActionTypeCd需要改为DIFF_AREA_CHANGE_CARD
			opeName = "异地补换卡";
			var areaid = prodInfo.areaId;
			if(areaid==undefined || areaid==''){
				$.alert("提示","营业后台未返回产品归属地区，无法办理异地补换卡业务！");
				return false;
			}
		}else{
			areaAtionType = CONST.BO_ACTION_TYPE.CHANGE_CARD;
			opeName = "补换卡";
		}
		var callParam = {
			prodId : prodInfo.prodInstId 	
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,areaAtionType,actionFlag,opeName,"");
		rule.rule.prepare(param,'prod.changeUim.initFillPage',callParam);
	};
	
	
	//初始化填单页面
	var _initFillPage = function(param){
		if(!prod.uim.setProdUim()){ //根据UIM类型，设置产品是3G还是4G，并且保存旧卡
			return false;
		}
		var prodInfo = order.prodModify.choosedProdInfo;
		$.callServiceAsHtml(contextPath+"/prod/changeCard", param, {
			"before":function(){
			},
			"done" : function(response){
				$("#order_fill_content").html(response.data).show();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$("#nothreelinks").css("display","none");
				$(".ordercon").show();
				$(".ordertabcon").show();
				$(".h2_title").append(prodInfo.productName+"-"+prodInfo.accNbr);
				order.prepare.step(1);
				$("#orderedprod").hide();
				$("#order_prepare").hide();
//				alert($("#DiffPlaceFlag").val());
				if($("#DiffPlaceFlag").val() == 'diff'){
					$("#uim_txt_" + prodInfo.prodInstId).css("display","none");
					$("#uim_check_btn_" + prodInfo.prodInstId).css("display","none");
					$("#uim_release_btn_" + prodInfo.prodInstId).css("display","none");
					$("#uim_lable").text("写卡：");
				}
				order.dealer.initDealer();
				//_queryAttachOffer();
			},
			"always":function(){
				$.unecOverlay();
			}
		});
		
		prod.changeUim.is4GProdInst = query.prod.checkIs4GProdInst(prodInfo); //设置是否是4G产品实例
	};
	
	//订单提交
	var _submit = function(){
		var prod = order.prodModify.choosedProdInfo;
		var param = {
			prodId : prod.prodInstId,	
			boActionTypeCd : OrderInfo.boActionTypeCd,
			remark : $("#order_remark").val()
		};
		var busiOrder = [];
		busiOrder.push(OrderInfo.getProdBusiOrder(param));
		AttachOffer.setAttachBusiOrder(busiOrder);	
	    SoOrder.submitOrder(busiOrder);
	};
	
	var _changeUimSel = function (scope){
		$("#selUimType").val($(scope).val());
	};
	
	return {
		init				: _init,
		initFillPage		: _initFillPage,
		submit 				: _submit,
		is4GProdInst		: _is4GProdInst,
		changeUimSel        : _changeUimSel
	};
})();
CommonUtils.regNamespace("acct", "acctModify");
/**
 * 二次业务帐户信息修改
 */
acct.acctModify = (function(){
	//这几个节点将用来装旧帐户信息
	var boAccountInfoDEL = {};
	var boPaymentAccountDEL = {};
	var boAccountMailingDEL = {};
	//修改帐户信息规则校验
	var _showAcctInfoModify = function(){
		var param = order.prodModify.getCallRuleParam(CONST.BO_ACTION_TYPE.ACCTINFOMODIFY,order.prodModify.choosedProdInfo.prodInstId);
		var callParam = {
				boActionTypeCd : CONST.BO_ACTION_TYPE.ACCTINFOMODIFY,
				boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ACCTINFOMODIFY),
				accessNumber : order.prodModify.choosedProdInfo.accNbr,
				prodOfferName : order.prodModify.choosedProdInfo.prodOfferName
			};

		var checkRule = rule.rule.prepare(param,'acct.acctModify.acctInfoModify',callParam);
		if (checkRule) return ;
//		SoOrder.builder();
		OrderInfo.initData(CONST.ACTION_CLASS_CD.ACCT_ACTION,CONST.BO_ACTION_TYPE.ACCTINFOMODIFY,10,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ACCTINFOMODIFY),"");	
	};
	
	//获取产品下帐户信息，跳转并初始化修改帐户信息页面
	var _acctInfoModify = function(){
		if(!order.prodModify.choosedProdInfo.prodInstId || !order.prodModify.choosedProdInfo.accNbr){
			$.alert("提示","产品信息定位异常，请联系管理员");
			$("#orderedprod").show();
			$("#order_prepare").show();
			$("#order_tab_panel_content").show();
			$("#order_confirm").show();
			$("#order_fill_content").hide();
			order.prepare.hideStep();
			return;
		}		
		var param={
				prodId : order.prodModify.choosedProdInfo.prodInstId,
				acctNbr : order.prodModify.choosedProdInfo.accNbr
		};
		$.callServiceAsHtml(contextPath + "/order/prodModify/acctInfoModify", param, {
			"before":function(){
				$.ecOverlay("<strong>正在确认当前产品帐户,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},						
			"done":function(response){
				if(response.code!=0){
					$.alert("提示","无法确认当前产品帐户，请联系管理员");
					$("#orderedprod").show();
					$("#order_prepare").show();
					$("#order_tab_panel_content").show();
					$("#order_confirm").show();
					$("#order_fill_content").hide();
					order.prepare.hideStep();
					return;
				}
				$("#order_fill_content").html(response.data).show();
				$(".h2_title").append(order.prodModify.choosedProdInfo.productName+"-"+order.prodModify.choosedProdInfo.accNbr);
				_chooseAcctToModify("#acctInfoList tr",$("#acctInfoList").children(":first-child"));
				$("#acctInfoList tr").each(function(){$(this).off("click").on("click",function(event){
					_chooseAcctToModify("#acctInfoList tr",this);
					event.stopPropagation();
					});
				});				
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
			}
		});
	};
	
	//切换展示要修改的帐户信息
	var _chooseAcctToModify = function(trs, $tr){
		$(trs).removeClass("plan_select");
		$(trs).children(":first-child").html("");
		$($tr).addClass("plan_select");
		$($tr).children(":first").html("<i class='select'></i>");
		//查询要修改的帐户详情
		var param = {
				acctId : $tr.attr("id")
		};
		var response = $.callServiceAsHtml(contextPath + "/order/prodModify/queryAcctDetailInfo", param);											
//		if(response.errorsList!=undefined && response.errorsList!="null"){					
//			$.alert("提示", response.errorsList);									
//		} 	
		if(response.code!=0){
			$("#acctInfoDetail").html("账户信息加载失败").show();
			return;
		}
		$("#acctInfoDetail").html(response.data).show();
		_getBILL_POST();	
		//删去重复加载的选择项
		var postTypes = $("#postType option:not(:first)");				
		$.each(postTypes, function(i, postType){					
			if($(postType).val()==$("#postType option:first").val()){						
				$(postType).remove();
				return false;
			}
		});
		var billContents = $("#billContent option:not(:first)");
		$.each(billContents, function(i, billContent){
			if($(billContent).val()==$("#billContent option:first").val()){
				$(billContent).remove();
				return false;
			}
		});
		var postCycles = $("#postCycle option:not(:first)");
		$.each(postCycles, function(i, postCycle){
			if($(postCycle).val()==$("#postCycle option:first").val()){
				$(postCycle).remove();
				return false;
			}
		});
		//帐户信息显示或隐藏初始化
		_paymentType();
		_billPostType();
		if($("#billContent").val()==14){
			$("#receipt").show();
		}
		//记录旧的帐户信息
		boAccountInfoDEL = {
				acctCd : $("#acctInfoList .plan_select td:eq(0)").attr("id"),        //*帐户合同号
				acctName : $("#acctName").val(),                            //*帐户名称
				acctTypeCd : "1",
				partyId : $("#partyId").val(),                              //*客户ID
				prodId : order.prodModify.choosedProdInfo.prodInstId,       //产品ID
				state : "DEL"
		};
		boPaymentAccountDEL = {
				bankAcct : $("#bankAcct").val(),
				bankId : $("#bankId").val(),
				limitQty : "1",
				paymentAcctTypeCd : $("#paymentType").val(),     //*支付类型 100000:现金 110000:银行 
				paymentAccountId : $("#paymentType").attr("name"),
				paymentMan : $("#paymentMan").val(),
				state : "DEL"
		};
		if($("#postType").val()!=-1){
			boAccountMailingDEL = {
					mailingType : $("#postType").val(),   //*投递方式
					param1 : $("#postAddress").val(),     //*投递地址
					param2 : "1",                         //格式ID
					param3 : $("#postCycle").val(),       //*投递周期
					param7 : $("#billContent").val(),     //*账单内容
					state : "DEL"
			};
			if($("#postType").val()==11 || $("#postType").val()==15){
				boAccountMailingDEL.param1 = $("#postAddress").val()+","+$("#zipCode").val()+","+$("#consignee").val(); //*收件地址,邮编,收件人			
			}
		}
		else{
			boAccountMailingDEL = {};
		}
	};
	
	//查询工号权限：能否选择银行托收
	var _ifCanAdjustBankPayment = function(){
		var jr = $.callServiceAsJson(contextPath+"/acct/ifCanAdjustBankPayment", {});
		if(jr.data=="0"){
			$("#paymentType").append("<option value='110000'>银行</option>");
		}
	};
	
	//获取账单投递信息主数据	
	var _getBILL_POST = function(showNewDetail){
		var configParam = {
				CONFIG_PARAM_TYPE : "BILL_POST"
		};				
		var qryConfigUrl=contextPath+"/order/queryApConf";	
		var jr = $.callServiceAsJsonGet(qryConfigUrl, configParam);
		if(jr.code==0 && jr.data){
			for(var n=0;n<jr.data.length;n++){								
				//账单投递方式								
				if(jr.data[n].BILL_POST_TYPE){									
					$.each(jr.data[n].BILL_POST_TYPE, function(i, postType){										
						$("<option>").attr("value",postType.COLUMN_VALUE).text(postType.COLUMN_VALUE_NAME).appendTo($("#postType"));									
					});								
				}								
				//账单投递内容								
				else if(jr.data[n].BILL_POST_CONTENT){									
					$.each(jr.data[n].BILL_POST_CONTENT, function(i, postContent){										
						$("<option>").attr("value",postContent.COLUMN_VALUE).text(postContent.COLUMN_VALUE_NAME).appendTo($("#billContent"));									
					});								
				}								
				//账单投递周期								
				else if(jr.data[n].BILL_POST_CYCLE){									
					$.each(jr.data[n].BILL_POST_CYCLE, function(i, postCycle){										
						$("<option>").attr("value",postCycle.COLUMN_VALUE).text(postCycle.COLUMN_VALUE_NAME).appendTo($("#postCycle"));									
					});								
				}							
			}
			if(showNewDetail){
				showNewDetail();
			}
		}
		//新装--二次加载
		if(OrderInfo.newOrderInfo.isReloadFlag=="N"&&OrderInfo.newOrderInfo.acctCd=="-1"){		
			$("#acctName").val(OrderInfo.newOrderInfo.acctName);//帐户名称为客户名称
			$("#paymentType").find("option[value='"+OrderInfo.newOrderInfo.paymentAcctTypeCd+"']").attr("selected","selected");
		}
		if(OrderInfo.newOrderInfo.isReloadFlag=="N"){
			$("#postType").find("option[value='"+OrderInfo.newOrderInfo.mailingType+"']").attr("selected","selected");
			if(OrderInfo.newOrderInfo.mailingType!=""&&OrderInfo.newOrderInfo.mailingType!=-1){
				_billPostType();//进行账单投递方式初始化
				//显示其他信息
				$("#postAddress").show();
				//$(".billPost").show();
				$("#billContent").show();
				$("#postCycle").show();
				if($("#postType").val()==11 ||$("#postType").val()==15){				
					var str=OrderInfo.newOrderInfo.param1.split(",");
					for(var i=0;i<str.length;i++){
						if(i==0){
							$("#postAddress").val(str[i]);//收件地址
						}else if(i==1){
							$("#zipCode").val(str[i])//邮编
						}else if(i==2){
							$("#consignee").val(str[i])//收件人
						}
					}
				}else{
					$("#postAddress").val(OrderInfo.newOrderInfo.param1);//账单投递地址
				}
				//账单内容
				$("#billContent").find("option[value='"+OrderInfo.newOrderInfo.param7+"']").attr("selected", "selected");
				//投递周期
				$("#postCycle").find("option[value='"+OrderInfo.newOrderInfo.param3+"']").attr("selected", "selected");
			}
		}
	};
	
	//选择支付方式
	var _paymentType = function(){
		if($("#paymentType").val()==100000){
			$(".bank").hide();
			$("#paymentType").parent().addClass("full");
		}
		else{
			$(".bank").show();
			$("#paymentType").parent().removeClass("full");
		}
	};
	
	//选择账单投递方式
	var _billPostType = function(){
		if($("#postType").val()==-1){
			$(".billPost").hide();
			$("#postType").parent().addClass("full");
			$("#billContent").find("option[value=11]").attr("selected","selected");
			$("#postType").find("option[value=12]").show();
			$("#postType").find("option[value=13]").show();
			$("#postType").find("option[value=14]").show();
			$("#receipt").hide();
		}
		else{
			$(".billPost").show();
			$("#postType").parent().removeClass("full");
			if($("#postType").val()==12){
				$("#postAddress").attr("placeHolder","请输入有效的传真号码");
			}
			else if($("#postType").val()==13){
				$("#postAddress").attr("placeHolder","请输入有效的Email地址");
			}
			else if($("#postType").val()==14){
				$("#postAddress").attr("placeHolder","请输入有效的手机号");
			}
			else{
				$("#postAddress").attr("placeHolder","请输入准确的收件地址");
			}
		}
	};
	
	//选择账单内容（发票不支持电子投递方式）
	var _billContent = function(){
		if($("#billContent").val()==14){						
			if($("#postType").val()==12 || $("#postType").val()==13 || $("#postType").val()==14){
				$("#postType").find("option[value=11]").attr("selected","selected");
				$("#postAddress").val("");
				$("#postAddress").attr("placeHolder","请输入准确的收件地址");
			}
			$("#postType").find("option[value=12]").hide();
			$("#postType").find("option[value=13]").hide();
			$("#postType").find("option[value=14]").hide();
			$("#receipt").fadeIn("slow");
		}
		else{			
			$("#postType").find("option[value=12]").show();
			$("#postType").find("option[value=13]").show();
			$("#postType").find("option[value=14]").show();
			$("#receipt").fadeOut("slow");
		}
	};
	
	//地区查询（银行查询弹出框）
	var _queryAllArea = function(){
		order.area.chooseAreaTreeAll("p_bank_areaId_val","p_bank_areaId",3);
	};
	
	//银行查询
	var _queryBank = function(pageIndex){
		var _bank;
		var _curPage = 1;
		if(pageIndex==0){
			_bank = {
					name : "",
					bankId : "",
					simpleSpell : "",
					commonRegionId : ""
			};
		}
		if(pageIndex>0){
			_curPage = pageIndex;
			_bank = {
					name : $("#p_bandkname").val(),
					bankId : "",
					simpleSpell : $("#p_simpleSpell").val(),
					commonRegionId : $("#p_bank_areaId").val()
			};
		}
		var param = {				
				bank : _bank,
				curPage : _curPage,
				pageSize : 10
		};
		$.callServiceAsHtml(contextPath + "/acct/getBankList",param,{
			"before":function(){
				$.ecOverlay("<strong>银行查询中,请稍等....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if(!response){
					response.data='';
				}
				$("#div_bank_dialog").html(response.data);				
				$("#bank_list tr").each(function(){$(this).off("click").on("click",function(event){
					_chooseBank("#bank_list tr",this);
					event.stopPropagation();
					});
				});
				easyDialog.open({
					container : "div_bank_dialog"
				});				
			}
		});	
	};
	
	//选定银行
	var _chooseBank = function(trs, $tr){
		$(trs).removeClass("plan_select");
		$(trs).children(":first-child").html("");
		$($tr).addClass("plan_select");
		$($tr).children(":first").html("<i class='select'></i>");
	};
	
	//在页面上添加选定的银行信息
	var _fillBankInfo = function(){
		var $bank = $("#bank_list .plan_select");
		$("#bankId").val($($bank).attr("id"));
		$("#bankName").val($($bank).find("td:eq(2)").text());
		if($bank.length > 0){
			easyDialog.close();
		}
		else{
			$.alert("操作提示","请选择银行！");
		}
	};
	
	//帐户信息修改：订单提交
	var _acctInfoModify_Submit = function() {
		//帐户信息填写校验
		if(!SoOrder.checkAcctInfo()){
			return;
		}			
		//订单报文开始组装
		var _busiOrder = {
				areaId : order.prodModify.choosedProdInfo.areaId,
				boActionType : {
					actionClassCd : CONST.ACTION_CLASS_CD.ACCT_ACTION,
					boActionTypeCd : CONST.BO_ACTION_TYPE.ACCTINFOMODIFY
				},
				busiObj : {
					accessNumber : order.prodModify.choosedProdInfo.accNbr,
					instId :  $("#acctInfoList .plan_select").attr("id"), //帐户ID
					isComp : "N",
					objId : "",
					offerTypeCd : "1"
				},
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				},
				data : {
					boAccountInfos : [],
					boAcct2PaymentAccts : [],
					boAccountItems : [],
					boPaymentAccounts : [],
					boAccountMailings : []
				}
		};
		//帐户基本信息节点
		var boAccountInfoADD = {
				acctCd : $("#acctInfoList .plan_select td:eq(0)").attr("id"),        //*帐户合同号
				acctName : $("#acctName").val(),                            //*帐户名称
				acctTypeCd : "1",
				partyId : $("#partyId").val(),                              //*客户ID
				prodId : order.prodModify.choosedProdInfo.prodInstId,       //产品ID
				state : "ADD"
		};
		_busiOrder.data.boAccountInfos.push(boAccountInfoDEL);
		_busiOrder.data.boAccountInfos.push(boAccountInfoADD);
		//帐户付费关联关系节点
		var boAcct2PaymentAcctADD = {
				priority : "1",
				paymentAccountId : $("#paymentType").attr("name"),
				state : "ADD"
		};
		_busiOrder.data.boAcct2PaymentAccts.push(boAcct2PaymentAcctADD);
		//帐户支付信息节点
		var boPaymentAccountADD = {
				bankAcct : "",
				bankId : "",
				limitQty : "1",
				paymentAcctTypeCd : $("#paymentType").val(),     //*支付类型 100000:现金 110000:银行 
				paymentAccountId : $("#paymentType").attr("name"),
				paymentMan : "",
				state : "ADD"
		};
		if($("#paymentType").val()==110000){
			boPaymentAccountADD.bankAcct = $("#bankAcct").val();        //*银行帐号
			boPaymentAccountADD.bankId = $("#bankId").val();            //*银行ID
			boPaymentAccountADD.paymentMan = $("#paymentMan").val();    //支付人
		}
		_busiOrder.data.boPaymentAccounts.push(boPaymentAccountDEL);
		_busiOrder.data.boPaymentAccounts.push(boPaymentAccountADD);
		//账单投递信息节点
		if(boAccountMailingDEL.mailingType){
			_busiOrder.data.boAccountMailings.push(boAccountMailingDEL);
		}
		if($("#postType").val()!=-1){
			var boAccountMailingADD = {
					mailingType : $("#postType").val(),   //*投递方式
					param1 : $("#postAddress").val(),     //*投递地址
					param2 : "1",                         //格式ID
					param3 : $("#postCycle").val(),       //*投递周期
					param7 : $("#billContent").val(),     //*账单内容
					state : "ADD"
			};
			if($("#postType").val()==11 || $("#postType").val()==15){				
				boAccountMailingADD.param1 = $("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val(); //*收件地址,邮编,收件人			
			}
			_busiOrder.data.boAccountMailings.push(boAccountMailingADD);
		}
		var busiOrder = [];
		busiOrder.push(_busiOrder);
		SoOrder.submitOrder(busiOrder);
	};
	
	return{
		showAcctInfoModify : _showAcctInfoModify,
		acctInfoModify : _acctInfoModify,
		ifCanAdjustBankPayment : _ifCanAdjustBankPayment,
		getBILL_POST : _getBILL_POST,
		paymentType : _paymentType,
		billPostType : _billPostType,
		billContent : _billContent,		
		queryAllArea : _queryAllArea,			
		queryBank : _queryBank,
		fillBankInfo : _fillBankInfo,
		acctInfoModify_Submit : _acctInfoModify_Submit
	};
	
})();
/**
 * 地区查询
 * 
 * @author dujb3
 */
CommonUtils.regNamespace("common", "area");
/**
 * 地区查询
 */
common.area = (function($){
//	var iplocation = {"北京": { id: "8110000", root: 0, djd: 1,c:72 },"上海": { id: "8310000", root: 1, djd: 1,c:78 },"天津": { id: "8120000", root: 0, djd: 1,c:51035 },"重庆": { id: "8500000", root: 3, djd: 1,c:113 },"河北": { id: "8130000", root: 0, djd: 1,c:142 },"山西": { id: "8140000", root: 0, djd: 1,c:303 },"河南": { id: "8410000", root: 0, djd: 1,c:412 },"辽宁": { id: "8210000", root: 0, djd: 1,c:560 },"吉林": { id: "8220000", root: 0, djd: 1,c:639 },"黑龙江": { id: "8230000", root: 0, djd: 1,c:698 },"内蒙古": { id: "8150000", root: 0, djd: 0,c:799 },"江苏": { id: "8320000", root: 1, djd: 1,c:904 },"山东": { id: "8370000", root: 0, djd: 1,c:1000 },"安徽": { id: "8340000", root: 1, djd: 1,c:1116 },"浙江": { id: "8330000", root: 1, djd: 1,c:1158 },"福建": { id: "8350000", root: 2, djd: 1,c:1303 },"湖北": { id: "8420000", root: 0, djd: 1,c:1381 },"湖南": { id: "8430000", root: 2, djd: 1,c:1482 },"广东": { id: "8440000", root: 2, djd: 1,c:1601 },"广西": { id: "8450000", root: 2, djd: 1,c:1715 },"江西": { id: "8360000", root: 2, djd: 1,c:1827 },"四川": { id: "8510000", root: 3, djd: 1,c:1930 },"海南": { id: "8460000", root: 2, djd: 1,c:2121 },"贵州": { id: "8520000", root: 3, djd: 1,c:2144 },"云南": { id: "8530000", root: 3, djd: 1,c:2235 },"西藏": { id: "8540000", root: 3, djd: 0,c:2951 },"陕西": { id: "8610000", root: 3, djd: 1,c:2376 },"甘肃": { id: "8620000", root: 3, djd: 1,c:2487 },"青海": { id: "8630000", root: 3, djd: 0,c:2580 },"宁夏": { id: "8640000", root: 3, djd: 1,c:2628 },"新疆": { id: "8650000", root: 3, djd: 0,c:2652 }};
	var provinceCityJson = {"8110000":[{"id":8110000,"name":"东城区"},{"id":8110000,"name":"西城区"},{"id":8110000,"name":"朝阳区"},{"id":8110000,"name":"丰台区"},{"id":8110000,"name":"石景山区"},{"id":8110000,"name":"海淀区"},{"id":8110000,"name":"门头沟区"},{"id":8110000,"name":"房山区"},{"id":8110000,"name":"通州区"},{"id":8110000,"name":"顺义区"},{"id":8110000,"name":"昌平区"},{"id":8110000,"name":"大兴区"},{"id":8110000,"name":"怀柔区"},{"id":8110000,"name":"平谷区"},{"id":8110000,"name":"密云县"},{"id":8110000,"name":"延庆县"}],"8310000":[{"id":8310000,"name":"黄浦区"},{"id":8310000,"name":"徐汇区"},{"id":8310000,"name":"长宁区"},{"id":8310000,"name":"静安区"},{"id":8310000,"name":"普陀区"},{"id":8310000,"name":"闸北区"},{"id":8310000,"name":"虹口区"},{"id":8310000,"name":"杨浦区"},{"id":8310000,"name":"闵行区"},{"id":8310000,"name":"宝山区"},{"id":8310000,"name":"嘉定区"},{"id":8310000,"name":"浦东新区"},{"id":8310000,"name":"金山区"},{"id":8310000,"name":"松江区"},{"id":8310000,"name":"青浦区"},{"id":8310000,"name":"奉贤区"},{"id":8310000,"name":"崇明县"}],"8120000":[{"id":8120000,"name":"和平区"},{"id":8120000,"name":"河东区"},{"id":8120000,"name":"河西区"},{"id":8120000,"name":"南开区"},{"id":8120000,"name":"河北区"},{"id":8120000,"name":"红桥区"},{"id":8120000,"name":"东丽区"},{"id":8120000,"name":"西青区"},{"id":8120000,"name":"津南区"},{"id":8120000,"name":"北辰区"},{"id":8120000,"name":"武清区"},{"id":8120000,"name":"宝坻区"},{"id":8120000,"name":"滨海新区"},{"id":8120000,"name":"宁河县"},{"id":8120000,"name":"静海县"},{"id":8120000,"name":"蓟县"}],"8500000":[{"id":8500000,"name":"万州区"},{"id":8500000,"name":"涪陵区"},{"id":8500000,"name":"渝中区"},{"id":8500000,"name":"大渡口区"},{"id":8500000,"name":"江北区"},{"id":8500000,"name":"沙坪坝区"},{"id":8500000,"name":"九龙坡区"},{"id":8500000,"name":"南岸区"},{"id":8500000,"name":"北碚区"},{"id":8500000,"name":"万盛区"},{"id":8500000,"name":"双桥区"},{"id":8500000,"name":"渝北区"},{"id":8500000,"name":"巴南区"},{"id":8500000,"name":"黔江区"},{"id":8500000,"name":"长寿区"},{"id":8500000,"name":"江津区"},{"id":8500000,"name":"合川区"},{"id":8500000,"name":"永川区"},{"id":8500000,"name":"南川区"},{"id":8500000,"name":"綦江县"},{"id":8500000,"name":"潼南县"},{"id":8500000,"name":"铜梁县"},{"id":8500000,"name":"大足县"},{"id":8500000,"name":"荣昌县"},{"id":8500000,"name":"璧山县"},{"id":8500000,"name":"梁平县"},{"id":8500000,"name":"城口县"},{"id":8500000,"name":"丰都县"},{"id":8500000,"name":"垫江县"},{"id":8500000,"name":"武隆县"},{"id":8500000,"name":"忠县"},{"id":8500000,"name":"开县"},{"id":8500000,"name":"云阳县"},{"id":8500000,"name":"奉节县"},{"id":8500000,"name":"巫山县"},{"id":8500000,"name":"巫溪县"},{"id":8500000,"name":"石柱土家族自治县"},{"id":8500000,"name":"秀山土家族苗族自治县"},{"id":8500000,"name":"酉阳土家族苗族自治县"},{"id":8500000,"name":"彭水苗族土家族自治县"}],"8130000":[{"id":8130100,"name":"石家庄市"},{"id":8130200,"name":"唐山市"},{"id":8130300,"name":"秦皇岛市"},{"id":8130400,"name":"邯郸市"},{"id":8130500,"name":"邢台市"},{"id":8130600,"name":"保定市"},{"id":8130700,"name":"张家口市"},{"id":8130800,"name":"承德市"},{"id":8130900,"name":"沧州市"},{"id":8131000,"name":"廊坊市"},{"id":8131100,"name":"衡水市"}],"8140000":[{"id":8140100,"name":"太原市"},{"id":8140200,"name":"大同市"},{"id":8140300,"name":"阳泉市"},{"id":8140400,"name":"长治市"},{"id":8140500,"name":"晋城市"},{"id":8140600,"name":"朔州市"},{"id":8140700,"name":"晋中市"},{"id":8140800,"name":"运城市"},{"id":8140900,"name":"忻州市"},{"id":8141000,"name":"临汾市"},{"id":8141100,"name":"吕梁市"}],"8410000":[{"id":8410100,"name":"郑州市"},{"id":8410200,"name":"开封市"},{"id":8410300,"name":"洛阳市"},{"id":8410400,"name":"平顶山市"},{"id":8410500,"name":"安阳市"},{"id":8410600,"name":"鹤壁市"},{"id":8410700,"name":"新乡市"},{"id":8410800,"name":"焦作市"},{"id":8410900,"name":"濮阳市"},{"id":8411000,"name":"许昌市"},{"id":8411100,"name":"漯河市"},{"id":8411200,"name":"三门峡市"},{"id":8411300,"name":"南阳市"},{"id":8411400,"name":"商丘市"},{"id":8411500,"name":"信阳市"},{"id":8411600,"name":"周口市"},{"id":8411700,"name":"驻马店市"},{"id":8419001,"name":"济源市"}],"8210000":[{"id":8210100,"name":"沈阳市"},{"id":8210200,"name":"大连市"},{"id":8210300,"name":"鞍山市"},{"id":8210400,"name":"抚顺市"},{"id":8210500,"name":"本溪市"},{"id":8210600,"name":"丹东市"},{"id":8210700,"name":"锦州市"},{"id":8210800,"name":"营口市"},{"id":8210900,"name":"阜新市"},{"id":8211000,"name":"辽阳市"},{"id":8211100,"name":"盘锦市"},{"id":8211200,"name":"铁岭市"},{"id":8211300,"name":"朝阳市"},{"id":8211400,"name":"葫芦岛市"}],"8220000":[{"id":8220100,"name":"长春市"},{"id":8220200,"name":"吉林市"},{"id":8220300,"name":"四平市"},{"id":8220400,"name":"辽源市"},{"id":8220500,"name":"通化市"},{"id":8220600,"name":"白山市"},{"id":8220700,"name":"松原市"},{"id":8220800,"name":"白城市"},{"id":8222400,"name":"延边朝鲜族自治州"}],"8230000":[{"id":8230100,"name":"哈尔滨市"},{"id":8230200,"name":"齐齐哈尔市"},{"id":8230300,"name":"鸡西市"},{"id":8230400,"name":"鹤岗市"},{"id":8230500,"name":"双鸭山市"},{"id":8230600,"name":"大庆市"},{"id":8230700,"name":"伊春市"},{"id":8230800,"name":"佳木斯市"},{"id":8230900,"name":"七台河市"},{"id":8231000,"name":"牡丹江市"},{"id":8231100,"name":"黑河市"},{"id":8231200,"name":"绥化市"},{"id":8232700,"name":"大兴安岭地区"}],"8150000":[{"id":8150100,"name":"呼和浩特市"},{"id":8150200,"name":"包头市"},{"id":8150300,"name":"乌海市"},{"id":8150400,"name":"赤峰市"},{"id":8150500,"name":"通辽市"},{"id":8150600,"name":"鄂尔多斯市"},{"id":8150700,"name":"呼伦贝尔市"},{"id":8150800,"name":"巴彦淖尔市"},{"id":8150900,"name":"乌兰察布市"},{"id":8152200,"name":"兴安盟"},{"id":8152500,"name":"锡林郭勒盟"},{"id":8152900,"name":"阿拉善盟"}],"8320000":[{"id":8320100,"name":"南京市"},{"id":8320200,"name":"无锡市"},{"id":8320300,"name":"徐州市"},{"id":8320400,"name":"常州市"},{"id":8320500,"name":"苏州市"},{"id":8320600,"name":"南通市"},{"id":8320700,"name":"连云港市"},{"id":8320800,"name":"淮安市"},{"id":8320900,"name":"盐城市"},{"id":8321000,"name":"扬州市"},{"id":8321100,"name":"镇江市"},{"id":8321200,"name":"泰州市"},{"id":8321300,"name":"宿迁市"}],"8370000":[{"id":8370100,"name":"济南市"},{"id":8370200,"name":"青岛市"},{"id":8370300,"name":"淄博市"},{"id":8370400,"name":"枣庄市"},{"id":8370500,"name":"东营市"},{"id":8370600,"name":"烟台市"},{"id":8370700,"name":"潍坊市"},{"id":8370800,"name":"济宁市"},{"id":8370900,"name":"泰安市"},{"id":8371000,"name":"威海市"},{"id":8371100,"name":"日照市"},{"id":8371200,"name":"莱芜市"},{"id":8371300,"name":"临沂市"},{"id":8371400,"name":"德州市"},{"id":8371500,"name":"聊城市"},{"id":8371600,"name":"滨州市"},{"id":8371700,"name":"菏泽市"}],"8340000":[{"id":8340100,"name":"合肥市"},{"id":8340200,"name":"芜湖市"},{"id":8340300,"name":"蚌埠市"},{"id":8340400,"name":"淮南市"},{"id":8340500,"name":"马鞍山市"},{"id":8340600,"name":"淮北市"},{"id":8340700,"name":"铜陵市"},{"id":8340800,"name":"安庆市"},{"id":8341000,"name":"黄山市"},{"id":8341100,"name":"滁州市"},{"id":8341200,"name":"阜阳市"},{"id":8341300,"name":"宿州市"},{"id":8341500,"name":"六安市"},{"id":8341600,"name":"亳州市"},{"id":8341700,"name":"池州市"},{"id":8341800,"name":"宣城市"}],"8330000":[{"id":8330100,"name":"杭州市"},{"id":8330200,"name":"宁波市"},{"id":8330300,"name":"温州市"},{"id":8330400,"name":"嘉兴市"},{"id":8330500,"name":"湖州市"},{"id":8330600,"name":"绍兴市"},{"id":8330700,"name":"金华市"},{"id":8330800,"name":"衢州市"},{"id":8330900,"name":"舟山市"},{"id":8331000,"name":"台州市"},{"id":8331100,"name":"丽水市"}],"8350000":[{"id":8350100,"name":"福州市"},{"id":8350200,"name":"厦门市"},{"id":8350300,"name":"莆田市"},{"id":8350400,"name":"三明市"},{"id":8350500,"name":"泉州市"},{"id":8350600,"name":"漳州市"},{"id":8350700,"name":"南平市"},{"id":8350800,"name":"龙岩市"},{"id":8350900,"name":"宁德市"}],"8420000":[{"id":8420100,"name":"武汉市"},{"id":8420200,"name":"黄石市"},{"id":8420300,"name":"十堰市"},{"id":8420500,"name":"宜昌市"},{"id":8420600,"name":"襄阳市"},{"id":8420700,"name":"鄂州市"},{"id":8420800,"name":"荆门市"},{"id":8420900,"name":"孝感市"},{"id":8421000,"name":"荆州市"},{"id":8421100,"name":"黄冈市"},{"id":8421200,"name":"咸宁市"},{"id":8421300,"name":"随州市"},{"id":8422800,"name":"恩施土家族苗族自治州"},{"id":8429004,"name":"仙桃市"},{"id":8429005,"name":"潜江市"},{"id":8429006,"name":"天门市"},{"id":8429021,"name":"神农架林区"}],"8430000":[{"id":8430100,"name":"长沙市"},{"id":8430200,"name":"株洲市"},{"id":8430300,"name":"湘潭市"},{"id":8430400,"name":"衡阳市"},{"id":8430500,"name":"邵阳市"},{"id":8430600,"name":"岳阳市"},{"id":8430700,"name":"常德市"},{"id":8430800,"name":"张家界市"},{"id":8430900,"name":"益阳市"},{"id":8431000,"name":"郴州市"},{"id":8431100,"name":"永州市"},{"id":8431200,"name":"怀化市"},{"id":8431300,"name":"娄底市"},{"id":8433100,"name":"湘西土家族苗族自治州"}],"8440000":[{"id":8440100,"name":"广州市"},{"id":8440200,"name":"韶关市"},{"id":8440300,"name":"深圳市"},{"id":8440400,"name":"珠海市"},{"id":8440500,"name":"汕头市"},{"id":8440600,"name":"佛山市"},{"id":8440700,"name":"江门市"},{"id":8440800,"name":"湛江市"},{"id":8440900,"name":"茂名市"},{"id":8441200,"name":"肇庆市"},{"id":8441300,"name":"惠州市"},{"id":8441400,"name":"梅州市"},{"id":8441500,"name":"汕尾市"},{"id":8441600,"name":"河源市"},{"id":8441700,"name":"阳江市"},{"id":8441800,"name":"清远市"},{"id":8441900,"name":"东莞市"},{"id":8442000,"name":"中山市"},{"id":8445100,"name":"潮州市"},{"id":8445200,"name":"揭阳市"},{"id":8445300,"name":"云浮市"}],"8450000":[{"id":8450100,"name":"南宁市"},{"id":8450200,"name":"柳州市"},{"id":8450300,"name":"桂林市"},{"id":8450400,"name":"梧州市"},{"id":8450500,"name":"北海市"},{"id":8450600,"name":"防城港市"},{"id":8450700,"name":"钦州市"},{"id":8450800,"name":"贵港市"},{"id":8450900,"name":"玉林市"},{"id":8451000,"name":"百色市"},{"id":8451100,"name":"贺州市"},{"id":8451200,"name":"河池市"},{"id":8451300,"name":"来宾市"},{"id":8451400,"name":"崇左市"}],"8360000":[{"id":8360100,"name":"南昌市"},{"id":8360200,"name":"景德镇市"},{"id":8360300,"name":"萍乡市"},{"id":8360400,"name":"九江市"},{"id":8360500,"name":"新余市"},{"id":8360600,"name":"鹰潭市"},{"id":8360700,"name":"赣州市"},{"id":8360800,"name":"吉安市"},{"id":8360900,"name":"宜春市"},{"id":8361000,"name":"抚州市"},{"id":8361100,"name":"上饶市"}],"8510000":[{"id":8510100,"name":"成都市"},{"id":8510300,"name":"自贡市"},{"id":8510400,"name":"攀枝花市"},{"id":8510500,"name":"泸州市"},{"id":8510600,"name":"德阳市"},{"id":8510700,"name":"绵阳市"},{"id":8510800,"name":"广元市"},{"id":8510900,"name":"遂宁市"},{"id":8511000,"name":"内江市"},{"id":8511100,"name":"乐山市"},{"id":8511300,"name":"南充市"},{"id":8511400,"name":"眉山市"},{"id":8511500,"name":"宜宾市"},{"id":8511600,"name":"广安市"},{"id":8511700,"name":"达州市"},{"id":8511800,"name":"雅安市"},{"id":8511900,"name":"巴中市"},{"id":8512000,"name":"资阳市"},{"id":8513200,"name":"阿坝藏族羌族自治州"},{"id":8513300,"name":"甘孜藏族自治州"},{"id":8513400,"name":"凉山彝族自治州"}],"8460000":[{"id":8460100,"name":"海口市"},{"id":8460200,"name":"三亚市"},{"id":8460300,"name":"三沙市"},{"id":8469001,"name":"五指山市"},{"id":8469002,"name":"琼海市"},{"id":8469003,"name":"儋州市"},{"id":8469005,"name":"文昌市"},{"id":8469006,"name":"万宁市"},{"id":8469007,"name":"东方市"},{"id":8469021,"name":"定安县"},{"id":8469022,"name":"屯昌县"},{"id":8469023,"name":"澄迈县"},{"id":8469024,"name":"临高县"},{"id":8469025,"name":"白沙黎族自治县"},{"id":8469026,"name":"昌江黎族自治县"},{"id":8469027,"name":"乐东黎族自治县"},{"id":8469028,"name":"陵水黎族自治县"},{"id":8469029,"name":"保亭黎族苗族自治县"},{"id":8469030,"name":"琼中黎族苗族自治县"},{"id":8469031,"name":"西沙群岛"},{"id":8469032,"name":"南沙群岛"},{"id":8469033,"name":"中沙群岛的岛礁及其海域"}],"8520000":[{"id":8520100,"name":"贵阳市"},{"id":8520200,"name":"六盘水市"},{"id":8520300,"name":"遵义市"},{"id":8520400,"name":"安顺市"},{"id":8522200,"name":"铜仁地区"},{"id":8522300,"name":"黔西南布依族苗族自治州"},{"id":8522400,"name":"毕节地区"},{"id":8522600,"name":"黔东南苗族侗族自治州"},{"id":8522700,"name":"黔南布依族苗族自治州"}],"8530000":[{"id":8530100,"name":"昆明市"},{"id":8530300,"name":"曲靖市"},{"id":8530400,"name":"玉溪市"},{"id":8530500,"name":"保山市"},{"id":8530600,"name":"昭通市"},{"id":8530700,"name":"丽江市"},{"id":8530800,"name":"普洱市"},{"id":8530900,"name":"临沧市"},{"id":8532300,"name":"楚雄彝族自治州"},{"id":8532500,"name":"红河哈尼族彝族自治州"},{"id":8532600,"name":"文山壮族苗族自治州"},{"id":8532800,"name":"西双版纳傣族自治州"},{"id":8532900,"name":"大理白族自治州"},{"id":8533100,"name":"德宏傣族景颇族自治州"},{"id":8533300,"name":"怒江傈僳族自治州"},{"id":8533400,"name":"迪庆藏族自治州"}],"8540000":[{"id":8540100,"name":"拉萨市"},{"id":8542100,"name":"昌都地区"},{"id":8542200,"name":"山南地区"},{"id":8542300,"name":"日喀则地区"},{"id":8542400,"name":"那曲地区"},{"id":8542500,"name":"阿里地区"},{"id":8542600,"name":"林芝地区"}],"8610000":[{"id":8610100,"name":"西安市"},{"id":8610200,"name":"铜川市"},{"id":8610300,"name":"宝鸡市"},{"id":8610400,"name":"咸阳市"},{"id":8610500,"name":"渭南市"},{"id":8610600,"name":"延安市"},{"id":8610700,"name":"汉中市"},{"id":8610800,"name":"榆林市"},{"id":8610900,"name":"安康市"},{"id":8611000,"name":"商洛市"}],"8620000":[{"id":8620100,"name":"兰州市"},{"id":8620200,"name":"嘉峪关市"},{"id":8620300,"name":"金昌市"},{"id":8620400,"name":"白银市"},{"id":8620500,"name":"天水市"},{"id":8620600,"name":"武威市"},{"id":8620700,"name":"张掖市"},{"id":8620800,"name":"平凉市"},{"id":8620900,"name":"酒泉市"},{"id":8621000,"name":"庆阳市"},{"id":8621100,"name":"定西市"},{"id":8621200,"name":"陇南市"},{"id":8622900,"name":"临夏回族自治州"},{"id":8623000,"name":"甘南藏族自治州"}],"8630000":[{"id":8630100,"name":"西宁市"},{"id":8632100,"name":"海东地区"},{"id":8632200,"name":"海北藏族自治州"},{"id":8632300,"name":"黄南藏族自治州"},{"id":8632500,"name":"海南藏族自治州"},{"id":8632600,"name":"果洛藏族自治州"},{"id":8632700,"name":"玉树藏族自治州"},{"id":8632800,"name":"海西蒙古族藏族自治州"}],"8640000":[{"id":8640100,"name":"银川市"},{"id":8640200,"name":"石嘴山市"},{"id":8640300,"name":"吴忠市"},{"id":8640400,"name":"固原市"},{"id":8640500,"name":"中卫市"}],"8650000":[{"id":8650100,"name":"乌鲁木齐市"},{"id":8650200,"name":"克拉玛依市"},{"id":8652100,"name":"吐鲁番地区"},{"id":8652200,"name":"哈密地区"},{"id":8652300,"name":"昌吉回族自治州"},{"id":8652700,"name":"博尔塔拉蒙古自治州"},{"id":8652800,"name":"巴音郭楞蒙古自治州"},{"id":8652900,"name":"阿克苏地区"},{"id":8653000,"name":"克孜勒苏柯尔克孜自治州"},{"id":8653100,"name":"喀什地区"},{"id":8653200,"name":"和田地区"},{"id":8654000,"name":"伊犁哈萨克自治州"},{"id":8654200,"name":"塔城地区"},{"id":8654300,"name":"阿勒泰地区"},{"id":8659001,"name":"石河子市"},{"id":8659002,"name":"阿拉尔市"},{"id":8659003,"name":"图木舒克市"},{"id":8659004,"name":"五家渠市"}]};
	
	var _setCookie=function(name, value, date) {
		var Days = date;
		var exp = new Date();
		exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
		document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString() + ";path=/;";
	};
	var _getCookie=function(name) {
		var arr = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
		if (arr != null) return unescape(arr[2]);
		return null;
	};
	var getIdNameByLevel=function(level){
	    var idName = "";
	    if (level == 1){
	        idName = "stock_province_item";
	    }
	    else if (level == 2){
	        idName = "stock_city_item";
	    }
	    return idName;
	};
	var _onAreaClick=function(area) {
//        resetBindMouseEvent();
        var areaId = $(area).attr("data-value");
        var areaName = $(area).html();
        var provinceName = $("#ctc-area div.mt ul.tab li[data-index=0] em").html();
        $("#ctc-area div.mt ul.tab li[data-index=1] em").html(areaName);
        $("#store-selector-text").html(provinceName + areaName).attr("area-id", areaId);
        $('#store-selector').removeClass('hover');
        var cookieVal = areaId + "-" + provinceName + "-" + areaName;
        _setCookie("login_area_id", cookieVal, 30);
        
        var level = $(area).parent().parent().parent().attr("data-area");
//        JdStockTabs.eq(level).find("a").attr("title",areaName).find("em").html(areaName.length>6?areaName.substring(0,6):areaName);
        level = new Number(level)+1;
        if (level=="2"){
//            CAI.currentCityId = areaId;
//            CAI.currentCityName = areaName;
        }
	};
	var _getAreaList=function(result) {
		var level = 2;
		var idName = getIdNameByLevel(level);
		if (idName && level) {
			$("#"+idName).html("");
	        var html = ["<ul class='area-list'>"];
	        var longhtml = [];
	        var longerhtml = [];
	        if (result&&result.length > 0){
	            for (var i=0,j=result.length;i<j ;i++ ){
	                result[i].name = result[i].name.replace(" ","");
	                if(result[i].name.length > 12){
	                    longerhtml.push("<li class='longer-area'><a href='#none' data-value='"+result[i].id+"'>"+result[i].name+"</a></li>");
	                }
	                else if(result[i].name.length > 5){
	                    longhtml.push("<li class='long-area'><a href='#none' data-value='"+result[i].id+"'>"+result[i].name+"</a></li>");
	                }
	                else{
	                    html.push("<li><a href='#none' data-value='"+result[i].id+"'>"+result[i].name+"</a></li>");
	                }
	            }
	        }
	        else{
	            html.push("<li><a href='#none' data-value='"+currentAreaInfo.currentFid+"'> </a></li>");
	        }
	        html.push(longhtml.join(""));
	        html.push(longerhtml.join(""));
	        html.push("</ul>");
	        $("#"+idName).html(html.join(""));
	        $("#"+idName).find("a").click(function(){
	        	_onAreaClick(this);
	        });
		}
	};
	var _init=function(){
		$("#ctc-area div.mt ul.tab li[data-index=0]").addClass("curr").find("a").addClass("hover");
		$("#stock_city_item").hide();
		$("#stock_province_item").show();
		$("#store-selector").off("mouseover").on("mouseover",function(){
			$('#store-selector').addClass('hover');
		});
		$("#store-selector").off("mouseout").on("mouseout",function(){
			$('#store-selector').removeClass('hover');
		});
		$("#ctc-area div.mt ul.tab li").off("click").on("click",function(){
			$("#ctc-area div.mt ul.tab li").removeClass("curr").find("a").removeClass("hover");
			$(this).addClass("curr").find("a").addClass("hover");
			var dataIndex = $(this).attr("data-index");
			if (dataIndex == "0") {
				$("#stock_city_item").hide();
				$("#stock_province_item").show();
			} else if (dataIndex == "1") {
				$("#stock_province_item").hide();
				$("#stock_city_item").show();
			}
		});
		$("#stock_province_item a").off("click").on("click",function(){
			var fid = $(this).attr("data-value");
			// 4个直辖市直接选中，无须选择下属辖区
			if (fid == "8110000" || fid == "8310000" || fid == "8120000" || fid == "8500000") {
				var provinceName = $(this).html();
				var areaName = "";
				$("#ctc-area div.mt ul.tab li[data-index=0] em").html(provinceName);
				$("#ctc-area div.mt ul.tab li[data-index=1] em").html(areaName);
		        $("#store-selector-text").html(provinceName + areaName).attr("area-id", fid);
		        $('#store-selector').removeClass('hover');
		        _getAreaList(provinceCityJson[fid]);
		        var cookieVal = fid + "-" + provinceName + "-" + areaName;
		        _setCookie("login_area_id", cookieVal, 30);
		        return ;
			}
			$("#store-selector").off("mouseout");
		    _getAreaList(provinceCityJson[fid+""]);
		    $("#ctc-area div.mt ul.tab li").removeClass("curr");
			$("#ctc-area div.mt ul.tab li a").removeClass("hover");
			$("#ctc-area div.mt ul.tab li[data-index=0] em").html($(this).html());
			$("#ctc-area div.mt ul.tab li[data-index=1] em").html("请选择");
			$("#ctc-area div.mt ul.tab li[data-index=1]").addClass("curr").find("a").addClass("hover");
		    $("#stock_province_item").hide();
			$("#stock_city_item").show();
		});
		$("#stock_city_item a").off("click").on("click",function(){
        	_onAreaClick(this);
        });
		var areaArr = _getCookie("login_area_id");
		if (!!areaArr && areaArr != "") {
			areaArr = areaArr.split("-");
			$("#store-selector-text").attr("area-id", areaArr[0]).html(areaArr[1]+areaArr[2]);
			$("#ctc-area div.mt ul.tab li[data-index=0] em").html(areaArr[1]);
			$("#ctc-area div.mt ul.tab li[data-index=1] em").html(areaArr[2]);
			//$("#store-selector").off("mouseout");
		    _getAreaList(provinceCityJson[areaArr[0].substring(0,3)+"0000"]);
		}
	};
	
	return {
		init : _init
	};
})(jQuery);

//初始化
$(function(){
	common.area.init();
});
CommonUtils.regNamespace("common", "arraypage");

/**
 * 前台静态分页组件
 * 
 * @requre jquery.js
 * @requre jquery.jevent.js
 * @auth tanzp
 * @desc 防淘宝分页,用于对array对象进行分页
 */
common.arraypage = (function() {

	/**
	 * pageSize : 10
	 */
	var page = {};
	var defaultPageSize = 10;
	var defaultListenerName = "pageChangeListener";
	var objs = {};
	var name = "";
	var divId = "";

	var _init = function(pageDivId, pageSize, pageId, listenerName, objList) {
		if (!pageDivId) {
			$.alert("提示", "分页DivId不能为空!");
			return;
		}
		divId = pageDivId;
		// 初始化赋值
		if (!pageSize || pageSize < 0) {
			page.pageSize = defaultPageSize;
		} else {
			page.pageSize = pageSize;
		}
		page.totalSize = objList.length;
		page.curPage = 1;
		if (!listenerName) {
			listenerName = defaultListenerName;
		}
		name = listenerName;
		objs = objList;
		var totalPage = Math.ceil(page.totalSize / page.pageSize);
		page.totalPage = totalPage;

		common.arraypage.turnToPage(page.curPage);
	};

	// 获取当前页信息列表
	var _getObjsByPage = function(curPage) {
		var objList = [];
		for ( var i = (curPage - 1) * page.pageSize + 1; i < curPage
				* page.pageSize + 1; i++) {
			if (i > page.totalSize) {
				break;
			}
			objList.push(objs[i - 1]);
		}
		return objList;
	};

	// 重置分页处理
	var _resetPageDiv = function(pageNum) {
		var str_prv = '', str_next = '';
		if (pageNum == 1) {
			str_prv = '<span class="disabled">上一页</span>';
		} else {
			str_prv = '<a href="javascript:void(0);" onclick="common.arraypage.turnPrePage()">上一页</a>';
		}

		var str = "";
		var dot = '<span class="spanDot">...</span>';
		if (page.totalPage <= 5) {
			for ( var i = 1; i <= page.totalPage; i++) {
				if (page.curPage == i) {
					str += '<span class="curr">' + i + '</span>';
				} else {
					str += '<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">'
							+ i + '</a>';
				}
			}
		} else {
			if (page.curPage <= 5) {
				for ( var i = 1; i <= 7; i++) {
					if (page.curPage == i) {
						str += '<span class="curr">' + i + '</span>';
					} else {
						str += '<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">'
								+ i + '</a>';
					}
				}
				str += dot;
			} else {
				str += '<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">1</a>';
				str += '<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">2</a>';
				str += dot;

				var begin = page.curPage - 2;
				var end = page.curPage + 2;
				if (end > page.totalPage) {
					end = page.totalPage;
					begin = end - 4;
					if (page.curPage - begin < 2) {
						begin = begin - 1;
					}
				} else if (end + 1 == page.totalPage) {
					end = page.totalPage;
				}
				for ( var i = begin; i <= end; i++) {
					if (page.curPage == i) {
						str += '<span class="curr">' + i + '</span>';
					} else {
						str += '<a href="javascript:void(0);" onclick="common.arraypage.turnToPage(parseInt($.trim($(this).text())))">'
								+ i + '</a>';
					}
				}
				if (end != page.totalPage) {
					str += dot;
				}
			}
		}

		if (page.curPage == page.totalPage) {
			str_next = '<span class="disabled">下一页</span>';
		} else {
			str_next = '<a href="javascript:void(0);" onclick="common.arraypage.turnNextPage()">下一页</a>';
		}

		var total_info = '<span class="totalText">当前第<span class="currPageNum">'
				+ page.curPage
				+ '</span>页<span class="totalInfoSplitStr">/</span>共<span class="totalPageNum">'
				+ page.totalPage + '</span>页</span>';

		var gopage_info = '';
		gopage_info = '<span class="goPageBox">&nbsp;转到<span class="arraypage_gopage_wrap">'
				+ '<input type="text" onkeydown="if(event.keyCode==13){common.arraypage.turnToPage(parseInt($.trim($(this).val())))}" class="arraypage_btn_go_input"/>页</span></span>';

		var pagerHtml = '<div class="arraypage_cls">';
		pagerHtml += str_prv
				+ str
				+ str_next
				+ '<span class="infoTextAndGoPageBtnWrap">'
				+ total_info
				+ gopage_info
				+ '</span><a href="javascript:void(0);"onclick="common.arraypage.gopage()" class="arraypage_btn_go">确定</span>';
		$("#" + divId).empty();
		$("#" + divId).html(pagerHtml);
	};

	// 前往前一页
	var _turnPrePage = function() {
		$(this).dispatchJEvent(name, _getObjsByPage(--page.curPage));
		_resetPageDiv(page.curPage);
	};

	// 前往下一页
	var _turnNextPage = function() {
		$(this).dispatchJEvent(name, _getObjsByPage(++page.curPage));
		_resetPageDiv(page.curPage);
	};

	var _gopage = function() {
		var pageNum = parseInt($.trim($("#" + divId).find("input").val()));
		_turnToPage(pageNum);
	};

	// 前往输入的页
	var _turnToPage = function(pageNum) {
		if (pageNum < 0 || pageNum > page.totalPage || pageNum == undefined
				|| isNaN(pageNum)) {
			return;
		}
		$(this).dispatchJEvent(name, _getObjsByPage(pageNum));
		page.curPage = pageNum;
		_resetPageDiv(page.curPage);
	};

	return {
		init : _init,
		turnPrePage : _turnPrePage,
		turnNextPage : _turnNextPage,
		gopage : _gopage,
		turnToPage : _turnToPage
	};
})();
/**
 * 公共业务逻辑脚本
 * @author liusd
 * @date 2012-09-25
 */
CommonUtils.regNamespace("busi","common");

busi.common = (function(){
	/**
	 * 地区查询公共函数
	 * 页面显示模块需相同的ID
	 * @param {Object} formId 地区选择窗口ID
	 * @param {Object} callBackFunc 回填函数
	 * @memberOf {TypeName} 
	 * @exception {TypeName} 
	 */
	var _queryAllArea=function(){
		_queryArea('',2);
	};
	var _load_area_data=function(response){
		var $areaSelectList;
		var selectHtml="";
		var resJson = response.data;
		var provId = $("#province_list").val();
		if("" == provId){
			if(resJson.length>0){
				$("#province_list").off("change").on("change",function(){_queryArea($("#province_list").val(),3);});
				$areaSelectList=$("#province_list").html("");
				var current_provId=($("#p_current_area").val()).substr(0,3)+"0000";
				for(var i=0;i<resJson.length;i++){
					if(resJson[i].commonRegionId==current_provId){
						selectHtml=selectHtml+"<option  selected='selected' value='" +resJson[i].commonRegionId + "' zone_number='" +resJson[i].zoneNumber +"' name='" +resJson[i].regionName + "'>" + resJson[i].regionName + "</option>";
					}else{
						selectHtml=selectHtml+"<option value='" +resJson[i].commonRegionId + "' zone_number='" +resJson[i].zoneNumber +"' name='" +resJson[i].regionName + "'>" + resJson[i].regionName + "</option>";
					}
				}
				$areaSelectList.html(selectHtml);
				provId= $("#province_list").val();
				if(provId!=""){
					_queryArea($("#province_list").val(),3);
				}
			}
		}else{
			$areaSelectList=$("#city_list").html("");
			if(resJson.length>0){
				var current_areaId=$("#p_current_area").val();
				for(var i=0;i<resJson.length;i++){
					if(resJson[i].commonRegionId==current_areaId){
						selectHtml=selectHtml+"<option  selected='selected' value='" +resJson[i].commonRegionId + "' zone_number='" +resJson[i].zoneNumber +"' name='" +resJson[i].regionName + "'>" + resJson[i].regionName + "</option>";
					}else{
						selectHtml=selectHtml+"<option value='" +resJson[i].commonRegionId + "' zone_number='" +resJson[i].zoneNumber +"' name='" +resJson[i].regionName + "'>" + resJson[i].regionName + "</option>";
					}
				}
				$areaSelectList.html(selectHtml);
				$("#city_list").show();
			}else{
				$("#city_list").hide();
			}
		}
	};
	//查询地区
	var _queryArea = function(provId,areaLevel){		
		var params = {
			'upRegionId': provId,
			'areaLevel': areaLevel
		};
		$.callServiceAsJson(contextPath + "/orderQuery/areaTreeAllChilden", params, {
			"before":function(){
				$.ecOverlay("地区信息加载中，请稍候...");		
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				try {
					if (response.code == 0) {
						if (!response.data) {
							$.alert("提示","没有地区信息返回,请重试。");
						} else {
							_load_area_data(response);							
						}
					} else {
						$.alert("提示","地区信息加载异常，请稍后再试.");
					}
				} catch(e) {
					$.alert("提示","地区信息加载异常，请稍后再试.");
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	
	/**
	 * 管理地区、渠道查询公共函数
	 * 页面显示模块需相同的ID
	 * @param {Object} rangeType 查询数据范围 "area"地区 "channel"渠道 
	 * @param {Object} formId 地区选择窗口ID
	 * @param {Object} callBackFunc 回填函数
	 * 窗口ec-dialog-form示例：
	 * 	<div style="display:none" id="ec-dialog-form-container(+formId)" class="ec-dialog-form-container">
	 *		<div class="ec-dialog-form-top">
	 *			<h1 class="ec-dialog-form-title"></h1>
	 *		</div>
	 *		<div class="ec-dialog-form-content">
	 *			<div class="ec-dialog-form-loading" style="display:none"></div>
	 *			<div class="ec-dialog-form-message" style="display:none"></div>
	 *			<div class="ec-dialog-form-form" >
	 *				<form id="dialogForm">
	 *					<div id="range_data" class="rangeDiv"></div>
	 *				</form>
	 *			</div>
	 *			<div class="ec-dialog-form-bottom-button">
	 *		    	<input type="button"  id="dialogFormSubmit" class="ec-dialog-form-send ec-dialog-form-button" tabindex="1007" value="确认"/>
	 *		    	<input type="button" class="ec-dialog-form-cancel ec-dialog-form-button simplemodal-close" tabindex="1008"  value="取消"/>
	 *			</div>
	 *		</div>
	 *		<div class="ec-dialog-form-bottom"></div>
	 *	</div>
	 * 回填函数样例：var $input = $("input[name='rdo_range_data']:checked");
	 *	            $("#testDataId").val($input.val());
	 *	            $("#testDataName").val($input.attr("rangename"));
	 *				--如果查询的是地区 则存在areacode
	 *				$("#testAreaCode").val($input.attr("areacode"));
	 * @memberOf {TypeName} 
	 * @exception {TypeName} 
	 */
	var _qryRangeData = function(rangeType,formId,callBackFunc){
		if(typeof callBackFunc =="undefined" && !$.isFunction(callBackFunc)){
 			throw new Error("无效的回调函数");
 		}
		var rangeTitle = "";
		if(rangeType == "area") {
			rangeTitle = "地区";
		}else if(rangeType == "channel") {
			rangeTitle = "渠道";
		}else {
			$.alert("提示","数据异常");
			return;
		}
		var params = {"rangeType":rangeType};
		var paramUrl=contextPath + "/staffMgr/getAuthRange";
		$.callServiceAsJsonGet(paramUrl,params, {
			"before":function(){
				$.ecOverlay(rangeTitle+"信息加载中，请稍候...");		
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				try {
					if (response.code == 0) {
						if (!response.data) {
							$.alert("提示","没有"+rangeTitle+"信息返回,请重试。");
						} else {
							ec.form.dialog.createDialog({
								"id":formId,
								"title":"选择"+rangeTitle,
								"width":630,
								"height":"",
								"initCallBack":function(dialogForm,dialog){
									$("#ec-dialog-form-container"+formId+" .ec-dialog-form-bottom-button").attr("ifshow","false");
									_putDialog(dialogForm,dialog);
									_load_range_data(response,rangeType);
									_bind_range_data(callBackFunc);
								},
								"submitCallBack":function(dialogForm,dialog){
									
								}
							});			
						}
					} else {
						$.alert("提示",rangeTitle+"信息加载异常，请稍后再试.")
					}
				} catch(e) {
					$.alert("提示",rangeTitle+"信息加载异常，请稍后再试.")
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	}
	//赋值
	var _dialogForm;
	var _dialog;
	var _putDialog = function(dialogForm,dialog){
		_dialogForm = dialogForm;
		_dialog = dialog;
	}
	//初始化加载当前工号管理地区
	var _load_range_data = function(response,rangeType) {
		var data = response.data;
		var content = "";
		for( var i = 0;i < data.length;i++) {
			var range = data[i];
			content +=
					"<div class='rangeInput'><input type='radio' value='"
							+ range.ID + "' name='rdo_range_data' rangename='"+range.NAME+"' ";
			if(rangeType == "area") {
				content +=  "areacode='"+range.AREA_CODE+"'";
			}
			content += "/>" + range.NAME + "</div>";
		}
		$("#range_data").html(content);
	}
	//使用代理绑定事件
	var _bind_range_data = function(callBackFunc){
		$("#range_data").on("click",function(e){
			var $target = $(e.target);
			$target.find("input[name='rdo_range_data']").attr("checked",true);
			callBackFunc.apply(this);
			_dialogForm.close(_dialog);
		});
	}
	
	/**
	 * 共用主数据查询
	 * @param {Object} attrSpecCode 主数据编码
	 * @memberOf {TypeName} 
	 * @exception {TypeName} 
	 */
	var _queryCTGMainData = function(attrSpecCode){
		param = {
			attrSpecCode:attrSpecCode
		};
		var paramUrl=contextPath + "/staffMgr/getCTGMainData";
		var responsedata = $.callServiceAsJson(paramUrl,param, {});
		if(responsedata.code==0){
			return responsedata.data;
		}else if(responsedata.code==-2){
			$.alertM(responsedata.data);
			return;
		}else{
			$.alert("提示","调用主数据接口失败！");
			return;
		}
	};
	return {
		queryAllArea:_queryAllArea,
		qryRangeData:_qryRangeData,
		queryCTGMainData:_queryCTGMainData
	}
})();

/**
 * 错误页面使用js
 * 
 * @author dujb3
 */
CommonUtils.regNamespace("common", "errorPage");
/**
 * 地区查询
 */
common.errorPage = (function($){
	var _setCookie=function(name, value, date) {
		var Days = date;
		var exp = new Date();
		exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
		document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString() + ";path=/;";
	};
	var _getCookie=function(name) {
		var arr = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
		if (arr != null) return unescape(arr[2]);
		return null;
	};
	
	var _showError=function(){
		try{
//			var tempdata=eval('('+errorJson+')');
			if (errorJson == undefined || errorJson == '') {
				return;
			}
			var tempdata = errorJson;
				
			if(tempdata && typeof tempdata.data!="undefined" && typeof tempdata.code!="undefined"){
				//异常信息
				if(tempdata.code == -2) {
					$.alertM(tempdata.data);
					return;
				}
			}
		}catch(e){
			//alert(e.name + ": " + e.message);
		}
	};
	
	return {
		showError : _showError
	};
})(jQuery);

//初始化
$(function(){
	common.errorPage.showError();
});

CommonUtils.regNamespace("common", "page");

/**
 * 前台分页组件
 * @requre jquery.js
 * @requre jquery.jevent.js
 */
common.page = (function(){
	
	/**
	 * 		pageSize : 5
	 */
	var page = {};
	var defaultPageSize = 5;
	var defaultListenerName = "changePage";
	var defaultPageId = "page";
	var objs = {};
	var name = "";
	var _pageDiv = {};
	var _prePage = {};
	var _nextPage = {};
	var _pageLabel = {};
	var _init = function(pageDivId,pageSize,pageId,listenerName,objList) {
		if (!pageSize || pageSize < 0) {
			page.pageSize = defaultPageSize;
		} else {
			page.pageSize = pageSize;
		}
		page.totalSize = objList.length;
		page.curPage = 1;
		if (!listenerName) {
			listenerName = defaultListenerName;
		}
		name = listenerName;
		objs = objList;
		var pageDiv = $("<div class='paging' id="+pageId+">" +
							"<span class='pageUpGray'>上一页</span>" +
							"<label></label>" +
							"<span class='nextPageGrayOrange'>下一页</span>" +
							"<label class='marginTop4'></label>" +
							"<label class='marginTop4'>跳转至</label>" +
							"<input type='text' class='inputW20H20'/>" +
							"<label class='marginTop4'>页</label>" +
						"<a class='determineBtn' href='#'>跳转</a>");
		$("#"+pageDivId).append(pageDiv);
		var totalPage = Math.ceil(page.totalSize / page.pageSize);
		if (totalPage > 0) {
			for (var i=0;i<totalPage;i++) {
				$("<a class='fontBlueB' href='#'>"+(i+1)+"</a>").appendTo(pageDiv.find("label:first"));
			}
		}
		page.totalPage = totalPage;
		_prePage = pageDiv.find("span:eq(0)");
		_prePage.click(function(){
			common.page.turnPrePage();
		});
		_nextPage = pageDiv.find("span:eq(1)");
		_nextPage.click(function(){
			common.page.turnNextPage();
		});
		_pageDiv = pageDiv;
		_pageLabel = _pageDiv.find("label:eq(0)");
		$.each(_pageLabel.find("a"),function(i,a){
			$(this).click(function(){
				common.page.turnToPage(parseInt($.trim($(this).text())));
			});
		});
		_pageDiv.find("a:last").click(function(){
			var pageNum = $.trim(_pageDiv.find("input").val());
			if (!/^\d+$/g.test(pageNum)) {
				$.alert("提示","请正确输入要跳转的页数");
				return;
			}
			if(pageNum<1 || pageNum>page.totalPage){
				$.alert("提示", "超过搜索范围");
				return;
			}
			common.page.turnToPage(parseInt(pageNum));
		});
		common.page.turnFirstPage();
	};
	//前往前一页
	var _turnPrePage = function() {
		if (page.curPage == 1) {
			$.alert("提示","已经到第一页");
			return;
		} else {
			$(this).dispatchJEvent(name, _getObjsByPage(--page.curPage));
			if (page.curPage == 1) {
				_prePage.removeClass("pageUpOrange").addClass("pageUpGray").attr("disabled","disabled");
			} else {
				_nextPage.removeClass("nextPageGray").addClass("nextPageGrayOrange").removeAttr("disabled");
			}
			_lightCurPage(page.curPage);
		}
	};
	//前往下一页
	var _turnNextPage = function() {
		if (page.curPage == page.totalPage) {
			$.alert("提示","已经到最后一页");
			_nextPage.removeClass("nextPageGrayOrange").addClass("nextPageGray");
			return;
		} else {
			$(this).dispatchJEvent(name, _getObjsByPage(++page.curPage));
			if (page.curPage == page.totalPage) {
				_nextPage.removeClass("nextPageGrayOrange").addClass("nextPageGray").attr("disabled","disabled");
			} else {
				_prePage.removeClass("pageUpGray").addClass("pageUpOrange").removeAttr("disabled");
			}
			_lightCurPage(page.curPage);
		}
	};
	//获取当前页信息列表
	var _getObjsByPage = function(curPage) {
		var objList = [];
		for (var i=(curPage-1)*page.pageSize+1;i<curPage*page.pageSize+1;i++) {
			if (i > page.totalSize) {
				break;
			}
			objList.push(objs[i-1]);
		}
		return objList;
	};
	//前往第一页
	var _turnFirstPage = function() {
		var objList = [];
		for (var i=1;i<page.pageSize+1;i++) {
			if (i>page.totalSize) {
				break;
			}
			objList.push(objs[i-1]);
		}
		_prePage.attr("disabled","disabled");
		$(this).dispatchJEvent(name,objList);
		_lightCurPage(1);
	};
	//当前页高亮
	var _lightCurPage = function(curPage) {
		$.each(_pageLabel.find("a"),function(i, a){
			if (curPage==parseInt($.trim($(this).text()))) {
				$(this).addClass("pagingSelect");
			} else {
				$(this).removeClass("pagingSelect");
			}
		});
	};
	//前往输入的页
	var _turnToPage = function(pageNum) {
		$(this).dispatchJEvent(name, _getObjsByPage(pageNum));
		_lightCurPage(pageNum);
		page.curPage = pageNum;
	};
	
	return {
		init : _init,
		turnPrePage : _turnPrePage,
		turnNextPage : _turnNextPage,
		turnFirstPage : _turnFirstPage,
		turnToPage : _turnToPage
	};
})();
/**
 * 客户资料管理
 */
CommonUtils.regNamespace("order", "cust");

order.cust = (function(){
	
	var _choosedCustInfo = {};
	var createCustInfo = {};
	var custInfo = null;
	var authFlag = null;
	var _fromProvFlag = "0"; //省份甩单标志
	var _provIsale = null; //省份isale流水号
	var g_query_cust_infos = [];
	//客户鉴权跳转权限
	var _jumpAuthflag="";
	//客户属性
	var _partyProfiles =[];
	//客户属性分页列表
	var _profileTabLists =[];
	var _tmpChooseUserInfo = {};
	var _queryForChooseUser = false;
	
	var _getCustInfo = function() {
		return custInfo;
	};
	var _orderBtnflag="";
	var _form_valid_init = function() {
		 //客户鉴权
		$('#custAuthForm').bind('formIsValid', function(event, form) {
			var param = _choosedCustInfo;
			param.prodPwd = $.trim($("#authPassword").val());
			//param.areaId = 21;
			//param.accessNumber="11969577";
			param.accessNumber=_choosedCustInfo.accessNumber;
			param.authFlag=authFlag;
			$.callServiceAsHtml(contextPath+"/cust/custAuth",param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
				},"done" : function(response){
					if (response.code == -2) {
						return;
					}
					if(response.data.indexOf("false") >=0) {
						$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
						return;
					}
					//判断能否转为json，可以的话返回的就是错误信息
					try {
						var errorData = $.parseJSON(response.data);
						$.alertMore("异常信息", errorData.resultMsg, errorData.errorStack,"error");
						return;
					} catch(e){
						
					}
					if(!order.cust.queryForChooseUser){
						custInfo = param;
						OrderInfo.boCusts.prodId=-1;
						OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
						OrderInfo.boCusts.partyProductRelaRoleCd="0";
						OrderInfo.boCusts.state="ADD";
						OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
						
						OrderInfo.cust = _choosedCustInfo;
						_custAuthCallBack(response);
					} else {
						//鉴权成功后显示选择使用人弹出框
						order.main.showChooseUserDialog(param);
					}
				},"always":function(){
					$.unecOverlay();
				}
			});
		}).ketchup({bindElement:"custAuthbtn"});
		//身份证鉴权
		$('#custAuthFormID').bind('formIsValid', function(event, form) {
			var param = _choosedCustInfo;
            param.pCustIdentityCd = $("#p_cust_identityCd").val();
			param.identityNum =base64encode($.trim($("#authIDTD").val()));
			param.custId = _choosedCustInfo.custId;
			param.authFlag=authFlag;
			$.callServiceAsHtml(contextPath+"/cust/custAuth",param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
				},"done" : function(response){
					if (response.code == -2) {
						return;
					}
					if(response.data.indexOf("false") >=0) {
						$.alert("提示","抱歉，您输入的身份证号有误，请重新输入。");
						return;
					}
					//判断能否转为json，可以的话返回的就是错误信息
					try {
						var errorData = $.parseJSON(response.data);
						$.alertMore("异常信息", errorData.resultMsg, errorData.errorStack,"error");
						return;
					} catch(e){

					}
					if(!order.cust.queryForChooseUser){
						custInfo = param;
						OrderInfo.boCusts.prodId=-1;
						OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
						OrderInfo.boCusts.partyProductRelaRoleCd="0";
						OrderInfo.boCusts.state="ADD";
						OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;

						OrderInfo.cust = _choosedCustInfo;
						_custAuthCallBack(response);
					} else {
						//鉴权成功后显示选择使用人弹出框
						order.main.showChooseUserDialog(param);
					}
					
				},"always":function(){
					$.unecOverlay();
				}
			});
		}).ketchup({bindElement:"custAuthbtnID"});

		$("#useraddclose").off("click").on("click",function(event){
			easyDialog.close();
			$("#cCustName").val("");
			$("#cCustIdCard").val("");
			$("#discontactName").val("");
			$("#dishomePhone").val("");
			$("#disofficePhone").val("");
			$("#dismobilePhone").val("");
			authFlag="";
			if($.ketchup)
				$.ketchup.hideAllErrorContainer($("#custCreateForm"));
		});
		//重置
		$("#custresetBtn").off("click").on("click",function(event){
			if($.ketchup)
				$.ketchup.hideAllErrorContainer($("#custCreateForm"));
			$("#btncustreset").click();
			
		});
		
		
	};
	//客户类型选择事件
	var _partyTypeCdChoose = function(scope,id) {
		var partyTypeCd=$(scope).val();
		//客户类型关联证件类型下拉框
		$("#"+id).empty();
		_certTypeByPartyType(partyTypeCd,id);
		//创建客户证件类型选择事件
		//_identidiesTypeCdChoose($("#"+id).children(":first-child"),"cCustIdCard");
		//创建客户确认按钮
		//_custcreateButton();

	};
	//客户类型关联证件类型下拉框
	var _certTypeByPartyType = function(_partyTypeCd,id){
		var params = {"partyTypeCd":_partyTypeCd} ;
		var url=contextPath+"/cust/queryCertType";
		var response = $.callServiceAsJson(url, params, {});
       if (response.code == -2) {
					$.alertM(response.data);
				}
	   if (response.code == 1002) {
					$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");
					return;
				}
	   if(response.code==0){
					var data = response.data ;
					if(data!=undefined && data.length>0){
						//去除重复的证件类型编码
						var uniData = [];
						for(var i=0;i<data.length;i++){
							var unique = true;
							var certTypeCd = data[i].certTypeCd;
							for(var j=0;j<uniData.length;j++){
								unique = unique && data[i].certTypeCd != uniData[j].certTypeCd;
								if(!unique){
									break;
								}
							}
						    //只有定义的渠道类型新建客户的时候可以选择非身份证类型,其他的渠道类型只能选择身份证类型。
							var isAllowChannelType = false;
							if(OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZQZXDL || OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.GZZXDL
									|| OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.HYKHZXDL || OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.SYKHZXDL
									|| OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.XYKHZXDL || OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.GZZXJL
									|| OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZYOUT || OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZYINGT
									|| OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.WBT || _partyTypeCd != "1" ){
								isAllowChannelType = true;
							}
							if(!isAllowChannelType && certTypeCd == "1"){
								isAllowChannelType= true;
							}
							if(unique && isAllowChannelType){
								uniData.push(data[i]);
							}
						}
						
						for(var i=0;i<uniData.length;i++){
							var certTypedate = uniData[i];
							$("#"+id).append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>");
						}
						//屏蔽身份证
						if(id=="identidiesTypeCd" && OrderInfo.staff.idType=="OFF")
						{
							$("#"+id+" option[value='1']").remove();
							$("#readCertBtnCreate").hide();
						}
					}
				}
	};
	//客户定位证件类型选择事件
	var _custidentidiesTypeCdChoose = function(scope,id) {
		var identidiesTypeCd=$(scope).val();
		if(identidiesTypeCd==-1){
			$("#"+id).attr("placeHolder","请输入接入号码");
			$("#"+id).attr("data-validate","validate(required:请准确填写接入号码) on(keyup)");
		}else if (identidiesTypeCd==1){
			$("#"+id).attr("placeHolder","请输入身份证号码");
			$("#"+id).attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(keyup)");
		}else if(identidiesTypeCd==2){
			$("#"+id).attr("placeHolder","请输入军官证");
			$("#"+id).attr("data-validate","validate(required:请准确填写军官证) on(keyup)");
		}else if(identidiesTypeCd==3){
			$("#"+id).attr("placeHolder","请输入护照");
			$("#"+id).attr("data-validate","validate(required:请准确填写护照) on(keyup)");
		}else{
			$("#"+id).attr("placeHolder","请输入证件号码");
			$("#"+id).attr("data-validate","validate(required:请准确填写证件号码) on(keyup)");
		}
		if(identidiesTypeCd!=-1){
			$("#isAppointNum").attr("checked",false);
		}
		if(id == 'p_cust_identityNum_choose'){
			_bindCustQueryForChoose();
		} else {
			_custLookforButton();
		}
		
		//启用读卡时禁用的控件
		$('#p_cust_identityNum').attr("disabled",false);
	};
	//创建客户证件类型选择事件
	var _identidiesTypeCdChoose = function(scope,id) {
		var identidiesTypeCd=$(scope).val();
		if(identidiesTypeCd==1){
			$("#"+id).attr("placeHolder","请输入合法身份证号码");
			$("#"+id).attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)");
		}else if(identidiesTypeCd==2){
			$("#"+id).attr("placeHolder","请输入合法军官证");
			$("#"+id).attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}else if(identidiesTypeCd==3){
			$("#"+id).attr("placeHolder","请输入合法护照");
			$("#"+id).attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}else{
			$("#"+id).attr("placeHolder","请输入合法证件号码");
			$("#"+id).attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		_custcreateButton();
		
		//启用读卡时禁用的控件
		$('#cCustIdCard').attr("disabled",false);
		$('#cCustName').attr("disabled",false);
		$('#cAddressStr').attr("disabled",false);
	};
	 var _custLookforButton = function() {
	//客户定位查询按钮
	$('#custQueryFirstForm').off().bind('formIsValid', function(event, form) {
		var url=contextPath+"/order/createorderlonger";
		var response = $.callServiceAsJson(url, {});
		if(response.code==0){
			OrderInfo.custorderlonger=response.data;
		}
		var identityCd="";
		var idcard="";
		var diffPlace="";
		var acctNbr="";
		var identityNum="";
		var queryType="";
		var queryTypeValue="";
		identityCd=$("#p_cust_identityCd").val();
		identityNum=$.trim($("#p_cust_identityNum").val());
		//判断是否是号码或身份证输入

		//省份甩单定位客户不需要进行客户鉴权
		if(order.cust.fromProvFlag == "1" || (identityCd!=-1 && CONST.getAppDesc()!=0)){
			identityCd=$("#p_cust_identityCd").val();
			authFlag="1";
		}else{
			//4G所有证件类型定位都需要客户鉴权
			authFlag="0";
		}
		if(identityCd==-1){
			acctNbr=identityNum;
			identityNum="";
			identityCd="";
		}else if(identityCd=="acctCd"||identityCd=="custNumber"){
			acctNbr="";
			identityNum="";
			identityCd="";
			queryType=$("#p_cust_identityCd").val();
			queryTypeValue=$.trim($("#p_cust_identityNum").val());

		}
		diffPlace=$("#DiffPlaceFlag").val();
		areaId=$("#p_cust_areaId").val();
		//lte进行受理地区市级验证
		if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){
			$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");
			return;
		}
		var param = {
				"acctNbr":acctNbr,
				"identityCd":identityCd,
				"identityNum":identityNum,
				"partyName":"",
				"custQueryType":$("#custQueryType").val(),
				"diffPlace":diffPlace,
				"areaId" : areaId,
				"queryType" :queryType,
				"queryTypeValue":queryTypeValue,
				"identidies_type":$("#p_cust_identityCd  option:selected").text()
		};
		$.callServiceAsHtml(contextPath+"/cust/queryCust",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if (response.code == -2) {
					return;
				}
				_queryCallBack(response);
			},fail:function(response){
				$.unecOverlay();
				$.alert("提示","查询失败，请稍后再试！");
			},"always":function(){
				$.unecOverlay();
				$("#usersearchbtn").attr("disabled",false);
			}
		});
	}).ketchup({bindElement:"usersearchbtn"});
	 };
	//创建客户确认按钮
    var _custcreateButton = function() {
	    $('#custCreateForm').off().bind('formIsValid',function(event) {
	    	var url=contextPath+"/order/createorderlonger";
			var response = $.callServiceAsJson(url, {});
			if(response.code==0){
				OrderInfo.custorderlonger=response.data;
			}
			_checkIdentity();
	     }).ketchup({bindElement:"createcustsussbtn"});
    };
	//客户查询列表
	var _queryCallBack = function(response) {
		if(response.data.indexOf("showVerificationcode") >=0) {
			$("#vali_code_input").val("");
			$('#validatecodeImg').css({"width":"80px","height":"32px"}).attr('src',contextPath+'/validatecode/codeimg.jpg?' + Math.floor(Math.random()*100)).fadeIn();
			easyDialog.open({
				container : 'Verificationcode_div'
			});
			return;
		}
		if(response.data.indexOf("false") >=0) {
			$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
			return;
		}
		var content$ = $("#custList");
		content$.html(response.data).show();
		$(".userclose").off("click").on("click",function(event) {
			authFlag="";
			$(".usersearchcon").hide();
		});
		if($("#custListTable").attr("custInfoSize")=="1"){
			$(".usersearchcon").hide();
		}
	};
	
	// 客户重新定位
	var _custReset = function() {
		//填单页面
		if((0!=OrderInfo.order.step)||(0==OrderInfo.order.step&&OrderInfo.actionFlag==2)){
			window.location.reload();
		}
		if($("#subPage").val()=="number"){
			window.location.reload();
		}
		$("#custQryDiv").show();
		$("#custInfo").hide();
		$("#p_cust_identityNum").val("");
		$("#authPassword").val("");
		authFlag="";
		OrderInfo.boCusts.partyId="";
		//新建客户
		OrderInfo.boCustInfos.name="";
		OrderInfo.boCustIdentities.identityNum="";
		OrderInfo.cust = {
			custId:-1,	
			custName : "",
			areaId:""
		};
		//定位客户
		OrderInfo.boCusts.prodId=-1;
		OrderInfo.boCusts.partyId="";
		OrderInfo.boCusts.partyProductRelaRoleCd="0";
		OrderInfo.boCusts.state="ADD";
		OrderInfo.cust = "";
		//已订购查询是不是查询标志
		order.cust.orderBtnflag="";
		//填单步骤
		OrderInfo.order.step=0;
		if((CONST.getAppDesc()!=0)&&($("#custModifyId").is(":hidden"))){
			$("#custModifyId").show();
		}
		
	};
	
	/**
	 * 客户鉴权
	 */
	var _custAuth = function(scope) {
		var param = _choosedCustInfo;
		param.prodPwd = $.trim($("#authPassword").val());
		param.authFlag=authFlag;
		$.callServiceAsHtml(contextPath+"/cust/custAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				
				if(!order.cust.queryForChooseUser){
					custInfo = param;
					OrderInfo.boCusts.prodId=-1;
					OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
					OrderInfo.boCusts.partyProductRelaRoleCd="0";
					OrderInfo.boCusts.state="ADD";
					OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
					
					OrderInfo.cust = _choosedCustInfo;
					_custAuthCallBack(response);
				} else {
					//鉴权成功后显示选择使用人弹出框
					order.main.showChooseUserDialog(param);
				}
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	var _jumpAuth = function() {
		if(order.cust.jumpAuthflag!="0"){
			$.alert("提示","没有跳过校验权限！");
			return;
		}
		var param = _choosedCustInfo;
		param.authFlag="1";
		$.callServiceAsHtml(contextPath+"/cust/custAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				
				if(!order.cust.queryForChooseUser){
					custInfo = param;
					OrderInfo.boCusts.prodId=-1;
					OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
					OrderInfo.boCusts.partyProductRelaRoleCd="0";
					OrderInfo.boCusts.state="ADD";
					OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
					
					OrderInfo.cust = _choosedCustInfo;
					_custAuthCallBack(response);
				} else {
					//鉴权成功后显示选择使用人弹出框
					order.main.showChooseUserDialog(param);
				}
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	// cust auth callback
	var _custAuthCallBack = function(response) {
		if(authFlag=="0"){
			easyDialog.close();
		}
		$("#custList").hide();
		$("#custQryDiv").hide();
		if($.ketchup)
			$.ketchup.hideAllErrorContainer($("#custCreateForm"));
		var content$ = $("#custInfo");
		content$.html(response.data).show();
		if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){
			$("#custModifyId").attr("style","display: none;");
		}else{
			$("#custModifyId").attr("style","");
		}
		$("#cCustName").val("");
		$("#cCustIdCard").val("");
		main.home.hideMainIco();
	};
	//客户列表点击
	var _showCustAuth = function(scope) {
		_choosedCustInfo = {
			custId : $(scope).find("td:eq(3)").text(),
			partyName : $(scope).find("td:eq(0)").text(),
			idCardNumber : $(scope).find("td:eq(4)").text(),
			identityName : $(scope).attr("identityName"),
			areaName : $(scope).attr("areaName"),
			areaId : $(scope).attr("areaId"),
			identityCd :$(scope).attr("identityCd"),
			addressStr :$(scope).attr("addressStr"),
			norTaxPayer :$(scope).attr("norTaxPayer"),
			segmentId :$(scope).attr("segmentId"),
			segmentName :$(scope).attr("segmentName"),
			custFlag :$(scope).attr("custFlag"),
			vipLevel :$(scope).attr("vipLevel"),
			vipLevelName :$(scope).attr("vipLevelName")
		};
		//设置被选择标识
		$(scope).attr("selected","selected");
		$(scope).siblings().each(function () {
				$(this).removeAttr("selected");
		});
		// 判断是否是政企客户
		var isGovCust = false;
		for (var i = 0; i <= CacheData.getGovCertType().length; i ++) {
			if (_choosedCustInfo.identityCd == CacheData.getGovCertType()[i]) {
				isGovCust = true;
				break;
			}
		}
		if(order.cust.queryForChooseUser && isGovCust){
			$.alert('提示','使用人必须是公众客户，请重新定位。');
			return false;
		}
		if(authFlag=="0"){
			if(order.cust.authType == '00'){
				$("#custAuthTypeName").html("客户密码：");
			} else {
				$("#custAuthTypeName").html("产品密码：");
			}
			var pCustIdentityCd = $("#p_cust_identityCd").val();
			if("1"==pCustIdentityCd){
				$('#authIDTD').attr("disabled",false);//身份鉴权的身份证在读卡时被禁用，此处启用
				easyDialog.open({
					container:'authID',
					callback : function(){
						order.cust.queryForChooseUser = false; //关闭弹出框时重置标识位
					}
				});
			}else{
				easyDialog.open({
					container : 'auth',
					callback : function(){
						order.cust.queryForChooseUser = false; //关闭弹出框时重置标识位
					}
				});
			}
			if(order.cust.jumpAuthflag=="0"){
				$("#jumpAuth").off('click').on('click', function(){
					order.cust.jumpAuth();
				});
				$("#jumpAuth").show();
				$("#jumpAuthID").show();
			}
			$("#authClose").off("click").on("click",function(event){
				easyDialog.close();
				$("#authPassword").val("");
			});
			$("#authIDClose").off("click").on("click",function(event){
				easyDialog.close();
				$("#authIDTD").val("");
			});
		} else{
			_custAuth(scope);
		}
	};
	//创键客户
	var _showCustCreate = function(scope) {
		var areaId=$("#p_cust_areaId").val();
		if(areaId.indexOf("0000")>0){
			$.alert("提示","前页受理地区为省级地区无法进行创建,请先选择市级地区！");
			return;
		}
		tabProfileFlag="1";
		_partyTypeCdChoose($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");
		_setSelectVal("identidiesTypeCd","1"); //默认证件类型使用“身份证”
		_identidiesTypeCdChoose($("#identidiesTypeCd  option:selected").length ?  $("#identidiesTypeCd  option:selected") : $("#identidiesTypeCd").children(":first-child"),"cCustIdCard");
		_custcreateButton();
		_spec_parm_show();
		$("#partyProfile").attr("style","display:none");
		easyDialog.open({
			container : 'user_add'
		});
	};
	var _setSelectVal = function(id,val){
		if($("#"+id+"  option:selected").val() != val){
			$("#"+id+"  option").each(function(){
				if($(this).val() == val){
					$(this).attr("selected","selected");
				} else {
					$(this).removeAttr("selected");
				}
			});
		}
	};
	//已订购业务
	var _btnQueryCustProd=function(curPage){
		//收集参数
		var param={};
		if(_choosedCustInfo==null){
			param.custId="";
		}else{
		param.custId=_choosedCustInfo.custId;
		param.areaId =$("#area").attr("areaId");
		//	param.custId="123002382243";//need modify
		}
		if(document.getElementById("accNbrQuery")){
			param.acctNbr=$.trim($("#accNbrQuery").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
			
		} else if($("#isAppointNum").attr("checked")=="checked"){
			param.acctNbr=$.trim($("#p_cust_identityNum").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
		}else {
			param.acctNbr="";
		}
		if(document.getElementById("custPageSize")){
			param.pageSize=$.trim($("#custPageSize").val());
			if(!(/^[1-9]\d*$/.test(param.pageSize))&&(param.pageSize!="")){
				$.alert("提示信息","页码格式不正确，必须为有效数字。");
				return false;
			}
			if(param.pageSize>15){
				$.alert("提示信息","页数大小不能超过15。");
				return false;
			}
		}else {
			param.pageSize="";
		}
		param.curPage=curPage;
		param.DiffPlaceFlag=$("#DiffPlaceFlag").val();
		if(param.custId==null||param.custId==""){
			$.alert("提示","无法查询已订购产品");
			return;
		}
		//请求地址
		var url = contextPath+"/cust/orderprod";
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>';
				}
				if (response.code == -2) {
					return;
				}else if(response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				var content$=$("#orderedprod");
				content$.html(response.data);
				//_linkSelectPlan("#phoneNumListtbody tr",$("#phoneNumListtbody").children(":first-child"));
				//绑定每行合约click事件
				$("#phoneNumListtbody tr").off("click").on("click",function(event){
					var thisTr=this;
					if(1==OrderInfo.order.step&&(!$(thisTr).hasClass("plan_select"))){
						$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
							yes:function(){
								_cancel();
								_linkQueryOffer(thisTr);
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else if(2==OrderInfo.order.step&&(!$(thisTr).hasClass("plan_select"))){
						$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
							yes:function(){
								SoOrder.orderBack();
								_cancel();
								_linkQueryOffer(thisTr);
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else{
						_linkQueryOffer(this);
					}
					
					});
				
				$("#plan2ndDiv tbody tr").each(function(){$(this).off("click").on("click",function(event){
					var this2Tr=this;
					if(1==OrderInfo.order.step&&(!$(this2Tr).hasClass("plan_select2"))){
						$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
							yes:function(){
								_cancel();
								order.cust.linkSelectPlan(this2Tr);event.stopPropagation();
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else if(2==OrderInfo.order.step&&(!$(this2Tr).hasClass("plan_select2"))){
						$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
							yes:function(){
								SoOrder.orderBack();
								_cancel();
								order.cust.linkSelectPlan(this2Tr);event.stopPropagation();
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else{
						order.cust.linkSelectPlan(this);event.stopPropagation();
					}
					
					
					});});
				
				$("#phoneNumListtbody").children(":first-child").next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();
				$("#phoneNumListtbody").children(":first-child").click();
			}
		});	
	};
	/**
	 * 已订购产品查询
	 */
	var _linkQueryOffer=function(selected){
		//3G用户标识
		$("#is3GCheckbox").off().change(function() { 
			order.prodModify.getChooseProdInfo();
			}); 
		//勾取消
		$("#phoneNumListtbody tr").filter(".plan_select").children(":first-child").html("");
		$("#phoneNumListtbody tr").filter(".plan_select")
			.removeClass("plan_select").next("#plan2ndTr").hide();
		$(selected).addClass("plan_select").next("#plan2ndTr").show();
		//打勾操作
		var nike="<i class='select'></i>";
		$(selected).children(":first-child").html(nike);
		
		$(selected).next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();
		
	};
	var _linkSelectPlan=function(selected){
		//二层选择取消
		$("#plan2ndDiv tbody tr").removeClass("plan_select2");
		//勾取消
		$("#plan2ndDiv tbody tr").children(":first-child").next().html("");
		$(selected).addClass("plan_select2");
		//打勾操作
		var nike="<i class='select'></i>";
		$(selected).children(":first-child").next().html(nike);
		order.prodModify.getChooseProdInfo();
		
	};
	//已订购业务
	var _btnQueryCustProdMore=function(param){
		if(OrderInfo.cust.custId==-1){
			$.alert("提示","新建客户无法查询已订购产品！");
			return;
		}
		var curPage=1;
		$("#prodDetail").hide();
		$("#prodInfo").hide();
		$("#prodList").show();
		//$("#orderedprod").show();
		$("#orderContent").show();
		if(order.cust.orderBtnflag==""){//初次查询
			//隐藏菜单
			main.home.hideMainIco();
			_btnQueryCustProd(curPage);
			$("#orderedprod").show();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
			
			$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");
			$("#orderbutton").css({"height":"35px","border-bottom":"1px solid #fff"});
			$("#orderbutton span").css({"color":"#327501"});
			order.cust.orderBtnflag="1";
		}else if(order.cust.orderBtnflag=="0"||$("#orderedprod").is(":hidden")){
			$("#orderedprod").show();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
			
			$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");
			$("#orderbutton").css({"height":"35px","border-bottom":"1px solid #fff"});
			$("#orderbutton span").css({"color":"#327501"});
			order.cust.orderBtnflag="1";
			
		}else{
			$("#orderedprod").hide();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrow");
			order.cust.orderBtnflag="0";
			$("#orderbutton").css({"height":"24px","border-bottom":"1px solid #4f7d3f"});
		}
		/*$("#orderbutton").off("click").on("click",function(event){_btnQueryPhoneNumber();event.stopPropagation();});*/
	};
	//定位客户选择地区
	var _chooseArea = function(){
		order.area.chooseAreaTree("/order/prepare","p_cust_areaId_val","p_cust_areaId",3,function(areaid,areaCode,areaName){
			OrderInfo.staff.soAreaId =areaid;
			OrderInfo.staff.soAreaName=areaName;
			OrderInfo.staff.soAreaCode =areaCode;
			$("#order_prepare").show();
			$("#order_tab_panel_content").hide();
			$("#step1").hide();
			
		});
	};
	//定位客户选择地区，选择使用人
	var _chooseAreaForChooseUser = function(){
		order.area.chooseAreaTree("/order/prepare","p_cust_areaId_val_choose","p_cust_areaId_choose",3,function(areaid,areaCode,areaName){
			OrderInfo.staff.soAreaId =areaid;
			OrderInfo.staff.soAreaName=areaName;
			OrderInfo.staff.soAreaCode =areaCode;
//			$("#order_prepare").show();
//			$("#order_tab_panel_content").hide();
//			$("#step1").hide();
			
		});
	};
	//客户信息查询户选择地区
	var _preQueryCustChooseArea = function(){
		order.area.chooseAreaTreeManger("cust/preQueryCust","p_areaId_val","p_areaId",3);
	};
	//异地定位客户选择地区
	var _chooseAllArea = function(){
		order.area.chooseAreaTreeAll("p_cust_areaId_val","p_cust_areaId",3,"limitProvince");
	};
	//协销人地区
	var _chooseStaffArea = function(){
		order.area.chooseAreaTreeCurrent("p_staff_areaId_val","p_staff_areaId",3,"limitProvince",$("#p_staff_areaId").val().substring(0,3)+"0000");
	//	order.area.chooseAreaTreeAll("p_staff_areaId_val","p_staff_areaId",3,"limitProvince");
	};
	//新建客户选择地区
	var _newCustChooseArea = function(){
		order.area.chooseAreaTree("/order/prepare","p_ncust_areaId_val","p_ncust_areaId",3);
	};
	//已订购选择地区
	var _prodChooseArea = function(){
		order.area.chooseAreaTree("/order/prepare","prodareaName","prodareaid",3);
		order.prodModify.choosedProdInfo.areaId=$("#prodareaid").val();
	};
	//定位客户证件类型下拉框
	var _initDic = function(){
//		var param = {"attrSpecCode":"PTY-0004"} ;
//		$.callServiceAsJson(contextPath+"/staffMgr/getCTGMainData",param,{
//			"done" : function(response){
//				if(response.code==0){
//					var data = response.data ;
//					if(data!=undefined && data.length>0){
//						for(var i=0;i<data.length;i++){
//							var busiStatus = data[i];
//							$("#p_cust_identityCd").append("<option value='"+busiStatus.attrValueCode+"' >"+busiStatus.attrValueName+"</option>");
//							
//						}
//					}
//				}else if(response.code==-2){
//					$.alertM(response.data);
//					return;
//				}else{
//					$.alert("提示","调用主数据接口失败！");
//					return;
//				}
//			}
//		});
		_certTypeByPartyType("-1","p_cust_identityCd"); //客户定位也使用根据客户类型查询证件类型接口，p_cust_identityCd=-1表示查询所有已关联的证件类型
		_certTypeByPartyType("-1","p_cust_identityCd_choose"); //初始化证件类型，p_cust_identityCd=-1表示查询所有已关联的证件类型
		_custidentidiesTypeCdChoose($("#p_cust_identityCd").children(":first-child"),"p_cust_identityNum");
		_checkAutoCustQry(); //省份甩单，自动定位客户
	};
	//使用带入的客户信息自动定位客户
	var _checkAutoCustQry = function(){
		if($("#fromProvFlag").length && $("#fromProvFlag").val() == "1"){
			order.cust.fromProvFlag = "1";
			order.cust.provIsale = $("#provIsale").val();
			$("#p_cust_areaId_val").val("");
			$("#p_cust_areaId").val($("#provAreaId").val());
			$("#p_cust_identityCd").val($("#provIdentityCd").val());
			$("#p_cust_identityNum").val($("#provIdentityNum").val());
			if($("#provIdentityCd").val()!=-1){
				$("#isAppointNum").attr("checked",false);
			}
			$("#usersearchbtn").click();
		} else {
			order.cust.fromProvFlag = "0";
			order.cust.provIsale = null;
		}
	};
	//客户属性-展示
	var _spec_parm_show = function(){
		var param={};
		$.callServiceAsHtmlGet(contextPath + "/cust/partyProfileSpecList",param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if (response.code == -2) {
					return;
				}
				$("#partyProfile").html(response.data);
				
				
			}
		});	
		
	};
	//客户属性-展示 更多按钮
	var _btnMoreProfile=function(){
		if($("#partyProfile").is(":hidden")){
			$("#partyProfile").show();
			$("#proarroworder").removeClass();
			$("#proarroworder").addClass("arrowup");
			order.cust.changeLabel(0);
		}else{
			$("#partyProfile").hide();
			$("#proarroworder").removeClass();
			$("#proarroworder").addClass("arrow");
			$("#tabProfile0").attr("click","1");
			$("#contactName").attr("data-validate","");
			_custcreateButton();
		}
		/*$("#orderbutton").off("click").on("click",function(event){_btnQueryPhoneNumber();event.stopPropagation();});*/
	};
	//客户信息查询定位客户
	var _queryCust = function(){
		var identityCd="";
		var acctNbr="";
		var identityNum="";
		identityCd=$("#p_cust_identityCd").val();
		identityNum=$.trim($("#p_cust_identityNum").val());
		if(identityNum==""){
			$.alert("提示","请输入证件号码！");
			return;
		}
		//判断是否是号码或身份证输入
		if(identityCd==1){
		 identityCd=$("#p_cust_identityCd").val();
		}
		if(identityCd==-1){
			acctNbr=identityNum;
			identityNum="";
			identityCd="";
		}

		diffPlace=$("#DiffPlaceFlag").val();
		areaId=$("#p_areaId").val();
		var param = {
				"acctNbr":acctNbr,
				"identityCd":identityCd,
				"identityNum":identityNum,
				"partyName":"",
				"custQueryType":$("#custQueryType").val(),
				"diffPlace":diffPlace,
				"areaId" : areaId
		};
		$.callServiceAsHtmlGet(contextPath+"/cust/queryCustAlone", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if (response.code == -2) {
					return;
				}
				if(!response){
					response.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';					
				}
				if(response.data =="fail\r\n"){
					$.alert("提示","查询失败，请稍后再试");
					return;
				}
				if(response.data =="error\r\n"){
					$.alert("提示","数据异常，请联系管理员");
					return;
				}
				$("#acctList").html(response.data).show();	
				$("#acctDetail").hide();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
		
	};
	//查询客户详情
	var _queryCustDetail = function(_custId){
		var param = {
				partyId : _custId,
				areaId : $("#p_areaId").val()
		};
		$.callServiceAsHtml(contextPath+"/cust/custInfo", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if (response.code == -2) {
					return;
				}
				if(!response){
					response.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';					
				}
				if(response.data =="fail\r\n"){
					$.alert("提示","查询失败，请稍后再试");
					return;
				}
				if(response.data =="error\r\n"){
					$.alert("提示","数据异常，请联系管理员");
					return;
				}
				$("#acctDetail").html(response.data).show();	
				$("#acctList").hide();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	var _mvnoCustCreate = function(callParam) {
		var param={};
		param.partyName=OrderInfo.cust.partyName;
		param.custId=OrderInfo.cust.custId;
		//定位客户
		param.idCardNumber=OrderInfo.cust.idCardNumber;
		$.callServiceAsHtml(contextPath + "/cust/mvnoCustCreate", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if (response.code == -2) {
					return;
				}
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				_partyTypeCdChoose($("#cmPartyTypeCd").children(":first-child"),"cc_identidiesTypeCd");
				_identidiesTypeCdChoose($("#div_cm_identidiesType").children(":first-child"),"ccCustIdCard");
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$(".ordercon").show();
				$(".ordertabcon").show();
				$("#step1").show();
				
				$(".ordercon a:first span").text("取 消");
				_form_custInfomodify_btn();
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	var _createCustConfirm = function() {
		//验证客户信息的长度（字符长度）--解决maxleng中中文只占一个字符导致后台数据库存储长度溢出
		var isLengthFlag = true; 
		$("#user_add  input").each(function(){
			var ascRegexp = /[^\x00-\xFF]/g;
			var length = $(this).attr("maxlength");
			var valueLength =  $(this).val().replace(ascRegexp, '..').length;
			if(valueLength>length){
				$.alert("提示",$(this).attr("id")+"字符超长！,请限制在"+length+"字符！(中文算两个字符！)");
				isLengthFlag = false;
				return false;
			}			
		});
		if(!isLengthFlag){
			return false;
		}
	createCustInfo = {
			cAreaId : OrderInfo.staff.soAreaId,// $("#p_ncust_areaId").val(),
			cAreaName : OrderInfo.staff.soAreaName,
			cCustName : $.trim($("#cCustName").val()),
			cCustIdCard :  $.trim($("#cCustIdCard").val()),
			cPartyTypeCd : $.trim($("#partyTypeCd  option:selected").val()), //($.trim($("#partyTypeCd  option:selected").val())==1) ? "1100":"1000",
			cPartyTypeName : ($.trim($("#partyTypeCd  option:selected").val())==1) ? "个人客户":"政企客户",
			cIdentidiesTypeCd : $.trim($("#identidiesTypeCd  option:selected").val()),
			cAddressStr :$.trim($("#cAddressStr").val()),
			cMailAddressStr :$.trim($("#cMailAddressStr").val())
		};
	var _boPartyContactInfo = {
			contactAddress : $.trim($("#contactAddress").val()),//参与人的联系地址
	        contactDesc : $.trim($("#contactDesc").val()),//参与人联系详细信息
	        contactEmployer  : $.trim($("#contactEmployer").val()),//参与人的联系单位
	        contactGender  : $.trim($("#contactGender").val()),//参与人联系人的性别
	        contactId : $.trim($("#contactId").val()),//参与人联系信息的唯一标识
	        contactName : $.trim($("#contactName").val()),//参与人的联系人名称
	        contactType : $.trim($("#contactType").val()),//联系人类型
	        eMail : $.trim($("#eMail").val()),//参与人的eMail地址
	        fax : $.trim($("#fax").val()),//传真号
	        headFlag :  $.trim($("#headFlag  option:selected").val()),//是否首选联系人
	        homePhone : $.trim($("#homePhone").val()),//参与人的家庭联系电话
	        mobilePhone : $.trim($("#mobilePhone").val()),//参与人的移动电话号码
	        officePhone : $.trim($("#officePhone").val()),//参与人办公室的电话号码
	        postAddress : $.trim($("#postAddress").val()),//参与人的邮件地址
	        postcode : $.trim($("#postcode").val()),//参与人联系地址的邮政编码
	        staffId : OrderInfo.staff.staffId,//员工ID
	        state : "ADD",//状态
	        statusCd : "100001"//订单状态
	};
	OrderInfo.boCustInfos.name=createCustInfo.cCustName;//客户名称
	OrderInfo.boCustInfos.areaId=createCustInfo.cAreaId;//客户地区
	OrderInfo.boCustInfos.partyTypeCd=createCustInfo.cPartyTypeCd;//客户类型
	OrderInfo.boCustInfos.defaultIdType=createCustInfo.cIdentidiesTypeCd;//证件类型
	OrderInfo.boCustInfos.addressStr=createCustInfo.cAddressStr;//客户地址
	OrderInfo.boCustInfos.mailAddressStr=createCustInfo.cMailAddressStr;//通信地址
	OrderInfo.boCustIdentities.identidiesTypeCd=createCustInfo.cIdentidiesTypeCd;//证件类型
	OrderInfo.boCustIdentities.identityNum=createCustInfo.cCustIdCard;//证件号码
	//boPartyContactInfo
	OrderInfo.boPartyContactInfo.contactAddress= _boPartyContactInfo.contactAddress,//参与人的联系地址
	OrderInfo.boPartyContactInfo.contactDesc =_boPartyContactInfo.contactDesc,//参与人联系详细信息
	OrderInfo.boPartyContactInfo.contactEmployer  =_boPartyContactInfo.contactEmployer,//参与人的联系单位
	OrderInfo.boPartyContactInfo.contactGender  =_boPartyContactInfo.contactGender,//参与人联系人的性别
	OrderInfo.boPartyContactInfo.contactId =_boPartyContactInfo.contactId,//参与人联系信息的唯一标识
	OrderInfo.boPartyContactInfo.contactName =_boPartyContactInfo.contactName,//参与人的联系人名称
	OrderInfo.boPartyContactInfo.contactType =_boPartyContactInfo.contactType,//联系人类型
	OrderInfo.boPartyContactInfo.eMail =_boPartyContactInfo.eMail,//参与人的eMail地址
	OrderInfo.boPartyContactInfo.fax =_boPartyContactInfo.fax,//传真号
	OrderInfo.boPartyContactInfo.headFlag =_boPartyContactInfo.headFlag,//是否首选联系人
	OrderInfo.boPartyContactInfo.homePhone =_boPartyContactInfo.homePhone,//参与人的家庭联系电话
	OrderInfo.boPartyContactInfo.mobilePhone =_boPartyContactInfo.mobilePhone,//参与人的移动电话号码
	OrderInfo.boPartyContactInfo.officePhone =_boPartyContactInfo.officePhone,//参与人办公室的电话号码
	OrderInfo.boPartyContactInfo.postAddress =_boPartyContactInfo.postAddress,//参与人的邮件地址
	OrderInfo.boPartyContactInfo.postcode =_boPartyContactInfo.postcode,//参与人联系地址的邮政编码
	OrderInfo.boPartyContactInfo.staffId =_boPartyContactInfo.staffId,//员工ID
	OrderInfo.boPartyContactInfo.state =_boPartyContactInfo.state,//状态
	OrderInfo.boPartyContactInfo.statusCd =_boPartyContactInfo.statusCd//订单状态

	OrderInfo.cust = {
		custId:-1,	
		partyName : createCustInfo.cCustName,
		areaId:createCustInfo.cAreaId
	};
	//客户属性
	OrderInfo.boCustProfiles=[];
	//客户属性节点
	for ( var i = 0; i < order.cust.partyProfiles.length; i++) {
		var partyProfiles = order.cust.partyProfiles[i];
		var profileValue=$("#"+partyProfiles.attrId).val();
		if(""==profileValue||undefined==profileValue){
			profileValue==$("#"+partyProfiles.attrId+"option:selected").val();
		}
		var partyProfiles = {
				partyProfileCatgCd: partyProfiles.attrId,
				profileValue: profileValue,
                state: "ADD"
		};
		if(""!=profileValue&&profileValue!=undefined){
		OrderInfo.boCustProfiles.push(partyProfiles);}
	}
	
	easyDialog.close();
	var param = {};
	param.prodPwd = "";
	param.accessNumber="";
	param.authFlag="1";
	authFlag="";
	param.identityCd=createCustInfo.cIdentidiesTypeCd;
	param.idCardNumber=createCustInfo.cCustIdCard;
	param.partyName=createCustInfo.cCustName;
	param.areaId=createCustInfo.cAreaId;
	param.areaName=createCustInfo.cAreaName;
	param.segmentName=createCustInfo.cPartyTypeName;
	param.identityName=$("#identidiesTypeCd  option:selected").text();
	$.callServiceAsHtml(contextPath+"/cust/custAuth",param,{
		"before":function(){
			$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
		},"done" : function(response){
			if(response.code != 0) {
				$.alert("提示","客户鉴权失败,稍后重试");
				return;
			}
			if(response.data.indexOf("false") >=0) {
				$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
				return;
			}
			
			_custAuthCallBack(response);
		},"always":function(){
			$.unecOverlay();
		}
	});
   };
   //验证证件号码是否存在
	var _checkIdentity = function() {
		if(!ec.util.isObj($.trim($("#identidiesTypeCd  option:selected").val()))){
			$.alert("提示","证件类型不能为空！","information");
			return;
		}
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		var custName=$("#p_cust_areaId_val").val();
		createCustInfo = {
				cAreaId : areaId,
				cAreaName : custName,
				cCustName : $.trim($("#cCustName").val()),
				cCustIdCard :  $.trim($("#cCustIdCard").val()),
				cPartyTypeCd : $.trim($("#partyTypeCd  option:selected").val()),
				cIdentidiesTypeCd : $.trim($("#identidiesTypeCd  option:selected").val()),
				cAddressStr :$.trim($("#cAddressStr").val())
			};
		diffPlace=$("#DiffPlaceFlag").val();
		var params = {
				"acctNbr":"",
				"identityCd":createCustInfo.cIdentidiesTypeCd,
				"identityNum":createCustInfo.cCustIdCard,
				"partyName":"",
				"custQueryType":$("#custQueryType").val(),
				"diffPlace":diffPlace,
				"areaId" : createCustInfo.cAreaId
		};
		var url=contextPath+"/cust/checkIdentity";
		var response = $.callServiceAsJson(url, params, {"before":function(){
			$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
		}});
		var msg="";
		if (response.code == 0) {
			$.unecOverlay();
			$.confirm("确认","此证件号码已存在,是否确认新建?",{ 
				yes:function(){	
					_createCustConfirm();
				},
				no:function(){
					
				}
			});
		}else{
			$.unecOverlay();
			_createCustConfirm();
		}
	};
	//切换标签
	var _changeLabel = function(labelId){
		if($("#partyProfile").is(":visible")==false){
			$("#partyProfile").show();
		}
		if(labelId=="0"){
			$("#tabProfile0").show();
			$("#cardtab_pro_0").addClass("setcon");
			$("#tabProfile0").attr("click","0");
			$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(blur)").attr("placeholder","请准确填写联系人名称");
			_custcreateButton();
		}else if(($("#tabProfile0").attr("click")=="0")&&($("#contactName").val()=="")){
			$.alert("提示","联系人名称不能为空！","information");
			return;
		}
		for ( var i = 0; i < order.cust.profileTabLists.length; i++) {
			var profileTabLists = order.cust.profileTabLists[i];
			var tabProfileNum=profileTabLists.tabProfileNum;
			var partyProfileCatgTypeCd=profileTabLists.partyProfileCatgTypeCd;
			if(labelId==partyProfileCatgTypeCd){
				$("#"+tabProfileNum).show();
				$("#cardtab_pro_"+partyProfileCatgTypeCd).addClass("setcon");
				$("#tabProfile0").hide();
				$("#cardtab_pro_0").removeClass("setcon");
			}else{
				$("#"+tabProfileNum).hide();
				$("#cardtab_pro_"+partyProfileCatgTypeCd).removeClass("setcon");
			}
		}
		
	};
	//指定号码checkbox
	var _isAppointNum = function(identityCdId){
		identityCdId = identityCdId || 'p_cust_identityCd';
		if($("#"+identityCdId).val()!=-1){
			$.alert("提示","只能接入号码才能指定号码！","information");
			$("#isAppointNum").attr("checked",false);
			return;
		}
		
		
	};
	//退出二次业务
	var _cancel = function() {		
			//退出二次业务时释放被预占的UIM卡
			var boProd2Tds = OrderInfo.boProd2Tds;
			if(boProd2Tds.length>0){
				for(var n=0;n<boProd2Tds.length;n++){
					var param = {
							numType : 2,
							numValue : boProd2Tds[n].terminalCode
					};
					$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
				}
			}
			//退出二次业务时释放被预占的号码（过滤身份证预占的号码）
			var boProdAns = OrderInfo.boProdAns;
			if(boProdAns.length>0){
				for(var n=0;n<boProdAns.length;n++){
					if(boProdAns[n].idFlag){
						continue;
					}
					var param = {
							numType : 1,
							numValue : boProdAns[n].accessNumber
					};
					$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
				}
				order.service.boProdAn = {};
				order.phoneNumber.resetBoProdAn();
			}			
			//页面变动
			$("#order_fill_content").empty();
			order.prepare.hideStep();
			$("#orderedprod").show();
			$("#order_prepare").show();
	};
	//返回按钮
	var _back = function(){
		$("#acctDetail").hide();
		$("#acctList").show();
	};
	//定位客户时读卡
	var _readCert = function() {
		var man = cert.readCert();
		if (man.resultFlag != 0){
			$.alert("提示", man.errorMsg);
			return;
		}
		$('#p_cust_identityCd').val(1);//身份证类型
		_custidentidiesTypeCdChoose($("#p_cust_identityCd").children(":first-child"),"p_cust_identityNum");
		$('#p_cust_identityNum').val(man.resultContent.certNumber);
		$('#p_cust_identityNum').attr("disabled",true);
		//查询
		$("#usersearchbtn").click();
	};
	//新建客户时读卡
	var _readCertWhenCreate = function() {
		var man = cert.readCert();
		if (man.resultFlag != 0){
			$.alert("提示", man.errorMsg);
			return;
		}
		$('#partyTypeCd').val(1);//个人
		_partyTypeCdChoose($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");
		$('#identidiesTypeCd').val(1);//身份证类型
		_identidiesTypeCdChoose($("#identidiesTypeCd").children(":first-child"),"cCustIdCard");
		$('#cCustIdCard').val(man.resultContent.certNumber);//设置身份证号
		$('#cCustIdCard').attr("disabled",true);
		$('#cCustName').val(man.resultContent.partyName);//姓名
		$('#cCustName').attr("disabled",true);
		$('#cAddressStr').val(man.resultContent.certAddress);//地址
		$('#cAddressStr').attr("disabled",true);
	};
	//用户鉴权时读卡
	var _readCertWhenAuth = function() {
		var man = cert.readCert();
		if (man.resultFlag != 0){
			$.alert("提示", man.errorMsg);
			return;
		}
		$('#authIDTD').val(man.resultContent.certNumber);
		$('#authIDTD').attr("disabled",true);
		
		$("#custAuthbtnID").click();
	};
	//绑定客户选择查询事件，使用人
	var _bindCustQueryForChoose = function(){
		$('#custQueryForChooseForm').off().bind('formIsValid', function(event, form) {
			var identityCd="";
			var idcard="";
			var diffPlace="";
			var acctNbr="";
			var identityNum="";
			var queryType="";
			var queryTypeValue="";
			identityCd=$("#p_cust_identityCd_choose").val();
			identityNum=$.trim($("#p_cust_identityNum_choose").val());
			authFlag="0"; //需要鉴权
			if(identityCd==-1){
				acctNbr=identityNum;
				identityNum="";
				identityCd="";
			}else if(identityCd=="acctCd"||identityCd=="custNumber"){
				acctNbr="";
				identityNum="";
				identityCd="";
				queryType=$("#p_cust_identityCd").val();
				queryTypeValue=$.trim($("#p_cust_identityNum_choose").val());
			}
			diffPlace=$("#DiffPlaceFlag_choose").val();
			areaId=$("#p_cust_areaId_choose").val();
			//lte进行受理地区市级验证
			if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){
				$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");
				return;
			}
			var param = {
					"acctNbr":acctNbr,
					"identityCd":identityCd,
					"identityNum":identityNum,
					"partyName":"",
					"custQueryType":$("#custQueryType_choose").val(),
					"diffPlace":diffPlace,
					"areaId" : areaId,
					"queryType" :queryType,
					"queryTypeValue":queryTypeValue,
					"identidies_type":$("#p_cust_identityCd_choose  option:selected").text()
			};
			
			
			//JSON.stringify(param)
			$.callServiceAsHtml(contextPath+"/cust/queryCust",param, {
				"before":function(){
					$.ecOverlay("<strong>正在查询中，请稍等...</strong>");
				},"always":function(){
					$.unecOverlay();
				},	
				"done" : function(response){
					if (response.code == -2) {
						return;
					}
					if(response.data.indexOf("false") >=0) {
						$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
						return;
					}
					
					order.cust.jumpAuthflag = $(response.data).find('#jumpAuthflag').val();
					order.cust.showCustAuth($(response.data).find('#custInfos'));
//					var content$ = $("#custList");
//					content$.html(response.data).show();
//					$(".userclose").off("click").on("click",function(event) {
//						authFlag="";
//						$(".usersearchcon").hide();
//					});
//					if($("#custListTable").attr("custInfoSize")=="1"){
//						$(".usersearchcon").hide();
//					}
				},
				"fail":function(response){
					$.unecOverlay();
					$.alert("提示","查询失败，请稍后再试！");
				}
			});
		}).ketchup({bindElement:"userSearchForChooseBtn"});
	};
	
	//客户架构信息查询接口
	var _queryCustCompreInfo = function(mainPhoneNum,provCustAreaId,busitypeflag,oldFlag){
		var param = {
			    "acctNbr": "",
			    "areaId": provCustAreaId,
			    "diffPlace": "local",
			    "identidies_type": "",
			    "identityCd": "",
			    "identityNum": "",
			    "olTypeCd": "8",
			    "operType": busitypeflag,
			    "partyName": "",
			    "prodClass": "12",
			    "queryType": "",
			    "queryTypeValue": ""
			};
		if(busitypeflag==1){
			param.queryTypeValue = mainPhoneNum;
			param.identidies_type = "客户编码";
			param.queryType = "custNumber";
		}else{
			param.acctNbr = mainPhoneNum;
			param.identidies_type = "接入号码";
		}
		$.ecOverlay("<strong>正在查询客户架构信息中,请稍等...</strong>");
		var response = $.callServiceAsJson(contextPath+"/token/pc/cust/queryCustCompreInfo", param);
		$.unecOverlay();
		if(response.code == 0) {
			if(response.data == null){
				$.alert("提示","客户架构信息接口无数据返回。");
				return false;
			}
			if(response.data.custInfos==undefined){
				$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
				return false;
			}else if(!ec.util.isArray(response.data.custInfos)){
				$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
				return false;
			}
			if(response.data.prodInstInfos==undefined && busitypeflag!=1){
				$.alert("提示","客户下没有可以办理业务的移动用户。");
				return false;
			}
			if(response.data.offerMemberInfos==undefined && busitypeflag!=1){
				$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理。");
				return false;
			}
			if(oldFlag=="OLD"){
				var custInfos = response.data.custInfos;
				if(OrderInfo.actionFlag!=1 && custInfos[0].custId!=OrderInfo.cust.custId){
					$.alert("提示",mainPhoneNum+"和主卡的客户不一致！");
					return false;
				}
				var prodInstInfos = {};
				var prodInfos = response.data.prodInstInfos;
				$.each(prodInfos,function(){
					if(this.accNbr==mainPhoneNum){
						prodInstInfos = this;
						if(prodInstInfos.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
							$.alert("提示",mainPhoneNum+"不是在用产品！");
							return false;
						}
						if(OrderInfo.actionFlag!=1 && prodInstInfos.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){
							$.alert("提示",mainPhoneNum+"和主卡的付费类型不一致！");
							return false;
						}
						if(prodInstInfos.productId=="280000000"){
							$.alert("提示",mainPhoneNum+"是无线宽带，不能纳入！");
							return false;
						}
						prodInstInfos.custId = custInfos[0].custId;
						OrderInfo.oldprodInstInfos.push(prodInstInfos);
					}
				})
				
				var flag = true;
				for ( var i = 0; i < response.data.offerMemberInfos.length; i++) {
					var member = response.data.offerMemberInfos[i];
					if(member.objType==""){
						$.alert("提示","销售品实例构成 "+member.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");
						return false;
					}else if(member.objType==CONST.OBJ_TYPE.PROD){
						if(member.accessNumber==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
							return false;
						}
					}
					if(member.objInstId==prodInstInfos.prodInstId){
						flag = false;
					}
				}
				if(flag){
					$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+prodInstInfos.accNbr+"】，无法继续受理，请业务后台核实");
					return false;
				}
				var offerInfos = {
					"offerMemberInfos":	response.data.offerMemberInfos,
					"offerId":prodInstInfos.mainProdOfferInstInfos[0].prodOfferInstId,
					"offerSpecId":prodInstInfos.mainProdOfferInstInfos[0].prodOfferId,
					"offerSpecName":prodInstInfos.mainProdOfferInstInfos[0].prodOfferName,
					"accNbr":prodInstInfos.accNbr
				};
				OrderInfo.oldoffer.push(offerInfos);
				order.memberChange.viceCartNum = 0;
				$.each(OrderInfo.oldoffer,function(){
					$.each(this.offerMemberInfos,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD){
							order.memberChange.viceCartNum++;
						}
					})
				});
			}else{
				var custInfos = response.data.custInfos;
				OrderInfo.cust={
					addressStr: custInfos[0].addressStr,
					areaId: custInfos[0].areaId,
					areaName: custInfos[0].areaName,
					authFlag: custInfos[0].authType,
					custFlag: custInfos[0].custFlag,
					custId: custInfos[0].custId,
					idCardNumber: custInfos[0].idCardNumber,
					identityCd: custInfos[0].identityCd,
					identityName: custInfos[0].identityName,
					norTaxPayer: "",
					partyName: custInfos[0].partyName,
					segmentId: custInfos[0].segmentId,
					segmentName: custInfos[0].segmentName,
					vipLevel: custInfos[0].vipLevel,
					vipLevelName: custInfos[0].vipLevelName
				}
				if(busitypeflag!=1){
					var prodInstInfos = response.data.prodInstInfos;
					order.prodModify.choosedProdInfo={
						accNbr: prodInstInfos[0].accNbr,
						areaCode: prodInstInfos[0].zoneNumber,
						areaId: prodInstInfos[0].areaId,
						corProdInstId: prodInstInfos[0].corProdInstId,
						custId: prodInstInfos[0].mainProdOfferInstInfos[0].custId,
						custName: prodInstInfos[0].mainProdOfferInstInfos[0].custName,
						endDt: prodInstInfos[0].mainProdOfferInstInfos[0].endDt,
						extProdInstId: prodInstInfos[0].extProductId,
						feeType: prodInstInfos[0].feeType.feeType,
						feeTypeName: prodInstInfos[0].feeType.feeTypeName,
						is3G: prodInstInfos[0].mainProdOfferInstInfos[0].is3G,
						prodBigClass: prodInstInfos[0].prodBigClass,
						prodClass: prodInstInfos[0].prodClass,
						prodInstId: prodInstInfos[0].prodInstId,
						prodOfferId: prodInstInfos[0].mainProdOfferInstInfos[0].prodOfferId,
						prodOfferInstId: prodInstInfos[0].mainProdOfferInstInfos[0].prodOfferInstId,
						prodOfferName: prodInstInfos[0].mainProdOfferInstInfos[0].prodOfferName,
						prodStateCd: prodInstInfos[0].prodStateCd,
						prodStateName: prodInstInfos[0].prodStateName,
						productId: prodInstInfos[0].productId,
						productName: prodInstInfos[0].productName,
						startDt: prodInstInfos[0].mainProdOfferInstInfos[0].startDt,
						stopRecordCd: prodInstInfos[0].prodStopRecords[0].stopRecordCd,
						stopRecordName: prodInstInfos[0].prodStopRecords[0].stopRecordName
					}
					var flag = true;
					for ( var i = 0; i < response.data.offerMemberInfos.length; i++) {
						var member = response.data.offerMemberInfos[i];
						if(member.objType==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");
							return false;
						}else if(member.objType==CONST.OBJ_TYPE.PROD){
							if(member.accessNumber==""){
								$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
								return false;
							}
						}
						if(member.objInstId==order.prodModify.choosedProdInfo.prodInstId){
							flag = false;
						}
					}
					if(flag){
						$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+order.prodModify.choosedProdInfo.accNbr+"】，无法继续受理，请业务后台核实");
						return false;
					}
					OrderInfo.offer.offerMemberInfos = response.data.offerMemberInfos; 
					OrderInfo.offer.offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
					OrderInfo.offer.offerSpecId = order.prodModify.choosedProdInfo.prodOfferId;
					OrderInfo.offer.offerSpecName = order.prodModify.choosedProdInfo.prodOfferName;
				}
			}
		}else{
			$.alertM(response.data);
			return false;
		}
		return true;
	};
	
	return {
		form_valid_init : _form_valid_init,
		showCustAuth : _showCustAuth,
		showCustCreate : _showCustCreate,
		custAuth : _custAuth,
		getCustInfo : _getCustInfo,
		custReset:_custReset,
		btnQueryCustProd:_btnQueryCustProd,
		btnQueryCustProdMore:_btnQueryCustProdMore,
		jumpAuth : _jumpAuth,
		identidiesTypeCdChoose :_identidiesTypeCdChoose,
		custidentidiesTypeCdChoose :_custidentidiesTypeCdChoose,
		choosedCustInfo :_choosedCustInfo,
		partyTypeCdChoose :_partyTypeCdChoose,
		chooseArea :_chooseArea,
		chooseAllArea : _chooseAllArea,
		chooseStaffArea : _chooseStaffArea,
		newCustChooseArea :_newCustChooseArea,
		prodChooseArea : _prodChooseArea,
		initDic : _initDic,
		btnMoreProfile : _btnMoreProfile,
		partyProfiles : _partyProfiles,
		profileTabLists : _profileTabLists,
		queryCust : _queryCust,
		queryCustDetail :_queryCustDetail,
		mvnoCustCreate : _mvnoCustCreate,
		changeLabel :_changeLabel,
		jumpAuthflag : _jumpAuthflag,
		orderBtnflag :_orderBtnflag,
		custcreateButton :_custcreateButton,
		isAppointNum :_isAppointNum,
		preQueryCustChooseArea :_preQueryCustChooseArea,
		linkSelectPlan:_linkSelectPlan,
		back :_back,
		readCert : _readCert,
		readCertWhenCreate : _readCertWhenCreate,
		readCertWhenAuth : _readCertWhenAuth,
		fromProvFlag : _fromProvFlag,
		provIsale : _provIsale,
		chooseAreaForChooseUser : _chooseAreaForChooseUser,
		certTypeByPartyType : _certTypeByPartyType,
		bindCustQueryForChoose : _bindCustQueryForChoose,
		tmpChooseUserInfo : _tmpChooseUserInfo,
		queryForChooseUser : _queryForChooseUser,
		queryCustCompreInfo:_queryCustCompreInfo
	};
})();
$(function() {
//   order.cust.form_valid_init();
	order.cust.initDic();
});
/**
 * 附属销售品受理对象
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("uiAttachOffer");

/** 附属销售品受理对象*/
uiAttachOffer = (function() {

	var _openList = []; //保存已经选择的附属销售品列表，保存附属销售品完整节点，以及参数值
	
	var _openedList = []; //已经订购的附属销售品列表，保存附属销售品完整节点，以及参数值
	
	var _openServList = []; //保存已经选择功能产品列表，保存附属销售品完整节点，以及参数值
	
	var _openedServList = []; //保存已经订购功能产品列表，保存附属销售品完整节点，以及参数值
	
	var _openAppList = []; //保存产品下增值业务
	
	var _changeList = []; //3g订购4g流量包订单提交预校验时，保存修改缓存列表的修改数据，用于订单确认页面返回的反向操作
	
	var _labelList = []; //标签列表
	
	var isRightCheck="N";
	
//	var _terminalGroups=[];//终端组
	var totalNums=0;//记录总共添加了多少个终端输入框
	//初始化附属销售页面
	var _init = function(){
		//开始进入订单页面new
		
		var prodInfo = order.prodModify.choosedProdInfo;
		
		if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
			order.uiCust.showPackageDialog("客户无可用产品,无法操作!");
			//$.alert("提示","请选择一个在用产品");
			return;
		}
		OrderInfo.actionFlag = 3;
		if(OrderInfo.provinceInfo.mergeFlag=="0"){
			if(!uiOfferQuery.setOffer()){ //必须先保存销售品实例构成，加载实例到缓存要使用
				return ;
			}
		}
		//规则校验入参
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		},{
			boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		}];
		if(!rule.rule.ruleCheck(boInfos)){ //规则校验失败
			return;
		}
		var param = {
			offerSpecId : prodInfo.prodOfferId,
			offerTypeCd : 1,
			partyId: OrderInfo.cust.custId
		};
		if(ec.util.isObj(prodInfo.prodOfferId)){
			if(!query.offer.queryMainOfferSpec(param)){ //查询主套餐规格构成，并且保存
				return;
			}
		}else{
			OrderInfo.offerSpec = {};
		}
		if(CONST.getAppDesc()==0){ //4g系统需要
			if(!prod.uim.setProdUim()){ //根据UIM类型，设置产品是3G还是4G，并且保存旧卡
				return;	
			}
		}
		
		uiAttachOffer.queryAttachOffer();
	}; 
	
	//已订购的附属销售品查询
	var _queryAttachOffer = function() {
		//加载订单填写页面信息内容!!new
		
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		var prodId = prodInfo.prodInstId;
		var param = {
		    prodId : prodId,
		    prodSpecId : prodInfo.productId,
		    offerSpecId : prodInfo.prodOfferId,
		    acctNbr : prodInfo.accNbr
		};
		if(ec.util.isObj(prodInfo.prodBigClass)){
			param.prodBigClass = prodInfo.prodBigClass;
		}
		
		//调用control，加载订单填写页面new
		var data = uiOfferQuery.queryAttachOfferHtml(param);
		
		//初始化填单页面new
		SoOrder.initFillPage();
		
		$("#order_fill_content").html(data).show();
		
		//在初始化填单页面后，一些信息是不需要的，暂时隐藏new
		$("#step1").hide();
		
		var member = CacheData.getOfferMember(prodId);
		//如果objId，objType，objType不为空才可以查询默认必须
		if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){
			param.queryType = "1,2";
			param.objId = member.objId;
			param.objType = member.objType;
			param.offerRoleId = member.offerRoleId;
			param.memberRoleCd = member.roleCd;
			//默认必须可选包
			var data = query.offer.queryDefMustOfferSpec(param);
			CacheData.parseOffer(data);
			//默认必须功能产品
			var data = query.offer.queryServSpec(param);
			CacheData.parseServ(data);
		}
		if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){ //主套餐下的成员判断
			var member = CacheData.getOfferMember(prodId);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(this.offerRoleId==member.offerRoleId && member.objType==CONST.OBJ_TYPE.PROD){
					var offerRole = this;
					$.each(this.roleObjs,function(){
						if(this.objType==CONST.OBJ_TYPE.SERV){
							var serv = CacheData.getServBySpecId(prodId,this.objId);//从已订购功能产品中找
							if(serv!=undefined){ //不在已经开跟已经选里面
								var $oldLi = $('#li_'+prodId+'_'+serv.servId);
								if(this.minQty==1){
									$oldLi.append('<dd class="mustchoose"></dd>');
								}
								$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
							}
						}
					});
					return false;
				}
			});
		}
		uiAttachOffer.changeLabel(prodId, prodInfo.productId,""); //初始化第一个标签附属
		order.dealer.initDealer();
		
		//进入订单页面加载结束,获取页面数据，判断是否二次加载订单
		//如果是暂存订单，需要加载订单信息
		_querrOldOrderInfo();
	};
	
	var _querrOldOrderInfo=function(){
		//开始可选包前进行重载校验 
		var isReload=order.uiCust.packageInfo.reloadFlag;
		
		var orderInfo=order.uiCust.orderInfo;
		
		if(isReload=="N"){
			//0是正确的，进行信息重新加载
			var resultCode=orderInfo.resultCode;
			var resultMsg=orderInfo.resultMsg;
			
			if(resultCode=="0"){
				//进行进行数据解析工作,获取产品数据
				var custOrderList=orderInfo.result.orderList.custOrderList;
				
				var orderListInfo=orderInfo.result.orderList.orderListInfo;
				
				if(custOrderList!=null && custOrderList!=""){
					//获取下属的产品
					if(custOrderList!=null && custOrderList.length>0){
						$(custOrderList).each(function(i,custOrder) { 
							//先把删除的开通功能进行删除操作
							$(custOrder.busiOrder).each(function(i,busiOrder) { 
								//解析到具体的订购产品数据
								//获取产品操作类型
								var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;
								
								//获取产品的操作状态,state,del-删除,add-添加
								var state="";
								var data=busiOrder.data;
								var ooOwners;
								var boServs;
								
								// 7是已开通功能，状态的获取和其他类型获取不一样
								if(boActionTypeCd=="7"){
									boServs=data.boServs;
									
									if(boServs!=null){
										$(boServs).each(function(i,boServ) { 
											state=boServ.state;
										});
									}
								}
								
								var busiObj=busiOrder.busiObj;
								
								if(boActionTypeCd=="7"){
									//7是已开通功能产品
									//获取唯一ID标识
									var instId=busiObj.instId;
									
									var boServOrders=data.boServOrders;
									
									$(data.boServs).each(function(i,boServ) { 
										var servId=boServ.servId;
										var state=boServ.state;
										if(state=="DEL"){
											_closeServSub(instId,servId);
										}
									});
								}
							});
						});
						
						$(custOrderList).each(function(i,custOrder) { 
							$(custOrder.busiOrder).each(function(i,busiOrder) { 
								//解析到具体的订购产品数据
								//获取产品操作类型
								var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;
								
								//获取产品的操作状态,state,del-删除,add-添加
								var state="";
								
								var data=busiOrder.data;
								
								var ooOwners;
								var boServs;
								
								// 7是已开通功能，状态的获取和其他类型获取不一样
								if(boActionTypeCd=="7"){
									boServs=data.boServs;
									
									if(boServs!=null){
										$(boServs).each(function(i,boServ) { 
											state=boServ.state;
										});
									}
								}else{
									ooOwners=data.ooOwners;
									if(ooOwners!=null){
										$(ooOwners).each(function(i,ooOwner) { 
											state=ooOwner.state;
											return false
										});
									}
								}
								
								var busiObj=busiOrder.busiObj;
								
								//S2是已订购可选包
								if(boActionTypeCd=="S2"){
									//获取唯一ID标识
									var instId=busiObj.instId;
									
									$(data.ooRoles).each(function(i,ooRole) { 
										var objInstId=ooRole.objInstId;
										if(state=="DEL"){
											_delOfferSub(objInstId,instId);
										}
									});
								}else if(boActionTypeCd=="7"){
									//7是已开通功能产品
									//获取唯一ID标识
									var instId=busiObj.instId;
									
									var boServOrders=data.boServOrders;
									
									$(data.boServs).each(function(i,boServ) { 
										var servId=boServ.servId;
										var state=boServ.state;
										
										if(state=="ADD"){
											$(boServOrders).each(function(i2,boServOrder) {
												var servSpecId=boServOrder.servSpecId;
												var servSpecName=boServOrder.servSpecName;
												
												_openServSpecSub(instId,servSpecId,servSpecName,'N');
											});
										}
									});
								}else if(boActionTypeCd=="S1"){
									//S1是订单中的已选可选包数据
									//获取唯一ID标识
									var objId=busiObj.objId;
									var accessNumber=busiObj.accessNumber;
									var objName=busiObj.objName;
									var prodId=null;
									
									var ooRoles=data.ooRoles;
									var busiOrderAttrs=data.busiOrderAttrs;
									
									$(data.ooRoles).each(function(i,ooRole) { 
										prodId=ooRole.prodId;
										return false;
									});
									
									var isNeedAdd=false;
									
									var roleCode="";
									
									$(busiOrderAttrs).each(function(i,busiOrderAttr) { 
										var itemSpecId=busiOrderAttr.itemSpecId;
										if(itemSpecId=="111111120"){
											roleCode=busiOrderAttr.role;
											isNeedAdd=true;
											return false;
										}
									});
									
									//新增发展人
									if(isNeedAdd){
										_addAttachDealerSub(prodId+"_"+objId,accessNumber,objName,roleCode);
									}
									
									//重载订单中已经选择的服务
									_addOfferSpecSub(prodId,objId,ooRoles);
									
									//加载终端数据
									var bo2Coupons=data.bo2Coupons;
									
									if(bo2Coupons!=null && bo2Coupons!=null && bo2Coupons.length>0){
										$(bo2Coupons).each(function(i,bo2Coupon) { 
											var prodId=bo2Coupon.prodId;
											var attachSepcId=bo2Coupon.attachSepcId;
											var num=bo2Coupon.num;
											var couponInstanceNumber=bo2Coupon.couponInstanceNumber;
											
											if(num>1){
												$("#terminalAddBtn_"+prodId+"_"+attachSepcId).click();
											}
											
											$("#terminalText_"+prodId+"_"+attachSepcId+"_"+num).val(couponInstanceNumber);
											
											_checkTerminalCodeSub($("#terminalBtn_"+prodId+"_"+attachSepcId+"_"+num));
										});
									}
								}
							});
						});
						
						
						//号码的预占一定要放到最后
						$(custOrderList).each(function(i,custOrder) { 
							$(custOrder.busiOrder).each(function(i,busiOrder) { 
								//解析到具体的订购产品数据
								//获取产品操作类型
								var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;
								
								var data=busiOrder.data;
								
								var ooOwners;
								var boServs;
								
								// 7是已开通功能，状态的获取和其他类型获取不一样
								if(boActionTypeCd=="14"){
									//加载UIM数据
									var bo2Coupons=data.bo2Coupons;
									
									if(bo2Coupons!=null && bo2Coupons!=null && bo2Coupons.length>0){
										$(bo2Coupons).each(function(i,bo2Coupon) { 
											var prodId=bo2Coupon.prodId;
											var attachSepcId=bo2Coupon.attachSepcId;
											var couponInstanceNumber=bo2Coupon.couponInstanceNumber;
											var state=bo2Coupon.state;
											
											if(state=="ADD"){
												//$("#uim_txt_"+prodId).val(couponInstanceNumber);
												
												//先释放
												//_releaseUim(prodId);
												
												//$("#uim_txt_"+prodId).val(couponInstanceNumber);											
												
												//第一次不知道为什么都会失败
												//_checkUim(prodId);
												
												//进行第二次
												//if(isRightCheck=="N"){
												//	_checkUim(prodId);
												//}
												_uimCardInfoSearch(couponInstanceNumber,prodId,bo2Coupon);
											}
										});
									}
								}
							});
						});
						
					}
				}
				
				//订单备注和模版等加载
				if(orderListInfo!=null && custOrderList!=null){
					var custOrderAttrs=orderListInfo.custOrderAttrs;
					var isTemplateOrder=orderListInfo.isTemplateOrder;
					var templateOrderName=orderListInfo.templateOrderName;
					
					$(custOrderAttrs).each(function(i,custOrderAttr) { 
						var itemSpecId=custOrderAttr.itemSpecId;
						
						//111111118是为备注的编码
						if(itemSpecId=="111111118"){
							var value=custOrderAttr.value;
							
							if(value!=null && value!=""){
								$("#order_remark").html(value);
							}
						}
					});
					
					//模版的操作
					if(isTemplateOrder=="Y"){
						$("#isTemplateOrder").click();//选中模版按钮
						
						SoOrder.showTemplateOrderName();//显示模版名称输入
						
						$("#templateOrderName").val(templateOrderName);//赋值模版名称
					}
				}
			}
		}
	}
	
	var  _uimCardInfoSearch=function(instCode,prodId,bo2Coupon){
		$("#uim_txt_"+prodId).val(instCode);//将UIM卡信息放入
		var coupon = {
				couponUsageTypeCd : "3", //物品使用类型
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : bo2Coupon.couponId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : "3000", //物品费用项类型
				couponNum : 1, //物品数量
				storeId : bo2Coupon.storeId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : 0, //物品价格
				couponInstanceNumber :instCode, //物品实例编码
				terminalCode : instCode,//前台内部使用的UIM卡号
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId :  prodId, //产品ID
				offerId : bo2Coupon.offerId, //销售品实例ID
				state : "ADD", //动作
				relaSeq : "" //关联序列	
		};
		if(bo2Coupon.cardTypeFlag!=null && bo2Coupon.cardTypeFlag!=""){
			coupon.cardTypeFlag=bo2Coupon.cardTypeFlag;
		}
		
		//校验按钮
		$("#uim_check_btn_"+prodId).attr("disabled",true);
		$("#uim_check_btn_"+prodId).attr("class","disablepurchase");
		
		//释放按钮
		$("#uim_release_btn_"+prodId).removeAttr("disabled");
		$("#uim_release_btn_"+prodId).attr("class","purchase");
		
		//输入框
		$("#uim_txt_"+prodId).attr("disabled",true);
		
		if(getIsMIFICheck(prodId)){//判断是否通过MIFI 校验
			$("#isMIFI_"+prodId).val("yes");
		}else{
			$("#isMIFI_"+prodId).val("no");
		}
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
	}
	
	//删除已订购可选包(new)
	var _delOfferSub = function(prodId,offerId){
		var $span = $("#li_"+prodId+"_"+offerId).find("span"); //定位删除的附属
		if($span.attr("class")=="del"){  //已经退订，再订购
			//AttachOffer.addOffer(prodId,offerId,$span.text());
		}else { //退订
			var offer = _getOffer(prodId,offerId);
			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offerId	
				};
				if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
						if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
							param.areaId = OrderInfo.oldprodInstInfos[i].areaId;
							param.acctNbr = OrderInfo.oldprodInstInfos[i].accNbr;
						}
					}
				}else{
					param.acctNbr = OrderInfo.getAccessNumber(prodId);
				}
				var data = uiOfferQuery.queryOfferInst(param);
				if(data==undefined){
					return;
				}
				//遍历附属的构成要和主套餐的构成实例要一致（兼容融合套餐）
				var offerMemberInfos=[];
				$.each(data.offerMemberInfos,function(){
					var prodInstId=this.objInstId;
					var flag=false;
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objInstId==prodInstId){
							flag=true;
							return false;
						}
					});
					if(flag){
						offerMemberInfos.push(this);
					}
				});
				
				offer.offerMemberInfos = data.offerMemberInfos=offerMemberInfos;
				offer.offerSpec = data.offerSpec;
			}
			var content = "";
			if(offer.offerSpec!=undefined){
				content = CacheData.getOfferProdStr(prodId,offer,1);
			}
			//这里原先是有弹窗提示的，二次加载就不需要了，原方法：_delOffer
			offer.isdel = "Y";
			$span.addClass("del");
			delServByOffer(prodId,offer);
		}
	};
	
	//获取销售品实例构成new
	var _getOffer = function(prodId,offerId){
		var offerList = _getOfferList(prodId);
		if(ec.util.isArray(offerList)){
			for ( var i = 0; i < offerList.length; i++) {
				if(offerList[i].offerId==offerId){
					return offerList[i];
				}
			}
		}
	};
	
	//通过产品id获取产品已开通附属实例列表new
	var _getOfferList = function (prodId){
		for ( var i = 0; i < AttachOffer.openedList.length; i++) {
			var opened = AttachOffer.openedList[i];
			if(opened.prodId == prodId){
				return opened.offerList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//关闭已开通功能产品(new)
	var _closeServSub = function(prodId,servId){
		var serv = CacheData.getServ(prodId,servId);
		var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
		if($span.attr("class")=="del"){  //已经关闭，取消关闭
			_openServ(prodId,serv);
		}else if("13409244"==serv.servSpecId){//一卡双号虚号
			$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能");
		}else{ //关闭
			var uim = OrderInfo.getProdUim(prodId);
			if(serv.servSpecId=="280000020" && (OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23) && uim.cardTypeFlag=="1"){//补换卡补4G卡不能退订4G上网功能产品
				$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");
				return;
			}

			$span.addClass("del");
			serv.isdel = "Y";
		}
	};
	
	//二次加载附属业务数据信息 第一步
	var _addOfferSpecSub = function(prodId,offerSpecId,roles){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		
		_setServ2OfferSpecSub(prodId,newSpec);
		
		_checkOfferExcludeDependSub(prodId,newSpec);
			
	};
	
	//终端校验
	var _checkTerminalCodeSub = function(obj){
		var prodId=$(obj).attr("prodId");
		var offerSpecId=$(obj).attr("offerSpecId");
//		var terminalGroupId=$(obj).attr("terminalGroupId");
		var num=$(obj).attr("num");
		var flag=$(obj).attr("flag");
		if(flag==undefined){
			flag = 0 ;
		}
		
		//清空旧终端信息
		_filterAttach2Coupons(prodId,offerSpecId,num);
		
		var objInstId = prodId+"_"+offerSpecId;
		
		var resIdArray = [];
		var terminalGroupIdArray = [];
		$("#"+objInstId+"  option").each(function(){
			resIdArray.push($(this).val());
		});
		$("#group_"+objInstId+"  option").each(function(){
			terminalGroupIdArray.push($(this).val());
		});
		var resId = resIdArray.join("|"); //拼接可用的资源规格id
		var terminalGroupId = terminalGroupIdArray.join("|"); //拼接可用的资源终端组id
		if((resId==undefined || $.trim(resId)=="") && (terminalGroupId==undefined || $.trim(terminalGroupId)=="")){
			$.alert("信息提示","终端规格不能为空！");
			return;
		}
		var instCode = $("#terminalText_"+objInstId + "_"+num).val();
		if(instCode==undefined || $.trim(instCode)==""){
			$.alert("信息提示","终端串码不能为空！");
			return;
		}
		if(_checkData(objInstId,instCode)){
			return;
		}
		var param = {
			instCode : instCode,
			flag : flag,
			mktResId : resId,
			termGroup : terminalGroupId
		};
		var data = query.prod.checkTerminal(param);
		if(data==undefined){
			return;
		}
		var activtyType ="";
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C" && ec.util.isArray(spec.agreementInfos)){  //订购的附属销售品
                    if(spec.agreementInfos[0].activtyType == 2){
                    	activtyType = "2";
				    }
				}
			}
		}
		if(data.statusCd==CONST.MKTRES_STATUS.USABLE || (data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2")){
			
			var mktPrice=0;//营销资源返回的单位是元
			var mktColor="";
			if(ec.util.isArray(data.mktAttrList)){
				$.each(data.mktAttrList,function(){
					if(this.attrId=="65010058"){
						mktPrice=this.attrValue;
					}else if(this.attrId=="60010004"){
						mktColor=this.attrValue;
					}
				});
			}
			$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");
			$("#terminalDesc_"+num).css("display","block");
			
			/*$("#terRes_"+objInstId).show();
			$("#terName_"+objInstId).text(data.mktResName);
			$("#terCode_"+objInstId).text(data.instCode);	
			if(price!=undefined){
				$("#terPrice_"+objInstId).text(price/100 + "元");
			}*/
			var coupon = {
				couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : data.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
				couponNum : 1, //物品数量
				storeId : data.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : mktPrice, //物品价格,约定取值为营销资源的
				couponInstanceNumber : data.instCode, //物品实例编码
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId : prodId, //产品ID
				offerId : -1, //销售品实例ID
				attachSepcId : offerSpecId,
				state : "ADD", //动作
				relaSeq : "", //关联序列	
				num	: num //第几个串码输入框
			};
			if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2"){//“已销售未补贴”的终端串码可以办理话补合约
				coupon.couponSource ="2"; //串码话补标识
			}
			if(CONST.getAppDesc()==0){
				coupon.termTypeFlag=data.termTypeFlag;
			}
			OrderInfo.attach2Coupons.push(coupon);
		}else if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){
			$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用");
		}else{
			$.alert("提示",data.message);
		}
	};
	
	//把选中的服务保存到销售品规格中 第二步
	var _setServ2OfferSpecSub = function(prodId,offerSpec,roles){
		if(offerSpec!=undefined){
			$.each(offerSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					var nowProd=prodId+"_"+this.objId;
					
					$(roles).each(function(i,role) { 
						var oldProd=role.prodId+"_"+role.objId;
							
						if(nowProd==oldProd){
							this.selQty = 1;
							return false;
						}else{
							this.selQty = 2;
						}
					});
				});
			});
		}
	};
	
	//校验销售品的互斥依赖 第三步
	var _checkOfferExcludeDependSub = function(prodId,offerSpec){
		var offerSpecId = offerSpec.offerSpecId;
		var param = CacheData.getExcDepOfferParam(prodId,offerSpecId);
		var data = query.offer.queryExcludeDepend(param);//查询规则校验
		if(data!=undefined){
			paserOfferDataSub(data.result,prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
		}
	};
	
	//解析互斥依赖返回结果
	var paserOfferDataSub = function(result,prodId,offerSpecId,specName){
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
				excludeOffer : [],   //互斥依赖显示列表
				defaultOffer : [], //默选的显示列表
				dependOffer : {  //存放互斥依赖列表
					dependOffers : [],
					offerGrpInfos : []
				}
		};
		if(result!=""){
			var exclude = result.offerSpec.exclude;
			var depend = result.offerSpec.depend;
			var defaultOffer=result.offerSpec.defaultList;
			//解析可选包互斥依赖组
			if(ec.util.isArray(exclude)){
				for (var i = 0; i < exclude.length; i++) {
					var offerList = CacheData.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
						param.excludeOffer.push(exclude[i].offerSpecId);
					}
				}
			}
			if(depend!=undefined && ec.util.isArray(depend.offerInfos)){
				for (var i = 0; i < depend.offerInfos.length; i++) {	
					content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
				}	
			}
			if(depend!=undefined && ec.util.isArray(depend.offerGrpInfos)){
				for (var i = 0; i < depend.offerGrpInfos.length; i++) {
					var offerGrpInfo = depend.offerGrpInfos[i];
					param.dependOffer.offerGrpInfos.push(offerGrpInfo);
					content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
					if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
						for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
							var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
							var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);
							if(ec.util.isObj(offerSpec)){
								if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
									content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}else{
								var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);
								if(ec.util.isObj(offerSpec)){
									if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
										content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}else{
										content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}
						}
					}
				}
			}
			//解析可选包默选组
			if(ec.util.isArray(defaultOffer)){
				for (var i = 0; i < defaultOffer.length; i++) {	
					content += "需要开通： " + defaultOffer[i].offerSpecName + "<br>";
					param.defaultOffer.push(defaultOffer[i].offerSpecId);
				}	
			}
		}
		var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);//查询销售品构成成员的依赖互斥以及连带
		content=content+serContent;
		
		AttachOffer.addOpenList(prodId,offerSpecId); 
//		if(content==""){ //没有互斥依赖
//			AttachOffer.addOpenList(prodId,offerSpecId); 
//		}else{	
//			content = "<div style='max-height:300px;overflow:auto;'>" + content + "</div>";
//			
//			$("#packageHiddenDiv").html(content);
//			
//			_setOffer2ExcludeOfferSpecSub(param);
//			excludeAddattch(prodId,offerSpecId,param);
//			excludeAddServ(prodId,"",paramObj);
//		}
	};
	
	//把选中的销售品保存到依赖或互斥的销售品规格中
	var _setOffer2ExcludeOfferSpecSub = function(param){
		if(param.dependOffer.offerGrpInfos.length>0){  // 依赖组
			var dependOffer=param.dependOffer;
			for (var i = 0; i < dependOffer.offerGrpInfos.length; i++) {
				var offerGrpInfo = dependOffer.offerGrpInfos[i];
				var $offerSpecs = $("input[name="+offerGrpInfo.grpId+"]:checked");
				var len  = $offerSpecs.length;
				dependOffer.offerGrpInfos[i].checkLen=len;
				for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){
					var subOfferSpecInfo=offerGrpInfo.subOfferSpecInfos[j];
					$offerSpecs.each(function(){
						if($(this).val()==subOfferSpecInfo.offerSpecId){
							subOfferSpecInfo.isCheck=true;
						}
					});
				}
			}
		}
	};
	
	//点击确认，添加附属销售品发展人
	var _addAttachDealerSub = function(id,accessNumbe,objName,roleCode){
		var prodId = id.split("_")[0];
		if($("#tr_"+id)[0]==undefined){ //没有添加过
			var objId = id+"_"+OrderInfo.SEQ.dealerSeq;
			var $tdType = _getDealerTypeSub(id,objId);
			if($tdType==undefined){
				return false;
			}
			var $tr = $("#atr_"+id);
			var $newTr = $('<tr name="tr_'+id+'"></tr>');
			$newTr.append("<td>"+accessNumbe+"</td>");
			$newTr.append("<td>"+objName+"</td>");
			$newTr.append($tdType);
			
			var dealer = $("#tr_"+prodId).find("input"); //产品协销人
			var staffId = 1;
			var staffName = "";
			if(dealer[0]==undefined){
				staffId = OrderInfo.staff.staffId;
				staffName = OrderInfo.staff.staffName;
			}else {
				staffId = dealer.attr("staffId");
				staffName = dealer.attr("value");
			}
			if(order.ysl!=undefined){
				var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" style="margin-left:45px;"></input></td>');
			}else{
				var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>');
			}
			$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');	
			$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
			$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+id+'\')">添加</a><label class="f_red">*</label>');
			$newTr.append($td);
			if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){
				OrderInfo.getChannelList();
			}
			var $tdChannel = $('<td></td>');
			var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
			$.each(OrderInfo.channelList,function(){
				if(dealerlist[d].channelNbr==this.channelNbr)
					$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
				else
					$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
			});
			$tdChannel.append($channelSelect);
			$tdChannel.append('<label class="f_red">*</label>');	
			$tr.append($tdChannel);
			$("#dealerTbody").append($newTr);
			
			if(roleCode!=null && roleCode !=""){
				$("#dealerType_"+id+"_"+OrderInfo.SEQ.dealerSeq).val(roleCode);
			}
			OrderInfo.SEQ.dealerSeq++;
		}
	};
	
	//校验发展人类型,并获取发展人类型列表
	var _getDealerTypeSub = function(objInstId,objId){
		var dealerType = "";
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":40020005,"NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":40020006,"NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":40020007,"NAME":"第三发展人"}];
		}
		if(OrderInfo.order.dealerTypeList!=undefined && OrderInfo.order.dealerTypeList.length>0){ //发展人类型列表
			$.each(OrderInfo.order.dealerTypeList,function(){
				var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
				var flag = true;
				$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
					if(dealerTypeId==$(this).val()){  //如果已经存在
						flag = false;
						return false;
					}
				});
				if(flag){ //如果发展人类型没有重复
					dealerType = dealerTypeId;
					return false;
				}
			});
		}else{
			$.alert("信息提示","没有发展人类型");
			return;
		}
		if(dealerType==undefined || dealerType==""){	
			$.alert("信息提示","每个业务发展人类型不能重复");
			return;
		}
		var $td = $('<td></td>'); //发展人类型
		var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		$.each(OrderInfo.order.dealerTypeList,function(){
			if(this.PARTYPRODUCTRELAROLECD==dealerType){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>");
			}else{
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			}
		});
		$td.append($select);
		$td.append('<label class="f_red">*</label>');
		return $td;
	};
	
	
	//开通功能产品new
	var _openServSpecSub = function(prodId,servSpecId,specName,ifParams){
		var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
		if(servSpec==undefined){   //在可订购功能产品里面 
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : specName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			if(servSpecId==CONST.YZFservSpecId){//翼支付助手根据付费类型改变默认值
				var feeType = $("select[name='pay_type_-1']").val();
				if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
				if(feeType == CONST.PAY_TYPE.AFTER_PAY){
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {
						var prodSpecParam = newSpec.prodSpecParams[j];
						prodSpecParam.setValue = "";
					}																			
				}else{
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {							
						var prodSpecParam = newSpec.prodSpecParams[j];
						if (prodSpecParam.value!="") {
							prodSpecParam.setValue = prodSpecParam.value;
						} else if (!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!="")
							//默认值为空则取第一个
							prodSpecParam.setValue = prodSpecParam.valueRange[0].value;
				}
			  }
			}
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			servSpec = newSpec;
		}
		
		_checkServExcludeDependSub(prodId,servSpec);
	};
	
	//校验服务的互斥依赖
	var _checkServExcludeDependSub = function(prodId,serv,flag){
		var servSpecId = serv.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		if(param.orderedServSpecIds.length == 0){
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserServDataSub(data.result,prodId,serv);//解析数据
			}
		}
	};
	
	//解析服务互斥依赖
	var paserServDataSub = function(result,prodId,serv){
		var servSpecId = serv.servSpecId;
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
		};
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + this.servSpecName + "<br>";
					param.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.dependServ.push(this);
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.relatedServ.push(this);
			});
		}
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{	
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
			excludeAddServ(prodId,servSpecId,param);
		}
	};
	
	//可订购的附属查询 
	var _queryAttachOfferSpec = function(param) {
		query.offer.queryAttachSpec(param,function(data){
			if (data) {
				$("#attach_"+param.prodId).html(data);
				_showMainRoleProd(param.prodId); //通过主套餐成员显示角字
				uiAttachOffer.changeLabel(param.prodId,param.prodSpecId,""); //初始化第一个标签附属
				if(param.prodId==-1 && OrderInfo.actionFlag==14){ //合约计划特殊处理
					uiAttachOffer.addOpenList(param.prodId,mktRes.terminal.offerSpecId);
				}
			}
		});
	};
	
	//显示增值业务内容
	var _showApp = function(prodId){
		var appList = CacheData.getOpenAppList(prodId);
		var content = CacheData.getAppContent(prodId,appList);
		$.confirm("增值业务设置： ",content[0].innerHTML,{ 
			yes:function(){	
				$.each(appList,function(){
					if($("#"+prodId+"_"+this.objId).attr("checked")=="checked"){
						this.dfQty = 1;
					}else{
						this.dfQty = 0;
					}
				});
			},
			no:function(){
			}
		});
	};
	
	//获取产品实例
	var getProdInst = function(prodId){
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(ec.util.isArray(offerRole.prodInsts)){
				for ( var j = 0; j < offerRole.prodInsts.length; j++) {  //遍历产品实例列表
					if(offerRole.prodInsts[j].prodInstId==prodId){
						return offerRole.prodInsts[j];
					}
				}
			}
		}
	};
	
	//主销售品角色分解个每个接入产品
	var _showMainRoleProd = function(prodId){
		var prodInst = getProdInst(prodId);
		var app = {
			prodId:prodId,
			appList:[]
		};
		uiAttachOffer.openAppList.push(app);
		for (var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){ //增值业务角色
				for ( var j = 0; j < offerRole.roleObjs.length; j++) {
					var roleObj = offerRole.roleObjs[j];
					if(roleObj.objType== CONST.OBJ_TYPE.SERV){
						if(prodInst.objId==roleObj.parentProdId && prodInst.componentTypeCd.substring(0,1)==roleObj.componentTypeCd.substring(0,1)){	
							app.appList.push(roleObj);
							if(roleObj.servSpecId==undefined){
								roleObj.servSpecId = roleObj.objId;
							}
							if(roleObj.servSpecName==undefined){
								roleObj.servSpecName = roleObj.objName;
							}
						}
					}
				}
				if(app.appList.length>0){
					var $li = $('<li id="li_'+prodId+'_'+offerRole.offerRoleId+'"></li>');
					$li.append('<dd class="mustchoose" ></dd>');	
					$li.append('<span>'+offerRole.offerRoleName+'</span>');
					$li.append('<dd id="can_'+prodId+'_'+offerRole.offerRoleId+'" class="gou2" onclick="AttachOffer.showApp('+prodId+');"></dd>');
					$("#open_app_ul_"+prodId).append($li);
				}
			}else{ 
				if(offerRole.prodInsts==undefined){
					continue;
				}
				$.each(offerRole.prodInsts,function(){  //遍历产品实例列表
					if(this.prodInstId==prodId){
						for (var k = 0; k < offerRole.roleObjs.length; k++) {
							var roleObj = offerRole.roleObjs[k];
							if(roleObj.objType==CONST.OBJ_TYPE.SERV){
								var servSpecId = roleObj.objId;
								var $oldLi = $('#li_'+prodId+'_'+servSpecId);
								var spec = CacheData.getServSpec(prodId,servSpecId);//从已选择功能产品中找
								if(spec != undefined){
									if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14){
										if(roleObj.dfQty == 0 && spec.ifDault==1){//在基础功能中没有选中的默认删除状态 
											var $span=$oldLi.find("span");
											$span.addClass("del");
											spec.isdel = "Y";
										}
									}
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								var serv = CacheData.getServBySpecId(prodId,servSpecId);//从已订购功能产品中找
								if(serv!=undefined){ //不在已经开跟已经选里面
									var $oldLi = $('#li_'+prodId+'_'+serv.servId);
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								if(roleObj.dfQty > 0){ //必选，或者默选
									var servSpec=jQuery.extend(true, {}, roleObj);
									CacheData.setServSpec(prodId,servSpec); //添加到已开通列表里
									spec = servSpec;
									if(ec.util.isArray(spec.prodSpecParams)){
										spec.ifParams = "Y";
									}
									$('#li_'+prodId+'_'+servSpecId).remove(); //删除可开通功能产品里面
									var $li = $('<li id="li_'+prodId+'_'+servSpecId+'"></li>');
									if(roleObj.minQty==0){
										$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+','+servSpecId+',\''+spec.servSpecName+'\',\''+spec.ifParams+'\')"></dd>');
									}else{
										$li.append('<dd class="mustchoose"></dd>');
									}
									$li.append('<span>'+spec.servSpecName+'</span>');
									if (spec.ifParams=="Y"){
										if(CacheData.setServParam(prodId,spec)){ 
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}else {
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}
									}
									$li.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									$("#open_serv_ul_"+prodId).append($li);
									spec.isdel = "N";
									_showHideUim(0,prodId,servSpecId);//显示或者隐藏补换卡
								}
							}
						}
					}
				});
			}
		}
	};
	
	var _showMainMemberRoleProd=function(prodId){
		for (var i = 0; i < OrderInfo.viceOfferSpec.length; i++) {//多张副卡同时进行套餐变更
			var offerSpec=OrderInfo.viceOfferSpec[i];
			if(prodId==offerSpec.prodId){
				for (var j = 0; j < offerSpec.offerRoles.length; j++) {
					var offerRole = offerSpec.offerRoles[j];
					if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){//主卡
						for (var k = 0; k < offerRole.roleObjs.length; k++) {
							var roleObj = offerRole.roleObjs[k];
							if(roleObj.objType==CONST.OBJ_TYPE.SERV){
								var servSpecId = roleObj.objId;
								var $oldLi = $('#li_'+prodId+'_'+servSpecId);
								var spec = CacheData.getServSpec(prodId,servSpecId);//从已选择功能产品中找
								if(spec != undefined){
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								var serv = CacheData.getServBySpecId(prodId,servSpecId);//从已订购功能产品中找
								if(serv!=undefined){ //不在已经开跟已经选里面
									var $oldLi = $('#li_'+prodId+'_'+serv.servId);
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								if(roleObj.dfQty > 0){ //必选，或者默选
									var servSpec=jQuery.extend(true, {}, roleObj);
									CacheData.setServSpec(prodId,servSpec); //添加到已开通列表里
									spec = servSpec;
									if(ec.util.isArray(spec.prodSpecParams)){
										spec.ifParams = "Y";
									}
									$('#li_'+prodId+'_'+servSpecId).remove(); //删除可开通功能产品里面
									var $li = $('<li id="li_'+prodId+'_'+servSpecId+'"></li>');
									if(roleObj.minQty==0){
										$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+','+servSpecId+',\''+spec.servSpecName+'\',\''+spec.ifParams+'\')"></dd>');
									}else{
										$li.append('<dd class="mustchoose"></dd>');
									}
									$li.append('<span>'+spec.servSpecName+'</span>');
									if (spec.ifParams=="Y"){
										if(CacheData.setServParam(prodId,spec)){ 
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}else {
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}
									}
									$li.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									$("#open_serv_ul_"+prodId).append($li);
									spec.isdel = "N";
									_showHideUim(0,prodId,servSpecId);//显示或者隐藏补换卡
								}
							}
						}
					}
				}
			}
		}
	};
	
	//查询附属销售品规格
	var _searchAttachOfferSpec = function(prodId,offerSpecId,prodSpecId) {
		var param = {   
			prodId : prodId,
		    prodSpecId : prodSpecId,
		    offerSpecIds : [offerSpecId],
		    ifCommonUse : "" 
		};
//		if(OrderInfo.actionFlag == 2){ //套餐变更		
//			param.offerSpecIds=[OrderInfo.offerSpec.offerSpecId];
//		}
		if(OrderInfo.actionFlag == 2){ //套餐变更		
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(ec.util.isArray(this.prodInsts)){
					$.each(this.prodInsts,function(){
						if(this.prodInstId==prodId){
							param.acctNbr = this.accessNumber;
							param.offerRoleId = this.offerRoleId;
							param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);	
							return false;
						}
					});
				}
			});
		}else if(OrderInfo.actionFlag == 3){  //可选包
			var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
			param.acctNbr = prodInfo.accNbr;
			if(!ec.util.isObj(prodInfo.prodOfferId)){
				prodInfo.prodOfferId = "";
			}
			var offerRoleId = CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;
			if(offerRoleId==undefined){
				offerRoleId = "";
			}
			param.offerRoleId = offerRoleId;
			param.offerSpecIds.push(prodInfo.prodOfferId);
		}else if(OrderInfo.actionFlag == 21){ //副卡套餐变更		
			$.each(OrderInfo.viceOfferSpec,function(){
				var offerSpecId=this.offerSpecId;
				var accessNumber=this.accessnumber;
				if(this.prodId==prodId){
					$.each(this.offerRoles,function(){
						if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD || this.memberRoleCd=="1"){
							$.each(this.roleObjs,function(){
								if(this.objType==CONST.OBJ_TYPE.PROD){
									param.acctNbr = accessNumber;
									param.offerRoleId = this.offerRoleId;
									param.offerSpecIds.push(offerSpecId);	
									return false;
								}
							});
						}
					});
				}
			});
		}else if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
			for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
				if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
					param.acctNbr = OrderInfo.oldprodInstInfos[i].accNbr;
					$.each(OrderInfo.oldofferSpec,function(){
						if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){
							param.offerSpecIds.push(this.offerSpec.offerSpecId);	
							$.each(this.offerSpec.offerRoles,function(){
								if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD || this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){
									param.offerRoleId = this.offerRoleId;
								}
							});
						}
					});
				}
			}
		}else { //新装
			param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);
			var prodInst = OrderInfo.getProdInst(prodId);
			if(prodInst){
				param.offerRoleId = prodInst.offerRoleId;
			}
		}
		var offerSepcName = $("#search_text_"+prodId).val();
		if(offerSepcName.replace(/\ /g,"")==""){
			$.alert("提示","请输入查询条件！");
			return;
		}
		param.offerSpecName = offerSepcName;
		var data = query.offer.searchAttachOfferSpec(param);
		if(data!=undefined){
			$("#attach_div_"+prodId).html(data).show();
		}
	};
	
	//点击搜索出来的附属销售品
	var _selectAttachOffer = function(prodId,offerSpecId){
		$("#attach_div_"+prodId).hide();
		_addAttOffer(prodId,offerSpecId);
	};
	
	//点击搜索出来的功能产品
	var _selectServ = function(prodId,servSpecId,specName,ifParams){
		$("#attach_div_"+prodId).hide();
		_openServSpec(prodId,servSpecId,specName,ifParams);
	};
	
	//点击搜索出来的附属销售品
	var _closeAttachSearch = function(prodId){
		$("#attach_div_"+prodId).hide();
	};
	
	//删除附属销售品规格
	var _delOfferSpec = function(prodId,offerSpecId){
		var $span = $("#li_"+prodId+"_"+offerSpecId).find("span"); //定位删除的附属
		if($span.attr("class")=="del"){  //已经取消订购，再订购
			AttachOffer.addOfferSpec(prodId,offerSpecId);
		}else { //取消订购
			var spec = CacheData.getOfferSpec(prodId,offerSpecId);
			var content = CacheData.getOfferProdStr(prodId,spec,2);
			$.confirm("信息确认",content,{ 
				yes:function(){
					$span.addClass("del");
					spec.isdel = "Y";
					delServSpec(prodId,spec); //取消订购销售品时
					order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
					$("#terminalUl_"+prodId+"_"+offerSpecId).remove();
					spec.isTerminal = 0;
				},
				no:function(){
					
				}
			});
		}
	};
	
	//删除附属销售品实例
	var _delOffer = function(prodId,offerId){
		var $span = $("#li_"+prodId+"_"+offerId).find("span"); //定位删除的附属
		if($span.attr("class")=="del"){  //已经退订，再订购
			AttachOffer.addOffer(prodId,offerId,$span.text());
		}else { //退订
			var offer = CacheData.getOffer(prodId,offerId);
			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offerId	
				};
				if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
						if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
							param.areaId = OrderInfo.oldprodInstInfos[i].areaId;
							param.acctNbr = OrderInfo.oldprodInstInfos[i].accNbr;
						}
					}
				}else{
					param.acctNbr = OrderInfo.getAccessNumber(prodId);
				}
				var data = uiOfferQuery.queryOfferInst(param);
				if(data==undefined){
					return;
				}
				//遍历附属的构成要和主套餐的构成实例要一致（兼容融合套餐）
				var offerMemberInfos=[];
				$.each(data.offerMemberInfos,function(){
					var prodInstId=this.objInstId;
					var flag=false;
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objInstId==prodInstId){
							flag=true;
							return false;
						}
					});
					if(flag){
						offerMemberInfos.push(this);
					}
				});
				
				offer.offerMemberInfos = data.offerMemberInfos=offerMemberInfos;
				offer.offerSpec = data.offerSpec;
			}
			var content = "";
			if(offer.offerSpec!=undefined){
				content = CacheData.getOfferProdStr(prodId,offer,1);
			}else {
				content = '退订【'+$span.text()+'】可选包' ;
			}
			$.confirm("信息确认",content,{ 
				yes:function(){
					offer.isdel = "Y";
					$span.addClass("del");
					delServByOffer(prodId,offer);
				},
				no:function(){	
				}
			});
		}
	};
	
	//关闭服务规格
	var _closeServSpec = function(prodId,servSpecId,specName,ifParams){
		var $span = $("#li_"+prodId+"_"+servSpecId).find("span"); //定位删除的附属
		if($span.attr("class")=="del"){  //已经退订，再订购
			AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams);
		}else { //退订
			$.confirm("信息确认","取消开通【"+$span.text()+"】功能产品",{ 
				yesdo:function(){
					var spec = CacheData.getServSpec(prodId,servSpecId);
					if(spec == undefined){ //没有在已开通附属销售列表中
						return;
					}
					$span.addClass("del");
					spec.isdel = "Y";
					_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					
					var serv = CacheData.getServBySpecId(prodId,servSpecId);
					if(ec.util.isObj(serv)){ //没有在已开通附属销售列表中
						$span.addClass("del");
						serv.isdel = "Y";
						//_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					}
				},
				no:function(){
				}
			});
		}
	};
	
	//关闭服务实例
	var _closeServ = function(prodId,servId){
		var serv = CacheData.getServ(prodId,servId);
		var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
		if($span.attr("class")=="del"){  //已经关闭，取消关闭
			_openServ(prodId,serv);
		}else if("13409244"==serv.servSpecId){//一卡双号虚号
			$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能");
		}else{ //关闭
			var uim = OrderInfo.getProdUim(prodId);
			if(serv.servSpecId=="280000020" && (OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23) && uim.cardTypeFlag=="1"){//补换卡补4G卡不能退订4G上网功能产品
				$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");
				return;
			}
			$.confirm("信息确认","关闭【"+$span.text()+"】功能产品",{ 
				yesdo:function(){
					$span.addClass("del");
					serv.isdel = "Y";
				},
				no:function(){						
				}
			});
		}
	};
	
	//开通功能产品
	var _openServSpec = function(prodId,servSpecId,specName,ifParams){
		$.confirm("信息确认","开通【"+specName+"】功能产品",{ 
			yesdo:function(){
				var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
				if(servSpec==undefined){   //在可订购功能产品里面 
					var newSpec = {
						objId : servSpecId, //调用公用方法使用
						servSpecId : servSpecId,
						servSpecName : specName,
						ifParams : ifParams,
						isdel : "C"   //加入到缓存列表没有做页面操作为C
					};
					var inPamam = {
						prodSpecId:servSpecId
					};
					if(ifParams == "Y"){
						var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
						if(data==undefined || data.result==undefined){
							return;
						}
						newSpec.prodSpecParams = data.result.prodSpecParams;
					if(servSpecId==CONST.YZFservSpecId){//翼支付助手根据付费类型改变默认值
						var feeType = $("select[name='pay_type_-1']").val();
						if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
						if(feeType == CONST.PAY_TYPE.AFTER_PAY){
							for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {
								var prodSpecParam = newSpec.prodSpecParams[j];
								prodSpecParam.setValue = "";
							}																			
						}else{
							for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {							
								var prodSpecParam = newSpec.prodSpecParams[j];
								if (prodSpecParam.value!="") {
									prodSpecParam.setValue = prodSpecParam.value;
								} else if (!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!="")
									//默认值为空则取第一个
									prodSpecParam.setValue = prodSpecParam.valueRange[0].value;
						}
					  }
					}
					}
					CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
					servSpec = newSpec;
				}
				_checkServExcludeDepend(prodId,servSpec);
			},
			no:function(){
			}
		});
	};
	
	//开通功能产品
	var _openServ = function(prodId,serv){
		$.confirm("信息确认","取消关闭【"+serv.servSpecName+"】功能产品",{ 
			yesdo:function(){
				if(serv!=undefined){   //在可订购功能产品里面 
					if(serv.servSpecId==""){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.removeClass("del");
						serv.isdel = "N";
					}else{
						_checkServExcludeDepend(prodId,serv);
					}
				}
			},
			no:function(){
			}
		});
	};
	
	//校验销售品的互斥依赖
	var _checkOfferExcludeDepend = function(prodId,offerSpec){
		var offerSpecId = offerSpec.offerSpecId;
		var param = CacheData.getExcDepOfferParam(prodId,offerSpecId);
//		if(param.orderedOfferSpecIds.length == 0 ){
////			AttachOffer.addOpenList(prodId,offerSpecId); 
//			paserOfferData("",prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
//		}else{
		var data = query.offer.queryExcludeDepend(param);//查询规则校验
		if(data!=undefined){
			paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
		}
//		}
		
		//获取销售品节点校验销售品下功能产品的互斥依赖
		/*var offerSpec = CacheData.getOfferSpec(offerSpecId);
		if(offerSpec!=undefined){
			$.each(offerSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					var param = {
						prodId : prodId,
						servSpecId : this.objId,
						orderedServSpecIds : [] //功能产品互斥依赖查询入场数组
					};
					//已选销售品列表
					var offerSpecList = CacheData.getSpecList(prodId);
					if(ec.util.isArray(offerSpecList)){
						$.each(offerSpecList,function(){
							if(this.offerSpecId!=offerSpecId && this.isdel!="Y" && this.isdel!="C"){
								param.orderedOfferSpecIds.push(this.offerSpecId);
							}
						});
					}
					if(param.orderedServSpecIds.length == 0 ){
						AttachOffer.addOpenList(prodId,offerSpecId); 
					}else{
						datas.push(query.offer.queryServExcludeDepend(param));//查询规则校验
					}
				});
			});
		}*/
		//paserData(datas,prodId,offerSpecId,offer.offerSpecName,"OFFER"); //解析数据
		
		/*if(param.orderedOfferSpecIds.length == 0 ){
			AttachOffer.addOpenList(prodId,offerSpecId); 
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserData(data.result,prodId,offerSpecId,offer.offerSpecName,"OFFER"); //解析数据
			}
		}*/
	};
	
	//校验服务的互斥依赖
	var _checkServExcludeDepend = function(prodId,serv,flag){
		var servSpecId = serv.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		if(param.orderedServSpecIds.length == 0){
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserServData(data.result,prodId,serv);//解析数据
			}
		}
	};
	
	//订购附属销售品
	var _addOfferSpec = function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		$.confirm("信息确认",content,{ 
			yes:function(){
				CacheData.setServ2OfferSpec(prodId,newSpec);
			},
			yesdo:function(){
				_checkOfferExcludeDepend(prodId,newSpec);
			},
			no:function(){
			}
		});
	};
	
	//根据预校验返回订购附属销售品
	var _addOfferSpecByCheck = function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		$.confirm("信息确认",content,{ 
			yes:function(){
				CacheData.setServ2OfferSpec(prodId,newSpec);
			},
			yesdo:function(){
				_checkOfferExcludeDepend(prodId,newSpec);
			}
		});
	};
	
	//删除附属销售品带出删除功能产品
	var delServSpec = function(prodId,offerSpec){
		$.each(offerSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				var servSpecId = this.objId;
				if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){
					var spec = CacheData.getServSpec(prodId,servSpecId);
					if(ec.util.isObj(spec)){
						spec.isdel = "Y";
						var $li = $("#li_"+prodId+"_"+servSpecId);
						$li.removeClass("canshu").addClass("canshu2");
						$li.find("span").addClass("del"); //定位删除的附属
						_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					}
				}
			});
		});
	};
	
	//删除附属销售品带出删除功能产品
	var delServByOffer = function(prodId,offer){	
		$.each(offer.offerMemberInfos,function(){
			var servId = this.objInstId;
			if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){
				var serv = CacheData.getServ(prodId,servId);
				if(ec.util.isObj(serv)){
					serv.isdel = "Y";
					var $li = $("#li_"+prodId+"_"+servId);
					$li.removeClass("canshu").addClass("canshu2");
					$li.find("span").addClass("del"); //定位删除的附属
				}
			}
		});
	};
	
	//取消退订附属销售品
	var _addOffer = function(prodId,offerId){
		var specName = $("#li_"+prodId+"_"+offerId).find("span").text();
		$.confirm("信息确认","取消退订【"+specName+"】可选包",{ 
			yesdo:function(){
				var offer = CacheData.getOffer(prodId,offerId); //在已经开通列表中查找
				if(offer!=undefined){   //在可订购功能产品里面 
					if(offer.offerSpecId==""){
						var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
						$span.removeClass("del");
						offer.isdel = "N";
					}else{
						_checkOfferExcludeDepend(prodId,offer);
					}
				}
			},
			no:function(){
			}
		});
	};
	
	//确认订购附属销售品
	var _addAttOffer = function(prodId,offerSpecId,specName){
		_addOfferSpec(prodId,offerSpecId);
	};
	
	//解析互斥依赖返回结果
	var paserOfferData = function(result,prodId,offerSpecId,specName){
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
				excludeOffer : [],   //互斥依赖显示列表
				defaultOffer : [], //默选的显示列表
				dependOffer : {  //存放互斥依赖列表
					dependOffers : [],
					offerGrpInfos : []
				}
		};
		if(result!=""){
			var exclude = result.offerSpec.exclude;
			var depend = result.offerSpec.depend;
			var defaultOffer=result.offerSpec.defaultList;
			//解析可选包互斥依赖组
			if(ec.util.isArray(exclude)){
				for (var i = 0; i < exclude.length; i++) {
					var offerList = CacheData.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
						param.excludeOffer.push(exclude[i].offerSpecId);
					}
				}
			}
			if(depend!=undefined && ec.util.isArray(depend.offerInfos)){
				for (var i = 0; i < depend.offerInfos.length; i++) {	
					content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
				}	
			}
			if(depend!=undefined && ec.util.isArray(depend.offerGrpInfos)){
				for (var i = 0; i < depend.offerGrpInfos.length; i++) {
					var offerGrpInfo = depend.offerGrpInfos[i];
					param.dependOffer.offerGrpInfos.push(offerGrpInfo);
					content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
					if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
						for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
							var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
							var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);
							if(ec.util.isObj(offerSpec)){
								if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
									content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}else{
								var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);
								if(ec.util.isObj(offerSpec)){
									if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
										content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}else{
										content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}
						}
					}
				}
			}
			//解析可选包默选组
			if(ec.util.isArray(defaultOffer)){
				for (var i = 0; i < defaultOffer.length; i++) {	
					content += "需要开通： " + defaultOffer[i].offerSpecName + "<br>";
					param.defaultOffer.push(defaultOffer[i].offerSpecId);
				}	
			}
		}
		var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);//查询销售品构成成员的依赖互斥以及连带
		content=content+serContent;
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenList(prodId,offerSpecId); 
		}else{	
			content = "<div style='max-height:300px;overflow:auto;'>" + content + "</div>";
			$.confirm("订购： " + specName,content,{ 
				yes:function(){
					CacheData.setOffer2ExcludeOfferSpec(param);
				},
				yesdo:function(){
					excludeAddattch(prodId,offerSpecId,param);
					excludeAddServ(prodId,"",paramObj);
				},
				no:function(){
					
				}
			});
		}
	};
	
	/*//解析互斥依赖返回结果
	var paserData = function(datas,prodId,offerSpecId,specName,objType){
		var exclude = result.offerSpec.exclude;
		var depend = result.offerSpec.depend;
		var servExclude = result.servSpec.exclude;
		var servDepend = result.servSpec.depend;

		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeOffer : [],   //互斥依赖显示列表
			dependOffer : {  //存放互斥依赖列表
				dependOffers : [],
				offerGrpInfos : []
			},
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [] //存放互斥依赖列表
		};
		
		//解析可选包互斥依赖组
		if(exclude!=undefined && exclude.length>0){
			for (var i = 0; i < exclude.length; i++) {
				var offerList = AttachOffer.getOfferList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(offerList!=undefined){
					for ( var j = 0; j < offerList.length; j++) {
						if(offerList[j].isdel=="Y"){
							if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
					param.excludeOffer.push(exclude[i].offerSpecId);
				}
			}
		}
		if(depend!=undefined && depend.offerInfos!=undefined && depend.offerInfos.length>0){
			for (var i = 0; i < depend.offerInfos.length; i++) {	
				content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
				param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
			}	
		}
		if(depend!=undefined && depend.offerGrpInfos!=undefined && depend.offerGrpInfos.length>0){
			for (var i = 0; i < depend.offerGrpInfos.length; i++) {
				var offerGrpInfo = depend.offerGrpInfos[i];
				param.dependOffer.offerGrpInfos.push(offerGrpInfo);
				content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
				if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
					for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
						var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
						content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
					}
				}
			}
		}
		
		//解析功能产品互斥依赖组
		if(servExclude!=undefined && servExclude.length>0){
			$.each(servExclude,function(){
				if(this.offerSpecId == undefined || this.offerSpecId == ""){ //纯功能产品互斥
					var servList = AttachOffer.getServList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(servList!=undefined){
						for ( var i = 0; i < servList.length; i++) {
							if(servList[i].isdel=="Y"){
								if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + this.servSpecName + "<br>";
						param.excludeServ.push(this);
					}
				}else {  //可选包下功能产品互斥
					var offerList = AttachOffer.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == this.offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + this.offerSpecName + "<br>";
						param.excludeOffer.push(this.offerSpecId);
					}
				}
			});
		}
		if(servDepend!=undefined && servDepend.length>0){
			$.each(servDepend,function(){
				if(this.offerSpecId == undefined || this.offerSpecId == ""){ //纯功能产品依赖
					content += "需要开通：   " + this.servSpecName + "<br>";
					param.dependServ.push(this);
				}else {  //功能产品与可选包下功能产品依赖
					content += "需要开通：   " + this.offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(this.offerSpecId);
				}
			});
		}
		
		if(content==""){ //没有互斥依赖
			if(objType == "OFFER"){
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}else {
				AttachOffer.addOpenServList(prodId,offerSpecId); 
			}
		}else{	
			$.confirm("开通： " + specName,content,{ 
				yesdo:function(){
					excludeAddattch(prodId,offerSpecId,param,objType);
				},
				no:function(){
					
				}
			});
		}
	};*/
	
	//解析服务互斥依赖
	var paserServData = function(result,prodId,serv){
		var servSpecId = serv.servSpecId;
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
		};
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + this.servSpecName + "<br>";
					param.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.dependServ.push(this);
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.relatedServ.push(this);
			});
		}
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{	
			$.confirm("开通： " + serv.servSpecName,content,{ 
				yesdo:function(){
					AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
					excludeAddServ(prodId,servSpecId,param);
				},
				no:function(){
				}
			});
		}
	};
	
	//服务互斥依赖时带出添加跟删除
	var excludeAddServ = function(prodId,servSpecId,param){
		if(ec.util.isArray(param.excludeServ)){ //有互斥
			for (var i = 0; i < param.excludeServ.length; i++) { //删除已开通
				var excludeServSpecId = param.excludeServ[i].servSpecId;
				var spec = CacheData.getServSpec(prodId,excludeServSpecId);
				if(spec!=undefined){
					var $span = $("#li_"+prodId+"_"+excludeServSpecId).find("span");
					$span.addClass("del");
					spec.isdel = "Y";
				}else{
					var serv = CacheData.getServBySpecId(prodId,excludeServSpecId);
					if(serv!=undefined){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.addClass("del");
						serv.isdel = "Y";
					}
				}
			}
		}
		if(ec.util.isArray(param.dependServ)){ // 依赖
			for (var i = 0; i < param.dependServ.length; i++) {
				var servSpec = param.dependServ[i];
				AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams); 
			}
		}
		if(ec.util.isArray(param.relatedServ)){ // 连带
			for (var i = 0; i < param.relatedServ.length; i++) {
				var servSpec = param.relatedServ[i];
				AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams); 
			}
		}
	};
	
	//互斥依赖时添加
	var excludeAddattch = function(prodId,specId,param){
		if(param.dependOffer.offerGrpInfos.length>0){  // 依赖组
			var dependOffer=param.dependOffer;
			for (var i = 0; i < dependOffer.offerGrpInfos.length; i++) {
				var offerGrpInfo = dependOffer.offerGrpInfos[i];
				var len  = offerGrpInfo.checkLen;
				if(len>=offerGrpInfo.minQty&&len<=offerGrpInfo.maxQty){
					$.each(offerGrpInfo.subOfferSpecInfos,function(){
						if(this.isCheck){
							AttachOffer.addOpenList(prodId,this.offerSpecId); 
						}
					});
				}else if(len<offerGrpInfo.minQty){
					$.alert("提示信息","依赖组至少选中"+offerGrpInfo.minQty+"个！");
					return;
				}else if(len>offerGrpInfo.maxQty){
					$.alert("提示信息","依赖组至多选中"+offerGrpInfo.maxQty+"个！");
					return;
				}else {
					$.alert("错误信息","依赖组选择出错！");
					return;
				}
			}
		}
		
		AttachOffer.addOpenList(prodId,specId); //添加开通附属
		if(param.excludeOffer.length>0){ //有互斥
			//删除已开通
			for (var i = 0; i < param.excludeOffer.length; i++) {
				var excludeSpecId = param.excludeOffer[i];
				var spec = CacheData.getOfferSpec(prodId,excludeSpecId);
				if(spec!=undefined){
					var $span = $("#li_"+prodId+"_"+excludeSpecId).find("span");
					$span.addClass("del");
					spec.isdel = "Y";
					$("#terminalUl_"+prodId+"_"+excludeSpecId).remove();
				}
				var offer = CacheData.getOfferBySpecId(prodId,excludeSpecId);
				if(offer!=undefined){
					var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
					$span.addClass("del");
					offer.isdel = "Y";
				}
			}
		}
		if(param.dependOffer.dependOffers.length>0){ // 依赖
			for (var i = 0; i < param.dependOffer.dependOffers.length; i++) {
				var offerSpecId = param.dependOffer.dependOffers[i];
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}
		}
		if(param.defaultOffer.length>0){ // 默选
			for (var i = 0; i < param.defaultOffer.length; i++) {
				var offerSpecId = param.defaultOffer[i];
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}
		}
		/*if(objType == "OFFER"){
			AttachOffer.addOpenList(prodId,specId); //添加开通附属
			if(param.excludeOffer.length>0){ //有互斥
				//删除已开通
				for (var i = 0; i < param.excludeOffer.length; i++) {
					var excludeSpecId = param.excludeOffer[i];
					var spec = AttachOffer.getSpec(prodId,excludeSpecId);
					if(spec!=undefined){
						var $span = $("#li_"+prodId+"_"+excludeSpecId).find("span");
						$span.addClass("del");
						spec.isdel = "Y";
					}
					var offer = AttachOffer.getOfferBySpecId(prodId,excludeSpecId);
					if(offer!=undefined){
						var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
						$span.addClass("del");
						offer.isdel = "Y";
					}
				}
			}
			if(param.dependOffer.dependOffers.length>0){ // 依赖
				for (var i = 0; i < param.dependOffer.dependOffers.length; i++) {
					var offerSpecId = param.dependOffer.dependOffers[i];
					AttachOffer.addOpenList(prodId,offerSpecId); 
				}
			}
		}else{
			AttachOffer.addOpenServList(prodId,specId); //添加开通功能
			if(param.excludeServ!=undefined && param.excludeServ.length>0){ //有互斥
				//删除已开通
				for (var i = 0; i < param.excludeServ.length; i++) {
					var excludeServSpecId = param.excludeServ[i].servSpecId;
					var spec = CacheData.getServSpec(prodId,excludeServSpecId);
					if(spec!=undefined){
						var $span = $("#li_"+prodId+"_"+excludeServSpecId).find("span");
						$span.addClass("del");
						spec.isdel = "Y";
					}
					var serv = AttachOffer.getServ(prodId,excludeServSpecId);
					if(serv!=undefined){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.addClass("del");
						serv.isdel = "Y";
					}
				}
			}
			if(param.dependServ!=undefined&&param.dependServ.length>0){ // 依赖
				for (var i = 0; i < param.dependServ.length; i++) {
					var servSpecId = param.dependServ[i].servSpecId;	
					var newSpec = {
						objId : servSpecId, //调用公用方法使用
						servSpecId : servSpecId,
						servSpecName : param.dependServ[i].servSpecName,
						ifParams : param.dependServ[i].ifParams,
						isdel : "C"   //加入到缓存列表没有做页面操作为C
					};
					var inPamam = {
						prodSpecId:servSpecId
					};
					if("Y"  == newSpec.ifParams){
						var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
						if(data==undefined || data.result==undefined){
							return;
						}
						newSpec.prodSpecParams = data.result.prodSpecParams;
					}
					CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
					AttachOffer.addOpenServList(prodId,servSpecId); 
				}
			}
		}*/
	};
	
	//添加到开通列表
	var _addOpenList = function(prodId,offerSpecId){
		if(!_manyPhoneFilter(prodId,offerSpecId)){
			return;
		}
		var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
		if(offer != undefined){ //在已开通中，需要取消退订
			if(offer.isdel!="Y"){
				var newSpec = _setSpec(prodId,offerSpecId);
				if(newSpec==undefined){ //没有在已开通附属销售列表中
					return;
				}
				if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){
					offer.counts++;
					newSpec.counts=offer.counts;
					if(_ifOrderAgain(newSpec)){
						offer.counts--;
						return;
					}
					if(offer.counts<=2){
						var $li=$("#li_"+prodId+"_"+offer.offerId);
						$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.setParam('+prodId+','+offerSpecId+','+1+');"></dd>');
					}
				}
			}else{
				var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
				$span.removeClass("del");
				offer.isdel = "N";
			}
			return;
		}
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		if(newSpec.isdel=="C"){ //没有在已开通附属销售列表中，但是已经加载到缓存
			if(_ifOrderAgain(newSpec)){
				return;
			}
			var $spec = $('#li_'+prodId+'_'+offerSpecId); //在已开通附属里面
			$spec.remove();
			var $li = $('<li id="li_'+prodId+'_'+offerSpecId+'"></li>');
			if(newSpec.ifDault==0){ //必须
				$li.append('<dd class="mustchoose"></dd>');	
			}else {
				$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+','+offerSpecId+')"></dd>');	
			}
			$li.append('<span>'+newSpec.offerSpecName+'</span>');
			if(newSpec.ifParams){
				if(CacheData.setParam(prodId,newSpec)){ 
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}else {
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}
			}
			if(newSpec.ifShowTime=="Y"){
				$li.append('<dd class="time" id="time_'+prodId+'_'+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+','+offerSpecId+',\''+newSpec.offerSpecName+'\');"></dd>');
			}
			if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){
				$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu2" onclick="AttachOffer.setParam('+prodId+','+offerSpecId+');"></dd>');
			}
			$("#open_ul_"+prodId).append($li);
			newSpec.isdel = "N";
		}else if((newSpec.isdel=="Y")) { 
			var $span = $("#li_"+prodId+"_"+offerSpecId).find("span");
			$span.removeClass("del");
			newSpec.isdel = "N";
		}else if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){
			newSpec.counts++;
			if(_ifOrderAgain(newSpec)){
				newSpec.counts--;
				return;
			}
//			if(newSpec.counts>=2){
//				var $spec = $('#li_'+prodId+'_'+offerSpecId); //在已开通附属里面
//				$spec.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.setParam('+prodId+','+offerSpecId+');"></dd>');
//			}
			
		}else {  //容错处理 //if((newSpec.isdel=="N")) 
			var $spec = $('#li_'+prodId+'_'+offerSpecId); //在已开通附属里面
			$spec.remove();
			var $li = $('<li id="li_'+prodId+'_'+offerSpecId+'"></li>');
			if(newSpec.ifDault==0){ //必须
				$li.append('<dd class="mustchoose"></dd>');	
			}else {
				$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+','+offerSpecId+')"></dd>');	
			}
			$li.append('<span>'+newSpec.offerSpecName+'</span>');
			if (newSpec.ifParams){
				if(CacheData.setParam(prodId,newSpec)){ 
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}else {
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}
			}
			if(newSpec.ifShowTime=="Y"){
				$li.append('<dd class="time" id="time_'+prodId+'_'+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+','+offerSpecId+',\''+newSpec.offerSpecName+'\');"></dd>');
			}
			$("#open_ul_"+prodId).append($li);
		}
		
		//获取销售品节点校验销售品下功能产品的互斥依赖
		if(newSpec!=undefined){
			$.each(newSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					if(this.objType==4 && this.selQty!=2){
						var ifParams = "N";
						if(ec.util.isArray(this.prodSpecParams)){
							ifParams = "Y";
						}
						_addOpenServList(prodId,this.objId,this.objName,ifParams);
						if(this.minQty>0){
							_minQtyFileter(prodId,this.objId);
						}
					}
				});
			});
		}
		if(ec.util.isArray(newSpec.agreementInfos)){ //合约销售品需要输入终端
			if(OrderInfo.actionFlag!=14){//非购机入口的
				totalNums=0;
//				OrderInfo.attach2Coupons.splice(0,OrderInfo.attach2Coupons.length);
//				OrderInfo.attach2Coupons=[];//清除串码组
				_removeAttach2Coupons(prodId,newSpec.offerSpecId);//清除串码组
//				AttachOffer.terminalGroups=[];//清除终端组缓存
//				$.each(newSpec.agreementInfos,function(){
//					AttachOffer.terminalGroups.push(this.terminalGroups);//兼容多个agreementInfos，一般不会有多个的。
//				});
				var objInstId = prodId+'_'+newSpec.offerSpecId;
				//一个终端对应一个ul
				var $ul = $('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');
				var $sel = $('<select id="terminalSel_'+objInstId+'"></select>');  
				var $li1 = $('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+'</span></label></li>');
				
				var $li2 = $('<li style="display:none;"><label> 可选终端规格：</label></li>'); //隐藏
				$.each(newSpec.agreementInfos,function(){
					var $option = $('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+'</option>');
					$sel.append($option);
				});
				$li2.append($sel).append('<label class="f_red">*</label>');
				
				var minNum=newSpec.agreementInfos[0].minNum;
				var maxNum=newSpec.agreementInfos[0].maxNum;
				var $li3=$('<ul></ul>');
				var isFastOffer = 0 ;
				if(ec.util.isArray(newSpec.extAttrParams)){
					$.each(newSpec.extAttrParams,function(){
						if(this.attrId == CONST.OFFER_FAST_FILL){
							isFastOffer = 1;
							return false;
						}
					});
				}
				for(var i=0;i<newSpec.agreementInfos.length;i++){
					var agreementInfo=newSpec.agreementInfos[i];
//					for(var j=0;j<agreementInfo.terminalGroups.length;j++){
//						var terminalGroupId=agreementInfo.terminalGroups[j].terminalGroupId;//终端组
//						var terminalMinNum=agreementInfo.terminalGroups[j].terminalMinNum;
//						var terminalMaxNum=agreementInfo.terminalGroups[j].terminalMaxNum;
						var $ulGroups=$('<ul id="ul_'+objInstId+'" class="fillin show"></ul>');
						var $liGroups = $('<li class="full"><label> 终端：</label></li>');
						var $selTerms = $('<select style="display:none;" id="'+objInstId+'"></select>');
						var $selTermGroups = $('<select style="display:none;" id="group_'+objInstId+'"></select>');
						if(ec.util.isArray(agreementInfo.terminalGroups)){ //如果有配置终端组，则拼接终端组的规格ID和包含的终端规格ID
							for(var j=0;j<agreementInfo.terminalGroups.length;j++){
								var $optionTermGroups=$('<option value="'+agreementInfo.terminalGroups[j].terminalGroupId+'" terminalMaxNum="'+agreementInfo.terminalGroups[j].terminalMaxNum+'" terminalMinNum="'+agreementInfo.terminalGroups[j].terminalMinNum+'">'+agreementInfo.terminalGroups[j].terminalGroupId+'</option>');
								$selTermGroups.append($optionTermGroups);
								if(ec.util.isArray(agreementInfo.terminalGroups[j].terminalGroup)){
									$.each(agreementInfo.terminalGroups[j].terminalGroup,function(){
										var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+'</option>');
										$selTerms.append($optionTerms);
									});
								}
							}
						}
						if(ec.util.isArray(agreementInfo.terminals)){ //如果是直接配置终端规格（旧数据），则拼接终端规格ID
							$.each(agreementInfo.terminals,function(){
								var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+'</option>');
								$selTerms.append($optionTerms);
							});
						}
						
						$liGroups.append($selTerms).append($selTermGroups);
						if(maxNum>newSpec.agreementInfos[0].minNum){
							var $strAdd=$('<input id="terminalAddBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="0" onclick="AttachOffer.addAndDelTerminal(this)" value="添加" class="purchase" style="float:left"></input>');
							var $strDel=$('<input id="terminalDelBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="1" onclick="AttachOffer.addAndDelTerminal(this)" value="删除" class="purchase" style="float:left"></input>');
							$liGroups.append($strAdd).append($strDel);
						}
						$ulGroups.append($liGroups);
//						if(minNum<=0){
//							$li3.append($ulGroups);
//							break;
//						}
//						if(minNum<terminalMinNum){
//							terminalMinNum=minNum;
//						}
						for(var k=1;k<=minNum;k++){
							var $liTerminal=$('<li><label>终端校验：</label><input id="terminalText_'+objInstId+'_'+k+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />'
									+'<input id="terminalBtn_'+objInstId+'_'+k+'" type="button" num="'+k+'" flag="'+isFastOffer+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" value="校验" class="purchase" style="float:left"></input></li>');
							var	$li4 = $('<li id="terminalDesc_'+k+'" style="white-space:nowrap;"><label></label><label id="terminalName_'+k+'"></label></li>');
							
							$ulGroups.append($liTerminal).append($li4);
						}
						$li3.append($ulGroups);
						totalNums+=minNum;
//					}
				}
				var $div = $("#terminalDiv_"+prodId);
				$ul.append($li1).append($li2).append($li3).appendTo($div);
				$div.show();
				if(newSpec.agreementInfos[0].minNum>0){//合约里面至少要有一个终端
					newSpec.isTerminal = 1;
				}
			}else if(OrderInfo.actionFlag==14){
					var objInstId = prodId+'_'+newSpec.offerSpecId;
					var terminalUl=$("#terminalUl_"+objInstId);//如果有就不添加串码框了，防止重复
					if(terminalUl.length>0){
						return;
					}
					//一个终端对应一个ul
					var $ul = $('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');
					var $sel = $('<select id="terminalSel_'+objInstId+'"></select>');  
					var $li1 = $('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+'</span></label></li>');
					var $li2 = $('<li style="display:none;"><label> 可选终端规格：</label></li>'); //隐藏
					$.each(newSpec.agreementInfos,function(){
						var $option = $('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+'</option>');
						$sel.append($option);
					});
					$li2.append($sel).append('<label class="f_red">*</label>');
					var $li3 = $('<li><label>终端校验：</label><input id="terminalText_'+objInstId+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />'
							+'<input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+','+newSpec.offerSpecId+')" value="校验" class="purchase" style="float:left"></input></li>');	
					/*var $li4 = $('<li id="terRes_'+objInstId+'" class="full" style="display: none;" >'
							+'<label style="width:auto; margin:0px 10px;">终端名称：<span id="terName_'+objInstId+'" ></span></label>'
							+'<label style="width:auto; margin:0px 10px;">终端串码：<span id="terCode_'+objInstId+'" ></span></label>'
							+'<label style="width:auto; margin:0px 10px;">终端价格：<span id="terPrice_'+objInstId+'" ></span></label></li>');*/
					var $div = $("#terminalDiv_"+prodId);
					var $li4 = $('<li id="terminalDesc" style="display:none;white-space:nowrap;"><label> 终端规格：</label><label id="terminalName"></label></li>');
					$ul.append($li1).append($li2).append($li3).append($li4).appendTo($div);
					$div.show();
					newSpec.isTerminal = 1;
					
					for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
						var coupon = OrderInfo.attach2Coupons[i];
						if(prodId==coupon.prodId){
							$("#terminalSel_"+objInstId).val(coupon.couponId);
							$("#terminalSel_"+objInstId).attr("disabled",true);
							$("#terminalText_"+objInstId).val(coupon.couponInstanceNumber);
							$("#terminalText_"+objInstId).attr("disabled",true);
							$("#terminalBtn_"+objInstId).hide();
						}
					}
				}
			//}
		}
	};
	
	//终端校验
	var _checkTerminalCode = function(obj){
		var prodId=$(obj).attr("prodId");
		var offerSpecId=$(obj).attr("offerSpecId");
//		var terminalGroupId=$(obj).attr("terminalGroupId");
		var num=$(obj).attr("num");
		var flag=$(obj).attr("flag");
		if(flag==undefined){
			flag = 0 ;
		}
		
		//清空旧终端信息
		_filterAttach2Coupons(prodId,offerSpecId,num);
		
		//清空旧终端信息
//		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
//			var attach2Coupon = OrderInfo.attach2Coupons[i];
//			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId){
//				OrderInfo.attach2Coupons.splice(i,1);
//				break;
//			}
//		}
		var objInstId = prodId+"_"+offerSpecId;
//		var resId = $("#terminalSel_"+objInstId+"_"+terminalGroupId).val();
		var resIdArray = [];
		var terminalGroupIdArray = [];
		$("#"+objInstId+"  option").each(function(){
			resIdArray.push($(this).val());
		});
		$("#group_"+objInstId+"  option").each(function(){
			terminalGroupIdArray.push($(this).val());
		});
		var resId = resIdArray.join("|"); //拼接可用的资源规格id
		var terminalGroupId = terminalGroupIdArray.join("|"); //拼接可用的资源终端组id
		if((resId==undefined || $.trim(resId)=="") && (terminalGroupId==undefined || $.trim(terminalGroupId)=="")){
			$.alert("信息提示","终端规格不能为空！");
			return;
		}
		var instCode = $("#terminalText_"+objInstId + "_"+num).val();
		if(instCode==undefined || $.trim(instCode)==""){
			$.alert("信息提示","终端串码不能为空！");
			return;
		}
		if(_checkData(objInstId,instCode)){
			return;
		}
		var param = {
			instCode : instCode,
			flag : flag,
			mktResId : resId
//			termGroup : terminalGroupId   update by huangjj #13336需求资源要求这个参数不传
		};
		var data = query.prod.checkTerminal(param);
		if(data==undefined){
			return;
		}
		var activtyType ="";
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C" && ec.util.isArray(spec.agreementInfos)){  //订购的附属销售品
                    if(spec.agreementInfos[0].activtyType == 2){
                    	activtyType = "2";
				    }
				}
			}
		}
		if(data.statusCd==CONST.MKTRES_STATUS.USABLE || (data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2")){
			$.alert("信息提示",data.message);
//			$("#terminalSel_"+objInstId).val(data.mktResId);
//			$("#terminalName").html(data.mktResName);
//			$("#terminalDesc").css("display","block");
//			var price = $("#terminalSel_"+objInstId).find("option:selected").attr("price");
			
			
			var mktPrice=0;//营销资源返回的单位是元
			var mktColor="";
			if(ec.util.isArray(data.mktAttrList)){
				$.each(data.mktAttrList,function(){
					if(this.attrId=="65010058"){
						mktPrice=this.attrValue;
					}else if(this.attrId=="60010004"){
						mktColor=this.attrValue;
					}
				});
			}
			$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");
			$("#terminalDesc_"+num).css("display","block");
			
			/*$("#terRes_"+objInstId).show();
			$("#terName_"+objInstId).text(data.mktResName);
			$("#terCode_"+objInstId).text(data.instCode);	
			if(price!=undefined){
				$("#terPrice_"+objInstId).text(price/100 + "元");
			}*/
			var coupon = {
				couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : data.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
				couponNum : 1, //物品数量
				storeId : data.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : mktPrice, //物品价格,约定取值为营销资源的
				couponInstanceNumber : data.instCode, //物品实例编码
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId : prodId, //产品ID
				offerId : -1, //销售品实例ID
				attachSepcId : offerSpecId,
				state : "ADD", //动作
				relaSeq : "", //关联序列	
				num	: num //第几个串码输入框
			};
			if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2"){//“已销售未补贴”的终端串码可以办理话补合约
				coupon.couponSource ="2"; //串码话补标识
			}
			if(CONST.getAppDesc()==0){
				coupon.termTypeFlag=data.termTypeFlag;
			}
			OrderInfo.attach2Coupons.push(coupon);
		}else if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){
			$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用");
		}else{
			$.alert("提示",data.message);
		}
	};
	
	//添加可选包到缓存列表
	var _setSpec = function(prodId,offerSpecId){
		var newSpec = CacheData.getOfferSpec(prodId,offerSpecId);  //没有在已选列表里面
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			newSpec = query.offer.queryAttachOfferSpec(prodId,offerSpecId); //重新获取销售品构成
			if(!newSpec){
				return;
			}
			CacheData.setOfferSpec(prodId,newSpec);
		}
		return newSpec;
	};
	
	//添加到开通列表
	var _addOpenServList = function(prodId,servSpecId,servSpecName,ifParams){
		//从已开通功能产品中找
		var serv = CacheData.getServBySpecId(prodId,servSpecId); 
		if(serv != undefined){
			$("#li_"+prodId+"_"+serv.servId).find("span").removeClass("del");
			serv.isdel = "N";
			return;
		}
		//从已选择功能产品中找
		var spec = CacheData.getServSpec(prodId,servSpecId);
//		if(OrderInfo.actionFlag==22){
//			spec = undefined;
//		}
		if(spec == undefined){
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : servSpecName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			spec = newSpec;
		} 
		if(spec.isdel == "C"){  //没有订购过
			$('#li_'+prodId+'_'+servSpecId).remove(); //删除可开通功能产品里面
			var $li = $('<li id="li_'+prodId+'_'+servSpecId+'"></li>');
			if(spec.ifDault==0){ //必须
				$li.append('<dd class="mustchoose"></dd>');	
			}else {
				$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+','+servSpecId+',\''+servSpecName+'\',\''+ifParams+'\')"></dd>');
			}
			$li.append('<span>'+spec.servSpecName+'</span>');
			if (spec.ifParams=="Y"){
				if(CacheData.setServParam(prodId,spec)){ 
					$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
				}else {
					$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
				}
			}
			$("#open_serv_ul_"+prodId).append($li);
		}else {
			$("#li_"+prodId+"_"+servSpecId).find("span").removeClass("del");
		}
		spec.isdel = "N";
		_showHideUim(0,prodId,servSpecId);//显示或者隐藏补换卡
	};
	
	//现在主销售品参数
	var _showMainParam = function(){
		var content = CacheData.getParamContent(-1,OrderInfo.offerSpec,0);
		$.confirm("参数设置： ",content,{ 
			yes:function(){	
				
			},
			no:function(){
				
			}
		});
		$('#paramForm').bind('formIsValid', function(event, form) {
		}).ketchup({bindElement:"easyDialogYesBtn"});
	};
	
	//显示参数
	var _showParam = function(prodId,offerSpecId,flag){	
		if(flag==1){ //显示已订购附属		
			var offer = CacheData.getOfferBySpecId(prodId,offerSpecId);
			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offer.offerId	
				};
				param.acctNbr = OrderInfo.getAccessNumber(prodId);
				var data = uiOfferQuery.queryOfferInst(param);
				if(data==undefined){
					return;
				}
				offer.offerMemberInfos = data.offerMemberInfos;
				offer.offerSpec = data.offerSpec;
			}
			if(!offer.isGetParam){  //已订购附属没有参数，需要获取销售品参数
				var param = {   
				    offerTypeCd : "2",
				    offerId: offer.offerId,
				    offerSpecId : offer.offerSpecId
				};
				var offerParam = query.offer.queryOfferParam(param); //重新获取销售品参数
				if(offerParam==undefined){
					return;
				}else{
					offer.offerParamInfos = offerParam.offerParamInfos;
					offer.isGetParam = true;
				}
			}
			var content = CacheData.getParamContent(prodId,offer,flag);
			$.confirm("参数设置： ",content,{ 
				yes:function(){		
				},
				no:function(){
				}
			});
			order.protocolnbr.init();
			$('#paramForm').bind('formIsValid', function(event, form) {
				//参数输入校验
				if(!paramInputCheck()){
					return;
				}
				var isset = false;
				$.each(offer.offerSpec.offerSpecParams,function(){
					var itemInfo = CacheData.getOfferParam(prodId,offer.offerId,this.itemSpecId);
					if(itemInfo.itemSpecId == CONST.ITEM_SPEC.PROT_NUMBER){
						itemInfo.setValue = $("#select1").val();
					}else{
					    itemInfo.setValue = $("#"+prodId+"_"+this.itemSpecId).val();
					}
					if(itemInfo.value!=itemInfo.setValue){
						itemInfo.isUpdate = "Y";
						isset = true;
					}
				});
				if(isset){
					$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu").addClass("canshu2");
					offer.isset = "Y";
					offer.update = "Y";
				}else{
					$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu2").addClass("canshu");
					offer.isset = "N";
					offer.update = "N";
				}
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});		
		}else {
			var spec = CacheData.getOfferSpec(prodId,offerSpecId);
			if(spec == undefined){  //未开通的附属销售品，需要获取销售品构成
				spec = query.offer.queryAttachOfferSpec(prodId,offerSpecId); //重新获取销售品构成
				if(!spec){
					return;
				}
			}
			var content = CacheData.getParamContent(prodId,spec,flag);	
			$.confirm("参数设置： ",content,{ 
				yes:function(){
				},
				no:function(){
				}
			});
			order.protocolnbr.init();
			$('#paramForm').bind('formIsValid', function(event, form){
				//参数输入校验
				if(!paramInputCheck()){
					return;
				}
				if(!!spec.offerSpecParams){
					for (var i = 0; i < spec.offerSpecParams.length; i++) {
						var param = spec.offerSpecParams[i];
						var itemSpec = CacheData.getSpecParam(prodId,offerSpecId,param.itemSpecId);
						if(itemSpec.itemSpecId == CONST.ITEM_SPEC.PROT_NUMBER){
							itemSpec.setValue = $("#select1").val();
						}else{
							itemSpec.setValue = $("#"+prodId+"_"+param.itemSpecId).val();
						}
					}
				}
				if(spec.offerRoles!=undefined && spec.offerRoles.length>0){
					for (var i = 0; i < spec.offerRoles.length; i++) {
						var offerRole = spec.offerRoles[i];
						for (var j = 0; j < offerRole.roleObjs.length; j++) {
							var roleObj = offerRole.roleObjs[j];
							if(!!roleObj.prodSpecParams){
								for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
									var prodParam = roleObj.prodSpecParams[k];
									var prodItem = CacheData.getProdSpecParam(prodId,offerSpecId,prodParam.itemSpecId);
									prodItem.value = $("#"+prodId+"_"+prodParam.itemSpecId).val();
								}
							}
						}
					}
				}
				$("#can_"+prodId+"_"+offerSpecId).removeClass("canshu").addClass("canshu2");
				var attchSpec = CacheData.getOfferSpec(prodId,offerSpecId);
				attchSpec.isset = "Y";
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});	
		}
	};
	
	//显示服务参数
	var _showServParam = function(prodId,servSpecId,flag){
		if(flag==1){ //显示已订购附属
			var serv = CacheData.getServBySpecId(prodId,servSpecId);
			var param = {
				prodId : serv.servId,
				ifServItem:"Y"
			};
			if(!serv.isGetParamSpec){  //已订购附属没有参数，需要获取销售品参数	
				param.prodSpecId = serv.servSpecId;
				var dataSepc = query.prod.prodSpecParamQuery(param); //重新获取销售品参数
				if(dataSepc==undefined){
					return;
				}else{
					serv.prodSpecParams = dataSepc.result.prodSpecParams;
					serv.isGetParamSpec = true;
				}
			}
			if(!serv.isGetParamInst){  //已订购附属没有参数，需要获取销售品参数
				var data = query.prod.prodInstParamQuery(param); //重新获取销售品参数
				if(data==undefined){
					return;
				}else{
					serv.prodInstParams = data.result.prodInstParams;
					serv.isGetParamInst = true;
				}
			}
			var content = CacheData.getParamContent(prodId,serv,3);
			
			if(OrderInfo.isGroupProSpecId(serv.servSpecId)){//群功能产品
				ec.form.dialog.createDialog({
					"id":"-group",
					"width":"370",
					"height":"440",
					"initCallBack":function(dialogForm,dialog){
						AttachOffer.dialogForm=dialogForm;
						AttachOffer.dialog=dialog;
						$("#div_group").empty();
						$("#div_group").append(content);
						$("#div_group_btn").empty();
						var str='<a href="javascript:void(0)" id="ok_btn" class="btn_h30"><span>确认</span></a>'
						+'<a href="javascript:void(0);" id="cancel_btn" class="btn_h30" style="margin-left:20px;"><span>取消</span></a>';
						$("#div_group_btn").append(str);
						//绑定确定按钮click事件
						$("#ok_btn").off("click").on("click",function(event){
							_groupInistOkBtn(prodId,servSpecId);
						});
						$("#cancel_btn").off("click").on("click",function(event){
							_closeDialog();
						});
					},
					"submitCallBack":function(dialogForm,dialog){
						
					},
					"closeCallBack":function(dialogForm,dialog){
					}
				});
				return;
			}
			
			$.confirm("参数设置： ",content,{ 
				yes:function(){	
					
				},
				no:function(){
					
				}
			});
			$('#paramForm').bind('formIsValid', function(event, form) {
				var isset = false;
				$.each(serv.prodSpecParams,function(){
					var prodItem = CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);
					prodItem.setValue = $("#"+prodId+"_"+this.itemSpecId).val();	
					if(prodItem.value!=prodItem.setValue){
						prodItem.isUpdate = "Y";
						isset = true;
					}
				});
				if(isset){
					$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");
					serv.isset = "Y";
					serv.update = "Y";
				}else{
					$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");
					serv.isset = "N";
					serv.update = "N";
				}
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
		
		}else {
			var spec = CacheData.getServSpec(prodId,servSpecId);
			if(spec == undefined){  //未开通的附属销售品，需要获取销售品构成
				return;
			}
			var content = CacheData.getParamContent(prodId,spec,2);	
			
			if(OrderInfo.isGroupProSpecId(spec.servSpecId)){//群功能产品
				ec.form.dialog.createDialog({
					"id":"-group",
					"width":"370",
					"height":"440",
					"initCallBack":function(dialogForm,dialog){
						AttachOffer.dialogForm=dialogForm;
						AttachOffer.dialog=dialog;
						$("#div_group").empty();
						$("#div_group").append(content);
						$("#div_group_btn").empty();
						var str='<a href="javascript:void(0)" id="ok_btn" class="btn_h30"><span>确认</span></a>'
						+'<a href="javascript:void(0);" id="cancel_btn" class="btn_h30" style="margin-left:20px;"><span>取消</span></a>';
						$("#div_group_btn").append(str);
						//绑定确定按钮click事件
						$("#ok_btn").off("click").on("click",function(event){
							_groupOkBtn(prodId,servSpecId);
						});
						$("#cancel_btn").off("click").on("click",function(event){
							_closeDialog();
						});
					},
					"submitCallBack":function(dialogForm,dialog){
						
					},
					"closeCallBack":function(dialogForm,dialog){
					}
				});
				return;
			}
			
			$.confirm("参数设置： ",content,{ 
				yes:function(){
				},
				no:function(){	
				}
			});
			$('#paramForm').bind('formIsValid', function(event, form){
				if(!!spec.prodSpecParams){
					for (var i = 0; i < spec.prodSpecParams.length; i++) {
						var param = spec.prodSpecParams[i];
						var itemSpec = CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);
						itemSpec.setValue = $("#"+prodId+"_"+param.itemSpecId).val();
					}
				}
				$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");
				var attchSpec = CacheData.getServSpec(prodId,servSpecId);
				attchSpec.isset = "Y";
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
		}
	};
	
	//已选群功能产品确定按钮
	var _groupOkBtn=function(prodId,servSpecId){
		var spec = CacheData.getServSpec(prodId,servSpecId);
		var flag=true;
		if(!!spec.prodSpecParams){
			for (var i = 0; i < spec.prodSpecParams.length; i++) {
				var param = spec.prodSpecParams[i];
				var itemSpec = CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);
				itemSpec.setValue = $("#"+prodId+"_"+param.itemSpecId).val();
				if(!ec.util.isObj(itemSpec.setValue)){
					$.alert("信息提示",param.name+"不能为空");
					flag=false;
					break;
				}
			}
		}
		if(flag){
			$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");
			var attchSpec = CacheData.getServSpec(prodId,servSpecId);
			attchSpec.isset = "Y";
			easyDialog.close();
//			_closeDialog();
		}
	};
	
	//已订购群功能产品确定按钮
	var _groupInistOkBtn=function(prodId,servSpecId){
		var serv = CacheData.getServBySpecId(prodId,servSpecId);
		var isset = false;
		$.each(serv.prodSpecParams,function(){
			var prodItem = CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);
			prodItem.setValue = $("#"+prodId+"_"+this.itemSpecId).val();	
			if(prodItem.value!=prodItem.setValue){
				prodItem.isUpdate = "Y";
				isset = true;
			}
		});
			if(isset){
				$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");
				serv.isset = "Y";
				serv.update = "Y";
			}else{
				$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");
				serv.isset = "N";
				serv.update = "N";
			}
			_closeDialog();
	};
	
	var _closeDialog = function() {
		if(AttachOffer.dialogForm!=undefined&&AttachOffer.dialog!=undefined){
			AttachOffer.dialogForm.close(AttachOffer.dialog);
		}
	};
	
	//（销售品）参数输入校验（服务参数暂未使用）
	var paramInputCheck = function(){
		var pass = true;
		$("#paramForm").find("input[type=text]").each(function(){
			var mask = $(this).attr("mask");
			var maskmsg = $(this).attr("maskmsg");
			if(mask!=null && mask!="" && mask.substring(0,1)=="/" && mask.substring(mask.length-1,mask.length)=="/"){
				if(!eval(mask).test($(this).val())){
					$.alert("提示",maskmsg);
					pass = false;
					return false;
				}
			}
		});
		return pass;
	};
	
	//销售品生失效时间显示
	var _showTime = function(prodId,offerSpecId,offerSpecName){	
		var data = OrderInfo.getPrivilege("EFF_TIME");		
		$('#attachName').text(offerSpecName+"--生失效设置");
		var spec = CacheData.getOfferSpec(prodId,offerSpecId);
		_initTime(spec);
		easyDialog.open({
			container : "div_time_dialog"
		});
		$("#timeSpan").off("click").on("click",function(){
			_setAttachTime(prodId,offerSpecId);
		});
		if(data==0){
			$("#startTimeTr").show();
			$("#endTimeTr").show();
		}else{
			$("#startTimeTr").hide();
			$("#endTimeTr").hide();
		}
	};
	
	//销售品生效时间显示
	var _showStartTime = function(){	
		var strDate =DateUtil.Format("yyyy年MM月dd日",new Date());
		var endDate = $("#endDt").val();
		if(endDate ==""){
			$.calendar({minDate:strDate});
		}else{
			$.calendar({minDate:strDate,maxDate:endDate});
		}
	};
	
	//销售品失效时间显示
	var _showEndTime = function(){	
		var strDate = $("#startDt").val();
		if(strDate==""){
			strDate =DateUtil.Format("yyyy年MM月dd日",new Date());
		}
		$.calendar({minDate:strDate});
	};
	
	//初始化时间设置页面
	var _initTime = function(spec){
		if(spec!=undefined && spec.ooTimes!=undefined){
			var ooTime = spec.ooTimes;
			$("input[name=startTimeType][value='"+ooTime.startType+"']").attr("checked","checked");
			$("input[name=endTimeType][value='"+ooTime.endType+"']").attr("checked","checked");
			$("#startDt").val("");
			$("#endDt").val("");
			$("#endTime").val("");
			if(ooTime.startType == 4){ //指定生效时间
				$("#startDt").val(ooTime.startDt);
			}
			if(ooTime.endType == 4){ //指定失效时间
				$("#endDt").val(ooTime.endDt);
			}else if(ooTime.endType == 5){  //有效时长
				$("#endTime").val(ooTime.effTime);
				$("#endTimeUnit").val(ooTime.effTimeUnitCd);
			}
		}else {
			$("input[name=startTimeType][value=1]").attr("checked","checked");
			$("input[name=endTimeType][value=1]").attr("checked","checked");
			$("#startDt").val("");
			$("#endDt").val("");
			$("#endTime").val("");
		}
	};
	
	//显示主套餐时间
	var _showOfferTime = function(){
		var data = OrderInfo.getPrivilege("EFF_TIME");		
		$('#attachName').text(OrderInfo.offerSpec.offerSpecName+"-生失效设置");
		_initTime(OrderInfo.offerSpec);
		easyDialog.open({
			container : "div_time_dialog"
		});
		$("#timeSpan").off("click").on("click",function(){
			_setMainTime();
		});
		if(data==0){
			$("#startTimeTr").show();
			$("#endTimeTr").show();
		}else{
			$("#startTimeTr").hide();
			$("#endTimeTr").hide();
		}
	};
	
	//显示主套餐构成
	var _showMainMember = function(){
		$('#memberName').text(OrderInfo.offerSpec.offerSpecName+"-构成");
		$("#main_member_div").empty();
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if(this.memberRoleCd == CONST.MEMBER_ROLE_CD.CONTENT){
				var $ul = $('</div><ul id="serv_ul_'+prodId+'"></ul>');
				var $div = $('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');
				$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));
				$.each(offerRole.roleObjs,function(){
					var $li = $('<li id="li_'+prodId+'_'+this.objId+'">'+this.objName+'</li>');
					var $checkbox = $('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');
					$ul.append($checkbox).append($li);
				});
				$("#main_member_div").append('<div class="clear"></div>');
			}else{
				$.each(offerRole.prodInsts,function(){
					var prodId = this.prodInstId;
					var $ul = $('</div><ul id="serv_ul_'+prodId+'"></ul>');
					var $div = $('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');
					$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));
					$.each(offerRole.roleObjs,function(){
						if(this.objType == CONST.OBJ_TYPE.SERV){
							var $li = $('<li id="li_'+prodId+'_'+this.objId+'">'+this.objName+'</li>');
							var $checkbox = $('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');
							$ul.append($checkbox).append($li);		
						}
					});
					$("#main_member_div").append('<div class="clear"></div>');
				});
			}
		});
		easyDialog.open({
			container : "div_member_dialog"
		});
		
		$.each(OrderInfo.offerSpec.offerRoles,function(){  //自动勾选功能产品
			var offerRole = this;
			$.each(offerRole.prodInsts,function(){ //自动勾选接入产品已经选择的功能产品
				var prodInst = this;
				$.each(offerRole.roleObjs,function(){ //根据规格配置勾选默认的功能产品
					var servSpecId = this.objId;
					if(this.minQty>0){ //必选
						$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){
							if(servSpecId==$(this).attr("servSpecId")){
								$(this).attr("checked","checked");
								$(this).attr("disabled","disabled");
							}
						});
					}
				});
				if(!!prodInst.servInsts){  
					$.each(prodInst.servInsts,function(){  //遍历产品实例下已经选择的功能产品
						var servSpecId = this.objId;
						$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){
							if(servSpecId==$(this).attr("servSpecId")){
								$(this).attr("checked","checked");
							}
						});
					});
				}
			});
		});
		
		$("#memberSpan").off("click").on("click",function(){
			_setMainMember();
		});
	};
	
	//保存主销售品成员
	var _setMainMember = function(){
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			$.each(this.prodInsts,function(){
				var prodInst = this;
				prodInst.servInsts = [];
				$("input[name='serv_check_"+this.prodInstId+"']:checked").each(function(){
					var servSpecId = $(this).attr("servSpecId");
					$.each(offerRole.roleObjs,function(){
						if(this.objId==servSpecId){  //获取选择功能产品的构成
							prodInst.servInsts.push(this);	
						}
					});
				});
			});
		});
		easyDialog.close();
	};
	
	//获取ooTime节点
	var _getTime = function(){
		var ooTime = {
			state : "ADD" 
		};
		//封装生效时间
		var startRadio = $("input[name=startTimeType]:checked").attr("value");
		ooTime.startType = startRadio;
		if(startRadio==1){
			ooTime.isDefaultStart = "Y";
		}else if(startRadio==2){  //竣工生效，不传值
			
		}else if(startRadio==3){  //次月生效
			ooTime.startTime = 1;
			ooTime.startTimeUnitCd = 7;
			//ooTime.startDt = _getNextMonthFirstDate();
		}else if(startRadio==4){ //指定生效时间
			if($("#startDt").val()==""){
				$.alert("提示","指定生效时间不能为空!");
				return;
			}
			ooTime.startDt = $("#startDt").val();
		}
		//封装失效时间
		var endRadio = $("input[name=endTimeType]:checked").attr("value");	
		ooTime.endType = endRadio;
		if(endRadio==1){
			ooTime.isDefaultEnd = "Y";
		}else if(endRadio==4){
			if($("#endDt").val()==""){
				$.alert("提示","指定失效时间不能为空!");
				return;
			}
			ooTime.endDt = $("#endDt").val();
		}else if(endRadio==5){
			var end = $("#endTime").val();
			if(end==""){
				$.alert("提示","有效时长不能为空!");
				return;
			}
			if(isNaN(end)){
				$.alert("提示","有效时长必须为数字!");
				return;
			} 
			if(end<=0){
				$.alert("提示","有效时长必须大于0!");
				return;
			} 
			ooTime.effTime = end;
			ooTime.effTimeUnitCd = $("#endTimeUnit").val();
		}
		return ooTime;
	};
	
	//设置主销售品生失效时间设置
	var _setMainTime = function(){
		var ooTime = _getTime();
		if(ooTime==undefined){
			return;
		}
		OrderInfo.offerSpec.ooTimes = ooTime;
		$("#mainTime").removeClass("time").addClass("time2");
		easyDialog.close();
	};
	
	//设置附属销售品生失效时间设置
	var _setAttachTime = function(prodId,offerSpecId){
		var ooTime = _getTime();
		if(ooTime==undefined){
			return;
		}
		var spec = CacheData.getOfferSpec(prodId,offerSpecId);
		spec.ooTimes = ooTime;
		$("#time_"+prodId+"_"+offerSpecId).removeClass("time").addClass("time2");
		easyDialog.close();
	};
	
	//获取下个月第一天
	/*var _getNextMonthFirstDate = function(){
		var d = new Date();
		var yyyy = 1900+d.getYear();    
		var MM = d.getMonth()+1;      
		var dd = "01";   
		if(MM==12){
			yyyy++;
			MM = "01";	
		}else if(MM<9){
			MM++;
			MM = "0"+MM;
		}else {
			MM++;
		}
		return yyyy+"-"+MM+"-"+dd; 
	};*/
	
	//切换标签
	var _changeLabel = function(prodId,prodSpecId,labelId){
		$.each(AttachOffer.labelList,function(){ //附属标签显示隐藏
			if(this.prodId==prodId){
				$.each(this.labels,function(){
					if(labelId==""){
						labelId = this.label;
						$("#tab_"+prodId+"_"+this.label).addClass("setcon");
					}else{
						if(labelId == this.label){
							$("#tab_"+prodId+"_"+this.label).addClass("setcon");
							$("#ul_"+prodId+"_"+this.label).show();
						}else{
							$("#tab_"+prodId+"_"+this.label).removeClass("setcon");
							$("#ul_"+prodId+"_"+this.label).hide();
						}
					}
				});
			}
		});
		var $ul = $("#ul_"+prodId+"_"+labelId); //创建ul
		if($ul[0]==undefined){ //没有加载过，重新加载  
			var queryType = "3";
			if(prodId>0){
				queryType = "";
			}
			if(labelId==CONST.LABEL.SERV){  //功能产品
				var param = {
					prodId : prodId,
					prodSpecId : prodSpecId,
					queryType : queryType,
					labelId : labelId
				};
				var data = query.offer.queryServSpec(param);
				var $ul = $('<ul id="ul_'+prodId+'_'+labelId+'"></ul>');
				if(data!=undefined && data.resultCode == "0"){
					if(ec.util.isArray(data.result.servSpec)){
						var servList = CacheData.getServList(prodId);//过滤已订购
						var servSpecList = CacheData.getServSpecList(prodId);//过滤已选择
						$.each(data.result.servSpec,function(){
							AttachOffer.allOfferList.push(this);
							var servSpecId = this.servSpecId;
							var flag = true;
							$.each(servList,function(){
								if(this.servSpecId==servSpecId&&this.isDel!="C"){
									flag = false;
									return false;
								}
							});
							$.each(servSpecList,function(){
								if(this.servSpecId==servSpecId){
									flag = false;
									return false;
								}
							});
							if(flag){
								var $li = $('<li id="li_'+prodId+'_'+this.servSpecId+'"></li>');
								var $dd = $('<dd class="canchoose" onclick="AttachOffer.openServSpec('+prodId+','+this.servSpecId+',\''+this.servSpecName+'\',\''+this.ifParams+'\')"></dd>');
								var $span = $('<span><a href="javascript:AttachOffer.openServSpec('+prodId+','+this.servSpecId+',\''+this.servSpecName+'\',\''+this.ifParams+'\')">'+this.servSpecName+'</a></span>');
								var $dd2 = $('<dd class="canshu2" onclick="AttachOffer.offerSpecDetail('+prodId+','+this.servSpecId+')"><img src="'+contextPath+'/image/common/more.png"/></dd>');
								$li.append($dd).append($span).append($dd2).appendTo($ul);
							}
						});
					}
				}
				$("#div_"+prodId).append($ul);
			}else{
				var param = {
					prodSpecId : prodSpecId,
					offerSpecIds : [],
					queryType : queryType,
					prodId : prodId,
					partyId : OrderInfo.cust.custId,
					labelId : labelId,
					ifCommonUse : ""			
				};
				if(OrderInfo.actionFlag == 2){ //套餐变更		
					$.each(OrderInfo.offerSpec.offerRoles,function(){
						if(ec.util.isArray(this.prodInsts)){
							$.each(this.prodInsts,function(){
								if(this.prodInstId==prodId){
									param.acctNbr = this.accessNumber;
									param.offerRoleId = this.offerRoleId;
									param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);	
									return false;
								}
							});
						}
					});
				}else if(OrderInfo.actionFlag == 3 || OrderInfo.actionFlag == 22){  //可选包
					var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
					param.acctNbr = prodInfo.accNbr;
					if(!ec.util.isObj(prodInfo.prodOfferId)){
						prodInfo.prodOfferId = "";
					}
					var offerRoleId = CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;
					if(offerRoleId==undefined){
						offerRoleId = "";
					}
					param.offerRoleId = offerRoleId;
					param.offerSpecIds.push(prodInfo.prodOfferId);
				}else if(OrderInfo.actionFlag == 21){ //副卡套餐变更		
					$.each(OrderInfo.viceOfferSpec,function(){
						var offerSpecId=this.offerSpecId;
						var accessNumber=this.accessnumber;
						if(this.prodId==prodId){
							$.each(this.offerRoles,function(){
								if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD || this.memberRoleCd=="1"){
									$.each(this.roleObjs,function(){
										if(this.objType==CONST.OBJ_TYPE.PROD){
											param.acctNbr = accessNumber;
											param.offerRoleId = this.offerRoleId;
											param.offerSpecIds.push(offerSpecId);	
											return false;
										}
									});
								}
							});
						}
					});
				}else if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
						if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
							param.acctNbr = OrderInfo.oldprodInstInfos[i].accNbr;
							$.each(OrderInfo.oldofferSpec,function(){
								if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){
									param.offerSpecIds.push(this.offerSpec.offerSpecId);	
									$.each(this.offerSpec.offerRoles,function(){
										if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD || this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){
											param.offerRoleId = this.offerRoleId;
										}
									});
								}
							});
						}
					}
				}else { //新装
					param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);
					var prodInst = OrderInfo.getProdInst(prodId);
					if(prodInst){
						param.offerRoleId = prodInst.offerRoleId;
					}
				}
				query.offer.queryCanBuyAttachSpec(param,function(data){
					var $ul = $('<ul id="ul_'+prodId+'_'+labelId+'"></ul>');
					if(data!=undefined && data.resultCode == "0"){
						if(ec.util.isArray(data.result.offerSpecList)){
							var offerList = CacheData.getOfferList(prodId); //过滤已订购
							var offerSpecList = CacheData.getOfferSpecList(prodId);//过滤已选择
							$.each(data.result.offerSpecList,function(){
								AttachOffer.allOfferList.push(this);
								var offerSpecId = this.offerSpecId;
								var flag = true;
								var ifOrderAgain=this.ifOrderAgain;//是否可以重复订购
								$.each(offerList,function(){
									if(this.offerSpecId==offerSpecId&&this.isDel!="C"&&ifOrderAgain!="Y"){
										flag = false;
										return false;
									}
								});
								$.each(offerSpecList,function(){
									if(this.offerSpecId==offerSpecId&&ifOrderAgain!="Y"){
										flag = false;
										return false;
									}
								});
								if(flag){
									var $li = $('<li id="li_'+prodId+'_'+this.offerSpecId+'"></li>');
									if(ec.util.isObj(ifOrderAgain)&&ifOrderAgain=="Y"){
										$li = $('<li id="li_'+prodId+'_'+this.offerSpecId+'_'+ifOrderAgain+'"></li>');
									}
									var $dd = $('<dd class="canchoose" onclick="AttachOffer.addOfferSpec('+prodId+','+this.offerSpecId+')"></dd>');
									var $span = $('<span><a href="javascript:AttachOffer.addOfferSpec('+prodId+','+this.offerSpecId+')" >'+this.offerSpecName+'</a></span>');
									var $dd2 = $('<dd class="canshu2" onclick="AttachOffer.offerSpecDetail('+prodId+','+this.offerSpecId+')"><img src="'+contextPath+'/image/common/more.png"/></dd>');
									$li.append($dd).append($span).append($dd2).appendTo($ul);
								}
							});
						}
					}
					$("#div_"+prodId).append($ul);
				});
			}
		}
	};
	
	//开通跟取消开通功能产品时判断是否显示跟隐藏补换卡
	var _showHideUim = function(flag,prodId,servSpecId){
		if(CONST.getAppDesc()==0 && servSpecId == CONST.PROD_SPEC.PROD_FUN_4G){ //4G系统并且是开通或者关闭4g功能产品
			var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
			if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){//套餐变更
				prodClass = CacheData.getOfferMember(prodId).prodClass;
			}else if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){
				for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
					if(prodId == OrderInfo.oldprodInstInfos[i].prodInstId){
						prodClass = OrderInfo.oldprodInstInfos[i].prodClass;
					}
				}
			}
			if(flag==0){ //开通功能产品
				if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡需要补卡
					$("#title_"+prodId).show();
					$("#uimDiv_"+prodId).show();
				}
			}else if(flag==1){//取消开通功能产品
				if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡，已经显示补卡,判断是否隐藏补卡
					$("#uimDiv_"+prodId).hide();
				}
			}
		}
	};
	
	//判断是否需要补卡
	var _isChangeUim = function(objId){
		if(CONST.getAppDesc()==0){
			var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
			var prodId = order.prodModify.choosedProdInfo.prodInstId;
			if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){//套餐变更
				var member = CacheData.getOfferMember(objId);
				prodClass = member.prodClass;
				prodId = member.objInstId;
			}else if(OrderInfo.actionFlag==6 && ec.util.isArray(OrderInfo.oldprodInstInfos)){
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.prodInstId==objId){
						prodClass = this.prodClass;
						prodId = this.prodInstId;
					}
				});
			}
			if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡，已经显示补卡,判断是否隐藏补卡
				var servSpec = CacheData.getServSpec(prodId,CONST.PROD_SPEC.PROD_FUN_4G);
				if(servSpec!=undefined && servSpec.isdel != "Y" && servSpec.isdel != "C"){ //有开通4G功能产品
					return true;
				}
			}
		}
		return false;
	};
	
	//获取附属销售品节点
	var _setAttachBusiOrder = function(busiOrders){
		//遍历已选功能产品列表
		$.each(AttachOffer.openServList,function(){
			var prodId = this.prodId;
			$.each(this.servSpecList,function(){
				if(this.isdel != "Y" && this.isdel != "C"){  //订购的功能产品  && _getRelaType(this.servSpecId)!="1000"
					SoOrder.createServ(this,prodId,0,busiOrders);
				}
			});
		});
		//遍历已订购功能产品列表
		$.each(AttachOffer.openedServList,function(){
			var prodId = this.prodId;
			$.each(this.servList,function(){
				if(this.isdel == "Y"){  //关闭功能产品
					SoOrder.createServ(this,prodId,1,busiOrders);
				}else {
					if(this.update=="Y"){  //变更功能产品
						SoOrder.createServ(this,prodId,2,busiOrders);
					}
				}
			});
		});
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C"){  //订购的附属销售品
					if(ec.util.isObj(spec.counts)){//组装重复订购的可选包
						for(var k=0;k<spec.counts;k++){
							SoOrder.createAttOffer(spec,open.prodId,0,busiOrders);
						}
					}else{
						SoOrder.createAttOffer(spec,open.prodId,0,busiOrders);
					}
				}
			}
		}
		//遍历已订购附属销售品列表
		for ( var i = 0; i < AttachOffer.openedList.length; i++) {
			var opened = AttachOffer.openedList[i];
			for ( var j = 0; j < opened.offerList.length; j++) {  //遍历当前产品下面的附属销售品
				var offer = opened.offerList[j];
				if(offer.isdel == "Y"){  //退订的附属销售品
					if(ec.util.isObj(offer.counts)){//组装重复订购的可选包
						for(var k=0;k<offer.orderCount;k++){
							offer.offerId=offer.offerIds[k];
							SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders);
						}
					}else{
						SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders);
					}
				}else if(offer.update=="Y"){//修改附属销售品
					SoOrder.createAttOffer(offer,opened.prodId,2,busiOrders);
				}else if(ec.util.isObj(offer.orderCount)&&ec.util.isObj(offer.counts)){
					if(offer.orderCount>offer.counts){//退订附属销售品
						for(var k=0;k<(offer.orderCount-offer.counts);k++){
							offer.offerId=offer.offerIds[k];
							SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders);
						}
					}else if(offer.orderCount<offer.counts){//订购附属销售品
						var spec = CacheData.getOfferSpec(opened.prodId,offer.offerSpecId);
						for(var k=0;k<(offer.counts-offer.orderCount);k++){
							SoOrder.createAttOffer(spec,opened.prodId,0,busiOrders);
						}
					}
					
				}
			}
		}
		
		//遍历已选增值业务
		$.each(AttachOffer.openAppList,function(){
			var prodId = this.prodId;
			$.each(this.appList,function(){
				if(this.dfQty==1){  //开通增值业务
					SoOrder.createServ(this,prodId,0,busiOrders);
				}
			});
		});
	};
	//把对比省预校验的后有变动的 功能产品和可选包 放入临时缓存列表中
	var _setChangeList=function(prodId){
		AttachOffer.changeList=[];//清空
		var prodInfos = offerChange.resultOffer.prodInfos;//预校验返回的功能产品
		if(ec.util.isArray(prodInfos)){
			$.each(prodInfos,function(){
//				var prodId = this.accProdInstId;
				//容错处理，省份接入产品实例id传错
//				var flag = true;
//				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
//					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
//						flag = false;
//						return false;
//					}
//				});
				if(prodId!=this.accProdInstId){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var param={
						prodInstId:prodId
					};
					var serv = CacheData.getServ(prodId,this.prodInstId);//在已开通的功能产品里面查找
					var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
					if(this.state=="DEL"){
						if(serv!=undefined && serv.isdel != "Y"){
							param.objId=this.prodInstId;
							param.status=(serv.isdel!=undefined?serv.isdel:"N");
							param.objIdType=1;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							serv.isdel = "Y";
							AttachOffer.changeList.push(param);
						}else if(servSpec!=undefined && servSpec.isdel !="Y" && servSpec.isdel !="C"){
							param.objId=this.productId;
							param.status=servSpec.isdel;
							param.objIdType=2;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							servSpec.isdel = "Y";
							AttachOffer.changeList.push(param);
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined && serv.isdel == "Y"){  //在已开通里面，修改不让关闭
							param.objId=this.prodInstId;
							param.status=serv.isdel;
							param.objIdType=1;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							serv.isdel = "N";
							AttachOffer.changeList.push(param);
						}else if(servSpec != undefined && servSpec.isdel =="Y"){
							param.objId=this.productId;
							param.status=servSpec.isdel;
							param.objIdType=2;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							servSpec.isdel = "N";
							AttachOffer.changeList.push(param);
						}else if(serv==undefined && servSpec==undefined){
							param.objId=this.productId;
							param.status="Y";
							param.objIdType=2;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							AttachOffer.changeList.push(param);
							if(this.productId!=undefined && this.productId!=""){
//								AttachOffer.openServSpec(prodId,this.productId);
								var newSerSpec = {
										objId : this.productId,
										servSpecId : this.productId,
										servSpecName : this.productName,
										ifParams : "N",
										isdel : "N"  
									};
								CacheData.setServSpec(prodId,newSerSpec); //添加到已开通列表里
								var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
								servSpec.isdel="N";
							}
						}
					}
				}
			});
		}
		var offers = offerChange.resultOffer.prodOfferInfos;//省预校验返回的可选包
		if(ec.util.isArray(offers)){
			$.each(offers,function(){
				if(this.memberInfo==undefined){
					return true;
				}
				var flag = true;
				$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
					if(ec.util.isObj(this.accProdInstId)&&prodId == this.accProdInstId){
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				var param={
						prodInstId:prodId
					};
				var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已开通里面查找
				var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已选里面查找
				if(this.state=="DEL"){
					if(offer!=undefined && offer.isdel != "Y"){
						param.objId=this.prodOfferInstId;
						param.status=(offer.isdel!=undefined?offer.isdel:"N");
						param.objIdType=3;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offer.isdel = "Y";
						AttachOffer.changeList.push(param);
					}else if(offerSpec!=undefined && offerSpec.isdel !="Y" && offerSpec.isdel !="C"){
						param.objId=this.prodOfferId;
						param.status=offerSpec.isdel;
						param.objIdType=4;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offerSpec.isdel = "Y";
						AttachOffer.changeList.push(param);
					}	
				}else if(this.state=="ADD"){
					if(offer!=undefined && offer.isdel == "Y"){  //在已开通里面，修改不让关闭
						param.objId=this.prodOfferInstId;
						param.status=offer.isdel;
						param.objIdType=3;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offer.isdel = "N";
						AttachOffer.changeList.push(param);
					}else if(offerSpec != undefined && offerSpec.isdel =="Y"){
						param.objId=this.prodOfferId;
						param.status=offerSpec.isdel;
						param.objIdType=4;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offerSpec.isdel = "N";
						AttachOffer.changeList.push(param);
					}else if(offer==undefined && offerSpec==undefined){
						param.objId=this.prodOfferId;
						param.status="Y";
						param.objIdType=4;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						AttachOffer.changeList.push(param);
						if(ec.util.isObj(this.prodOfferId) && this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){
//							AttachOffer.addOfferSpecByCheck(prodId,this.prodOfferId);
							var newOfferSpec=_setSpec(prodId,this.prodOfferId);
							newOfferSpec.isdel="N";
						}
					}
				}
			});
		}
	};
	//还原预校验前的缓存信息
	var _reductionChangList=function(prodId){
		$.each(AttachOffer.changeList,function(){
			if(this.prodInstId==prodId){
				if(this.objIdType==1){
					var serv = CacheData.getServ(prodId,this.objId);//在已开通的功能产品里面查找
					if(serv!=undefined){
						serv.isdel=this.status;
					}
				}else if(this.objIdType==2){
					var servSpec = CacheData.getServSpec(prodId,this.objId);//在已选的功能产品里面查找
					if(servSpec!=undefined){
						servSpec.isdel=this.status;
					}
				}else if(this.objIdType==3){
					var offer = CacheData.getOffer(prodId,this.objId); //已开通里面查找
					if(offer!=undefined){
						offer.isdel=this.status;
					}
				}else if(this.objIdType==4){
					var offerSpec = CacheData.getOfferSpec(prodId,this.objId); //已选里面查找
					if(offerSpec!=undefined){
						offerSpec.isdel=this.status;
					}
				}
			}
		});
	};
	//查询销售品对象的互斥依赖连带的关系
	var _servExDepReByRoleObjs=function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		paramObj.excludeServ=[];//初始化
		paramObj.dependServ=[];//初始化
		paramObj.relatedServ=[];//初始化
		var globContent="";
		$.each(newSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objType==4 && this.selQty==1){
						var servSpec = CacheData.getServSpec(prodId,this.objId); //在已选列表中查找
						if(servSpec==undefined){   //在可订购功能产品里面 
							var serv = CacheData.getServBySpecId(prodId,this.objId); //在已开通列表中查找
							if(serv==undefined){
								var newServSpec = {
										objId : this.objId, //调用公用方法使用
										servSpecId : this.objId,
										servSpecName : this.objName,
										ifParams : this.isCompParam,
										prodSpecParams : this.prodSpecParams,
										isdel : "C"   //加入到缓存列表没有做页面操作为C
								};
								CacheData.setServSpec(prodId,newServSpec); //添加到已开通列表里
								servSpec = newServSpec;
							}else{
								servSpec=serv;
							}
						}
						var servSpecId = servSpec.servSpecId;
						var param = CacheData.getExcDepServParam(prodId,servSpecId);
						if(param.orderedServSpecIds.length == 0){
//							AttachOffer.addOpenServList(prodId,servSpecId,servSpec.servSpecName,servSpec.ifParams);
						}else{
							var data=query.offer.queryExcludeDepend(param);//查询规则校验
							var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);
							if(content!=""){
								content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);
								globContent+=(content+"<br>");
							}
						}
				}
			});
		});
		return globContent;
	};
	
	//转换接口返回的互斥依赖
	var paramObj = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
	};
	//解析服务互斥依赖
	var paserServDataByObjs = function(result,prodId,serv,newSpec){
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + this.servSpecName + "<br>";
					paramObj.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				if(!AttachOffer.filterServ(this.servSpecId,newSpec)){
					content += "需要开通：   " + this.servSpecName + "<br>";
					paramObj.dependServ.push(this);
				}
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				if(!AttachOffer.filterServ(this.servSpecId,newSpec)){
					content += "需要开通：   " + this.servSpecName + "<br>";
					paramObj.relatedServ.push(this);
				}
			});
		}
		return content;
	};
	
	//去重，把互斥依赖里面的信息进行去重处理
	var _filterServ=function(servSpecId,newSpec){
		var flag=false;
		$.each(newSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objType==4 && this.selQty==1){
					if(servSpecId==this.objId){
						flag=true;
						return false;
					}
				}
			});
		});
		if(!flag){
			if(ec.util.isArray(paramObj.dependServ)){
				for(var i=0;i<paramObj.dependServ.length;i++){
					if(servSpecId==paramObj.dependServ[i].servSpecId){
						flag=true;
						break;
					}
				}
			}
			if(!flag){
				if(ec.util.isArray(paramObj.relatedServ)){
					for(var i=0;i<paramObj.relatedServ.length;i++){
						if(servSpecId==paramObj.relatedServ[i].servSpecId){
							flag=true;
							break;
						}
					}
				}
			}
		}
		return flag;
	};
	
	//销售品角色成员对象是中 minQty大于0的话 就必须设置其为不能删除（暂定）
	var _minQtyFileter=function(prodId,servSpecId){
		//从已开通功能产品中找
		var serv = CacheData.getServBySpecId(prodId,servSpecId); 
		var $li;
		if(serv != undefined){
			$li=$("#li_"+prodId+"_"+serv.servId);
		}else{
			$li=$("#li_"+prodId+"_"+servSpecId);
		}
		if($li!=undefined){
			$li.find(".delete").remove();
			$li.append('<dd class="mustchoose"></dd>');	
		}
	};
	
	/**
	 * 判断 该合约是否满足被订购的条件：主套餐成员实例数据小于最小终端数，需要进行提示，不允许受理
	 */
	var _manyPhoneFilter=function(prodId,offerSpecId){
			if(OrderInfo.actionFlag==14){
				return true;
			}
			var newSpec;
			var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
			if(ec.util.isObj(offer)){
				newSpec=offer;
			}else{
				newSpec = _setSpec(prodId,offerSpecId);
			}
			if(newSpec==undefined){
				return false;
			}
			if(ec.util.isArray(newSpec.agreementInfos)){
				var num=0;
				if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag == 6){
					$.each(OrderInfo.offerSpec.offerRoles,function(){
					$.each(this.prodInsts,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD){
							num++;
						}
						});
					});
				}else if(OrderInfo.actionFlag == 2 || OrderInfo.actionFlag == 3){
					$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
						if(this.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
							num++;
						}
					});
				}else if(OrderInfo.actionFlag == 21){
					$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
						if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==prodId){  //接入类产品
							num++;
						}
					});
				}
				
				var minNum=newSpec.agreementInfos[0].minNum;
				var maxNum=newSpec.agreementInfos[0].maxNum;
				if(!ec.util.isObj(minNum)){
					$.alert("信息提示","销售品规格查询，未返回最小合约数，请后台确认。");
					return false;
				}
				if(num<minNum){
					$.alert("信息提示","该合约的最小合约数为"+minNum+"个，而该套餐的成员实例只有"+num+"个，故无法办理该合约。");
					return false;
				}
				if(maxNum>num){
					newSpec.agreementInfos[0].maxNum=num;//取最小的一个为最大终端数
				}
//				var terminalMinNum=0;
//				var terminalMaxNum=0;
//				$.each(newSpec.agreementInfos,function(){
//					$.each(this.terminalGroups,function(){
//						terminalMinNum+=this.terminalMinNum;
//						terminalMaxNum+=this.terminalMaxNum;
//					});
//				});
//				if(minNum>terminalMaxNum){
//					$.alert("信息提示","该合约的终端配置有问题，最小合约数大于组内最大值之和，请配置组核查。");
//					return false;
//				}
//				if(maxNum<terminalMinNum){
//					$.alert("信息提示","该合约的终端配置有问题，最大合约数小于组内最小值之和，请配置组核查。");
//					return false;
//				}
			}
		return true;
	};
	
	//添加终端
	var _addAndDelTerminal=function(obj){
		var prodId=$(obj).attr("prodId");
		var offerSpecId=$(obj).attr("offerSpecId");
		var fag=$(obj).attr("fag");
		var newSpec;
		var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
		if(ec.util.isObj(offer)){
			newSpec=offer;
		}else{
			newSpec = _setSpec(prodId,offerSpecId);
		}
		var objInstId = prodId+'_'+newSpec.offerSpecId;
//		var terminalMaxNum=0;
//		var terminalMinNum=0;
//		$.each(newSpec.agreementInfos,function(){
//			$.each(this.terminalGroups,function(){
//				if(this.terminalGroupId==terminalGroupId){
//					terminalMaxNum=this.terminalMaxNum;
//					terminalMinNum=this.terminalMinNum;
//					return false;
//				}
//			});
//		});
		var maxNum=newSpec.agreementInfos[0].maxNum;
		var minNum=newSpec.agreementInfos[0].minNum;
//		$("li[id=^terminalDesc_"+terminalGroupId+"]");
//		var $ul=$(obj).parent().parent();ul_"'+objInstId+'
		var $ul=$("#ul_"+objInstId);
		var $li=$("#ul_"+objInstId+" li");
		var length=$li.length-1;
//		var $liPre=$("li[id=^terminalDesc_"+terminalGroupId+"]")
//		var length=$("li[id=^terminalDesc_"+terminalGroupId+"]").length;
		var isFastOffer = 0 ;
		if(ec.util.isArray(newSpec.extAttrParams)){
			$.each(newSpec.extAttrParams,function(){
				if(this.attrId == CONST.OFFER_FAST_FILL){
					isFastOffer = 1;
					return false;
				}
			});
		}
		if(fag==0){//添加终端
			if(totalNums>=maxNum){
				$.alert("信息提示","终端数已经达到最大，不能再添加了。");
				return;
			}
//			if(terminalMaxNum==(length/2)){
//				$.alert("信息提示","终端数已经达到最大，不能再添加了。");
//				return;
//			}
			var $liTerminalAdd=$('<li><label>终端校验：</label><input id="terminalText_'+objInstId+'_'+(length/2+1)+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />'
					+'<input id="terminalBtn_'+objInstId+'_'+(length/2+1)+'" type="button" flag="'+isFastOffer+'" num="'+(length/2+1)+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" value="校验" class="purchase" style="float:left"></input></li>');
			var $liAdd = $('<li id="terminalDesc_'+(length/2+1)+'" style="white-space:nowrap;"><label></label><label id="terminalName_'+(length/2+1)+'"></label></li>');
			
			$ul.append($liTerminalAdd).append($liAdd);
			totalNums++;
		}else{//删除终端
			if(minNum==(length/2)){
				$.alert("信息提示","终端数已经达到最小，不能再删除了。");
				return;
			}
			$li.each(function(index){
				if(length-1==index){
					$(this).remove();
				}else if(length==index){
					_filterAttach2Coupons(prodId,offerSpecId,(index/2));
					$(this).remove();
				}
				
			});
			totalNums--;
		}
	};
	
	//判断同一个终端组里面是否串码有重复的
	var _checkData=function(objInstId,terminalCode){
		var $input=$("input[id^=terminalText_"+objInstId+"]");
		var num=0;
		$input.each(function(){//遍历页面上面的串码输入框，为的是跟缓存里面的串码进行比对
			var instCode=$.trim(this.value);//页面上面的串码
			if(ec.util.isObj(instCode)&&terminalCode==instCode){
				num++;
			}
		});
		if(num>=2){
			$.alert("信息提示","终端串码重复了，请填写不同的串码。");
			return true ; 
		}
		return false;
	};
	
	//过滤 同一个串码输入框校验多次，如果之前有校验通过先清空
	var _filterAttach2Coupons=function(prodId,offerSpecId,num){
		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
			var attach2Coupon = OrderInfo.attach2Coupons[i];
			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId&&attach2Coupon.num==num){
				OrderInfo.attach2Coupons.splice(i,1);
				$("#terminalName_"+num).html("");
				break;
			}
		}
	};
	
	//清空同一个产品下的同一个销售品的串码缓存信息
	var _removeAttach2Coupons=function(prodId,offerSpecId){
		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
			var attach2Coupon = OrderInfo.attach2Coupons[i];
			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId){
				OrderInfo.attach2Coupons.splice(i,1);
				i--;
			}
		}
	};
	
	//判断是否是重复订购的逻辑
	var _ifOrderAgain=function(newSpec){
		if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){
			if(parseInt(newSpec.orderCount)<newSpec.counts){
//				var $specAgain = $('#li_'+prodId+'_'+offerSpecId+'_'+newSpec.ifOrderAgain); //在已开通附属里面
//				$specAgain.remove();
				$.alert("信息提示","可选包："+newSpec.offerSpecName+"至多只能订购"+newSpec.orderCount+"次");
				return true;
			}
		}
	};
	
	//1表示从已订购那边过来的
	var _setParam=function(prodId,offerSpecId,flag){
		var newSpec = _setSpec(prodId,offerSpecId);  //没有在已选列表里面
		var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
		if(flag==1){
			newSpec.counts=offer.counts;
		}
		var content = '<form id="paramForm">' ;
		content += "次数" + ' : <input id="text_'+prodId+'_'+offerSpecId  
		+'" class="inputWidth183px" type="text" value="'+newSpec.counts+'"><br>'; 
		content +='</form>' ;
		$.confirm("参数设置： ",content,{ 
			yes:function(){
			},
			no:function(){
			}
		});
		$('#paramForm').bind('formIsValid', function(event, form) {
			var nums=$("#text_"+prodId+"_"+offerSpecId).val();
			var reg = /^\+?[1-9][0-9]*$/;//正整数
			if(!reg.test(nums)){
				$.alert("信息提示","次数只能是正整数。");
				return;
			}
//			if(flag==1&&offer.orderCount>nums){
//				$.alert("信息提示","可选包【"+newSpec.offerSpecName+"】不允许退订！");
//				return;
//			}
			if(parseInt(newSpec.orderCount)<nums){
				$.alert("信息提示","可选包【"+newSpec.offerSpecName+"】至多只能订购"+newSpec.orderCount+"次");
				return;
			}
			if(flag==1 && offer!=undefined){
				if(offer.orderCount>nums){//退订附属销售品
					if(!ec.util.isArray(offer.offerMemberInfos)){//销售品实例查询	
						var param = {
								prodId:prodId,
								areaId: OrderInfo.getProdAreaId(prodId),
								offerId:offer.offerId	
						};
						param.acctNbr = OrderInfo.getAccessNumber(prodId);
						var data = uiOfferQuery.queryOfferInst(param);
						if(data==undefined){
							return;
						}
						offer.offerMemberInfos = data.offerMemberInfos;
						offer.offerSpec = data.offerSpec;
					}
				}
				offer.counts=nums;
			}else{
				newSpec.counts=nums;
			}
			$(".ZebraDialog").remove();
			$(".ZebraDialogOverlay").remove();
		}).ketchup({bindElementByClass:"ZebraDialog_Button1"});	
	};
	
	var _offerSpecDetail=function(prodId,offerSpecId){
		var offerSpecName ="";
		var summary = "";
		$.each(AttachOffer.allOfferList,function(){
			if(this.offerSpecId == offerSpecId){
				offerSpecName = this.offerSpecName;
				summary = this.summary;
			}else if(this.servSpecId == offerSpecId){
				offerSpecName = this.servSpecName;
				summary = this.summary;
			}
		});
		$('#detail_tbody').empty();
		var $tr = $('<tr></tr>');
		//var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"><td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td></tr>');
		$tr.append('<td>'+offerSpecName+'</td><td width="900">'+summary+'</td>');
		$('#detail_tbody').append($tr);
		easyDialog.open({
			container : "div_detail_dialog"
		});
	};
	//已订购的附属销售品查询
	var _queryCardAttachOffer = function(cardTypeFlag) {
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		var prodId = prodInfo.prodInstId;
		var param = {
		    prodId : prodId,
		    prodSpecId : prodInfo.productId,
		    offerSpecId : prodInfo.prodOfferId,
		    acctNbr : prodInfo.accNbr
		};
		if(ec.util.isObj(prodInfo.prodBigClass)){
			param.prodBigClass = prodInfo.prodBigClass;
		}
		
		var data = uiOfferQuery.queryAttachOfferHtml(param);
	//	SoOrder.initFillPage();
		$("#attach").html(data).show();
		//var member = CacheData.getOfferMember(prodId);
		//如果objId，objType，objType不为空才可以查询默认必须
		//if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){
            var temp = {   
				boActionTypeCd : '14',
				cardType : cardTypeFlag=="1"?"4G":"3G",
				accNbr: prodInfo.accNbr,
				prodInstId : prodId,
				prodId : prodId,
				prodSpecId : prodInfo.productId
			};
			//默认必须可选包和功能产品
			var data = query.offer.queryDefMustOfferSpecAndServ(temp);
			CacheData.parseOffer(data);
			CacheData.parseServ(data);
		//}
		if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){ //主套餐下的成员判断
			var member = CacheData.getOfferMember(prodId);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(this.offerRoleId==member.offerRoleId && member.objType==CONST.OBJ_TYPE.PROD){
					var offerRole = this;
					$.each(this.roleObjs,function(){
						if(this.objType==CONST.OBJ_TYPE.SERV){
							var serv = CacheData.getServBySpecId(prodId,this.objId);//从已订购功能产品中找
							if(serv!=undefined){ //不在已经开跟已经选里面
								var $oldLi = $('#li_'+prodId+'_'+serv.servId);
								if(this.minQty==1){
									$oldLi.append('<dd class="mustchoose"></dd>');
								}
								$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
							}
						}
					});
					return false;
				}
			});
		}
		//AttachOffer.changeLabel(prodId, prodInfo.productId,""); //初始化第一个标签附属
		//order.dealer.initDealer();
	};
	
	
	//uim卡号释放
	var _releaseUim = function(prodId){	
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}

		//释放UIM并更新门户记录
		var param = {
			numType : 2,
			numValue : cardNo
		};
		var jr = $.callServiceAsJson(contextPath+"/app/mktRes/phonenumber/releaseErrorNum", param);			
		if(jr.code==-2){
			$.alertM(jr.data);
			return;
		}
		if(jr.code==-1){
			$.alert("提示",jr.data);
			return;
		}
		//$.alert("提示","成功释放UIM卡："+cardNo);
		
		if(OrderInfo.actionFlag==22){
			$('#attach').children().remove();
	    }
		$("#uim_check_btn_"+prodId).attr("disabled",false);
		//$("#uim_check_btn_"+prodId).removeClass("disablepurchase").addClass("purchase");
		$("#uim_release_btn_"+prodId).attr("disabled",true);
		//$("#uim_release_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
		$("#uim_txt_"+prodId).attr("disabled",false);
		$("#uim_txt_"+prodId).val("");
		OrderInfo.clearProdUim(prodId);
	};
	
	//uim卡号校验
	var _checkUim = function(prodId){
		var phoneNumber = OrderInfo.getAccessNumber(prodId);
		var offerId = "-1"; //新装默认，主销售品ID
		if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){ //新装需要选号
			if(phoneNumber==''){
				$.alert("提示","校验UIM卡前请先选号!");
				return false;
			}
		}
		if(OrderInfo.actionFlag==3 || OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23 || OrderInfo.actionFlag==6 ){ //可选包变更，补换卡，加装副卡
			if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//判断是否是纳入老用户
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.prodInstId==prodId){
						offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
					}
				});
			}else{
				offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
			}
		}
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}
		var inParam = {
			"instCode" : cardNo,
			"phoneNum" : phoneNumber,
			"areaId"   : OrderInfo.getProdAreaId(prodId)
//			"areaId"   : '8320102'
		};

		var prodSpecId = OrderInfo.getProdSpecId(prodId);
		var mktResCd="";
		if(CONST.getAppDesc()==0){
			if(getIsMIFICheck(prodId)){
				mktResCd =getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID);
			}else{
				mktResCd = getMktResCd(prodSpecId);
			}
			if(ec.util.isObj(mktResCd)){
//				inParam.mktResCd = mktResCd;
			}else{
				$.alert("提示","查询卡类型失败！");
				return;
			}
			if(OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23){ //补换卡和异地补换卡
				if(prod.changeUim.is4GProdInst){ //如果已办理4G业务，则校验uim卡是否是4G卡
					inParam.onlyLTE = "1";
				}
			}
		}
		var data = _checkUimSub(inParam,prodId);//校验uim卡
		if(data==undefined || data.baseInfo==undefined){
			return false;
		}
		//根据uim返回数据组织物品节点
		var couponNum = data.baseInfo.qty ;
		if(couponNum==undefined||couponNum==null){
			couponNum = 1 ;
		}
		var coupon = {
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "1",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId : data.baseInfo.mktResId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : "3000", //物品费用项类型
			couponNum : couponNum, //物品数量
			storeId : data.baseInfo.mktResStoreId, //仓库ID
			storeName : "1", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : data.baseInfo.mktResInstCode, //物品实例编码
			terminalCode : data.baseInfo.mktResInstCode,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId :  prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "ADD", //动作
			relaSeq : "" //关联序列	
		};
		if(CONST.getAppDesc()==0){
			coupon.cardTypeFlag=data.baseInfo.cardTypeFlag;//UIM卡类型
		}
		$("#uim_check_btn_"+prodId).attr("disabled",true);
		//$("#uim_check_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
		//$("#uim_release_btn_"+prodId).attr("disabled",false);
		$("#uim_release_btn_"+prodId).removeClass("disabled");
		$("#uim_txt_"+prodId).attr("disabled",true);
		if(getIsMIFICheck(prodId)){//判断是否通过MIFI 校验
			$("#isMIFI_"+prodId).val("yes");
		}else{
			$("#isMIFI_"+prodId).val("no");
		}
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
		if(OrderInfo.actionFlag==22 && data.baseInfo.cardTypeFlag==1){
		//	_queryAttachOffer();
		  AttachOffer.queryCardAttachOffer(data.baseInfo.cardTypeFlag);  //加载附属销售品
	    }
	};
	
	var getMktResCd = function(prodSpecId){
		var param={
			"prodSpecId":prodSpecId
		};
		var url = contextPath+"/mktRes/uim/getMktResCd";
		$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == "0") {
			return response.data;
		}else{
			return "";
		}
	};
	
	/*
	 * 是否是MIFI卡类型校验
	 */
	var getIsMIFICheck=function(prodId){
		var prodIdTmp=(Math.abs(prodId)-1);
		if(AttachOffer.openServList.length>prodIdTmp){
			var specList = AttachOffer.openServList[prodIdTmp].servSpecList;
			for (var j = 0; j < specList.length; j++) {
				var spec = specList[j];
				if(spec.isdel!="Y" && spec.isdel!="C"){
					if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID && CONST.APP_DESC==0){
						return true ; 
					}
				}
			}
		}
		return false;
	};
	
	var _checkUimSub=function(param,prodId){
		var url = contextPath+"/app/mktRes/uim/checkUim";
		$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == 0) {
			isRightCheck="Y";
			//$.alert("提示","UIM卡校验成功!");
			
			//校验成功后，修改按钮class属性数据
			$("#uim_check_btn_"+prodId).removeAttr("class");
												
			$("#uim_check_btn_"+prodId).attr("class","disablepurchase");	
			
			$("#uim_check_btn_"+prodId).attr("disabled","disabled");	
			
			//修改释放按钮的展示
			$("#uim_release_btn_"+prodId).removeAttr("class");
			
			$("#uim_release_btn_"+prodId).removeAttr("disabled");
			
			$("#uim_release_btn_"+prodId).attr("class","purchase");	
			
			return response.data;
		}else{
			if(typeof response == undefined){
				$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常");
			}else if (response.code == -2) {
				$.alertM(response.data);
			}else{
				var msg="";
				if(response.data!=undefined && response.data.msg!=undefined){
					msg=response.data.msg;
				}else{
					msg="卡号["+cardNo+"]预占失败";
				}
				$.alert("提示","UIM卡校验失败，可能原因:"+msg);
			}
		}
	};
	
	return {
		addOffer 				: _addOffer,
		addOfferSpec 			: _addOfferSpec,
		addOpenList				: _addOpenList,
		addOpenServList			: _addOpenServList,
		addOfferSpecByCheck		: _addOfferSpecByCheck,
		addAndDelTerminal		: _addAndDelTerminal,
		closeAttachSearch 		: _closeAttachSearch,
		changeLabel				: _changeLabel,
		changeList				: _changeList,
		closeServ				: _closeServ,
		closeServSpec			: _closeServSpec,
		checkData				: _checkData,
		delOffer				: _delOffer,
		delOfferSpec			: _delOfferSpec,
		labelList				: _labelList,
		isChangeUim				: _isChangeUim,
		init					: _init,
		openList				: _openList,
		openedList				: _openedList,
		openServList			: _openServList,
		openedServList 			: _openedServList,
		openServSpec			: _openServSpec,
		openAppList				: _openAppList,
		queryAttachOffer 		: _queryAttachOffer,
		queryAttachOfferSpec 	: _queryAttachOfferSpec,
		queryCardAttachOffer    : _queryCardAttachOffer,
		showParam 				: _showParam,
		showServParam			: _showServParam,
		showTime				: _showTime,
		setAttachTime			: _setAttachTime,
		searchAttachOfferSpec   : _searchAttachOfferSpec,
		selectAttachOffer		: _selectAttachOffer,
		showOfferTime			: _showOfferTime,
		showMainParam			: _showMainParam,
		showMainMember			: _showMainMember,
		selectServ				: _selectServ,
		showStartTime			: _showStartTime,
		showEndTime			    : _showEndTime,
		setAttachBusiOrder		: _setAttachBusiOrder,
		showApp					: _showApp,
		showHideUim				: _showHideUim,
		showMainRoleProd		: _showMainRoleProd,
		checkTerminalCode		: _checkTerminalCode,
		checkOfferExcludeDepend	: _checkOfferExcludeDepend,
		checkServExcludeDepend	: _checkServExcludeDepend,
		servExDepReByRoleObjs	: _servExDepReByRoleObjs,
		setChangeList			: _setChangeList,
		reductionChangList		: _reductionChangList,
		filterServ				: _filterServ,
		setParam				: _setParam,
		showMainMemberRoleProd	: _showMainMemberRoleProd,
		offerSpecDetail         : _offerSpecDetail
	};
})();
/**
 * 客户资料管理
 */
CommonUtils.regNamespace("order", "uiCust");

order.uiCust = (function(){
	
	var _choosedCustInfo = {};
	
	var createCustInfo = {};
	
	var custInfo = null;
	
	var authFlag = null;
	
	var _fromProvFlag = "0"; //省份甩单标志
	
	var _provIsale = null; //省份isale流水号
	
	var g_query_cust_infos = [];
	
	//客户鉴权跳转权限
	var _jumpAuthflag="";
	
	//客户属性
	var _partyProfiles =[];
	
	//客户属性分页列表
	var _profileTabLists =[];
	
	var _tmpChooseUserInfo = {};
	
	var _queryForChooseUser = false;
	
	var _packageInfo={
		provIsale:"",
		redirectUri:"",
		isFee:"",
		reloadFlag:""
	}

	var _orderInfo;
	
	var showDialogInfo=function(content){
		$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>"+content+"</div>");
	}
	
	var _showPackageDialog=function(msg){
		var html="<table class=\"contract_list rule\">";
		html+='<thead><tr> <td colspan="2">提示</td></tr></thead></table>';
		html+="<div id=\"rules_div\" height=\"height:140px;\">";
		html+='<table width="100%" height="120px;" border="0" cellspacing="0" cellpadding="0">';
		html+='<tr>';
		html+='<td align="right"></td>';
		html+="<td><div class=\"rule_font\" style=\"width:100%;font-size:15px; text-align:center;\">"+msg+"</div></td>";
		html+='</tr>';
		html+='</table>';
		html+='</div>';
		easyDialog.open({
			container : 'packageTip_dialog'
		});
		$("#infoTipContent").html("");
		$("#infoTipContent").html(html);
	};
	
	var _custQuery=function(){
		//开始可选包前进行重载校验 
		var isReload=_packageInfo.reloadFlag;

		if(isReload=="N"){
			if(order.uiCust.orderInfo==null || order.uiCust.orderInfo=="" || order.uiCust.orderInfo=="undefined"){
				_showPackageDialog("二次加载数据信息丢失!");
				return;
			}
			
			var resultCode=order.uiCust.orderInfo.resultCode;
			
			var resultMsg=order.uiCust.orderInfo.resultMsg;
			
			if(resultCode==null || resultCode=="" || resultCode=="undefined"){
				_showPackageDialog("二次加载数据信息丢失!");
				return;
			}
			
			if(order.uiCust.orderInfo.result.orderList==null || order.uiCust.orderInfo.result.orderList==""){
				_showPackageDialog(resultMsg);
				return;
			}
		
			var custOrderAttrs =order.uiCust.orderInfo.result.orderList.orderListInfo.custOrderAttrs;
			
			var isRight="0";
			
			$.each(custOrderAttrs,function(){
				if(this.itemSpecId=="30010024"){
					if(this.value!="14"){
						isRight="1";
					}
				}
			});
			
			if(isRight=="1"){
				_showPackageDialog("不是可选包变更受理流水号，请重试!");
				return;
			}
			
			if(resultCode=="-1" || resultCode=="2"){
				_showPackageDialog(resultMsg);
				return;
			}
		}
		
		var url=contextPath+"/order/createorderlonger";
		var response = $.callServiceAsJson(url, {});
		if(response.code==0){
			OrderInfo.custorderlonger=response.data;
		}
		var identityCd="";
		var idcard="";
		var diffPlace="";
		var acctNbr="";
		var identityNum="";
		var queryType="";
		var queryTypeValue="";
		identityCd=$("#p_cust_identityCd").val();
		identityNum=iacc_nbr;
		//判断是否是号码或身份证输入

		//省份甩单定位客户不需要进行客户鉴权
		if(order.cust.fromProvFlag == "1" || (identityCd!=-1 && CONST.getAppDesc()!=0)){
			identityCd=$("#p_cust_identityCd").val();
			authFlag="1";
		}else{
			//4G所有证件类型定位都需要客户鉴权
			authFlag="0";
		}
		
		if(identityCd==-1){
			acctNbr=identityNum;
			identityNum="";
			identityCd="";
		}else if(identityCd=="acctCd"||identityCd=="custNumber"){
			acctNbr="";
			identityNum="";
			identityCd="";
			queryType=$("#p_cust_identityCd").val();
			queryTypeValue=$.trim($("#p_cust_identityNum").val());
		}
		
		diffPlace=$("#DiffPlaceFlag").val();
		
		//原来地市是获取员工默认地市
		//areaId=$("#p_cust_areaId").val();
		
		//现在修改为使用省份传输地市
		areaId=$("#custAreaId_").val();
		
		if(areaId==null || areaId=="" || areaId=="null" || areaId=="undefined"){
			_showPackageDialog("用于客户定位的地市为空，请重试!");
			return;
		}
		
		//lte进行受理地区市级验证
		if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){
			_showPackageDialog("省级地区无法进行定位客户,请选择市级地区!");
			return;
		}
		
		var param = {
				"acctNbr":acctNbr,
				"identityCd":identityCd,
				"identityNum":identityNum,
				"partyName":"",
				"custQueryType":$("#custQueryType").val(),
				"diffPlace":diffPlace,
				"areaId" : areaId,
				"queryType" :queryType,
				"queryTypeValue":queryTypeValue,
				"identidies_type":$("#p_cust_identityCd  option:selected").text()
		};
		$.callServiceAsHtml(contextPath+"/cust/queryCustSub",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询客户信息中,请稍候...</strong>");
			},"done" : function(response){
				if (response.code == -2) {
					return;
				}
				_queryCallBack(response);
			},fail:function(response){
				$.unecOverlay();
				_showPackageDialog("查询失败，请稍后再试!");
			},"always":function(){
				$.unecOverlay();
				$("#usersearchbtn").attr("disabled",false);
			}
		});
	}

	//客户查询列表
	var _queryCallBack = function(response) {
		if(response.data.indexOf("showVerificationcode") >=0) {
			$("#vali_code_input").val("");
			$('#validatecodeImg').css({"width":"80px","height":"32px"}).attr('src',contextPath+'/validatecode/codeimg.jpg?' + Math.floor(Math.random()*100)).fadeIn();
			easyDialog.open({
				container : 'Verificationcode_div'
			});
			return;
		}
		if(response.data.indexOf("false") >=0) {
			_showPackageDialog("抱歉,没有定位到客户,请尝试其他客户");
			return;
		}
		var content$ = $("#custList");
		content$.html(response.data).show();
		$(".userclose").off("click").on("click",function(event) {
			authFlag="";
			$(".usersearchcon").hide();
		});
		if($("#custListTable").attr("custInfoSize")=="1"){
			$(".usersearchcon").hide();
		}
		
		//_showCustAuth($("#custInfos"));
	}
	
	//展示客户验证窗口，这里不需要，但是还是需要这个环节，弹出后马上关闭
	var _showCustAuth = function(scope) {
		$("#main_div_1").show();
		
		_choosedCustInfo = {
			custId : $(scope).find("td:eq(3)").text(),
			partyName : $(scope).find("td:eq(0)").text(),
			idCardNumber : $(scope).find("td:eq(4)").text(),
			identityName : $(scope).attr("identityName"),
			areaName : $(scope).attr("areaName"),
			areaId : $(scope).attr("areaId"),
			identityCd :$(scope).attr("identityCd"),
			addressStr :$(scope).attr("addressStr"),
			norTaxPayer :$(scope).attr("norTaxPayer"),
			segmentId :$(scope).attr("segmentId"),
			segmentName :$(scope).attr("segmentName"),
			custFlag :$(scope).attr("custFlag"),
			vipLevel :$(scope).attr("vipLevel"),
			vipLevelName :$(scope).attr("vipLevelName")
		};
		if(order.cust.queryForChooseUser && _choosedCustInfo.segmentId != 1100){
			_showPackageDialog("使用人必须是公众客户，请重新定位");
			return false;
		}
		if(authFlag=="0"){
			if(order.cust.authType == '00'){
				$("#custAuthTypeName").html("客户密码：");
			} else {
				$("#custAuthTypeName").html("产品密码：");
			}
			var pCustIdentityCd = $("#p_cust_identityCd").val();
			if("1"==pCustIdentityCd){
				$('#authIDTD').attr("disabled",false);//身份鉴权的身份证在读卡时被禁用，此处启用
				easyDialog.open({
					container:'authID',
					callback : function(){
						order.cust.queryForChooseUser = false; //关闭弹出框时重置标识位
					}
				});
			}else{
				easyDialog.open({
					container : 'auth',
					callback : function(){
						order.cust.queryForChooseUser = false; //关闭弹出框时重置标识位
					}
				});
				
				_jumpAuth();
			}
			if(order.cust.jumpAuthflag=="0"){
				$("#jumpAuth").off('click').on('click', function(){
					order.cust.jumpAuth();
				});
				$("#jumpAuth").show();
				$("#jumpAuthID").show();
			}
			$("#authClose").off("click").on("click",function(event){
				easyDialog.close();
				$("#authPassword").val("");
			});
			$("#authIDClose").off("click").on("click",function(event){
				easyDialog.close();
				$("#authIDTD").val("");
			});
		} else{
			_custAuth(scope);
		}
		
	};
	
	//跳过验证权限
	var _jumpAuth = function() {
		//正常是要验证权限，这里就不需要了
//		if(order.cust.jumpAuthflag!="0"){
//			$.alert("提示","没有跳过校验权限！");
//			return;
//		}
		var param = _choosedCustInfo;
		param.authFlag="1";
		$.callServiceAsHtml(contextPath+"/cust/custAuthSub",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					_showPackageDialog("客户鉴权失败,稍后重试!");
					return;
				}
				
				if(!order.cust.queryForChooseUser){
					custInfo = param;
					OrderInfo.boCusts.prodId=-1;
					OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
					OrderInfo.boCusts.partyProductRelaRoleCd="0";
					OrderInfo.boCusts.state="ADD";
					OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
					
					OrderInfo.cust = _choosedCustInfo;
					_custAuthCallBack(response);
				} else {
					//鉴权成功后显示选择使用人弹出框
					order.main.showChooseUserDialog(param);
				}
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	// cust auth callback
	var _custAuthCallBack = function(response) {
		if(authFlag=="0"){
			easyDialog.close();
		}
		$("#custList").hide();
		$("#custQryDiv").hide();
		if($.ketchup)
			$.ketchup.hideAllErrorContainer($("#custCreateForm"));
		var content$ = $("#custInfo");
		content$.html(response.data).show();
		if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){
			$("#custModifyId").attr("style","display: none;");
		}else{
			$("#custModifyId").attr("style","");
		}
		$("#cCustName").val("");
		$("#cCustIdCard").val("");
		main.home.hideMainIco();
		
		_btnQueryCustProdMore();
	};
	
	//点击已经订购业务开始start
	var _btnQueryCustProdMore=function(param){
		
		if(OrderInfo.cust.custId==-1){
			_showPackageDialog("新建客户无法查询已订购产品!");
			return;
		}
		
		var curPage=1;
		
		$("#prodDetail").hide();
		$("#prodInfo").hide();
		$("#prodList").hide();//原来是show的，这里不展示
		//$("#orderedprod").show();
		$("#orderContent").show();
		if(order.cust.orderBtnflag==""){//初次查询
			//隐藏菜单
			main.home.hideMainIco();
			_btnQueryCustProd(curPage);
			$("#orderedprod").hide();//原来是show的，这里不展示，改为hide
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
			
			$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");
			$("#orderbutton").css({"height":"35px","border-bottom":"1px solid #fff"});
			$("#orderbutton span").css({"color":"#327501"});
			order.cust.orderBtnflag="1";
		}else if(order.cust.orderBtnflag=="0"||$("#orderedprod").is(":hidden")){
			$("#orderedprod").show();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
			
			$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");
			$("#orderbutton").css({"height":"35px","border-bottom":"1px solid #fff"});
			$("#orderbutton span").css({"color":"#327501"});
			order.cust.orderBtnflag="1";
			
		}else{
			$("#orderedprod").hide();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrow");
			order.cust.orderBtnflag="0";
			$("#orderbutton").css({"height":"24px","border-bottom":"1px solid #4f7d3f"});
		}
		/*$("#orderbutton").off("click").on("click",function(event){_btnQueryPhoneNumber();event.stopPropagation();});*/
	};
	
	//已订购业务第二步
	var _btnQueryCustProd=function(curPage){
		//收集参数
		var param={};
		if(_choosedCustInfo==null){
			param.custId="";
		}else{
			param.custId=_choosedCustInfo.custId;
			param.areaId =$("#area").attr("areaId");
		}
		
		if(document.getElementById("accNbrQuery")){
			param.acctNbr=$.trim($("#accNbrQuery").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
			
		} else if($("#isAppointNum").attr("checked")=="checked"){
			param.acctNbr=$.trim($("#p_cust_identityNum").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
		}else {
			param.acctNbr="";
		}
		
		//获取查询号码new
		param.acctNbr=$("#phoneNum_").val();
		
		if(document.getElementById("custPageSize")){
			param.pageSize=$.trim($("#custPageSize").val());
			if(!(/^[1-9]\d*$/.test(param.pageSize))&&(param.pageSize!="")){
				//页码格式不正确，必须为有效数字
				_showPackageDialog("获取页面信息失败,请稍后再试!");
				return false;
			}
			if(param.pageSize>15){
				//页数大小不能超过15
				_showPackageDialog("获取页面信息失败,请稍后再试!");
				return false;
			}
		}else {
			param.pageSize="";
		}
		param.curPage=curPage;
		param.DiffPlaceFlag=$("#DiffPlaceFlag").val();
		if(param.custId==null||param.custId==""){
			_showPackageDialog("无法查询已订购产品,查询失败!");
			//$.alert("提示","无法查询已订购产品");
			return;
		}
		
		//请求地址,查询产品列表
		var url = contextPath+"/cust/orderprodSub";//原地址是/cust/orderprod
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>';
				}
				if (response.code == -2) {
					return;
				}else if(response.code != 0) {
					if(response.msg!=null && response.msg!=""){
						_showPackageDialog(response.msg);
					}else{
						_showPackageDialog("查询信息失败,请稍后重试!");
					}
					//$.alert("提示","查询失败,稍后重试");
					return;
				}
				var content$=$("#orderedprod");
				content$.html(response.data);
				//_linkSelectPlan("#phoneNumListtbody tr",$("#phoneNumListtbody").children(":first-child"));
				//绑定每行合约click事件
				$("#phoneNumListtbody tr").off("click").on("click",function(event){
					var thisTr=this;
					if(1==OrderInfo.order.step&&(!$(thisTr).hasClass("plan_select"))){
						$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
							yes:function(){
								_cancel();
								_linkQueryOffer(thisTr);
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else if(2==OrderInfo.order.step&&(!$(thisTr).hasClass("plan_select"))){
						$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
							yes:function(){
								SoOrder.orderBack();
								_cancel();
								_linkQueryOffer(thisTr);
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else{
						_linkQueryOffer(this);
					}
					
					});
				
				$("#plan2ndDiv tbody tr").each(function(){$(this).off("click").on("click",function(event){
					var this2Tr=this;
					if(1==OrderInfo.order.step&&(!$(this2Tr).hasClass("plan_select2"))){
						$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
							yes:function(){
								_cancel();
								order.cust.linkSelectPlan(this2Tr);event.stopPropagation();
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else if(2==OrderInfo.order.step&&(!$(this2Tr).hasClass("plan_select2"))){
						$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
							yes:function(){
								SoOrder.orderBack();
								_cancel();
								order.cust.linkSelectPlan(this2Tr);event.stopPropagation();
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else{
						order.cust.linkSelectPlan(this);event.stopPropagation();
					}
					
					
					});});
				
				$("#phoneNumListtbody").children(":first-child").next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();
				$("#phoneNumListtbody").children(":first-child").click();
			}
		});	
	};
	
	/**
	 * 已订购产品查询（选中产品）
	 */
	var _linkQueryOffer=function(selected){
		//3G用户标识
		$("#is3GCheckbox").off().change(function() { 
			order.prodModify.getChooseProdInfo();
			}); 
		//勾取消
		$("#phoneNumListtbody tr").filter(".plan_select").children(":first-child").html("");
		$("#phoneNumListtbody tr").filter(".plan_select")
			.removeClass("plan_select").next("#plan2ndTr").hide();
		$(selected).addClass("plan_select").next("#plan2ndTr").show();
		//打勾操作
		var nike="<i class='select'></i>";
		$(selected).children(":first-child").html(nike);
		
		$(selected).next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();
		
		//产品选择后，跳转到订单填写页面
		order.uiCust.orderAttachOffer();
		
	};
	
	//可选包订购退订
	var _orderAttachOffer = function () {
		OrderInfo.busitypeflag=14;
		$("#main_div_1").show();
		//order.prodModify.orderAttachOffer();
		uiAttachOffer.init();
	};
	
	return {
		custQuery : _custQuery,
		queryCallBack : _queryCallBack,
		btnQueryCustProd : _btnQueryCustProd,
		showCustAuth : _showCustAuth,
		orderInfo : _orderInfo,
		packageInfo : _packageInfo,
		showPackageDialog : _showPackageDialog,
		orderAttachOffer:_orderAttachOffer
	};
})();
$(function() {
//   order.cust.form_valid_init();
//   order.cust.initDic();
});
/**
 * 客户资料管理
 */
CommonUtils.regNamespace("order", "uiCusts");

order.uiCusts = (function(){
	
	var _choosedCustInfo = {};
	
	var createCustInfo = {};
	
	var custInfo = null;
	
	var authFlag = null;
	
	var _fromProvFlag = "0"; //省份甩单标志
	
	var _provIsale = null; //省份isale流水号
	
	var g_query_cust_infos = [];
	
	//客户鉴权跳转权限
	var _jumpAuthflag="";
	
	//客户属性
	var _partyProfiles =[];
	
	//客户属性分页列表
	var _profileTabLists =[];
	
	var _tmpChooseUserInfo = {};
	
	var _queryForChooseUser = false;
	
	var _orderInfo;
	
	var showDialogInfo=function(content){
		$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>"+content+"</div>");
	}
	
	var _showPackageDialog=function(msg){
		var html="<table class=\"contract_list rule\">";
		html+='<thead><tr> <td colspan="2">提示</td></tr></thead></table>';
		html+="<div id=\"rules_div\" height=\"height:140px;\">";
		html+='<table width="100%" height="120px;" border="0" cellspacing="0" cellpadding="0">';
		html+='<tr>';
		html+='<td align="right"></td>';
		html+="<td><div class=\"rule_font\" style=\"width:100%;font-size:15px; text-align:center;\">"+msg+"</div></td>";
		html+='</tr>';
		html+='</table>';
		html+='</div>';
		easyDialog.open({
			container : 'packageTip_dialog'
		});
		$("#infoTipContent").html("");
		$("#infoTipContent").html(html);
	};
	
	var _custQuery=function(){
		//开始可选包前进行重载校验 
	//	var isReload=_packageInfo.reloadFlag;
/*
		if(isReload=="N"){
			if(order.uiCust.orderInfo==null || order.uiCust.orderInfo=="" || order.uiCust.orderInfo=="undefined"){
				_showPackageDialog("二次加载数据信息丢失!");
				return;
			}
			
			var resultCode=order.uiCust.orderInfo.resultCode;
			
			var resultMsg=order.uiCust.orderInfo.resultMsg;
			
			if(resultCode==null || resultCode=="" || resultCode=="undefined"){
				_showPackageDialog("二次加载数据信息丢失!");
				return;
			}
			
			if(resultCode=="-1" || resultCode=="2"){
				_showPackageDialog(resultMsg);
				return;
			}
		}
	*/	
		var url=contextPath+"/order/createorderlonger";
		var response = $.callServiceAsJson(url, {});
		if(response.code==0){
			OrderInfo.custorderlonger=response.data;
		}
		var identityCd="";
		var idcard="";
		var diffPlace="";
		var acctNbr="";
		var identityNum="";
		var queryType="";
		var queryTypeValue="";
		identityCd=$("#p_cust_identityCd").val();
		identityNum=$.trim($("#p_cust_identityNum").val());
		//判断是否是号码或身份证输入

		//省份甩单定位客户不需要进行客户鉴权
		if(order.uiCusts.fromProvFlag == "1" || (identityCd!=-1 && CONST.getAppDesc()!=0)){
			identityCd=$("#p_cust_identityCd").val();
			authFlag="1";
		}else{
			//4G所有证件类型定位都需要客户鉴权
			authFlag="0";
		}
		if(identityCd==-1){
			acctNbr=identityNum;
			identityNum="";
			identityCd="";
		}else if(identityCd=="acctCd"||identityCd=="custNumber"){
			acctNbr="";
			identityNum="";
			identityCd="";
			queryType=$("#p_cust_identityCd").val();
			queryTypeValue=$.trim($("#p_cust_identityNum").val());

		}
		diffPlace=$("#DiffPlaceFlag").val();
		
		//旧客户定位地市是获取工号地市，暂不用
		//areaId=$("#p_cust_areaId").val();
		
		//改为使用参数中的地市进行定位
		areaId=$("#custAreaId_").val();
		
		if(areaId==null || areaId=="" || areaId=="null" || areaId=="undefined"){
			_showPackageDialog("用于客户定位的地市为空，请重试!");
			return;
		}
		
		//lte进行受理地区市级验证
		if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){
			_showPackageDialog("省级地区无法进行定位客户,请选择市级地区!");
			return;
		}
		
		var param = {
				"acctNbr":acctNbr,
				"identityCd":identityCd,
				"identityNum":identityNum,
				"partyName":"",
				"custQueryType":$("#custQueryType").val(),
				"diffPlace":diffPlace,
				"areaId" : areaId,
				"queryType" :queryType,
				"queryTypeValue":queryTypeValue,
				"identidies_type":$("#p_cust_identityCd  option:selected").text()
		};
		
		$.callServiceAsHtml(contextPath+"/token/pc/cust/queryCustSub",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询客户信息中,请稍候...</strong>");
			},"done" : function(response){
				if (response.code == -2) {
					return;
				}
				
				_queryCallBack(response);

			},fail:function(response){
				$.unecOverlay();
				_showPackageDialog("客户定位失败，请稍后再试!");
			},"always":function(){
				$.unecOverlay();
				$("#usersearchbtn").attr("disabled",false);
			}
		});
	}

	//客户查询列表
	var _queryCallBack = function(response) {
		
		if(response.data.indexOf("showVerificationcode") >=0) {
			$("#vali_code_input").val("");
			$('#validatecodeImg').css({"width":"80px","height":"32px"}).attr('src',contextPath+'/validatecode/codeimg.jpg?' + Math.floor(Math.random()*100)).fadeIn();
			easyDialog.open({
				container : 'Verificationcode_div'
			});
		
			return;
		}
		if(response.data.indexOf("false") >=0) {
			_showPackageDialog("抱歉,没有定位到客户,请尝试其他客户");
			return;
		}
		var content$ = $("#custList");
		
		content$.html(response.data).show();
		
		$(".userclose").off("click").on("click",function(event) {
			
			authFlag="";
			$(".usersearchcon").hide();
		});
		if($("#custListTable").attr("custInfoSize")=="1"){
			$(".usersearchcon").hide();
		}
		
		//_showCustAuth($("#custInfos"));
		
	}
	
	//展示客户验证窗口，这里不需要，但是还是需要这个环节，弹出后马上关闭
	var _showCustAuth = function(scope) {

		
		$("#main_div_1").show();
		
		_choosedCustInfo = {
			custId : $(scope).find("td:eq(3)").text(),
			partyName : $(scope).find("td:eq(0)").text(),
			idCardNumber : $(scope).find("td:eq(4)").text(),
			identityName : $(scope).attr("identityName"),
			areaName : $(scope).attr("areaName"),
			areaId : $(scope).attr("areaId"),
			identityCd :$(scope).attr("identityCd"),
			addressStr :$(scope).attr("addressStr"),
			norTaxPayer :$(scope).attr("norTaxPayer"),
			segmentId :$(scope).attr("segmentId"),
			segmentName :$(scope).attr("segmentName"),
			custFlag :$(scope).attr("custFlag"),
			vipLevel :$(scope).attr("vipLevel"),
			vipLevelName :$(scope).attr("vipLevelName")
		};
		if(order.uiCusts.queryForChooseUser && _choosedCustInfo.segmentId != 1100){
			_showPackageDialog("使用人必须是公众客户，请重新定位");
			return false;
		}
		if(authFlag=="0"){
			if(order.cust.authType == '00'){
				$("#custAuthTypeName").html("客户密码：");
			} else {
				$("#custAuthTypeName").html("产品密码：");
			}
			var pCustIdentityCd = $("#p_cust_identityCd").val();
			if("1"==pCustIdentityCd){
				$('#authIDTD').attr("disabled",false);//身份鉴权的身份证在读卡时被禁用，此处启用
				easyDialog.open({
					container:'authID',
					callback : function(){
						order.uiCusts.queryForChooseUser = false; //关闭弹出框时重置标识位
					}
				});
			}else{
				easyDialog.open({
					container : 'auth',
					callback : function(){
						order.uiCusts.queryForChooseUser = false; //关闭弹出框时重置标识位
					}
				});
				
				_jumpAuth();
			}
			if(order.cust.jumpAuthflag=="0"){
				$("#jumpAuth").off('click').on('click', function(){
					order.cust.jumpAuth();
				});
				$("#jumpAuth").show();
				$("#jumpAuthID").show();
			}
			$("#authClose").off("click").on("click",function(event){
				easyDialog.close();
				$("#authPassword").val("");
			});
			$("#authIDClose").off("click").on("click",function(event){
				easyDialog.close();
				$("#authIDTD").val("");
			});
		} else{
			_custAuth(scope);
		}
		
	};
	
	//跳过验证权限
	var _jumpAuth = function() {
		
		//正常是要验证权限，这里就不需要了
//		if(order.cust.jumpAuthflag!="0"){
//			$.alert("提示","没有跳过校验权限！");
//			return;
//		}
		var param = _choosedCustInfo;
		param.authFlag="1";
		$.callServiceAsHtml(contextPath+"/cust/custAuthSub",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					_showPackageDialog("客户鉴权失败,稍后重试!");
					return;
				}
				
				if(!order.uiCusts.queryForChooseUser){
					custInfo = param;
					OrderInfo.boCusts.prodId=-1;
					OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
					OrderInfo.boCusts.partyProductRelaRoleCd="0";
					OrderInfo.boCusts.state="ADD";
					OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
					
					OrderInfo.cust = _choosedCustInfo;
					_custAuthCallBack(response);
				} else {
					//鉴权成功后显示选择使用人弹出框
					order.main.showChooseUserDialog(param);
				}
			},"always":function(){
				// 注释后 才会显示下个请求的提示信息
//				$.unecOverlay();
			}
		});
	};
	
	// cust auth callback
	var _custAuthCallBack = function(response) {
		
		if(authFlag=="0"){
			easyDialog.close();
		}
		$("#custList").hide();
		$("#custQryDiv").hide();
		if($.ketchup)
			$.ketchup.hideAllErrorContainer($("#custCreateForm"));
		var content$ = $("#custInfo");
		content$.html(response.data).show();
		if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){
			$("#custModifyId").attr("style","display: none;");
		}else{
			$("#custModifyId").attr("style","");
		}
		$("#cCustName").val("");
		$("#cCustIdCard").val("");
		main.home.hideMainIco();
		
		_btnQueryCustProdMore();
	};
	
	//点击已经订购业务开始start
	var _btnQueryCustProdMore=function(param){
		
		if(OrderInfo.cust.custId==-1){
			_showPackageDialog("新建客户无法查询已订购产品!");
			return;
		}
		
		var curPage=1;
		
		$("#prodDetail").hide();
		$("#prodInfo").hide();
		$("#prodList").hide();//原来是show的，这里不展示
		//$("#orderedprod").show();
		$("#orderContent").show();
		if(order.cust.orderBtnflag==""){//初次查询
			//隐藏菜单
			main.home.hideMainIco();
			_btnQueryCustProd(curPage);
			$("#orderedprod").hide();//原来是show的，这里不展示，改为hide
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
			
			$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");
			$("#orderbutton").css({"height":"35px","border-bottom":"1px solid #fff"});
			$("#orderbutton span").css({"color":"#327501"});
			order.cust.orderBtnflag="1";
		}else if(order.cust.orderBtnflag=="0"||$("#orderedprod").is(":hidden")){
			$("#orderedprod").show();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
			
			$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");
			$("#orderbutton").css({"height":"35px","border-bottom":"1px solid #fff"});
			$("#orderbutton span").css({"color":"#327501"});
			order.cust.orderBtnflag="1";
			
		}else{
			$("#orderedprod").hide();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrow");
			order.cust.orderBtnflag="0";
			$("#orderbutton").css({"height":"24px","border-bottom":"1px solid #4f7d3f"});
		}
		/*$("#orderbutton").off("click").on("click",function(event){_btnQueryPhoneNumber();event.stopPropagation();});*/
	};
	
	//已订购业务第二步
	var _btnQueryCustProd=function(curPage){
		//收集参数
		var param={};
		if(_choosedCustInfo==null){
			param.custId="";
		}else{
			param.custId=_choosedCustInfo.custId;
			param.areaId =$("#area").attr("areaId");
		}
		
		if(document.getElementById("accNbrQuery")){
			param.acctNbr=$.trim($("#accNbrQuery").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
			
		} else if($("#isAppointNum").attr("checked")=="checked"){
			param.acctNbr=$.trim($("#p_cust_identityNum").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
		}else {
			param.acctNbr="";
		}
		
		//获取查询号码new
			param.acctNbr=OrderInfo.acctNbr;

		if(document.getElementById("custPageSize")){
			param.pageSize=$.trim($("#custPageSize").val());
			if(!(/^[1-9]\d*$/.test(param.pageSize))&&(param.pageSize!="")){
				//页码格式不正确，必须为有效数字
				_showPackageDialog("获取页面信息失败,请稍后再试!");
				return false;
			}
			if(param.pageSize>15){
				//页数大小不能超过15
				_showPackageDialog("获取页面信息失败,请稍后再试!");
				return false;
			}
		}else {
			param.pageSize="";
		}
		param.curPage=curPage;
		param.DiffPlaceFlag=$("#DiffPlaceFlag").val();
		if(param.custId==null||param.custId==""){
			_showPackageDialog("无法查询已订购产品,查询失败!");
			//$.alert("提示","无法查询已订购产品");
			return;
		}
		
		//请求地址,查询产品列表
		var url = contextPath+"/cust/orderprodSub";//原地址是/cust/orderprod
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>';
				}
				if (response.code == -2) {
					return;
				}else if(response.code != 0) {
					_showPackageDialog("查询信息失败,请稍后重试!");
					//$.alert("提示","查询失败,稍后重试");
					return;
				}
				var content$=$("#orderedprod");
				content$.html(response.data);
				//_linkSelectPlan("#phoneNumListtbody tr",$("#phoneNumListtbody").children(":first-child"));
				//绑定每行合约click事件
				$("#phoneNumListtbody tr").off("click").on("click",function(event){
					var thisTr=this;
					if(1==OrderInfo.order.step&&(!$(thisTr).hasClass("plan_select"))){
						$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
							yes:function(){
								_cancel();
								_linkQueryOffer(thisTr);
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else if(2==OrderInfo.order.step&&(!$(thisTr).hasClass("plan_select"))){
						$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
							yes:function(){
								SoOrder.orderBack();
								_cancel();
								_linkQueryOffer(thisTr);
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else{
						_linkQueryOffer(this);
					}
					
					});
				
				$("#plan2ndDiv tbody tr").each(function(){$(this).off("click").on("click",function(event){
					var this2Tr=this;
					if(1==OrderInfo.order.step&&(!$(this2Tr).hasClass("plan_select2"))){
						$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
							yes:function(){
								_cancel();
								order.cust.linkSelectPlan(this2Tr);event.stopPropagation();
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else if(2==OrderInfo.order.step&&(!$(this2Tr).hasClass("plan_select2"))){
						$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
							yes:function(){
								SoOrder.orderBack();
								_cancel();
								order.cust.linkSelectPlan(this2Tr);event.stopPropagation();
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else{
						order.cust.linkSelectPlan(this);event.stopPropagation();
					}
					
					
					});});
				
				$("#phoneNumListtbody").children(":first-child").next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();
				$("#phoneNumListtbody").children(":first-child").click();
			}
		});	
	};
	
	/**
	 * 已订购产品查询（选中产品）
	 */
	var _linkQueryOffer=function(selected){
		
	

		//3G用户标识
		$("#is3GCheckbox").off().change(function() {
			order.prodModify.getChooseProdInfo();

			}); 
		//勾取消
		$("#phoneNumListtbody tr").filter(".plan_select").children(":first-child").html("");
		$("#phoneNumListtbody tr").filter(".plan_select")
			.removeClass("plan_select").next("#plan2ndTr").hide();
		$(selected).addClass("plan_select").next("#plan2ndTr").show();
		//打勾操作
		var nike="<i class='select'></i>";
		$(selected).children(":first-child").html(nike);
		
		$(selected).next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();
		
		
		OrderInfo.busitypeflag=2
		$("#custInfo").hide();
		
		offerChange.init(); 
		//window.location.href=contextPath+"/app/main/common";
		
	};
	
	
	
	return {
		fromProvFlag : _fromProvFlag,
		custQuery : _custQuery,
		queryCallBack : _queryCallBack,
		btnQueryCustProd : _btnQueryCustProd,
		showCustAuth : _showCustAuth,
		orderInfo : _orderInfo,
		//packageInfo : _packageInfo,
		showPackageDialog : _showPackageDialog
	};
})();
$(function() {
//   order.cust.form_valid_init();
//   order.cust.initDic();
});
/**
 * 客户资料管理
 */
CommonUtils.regNamespace("order", "uiCustes");
var num=0;
var maxNum = 0;
var _newAddList = [];

var showDialogInfo=function(content){
	$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>"+content+"</div>");
}

var _showPackageDialog=function(msg){
	var html="<table class=\"contract_list rule\">";
	html+='<thead><tr> <td colspan="2">提示</td></tr></thead></table>';
	html+="<div id=\"rules_div\" height=\"height:140px;\">";
	html+='<table width="100%" height="120px;" border="0" cellspacing="0" cellpadding="0">';
	html+='<tr>';
	html+='<td align="right"></td>';
	html+="<td><div class=\"rule_font\" style=\"width:100%;font-size:15px; text-align:center;\">"+msg+"</div></td>";
	html+='</tr>';
	html+='</table>';
	html+='</div>';
	easyDialog.open({
		container : 'packageTip_dialog'
	});
	$("#infoTipContent").html("");
	$("#infoTipContent").html(html);
};
order.uiCustes = (function(){
var _choosedCustInfo = {};
	
	var createCustInfo = {};
	var _orderInfo;
	var custInfo = null;
	
	var authFlag = null;
	
	var _fromProvFlag = "0"; //省份甩单标志
	
	var _provIsale = null; //省份isale流水号
	
	var g_query_cust_infos = [];
	
	//客户鉴权跳转权限
	var _jumpAuthflag="";
	
	//客户属性
	var _partyProfiles =[];
	
	//客户属性分页列表
	var _profileTabLists =[];
	
	var _tmpChooseUserInfo = {};
	
	var _queryForChooseUser = false;
	
	var _choosedCustInfo = {};
	
	var _custQuery=function(){
		
	
		var url=contextPath+"/order/createorderlonger";
		var response = $.callServiceAsJson(url, {});
		if(response.code==0){
			OrderInfo.custorderlonger=response.data;
		}
		var identityCd="";
		var idcard="";
		var diffPlace="";
		var acctNbr="";
		var identityNum="";
		var queryType="";
		var queryTypeValue="";
		identityCd=$("#p_cust_identityCd").val();
		identityNum=$.trim($("#p_cust_identityNum").val());
		//判断是否是号码或身份证输入

		//省份甩单定位客户不需要进行客户鉴权
		if(order.uiCustes.fromProvFlag == "1" || (identityCd!=-1 && CONST.getAppDesc()!=0)){
			identityCd=$("#p_cust_identityCd").val();
			authFlag="1";
		}else{
			//4G所有证件类型定位都需要客户鉴权
			authFlag="0";
		}
		if(identityCd==-1){
			acctNbr=identityNum;
			identityNum="";
			identityCd="";
		}else if(identityCd=="acctCd"||identityCd=="custNumber"){
			acctNbr="";
			identityNum="";
			identityCd="";
			queryType=$("#p_cust_identityCd").val();
			queryTypeValue=$.trim($("#p_cust_identityNum").val());

		}
		diffPlace=$("#DiffPlaceFlag").val();
		
		//旧客户定位地市是获取工号地市，暂不用
		//areaId=$("#p_cust_areaId").val();
		//改为使用参数中的地市进行定位
		areaId=$("#custAreaId_").val();
		
		if(areaId==null || areaId=="" || areaId=="null" || areaId=="undefined"){
			_showPackageDialog("用于客户定位的地市为空，请重试!");
			return;
		}
		
		//lte进行受理地区市级验证
		if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){
			_showPackageDialog("省级地区无法进行定位客户,请选择市级地区!");
			return;
		}
		
		var param = {
				"acctNbr":acctNbr,
				"identityCd":identityCd,
				"identityNum":identityNum,
				"partyName":"",
				"custQueryType":$("#custQueryType").val(),
				"diffPlace":diffPlace,
				"areaId" : areaId,
				"queryType" :queryType,
				"queryTypeValue":queryTypeValue,
				"identidies_type":$("#p_cust_identityCd  option:selected").text()
		};
		
		$.callServiceAsHtml(contextPath+"/token/pc/cust/queryCustSub2",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询客户信息中,请稍候...</strong>");
			},"done" : function(response){
				if (response.code == -2) {
					return;
				}
				
				_queryCallBack(response);

			},fail:function(response){
				$.unecOverlay();
				_showPackageDialog("客户定位失败，请稍后再试!");
			},"always":function(){
				$.unecOverlay();
				$("#usersearchbtn").attr("disabled",false);
			}
		});
	}

	//客户查询列表
	var _queryCallBack = function(response) {
		
		if(response.data.indexOf("showVerificationcode") >=0) {
			$("#vali_code_input").val("");
			$('#validatecodeImg').css({"width":"80px","height":"32px"}).attr('src',contextPath+'/validatecode/codeimg.jpg?' + Math.floor(Math.random()*100)).fadeIn();
			easyDialog.open({
				container : 'Verificationcode_div'
			});
		
			return;
		}
		if(response.data.indexOf("false") >=0) {
			_showPackageDialog("抱歉,没有定位到客户,请尝试其他客户");
			return;
		}
		var content$ = $("#custList");
		
		content$.html(response.data).show();
		
		$(".userclose").off("click").on("click",function(event) {
			
			authFlag="";
			$(".usersearchcon").hide();
		});
		if($("#custListTable").attr("custInfoSize")=="1"){
			$(".usersearchcon").hide();
		}
		
		//_showCustAuth($("#custInfos"));
		
	}
	
	//展示客户验证窗口，这里不需要，但是还是需要这个环节，弹出后马上关闭
	var _showCustAuth = function(scope) {

		
		$("#main_div_1").show();
		
		_choosedCustInfo = {
			custId : $(scope).find("td:eq(3)").text(),
			partyName : $(scope).find("td:eq(0)").text(),
			idCardNumber : $(scope).find("td:eq(4)").text(),
			identityName : $(scope).attr("identityName"),
			areaName : $(scope).attr("areaName"),
			areaId : $(scope).attr("areaId"),
			identityCd :$(scope).attr("identityCd"),
			addressStr :$(scope).attr("addressStr"),
			norTaxPayer :$(scope).attr("norTaxPayer"),
			segmentId :$(scope).attr("segmentId"),
			segmentName :$(scope).attr("segmentName"),
			custFlag :$(scope).attr("custFlag"),
			vipLevel :$(scope).attr("vipLevel"),
			vipLevelName :$(scope).attr("vipLevelName")
		};
		if(order.uiCustes.queryForChooseUser && _choosedCustInfo.segmentId != 1100){
			_showPackageDialog("使用人必须是公众客户，请重新定位");
			return false;
		}
		if(authFlag=="0"){
			if(order.cust.authType == '00'){
				$("#custAuthTypeName").html("客户密码：");
			} else {
				$("#custAuthTypeName").html("产品密码：");
			}
			var pCustIdentityCd = $("#p_cust_identityCd").val();
			if("1"==pCustIdentityCd){
				$('#authIDTD').attr("disabled",false);//身份鉴权的身份证在读卡时被禁用，此处启用
				easyDialog.open({
					container:'authID',
					callback : function(){
						order.uiCustes.queryForChooseUser = false; //关闭弹出框时重置标识位
					}
				});
			}else{
				easyDialog.open({
					container : 'auth',
					callback : function(){
						order.uiCustes.queryForChooseUser = false; //关闭弹出框时重置标识位
					}
				});
				
				_jumpAuth();
			}
			if(order.cust.jumpAuthflag=="0"){
				$("#jumpAuth").off('click').on('click', function(){
					order.cust.jumpAuth();
				});
				$("#jumpAuth").show();
				$("#jumpAuthID").show();
			}
			$("#authClose").off("click").on("click",function(event){
				easyDialog.close();
				$("#authPassword").val("");
			});
			$("#authIDClose").off("click").on("click",function(event){
				easyDialog.close();
				$("#authIDTD").val("");
			});
		} else{
			_custAuth(scope);
		}
		
	};
	
	//跳过验证权限
	var _jumpAuth = function() {
		
		//正常是要验证权限，这里就不需要了
//		if(order.cust.jumpAuthflag!="0"){
//			$.alert("提示","没有跳过校验权限！");
//			return;
//		}
		var param = _choosedCustInfo;
		param.authFlag="1";
		$.callServiceAsHtml(contextPath+"/cust/custAuthSub",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					_showPackageDialog("客户鉴权失败,稍后重试!");
					return;
				}
				
				if(!order.uiCustes.queryForChooseUser){
					custInfo = param;
					OrderInfo.boCusts.prodId=-1;
					OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
					OrderInfo.boCusts.partyProductRelaRoleCd="0";
					OrderInfo.boCusts.state="ADD";
					OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
					
					OrderInfo.cust = _choosedCustInfo;
					_custAuthCallBack(response);
				} else {
					//鉴权成功后显示选择使用人弹出框
					order.main.showChooseUserDialog(param);
				}
			},"always":function(){
				// 注释后 才会显示下个请求的提示信息
//				$.unecOverlay();
			}
		});
	};
	
	// cust auth callback
var _custAuthCallBack = function(response) {
		
		if(authFlag=="0"){
			easyDialog.close();
		}
		$("#custList").hide();
		$("#custQryDiv").hide();
		if($.ketchup)
			$.ketchup.hideAllErrorContainer($("#custCreateForm"));
		var content$ = $("#custInfo");
		content$.html(response.data).show();
		if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){
			$("#custModifyId").attr("style","display: none;");
		}else{
			$("#custModifyId").attr("style","");
		}
		$("#cCustName").val("");
		$("#cCustIdCard").val("");
		main.home.hideMainIco();
		
		_btnQueryCustProdMore();
	};
	
	//点击已经订购业务开始start
	var _btnQueryCustProdMore=function(param){
		
		if(OrderInfo.cust.custId==-1){
			_showPackageDialog("新建客户无法查询已订购产品!");
			return;
		}
		
		var curPage=1;
		
		$("#prodDetail").hide();
		$("#prodInfo").hide();
		$("#prodList").hide();//原来是show的，这里不展示
		//$("#orderedprod").show();
		$("#orderContent").show();
		if(order.cust.orderBtnflag==""){//初次查询
			//隐藏菜单
			main.home.hideMainIco();
			_btnQueryCustProd(curPage);
			$("#orderedprod").hide();//原来是show的，这里不展示，改为hide
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
			
			$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");
			$("#orderbutton").css({"height":"35px","border-bottom":"1px solid #fff"});
			$("#orderbutton span").css({"color":"#327501"});
			order.cust.orderBtnflag="1";
		}else if(order.cust.orderBtnflag=="0"||$("#orderedprod").is(":hidden")){
			$("#orderedprod").show();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
			
			$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");
			$("#orderbutton").css({"height":"35px","border-bottom":"1px solid #fff"});
			$("#orderbutton span").css({"color":"#327501"});
			order.cust.orderBtnflag="1";
			
		}else{
			$("#orderedprod").hide();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrow");
			order.cust.orderBtnflag="0";
			$("#orderbutton").css({"height":"24px","border-bottom":"1px solid #4f7d3f"});
		}
		/*$("#orderbutton").off("click").on("click",function(event){_btnQueryPhoneNumber();event.stopPropagation();});*/
	};
	
	
	//已订购业务第二步
	var _btnQueryCustProd=function(curPage){
	
		//收集参数
		var param={};
		if(_choosedCustInfo==null){
			param.custId="";
		}else{
			param.custId=_choosedCustInfo.custId;
			param.areaId =$("#area").attr("areaId");
		}
		
		if(document.getElementById("accNbrQuery")){
			param.acctNbr=$.trim($("#accNbrQuery").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
			
		} else if($("#isAppointNum").attr("checked")=="checked"){
			param.acctNbr=$.trim($("#p_cust_identityNum").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
		}else {
			param.acctNbr="";
		}
		
		//获取查询号码new
		param.acctNbr=OrderInfo.acctNbr;
		
		if(document.getElementById("custPageSize")){
			param.pageSize=$.trim($("#custPageSize").val());
			if(!(/^[1-9]\d*$/.test(param.pageSize))&&(param.pageSize!="")){
				//页码格式不正确，必须为有效数字
				_showPackageDialog("获取页面信息失败,请稍后再试!");
				return false;
			}
			if(param.pageSize>15){
				//页数大小不能超过15
				_showPackageDialog("获取页面信息失败,请稍后再试!");
				return false;
			}
		}else {
			param.pageSize="";
		}
		param.curPage=curPage;
		param.DiffPlaceFlag=$("#DiffPlaceFlag").val();
		if(param.custId==null||param.custId==""){
			_showPackageDialog("无法查询已订购产品,查询失败!");
			//$.alert("提示","无法查询已订购产品");
			return;
		}
		
		//请求地址,查询产品列表
		var url = contextPath+"/cust/orderprodSub";//原地址是/cust/orderprod
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>';
				}
				if (response.code == -2) {
					return;
				}else if(response.code != 0) {
					_showPackageDialog("查询信息失败,请稍后重试!");
					//$.alert("提示","查询失败,稍后重试");
					return;
				}
				var content$=$("#orderedprod");
				content$.html(response.data);
				//_linkSelectPlan("#phoneNumListtbody tr",$("#phoneNumListtbody").children(":first-child"));
				//绑定每行合约click事件
				$("#phoneNumListtbody tr").off("click").on("click",function(event){
					var thisTr=this;
					if(1==OrderInfo.order.step&&(!$(thisTr).hasClass("plan_select"))){
						$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
							yes:function(){
								_cancel();
								order.uiCustes.linkQueryOffer(thisTr);
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else if(2==OrderInfo.order.step&&(!$(thisTr).hasClass("plan_select"))){
						$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
							yes:function(){
								SoOrder.orderBack();
								_cancel();
								order.uiCustes.linkQueryOffer(thisTr);
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else{
						order.uiCustes.linkQueryOffer(this);
					}
					
					});
				
				$("#plan2ndDiv tbody tr").each(function(){$(this).off("click").on("click",function(event){
					var this2Tr=this;
					if(1==OrderInfo.order.step&&(!$(this2Tr).hasClass("plan_select2"))){
						$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
							yes:function(){
								_cancel();
								order.cust.linkSelectPlan(this2Tr);event.stopPropagation();
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else if(2==OrderInfo.order.step&&(!$(this2Tr).hasClass("plan_select2"))){
						$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
							yes:function(){
								SoOrder.orderBack();
								_cancel();
								order.cust.linkSelectPlan(this2Tr);event.stopPropagation();
								OrderInfo.order.step=0;
							},
							no:function(){
								null;
							}
						});
					}else{
						order.cust.linkSelectPlan(this);event.stopPropagation();
					}
					
					
					});});
				
				$("#phoneNumListtbody").children(":first-child").next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();
				$("#phoneNumListtbody").children(":first-child").click();
			}
		});	
	};
	
	/**
	 * 
	 * */
	//订购销售品
	var _buyService = function(specId,price) {
	
		var custId = OrderInfo.cust.custId;
		offerprice = price;
		if(OrderInfo.cust==undefined || custId==undefined || custId==""){
			$.alert("提示","在订购套餐之前请先进行客户定位！");
			return;
		}
		var param = {
			"price":price,
			"specId" : specId,
			"custId" : OrderInfo.cust.custId,
			"areaId" : OrderInfo.staff.soAreaId
		};
		
		if(OrderInfo.actionFlag == 2){  //套餐变更不做校验	
			order.uiCustes.opeSer(param);   
		}
	};
	/**
	 * */
	//获取销售品构成，并选择数量
	var _opeSer = function(inParam){	
		
		var param = {
			offerSpecId : inParam.specId,
			offerTypeCd : 1,
			partyId: OrderInfo.cust.custId
		};
		var offerSpec = query.offer.queryMainOfferSpec(param); //查询主销售品构成
		if(!offerSpec){
			return;
		}
		if(OrderInfo.actionFlag == 2){ //套餐变更			
			var url=contextPath+"/token/pc/order/queryFeeType";
			$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {			
				if(response.data!=undefined){
					if("0"==response.data){			
						var is_same_feeType=false;
						if(order.prodModify.choosedProdInfo.feeType=="2100" && (offerSpec.feeType=="2100"||offerSpec.feeType=="3100"||offerSpec.feeType=="3101"||offerSpec.feeType=="3103"||offerSpec.feeType=="1202"||offerSpec.feeType=="2101")){
							is_same_feeType=true;//预付费
						}else if(order.prodModify.choosedProdInfo.feeType=="1200" && (offerSpec.feeType=="1200"||offerSpec.feeType=="3100"||offerSpec.feeType=="3102"||offerSpec.feeType=="3103"||offerSpec.feeType=="1202"||offerSpec.feeType=="2101")){
							is_same_feeType=true;//后付费
						}else if(order.prodModify.choosedProdInfo.feeType=="1201" && (offerSpec.feeType=="1201"||offerSpec.feeType=="3101"||offerSpec.feeType=="3102"||offerSpec.feeType=="3103")){
							is_same_feeType=true;//准实时预付费
						}
						if(!is_same_feeType){
							$.alert("提示","付费类型不一致,无法进行套餐变更。");
							return;
						}
					}
				}
			}
			order.uiCustes.offerChangeView();
			return;
		}
		var iflag = 0; //判断是否弹出副卡选择框 false为不选择
		var $tbody = $("#member_tbody");
		$tbody.html("");
		$("#main_title").text(OrderInfo.offerSpec.offerSpecName);
		$.each(offerSpec.offerRoles,function(){
			var offerRole = this;
			var $tr = $("<tr style='background:#f8f8f8;'></tr>");
			var $td = $('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'
					+offerRole.offerRoleName+'</span>&nbsp;&nbsp;</td>');
			if(this.memberRoleCd == CONST.MEMBER_ROLE_CD.CONTENT){
				$tr.append($td).append($("<td colspan='3'></td>")).appendTo($tbody);
			}else{
				$tr.append($td).appendTo($tbody);
			}
			
			$.each(this.roleObjs,function(){
				var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
				if(this.objType == CONST.OBJ_TYPE.PROD){
					if(offerRole.minQty == 0){ //加装角色
						this.minQty = 0;
						this.dfQty = 0;
					}
					var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
					$tr.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'>"+
							"<a class='add' href='javascript:order.service.subNum(\""+objInstId+"\","+this.minQty+");'></a>"+
							"<input id='"+objInstId+"' type='text' value='"+this.dfQty+"' class='numberTextBox width22' readonly='readonly'>"+
							"<a class='add2' href='javascript:order.service.addNum(\""+objInstId+"\","+this.maxQty+",\""+offerRole.parentOfferRoleId+"\");'> </a>"+
							"</i>"+this.minQty+"-"+max+"（张） </td>");	
					iflag++;
				}
			});
			var $trServ = $("<tr></tr>");
			var i = 0;
			$.each(this.roleObjs,function(){
				var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id	
				if(this.objType == CONST.OBJ_TYPE.SERV){  //是否有功能产品
					if(i%4==0){
						$trServ = $("<tr></tr>");
						$trServ.appendTo($tbody);
					}
					var $input = $('<input id="'+objInstId+'" name="'+offerRole.offerRoleId+'" type="checkbox">'+this.objName+'</input>');
					if(this.minQty == 0){
						if(this.dfQty>0){
							$input.attr("checked","checked");
						}
					}else if(this.minQty > 0){
						$input.attr("checked","checked");
						$input.attr("disabled","disabled");
					}
					var $td = $("<td></td>");
					$td.append($input).appendTo($trServ);
					i++;
					iflag++;
				}
			});
		});
		//页面初始化参数
		var param = {
			"boActionTypeCd" : "S1" ,
			"boActionTypeName" : "订购",
			"offerSpec" : offerSpec,
			"actionFlag" :1,
			"type" : 1
		};
		if(iflag>1){
			easyDialog.open({
				container : "member_dialog"
			});
			$("#member_btn").off("click").on("click",function(){
				order.service.confirm(param);
			});
		}else{
			if(!_setOfferSpec(1)){
				$.alert("错误提示","请选择一个接入产品");
				return;
			}
			if(OrderInfo.actionFlag!=14){ //合约套餐不初始化
				order.main.buildMainView(param);	
			}
		}
	};
	
	//套餐变更页面显示
	var _offerChangeView=function(){
		_newAddList = [];
		offerChange.newMemberFlag = false;
		offerChange.oldMemberFlag = false;
		var oldLen = 0 ;
		$.each(OrderInfo.offer.offerMemberInfos,function(){
			if(this.objType==2){
				oldLen++;
			}
		});
		var memberNum = 1; //判断是否多成员 1 单成员2多成员
		var viceNum = 0;
		if(oldLen>1){ //多成员角色，目前只支持主副卡
			memberNum = 2;
		}
		//把旧套餐的产品自动匹配到新套餐中
		if(!offerChange.setChangeOfferSpec(memberNum,viceNum)){  
			return;
		};
		//4g系统需要
		if(CONST.getAppDesc()==0){ 
			//老套餐是3G，新套餐是4G
			if(order.prodModify.choosedProdInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){
				if(!offerChange.checkOrder()){ //省内校验单
					return;
				}
			}
			//根据UIM类型，设置产品是3G还是4G，并且保存旧卡
			if(!prod.uim.setProdUim()){ 
				return ;
			}
		}
		if(OrderInfo.actionFlag == 2){ //套餐变更
			var custOrderList = OrderInfo.data.orderList.custOrderList[0].busiOrder;
			var newsplitflag = 1;
			var oldsplitflag = 1;
			order.memberChange.newSubPhoneNum="";
			order.memberChange.oldSubPhoneNum="";
			$.each(custOrderList,function(){
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员
					order.memberChange.newmembers.flag = true;
					if(newsplitflag==1){
						order.memberChange.newSubPhoneNum += this.busiObj.accessNumber;
						newsplitflag++;
					}else{
						order.memberChange.newSubPhoneNum += ","+this.busiObj.accessNumber;
					}
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S2"){//纳入老成员
					if(this.busiObj.isComp!=undefined){
						order.memberChange.oldmembers.flag = true;
						if(oldsplitflag==1){
							order.memberChange.oldSubPhoneNum += this.busiObj.accessNumber;
							oldsplitflag++;
						}else{
							order.memberChange.oldSubPhoneNum += ","+this.busiObj.accessNumber;
						}
						var objInstId = this.data.ooRoles[0].objInstId;
						var instId = this.busiObj.instId;
						order.memberChange.oldmembers.objInstId.push({"instId":instId,"objInstId":objInstId});
					}
				}
			});
			var newSubPhoneNumsize=[];
			var oldSubPhoneNumsize=[];
			if(order.memberChange.newSubPhoneNum!=""){
				newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
			}
			if(order.memberChange.oldSubPhoneNum!=""){
				oldSubPhoneNumsize = order.memberChange.oldSubPhoneNum.split(",");
			}
			var max = 0;
			var $tbody = $("#member_tbody");
			$tbody.html("");
			$("#main_title").text(OrderInfo.offerSpec.offerSpecName);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(this.memberRoleCd=="401"){
					var offerRole = this;
					var $tr = $("<tr style='background:#f8f8f8;'></tr>");
					var $td = $('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'
							+offerRole.offerRoleName+'</span>&nbsp;&nbsp;</td>');
					if(this.memberRoleCd == CONST.MEMBER_ROLE_CD.CONTENT){
						$tr.append($td).append($("<td colspan='3'></td>")).appendTo($tbody);
					}else{
						$tr.append($td).appendTo($tbody);
					}
					$.each(this.roleObjs,function(){
						var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
						if(this.objType == CONST.OBJ_TYPE.PROD){
							_newAddList.push(objInstId);
							if(offerRole.minQty == 0){ //加装角色
								this.minQty = 0;
								this.dfQty = 0;
							}
							var membernum = 0;
							$.each(OrderInfo.offer.offerMemberInfos,function(){
								if(this.roleCd=="401"){
									membernum++;
								}
							})
							max = this.maxQty<0?"不限制":this.maxQty-membernum;
							if(max<0){
								max = 0;
							}
							maxNum = max;
							$tr.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'>"+
									"<a class='add' href='javascript:order.service.subNum(\""+objInstId+"\","+this.minQty+");'></a>"+
									"<input id='"+objInstId+"' type='text' value='"+newSubPhoneNumsize.length+"' class='numberTextBox width22' readonly='readonly'>"+
									"<a class='add2' href='javascript:order.service.addNum(\""+objInstId+"\","+max+",\""+offerRole.parentOfferRoleId+"\");'> </a>"+
									"</i>"+this.minQty+"-"+max+"（张） </td>");	
							if(max>0){
								for(var k=0;k<oldSubPhoneNumsize.length;k++){
									if(k==0){
										var olro = "<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'>" +
										"<td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td>" +
										"<td align='left' colspan='3'><input value='"+oldSubPhoneNumsize[k]+"' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' >" +
										"<a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+max+",\"\");'> </a>"+this.minQty+"-"+max+"（张）</td></tr>";	
										$tr.after(olro);
									}else{
										order.memberChange.addNum(max,oldSubPhoneNumsize[k]);
									}
								}
							}
						}
					});
				}
			});
			easyDialog.open({
				container : "member_dialog"
			});
//			$("#member_btn").off("click").on("click",function(){
				offerChangeConfirm();
//			});
		}
	};
	
	function offerChangeConfirm(){
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldprodAcctInfos = [];
		OrderInfo.oldAddNumList = [];
		var newnum = 0;
		var oldnum = 0;
		order.memberChange.viceCartNum = 0;
		var delprodInsts = [];
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			if(this.memberRoleCd=="401"){
				if(this.prodInsts!=undefined){
					var oldprodInsts = this.prodInsts;
					for(var i=0;i<this.prodInsts.length;i++){
						var prodInstId = '"'+this.prodInsts[i].prodInstId+'"';
						if(prodInstId.indexOf("-")!=-1){
							delprodInsts.push(this.prodInsts[i]);
						}
					}
					$.each(delprodInsts,function(){
						var delprodInstId = this.prodInstId;
						$.each(oldprodInsts,function(j){
							if(this.prodInstId = delprodInstId){
								oldprodInsts.splice(j,1);
							}
						});
					});
				}
			}
		});
		$.each(_newAddList,function(){
			newnum=newnum+Number($("#"+this).val());
		});
		$("#member_tbody").find("tr[name='oldnbr']").each(function(){
			var num = $.trim($(this).children("td").eq(1).children("input").val());
			if(ec.util.isObj(num)){
				oldnum++;
			}
		});
		if(newnum>0){
			offerChange.newMemberFlag = true;
			order.service.setOfferSpec();
		}
		if(oldnum>0){
			offerChange.oldMemberFlag = true;
			if(!order.memberChange.queryofferinfo()){
				return;
			}
		}
//		if(parseInt(newnum)+parseInt(order.memberChange.viceCartNum)>maxNum){
//			$.alert("提示","加装数量已经超过能加装的最大数量【"+maxNum+"】!");
//			return;
//		}
		//初始化填单页面
		var prodInfo = order.prodModify.choosedProdInfo;
		var param = {
			boActionTypeCd : "S2" ,
			boActionTypeName : "套餐变更",
			actionFlag :"2",
			offerSpec : OrderInfo.offerSpec,
			prodId : prodInfo.prodInstId,
			offerMembers : OrderInfo.offer.offerMemberInfos,
			oldOfferSpecName : prodInfo.prodOfferName,
			prodClass : prodInfo.prodClass,
			appDesc : CONST.getAppDesc(),
			areaId : order.prodModify.choosedProdInfo.areaId,
			newnum : parseInt(newnum),
			oldnum : parseInt(oldnum)
		};
		if(oldnum>0){
			param.oldprodInstInfos = OrderInfo.oldprodInstInfos;
			param.oldofferSpec = OrderInfo.oldofferSpec;
			param.oldoffer = OrderInfo.oldoffer;
		}
		order.uiCustes.buildMainView(param);
		easyDialog.close();
	}
	
	var _buildMainView = function(param) {
		
		if (param == undefined || !param) {
			param = _getTestParam();
		}
		if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){
			if(OrderInfo.actionFlag == 6){//主副卡成员变更 付费类型判断 如果一致才可以进行加装
				var is_same_feeType=false;//
				if(param.feeTypeMain=="2100" && (OrderInfo.offerSpec.feeType=="2100"||OrderInfo.offerSpec.feeType=="3100"||OrderInfo.offerSpec.feeType=="3101"||OrderInfo.offerSpec.feeType=="3103")){
					is_same_feeType=true;
				}else if(param.feeTypeMain=="1200" && (OrderInfo.offerSpec.feeType=="1200"||OrderInfo.offerSpec.feeType=="3100"||OrderInfo.offerSpec.feeType=="3102"||OrderInfo.offerSpec.feeType=="3103")){
					is_same_feeType=true;
				}else if(param.feeTypeMain=="1201" && (OrderInfo.offerSpec.feeType=="1201"||OrderInfo.offerSpec.feeType=="3101"||OrderInfo.offerSpec.feeType=="3102"||OrderInfo.offerSpec.feeType=="3103")){
					is_same_feeType=true;
				}
				if(!is_same_feeType){
					$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");
					return;
				}
			}
		}
		$.callServiceAsHtml(contextPath+"/token/pc/order/main",param,{
			"before":function(){
				$.ecOverlay("<strong>正在加载中,请稍等...</strong>");
			},"done" : function(response){
				if(!response){
					 response.data='查询失败,稍后重试';
				}
				if(response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				OrderInfo.actionFlag = param.actionFlag;
				if(OrderInfo.actionFlag == 2){
					
					order.uiCustes.fillOfferChange(response,param);
				}else if(OrderInfo.actionFlag == 21){//副卡换套餐
					order.memberChange.fillmemberChange(response,param);
				}else {
					_callBackBuildView(response,param);
				}
				if(CONST.getAppDesc()==1 && (OrderInfo.actionFlag==1 ||OrderInfo.actionFlag==14)){
					$("#li_is_activation").show();
				}
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	//填充套餐变更页面
	var _fillOfferChange = function(response, param) {
		
		SoOrder.initFillPage(); //并且初始化订单数据
		$("#order_fill_content").html(response.data);
		$("#fillNextStep").off("click").on("click",function(){
			SoOrder.submitOrder();
		});
		$("#fillLastStep").off("click").on("click",function(){
			order.main.lastStep();
		});
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		//遍历主销售品构成
		var uimDivShow=false;//是否已经展示了
		var n=0;
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if(ec.util.isArray(this.prodInsts)){
				$.each(this.prodInsts,function(){
					var _prodInstId = "'"+this.prodInstId+"'";
					if(_prodInstId.indexOf("-") == -1){
						var prodId = this.prodInstId;
						var param = {
							areaId : OrderInfo.getProdAreaId(prodId),
							channelId : OrderInfo.staff.channelId,
							staffId : OrderInfo.staff.staffId,
						    prodId : prodId,
						    prodSpecId : this.objId,
						    offerSpecId : prodInfo.prodOfferId,
						    offerRoleId : this.offerRoleId,
						    acctNbr : this.accessNumber
						};
						var res = query.offer.queryChangeAttachOffer(param);
						$("#attach_"+prodId).html(res);	
						//如果objId，objType，objType不为空才可以查询默认必须
						if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){
							param.queryType = "1,2";
							param.objId = this.objId;
							param.objType = this.objType;
							param.memberRoleCd = this.roleCd;
							param.offerSpecId=OrderInfo.offerSpec.offerSpecId;
							//默认必须可选包
							var data = query.offer.queryDefMustOfferSpec(param);
							CacheData.parseOffer(data);
							//默认必须功能产品
							param.queryType = "1";//只查询必选，不查默认
							var data = query.offer.queryServSpec(param);
							CacheData.parseServ(data);
						}
						/*if(CONST.getAppDesc()==0 && prodInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){	//预校验
						}else{	
						}*/
						AttachOffer.showMainRoleProd(prodId); //显示新套餐构成
						AttachOffer.changeLabel(prodId,this.objId,""); //初始化第一个标签附属
						if(AttachOffer.isChangeUim(prodId)){ //需要补换卡
	                     if(n==0){
	                    	 $("#uimDiv_"+prodId).show();
	                    	 n++;
	                     }
	                     else{
	                    	 $("#uimDiv_"+prodId)[0].style.display = 'none';
	                     }
	                     
						}
					}else{
						var prodInst = this;
						var param = {   
							offerSpecId : OrderInfo.offerSpec.offerSpecId,
							prodSpecId : prodInst.objId,
							offerRoleId: prodInst.offerRoleId,
							prodId : prodInst.prodInstId,
							queryType : "1,2",
							objType: prodInst.objType,
							objId: prodInst.objId,
							memberRoleCd : prodInst.memberRoleCd
						};
						AttachOffer.queryAttachOfferSpec(param);  //加载附属销售品
						var obj = {
							ul_id : "item_order_"+prodInst.prodInstId,
							prodId : prodInst.prodInstId,
							offerSpecId : OrderInfo.offerSpec.offerSpecId,
							compProdSpecId : "",
							prodSpecId : prodInst.objId,
							roleCd : offerRole.roleCd,
							offerRoleId : offerRole.offerRoleId,
							partyId : OrderInfo.cust.custId
						};
						order.main.spec_parm(obj); //加载产品属性
					}
				});
			}
		});
		if(offerChange.newMemberFlag){
			order.main.initAcct(0);
		}
		if(offerChange.oldMemberFlag){
			order.main.initAcct(1);//初始化副卡帐户列表
			order.main.loadAttachOffer();
		}
		$("#zhanghuclose").click(function(){
			easyDialog.close();
			//删除所有选择帐户监听
			$(document).removeJEventListener("queryAccount");
		});
		order.dealers.initDealer(); //初始化发展人
		_initOrderProvAttr();//初始化省内订单属性
		if(CONST.getAppDesc()==0 && order.prodModify.choosedProdInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){ //3G转4G需要校验
			offerChange.checkOfferProd();
		}
		_showOffer();   
	};
	
	
	
	//解析数据
	var _showOffer=function(){
		$("#dealerTbody").empty();
		var custOrderList = OrderInfo.data.orderList.custOrderList[0].busiOrder;
		$.each(custOrderList,function(){
			if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员
				//选号
				$("#nbr_btn_"+this.data.boProdAns[0].prodId).removeClass("selectBoxTwo");
				$("#nbr_btn_"+this.data.boProdAns[0].prodId).addClass("selectBoxTwoOn");
				$("#nbr_btn_"+this.data.boProdAns[0].prodId).html(this.busiObj.accessNumber+"<u></u>");
				var boProdAns={
						prodId : this.data.boProdAns[0].prodId, //从填单页面头部div获取
						accessNumber : this.data.boProdAns[0].accessNumber, //接入号
						anChooseTypeCd : this.data.boProdAns[0].anChooseTypeCd, //接入号选择方式,自动生成或手工配号，默认传2
						anId : this.data.boProdAns[0].anId, //接入号ID
						pnLevelId:this.data.boProdAns[0].pnLevelId,
						anTypeCd : this.data.boProdAns[0].anTypeCd, //号码类型
						state : this.data.boProdAns[0].state, //动作	,新装默认ADD	
						areaId:this.data.boProdAns[0].areaId,
						areaCode:this.data.boProdAns[0].areaCode,
						memberRoleCd:this.data.boProdAns[0].memberRoleCd,
						preStore:this.data.boProdAns[0].preStore,
						minCharge:this.data.boProdAns[0].minCharge
					};
				OrderInfo.boProdAns.push(boProdAns);
				order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);//选号玩要刷新发展人管理里面的号码
				//uim卡校验
				$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);
				$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).removeClass("purchase").addClass("disablepurchase");
				$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);
				$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).removeClass("disablepurchase").addClass("purchase");
				$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);
				$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);
				var coupon = {
						couponUsageTypeCd : this.data.bo2Coupons[0].couponUsageTypeCd, //物品使用类型
						cardTypeFlag : this.data.bo2Coupons[0].cardTypeFlag,
						inOutTypeId : this.data.bo2Coupons[0].inOutTypeId,  //出入库类型
						inOutReasonId : this.data.bo2Coupons[0].inOutReasonId, //出入库原因
						saleId : this.data.bo2Coupons[0].saleId, //销售类型
						couponId : this.data.bo2Coupons[0].couponId, //物品ID
						couponinfoStatusCd : this.data.bo2Coupons[0].couponinfoStatusCd, //物品处理状态
						chargeItemCd : this.data.bo2Coupons[0].chargeItemCd, //物品费用项类型
						couponNum : this.data.bo2Coupons[0].couponNum, //物品数量
						storeId : this.data.bo2Coupons[0].storeId, //仓库ID
						storeName : this.data.bo2Coupons[0].storeName, //仓库名称
						agentId : this.data.bo2Coupons[0].agentId, //供应商ID
						apCharge : this.data.bo2Coupons[0].apCharge, //物品价格
						couponInstanceNumber : this.data.bo2Coupons[0].couponInstanceNumber, //物品实例编码
						terminalCode : this.data.bo2Coupons[0].terminalCode,//前台内部使用的UIM卡号
						ruleId : this.data.bo2Coupons[0].ruleId, //物品规则ID
						partyId : this.data.bo2Coupons[0].partyId, //客户ID
						prodId :  this.data.bo2Coupons[0].prodId, //产品ID
						offerId : this.data.bo2Coupons[0].offerId, //销售品实例ID
						state : this.data.bo2Coupons[0].state, //动作
						relaSeq : this.data.bo2Coupons[0].relaSeq //关联序列	
					};
				OrderInfo.clearProdUim(this.busiObj.instId);
				OrderInfo.boProd2Tds.push(coupon);
				//产品密码
				$("#pwd_"+this.busiObj.instId).val(this.data.boProdPasswords[0].pwd);
				//封装付费方式
				$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected");
			}
			//帐户信息
			if(this.data.boAccountRelas!=undefined){
				var acctId = this.data.boAccountRelas[0].acctId;
				$("#acctSelect").find("option[value="+acctId+"]").attr("selected","selected");
			}
			//发展人
			if(this.data.busiOrderAttrs!=undefined){
				var dealerlist = [];
				var dealerMap1 = {};
				var dealerMap2 = {};
				var dealerMap3 = {};
				$.each(this.data.busiOrderAttrs,function(){
					if(this.role=="40020005"){
						dealerMap1.role = this.role;
						if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
							dealerMap1.staffid = this.value;
							dealerMap1.channelNbr = this.channelNbr;
						}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
							dealerMap1.staffname = this.value;
						}
					}else if(this.role=="40020006"){
						dealerMap2.role = this.role;
						if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
							dealerMap2.staffid = this.value;
							dealerMap2.channelNbr = this.channelNbr;
						}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
							dealerMap2.staffname = this.value;
						}
					}else if(this.role=="40020007"){
						dealerMap3.role = this.role;
						if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
							dealerMap3.staffid = this.value;
							dealerMap3.channelNbr = this.channelNbr;
						}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
							dealerMap3.staffname = this.value;
						}
					}
					
				});
				if(ec.util.isObj(dealerMap1.role)){
					dealerlist.push(dealerMap1);
				}
				if(ec.util.isObj(dealerMap2.role)){
					dealerlist.push(dealerMap2);
				}
				if(ec.util.isObj(dealerMap3.role)){
					dealerlist.push(dealerMap3);
				}
				var objInstId = "";
				var deldealerflag = "";
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){
					objInstId = this.busiObj.instId;
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="1"){
					objInstId = this.busiObj.objId;
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="2"){
					objInstId = this.data.ooRoles[0].prodId+"_"+this.busiObj.objId;
					deldealerflag = "DEL";
				}
				var dealeraccNbr = this.busiObj.accessNumber;
				if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="1"){
					dealeraccNbr = "主套餐";
				}
				for(var d=0;d<dealerlist.length;d++){
					var $tr;
					if(d==0){
						$tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
					}else{
						$tr = $('<tr name="tr_'+objInstId+'"></tr>');
					}
					var $tdType = $('<td></td>');
					var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
					var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
					$.each(OrderInfo.order.dealerTypeList,function(){
						if(dealerlist[d].role==this.PARTYPRODUCTRELAROLECD){
							$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected>"+this.NAME+"</option>");
						}else{
							$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
						}
					});
					$tdType.append($select);
					$tdType.append('<label class="f_red">*</label>');
					$tr.append("<td>"+dealeraccNbr+"</td>");
					if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){
						$tr.append("<td>移动电话（仅含本地语音）</td>");
					}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"){
						$tr.append("<td>"+this.busiObj.objName+"</td>");
					}
					$tr.append($tdType);
					var $td;
					if(deldealerflag=="DEL"){
						if(d==0){
							$td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>');
						}else{
							$td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>');
						}
					}else{
						$td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>');
					}
					$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
					if(d==0){
						if(deldealerflag=="DEL"){
							$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
						}
						$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
					}else{
						$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');
					}
					$tr.append($td);
					if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){
						OrderInfo.getChannelList();
					}
					var $tdChannel = $('<td></td>');
					var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
					$.each(OrderInfo.channelList,function(){
						if(dealerlist[d].channelNbr==this.channelNbr)
							$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
						else
							$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
					});
					$tdChannel.append($channelSelect);
					$tdChannel.append('<label class="f_red">*</label>');	
					$tr.append($tdChannel);
					OrderInfo.SEQ.dealerSeq++;
					$("#dealerTbody").append($tr);
				}
			}
		});
        //清空发展人数据
		var array=new Array();
		var data=OrderInfo.data;
		var number=0;
		//进行进行数据解析工作,获取产品数据
		var custOrderList=data.orderList.custOrderList;
		
		var orderListInfo=data.orderList.orderListInfo;
		//购物车流水
		//OrderInfo.orderResult.olNbr=data.orderList.orderListInfo.soNbr;
		if(custOrderList!=null && custOrderList!=""){
			//获取下属的产品
			if(custOrderList!=null && custOrderList.length>0){
				$(custOrderList).each(function(i,custOrder) { 
					$(custOrder.busiOrder).each(function(i,busiOrder) { 
						//解析到具体的订购产品数据
						//获取产品操作类型
						var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;
						
						//获取产品的操作状态,state,del-删除,add-添加
						var state="";
						
						var datas=busiOrder.data;
				
						var ooOwners;
						var boServs;
						
						// 7是已开通功能，状态的获取和其他类型获取不一样
						if(boActionTypeCd=="7"){
							boServs=datas.boServs;
							
							if(boServs!=null){
								$(boServs).each(function(i,boServ) { 
									state=boServ.state;
								});
							}
							
						}else{
							ooOwners=datas.ooOwners;
							if(ooOwners!=null){
								$(ooOwners).each(function(i,ooOwner) { 
									state=ooOwner.state;
									return false
								});
							}
						}
						
						var busiObj=busiOrder.busiObj;
					    
						
						
						//S2是已订购可选包
						if(boActionTypeCd=="S2" ){
							
							//获取唯一ID标识
							var instId=busiObj.instId;
							var offerTypeCd1=busiObj.offerTypeCd;
							$(datas.ooRoles).each(function(i,ooRole) { 
								var objInstId=ooRole.objInstId;
								state=ooRole.state;
								if(offerTypeCd1=="2"){
									if(state=="DEL"){
										_delOfferSub(objInstId,instId);
									}
								}
								
							});
						}else if(boActionTypeCd=="7"){
					
							//7是已开通功能产品
							//获取唯一ID标识
							
							var instId=busiObj.instId;
							
							var boServOrders=datas.boServOrders;
							
							$(datas.boServs).each(function(i,boServ) { 
								var servId=boServ.servId;
								var state=boServ.state;
								
								if(state=="DEL"){
									_closeServSub(instId,servId,state);
								}else if(state=="ADD"){
									$(boServOrders).each(function(i2,boServOrder) {
										var servSpecId=boServOrder.servSpecId;
										var servSpecName=boServOrder.servSpecName;
										
										_openServSpecSub(instId,servSpecId,servSpecName,'N');
									});
								}
							});
							
						}else if(boActionTypeCd=="S1"){
							
							//S1是订单中的已选可选包数据
							//获取唯一ID标识s
							var instid=busiObj.instId;
							var busiOrderAttrs=busiOrder.data.busiOrderAttrs;
							var ooRoles=busiOrder.data.ooRoles;
							var offerTypeCd=busiObj.offerTypeCd;
							var instid=busiObj.instId;
							var busiOrderAttrs=busiOrder.data.busiOrderAttrs;
							var ooRoles=busiOrder.data.ooRoles;
							var zdDatas=busiOrder.data;    //终端
							
							if( busiOrder.boActionType.actionClassCd=="1200" && busiOrder.boActionType.boActionTypeCd=="S1" && busiOrder.busiObj.offerTypeCd=="2" ){
								
								var objId=busiObj.objId;
							
								var accessNumber=busiObj.accessNumber;
								var objName=busiObj.objName;
								var prodId=null;
								var ooRoles=datas.ooRoles;
								$(datas.ooRoles).each(function(i,ooRole) { 
									prodId=ooRole.prodId;
									return false;
								});
								
								
							//	_addAttachDealerSub(prodId+"_"+objId,accessNumber,objName);
								
								//重载订单中已经选择的服务
								_addOfferSpecSub(prodId,objId,ooRoles);
								
							}
							//解析终端串码
							if(busiOrder.boActionType.actionClassCd=="1200" && busiOrder.boActionType.boActionTypeCd=="S1" && busiOrder.busiObj.offerTypeCd=="2" ){
								if(zdDatas.bo2Coupons!=undefined){								
									//开始解析终端
                                     if(zdDatas.bo2Coupons.length==1){
                                    	 var bo2Coupons = zdDatas.bo2Coupons[0];
                                    	 var prodId=bo2Coupons.prodId;
                                    	 var offerSpecId=bo2Coupons.attachSepcId;
                                    	 var num="1";
                                    	 var flag="0";
                                    	 $("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+num).val(bo2Coupons.couponInstanceNumber);
                                    	 checkTerminalCode(prodId,offerSpecId,num,flag);
                                     }else{
                                    	  for(var i=0;i<zdDatas.bo2Coupons.length;i++){
                                    		   if(i==0){
                                    			 var bo2Coupons = zdDatas.bo2Coupons[0];
                                              	 var prodId=bo2Coupons.prodId;
                                              	 var offerSpecId=bo2Coupons.attachSepcId;
                                              	 var num="1";
                                              	 var flag="0";
                                              	 $("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+num).val(bo2Coupons.couponInstanceNumber);
                                              	 checkTerminalCode(prodId,offerSpecId,num,flag);
                                    		   }
                                    		   else{
                                    			   var bo2Coupons = zdDatas.bo2Coupons[i];
                                    			   var prodId=bo2Coupons.prodId;
                                                   var offerSpecId=bo2Coupons.attachSepcId;
                                                   var objInstId = prodId+"_"+offerSpecId;
                                    			   var $li=$("#ul_"+objInstId+" li");
                                    			   var length=$li.length-1;
                                    		       var num=length/2+1;
                                    		       var fag="0";
                                    		       var flag="0";
                                    			    //添加终端
                                    		        addAndDelTerminal(prodId,offerSpecId,fag);
                                    		        //赋值
                                    		        $("#terminalText_"+prodId+"_"+bo2Coupons.attachSepcId+"_"+num).val(bo2Coupons.couponInstanceNumber);
                                    		        //校验
                                    		        checkTerminalCode(prodId,offerSpecId,num,flag);
                                    		   }
                                    	  }
                                     }
								}
							}
						}else if(boActionTypeCd=="14"){
						    
							var bo2Coupons=busiOrder.data.bo2Coupons
							for(var i=0;i<bo2Coupons.length;i++){
								if(bo2Coupons[i].state=="ADD"){
									//uim卡号  //uim_txt_140029724038
									var card=bo2Coupons[i].couponInstanceNumber;
									//prodId
									var id=bo2Coupons[i].prodId;
									
									$("#uim_txt_"+id).val(card);//填充卡号
									order.uiCustes.checkUim(id,bo2Coupons[i]);
									
									 array[number]=id;
									 number++;
                                	 $("#uimDiv_"+id)[0].style.display = 'none';
								}
							}
						}
						
					});
				});
			}
		}
		
		//退订功能产品
		$.each(AttachOffer.openServList,function(){
			var openmap = this;
			$.each(this.servSpecList,function(){
				var offermap = this;
				var offerflag = false;
				var custOrderLists=custOrderList[0];
				$.each(custOrderLists.busiOrder,function(){
					var obj=this;
					if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="7"){
						if(offermap.servSpecId==this.data.boServOrders[0].servSpecId && openmap.prodId==this.busiObj.instId){
							offerflag = true;
							return false;
						}
					}
				});
				if(!offerflag){
					var $span = $("#li_"+openmap.prodId+"_"+this.servSpecId).find("span"); //定位删除的附属
					var spec = CacheData.getServSpec(openmap.prodId,this.servSpecId);
					if(spec == undefined){ //没有在已开通附属销售列表中
						return;
					}
					$span.addClass("del");
					spec.isdel = "Y";
					AttachOffer.showHideUim(1,openmap.prodId,this.servSpecId);   //显示或者隐藏
					var serv = CacheData.getServBySpecId(openmap.prodId,this.servSpecId);
					if(ec.util.isObj(serv)){ //没有在已开通附属销售列表中
						$span.addClass("del");
						serv.isdel = "Y";
					}
				}
			});
		});
		
		//订单备注和模版等加载
		if(orderListInfo!=null && custOrderList!=null){
			var custOrderAttrs=orderListInfo.custOrderAttrs;
			var isTemplateOrder=orderListInfo.isTemplateOrder;
			var templateOrderName=orderListInfo.templateOrderName;
			
			$(custOrderAttrs).each(function(i,custOrderAttr) { 
				var itemSpecId=custOrderAttr.itemSpecId;
				//111111118是为备注的编码
				if(itemSpecId=="111111118"){
					var value=custOrderAttr.value;
					if(value!=null && value!=""){
						$("#order_remark").html(value);
					}
				}
				//经办人
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrName){
					$('#orderAttrName').val(this.value);
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrPhoneNbr){
					$('#orderAttrPhoneNbr').val(this.value);
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderIdentidiesTypeCd){
					$("#orderIdentidiesTypeCd").find("option[value="+this.value+"]").attr("selected","selected");
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrIdCard){
					$('#orderAttrIdCard').val(this.value);
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrAddr){
					$('#orderAttrAddr').val(this.value);
				}
			});
			
			//模版的操作
			if(isTemplateOrder=="Y"){
				$("#isTemplateOrder").click();//选中模版按钮
				
				SoOrder.showTemplateOrderName();//显示模版名称输入
				
				$("#templateOrderName").val(templateOrderName);//赋值模版名称
			}
		}
		for(var i=0;i<array.length;i++){
			if(i==0){
				$("#uimDiv_"+array[i])[0].style.display = 'block';
			}
			else{
				 $("#uimDiv_"+array[i])[0].style.display = 'none';
			}
		}
	};
	
	//添加可选包到缓存列表
	var _setSpec = function(prodId,offerSpecId){
		var newSpec = CacheData.getOfferSpec(prodId,offerSpecId);  //没有在已选列表里面
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			newSpec = query.offer.queryAttachOfferSpec(prodId,offerSpecId); //重新获取销售品构成
			if(!newSpec){
				return;
			}
			CacheData.setOfferSpec(prodId,newSpec);
		}
		return newSpec;
	};
	
	//二次加载附属业务数据信息 第一步
	var _addOfferSpecSub = function(prodId,offerSpecId,roles){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		
		_setServ2OfferSpecSub(prodId,newSpec);
		
		_checkOfferExcludeDependSub(prodId,newSpec);
			
	};
	//校验销售品的互斥依赖 第三步
	var _checkOfferExcludeDependSub = function(prodId,offerSpec){
		var offerSpecId = offerSpec.offerSpecId;
		var param = CacheData.getExcDepOfferParam(prodId,offerSpecId);
		var data = query.offer.queryExcludeDepend(param);//查询规则校验
		if(data!=undefined){
			paserOfferDataSub(data.result,prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
		}
	};
	
	//解析互斥依赖返回结果
	var paserOfferDataSub = function(result,prodId,offerSpecId,specName){
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
				excludeOffer : [],   //互斥依赖显示列表
				defaultOffer : [], //默选的显示列表
				dependOffer : {  //存放互斥依赖列表
					dependOffers : [],
					offerGrpInfos : []
				}
		};
		if(result!=""){
			var exclude = result.offerSpec.exclude;
			var depend = result.offerSpec.depend;
			var defaultOffer=result.offerSpec.defaultList;
			//解析可选包互斥依赖组
			if(ec.util.isArray(exclude)){
				for (var i = 0; i < exclude.length; i++) {
					var offerList = CacheData.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
						param.excludeOffer.push(exclude[i].offerSpecId);
					}
				}
			}
			if(depend!=undefined && ec.util.isArray(depend.offerInfos)){
				for (var i = 0; i < depend.offerInfos.length; i++) {	
					content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
				}	
			}
			if(depend!=undefined && ec.util.isArray(depend.offerGrpInfos)){
				for (var i = 0; i < depend.offerGrpInfos.length; i++) {
					var offerGrpInfo = depend.offerGrpInfos[i];
					param.dependOffer.offerGrpInfos.push(offerGrpInfo);
					content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
					if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
						for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
							var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
							var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);
							if(ec.util.isObj(offerSpec)){
								if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
									content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}else{
								var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);
								if(ec.util.isObj(offerSpec)){
									if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
										content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}else{
										content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}
						}
					}
				}
			}
			//解析可选包默选组
			if(ec.util.isArray(defaultOffer)){
				for (var i = 0; i < defaultOffer.length; i++) {	
					content += "需要开通： " + defaultOffer[i].offerSpecName + "<br>";
					param.defaultOffer.push(defaultOffer[i].offerSpecId);
				}	
			}
		}
		var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);//查询销售品构成成员的依赖互斥以及连带
		content=content+serContent;
		
		AttachOffer.addOpenList(prodId,offerSpecId); 
//		if(content==""){ //没有互斥依赖
//			AttachOffer.addOpenList(prodId,offerSpecId); 
//		}else{	
//			content = "<div style='max-height:300px;overflow:auto;'>" + content + "</div>";
//			
//			$("#packageHiddenDiv").html(content);
//			
//			_setOffer2ExcludeOfferSpecSub(param);
//			excludeAddattch(prodId,offerSpecId,param);
//			excludeAddServ(prodId,"",paramObj);
//		}
	};
	
	//关闭已开通功能产品(new)
	var _closeServSub = function(prodId,servId,state){
		var serv = CacheData.getServ(prodId,servId);
		var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
		if("13409244"==serv.servSpecId){//一卡双号虚号
			$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能");
		}else{ //关闭
			var uim = OrderInfo.getProdUim(prodId);
			if(serv.servSpecId=="280000020" && (OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23) && uim.cardTypeFlag=="1"){//补换卡补4G卡不能退订4G上网功能产品
				$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");
				return;
			}

			$span.addClass("del");
			serv.isdel = "Y";
		}
	};
	//把选中的服务保存到销售品规格中 第二步
	var _setServ2OfferSpecSub = function(prodId,offerSpec,roles){
		if(offerSpec!=undefined){
			$.each(offerSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					var nowProd=prodId+"_"+this.objId;
					
					$(roles).each(function(i,role) { 
						var oldProd=role.prodId+"_"+role.objId;
							
						if(nowProd==oldProd){
							this.selQty = 1;
							return false;
						}else{
							this.selQty = 2;
						}
					});
				});
			});
		}
	};
	
	//校验发展人类型,并获取发展人类型列表
	var _getDealerTypeSub = function(objInstId,objId){
		var dealerType = "";
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":40020005,"NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":40020006,"NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":40020007,"NAME":"第三发展人"}];
		}
		if(OrderInfo.order.dealerTypeList!=undefined && OrderInfo.order.dealerTypeList.length>0){ //发展人类型列表
			$.each(OrderInfo.order.dealerTypeList,function(){
				var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
				var flag = true;
				$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
					if(dealerTypeId==$(this).val()){  //如果已经存在
						flag = false;
						return false;
					}
				});
				if(flag){ //如果发展人类型没有重复
					dealerType = dealerTypeId;
					return false;
				}
			});
		}else{
			$.alert("信息提示","没有发展人类型");
			return;
		}
		if(dealerType==undefined || dealerType==""){	
			$.alert("信息提示","每个业务发展人类型不能重复");
			return;
		}
		var $td = $('<td></td>'); //发展人类型
		var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		$.each(OrderInfo.order.dealerTypeList,function(){
			if(this.PARTYPRODUCTRELAROLECD==dealerType){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>");
			}else{
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			}
		});
		$td.append($select);
		$td.append('<label class="f_red">*</label>');
		return $td;
	};
	
	//解析互斥依赖返回结果
	var _paserOfferData = function(result,prodId,offerSpecId,specName){
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
				excludeOffer : [],   //互斥依赖显示列表
				defaultOffer : [], //默选的显示列表
				dependOffer : {  //存放互斥依赖列表
					dependOffers : [],
					offerGrpInfos : []
				}
		};
		if(result!=""){
			var exclude = result.offerSpec.exclude;
			var depend = result.offerSpec.depend;
			var defaultOffer=result.offerSpec.defaultList;
			//解析可选包互斥依赖组
			if(ec.util.isArray(exclude)){
				for (var i = 0; i < exclude.length; i++) {
					var offerList = CacheData.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
						param.excludeOffer.push(exclude[i].offerSpecId);
					}
				}
			}
			if(depend!=undefined && ec.util.isArray(depend.offerInfos)){
				for (var i = 0; i < depend.offerInfos.length; i++) {	
					content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
				}	
			}
			if(depend!=undefined && ec.util.isArray(depend.offerGrpInfos)){
				for (var i = 0; i < depend.offerGrpInfos.length; i++) {
					var offerGrpInfo = depend.offerGrpInfos[i];
					param.dependOffer.offerGrpInfos.push(offerGrpInfo);
					content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
					if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
						for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
							var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
							var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);
							if(ec.util.isObj(offerSpec)){
								if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
									content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}else{
								var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);
								if(ec.util.isObj(offerSpec)){
									if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
										content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}else{
										content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}
						}
					}
				}
			}
			//解析可选包默选组
			if(ec.util.isArray(defaultOffer)){
				for (var i = 0; i < defaultOffer.length; i++) {	
					content += "需要开通： " + defaultOffer[i].offerSpecName + "<br>";
					param.defaultOffer.push(defaultOffer[i].offerSpecId);
				}	
			}
		}
		var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);//查询销售品构成成员的依赖互斥以及连带
		content=content+serContent;
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenList(prodId,offerSpecId); 
		}else{	
			content = "<div style='max-height:300px;overflow:auto;'>" + content + "</div>";
			$.confirm("订购： " + specName,content,{ 
				yes:function(){
					CacheData.setOffer2ExcludeOfferSpec(param);
				},
				yesdo:function(){
					AttachOffer.excludeAddattch(prodId,offerSpecId,param);
					AttachOffer.excludeAddServ(prodId,"",paramObj);
				},
				no:function(){
					
				}
			});
		}
	};
	//互斥依赖时添加
	var _excludeAddattch = function(prodId,specId,param){
		if(param.dependOffer.offerGrpInfos.length>0){  // 依赖组
			var dependOffer=param.dependOffer;
			for (var i = 0; i < dependOffer.offerGrpInfos.length; i++) {
				var offerGrpInfo = dependOffer.offerGrpInfos[i];
				var len  = offerGrpInfo.checkLen;
				if(len>=offerGrpInfo.minQty&&len<=offerGrpInfo.maxQty){
					$.each(offerGrpInfo.subOfferSpecInfos,function(){
						if(this.isCheck){
							AttachOffer.addOpenList(prodId,this.offerSpecId); 
						}
					});
				}else if(len<offerGrpInfo.minQty){
					$.alert("提示信息","依赖组至少选中"+offerGrpInfo.minQty+"个！");
					return;
				}else if(len>offerGrpInfo.maxQty){
					$.alert("提示信息","依赖组至多选中"+offerGrpInfo.maxQty+"个！");
					return;
				}else {
					$.alert("错误信息","依赖组选择出错！");
					return;
				}
			}
		}
		
		AttachOffer.addOpenList(prodId,specId); //添加开通附属
		if(param.excludeOffer.length>0){ //有互斥
			//删除已开通
			for (var i = 0; i < param.excludeOffer.length; i++) {
				var excludeSpecId = param.excludeOffer[i];
				var spec = CacheData.getOfferSpec(prodId,excludeSpecId);
				if(spec!=undefined){
					var $span = $("#li_"+prodId+"_"+excludeSpecId).find("span");
					$span.addClass("del");
					spec.isdel = "Y";
					$("#terminalUl_"+prodId+"_"+excludeSpecId).remove();
				}
				var offer = CacheData.getOfferBySpecId(prodId,excludeSpecId);
				if(offer!=undefined){
					var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
					$span.addClass("del");
					offer.isdel = "Y";
				}
			}
		}
		if(param.dependOffer.dependOffers.length>0){ // 依赖
			for (var i = 0; i < param.dependOffer.dependOffers.length; i++) {
				var offerSpecId = param.dependOffer.dependOffers[i];
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}
		}
		if(param.defaultOffer.length>0){ // 默选
			for (var i = 0; i < param.defaultOffer.length; i++) {
				var offerSpecId = param.defaultOffer[i];
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}
		}
		/*if(objType == "OFFER"){
			AttachOffer.addOpenList(prodId,specId); //添加开通附属
			if(param.excludeOffer.length>0){ //有互斥
				//删除已开通
				for (var i = 0; i < param.excludeOffer.length; i++) {
					var excludeSpecId = param.excludeOffer[i];
					var spec = AttachOffer.getSpec(prodId,excludeSpecId);
					if(spec!=undefined){
						var $span = $("#li_"+prodId+"_"+excludeSpecId).find("span");
						$span.addClass("del");
						spec.isdel = "Y";
					}
					var offer = AttachOffer.getOfferBySpecId(prodId,excludeSpecId);
					if(offer!=undefined){
						var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
						$span.addClass("del");
						offer.isdel = "Y";
					}
				}
			}
			if(param.dependOffer.dependOffers.length>0){ // 依赖
				for (var i = 0; i < param.dependOffer.dependOffers.length; i++) {
					var offerSpecId = param.dependOffer.dependOffers[i];
					AttachOffer.addOpenList(prodId,offerSpecId); 
				}
			}
		}else{
			AttachOffer.addOpenServList(prodId,specId); //添加开通功能
			if(param.excludeServ!=undefined && param.excludeServ.length>0){ //有互斥
				//删除已开通
				for (var i = 0; i < param.excludeServ.length; i++) {
					var excludeServSpecId = param.excludeServ[i].servSpecId;
					var spec = CacheData.getServSpec(prodId,excludeServSpecId);
					if(spec!=undefined){
						var $span = $("#li_"+prodId+"_"+excludeServSpecId).find("span");
						$span.addClass("del");
						spec.isdel = "Y";
					}
					var serv = AttachOffer.getServ(prodId,excludeServSpecId);
					if(serv!=undefined){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.addClass("del");
						serv.isdel = "Y";
					}
				}
			}
			if(param.dependServ!=undefined&&param.dependServ.length>0){ // 依赖
				for (var i = 0; i < param.dependServ.length; i++) {
					var servSpecId = param.dependServ[i].servSpecId;	
					var newSpec = {
						objId : servSpecId, //调用公用方法使用
						servSpecId : servSpecId,
						servSpecName : param.dependServ[i].servSpecName,
						ifParams : param.dependServ[i].ifParams,
						isdel : "C"   //加入到缓存列表没有做页面操作为C
					};
					var inPamam = {
						prodSpecId:servSpecId
					};
					if("Y"  == newSpec.ifParams){
						var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
						if(data==undefined || data.result==undefined){
							return;
						}
						newSpec.prodSpecParams = data.result.prodSpecParams;
					}
					CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
					AttachOffer.addOpenServList(prodId,servSpecId); 
				}
			}
		}*/
	};
	//查询销售品对象的互斥依赖连带的关系
	var _servExDepReByRoleObjs=function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		paramObj.excludeServ=[];//初始化
		paramObj.dependServ=[];//初始化
		paramObj.relatedServ=[];//初始化
		var globContent="";
		$.each(newSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objType==4 && this.selQty==1){
						var servSpec = CacheData.getServSpec(prodId,this.objId); //在已选列表中查找
						if(servSpec==undefined){   //在可订购功能产品里面 
							var serv = CacheData.getServBySpecId(prodId,this.objId); //在已开通列表中查找
							if(serv==undefined){
								var newServSpec = {
										objId : this.objId, //调用公用方法使用
										servSpecId : this.objId,
										servSpecName : this.objName,
										ifParams : this.isCompParam,
										prodSpecParams : this.prodSpecParams,
										isdel : "C"   //加入到缓存列表没有做页面操作为C
								};
								CacheData.setServSpec(prodId,newServSpec); //添加到已开通列表里
								servSpec = newServSpec;
							}else{
								servSpec=serv;
							}
						}
						var servSpecId = servSpec.servSpecId;
						var param = CacheData.getExcDepServParam(prodId,servSpecId);
						if(param.orderedServSpecIds.length == 0){
//							AttachOffer.addOpenServList(prodId,servSpecId,servSpec.servSpecName,servSpec.ifParams);
						}else{
							var data=query.offer.queryExcludeDepend(param);//查询规则校验
							var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);
							if(content!=""){
								content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);
								globContent+=(content+"<br>");
							}
						}
				}
			});
		});
		return globContent;
	};
	//转换接口返回的互斥依赖
	var paramObj = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
	};
	var _queryOfferInst = function(param,callBackFun) {
		var url= contextPath+"/offer/queryOfferInst";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品实例失败,稍后重试");
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品实例失败,稍后重试");
			}
		}
	};
	
	//点击确认，添加附属销售品发展人
	var _addAttachDealerSub = function(id,accessNumbe,objName){
		var prodId = id.split("_")[0];
		if($("#tr_"+id)[0]==undefined){ //没有添加过
			var objId = id+"_"+OrderInfo.SEQ.dealerSeq;
			var $tdType = _getDealerTypeSub(id,objId);
			if($tdType==undefined){
				return false;
			}
			var $tr = $("#atr_"+id);
			var $newTr = $('<tr name="tr_'+id+'"></tr>');
			$newTr.append("<td>"+accessNumbe+"</td>");
			$newTr.append("<td>"+objName+"</td>");
			$newTr.append($tdType);
			
			var dealer = $("#tr_"+prodId).find("input"); //产品协销人
			var staffId = 1;
			var staffName = "";
			if(dealer[0]==undefined){
				staffId = OrderInfo.staff.staffId;
				staffName = OrderInfo.staff.staffName;
			}else {
				staffId = dealer.attr("staffId");
				staffName = dealer.attr("value");
			}
			if(order.ysl!=undefined){
				var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" style="margin-left:45px;"></input></td>');
			}else{
				var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>');
			}
			$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');	
			$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
			$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+id+'\')">添加</a><label class="f_red">*</label>');
			$newTr.append($td);
			$("#dealerTbody").append($newTr);
			OrderInfo.SEQ.dealerSeq++;
		}
	};
	
	//初始化省内订单属性
	var _initOrderProvAttr = function(){
		if($("#orderProvAttrIsale")){
			$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale);
		}
		var url=contextPath+"/order/provOrderAttrFlag";
		$.ecOverlay("<strong>正在查询是否显示省内订单属性,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,{});	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data!=undefined){
				if("0"==response.data){
					$("#orderProvAttrDiv").show();
				}
			}
		}
	};
	
	//删除已订购可选包(new)
	var _delOfferSub = function(prodId,offerId){
		var $span = $("#li_"+prodId+"_"+offerId).find("span"); //定位删除的附属
		
		if($span.attr("class")=="del"){  //已经退订，再订购
			//二次加载，如果销售品原本就是删除的，不用操作
			//AttachOffer.addOffer(prodId,offerId,$span.text());
		}else { //退订
			var offer = _getOffer(prodId,offerId);

			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offerId	
				};
				if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
						if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
							param.areaId = OrderInfo.oldprodInstInfos[i].areaId;
							param.acctNbr = OrderInfo.oldprodInstInfos[i].accNbr;
						}
					}
				}else{
					param.acctNbr = OrderInfo.getAccessNumber(prodId);
				}
				var dataes = order.uiCustes.queryOfferInst(param);
				if(dataes==undefined){
					return;
				}
				//遍历附属的构成要和主套餐的构成实例要一致（兼容融合套餐）
				var offerMemberInfos=[];
				$.each(dataes.offerMemberInfos,function(){
					var prodInstId=this.objInstId;
					var flag=false;
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objInstId==prodInstId){
							flag=true;
							return false;
						}
					});
					if(flag){
						offerMemberInfos.push(this);
					}
				});
				
				offer.offerMemberInfos = dataes.offerMemberInfos=offerMemberInfos;
				offer.offerSpec = dataes.offerSpec;
			}
			var content = "";
			if(offer.offerSpec!=undefined){
				content = CacheData.getOfferProdStr(prodId,offer,1);
			}
			//这里原先是有弹窗提示的，二次加载就不需要了，原方法：_delOffer
			offer.isdel = "Y";
			$span.addClass("del");
			delServByOffer(prodId,offer);
		}
	};
	
	//删除附属销售品带出删除功能产品
	var delServByOffer = function(prodId,offer){	
		$.each(offer.offerMemberInfos,function(){
			var servId = this.objInstId;
			if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){
				var serv = CacheData.getServ(prodId,servId);
				if(ec.util.isObj(serv)){
					serv.isdel = "Y";
					var $li = $("#li_"+prodId+"_"+servId);
					$li.removeClass("canshu").addClass("canshu2");
					$li.find("span").addClass("del"); //定位删除的附属
				}
			}
		});
	};
	//获取销售品实例构成new
	var _getOffer = function(prodId,offerId){
		
		var offerList = order.uiCustes.getOfferList(prodId);
		//$.alert(JSON.stringify(offerList));
		if(ec.util.isArray(offerList)){
			for ( var i = 0; i < offerList.length; i++) {
				if(offerList[i].offerId==offerId){
					return offerList[i];
				}
			}
		}
	};
	
	//开通功能产品
	var _openServ = function(prodId,serv){
		if(serv!=undefined){   //在可订购功能产品里面 
			if(serv.servSpecId==""){
				var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
				$span.removeClass("del");
				serv.isdel = "N";
			}else{
				AttachOffer.checkServExcludeDepend(prodId,serv);
			}
		}
	};
	
	//开通功能产品
	var _openServSpecSub = function(prodId,servSpecId,specName,ifParams){
		var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
		if(servSpec==undefined){   //在可订购功能产品里面 
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : specName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			if(servSpecId==CONST.YZFservSpecId){//翼支付助手根据付费类型改变默认值
				var feeType = $("select[name='pay_type_-1']").val();
				if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
				if(feeType == CONST.PAY_TYPE.AFTER_PAY){
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {
						var prodSpecParam = newSpec.prodSpecParams[j];
						prodSpecParam.setValue = "";
					}																			
				}else{
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {							
						var prodSpecParam = newSpec.prodSpecParams[j];
						if (prodSpecParam.value!="") {
							prodSpecParam.setValue = prodSpecParam.value;
						} else if (!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!="")
							//默认值为空则取第一个
							prodSpecParam.setValue = prodSpecParam.valueRange[0].value;
				}
			  }
			}
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			servSpec = newSpec;
		}
		
		_checkServExcludeDepend(prodId,servSpec);
	};
	//解析服务互斥依赖
	var paserServData = function(result,prodId,serv){
		var servSpecId = serv.servSpecId;
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
		};
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					//scontent += "需要关闭：   " + this.servSpecName + "<br>";
					param.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.dependServ.push(this);
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.relatedServ.push(this);
			});
		}
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{	
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
			AttachOffer.excludeAddServ(prodId,servSpecId,param);
		}
	};
	//校验服务的互斥依赖
	var _checkServExcludeDepend = function(prodId,serv,flag){
		var servSpecId = serv.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		if(param.orderedServSpecIds.length == 0){
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserServData(data.result,prodId,serv);//解析数据
			}
		}
	};
	//通过产品id获取产品已开通附属实例列表
	var _getOfferList = function (prodId){
		for ( var i = 0; i < AttachOffer.openedList.length; i++) {
			var opened = AttachOffer.openedList[i];
			if(opened.prodId == prodId){
				return opened.offerList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	var _addOfferSpec = function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		CacheData.setServ2OfferSpec(prodId,newSpec);
	};
	
	//uim卡
	
	//uim卡号校验
	var _checkUim = function(prodId,bo2Coupons){
	
		var phoneNumber = OrderInfo.getAccessNumber(prodId);
		var offerId = "-1"; //新装默认，主销售品ID
		/*
		if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){ //新装需要选号
			if(phoneNumber==''){
				$.alert("提示","校验UIM卡前请先选号!");
				return false;
			}
		}
		*/
		if(OrderInfo.actionFlag==3 || OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23 || OrderInfo.actionFlag==6 ){ //可选包变更，补换卡，加装副卡
			if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//判断是否是纳入老用户
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.prodInstId==prodId){
						offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
					}
				});
			}else{
				offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
			}
		}
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		/*
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}
		*/
		var inParam = {
			"instCode" : cardNo,
			"phoneNum" : phoneNumber,
			"areaId"   : OrderInfo.getProdAreaId(prodId)
		};

		var prodSpecId = OrderInfo.getProdSpecId(prodId);
		var mktResCd="";
		if(CONST.getAppDesc()==0){
			if(getIsMIFICheck(prodId)){
				mktResCd =prod.uim.getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID);
			}else{
				mktResCd = prod.uim.getMktResCd(prodSpecId);
			}
			if(ec.util.isObj(mktResCd)){
//				inParam.mktResCd = mktResCd;
			}else{
				//$.alert("提示","查询卡类型失败！");
				return;
			}
			if(OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23){ //补换卡和异地补换卡
				if(prod.changeUim.is4GProdInst){ //如果已办理4G业务，则校验uim卡是否是4G卡
					inParam.onlyLTE = "1";
				}
			}
		}
		//var data = query.prod.checkUim(inParam);//校验uim卡
  
			var uimData = {
					prodId :  prodId, //产品ID
					isWireBusi : "",
					isWireUIM : false, //判断是否为无线上网卡
					wireType : 0, //1-普通上网卡 2-全球上网卡 0-默认
					uimCode  : bo2Coupons.couponInstanceNumber,//data.baseInfo.mktResInstCode,
					uimName  : ""//data.baseInfo.mktResName
			};
			/*
			$.each(data.attrList, function() {
				if (this.attrId == '60020007') {
					uimData.isWireUIM = true;
					uimData.wireType = this.attrValue;
					return false;
				}
			});
			*/
			if(uimData.isWireUIM){
				if (prodSpecId == CONST.PROD_SPEC.CDMA) {
					uimData.isWireBusi = 1; // 上网卡 - 移动电话业务
				}
			}else{
				if(prodSpecId == CONST.PROD_SPEC.DATA_CARD){
					uimData.isWireBusi = 2; // 普通卡 - 无线业务
				}
			}
			OrderInfo.clearCheckUimData(prodId);
			OrderInfo.checkUimData.push(uimData);
		//根据uim返回数据组织物品节点
		var couponNum = bo2Coupons.couponNum;//data.baseInfo.qty ;
		if(couponNum==undefined||couponNum==null){
			couponNum = 1 ;
		}
		var coupon = {
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "1",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId :bo2Coupons.couponId, //data.baseInfo.mktResId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : "3000", //物品费用项类型
			couponNum : couponNum, //物品数量
			storeId : bo2Coupons.storeId,//data.baseInfo.mktResStoreId, //仓库ID
			storeName : "1", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : bo2Coupons.terminalCode,//data.baseInfo.mktResInstCode, //物品实例编码
			terminalCode : bo2Coupons.terminalCode,//data.baseInfo.mktResInstCode,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId :  prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "ADD", //动作
			relaSeq : "" //关联序列	
		};
		if(CONST.getAppDesc()==0){
			coupon.cardTypeFlag=bo2Coupons.cardTypeFlag;//UIM卡类型
		}
		$("#uim_check_btn_"+prodId).attr("disabled",true);
		$("#uim_check_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
		$("#uim_release_btn_"+prodId).attr("disabled",false);
		$("#uim_release_btn_"+prodId).removeClass("disablepurchase").addClass("purchase");
		$("#uim_txt_"+prodId).attr("disabled",true);
		if(getIsMIFICheck(prodId)){//判断是否通过MIFI 校验
			$("#isMIFI_"+prodId).val("yes");
		}else{
			$("#isMIFI_"+prodId).val("no");
		}
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
		if(OrderInfo.actionFlag==22 && bo2Coupons.cardTypeFlag==1 && order.prodModify.choosedProdInfo.productId != '280000000'){
		//	_queryAttachOffer();
		  AttachOffer.queryCardAttachOffer(bo2Coupons.cardTypeFlag);  //加载附属销售品
	    }
		// 办理上网卡套餐，UIM校验当卡为全球上网卡自动带出天翼宽带-国际及港澳台数据漫游
		if (OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 14) {
			if (uimData.isWireUIM && uimData.wireType == '02'
					&& prodSpecId == CONST.PROD_SPEC.DATA_CARD) {
				// AttachOffer.openServSpec(prodId,13409441,'天翼宽带-国际及港澳台数据漫游','N');
				AttachOffer.addOpenServList(prodId,
						CONST.PROD_SPEC_ID.WIRE_GLOBAL, '天翼宽带-国际及港澳台数据漫游', 'N');
				var $li = $("#li_" + prodId + "_"
						+ CONST.PROD_SPEC_ID.WIRE_GLOBAL);
				if ($li.length > 0) {
					$li.find("dd").removeClass("delete").addClass("mustchoose")
							.attr("onclick", '');
				}
			}
		}
	};
	
	
	
	var getIsMIFICheck=function(prodId){
		var prodIdTmp=(Math.abs(prodId)-1);
		if(AttachOffer.openServList.length>prodIdTmp){
			var specList = AttachOffer.openServList[prodIdTmp].servSpecList;
			for (var j = 0; j < specList.length; j++) {
				var spec = specList[j];
				if(spec.isdel!="Y" && spec.isdel!="C"){
					if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID && CONST.APP_DESC==0){
						return true ; 
					}
				}
			}
		}
		return false;
	};
	//判断同一个终端组里面是否串码有重复的
	var _checkData=function(objInstId,terminalCode){
		var $input=$("input[id^=terminalText_"+objInstId+"]");
		var num=0;
		$input.each(function(){//遍历页面上面的串码输入框，为的是跟缓存里面的串码进行比对
			var instCode=$.trim(this.value);//页面上面的串码
			if(ec.util.isObj(instCode)&&terminalCode==instCode){
				num++;
			}
		});
		if(num>=2){
			$.alert("信息提示","终端串码重复了，请填写不同的串码。");
			return true ; 
		}
		return false;
	};
	//添加终端
	var addAndDelTerminal=function(prodId,offerSpecId,fag){

		var newSpec;
		var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
		if(ec.util.isObj(offer)){
			newSpec=offer;
		}else{
			newSpec = _setSpec(prodId,offerSpecId);
		}
		var objInstId = prodId+'_'+newSpec.offerSpecId;
		var maxNum=newSpec.agreementInfos[0].maxNum;
		var minNum=newSpec.agreementInfos[0].minNum;

		var $ul=$("#ul_"+objInstId);
		var $li=$("#ul_"+objInstId+" li");
		var length=$li.length-1;

		var isFastOffer = 0 ;
		if(ec.util.isArray(newSpec.extAttrParams)){
			$.each(newSpec.extAttrParams,function(){
				if(this.attrId == CONST.OFFER_FAST_FILL){
					isFastOffer = 1;
					return false;
				}
			});
		}
		if(fag==0){//添加终端
			if(AttachOffer.totalNums>=maxNum){
				$.alert("信息提示","终端数已经达到最大，不能再添加了。");
				return;
			}

			var $liTerminalAdd=$('<li><label>终端校验：</label><input id="terminalText_'+objInstId+'_'+(length/2+1)+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />'
					+'<input id="terminalBtn_'+objInstId+'_'+(length/2+1)+'" type="button" flag="'+isFastOffer+'" num="'+(length/2+1)+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" value="校验" class="purchase" style="float:left"></input></li>');
			var $liAdd = $('<li id="terminalDesc_'+(length/2+1)+'" style="white-space:nowrap;"><label></label><label id="terminalName_'+(length/2+1)+'"></label></li>');
			
			$ul.append($liTerminalAdd).append($liAdd);
			AttachOffer.totalNums++;
		}else{//删除终端
			if(minNum==(length/2)){
				$.alert("信息提示","终端数已经达到最小，不能再删除了。");
				return;
			}
			$li.each(function(index){
				if(length-1==index){
					$(this).remove();
				}else if(length==index){
					_filterAttach2Coupons(prodId,offerSpecId,(index/2));
					$(this).remove();
				}
				
			});
			AttachOffer.totalNums--;
		}
	};
	//过滤 同一个串码输入框校验多次，如果之前有校验通过先清空
	var filterAttach2Coupons=function(prodId,offerSpecId,num){
		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
			var attach2Coupon = OrderInfo.attach2Coupons[i];
			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId&&attach2Coupon.num==num){
				OrderInfo.attach2Coupons.splice(i,1);
				$("#terminalName_"+num).html("");
				break;
			}
		}
	};
	var _checkTerminal = function(param){
		var url = contextPath+"/mktRes/terminal/checkTerminal";
		$.ecOverlay("<strong>终端校验中,请稍后....</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == -2) {
			$.alertM(response.data);
		}else if(response.data && response.data.code == 0) {
			return response.data;
		}else if( response.data.code == 1){
			$.alert("提示", response.data.message);
		}else{
			$.alert("提示","<br/>校验失败，请稍后重试！");
		}
	};
	//终端校验
	var checkTerminalCode = function(prodId,offerSpecId,num,flag){


		if(flag==undefined){
			flag = 0 ;
		}
		
		//清空旧终端信息
		filterAttach2Coupons(prodId,offerSpecId,num);
		
		var objInstId = prodId+"_"+offerSpecId;

		var resIdArray = [];
		var terminalGroupIdArray = [];
		$("#"+objInstId+"  option").each(function(){
			resIdArray.push($(this).val());
		});
		$("#group_"+objInstId+"  option").each(function(){
			terminalGroupIdArray.push($(this).val());
		});
		var resId = resIdArray.join("|"); //拼接可用的资源规格id
		var terminalGroupId = terminalGroupIdArray.join("|"); //拼接可用的资源终端组id
		if((resId==undefined || $.trim(resId)=="") && (terminalGroupId==undefined || $.trim(terminalGroupId)=="")){
			$.alert("信息提示","终端规格不能为空！");
			return;
		}
		var instCode = $("#terminalText_"+objInstId + "_"+num).val();
		if(instCode==undefined || $.trim(instCode)==""){
			$.alert("信息提示","终端串码不能为空！");
			return;
		}
		if(_checkData(objInstId,instCode)){
			return;
		}
		var param = {
			instCode : instCode,
			flag : flag,
			mktResId : resId
	//		termGroup : terminalGroupId   update by huangjj #13336需求资源要求这个参数不传
		};
		var data = query.prod.checkTerminal(param);
		if(data==undefined){
			return;
		}
		var activtyType ="";
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C" && ec.util.isArray(spec.agreementInfos)){  //订购的附属销售品
                    if(spec.agreementInfos[0].activtyType == 2){
                    	activtyType = "2";
				    }
				}
			}
		}
		if(data.statusCd==CONST.MKTRES_STATUS.USABLE || (data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2")){
			//$.alert("信息提示",data.message);

			var mktPrice=0;//营销资源返回的单位是元
			var mktColor="";
			if(ec.util.isArray(data.mktAttrList)){
				$.each(data.mktAttrList,function(){
					if(this.attrId=="65010058"){
						mktPrice=this.attrValue;
					}else if(this.attrId=="60010004"){
						mktColor=this.attrValue;
					}
				});
			}
			//$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");
			$("#terminalDesc_"+num).css("display","block");

			var coupon = {
				couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : data.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
				couponNum : 1, //物品数量
				storeId : data.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : mktPrice, //物品价格,约定取值为营销资源的
				couponInstanceNumber : data.instCode, //物品实例编码
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId : prodId, //产品ID
				offerId : -1, //销售品实例ID
				attachSepcId : offerSpecId,
				state : "ADD", //动作
				relaSeq : "", //关联序列	
				num	: num //第几个串码输入框
			};
			if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2"){//“已销售未补贴”的终端串码可以办理话补合约
				coupon.couponSource ="2"; //串码话补标识
			}
			if(CONST.getAppDesc()==0){
				coupon.termTypeFlag=data.termTypeFlag;
			}
			OrderInfo.attach2Coupons.push(coupon);
		}else if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){
			$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用");
		}else{
			//$.alert("提示",data.message);
		}
	};
	
	/**
	 * 已订购产品查询（选中产品）
	 */
	var _linkQueryOffer=function(selected){
	
		//3G用户标识
		$("#is3GCheckbox").off().change(function() { 
			order.prodModify.getChooseProdInfo();
		}); 
		
		//勾取消
		$("#phoneNumListtbody tr").filter(".plan_select").children(":first-child").html("");
		$("#phoneNumListtbody tr").filter(".plan_select")
			.removeClass("plan_select").next("#plan2ndTr").hide();
		$(selected).addClass("plan_select").next("#plan2ndTr").show();
		//打勾操作
		var nike="<i class='select'></i>";
		$(selected).children(":first-child").html(nike);
		
		$(selected).next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();
		
		//order.prodModify.orderAttachOffer();
		//跳转到套餐更新页面
		
		OrderInfo.busitypeflag=2
		$("#custInfo").hide();
		OrderInfo.actionFlag = 2;
		if(OrderInfo.provinceInfo.mergeFlag=="0"){
			if(!query.offer.setOffer()){ //必须先保存销售品实例构成，加载实例到缓存要使用
				return ;
			}
		}
		$("#custInfo").hide();
		
		var boInfos;
		var prodInfo = order.prodModify.choosedProdInfo;
		var nowIs3G=order.prodModify.choosedProdInfo.is3G;
		if(nowIs3G=="Y"){
			boInfos=[{
				boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER,
				specId : CONST.PROD_SPEC.CDMA,
			},{
				boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER,
				specId : CONST.PROD_SPEC.CDMA,
			}];
		}else{
			boInfos=[{
				boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER,
				instId : prodInfo.prodInstId,
				specId : CONST.PROD_SPEC.CDMA,
				prodId : prodInfo.prodInstId
			},{
				boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER,
				instId : prodInfo.prodInstId,
				specId : CONST.PROD_SPEC.CDMA,
				prodId : prodInfo.prodInstId
			}];
		}
		
		//进行规则校验
		if(!rule.rule.ruleCheck(boInfos)){
			return;
		}
		
		//如果是二次加载 
		if(OrderInfo.reloadFlag=="N"){
			order.uiCustes.buyService(OrderInfo.offid,"");
		}else{
			order.service.buyService(OrderInfo.offid,"");
		}
	};

	return {
		openServ:_openServ,
	//	getIsMIFICheck:_getIsMIFICheck,
		fromProvFlag : _fromProvFlag,
		orderInfo : _orderInfo,
		custQuery : _custQuery,
		queryCallBack : _queryCallBack,
		btnQueryCustProd : _btnQueryCustProd,
		showCustAuth : _showCustAuth,
		showPackageDialog : _showPackageDialog,
		closeServSub:_closeServSub,
		getOfferList:_getOfferList,
		openServSpecSub:_openServSpecSub,
		getDealerTypeSub:_getDealerTypeSub,
		excludeAddattch:_excludeAddattch,
		paserOfferData:_paserOfferData,
		servExDepReByRoleObjs:_servExDepReByRoleObjs,
		checkOfferExcludeDependSub:_checkOfferExcludeDependSub,
		setServ2OfferSpecSub:_setServ2OfferSpecSub,
		setSpec:_setSpec,
		addOfferSpecSub:_addOfferSpecSub,
		addAttachDealerSub:_addAttachDealerSub,
		queryOfferInst:_queryOfferInst,
		getOffer:_getOffer,
		delOfferSub:_delOfferSub,
		showOffer:_showOffer,
		initOrderProvAttr:_initOrderProvAttr,
		fillOfferChange:_fillOfferChange,
		buildMainView:_buildMainView,
		offerChangeView:_offerChangeView,
		opeSer:_opeSer,
		buyService:_buyService,
		btnQueryCustProd : _btnQueryCustProd,
		checkUim:_checkUim,
		linkQueryOffer:_linkQueryOffer
	};
})();

/**
 * 销售品产品相关查询
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("uiOfferQuery");

uiOfferQuery = (function() {
	
	/**
	 * 销售品规格构成查询
	 * @param  offerSpecId 销售品规格ID
	 * @param  offerTypeCd 销售品类型,销售品主 1 ,附属2  
	 * @param  mainOfferSpecId  主套餐id
	 * @param  partyId  客户ID
	 * @callBackFun 回调函数
	 */
	var _queryOfferSpec = function(param,callBackFun) {
		param.areaId = OrderInfo.cust.areaId;
		var url= contextPath+"/offer/queryOfferSpec";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data.offerSpec);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品规格构成失败,稍后重试");
					}
				}
			});
		}else{
			$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data.offerSpec;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品规格构成失败,稍后重试");
			}
		}
	};

	/**
	 * 销售品实例构成查询
	 * @param  offerId 销售品实例ID
	 * @param  areaId 地区ID
	 * @param  accessNumber 接入号
	 * @callBackFun 异步调用函数
	 */
	var _queryOfferInst = function(param,callBackFun) {
		var url= contextPath+"/offer/queryOfferInst";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						//$.alert("提示","查询销售品实例失败,稍后重试");
						order.uiCust.showPackageDialog("查询销售品实例失败,稍后重试!");
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				order.uiCust.showPackageDialog("查询销售品实例失败,稍后重试!");
				//$.alert("提示","查询销售品实例失败,稍后重试");
			}
		}
	};
	
	//根据选择产品查询销售品实例，并保存到OrderInfo.offer
	var _setOffer = function() {
		var prod = order.prodModify.choosedProdInfo ; 
		var param = {
			offerId : prod.prodOfferInstId,
			offerSpecId : prod.prodOfferId,
			acctNbr : prod.accNbr,
			areaId : prod.areaId,
			distributorId : ""
		};
		var data =_queryOfferInst(param); //查询销售品实例构成
		if(data&&data.code == CONST.CODE.SUCC_CODE){
			var flag = true;
			if(ec.util.isArray(data.offerMemberInfos)){
				CacheData.sortOffer(data);
				for ( var i = 0; i < data.offerMemberInfos.length; i++) {
					var member = data.offerMemberInfos[i];
					if(member.objType==""){
						$.alert("提示","销售品实例构成 "+member.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");
						return false;
					}else if(member.objType==CONST.OBJ_TYPE.PROD){
						/*if(member.objId==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品规格【objId】节点为空，无法继续受理,请营业后台核实");
							return false;
						}*/
						if(member.accessNumber==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
							return false;
						}
					}
					if(member.objInstId==prod.prodInstId){
						flag = false;
					}
				}
				if(flag){
					$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+prod.accNbr+"】，无法继续受理，请业务后台核实");
					return false;
				}
				OrderInfo.offer.offerMemberInfos = data.offerMemberInfos; 
				OrderInfo.offer.offerId = prod.prodOfferInstId;
				OrderInfo.offer.offerSpecId = prod.prodOfferId;
				OrderInfo.offer.offerSpecName = prod.prodOfferName;
				return true;
			}else{//销售品成员实例为空
				$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");
				return false;
			}
		}
	};
	
	//销售品参数查询
	var _queryOfferParam = function(param,callBackFun) {
		var url= contextPath+"/offer/queryOfferParam";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品实例参数失败,稍后重试");
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品实例参数失败,稍后重试");
			}
		}
	};	
	
	/**
	 * 已订购附属查询 
	 */
	var _queryAttachOfferHtml = function(param,callBackFun) {
		//获取订单填写页面new
		addParam(param);  //添加基本参数
		param.isServiceOpen="Y";
		var url = contextPath+"/token/pc/offer/queryAttachOfferSub";
		if(OrderInfo.actionFlag==22){
			url = contextPath+"/offer/queryAttachOffer2";
		}
		
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍候....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else {
						$.alert("提示","附属销售品实例查询失败,稍后重试");
						return;
					}
				}
			});
		}else{
			$.ecOverlay("<strong>查询附属销售品实例中，请稍候...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}		
	};
	
	/**
	 * 已订购销售品和功能产品
	 */
	var _queryOpenedAttachAndServ = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryOpenedAttachAndServ";
		$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else {
			$.alert("提示","查询附属销售品失败,稍后重试");
			return;
		}
	};
	
	//套餐变更，查询附属销售品页面
	var _queryChangeAttachOffer = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryChangeAttachOffer";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else {
						$.alert("提示","附属销售品实例查询失败,稍后重试");
						return;
					}
				}
			});
		}else{
			$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else {
				$.alert("提示","查询附属销售品实例失败,稍后重试");
				return;
			}
		}		
	};
	
	//附属销售品规格查询
	var _queryAttachSpec = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryAttachSpec";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
						return;
					}else {
						$.alert("提示","附属销售品查询失败,稍后重试");
						return;
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
				return;
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}
	};
	
	//加载附属标签下的附属销售品
	var _queryCanBuyAttachSpec = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryCanBuyAttachSpec";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
						return;
					}else {
						$.alert("提示","附属销售品查询失败,稍后重试");
						return;
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");
			var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
				return;
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}
	};
	
	// 查询默认必须可选包
	var _queryDefMustOfferSpec = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryDefaultAndRequiredOfferSpec";
		$.ecOverlay("<strong>查询默认必须可选包中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			OrderInfo.isSuccess = "Y";
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购功能产品失败,稍后重试");
			return;
		}
	};
	// 查询默认必须可选包 + 功能产品 (补换卡加可选包)
	var _queryDefMustOfferSpecAndServ = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryDefaultAndRequiredOfferSpecAndServ";
		$.ecOverlay("<strong>查询默认必须可选包和功能产品中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			OrderInfo.isSuccess = "Y";
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购可选包和功能产品失败,稍后重试");
			return;
		}
	};
	
	// 查询功能产品规格,(默认1，必须2，可订购3)
	var _queryServSpec = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryServSpec";
		$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购功能产品失败,稍后重试");
			return;
		}
	};
	
	//销售品互斥依赖查询
	var _queryExcludeDepend = function(param){
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryExcludeDepend";
		$.ecOverlay("<strong>规则校验中,请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","数据查询异常，请稍后重试！");
		}
	};
		
	//功能产品互斥依赖查询
	var _queryServExcludeDepend = function(param){
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryServExcludeDepend";
		$.ecOverlay("<strong>规则校验中,请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","数据查询异常，请稍后重试！");
		}
	};
	
	//查询附属销售品规格
	var _searchAttachOfferSpec = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/searchAttachOfferSpec";
		$.ecOverlay("<strong>附属销售品查询中，请稍等...</strong>");
		var response = $.callServiceAsHtmlGet(url,{strParam:encodeURI(JSON.stringify(param),"utf-8")});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","查询附属销售失败，请稍后重试！");
		}
	};
	
	//受理权限查询
	var _checkOperate = function(param) {
		var url = contextPath+"/order/checkOperate";
		$.ecOverlay("<strong>受理权限查询中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,"");
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","受理权限查询失败，请稍后重试！");
		}
	};
	
	//订单提交
	var _orderSubmit = function(param) {
		var url = contextPath+"/order/orderSubmit";
		if(OrderInfo.order.token!=""){
			url = contextPath+"/order/orderSubmit?token="+OrderInfo.order.token;
		}
		$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
		var response = $.callServiceAsHtml(url,param);
		$.unecOverlay();
		if(!response || response.code != 0){
			 return;
		}
		return response.data;
	};
	
	//订单提交（一次性）
	var _orderSubmitComplete = function(param) {
		var url = contextPath+"/order/orderSubmitComplete";
		if(OrderInfo.order.token!=""){
			url = contextPath+"/order/orderSubmitComplete?token="+OrderInfo.order.token;
		}
		$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if(!response || response.code != 0){
			 return;
		}
		return response.data;
	};	
	
	/**
	 * 查询主销售品规格构成
	 * 并对结果进行数据校验
	 */
	var _queryMainOfferSpec = function(param){
		var offerSpec = query.offer.queryOfferSpec(param); //查询主销售品构成
		if(offerSpec ==undefined){
			return false;
		}
		if( offerSpec.offerRoles ==undefined){
			$.alert("错误提示","销售品规格构成查询: 返回的销售品规格构成结构不对！");
			return false;
		}
		if(offerSpec.offerSpecId==undefined || offerSpec.offerSpecId==""){
			$.alert("错误提示","销售品规格构成查询: 销售品规格ID未返回，无法继续受理！");
			return false;
		}
		if(offerSpec.offerRoles.length == 0){
			$.alert("错误提示","销售品规格构成查询: 成员角色为空，无法继续受理！");
			return false;
		}
		if(offerSpec.feeType ==undefined || offerSpec.feeType=="" || offerSpec.feeType=="null"){
			$.alert("错误提示","无付费类型，无法新装！");
			return false;
		}
		offerSpec = SoOrder.sortOfferSpec(offerSpec); //排序主副卡套餐	
		if(OrderInfo.actionFlag==6 && ec.util.isArray(OrderInfo.oldprodInstInfos)){//主副卡纳入老用户
			OrderInfo.oldofferSpec.push({"offerSpec":offerSpec,"accNbr":param.accNbr});
		}else{
			OrderInfo.offerSpec = offerSpec;
		}
		return offerSpec;
	};
	
	/**
	 * 同步查询销售品规格构成
	 * 并对结果进行数据校验
	 */
	var _queryAttachOfferSpec = function(prodId,offerSpecId){
		var param = {
			offerSpecId:offerSpecId,
			partyId : OrderInfo.cust.custId,
			offerTypeCd:2	
		};	
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==2 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==14){//新装业务,添加主套餐id用于查询终端
			param.mainOfferSpecId = OrderInfo.offerSpec.offerSpecId;
		}
		if(OrderInfo.actionFlag==3){//可选包
			param.mainOfferSpecId = order.prodModify.choosedProdInfo.prodOfferId;
		}
		if(OrderInfo.actionFlag==21){//副卡换挡
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					if(this.prodId==prodId){
						param.mainOfferSpecId=this.offerSpecId;
						return false;
					}
				});
			}
		}
		var offerSpec = query.offer.queryOfferSpec(param); //查询主销售品构成
		if(offerSpec ==undefined || offerSpec.offerRoles ==undefined){
			$.alert("提示","返回的销售品规格构成结构不对！");
			return false;
		}
		if(offerSpec.offerSpecId==undefined || offerSpec.offerSpecId==""){
			$.alert("提示","销售品规格ID未返回，继续受理将出现异常！");
			return false;
		}
		if(offerSpec.offerSpecName==undefined || offerSpec.offerSpecName==""){
			$.alert("提示","销售品规格名称未返回，继续受理将出现异常！");
			return false;
		}
		var offerRoles = []; //过滤角色
		var prodSpecId = OrderInfo.getProdSpecId(prodId);
		var flag = false;
		$.each(offerSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objId==prodSpecId){
					flag = true;
					return false;
				}
			});
			if(flag){
				offerRoles.push(this);
				return false;
			}
		});
		offerSpec.offerRoles = offerRoles;
		return offerSpec;
	};
	
	//预校验
	var _updateCheckByChange = function(param){
		var url = contextPath+"/order/prodModify/updateCheckByChange";
		$.ecOverlay("<strong>正在预校验中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == 0) {
			return response.data;
		}else if (response.code == -2) {
			$.alertM(response.data);
		}else{
		    if (response.data.resultMsg) {
		        $.alert("提示","预校验失败!失败原因为："+response.data.resultMsg);
		    } else {
		        $.alert("提示","预校验失败! 集团营业后台未给出原因。");
		    }
		}
	};
	
	/**
	 * 加载实例
	 * 如果传入了paramInfo，则使用它，否则拼入参
	 */
	var _loadInst = function(){
		if(OrderInfo.order.soNbr==null || OrderInfo.order.soNbr==undefined || OrderInfo.order.soNbr==""){
			OrderInfo.order.soNbr = UUID.getDataId();
		}
		if(CONST.getAppDesc()!=0){ //不是4g不需要加载
			return true;
		}
		
		if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 14 || OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){ //新装不要加载实例
			return true;
		}
		
		if (order.prodModify == undefined) { // 如果没有引入orderProdModify.js
			$.alert("提示","未获取到产品相关信息，无法办理二次业务！");
			return false;
		}
		var prod = order.prodModify.choosedProdInfo;
		if(prod==undefined || prod.prodInstId ==undefined){
			$.alert("提示","未获取到产品相关信息，无法办理二次业务！");
			return false;
		}
		var param = {
			areaId : OrderInfo.getProdAreaId(prod.prodInstId),
			acctNbr : prod.accNbr,
			custId : OrderInfo.cust.custId,
			soNbr : OrderInfo.order.soNbr,
			instId : prod.prodInstId,
			type : "2"
		};
		
		var queryMergeFlag=OrderInfo.provinceInfo.mergeFlag;
		
		if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //遍历主销售品构成
			var flag = true;
			$.each(OrderInfo.offer.offerMemberInfos,function(){
				if(this.objType == CONST.OBJ_TYPE.PROD && this.accessNumber==prod.accNbr){ //选中号码在销售品实例构成中，为了防止销售品实例缓存
					flag = false;
					return false;
				}
			});
			
			if(flag){ //不在销售品实例缓存
				if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
					param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
					return query.offer.invokeLoadInstSub(param);
				}else{
					return query.offer.invokeLoadInst(param);
				}
			}else{
				var vFlag = true;
				
				//1调用新接口，如果是0，就是按照旧的方式调用
				if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD){
							param.data.push({accessNbr:this.accessNumber,instId:this.objInstId});
						}
					});
					
					if(param!=null){
						if (!query.offer.invokeLoadInstSub(param)) {
							vFlag = false;
							return false;
						}
					}
				}else{
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD){
							param.acctNbr = this.accessNumber;
							param.instId = this.objInstId;
							if (!query.offer.invokeLoadInst(param)) {
								vFlag = false;
								return false;
							}
						}
					});
				}
				
				return vFlag;
			}
		}else{
			if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
				param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
				return query.offer.invokeLoadInstSub(param);
			}else{
				return query.offer.invokeLoadInst(param);
			}
		}
	};
	
	//补充查询基本条件
	var addParam = function(param){
		param.staffId = OrderInfo.staff.staffId;
		param.channelId = OrderInfo.staff.channelId;
		param.areaId = OrderInfo.getProdAreaId(param.prodId);
		param.partyId = OrderInfo.cust.custId;
		param.distributorId = OrderInfo.staff.distributorId;
		if(OrderInfo.actionFlag == 3){
			param.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId;
		}else if(OrderInfo.actionFlag==21){
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					if(this.prodId==param.prodId){
						param.mainOfferSpecId=this.offerSpecId;
						return false;
					}
				});
			}
		}else{
			param.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId;
		}
		if(ec.util.isObj(OrderInfo.order.soNbr)){  //缓存流水号
			param.soNbr = OrderInfo.order.soNbr;
		}
		if(order.ysl!=undefined){
			if(order.ysl.yslbean.yslflag!=undefined){
				param.yslflag = order.ysl.yslbean.yslflag;
			}
		}
		if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
			for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
				if(param.acctNbr==OrderInfo.oldprodInstInfos[i].accNbr){
					param.areaId = OrderInfo.oldprodInstInfos[i].areaId;
					param.partyId = OrderInfo.oldprodInstInfos[i].custId;
					param.mainOfferSpecId=OrderInfo.oldprodInstInfos[i].mainProdOfferInstInfos[0].prodOfferId;
				}
			}
		}
	};
	
	var _invokeLoadInst = function(param) {
		order.prepare.createorderlonger();
		var url = contextPath+"/offer/loadInst";
		$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);
		$.unecOverlay();
		if (response.code== 0) {
			return true;
		}else if(response.code==-2){
			$.alertM(response.data);
			return false;
		}else {
			if (response.msg == undefined) {
				$.alert("提示", "全量信息查询失败");
			} else {				
				$.alert("提示",response.msg);
			}
			return false;
		}
	};
	
	/**
	 * 产品信息查询
	 */
	var _queryProduct = function(param) {
		var url = contextPath+"/cust/offerorderprod";
		$.ecOverlay("<strong>查询产品信息中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else {
			$.alert("提示","查询附属销售品失败,稍后重试");
			return;
		}
	};
	
	/**
	 * 查询产品实例属性
	 * param : {
	 * prodId : "", //产品实例id
	 * acctNbr : "", //接入号
	 * prodSpecId : "", //产品规格id
	 * areaId : "" //地区id
	 * }
	 */
	var _queryProdInstParam = function(param) {
		var url = contextPath+"/order/prodInstParam";
		$.ecOverlay("<strong>查询产品实例属性中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else {
			$.alert("提示","查询附属销售品失败,稍后重试");
			return;
		}
	};
	
	return {
		checkOperate			: _checkOperate,
		loadInst				: _loadInst,
		invokeLoadInst			: _invokeLoadInst,
		setOffer				: _setOffer,
		searchAttachOfferSpec	: _searchAttachOfferSpec,
		queryOfferSpec			: _queryOfferSpec,
		queryServSpec			: _queryServSpec,
		queryOfferInst 			: _queryOfferInst,
		queryOfferParam 		: _queryOfferParam,
		queryAttachOfferHtml	: _queryAttachOfferHtml,
		queryChangeAttachOffer  : _queryChangeAttachOffer,
		queryCanBuyAttachSpec 	: _queryCanBuyAttachSpec,
		queryExcludeDepend		: _queryExcludeDepend,
		queryServExcludeDepend	: _queryServExcludeDepend,
		queryAttachSpec			: _queryAttachSpec,
		queryMainOfferSpec		: _queryMainOfferSpec,
		queryAttachOfferSpec	: _queryAttachOfferSpec,
		queryDefMustOfferSpec	: _queryDefMustOfferSpec,
		queryDefMustOfferSpecAndServ : _queryDefMustOfferSpecAndServ,
		orderSubmit				: _orderSubmit,
		orderSubmitComplete		: _orderSubmitComplete,
		updateCheckByChange		: _updateCheckByChange,
		queryProduct			: _queryProduct,
		queryOpenedAttachAndServ: _queryOpenedAttachAndServ,
		queryProdInstParam		: _queryProdInstParam
	};
})();
//初始化
$(function(){
	$("#bill_list").delegate("ul.main_list_ul","click",function(event){
		event.preventDefault();
		ec.agent.page.pageNewLoad($(this).attr("url"));
		event.stopPropagation();
	});	
});

//初始化
$(function(){
	$("#main_list").delegate("ul.main_list_ul","click",function(event){
		event.preventDefault();
		ec.agent.page.pageNewLoad($(this).attr("url"));
		event.stopPropagation();
	});	
});

//初始化
$(function(){
	$("#main_list").delegate("ul.main_list_ul","click",function(event){
		event.preventDefault();
		ec.agent.page.pageNewLoad($(this).attr("url"));
		event.stopPropagation();
	});	
});

/**
 *
 * 首页
 * 
 * @author tang
 */
CommonUtils.regNamespace("main", "home");
//首页初始化
$(function(){
//main.home.queryNotice();   
  /*
	//首页中热卖套餐tab切换
   $(".selser_tab_panel:first").show();
   $(".side_nav li").each(function(index){
	 $(this).click(function(){
		$(this).addClass("current").siblings().removeClass("current");
		$(this).parents(".side_nav").siblings(".selser_tab_content").find(".selser_tab_panel").eq(index).show().siblings().hide();
		});
	});	
   	
   //首页中最新信息展示tab切换
   $(".news_tab_panel:first").show();
   $(".news_nav li").each(function(index){
	 $(this).click(function(){
		$(this).addClass("current").siblings().removeClass("current");
		$(this).parents(".news_nav").siblings(".news_tab_content").find(".news_tab_panel").eq(index).show().siblings().hide();
		});
	});
      	
   //首页中最新信息展示tab切换
   $(".phone_list:first").show();
   $(".main_title a").each(function(index){
	 $(this).click(function(){
		 
		 $(".goodsListInfor").eq(index).show().siblings().hide();

		$(this).addClass("current").siblings().removeClass("current");
		$(this).parents(".news_nav").siblings(".news_tab_content").find(".news_tab_panel").eq(index).show().siblings().hide();
		});
	});
   */

   
});
main.home = (function(){
	
	// Tab管理对象
	var _tabManager = {};
	
	/**
	 * 获得选中的TAB项.
	 */
	var _getSelectedTabItem = function() {
		var tabId = this.tabManager.getSelectedTabItemID();
		return $(".l-tab-content-item[tabid=" + tabId + "]");
	};
	
	var _getSelectedTabName = function() {
		return $("li.l-selected a").text();
	};
	
	var _addTab = function(tabid, text, url) {
		this.tabManager.addTabItem({tabid: tabid, text: text, url: url});
		
		$("#"+tabid).css("min-height","550px");
		$("#"+tabid).css("height","550px");
		
		$(".allsort").removeClass("showme");
		//$(".main_quick_div").css("display","none");
		$("#updateNews").css("margin-left","80px");
		$("#new").css("margin-left","100px").css("width","90%");
		$(".homecon").css("width","100%").css("margin-left","0px");
		//$("#div_main_index").removeClass("main_index").addClass("main_div");
		
		//		$("#" + tabid).after('<iframe frameborder="0" style="height: 548px; min-height: 551px; display: none;"></iframe>');
	};
	
	var _backTab = function(funName) {
		var tabItem = main.getSelectedTabItem();
		$("iframe:last", tabItem).removeAttr("src");
		$("iframe:first", tabItem).show();
		if (funName !== undefined) {
			var tabId = this.tabManager.getSelectedTabItemID();
			var dom = $("#" + tabId).get(0);
			//var win = $.browser.msie ? dom.window : dom.contentWindow;
			dom.contentWindow.window.eval(funName);
		}
	};
	
	var _loadTab = function(url) {
		var tabItem = main.getSelectedTabItem();
		var iframeloading = $(".l-tab-loading:first", tabItem);
		var iframe = $("iframe:last", tabItem);
		$("iframe:first", tabItem).hide();
		iframe.show();
		iframeloading.show();
		iframe.attr("src", url).unbind("load.tab").bind("load.tab", function() {
			iframeloading.hide();
		});
	};
	
	//首页请求公告
	var _queryNotice = function(bulletinId){
		
		var param = "";
		if(typeof(bulletinId) !="undefined"){ 
			 param = {
					bulletinId : bulletinId
			 };
		}
		$.callServiceAsHtmlGet(contextPath + "/main/notice",param, {
			"done" : function(response){
				
				
				if(typeof(bulletinId) !='undefined'){
					$(".detail").html(response.data);
					_createNoticeDialog();
					return;
				}
				
				if(!response){
					response = {};
					response.data='<li><a href="#" class="ft">暂无公告</a></li>';
				}
				
				$(".news").html(response.data);
				var _hasClass = $(".allsort").hasClass("showme");
				if(_hasClass){
					$("#updateNews").css("margin-left","190px");
					$("#new").css("margin-left","200px").css("width","82%");
				}
				/*if($(".item").css('display')!="none")
				{
					$("#updateNews").css("margin-left","200px");
					$("#new").css("margin-left","200px").css("width","82%");
				}*/
				var intervalTime = $("#intervalTime").val();
				if(intervalTime == ""){
					intervalTime = 3000;
				}
				
//				var box=document.getElementById("new"); 
//				var can=true;
//				box.innerHTML+=box.innerHTML; 
//				box.onmouseover=function(){can=false;}; 
//				box.onmouseout=function(){can=true;}; 
//				void function(){ 
//					var stop=box.scrollTop%41==0&&!can; 
//					if(!stop) {
//						box.scrollTop==parseInt(box.scrollHeight/2)?box.scrollTop=0:box.scrollTop++;
//					}
//					setTimeout(arguments.callee, box.scrollTop%41?10:intervalTime);
//				}();
				
				
				
			},
			fail:function(response){
				$.unecOverlay();
				//$.alert("提示","公告加载失败，请稍后再试！");
			}
		});
	};
	
	
	var _createNoticeDialog = function(){
		easyDialog.open({
			container : "ec-dialog-form-container-notice-items"
		});
		document.getElementById("ec-dialog-form-container-notice-items").setAttribute("style", "margin-top:40px;display: block;");
		$("#noticeItemsConCancel").click(function(){
			easyDialog.close();
		});
	};
	
	//首页请求已设置的快捷菜单
	var _queryMainShortcut = function(){
		$.callServiceAsHtmlGet(contextPath + "/menu/mainshortcut", {
			"done":function(response){
				$("#faster_ul").html(response.data).show();
			},
			fail:function(response){
				$.unecOverlay();
				//$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	
	var _hideMainIco = function(){
		$(".allsort").removeClass("showme");
		$(".main_quick_div").css("display","none");
		$("#updateNews").css("margin-left","80px");
		$("#new").css("margin-left","100px").css("width","90%");
//		$(".news").css("display","none");
		$(".homecon").css("width","100%").css("margin-left","0px");
		$("#div_main_index").removeClass("main_index").addClass("main_div");
	};
	
	/*****************************************************首页弹出框初始化调用函数*****************************************************/
	var _createDialog = function(){
		var _hasClass = $(".allsort").hasClass("showme");
		if(_hasClass){
			$(".allsort").removeClass("showme"); //打开弹出框的时候收起菜单导航
		}
		//登录窗口
		//校验是否已在异地登陆，先去除前台触发的校验，后续会在后端添加统一的验证
//		var response = $.callServiceAsJson(contextPath+"/staff/login/isLogin");
//		if (response.code !=0){
//			login.windowpub.alertLoginWindow(response.data);
//			return;
//		}
		//快捷菜单设置窗口
		easyDialog.open({
			container : "q_menu_dialog"
		});
		main.home.getMyList();
		main.home.getLv1();
		$("#q_menuclose").off("click").on("click",function(event){
			easyDialog.close();
			if(_hasClass){
				$(".allsort").addClass("showme"); //关闭弹出框的时候重新展开菜单导航
			}
			main.home.queryMainShortcut();
		});
	};

	/*******************************************************快捷菜单设置调用函数*******************************************************/			
		//(弹出框上部分)已设置的快捷菜单
		var _getMyList = function(){
			var param = {
					setShortcut : 1
			};
			$.callServiceAsHtmlGet(contextPath + "/menu/mainshortcut", param, {
				"always":function(){
					$.unecOverlay();
				},
				"done":function(response){
					$("#shortcut_getmylist").html(response.data).show();
				},
				fail:function(response){
					$.unecOverlay();
					$.alert("提示","请求可能发生异常，请稍后再试！");
				}
			});
		};
		
		//(弹出框下部分左侧)第一级菜单
		var _getLv1 = function(){
			var url = contextPath+"/menu/inquireLv1";
			$.callServiceAsHtmlGet(url,{
				"done":function(response){
					$("#parentslist").html(response.data).show();
					$("#first_level a:first").addClass("side_nav_hover");
					var parentId = $("#first_level").find("a[class=side_nav_hover]").attr("id");
					main.home.getLv2(parentId);
				}
			});
		};
		
		//点击第一级菜单项目切换第二级菜单
		var _changeParent = function(parentId){
			$("#first_level").find("a[class=side_nav_hover]").removeClass();
			$("#first_level").find("a[id="+parentId+"]").addClass("side_nav_hover");
			main.home.getLv2(parentId);
		};
		
		//(弹出框下部分右侧)第二级菜单
		var _getLv2 = function(parentId){
			var url = contextPath+"/menu/inquireLv2";
			var param = {"parentId":parentId};
			$.callServiceAsHtmlGet(url,param, {
				"before":function(){
					$.ecOverlay("<strong>菜单查询中,请稍等...</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done":function(response){
					if(response.data == ""){
						$("#son_list").html("<font style='color:#FA3D03;'>您没有权限添加此菜单</font>").show();
					}else {
						$("#son_list").html(response.data).show();
						$("#shortcut_getmylist").find("li").each(function(){
							var menuId=$(this).attr("id");
							var menu$=$("#second_level").find("ul[id="+menuId+"]");
							if(menu$ && menu$.length>0){
								menu$.addClass("ul_sel").removeAttr("onclick").css("cursor", "auto").find("a.close").show();	
							}
						});	
					}
				}
			});
		};
		
		//(弹出框下部分右侧)第三级菜单
		var _getLv3 = function(grandParentId, parentId){
			var url = contextPath+"/menu/inquireLv3";
			var param = {
					"grandParentId":grandParentId,
					"parentId":parentId
			};
			$.callServiceAsHtmlGet(url,param, {
					"before":function(){
					$.ecOverlay("<strong>菜单查询中,请稍等...</strong>");
				},"always":function(){
					$.unecOverlay();
				},
				"done":function(response){
					if(response.data == ""){
						$("#son_list").html("<font style='color:#FA3D03;'>您没有权限添加此菜单</font>").show();
					}else {
						$("#son_list").html(response.data).show();
						$("#shortcut_getmylist").find("li").each(function(){
							var menuId=$(this).attr("id");
							var menu$=$("#son_list").find("ul[id="+menuId+"]");
							if(menu$ && menu$.length>0){
								menu$.addClass("ul_sel").removeAttr("onclick").css("cursor", "auto").find("a.close").show();
							}
						});	
					}
				}
			});
		};
		
		//快捷菜单添加
		var _addShortcut = function(resourceId,isDrag){
			var ul$=$("#son_list").find("ul[id="+resourceId+"]");
			var dispOrder=1;
			var shortcutList$=$("#shortcut_getmylist");
			if(!isDrag){
				var lis = $("#shortcut_getmylist ul li");
				var lastEle$=shortcutList$.find("li:last");
				if(lis.length >=8){
					$.alert("提示","最多允许添加8个图标,请取消已选图标后再添加！");
					return;
				}
				if(lastEle$.length>0){
					dispOrder=lastEle$.attr("disporder")/1+1;
				}else{
					dispOrder=1;
				}
			}else {
				dispOrder=$("#shortcut_getmylist").find("#"+resourceId).index()+1;
			}	
			var url = contextPath+"/menu/setShortcut";
			var param = {
				    "dispOrder":dispOrder,
					"resourceId":resourceId,
					"actionType":"ADD"
			};
			$.callServiceAsJson(url,param, {
				"before":function(){
					$.ecOverlay("添加中...");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done":function(response){
					if(response.code==0){
						if(!isDrag){
							ul$.addClass("ul_sel").removeAttr("onclick").css("cursor", "auto").find("a.close").show();
							var dragAdd$=changeQuickLi(ul$.clone());
							var darg$=shortcutList$.find("ul").append(dragAdd$.html()).find("#"+dragAdd$.attr("id")).attr("disporder",dispOrder);
//			        		addDragEvent(darg$);
//			        		addDropEvent(darg$);
//			        		ul$.draggable("destroy");
						}
					}else if(response.code==-2){
						$.alertM(response.data);
					}					
				},
				fail:function(response){
					$.unecOverlay();
					$.alert("提示","请求可能发生异常，请稍后再试！");
				}
			});
		};
		
		//将待选的菜单ul元素转为已选的快捷菜单li元素
		function changeQuickLi(ulEle$){
			ulEle$.find("a").remove();
			ulEle$.find("div").removeClass("ul_list_img").addClass("quick_top_ul_img");
			ulEle$.find("li").attr("id",ulEle$.attr("id")).attr("onclick","main.home.deleteShortcut("+ulEle$.attr("id")+")");
			return ulEle$;
		}
		
		//快捷菜单删除
		var _deleteShortcut = function(resourceId,isDrag){
			var url = contextPath+"/menu/setShortcut";
			var param = {
					"resourceId":resourceId,
					"actionType":"DEL"
			};
			$.callServiceAsJson(url,param, {
				"before":function(){
					$.ecOverlay("删除中...");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done":function(response){
					if(response.code==0){
						var ulEle$=$("#son_list").find("#"+resourceId);
						if(ulEle$ && ulEle$.length>0){
							ulEle$.removeClass("ul_sel").attr("onclick","main.home.addShortcut("+resourceId+")").css("cursor", "pointer").find("a.close").hide();
						}
						if(!isDrag){
//							addDragEvent(ulEle$,true);
						}
						$("#shortcut_getmylist ul").find("li[id="+resourceId+"]").remove();
					}else if(response.code==-2){
						$.alertM(response.data);
					}	
				},
				fail:function(response){
					$.unecOverlay();
					$.alert("提示","请求可能发生异常，请稍后再试！");
				}
			});
		};
		
		function _gotoPrepare(id){
			$("#mktResTypeCd").val($("#"+id).attr("mktResTypeCd"));
			$("#mktResCd").val($("#"+id).attr("mktResCd"));
			$("#mktResId").val($("#"+id).attr("mktResId"));
			$("#brand").val($("#"+id).attr("brand"));
			$("#phoneType").val($("#"+id).attr("phoneType"));
			$("#phoneColor").val($("#"+id).attr("phoneColor"));
			$("#mktName").val($("#"+id).attr("mktName"));
			$("#mktPrice").val($("#"+id).attr("mktPrice"));
			$("#mktPicA").val($("#"+id).attr("mktPicA"));
			$("#oprepare_form").submit();
		}
		
		function _gotoPrepare2(id){
			$("#prodOfferId").val(id);
			$("#oprepare_form2").submit();
		}
		
		var _refreshValidateCodeImg=function(){
			$("#vali_code_input").val("");
			$('#validatecodeImg').css({"width":"80px","height":"32px"}).attr('src',contextPath+'/validatecode/codeimg.jpg?' + Math.floor(Math.random()*100)).fadeIn();
		};
		
		var _closeVerificationcode = function(){
			var code = $("#vali_code_input").val().toUpperCase();
			$.callServiceAsJson(contextPath+"/main/checkVerificationcode?validatecode="+code, {}, {
				"before" : function(){
					$.ecOverlay("<strong>验证验证码中,请稍等会儿....</strong>");
				},
				"done" : function(response){
					if(response.code!=0){
						$("#vali_code_input").val("");
						$('#validatecodeImg').css({"width":"80px","height":"32px"}).attr('src',contextPath+'/validatecode/codeimg.jpg?' + Math.floor(Math.random()*100)).fadeIn();
						$.alert("失败", "<br>验证码不正确", 'error');
					}else if(response.code==0){
						easyDialog.close();
					}
				},
				"always" : function(){
					$.unecOverlay();
				},
				"fail" : function(response){
					$.alert("提示","请求可能发生异常，请稍候");
				}
			});
		}
		
/**************************	以下为拖拽相关,暂不使用
	
		function sortQuickByUpdate(){
			var shortCutInfo=[];
			$("#shortcut_getmylist").find("ul > li").each(function(i){
				var id=$(this).attr("id");
				if(!!id){
					shortCutInfo.push({"resourceId":$(this).attr("id"),"dispOrder":i+1});
					$(this).attr("disporder",i+1);
				}
			});
			var url = contextPath+"/menu/sortquick";
			$.callServiceAsJson(url,{"shortlist":shortCutInfo}, {
				"before":function(){
					$.ecOverlay("排序中...");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done":function(response){
				}
			});
		}
		
		function sortQuickByInsertUpdate(){
			var shortCutInfo=[];
			$("#shortcut_getmylist").find("ul > li").each(function(i){
				var id=$(this).attr("id");
				if(!!id){
					shortCutInfo.push({"resourceId":$(this).attr("id"),"dispOrder":i+1});
				}
			});
			var url = contextPath+"/menu/sortquick";
			$.callServiceAsJson(url,{"shortlist":shortCutInfo}, {
				"before":function(){
					$.ecOverlay("排序中...");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done":function(response){
				}
			});
		}
		
		function dragSort(){
			$("#shortcut_getmylist").find("li").draggable({
			      helper: "clone",
			      opacity: .75,
			      zIndex:1011,
			      containment:"#ec-dialog-container",
			      refreshPositions: true, // Performance?
			      revert: "invalid",
			      revertDuration: 300,
			      scroll: true,
			      stop:function(event,ui){
			    	  if($(this).data("drop")){
			    		  sortQuickByUpdate();
			    		  $(this).removeData("drop");
			    	  }
			      }
		   });

			$("#shortcut_getmylist").find("li").droppable({
			        drop: function(e, ui) {
			        		if($(ui.draggable).parent("ul").hasClass("quick_top_ul")){
			        			//右拖
			        			if($(ui.draggable).index()<$(this).index()){
			        				$(this).after($(ui.draggable));
			        			}else{
			        				$(ui.draggable).after($(this));
			        			}
			        			$(ui.draggable).data("drop",true); 
				        		addDropEvent($(ui.draggable));
				        	}else {
				        		var dragAdd$=changeQuickLi($(ui.draggable).clone());
				        		$(this).after(dragAdd$.html());
				        		$(ui.draggable).addClass("ul_sel").find("a.close").show();     
				        		var darg$=$(this).parent().find("#"+dragAdd$.attr("id"));
				        		addDragEvent(darg$);
				        		addDropEvent(darg$);
				        		choseson(dragAdd$.attr("id"),true);
				        	}
			        },
			        hoverClass: "accept",
			        over: function(e, ui) {
			        }
			   });
		}
		
		function dragDelete(){
			$("#son_list").parent("div").droppable({
		        drop: function(e, ui) {
		        	var parentUl$=$(ui.draggable).parent("ul");
		        	if(parentUl$ && parentUl$.length>0 && parentUl$.hasClass("quick_top_ul")){
		        		var id=$(ui.draggable).attr("id");
		        		$(ui.draggable).remove();
		        		var ulEle$=$("#son_list").find("#"+id);
		        		ulEle$.attr("onclick","main.home.choseson("+id+")").removeClass("ul_sel").find("a.close").hide();
		        		cancelshortcut(id,true);
		        		addDragEvent(ulEle$,true);
		        	}
		        },
		        hoverClass: "accept",
		        over: function(e, ui) {
		        	
		        }
		   });
		}
		

		function dragAdd(){

			$("#son_list").find("ul").not(".ul_sel").draggable({
			      helper: "clone",
			      opacity: .75,
			      zIndex:1011,
			      containment:"#ec-dialog-container",
			      refreshPositions: true, // Performance?
			      revert: "invalid",
			      revertDuration: 300,
			      scroll: true,
			      stop:function(event,ui){
			    	  if($(this).hasClass("ul_sel")){
			    		  $(this).draggable("destroy");
			    	  }
			      }
		   });
		}
		
		function addDragEvent(ele$,isDestroy){
			if(isDestroy){
				ele$.draggable({
				      helper: "clone",
				      opacity: .75,
				      zIndex:1011,
				      containment:"#ec-dialog-container",
				      refreshPositions: true, // Performance?
				      revert: "invalid",
				      revertDuration: 300,
				      scroll: true,
				      stop:function(event,ui){
				    	  if($(this).hasClass("ul_sel")){
				    		  $(this).draggable("destroy");
				    	  }
				      }
			   });
			}else{
				ele$.draggable({
				      helper: "clone",
				      opacity: .75,
				      zIndex:1011,
				      containment:"#ec-dialog-container",
				      refreshPositions: true, // Performance?
				      revert: "invalid",
				      revertDuration: 300,
				      scroll: true,
				      stop:function(event,ui){
				    	  if($(this).data("drop")){
				    		  sortQuickByUpdate();
				    		  $(this).removeData("drop");
				    	  }
				      }
			   });
			}
		}
		
		function addDropEvent(ele$){
			ele$.droppable({
		        drop: function(e, ui) {
		        	if($(ui.draggable).parent("ul").hasClass("quick_top_ul")){
		        		//右拖
	        			if($(ui.draggable).index()<$(this).index()){
	        				$(this).after($(ui.draggable));
	        			}else{
	        				$(ui.draggable).after($(this));
	        			}
	        			$(ui.draggable).data("drop",true); 
		        	}else {
		        		var dragAdd$=changeQuickLi($(ui.draggable).clone());
		        		$(this).after(dragAdd$.html());
		        		$(ui.draggable).addClass("ul_sel").find("a.close").show();      
		        		var darg$=$(this).parent().find("#"+dragAdd$.attr("id"));
		        		addDragEvent(darg$);
		        		addDropEvent(darg$);
		        	}
		        },
		        hoverClass: "accept",
		        over: function(e, ui) {
		        	
		        }
		   });
		}
		
**************************/
	
	return {
		tabManager				:_tabManager,
		queryNotice				:_queryNotice,
		queryMainShortcut		:_queryMainShortcut,
		getMyList				:_getMyList,
		getLv1					:_getLv1,
		getLv2					:_getLv2,
		getLv3					:_getLv3,
		createDialog			:_createDialog,
		addShortcut				:_addShortcut,
		deleteShortcut			:_deleteShortcut,
		changeParent			:_changeParent,
		gotoPrepare				:_gotoPrepare,
		gotoPrepare2			:_gotoPrepare2,
		hideMainIco				:_hideMainIco,
		refreshValidateCodeImg	:_refreshValidateCodeImg,
		closeVerificationcode	:_closeVerificationcode,
		getSelectedTabItem		:_getSelectedTabItem,
		getSelectedTabName		:_getSelectedTabName,
		addTab					:_addTab,
		backTab					:_backTab,
		loadTab					:_loadTab
	};
	
})();



/**
 * 号码查询
 * 
 * @author lianld
 */
CommonUtils.regNamespace("order", "phoneNumber");
/**
 * 号码查询
 */
var phoneNum_level="";
var selectedObj=null;
var _queryFlag="0";
order.phoneNumber = (function(){
	var _boProdAn = {
			accessNumber : "", //接入号
			org_level:"",//原始的号码等级，为了页面展示增加的字段
			level : "", //等级
			anId : "", //接入号ID
			anTypeCd : "",//号码类型
			areaId:"",
			areaCode:"",
			memberRoleCd:"",
			preStore:"",
			minCharge:""
	};
	var _resetBoProdAn = function(){
		_boProdAn = {
				accessNumber : "", //接入号
				org_level:"",//原始的号码等级，为了页面展示增加的字段
				level : "", //等级
				anId : "", //接入号ID
				anTypeCd : "",//号码类型
				areaId:"",
				areaCode:"",
				memberRoleCd:"",
				preStore: "",
				minCharge:""
		};
	};
	var ispurchased=0;
	var selectedLevel="";
	var idcode=[];
	//请求地址
	var url = contextPath+"/mktRes/phonenumber/list";
	var phoneNumberVal="";
	//按钮查询
	var _btnQueryPhoneNumber=function(param){
		selectedObj=null;//初始化原先选中的号码
		//收集参数
		param = _buildInParam(param);
		param.isReserveFlag=_queryFlag;
		if(_queryFlag=='1'){//预约选号
			param.queryFlag="3";
		}
		$.callServiceAsHtml(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.data.indexOf("showVerificationcode") >=0) {
					$("#vali_code_input").val("");
					$('#validatecodeImg').css({"width":"80px","height":"32px"}).attr('src',contextPath+'/validatecode/codeimg.jpg?' + Math.floor(Math.random()*100)).fadeIn();
					easyDialog.open({
						container : 'Verificationcode_div'
					});
				}
				if(!response||response.code != 0){
					 response.data='查询失败,稍后重试';
				}
				var content$=$("#order_phonenumber .phone_warp");
				content$.html(response.data);
				$("#btnSwitchNbr").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber({});});
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	//提供给LTE项目，新装套餐、主副卡变更等功能中的号码信息查询
	var _queryPhoneNumber=function(param){
		var url = contextPath+"/token/pc/mktRes/phone/numberlist";
		//收集参数
		var params = {
				"areaId":OrderInfo.getAreaId(),
				"phoneNumber":param.phoneNum
			};
		var response = $.callServiceAsJson(url,params);
		if (response&&response.code==0) {
			if(response.data){
//				var result = response.data;
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
		}else {
			$.alert("提示","查询号码信息失败,稍后重试");
		}	
	};
	
	var _btnIBydentityQuery=function(){
		var idcode=$.trim($("#idCode").val());
		if(idcode==''){
			$.alert("提示","请先输入身份证号码!");
			return;
		}
		if(!_idcardCheck(idcode)){
			$.alert("提示","身份证号码输入有误!");
			return;
		}
		var areaId=$("#p_cust_areaId").val();
		var param={"identityId":idcode,"areaId":areaId};
		$.callServiceAsHtmlGet(contextPath+"/mktRes/phonenumber/listByIdentity",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response||response.code != 0){
					 response.data='查询失败,稍后重试';
				}
				var content$=$("#order_phonenumber .phone_warp");
				content$.html(response.data);
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	//选择身份证预占的号码
	var _btnToOffer=function(obj){
		phoneNumberVal = $(obj).attr("numberVal"); 
		var memberRoleCd=CONST.MEMBER_ROLE_CD.MAIN_CARD;
		//选号类型：新装主卡选号、新装副卡选号 Y1、Y2
		var subFlag=$("#subFlag").val();
		if(subFlag=='Y2'){
			memberRoleCd=CONST.MEMBER_ROLE_CD.VICE_CARD;
		}
		//订单序号：O1、O2区分暂存单允许多个订单的情况
		var subnum=$("#subnum").val();
		//入口终端入口，号码入口，订单填写入口:terminal\offer\number
		var subPage=$("#subPage").val();
		//号码的预存话费
		var preStoreFare=phoneNumberVal.split("_")[1];
		//保底消费
		var pnPrice=phoneNumberVal.split("_")[2];
		if(order.service.offerprice!=''){
			var minMonthFare=parseInt(pnPrice);
			//套餐月基本费用
			var packageMonthFare=parseInt(order.service.offerprice);
			if(packageMonthFare<minMonthFare){
				$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");
				return;
			}
		}
		//正在被预占的号码
		var phoneNumber=phoneNumberVal.split("_")[0];
		var anTypeCd=phoneNumberVal.split("_")[3];
		var plevel=selectedLevel;
		if(selectedLevel==""){
			plevel=phoneNumberVal.split("_")[5];
		}
		var orgLevel=phoneNumberVal.split("_")[5];//初始等级
		var phoneNumId=phoneNumberVal.split("_")[6];
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		//var areaCode=$("#p_cust_areaId").attr("areaCode");
		var areaCode=  $(obj).attr("zoneNumber");
		if(areaCode==null || areaCode==""){
			areaCode =OrderInfo.staff.areaCode;
		} 
		if(phoneNumber){
			var oldrelease=false;
			var oldPhoneNumber="";
			var oldAnTypeCd="";
			if(subPage=='terminal'||subPage=='number'){
				oldPhoneNumber=_boProdAn.accessNumber;
				oldAnTypeCd=_boProdAn.anTypeCd;
				/*if(oldPhoneNumber==phoneNumber){
					$.alert("提示","号码已经被预占,请选择其它号码!");
					return;
				}*/
			}else if(subPage=='offer'){
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].prodId==subnum){
						oldPhoneNumber=OrderInfo.boProdAns[i].accessNumber;
						oldAnTypeCd=OrderInfo.boProdAns[i].anTypeCd;
						break;
					}
				}
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].prodId!=subnum){
						if(OrderInfo.boProdAns[i].accessNumber==phoneNumber){
							$.alert("提示","你已经选择了该号码,请选择其它号码!");
							return;
						}
					}
				}
			}
			if(oldPhoneNumber!=""){
				oldrelease=true;
				for(var i=0;i<idcode.length;i++){//身份证预占的号码不需要被释放
					if(idcode[i]==oldPhoneNumber){
						oldrelease=false;
						break;
					}
				}
				if(oldrelease){
					var purchaseUrl=contextPath+"/mktRes/phonenumber/purchase";
					var params={"oldPhoneNumber":oldPhoneNumber,"oldAnTypeCd":oldAnTypeCd};
					$.callServiceAsJson(purchaseUrl, params, {});
				}
			}
			idcode.push(phoneNumber);
			if(subPage=='number'){
				var content$=$("#order_fill_content");
				content$.html('');
				_boProdAn.accessNumber=phoneNumber;
				_boProdAn.anTypeCd=anTypeCd;
				_boProdAn.level=plevel;
				_boProdAn.org_level=orgLevel;
				_boProdAn.anId=phoneNumId;
				_boProdAn.areaId=areaId;
				_boProdAn.areaCode =areaCode;
				_boProdAn.memberRoleCd=memberRoleCd;
				_boProdAn.idFlag=0;
				_boProdAn.preStore=preStoreFare;
				_boProdAn.minCharge=pnPrice;
				order.service.boProdAn = _boProdAn;
				_qryOfferInfoByPhoneNumFee();
			}else if(subPage=='terminal'){
				mktRes.terminal.setNumber(phoneNumber, plevel);
				_boProdAn.accessNumber=phoneNumber;
				_boProdAn.anTypeCd=anTypeCd;
				_boProdAn.level=plevel;
				_boProdAn.org_level=orgLevel;
				_boProdAn.anId=phoneNumId;
				_boProdAn.areaId=areaId;
				_boProdAn.areaCode =areaCode;
				_boProdAn.memberRoleCd=memberRoleCd;
				_boProdAn.idFlag=0;
				_boProdAn.preStore=preStoreFare;
				_boProdAn.minCharge=pnPrice;
				order.service.boProdAn = _boProdAn;
				if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){
					order.phoneNumber.dialogForm.close(order.phoneNumber.dialog);
				}
			}else if(subPage=='offer'){
				_boProdAn.anTypeCd=anTypeCd;
				_boProdAn.anId=phoneNumId;
				_boProdAn.accessNumber=phoneNumber;
//				_boProdAn.level=response.data.phoneLevelId;
				_boProdAn.level=plevel;
				_boProdAn.org_level=orgLevel;
				_boProdAn.areaId=areaId;
				_boProdAn.areaCode =areaCode;
				_boProdAn.preStore=preStoreFare;
				_boProdAn.minCharge=pnPrice;
				$("#nbr_btn_"+subnum).removeClass("selectBoxTwo");
				$("#nbr_btn_"+subnum).addClass("selectBoxTwoOn");
				$("#nbr_btn_"+subnum).html(phoneNumber+"<u></u>");
				$("#choosedNumSpan").val(phoneNumber);
				var isExists=false;
				if(OrderInfo.boProdAns.length>0){
					for(var i=0;i<OrderInfo.boProdAns.length;i++){
						if(OrderInfo.boProdAns[i].prodId==subnum){
							OrderInfo.boProdAns[i].accessNumber=phoneNumber;
							OrderInfo.boProdAns[i].anTypeCd=anTypeCd;
							OrderInfo.boProdAns[i].pnLevelId=plevel;
							OrderInfo.boProdAns[i].anId=phoneNumId;
							OrderInfo.boProdAns[i].areaId=areaId;
							OrderInfo.boProdAns[i].areaCode =areaCode;
							OrderInfo.boProdAns[i].memberRoleCd=memberRoleCd;
							OrderInfo.boProdAns[i].idFlag=0;
							OrderInfo.boProdAns[i].preStore=preStoreFare;
							OrderInfo.boProdAns[i].minCharge=pnPrice;
							isExists=true;
							OrderInfo.setProdAn(OrderInfo.boProdAns[i]);  //保存到产品实例列表里面
							order.dealer.changeAccNbr(subnum,phoneNumber); //选号玩要刷新发展人管理里面的号码
							break;
						}
					}
				}
				if(!isExists){
					var param={
						prodId : subnum, //从填单页面头部div获取
						accessNumber : phoneNumber, //接入号
						anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
						anId : phoneNumId, //接入号ID
						anTypeCd : anTypeCd, //号码类型
						pnLevelId:plevel,
						state : "ADD", //动作	,新装默认ADD	
						areaId:areaId,
						areaCode:areaCode,
						memberRoleCd:memberRoleCd,
						idFlag:0,
						preStore:preStoreFare,
						minCharge:pnPrice
					};
					OrderInfo.boProdAns.push(param);
				}
				if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){
					order.phoneNumber.dialogForm.close(order.phoneNumber.dialog);
				}
				if(subnum=='-1'){
					OrderInfo.boCustInfos.telNumber=phoneNumber;
				}
			}
		} else {
			$.alert("提示","号码格式不正确!");
		}
	};
	
	var _initOffer=function(subnum){
		if(_boProdAn.accessNumber!=''){
			$("#nbr_btn_"+subnum).removeClass("selectBoxTwo");
			$("#nbr_btn_"+subnum).addClass("selectBoxTwoOn");
			$("#nbr_btn_"+subnum).html(_boProdAn.accessNumber+"<u></u>");
			order.dealer.changeAccNbr(subnum,_boProdAn.accessNumber);
			var isExists=false;
			if(OrderInfo.boProdAns.length>0){
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].prodId==subnum){
						OrderInfo.boProdAns[i].accessNumber=_boProdAn.accessNumber;
						OrderInfo.boProdAns[i].anTypeCd=_boProdAn.anTypeCd;
						OrderInfo.boProdAns[i].anId=_boProdAn.anId;
						OrderInfo.boProdAns[i].pnLevelId=_boProdAn.level;
						OrderInfo.boProdAns[i].areaId=_boProdAn.areaId;
						OrderInfo.boProdAns[i].memberRoleCd=_boProdAn.memberRoleCd;
						OrderInfo.boProdAns[i].preStore=_boProdAn.preStore;
						OrderInfo.boProdAns[i].minCharge=_boProdAn.minCharge;
						if(_boProdAn.idFlag){
							OrderInfo.boProdAns[i].idFlag=_boProdAn.idFlag;
						}
						OrderInfo.setProdAn(OrderInfo.boProdAns[i]);  //保存到产品实例列表里面
						order.dealer.changeAccNbr(subnum,phoneNumber); //选号玩要刷新发展人管理里面的号码
						isExists=true;
						break;
					}
				}
			}
			if(!isExists){
				var param={
					prodId : subnum, //从填单页面头部div获取
					accessNumber : _boProdAn.accessNumber, //接入号
					anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
					anId : _boProdAn.anId, //接入号ID
					pnLevelId:_boProdAn.level,
					anTypeCd : _boProdAn.anTypeCd, //号码类型
					state : "ADD", //动作	,新装默认ADD
					areaId:_boProdAn.areaId,
					areaCode:_boProdAn.areaCode,
					memberRoleCd:_boProdAn.memberRoleCd,
					preStore:_boProdAn.preStore,
					minCharge:_boProdAn.minCharge
				};
				if(_boProdAn.idFlag){
					param.idFlag=_boProdAn.idFlag;
				}
				OrderInfo.boProdAns.push(param);
			}
			if(subnum=='-1'){
				OrderInfo.boCustInfos.telNumber=_boProdAn.accessNumber;
			}
		}
	};
	
	var _qryOfferInfoByPhoneNumFee=function(){
		var param={"numsubflag":"number"};
		$.callServiceAsHtmlGet(contextPath+"/order/prodoffer/prepare",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response||response.code != 0){
					 response.data='查询失败,稍后重试';
				}
				var content$=$("#order_tab_panel_content");
				content$.html(response.data);
				order.service.initSpec();
				order.prodOffer.init();
				order.service.searchPack();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	
	//号码预占
	var _btnPurchase=function(obj,needPsw){
		phoneNumberVal = $(obj).attr("numberVal"); 
		var memberRoleCd=CONST.MEMBER_ROLE_CD.MAIN_CARD;
		//选号类型：新装主卡选号、新装副卡选号 Y1、Y2
		var subFlag=$("#subFlag").val();
		if(subFlag=='Y2'){
			memberRoleCd=CONST.MEMBER_ROLE_CD.VICE_CARD;
		}
		//订单序号：O1、O2区分暂存单允许多个订单的情况
		var subnum=$("#subnum").val();
		//入口终端入口，号码入口，订单填写入口:terminal\offer\number
		var subPage=$("#subPage").val();
		//号码的预存话费
		var preStoreFare=phoneNumberVal.split("_")[1];
		//保底消费
		var pnPrice=phoneNumberVal.split("_")[2];
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		var areaCode=  $(obj).attr("zoneNumber");
		//var areaCode=$("#p_cust_areaId").attr("areaCode");
		if(areaCode==null || areaCode==""){
			areaCode =OrderInfo.staff.areaCode;
		} 
		if(order.service.offerprice!=''){
			var minMonthFare=parseInt(pnPrice);
			//套餐月基本费用
			var packageMonthFare=parseInt(order.service.offerprice);
			if(packageMonthFare<minMonthFare){
				$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");
				return;
			}
		}
		//正在被预占的号码
		var phoneNumber=phoneNumberVal.split("_")[0];
		var anTypeCd=phoneNumberVal.split("_")[3];
		var plevel=phoneNumberVal.split("_")[5];
		if(phoneNumber){
			var phoneAreaId = $("#p_cust_areaId").val();
			var params={};
			if(needPsw){
				 params={"phoneNumber":phoneNumber,"actionType":"E","anTypeCd":anTypeCd,"areaId":phoneAreaId,"attrList":[{"attrId":"65010036","attrValue":needPsw}]};
			}else{
				 params={"phoneNumber":phoneNumber,"actionType":"E","anTypeCd":anTypeCd,"areaId":phoneAreaId};
			}
			var oldrelease=false;
			var oldPhoneNumber="";
			var oldAnTypeCd="";
			if(subPage=='terminal'||subPage=='number'){
				oldPhoneNumber=_boProdAn.accessNumber;
				oldAnTypeCd=_boProdAn.anTypeCd;
				if(oldPhoneNumber==phoneNumber){
					$.alert("提示","号码已经被预占,请选择其它号码!");
					return;
				}else{
					_boProdAn={};
				}
			}else if(subPage=='offer'){
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].prodId==subnum){
						oldPhoneNumber=OrderInfo.boProdAns[i].accessNumber;
						oldAnTypeCd=OrderInfo.boProdAns[i].anTypeCd;
						break;
					}
				}
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].accessNumber==phoneNumber){
						$.alert("提示","号码已经被预占,请选择其它号码!");
						return;
					}
				}
			}
			if(oldPhoneNumber&&oldPhoneNumber!=""){
				oldrelease=true;
				for(var i=0;i<idcode.length;i++){//身份证预占的号码不需要被释放
					if(idcode[i]==oldPhoneNumber){
						oldrelease=false;
						break;
					}
				}
				if(oldrelease){
					if(needPsw){
						params={"newPhoneNumber":phoneNumber,"oldPhoneNumber":oldPhoneNumber,"newAnTypeCd":anTypeCd,"oldAnTypeCd":oldAnTypeCd,"areaId":phoneAreaId,"attrList":[{"attrId":"65010036","attrValue":needPsw}]};
					}else{
						params={"newPhoneNumber":phoneNumber,"oldPhoneNumber":oldPhoneNumber,"newAnTypeCd":anTypeCd,"oldAnTypeCd":oldAnTypeCd,"areaId":phoneAreaId};
					}
				}
			}
			
			var purchaseUrl=contextPath+"/mktRes/phonenumber/purchase";
			$.callServiceAsJson(purchaseUrl, params, {
				"before":function(){
					$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>");
				},"always":function(){
					$.unecOverlay();
				},	
				"done" : function(response){
					if (response.code == 0) {
						if(selectedLevel==""){//selectedLevel缓存号码等级信息，以缓存的为准
							selectedLevel=response.data.phoneLevelId;
						}
						if(subPage=='number'){
							var content$=$("#order_fill_content");
							content$.html('');
							_boProdAn.accessNumber=phoneNumber;
							_boProdAn.anTypeCd=anTypeCd;
							_boProdAn.level=selectedLevel;
							_boProdAn.org_level=response.data.phoneLevelId;
							_boProdAn.anId=response.data.phoneNumId;
							_boProdAn.areaId=areaId;
							_boProdAn.areaCode = areaCode;
							_boProdAn.memberRoleCd=memberRoleCd;
							_boProdAn.preStore=preStoreFare;
							_boProdAn.minCharge=pnPrice;
							order.service.boProdAn = _boProdAn;
							_qryOfferInfoByPhoneNumFee();
						}else if(subPage=='terminal'){
							mktRes.terminal.setNumber(phoneNumber, response.data.phoneLevelId);
							_boProdAn.accessNumber=phoneNumber;
							_boProdAn.anTypeCd=anTypeCd;
							_boProdAn.level=selectedLevel;
							_boProdAn.org_level=response.data.phoneLevelId;
							_boProdAn.anId=response.data.phoneNumId;
							_boProdAn.areaId=areaId;
							_boProdAn.areaCode = areaCode;
							_boProdAn.memberRoleCd=memberRoleCd;
							_boProdAn.preStore=preStoreFare;
							_boProdAn.minCharge=pnPrice;
							order.service.boProdAn = _boProdAn;
							if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){
								order.phoneNumber.dialogForm.close(order.phoneNumber.dialog);
							}
						}else if(subPage=='offer'){
							$("#nbr_btn_"+subnum).removeClass("selectBoxTwo");
							$("#nbr_btn_"+subnum).addClass("selectBoxTwoOn");
							$("#nbr_btn_"+subnum).html(phoneNumber+"<u></u>");
							$("#choosedNumSpan").val(phoneNumber);
							_boProdAn.accessNumber=phoneNumber;
							_boProdAn.level=selectedLevel;
							_boProdAn.org_level=response.data.phoneLevelId;
							_boProdAn.areaId=areaId;
							_boProdAn.anTypeCd=anTypeCd;
							_boProdAn.anId=response.data.phoneNumId;
							_boProdAn.preStore=preStoreFare;
							_boProdAn.minCharge=pnPrice;
							var isExists=false;
							if(OrderInfo.boProdAns.length>0){//判断是否选过
								for(var i=0;i<OrderInfo.boProdAns.length;i++){
									if(OrderInfo.boProdAns[i].prodId==subnum){
										OrderInfo.boProdAns[i].accessNumber=phoneNumber;
										OrderInfo.boProdAns[i].anTypeCd=anTypeCd;
										OrderInfo.boProdAns[i].pnLevelId=selectedLevel;
										OrderInfo.boProdAns[i].anId=response.data.phoneNumId;
										OrderInfo.boProdAns[i].areaId=areaId;
										OrderInfo.boProdAns[i].areaCode = areaCode;
										OrderInfo.boProdAns[i].memberRoleCd=memberRoleCd;
										OrderInfo.boProdAns[i].preStore=preStoreFare;
										OrderInfo.boProdAns[i].minCharge=pnPrice;
										isExists=true;
										if(OrderInfo.offerSpec.offerRoles!=undefined){
											OrderInfo.setProdAn(OrderInfo.boProdAns[i]);  //保存到产品实例列表里面
										}
										order.dealer.changeAccNbr(subnum,phoneNumber); //选号玩要刷新发展人管理里面的号码
										break;
									}
								}
							}
							if(!isExists){
								var param={
									prodId : subnum, //从填单页面头部div获取
									accessNumber : phoneNumber, //接入号
									anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
									anId : response.data.phoneNumId, //接入号ID
									pnLevelId:selectedLevel,
									anTypeCd : anTypeCd, //号码类型
									state : "ADD", //动作	,新装默认ADD	
									areaId:areaId,
									areaCode:areaCode,
									memberRoleCd:memberRoleCd,
									preStore:preStoreFare,
									minCharge:pnPrice
								};
								OrderInfo.boProdAns.push(param);
								if(OrderInfo.offerSpec.offerRoles!=undefined){
									OrderInfo.setProdAn(param);//保存到产品实例列表里面
								}
								order.dealer.changeAccNbr(subnum,phoneNumber);//选号玩要刷新发展人管理里面的号码
							}
							if(subnum=='-1'){
								OrderInfo.boCustInfos.telNumber=phoneNumber;
							}
							if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){
								order.phoneNumber.dialogForm.close(order.phoneNumber.dialog);
							}
						}
					}else if (response.code == -2) {
						$.alertM(response.data);
					}else{
						var msg="";
						if(response.data!=undefined&&response.data.msg!=undefined){
							msg=response.data.msg;
						}else{
							msg="号码["+phoneNumber+"]预占失败";
						}
						$.alert("提示","号码预占失败，可能原因:"+msg);
					}
				},
				fail:function(response){
					$.unecOverlay();
					$.alert("提示","请求可能发生异常，请稍后再试！");
				}
			});
		} else {
			$.alert("提示","号码格式不正确!");
		}
	};
	

	
	//链接查询
	var _linkQueryPhoneNumber = function(loc,selected){
		_exchangeSelected(loc,selected);
		_btnQueryPhoneNumber();
	};
	//构造查询条件 
	var _buildInParam = function(param){
		var query_flag_01= $('input:radio[name="query_flag_01"]:checked').val();
		var areaId="";
		if(OrderInfo.cust==undefined || OrderInfo.cust.custId==undefined || OrderInfo.cust.custId==""){
			areaId=$("#p_cust_areaId").val();
		}else{
			areaId=OrderInfo.getAreaId();
		}
		var pnHead = $("#pnHead").find("a.selected").attr("val");
		var pncharacteristic = $("#pncharacteristic").find("a.selected").attr("val");
		var pnEnd =$.trim($("#pnEnd").val());
		if(pncharacteristic!=null && pncharacteristic!=""){
			pnEnd = pncharacteristic;
		}else{
			if(pnEnd=='最后四位'){
				pnEnd='';
			}
		}
		var phoneNum=$.trim($("#phoneNum").val());
		if(phoneNum=="任意四位"){
			phoneNum='';
		}
		var pnCharacterId="";
		var Greater  = "";
		var Less  ="";
		var preStore$=$("#preStore").find("a.selected");
		if(preStore$.length>0){
			Greater= preStore$.attr("Greater");
			Less=preStore$.attr("Less");
		}
		
		var poolId = $("#nbrPool option:selected").val();	
		
		if($("#pnCharacterId_basic").css("display") != "none"){
			pnCharacterId = $("#pnCharacterId_basic a.selected").attr("val");
		}
		if($("#pnCharacterId_all").css("display") != "none"){
			pnCharacterId = $("#pnCharacterId_all a.selected").attr("val");
		}
		pnCharacterId = ec.util.defaultStr(pnCharacterId);
		return {"pnHead":pnHead,"pnEnd":pnEnd,"goodNumFlag":pnCharacterId,"maxPrePrice":Less,
			"minPrePrice":Greater,"pnLevelId":'',"pageSize":"15","phoneNum":phoneNum,"areaId":areaId,"poolId":poolId,
			"queryFlag":query_flag_01
		};
	};
	//点击前定位
	var _exchangeSelected = function(loc,selected){
		$(loc).each(function(){$(this).removeClass("selected");});
		$(selected).addClass("selected");
	};
	//分页查询
	var _getIndexPagePhoneNumber=function(pageIndex){
		var param={pageIndex:pageIndex};
		order.phoneNumber.btnQueryPhoneNumber(param);
	};
	var _idcardCheck=function(num){
		num = num.toUpperCase();
		if(!(/(^\d{15}$)|(^\d{17}([0-9]|X)$)/.test(num)))//是否15位数字或者17位数字加一位数字或字母X
		{
			return false;
		}
		var len, re;
		len = num.length;
		if(len == 15) {
			re = new RegExp(/^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/);
			var arrSplit = num.match(re);
			var dtmBirth = new Date('19' + arrSplit[2] + '/' + arrSplit[3] + '/' + arrSplit[4]);
			var bGoodDay;
			bGoodDay = (dtmBirth.getYear() == Number(arrSplit[2])) && ((dtmBirth.getMonth() + 1) == Number(arrSplit[3])) && (dtmBirth.getDate() == Number(arrSplit[4]));
			if(!bGoodDay) {
				return false;
			} else {
				var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
				var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
				var nTemp = 0, i;
				num = num.substr(0, 6) + '19' + num.substr(6, num.length - 6);
				for( i = 0; i < 17; i++) {
					nTemp += num.substr(i, 1) * arrInt[i];
				}
				num += arrCh[nTemp % 11];
				return num;
			}
		}
		if(len == 18) {
			re = new RegExp(/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/);
			var arrSplit = num.match(re);
			var dtmBirth = new Date(arrSplit[2] + "/" + arrSplit[3] + "/" + arrSplit[4]);
			var bGoodDay;
			bGoodDay = (dtmBirth.getFullYear() == Number(arrSplit[2])) && ((dtmBirth.getMonth() + 1) == Number(arrSplit[3])) && (dtmBirth.getDate() == Number(arrSplit[4]));
			if(!bGoodDay) {
				return false;
			} else {
				var valnum;
				var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
				var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
				var nTemp = 0, i;
				for( i = 0; i < 17; i++) {
					nTemp += num.substr(i, 1) * arrInt[i];
				}
				valnum = arrCh[nTemp % 11];
				if(valnum != num.substr(17, 1)) {
					return false;
				}
				return num;
			}
		}
		return false;
	};

	

	//选择地区
	var _chooseArea = function(){
		order.area.chooseAreaTree("order/prepare","p_phone_areaId_val","p_phone_areaId",3);
	};
	var _initPage=function(){
		
		var url=contextPath+"/mktRes/phonenumber/prepare";
		var param={};
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='选号页面加载异常,稍后重试';
				}
				if(response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				var content$=$("#order_tab_panel_content");
				content$.html(response.data);
				_boProdAn = {accessNumber : "",level : "",anId : "",anTypeCd : ""};
				_initPhonenumber();
			}
		});	
	};
	var _initPhonenumber=function(){
		if(CONST.getAppDesc()==1){
			$("#psw_dt").hide();
			$("#psw_dd").hide();
		}
		selectedObj=null;
		ispurchased=0;
		selectedLevel="";
		order.phoneNumber.queryApConfig();
		queryPhoneNbrPool();
		queryPnLevelProdOffer();
		var param={};
		order.phoneNumber.btnQueryPhoneNumber(param);
		//1、此段代码加上后会导致在选号页面的其他弹出框（如预占密码弹出框）被覆盖，无法显示--jinjian
		//$("#ec-dialog-container-phonenumber").css("z-index","10002");
		$("#btnNumSearch").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber(param);});
		$("#btnNumExistSearch").off("click").on("click",function(event){order.phoneNumber.btnIBydentityQuery(param);event.stopPropagation();});
	};
	//查询平台配置信息
	var _queryApConfig=function(){
		var configParam={"CONFIG_PARAM_TYPE":"TERMINAL_AND_PHONENUMBER"};
		var qryConfigUrl=contextPath+"/order/queryApConf";
		$.callServiceAsJsonGet(qryConfigUrl, configParam,{
			"done" : call_back_success_queryApConfig
		});
	};
	var call_back_success_queryApConfig=function(response){
		var PHONE_NUMBER_PRESTORE;
		var PHONE_NUMBER_SEGMENT;
		var PHONE_NUMBER_FEATURE;
		var phoneNumberPreStoreHtml="<a href=\"javascript:void(0);\" class=\"selected\" Greater=\"\" Less=\"\">不限</a>";
		var phoneNumStartHtml="<a href=\"javascript:void(0);\" class=\"selected\" val=\"\">不限</a>";
		var phoneNumberFeatureLessHtml="<a href=\"javascript:void(0);\" class=\"selected \" val=\"\">不限</a>";
		var phoneNumberFeatureMoreHtml="<a href=\"javascript:void(0);\" class=\"selected \" val=\"\">不限</a>";
		if(response.data){
			var dataLength=response.data.length;
			//号码预存话费
			for (var i=0; i < dataLength; i++) {
				if(response.data[i].PHONE_NUMBER_PRESTORE){
				  	PHONE_NUMBER_PRESTORE=response.data[i].PHONE_NUMBER_PRESTORE;
				  	for(var m=0;m<PHONE_NUMBER_PRESTORE.length;m++){
				  		var  preStore=PHONE_NUMBER_PRESTORE[m].COLUMN_VALUE_NAME.replace(/\"/g, "");
				  		var greater;
				  		var less;
			  			var preStoreArry=preStore.split("-");
			  			if(preStoreArry.length!=1){
			  				greater=preStoreArry[0];
			  				less=preStoreArry[1];
			  			}else{
			  				preStoreArry=preStoreArry.toString();
			  				greater=preStoreArry.substring(0,preStoreArry.length-2);
			  				less="\"\"";
			  			}
			  			preStore=preStore.replace(/\"/g, "");
				  		phoneNumberPreStoreHtml=phoneNumberPreStoreHtml+"<a href=\"javascript:void(0);\" Greater="+greater+" Less="+less+">"+preStore+"</a>";
				  	}
				  	$("#preStore").html(phoneNumberPreStoreHtml);
					continue;
				}
			};
			//号段
			for (var i=0; i < dataLength; i++) {
				if(response.data[i].PHONE_NUMBER_SEGMENT){
				  	PHONE_NUMBER_SEGMENT=response.data[i].PHONE_NUMBER_SEGMENT;
				  	for(var m=0;m<PHONE_NUMBER_SEGMENT.length;m++){
				  		var  numberStart=PHONE_NUMBER_SEGMENT[m].COLUMN_VALUE_NAME;
				  		numberStart=numberStart.replace(/\"/g, "");
				  		phoneNumStartHtml=phoneNumStartHtml+"<a href=\"javascript:void(0);\" val="+numberStart+">"+numberStart+"</a>";
				  	}
				  	$("#pnHead").html(phoneNumStartHtml);
					continue;
				}
			};
			//号码特征
			for (var i=0; i < dataLength; i++) {
				if(response.data[i].PHONE_NUMBER_FEATURE){
				  	PHONE_NUMBER_FEATURE=response.data[i].PHONE_NUMBER_FEATURE;
				  	var featureLength;
				  	if(PHONE_NUMBER_FEATURE.length<=9){
				  		featureLength=PHONE_NUMBER_FEATURE.length;
				  	}else{
				  		featureLength=9;
				  	}
				  	for(var m=0;m<featureLength;m++){
				  		var numberFeature=(PHONE_NUMBER_FEATURE[m].COLUMN_VALUE_NAME).replace(/\"/g, "");
				  		var numberFeatureVal=(PHONE_NUMBER_FEATURE[m].COLUMN_VALUE).replace(/\"/g, "");
				  		phoneNumberFeatureLessHtml=phoneNumberFeatureLessHtml+"<a href=\"javascript:void(0);\" val="+numberFeatureVal+">"+numberFeature+"</a>";
				  	}
				  	if(PHONE_NUMBER_FEATURE.length>9){
				  		for(var n=0;n<PHONE_NUMBER_FEATURE.length;n++){
				  			var numberFeature=(PHONE_NUMBER_FEATURE[n].COLUMN_VALUE_NAME).replace(/\"/g, "");
				  			var numberFeatureVal=(PHONE_NUMBER_FEATURE[n].COLUMN_VALUE).replace(/\"/g, "");
				  			phoneNumberFeatureMoreHtml=phoneNumberFeatureMoreHtml+"<a href=\"javascript:void(0);\" val="+numberFeatureVal+">"+numberFeature+"</a>";
				  		}
				  		$("#pnCharacterId_more").show();
				  		$("#pnCharacterId_more").off("click").on("click",function(event){_view_phonenumber_feature();event.stopPropagation();});
				  	}
				  	$("#pnCharacterId_basic").html(phoneNumberFeatureLessHtml);
				  	$("#pnCharacterId_all").html(phoneNumberFeatureMoreHtml);
					continue;
				}
			};
		}
		$("#pnCharacterId_basic a").each(function(){$(this).off("click").on("click",function(event){order.phoneNumber.linkQueryPhoneNumber("#pnCharacterId_basic a",this);event.stopPropagation();});});
		$("#pnCharacterId_all a").each(function(){$(this).off("click").on("click",function(event){order.phoneNumber.linkQueryPhoneNumber("#pnCharacterId_all a",this);event.stopPropagation();});});
		$("#pnHead a").each(function(){$(this).off("click");$(this).on("click",function(event){order.phoneNumber.linkQueryPhoneNumber("#pnHead a",this);event.stopPropagation();});});
		$("#preStore a").each(function(){$(this).off("click");$(this).on("click",function(event){order.phoneNumber.linkQueryPhoneNumber("#preStore a",this);event.stopPropagation();});});
	};
	//号码类型全部展示与部分展示
	var _view_phonenumber_feature = function(){
		if($('#pnCharacterId_basic').is(':hidden')){
			$("#pnCharacterId_basic").css("display","");
			$("#pnCharacterId_all").css("display","none");
			$("#pnCharacterId_all").parent("dl").css("overflow","inherit");
		}else{
			$("#pnCharacterId_basic").css("display","none");
			$("#pnCharacterId_all").css("display","");
			$("#pnCharacterId_all").parent("dl").css("overflow","hidden");
		}
	};
	//查询号池
	var queryPhoneNbrPool = function(){
		var url=contextPath+"/mktRes/phonenumber/queryPhoneNbrPool";
		var param={};
		var response = $.callServiceAsJson(url,param);
		if (response.code==0) {
			if(response.data){
				var phoneNbrPoolList= response.data.phoneNbrPoolList;
				var $sel = $('<select id="nbrPool" style="width:200px;"></select>');  
				var $defaultopt = $('<option value="" selected="selected">请选择号池</option>');
				$sel.append($defaultopt);
				if(phoneNbrPoolList!=null){
					$.each(phoneNbrPoolList,function(){
						var $option = $('<option value="'+this.poolId+'">'+this.poolName+'</option>');
						$sel.append($option);
					});
				}
				$("#nbrPool").append($sel);
			}
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","号池加载失败，请稍后再试！");
		}
	};
	//靓号预存和保底金额查询
	var queryPnLevelProdOffer = function(str){
		var url=contextPath+"/mktRes/phonenumber/queryPnLevelProdOffer";
		var areaId = "";
//		if(order.ysl!=undefined||str!=undefined){
//			areaId=$("#_session_staff_info").attr("areaid");
//		}else{
//			areaId=$("#p_cust_areaId").val();
//		}
		areaId = OrderInfo.cust.areaId;
		areaId = areaId.substring(0,3)+"0000";
		var param={"areaId":areaId};
		var response = $.callServiceAsJson(url,param);
	};
	
	//设置号码等级
	var _qryPhoneNbrLevelInfoList=function(){
		if(selectedObj==undefined||selectedObj==null){
			$.alert("提示","请先选择号码！");
			return;
		}
		var phoneNumberVal = $(selectedObj).attr("numberVal"); 
		var plevel=phoneNumberVal.split("_")[5];
		var phoneNumber=phoneNumberVal.split("_")[0];
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		var qryUrl=contextPath+"/mktRes/qryPhoneNbrLevelInfoList";
		$.ligerDialog.open({
			width:560,
			height:350,
			allowClose:false,
			title:'设置号码等级（'+phoneNumber+"）",
			url:qryUrl+"?pnLevelId="+selectedLevel+"&areaId="+areaId+"&org_level="+plevel,
			buttons: [ { text: '确定', onclick:function (item, dialog) {
				var strs=phoneNum_level.split("_");////全局变量，保存“号码等级_预存金额_保底金额”，由弹出框的iframe，赋值
				dialog.close(); 
				//设置选择的样式
				$(".select_nbr_li").each(function(){
					if($(this).hasClass("select")){
						var numberval=$(this).attr("numberval").split("_");
						var tx;
						if(phoneNum_level!=undefined&&phoneNum_level!=""&&numberval[5]!=strs[0]){
							tx="<span style='float:left;margin-left:10px;'>预存<span class='orange'>"+numberval[1]+"</span>元<br/>保底<span class='orange'>"+numberval[2]+"</span>元</span><span style='float:right;margin-right:10px;'>预存<span class='orange'>"+strs[1]+"</span>元<br/>保底<span class='orange'>"+strs[2]+"</span>元</span><span style='width: 15px; display: table; height: 30px; padding-top: 10px;'><img  src='"+contextPath+"/image/common/levelArrow.png'></span>";
						}else{
							tx="<span style='padding-left:10px;'>预存<span class='orange'>"+numberval[1]+"</span>元</span> <span style='padding-left:10px;'> 保底<span class='orange'>"+numberval[2]+"</span>元</span>";
						}
						$(this).find("div").html(tx);
					}
				});
				//保存刚修改的值
				selectedLevel=strs[0];
			} }, { text: '关闭', onclick: function (item, dialog) { dialog.close(); } }] 	
		});
	};
	//结束选号，不通的模块要做的动作不相同
	var _endSelectNum=function(){
		if(selectedObj==undefined||selectedObj==null){
			$.alert("提示","请先选择号码！");
			return;
		}
		if(ispurchased==1){
			_btnToOffer(selectedObj);
		}else{
			var phoneNumberVal_06 = $(selectedObj).attr("numberVal").split("_")[7]; 
			if(phoneNumberVal_06=="1"){
				easyDialog.open({
					container : 'password_dialog'
				});
			}else{
				_btnPurchase(selectedObj);
			}
		}
		$("#uim_check_btn_"+prodId).attr("disabled",false);
		$("#uim_check_btn_"+prodId).removeClass("disablepurchase").addClass("purchase");
		$("#uim_release_btn_"+prodId).attr("disabled",true);
		$("#uim_release_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
		$("#uim_txt_"+prodId).attr("disabled",false);
		$("#uim_txt_"+prodId).val("");
	};
	/**
	 * obj被选中的号码对象
	 * ispurchased是否身份预占号码。1：是,0否。不是身份预占的号码需要调用预占方法。
	 */
	var _selectNum=function(obj,purchas){
		if(selectedObj==obj){//老点同一个号？
			return;
		}
		ispurchased=purchas;
		selectedObj=obj;
		var phoneNumberVal = $(selectedObj).attr("numberVal"); 
		selectedLevel=phoneNumberVal.split("_")[5];
		//去掉其他号码选中效果
		$(obj).siblings().each(function(){
			$(this).removeClass("select");
			var numberval=$(this).attr("numberval").split("_");
			var tx="<span style='padding-left:10px;'>预存<span class='orange'>"+numberval[1]+"</span>元</span> <span style='padding-left:10px;'> 月保底<span class='orange'>"+numberval[2]+"</span>元</span>";
			$(this).find("div").html(tx);
		});
		//添加号码选中样式
		$(obj).addClass("select");
	};
	
	/**
	 * 靓号预占 密码校验
	 */
	var _preePassword=function(){
		var pree_password_text=$("#pree_password_text").val();
		if($.trim(pree_password_text)==""){
			$.alert("提示","预占密码不能为空！");
		}else{
			easyDialog.close();
			$("#pree_password_text").val("");//初始化
			_btnPurchase(selectedObj,pree_password_text);
		}
	};
	
	return {
		qryPhoneNbrLevelInfoList:_qryPhoneNbrLevelInfoList,
		selectNum:_selectNum,
		endSelectNum:_endSelectNum,
		//btnPurchase : _btnPurchase,
		btnQueryPhoneNumber : _btnQueryPhoneNumber,
		linkQueryPhoneNumber : _linkQueryPhoneNumber,
		getIndexPagePhoneNumber :_getIndexPagePhoneNumber,
		queryApConfig:_queryApConfig,
		initPhonenumber:_initPhonenumber,
		boProdAn:_boProdAn,
		resetBoProdAn:_resetBoProdAn,
		btnIBydentityQuery:_btnIBydentityQuery,
		//btnToOffer:_btnToOffer,
		initOffer:_initOffer,
		initPage:_initPage,
		chooseArea : _chooseArea,
		preePassword:_preePassword,
		queryPhoneNbrPool:queryPhoneNbrPool,
		queryFlag:_queryFlag,
		queryPnLevelProdOffer:queryPnLevelProdOffer,
		queryPhoneNumber    :_queryPhoneNumber
	};
})();
/**
 * 终端入口
 * 
 * @author dujb3
 */
CommonUtils.regNamespace("mktRes", "terminal");
/**
 * 终端入口
 */
mktRes.terminal = (function($){
	var _offerSpecId = ""; //保存合约附属ID，合约套餐使用
	var pageSize = 12;
	var termInfo = {};
	/**
	 * 校验是否可以进入下一步
	 */
	var buyChk = {
			buyType : "lj",
			numFlag : false,
			numLevel : "0",
			hyFlag : false,
			hyType: "cfsj",
			hyOfferSpecId: 0,
			hyOfferSpecName: "",
			hyOfferSpecQty: 0,
			hyOfferSpecFt: 0,
			hyOfferRoles:null,
			tsnFlag : false
	};
	_initBuyChk = function() {
		buyChk = {
				buyType : "lj",
				numFlag : false,
				numLevel : "0",
				hyFlag : false,
				hyType: "cfsj",
				hyOfferSpecId: 0,
				hyOfferSpecName: "",
				hyOfferSpecQty: 0,
				hyOfferSpecFt: 0,
				hyOfferRoles:null,
				tsnFlag : false
		};
	};
	/**
	 * 检验buyChk的状态，从而改变订购按钮的样式
	 */
	var _chkState=function(){
		if ("lj"==buyChk.buyType) {
			OrderInfo.actionFlag = 13;
			$("#treaty").hide();
			$("#sel_number").hide();
			$("#lj").addClass("selectBoxTwoOn").removeClass("selectBoxTwo");
			$("#hy").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");
			
			if(buyChk.tsnFlag) {
				$("#purchaseTermA").removeClass("btna_g").addClass("btna_o");
			}
			$("#dealerMktDiv").show();
		} else if ("hy"==buyChk.buyType){
			OrderInfo.actionFlag = 14;
			$("#treaty").show();
			$("#sel_number").show();
			$("#lj").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");
			$("#hy").addClass("selectBoxTwoOn").removeClass("selectBoxTwo");
			
			if(buyChk.numFlag && buyChk.hyFlag && buyChk.tsnFlag) {
				$("#purchaseTermA").removeClass("btna_g").addClass("btna_o");
			} else {
				$("#purchaseTermA").removeClass("btna_o").addClass("btna_g");
			}
			if (buyChk.hyFlag) {
				if (buyChk.hyType == 'cfsj') {
					$("#cfsjA").addClass("selectBoxTwoOn").removeClass("selectBoxTwo");			
				} else {
					$("#gjsfA").addClass("selectBoxTwoOn").removeClass("selectBoxTwo");
				}
			} else {
				$("#cfsjA,#gjsfA").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");
				$("#choosedOfferPlan").html("");
			}
			if (buyChk.numFlag) {
				$("#cNumA").addClass("selectBoxTwoOn").removeClass("selectBoxTwo");
			} else {
				$("#cNumA").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");
				$("#choosedNumSpan").html("");
			}
			$("#dealerMktDiv").hide();
		}
	};
	var _setNumber=function(num, numLevel){
		$("#choosedNumSpan").html(num);
		buyChk.numFlag = true;
		buyChk.numLevel = numLevel;
		_chkState();
	};
	var _init =function(){
		
	};
	
	/**
	 * 按钮查询
	 */
	var _btnQueryTerminal=function(curPage){
		//请求地址
		var url = contextPath+"/mktRes/terminal/list";
		//收集参数
		var param = _buildInParam(curPage);
		$.callServiceAsHtml(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","<br/>查询失败,稍后重试");
					return;
				}
				var termList$=$("#order_term_list");
				termList$.show();
				termList$.html(response.data).fadeIn();
			}
		});	
	};
	/**
	 * 链接查询
	 */
	var _linkQueryTerminal = function(loc,selected){
		_exchangeSelected(loc,selected);
		_btnQueryTerminal(1);
	};
	/**
	 * 构造查询条件
	 */
	var _buildInParam = function(curPage){
		var brand = "";
		var phoneType = "";
		var $priceArea = $("#priceArea a[class='selected']");
		var minPrice = $priceArea.attr("minPrice");
		var maxPrice = $priceArea.attr("maxPrice");
		var commCond = $("#commCond").val();
		//处理品牌选择项
		if($("#termManf_small").css("display") != "none"){
			brand = $("#termManf_small a[class='selected']").attr("val");
		}
		var contractFlag = "";
		if($("#contractFlag_small").css("display") != "none"){
			contractFlag = $("#contractFlag_small a[class='selected']").attr("val");
		}
		if($("#termManf_all").css("display") != "none"){
			brand = $("#termManf_all a[class='selected']").attr("val");
		}
		brand = ec.util.defaultStr(brand);
		if($("#phoneType_small").css("display") != "none"){
			phoneType = $("#phoneType_small a[class='selected']").attr("val");
		}
		if($("#phoneType_all").css("display") != "none"){
			phoneType = $("#phoneType_all a[class='selected']").attr("val");
		}
		phoneType = ec.util.defaultStr(phoneType);
		minPrice = ec.util.defaultStr(minPrice);
		maxPrice = ec.util.defaultStr(maxPrice);
		commCond = ec.util.defaultStr(commCond);
		if(minPrice!=""){
			minPrice=parseInt(minPrice) * 100;
		}
		if(maxPrice!=""){
			maxPrice=parseInt(maxPrice) * 100;
		}
		var attrList = [];
		if(brand != "" && brand != "无限") {
			var attr = {
				"attrId":CONST.TERMINAL_SPEC_ATTR_ID.BRAND,
				"attrValue":brand
			};
			attrList.push(attr);
		}
		if(phoneType != "" && phoneType != "无限") {
			var attr = {
					"attrId":CONST.TERMINAL_SPEC_ATTR_ID.PHONE_TYPE,
					"attrValue":phoneType
			};
			attrList.push(attr);
		}
		return {
			"mktResCd":"",
			"mktResName":commCond,
			"mktResType":"",
			"minPrice":minPrice,
			"maxPrice":maxPrice,
			"contractFlag":contractFlag,
			"pageInfo":{
				"pageIndex":curPage,
				"pageSize":pageSize
			},
			"attrList":attrList
		};
	};
	/**
	 * 点击前定位
	 */
	var _exchangeSelected = function(loc,selected){
		$(loc).removeClass("selected");
		$(selected).addClass("selected");
	};
	/**
	 * 初始化查询条件
	 */
	var _initInParam = function(brand,minPrice,maxPrice,commCond){
		$("#commCond").val(commCond);
		//给搜索输入框绑定回车事件
		$("#commCond").off("keydown").on("keydown", function(e){
			var ev = document.all ? window.event : e; 
			if(ev.keyCode==13) {
				$("#btn_term_search").click();
			}
		});
		var not_exist_ = false;
		$("#termManf_small a").each(function(){
			if($(this).attr("val")==brand){
				$(this).addClass("selected");
				not_exist_ = true;
			}else{
				$(this).removeClass("selected");
			}
		});
		if(!not_exist_){
			$("#termManf_all a").each(function(){
				if($(this).attr("val")==brand){
					$(this).addClass("selected");
				}else{
					$(this).removeClass("selected");
				}
			});
			//_view_termManf("termManf_all");
		}
		$("#priceArea a").removeClass("selected");
		$("#priceArea a[minPrice='"+minPrice+"'][maxPrice='"+maxPrice+"']").addClass("selected");
	};
	/**
	 * 成功获取搜索条件后展示
	 */
	var call_back_success_queryApConfig=function(response){
		var dataLength=response.data.length;
		var PHONE_BRAND;
		var PHONE_PRICE_AREA;
		var PHONE_TYPE;
		var terminalBrandLessHtml="<a href=\"javascript:void(0);\" class=\"selected \" val=\"\">不限</a>";
		var terminalBrandMoreHtml="<a href=\"javascript:void(0);\" class=\"selected \" val=\"\">不限</a>";
		var phonePriceAreaHtml="<a href=\"javascript:void(0);\" class=\"selected\" minPrice=\"\" maxPrice=\"\">不限</a>";
		var phoneTypeLessHtml="<a href=\"javascript:void(0);\" class=\"selected \" val=\"\">不限</a>";
		var phoneTypeMoreHtml="<a href=\"javascript:void(0);\" class=\"selected \" val=\"\">不限</a>";
		//终端品牌
		for (var i=0; i < dataLength; i++) {
			if(response.data[i].PHONE_BRAND){
			  	PHONE_BRAND=response.data[i].PHONE_BRAND;
			  	var brandLength;
			  	if(PHONE_BRAND.length<=6){
			  		brandLength=PHONE_BRAND.length;
			  	}else{
			  		brandLength=6;
			  	}
			  	for(var m=0;m<brandLength;m++){
			  		var phoneBrand=(PHONE_BRAND[m].COLUMN_VALUE_NAME).replace(/\"/g, "");
			  		terminalBrandLessHtml=terminalBrandLessHtml+"<a href=\"javascript:void(0);\" val="+phoneBrand+">"+phoneBrand+"</a>";
			  	}
			  	if(PHONE_BRAND.length>6){
			  		for(var n=0;n<PHONE_BRAND.length;n++){
			  			var phoneBrand=(PHONE_BRAND[n].COLUMN_VALUE_NAME).replace(/\"/g, "");
			  			terminalBrandMoreHtml=terminalBrandMoreHtml+"<a href=\"javascript:void(0);\" val="+phoneBrand+">"+phoneBrand+"</a>";
			  		}
			  		$("#termManfId_more").show();
			  		$("#termManfId_more").off("click").on("click",function(event){
			  			_viewSmallOrAll("#termManf_all", "#termManf_small");
			  			event.stopPropagation();
			  		});
			  		$("#termManfId_more").toggle(
			  			function(){
			  				$("#termManfId_more a").addClass("btn_less");
			  				$("#termManfId_more a").text("收起");
			  			},
			  			function(){
			  				$("#termManfId_more a").removeClass("btn_less");
			  				$("#termManfId_more a").text("展开");
			  			});
			  		
			  	}
			  	$("#termManf_small").html(terminalBrandLessHtml);
			  	$("#termManf_all").html(terminalBrandMoreHtml);
				continue;
			}
		};
		//终端价格
		for (var i=0; i < dataLength; i++) {
			if(response.data[i].PHONE_PRICE_AREA){
			  	PHONE_PRICE_AREA=response.data[i].PHONE_PRICE_AREA;
			  	for(var m=0;m<PHONE_PRICE_AREA.length;m++){
			  		var  phonePriceArea=(PHONE_PRICE_AREA[m].COLUMN_VALUE_NAME).replace(/\"/g, "");
			  			var phonePriceAreaArry=phonePriceArea.split("-");
			  			if(phonePriceAreaArry.length!=1){
			  				minPrice=phonePriceAreaArry[0];
			  				maxPrice=phonePriceAreaArry[1];
			  			}else{
			  				phonePriceAreaArry=phonePriceAreaArry.toString();
			  				minPrice=phonePriceAreaArry.substring(0,phonePriceAreaArry.length-2);
			  				maxPrice="\"\"";
			  			}
			  			
			  			phonePriceAreaHtml=phonePriceAreaHtml+"<a href=\"javascript:void(0);\" minPrice="+minPrice+" maxPrice="+maxPrice+">"+phonePriceArea+"</a>";
			  	}
			  	$("#priceArea").html(phonePriceAreaHtml);
				continue;
			}
		};
		//终端类型
		for (var i=0; i < dataLength; i++) {
			if(response.data[i].PHONE_TYPE){
				PHONE_TYPE=response.data[i].PHONE_TYPE;
			  	var typeLength;
			  	if(PHONE_TYPE.length<=6){
			  		typeLength=PHONE_TYPE.length;
			  	}else{
			  		typeLength=6;
			  	}
			  	for(var m=0;m<typeLength;m++){
			  		var phoneType=(PHONE_TYPE[m].COLUMN_VALUE_NAME).replace(/\"/g, "");
			  		phoneTypeLessHtml=phoneTypeLessHtml+"<a href=\"javascript:void(0);\" val="+phoneType+">"+phoneType+"</a>";
			  	}
			  	if(PHONE_TYPE.length>6){
			  		for(var n=0;n<PHONE_TYPE.length;n++){
			  			var phoneType=(PHONE_TYPE[n].COLUMN_VALUE_NAME).replace(/\"/g, "");
			  			phoneTypeMoreHtml=phoneTypeMoreHtml+"<a href=\"javascript:void(0);\" val="+phoneType+">"+phoneType+"</a>";
			  		}
			  		$("#phoneTypeId_more").show();
			  		$("#phoneTypeId_more").off("click").on("click",function(event){_viewSmallOrAll("#phoneType_all", "#phoneType_small");event.stopPropagation();});
			  	}
			  	$("#phoneType_small").html(phoneTypeLessHtml);
			  	$("#phoneType_all").html(phoneTypeMoreHtml);
				continue;
			}
		};
		//手机终端
		$("#btn_term_search").off("click").on("click",function(event){_btnQueryTerminal(1);event.stopPropagation();});
		$("#termManf_small a[val!='更多']").off("click").on("click",function(event){_linkQueryTerminal("#termManf_small a[val!='更多']",this);});
		$("#termManf_all a[val!='更多']").off("click").on("click",function(event){_linkQueryTerminal("#termManf_all a[val!='更多']",this);});
		$("#priceArea a").off("click").on("click",function(event){_linkQueryTerminal("#priceArea a",this);});
		$("#contractFlag_small a").off("click").on("click",function(event){_linkQueryTerminal("#contractFlag_small a",this);});
		$("#phoneType_small a[val!='更多']").off("click").on("click",function(event){_linkQueryTerminal("#phoneType_small a[val!='更多']",this);});
		$("#phoneType_all a[val!='更多']").off("click").on("click",function(event){_linkQueryTerminal("#phoneType_all a[val!='更多']",this);});
	};
	/**
	 * 获取搜索条件
	 */
	var _queryApConfig=function(){
		var configParam={"CONFIG_PARAM_TYPE":"TERMINAL_AND_PHONENUMBER"};
		var qryConfigUrl=contextPath+"/order/queryApConf";
		$.callServiceAsJsonGet(qryConfigUrl, configParam,{
			"done" : call_back_success_queryApConfig
		});
	};
	/**
	 * 全部展示与部分展示
	 */
	var _viewSmallOrAll = function(small, all){
		if($(small).is(':hidden')){
			$(small).css("display","");
			$(all).css("display","none");
			$(all).parent("dl").css("overflow","auto");
		}else{
			$(small).css("display","none");
			$(all).css("display","");
			$(all).parent("dl").css("overflow","hidden");
		}
	};
	/**
	 * 选择立即订购终端
	 */
	var _selectTerminal=function(obj){
		//mktResTypeCd="${mkt.mktResTypeCd}" mktResCd="${mkt.mktResCd}" brand="${brand}" phoneType="${phoneType}" 
		//phoneColor="${phoneColor}" mktName="${mkt.mktResName}" mktPrice="${(mkt.salePrice)}" mktPicA="${p_pic}" 
		var param = {
				mktResTypeCd :$(obj).attr("mktResTypeCd"),
				mktResCd :$(obj).attr("mktResCd"),
				mktResId :$(obj).attr("mktResId"),
				brand :$(obj).attr("brand"),
				phoneType :$(obj).attr("phoneType"),
				phoneColor :$(obj).attr("phoneColor"),
				mktName : $(obj).attr("mktName"),
				mktPrice : $(obj).attr("mktPrice"),
				mktLjPrice:$(obj).attr("mktLjPrice"),
				mktPicA : $(obj).attr("mktPicA")
		};
		if(CONST.getAppDesc()==0){
			param.mktSpecCode=$(obj).attr("mktSpecCode");
			param.pageInfo={pageIndex:1,pageSize:20};
			param.attrList=[];
			param.is4G="yes";
		}
		var termDetailUrl = contextPath+"/mktRes/terminal/detail";
		$.callServiceAsHtml(termDetailUrl, param, {
			"before":function(){
				$.ecOverlay("<strong>在处理中,请稍等会儿....</strong>");
			},"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					$.alert("提示","<br/>处理失败，请稍后重试！");
					return;
				}
				if(response.code != 0) {
					$.alert("提示","<br/>处理失败，请稍后重试！");
					return;
				}
				var termDetail$=$("#order_term_detail");
				$("#order_tab_panel_terminal .order_tab_header").hide();
				$("#order_term_list").hide();
				termDetail$.show();
				termDetail$.html(response.data).fadeIn();
				_initBuyChk();
				$("#hy").click(function(){
					_initBuyChk();
					buyChk.buyType = 'hy';
					_setPrice();
					_chkState();
				});
				$("#lj").click(function(){
					_initBuyChk();
					buyChk.buyType = 'lj';
					_setPrice();
					_chkState();
					//需要重新校验串码
					$("#tsn_hid").val("");
					$("#tsn").val("");
					termInfo = {};
				});
				$("#cNumA").click(function(){
					var custId = OrderInfo.cust.custId;
					if(OrderInfo.cust==undefined || custId==undefined || custId==""){
						$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");
						return;
					}
					_chkState();
					order.prepare.phoneNumDialog('terminal','Y1','01');
				});
				$("#cfsjA").click(function(){
					_selectHy(1);
				});
				$("#gjsfA").click(function(){
					_selectHy(2);
				});
				$("#chkTsnA").click(function(){
					_checkTerminalCode('tsn');
				});
				$("#purchaseTermA").click(function(){
					_purchase();
				});
				//初始化裸机发展人信息
				$("#lj").click();
				OrderInfo.actionFlag=13;
				order.dealer.initDealer();//初始化发展人
			}
		});	
	};
	
	
	/**
	 * 选择颜色
	 */
	var _selectColor=function(obj){
		$("a[name^='selectBox']").each(function(i){
			$(this).addClass("selectBoxTwo").removeClass("selectBoxTwoOn");
		});
		$(obj).addClass("selectBoxTwoOn").removeClass("selectBoxTwo");
		var p_pic=$(obj).attr("p_pic");
		var mktResName=$(obj).attr("mktResName");
		var mktSalePrice=$(obj).attr("mktSalePrice");
		var mktNormalSalePrice=$(obj).attr("mktNormalSalePrice");
		var mktResId=$(obj).attr("mktResId");
		var mktResTypeCd=$(obj).attr("mktResTypeCd");
		var mktSpecCode=$(obj).attr("mktSpecCode");
		if(buyChk.buyType == 'hy'){
			$("#mkt_saleprice_id").html(mktNormalSalePrice / 100+" 元");
		}else if(buyChk.buyType == 'lj'){
			$("#mkt_saleprice_id").html(mktSalePrice / 100+" 元");
		}
		$("#term_pic_id").attr("src",p_pic);
		$("#mkt_resname_id").html(mktResName);
		$("#mktResId").val(mktResId);
		$("#mktResName").val(mktResName);
		$("#mktLjPrice").val(mktSalePrice);
		$("#price").val(mktNormalSalePrice);
		$("#mktResType").val(mktResTypeCd);
		$("#mktSpecCode").val(mktSpecCode);
		
		var buyTypeTmp=buyChk.buyType;
		_initBuyChk();
		buyChk.buyType=buyTypeTmp;
		_chkState();
		$("#tsn_hid").val("");
		$("#tsn").val("");
		termInfo = {};
	};
	
	var _setPrice = function(){
		selectColor$ = $("a[name='selectBox'][class='selectNumbel selectBoxTwoOn']");
		if(buyChk.buyType == 'hy'){
			var mktNormalSalePrice=selectColor$.attr("mktNormalSalePrice");
			$("#mkt_saleprice_id").html(mktNormalSalePrice / 100+" 元");
			$("#mktLjPrice").val(mktNormalSalePrice);
		}else if(buyChk.buyType == 'lj'){
			var mktSalePrice=selectColor$.attr("mktSalePrice");
			$("#mkt_saleprice_id").html(mktSalePrice / 100+" 元");
			$("#mktLjPrice").val(mktSalePrice);
		}
	};
	
	/**
	 * 选择合约
	 */
	var _selectHy=function(agreementType){
		$("#choosedOfferPlan").html("");
		buyChk.hyFlag = false;
		if (agreementType == 1) {
			buyChk.hyType = 'cfsj';
			$("#tsn_hid").val("");
			$("#tsn").val("");
			termInfo = {};
		} else {
			buyChk.hyType = 'gjsf';
		}
		_chkState();
		
		if (!buyChk.numFlag){
			$.alert("提示","请先选号！");
			return;
		}
		
		ec.form.dialog.createDialog({
			"id":"-gjhy",
			"width":980,
			"height":550,
			"initCallBack":function(dialogForm,dialog){
				var param={
						"mktResCd":$("#mktResId").val(),
						"agreementType":agreementType
				};
				var url=contextPath+"/mktRes/terminal/mktplan";
				$.callServiceAsHtmlGet(url,param,{
					"before":function(){
//						$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
					},
					"always":function(){
//						$.unecOverlay();
					},
					"done" : function(response){
						mktRes.terminal.dialogForm=dialogForm;
						mktRes.terminal.dialog=dialog;
						if(!response){
							$.alert("提示","<br/>处理失败，请稍后重试！");
							return;
						}
						if(response.code != 0) {
							if (response.code == 1006){
								$.alert("提示","<br/>查询不到，请稍后重试");
							} else {								
								$.alert("提示","<br/>查询失败，请稍后重试");
							}
							if(mktRes.terminal.dialogForm!=undefined&&mktRes.terminal.dialog!=undefined){
								mktRes.terminal.dialogForm.close(mktRes.terminal.dialog);
							}
							return;
						}
						$("#gjhyContent").html(response.data);
						//显示第一个tab的div
						$("#tab_content_0").show();
						//绑定切换合约页click事件
						$("#contract_nav_agreement li").off("click").on("click",function(event){
							_setPlanOfferTab(this, $(this).attr("itemIndex"));
						});
						//绑定每行合约click事件
						$("#phone_warp_id .contract_tab_content tr:gt(0)").off("click").on("click",function(event){
							_linkQueryOffer(this);
						});
						//绑定确定按钮click事件
						$("#hy_nav_confirm_a").off("click").on("click",function(event){
							_selectPlan();
						});
					}
				});	
			 },
			"submitCallBack":function(dialogForm,dialog){
				buyChk.hyFlag = true;
			},
			"closeCallBack":function(dialogForm,dialog){
//				buyChk.hyFlag = false;
				_chkState();
				var content$=$("#gjhyContent");
				content$.html('');
			}
		});
	};
	/**
	 * 切换合约计划标签页
	 */
	var _setPlanOfferTab=function(selected, id){
		if ($(selected).hasClass("current")) {
			return;
		}
		$("#contract_nav_agreement li").removeClass("current");
		$("#tab_"+id).addClass("current");
		$(".contract_tab_content").hide();
		$("#tab_content_"+id).show();
	};
	/**
	 * 根据合约查询套餐
	 */
	var _linkQueryOffer=function(selected){
		if ($(selected).hasClass("plan_select")) {
			$(selected).removeClass("bg plan_select").next("#plan2ndTr").hide();
			return false;
		}
		$("#phone_warp_id .contract_tab_content tr").filter(".plan_select")
			.removeClass("bg plan_select").next("#plan2ndTr").hide();
		$(selected).addClass("bg").addClass("plan_select");
		var offerSpecId=$(selected).attr("offerSpecId");
		var agreementType = $(selected).attr("agreementType");
		_queryOffer(selected, offerSpecId, agreementType);
	};
	/**
	 * 查询套餐后生成展示内容
	 */
	var _queryOffer=function(selected, offerSpecId, agreementType){
		
		var obj$ = $(selected).next("#plan2ndTr");
		if (obj$.length > 0) {
			obj$.show();
			return;
		}
		
		//调用order.js中的方法获得主销售品规格
		var response = order.service.queryPackForTerm(offerSpecId, agreementType, '');
		if (typeof(response) == "undefined" || response==null){
			$.alert("提示","<br/>未查到套餐，请稍后再试！");
			return;
		}
		if (response.code == -2){
			$.alertM(response.data);
			$.unecOverlay();
			return;
		}
		if(response.code != 0 || response.data.code != "POR-0000"){
			$.alert("提示","<br/>未查到合适套餐，请稍后再试！");
			return;
		}
		var offerHtml="";
		offerHtml+="<tr id='plan2ndTr' class='nocolor'>";
		offerHtml+="<td class='nopadding' colspan='7'>";
		offerHtml+="<div id='plan2ndDiv' class='plan_second_list cashier_tr'>";
		offerHtml+="  <table class='contract_list'>";
		offerHtml+="  <thead>";
		offerHtml+="    <tr>";
		offerHtml+="      <td class='borderLTB'>&nbsp;</td><td>套餐名称</td><td>价格</td>";
		offerHtml+="      <td>流量</td><td>语音分钟数</td><td>WIFI时长</td><td>点对点短信</td>";
		offerHtml+="      <td>点对点彩信</td><td>套餐外流量</td><td>套餐外通话分钟数</td>";
		offerHtml+="    </tr>";
		offerHtml+="  </thead>";
		offerHtml+="  <tbody>";
		var offerInfos = response.data.prodOfferInfos;
		if (offerInfos.length == 0) {
			$.alert("提示","<br/>未查到套餐，请稍后再试！");
		}
		for(var i=0;i<offerInfos.length;i++){
			var offer = offerInfos[i];
			offerHtml+="    <tr offerSpecId='"+offer.offerSpecId+"' ";
			offerHtml+=		"   offerSpecName='"+offer.offerSpecName+"' ";
			offerHtml+=		"   price='"+offer.price+"' >";
			offerHtml+="      <td></td>";
			offerHtml+="      <td style='width:240px;'>"+ec.util.defaultStr(offer.offerSpecName)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.price)+"</td>";
			var inFlux = '';
			if (offer.inFlux >= 1024) {
				inFlux = offer.inFlux / 1024 + 'G';
			} else {
				inFlux = offer.inFlux + 'M';
			}
			offerHtml+="      <td>"+ec.util.defaultStr(inFlux)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.inVoice)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.inWIFI)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.inSMS)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.inMMS)+"</td>";
			offerHtml+="      <td style='width:140px;'>"+ec.util.defaultStr(offer.outFlux)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.outVoice)+"</td>";
			offerHtml+="    </tr>";
		}
		offerHtml+="  </tbody>";
		offerHtml+="  </table>";
		offerHtml+="</div>";
		offerHtml+="</td>";
		offerHtml+="</tr>";
		
		$(selected).after(offerHtml);
		$("#plan2ndDiv tbody tr").off("click").on("click",function(event){_linkSelectPlan(this);event.stopPropagation();});
//		alert(response.data);
	};
	var _linkSelectPlan=function(selected){
		$("#plan2ndDiv tbody tr").removeClass("plan_select2");
		$("#plan2ndDiv tbody tr").children(":first-child").html("");
		var offerSpecId = $(selected).attr("offerSpecId");
		var result = _queryOfferSpec(offerSpecId, selected);
		if (result) {
			$(selected).addClass("plan_select2");
			var nike="<i class='terminalSelect'></i>";
			$(selected).children(":first").html(nike);
		}
	};
	
	var _queryOfferSpec=function(offerSpecId, selected){
		var inParam = {
			"price":$(selected).attr("price"),
			"id" : 'tcnum1',
			"specId" : offerSpecId,
			"custId" : OrderInfo.cust.custId,
			"areaId" : OrderInfo.staff.soAreaId
		};
		order.service.opeSer(inParam); //调用公用弹出层
		return true;
	};
	
	
	/**
	 * 查询销售品构成
	 */
	var _queryOfferSpecOld=function(offerSpecId, selected){
		buyChk.hyOfferSpecQty=0;
		buyChk.hyOfferSpecFt=0;
		var data = $(selected).data("__offerSpec");
		if (typeof(data) == "undefined") {
			var params={
					"offerSpecId":Number(offerSpecId)
			};
			var url = contextPath+"/order/queryOfferSpec";
			var response = $.callServiceAsJson(url,params);
			data = response.data.offerSpec;
			$(selected).data("__offerSpec", data);
			
			if (typeof(response) == "undefined" || response==null){
				$.alert("提示","<br/>未查到销售品构成，请稍后再试！");
				return false;
			}
			if (response.code != "0" || !response.isjson){
				$.alert("提示","<br/>未查到销售品构成，请稍后再试！");
				return false;
			}
			if(response.data.code != "POR-0000"){
				$.alert("提示","<br/>未查到销售品构成，请稍后再试！");
				return false;
			}
		}
		var offerSpec= SoOrder.sortOfferSpec(data);//排序主副卡销售品
				
		var offerRoles=offerSpec.offerRoles;
		
		buyChk.hyOfferRoles=offerRoles;
		
		var i;
		var maxQty = 0;
		var minQty = 0;
		/*
		for(i=0;i<offerRoles.length;i++){
			if(CONST.MEMBER_ROLE_CD.VICE_CARD==offerRoles[i].memberRoleCd){
				maxQty=offerRoles[i].maxQty;
				minQty=offerRoles[i].minQty;
			} else {
				offerRoles[i].selectQty=1;
			}
		}
		*/
		/*卞贤伟 2014-0307修改 控制副卡个数*/
		for(i=0;i<offerRoles.length;i++){
			var offerRole = offerRoles[i];
			if(CONST.MEMBER_ROLE_CD.VICE_CARD==offerRoles[i].memberRoleCd){
				if(offerRole.roleObjs){
					$.each(offerRole.roleObjs,function(){
						if(this.objType == 2){
							maxQty = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
							minQty = this.minQty<0?"0":this.minQty;//主卡的最大数量
						}
					});
				}
			} else {
				offerRoles[i].selectQty=1;
			}
		}
		offerSpec.offerRoles=offerRoles;
		//填OrderInfo
		OrderInfo.offerSpec = offerSpec;
		
		//付费类型 ：初始化buyChk.hyOfferSpecFt
		buyChk.hyOfferSpecFt=offerSpec.feeType;
		
		//如果没有副卡
		if (maxQty == 0) {
			return true;
		}
		
		//副卡个数
		var cPanel = $("#termOfferSpecViceLi");
		cPanel.find("input").val(minQty);
		cPanel.find(".addinfo").html("&nbsp;&nbsp;&nbsp;"+minQty+"-"+maxQty+"（张） ");
		cPanel.find("a:first").off("click").on("click", function(event){
			var num = parseInt(cPanel.find("input").val());
			if (num <= minQty) {
				$.alert("提示","副卡数量已经达到最小值，不能再减少。");
				return;
			} else {
				cPanel.find("input").val(num-1);
			}
		});
		cPanel.find("a:last").off("click").on("click", function(event){
			var num = parseInt(cPanel.find("input").val());
			if (num >= maxQty) {
				$.alert("提示","副卡数量已经达到最大值，不能再增加。");
				return;
			} else {
				cPanel.find("input").val(num+1);
			}
		});
		easyDialog.open({
			container : 'termOfferSpec'
		});
		$("#termOfferSpecClose").off("click").on("click",function(event){
			easyDialog.close();
		});
		$("#termOfferSpecCancel").off("click").on("click",function(event){
			easyDialog.close();
		});
		$("#termOfferSpecConfirm").off("click").on("click",function(event){
			var selectQty = cPanel.find("input").val();
			buyChk.hyOfferSpecQty = selectQty;
			for(i=0;i<offerRoles.length;i++){
				if(CONST.MEMBER_ROLE_CD.VICE_CARD==offerRoles[i].memberRoleCd){
					offerRoles[i].selectQty=selectQty;
				} else {
					offerRoles[i].selectQty=1;
				}
			}
			OrderInfo.offerSpec.offerRoles = offerRoles;
			
			easyDialog.close();
		});
		return true;
	};
	/**
	 * 在合约套餐窗口选择套餐
	 */
	var _selectPlan=function(){
		//搜索是否有
		var offerSpec=$("#plan2ndDiv tbody tr[class='plan_select2']");
		if (offerSpec.length!=1) {
			$.alert("提示","请选择一个套餐！");
			return;
		}
		//填入合约信息
		var agreement = offerSpec.parents("#plan2ndTr").prev();
		if (agreement.length!=1) {
			$.alert("提示","请选择一个合约！");
			return;
		}
		mktRes.terminal.offerSpecId = agreement.attr("offerSpecId");
		buyChk.hyFlag = true;
		buyChk.hyOfferSpecId=offerSpec.attr("offerSpecId");
		buyChk.hyOfferSpecName=offerSpec.attr("offerSpecName");
//		order.service.setOfferSpec(1, Number(buyChk.hyOfferSpecQty));
		
		_chkState();
		$("#choosedOfferPlan").html(agreement.attr("offerSpecName"));
		if(mktRes.terminal.dialogForm!=undefined&&mktRes.terminal.dialog!=undefined){
			mktRes.terminal.dialogForm.close(mktRes.terminal.dialog);
		}
	};
	/**
	 * 增加附属销售品（填入合约信息）
	 */
	var _addAttachParam=function(prodId,offerSpecId,offerSpecName){
		var param = {
			offerSpecId:offerSpecId,
			prodId:prodId
		};
		var orderedOfferSpecIds = [];
		var specList = AttachOffer.getSpecList(prodId);
		if(specList!=undefined){
			for (var i = 0; i < specList.length; i++) {  //遍历开通附属
				if(specList[i].offerSpecId!=offerSpecId&&specList[i].isdel!="Y"){
					orderedOfferSpecIds.push(specList[i].offerSpecId);
				}
			}	
		}
		var offerList = AttachOffer.getOfferList(prodId);
		if(offerList!=undefined){
			for (var i = 0; i < offerList.length; i++) { //遍历已订购附属
				if(offerList[i].offerSpecId!=offerSpecId && offerList[i].isdel!="Y"){
					orderedOfferSpecIds.push(offerList[i].offerSpecId);
				}
			}
		}
		if(orderedOfferSpecIds.length>0){
			param.orderedOfferSpecIds = orderedOfferSpecIds;
		}
		var response = $.callServiceAsJsonGet(contextPath+"/offer/queryExcludeDepend",{strParam:JSON.stringify(param)},{});
		if(response.code == 0){
			AttachOffer.parseRuleData(response.data,offerSpecId,prodId,offerSpecName);	
			return true;
		}else if(response.code == 1){
			$.alert("提示","<strong>"+response.errorsList[0].msg+"("+response.errorsList[0].code+")</strong>");
		}else{
			$.alert("提示","数据查询异常，请稍后重试！");
		}
		return false;
	};
	/**
	 * 终端串号校验
	 */
	var _checkTerminalCode=function(id){
		termInfo = {};
		buyChk.tsnFlag = false;
		_chkState();
		$("#tsn_hid").val("");
		
		var tc = $("#"+id).val();
		if(tc == "")
			return ;
		var param = {
			"instCode" : tc,
			"mktResTypeCd" : $("#mktResType").val(),
			"orderNo" : ""
		};
		if(CONST.getAppDesc()==0){
			var mktSpecCode=$("#mktSpecCode").val();
			if($.trim(mktSpecCode)==""){
				$.alert("提示","营销资源返回的规格存货编码为空！");
				return;
			}
			if(mktSpecCode.length>=22){
				mktSpecCode=mktSpecCode.substring(0,22);
			}
			param.mktSpecCode=mktSpecCode;
		}else{
			param.mktResId=$("#mktResId").val();
		}
		var url = contextPath+"/mktRes/terminal/checkTerminal";
		$.callServiceAsJson(url,param,{
			"before":function(){
//				$.ecOverlay("<strong>终端串码校验中,请稍等...</strong>");
			},"always":function(){
//				$.unecOverlay();
			},
			"done" : function(response){
				if (response && response.code == -2) {
					$.alertM(response.data);
				} else if(response&&response.data&&response.data.code == 0) {
					if(response.data.statusCd==CONST.MKTRES_STATUS.USABLE){
						$.alert("提示","<br/>此终端串号可以使用");
						//记录终端串码
//						SoOrder.order.item.mhk.sn  = tc;
						buyChk.tsnFlag = true;
						_chkState();
						$("#tsn_hid").val(tc);
						termInfo = response.data;
						
					}else if(response.data.statusCd==CONST.MKTRES_STATUS.HAVESALE){ //“已销售未补贴”的终端串码可以办理话补合约
						if(buyChk.hyType =='gjsf'){
							$.alert("提示","<br/>此终端串号可以使用");
							//记录终端串码
//							SoOrder.order.item.mhk.sn  = tc;
							buyChk.tsnFlag = true;
							_chkState();
							$("#tsn_hid").val(tc);
							termInfo = response.data;
							termInfo.couponSourc = "2"; //串码话补标识,“2”已销售未补贴
						}else{
							$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用");
						}
						
						
					}else{
						$.alert("提示",response.data.message);
					}
				}else if(response && response.data && response.data.message
						&& response.data.code == 1){
					$.alert("提示", response.data.message);
				}else{
					$.alert("提示","<br/>校验失败，请稍后重试！");
				}
			}
		});
	};
	
	/**
	 * 购买手机，判断是否满足条件，合约机跳往填单，裸机直接算费
	 */
	var _purchase=function(){
		if ("lj"==buyChk.buyType) {
			if (!buyChk.tsnFlag) {
				$.alert("提示","<br/>请先校验终端串号。");
				return;
			}
			var areaId= OrderInfo.staff.soAreaId;
			if(areaId.indexOf("0000")>0){
				$.alert("提示","仅三级和四级地区才能进行裸机购买！");
				return;
			}
			// 单位为元
			var apCharge = $("#mktLjPrice").val() / 100;
			var coupons = [{
				couponUsageTypeCd : "3", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : termInfo.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
				couponNum : 1, //物品数量
				storeId : termInfo.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : apCharge, //物品价格
				couponInstanceNumber : termInfo.instCode, //物品实例编码
				ruleId : "", //物品规则ID
				partyId : CONST.CUST_COUPON_SALE, //客户ID
				prodId : 0, //产品ID
				offerId : 0, //销售品实例ID
				state : "ADD", //动作
				relaSeq : "" //关联序列	
			}];
			//如果是老客户或新建客户
			if (OrderInfo.cust.custId != undefined && OrderInfo.cust.custId != "") {
				coupons[0].partyId = OrderInfo.cust.custId;
			}
			OrderInfo.actionTypeName = "订购";
			OrderInfo.businessName = $("#mktResName").val();
			var data = {};
			data.busiObj = {
				instId : termInfo.mktResId //业务对象实例ID
			};
			data.boActionType = {
				actionClassCd : CONST.ACTION_CLASS_CD.MKTRES_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.COUPON_SALE
			};
			data.coupons = coupons;
			//发展人
			var $tr = $("tr[name='tr_"+$("#mktResId").val()+"']");
			if($tr!=undefined){
				data.dealers = [];
				$tr.each(function(){   //遍历产品有几个发展人
					var dealer = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("staffid") 
					};
					data.dealers.push(dealer);
				});
			}
			SoOrder.getTokenSynchronize();
			//订单提交
			SoOrder.submitOrder(data);
			return;
		} else if ("hy"==buyChk.buyType) {
			if (!buyChk.numFlag) {
				$.alert("提示","<br/>请先选号。");
				return;
			} else if (!buyChk.hyFlag) {
				$.alert("提示","<br/>请先选择合约套餐。");
				return;
			} else if (!buyChk.tsnFlag) {
				$.alert("提示","<br/>请先校验终端串号。");
				return;
			}
			//校验客户是否已定位
			if (OrderInfo.cust.custId==undefined||OrderInfo.cust.custId=="") {
				$.alert("提示","<br/>在订购套餐之前请先进行客户定位！");
				return;
			}
			//构造参数，填单
		} else {
			return;
		}
		var apCharge = $("#price").val() / 100;
		var coupon = {
			couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
			inOutTypeId : "1",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId : termInfo.mktResId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
			couponNum : 1, //物品数量
			storeId : termInfo.mktResStoreId, //仓库ID
			storeName : "1", //仓库名称
			agentId : 1, //供应商ID
			apCharge : apCharge, //物品价格
			couponInstanceNumber : termInfo.instCode, //物品实例编码
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId : -1, //产品ID
			offerId : -1, //销售品实例ID
			attachSepcId : mktRes.terminal.offerSpecId,
			state : "ADD", //动作
			relaSeq : "" ,//关联序列
			couponSource: termInfo.couponSourc //串码话补标识
		};
		if(CONST.getAppDesc()==0){
			coupon.termTypeFlag=termInfo.termTypeFlag;
		}
		OrderInfo.attach2Coupons = [];
		OrderInfo.attach2Coupons.push(coupon);
		var param = {
			boActionTypeCd : 'S1',
			boActionTypeName : "订购",
			offerSpec : OrderInfo.offerSpec,
			offerSpecId : buyChk.hyOfferSpecId,
			offerSpecName : buyChk.hyOfferSpecName,
			viceCardNum : Number(buyChk.hyOfferSpecQty),
			feeType : buyChk.hyOfferSpecFt,
			offerNum : 1,
			type : 2,//1购套餐2购终端3选靓号
			actionFlag : OrderInfo.actionFlag,
			terminalInfo : {
				terminalName : $("#mktResName").val(),
				terminalCode : $("#tsn_hid").val()
			},
			offerRoles : buyChk.hyOfferRoles
		};
		OrderInfo.actionTypeName = "订购";
		SoOrder.builder(); //初始化订单数据
		order.main.buildMainView(param);
	};
	
	return {
		init:_init,
		btnQueryTerminal:_btnQueryTerminal,
		initInParam:_initInParam,
		queryApConfig:_queryApConfig,
		selectTerminal:_selectTerminal,
		setNumber:_setNumber,
		offerSpecId:_offerSpecId,
		selectColor:_selectColor
	};
})(jQuery);

//初始化
$(function(){
	//mktRes.terminal.init();
});
/**
 * 附属销售品受理对象
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("AttachOffer");

/** 附属销售品受理对象*/
AttachOffer = (function() {

	var _openList = []; //保存已经选择的附属销售品列表，保存附属销售品完整节点，以及参数值
	
	var _openedList = []; //已经订购的附属销售品列表，保存附属销售品完整节点，以及参数值
	
	var _openServList = []; //保存已经选择功能产品列表，保存附属销售品完整节点，以及参数值
	
	var _openedServList = []; //保存已经订购功能产品列表，保存附属销售品完整节点，以及参数值
	
	var _openAppList = []; //保存产品下增值业务
	
	var _changeList = []; //3g订购4g流量包订单提交预校验时，保存修改缓存列表的修改数据，用于订单确认页面返回的反向操作
	
	var _labelList = []; //标签列表
	
	var checkedReserveNbr = "";//已经校验过的终端预约号
	
	var checkedReserveCode = "";//已经校验过的终端预约码
	
	var checkedOfferSpec = []; //已经校验过的终端预约号对应的促销包
	
//	var _terminalGroups=[];//终端组
	var totalNums=0;//记录总共添加了多少个终端输入框
	//初始化附属销售页面
	var _init = function(){
		var prodInfo = order.prodModify.choosedProdInfo;
		if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
			$.alert("提示","请选择一个在用产品");
			return;
		}
		OrderInfo.actionFlag = 3;
		if(!query.offer.setOffer()){ //必须先保存销售品实例构成，加载实例到缓存要使用
			return ;
		}
		//规则校验入参
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		},{
			boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		}];
		if(!rule.rule.ruleCheck(boInfos)){ //规则校验失败
			return;
		}
		var param = {
			offerSpecId : prodInfo.prodOfferId,
			offerTypeCd : 1,
			partyId: OrderInfo.cust.custId
		};
		if(ec.util.isObj(prodInfo.prodOfferId)){
			if(!query.offer.queryMainOfferSpec(param)){ //查询主套餐规格构成，并且保存
				return;
			}
		}else{
			OrderInfo.offerSpec = {};
		}
		if(CONST.getAppDesc()==0){ //4g系统需要
			if(!prod.uim.setProdUim()){ //根据UIM类型，设置产品是3G还是4G，并且保存旧卡
				return;	
			}
		}
		AttachOffer.queryAttachOffer();
		
	}; 
	
	//可订购的附属查询 
	var _queryAttachOfferSpec = function(param) {
		var data= query.offer.queryAttachSpec(param);
			if (data) {
				$("#attach_"+param.prodId).html(data);
				_showMainRoleProd(param.prodId); //通过主套餐成员显示角字
				//根据已选功能产品查询带出的可选包
				var servSpecIds = [];
				if(AttachOffer.openServList!=null&&AttachOffer.openServList!=undefined){
					$.each(AttachOffer.openServList,function(){
						if(this.prodId == param.prodId){
							var servSpecList = this.servSpecList;
							if(servSpecList!=null&&servSpecList!=undefined){
								$.each(servSpecList,function(){
									if(this.servSpecId!=null&&this.servSpecId!=undefined){
//										var servSpecListinfo = {
//												servSpecId : this.servSpecId
//										};
//										servSpecIds.push(servSpecListinfo);
										servSpecIds.push(this.servSpecId);
									}
									});
								}
						}
					});					
				}
				if(servSpecIds.length>0){
					param.servSpecIds = servSpecIds;
					var queryData = query.offer.queryServSpecPost(param);
					if(queryData!=null&&queryData.resultCode==0){
						if(queryData.result.offerList!=null&&queryData.result.offerList!=undefined){
							$.each(queryData.result.offerList,function(){
								AttachOffer.addOpenList(param.prodId,this.offerSpecId); 
							});
						}					
					}	
				}
				AttachOffer.changeLabel(param.prodId,param.prodSpecId,""); //初始化第一个标签附属
				if(param.prodId==-1 && OrderInfo.actionFlag==14){ //合约计划特殊处理
					AttachOffer.addOpenList(param.prodId,mktRes.terminal.offerSpecId);
				}
			}
	};
	
	//显示增值业务内容
	var _showApp = function(prodId){
		var appList = CacheData.getOpenAppList(prodId);
		var content = CacheData.getAppContent(prodId,appList);
		$.confirm("增值业务设置： ",content[0].innerHTML,{ 
			yes:function(){	
				$.each(appList,function(){
					if($("#"+prodId+"_"+this.objId).attr("checked")=="checked"){
						this.dfQty = 1;
					}else{
						this.dfQty = 0;
					}
				});
			},
			no:function(){
			}
		});
	};
	
	//获取产品实例
	var getProdInst = function(prodId){
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(ec.util.isArray(offerRole.prodInsts)){
				for ( var j = 0; j < offerRole.prodInsts.length; j++) {  //遍历产品实例列表
					if(offerRole.prodInsts[j].prodInstId==prodId){
						return offerRole.prodInsts[j];
					}
				}
			}
		}
	};
	
	//主销售品角色分解个每个接入产品
	var _showMainRoleProd = function(prodId){
		var prodInst = getProdInst(prodId);
		var app = {
			prodId:prodId,
			appList:[]
		};
		AttachOffer.openAppList.push(app);
		for (var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){ //增值业务角色
				for ( var j = 0; j < offerRole.roleObjs.length; j++) {
					var roleObj = offerRole.roleObjs[j];
					if(roleObj.objType== CONST.OBJ_TYPE.SERV){
						if(prodInst.objId==roleObj.parentProdId && prodInst.componentTypeCd.substring(0,1)==roleObj.componentTypeCd.substring(0,1)){	
							app.appList.push(roleObj);
							if(roleObj.servSpecId==undefined){
								roleObj.servSpecId = roleObj.objId;
							}
							if(roleObj.servSpecName==undefined){
								roleObj.servSpecName = roleObj.objName;
							}
						}
					}
				}
				if(app.appList.length>0){
					var $li = $('<li id="li_'+prodId+'_'+offerRole.offerRoleId+'"></li>');
					$li.append('<dd class="mustchoose" ></dd>');	
					$li.append('<span>'+offerRole.offerRoleName+'</span>');
					$li.append('<dd id="can_'+prodId+'_'+offerRole.offerRoleId+'" class="gou2" onclick="AttachOffer.showApp('+prodId+');"></dd>');
					$("#open_app_ul_"+prodId).append($li);
				}
			}else{ 
				if(offerRole.prodInsts==undefined){
					continue;
				}
				$.each(offerRole.prodInsts,function(){  //遍历产品实例列表
					if(this.prodInstId==prodId){
						for (var k = 0; k < offerRole.roleObjs.length; k++) {
							var roleObj = offerRole.roleObjs[k];
							if(roleObj.objType==CONST.OBJ_TYPE.SERV){
								var servSpecId = roleObj.objId;
								var $oldLi = $('#li_'+prodId+'_'+servSpecId);
								var spec = CacheData.getServSpec(prodId,servSpecId);//从已选择功能产品中找
								if(spec != undefined){
									if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14){
										if(roleObj.dfQty == 0 && spec.ifDault==1){//在基础功能中没有选中的默认删除状态 
											var $span=$oldLi.find("span");
											$span.addClass("del");
											spec.isdel = "Y";
										}
									}
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								var serv = CacheData.getServBySpecId(prodId,servSpecId);//从已订购功能产品中找
								if(serv!=undefined){ //不在已经开跟已经选里面
									var $oldLi = $('#li_'+prodId+'_'+serv.servId);
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								if(roleObj.dfQty > 0){ //必选，或者默选
									var servSpec=jQuery.extend(true, {}, roleObj);
									CacheData.setServSpec(prodId,servSpec); //添加到已开通列表里
									spec = servSpec;
									if(ec.util.isArray(spec.prodSpecParams)){
										spec.ifParams = "Y";
									}
									$('#li_'+prodId+'_'+servSpecId).remove(); //删除可开通功能产品里面
									var $li = $('<li id="li_'+prodId+'_'+servSpecId+'"></li>');
									if(roleObj.minQty==0){
										$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+','+servSpecId+',\''+spec.servSpecName+'\',\''+spec.ifParams+'\')"></dd>');
									}else{
										$li.append('<dd class="mustchoose"></dd>');
									}
									$li.append('<span>'+spec.servSpecName+'</span>');
									if (spec.ifParams=="Y"){
										if(CacheData.setServParam(prodId,spec)){ 
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}else {
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}
									}
									$li.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									$("#open_serv_ul_"+prodId).append($li);
									spec.isdel = "N";
									_showHideUim(0,prodId,servSpecId);//显示或者隐藏补换卡
								}
							}
						}
					}
				});
			}
		}
	};
	
	var _showMainMemberRoleProd=function(prodId){
		for (var i = 0; i < OrderInfo.viceOfferSpec.length; i++) {//多张副卡同时进行套餐变更
			var offerSpec=OrderInfo.viceOfferSpec[i];
			if(prodId==offerSpec.prodId){
				for (var j = 0; j < offerSpec.offerRoles.length; j++) {
					var offerRole = offerSpec.offerRoles[j];
					if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){//主卡
						for (var k = 0; k < offerRole.roleObjs.length; k++) {
							var roleObj = offerRole.roleObjs[k];
							if(roleObj.objType==CONST.OBJ_TYPE.SERV){
								var servSpecId = roleObj.objId;
								var $oldLi = $('#li_'+prodId+'_'+servSpecId);
								var spec = CacheData.getServSpec(prodId,servSpecId);//从已选择功能产品中找
								if(spec != undefined){
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								var serv = CacheData.getServBySpecId(prodId,servSpecId);//从已订购功能产品中找
								if(serv!=undefined){ //不在已经开跟已经选里面
									var $oldLi = $('#li_'+prodId+'_'+serv.servId);
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								if(roleObj.dfQty > 0){ //必选，或者默选
									var servSpec=jQuery.extend(true, {}, roleObj);
									CacheData.setServSpec(prodId,servSpec); //添加到已开通列表里
									spec = servSpec;
									if(ec.util.isArray(spec.prodSpecParams)){
										spec.ifParams = "Y";
									}
									$('#li_'+prodId+'_'+servSpecId).remove(); //删除可开通功能产品里面
									var $li = $('<li id="li_'+prodId+'_'+servSpecId+'"></li>');
									if(roleObj.minQty==0){
										$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+','+servSpecId+',\''+spec.servSpecName+'\',\''+spec.ifParams+'\')"></dd>');
									}else{
										$li.append('<dd class="mustchoose"></dd>');
									}
									$li.append('<span>'+spec.servSpecName+'</span>');
									if (spec.ifParams=="Y"){
										if(CacheData.setServParam(prodId,spec)){ 
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}else {
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}
									}
									$li.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									$("#open_serv_ul_"+prodId).append($li);
									spec.isdel = "N";
									_showHideUim(0,prodId,servSpecId);//显示或者隐藏补换卡
								}
							}
						}
					}
				}
			}
		}
	};
	
	//查询附属销售品规格
	var _searchAttachOfferSpec = function(prodId,offerSpecId,prodSpecId) {
		var param = {   
			prodId : prodId,
		    prodSpecId : prodSpecId,
		    offerSpecIds : [offerSpecId],
		    ifCommonUse : "" 
		};
//		if(OrderInfo.actionFlag == 2){ //套餐变更		
//			param.offerSpecIds=[OrderInfo.offerSpec.offerSpecId];
//		}
		if(OrderInfo.actionFlag == 2){ //套餐变更
			param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(ec.util.isArray(this.prodInsts)){
					$.each(this.prodInsts,function(){
						if(this.prodInstId==prodId){
							param.acctNbr = this.accessNumber;
							param.offerRoleId = this.offerRoleId;
							param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);	
							return false;
						}
					});
				}
			});
			
			var prodInst = OrderInfo.getProdInst(prodId);
			if(prodInst){
				param.offerRoleId = prodInst.offerRoleId;
			}
			
			for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
				if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
					param.acctNbr = OrderInfo.oldprodInstInfos[i].accNbr;
					$.each(OrderInfo.oldofferSpec,function(){
						if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){
							param.offerSpecIds.push(this.offerSpec.offerSpecId);	
							$.each(this.offerSpec.offerRoles,function(){
								if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD || this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){
									param.offerRoleId = this.offerRoleId;
								}
							});
						}
					});
				}
			}
		}else if(OrderInfo.actionFlag == 3){  //可选包
			var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
			param.acctNbr = prodInfo.accNbr;
			if(!ec.util.isObj(prodInfo.prodOfferId)){
				prodInfo.prodOfferId = "";
			}
			var offerRoleId = CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;
			if(offerRoleId==undefined){
				offerRoleId = "";
			}
			param.offerRoleId = offerRoleId;
			param.offerSpecIds.push(prodInfo.prodOfferId);
		}else if(OrderInfo.actionFlag == 21){ //副卡套餐变更		
			$.each(OrderInfo.viceOfferSpec,function(){
				var offerSpecId=this.offerSpecId;
				var accessNumber=this.accessnumber;
				if(this.prodId==prodId){
					$.each(this.offerRoles,function(){
						if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD || this.memberRoleCd=="1"){
							$.each(this.roleObjs,function(){
								if(this.objType==CONST.OBJ_TYPE.PROD){
									param.acctNbr = accessNumber;
									param.offerRoleId = this.offerRoleId;
									param.offerSpecIds.push(offerSpecId);	
									return false;
								}
							});
						}
					});
				}
			});
		}else if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
			var oldoffer = {};
			for(var j=0;j<OrderInfo.oldoffer.length;j++){
				oldoffer = OrderInfo.oldoffer[j];
				for ( var i = 0; i < OrderInfo.oldoffer[j].offerMemberInfos.length; i++) {
					var offerMember = OrderInfo.oldoffer[j].offerMemberInfos[i];
					if(offerMember.objInstId==prodId){
						param.acctNbr = offerMember.accessNumber;
						$.each(OrderInfo.oldofferSpec,function(){
							if(this.accNbr==oldoffer.accNbr){
								param.offerSpecIds.push(this.offerSpec.offerSpecId);	
								$.each(this.offerSpec.offerRoles,function(){
									if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD || this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){
										param.offerRoleId = this.offerRoleId;
										return false;
									}
								});
							}
						});
					}
				}
			}
		}else { //新装
			param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);
			var prodInst = OrderInfo.getProdInst(prodId);
			if(prodInst){
				param.offerRoleId = prodInst.offerRoleId;
			}
		}
		var offerSepcName = $("#search_text_"+prodId).val();
		if(offerSepcName.replace(/\ /g,"")==""){
			$.alert("提示","请输入查询条件！");
			return;
		}
		param.offerSpecName = offerSepcName;
		var data = query.offer.searchAttachOfferSpec(param);
		if(data!=undefined){
			$("#attach_div_"+prodId).html(data).show();
		}
	};
	
	//点击搜索出来的附属销售品
	var _selectAttachOffer = function(prodId,offerSpecId){
		$("#attach_div_"+prodId).hide();
		_addAttOffer(prodId,offerSpecId);
	};
	
	//点击搜索出来的功能产品
	var _selectServ = function(prodId,servSpecId,specName,ifParams){
		$("#attach_div_"+prodId).hide();
		_openServSpec(prodId,servSpecId,specName,ifParams);
	};
	
	//点击搜索出来的附属销售品
	var _closeAttachSearch = function(prodId){
		$("#attach_div_"+prodId).hide();
	};
	
	//已订购的附属销售品查询
	var _queryAttachOffer = function() {
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		var prodId = prodInfo.prodInstId;
		var param = {
		    prodId : prodId,
		    prodSpecId : prodInfo.productId,
		    offerSpecId : prodInfo.prodOfferId,
		    acctNbr : prodInfo.accNbr
		};
		if(ec.util.isObj(prodInfo.prodBigClass)){
			param.prodBigClass = prodInfo.prodBigClass;
		}
		var data = query.offer.queryAttachOfferHtml(param);
		SoOrder.initFillPage();
		$("#order_fill_content").html(data).show();
		var member = CacheData.getOfferMember(prodId);
		//如果objId，objType，objType不为空才可以查询默认必须
		if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){
			param.queryType = "1,2";
			param.objId = member.objId;
			param.objType = member.objType;
			param.offerRoleId = member.offerRoleId;
			param.memberRoleCd = member.roleCd;
			//默认必须可选包
			var data = query.offer.queryDefMustOfferSpec(param);
			CacheData.parseOffer(data);
			//默认必须功能产品
			var data = query.offer.queryServSpec(param);
			CacheData.parseServ(data);
		}
		if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){ //主套餐下的成员判断
			var member = CacheData.getOfferMember(prodId);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(this.offerRoleId==member.offerRoleId && member.objType==CONST.OBJ_TYPE.PROD){
					var offerRole = this;
					$.each(this.roleObjs,function(){
						if(this.objType==CONST.OBJ_TYPE.SERV){
							var serv = CacheData.getServBySpecId(prodId,this.objId);//从已订购功能产品中找
							if(serv!=undefined){ //不在已经开跟已经选里面
								var $oldLi = $('#li_'+prodId+'_'+serv.servId);
								if(this.minQty==1){
									$oldLi.append('<dd class="mustchoose"></dd>');
								}
								$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
							}
						}
					});
					return false;
				}
			});
		}
		AttachOffer.changeLabel(prodId, prodInfo.productId,""); //初始化第一个标签附属
		order.dealer.initDealer();
	};
	
	//删除附属销售品规格
	var _delOfferSpec = function(prodId,offerSpecId,reflag){
		var $span = $("#li_"+prodId+"_"+offerSpecId).find("span"); //定位删除的附属
		if($span.attr("class")=="del"){  //已经取消订购，再订购
			AttachOffer.addOfferSpec(prodId,offerSpecId);
		}else { //取消订购
			var spec = CacheData.getOfferSpec(prodId,offerSpecId);
			if(reflag!=undefined && reflag=="reload"){//暂存单二次加载
				$span.addClass("del");
				spec.isdel = "Y";
				delServSpec(prodId,spec); //取消订购销售品时
				order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
				$("#terminalUl_"+prodId+"_"+offerSpecId).remove();
				spec.isTerminal = 0;
			}else{
				var content = CacheData.getOfferProdStr(prodId,spec,2);
				$.confirm("信息确认",content,{ 
					yes:function(){
						$span.addClass("del");
						spec.isdel = "Y";
						delServSpec(prodId,spec); //取消订购销售品时
						order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
						$("#terminalUl_"+prodId+"_"+offerSpecId).remove();
						spec.isTerminal = 0;
					},
					no:function(){
						
					}
				});
			}
		}
	};
	
	//删除附属销售品实例
	var _delOffer = function(prodId,offerId,reflag){
		var $span = $("#li_"+prodId+"_"+offerId).find("span"); //定位删除的附属
		
		if($span.attr("class")=="del"){  //已经退订，再订购
			AttachOffer.addOffer(prodId,offerId,$span.text());
		}else { //退订
			var offer = CacheData.getOffer(prodId,offerId);
			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offerId	
				};
				if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){
					var flag = false;
					for(var j=0;j<OrderInfo.oldoffer.length;j++){
						var oldOffer = OrderInfo.oldoffer[j];
						for ( var i = 0; i < oldOffer.offerMemberInfos.length; i++) {
							var oldOfferMember = oldOffer.offerMemberInfos[i];
							if(oldOfferMember.objInstId==prodId){
								param.acctNbr = oldOfferMember.accessNumber;
								flag = true;
								break;
							}
						}
						if(flag){
							for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
								if(offer.accNbr == OrderInfo.oldprodInstInfos[i].accNbr){
									param.areaId = OrderInfo.oldprodInstInfos[i].areaId;
								}
							}
						}
					}
				}else{
					param.acctNbr = OrderInfo.getAccessNumber(prodId);
				}
				var data = query.offer.queryOfferInst(param);
				if(data==undefined){
					return;
				}
				//遍历附属的构成要和主套餐的构成实例要一致（兼容融合套餐）
				var offerMemberInfos=[];
				$.each(data.offerMemberInfos,function(){
					var prodInstId=this.objInstId;
					var flag=false;
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objInstId==prodInstId){
							flag=true;
							return false;
						}
					});
					if(flag){
						offerMemberInfos.push(this);
					}
				});
				
				offer.offerMemberInfos = data.offerMemberInfos=offerMemberInfos;
				offer.offerSpec = data.offerSpec;
			}
			if(reflag!=undefined && reflag=="reload"){//暂存单二次加载
				offer.isdel = "Y";
				$span.addClass("del");
				delServByOffer(prodId,offer);
			}else{
				var content = "";
				if(offer.offerSpec!=undefined){
					content = CacheData.getOfferProdStr(prodId,offer,1);
				}else {
					content = '退订【'+$span.text()+'】可选包' ;
				}
				$.confirm("信息确认",content,{ 
					yes:function(){
						offer.isdel = "Y";
						$span.addClass("del");
						delServByOffer(prodId,offer);
					},
					no:function(){	
					}
				});
			}
		}
	};
	
	//关闭服务规格
	var _closeServSpec = function(prodId,servSpecId,specName,ifParams){
		var $span = $("#li_"+prodId+"_"+servSpecId).find("span"); //定位删除的附属
		if($span.attr("class")=="del"){  //已经退订，再订购
			AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams);
		}else { //退订
			$.confirm("信息确认","取消开通【"+$span.text()+"】功能产品",{ 
				yesdo:function(){
					var spec = CacheData.getServSpec(prodId,servSpecId);
					if(spec == undefined){ //没有在已开通附属销售列表中
						return;
					}
					$span.addClass("del");
					spec.isdel = "Y";
					_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					
					var serv = CacheData.getServBySpecId(prodId,servSpecId);
					if(ec.util.isObj(serv)){ //没有在已开通附属销售列表中
						$span.addClass("del");
						serv.isdel = "Y";
						//_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					}
				},
				no:function(){
				}
			});
		}
	};
	
	//关闭服务实例
	var _closeServ = function(prodId,servId,reflag){
		var serv = CacheData.getServ(prodId,servId);
		var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
		if($span.attr("class")=="del"){  //已经关闭，取消关闭
			_openServ(prodId,serv);
		}else if("13409244"==serv.servSpecId){//一卡双号虚号
			$.alert("提示","请通过“一卡双号退订”入口或者短信入口退订此功能");
		}else{ //关闭
			var uim = OrderInfo.getProdUim(prodId);
			if(serv.servSpecId=="280000020" && (OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23) && uim.cardTypeFlag=="1"){//补换卡补4G卡不能退订4G上网功能产品
				$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");
				return;
			}
			if(reflag!=undefined && reflag=="reload"){//暂存单二次加载
				$span.addClass("del");
				serv.isdel = "Y";
			}else{
				$.confirm("信息确认","关闭【"+$span.text()+"】功能产品",{ 
					yesdo:function(){
						$span.addClass("del");
						serv.isdel = "Y";
					},
					no:function(){						
					}
				});
			}
		}
	};
	
	//开通功能产品
	var _openServSpec = function(prodId,servSpecId,specName,ifParams){
		$.confirm("信息确认","开通【"+specName+"】功能产品",{ 
			yesdo:function(){
				var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
				if(servSpec==undefined){   //在可订购功能产品里面 
					var newSpec = {
						objId : servSpecId, //调用公用方法使用
						servSpecId : servSpecId,
						servSpecName : specName,
						ifParams : ifParams,
						isdel : "C"   //加入到缓存列表没有做页面操作为C
					};
					var inPamam = {
						prodSpecId:servSpecId
					};
					if(ifParams == "Y"){
						var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
						if(data==undefined || data.result==undefined){
							return;
						}
						newSpec.prodSpecParams = data.result.prodSpecParams;
					if(servSpecId==CONST.YZFservSpecId){//翼支付助手根据付费类型改变默认值
						var feeType = $("select[name='pay_type_-1']").val();
						if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
						if(feeType == CONST.PAY_TYPE.AFTER_PAY){
							for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {
								var prodSpecParam = newSpec.prodSpecParams[j];
								prodSpecParam.setValue = "";
							}																			
						}else{
							for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {							
								var prodSpecParam = newSpec.prodSpecParams[j];
								if (prodSpecParam.value!="") {
									prodSpecParam.setValue = prodSpecParam.value;
								} else if (!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!="")
									//默认值为空则取第一个
									prodSpecParam.setValue = prodSpecParam.valueRange[0].value;
						}
					  }
					}
					}
					CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
					servSpec = newSpec;
				}
				_checkServExcludeDepend(prodId,servSpec);
			},
			no:function(){
			}
		});
	};
	
	//开通功能产品
	var _openServ = function(prodId,serv){
		$.confirm("信息确认","取消关闭【"+serv.servSpecName+"】功能产品",{ 
			yesdo:function(){
				if(serv!=undefined){   //在可订购功能产品里面 
					if(serv.servSpecId==""){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.removeClass("del");
						serv.isdel = "N";
					}else{
						_checkServExcludeDepend(prodId,serv);
					}
				}
			},
			no:function(){
			}
		});
	};
	
	//校验销售品的互斥依赖
	var _checkOfferExcludeDepend = function(prodId,offerSpec){
		var offerSpecId = offerSpec.offerSpecId;
		var param = CacheData.getExcDepOfferParam(prodId,offerSpecId);
//		if(param.orderedOfferSpecIds.length == 0 ){
////			AttachOffer.addOpenList(prodId,offerSpecId); 
//			paserOfferData("",prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
//		}else{
		var data = query.offer.queryExcludeDepend(param);//查询规则校验
		if(data!=undefined){
			paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
		}
//		}
		
		//获取销售品节点校验销售品下功能产品的互斥依赖
		/*var offerSpec = CacheData.getOfferSpec(offerSpecId);
		if(offerSpec!=undefined){
			$.each(offerSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					var param = {
						prodId : prodId,
						servSpecId : this.objId,
						orderedServSpecIds : [] //功能产品互斥依赖查询入场数组
					};
					//已选销售品列表
					var offerSpecList = CacheData.getSpecList(prodId);
					if(ec.util.isArray(offerSpecList)){
						$.each(offerSpecList,function(){
							if(this.offerSpecId!=offerSpecId && this.isdel!="Y" && this.isdel!="C"){
								param.orderedOfferSpecIds.push(this.offerSpecId);
							}
						});
					}
					if(param.orderedServSpecIds.length == 0 ){
						AttachOffer.addOpenList(prodId,offerSpecId); 
					}else{
						datas.push(query.offer.queryServExcludeDepend(param));//查询规则校验
					}
				});
			});
		}*/
		//paserData(datas,prodId,offerSpecId,offer.offerSpecName,"OFFER"); //解析数据
		
		/*if(param.orderedOfferSpecIds.length == 0 ){
			AttachOffer.addOpenList(prodId,offerSpecId); 
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserData(data.result,prodId,offerSpecId,offer.offerSpecName,"OFFER"); //解析数据
			}
		}*/
	};
	
	//校验服务的互斥依赖
	var _checkServExcludeDepend = function(prodId,serv,flag){
		var servSpecId = serv.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		if(param.orderedServSpecIds.length == 0){
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserServData(data.result,prodId,serv);//解析数据
			}
		}
	};
	
	//订购附属销售品
	var _addOfferSpec = function(prodId,offerSpecId){
		
		var newSpec = _setSpec(prodId,offerSpecId);
		
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		$.confirm("信息确认",content,{ 
			yes:function(){
				CacheData.setServ2OfferSpec(prodId,newSpec);
			},
			yesdo:function(){
				_checkOfferExcludeDepend(prodId,newSpec);
			},
			no:function(){
			}
		});
	};
	
	//根据预校验返回订购附属销售品
	var _addOfferSpecByCheck = function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		$.confirm("信息确认",content,{ 
			yes:function(){
				CacheData.setServ2OfferSpec(prodId,newSpec);
			},
			yesdo:function(){
				_checkOfferExcludeDepend(prodId,newSpec);
			}
		});
	};
	
	//删除附属销售品带出删除功能产品
	var delServSpec = function(prodId,offerSpec){
		$.each(offerSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				var servSpecId = this.objId;
				if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){
					var spec = CacheData.getServSpec(prodId,servSpecId);
					if(ec.util.isObj(spec)){
						spec.isdel = "Y";
						var $li = $("#li_"+prodId+"_"+servSpecId);
						$li.removeClass("canshu").addClass("canshu2");
						$li.find("span").addClass("del"); //定位删除的附属
						_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					}
				}
			});
		});
	};
	
	//删除附属销售品带出删除功能产品
	var delServByOffer = function(prodId,offer){	
		$.each(offer.offerMemberInfos,function(){
			var servId = this.objInstId;
			if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){
				var serv = CacheData.getServ(prodId,servId);
				if(ec.util.isObj(serv)){
					serv.isdel = "Y";
					var $li = $("#li_"+prodId+"_"+servId);
					$li.removeClass("canshu").addClass("canshu2");
					$li.find("span").addClass("del"); //定位删除的附属
				}
			}
		});
	};
	
	//取消退订附属销售品
	var _addOffer = function(prodId,offerId){
		var specName = $("#li_"+prodId+"_"+offerId).find("span").text();
		$.confirm("信息确认","取消退订【"+specName+"】可选包",{ 
			yesdo:function(){
				var offer = CacheData.getOffer(prodId,offerId); //在已经开通列表中查找
				if(offer!=undefined){   //在可订购功能产品里面 
					if(offer.offerSpecId==""){
						var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
						$span.removeClass("del");
						offer.isdel = "N";
					}else{
						_checkOfferExcludeDepend(prodId,offer);
					}
				}
			},
			no:function(){
			}
		});
	};
	
	//确认订购附属销售品
	var _addAttOffer = function(prodId,offerSpecId,specName){
		_addOfferSpec(prodId,offerSpecId);
	};
	
	//解析互斥依赖返回结果
	var paserOfferData = function(result,prodId,offerSpecId,specName){
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
				excludeOffer : [],   //互斥依赖显示列表
				defaultOffer : [], //默选的显示列表
				dependOffer : {  //存放互斥依赖列表
					dependOffers : [],
					offerGrpInfos : []
				}
		};
		if(result!=""){
			var exclude = result.offerSpec.exclude;
			var depend = result.offerSpec.depend;
			var defaultOffer=result.offerSpec.defaultList;
			//解析可选包互斥依赖组
			if(ec.util.isArray(exclude)){
				for (var i = 0; i < exclude.length; i++) {
					var offerList = CacheData.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
						param.excludeOffer.push(exclude[i].offerSpecId);
					}
				}
			}
			if(depend!=undefined && ec.util.isArray(depend.offerInfos)){
				for (var i = 0; i < depend.offerInfos.length; i++) {	
					content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
				}	
			}
			if(depend!=undefined && ec.util.isArray(depend.offerGrpInfos)){
				for (var i = 0; i < depend.offerGrpInfos.length; i++) {
					var offerGrpInfo = depend.offerGrpInfos[i];
					param.dependOffer.offerGrpInfos.push(offerGrpInfo);
					content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
					if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
						for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
							var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
							var offerSpec=CacheData.getOfferSpec(prodId,subOfferSpec.offerSpecId);
							if(ec.util.isObj(offerSpec)){
								if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
									content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}else{
								var offerSpec=CacheData.getOfferBySpecId(prodId,subOfferSpec.offerSpecId);
								if(ec.util.isObj(offerSpec)){
									if(offerSpec.isdel!="Y"&&offerSpec.isdel!="C"){
										content += '<input id="'+subOfferSpec.offerSpecId+'" checked="checked" disabled="disabled" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}else{
										content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
									}
								}else{
									content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
								}
							}
						}
					}
				}
			}
			//解析可选包默选组
			if(ec.util.isArray(defaultOffer)){
				for (var i = 0; i < defaultOffer.length; i++) {	
					content += "需要开通： " + defaultOffer[i].offerSpecName + "<br>";
					param.defaultOffer.push(defaultOffer[i].offerSpecId);
				}	
			}
		}
		var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);//查询销售品构成成员的依赖互斥以及连带
		content=content+serContent;
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenList(prodId,offerSpecId); 
		}else{	
			content = "<div style='max-height:300px;overflow:auto;'>" + content + "</div>";
			$.confirm("订购： " + specName,content,{ 
				yes:function(){
					CacheData.setOffer2ExcludeOfferSpec(param);
				},
				yesdo:function(){
					excludeAddattch(prodId,offerSpecId,param);
					excludeAddServ(prodId,"",paramObj);
				},
				no:function(){
					
				}
			});
		}
	};
	
	/*//解析互斥依赖返回结果
	var paserData = function(datas,prodId,offerSpecId,specName,objType){
		var exclude = result.offerSpec.exclude;
		var depend = result.offerSpec.depend;
		var servExclude = result.servSpec.exclude;
		var servDepend = result.servSpec.depend;

		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeOffer : [],   //互斥依赖显示列表
			dependOffer : {  //存放互斥依赖列表
				dependOffers : [],
				offerGrpInfos : []
			},
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [] //存放互斥依赖列表
		};
		
		//解析可选包互斥依赖组
		if(exclude!=undefined && exclude.length>0){
			for (var i = 0; i < exclude.length; i++) {
				var offerList = AttachOffer.getOfferList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(offerList!=undefined){
					for ( var j = 0; j < offerList.length; j++) {
						if(offerList[j].isdel=="Y"){
							if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
					param.excludeOffer.push(exclude[i].offerSpecId);
				}
			}
		}
		if(depend!=undefined && depend.offerInfos!=undefined && depend.offerInfos.length>0){
			for (var i = 0; i < depend.offerInfos.length; i++) {	
				content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
				param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
			}	
		}
		if(depend!=undefined && depend.offerGrpInfos!=undefined && depend.offerGrpInfos.length>0){
			for (var i = 0; i < depend.offerGrpInfos.length; i++) {
				var offerGrpInfo = depend.offerGrpInfos[i];
				param.dependOffer.offerGrpInfos.push(offerGrpInfo);
				content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
				if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
					for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
						var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
						content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
					}
				}
			}
		}
		
		//解析功能产品互斥依赖组
		if(servExclude!=undefined && servExclude.length>0){
			$.each(servExclude,function(){
				if(this.offerSpecId == undefined || this.offerSpecId == ""){ //纯功能产品互斥
					var servList = AttachOffer.getServList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(servList!=undefined){
						for ( var i = 0; i < servList.length; i++) {
							if(servList[i].isdel=="Y"){
								if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + this.servSpecName + "<br>";
						param.excludeServ.push(this);
					}
				}else {  //可选包下功能产品互斥
					var offerList = AttachOffer.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == this.offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + this.offerSpecName + "<br>";
						param.excludeOffer.push(this.offerSpecId);
					}
				}
			});
		}
		if(servDepend!=undefined && servDepend.length>0){
			$.each(servDepend,function(){
				if(this.offerSpecId == undefined || this.offerSpecId == ""){ //纯功能产品依赖
					content += "需要开通：   " + this.servSpecName + "<br>";
					param.dependServ.push(this);
				}else {  //功能产品与可选包下功能产品依赖
					content += "需要开通：   " + this.offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(this.offerSpecId);
				}
			});
		}
		
		if(content==""){ //没有互斥依赖
			if(objType == "OFFER"){
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}else {
				AttachOffer.addOpenServList(prodId,offerSpecId); 
			}
		}else{	
			$.confirm("开通： " + specName,content,{ 
				yesdo:function(){
					excludeAddattch(prodId,offerSpecId,param,objType);
				},
				no:function(){
					
				}
			});
		}
	};*/
	
	//解析服务互斥依赖
	var paserServData = function(result,prodId,serv){
		var servSpecId = serv.servSpecId;
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var servOfferList = result.servSpec.offerList; //带出的可选包
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [], //连带
			offerListServ : [] //带出的可选包
		};
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + this.servSpecName + "<br>";
					param.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.dependServ.push(this);
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.relatedServ.push(this);
			});
		}
		//解析带出的可选包，获取功能产品订购依赖互斥的接口返回的带出可选包拼接成字符串
		if(ec.util.isArray(servOfferList)){
			if(servOfferList.length>0){
				content += "需要订购：   <br>";
				$.each(servOfferList,function(){
					if(this.ifDault===0){
						content += '<input id="check_open_'+prodId+'_'+this.offerSpecId +'" type="checkbox" checked="checked" disabled="disabled">'+this.offerSpecName+'<br>'; 
					}else{
						content += '<input id="check_open_'+prodId+'_'+this.offerSpecId +'" type="checkbox" checked="checked">'+this.offerSpecName+'<br>'; 
					}
//					content += "需要订购：   " + this.offerSpecName + "<br>";
					param.offerListServ.push(this);
				});
			}
		}
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			if(OrderInfo.newOrderInfo.isReloadFlag=="N"){
				AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
				excludeAddServ(prodId,servSpecId,param);
			}else{
				$.confirm("开通： " + serv.servSpecName,content,{ 
					yes:function(){
						AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
						excludeAddServ(prodId,servSpecId,param);
					},
					no:function(){
					}
				});
			}

		}
	};
	
	//服务互斥依赖时带出添加跟删除
	var excludeAddServ = function(prodId,servSpecId,param){
		if(ec.util.isArray(param.excludeServ)){ //有互斥
			for (var i = 0; i < param.excludeServ.length; i++) { //删除已开通
				var excludeServSpecId = param.excludeServ[i].servSpecId;
				var spec = CacheData.getServSpec(prodId,excludeServSpecId);
				if(spec!=undefined){
					var $span = $("#li_"+prodId+"_"+excludeServSpecId).find("span");
					$span.addClass("del");
					spec.isdel = "Y";
				}else{
					var serv = CacheData.getServBySpecId(prodId,excludeServSpecId);
					if(serv!=undefined){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.addClass("del");
						serv.isdel = "Y";
					}
				}
			}
		}
		if(ec.util.isArray(param.dependServ)){ // 依赖
			for (var i = 0; i < param.dependServ.length; i++) {
				var servSpec = param.dependServ[i];
				AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams); 
			}
		}
		if(ec.util.isArray(param.relatedServ)){ // 连带
			for (var i = 0; i < param.relatedServ.length; i++) {
				var servSpec = param.relatedServ[i];
				AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams); 
			}
		}
		if(ec.util.isArray(param.offerListServ)){//添加带出的可选包
			for (var i = 0; i < param.offerListServ.length; i++) {
				var servSpec = param.offerListServ[i];
				if($("#check_open_"+prodId+"_"+servSpec.offerSpecId).attr("checked")=="checked"){
					AttachOffer.addOpenList(prodId,servSpec.offerSpecId); 
				}
			}
		}
	};
	
	//互斥依赖时添加
	var excludeAddattch = function(prodId,specId,param){
		if(param.dependOffer.offerGrpInfos.length>0){  // 依赖组
			var dependOffer=param.dependOffer;
			for (var i = 0; i < dependOffer.offerGrpInfos.length; i++) {
				var offerGrpInfo = dependOffer.offerGrpInfos[i];
				var len  = offerGrpInfo.checkLen;
				if(len>=offerGrpInfo.minQty&&len<=offerGrpInfo.maxQty){
					$.each(offerGrpInfo.subOfferSpecInfos,function(){
						if(this.isCheck){
							AttachOffer.addOpenList(prodId,this.offerSpecId); 
						}
					});
				}else if(len<offerGrpInfo.minQty){
					$.alert("提示信息","依赖组至少选中"+offerGrpInfo.minQty+"个！");
					return;
				}else if(len>offerGrpInfo.maxQty){
					$.alert("提示信息","依赖组至多选中"+offerGrpInfo.maxQty+"个！");
					return;
				}else {
					$.alert("错误信息","依赖组选择出错！");
					return;
				}
			}
		}
		
		AttachOffer.addOpenList(prodId,specId); //添加开通附属
		if(param.excludeOffer.length>0){ //有互斥
			//删除已开通
			for (var i = 0; i < param.excludeOffer.length; i++) {
				var excludeSpecId = param.excludeOffer[i];
				var spec = CacheData.getOfferSpec(prodId,excludeSpecId);
				if(spec!=undefined){
					var $span = $("#li_"+prodId+"_"+excludeSpecId).find("span");
					$span.addClass("del");
					spec.isdel = "Y";
					$("#terminalUl_"+prodId+"_"+excludeSpecId).remove();
				}
				var offer = CacheData.getOfferBySpecId(prodId,excludeSpecId);
				if(offer!=undefined){
					var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
					$span.addClass("del");
					offer.isdel = "Y";
				}
			}
		}
		if(param.dependOffer.dependOffers.length>0){ // 依赖
			for (var i = 0; i < param.dependOffer.dependOffers.length; i++) {
				var offerSpecId = param.dependOffer.dependOffers[i];
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}
		}
		if(param.defaultOffer.length>0){ // 默选
			for (var i = 0; i < param.defaultOffer.length; i++) {
				var offerSpecId = param.defaultOffer[i];
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}
		}
		/*if(objType == "OFFER"){
			AttachOffer.addOpenList(prodId,specId); //添加开通附属
			if(param.excludeOffer.length>0){ //有互斥
				//删除已开通
				for (var i = 0; i < param.excludeOffer.length; i++) {
					var excludeSpecId = param.excludeOffer[i];
					var spec = AttachOffer.getSpec(prodId,excludeSpecId);
					if(spec!=undefined){
						var $span = $("#li_"+prodId+"_"+excludeSpecId).find("span");
						$span.addClass("del");
						spec.isdel = "Y";
					}
					var offer = AttachOffer.getOfferBySpecId(prodId,excludeSpecId);
					if(offer!=undefined){
						var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
						$span.addClass("del");
						offer.isdel = "Y";
					}
				}
			}
			if(param.dependOffer.dependOffers.length>0){ // 依赖
				for (var i = 0; i < param.dependOffer.dependOffers.length; i++) {
					var offerSpecId = param.dependOffer.dependOffers[i];
					AttachOffer.addOpenList(prodId,offerSpecId); 
				}
			}
		}else{
			AttachOffer.addOpenServList(prodId,specId); //添加开通功能
			if(param.excludeServ!=undefined && param.excludeServ.length>0){ //有互斥
				//删除已开通
				for (var i = 0; i < param.excludeServ.length; i++) {
					var excludeServSpecId = param.excludeServ[i].servSpecId;
					var spec = CacheData.getServSpec(prodId,excludeServSpecId);
					if(spec!=undefined){
						var $span = $("#li_"+prodId+"_"+excludeServSpecId).find("span");
						$span.addClass("del");
						spec.isdel = "Y";
					}
					var serv = AttachOffer.getServ(prodId,excludeServSpecId);
					if(serv!=undefined){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.addClass("del");
						serv.isdel = "Y";
					}
				}
			}
			if(param.dependServ!=undefined&&param.dependServ.length>0){ // 依赖
				for (var i = 0; i < param.dependServ.length; i++) {
					var servSpecId = param.dependServ[i].servSpecId;	
					var newSpec = {
						objId : servSpecId, //调用公用方法使用
						servSpecId : servSpecId,
						servSpecName : param.dependServ[i].servSpecName,
						ifParams : param.dependServ[i].ifParams,
						isdel : "C"   //加入到缓存列表没有做页面操作为C
					};
					var inPamam = {
						prodSpecId:servSpecId
					};
					if("Y"  == newSpec.ifParams){
						var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
						if(data==undefined || data.result==undefined){
							return;
						}
						newSpec.prodSpecParams = data.result.prodSpecParams;
					}
					CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
					AttachOffer.addOpenServList(prodId,servSpecId); 
				}
			}
		}*/
	};
	
	//添加到开通列表
	var _addOpenList = function(prodId,offerSpecId){
		if(!_manyPhoneFilter(prodId,offerSpecId)){
			return;
		}
		var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
		if(offer != undefined){ //在已开通中，需要取消退订
			if(offer.isdel!="Y"){
				var newSpec = _setSpec(prodId,offerSpecId);
				if(newSpec==undefined){ //没有在已开通附属销售列表中
					return;
				}
				if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){
					offer.counts++;
					newSpec.counts=offer.counts;
					if(_ifOrderAgain(newSpec)){
						offer.counts--;
						return;
					}
					if(offer.counts<=2){
						var $li=$("#li_"+prodId+"_"+offer.offerId);
						$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.setParam('+prodId+','+offerSpecId+','+1+');"></dd>');
					}
				}
			}else{
				var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
				$span.removeClass("del");
				offer.isdel = "N";
			}
			return;
		}
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		if(newSpec.isdel=="C"){ //没有在已开通附属销售列表中，但是已经加载到缓存
			if(_ifOrderAgain(newSpec)){
				return;
			}
			var $spec = $('#li_'+prodId+'_'+offerSpecId); //在已开通附属里面
			$spec.remove();
			var $li = $('<li id="li_'+prodId+'_'+offerSpecId+'"></li>');
			if(newSpec.ifDault==0){ //必须
				$li.append('<dd class="mustchoose"></dd>');	
			}else {
				$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+','+offerSpecId+')"></dd>');	
			}
			$li.append('<span>'+newSpec.offerSpecName+'</span>');
			if(newSpec.ifParams){
				if(CacheData.setParam(prodId,newSpec)){ 
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}else {
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}
			}
			if(newSpec.ifShowTime=="Y"){
				$li.append('<dd class="time" id="time_'+prodId+'_'+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+','+offerSpecId+',\''+newSpec.offerSpecName+'\');"></dd>');
			}
			if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){
				$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu2" onclick="AttachOffer.setParam('+prodId+','+offerSpecId+');"></dd>');
			}
			$("#open_ul_"+prodId).append($li);
			newSpec.isdel = "N";
		}else if((newSpec.isdel=="Y")) { 
			var $span = $("#li_"+prodId+"_"+offerSpecId).find("span");
			$span.removeClass("del");
			newSpec.isdel = "N";
		}else if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){
			newSpec.counts++;
			if(_ifOrderAgain(newSpec)){
				newSpec.counts--;
				return;
			}
//			if(newSpec.counts>=2){
//				var $spec = $('#li_'+prodId+'_'+offerSpecId); //在已开通附属里面
//				$spec.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.setParam('+prodId+','+offerSpecId+');"></dd>');
//			}
			
		}else {  //容错处理 //if((newSpec.isdel=="N")) 
			var $spec = $('#li_'+prodId+'_'+offerSpecId); //在已开通附属里面
			$spec.remove();
			var $li = $('<li id="li_'+prodId+'_'+offerSpecId+'"></li>');
			if(newSpec.ifDault==0){ //必须
				$li.append('<dd class="mustchoose"></dd>');	
			}else {
				$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+','+offerSpecId+')"></dd>');	
			}
			$li.append('<span>'+newSpec.offerSpecName+'</span>');
			if (newSpec.ifParams){
				if(CacheData.setParam(prodId,newSpec)){ 
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}else {
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}
			}
			if(newSpec.ifShowTime=="Y"){
				$li.append('<dd class="time" id="time_'+prodId+'_'+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+','+offerSpecId+',\''+newSpec.offerSpecName+'\');"></dd>');
			}
			$("#open_ul_"+prodId).append($li);
		}
		
		//获取销售品节点校验销售品下功能产品的互斥依赖
		if(newSpec!=undefined){
			$.each(newSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					if(this.objType==4 && this.selQty!=2){
						var ifParams = "N";
						if(ec.util.isArray(this.prodSpecParams)){
							ifParams = "Y";
						}
						_addOpenServList(prodId,this.objId,this.objName,ifParams);
						if(this.minQty>0){
							_minQtyFileter(prodId,this.objId);
						}
					}
				});
			});
		}
		if(ec.util.isArray(newSpec.agreementInfos)){ //合约销售品需要输入终端
			if(OrderInfo.actionFlag!=14){//非购机入口的
				totalNums=0;
//				OrderInfo.attach2Coupons.splice(0,OrderInfo.attach2Coupons.length);
//				OrderInfo.attach2Coupons=[];//清除串码组
				_removeAttach2Coupons(prodId,newSpec.offerSpecId);//清除串码组
//				AttachOffer.terminalGroups=[];//清除终端组缓存
//				$.each(newSpec.agreementInfos,function(){
//					AttachOffer.terminalGroups.push(this.terminalGroups);//兼容多个agreementInfos，一般不会有多个的。
//				});
				var objInstId = prodId+'_'+newSpec.offerSpecId;
				//一个终端对应一个ul
				var $ul = $('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');
				var $sel = $('<select id="terminalSel_'+objInstId+'"></select>');  
				var $li1 = $('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+'</span></label></li>');
				
				var $li2 = $('<li style="display:none;"><label> 可选终端规格：</label></li>'); //隐藏
				$.each(newSpec.agreementInfos,function(){
					var $option = $('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+'</option>');
					$sel.append($option);
				});
				$li2.append($sel).append('<label class="f_red">*</label>');
				
				var minNum=newSpec.agreementInfos[0].minNum;
				var maxNum=newSpec.agreementInfos[0].maxNum;
				var $li3=$('<ul></ul>');
				var isFastOffer = 0 ;
				if(ec.util.isArray(newSpec.extAttrParams)){
					$.each(newSpec.extAttrParams,function(){
						if(this.attrId == CONST.OFFER_FAST_FILL){
							isFastOffer = 1;
							return false;
						}
					});
				}
				for(var i=0;i<newSpec.agreementInfos.length;i++){
					var agreementInfo=newSpec.agreementInfos[i];
//					for(var j=0;j<agreementInfo.terminalGroups.length;j++){
//						var terminalGroupId=agreementInfo.terminalGroups[j].terminalGroupId;//终端组
//						var terminalMinNum=agreementInfo.terminalGroups[j].terminalMinNum;
//						var terminalMaxNum=agreementInfo.terminalGroups[j].terminalMaxNum;
						var $ulGroups=$('<ul id="ul_'+objInstId+'" class="fillin show"></ul>');
						var $liGroups = $('<li class="full"><label> 终端：</label></li>');
						var $selTerms = $('<select style="display:none;" id="'+objInstId+'"></select>');
						var $selTermGroups = $('<select style="display:none;" id="group_'+objInstId+'"></select>');
						if(ec.util.isArray(agreementInfo.terminalGroups)){ //如果有配置终端组，则拼接终端组的规格ID和包含的终端规格ID
							for(var j=0;j<agreementInfo.terminalGroups.length;j++){
								var $optionTermGroups=$('<option value="'+agreementInfo.terminalGroups[j].terminalGroupId+'" terminalMaxNum="'+agreementInfo.terminalGroups[j].terminalMaxNum+'" terminalMinNum="'+agreementInfo.terminalGroups[j].terminalMinNum+'">'+agreementInfo.terminalGroups[j].terminalGroupId+'</option>');
								$selTermGroups.append($optionTermGroups);
								if(ec.util.isArray(agreementInfo.terminalGroups[j].terminalGroup)){
									$.each(agreementInfo.terminalGroups[j].terminalGroup,function(){
										var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+'</option>');
										$selTerms.append($optionTerms);
									});
								}
							}
						}
						if(ec.util.isArray(agreementInfo.terminals)){ //如果是直接配置终端规格（旧数据），则拼接终端规格ID
							$.each(agreementInfo.terminals,function(){
								var $optionTerms=$('<option value="'+this.terminalModels+'" price="'+this.terminalPrice+'">'+this.terminalName+'</option>');
								$selTerms.append($optionTerms);
							});
						}
						
						$liGroups.append($selTerms).append($selTermGroups);
						if(maxNum>newSpec.agreementInfos[0].minNum){
							var $strAdd=$('<input id="terminalAddBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="0" onclick="AttachOffer.addAndDelTerminal(this)" value="添加" class="purchase" style="float:left"></input>');
							var $strDel=$('<input id="terminalDelBtn_'+objInstId+'" type="button" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" fag="1" onclick="AttachOffer.addAndDelTerminal(this)" value="删除" class="purchase" style="float:left"></input>');
							$liGroups.append($strAdd).append($strDel);
						}
						$ulGroups.append($liGroups);
//						if(minNum<=0){
//							$li3.append($ulGroups);
//							break;
//						}
//						if(minNum<terminalMinNum){
//							terminalMinNum=minNum;
//						}
						 var minNumArray=new Array();
						for(var k=1;k<=minNum;k++){
							var id="terminalText_"+objInstId+'_'+k;
							minNumArray[k-1]=id;
							var $liTerminal=$('<li style="width:700px" name="terminalCodeCheckValidLi"><form name="terminalCodeCheckValidForm"><label>终端校验：</label><input id="terminalText_'+objInstId+'_'+k+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />'
									+'<input type="checkbox" id="if_p_reserveCode" onclick="AttachOffer.changereserveCode()"><label>使用预约码：</label><input type="text" class="inputWidth228px inputMargin0" id="reserveCode" value="" disabled="disabled" maxlength="20" placeholder="请输入预约码" style="width:160px;background-color: #E8E8E8;" />'
									+'<input id="terminalBtn_'+objInstId+'_'+k+'" name="terminalCodeCheckValidBtn" type="button" num="'+k+'" flag="'+isFastOffer+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="" value="校验" class="purchase" style="float:left"></input></form></li>');
							var	$li4 = $('<li id="terminalDesc_'+k+'" style="white-space:nowrap;width:700px;"><label></label><label id="terminalName_'+k+'"></label></li>');
							$ulGroups.append($liTerminal).append($li4);
						}
						$li3.append($ulGroups);
						totalNums+=minNum;
//					}
				}
				var $div = $("#terminalDiv_"+prodId);
				$ul.append($li1).append($li2).append($li3).appendTo($div);
				//
				var terminalCode="";
				if(OrderInfo.terminalCode!=null && OrderInfo.terminalCode!="" && OrderInfo.terminalCode!="null" && OrderInfo.reloadFlag!="N"){
					var	accessNum=OrderInfo.getAccessNumber(prodId);
					if(accessNum!="" && accessNum!=null && accessNum!= undefined){
						var terminalCodeArray=OrderInfo.terminalCode.split(",");
						for(var k=0;k<terminalCodeArray.length;k++){
							if(terminalCodeArray[k].indexOf(accessNum)!=-1){
								//取终端串码minNumArray
								terminalCode=terminalCodeArray[k].split("_")[1];
								//填值
								for(var z=0;z<minNumArray.length;z++){
									if(minNumArray[z].indexOf(prodId)!=-1){
										$("#"+minNumArray[z]).val(terminalCode);
			                             break;
									}
								}
							}
						}
					}
				}
			
				$div.show();
				$li3.find("li[name=terminalCodeCheckValidLi]").find("form[name=terminalCodeCheckValidForm]").each(function() {
					var terminalCodeCheckValidBtn =$(this).find("input[name=terminalCodeCheckValidBtn]");
					var terminalCodeCheckValidBtnId= terminalCodeCheckValidBtn.attr('id');
	                $(this).off('formIsValid').on('formIsValid',function(event,form){
	                	AttachOffer.checkTerminalCode(terminalCodeCheckValidBtn);
	                }).ketchup({bindElement:terminalCodeCheckValidBtnId});  
	            });  
//				$("#if_p_reserveCode").change(function(){
//					if($("#if_p_reserveCode").attr("checked")){
//						$("#reserveCode").css("background-color","white").attr("disabled", false) ;
//					}else{
//						$("#reserveCode").css("background-color","#E8E8E8").attr("disabled", true) ;
//					}
//				});	
				if(newSpec.agreementInfos[0].minNum>0){//合约里面至少要有一个终端
					newSpec.isTerminal = 1;
				}
			}else if(OrderInfo.actionFlag==14){
					var objInstId = prodId+'_'+newSpec.offerSpecId;
					var terminalUl=$("#terminalUl_"+objInstId);//如果有就不添加串码框了，防止重复
					if(terminalUl.length>0){
						return;
					}
					//一个终端对应一个ul
					var $ul = $('<ul id="terminalUl_'+objInstId+'" class="fillin show"></ul>');
					var $sel = $('<select id="terminalSel_'+objInstId+'"></select>');  
					var $li1 = $('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+'</span></label></li>');
					var $li2 = $('<li style="display:none;"><label> 可选终端规格：</label></li>'); //隐藏
					$.each(newSpec.agreementInfos,function(){
						var $option = $('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+'</option>');
						$sel.append($option);
					});
					$li2.append($sel).append('<label class="f_red">*</label>');
					var $li3 = $('<li><label>终端校验：</label><input id="terminalText_'+objInstId+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />'
							+'<input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+','+newSpec.offerSpecId+')" value="校验" class="purchase" style="float:left"></input></li>');	
					/*var $li4 = $('<li id="terRes_'+objInstId+'" class="full" style="display: none;" >'
							+'<label style="width:auto; margin:0px 10px;">终端名称：<span id="terName_'+objInstId+'" ></span></label>'
							+'<label style="width:auto; margin:0px 10px;">终端串码：<span id="terCode_'+objInstId+'" ></span></label>'
							+'<label style="width:auto; margin:0px 10px;">终端价格：<span id="terPrice_'+objInstId+'" ></span></label></li>');*/
					var $div = $("#terminalDiv_"+prodId);
					var $li4 = $('<li id="terminalDesc" style="display:none;white-space:nowrap;"><label> 终端规格：</label><label id="terminalName"></label></li>');
					$ul.append($li1).append($li2).append($li3).append($li4).appendTo($div);
					$div.show();
					newSpec.isTerminal = 1;
					
					for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
						var coupon = OrderInfo.attach2Coupons[i];
						if(prodId==coupon.prodId){
							$("#terminalSel_"+objInstId).val(coupon.couponId);
							$("#terminalSel_"+objInstId).attr("disabled",true);
							$("#terminalText_"+objInstId).val(coupon.couponInstanceNumber);
							$("#terminalText_"+objInstId).attr("disabled",true);
							$("#terminalBtn_"+objInstId).hide();
						}
					}
				}
			//}
		}
	};
	
	var _changereserveCode = function(){
		if($("#if_p_reserveCode").attr("checked")){
			$("#reserveCode").css("background-color","white").attr("disabled", false) ;
		}else{
			$("#reserveCode").css("background-color","#E8E8E8").attr("disabled", true) ;
		}
	}
	
	//终端校验
	var _checkTerminalCode = function(obj){
		var prodId=$(obj).attr("prodId");
		var offerSpecId=$(obj).attr("offerSpecId");
//		var terminalGroupId=$(obj).attr("terminalGroupId");
		var num=$(obj).attr("num");
		var flag=$(obj).attr("flag");
		if(flag==undefined){
			flag = 0 ;
		}
		OrderInfo.termReserveFlag ="";
		//清空旧终端信息
		_filterAttach2Coupons(prodId,offerSpecId,num);

		//清空旧终端信息
//		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
//			var attach2Coupon = OrderInfo.attach2Coupons[i];
//			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId){
//				OrderInfo.attach2Coupons.splice(i,1);
//				break;
//			}
//		}
		var objInstId = prodId+"_"+offerSpecId;
//		var resId = $("#terminalSel_"+objInstId+"_"+terminalGroupId).val();
		var resIdArray = [];
		var terminalGroupIdArray = [];
		$("#"+objInstId+"  option").each(function(){
			resIdArray.push($(this).val());
		});
		$("#group_"+objInstId+"  option").each(function(){
			terminalGroupIdArray.push($(this).val());
		});
		var resId = resIdArray.join("|"); //拼接可用的资源规格id
		var terminalGroupId = terminalGroupIdArray.join("|"); //拼接可用的资源终端组id
		if((resId==undefined || $.trim(resId)=="") && (terminalGroupId==undefined || $.trim(terminalGroupId)=="")){
			$.alert("信息提示","终端规格不能为空！");
			return;
		}
		var instCode = $("#terminalText_"+objInstId + "_"+num).val();
		if(instCode==undefined || $.trim(instCode)==""){
			$.alert("信息提示","终端串码不能为空！");
			return;
		}
		if($("#if_p_reserveCode").attr("checked")){
			var reserveCode = $("#reserveCode").val();
			if(reserveCode ==""){
				$.alert("信息提示","请输入终端预约码！");
				return;
			}
		}else{
			$.each(checkedOfferSpec,function(){
				var offerSpec = this;
				var specList = CacheData.getOfferSpecList(prodId);
				$.each(specList,function(){
					if(offerSpec.offerSpecId == this.offerSpecId){
						var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
						this.isdel = "Y";
						_delServSpec(prodId,this); //取消订购销售品时
						order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
						$("#li_"+prodId+"_"+this.offerSpecId).remove();
					}
				});
			});
			checkedOfferSpec = [];
		}
		if(_checkData(objInstId,instCode)){
			return;
		}
		var newSpec = _setSpec(prodId,offerSpecId);
		var param = {
			instCode : instCode,
			flag : flag,
			mktResId : resId,
			offerSpecId: offerSpecId,
			offerSpecName:newSpec.offerSpecName
			//termGroup : terminalGroupId  update by huangjj #13336需求资源要求这个参数不传
		};
		var data = query.prod.checkTerminal(param);
		if(data==undefined){
			return;
		}
		var activtyType ="";
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C" && ec.util.isArray(spec.agreementInfos)){  //订购的附属销售品
                    if(spec.agreementInfos[0].activtyType == 2){
                    	activtyType = "2";
				    }
				}
			}
		}
		if(data.statusCd==CONST.MKTRES_STATUS.USABLE || (data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2")){
//			$("#terminalSel_"+objInstId).val(data.mktResId);
//			$("#terminalName").html(data.mktResName);
//			$("#terminalDesc").css("display","block");
//			var price = $("#terminalSel_"+objInstId).find("option:selected").attr("price");
			
			
			var mktPrice=0;//营销资源返回的单位是元
			var mktColor="";
			if(ec.util.isArray(data.mktAttrList)){
				$.each(data.mktAttrList,function(){
					if(this.attrId=="65010058"){
						mktPrice=this.attrValue;
					}else if(this.attrId=="60010004"){
						mktColor=this.attrValue;
					}
				});
			}
			$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");
			$("#terminalDesc_"+num).css("display","block");
			
			/*$("#terRes_"+objInstId).show();
			$("#terName_"+objInstId).text(data.mktResName);
			$("#terCode_"+objInstId).text(data.instCode);	
			if(price!=undefined){
				$("#terPrice_"+objInstId).text(price/100 + "元");
			}*/
			var coupon = {
				couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : data.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
				couponNum : 1, //物品数量
				storeId : data.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : mktPrice, //物品价格,约定取值为营销资源的
				couponInstanceNumber : data.instCode, //物品实例编码
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId : prodId, //产品ID
				offerId : -1, //销售品实例ID
				attachSepcId : offerSpecId,
				state : "ADD", //动作
				relaSeq : "", //关联序列	
				num	: num, //第几个串码输入框
				attrList:data.mktAttrList //终端属性列表
			};
			if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2"){//“已销售未补贴”的终端串码可以办理话补合约
				coupon.couponSource ="2"; //串码话补标识
			}
			if(CONST.getAppDesc()==0){
				coupon.termTypeFlag=data.termTypeFlag;
			}
			if($("#if_p_reserveCode").attr("checked")){
				var custId = OrderInfo.cust.custId;
				var identityTypeCd  ="";
				var identityNum ="";
				if (custId == -1) {
					identityTypeCd = OrderInfo.boCustIdentities.identidiesTypeCd;
					identityNum =OrderInfo.boCustIdentities.identityNum;
				}
				var param = {
						reserveCode : reserveCode,
						couponId : data.mktResId,
						terminalPrice : mktPrice,
						custId : custId,
						identityTypeCd : identityTypeCd,
						identityNum : identityNum
				};
				var url = contextPath+"/mktRes/terminal/queryCouponReserveCodeCheck ";
				$.callServiceAsJson(url,param,{
					"before":function(){
//						$.ecOverlay("<strong>预约码校验中,请稍等...</strong>");
					},"always":function(){
//						$.unecOverlay();
					},
					"done" : function(response){
						if (response && response.code == -2) {
							$.each(checkedOfferSpec,function(){
								var offerSpec = this;
								var specList = CacheData.getOfferSpecList(prodId);
								$.each(specList,function(){
									if(offerSpec.offerSpecId == this.offerSpecId){
										var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
										this.isdel = "Y";
										_delServSpec(prodId,this); //取消订购销售品时
										order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
										$("#li_"+prodId+"_"+this.offerSpecId).remove();
									}
								});
							});
							checkedOfferSpec = [];
							$.alertM(response.data);
							return;
						} else if(response&&response.data&&response.data.code == 0) {
							if(response.data.buyFlag!=null && response.data.buyFlag=="Y"){
								var content = "您购买的终端和预约的终端不一致，请确认是否需要购买该终端？";
								$.confirm("信息确认",content,{ 
									yes:function(){
									},
									yesdo:function(){
										if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){
											$.each(checkedOfferSpec,function(){
												var offerSpec = this;
												var specList = CacheData.getOfferSpecList(prodId);
												$.each(specList,function(){
													if(offerSpec.offerSpecId == this.offerSpecId){
														var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
														this.isdel = "Y";
														_delServSpec(prodId,this); //取消订购销售品时
														order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
														$("#li_"+prodId+"_"+this.offerSpecId).remove();
													}
												});
											});
										}
										checkedReserveNbr= response.data.couponInfo.reserveNbr;
										coupon.sourceId = checkedReserveNbr;
										OrderInfo.termReserveFlag = CONST.OL_TYPE_CD.ZDYY;
										OrderInfo.attach2Coupons.push(coupon);
										if(response.data.offerSpec.length>0){
											checkedOfferSpec = response.data.offerSpec;
											var content = '<form id="promotionForm"><table>';
											var selectStr = "";
											var optionStr = "";
											selectStr = selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>"; 
											$.each(response.data.offerSpec,function(){
												var offerSpec = this;
												optionStr +='<option value="'+this.offerSpecId+'">'+this.offerSpecName+'</option>';
											});
											selectStr += optionStr + "</select></td></tr>"; 
											content +=selectStr;
											var offerSpecId;
											$.confirm("促销包选择",content,{ 
												yes:function(){	
													
												},
												no:function(){
													
												}
											});
											$('#promotionForm').bind('formIsValid', function(event, form) {
												offerSpecId = $('#'+checkedReserveNbr+' option:selected').val();
												$(".ZebraDialog").remove();
								                $(".ZebraDialogOverlay").remove();
								                AttachOffer.selectAttachOffer(prodId,offerSpecId);
											}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
											
										}
									},
									no:function(){
									}
								});
							}else{
								if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){
									$.each(checkedOfferSpec,function(){
										var offerSpec = this;
										var specList = CacheData.getOfferSpecList(prodId);
										$.each(specList,function(){
											if(offerSpec.offerSpecId == this.offerSpecId){
												var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
												this.isdel = "Y";
												_delServSpec(prodId,this); //取消订购销售品时
												order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
												$("#li_"+prodId+"_"+this.offerSpecId).remove();
											}
										});
									});
								}
								checkedReserveNbr= response.data.couponInfo.reserveNbr;
								coupon.sourceId = checkedReserveNbr;
								OrderInfo.termReserveFlag = CONST.OL_TYPE_CD.ZDYY;
								OrderInfo.attach2Coupons.push(coupon);
								if(response.data.offerSpec.length>0){
									checkedOfferSpec = response.data.offerSpec;
									var content = '<form id="promotionForm"><table>';
									var selectStr = "";
									var optionStr = "";
									selectStr = selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>"; 
									$.each(response.data.offerSpec,function(){
										var offerSpec = this;
										optionStr +='<option value="'+this.offerSpecId+'">'+this.offerSpecName+'</option>';
									});
									selectStr += optionStr + "</select></td></tr>"; 
									content +=selectStr;
									var offerSpecId;
									$.confirm("促销包选择",content,{ 
										yes:function(){	
											
										},
										no:function(){
											
										}
									});
									$('#promotionForm').bind('formIsValid', function(event, form) {
										offerSpecId = $('#'+checkedReserveNbr+' option:selected').val();
										$(".ZebraDialog").remove();
						                $(".ZebraDialogOverlay").remove();
						                AttachOffer.selectAttachOffer(prodId,offerSpecId);
									}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
									
								}else {
									$.alert("信息提示",data.message);
								}
							}
						}else if(response && response.data && response.data.message
								&& response.data.code == 1){
							$.each(checkedOfferSpec,function(){
								var offerSpec = this;
								var specList = CacheData.getOfferSpecList(prodId);
								$.each(specList,function(){
									if(offerSpec.offerSpecId == this.offerSpecId){
										var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
										this.isdel = "Y";
										_delServSpec(prodId,this); //取消订购销售品时
										order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
										$("#li_"+prodId+"_"+this.offerSpecId).remove();
									}
								});
							});
							checkedOfferSpec = [];
							$.alert("提示", response.data.message);
							return;
						}else{
							$.each(checkedOfferSpec,function(){
								var offerSpec = this;
								var specList = CacheData.getOfferSpecList(prodId);
								$.each(specList,function(){
									if(offerSpec.offerSpecId == this.offerSpecId){
										var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
										this.isdel = "Y";
										_delServSpec(prodId,this); //取消订购销售品时
										order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
										$("#li_"+prodId+"_"+this.offerSpecId).remove();
									}
								});
							});
							checkedOfferSpec = [];
							$.alert("提示","<br/>终端预约码校验失败，请稍后重试！");
							return;
						}
					}
				});
			}else{
				$.alert("信息提示",data.message);
				OrderInfo.attach2Coupons.push(coupon);
			}
		}else if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){
			$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用");
		}else{
			$.alert("提示",data.message);
		}
	};
	
	//添加可选包到缓存列表
	var _setSpec = function(prodId,offerSpecId){
		var newSpec = CacheData.getOfferSpec(prodId,offerSpecId);  //没有在已选列表里面
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			newSpec = query.offer.queryAttachOfferSpec(prodId,offerSpecId); //重新获取销售品构成
			if(!newSpec){
				return;
			}
			CacheData.setOfferSpec(prodId,newSpec);
		}
		return newSpec;
	};
	
	//添加到开通列表
	var _addOpenServList = function(prodId,servSpecId,servSpecName,ifParams){
		//从已开通功能产品中找
		var serv = CacheData.getServBySpecId(prodId,servSpecId); 
		if(serv != undefined){
			$("#li_"+prodId+"_"+serv.servId).find("span").removeClass("del");
			serv.isdel = "N";
			return;
		}
		//从已选择功能产品中找
		var spec = CacheData.getServSpec(prodId,servSpecId);
//		if(OrderInfo.actionFlag==22){
//			spec = undefined;
//		}
		if(spec == undefined){
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : servSpecName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			spec = newSpec;
		} 
		if(spec.isdel == "C"){  //没有订购过
			$('#li_'+prodId+'_'+servSpecId).remove(); //删除可开通功能产品里面
			var $li = $('<li id="li_'+prodId+'_'+servSpecId+'"></li>');
			if(spec.ifDault==0){ //必须
				$li.append('<dd class="mustchoose"></dd>');	
			}else {
				$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+','+servSpecId+',\''+servSpecName+'\',\''+ifParams+'\')"></dd>');
			}
			$li.append('<span>'+spec.servSpecName+'</span>');
			if (spec.ifParams=="Y"){
				if(CacheData.setServParam(prodId,spec)){ 
					$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
				}else {
					$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
				}
			}
			$("#open_serv_ul_"+prodId).append($li);
		}else {
			$("#li_"+prodId+"_"+servSpecId).find("span").removeClass("del");
		}
		spec.isdel = "N";
		_showHideUim(0,prodId,servSpecId);//显示或者隐藏补换卡
	};
	
	//现在主销售品参数
	var _showMainParam = function(){
		var content = CacheData.getParamContent(-1,OrderInfo.offerSpec,0);
		$.confirm("参数设置： ",content,{ 
			yes:function(){	
				
			},
			no:function(){
				
			}
		});
		$('#paramForm').bind('formIsValid', function(event, form) {
		}).ketchup({bindElement:"easyDialogYesBtn"});
	};
	
	//显示参数
	var _showParam = function(prodId,offerSpecId,flag){	
		if(flag==1){ //显示已订购附属		
			var offer = CacheData.getOfferBySpecId(prodId,offerSpecId);
			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offer.offerId	
				};
				param.acctNbr = OrderInfo.getAccessNumber(prodId);
				var data = query.offer.queryOfferInst(param);
				if(data==undefined){
					return;
				}
				offer.offerMemberInfos = data.offerMemberInfos;
				offer.offerSpec = data.offerSpec;
			}
			if(!offer.isGetParam){  //已订购附属没有参数，需要获取销售品参数
				var param = {   
				    offerTypeCd : "2",
				    offerId: offer.offerId,
				    offerSpecId : offer.offerSpecId
				};
				var offerParam = query.offer.queryOfferParam(param); //重新获取销售品参数
				if(offerParam==undefined){
					return;
				}else{
					offer.offerParamInfos = offerParam.offerParamInfos;
					offer.isGetParam = true;
				}
			}
			var content = CacheData.getParamContent(prodId,offer,flag);
			$.confirm("参数设置： ",content,{ 
				yes:function(){		
				},
				no:function(){
				}
			});
			order.protocolnbr.init();
			$('#paramForm').bind('formIsValid', function(event, form) {
				//参数输入校验
				if(!paramInputCheck()){
					return;
				}
				var isset = false;
				$.each(offer.offerSpec.offerSpecParams,function(){
					var itemInfo = CacheData.getOfferParam(prodId,offer.offerId,this.itemSpecId);
					if(itemInfo.itemSpecId == CONST.ITEM_SPEC.PROT_NUMBER){
						itemInfo.setValue = $("#select1").val();
					}else{
					    itemInfo.setValue = $("#"+prodId+"_"+this.itemSpecId).val();
					}
					if(itemInfo.value!=itemInfo.setValue){
						itemInfo.isUpdate = "Y";
						isset = true;
					}
				});
				if(isset){
					$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu").addClass("canshu2");
					offer.isset = "Y";
					offer.update = "Y";
				}else{
					$("#can_"+prodId+"_"+offer.offerId).removeClass("canshu2").addClass("canshu");
					offer.isset = "N";
					offer.update = "N";
				}
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});		
		}else {
			var spec = CacheData.getOfferSpec(prodId,offerSpecId);
			if(spec == undefined){  //未开通的附属销售品，需要获取销售品构成
				spec = query.offer.queryAttachOfferSpec(prodId,offerSpecId); //重新获取销售品构成
				if(!spec){
					return;
				}
			}
			var content = CacheData.getParamContent(prodId,spec,flag);	
			$.confirm("参数设置： ",content,{ 
				yes:function(){
				},
				no:function(){
				}
			});
			order.protocolnbr.init();
			$('#paramForm').bind('formIsValid', function(event, form){
				//参数输入校验
				if(!paramInputCheck()){
					return;
				}
				if(!!spec.offerSpecParams){
					for (var i = 0; i < spec.offerSpecParams.length; i++) {
						var param = spec.offerSpecParams[i];
						var itemSpec = CacheData.getSpecParam(prodId,offerSpecId,param.itemSpecId);
						if(itemSpec.itemSpecId == CONST.ITEM_SPEC.PROT_NUMBER){
							itemSpec.setValue = $("#select1").val();
						}else{
							itemSpec.setValue = $("#"+prodId+"_"+param.itemSpecId).val();
						}
					}
				}
				if(spec.offerRoles!=undefined && spec.offerRoles.length>0){
					for (var i = 0; i < spec.offerRoles.length; i++) {
						var offerRole = spec.offerRoles[i];
						for (var j = 0; j < offerRole.roleObjs.length; j++) {
							var roleObj = offerRole.roleObjs[j];
							if(!!roleObj.prodSpecParams){
								for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
									var prodParam = roleObj.prodSpecParams[k];
									var prodItem = CacheData.getProdSpecParam(prodId,offerSpecId,prodParam.itemSpecId);
									prodItem.value = $("#"+prodId+"_"+prodParam.itemSpecId).val();
								}
							}
						}
					}
				}
				$("#can_"+prodId+"_"+offerSpecId).removeClass("canshu").addClass("canshu2");
				var attchSpec = CacheData.getOfferSpec(prodId,offerSpecId);
				attchSpec.isset = "Y";
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});	
		}
	};
	
	//显示服务参数
	var _showServParam = function(prodId,servSpecId,flag){
		if(flag==1){ //显示已订购附属
			var serv = CacheData.getServBySpecId(prodId,servSpecId);
			var param = {
				prodId : serv.servId,
				ifServItem:"Y"
			};
			if(!serv.isGetParamSpec){  //已订购附属没有参数，需要获取销售品参数	
				param.prodSpecId = serv.servSpecId;
				var dataSepc = query.prod.prodSpecParamQuery(param); //重新获取销售品参数
				if(dataSepc==undefined){
					return;
				}else{
					serv.prodSpecParams = dataSepc.result.prodSpecParams;
					serv.isGetParamSpec = true;
				}
			}
			if(!serv.isGetParamInst){  //已订购附属没有参数，需要获取销售品参数
				var data = query.prod.prodInstParamQuery(param); //重新获取销售品参数
				if(data==undefined){
					return;
				}else{
					serv.prodInstParams = data.result.prodInstParams;
					serv.isGetParamInst = true;
				}
			}
			var content = CacheData.getParamContent(prodId,serv,3);
			
			if(OrderInfo.isGroupProSpecId(serv.servSpecId)){//群功能产品
				ec.form.dialog.createDialog({
					"id":"-group",
					"width":"370",
					"height":"440",
					"initCallBack":function(dialogForm,dialog){
						AttachOffer.dialogForm=dialogForm;
						AttachOffer.dialog=dialog;
						$("#div_group").empty();
						$("#div_group").append(content);
						$("#div_group_btn").empty();
						var str='<a href="javascript:void(0)" id="ok_btn" class="btn_h30"><span>确认</span></a>'
						+'<a href="javascript:void(0);" id="cancel_btn" class="btn_h30" style="margin-left:20px;"><span>取消</span></a>';
						$("#div_group_btn").append(str);
						//绑定确定按钮click事件
						$("#ok_btn").off("click").on("click",function(event){
							_groupInistOkBtn(prodId,servSpecId);
						});
						$("#cancel_btn").off("click").on("click",function(event){
							_closeDialog();
						});
					},
					"submitCallBack":function(dialogForm,dialog){
						
					},
					"closeCallBack":function(dialogForm,dialog){
					}
				});
				return;
			}
			
			$.confirm("参数设置： ",content,{ 
				yes:function(){	
					
				},
				no:function(){
					
				}
			});
			$('#paramForm').bind('formIsValid', function(event, form) {
				var isset = false;
				$.each(serv.prodSpecParams,function(){
					var prodItem = CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);
					prodItem.setValue = $("#"+prodId+"_"+this.itemSpecId).val();	
					if(prodItem.value!=prodItem.setValue){
						prodItem.isUpdate = "Y";
						isset = true;
					}
				});
				if(isset){
					$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");
					serv.isset = "Y";
					serv.update = "Y";
				}else{
					$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");
					serv.isset = "N";
					serv.update = "N";
				}
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
		
		}else {
			var spec = CacheData.getServSpec(prodId,servSpecId);
			if(spec == undefined){  //未开通的附属销售品，需要获取销售品构成
				return;
			}
			var content = CacheData.getParamContent(prodId,spec,2);	
			
			if(OrderInfo.isGroupProSpecId(spec.servSpecId)){//群功能产品
				ec.form.dialog.createDialog({
					"id":"-group",
					"width":"370",
					"height":"440",
					"initCallBack":function(dialogForm,dialog){
						AttachOffer.dialogForm=dialogForm;
						AttachOffer.dialog=dialog;
						$("#div_group").empty();
						$("#div_group").append(content);
						$("#div_group_btn").empty();
						var str='<a href="javascript:void(0)" id="ok_btn" class="btn_h30"><span>确认</span></a>'
						+'<a href="javascript:void(0);" id="cancel_btn" class="btn_h30" style="margin-left:20px;"><span>取消</span></a>';
						$("#div_group_btn").append(str);
						//绑定确定按钮click事件
						$("#ok_btn").off("click").on("click",function(event){
							_groupOkBtn(prodId,servSpecId);
						});
						$("#cancel_btn").off("click").on("click",function(event){
							_closeDialog();
						});
					},
					"submitCallBack":function(dialogForm,dialog){
						
					},
					"closeCallBack":function(dialogForm,dialog){
					}
				});
				return;
			}
			
			$.confirm("参数设置： ",content,{ 
				yes:function(){
				},
				no:function(){	
				}
			});
			$('#paramForm').bind('formIsValid', function(event, form){
				if(!!spec.prodSpecParams){
					for (var i = 0; i < spec.prodSpecParams.length; i++) {
						var param = spec.prodSpecParams[i];
						var itemSpec = CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);
						itemSpec.setValue = $("#"+prodId+"_"+param.itemSpecId).val();
					}
				}
				$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");
				var attchSpec = CacheData.getServSpec(prodId,servSpecId);
				attchSpec.isset = "Y";
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
		}
	};
	
	//已选群功能产品确定按钮
	var _groupOkBtn=function(prodId,servSpecId){
		var spec = CacheData.getServSpec(prodId,servSpecId);
		var flag=true;
		if(!!spec.prodSpecParams){
			for (var i = 0; i < spec.prodSpecParams.length; i++) {
				var param = spec.prodSpecParams[i];
				var itemSpec = CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);
				itemSpec.setValue = $("#"+prodId+"_"+param.itemSpecId).val();
				if(!ec.util.isObj(itemSpec.setValue)){
					$.alert("信息提示",param.name+"不能为空");
					flag=false;
					break;
				}
			}
		}
		if(flag){
			$("#can_"+prodId+"_"+servSpecId).removeClass("canshu").addClass("canshu2");
			var attchSpec = CacheData.getServSpec(prodId,servSpecId);
			attchSpec.isset = "Y";
			easyDialog.close();
//			_closeDialog();
		}
	};
	
	//已订购群功能产品确定按钮
	var _groupInistOkBtn=function(prodId,servSpecId){
		var serv = CacheData.getServBySpecId(prodId,servSpecId);
		var isset = false;
		$.each(serv.prodSpecParams,function(){
			var prodItem = CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);
			prodItem.setValue = $("#"+prodId+"_"+this.itemSpecId).val();	
			if(prodItem.value!=prodItem.setValue){
				prodItem.isUpdate = "Y";
				isset = true;
			}
		});
			if(isset){
				$("#can_"+prodId+"_"+serv.servId).removeClass("canshu").addClass("canshu2");
				serv.isset = "Y";
				serv.update = "Y";
			}else{
				$("#can_"+prodId+"_"+serv.servId).removeClass("canshu2").addClass("canshu");
				serv.isset = "N";
				serv.update = "N";
			}
			_closeDialog();
	};
	
	var _closeDialog = function() {
		if(AttachOffer.dialogForm!=undefined&&AttachOffer.dialog!=undefined){
			AttachOffer.dialogForm.close(AttachOffer.dialog);
		}
	};
	
	//（销售品）参数输入校验（服务参数暂未使用）
	var paramInputCheck = function(){
		var pass = true;
		$("#paramForm").find("input[type=text]").each(function(){
			var mask = $(this).attr("mask");
			var maskmsg = $(this).attr("maskmsg");
			if(mask!=null && mask!="" && mask.substring(0,1)=="/" && mask.substring(mask.length-1,mask.length)=="/"){
				if(!eval(mask).test($(this).val())){
					$.alert("提示",maskmsg);
					pass = false;
					return false;
				}
			}
		});
		return pass;
	};
	
	//销售品生失效时间显示
	var _showTime = function(prodId,offerSpecId,offerSpecName){	
		var data = OrderInfo.getPrivilege("EFF_TIME");		
		$('#attachName').text(offerSpecName+"--生失效设置");
		var spec = CacheData.getOfferSpec(prodId,offerSpecId);
		_initTime(spec);
		easyDialog.open({
			container : "div_time_dialog"
		});
		$("#timeSpan").off("click").on("click",function(){
			_setAttachTime(prodId,offerSpecId);
		});
		if(data==0){
			$("#startTimeTr").show();
			$("#endTimeTr").show();
		}else{
			$("#startTimeTr").hide();
			$("#endTimeTr").hide();
		}
	};
	
	//销售品生效时间显示
	var _showStartTime = function(){	
		var strDate =DateUtil.Format("yyyy年MM月dd日",new Date());
		var endDate = $("#endDt").val();
		if(endDate ==""){
			$.calendar({minDate:strDate});
		}else{
			$.calendar({minDate:strDate,maxDate:endDate});
		}
	};
	
	//销售品失效时间显示
	var _showEndTime = function(){	
		var strDate = $("#startDt").val();
		if(strDate==""){
			strDate =DateUtil.Format("yyyy年MM月dd日",new Date());
		}
		$.calendar({minDate:strDate});
	};
	
	//初始化时间设置页面
	var _initTime = function(spec){
		if(spec!=undefined && spec.ooTimes!=undefined){
			var ooTime = spec.ooTimes;
			$("input[name=startTimeType][value='"+ooTime.startType+"']").attr("checked","checked");
			$("input[name=endTimeType][value='"+ooTime.endType+"']").attr("checked","checked");
			$("#startDt").val("");
			$("#endDt").val("");
			$("#endTime").val("");
			if(ooTime.startType == 4){ //指定生效时间
				$("#startDt").val(ooTime.startDt);
			}
			if(ooTime.endType == 4){ //指定失效时间
				$("#endDt").val(ooTime.endDt);
			}else if(ooTime.endType == 5){  //有效时长
				$("#endTime").val(ooTime.effTime);
				$("#endTimeUnit").val(ooTime.effTimeUnitCd);
			}
		}else {
			$("input[name=startTimeType][value=1]").attr("checked","checked");
			$("input[name=endTimeType][value=1]").attr("checked","checked");
			$("#startDt").val("");
			$("#endDt").val("");
			$("#endTime").val("");
		}
	};
	
	//显示主套餐时间
	var _showOfferTime = function(){
		var data = OrderInfo.getPrivilege("EFF_TIME");		
		$('#attachName').text(OrderInfo.offerSpec.offerSpecName+"-生失效设置");
		_initTime(OrderInfo.offerSpec);
		easyDialog.open({
			container : "div_time_dialog"
		});
		$("#timeSpan").off("click").on("click",function(){
			_setMainTime();
		});
		if(data==0){
			$("#startTimeTr").show();
			$("#endTimeTr").show();
		}else{
			$("#startTimeTr").hide();
			$("#endTimeTr").hide();
		}
	};
	
	//显示主套餐构成
	var _showMainMember = function(){
		$('#memberName').text(OrderInfo.offerSpec.offerSpecName+"-构成");
		$("#main_member_div").empty();
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if(this.memberRoleCd == CONST.MEMBER_ROLE_CD.CONTENT){
				var $ul = $('</div><ul id="serv_ul_'+prodId+'"></ul>');
				var $div = $('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');
				$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));
				$.each(offerRole.roleObjs,function(){
					var $li = $('<li id="li_'+prodId+'_'+this.objId+'">'+this.objName+'</li>');
					var $checkbox = $('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');
					$ul.append($checkbox).append($li);
				});
				$("#main_member_div").append('<div class="clear"></div>');
			}else{
				$.each(offerRole.prodInsts,function(){
					var prodId = this.prodInstId;
					var $ul = $('</div><ul id="serv_ul_'+prodId+'"></ul>');
					var $div = $('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');
					$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));
					$.each(offerRole.roleObjs,function(){
						if(this.objType == CONST.OBJ_TYPE.SERV){
							var $li = $('<li id="li_'+prodId+'_'+this.objId+'">'+this.objName+'</li>');
							var $checkbox = $('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');
							$ul.append($checkbox).append($li);		
						}
					});
					$("#main_member_div").append('<div class="clear"></div>');
				});
			}
		});
		easyDialog.open({
			container : "div_member_dialog"
		});
		
		$.each(OrderInfo.offerSpec.offerRoles,function(){  //自动勾选功能产品
			var offerRole = this;
			$.each(offerRole.prodInsts,function(){ //自动勾选接入产品已经选择的功能产品
				var prodInst = this;
				$.each(offerRole.roleObjs,function(){ //根据规格配置勾选默认的功能产品
					var servSpecId = this.objId;
					if(this.minQty>0){ //必选
						$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){
							if(servSpecId==$(this).attr("servSpecId")){
								$(this).attr("checked","checked");
								$(this).attr("disabled","disabled");
							}
						});
					}
				});
				if(!!prodInst.servInsts){  
					$.each(prodInst.servInsts,function(){  //遍历产品实例下已经选择的功能产品
						var servSpecId = this.objId;
						$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){
							if(servSpecId==$(this).attr("servSpecId")){
								$(this).attr("checked","checked");
							}
						});
					});
				}
			});
		});
		
		$("#memberSpan").off("click").on("click",function(){
			_setMainMember();
		});
	};
	
	//保存主销售品成员
	var _setMainMember = function(){
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			$.each(this.prodInsts,function(){
				var prodInst = this;
				prodInst.servInsts = [];
				$("input[name='serv_check_"+this.prodInstId+"']:checked").each(function(){
					var servSpecId = $(this).attr("servSpecId");
					$.each(offerRole.roleObjs,function(){
						if(this.objId==servSpecId){  //获取选择功能产品的构成
							prodInst.servInsts.push(this);	
						}
					});
				});
			});
		});
		easyDialog.close();
	};
	
	//获取ooTime节点
	var _getTime = function(){
		var ooTime = {
			state : "ADD" 
		};
		//封装生效时间
		var startRadio = $("input[name=startTimeType]:checked").attr("value");
		ooTime.startType = startRadio;
		if(startRadio==1){
			ooTime.isDefaultStart = "Y";
		}else if(startRadio==2){  //竣工生效，不传值
			
		}else if(startRadio==3){  //次月生效
			ooTime.startTime = 1;
			ooTime.startTimeUnitCd = 7;
			//ooTime.startDt = _getNextMonthFirstDate();
		}else if(startRadio==4){ //指定生效时间
			if($("#startDt").val()==""){
				$.alert("提示","指定生效时间不能为空!");
				return;
			}
			ooTime.startDt = $("#startDt").val();
		}
		//封装失效时间
		var endRadio = $("input[name=endTimeType]:checked").attr("value");	
		ooTime.endType = endRadio;
		if(endRadio==1){
			ooTime.isDefaultEnd = "Y";
		}else if(endRadio==4){
			if($("#endDt").val()==""){
				$.alert("提示","指定失效时间不能为空!");
				return;
			}
			ooTime.endDt = $("#endDt").val();
		}else if(endRadio==5){
			var end = $("#endTime").val();
			if(end==""){
				$.alert("提示","有效时长不能为空!");
				return;
			}
			if(isNaN(end)){
				$.alert("提示","有效时长必须为数字!");
				return;
			} 
			if(end<=0){
				$.alert("提示","有效时长必须大于0!");
				return;
			} 
			ooTime.effTime = end;
			ooTime.effTimeUnitCd = $("#endTimeUnit").val();
		}
		return ooTime;
	};
	
	//设置主销售品生失效时间设置
	var _setMainTime = function(){
		var ooTime = _getTime();
		if(ooTime==undefined){
			return;
		}
		OrderInfo.offerSpec.ooTimes = ooTime;
		$("#mainTime").removeClass("time").addClass("time2");
		easyDialog.close();
	};
	
	//设置附属销售品生失效时间设置
	var _setAttachTime = function(prodId,offerSpecId){
		var ooTime = _getTime();
		if(ooTime==undefined){
			return;
		}
		var spec = CacheData.getOfferSpec(prodId,offerSpecId);
		spec.ooTimes = ooTime;
		$("#time_"+prodId+"_"+offerSpecId).removeClass("time").addClass("time2");
		easyDialog.close();
	};
	
	//获取下个月第一天
	/*var _getNextMonthFirstDate = function(){
		var d = new Date();
		var yyyy = 1900+d.getYear();    
		var MM = d.getMonth()+1;      
		var dd = "01";   
		if(MM==12){
			yyyy++;
			MM = "01";	
		}else if(MM<9){
			MM++;
			MM = "0"+MM;
		}else {
			MM++;
		}
		return yyyy+"-"+MM+"-"+dd; 
	};*/
	
	//切换标签
	var _changeLabel = function(prodId,prodSpecId,labelId){
		$.each(AttachOffer.labelList,function(){ //附属标签显示隐藏
			if(this.prodId==prodId){
				$.each(this.labels,function(){
					if(labelId==""){
						labelId = this.label;
						$("#tab_"+prodId+"_"+this.label).addClass("setcon");
					}else{
						if(labelId == this.label){
							$("#tab_"+prodId+"_"+this.label).addClass("setcon");
							$("#ul_"+prodId+"_"+this.label).show();
						}else{
							$("#tab_"+prodId+"_"+this.label).removeClass("setcon");
							$("#ul_"+prodId+"_"+this.label).hide();
						}
					}
				});
			}
		});
		var $ul = $("#ul_"+prodId+"_"+labelId); //创建ul
		if($ul[0]==undefined){ //没有加载过，重新加载  
			var queryType = "3";
			if(prodId>0){
				queryType = "";
			}
			if(labelId==CONST.LABEL.SERV){  //功能产品
				var param = {
					prodId : prodId,
					prodSpecId : prodSpecId,
					queryType : queryType,
					labelId : labelId
				};
				var data = query.offer.queryServSpec(param);
				var $ul = $('<ul id="ul_'+prodId+'_'+labelId+'"></ul>');
				if(data!=undefined && data.resultCode == "0"){
					if(ec.util.isArray(data.result.servSpec)){
						var servList = CacheData.getServList(prodId);//过滤已订购
						var servSpecList = CacheData.getServSpecList(prodId);//过滤已选择
						$.each(data.result.servSpec,function(){
							AttachOffer.allOfferList.push(this);
							var servSpecId = this.servSpecId;
							var flag = true;
							$.each(servList,function(){
								if(this.servSpecId==servSpecId&&this.isDel!="C"){
									flag = false;
									return false;
								}
							});
							$.each(servSpecList,function(){
								if(this.servSpecId==servSpecId){
									flag = false;
									return false;
								}
							});
							if(flag){
								var $li = $('<li id="li_'+prodId+'_'+this.servSpecId+'"></li>');
								var $dd = $('<dd class="canchoose" onclick="AttachOffer.openServSpec('+prodId+','+this.servSpecId+',\''+this.servSpecName+'\',\''+this.ifParams+'\')"></dd>');
								var $span = $('<span><a href="javascript:AttachOffer.openServSpec('+prodId+','+this.servSpecId+',\''+this.servSpecName+'\',\''+this.ifParams+'\')">'+this.servSpecName+'</a></span>');
								var $dd2 = $('<dd class="canshu2" onclick="AttachOffer.offerSpecDetail('+prodId+','+this.servSpecId+')"><img src="'+contextPath+'/image/common/more.png"/></dd>');
								$li.append($dd).append($span).append($dd2).appendTo($ul);
							}
						});
					}
				}
				$("#div_"+prodId).append($ul);
			}else{
				var param = {
					prodSpecId : prodSpecId,
					offerSpecIds : [],
					queryType : queryType,
					prodId : prodId,
					partyId : OrderInfo.cust.custId,
					labelId : labelId,
					ifCommonUse : ""			
				};
				if(OrderInfo.actionFlag == 2){ //套餐变更		
					param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);
					var prodInst = OrderInfo.getProdInst(prodId);
					if(prodInst){
						param.offerRoleId = prodInst.offerRoleId;
					}
					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
						if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
							param.acctNbr = OrderInfo.oldprodInstInfos[i].accNbr;
							$.each(OrderInfo.oldofferSpec,function(){
								if(this.accNbr==OrderInfo.oldprodInstInfos[i].accNbr){
									param.offerSpecIds.push(this.offerSpec.offerSpecId);	
									$.each(this.offerSpec.offerRoles,function(){
										if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD || this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){
											param.offerRoleId = this.offerRoleId;
										}
									});
								}
							});
						}
					}
					$.each(OrderInfo.offerSpec.offerRoles,function(){
						if(ec.util.isArray(this.prodInsts)){
							$.each(this.prodInsts,function(){
								if(this.prodInstId==prodId){
									param.acctNbr = this.accessNumber;
									param.offerRoleId = this.offerRoleId;
									param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);	
									return false;
								}
							});
						}
					});
				}else if(OrderInfo.actionFlag == 3 || OrderInfo.actionFlag == 22){  //可选包
					var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
					param.acctNbr = prodInfo.accNbr;
					if(!ec.util.isObj(prodInfo.prodOfferId)){
						prodInfo.prodOfferId = "";
					}
					var offerRoleId = CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;
					if(offerRoleId==undefined){
						offerRoleId = "";
					}
					param.offerRoleId = offerRoleId;
					param.offerSpecIds.push(prodInfo.prodOfferId);
				}else if(OrderInfo.actionFlag == 21){ //副卡套餐变更		
					$.each(OrderInfo.viceOfferSpec,function(){
						var offerSpecId=this.offerSpecId;
						var accessNumber=this.accessnumber;
						if(this.prodId==prodId){
							$.each(this.offerRoles,function(){
								if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD || this.memberRoleCd=="1"){
									$.each(this.roleObjs,function(){
										if(this.objType==CONST.OBJ_TYPE.PROD){
											param.acctNbr = accessNumber;
											param.offerRoleId = this.offerRoleId;
											param.offerSpecIds.push(offerSpecId);	
											return false;
										}
									});
								}
							});
						}
					});
				}else if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){
					var oldoffer = {};
					for(var j=0;j<OrderInfo.oldoffer.length;j++){
						oldoffer = OrderInfo.oldoffer[j];
						for ( var i = 0; i < OrderInfo.oldoffer[j].offerMemberInfos.length; i++) {
							var offerMember = OrderInfo.oldoffer[j].offerMemberInfos[i];
							if(offerMember.objInstId==prodId){
								param.acctNbr = offerMember.accessNumber;
								$.each(OrderInfo.oldofferSpec,function(){
									if(this.accNbr==oldoffer.accNbr){
										param.offerSpecIds.push(this.offerSpec.offerSpecId);	
										$.each(this.offerSpec.offerRoles,function(){
											if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD || this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){
												param.offerRoleId = this.offerRoleId;
												return false;
											}
										});
									}
								});
							}
						}
					}
				}else { //新装
					param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);
					var prodInst = OrderInfo.getProdInst(prodId);
					if(prodInst){
						param.offerRoleId = prodInst.offerRoleId;
					}
				}
				query.offer.queryCanBuyAttachSpec(param,function(data){
					var $ul = $('<ul id="ul_'+prodId+'_'+labelId+'"></ul>');
					if(data!=undefined && data.resultCode == "0"){
						if(ec.util.isArray(data.result.offerSpecList)){
							var offerList = CacheData.getOfferList(prodId); //过滤已订购
							var offerSpecList = CacheData.getOfferSpecList(prodId);//过滤已选择
							$.each(data.result.offerSpecList,function(){
								AttachOffer.allOfferList.push(this);
								var offerSpecId = this.offerSpecId;
								var flag = true;
								var ifOrderAgain=this.ifOrderAgain;//是否可以重复订购
								$.each(offerList,function(){
									if(this.offerSpecId==offerSpecId&&this.isDel!="C"&&ifOrderAgain!="Y"){
										flag = false;
										return false;
									}
								});
								$.each(offerSpecList,function(){
									if(this.offerSpecId==offerSpecId&&ifOrderAgain!="Y"){
										flag = false;
										return false;
									}
								});
								if(flag){
									var $li = $('<li id="li_'+prodId+'_'+this.offerSpecId+'"></li>');
									if(ec.util.isObj(ifOrderAgain)&&ifOrderAgain=="Y"){
										$li = $('<li id="li_'+prodId+'_'+this.offerSpecId+'_'+ifOrderAgain+'"></li>');
									}
									var $dd = $('<dd class="canchoose" onclick="AttachOffer.addOfferSpec('+prodId+','+this.offerSpecId+')"></dd>');
									var $span = $('<span><a href="javascript:AttachOffer.addOfferSpec('+prodId+','+this.offerSpecId+')" >'+this.offerSpecName+'</a></span>');
									var $dd2 = $('<dd class="canshu2" onclick="AttachOffer.offerSpecDetail('+prodId+','+this.offerSpecId+')"><img src="'+contextPath+'/image/common/more.png"/></dd>');
									$li.append($dd).append($span).append($dd2).appendTo($ul);
								}
							});
						}
					}
					$("#div_"+prodId).append($ul);
				});
			}
		}
	};
	
	//开通跟取消开通功能产品时判断是否显示跟隐藏补换卡
	var _showHideUim = function(flag,prodId,servSpecId){
		if(CONST.getAppDesc()==0 && servSpecId == CONST.PROD_SPEC.PROD_FUN_4G){ //4G系统并且是开通或者关闭4g功能产品
			var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
			if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){//套餐变更
				prodClass = CacheData.getOfferMember(prodId).prodClass;
				if(prodClass==undefined && offerChange.oldMemberFlag){
					$.each(OrderInfo.oldoffer,function(){
						$.each(this.offerMemberInfos,function(){
							if(this.objInstId==prodId){
								prodClass = this.prodClass;
								return false;
							}
						});
					});
				}
			}else if(OrderInfo.actionFlag==6){
				for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
					if(prodId == OrderInfo.oldprodInstInfos[i].prodInstId){
						prodClass = OrderInfo.oldprodInstInfos[i].prodClass;
					}
				}
				$.each(OrderInfo.viceOfferSpec,function(){
					if(this.prodId==prodId){
						prodClass = CacheData.getOfferMember(prodId).prodClass;
					}
				});
			}
			
			if(flag==0){ //开通功能产品
				if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡需要补卡
					$("#title_"+prodId).show();
					$("#uimDiv_"+prodId).show();
					
					var actionFalg=OrderInfo.actionFlag;
					var instCode=OrderInfo.provinceInfo.mktResInstCode;
					var codeMsg=OrderInfo.provinceInfo.codeMsg;
					if(actionFalg=="3"  && order.uiCust.packageInfo.reloadFlag=="Y"){
						if(codeMsg!=null && codeMsg!=""){
							$.alert("提示",codeMsg);
						}else{
							if(instCode!=null && instCode!=""){
								$("#uim_txt_"+prodId).val(instCode);//将UIM卡信息放入
								$("#uim_check_btn_"+prodId).hide();
								$("#uim_release_btn_"+prodId).hide();
								$("#uim_txt_"+prodId).attr("disabled",true);
								
								var uimParam = {
									"instCode":instCode
								};
								
								var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
								
								if (response.code==0) {
									if(response.data.mktResBaseInfo){
										var statusCd=response.data.mktResBaseInfo.statusCd;
										if(statusCd=="1102"){
											var offerId="";
											if(OrderInfo.actionFlag==6){
												offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
												$.each(OrderInfo.oldprodInstInfos,function(){
													if(this.prodInstId==prodId){
														offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
													}
												});
											}else{
												offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
											}
											
											_packageCouponInfo(prodId,offerId,response,instCode);
										}else{
											$.alert("提示","UIM卡["+instCode+"]不是预占状态，当前为"+statusCd);
										}
									}else{
										$.alert("提示","查询不到UIM卡["+instCode+"]信息");
									}
								}else if (response.code==-2){
									$.alertM(response.data);
								}else {
									$.alert("提示","UIM信息查询接口出错,稍后重试");
								}
							}
						}
					}
					
					if((order.memberChange.mktResInstCode!="" && order.memberChange.reloadFlag=="Y")||(OrderInfo.mktResInstCode!="" && OrderInfo.reloadFlag=="Y")){
						var nbrlist = [];
						var nbrflag = true;
						var offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
						$.each(OrderInfo.oldprodInstInfos,function(){
							if(this.prodInstId==prodId){
								offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
							}
						});
						var mktResInstCodesize = "";
						if(OrderInfo.actionFlag==2){
							mktResInstCodesize = OrderInfo.mktResInstCode.split(",");
						}else if(OrderInfo.actionFlag==6){
							mktResInstCodesize = order.memberChange.mktResInstCode.split(",");
						}
						for(var u=0;u<mktResInstCodesize.length;u++){
							if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null" && order.memberChange.oldSubPhoneNum!=""){
								var nbrAndUimCode = mktResInstCodesize[u].split("_");
								var _accNbr = nbrAndUimCode[0];
								var _uimCode = nbrAndUimCode[1];
								var oldSubPhoneNumsize = order.memberChange.oldSubPhoneNum.split(",");
								var uimflag = false;
								$.each(nbrlist,function(){
									if(this==_accNbr){
										nbrflag = false;
										return false;
									}else{
										nbrflag = true;
									}
								});
								if(!nbrflag){
									$.alert("提示","UIM卡"+_uimCode+"对应的号码重复");
									return;
								}
								for(var n=0;n<oldSubPhoneNumsize.length;n++){
									if(oldSubPhoneNumsize[n]==_accNbr){
										nbrlist.push(oldSubPhoneNumsize[n]);
										uimflag = true;
										$.each(OrderInfo.oldoffer,function(){
											$.each(this.offerMemberInfos,function(){
												if(this.accessNumber==_accNbr){
													$("#uim_txt_"+this.objInstId).attr("disabled",true);
													var uimParam = {
															"instCode":_uimCode
													};
													var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
													if (response.code==0) {
														if(response.data.mktResBaseInfo){
															if(response.data.mktResBaseInfo.statusCd=="1102"){
																$("#uim_check_btn_"+this.objInstId).attr("disabled",true);
																$("#uim_check_btn_"+this.objInstId).removeClass("purchase").addClass("disablepurchase");
																$("#uim_release_btn_"+this.objInstId).attr("disabled",false);
																$("#uim_release_btn_"+this.objInstId).removeClass("disablepurchase").addClass("purchase");
																$("#uim_txt_"+this.objInstId).val(_uimCode);
																var coupon = {
																		couponUsageTypeCd : "3", //物品使用类型
																		inOutTypeId : "1",  //出入库类型
																		inOutReasonId : 0, //出入库原因
																		saleId : 1, //销售类型
																		couponId : response.data.mktResBaseInfo.mktResId, //物品ID
																		couponinfoStatusCd : "A", //物品处理状态
																		chargeItemCd : "3000", //物品费用项类型
																		couponNum : response.data.mktResBaseInfo.qty, //物品数量
																		storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
																		storeName : "1", //仓库名称
																		agentId : 1, //供应商ID
																		apCharge : 0, //物品价格
																		couponInstanceNumber : _uimCode, //物品实例编码
																		terminalCode :_uimCode,//前台内部使用的UIM卡号
																		ruleId : "", //物品规则ID
																		partyId : OrderInfo.cust.custId, //客户ID
																		prodId :  this.objInstId, //产品ID
																		offerId : offerId, //销售品实例ID
																		state : "ADD", //动作
																		relaSeq : "" //关联序列	
																	};
																OrderInfo.clearProdUim(this.objInstId);
																OrderInfo.boProd2Tds.push(coupon);
															}else{
																$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
															}
														}else{
															$.alert("提示","查询不到UIM信息");
														}
													}else if (response.code==-2){
														$.alertM(response.data);
													}else {
														$.alert("提示","UIM信息查询接口出错,稍后重试");
													}
												}
											});
										})
									}
								}
								if(!uimflag){
									$.alert("提示","UIM卡"+_uimCode+"未匹配到接入号");
								}
							}
						}
					}
				}
			}else if(flag==1){//取消开通功能产品
				if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡，已经显示补卡,判断是否隐藏补卡
					$("#uimDiv_"+prodId).hide();
				}
			}
		}
	};
	
	/**组装UIM数据信息*/
	var _packageCouponInfo=function(prodId,offerId,response,instCode){
		var coupon = {
				couponUsageTypeCd : "3", //物品使用类型
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : response.data.mktResBaseInfo.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : "3000", //物品费用项类型
				couponNum : 1, //物品数量
				storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : 0, //物品价格
				couponInstanceNumber :instCode, //物品实例编码
				terminalCode : instCode,//前台内部使用的UIM卡号
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId :  prodId, //产品ID
				offerId : offerId, //销售品实例ID
				state : "ADD", //动作
				relaSeq : "" //关联序列	
		};
		
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
	}
	
	//判断是否需要补卡
	var _isChangeUim = function(objId){
		if(CONST.getAppDesc()==0){
			var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
			var prodId = order.prodModify.choosedProdInfo.prodInstId;
			if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){//套餐变更
				var member = CacheData.getOfferMember(objId);
				if(member.objInstId==undefined && offerChange.oldMemberFlag){
					$.each(OrderInfo.oldoffer,function(){
						$.each(this.offerMemberInfos,function(){
							if(this.objInstId==objId){
								member = this;
								return false;
							}
						});
					});
				}
				prodClass = member.prodClass;
				prodId = member.objInstId;
			}else if(OrderInfo.actionFlag==6){
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.prodInstId==objId){
						prodClass = this.prodClass;
						prodId = this.prodInstId;
					}
				});
				$.each(OrderInfo.viceOfferSpec,function(){
					if(this.prodId==prodId){
						var member = CacheData.getOfferMember(objId);
						prodClass = member.prodClass;
						prodId = member.objInstId;
					}
				});
			}
			if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡，已经显示补卡,判断是否隐藏补卡
				var servSpec = CacheData.getServSpec(prodId,CONST.PROD_SPEC.PROD_FUN_4G);
				if(servSpec!=undefined && servSpec.isdel != "Y" && servSpec.isdel != "C"){ //有开通4G功能产品
					return true;
				}
			}
		}
		return false;
	};
	
	//获取附属销售品节点
	var _setAttachBusiOrder = function(busiOrders){
		//遍历已选功能产品列表
		$.each(AttachOffer.openServList,function(){
			var prodId = this.prodId;
			$.each(this.servSpecList,function(){
				if(this.isdel != "Y" && this.isdel != "C"){  //订购的功能产品  && _getRelaType(this.servSpecId)!="1000"
					SoOrder.createServ(this,prodId,0,busiOrders);
				}
			});
		});
		//遍历已订购功能产品列表
		$.each(AttachOffer.openedServList,function(){
			var prodId = this.prodId;
			$.each(this.servList,function(){
				if(this.isdel == "Y"){  //关闭功能产品
					SoOrder.createServ(this,prodId,1,busiOrders);
				}else {
					if(this.update=="Y"){  //变更功能产品
						SoOrder.createServ(this,prodId,2,busiOrders);
					}
				}
			});
		});
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C"){  //订购的附属销售品
					if(ec.util.isObj(spec.counts)){//组装重复订购的可选包
						for(var k=0;k<spec.counts;k++){
							SoOrder.createAttOffer(spec,open.prodId,0,busiOrders);
						}
					}else{
						SoOrder.createAttOffer(spec,open.prodId,0,busiOrders);
					}
				}
			}
		}
		//遍历已订购附属销售品列表
		for ( var i = 0; i < AttachOffer.openedList.length; i++) {
			var opened = AttachOffer.openedList[i];
			for ( var j = 0; j < opened.offerList.length; j++) {  //遍历当前产品下面的附属销售品
				var offer = opened.offerList[j];
				if(offer.isdel == "Y"){  //退订的附属销售品
					if(ec.util.isObj(offer.counts)){//组装重复订购的可选包
						for(var k=0;k<offer.orderCount;k++){
							offer.offerId=offer.offerIds[k];
							SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders);
						}
					}else{
						SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders);
					}
				}else if(offer.update=="Y"){//修改附属销售品
					SoOrder.createAttOffer(offer,opened.prodId,2,busiOrders);
				}else if(ec.util.isObj(offer.orderCount)&&ec.util.isObj(offer.counts)){
					if(offer.orderCount>offer.counts){//退订附属销售品
						for(var k=0;k<(offer.orderCount-offer.counts);k++){
							offer.offerId=offer.offerIds[k];
							SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders);
						}
					}else if(offer.orderCount<offer.counts){//订购附属销售品
						var spec = CacheData.getOfferSpec(opened.prodId,offer.offerSpecId);
						for(var k=0;k<(offer.counts-offer.orderCount);k++){
							SoOrder.createAttOffer(spec,opened.prodId,0,busiOrders);
						}
					}
					
				}
			}
		}
		
		//遍历已选增值业务
		$.each(AttachOffer.openAppList,function(){
			var prodId = this.prodId;
			$.each(this.appList,function(){
				if(this.dfQty==1){  //开通增值业务
					SoOrder.createServ(this,prodId,0,busiOrders);
				}
			});
		});
	};
	//把对比省预校验的后有变动的 功能产品和可选包 放入临时缓存列表中
	var _setChangeList=function(prodId){
		AttachOffer.changeList=[];//清空
		var prodInfos = offerChange.resultOffer.prodInfos;//预校验返回的功能产品
		if(ec.util.isArray(prodInfos)){
			$.each(prodInfos,function(){
//				var prodId = this.accProdInstId;
				//容错处理，省份接入产品实例id传错
//				var flag = true;
//				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
//					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
//						flag = false;
//						return false;
//					}
//				});
				if(prodId!=this.accProdInstId){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var param={
						prodInstId:prodId
					};
					var serv = CacheData.getServ(prodId,this.prodInstId);//在已开通的功能产品里面查找
					var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
					if(this.state=="DEL"){
						if(serv!=undefined && serv.isdel != "Y"){
							param.objId=this.prodInstId;
							param.status=(serv.isdel!=undefined?serv.isdel:"N");
							param.objIdType=1;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							serv.isdel = "Y";
							AttachOffer.changeList.push(param);
						}else if(servSpec!=undefined && servSpec.isdel !="Y" && servSpec.isdel !="C"){
							param.objId=this.productId;
							param.status=servSpec.isdel;
							param.objIdType=2;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							servSpec.isdel = "Y";
							AttachOffer.changeList.push(param);
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined && serv.isdel == "Y"){  //在已开通里面，修改不让关闭
							param.objId=this.prodInstId;
							param.status=serv.isdel;
							param.objIdType=1;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							serv.isdel = "N";
							AttachOffer.changeList.push(param);
						}else if(servSpec != undefined && servSpec.isdel =="Y"){
							param.objId=this.productId;
							param.status=servSpec.isdel;
							param.objIdType=2;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							servSpec.isdel = "N";
							AttachOffer.changeList.push(param);
						}else if(serv==undefined && servSpec==undefined){
							param.objId=this.productId;
							param.status="Y";
							param.objIdType=2;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							AttachOffer.changeList.push(param);
							if(this.productId!=undefined && this.productId!=""){
//								AttachOffer.openServSpec(prodId,this.productId);
								var newSerSpec = {
										objId : this.productId,
										servSpecId : this.productId,
										servSpecName : this.productName,
										ifParams : "N",
										isdel : "N"  
									};
								CacheData.setServSpec(prodId,newSerSpec); //添加到已开通列表里
								var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
								servSpec.isdel="N";
							}
						}
					}
				}
			});
		}
		var offers = offerChange.resultOffer.prodOfferInfos;//省预校验返回的可选包
		if(ec.util.isArray(offers)){
			$.each(offers,function(){
				if(this.memberInfo==undefined){
					return true;
				}
				var flag = true;
				$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
					if(ec.util.isObj(this.accProdInstId)&&prodId == this.accProdInstId){
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				var param={
						prodInstId:prodId
					};
				var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已开通里面查找
				var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已选里面查找
				if(this.state=="DEL"){
					if(offer!=undefined && offer.isdel != "Y"){
						param.objId=this.prodOfferInstId;
						param.status=(offer.isdel!=undefined?offer.isdel:"N");
						param.objIdType=3;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offer.isdel = "Y";
						AttachOffer.changeList.push(param);
					}else if(offerSpec!=undefined && offerSpec.isdel !="Y" && offerSpec.isdel !="C"){
						param.objId=this.prodOfferId;
						param.status=offerSpec.isdel;
						param.objIdType=4;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offerSpec.isdel = "Y";
						AttachOffer.changeList.push(param);
					}	
				}else if(this.state=="ADD"){
					if(offer!=undefined && offer.isdel == "Y"){  //在已开通里面，修改不让关闭
						param.objId=this.prodOfferInstId;
						param.status=offer.isdel;
						param.objIdType=3;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offer.isdel = "N";
						AttachOffer.changeList.push(param);
					}else if(offerSpec != undefined && offerSpec.isdel =="Y"){
						param.objId=this.prodOfferId;
						param.status=offerSpec.isdel;
						param.objIdType=4;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offerSpec.isdel = "N";
						AttachOffer.changeList.push(param);
					}else if(offer==undefined && offerSpec==undefined){
						param.objId=this.prodOfferId;
						param.status="Y";
						param.objIdType=4;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						AttachOffer.changeList.push(param);
						if(ec.util.isObj(this.prodOfferId) && this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){
//							AttachOffer.addOfferSpecByCheck(prodId,this.prodOfferId);
							var newOfferSpec=_setSpec(prodId,this.prodOfferId);
							newOfferSpec.isdel="N";
						}
					}
				}
			});
		}
	};
	//还原预校验前的缓存信息
	var _reductionChangList=function(prodId){
		$.each(AttachOffer.changeList,function(){
			if(this.prodInstId==prodId){
				if(this.objIdType==1){
					var serv = CacheData.getServ(prodId,this.objId);//在已开通的功能产品里面查找
					if(serv!=undefined){
						serv.isdel=this.status;
					}
				}else if(this.objIdType==2){
					var servSpec = CacheData.getServSpec(prodId,this.objId);//在已选的功能产品里面查找
					if(servSpec!=undefined){
						servSpec.isdel=this.status;
					}
				}else if(this.objIdType==3){
					var offer = CacheData.getOffer(prodId,this.objId); //已开通里面查找
					if(offer!=undefined){
						offer.isdel=this.status;
					}
				}else if(this.objIdType==4){
					var offerSpec = CacheData.getOfferSpec(prodId,this.objId); //已选里面查找
					if(offerSpec!=undefined){
						offerSpec.isdel=this.status;
					}
				}
			}
		});
	};
	//查询销售品对象的互斥依赖连带的关系
	var _servExDepReByRoleObjs=function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		paramObj.excludeServ=[];//初始化
		paramObj.dependServ=[];//初始化
		paramObj.relatedServ=[];//初始化
		var globContent="";
		$.each(newSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objType==4 && this.selQty==1){
						var servSpec = CacheData.getServSpec(prodId,this.objId); //在已选列表中查找
						if(servSpec==undefined){   //在可订购功能产品里面 
							var serv = CacheData.getServBySpecId(prodId,this.objId); //在已开通列表中查找
							if(serv==undefined){
								var newServSpec = {
										objId : this.objId, //调用公用方法使用
										servSpecId : this.objId,
										servSpecName : this.objName,
										ifParams : this.isCompParam,
										prodSpecParams : this.prodSpecParams,
										isdel : "C"   //加入到缓存列表没有做页面操作为C
								};
								CacheData.setServSpec(prodId,newServSpec); //添加到已开通列表里
								servSpec = newServSpec;
							}else{
								servSpec=serv;
							}
						}
						var servSpecId = servSpec.servSpecId;
						var param = CacheData.getExcDepServParam(prodId,servSpecId);
						if(param.orderedServSpecIds.length == 0){
//							AttachOffer.addOpenServList(prodId,servSpecId,servSpec.servSpecName,servSpec.ifParams);
						}else{
							var data=query.offer.queryExcludeDepend(param);//查询规则校验
							var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);
							if(content!=""){
								content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);
								globContent+=(content+"<br>");
							}
						}
				}
			});
		});
		return globContent;
	};
	
	//转换接口返回的互斥依赖
	var paramObj = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
	};
	//解析服务互斥依赖
	var paserServDataByObjs = function(result,prodId,serv,newSpec){
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + this.servSpecName + "<br>";
					paramObj.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				if(!AttachOffer.filterServ(this.servSpecId,newSpec)){
					content += "需要开通：   " + this.servSpecName + "<br>";
					paramObj.dependServ.push(this);
				}
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				if(!AttachOffer.filterServ(this.servSpecId,newSpec)){
					content += "需要开通：   " + this.servSpecName + "<br>";
					paramObj.relatedServ.push(this);
				}
			});
		}
		return content;
	};
	
	//去重，把互斥依赖里面的信息进行去重处理
	var _filterServ=function(servSpecId,newSpec){
		var flag=false;
		$.each(newSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objType==4 && this.selQty==1){
					if(servSpecId==this.objId){
						flag=true;
						return false;
					}
				}
			});
		});
		if(!flag){
			if(ec.util.isArray(paramObj.dependServ)){
				for(var i=0;i<paramObj.dependServ.length;i++){
					if(servSpecId==paramObj.dependServ[i].servSpecId){
						flag=true;
						break;
					}
				}
			}
			if(!flag){
				if(ec.util.isArray(paramObj.relatedServ)){
					for(var i=0;i<paramObj.relatedServ.length;i++){
						if(servSpecId==paramObj.relatedServ[i].servSpecId){
							flag=true;
							break;
						}
					}
				}
			}
		}
		return flag;
	};
	
	//销售品角色成员对象是中 minQty大于0的话 就必须设置其为不能删除（暂定）
	var _minQtyFileter=function(prodId,servSpecId){
		//从已开通功能产品中找
		var serv = CacheData.getServBySpecId(prodId,servSpecId); 
		var $li;
		if(serv != undefined){
			$li=$("#li_"+prodId+"_"+serv.servId);
		}else{
			$li=$("#li_"+prodId+"_"+servSpecId);
		}
		if($li!=undefined){
			$li.find(".delete").remove();
			$li.append('<dd class="mustchoose"></dd>');	
		}
	};
	
	/**
	 * 判断 该合约是否满足被订购的条件：主套餐成员实例数据小于最小终端数，需要进行提示，不允许受理
	 */
	var _manyPhoneFilter=function(prodId,offerSpecId){
			if(OrderInfo.actionFlag==14){
				return true;
			}
			var newSpec;
			var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
			if(ec.util.isObj(offer)){
				newSpec=offer;
			}else{
				newSpec = _setSpec(prodId,offerSpecId);
			}
			if(newSpec==undefined){
				return false;
			}
			if(ec.util.isArray(newSpec.agreementInfos)){
				var num=0;
				if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag == 6){
					$.each(OrderInfo.offerSpec.offerRoles,function(){
					$.each(this.prodInsts,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD){
							num++;
						}
						});
					});
				}else if(OrderInfo.actionFlag == 2 || OrderInfo.actionFlag == 3){
					$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
						if(this.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
							num++;
						}
					});
				}else if(OrderInfo.actionFlag == 21){
					$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
						if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==prodId){  //接入类产品
							num++;
						}
					});
				}
				
				var minNum=newSpec.agreementInfos[0].minNum;
				var maxNum=newSpec.agreementInfos[0].maxNum;
				if(!ec.util.isObj(minNum)){
					$.alert("信息提示","销售品规格查询，未返回最小合约数，请后台确认。");
					return false;
				}
				if(num<minNum){
					$.alert("信息提示","该合约的最小合约数为"+minNum+"个，而该套餐的成员实例只有"+num+"个，故无法办理该合约。");
					return false;
				}
				if(maxNum>num){
					newSpec.agreementInfos[0].maxNum=num;//取最小的一个为最大终端数
				}
//				var terminalMinNum=0;
//				var terminalMaxNum=0;
//				$.each(newSpec.agreementInfos,function(){
//					$.each(this.terminalGroups,function(){
//						terminalMinNum+=this.terminalMinNum;
//						terminalMaxNum+=this.terminalMaxNum;
//					});
//				});
//				if(minNum>terminalMaxNum){
//					$.alert("信息提示","该合约的终端配置有问题，最小合约数大于组内最大值之和，请配置组核查。");
//					return false;
//				}
//				if(maxNum<terminalMinNum){
//					$.alert("信息提示","该合约的终端配置有问题，最大合约数小于组内最小值之和，请配置组核查。");
//					return false;
//				}
			}
		return true;
	};
	
	//添加终端
	var _addAndDelTerminal=function(obj){
		var prodId=$(obj).attr("prodId");
		var offerSpecId=$(obj).attr("offerSpecId");
		var fag=$(obj).attr("fag");
		var newSpec;
		var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
		if(ec.util.isObj(offer)){
			newSpec=offer;
		}else{
			newSpec = _setSpec(prodId,offerSpecId);
		}
		var objInstId = prodId+'_'+newSpec.offerSpecId;
//		var terminalMaxNum=0;
//		var terminalMinNum=0;
//		$.each(newSpec.agreementInfos,function(){
//			$.each(this.terminalGroups,function(){
//				if(this.terminalGroupId==terminalGroupId){
//					terminalMaxNum=this.terminalMaxNum;
//					terminalMinNum=this.terminalMinNum;
//					return false;
//				}
//			});
//		});
		var maxNum=newSpec.agreementInfos[0].maxNum;
		var minNum=newSpec.agreementInfos[0].minNum;
//		$("li[id=^terminalDesc_"+terminalGroupId+"]");
//		var $ul=$(obj).parent().parent();ul_"'+objInstId+'
		var $ul=$("#ul_"+objInstId);
		var $li=$("#ul_"+objInstId+" li");
		var length=$li.length-1;
//		var $liPre=$("li[id=^terminalDesc_"+terminalGroupId+"]")
//		var length=$("li[id=^terminalDesc_"+terminalGroupId+"]").length;
		var isFastOffer = 0 ;
		if(ec.util.isArray(newSpec.extAttrParams)){
			$.each(newSpec.extAttrParams,function(){
				if(this.attrId == CONST.OFFER_FAST_FILL){
					isFastOffer = 1;
					return false;
				}
			});
		}
		if(fag==0){//添加终端
			if(totalNums>=maxNum){
				$.alert("信息提示","终端数已经达到最大，不能再添加了。");
				return;
			}
//			if(terminalMaxNum==(length/2)){
//				$.alert("信息提示","终端数已经达到最大，不能再添加了。");
//				return;
//			}
			var $liTerminalAdd=$('<li style="width:700px;"><label>终端校验：</label><input id="terminalText_'+objInstId+'_'+(length/2+1)+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />'
					+'<input id="terminalBtn_'+objInstId+'_'+(length/2+1)+'" type="button" flag="'+isFastOffer+'" num="'+(length/2+1)+'" prodId="'+prodId+'" offerSpecId="'+newSpec.offerSpecId+'" onclick="AttachOffer.checkTerminalCode(this)" value="校验" class="purchase" style="float:left"></input></li>');
			var $liAdd = $('<li id="terminalDesc_'+(length/2+1)+'" style="white-space:nowrap;width:700px;"><label></label><label id="terminalName_'+(length/2+1)+'"></label></li>');
			
			$ul.append($liTerminalAdd).append($liAdd);
			totalNums++;
		}else{//删除终端
			if(minNum==(length/2)){
				$.alert("信息提示","终端数已经达到最小，不能再删除了。");
				return;
			}
			$li.each(function(index){
				if(length-1==index){
					$(this).remove();
				}else if(length==index){
					_filterAttach2Coupons(prodId,offerSpecId,(index/2));
					$(this).remove();
				}
				
			});
			totalNums--;
		}
	};
	
	//判断同一个终端组里面是否串码有重复的
	var _checkData=function(objInstId,terminalCode){
		var $input=$("input[id^=terminalText_"+objInstId+"]");
		var num=0;
		$input.each(function(){//遍历页面上面的串码输入框，为的是跟缓存里面的串码进行比对
			var instCode=$.trim(this.value);//页面上面的串码
			if(ec.util.isObj(instCode)&&terminalCode==instCode){
				num++;
			}
		});
		if(num>=2){
			$.alert("信息提示","终端串码重复了，请填写不同的串码。");
			return true ; 
		}
		return false;
	};
	
	//过滤 同一个串码输入框校验多次，如果之前有校验通过先清空
	var _filterAttach2Coupons=function(prodId,offerSpecId,num){
		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
			var attach2Coupon = OrderInfo.attach2Coupons[i];
			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId&&attach2Coupon.num==num){
				OrderInfo.attach2Coupons.splice(i,1);
				$("#terminalName_"+num).html("");
				break;
			}
		}
	};
	
	//清空同一个产品下的同一个销售品的串码缓存信息
	var _removeAttach2Coupons=function(prodId,offerSpecId){
		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
			var attach2Coupon = OrderInfo.attach2Coupons[i];
			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId){
				OrderInfo.attach2Coupons.splice(i,1);
				i--;
			}
		}
	};
	
	//判断是否是重复订购的逻辑
	var _ifOrderAgain=function(newSpec){
		if(ec.util.isObj(newSpec.ifOrderAgain)&&newSpec.ifOrderAgain=="Y"){
			if(parseInt(newSpec.orderCount)<newSpec.counts){
//				var $specAgain = $('#li_'+prodId+'_'+offerSpecId+'_'+newSpec.ifOrderAgain); //在已开通附属里面
//				$specAgain.remove();
				$.alert("信息提示","可选包："+newSpec.offerSpecName+"至多只能订购"+newSpec.orderCount+"次");
				return true;
			}
		}
	};
	
	//1表示从已订购那边过来的
	var _setParam=function(prodId,offerSpecId,flag){
		var newSpec = _setSpec(prodId,offerSpecId);  //没有在已选列表里面
		var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
		if(flag==1){
			newSpec.counts=offer.counts;
		}
		var content = '<form id="paramForm">' ;
		content += "次数" + ' : <input id="text_'+prodId+'_'+offerSpecId  
		+'" class="inputWidth183px" type="text" value="'+newSpec.counts+'"><br>'; 
		content +='</form>' ;
		$.confirm("参数设置： ",content,{ 
			yes:function(){
			},
			no:function(){
			}
		});
		$('#paramForm').bind('formIsValid', function(event, form) {
			var nums=$("#text_"+prodId+"_"+offerSpecId).val();
			var reg = /^\+?[1-9][0-9]*$/;//正整数
			if(!reg.test(nums)){
				$.alert("信息提示","次数只能是正整数。");
				return;
			}
//			if(flag==1&&offer.orderCount>nums){
//				$.alert("信息提示","可选包【"+newSpec.offerSpecName+"】不允许退订！");
//				return;
//			}
			if(parseInt(newSpec.orderCount)<nums){
				$.alert("信息提示","可选包【"+newSpec.offerSpecName+"】至多只能订购"+newSpec.orderCount+"次");
				return;
			}
			if(flag==1 && offer!=undefined){
				if(offer.orderCount>nums){//退订附属销售品
					if(!ec.util.isArray(offer.offerMemberInfos)){//销售品实例查询	
						var param = {
								prodId:prodId,
								areaId: OrderInfo.getProdAreaId(prodId),
								offerId:offer.offerId	
						};
						param.acctNbr = OrderInfo.getAccessNumber(prodId);
						var data = query.offer.queryOfferInst(param);
						if(data==undefined){
							return;
						}
						offer.offerMemberInfos = data.offerMemberInfos;
						offer.offerSpec = data.offerSpec;
					}
				}
				offer.counts=nums;
			}else{
				newSpec.counts=nums;
			}
			$(".ZebraDialog").remove();
			$(".ZebraDialogOverlay").remove();
		}).ketchup({bindElementByClass:"ZebraDialog_Button1"});	
	};
	
	var _offerSpecDetail=function(prodId,offerSpecId){
		var offerSpecName ="";
		var summary = "";
		$.each(AttachOffer.allOfferList,function(){
			if(this.offerSpecId == offerSpecId){
				offerSpecName = this.offerSpecName;
				summary = this.summary;
			}else if(this.servSpecId == offerSpecId){
				offerSpecName = this.servSpecName;
				summary = this.summary;
			}
		});
		$('#detail_tbody').empty();
		var $tr = $('<tr></tr>');
		//var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"><td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td></tr>');
		$tr.append('<td>'+offerSpecName+'</td><td width="900">'+summary+'</td>');
		$('#detail_tbody').append($tr);
		easyDialog.open({
			container : "div_detail_dialog"
		});
	};
	//已订购的附属销售品查询
	var _queryCardAttachOffer = function(cardTypeFlag) {
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		var prodId = prodInfo.prodInstId;
		var param = {
		    prodId : prodId,
		    prodSpecId : prodInfo.productId,
		    offerSpecId : prodInfo.prodOfferId,
		    acctNbr : prodInfo.accNbr
		};
		if(ec.util.isObj(prodInfo.prodBigClass)){
			param.prodBigClass = prodInfo.prodBigClass;
		}
		var data = query.offer.queryAttachOfferHtml(param);
	//	SoOrder.initFillPage();
		$("#attach").html(data).show();
		//var member = CacheData.getOfferMember(prodId);
		//如果objId，objType，objType不为空才可以查询默认必须
		//if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){
            var temp = {   
				boActionTypeCd : '14',
				cardType : cardTypeFlag=="1"?"4G":"3G",
				accNbr: prodInfo.accNbr,
				prodInstId : prodId,
				prodId : prodId,
				prodSpecId : prodInfo.productId
			};
			//默认必须可选包和功能产品
			var data = query.offer.queryDefMustOfferSpecAndServ(temp);
			CacheData.parseOffer(data);
			CacheData.parseServ(data);
		//}
		if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){ //主套餐下的成员判断
			var member = CacheData.getOfferMember(prodId);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(this.offerRoleId==member.offerRoleId && member.objType==CONST.OBJ_TYPE.PROD){
					var offerRole = this;
					$.each(this.roleObjs,function(){
						if(this.objType==CONST.OBJ_TYPE.SERV){
							var serv = CacheData.getServBySpecId(prodId,this.objId);//从已订购功能产品中找
							if(serv!=undefined){ //不在已经开跟已经选里面
								var $oldLi = $('#li_'+prodId+'_'+serv.servId);
								if(this.minQty==1){
									$oldLi.append('<dd class="mustchoose"></dd>');
								}
								$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
							}
						}
					});
					return false;
				}
			});
		}
		//AttachOffer.changeLabel(prodId, prodInfo.productId,""); //初始化第一个标签附属
		//order.dealer.initDealer();
	};
	
	//新装二次加载部分
	//删除附属销售品规格
	var _delOfferSpecReload = function(prodId,offerSpecId){
		var $span = $("#li_"+prodId+"_"+offerSpecId).find("span"); //定位删除的附属
		if($span.attr("class")=="del"){  //已经取消订购，再订购
			AttachOffer.addOfferSpec(prodId,offerSpecId);
		}else { //取消订购
			var spec = CacheData.getOfferSpec(prodId,offerSpecId);
			var content = CacheData.getOfferProdStr(prodId,spec,2);
			$span.addClass("del");
			spec.isdel = "Y";
			delServSpec(prodId,spec); //取消订购销售品时
			order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
			$("#terminalUl_"+prodId+"_"+offerSpecId).remove();
			spec.isTerminal = 0;
		}
	};
	//关闭服务规格
	var _closeServSpecReload = function(prodId,servSpecId,specName,ifParams){
		var $span = $("#li_"+prodId+"_"+servSpecId).find("span"); //定位删除的附属
		if($span.attr("class")=="del"){  //已经退订，再订购
			AttachOffer.openServSpecReload(prodId,servSpecId,specName,ifParams);
		}else { //退订
			var spec = CacheData.getServSpec(prodId,servSpecId);
			if(spec == undefined){ //没有在已开通附属销售列表中
				return;
			}
			$span.addClass("del");
			spec.isdel = "Y";
			_showHideUim(1,prodId,servSpecId);   //显示或者隐藏			
			var serv = CacheData.getServBySpecId(prodId,servSpecId);
			if(ec.util.isObj(serv)){ //没有在已开通附属销售列表中
				$span.addClass("del");
				serv.isdel = "Y";
				//_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
			}
		}
	};
	//订购附属销售品
	var _addOfferSpecReload = function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		CacheData.setServ2OfferSpec(prodId,newSpec);
		_checkOfferExcludeDepend(prodId,newSpec);
	};
	//开通功能产品
	var _openServSpecReload = function(prodId,servSpecId,specName,ifParams){
		var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
		if(servSpec==undefined){   //在可订购功能产品里面 
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : specName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			if(servSpecId==CONST.YZFservSpecId){//翼支付助手根据付费类型改变默认值
				var feeType = $("select[name='pay_type_-1']").val();
				if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
				if(feeType == CONST.PAY_TYPE.AFTER_PAY){
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {
						var prodSpecParam = newSpec.prodSpecParams[j];
						prodSpecParam.setValue = "";
					}																			
				}else{
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {							
						var prodSpecParam = newSpec.prodSpecParams[j];
						if (prodSpecParam.value!="") {
							prodSpecParam.setValue = prodSpecParam.value;
						} else if (!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!="")
							//默认值为空则取第一个
							prodSpecParam.setValue = prodSpecParam.valueRange[0].value;
				}
			  }
			}
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			servSpec = newSpec;
		}
		_checkServExcludeDepend(prodId,servSpec);
	};
	//终端校验
	var _checkTerminalCodeReload = function(obj){
		var prodId=$(obj).attr("prodId");
		var offerSpecId=$(obj).attr("offerSpecId");
//		var terminalGroupId=$(obj).attr("terminalGroupId");
		var num=$(obj).attr("num");
		var flag=$(obj).attr("flag");
		if(flag==undefined){
			flag = 0 ;
		}
		
		//清空旧终端信息
		_filterAttach2Coupons(prodId,offerSpecId,num);
		
		//清空旧终端信息
//		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
//			var attach2Coupon = OrderInfo.attach2Coupons[i];
//			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId){
//				OrderInfo.attach2Coupons.splice(i,1);
//				break;
//			}
//		}
		var objInstId = prodId+"_"+offerSpecId;
//		var resId = $("#terminalSel_"+objInstId+"_"+terminalGroupId).val();
		var resIdArray = [];
		var terminalGroupIdArray = [];
		$("#"+objInstId+"  option").each(function(){
			resIdArray.push($(this).val());
		});
		$("#group_"+objInstId+"  option").each(function(){
			terminalGroupIdArray.push($(this).val());
		});
		var resId = resIdArray.join("|"); //拼接可用的资源规格id
		var terminalGroupId = terminalGroupIdArray.join("|"); //拼接可用的资源终端组id
		if((resId==undefined || $.trim(resId)=="") && (terminalGroupId==undefined || $.trim(terminalGroupId)=="")){
			$.alert("信息提示","终端规格不能为空！");
			return;
		}
		var instCode = $("#terminalText_"+objInstId + "_"+num).val();
		if(instCode==undefined || $.trim(instCode)==""){
			$.alert("信息提示","终端串码不能为空！");
			return;
		}
		if(_checkData(objInstId,instCode)){
			return;
		}
		var param = {
			instCode : instCode,
			flag : flag,
			mktResId : resId,
			termGroup : terminalGroupId
		};
		var data = query.prod.checkTerminal(param);
		if(data==undefined){
			return;
		}
		var activtyType ="";
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C" && ec.util.isArray(spec.agreementInfos)){  //订购的附属销售品
                    if(spec.agreementInfos[0].activtyType == 2){
                    	activtyType = "2";
				    }
				}
			}
		}
		if(data.statusCd==CONST.MKTRES_STATUS.USABLE || (data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2")){
			//$.alert("信息提示",data.message);
//			$("#terminalSel_"+objInstId).val(data.mktResId);
//			$("#terminalName").html(data.mktResName);
//			$("#terminalDesc").css("display","block");
//			var price = $("#terminalSel_"+objInstId).find("option:selected").attr("price");
			
			
			var mktPrice=0;//营销资源返回的单位是元
			var mktColor="";
			if(ec.util.isArray(data.mktAttrList)){
				$.each(data.mktAttrList,function(){
					if(this.attrId=="65010058"){
						mktPrice=this.attrValue;
					}else if(this.attrId=="60010004"){
						mktColor=this.attrValue;
					}
				});
			}
			$("#terminalName_"+num).html("终端规格："+data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");
			$("#terminalDesc_"+num).css("display","block");
			
			/*$("#terRes_"+objInstId).show();
			$("#terName_"+objInstId).text(data.mktResName);
			$("#terCode_"+objInstId).text(data.instCode);	
			if(price!=undefined){
				$("#terPrice_"+objInstId).text(price/100 + "元");
			}*/
			var coupon = {
				couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : data.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
				couponNum : 1, //物品数量
				storeId : data.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : mktPrice, //物品价格,约定取值为营销资源的
				couponInstanceNumber : data.instCode, //物品实例编码
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId : prodId, //产品ID
				offerId : -1, //销售品实例ID
				attachSepcId : offerSpecId,
				state : "ADD", //动作
				relaSeq : "", //关联序列	
				num	: num //第几个串码输入框
			};
			if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2"){//“已销售未补贴”的终端串码可以办理话补合约
				coupon.couponSource ="2"; //串码话补标识
			}
			if(CONST.getAppDesc()==0){
				coupon.termTypeFlag=data.termTypeFlag;
			}
			OrderInfo.attach2Coupons.push(coupon);
		}else if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){
			$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用");
		}else{
			$.alert("提示",data.message);
		}
	};
	
	//删除附属销售品带出删除功能产品
	var _delServSpec = function(prodId,offerSpec){
		$.each(offerSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				var servSpecId = this.objId;
				if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){
					var spec = CacheData.getServSpec(prodId,servSpecId);
					if(ec.util.isObj(spec)){
						spec.isdel = "Y";
						var $li = $("#li_"+prodId+"_"+servSpecId);
						$li.removeClass("canshu").addClass("canshu2");
						$li.find("span").addClass("del"); //定位删除的附属
						_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					}
				}
			});
		});
	};
	
	return {
		excludeAddServ:excludeAddServ,
		addOffer 				: _addOffer,
		addOfferSpec 			: _addOfferSpec,
		addOpenList				: _addOpenList,
		addOpenServList			: _addOpenServList,
		addOfferSpecByCheck		: _addOfferSpecByCheck,
		addAndDelTerminal		: _addAndDelTerminal,
		closeAttachSearch 		: _closeAttachSearch,
		changeLabel				: _changeLabel,
		changeList				: _changeList,
		closeServ				: _closeServ,
		closeServSpec			: _closeServSpec,
		checkData				: _checkData,
		delOffer				: _delOffer,
		delOfferSpec			: _delOfferSpec,
		labelList				: _labelList,
		isChangeUim				: _isChangeUim,
		init					: _init,
		openList				: _openList,
		openedList				: _openedList,
		openServList			: _openServList,
		openedServList 			: _openedServList,
		openServSpec			: _openServSpec,
		openAppList				: _openAppList,
		queryAttachOffer 		: _queryAttachOffer,
		queryAttachOfferSpec 	: _queryAttachOfferSpec,
		queryCardAttachOffer    : _queryCardAttachOffer,
		showParam 				: _showParam,
		showServParam			: _showServParam,
		showTime				: _showTime,
		setAttachTime			: _setAttachTime,
		searchAttachOfferSpec   : _searchAttachOfferSpec,
		selectAttachOffer		: _selectAttachOffer,
		showOfferTime			: _showOfferTime,
		showMainParam			: _showMainParam,
		showMainMember			: _showMainMember,
		selectServ				: _selectServ,
		showStartTime			: _showStartTime,
		showEndTime			    : _showEndTime,
		setAttachBusiOrder		: _setAttachBusiOrder,
		showApp					: _showApp,
		showHideUim				: _showHideUim,
		showMainRoleProd		: _showMainRoleProd,
		checkTerminalCode		: _checkTerminalCode,
		checkOfferExcludeDepend	: _checkOfferExcludeDepend,
		checkServExcludeDepend	: _checkServExcludeDepend,
		servExDepReByRoleObjs	: _servExDepReByRoleObjs,
		setChangeList			: _setChangeList,
		reductionChangList		: _reductionChangList,
		filterServ				: _filterServ,
		setParam				: _setParam,
		showMainMemberRoleProd	: _showMainMemberRoleProd,
		offerSpecDetail         : _offerSpecDetail,
		delOfferSpecReload     :_delOfferSpecReload,
		closeServSpecReload    :_closeServSpecReload,
		addOfferSpecReload     :_addOfferSpecReload,
		openServSpecReload     :_openServSpecReload,
		checkTerminalCodeReload:_checkTerminalCodeReload,
		changereserveCode:_changereserveCode,
		delServSpec             : _delServSpec,
		setSpec:_setSpec
	};
})();
/**
 * 对缓存数据操作
 * 
 * @author wukf
 * date 2014-01-15
 */
CommonUtils.regNamespace("CacheData");

/** 缓存数据对象*/
CacheData = (function() {
	
	//把销售品规格保存到开通列表里面
	var _setOfferSpec = function(prodId,offerSpec){
		offerSpec.isdel="C";
		offerSpec.counts=1;
		var flag = true ; 
		for (var i = 0; i < AttachOffer.openList.length; i++) { //没有开通任何附属
			var open = AttachOffer.openList[i];
			if(open.prodId==prodId){
				flag = false;
				break;
			}
		} 
		if(flag){
			var open = {
				prodId : prodId,
				specList : []
			};
			AttachOffer.openList.push(open);
		}
		CacheData.getOfferSpecList(prodId).push(offerSpec);//添加到已开通列表里
	};
	
	//添加功能产品到缓存列表
	var _setServSpec = function(prodId,spec){
		spec.isdel="C";
		if(spec.servSpecId==undefined){
			spec.servSpecId = spec.objId;
		}
		if(spec.servSpecName==undefined){
			spec.servSpecName = spec.objName;
		}
		var flag = true ; 
		for (var i = 0; i < AttachOffer.openServList.length; i++) { //没有开通任何附属
			var open = AttachOffer.openServList[i];
			if(open.prodId==prodId){
				flag = false;
				break;
			}
		} 
		if(flag){
			var open = {
				prodId : prodId,
				servSpecList : []
			};			
			AttachOffer.openServList.push(open);
		}
		CacheData.getServSpecList(prodId).push(spec);//添加到已开通列表里
	};
	
	//把选中的服务保存到销售品规格中
	var _setServ2OfferSpec = function(prodId,offerSpec){
		if(offerSpec!=undefined){
			$.each(offerSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					if($("#check_"+prodId+"_"+this.objId).attr("checked")=="checked"){
						this.selQty = 1;
					}else{
						this.selQty = 2;//未选中
					}
				});
			});
		}
	};
	
	//把选中的销售品保存到依赖或互斥的销售品规格中
	var _setOffer2ExcludeOfferSpec = function(param){
		if(param.dependOffer.offerGrpInfos.length>0){  // 依赖组
			var dependOffer=param.dependOffer;
			for (var i = 0; i < dependOffer.offerGrpInfos.length; i++) {
				var offerGrpInfo = dependOffer.offerGrpInfos[i];
				var $offerSpecs = $("input[name="+offerGrpInfo.grpId+"]:checked");
				var len  = $offerSpecs.length;
				dependOffer.offerGrpInfos[i].checkLen=len;
				for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){
					var subOfferSpecInfo=offerGrpInfo.subOfferSpecInfos[j];
					$offerSpecs.each(function(){
						if($(this).val()==subOfferSpecInfo.offerSpecId){
							subOfferSpecInfo.isCheck=true;
						}
					});
				}
			}
		}
	};
	
	//获取参数内容
	var _getParamContent = function(prodId,spec,flag){
		var content = '<form id="paramForm"><table>' ;
		if(flag==2){  //功能产品规格参数
			if(ec.util.isArray(spec.prodSpecParams)){ //拼接功能产品规格参数
				for (var i = 0; i < spec.prodSpecParams.length; i++) { 
					var param = spec.prodSpecParams[i];
					if(param.value==undefined){
						param.value = "";
					}
					content += _getStrByParam(prodId,param,spec.servSpecId,param.itemSpecId,param.value);
				}
			}
		}else if(flag==3){ //功能产品实例参数
			if(ec.util.isArray(spec.prodSpecParams)){ //拼接功能产品规格参数
				for (var i = 0; i < spec.prodSpecParams.length; i++) { 
					var param = spec.prodSpecParams[i];
					if(ec.util.isArray(spec.prodInstParams)){ //拼接功能产品实例参数
						$.each(spec.prodInstParams,function(){
							if(this.itemSpecId==param.itemSpecId){
								param.value = this.value;
							}
						});
					}
					if(param.value==undefined){
						param.value = "";
					}
					content += _getStrByParam(prodId,param,spec.servSpecId,param.itemSpecId,param.value);
				}
			}
		} else if(flag==1){  //销售品实例参数
			if(spec.offerSpec!=undefined){
				if(ec.util.isArray(spec.offerSpec.offerSpecParams)){
					var offerSpecParams = spec.offerSpec.offerSpecParams;//sortParam(spec.offerSpec.offerSpecParams);
					$.each(offerSpecParams,function(){
						var param = this;
						if(ec.util.isArray(spec.offerParamInfos)){ //销售品实例参数
							$.each(spec.offerParamInfos,function(){  
								if(this.itemSpecId==param.itemSpecId){
									param.value = this.value;
								}
							});
						}
						content += _getStrByParam(prodId,this,spec.servSpecId,this.itemSpecId,this.value);
					});
				}
			}
		}else {  //销售品规格参数
			if(ec.util.isArray(spec.offerSpecParams)){
				var offerSpecParams = spec.offerSpecParams;
				$.each(offerSpecParams,function(){
					content += _getStrByParam(prodId,this,spec.servSpecId,this.itemSpecId,this.value);
				});
			}
			/*if(spec.offerRoles!=undefined && spec.offerRoles.length>0){
				for (var i = 0; i < spec.offerRoles.length; i++) {
					var offerRole = spec.offerRoles[i];
					for (var j = 0; j < offerRole.roleObjs.length; j++) {
						var roleObj = offerRole.roleObjs[j];
						if(roleObj.prodSpecParams !=undefined && roleObj.prodSpecParams.length>0){
							for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
								content += _getStrByParam(prodId,roleObj.prodSpecParams[k],roleObj.prodSpecParams[k].itemSpecId,flag);
							}
						}
					}
				}
			}*/
		}
		content +='</table></form>';
		return content;
	};
	
	//获取增值业务内容
	var _getAppContent = function(prodId,appList){
		var $form = $('<form id="appForm"></form>');
		if(!!appList && appList.length>0){ //下拉框
			$.each(appList,function(){
				var $input = $('<input id="'+prodId+'_'+this.objId+'" name="'+prodId+'" type="checkbox">'+this.objName+'</input></br>');
				if(this.minQty == 0){
					if(this.dfQty>0){
						$input.attr("checked","checked");
					}
				}else if(this.minQty > 0){
					$input.attr("checked","checked");
					$input.attr("disabled","disabled");
				}
				$form.append($input);
			});
		}
		return $form;
	};
	
	//根据参数获取字符串
	var _getStrByParam = function(prodId,param,specId){
		var itemSpecId = param.itemSpecId;
		if(param.setValue==undefined){  //没有设置过参数
			param.setValue = param.value; //赋值成默认值
		}
		var paramVal = param.setValue;
		var selectStr = ""; //返回字符串
		var optionStr = "";
		if(!!param.valueRange && itemSpecId == 11251741){ //可编辑下拉框（11251741 为政企协议编码 ） 这段 仅仅最为 临时处理 后续优化
			//if(param.rule.isConstant=='Y'){ //不可修改
		//		selectStr = param.name + ": <select class='inputWidth183px' id="+prodId+"_"+itemSpecId+" disabled='disabled'>"; 
		//	}else {
		//		if(param.rule.isOptional=="N") { //必填
			      //  selectStr = selectStr + '<script src="${contextPath}/js/busi-js/order/test.js?${jsversion}" type="text/javascript"></script>';
			       
					selectStr = selectStr + param.name + ": <input id='input1' name='input1' type='text' class='cssINPUT'  style='height: 19px; display: block; float: left; position: absolute; border-right: 0px;'><label class='f_red'>*</label><br>";
					selectStr = selectStr + "<select id='select1'  name='select1' class='cssINPUT' data-validate='validate(required:请在下拉框中选择协议编码) on(blur)' style='float: left;display: none; height: 27PX; position: absolute; cursor: pointer; margin-left: 2px;  padding: 0px;'>"; 
					
		//		}else{
		//			selectStr = param.name + ": <select class='inputWidth183px' id="+prodId+"_"+itemSpecId+"><br>"; 
				    optionStr +='<option style="display:none" value=""></option>';  //不是必填可以不选
		//		}
		//	}
			for ( var j = 0; j < param.valueRange.length; j++) {
				var valueRange = param.valueRange[j];
				if(valueRange.value== param.setValue){
					optionStr +='<option value="'+valueRange.value+'" selected="selected" >'+valueRange.text+'</option>';
				}else {
					optionStr +='<option value="'+valueRange.value+'">'+valueRange.text+'</option>';
				}
			}
			selectStr += optionStr + "</select><br>"; 
			selectStr = selectStr + "<div id='div1' style='position: absolute;top:77px;'></div>";
			return selectStr;
		}
		if(!!param.valueRange && (itemSpecId == CONST.YZFitemSpecId1||itemSpecId ==  CONST.YZFitemSpecId2||itemSpecId ==  CONST.YZFitemSpecId3)){ //可编辑下拉框（10020034,10020035,10020036 为翼支付交费助手的三属性）
			//缴费助手的属性值,如果是预付费的，则属性中展示默认值，且必填，如果是后付费的，属性为空，且不可填
		var feeType = $("select[name='pay_type_-1']").val();
		if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
		if(feeType == CONST.PAY_TYPE.BEFORE_PAY){
			if(param.rule.isConstant=='Y'){ //不可修改
				selectStr = selectStr+"<tr><td>"+param.name + ": </td><td><select class='inputWidth183px' id="+prodId+"_"+itemSpecId+" disabled='disabled'>"; 
			}else {
				if(param.rule.isOptional=="N") { //必填
					selectStr = selectStr+"<tr><" +
							"td>"+param.name + ": </td><td><select class='inputWidth183px' id="+prodId+"_"+itemSpecId+" data-validate='validate(required,reg:"
							  + param.rule.maskMsg+"("+param.rule.mask+")) on(blur)'><label class='f_red'>*</label><br>"; 
				}else{
					selectStr = selectStr+"<tr><td>"+param.name + ": </td><td><select class='inputWidth183px' id="+prodId+"_"+itemSpecId+"><br>"; 
				}
			}
			for ( var j = 0; j < param.valueRange.length; j++) {
				var valueRange = param.valueRange[j];
				if(valueRange.value== param.setValue){
					optionStr +='<option value="'+valueRange.value+'" selected="selected" >'+valueRange.text+'</option>';
				}else {
					optionStr +='<option value="'+valueRange.value+'">'+valueRange.text+'</option>';
				}
			}
			selectStr += optionStr + "</select></td></tr>"; 
			return selectStr;
		}
			else if(feeType == CONST.PAY_TYPE.AFTER_PAY){
				selectStr =selectStr+"<tr><td>"+ param.name + ":</td><td> <select class='inputWidth183px' id="+prodId+"_"+itemSpecId+" disabled='disabled'>";
				optionStr +='<option value="" selected="selected">不可选</option>';
				selectStr += optionStr + "</select></td></tr>"; 
				return selectStr;
			}
		}
		if(ec.util.isArray(param.valueRange)){ //下拉框
			if(param.rule.isConstant=='Y'){ //不可修改
				selectStr = param.name + ": <select class='inputWidth183px' id="+prodId+"_"+itemSpecId+" disabled='disabled'>"; 
			}else {
				if(param.rule.isOptional=="N") { //必填
					selectStr = param.name + ": <select class='inputWidth183px' id="+prodId+"_"+itemSpecId+" data-validate='validate(required,reg:"
							  + param.rule.maskMsg+"("+param.rule.mask+")) on(blur)'><label class='f_red'>*</label><br>"; 
				}else{
					selectStr = param.name + ": <select class='inputWidth183px' id="+prodId+"_"+itemSpecId+"><br>"; 
					optionStr +='<option value="" >请选择</option>';  //不是必填可以不选
				}
			}
			for ( var j = 0; j < param.valueRange.length; j++) {
				var valueRange = param.valueRange[j];
				if(valueRange.value== param.setValue){
					optionStr +='<option value="'+valueRange.value+'" selected="selected" >'+valueRange.text+'</option>';
				}else {
					optionStr +='<option value="'+valueRange.value+'">'+valueRange.text+'</option>';
				}
			}
			selectStr += optionStr + "</select><br>"; 
		}else { 
			 if(param.dataTypeCd==1){  //文本框
				if(param.rule==undefined){
					selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId +'" class="inputWidth183px" type="text" value="'+paramVal+'" ><br>'; 
				}else {
					if(param.rule.isConstant=='Y'){ //不可修改
						selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId
						+'" class="inputWidth183px" type="text" disabled="disabled" value="'+paramVal+'" >';
						if(ec.util.isObj(specId)&&ec.util.isObj(CONST.getGroupServProdMap(specId,itemSpecId))){//是否是群功能产品
							var type=CONST.getGroupServProdMap(specId,itemSpecId);
							var id=prodId+'_'+specId+'_'+itemSpecId;
							selectStr+='<a class="purchase" href="javascript:order.main.queryGroup('+type+',0,\''+id+'\');">选择</a>';
						}
						selectStr+='<br>';
					}else {
						if(param.rule.isOptional=="N") { //必填
							if(OrderInfo.isGroupProSpecId(specId)){//群功能产品
								selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId  
								+'" class="inputWidth183px" type="text" mask="'+param.rule.mask+'" maskmsg="'+param.rule.maskMsg+'" value="'+paramVal+'" ><label style="color: #ff0000;float:right;margin-right:40px;">*</label><br>';
							}else{
								selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId  
								+'" class="inputWidth183px" type="text" mask="'+param.rule.mask+'" maskmsg="'+param.rule.maskMsg+'" value="'+paramVal+'" ><label class="f_red">*</label><br>';//data-validate="validate(required,reg:'+param.rule.maskMsg+'('+param.rule.mask+')) on(blur)"
							}
						}else{
							selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId  
							+'" class="inputWidth183px" type="text" mask="'+param.rule.mask+'" maskmsg="'+param.rule.maskMsg+'" value="'+paramVal+'" ><br>';//data-validate="validate(reg:'+param.rule.maskMsg+'('+param.rule.mask+')) on(blur)"
						}
					}
				}
			} else if(param.dataTypeCd==8){  //密码框
				if(param.rule==undefined){
					selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId +'" class="inputWidth183px" type="password" value="'+paramVal+'" ><br>'; 
				}else{
					if(param.rule.isConstant=='Y'){
						selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId
						+'" class="inputWidth183px" type="password"  disabled="disabled" value="'+paramVal+'" ><br>';
					}else {
						if(param.rule.isOptional=="N") {
							selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId  
							+'" class="inputWidth183px" type="password" data-validate="validate(required,reg:'+param.rule.maskMsg+'('+param.rule.mask+')) on(blur)" value="'+paramVal+'" ><label class="f_red">*</label><br>'; 
						}else{
							selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId  
							+'" class="inputWidth183px" type="password" data-validate="validate(reg:'+param.rule.maskMsg+'('+param.rule.mask+')) on(blur)" value="'+paramVal+'" ><br>'; 
						}
					}
				}
			}else if(param.dataTypeCd==4){ //日期，暂时不写
			
			
			}
		}
		return selectStr;
	};
	
	//获取销售品下的功能产品拼接成字符串
	var _getOfferProdStr = function(prodId,spec,flag){
		var content = '<form id="paramForm">' ;
		var str = "";
		if(flag==0){  //订购可选包
			$.each(spec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					if(this.objType==4){
						if(this.minQty==0 && this.maxQty>0 && this.dfQty>0){
							str += '<input id="check_'+prodId+'_'+this.objId +'" type="checkbox" checked="checked">'+this.objName+'<br>'; 
						}else if(this.minQty>0){
							str += '<input id="check_'+prodId+'_'+this.objId +'"  type="checkbox" checked="checked" disabled="disabled">'+this.objName+'<br>';
						}else if(this.minQty==0 && this.maxQty>0 && this.dfQty==0){
							str += '<input id="check_'+prodId+'_'+this.objId +'" type="checkbox">'+this.objName+'<br>'; 
						}
					}
				});
			});
			if(str==""){
				content = '订购【'+spec.offerSpecName+'】可选包' ;
			}else{
				content = '订购【'+spec.offerSpecName+'】可选包，需要开通以下勾选的功能产品：<br>' +str;
			}
		}else if(flag==1) { //退订可选包
			$.each(spec.offerMemberInfos,function(){  //退订时候spec当成serv
				var offerMember = this;
				$.each(spec.offerSpec.offerRoles,function(){
					$.each(this.roleObjs,function(){
						if(offerMember.objId==this.objId && this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){ //优惠构成关系
							var servId = offerMember.objInstId;
							if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE&&this.minQty<=0){
								str += '<input id="check_'+prodId+'_'+servId+'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+'<br>'; 
							}else if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE&&this.minQty<=0){
								str += '<input id="check_'+prodId+'_'+servId+'" type="checkbox" checked="checked">'+this.objName+'<br>';
							}
						}
					});
				});
			});
			if(str==""){
				content = '退订【'+spec.offerSpecName+'】可选包' ;
			}else{
				content = '退订【'+spec.offerSpecName+'】可选包，需要关闭以下勾选的功能产品：<br>' +str;
			}
		}else if(flag==2) { //取消订购可选包
			$.each(spec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					if(this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){ //优惠构成关系
						if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE&&this.minQty<=0){
							str += '<input id="check_'+prodId+'_'+this.objId +'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+'<br>'; 
						}else if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE&&this.minQty<=0){
							str += '<input id="check_'+prodId+'_'+this.objId +'" type="checkbox" checked="checked">'+this.objName+'<br>';
						}
					}
				});
			});
			if(str==""){
				content = '取消订购【'+spec.offerSpecName+'】可选包' ;
			}else{
				content = '取消订购【'+spec.offerSpecName+'】可选包，需要取消开通以下勾选的功能产品：<br>' +str;
			}
		}
		content +='</form>';
		return content;
	};
	
	//自动设置参数
	var _setParam = function(prodId,offerSpec){
		//自动设置销售品参数
		if(ec.util.isArray(offerSpec.offerSpecParams)){
			for (var i = 0; i < offerSpec.offerSpecParams.length; i++) {
				var param = offerSpec.offerSpecParams[i];
				if(ec.util.isArray(param.valueRange)){ //不是下拉框
					if(param.value==undefined || param.value==""){ //必须手工填写
						if(param.rule.isOptional=="N"){ //必填
							return false;
						}
					}
				}else{
					if(param.value==undefined || param.value==""){
						if(param.rule.isOptional=="N"){ //必填
							return false;
						}
					}
				}
			}
		}
		//自动设置服务参数
		/*if(!!offerSpec.offerRoles){
			for (var i = 0; i < offerSpec.offerRoles.length; i++) {
				var offerRole = offerSpec.offerRoles[i];
				for (var j = 0; j < offerRole.roleObjs.length; j++) {
					var roleObj = offerRole.roleObjs[j];
					if(!!roleObj.prodSpecParams){
						for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
							var param = roleObj.prodSpecParams[k];
							if(param.valueRange.length == 0){ //不是下拉框
								if(param.value===""){ //必须手工填写
									return false;
								}
							}else{
								if(param.value==undefined || param.value==""){
									param.value = param.valueRange[0].value; 
								}
							}
						}
					}
				}
			}
		}*/
		offerSpec.isset = "Y";
		return true;
	};

	//自动设置服务参数
	var _setServParam = function(prodId,servSpec){
		if(ec.util.isArray(servSpec.prodSpecParams)){
			for (var k = 0; k < servSpec.prodSpecParams.length; k++) {
				var param = servSpec.prodSpecParams[k];
				if(ec.util.isArray(param.valueRange)){ //下拉框
					if(param.value==undefined || param.value==""){ //必须手工填写
						if(param.rule.isOptional=="N"){ //必填
							return false;
						}
					}
				}else{
					if(param.value==undefined || param.value==""){
						if(param.rule.isOptional=="N"){ //必填
							return false;
						}
					}
				}
			}
		}
		servSpec.isset = "Y";
		return true;
	};
	
	//通过产品id获取产品已开通附属规格列表
	var _getOfferSpecList = function (prodId){
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			if(open.prodId == prodId){
				return open.specList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//通过产品id,跟销售品规格id获取销售品构成
	var _getOfferSpec = function(prodId,offerSpecId){
		var specList = _getOfferSpecList(prodId);
		if(specList!=undefined){
			for ( var i = 0; i < specList.length; i++) {
				if(specList[i].offerSpecId==offerSpecId){
					return specList[i];
				}
			}
		}
	};
	
	//获取某个销售品规格参数  
	var _getSpecParam = function(prodId,offerSpecId,itemSpecId){
		var spec = _getOfferSpec(prodId,offerSpecId);
		if(ec.util.isObj(spec)){
			for ( var i = 0; i < spec.offerSpecParams.length; i++) {
				if(spec.offerSpecParams[i].itemSpecId==itemSpecId){
					return spec.offerSpecParams[i];
				}
			}
		}
	};
	
	//获取销售品下某个功能产品参数  
	var _getProdSpecParam = function(prodId,offerSpecId,itemSpecId){
		var spec = _getOfferSpec(prodId,offerSpecId);
		if(!!spec.offerRoles){
			for (var i = 0; i < spec.offerRoles.length; i++) {
				var offerRole = spec.offerRoles[i];
				for (var j = 0; j < offerRole.roleObjs.length; j++) {
					var roleObj = offerRole.roleObjs[j];
					if(roleObj.prodSpecParams !=undefined && roleObj.prodSpecParams.length>0){
						for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
							if(roleObj.prodSpecParams[k].itemSpecId==itemSpecId){
								return roleObj.prodSpecParams[k];
							}
						}
					}
				}
			}
		}
	};
	
	//通过产品id获取产品已开通附属实例列表
	var _getOfferList = function (prodId){
		for ( var i = 0; i < AttachOffer.openedList.length; i++) {
			var opened = AttachOffer.openedList[i];
			if(opened.prodId == prodId){
				return opened.offerList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//获取销售品实例构成
	var _getOffer = function(prodId,offerId){
		var offerList = _getOfferList(prodId);
		if(ec.util.isArray(offerList)){
			for ( var i = 0; i < offerList.length; i++) {
				if(offerList[i].offerId==offerId){
					return offerList[i];
				}
			}
		}
	};
	
	//根据规格ID获取销售品实例构成
	var _getOfferBySpecId = function(prodId,offerSpecId){
		var offerList = _getOfferList(prodId);
		if(ec.util.isArray(offerList)){
			for ( var i = 0; i < offerList.length; i++) {
				if(offerList[i].offerSpecId==offerSpecId){
					return offerList[i];
				}
			}
		}
	};
	
	//获取某个销售品参数  
	var _getOfferParam = function(prodId,offerId,itemSpecId){
		var offer = _getOffer(prodId,offerId);
		if(ec.util.isArray(offer.offerSpec.offerSpecParams)){
			for ( var i = 0; i < offer.offerSpec.offerSpecParams.length; i++) {
				if(offer.offerSpec.offerSpecParams[i].itemSpecId==itemSpecId){
					return offer.offerSpec.offerSpecParams[i];
				}
			}
		}
		/*if(offer.offerParamInfos!=undefined){
			for ( var i = 0; i < offer.offerParamInfos.length; i++) {
				if(offer.offerParamInfos[i].offerParamId==offerParamId){
					return offer.offerParamInfos[i];
				}
			}
		}*/
	};
	
	//获取某个实例功能产品参数  
	var _getProdInstParam = function(prodId,offerId,itemSpecId){
		var offer = _getOffer(prodId,offerId);
		if(ec.util.isArray(offer.offerMembers)){
			for (var i = 0; i < offer.offerMembers.length; i++) {
				var offerMember = offer.offerMembers[i];
				for (var j = 0; j < offerMember.prodParamInfos.length; j++) {
					for (var k = 0; k < offerMember.prodParamInfos.length; k++) {
						var prodParam = offerMember.prodParamInfos[k];
						if(prodParam.itemSpecId==itemSpecId){
							return prodParam;
						}
					}
				}
			}
		}
	};
	
	//通过产品id获取产品已选功能产品规格列表
	var _getServSpecList = function(prodId){
		for ( var i = 0; i < AttachOffer.openServList.length; i++) {
			var open = AttachOffer.openServList[i];
			if(open.prodId == prodId){
				return open.servSpecList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//根据产品id,跟规格ID获取功能产品
	var _getServSpec = function(prodId,servSpecId){
		var servSpecList = _getServSpecList(prodId);
		if(servSpecList != undefined){
			for ( var i = 0; i < servSpecList.length; i++) {
				if(servSpecList[i].servSpecId==servSpecId){
					return servSpecList[i];
				}
			}
		}
	};
	
	//获取某个功能产品一个参数  
	var _getServSpecParam = function(prodId,servSpecId,itemSpecId){
		var servSpec = _getServSpec(prodId,servSpecId);
		if(ec.util.isArray(servSpec.prodSpecParams)){
			for (var i = 0; i < servSpec.prodSpecParams.length; i++) {
				if(servSpec.prodSpecParams[i].itemSpecId==itemSpecId){
					return servSpec.prodSpecParams[i];
				}
			}
		}
	};
	
	//通过产品id获取产品已选功能产品实例列表
	var _getServList = function(prodId){
		for ( var i = 0; i < AttachOffer.openedServList.length; i++) {
			var opened = AttachOffer.openedServList[i];
			if(opened.prodId == prodId){
				return opened.servList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//通过功能产品id获取功能产品
	var _getServ = function(prodId,servId){
		var servList = _getServList(prodId);
		if(ec.util.isArray(servList)){
			for ( var i = 0; i < servList.length; i++) {
				if(servList[i].servId==servId){
					return servList[i];
				}
			}
		}
	};
	
	//通过功能产品id获取功能产品
	var _getServBySpecId = function(prodId,servSpecId){
		var servList = _getServList(prodId);
		if(ec.util.isArray(servList)){
			for ( var i = 0; i < servList.length; i++) {
				if(servList[i].servSpecId==servSpecId){
					return servList[i];
				}
			}
		}
	};
	
	//获取某个实例功能产品参数  
	var _getServInstParam = function(prodId,servId,itemSpecId){
		var serv = _getServ(prodId,servId);
		if(ec.util.isArray(serv.prodSpecParams)){
			for ( var i = 0; i < serv.prodSpecParams.length; i++) {
				var servParam = serv.prodSpecParams[i];
				if(servParam.itemSpecId==itemSpecId){
					return servParam;
				}
			}
		}
		/*if(ec.util.isArray(serv.prodInstParams)){
			for ( var i = 0; i < serv.prodInstParams.length; i++) {
				var servParam = serv.prodInstParams[i];
				if(servParam.itemSpecId==itemSpecId){
					return servParam;
				}
			}
		}*/
	};
	
	//获取增值业务列表
	var _getOpenAppList = function(prodId){
		for ( var i = 0; i < AttachOffer.openAppList.length; i++) {
			var open = AttachOffer.openAppList[i];
			if(open.prodId == prodId){
				return open.appList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//根据产品id获取销售品成员
	var _getOfferMember = function(prodId){
		if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //销售品实例构成
			for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[i];
				if(offerMember.objInstId==prodId){
					return offerMember;
				}
			}
		}
		return {};
	};
	
	//根据产品id获取销售品成员
	var _getOldOfferMember = function(prodId){
		for(var j=0;j<OrderInfo.oldoffer.length;j++){
			for ( var i = 0; i < OrderInfo.oldoffer[j].offerMemberInfos.length; i++) {
				var offerMember = OrderInfo.oldoffer[j].offerMemberInfos[i];
				if(offerMember.objInstId==prodId){
					return offerMember;
				}
			}
		}
		return {};
	};
	
	//获取功能产品互斥依赖参数
	var _getExcDepServParam = function(prodId,servSpecId){
		//互斥依赖入参
		var param = { 
			servSpecId:servSpecId,
			prodId:prodId,
			orderedServSpecIds : [] //销售品互斥依赖查询入场数组
		};
		//遍历已选功能产品
		var servSpecList = CacheData.getServSpecList(prodId);
		if(ec.util.isArray(servSpecList)){
			$.each(servSpecList,function(){ //遍历已选择功能产品
				if(this.servSpecId!=servSpecId && this.isdel!="Y" && this.isdel!="C"){
					param.orderedServSpecIds.push(this.servSpecId);
				}
			});
		}
		//遍历已选功能产品
		var servList = CacheData.getServList(prodId);
		if(ec.util.isArray(servList)){
			$.each(servList,function(){ //遍历已选择功能产品
				if(this.servSpecId!=servSpecId && this.isdel!="Y" && this.isdel!="C"){
					param.orderedServSpecIds.push(this.servSpecId);
				}
			});
		}
		return param;
	};
	
	//获取可选包互斥依赖参数
	var _getExcDepOfferParam = function(prodId,offerSpecId){
		//互斥依赖入参
		var param = {
			prodId : prodId,
			offerSpecId : offerSpecId,
			objType : CONST.OBJ_TYPE.PROD,
			orderedOfferSpecIds : [] //可选包互斥依赖查询入场数组
		};
//		if(OrderInfo.actionFlag == 2){ //套餐变更		
//			$.each(OrderInfo.offerSpec.offerRoles,function(){
//				if(ec.util.isArray(this.prodInsts)){
//					$.each(this.prodInsts,function(){
//						if(this.prodInstId==prodId){
//							param.objId=this.objId;
//							return false;
//						}
//					});
//				}
//			});
//		}else if(OrderInfo.actionFlag == 3){  //可选包
//			param.objId=order.prodModify.choosedProdInfo.productId;
//		}else { //新装
//			var prodInst = OrderInfo.getProdInst(prodId);
//			if(prodInst){
//				param.objId=prodInst.objId;
//			}
//		}
		var offerSpec=CacheData.getOfferSpec(prodId,offerSpecId);
		if(ec.util.isObj(offerSpec)){
			if(ec.util.isArray(offerSpec.offerRoles)){
				$.each(offerSpec.offerRoles,function(){
					if(ec.util.isArray(this.roleObjs)){
						$.each(this.roleObjs,function(){
							if(this.objType==CONST.OBJ_TYPE.PROD){
								param.offerRoleId = this.offerRoleId;
								param.objId=this.objId;
								return false;
							}
						});
					}
				});
			}
		}else{
			var offer=CacheData.getOfferBySpecId(prodId,offerSpecId);
			if(ec.util.isObj(offer)){
				param.offerRoleId = offer.offerRoleId;
				if(ec.util.isArray(offer.offerMemberInfos)){
					$.each(offer.offerMemberInfos,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD){
							param.objId=this.objId;
							return false;
						}
					});
				}
			}
		}
		//已开通销售品列表(和后台约定，前台不传已订购的附属销售品，防止影响续约的)
//		var offerList = CacheData.getOfferList(prodId); 
//		if(ec.util.isArray(offerList)){
//			$.each(offerList,function(){
//				if(this.offerSpecId!=offerSpecId && this.isdel!="Y"  && this.isdel!="N"){
//					if(this.offerSpecId!=undefined){
//						param.orderedOfferSpecIds.push(this.offerSpecId);
//					}
//				}
//			});
//		}
		//已选销售品列表
		var offerSpecList = CacheData.getOfferSpecList(prodId); 
		if(ec.util.isArray(offerSpecList)){
			$.each(offerSpecList,function(){
				if(this.offerSpecId!=offerSpecId && this.isdel!="Y"){
					if(this.offerSpecId!=undefined){
						param.orderedOfferSpecIds.push(this.offerSpecId);
					}
				}
			});
		}
		return param;
	};
	
	//二次业务把必须功能产品改成不能删除
	var _parseServ = function(data,objInstId){
		if(ec.util.isObj(data)){
			if(ec.util.isArray(data.result.servSpec)){
				if(ec.util.isObj(objInstId)){
					prodId=objInstId;
				}
				for (var i = 0; i < data.result.servSpec.length; i++) {
					var servSpec = data.result.servSpec[i];
					var serv = CacheData.getServBySpecId(prodId,servSpec.servSpecId); //已开通里面查找
					var newSpec = CacheData.getServSpec(prodId,servSpec.servSpecId); //已选里面查找
					if(servSpec.ifDault==0 || servSpec.ifCanCancelDoublePackage=="N"){
						if(ec.util.isObj(serv)){
							var $dd = $("#del_"+prodId+"_"+serv.servId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("delete").addClass("mustchoose");
								$dd.removeAttr("onclick");
								serv.isdel = "N";
							}
						}	
						else if(ec.util.isObj(newSpec)){
							var $dd = $("#del_"+prodId+"_"+newSpec.servSpecId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("delete").addClass("mustchoose");
								$dd.removeAttr("onclick");
								newSpec.isdel = "N";
							}
						}else {
							if(OrderInfo.actionFlag==2){//套餐变更
								servSpec.isdel = "C";
								CacheData.setServSpec(prodId,servSpec);
								AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams);
								//AttachOffer.checkServExcludeDepend(prodId,servSpec);
							}
						}
					}else if((OrderInfo.actionFlag==2||OrderInfo.actionFlag==21 ||OrderInfo.actionFlag==22 )&&servSpec.ifDault==1){//套餐变更需要展示默认的功能产品
						if(ec.util.isObj(serv)){
							var $dd = $("#del_"+prodId+"_"+serv.servId);
							if(ec.util.isObj($dd)){
								serv.isdel = "N";
							}
						}	
						else if(ec.util.isObj(newSpec)){
							var $dd = $("#del_"+prodId+"_"+newSpec.servSpecId);
							if(ec.util.isObj($dd)){
								newSpec.isdel = "N";
							}
						}else {
							servSpec.isdel = "C";
							CacheData.setServSpec(prodId,servSpec);
							AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams);
							//AttachOffer.checkServExcludeDepend(prodId,servSpec);
						}
					}
				}
			}
		}
	};
	
	//二次业务把必须可选包改成不能删除
	var _parseOffer = function(data,objInstId){
		if(ec.util.isObj(data)){
			if(ec.util.isArray(data.result.offerSpec)){
				if(ec.util.isObj(objInstId)){
					prodId=objInstId;
				}
				for (var i = 0; i < data.result.offerSpec.length; i++) {
					var offerSpec = data.result.offerSpec[i];
					if(offerSpec.ifDault==0 || offerSpec.ifCanCancelDoublePackage=="N"){
						var offer = CacheData.getOfferBySpecId(prodId,offerSpec.offerSpecId); //已开通里面查找
						if(ec.util.isObj(offer)){
							var $dd = $("#del_"+prodId+"_"+offer.offerId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("delete").addClass("mustchoose");
								$dd.removeAttr("onclick");
								offer.isdel = "N";
							}
							continue;
						}	
						var newSpec = CacheData.getOfferSpec(prodId,offerSpec.offerSpecId); //已开通里面查找
						if(ec.util.isObj(newSpec)){
							var $dd = $("#del_"+prodId+"_"+newSpec.offerSpecId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("delete").addClass("mustchoose");
								$dd.removeAttr("onclick");
								newSpec.isdel = "N";
							}
						}else {
							if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21 ||OrderInfo.actionFlag==22){
								offerSpec.isdel = "C";
								CacheData.setOfferSpec(prodId,offerSpec);
								var param = CacheData.getExcDepOfferParam(prodId,offerSpec.offerSpecId);
								AttachOffer.addOpenList(prodId,offerSpec.offerSpecId); 
								if(param.orderedOfferSpecIds.length > 0 ){
									var dataExcludeDepend = query.offer.queryExcludeDepend(param);//查询规则校验
									if(dataExcludeDepend!=undefined && dataExcludeDepend.result!=undefined){
										var excludes = dataExcludeDepend.result.offerSpec.exclude;
										if(ec.util.isArray(excludes)){ //有互斥
											//删除已开通
											for (var i = 0; i < excludes.length; i++) {
												var excludeSpecId = excludes[i];
												var offer = CacheData.getOfferBySpecId(prodId,excludeSpecId);
												if(offer!=undefined){
													var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
													$span.addClass("del");
													offer.isdel = "Y";
													var $dd = $("#del_"+prodId+"_"+offer.offerId);
													if(ec.util.isObj($dd)){
														$dd.removeClass("delete").addClass("mustchoose");
														$dd.removeAttr("onclick");
													}
												}
											}
										}
									}
								}
							}
						}
					}
					else if(OrderInfo.actionFlag==22){
						offerSpec.isdel = "C";
						CacheData.setOfferSpec(prodId,offerSpec);
						AttachOffer.addOpenList(prodId,offerSpec.offerSpecId);
					}
				}
			}
		}
	};
	
	//获取产品对应的角色
	var _getOfferRoleId = function(prodId){
		var offerRoleId = "";
		if(prodId>0){ //二次业务
			if(OrderInfo.offer.offerMemberInfos!=undefined){
				$.each(OrderInfo.offer.offerMemberInfos,function(i){
					if(this.objInstId == prodId){
						offerRoleId = this.offerRoleId;  //角色ID
						return false;
					}
				});
			}
		}else if(prodId<0){ //新装
			if(OrderInfo.offerSpec.offerRoles!=undefined){
				$.each(OrderInfo.offerSpec.offerRoles,function(i){
					var roleId = this.offerRoleId;  //角色ID
					if(this.prodInsts!=undefined){
						$.each(this.prodInsts,function(){
							if(this.prodInstId == prodId){
								offerRoleId = roleId;
								return false;
							}
						});
					}
				});
			}
		}
		return offerRoleId;
	};
	
	//重新排列offerMemberInfos 把按顺序把主卡角色提前
	var _sortOffer = function(data){
		var tmpOfferMemberInfos = [];
		for ( var i = 0; i < data.offerMemberInfos.length; i++) {
			var offerMember = data.offerMemberInfos[i];
			if(offerMember.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){ //主卡
				tmpOfferMemberInfos.push(offerMember);
			}
		}
		for ( var i = 0; i < data.offerMemberInfos.length; i++) {
			var offerMember = data.offerMemberInfos[i];
			if(offerMember.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){
				tmpOfferMemberInfos.push(offerMember);
			}
		}
		data.offerMemberInfos = tmpOfferMemberInfos;
	};
	// 获取政企客户证件类型
	var govCertTyteArr = [];
	var _getGovCertType = function() {
		if (govCertTyteArr.length == 0) {
			var params = {"partyTypeCd": 2} ;
			var url=contextPath+"/cust/queryCertType";
			var response = $.callServiceAsJson(url, params, {});
			if (response.code == -2) {
				$.alertM(response.data);
			}
			if (response.code == 1002) {
				$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");
				return;
			}
			if(response.code==0){
				var data = response.data ;
				if(data!=undefined && data.length>0){
					for (var i=0; i<data.length; i++) {
						govCertTyteArr[i] = data[i].certTypeCd;
					}
				}
			}
		}
		return govCertTyteArr;
	};
	return {
		setParam				: _setParam,
		setServParam			: _setServParam,
		setOfferSpec			: _setOfferSpec,
		setServSpec				: _setServSpec,
		setServ2OfferSpec		: _setServ2OfferSpec,
		sortOffer				: _sortOffer,
		setOffer2ExcludeOfferSpec	:_setOffer2ExcludeOfferSpec,
		getParamContent			: _getParamContent,
		getOfferSpecList		: _getOfferSpecList,
		getOfferSpec			: _getOfferSpec,
		getSpecParam			: _getSpecParam,
		getOfferList			: _getOfferList,
		getOffer				: _getOffer,
		getOfferParam			: _getOfferParam,
		getOfferBySpecId		: _getOfferBySpecId,
		getServList				: _getServList,
		getServ					: _getServ,
		getServBySpecId			: _getServBySpecId,
		getServSpec				: _getServSpec,
		getServSpecList			: _getServSpecList,
		getProdInstParam		: _getProdInstParam,
		getProdSpecParam		: _getProdSpecParam,
		getServInstParam		: _getServInstParam,
		getServSpecParam		: _getServSpecParam,
		getOfferProdStr			: _getOfferProdStr,
		getOpenAppList			: _getOpenAppList,
		getAppContent			: _getAppContent,
		getOfferMember			: _getOfferMember,
		getExcDepServParam		: _getExcDepServParam,
		getExcDepOfferParam		: _getExcDepOfferParam,
		getOfferRoleId 			: _getOfferRoleId,
		parseServ				: _parseServ,
		parseOffer				: _parseOffer,
		getOldOfferMember		: _getOldOfferMember,
		getGovCertType          : _getGovCertType
	};
})();
/**
 * 订单算费
 * 
 * @author tang
 */
CommonUtils.regNamespace("order", "calcharge");
/**
 * 订单算费
 */
order.calcharge = (function(){
	var _chargeItems = [];
	var _prints=[];
	var _olId=0;
	var _soNbr=0;
	var num=0;
	var money=0;
	var _pageFlag='newOrder';
	var submit_success=false;
	var inOpetate=false;
	var olpos = false;
	var _posPayMethodIofo = []; //记录使用 离线pos支付方式 的费用项trid
	var _addbusiOrder=function(proId,obj){
		var html=$("#pro_"+proId).html();
		if(html!=undefined&&html!=''){
			easyDialog.open({
				container : 'moneyAdd'
			});
			$("#addContent").html('');
			$("#addContent").html(html);
			$("#moneyclose").off("click").on("click",function(event){easyDialog.close();});
			order.calcharge.trObj=obj;
		}else{
			$.alert("提示","没有可添加费用项的业务对象！");
		}
	};
	var _addSubmit=function(boId,boActionTypeCd,objType,objId,objName,actionName,objInstId,prodId){
		var refundType = "0" ;
		//撤单 if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
		if(OrderInfo.actionFlag==11){
			refundType = "1" ;
		}else if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
			refundType = "2" ;
		}
		var param={"boId":boId,"objInstId":objInstId,"prodId":prodId,"boActionTypeCd":boActionTypeCd,"actionFlag":OrderInfo.actionFlag,
				"objType":objType,"objId":objId,"itemNum":num,"objName":objName,"actionName":actionName,"refundType":refundType};
		$.callServiceAsHtml(contextPath+"/order/getChargeAddByObjId",param,{
			"before":function(){
				$.ecOverlay("<strong>正在增加收费项,请稍等会儿....</strong>");
			},"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				_addItems(boId,response.data);
			},
			"fail":function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	var _addItems=function(boId,html){
		easyDialog.close();
		if(html!=''){
			$(order.calcharge.trObj).parent().parent().after(html);
			num--;
			_reflashTotal();
		}else{
			$.alert("提示","没有可添加的费用项");
			return;
		}
	};
	var _delItems=function(obj,val,str){
		if(str=='old'){
			var fee=$("#feeAmount_"+val).val();
			if(($("#realAmount_"+val).val())*100==0){
				$("#realAmount_"+val).val(((fee/100).toFixed(2))+"");
			}else{
				$("#realAmount_"+val).val('0');
			}			
			var real=($("#realAmount_"+val).val())*100;
			if(real!=fee){
				$("#chargeModifyReasonCd_"+val).show();
			}else{
				$("#chargeModifyReasonCd_"+val).hide();
			}
		}else{
			$(obj).parent().parent().remove();
		}
		_reflashTotal();
	};
	var _delItems2=function(obj,itemTypeId,val,str){
		var flag = _queryPayMethodByItem(itemTypeId,val,null);
		if(flag){
			if(str=='old'){
				var fee=$("#feeAmount_"+val).val();
				if(($("#realAmount_"+val).val())*100!=0){
					$("#realAmount_"+val).val(((fee/100).toFixed(2))+"");
				}else{
					$("#realAmount_"+val).val('0');
				}			
				var real=($("#realAmount_"+val).val())*100;
				if(real!=fee){
					$("#chargeModifyReasonCd_"+val).show();
				}else{
					$("#chargeModifyReasonCd_"+val).hide();
				}
			}else{
				$(obj).parent().parent().remove();
			}
			_reflashTotal();
		}
	};
	var _reflashTotal=function(){
		_chargeItems=[];
		_prints=[];
		var realAmount=0;
		$("#calTab tbody tr").each(function() {
			var val = $(this).attr("id");
			if(val!=undefined&&val!=''){
				val=val.substr(5,val.length);
				if($("#paymentAmount_"+val) && $("#paymentAmount_"+val).val()*1==0){
					
				}else{
					var aa=($("#realAmount_"+val).val())*1;
					if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
						aa=($("#backAmount_"+val).val())*1;
					}
					realAmount=realAmount+aa;
					_commitParam(val);
				}
			}
		});
		if(OrderInfo.actionFlag==15){
			var backAmount=0;
			$("#calTab tbody tr").each(function() {
				var val = $(this).attr("id");
				if(val!=undefined&&val!=''){
					if($("#paymentAmount_"+val) && $("#paymentAmount_"+val).val()*1==0){
						
					}else{
						val=val.substr(5,val.length);
						var aa=($("#backAmount_"+val).val())*1;
						backAmount=backAmount+aa;
					}
				}
			});
			$('#backAmount').val(Number(backAmount).toFixed(2));
		}
		//alert(JSON.stringify(_prints));
		$('#realmoney').val(Number(realAmount).toFixed(2));
		if(OrderInfo.actionFlag==15){
			order.refund.conBtns();
		}else{
			_conBtns();
		}
	};
	var _submitParam=function(){
		var remakrFlag = true ;
		var posLenFlag = true ;
		var posNvlFlag = true ;
		$("#calTab tbody tr").each(function() {
			var val = $(this).attr("id");
			if(val!=undefined&&val!=''){
				val=val.substr(5,val.length);
				var chargeModifyReasonCd=$("#chargeModifyReasonCd_"+val).val();
				if(chargeModifyReasonCd=="1"){
					if($("#remark_"+val).val()==undefined||$("#remark_"+val).val()==null||$("#remark_"+val).val()==''){
						remakrFlag = false ;
					}
				}
				var payMethodCd=$("#payMethodCd_"+val).val();
				var terminalNumber=$("#terminalNumber").val();
				var serialNumber=$("#serialNumber").val();
				if(payMethodCd == '110101'){
					if(terminalNumber==undefined || $.trim(terminalNumber)==""){
						posNvlFlag = false;
					}
					if(serialNumber==undefined || $.trim(serialNumber)==""){
						posNvlFlag = false;
					}
					
					if(terminalNumber.length >100){
						posLenFlag = false;
					}
					if(serialNumber.length >100){
						posLenFlag = false;
					}
				}else if (payMethodCd == '110102'){
					olpos = true;
				}
			}
		});
		if(!remakrFlag){
			$.alert("提示信息","请填写修改原因");
			return false ;
		}
		if(!posNvlFlag){
			$.alert("提示信息","pos流水号或者终端号不能为空，请重新输入！");
			return false ;
		}
		if(!posLenFlag){
			$.alert("提示信息","pos流水号或者终端号长度超过100位，请重新输入！");
			return false ;
		}
		
		_chargeItems=[];
		_buildChargeItems();
		return true ;
	};
	var _buildChargeItems = function(){
		$("#calTab tbody tr").each(function() {
			var val = $(this).attr("id");
			if(val!=undefined&&val!=''){
				val=val.substr(5,val.length);
				var realmoney=($("#realAmount_"+val).val())*100+'';
				var amount=$("#feeAmount_"+val).val();
				var feeAmount="";
				if(amount!=undefined&&amount!=''){
					feeAmount=amount+'';
				}else{
					feeAmount=realmoney;
				}
				if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
					feeAmount = $("#feeAmount_"+val).val()*1+'';
					realmoney = (0-($("#backAmount_"+val).val())*100)+'';
					//realmoney = (parseInt(feeAmount) + parseInt(realmoney))+'';
					//alert("feeAmount="+feeAmount+"||realmoney="+realmoney);
				}
				var acctItemTypeId=$("#acctItemTypeId_"+val).val();
				var objId=$("#objId_"+val).val();
				var objType=$("#objType_"+val).val();
				var acctItemId=$("#acctItemId_"+val).val();
				var boId=$("#boId_"+val).val();
				var payMethodCd=$("#payMethodCd_"+val).val();
				var objInstId=$("#objInstId_"+val).val();
				var prodId=$("#prodId_"+val).val();
				var boActionType=$("#boActionType_"+val).val();
				var paymentAmount = $("#paymentAmount_"+val).val();
				var chargeModifyReasonCd = 1 ;
				var remark="";
				if($("#chargeModifyReasonCd_"+val).is(":hidden")){
					if(feeAmount!=realmoney){
						remark="其他";
					}
				}else{
					chargeModifyReasonCd = $("#chargeModifyReasonCd_"+val).val();
					remark=$('#chargeModifyReasonCd_'+val).find("option:selected").text();
					if(chargeModifyReasonCd=="1"){
						remark = $("#remark_"+val).val();
					}
				}
				var terminalNumber = "";
				var serialNumber = "";
				if(payMethodCd == '110101'){
					 terminalNumber=$("#terminalNumber").val();
					 serialNumber=$("#serialNumber").val();
				}
				
				var param={"realAmount":realmoney,
						"feeAmount":feeAmount,
						"paymentAmount":paymentAmount,
						"acctItemTypeId":acctItemTypeId,
						"objId":objId,
						"objType":objType,
						"acctItemId":acctItemId,
						"boId":boId,
						"prodId":prodId,
						"objInstId":objInstId,
						"payMethodCd":payMethodCd,
						"terminalNo":terminalNumber,
						"posSeriaNbr":serialNumber,
						"chargeModifyReasonCd":chargeModifyReasonCd,
						"remark":remark,
						"boActionType":boActionType
				};
				_chargeItems.push(param);
			}
		});
	};
	var _selectChangePayMethodCd=function(trid){
		var methodCd=$("#changeMethod_"+trid).val();
		$("#payMethodCd_"+trid).val(methodCd);
	};
	//调用接口，判断用户是否可以修改金额，并加载付费类型
	var _queryPayMethodByItem = function(itemTypeId,trid,defmethod){
		var params={"acctItemTypeId":itemTypeId};
		var url=contextPath+"/order/queryPayMethodByItem";
		
		var response = $.callServiceAsJson(url, params);
		if (response.code == 0) {
			if(response.data!=undefined&&response.data!=null){
				if(response.data.length>0){
					var items=response.data;
					var flag=false;
					if(OrderInfo.actionFlag==11){//撤单
						if(items[0].limitChange=="N"){
							if(defmethod=="110102"){//在线pos
								flag = false;
							}else{
								return true ;
							}
						}
					}else if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){//返销
						if(items[0].limitBuyBack=="N"){
							return true ;
						}
					}else if(OrderInfo.actionFlag==15){
						if(items[0].limitRedo=="N"){
							flag=true;
						}
					}else{
						if(items[0].limitChange=="N"){
							flag=true;
						}
					}
					//if(OrderInfo.actionFlag!=19&&OrderInfo.actionFlag!=20&&OrderInfo.actionFlag!=15){
						var methodsInfo=items[0].payMethods;
						if(methodsInfo.length>0){
							if(trid){
								var id="'"+trid+"'";
								var html='<select class=\'txt_cal_edit\' id="changeMethod_'+trid+'" style="border: 1px solid #DCDCDC;height: 23px;line-height: 23px;padding: 1px; width: 120px;" onchange="order.calcharge.selectChangePayMethodCd('+id+')">';
								$.each(methodsInfo,function(i,method){
									if(method.payMethodCd==defmethod){
										html+='<option value="'+method.payMethodCd+'" selected="selected">'+method.payMethodName+'</option>';
									}else if(OrderInfo.actionFlag==11 && defmethod=="110102"){
										if(method.payMethodCd=="100000"){
											html+='<option value="'+method.payMethodCd+'">'+method.payMethodName+'</option>';
										}
									}else{
										html+='<option value="'+method.payMethodCd+'">'+method.payMethodName+'</option>';
									}
								});
								html+='</select>';
								$("#payMethodText_"+trid).html(html);
								
								_posPayMethodIofo.push({trid:trid,payMethod:methodsInfo[0].payMethodCd});
								//pos终端号等输入框在付费方式修改成离线pos时显示（有一项收费项使用离线pos就显示该输入框）
								$("#changeMethod_"+trid).off("change").on("change",function(){
									for(var i=0;i<_posPayMethodIofo.length;i++){
										if(_posPayMethodIofo[i].trid == trid){
											_posPayMethodIofo[i].payMethod = $(this).val();
											break;
										}
									}
									var _posPayMethodCount = 0;
									for(var i=0;i<_posPayMethodIofo.length;i++){
										if(_posPayMethodIofo[i].payMethod == '110101'){  //pos
											_posPayMethodCount ++;
										}
									}
									if(_posPayMethodCount > 0){ //至少有一个费用项选择使用离线pos支付方式
										$("#posDiv").css("display","inline");
										$("#posDiv").css("disabled","");
									} else{
										$("#posDiv").css("display","none");
										$("#posDiv").css("disabled","disabled");
									}
								});
							}
						}
					//}
					return flag ;
					
				}else{
					return false;
				}
			}else{
				return false;
			}
		}else if (response.code == -2) {
			$.alertM(response.data);
			return false ;
		}else{
			$.alert("提示","查询付费方式失败!");
			return false ;
		}
		
		
		
	};
	
	var _bindChargeModifyReason = function(trid){
		if($("#chargeModifyReasonCd_"+trid).val()=="1"){
			$("#remark_"+trid).css("display","inline");
		}else{
			$("#remark_"+trid).css("display","none");
		}
	};
	
	var _changePayMethod=function(itemTypeId,trid,defmethod,obj){
		var flag = _queryPayMethodByItem(itemTypeId,trid,defmethod);
		if(flag){
			if(_queryAuthenticDataRange(trid)){
			//$("#chargeModifyReasonCd_"+trid).show();
			//$("#remark_"+trid).hide();chargeModifyReasonCd
				$("#chargeModifyReasonCd_"+trid).off("change").on("change",function(){
					if($(this).val()=="1"){
						$("#remark_"+trid).css("display","inline");
					}else{
						$("#remark_"+trid).css("display","none");
					}
				});
				if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20||OrderInfo.actionFlag==15){//撤单，返销，补退费
					$("#backAmount_"+trid).removeAttr("disabled").css("border","1px solid #DCDCDC").focus() ;
				}else{
					$("#realAmount_"+trid).removeAttr("disabled").css("border","1px solid #DCDCDC").focus() ;
				}
			}
			
		}
		
		$(obj).removeAttr("onclick").removeClass("money_edit").addClass("money_edit_gray");
	};
	
	var _queryAuthenticDataRange = function(trid){
		var params={};
		var url=contextPath+"/order/queryAuthenticDataRange";
		var response = $.callServiceAsJson(url, params);
		if (response.code == 0) {
			var dataRanges = response.data;
			var flag = false;
			for(var i=0;i<dataRanges.length;i++){
				if($("#acctItemTypeId_"+trid).val()==dataRanges[i].dataDimensionName){
					flag = true;
					break;
				}else{
					flag = false;
				}
			}
			if(flag){
				return true;
			}else{
				$.alert("提示","当前费用项不允许修改!");
				return false;
			}
		}else if (response.code == -2) {
			$.alertM(response.data);
			return false ;
		}else{
			$.alert("提示","权限数据范围查询失败!");
			return false ;
		}
	}
	
	var _commitParam=function(val){
		var realmoney=($("#realAmount_"+val).val())*100+'';
		var amount=$("#feeAmount_"+val).val();
		var feeAmount="";
		if(amount!=undefined&&amount!=''){
			feeAmount=amount+'';
		}else{
			feeAmount=realmoney;
		}
		var acctItemTypeId=$("#acctItemTypeId_"+val).val();
		var objId=$("#objId_"+val).val();
		var objType=$("#objType_"+val).val();
		var acctItemId=$("#acctItemId_"+val).val();
		var acctItemTypeName=$("#acctItemTypeName_"+val).val();
		var paymentAmount = $("#paymentAmount_"+val).val();
		var param2={"realmoney":realmoney,
				"feeAmount":feeAmount,
				"paymentAmount":paymentAmount,
				"acctItemTypeId":acctItemTypeId,
				"objId":objId,
				"objType":objType,
				"acctItemId":acctItemId,
				"acctItemTypeName":acctItemTypeName
		};
		_prints.push(param2);
	};
	var _editMoney=function(obj,val,str){//obj:对象,val:id,str:类型
		var cash=$.trim($(obj).val());//当前费用
		if(cash==''){
			$(obj).val('0');
			order.calcharge.reflashTotal();
		}else{
			if(str=="old"){//修改费用
				var amount=$("#feeAmount_"+val).val();
				var check = true ;
				if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(cash)){
			  		$.alert("提示","费用金额请输入数字，最高保留两位小数！");
			  		check = false ;
				}else if((cash*100>amount*1)&&cash>0){
					$.alert("提示","实收费用金额不能高于应收金额！");
					check = false ;
				}else if((cash*100<amount*1)&&cash<0){
					$.alert("提示","实收费用金额不能低于应收金额！");
					check = false ;
				}
				if(check){
					var real=($(obj).val())*100;
		  			if(real!=amount){
		  				$("#chargeModifyReasonCd_"+val).show();
					}else{
						$("#chargeModifyReasonCd_"+val).hide();
						$("#remark_"+val).hide();
					}
					_reflashTotal();
				}else{
					if(money!=''){
			  			$(obj).val(money);
			  		}
			  		money="";
				}
			}else if(str=="undo"){//退费：撤单和返销
				var check = true ;
				if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(cash)){//金额非数字，恢复金额
			  		$.alert("提示","费用金额请输入数字，最高保留两位小数！");
			  		check = false ;
				}else{
					if(cash<0){//退费金额 不能填负值
						$.alert("提示","退费金额不能为负值！");
						check = false ;
					}else{
						var amount=$("#realhidden_"+val).val();
						var v_cash = cash*-1 ;
						if(v_cash<amount*1){//要退-100，不能退120
							$.alert("提示","退费金额不能高于实收金额！");
							check = false ;
						}
					}
				}
				if(check){
					var real=($(obj).val())*-1;
					var amount=$("#realhidden_"+val).val();
					if(real!=0){
		  				$("#chargeModifyReasonCd_"+val).show();
					}else{
						$("#chargeModifyReasonCd_"+val).hide();
						$("#remark_"+val).hide();
					}
					_reflashTotal();
				}else{
					if(money!=''){
			  			$(obj).val(money);
			  		}
			  		money="";
				}
			}else if(str=="new"){//新增费用
				if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(cash)){
			  		$.alert("提示","费用金额请输入数字，最高保留两位小数！");
			  		if(money!=''){
			  			$(obj).val(money);
			  		}
			  		money="";
				}else if(cash<0){//
					$.alert("提示","实收费用金额不能为负值！");
				}else{
					_reflashTotal();
				}
			}
		}
	};
	var _setGlobeMoney=function(obj){
		money=$.trim($(obj).val());
	};
	var _disableButton=function(){
		$("#toCharge").removeClass("btna_o").addClass("btna_g");
		$("#toComplate").removeClass("btna_o").addClass("btna_g");
		$("#orderCancel").removeClass("btna_o").addClass("btna_g");
		$("#orderCancel").off("click");
		$("#toComplate").off("click");
		$("#toCharge").off("click");
	};
	var _conBtns=function(){
		$("#orderCancel").removeClass("btna_g").addClass("btna_o");
		var val=($('#realmoney').val())*1;
		if(OrderInfo.actionFlag==11){
			$("#orderCancel").off("click").on("click",function(event){
				order.undo.orderBack();
			});
		} else if(OrderInfo.actionFlag==35){ //分段受理
			$("#orderCancel").off("click").on("click",function(event){
				stepOrder.main.orderCancel();
			});
		} else{
			$("#orderCancel").off("click").on("click",function(event){
				SoOrder.orderBack();
			});
		}
		
		if(!submit_success){
			if(val!=0){
				$("#toCharge").removeClass("btna_g").addClass("btna_o");
				$("#toComplate").removeClass("btna_o").addClass("btna_g");
				$("#toCharge").off("click").on("click",function(event){
					if(!_pos_paymethod()){
//						$.alert("提示","付费方式为在线POS，不允许撤单，请修改为现金方式！");
						return;
					}
					_updateChargeInfoForCheck('1');
				});
				$("#toComplate").off("click");
			}else{
				$("#toCharge").removeClass("btna_o").addClass("btna_g");
				$("#toComplate").removeClass("btna_g").addClass("btna_o");
				$("#toCharge").off("click");
				$("#toComplate").off("click").on("click",function(event){
					if(!_pos_paymethod()){
						return;
					}
					_chargeSave('0');
				});
			}
		}else{
//			if(val!=0){
//				$("#printInvoiceA").removeClass("btna_g").addClass("btna_o");
//			}else{
//				$("#printInvoiceA").removeClass("btna_o").addClass("btna_g");
//				$("#printInvoiceA").off("click");
//			}
			$("#toCharge").removeClass("btna_o").addClass("btna_g");
			$("#toComplate").removeClass("btna_o").addClass("btna_g");
			$("#toCharge").off("click");
			$("#toComplate").off("click");
		}
	};
	
	var _pos_paymethod = function(){
		var payflag = true;
		$("#calTab tbody tr").each(function() {
			var val = $(this).attr("id");
			if(val!=undefined&&val!=''){
				val=val.substr(5,val.length);
				var payMethodCd=$("#payMethodCd_"+val).val();
				if (payMethodCd == '110102'){
					if(OrderInfo.actionFlag=="11"){
						$.alert("提示","付费方式为在线POS，不允许撤单，请修改为现金方式！");
						payflag = false;
						return;
					}else{
						var posfee = $("#realAmount_"+val).val()*1;
						if(posfee<=0){
							$.alert("提示","在线POS的实收费用金额不能小于等于零，请修改！");
							payflag = false;
							return;
						}
					}
				}
			}
		});
		return payflag;
	};
	
	var _updateChargeInfoForCheck=function(flag){
		_disableButton();
		if(submit_success){
			$.alert("提示","订单已经建档成功,不能重复操作!");
			return;
		}
		if(inOpetate){
			return;
		}
		if(!_submitParam()){
			_conBtns();
			return ;
		}
		inOpetate=true;
		var url=contextPath+"/order/updateChargeInfoForCheck";
		var custid = OrderInfo.cust.custId;
		if(custid==""){
			custid=="-1";
		}
		var params={
				"olId":_olId,
				"soNbr":OrderInfo.order.soNbr,
				"areaId" : OrderInfo.staff.areaId,
				"chargeItems":_chargeItems,
				"custId":custid,
				"olNbr":OrderInfo.orderResult.olNbr
		};
//		alert("?result="+JSON.stringify(_chargeItems)+"&olId="+_olId+"&soNbr="+OrderInfo.order.soNbr);
		$.callServiceAsJson(url,params, {
			"before":function(){
				$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>");
			},"always":function(){
				$.unecOverlay();
			},	
			"done" : function(response){
				if (response.code == 0) {
					if(olpos && queryConstConfig(null,2)){
						if(response.data==undefined || response.data=="undefined"){
							$.alert("提示","在线POS地址未配置！");
							return;
						}
						_toolpos();
						var src=response.data+"?result="+base64encode(utf16to8(JSON.stringify(_chargeItems)))+"&olId="+base64encode(utf16to8(_olId))+"&soNbr="+base64encode(utf16to8(OrderInfo.orderResult.olNbr));
						var vra=document.createElement('a');
				        vra.target='_blank';
				        vra.href=src;
				        document.body.appendChild(vra);
				        vra.click();
					}else{
						_chargeSave(flag);
					}
				}else if (response.code == -2) {
					_conBtns();
					inOpetate=false;
					$.alertM(response.data);
				}else{
					_conBtns();
					inOpetate=false;
					if(response.data!=undefined){
						$.alert("提示",response.data);
					}else{
						$.alert("提示","代理商保证金校验失败!");
					}
				}
			}
		});
	};
	
	var _toolpos = function(){
		submit_success=true;
		//受理成功，不再取消订单
		SoOrder.delOrderFin();
		if(OrderInfo.actionFlag==31){//改产品密码，则将session中密码重置，用户需要重新输入密码
			var url=contextPath+"/cust/passwordReset";
			var response2 = $.callServiceAsJson(url, null, {});
		}
		$("#orderCancel").removeClass("btna_g").addClass("btna_o");
		$("#printVoucherA").removeClass("btna_o").addClass("btna_g").off("click");
		if($("#printVoucherLoc").length > 0){
			$("#printVoucherLoc").removeClass("btna_o").addClass("btna_g").off("click");
		}
		//移除费用新增、费用修改按钮
		$(".charge_add").remove();
		//禁用费用项修改框
		$(".cash_inp_dis").attr("disabled","disabled");
		if(OrderInfo.actionFlag==11){
			$("#orderCancel").html("<span>返回首页</span>");
			$("#orderCancel").off("click").on("click",function(event){
				order.undo.toUndoMain(1);
			});
		}else if(OrderInfo.actionFlag==35){ //分段受理
			$("#orderCancel span").html("继续受理");
			$("#orderCancel").off("click").on("click",function(event){
				stepOrder.main.orderBack();
			}).show();
		}else{
			//将订单取消改为继续受理
			//$("#orderCancel span").html("继续受理");
			//$("#orderCancel").off("click").on("click",function(event){_backToEntr();});
			$("#orderCancel").hide();
		}
		SoOrder.updateResState(); //修改UIM，号码状态
//		var src=response.data+"?result="+_chargeItems+"&olId="+_olId+"&soNbr="+OrderInfo.order.soNbr;
		
	}
	
	var _tochargeSubmit=function(orderdata){	
//		if(submit_success){
//			$.alert("提示","订单已经激活,不能重复操作!");
//			return;
//		}
//		if(!_submitParam()){
//			return ;
//		}
		var url=contextPath+"/token/pc/order/checkRuleToProv";
		var params={
				"olId":orderdata.rolId,
				"soNbr":orderdata.rsoNbr,
				"areaId" : OrderInfo.staff.areaId,
				"chargeItems":[]
		};
		$.ecOverlay("<strong>正在下省校验,请稍等会儿....</strong>");
		var response = $.callServiceAsJson(url,params);
		$.unecOverlay();
//			"before":function(){
//				$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>");
//			},"always":function(){
//				$.unecOverlay();
//			},	
//			"done" : function(response){		
		var provCheckResult;				
		if (response.code == 0) {					
			var data = response.data;
			if(data.checkResult!=undefined){
				OrderInfo.checkresult=data.checkResult;		
			}
			provCheckResult = {							
					code : 0				
			};				
		}else{					
			provCheckResult = {							
					code : 1,							
					data : response.data
			};
		}
		return provCheckResult;
//			}
//		});	
	};
	var _chargeSave = function(flag){
		var realmoney = $("#realmoney").val();
		if(realmoney == "0.00"){
			if(!_submitParam()){
				return ;
			}
	    }
		var params={
				"olId":_olId,
				"soNbr":OrderInfo.order.soNbr,
				"areaId" : OrderInfo.staff.areaId,
				"chargeItems":_chargeItems,
				"custOrderAttrs" : []
		};
		if(OrderInfo.actionFlag==35){
			params.custOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.STEP_ORDER_CHARGE_STAFF,  //订单属性--分段受理保存收费员工时增加
				value : OrderInfo.staff.staffCode 
			});
		}
		var url=contextPath+"/token/pc/order/chargeSubmit?token="+OrderInfo.order.token;
		var response=$.callServiceAsJson(url, params, {});
		var msg="";
		if (response.code == 0) {
			submit_success=true;
			//受理成功，不再取消订单
			SoOrder.delOrderFin();
			
			if(OrderInfo.actionFlag==31){//改产品密码，则将session中密码重置，用户需要重新输入密码
				var url=contextPath+"/cust/passwordReset";
				var response2 = $.callServiceAsJson(url, null, {});
			}
			if(flag=='1'){
				if(OrderInfo.actionFlag==11){
					msg="退费成功";
				}else{
					msg="收费成功";
				}
			}else{
				msg="受理成功";
			}	
			$("#orderCancel").removeClass("btna_g").addClass("btna_o");
			$("#printVoucherA").removeClass("btna_o").addClass("btna_g").off("click");
			if($("#printVoucherLoc").length > 0){
				$("#printVoucherLoc").removeClass("btna_o").addClass("btna_g").off("click");
			}
			//移除费用新增、费用修改按钮
			$(".charge_add").remove();
			//禁用费用项修改框
			$(".cash_inp_dis").attr("disabled","disabled");
			if(OrderInfo.actionFlag==11){
				$("#orderCancel").html("<span>返回首页</span>");
				$("#orderCancel").off("click").on("click",function(event){
					order.undo.toUndoMain(1);
				});
			}else if(OrderInfo.actionFlag==35){ //分段受理
				$("#orderCancel span").html("继续受理");
				$("#orderCancel").off("click").on("click",function(event){
					stepOrder.main.orderBack();
				}).show();
			}else{
//						$("#orderCancel").removeClass("btna_o").addClass("btna_g");
//						$("#orderCancel").off("click");
				//将订单取消改为继续受理
				var redirectUri = OrderInfo.provinceInfo.redirectUri;//回调地址
				if(redirectUri != null && redirectUri!=undefined && redirectUri!=""){
					$("#orderCancel span").html("返回省份");
					//$("#orderCancel").off("click").on("click",function(event){_backToEntr();});
					$("#orderCancel").off("click").on("click",function(event){_backToProvince();});	
				}else{
					$("#ordermessage").show();
					$("#ordermessage").html("订单已"+msg);	
					$("#orderCancel").hide();
				}
			}
			//异地补换卡调用订单受理接口在本地存储订单数据
			//alert("DiffPlaceFlag:"+$("#DiffPlaceFlag").val());
			//alert(JSON.stringify(OrderInfo));
			/*屏蔽异地写卡订单记录
			if (OrderInfo.boActionTypeCd == "14" && $("#DiffPlaceFlag").val() == "diff"
				&& OrderInfo.orderData.orderList.orderListInfo.areaId!=OrderInfo.staff.areaId){
				var orderData = OrderInfo.orderData;
				orderData.orderList.orderListInfo.areaId = OrderInfo.staff.areaId;
				orderData.orderList.custOrderList[0].busiOrder[0].areaId = OrderInfo.staff.areaId;
				orderData.orderList.custOrderList[0].busiOrder[0].boActionType.boActionTypeCd = "-10000";
				var result = query.offer.orderSubmitComplete(JSON.stringify(OrderInfo.orderData));
				if (result.resultCode == "0"){
					alert(result.resultMsg);
				}else{
					alert("创建本地订单失败：原因："+result.resultMsg);
				}
			}
			*/
			SoOrder.updateResState(); //修改UIM，号码状态
			//金额不为零，提示收费成功
			if(flag=='1'){
				var realmoney=($('#realmoney').val())*1;
				//费用大于0，才可以打印发票
				if (realmoney > 0) {
					//收费成功，先调初始化发票信息
					var param={
						"soNbr":OrderInfo.order.soNbr,
						"billType" : 0,
						"olId" : _olId,
						"printFlag" : -1,
						"areaId" : OrderInfo.staff.areaId,
						"acctItemIds":[]
					};
					var initResult = common.print.initPrintInfo(param);
					if(!initResult) {
						return;
					}
					//然后提示是否打印发票
					$.confirm("信息提示","收费成功，是否打印发票?",{
						names:["是","否"],
						yesdo:function(){
							var param={
								"soNbr":OrderInfo.order.soNbr,
								"billType" : 0,
								"olId" : _olId,
								"printFlag" : 0,
								"areaId" : OrderInfo.staff.areaId,
								"acctItemIds":[]
							};
							common.print.prepareInvoiceInfo(param);
							return;
						},
						no:function(){
							var redirectUri = OrderInfo.provinceInfo.redirectUri;//回调地址
							if(redirectUri != null && redirectUri!=undefined && redirectUri!=""){
								_backToProvince();
							}
						}
					});
				} else {
					//提示收费成功
					_showFinDialog(flag, msg);
				}
			} else {
				//提示受理完成
				_showFinDialog(flag, msg);
			}
			//将订单取消改为继续受理
//					$("#orderCancel span").html("继续受理");
//					$("#orderCancel").off("click").on("click",function(event){_backToEntr();});
			return;
			
		}else if (response.code == -2) {
			_conBtns();
			SoOrder.getToken();
			inOpetate=false;
			$.alertM(response.data);
		}else{
			_conBtns();
			SoOrder.getToken();
			inOpetate=false;
			if(response.data!=undefined){
				$.alert("提示",response.data);
			}else{
				$.alert("提示","费用信息提交失败!");
			}
		}	
	};
	var _showFinDialog=function(flag, msg){
		var html='<table class="contract_list rule">';
		if(flag=='1'){
			if(OrderInfo.actionFlag==11){
				html+='<thead><tr> <td colspan="2">退费结果</td></tr></thead></table>';
			}else{
				html+='<thead><tr> <td colspan="2">收费结果</td></tr></thead></table>';
			}
		}else{
			html+='<thead><tr> <td colspan="2">受理结果</td></tr></thead></table>';
		}
		html+='<div id="rules_div">';
		html+='<table width="100%" border="0" cellspacing="0" cellpadding="0">';
		html+='<tr>';
		html+='<td align="right"><i class="rule_icon"></i></td>';
		html+='<td><span class="rule_font">'+msg+'</span></td>';
		html+='</tr>';
		html+='</table>';
		html+='</div>';
		easyDialog.open({
			container : 'successTip_dialog'
		});
		$("#successTipContent").html('');
		$("#successTipContent").html(html);
		//$("#successTipclose,#successTip_dialog_cls").off("click").on("click",function(event){easyDialog.close();order.cust.custReset();});
		
		$(".txt_cal_edit").attr("disabled","disabled");
		$(".charge_add").remove();
		
		
		var redirectUri = OrderInfo.provinceInfo.redirectUri;//回调地址
		if(redirectUri != null && redirectUri!="" && redirectUri!=undefined){
			$("#successTip_dialog_comfirm").show();
			$("#successTip_dialog_comfirm").off("click").on("click",function(event){_backToProvince();});		
		}
		
		//返回三个入口
		/*if(OrderInfo.actionFlag==11){
			$("#successTip_dialog_cnt").off("click").on("click",function(event){order.undo.toUndoMain(1);});
		}else{
			$("#successTip_dialog_cnt").off("click").on("click",function(event){_backToEntr();});
		}*/
		if(flag=='1'){
			if(OrderInfo.actionFlag==11){
				$("#successTip_dialog_inv").show();
				$("#successTip_dialog_inv").off("click").on("click",function(event){_invaideInvoice();});
				$("#successTip_dialog_inv").css("margin-left","30px");
				$("#successTip_dialog_cnt").css("margin-left","30px");
			}	
		}
	};
	
	var _showErrorInfo=function(){
		if($('#sumitErrorInfo').is(':hidden')){
			$("#sumitErrorInfo").css("display","");
		}else{
			$("#sumitErrorInfo").css("display","none");
		}
	};
	var _selePaymethod=function(str,obj){
		var selObj =$("#payMethodCd_"+str);
		selObj.empty();
		$("select[@id=backpayMethodCd_"+str+"] option").each(function(){
			var vv=$(this).val();
			if(vv!=undefined){
				var tt=$(this).text();
				if(vv.split("_")[1]==$(obj).val()){
					$("<option value='"+vv.split("_")[0]+"'>"+tt+"</option>").appendTo(selObj);
				}
			}
	    });

	};
	var _backToEntr=function(){
		//如果有easyDialog弹出框，则关闭它
		if ($("#successTip_dialog").is(":visible")) {
			easyDialog.close();			
		}
		
		if (OrderInfo.actionFlag == 17 || OrderInfo.actionFlag == 18) {
			window.location.href = contextPath+"/mktRes/terminal/exchangePrepare";
			return;
		}else if(OrderInfo.actionFlag ==8){
			window.location.href = contextPath+"/cust/mvnoCustCreate";
			return;
		}
		$("#order_confirm,#order_fill_content,#order_tab_panel_content").empty();
		$("#order_prepare").show();
		order.cust.custReset();
		//如果是新建客户，则要重置客户信息
		if(OrderInfo.cust.custId == -1) {
			order.cust.custReset();
		}
	};
	var _calchargeInit=function(){
//		if(OrderInfo.zcd_privilege==0&&OrderInfo.actionFlag!=14&&OrderInfo.actionFlag!=11&&OrderInfo.actionFlag!=13&&OrderInfo.actionFlag!=17&&OrderInfo.actionFlag!=18&&OrderInfo.actionFlag!=35){
//			SoOrder.delOrderFin();
//			_showFinDialog("0", "暂存成功！");
//			return;
//		}
		$("#step1").hide();
		$("#step2").hide();
		$("#step3").show();
		_olId = OrderInfo.orderResult.olId;
		_soNbr = OrderInfo.orderResult.soNbr;
		_chargeItems = [];
		_prints=[];
		num=0;
		money=0;
		submit_success=false;
		inOpetate=false;
		var refundType = "0" ;
		if(OrderInfo.actionFlag==11){
			refundType = "1" ;
		}else if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
			refundType = "2" ;
		}
		var params={
			"olId":_olId,
			'custVipLevel':OrderInfo.cust.vipLevel,
			"actionFlag":OrderInfo.actionFlag,
			"actionTypeName" : encodeURI(OrderInfo.actionTypeName),
			"businessName" : encodeURI(OrderInfo.businessName),
			"olNbr":OrderInfo.orderResult.olNbr,
			"soNbr" : OrderInfo.order.soNbr,
			"refundType":refundType,
			"checkResult":JSON.stringify(OrderInfo.checkresult)
		};
		$.callServiceAsHtmlGet(contextPath+"/token/pc/order/getChargeList?token="+OrderInfo.order.token,params,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				SoOrder.getToken();
				if(response.code != 0) {
					$.alert("提示","算费失败，请稍后重试");
					return;
				}
				if(OrderInfo.provinceInfo.isFee == "1"){//不收费	
					//暂存成功，不再取消订单
					SoOrder.delOrderFin();
					var redirectUri = OrderInfo.provinceInfo.redirectUri;//回调地址
					if(redirectUri == null || redirectUri=="" || redirectUri==undefined){
						$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>订单暂存成功</div>");
						return;
					}
					$.alert("提示","订单暂存成功");
					_backToProvince();			
				}else if(OrderInfo.provinceInfo.isFee == "2"){//收费
					var content$=$("#order_confirm");
					content$.html(response.data).show();				
					//分段受理,如果受理工号和收费工号不是同一个,不展示"订单取消"按钮
					if(OrderInfo.actionFlag==35){
						if($("#orderCancel").attr("stepOrderParam") != 1){
							stepOrder.main.delOrderOperate = false;
							$("#orderCancel").hide();
						} else {
							stepOrder.main.delOrderOperate = true;
						}
					}
					
					if(OrderInfo.actionFlag==1){ 
						$("#buytitle").html("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName);
					}else if(OrderInfo.actionFlag==11){
						$("#buytitle").html("撤单");
						$("#toCharge").html("<span>退费</span>");
					}else if(OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){
						$("#buytitle").html("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName);
					}else if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
						$("#buytitle").html("返销");
						$("#toCharge").html("<span>退费</span>");
					}else{
						$("#buytitle").html("<span>"+OrderInfo.actionTypeName+"</span>");
					}
					$.each($(".cashier_td"),function(){
						var prodId=$(this).attr("id");
						var obj=$(this);
						if($.trim($(this).html())==""&&$("#phoneNumListtbody")!=undefined){
							$.each($("#phoneNumListtbody tr").find("td:eq(0)"),function(){
								 var prodInstId=$(this).attr("prodInstId");
								 var accNbr=$(this).attr("accNbr");
								 var prodName=$(this).attr("productName");
								 if(prodInstId!=undefined&&accNbr!=undefined){
									 if(prodId==prodInstId){
										 obj.html(prodName+"&nbsp;-&nbsp;"+accNbr);
									 }
								 }
							});	
						}
						
					});
				}			
				$("#printVoucherA").off("click").on("click", function(event){
					if(!_submitParam()){
						return ;
					}
					var voucherInfo = {
						"olId":_olId,
						"soNbr":OrderInfo.order.soNbr,
						"busiType":"1",
						"chargeItems":_chargeItems,
						"areaId":OrderInfo.getAreaId()
					};
					if(_getCookie('_session_pad_flag')=='1'){
						common.print.signVoucher(voucherInfo);
					}else{
						if(queryConstConfig(voucherInfo,1)){
							common.print.printVoucher(voucherInfo);
						}else{
							return;
						}
					}
				});
				// 本地打印回执,只有配置无纸化省份才会提供
				$("#printVoucherLoc").off("click").on("click", function(event){
					if(!_submitParam()){
						return ;
					}
					var voucherInfo = {
						"olId":_olId,
						"soNbr":OrderInfo.order.soNbr,
						"busiType":"1",
						"chargeItems":_chargeItems,
						"areaId":OrderInfo.getAreaId()
					};
					common.print.printVoucher(voucherInfo);
				});
				
				_reflashTotal();
			},
			"fail":function(response){
				SoOrder.getToken();
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	var _getCookie = function(name){
		var cookievalue = "";
		var arr = document.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));
		if(arr != null) {
			cookievalue = unescape(arr[2]);
		}
		return cookievalue;
	};
	var _appendTrTd = function(item){
		//补贴金额,赠送话费额 不计入
		if(item.acctItemTypeId == '2090000' || item.acctItemTypeId == '2091000'){
			return '';
		}
		if(item.feeAmount == 0){
			return '';
		}
		var html = "<tr>";
		html += '<td>';
		//先预设打印次数为0
		item.printTimes = 0;
		if(item.printTimes == 0){
			html += '<input type="checkbox" checked="checked" name="acctItem" value="';
		}else{
			html += '<input type="checkbox" disabled="disabled" name="acctItem" value="';
		}
		html += item.acctItemTypeId + '_' + item.objId  + '"/>';
		
		html += '</td>';
		html += '<td style="width: 200px">'+item.acctItemTypeName+'</td>';
		html += '<td>'+ (parseFloat(item.realmoney)/100).toFixed(2)+'</td>';
		html += '</tr>';
		return html;
	};
	


	var _invaideInvoice = function(){
		var params = {"olId":OrderInfo.order.oldSoId,"soNbr":OrderInfo.order.oldSoNbr} ;
		$.callServiceAsHtmlGet(contextPath+"/order/invaideInvoice",params,{
			"before":function(){
				$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code==0){
					//alert(response.data);
					var data = $.parseJSON(response.data) ;
					if(data.code==0){
						//$("#successTip_dialog_inv").removeClass("btna_o").addClass("btna_g");
						$("#successTip_dialog_inv").off("click");
						$.alert("提示","作废发票成功！");	
					}else if(data.code==1){
						$.alert("提示","作废发票失败！");
					}else if(data.code==2){
						$.alert("提示","未获取到发票信息！");
					}else if(data.code==3){
						$.alert("提示","获取发票失败！");
					}else{
						$.alert("提示","作废发票异常！");
					}
				} else if(response.code == -2){
				}else{
					$.alert("提示","作废发票异常！");
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	
	var queryConstConfig=function(voucherInfo,typeClass){
		var isProPrint=false;
		var param={
			typeClass:typeClass,
			queryType:1
		};
		var url=contextPath+"/print/queryConstConfig";
		$.ecOverlay("<strong>正在查询公共数据查询的服务中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data!=undefined){
				if("Y"==response.data.value){
					isProPrint=true;
				}
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return false;
		}else {
			$.alert("提示","查询公共数据查询的服务失败,稍后重试");
			return false;
		}
		if(isProPrint && voucherInfo!=null){//是否使用省里面打印
			voucherInfo.signFlag=3;
		}
		return true;
	};
	
	var _backToProvince=function(){
		var reParams = {
				provIsale:OrderInfo.provinceInfo.provIsale,
				extCustOrderID:OrderInfo.orderResult.olId,
				resultCode:'0',
				redirectUri:OrderInfo.provinceInfo.redirectUri
			};
		$.callServiceAsHtmlGet(contextPath+"/mode/pc/backProvince",reParams,{
			"before":function(){
				$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code==0){								
					var data = $.parseJSON(response.data) ;
					if(data.code==0){
						//判断
						if(data.data.indexOf("&amp;")!=-1){
							data.data=data.data.replace(/\&amp;/g,"&");
						}
						window.location.href = data.data;
						return;						
					}else if(data.code==1){
						$.alert("提示",data.data);
					}
				}else{
					$.alert("提示","页面回调异常！");
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","页面回调可能发生异常，请稍后再试！");
			}
		});	
	};
	
	return {
		addItems:_addItems,
		delItems:_delItems,
		reflashTotal:_reflashTotal,
		editMoney:_editMoney,
		setGlobeMoney:_setGlobeMoney,
		conBtns:_conBtns,
		addbusiOrder:_addbusiOrder,
		addSubmit:_addSubmit,
		selePaymethod:_selePaymethod,
		calchargeInit:_calchargeInit,
		showErrorInfo:_showErrorInfo,
		pageFlag:_pageFlag,
		changePayMethod:_changePayMethod,
		selectChangePayMethodCd:_selectChangePayMethodCd,
		bindChargeModifyReason:_bindChargeModifyReason,
		invaideInvoice:_invaideInvoice,
		updateChargeInfoForCheck:_updateChargeInfoForCheck,
		tochargeSubmit:_tochargeSubmit,
		backToEntr:_backToEntr,
		backToProvince:_backToProvince
	};
})();


/**
 * 发展人管理
 * 
 * @author wukf
 * date 2014-01-20
 */
CommonUtils.regNamespace("order","dealer");

/** 发展人对象*/
order.dealer = (function() {
	//初始化发展人
	var _initDealer = function(prodInfo) {
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":"40020005","NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":"40020006","NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":"40020007","NAME":"第三发展人"}];
		}else{
			if(!ec.util.isArray(OrderInfo.order.dealerTypeList)){
				$.ecOverlay("<strong>正在查询发展人类型中,请稍后....</strong>");
				var response = $.callServiceAsJson(contextPath+"/order/queryPartyProfileSpecList",null); //发展人类型查询
				$.unecOverlay();
				if(response.code==0){
					OrderInfo.order.dealerTypeList = response.data;
				}else if(response.code==-2){
					$.alertM(response.data);
					return;
				}else{
					$.alert("信息提示",response.msg);
					return;
				}
			}
			if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){
				OrderInfo.getChannelList();
			}
		}
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==2 || OrderInfo.actionFlag==14){ //新装业务，套餐变更需要主套餐发展人
			var objInstId = OrderInfo.offerSpec.offerSpecId;
			var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
			var $tdType = $('<td></td>');
			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
			if(order.ysl!=undefined){
				$select.append("<option value='40020005'>第一发展人</option>");
				$select.append("<option value='40020006'>第二发展人</option>");
				$select.append("<option value='40020007'>第三发展人</option>");
			}else{
				$.each(OrderInfo.order.dealerTypeList,function(){
					$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
				});
			}
			$tdType.append($select);
			$tdType.append('<label class="f_red">*</label>');
			var accNbr = "主套餐";
			$tr.append("<td>"+accNbr+"</td>");
			$tr.append("<td>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</td>");
			$tr.append($tdType);
			if(order.ysl!=undefined){
				var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px"></input></td>');
			}else{
				var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');
			}
			$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
			$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
			$tr.append($td);
			var $tdChannel = $('<td></td>');
			var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
			$.each(OrderInfo.channelList,function(){
				if(this.isSelect==1)
					$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
				else
					$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
			});
			$tdChannel.append($channelSelect);
			$tdChannel.append('<label class="f_red">*</label>');	
			$tr.append($tdChannel);
			OrderInfo.SEQ.dealerSeq++;
			$("#dealerTbody").append($tr);
			if(offerChange.newMemberFlag){
				$.each(OrderInfo.offerSpec.offerRoles,function(){
		    		$.each(this.prodInsts,function(){
		    			var _prodInstId = "'"+this.prodInstId+"'";
						if(_prodInstId.indexOf("-") != -1){
							var objInstId = this.prodInstId;
			    			var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
			    			var $tdType = $('<td></td>');
			    			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
			    			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
			    			$.each(OrderInfo.order.dealerTypeList,function(){
			    				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			    			});
			    			$tdType.append($select);
							$tdType.append('<label class="f_red">*</label>');
			    			//$tr.append("<td>"+CONST.EVENT.PROD_NEW+"</td>");
							var accNbr = "未选号";
							if(this.accNbr!=undefined && this.accNbr!=""){
								accNbr = prodInst.accNbr;
							}
			    			$tr.append("<td>"+accNbr+"</td>");
							$tr.append("<td>"+this.objName+"</td>");
							$tr.append($tdType);
							var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');
							$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
							$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
							$tr.append($td);
							var $tdChannel = $('<td></td>');
							var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px"  onclick=a=this.value;></select>');
							$.each(OrderInfo.channelList,function(){
								if(this.isSelect==1)
									$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
								else
									$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
							});
							$tdChannel.append($channelSelect);
							$tdChannel.append('<label class="f_red">*</label>');	
							$tr.append($tdChannel);
							OrderInfo.SEQ.dealerSeq++;
							$("#dealerTbody").append($tr);
			    		}
		    		});
		    	});
			}
		}
		if(OrderInfo.actionFlag==6 ){ //加装需要接入产发展人
//			if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//纳入老用户的发展人
//				var prodInfo = OrderInfo.oldprodInstInfos;
//				var objInstId = prodInfo.prodInstId;
//    			var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
//    			var $tdType = $('<td></td>');
//    			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
//    			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
//    			$.each(OrderInfo.order.dealerTypeList,function(){
//    				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
//    			});
//    			$tdType.append($select);
//				$tdType.append('<label class="f_red">*</label>');
//    			//$tr.append("<td>"+CONST.EVENT.PROD_NEW+"</td>");
//				var accNbr = "未选号";
//				if(prodInfo.accNbr!=undefined && prodInfo.accNbr!=""){
//					accNbr = prodInfo.accNbr;
//				}
//    			$tr.append("<td>"+accNbr+"</td>");
//				$tr.append("<td>移动电话（仅含本地语音）</td>");
//				$tr.append($tdType);
//				var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');
//				$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
//				$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
//				$tr.append($td);
//				OrderInfo.SEQ.dealerSeq++;
//				$("#dealerTbody").append($tr);
			if(order.memberChange.newMemberFlag){
				$.each(OrderInfo.offerSpec.offerRoles,function(){
		    		$.each(this.prodInsts,function(){
		    			var objInstId = this.prodInstId;
		    			var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
		    			var $tdType = $('<td></td>');
		    			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
		    			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		    			$.each(OrderInfo.order.dealerTypeList,function(){
		    				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
		    			});
		    			$tdType.append($select);
						$tdType.append('<label class="f_red">*</label>');
		    			//$tr.append("<td>"+CONST.EVENT.PROD_NEW+"</td>");
						var accNbr = "未选号";
						if(this.accNbr!=undefined && this.accNbr!=""){
							accNbr = prodInst.accNbr;
						}
		    			$tr.append("<td>"+accNbr+"</td>");
						$tr.append("<td>"+this.objName+"</td>");
						$tr.append($tdType);
						var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');
						$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
						$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
						$tr.append($td);
						var $tdChannel = $('<td></td>');
						var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px"  onclick=a=this.value;></select>');
						$.each(OrderInfo.channelList,function(){
							if(this.isSelect==1)
								$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
							else
								$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
						});
						$tdChannel.append($channelSelect);
						$tdChannel.append('<label class="f_red">*</label>');	
						$tr.append($tdChannel);
						OrderInfo.SEQ.dealerSeq++;
						$("#dealerTbody").append($tr);
		    		});
		    	});
			}
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					var objInstId = this.offerSpecId;
					var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
					var $tdType = $('<td></td>');
					var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
					var flag = true;
					$.each(OrderInfo.order.dealerTypeList,function(){
						var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
						$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
							if(dealerTypeId==$(this).val()){  //如果已经存在
								flag = false;
							}
						});
					});
					if(!flag){
						return;
					}
					var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
					if(order.ysl!=undefined){
						$select.append("<option value='40020005'>第一发展人</option>");
						$select.append("<option value='40020006'>第二发展人</option>");
						$select.append("<option value='40020007'>第三发展人</option>");
					}else{
						$.each(OrderInfo.order.dealerTypeList,function(){
							$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
						});
					}
					$tdType.append($select);
					$tdType.append('<label class="f_red">*</label>');
					var accNbr = "主套餐";
					$tr.append("<td>"+accNbr+"</td>");
					$tr.append("<td>"+this.offerSpecName+"（包含接入产品）</td>");
					$tr.append($tdType);
					if(order.ysl!=undefined){
						var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px"></input></td>');
					}else{
						var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');
					}
					$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
					$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
					$tr.append($td);
					var $tdChannel = $('<td></td>');
					var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px"  onclick=a=this.value;></select>');
					$.each(OrderInfo.channelList,function(){
						if(this.isSelect==1)
							$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
						else
							$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
					});
					$tdChannel.append($channelSelect);
					$tdChannel.append('<label class="f_red">*</label>');	
					$tr.append($tdChannel);
					OrderInfo.SEQ.dealerSeq++;
					$("#dealerTbody").append($tr);
				});
			}
		}
		if(OrderInfo.actionFlag==13){ //裸机销售需要发展人
			var objInstId = $("#mktResId").val();
			var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
			var $tdType = $('<td></td>');
			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
			$.each(OrderInfo.order.dealerTypeList,function(){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			});
			$tdType.append($select);
			$tdType.append('<label class="f_red">*</label>');
			$tr.append($tdType);
			var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');
			$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
			$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
			$tr.append($td);
			OrderInfo.SEQ.dealerSeq++;
			$("#dealerMktTbody").append($tr);
		}
		if(OrderInfo.actionFlag==36){ //一卡双号订购发展人
			var objInstId = OrderInfo.orderAccNbr;
			var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
			var $tdType = $('<td></td>');
			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
			if(order.ysl!=undefined){
				$select.append("<option value='40020005'>第一发展人</option>");
				$select.append("<option value='40020006'>第二发展人</option>");
				$select.append("<option value='40020007'>第三发展人</option>");
			}else{
				$.each(OrderInfo.order.dealerTypeList,function(){
					$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
				});
			}
			$tdType.append($select);
			$tdType.append('<label class="f_red">*</label>');
			var accNbr = OrderInfo.orderAccNbr;
			$tr.append("<td>"+accNbr+"</td>");
			$tr.append("<td>一卡双号订购</td>");
			$tr.append($tdType);
			if(order.ysl!=undefined){
				var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px"></input></td>');
			}else{
				var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');
			}
			$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
			$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
			$tr.append($td);
			OrderInfo.SEQ.dealerSeq++;
			$("#dTbody").append($tr);
		}
		if(OrderInfo.actionFlag==21){//副卡套餐变更
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					var objInstId = this.offerSpecId;
					var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
					var $tdType = $('<td></td>');
					var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
					var flag = true;
					$.each(OrderInfo.order.dealerTypeList,function(){
						var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
						$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
							if(dealerTypeId==$(this).val()){  //如果已经存在
								flag = false;
							}
						});
					});
					if(!flag){
						return;
					}
					var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
					if(order.ysl!=undefined){
						$select.append("<option value='40020005'>第一发展人</option>");
						$select.append("<option value='40020006'>第二发展人</option>");
						$select.append("<option value='40020007'>第三发展人</option>");
					}else{
						$.each(OrderInfo.order.dealerTypeList,function(){
							$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
						});
					}
					$tdType.append($select);
					$tdType.append('<label class="f_red">*</label>');
					var accNbr = "主套餐";
					$tr.append("<td>"+accNbr+"</td>");
					$tr.append("<td>"+this.offerSpecName+"（包含接入产品）</td>");
					$tr.append($tdType);
					if(order.ysl!=undefined){
						var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px"></input></td>');
					}else{
						var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');
					}
					$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
					$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
					$tr.append($td);
					OrderInfo.SEQ.dealerSeq++;
					$("#dealerTbody").append($tr);
				});
			}
		}
	};
	
	//修改发展人角色
	var _changeDealer = function(select,objInstId,value){
		var i = 0;
		$("select[name="+objInstId+"]").each(function(){
			if($(this).val() == $(select).val()){
				i++;
			}
		});
		if(i>1){
			$.alert("信息提示","每个业务的发展人类型不能重复");
			$(select).val(value);
		}
	};
	
	//点击确认，添加附属销售品发展人
	var _addAttachDealer = function(){
		$("input[name=attach_dealer]:checked").each(function(){	
			var id = $(this).attr("id");	
			var prodId = id.split("_")[0];
			if($("#tr_"+id)[0]==undefined){ //没有添加过
				var objId = id+"_"+OrderInfo.SEQ.dealerSeq;
				var $tdType = _getDealerType(id,objId);
				if($tdType==undefined){
					return false;
				}
				var $tr = $("#atr_"+id);
				var $newTr = $('<tr name="tr_'+id+'"></tr>');
				$newTr.append("<td>"+$tr.children().eq(1).text()+"</td>");
				$newTr.append("<td>"+$tr.children().eq(2).text()+"</td>");
				$newTr.append($tdType);
				
				var dealer = $("#tr_"+prodId).find("input"); //产品协销人
				var staffId = 1;
				var staffName = "";
				if(dealer[0]==undefined){
					staffId = OrderInfo.staff.staffId;
					staffName = OrderInfo.staff.staffName;
				}else {
					staffId = dealer.attr("staffId");
					staffName = dealer.attr("value");
				}
				if(order.ysl!=undefined){
					var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" style="margin-left:45px;"></input></td>');
				}else{
					var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>');
				}
				$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');	
				$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
				$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+id+'\')">添加</a><label class="f_red">*</label>');
				$newTr.append($td);
				var $tdChannel = $('<td></td>');
				var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+id+'" class="inputWidth183px" onclick=a=this.value;></select>');
				OrderInfo.getChannelList();
				$.each(OrderInfo.channelList,function(){
					if(this.isSelect==1)
						$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
					else
						$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
				});
				$tdChannel.append($channelSelect);
				$tdChannel.append('<label class="f_red">*</label>');	
				$newTr.append($tdChannel);
				$("#dealerTbody").append($newTr);
				OrderInfo.SEQ.dealerSeq++;
			}	
		});
		easyDialog.close();
	};
	
	//添加一行产品协销人
	var _addProdDealer = function(obj,objInstId,type){
		var $oldTr = $(obj).parent().parent();
		var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
		var $tdType = _getDealerType(objInstId,objId);
		if($tdType==undefined){
			return;
		}
		var $tr = $('<tr name="tr_'+objInstId+'"></tr>');
		/*if(type==1){
			$tr.append("<td>"+CONST.EVENT.PROD_NEW+"</td>");
		}else{
			$tr.append("<td>"+CONST.EVENT.OFFER_BUY+"</td>");
		}*/
		if (OrderInfo.actionFlag != 13) {
			$tr.append("<td>"+$oldTr.find("td").eq(0).text()+"</td>");
			$tr.append("<td>"+$oldTr.find("td").eq(1).text()+"</td>");
		}
		$tr.append($tdType);
		if(order.ysl!=undefined){
			var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+objInstId+'" staffId="'+$oldTr.find("input").attr("staffId")+'" value="'+$oldTr.find("input").attr("value")+'" class="inputWidth183px" ></input></td>');
		}else{
			var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+objInstId+'" staffId="'+$oldTr.find("input").attr("staffId")+'" value="'+$oldTr.find("input").attr("value")+'" class="inputWidth183px" readonly="readonly" ></input></td>');
		}
		$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
		$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');
		/*if(type==1){
			$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');
		}else{
			$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
			$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+')">添加</a><label class="f_red">*</label>');
		}*/
		$tr.append($td);	
		$oldTr.after($tr);
		OrderInfo.SEQ.dealerSeq++;
	};
	
	//改变发展人号码
	var _changeAccNbr = function(prodId,accNbr){
		$("tr[name^='tr_"+prodId+"']").each(function(){
			$(this).find("td").eq(0).text(accNbr);
		});
	};
	
	//校验发展人类型,并获取发展人类型列表
	var _getDealerType = function(objInstId,objId){
		var dealerType = "";
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":40020005,"NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":40020006,"NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":40020007,"NAME":"第三发展人"}];
		}
		if(OrderInfo.order.dealerTypeList!=undefined && OrderInfo.order.dealerTypeList.length>0){ //发展人类型列表
			$.each(OrderInfo.order.dealerTypeList,function(){
				var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
				var flag = true;
				$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
					if(dealerTypeId==$(this).val()){  //如果已经存在
						flag = false;
						return false;
					}
				});
				if(flag){ //如果发展人类型没有重复
					dealerType = dealerTypeId;
					return false;
				}
			});
		}else{
			$.alert("信息提示","没有发展人类型");
			return;
		}
		if(dealerType==undefined || dealerType==""){	
			$.alert("信息提示","每个业务发展人类型不能重复");
			return;
		}
		var $td = $('<td></td>'); //发展人类型
		var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		$.each(OrderInfo.order.dealerTypeList,function(){
			if(this.PARTYPRODUCTRELAROLECD==dealerType){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>");
			}else{
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			}
		});
		$td.append($select);
		$td.append('<label class="f_red">*</label>');
		return $td;
	};
	
	//显示已经受理的业务列表
	var _showOfferList = function(){	
		$('#attach_tbody').empty();
		//主销售品
		/*if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 14 || OrderInfo.actionFlag == 2){
			var id = OrderInfo.offerSpec.offerSpecId;
			if($("tr[name='tr_"+id+"']")[0]==undefined){
				var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"></tr>');
				$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td>');
				$tr.append('<td>主套餐</td><td>'+OrderInfo.offerSpec.offerSpecName+'</td>');
				$('#attach_tbody').append($tr);
			}
		}*/
		//接入产品
		/*if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 14){
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				$.each(this.prodInsts,function(){
					var accNbr = "未选号";
					if(this.accNbr!=undefined && this.accNbr!=""){
						accNbr = prodInst.accNbr;
					}
					var id = this.prodInstId;
					var accNbr = OrderInfo.getProdAn(id).accessNumber;
					if(accNbr==undefined || accNbr==""){ 
						accNbr = "未选号";
					}
					if($("tr[name='tr_"+id+"']")[0]==undefined){
						var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')">');
						$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td></tr>');
						$tr.append('<td>'+accNbr+'</td><td>'+this.objName+'</td>');
						$('#attach_tbody').append($tr);
					}
				});
			});
		}*/
		//可选包
		$.each(AttachOffer.openList,function(){
			var prodId = this.prodId;
			var accNbr = "";
			if(OrderInfo.actionFlag==6){
				accNbr = OrderInfo.getAccessNumber(prodId);
				for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
					if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
						accNbr = OrderInfo.oldprodInstInfos[i].accNbr;
					}
				}
			}else{
				accNbr = OrderInfo.getAccessNumber(prodId);
			}
			if(accNbr==undefined || accNbr==""){ 
				accNbr = "未选号";
			}
			$.each(this.specList,function(){
				var id = prodId+'_'+this.offerSpecId;
				if(this.isdel != "Y" && this.isdel != "C" && $("tr[name='tr_"+id+"']")[0]==undefined){  //订购的附属销售品	
					var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"></tr>');
					//var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"><td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td></tr>');
					$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td>');
					$tr.append('<td>'+accNbr+'</td><td>'+this.offerSpecName+'</td>');
					$('#attach_tbody').append($tr);
				};
			});
		});
		
		//预受理
		if(order.ysl!=undefined){
			if(order.ysl.yslbean.yslflag!=undefined){
				for (var j = 0; j < order.ysl.openList.length; j++) {
					if(order.ysl.openList[j].type=="1"){
						var prodId = "-1";
						var accNbr = $("#choosedNumSpan").val();
						if(accNbr==undefined || accNbr==""){ 
							accNbr = "未选号";
						}
						var dealerchecked = "N";
						var dealertr = $("#dealerTbody").find("tr");
						dealertr.each(function(){
							if($(this).attr("name")=="tr_-1_"+order.ysl.openList[j].id){
								dealerchecked = "Y";
							}else{
								dealerchecked = "N";
							}
						});
						if(dealerchecked=="N"){
							var id = prodId+'_'+order.ysl.openList[j].id;
							var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"></tr>');
							$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td>');
							$tr.append('<td>'+accNbr+'</td><td>'+order.ysl.openList[j].name+'</td>');
							$('#attach_tbody').append($tr);
						}
					}
				}
			}
		}
		//功能产品
		/*$.each(AttachOffer.openServList,function(){
			var prodId = this.prodId;
			var accNbr = OrderInfo.getAccessNumber(prodId);
			if(accNbr==undefined || accNbr==""){ 
				accNbr = "未选号";
			}
			$.each(this.servSpecList,function(){
				var id = prodId+'_'+this.servSpecId;
				if(this.isdel != "Y" && this.isdel != "C"  && $("tr[name='tr_"+id+"']")[0]==undefined){  //订购的附属销售品
					var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"><td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td></tr>');
					$tr.append('<td>'+accNbr+'</td><td>'+this.servSpecName+'</td>');
					$('#attach_tbody').append($tr);
				};
			});
		});*/
		easyDialog.open({
			container : "div_attach_dialog"
		});
	};
	
	//勾选一个附属
	var _checkAttach = function(id){
		var tr = $("#atr_"+id);
		var checkbox = $("#"+id);
		if(checkbox.attr("checked")=="checked"){
			tr.removeClass("plan_select");
			checkbox.attr("checked", false);
		}else {
			tr.addClass("plan_select");
			checkbox.attr("checked", true);
		}
	};
	
	//删除协销人
	var _removeDealer = function(obj){
		$(obj).parent().parent().remove();
	};
	
	//删除协销人
	var _removeAttDealer = function(id){
		$("tr[name^='tr_"+id+"']").each(function(){
			$(this).remove();
		});
	};
	
	return {
		initDealer 			: _initDealer,
		changeAccNbr		: _changeAccNbr,
		showOfferList		: _showOfferList,
		addProdDealer		: _addProdDealer,
		addAttachDealer		: _addAttachDealer,
		checkAttach			: _checkAttach,
		removeDealer		: _removeDealer,
		removeAttDealer		: _removeAttDealer,
		changeDealer		: _changeDealer
	};
})();

CommonUtils.regNamespace("order", "entrance");

order.entrance = (function(){
	
	//初始化
	var _init = function() {
		_initEvent();
	}
	
	//初始化页面点击事件
	var _initEvent = function() {
		$("#buyOffer").click(function(){
			_buyOffer()
		});
		$("#buyTerminal").click(function(){
			_buyTerminal()
		});
		$("#choosePrettyNumber").click(function(){
			_choosePrettyNumber();
		});
	}
	
	//购套餐
	var _buyOffer = function() {
		if (!_checkIfQueryCust()) {
			return;
		}
	}
	
	//购终端
	var _buyTerminal = function() {
		if (!_checkIfQueryCust()) {
			return;
		}
	}
	
	//挑靓号
	var _choosePrettyNumber = function() {
		if (!_checkIfQueryCust()) {
			return;
		}
	}
	
	var _checkIfQueryCust = function() {
		if (!order.cust.getCustInfo()) {
			$.alert("提示","请先定位客户！");
			return false;
		}
		return true;
	}
	
	return {
		init : _init,
		checkIfQueryCust : _checkIfQueryCust
	}
})()
$(function(){
	order.entrance.init();
})
CommonUtils.regNamespace("order", "memberChange");
order.memberChange = function(){
	var _offerProd={};
	var _memberAddList=[];
	var _ischooseOffer=false;
	var _newMemberFlag = false;
	var _oldMemberFlag = false;
	var _changeMemberFlag = false;
	var _viceCartNum = 0;//纳入老用户副卡总数量
	var maxNum = 0;
	var idnum = 1;
	var _reloadFlag = "";
	var _newSubPhoneNum;
	var _oldSubPhoneNum;
	var _mktResInstCode;
	var _newmembers = {};
	var _oldmembers = {
			objInstId:[]
	};
	var _delmembers = {
			accessNumbers:[]
	};
	var _changemembers = {
			accessNumbers:[]
	};
	var _rejson = {};
	var _viceparams = [];
	var _ooRoless = [];
	
	var _viceCartNum = 0;//纳入老用户副卡总数量[W]
	
	//点击主副卡成员变更跳出一个div
	var _showOfferCfgDialog=function(){
		if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){
			$.alert("提示","停机产品不允许受理！");
			return;
		}
		_memberAddList=[];
		idnum = 1;
		OrderInfo.busitypeflag=3;
		OrderInfo.actionFlag=6;
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldprodAcctInfos = [];
		OrderInfo.oldAddNumList = [];
		OrderInfo.viceOfferSpec=[];
		
		//页面变动
		$("#order_fill_content").empty();
		OrderInfo.order.step=0;//订单初始页面
		order.prepare.hideStep();
		$("#orderedprod").show();
		$("#order_prepare").show();
		$("#order_confirm").hide();
		
		order.prepare.createorderlonger();
		//4G系统判断，如果是3g套餐不能做该业务
		if(CONST.getAppDesc()==0 && order.prodModify.choosedProdInfo.is3G=="Y"){
			$.alert("提示","3G套餐不允许做主副卡成员变更业务！","information");
			return;
		}
		//根据省份来限制纳入老用户入口,开关在portal.properties[W]
		var areaidflag = order.memberChange.areaidJurisdiction();
		//暂存单二次加载
		if(order.memberChange.reloadFlag=="N"){
			if(!queryReOrder()){
				return;
			}
//			order.memberChange.rejson={};
			var custOrderAttrs = order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;
			var busiTypeFlag = true;
			$.each(custOrderAttrs,function(){
				if(this.itemSpecId=="30010024"){
					if(this.value!="3"){
						busiTypeFlag = false;
						return false;
					}
				}
			});
			if(!busiTypeFlag){
				$.alert("提示","不是主副卡成员变更受理流水号，请重试！");
				return;
			}
			var custOrderList = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
			var newsplitflag = 1;
			var oldsplitflag = 1;
			order.memberChange.newSubPhoneNum="";
			order.memberChange.oldSubPhoneNum="";
			$.each(custOrderList,function(){
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="3"){//拆副卡
					order.memberChange.delmembers.flag = true;
					order.memberChange.delmembers.accessNumbers.push({"nbr":this.busiObj.accessNumber});
				}else if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员
					order.memberChange.newmembers.flag = true;
					if(newsplitflag==1){
						order.memberChange.newSubPhoneNum += this.busiObj.accessNumber;
						newsplitflag++;
					}else{
						order.memberChange.newSubPhoneNum += ","+this.busiObj.accessNumber;
					}
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S2"){//纳入老成员
					if(this.busiObj.offerTypeCd=="1"){
						order.memberChange.oldmembers.flag = true;
						if(oldsplitflag==1){
							order.memberChange.oldSubPhoneNum += this.busiObj.accessNumber;
							oldsplitflag++;
						}else{
							order.memberChange.oldSubPhoneNum += ","+this.busiObj.accessNumber;
						}
					}
					var objInstId = this.data.ooRoles[0].objInstId;
					var instId = this.busiObj.instId;
					order.memberChange.oldmembers.objInstId.push({"instId":instId,"objInstId":objInstId});
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="1"){//保留选择新套擦
					order.memberChange.changemembers.flag = true;
					order.memberChange.changemembers.accessNumbers.push({"nbr":this.busiObj.accessNumber,"specId":this.busiObj.objId,"name":this.busiObj.objName});
				}
			});
		}
		var newSubPhoneNumsize=[];
		var oldSubPhoneNumsize=[];
		if(order.memberChange.newSubPhoneNum!=""){
			newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
		}
		if(order.memberChange.oldSubPhoneNum!=""){
			oldSubPhoneNumsize = order.memberChange.oldSubPhoneNum.split(",");
		}
		//查询销售品规格并且保存
		var param = {
			offerSpecId : order.prodModify.choosedProdInfo.prodOfferId, 
			offerTypeCd : 1,
			partyId : OrderInfo.cust.custId
		};
		var offerSpec = query.offer.queryMainOfferSpec(param); //查询主销售品构成
		if(!offerSpec){
			return;
		}
		//根据销售品规格验证是否是主副卡套餐
		var flag = true;
		$.each(offerSpec.offerRoles,function(){
			if (this.memberRoleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD) {
				flag = false;
				return false;
			}
		});
		if(flag){
			$.alert("错误","你选择的套餐不是主副卡套餐，不能进行主副卡成员变更");
			return;
		}
		//查询销售品实例并且保存
		if(OrderInfo.provinceInfo.mergeFlag=="0"){
			if(!query.offer.setOffer()){  
				return;
			}
		}
		//改造中...
		var iflag = 0; //判断是否弹出副卡选择框 false为不选择
		var errorflag = true;
		var $tbody = $("#maincard_member_tbody");
		$tbody.html("");
		$("#main_title").text(OrderInfo.offerSpec.offerSpecName);
		$.each(offerSpec.offerRoles,function(){
			var offerRole = this;
			var $tr = $("<tr style='background:#f8f8f8;'></tr>");
			var $td = $('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'
					+offerRole.offerRoleName+'</span>&nbsp;&nbsp;</td>');
			if(this.memberRoleCd == CONST.MEMBER_ROLE_CD.CONTENT){
				$tr.append($td).append($("<td colspan='3'></td>")).appendTo($tbody);
			}else{
				$tr.append($td).appendTo($tbody);
			}
			/*$.each(this.roleObjs,function(){
				var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
				if(this.objType == CONST.OBJ_TYPE.PROD){
					if(offerRole.minQty == 0){ //加装角色
						this.minQty = 0;
						this.dfQty = 0;
					}
					var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
					$tr.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'>"+
							"<a class='add' href='javascript:order.service.subNum(\""+objInstId+"\","+this.minQty+");'></a>"+
							"<input id='"+objInstId+"' type='text' value='"+this.dfQty+"' class='numberTextBox width22' readonly='readonly'>"+
							"<a class='add2' href='javascript:order.service.addNum(\""+objInstId+"\","+this.maxQty+");'> </a>"+
							"</i>"+this.minQty+"-"+max+"（张） </td>");	
					iflag++;
				}
			});*/
			//销售品规格
			//主卡
			if (offerRole.memberRoleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD) {
				$.each(this.roleObjs,function(){
					if(this.objType == CONST.OBJ_TYPE.PROD){
						//$tr.append("<td align='center' colspan='2'>"+this.objName+":</td>");
						$tr.append("<td align='center' colspan='2' class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>"
								+this.objName+"</span>&nbsp;&nbsp;</td>");
					}
				});
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.offerRoleId==offerRole.offerRoleId && this.objType==CONST.OBJ_TYPE.PROD){
						$tr.append("<td align='left' colspan='1' class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>"
						+this.accessNumber+"</span>&nbsp;&nbsp;</td>");
						return;
					}
				});
			}else{
				//副卡添加
				$.each(offerRole.roleObjs,function(){  //遍历副卡角色下的成员
					if(this.objType == CONST.OBJ_TYPE.PROD){
						this.minQty = 0;
						this.dfQty = 0;
						viceMinQty = 0;
						viceMaxQty = this.maxQty;
						numId = offerRole.offerRoleId+"_"+this.objId;//offerRole.memberRoleCd;
					}
				});
				var existViceCardNum = 0;//已有副卡数量
				//副卡个数
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.offerRoleId == offerRole.offerRoleId  && this.objType==CONST.OBJ_TYPE.PROD){
						existViceCardNum++;
					}
				});
				//副卡添加
				$.each(this.roleObjs,function(){
					var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
					if(this.objType == CONST.OBJ_TYPE.PROD){
						_memberAddList.push(objInstId);
						if(offerRole.minQty == 0){ //加装角色
							this.minQty = 0;
							this.dfQty = 0;
						}
						var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
						max = max -existViceCardNum;
						maxNum = max;
						if(max>0){
							var subnumpic = "";
							var addNumpic = "";
							if(newSubPhoneNumsize.length==0 && oldSubPhoneNumsize.length==0){
								subnumpic = "<a class='add' href='javascript:order.service.subNum(\""+objInstId+"\","+this.minQty+");'></a>";
								addNumpic = "<a class='add2' href='javascript:order.service.addNum(\""+objInstId+"\","+max+");'> </a>";
							}else if(newSubPhoneNumsize.length>max){
								$.alert("规则限制","newSubPhoneNum的角色成员数量总和不能超过"+max);
								errorflag = false;
								return false;
							}
							$tr.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'>"+
									subnumpic+
									"<input id='"+objInstId+"' type='text' value='"+newSubPhoneNumsize.length+"' class='numberTextBox width22' readonly='readonly'>"+
									addNumpic+
									"</i>"+this.minQty+"-"+max+"（张） </td>");	
						}
//						else{
//							$tr.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'>"+
//									"<a class='add' href='javascript:order.service.subNum(\""+objInstId+"\","+this.minQty+");'></a>"+
//									"<input id='"+objInstId+"' type='text' value='"+this.dfQty+"' class='numberTextBox width22' readonly='readonly'>"+
//									"<a class='add2' href='javascript:order.service.addNum(\""+objInstId+"\","+max+");'> </a>"+
//									"</i>"+this.minQty+"-"+max+"（张） </td>");	
//						}
						iflag++;
					}
				});
				
				//[W]
				if(areaidflag!="" && areaidflag.flag=="ON" && areaidflag.net_vice_card=="0"){
					//添加老用户
					$.each(this.roleObjs,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD){
							var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
							max = max -existViceCardNum;
							if(max>0){
								var addNumpic = "";
								if(newSubPhoneNumsize.length==0 && oldSubPhoneNumsize.length==0){
									addNumpic = "<a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+max+",\"\");'> </a>";
									var olro = "<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'>" +
									"<td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td>" +
									"<td align='left' colspan='3'><input value='' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' >" +
									addNumpic+
									this.minQty+"-"+max+"（张）"+
//									"<a href='javascript:void(0)' class='purchase' onclick='order.memberChange.queryofferinfo()'>加装</a>"+
									"</td></tr>";	
									$tr.after(olro);
								}else if(oldSubPhoneNumsize.length>max){
									$.alert("规则限制","oldSubPhoneNum的角色成员数量总和不能超过"+max);
									errorflag = false;
									return false;
								}else{
									for(var k=0;k<oldSubPhoneNumsize.length;k++){
										if(k==0){
											var olro = "<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'>" +
											"<td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td>" +
											"<td align='left' colspan='3'><input value='"+oldSubPhoneNumsize[k]+"' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' readonly='readonly'>" +
//											addNumpic+
											this.minQty+"-"+max+"（张）"+
//											"<a href='javascript:void(0)' class='purchase' onclick='order.memberChange.queryofferinfo()'>加装</a>"+
											"</td></tr>";	
											$tr.after(olro);
										}else{
											order.memberChange.addNum(max,oldSubPhoneNumsize[k]);
										}
									}
								}
							}
						}
					});
				}
				//副卡成员
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					var $Othertr = $("<tr></tr>");
					if(this.offerRoleId == offerRole.offerRoleId  && this.objType==CONST.OBJ_TYPE.PROD){
						var li = $("<td colspan='4' id=\"li_viceCard_new_"+this.accessNumber+"\"></td>").text(this.accessNumber).appendTo($Othertr);
						li.attr("del","N").attr("knew","N").attr("objId",this.objId).attr("objInstId",this.objInstId)
						  .attr("objType",this.objType).attr("offerMemberId",this.offerMemberId).attr("offerRoleId",this.offerRoleId).attr("accessNumber",this.accessNumber);
						var eleI = $("<i id='plan_no'><a id='' accNbr='"+this.accessNumber+"' class='purchase' href='javascript:void(0)'>拆副卡</a></i>").appendTo(li);
						eleI.click(function(){
							if (($(this).parent().attr("del") == "N")) {
								$(this).parent().css("text-decoration","line-through").attr("del","Y").attr("knew","N");
								$(this).find("a").text("不 拆");
							} else {
								$(this).parent().css("text-decoration","").attr("del","N").attr("knew","N");
								$(this).find("a").text("拆副卡");
								$("#"+'viceCard_new_'+$(this).find("a").attr("accNbr")).html("");
							}
						});
						$("<span  id='viceCard_new_"+this.accessNumber+"'></span>").appendTo(li);
						if(areaidflag!="" && areaidflag.flag=="ON"){
							var eleR = $("<i id='plan_no_remain'><a id='' accNbr='"+this.accessNumber+"' class='purchase' href='javascript:void(0)'>保留>>选择新套餐</a></i>").appendTo(li);
							eleR.click(function(){
								order.service.offerDialog('viceCard_new_'+$(this).find("a").attr("accNbr"));
	//							$($("#plan_no")).parent().css("text-decoration","line-through").attr("del","Y");
							});	
						}
//						existViceCardNum++;
					}
					$tr.after($Othertr);
				});
			}
		});
		if(order.memberChange.reloadFlag=="Y"){
			$("#memeberChange .btna_o:last").click(function(){
				_closeDialog();
			});
			if(errorflag){
				ec.form.dialog.createDialog({
					"id":"-memeberChange",
					"width":580,
					"height":400,
					"initCallBack":function(dialogForm,dialog){
						order.prodModify.dialogForm=dialogForm;
						order.prodModify.dialog=dialog;
					},
					"submitCallBack":function(dialogForm,dialog){}
				});
			}
		}else if(order.memberChange.reloadFlag=="N"){
//			if(order.memberChange.delmembers.flag || order.memberChange.newmembers.flag || order.memberChange.changemembers.flag){
				order.memberChange.submit();
//			}else if(order.memberChange.oldmembers.flag){
//				order.memberChange.queryofferinfo();
//			}
		}
	};
	
	var _areaidJurisdiction = function(){
		var provid = OrderInfo.staff.soAreaId.substring(0,3) + "0000";
		var areaparam = {"areaid":provid};
		$.ecOverlay("<strong>正在查询中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(contextPath+"/offer/areaidJurisdiction",areaparam);	
		$.unecOverlay();
		if (response.code==0) {
			return response.data;
//			if(response.data=="ON"){
//				return true;
//			}else{
//				return false;
//			}
		}else {
			return "";
		}
	};
	
	function queryReOrder(){
		var provTransId = OrderInfo.provinceInfo.provIsale;
		var areaparam = {"provTransId":provTransId,"backFlag":"Y"};
		$.ecOverlay("<strong>正在查询中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(contextPath+"/accessToken/queryOrderInfos",areaparam);	
		$.unecOverlay();
		if (response.code==0) {
			order.memberChange.rejson = response.data;
			return true;
		}else if(response.code==1002){
			$.alert("错误",response.data);
			return false;
		}else{
			$.alertM(response.data);
			return false;
		}
	}
	
	var _addNum = function(max,addnum){
		var tbody = "";
		if(OrderInfo.actionFlag==2 || OrderInfo.actionFlag==1){
			tbody = "member_tbody";
		}else{
			tbody = "maincard_member_tbody";
		}
		var lis = $("#"+tbody).find("tr[name='oldnbr']");
		lis = lis.length+1;
		if(lis>max){
			return;
		}
		idnum++;		

		var delNumpic = "";
		var readonlyflag = "";
		if(addnum==""){
			delNumpic = "<a style='margin-top:15px' class='add' href='javascript:order.memberChange.delNum(\"oldnum_"+idnum+"\");'> </a>";
		}else{
			readonlyflag = "readonly='readonly'";
		}
		var olro = "<tr style='background:#f8f8f8;' id='oldnum_"+idnum+"' name='oldnbr'>" +
		"<td  class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td>" +
		"<td align='left' colspan='3'><input value='"+addnum+"' style='margin-top:10px' class='numberTextBox' id='oldphonenum_"+idnum+"' type='text' "+readonlyflag+">" +
		delNumpic+
		"</td></tr>";
		
		if(OrderInfo.actionFlag==2 || OrderInfo.actionFlag==1){
			$("#member_tbody").append(olro);
		}else{
			$("#maincard_member_tbody").append(olro);
		}
	};
	
	var _delNum = function(id){
		//[W]
		//choosenum--; 
		$("#"+id).remove();
	};
	
	var custinfolist = [];
	//老用户纳入查询开始
	var _queryofferinfo = function(){
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldAddNumList = [];
		custinfolist = [];
		var oldAddNumList_flag = true;
		var tbody = "";
		if(OrderInfo.actionFlag==2 || OrderInfo.actionFlag==1){
			tbody = "member_tbody";
		}else{
			tbody = "maincard_member_tbody";
		}
		var isReloadFlag= OrderInfo.newOrderInfo.isReloadFlag;
		$("#"+tbody).find("tr[name='oldnbr']").each(function(){
			var num = $.trim($(this).children("td").eq(1).children("input").val());
			if(ec.util.isObj(num)){
				if(ec.util.isArray(OrderInfo.oldAddNumList)){
					if(!oldAddNumList_flag){
						return false;
					}
					$.each(OrderInfo.oldAddNumList,function(){
						if(num==this.accNbr){
							oldAddNumList_flag = false;
							$.alert("提示",num+"重复，请重新输入！");
							return false;
						}
					});
					if(oldAddNumList_flag){
						OrderInfo.oldAddNumList.push({"accNbr":num});
					}
				}else{
					OrderInfo.oldAddNumList.push({"accNbr":num});
				}
			}
		});
		if(!oldAddNumList_flag){
			return false;
		}
		if(OrderInfo.oldAddNumList.length==0){
			$.alert("提示","请输入手机号码!");
			return false;
		}
		var custflag = true;
		for(var i=0;i<OrderInfo.oldAddNumList.length;i++){
			for(var v=0;v<OrderInfo.offer.offerMemberInfos.length;v++){
				if(OrderInfo.oldAddNumList[i].accNbr==OrderInfo.offer.offerMemberInfos[v].accessNumber){
					$.alert("提示",OrderInfo.oldAddNumList[i].accNbr+"号码重复，请重新输入！");
					custflag = false;
					return false;
				}
			}
			if(OrderInfo.provinceInfo.mergeFlag=="0"){
				custflag = queryoffercust(OrderInfo.oldAddNumList[i].accNbr,custinfolist);
				if(!custflag){
					break;
				}
			}else{
				var provCustAreaId = $("#p_cust_areaId_choose").val();
				custflag = order.cust.queryCustCompreInfo(OrderInfo.oldAddNumList[i].accNbr,provCustAreaId,3,'OLD');
				if(!custflag){
					break;
				}
			}
		}
		if(custflag){
			if(OrderInfo.provinceInfo.mergeFlag=="0"){
				return QueryofferCustProd();
			}else{
				if(checkCanAddNum(order.memberChange.viceCartNum)){
					return queryMainOfferSpec();
				}
			}
		}
	};
	
	var queryoffercust = function(accNbr,custinfolist){
		var param = {
				"acctNbr":accNbr,
				"identityCd":"",
				"identityNum":"",
				"partyName":"",
				"diffPlace":"local",
				"areaId" : $("#p_cust_areaId").val(),
				"queryType" :"",
				"queryTypeValue":""
		};
		var response = $.callServiceAsJson(contextPath+"/cust/queryoffercust", param, {"before":function(){
			$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
		}});
		if (response.code == 0) {
			$.unecOverlay();
			if(response.data.custInfos.length==0){
				$.alert("提示","抱歉，没有定位到"+accNbr+"客户，请尝试其他客户。");
				return false;
			}
			var custId = response.data.custInfos[0].custId;
			// 主副卡客户校验取客户查询返回结果中的custId,旧的取order.prodModify.choosedProdInfo.custId
			if(OrderInfo.actionFlag!=1 && custId!=OrderInfo.cust.custId){
				$.alert("提示",accNbr+"和主卡的客户不一致！");
				return false;
			}
			custinfolist.push({"accNbr":accNbr,"custId":custId});
		}else{
			$.unecOverlay();
			$.alertM(response.data);
			return false;
		}
		return true;
	};
	
	var QueryofferCustProd = function(){
		var orderflag = true;
		for(var i=0;i<custinfolist.length;i++){
			var param={};
			param.custId=custinfolist[i].custId;
			param.acctNbr=custinfolist[i].accNbr;
			param.areaId=$("#p_cust_areaId").val();
			param.pageSize="";
			param.curPage="";
			param.DiffPlaceFlag="local";
			if(param.custId==null||param.custId==""){
				orderflag = false;
				$.alert("提示",custinfolist[i].accNbr+"无法查询已订购产品");
				return false;
			}
			var response = $.callServiceAsJson(contextPath+"/cust/offerorderprod", param, {"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			}});
			if (response.code == 0) {
				$.unecOverlay();
				var list = response.data;
				if(!ec.util.isArray(list)){
					$.alert("提示",custinfolist[i].accNbr+"无法查询已订购产品");
					return false;
				}
				for(var j=0;j<list.length;j++){
					if (list[j].accNbr == custinfolist[i].accNbr){
						var prodInstInfos = list[j];
						prodInstInfos.custId = custinfolist[i].custId;
						if(prodInstInfos.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
							orderflag = false;
							$.alert("提示",custinfolist[i].accNbr+"不是在用产品！");
							return;
						}
						if(OrderInfo.actionFlag!=1 && prodInstInfos.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){
							orderflag = false;
							$.alert("提示",custinfolist[i].accNbr+"和主卡的付费类型不一致！");
							return;
						}
						if(prodInstInfos.productId=="280000000"){
							$.alert("提示",custinfolist[i].accNbr+"是无线宽带，不能纳入！");
							return false;
						}
						OrderInfo.oldprodInstInfos.push(prodInstInfos);
						break;
					}
				}
			}else{
				orderflag = false;
				$.unecOverlay();
				$.alertM(response.data);
				return false;
			}
		}
		if(orderflag){
			return setOffer();
		}
	};
	
	var queryMainOfferSpec = function(){
		var specflag = true;
		for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
			var prodOfferId = OrderInfo.oldprodInstInfos[i].mainProdOfferInstInfos[0].prodOfferId;
			if(ec.util.isObj(prodOfferId)){
				var param = {
						offerSpecId : prodOfferId, 
						offerTypeCd : 1,
						partyId : OrderInfo.oldprodInstInfos[i].custId,
						accNbr : OrderInfo.oldprodInstInfos[i].accNbr
					};
				if(!query.offer.queryMainOfferSpec(param)){ //查询主套餐规格构成，并且保存
					specflag = false;
					return false;
				}
			}
		}
		if(specflag){
			return setProdUim();
		}
	};
	
	var setOffer = function() {
		var offerflag = true;
		var addNum = 0; // 加装副卡数量
		var exitNum = [];
		for(var z=0;z<OrderInfo.oldprodInstInfos.length;z++){
			if(ec.util.isArray(exitNum)){
				for(var i in exitNum){
					if(OrderInfo.oldprodInstInfos[z].accNbr == exitNum[i].accessNumber){
						$.alert("提示","号码【"+OrderInfo.oldprodInstInfos[z].accNbr+"】与【"+exitNum[i].accNbr+"】为同一套餐下的实例成员，不能重复加装!");
						return false;
					}
				}
			}
			var param = {
					offerId : OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferInstId,
					offerSpecId : OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferId,
					acctNbr : OrderInfo.oldprodInstInfos[z].accNbr,
					areaId : OrderInfo.oldprodInstInfos[z].areaId,
					distributorId : ""
			};
			var data = query.offer.queryOfferInst(param); //查询销售品实例构成
			if(data&&data.code == CONST.CODE.SUCC_CODE){
				var flag = true;
				if(ec.util.isArray(data.offerMemberInfos)){
					CacheData.sortOffer(data);
					var objTypeflag = 0;
					for ( var i = 0; i < data.offerMemberInfos.length; i++) {
						var member = data.offerMemberInfos[i];
						member.prodClass = OrderInfo.oldprodInstInfos[z].prodClass;
						if(member.objType==""){
							offerflag = false;
							$.alert("提示","销售品实例构成 "+member.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");
							return false;
						}else if(member.objType==CONST.OBJ_TYPE.PROD){
							if(member.accessNumber==""){
								offerflag = false;
								$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
								return false;
							}
							objTypeflag++;
							addNum++;
							exitNum.push({"accNbr":OrderInfo.oldprodInstInfos[z].accNbr,"accessNumber":member.accessNumber});
						}
						if(member.objInstId==OrderInfo.oldprodInstInfos[z].prodInstId){
							flag = false;
						}
					}
					if(flag){
						offerflag = false;
						$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+OrderInfo.oldprodInstInfos[z].accNbr+"】，无法继续受理，请业务后台核实");
						return false;
					}
//					if(objTypeflag>1){
//						offerflag = false;
//						$.alert("提示",OrderInfo.oldprodInstInfos[z].accNbr+"不是单产品，不能纳入！");
//						return false;
//					}
					var offerinfos = {
						"offerMemberInfos":	data.offerMemberInfos,
						"offerId":OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferInstId,
						"offerSpecId":OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferId,
						"offerSpecName":OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferName,
						"accNbr":OrderInfo.oldprodInstInfos[z].accNbr
					};
					OrderInfo.oldoffer.push(offerinfos);
				}else{//销售品成员实例为空
					offerflag = false;
					$.alert("提示",OrderInfo.oldprodInstInfos[z].accNbr+"查询销售品实例构成，没有返回成员实例无法继续受理");
					return false;
				}
			}
		}
		order.memberChange.viceCartNum = addNum;
		if(offerflag && checkCanAddNum(addNum)){
			return queryMainOfferSpec();
		}
	};
	
	// 判断能加装的最大数量
	var checkCanAddNum = function(num){
		var flag = true;
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if (offerRole.memberRoleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD) {
				var existViceCardNum = 0;//已有副卡数量
				//副卡个数
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.offerRoleId == offerRole.offerRoleId  && this.objType==CONST.OBJ_TYPE.PROD){
						existViceCardNum++;
					}
				});
				$.each(this.roleObjs,function(){
					if(this.objType == CONST.OBJ_TYPE.PROD){
						var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
						if(max > 0 && (max - existViceCardNum - num) < 0){
							$.alert("提示","加装数量已经超过能加装的最大数量【"+max+"】!");
							flag = false;
							//[W]
							return;
						}
					}
				});
			}
		});
		return flag;
	};
	
	var setProdUim = function(){
		var produimflag = true;
		//OrderInfo.boProd2OldTds = []; //清空旧卡
		$.each(OrderInfo.oldoffer,function(){
			var oldoffer = this;
			var prod = {};
			$.each(oldoffer.offerMemberInfos,function(){
				if (this.objType == CONST.OBJ_TYPE.PROD) { // 接入类产品
					prod.prodInstId = this.objInstId;
					prod.accNbr = this.accessNumber;
					var uim = query.prod.getTerminalInfo(prod);
					if (uim == undefined) { // 查询旧卡信息失败返回
						produimflag = false;
						return false;
					}
					setOldUim(this.offerId, this.objInstId, uim); // 保存旧卡信息
					if (uim.is4GCard == "Y") {
						this.prodClass = CONST.PROD_CLASS.FOUR;
					} else {
						this.prodClass = CONST.PROD_CLASS.THREE;
					}
				}
			});
		});
		if(produimflag){
			var instflag = true;
			if(OrderInfo.order.soNbr==null || OrderInfo.order.soNbr==undefined || OrderInfo.order.soNbr==""){
				OrderInfo.order.soNbr = UUID.getDataId();
			}
			for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
				var prod = OrderInfo.oldprodInstInfos[i];
				if(prod==undefined || prod.prodInstId ==undefined){
					instflag = false;
					$.alert("提示",OrderInfo.oldprodInstInfos[i].accNbr+"未获取到老用户产品相关信息，无法办理二次业务！");
					return false;
				}
				var param = {
					areaId : prod.areaId,
					acctNbr : prod.accNbr,
					custId : prod.custId,
					soNbr : OrderInfo.order.soNbr,
					instId : prod.prodInstId,
					type : "2",
					queryType: "1,2,3,4,5",
					acctNbr : "",
					data:[]
				};
				if(!loadInst(param,prod)){  //加载实例到缓存
					instflag = false;
					return false;
				};
			}
			if(instflag){
				return ruleCheck();
			}
		}
	};
	
	//保存旧卡
	var setOldUim = function(offerId ,prodId,uim){
		if(ec.util.isArray(OrderInfo.boProd2OldTds)){
			$.each(OrderInfo.boProd2OldTds,function(){
				if(this.prodId==prodId){
					$(this).remove();
				}
			})
		}
		
		var oldUim={
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "2",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId :uim.couponId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD, //物品费用项类型
			couponNum : 1, //物品数量
			//storeId : oldUimInfo.storeId, //仓库ID
			storeId : 1, //仓库ID
			storeName : "11", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : uim.couponInsNumber, //物品实例编码
			terminalCode : uim.couponInsNumber,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId : prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "DEL", //动作
			relaSeq : "", //关联序列
			id:0,
			isOld : "T",  //旧卡
			is4GCard : uim.is4GCard
		};
		OrderInfo.boProd2OldTds.push(oldUim);
	};
	
	/**
	 * 加载实例
	 */
	var loadInst = function(param,prod){
		//获取标识，调用新全量接口还是旧全量接口
		var queryMergeFlag=OrderInfo.provinceInfo.mergeFlag;
		
		for(var j=0;j<OrderInfo.oldoffer.length;j++){
			if(OrderInfo.oldoffer[j].accNbr==prod.accNbr){
				if(ec.util.isArray(OrderInfo.oldoffer[j].offerMemberInfos)){ //遍历主销售品构成
					var flag = true;
					$.each(OrderInfo.oldoffer[j].offerMemberInfos,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD && this.accessNumber==prod.accNbr){ //选中号码在销售品实例构成中，为了防止销售品实例缓存
							instflag = false;
							flag = false;
							return false;
						}
					});
					
					if(flag){ //不在销售品实例缓存
						if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
							param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
							return  query.offer.invokeLoadInstSub(param);
						}else{
							return query.offer.invokeLoadInst(param);
						}
					}else{
						var vFlag = true;
						
						//1调用新接口，如果是0，就是按照旧的方式调用
						if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
							$.each(OrderInfo.oldoffer[j].offerMemberInfos,function(){
								if(this.objType == CONST.OBJ_TYPE.PROD){
									param.data.push({accessNbr:this.accessNumber,instId:this.objInstId});
								}
							});
							
							if(param!=null){
								if (!query.offer.invokeLoadInstSub(param)) {
									vFlag = false;
									return false;
								}
							}
						}else{
							//按旧的方式调用
							$.each(OrderInfo.oldoffer[j].offerMemberInfos,function(){
								if(this.objType == CONST.OBJ_TYPE.PROD){
									param.acctNbr = this.accessNumber;
									param.instId = this.objInstId;
									if (!query.offer.invokeLoadInst(param)) {
										vFlag = false;
										return false;
									}
								}
							});
						}
						
						return vFlag;
					}
				}else{
					if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
						param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
						return query.offer.invokeLoadInstSub(param);
					}else{
						return query.offer.invokeLoadInst(param);
					}
				}
			}
		};
	}
	
	//生成订单流水号，规则校验
	var ruleCheck = function(){
		rule.rule.init();
		var ruleflag = true;
		for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
			var prod = OrderInfo.oldprodInstInfos[i];
			var oldinfo = {
					boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,
					instId : prod.mainProdOfferInstInfos[0].prodOfferInstId,
//					specId : OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].prodOfferId,
					prodId : prod.prodInstId
				};
			if(prod.mainProdOfferInstInfos[0].prodOfferId!=""){
				oldinfo.specId = prod.mainProdOfferInstInfos[0].prodOfferId;
			}
			var boInfos = []; 
			boInfos.push(oldinfo);
//			var choosedProdInfo  = {
//					accNbr :OrderInfo.oldprodInstInfos.accNbr,//产品接入号
//					productName :OrderInfo.oldprodInstInfos.productName,//产品规格名称
//					prodStateName :OrderInfo.oldprodInstInfos.prodStateName,//产品状态名称
//					feeTypeName :OrderInfo.oldprodInstInfos.feeType.feeTypeName,//付费方式名称
//					prodInstId :OrderInfo.oldprodInstInfos.prodInstId,//产品ID
//					extProdInstId : OrderInfo.oldprodInstInfos.extProdInstId,//省内产品实例ID
//					corProdInstId : OrderInfo.oldprodInstInfos.corProdInstId,//外部产品实例ID
//					prodStateCd :OrderInfo.oldprodInstInfos.prodStateCd,//产品状态CD
//					productId :OrderInfo.oldprodInstInfos.productId,//产品规格ID
//					feeType :OrderInfo.oldprodInstInfos.feeType.feeType,//付费方式id
//					prodClass :OrderInfo.oldprodInstInfos.prodClass,//产品大类 4 表示4G；3表示3G
//					stopRecordCd :"",//停机记录CD
//					stopRecordName :"",//停机记录名称
//					prodOfferName :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].prodOfferName,//主套餐名称
//					custName :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].custName,//所属人客户名称
//					startDt :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].startDt,//生效时间
//					endDt :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].endDt,//失效时间
//					prodOfferId :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].prodOfferId,//主套餐规格ID
//					prodOfferInstId :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].prodOfferInstId,//主套餐实例ID
//					custId :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].custId,//所属人客户ID
//					is3G :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].is3G,//3G/4G主销售品标识
//					areaCode :OrderInfo.oldprodInstInfos.zoneNumber,//产品地区CODE
//					areaId : OrderInfo.oldprodInstInfos.areaId//产品地区id
//				};
//			if(OrderInfo.oldprodInstInfos.prodStopRecords.length>0){
//				choosedProdInfo.stopRecordCd=OrderInfo.oldprodInstInfos.prodStopRecords[0].stopRecordCd;
//				choosedProdInfo.stopRecordName=OrderInfo.oldprodInstInfos.prodStopRecords[0].stopRecordName;
//			}
			var inParam ={
					areaId : OrderInfo.staff.soAreaId,
					staffId : OrderInfo.staff.staffId,
					channelId : OrderInfo.staff.channelId,
					custId : prod.custId,
					soNbr : OrderInfo.order.soNbr,
					boInfos : boInfos,
					prodInfo : prod	
				};
				$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");
				var response = $.callServiceAsJson(contextPath+"/rule/prepare",inParam); //调用规则校验
				$.unecOverlay();
				if(response!=undefined && response.code==0){
					var checkData = response.data;
					if(checkData == null){
						ruleflag = false;
						$.alert("提示","规则校验异常，请联系管理人员！");
						return false;
					}
					if(checkData.ruleType == "portal"){  //门户层校验
						if (checkData.resultCode == "0"){  // 0为门户层校验为通过
							ruleflag = false;
							$.alert("提示",checkData.resultMsg);
							return false;
						}
					}		
					var checkRuleInfo = checkData.result.resultInfo;  //业务规则校验
					if(checkRuleInfo!=undefined && checkRuleInfo.length > 0){
						$.each(checkRuleInfo, function(i, ruleInfo) {
							$("<tr><td>"+ruleInfo.resultCode+"</td>" +
									"<td>"+ruleInfo.ruleDesc+"</td>" +
									"<td>"+rule.rule.getRuleLevelName(ruleInfo.ruleLevel)+"</td>" +
									"<td><div style='display:block;margin-left:30px;' class='"+rule.rule.getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td>" +
							"</tr>").appendTo($("#ruleBody"));
						});
						easyDialog.open({
							container : 'ruleDiv'
						});
						ruleflag = false;
						return false;
					}
				}else{
					ruleflag = false;
					$.alertM(response.data);
					return false;
				}
		}
		
		if (ruleflag) {
			return true;
		}
	};
	
	var addOldSubmit = function(){
		//老用户纳入
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,
				CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
		
		param = {
			memberChange : "Y",
			type : 1,
			boActionTypeName : "主副卡成员变更",
			viceCardNum : parseInt(OrderInfo.oldAddNumList.length),
			offerNum : 1,
			actionFlag:6,
			oldofferSpec:OrderInfo.oldofferSpec,
			oldprodInstInfos:OrderInfo.oldprodInstInfos,
			oldoffer:OrderInfo.oldoffer,
			addflag:"ADD",
			oldnum:parseInt(OrderInfo.oldAddNumList.length)
		};
		
//		order.service.setOfferSpec(); //把选择的主副卡数量保存
		var prod = order.prodModify.choosedProdInfo; 
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,
			instId : prod.prodOfferInstId,
			specId : prod.prodOfferId,
			prodId : _offerProd.objInstId//纳入产品成员这些动作时出入宿主产品实例ID
		}];
		if(rule.rule.ruleCheck(boInfos)){  //业务规则校验
			order.main.buildMainView(param);	
		}
		order.memberChange.closeDialog();
	};

	var _submit = function() {
		OrderInfo.oldAddNumList = [];
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldprodAcctInfos = [];
		order.memberChange.viceCartNum = 0;
		var num=0; 
		var oldnum = 0;
		var lis = $("#maincard_member_tbody tr[style!='background:#f8f8f8;'] td[colspan='4']");
		for (var i=0;i<lis.length;i++) {
			if(order.memberChange.delmembers.flag){
				$.each(order.memberChange.delmembers.accessNumbers,function(){
					if(this.nbr==$(lis[i]).attr("accessnumber")){
						$(lis[i]).css("text-decoration","line-through").attr("del","Y").attr("knew","N");
						$(lis[i]).find("a").text("不 拆");
					}
				});
			}
			if(order.memberChange.changemembers.flag){
				$.each(order.memberChange.changemembers.accessNumbers,function(){
					if(this.nbr==$(lis[i]).attr("accessnumber")){
						order.service.choosedOffer('tcnum'+1,this.specId,'','viceCard_new_'+this.nbr,this.name);
					}
				});
			}
		}
		
		var ifRemoveProd = false;
		
		for (var i=0;i<lis.length;i++) {
			if ($(lis[i]).attr("del") == "Y"||$(lis[i]).attr("knew") == "Y") {
				ifRemoveProd = true;
				break;
			}
		}
		$.each(_memberAddList,function(){
			num=num+Number($("#"+this).val());
		});
		$("#maincard_member_tbody").find("tr[name='oldnbr']").each(function(){
			var num = $.trim($(this).children("td").eq(1).children("input").val());
			if(ec.util.isObj(num)){
				oldnum++;
			}
		});
		//var num = $("#memeberChange ul:last h5 i input").val();
//		if ((ifRemoveProd) && num> 0) {
//			$.alert("提示","副卡拆机和副卡新装不能同时做，请分开两次操作");
//			return;
//		}
		if (!(ifRemoveProd) && num <=0 && oldnum<=0) {
			$.alert("提示","没有对副卡进行操作。");
			return;
		}
		var prod = order.prodModify.choosedProdInfo; 
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,
			instId : prod.prodOfferInstId,
			specId : prod.prodOfferId,
			prodId : _offerProd.objInstId//纳入产品成员这些动作时出入宿主产品实例ID
		}];
		if(!rule.rule.ruleCheck(boInfos)){  //业务规则校验
			return;
		}
		var paramMap = {
			boActionTypeName : "主副卡成员变更"
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,
				CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
		if(num>0){//新装副卡
			//查询主卡的产品属性并保存
			var param = {
				prodId : prod.prodInstId, // 产品实例id
				acctNbr : prod.accNbr, // 接入号
				prodSpecId : prod.productId, // 产品规格id
				areaId : prod.areaId // 地区id
			};
			var resData = query.offer.queryProdInstParam(param);
			if(resData && resData.prodSpecParams){
				OrderInfo.prodInstAttrs = resData.prodSpecParams;
			}
			
//			OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,
//					CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
//			param = {
			paramMap.memberChange = "Y";
			paramMap.type = 1;
//			paramMap.boActionTypeName = "主副卡成员变更";
//			paramMap.viceCardNum = parseInt(num);
			paramMap.feeTypeMain=prod.feeType;
			paramMap.offerNum = 1;
			paramMap.custId = OrderInfo.cust.custId;
			paramMap.actionFlag=6;
			paramMap.accessNumber=_offerProd.accessNumber;
			paramMap.offerSpec= OrderInfo.offerSpec;
			paramMap.newnum = num;
//			};
			order.service.setOfferSpec(); //把选择的主副卡数量保存
			order.memberChange.newMemberFlag = true;
//			if(rule.rule.ruleCheck(boInfos)){  //业务规则校验
//				order.main.buildMainView(param);	
//			}
//			order.memberChange.closeDialog();
		}else{
			order.memberChange.newMemberFlag = false;
		}
		if(oldnum>0){
//			var prod = order.prodModify.choosedProdInfo; 
//			var boInfos = [{
//				boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,
//				instId : prod.prodOfferInstId,
//				specId : prod.prodOfferId,
//				prodId : _offerProd.objInstId//纳入产品成员这些动作时出入宿主产品实例ID
//			}];
//			if(rule.rule.ruleCheck(boInfos)){  //业务规则校验
//				order.main.buildMainView(param);	
//			}
//			order.memberChange.closeDialog();
			if(!order.memberChange.queryofferinfo()){
				return;
			}
			order.memberChange.oldMemberFlag = true;
			paramMap.memberChange = "Y";
			paramMap.type = 1;
			paramMap.offerNum = 1;
			paramMap.actionFlag=6;
			paramMap.oldofferSpec=OrderInfo.oldofferSpec;
			paramMap.oldprodInstInfos=OrderInfo.oldprodInstInfos;
			paramMap.oldoffer=OrderInfo.oldoffer;
			paramMap.oldnum = oldnum;
		}else{
			order.memberChange.oldMemberFlag = false;
		}
		if(parseInt(num)+parseInt(order.memberChange.viceCartNum)>maxNum && order.memberChange.reloadFlag!="N"){
			$.alert("提示","加装数量已经超过能加装的最大数量【"+maxNum+"】!");
			return;
		}
	   if(ifRemoveProd){//保留副卡
		   var viceparam = [];
			$.each(lis,function(i, li){//所有副卡信息
				if ($(this).attr("knew") == "Y"||$(this).attr("del") == "Y") {
					viceparam.push({
						objId : $(this).attr("objId"),
						objInstId : $(this).attr("objInstId"),
						objType : $(this).attr("objType"),
						offerRoleId : $(this).attr("addRoleId"),
						offerSpecId :$(this).attr("addSpecId"),
						offerMemberId:$(this).attr("offerMemberId"),
						del : $(this).attr("del"),
						accessNumber : $(this).attr("accessNumber"),
						offerSpecName : $(this).attr("addSpecName"),
						roleName : "基础移动电话",
						knew : $(this).attr("knew")
					});
				}
			});
			order.memberChange.viceparams = viceparam;
			var ooRoles = [];
			$.each(lis,function(i, li){
				if ($(this).attr("del") == "Y"||$(this).attr("knew") == "Y") {
					ooRoles.push({
						objId : $(this).attr("objId"),
						objInstId : $(this).attr("objInstId"),
						objType : $(this).attr("objType"),
						offerMemberId : $(this).attr("offerMemberId"),
						offerRoleId : $(this).attr("offerRoleId"),
						state:'DEL'
					});
				}
			});
			order.memberChange.ooRoless = ooRoles;
			//params = {viceParam:viceparam,ooRoles:ooRoles};
//		   OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,21,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
//		   var boInfos = [{
//				boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,
//				instId : _offerProd.offerId,
//				specId : _offerProd.offerSpecId,
//				prodId : _offerProd.objInstId//纳入产品成员这些动作时出入宿主产品实例ID
//			}];
/*		   if(rule.rule.ruleCheck(boInfos)){  //业务规则校验
		   _removeAndAdd();
		   }*/
		   var submitFlag = "removeProd" ;
		   var boActionType=CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;
			var callParam = {
				boActionTypeCd : boActionType,
//				boActionTypeName : CONST.getBoActionTypeName(boActionType),
				//accessNumber : _choosedProdInfo.accNbr,
				submitFlag:submitFlag,
				viceParam:viceparam,
				ooRoles:ooRoles
			};
/*			OrderInfo.order.templateType=templateType;
			var v_actionFlag = 0 ;
			if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){
				v_actionFlag =20;//OrderInfo.actionFlag
			}*/
			var param={
				areaId : OrderInfo.staff.areaId,
				staffId : OrderInfo.staff.staffId,
				channelId : OrderInfo.staff.channelId,
				custId : OrderInfo.cust.custId,
				boInfos : []
			};
			param.boInfos=boInfos;
//			if(_getSimulateData()){
//				if(rule.rule.ruleCheck(boInfos)){  //业务规则校验
				//根据UIM类型，设置产品是3G还是4G，并且保存旧卡
				if(!prodUimSetProdUim()){ 
					return ;
				}
				var prodInfo = order.prodModify.choosedProdInfo;
//				var paramTmp = {
				paramMap.boActionTypeCd = boActionType;
//						boActionTypeName = CONST.getBoActionTypeName(boActionType);
				paramMap.actionFlag ="6";
				paramMap.prodId = prodInfo.prodInstId;
				paramMap.offerMembers = OrderInfo.offer.offerMemberInfos;
				paramMap.oldOfferSpecName = prodInfo.prodOfferName;
				paramMap.prodClass = prodInfo.prodClass;
				paramMap.appDesc = CONST.getAppDesc();
				paramMap.submitFlag=submitFlag;
				paramMap.viceParam=viceparam;
				paramMap.ooRoles=ooRoles;
				order.memberChange.changeMemberFlag = true;
//					};
//					order.main.buildMainView(paramTmp);	
//				}
//			}else{
//				//OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);
//				var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
//				if(flag) return;
//			}
//			order.memberChange.closeDialog();
	   }else{
		   order.memberChange.changeMemberFlag = false;
	   }
	   order.main.buildMainView(paramMap);	
	   order.memberChange.closeDialog();
	};
	
	var prodUimSetProdUim=function(){
		return prod.uim.setProdUim();
	};
	
	/**
	 * 从缓存里面获取标识
	 */
	var _getSimulateData=function(){
		var param={
			code:"old_memberchange"
		};
		var url=contextPath+"/order/getSimulateData";
		$.ecOverlay("<strong>正在查询公共数据查询的服务中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data!=undefined){
				if("Y"==response.data){
					return false;
				}
			}
		}
		return true;
	};
	
	var _fillmemberChange=function(response,param){
//		SoOrder.initFillPage(); //并且初始化订单数据
//		$("#order_fill_content").html(response.data);
//		$("#fillNextStep").off("click").on("click",function(){
//			SoOrder.submitOrder();
//			_removeAndAdd(param);
//		});
//		$("#fillLastStep").off("click").on("click",function(){
//			order.main.lastStep();
//		});
		
		$.each(OrderInfo.offer.offerMemberInfos,function(){
			if(this.objType=="2"){
				var prodId = this.objInstId;
				var param = {
						areaId : OrderInfo.getProdAreaId(prodId),
						channelId : OrderInfo.staff.channelId,
						staffId : OrderInfo.staff.staffId,
					    prodId : prodId,
					    prodSpecId : this.objId,
					    offerSpecId : order.prodModify.choosedProdInfo.prodOfferId,
					    offerRoleId : this.offerRoleId,
					    acctNbr : this.accessNumber
					};
				var res = query.offer.queryMainCartAttachOffer(param);
			}
		});
		
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		//遍历主销售品构成
		var uimDivShow=false;//是否已经展示了
		$.each(param.viceParam,function(){
			var prodId = this.objInstId;
			var param = {
				areaId : OrderInfo.getProdAreaId(prodId),
				channelId : OrderInfo.staff.channelId,
				staffId : OrderInfo.staff.staffId,
			    prodId : prodId,
			    prodSpecId : this.objId,
			    offerSpecId : prodInfo.prodOfferId,
			    offerRoleId : this.offerRoleId,
			    acctNbr : this.accessNumber
			};
			var res = query.offer.queryChangeAttachOffer(param);
			$("#attach_"+prodId).html(res);	
			//如果objId，objType，objType不为空才可以查询默认必须
			if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){
				param.queryType = "1,2";
				param.objId = this.objId;
				param.objType = this.objType;
				param.memberRoleCd = "400";
				param.offerSpecId=this.offerSpecId;
				//默认必须可选包
				var data = query.offer.queryDefMustOfferSpec(param);
				CacheData.parseOffer(data,prodId);
				//默认必须功能产品
				var data = query.offer.queryServSpec(param);
				CacheData.parseServ(data,prodId);
			}
			/*if(CONST.getAppDesc()==0 && prodInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){	//预校验
			}else{	
			}*/
			AttachOffer.showMainMemberRoleProd(prodId); //显示新套餐构成
			AttachOffer.changeLabel(prodId,this.objId,""); //初始化第一个标签附属
			if(AttachOffer.isChangeUim(prodId)){ //需要补换卡
				if(!uimDivShow){
					$("#uimDiv_"+prodId).show();
				}else{
					$("#uimDiv_"+prodId).hide();
				}
			}
			uimDivShow=true;
		});
//		order.dealer.initDealer(); //初始化发展人
//		offerChange.initOrderProvAttr();//初始化省内订单属性
//		order.main.reload();
	};
	
	var _closeDialog = function() {
		if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){
			order.prodModify.dialogForm.close(order.prodModify.dialog);
		}
	};
	//主卡不变副卡新装套餐
	var _removeAndAdd=function(date){
		var viceparam = [];
		var ooRoles =[];
		var params =[];
		viceparam=date.viceParam;
		ooRoles=date.ooRoles;
		params = {viceParam:viceparam,ooRoles:ooRoles,remark:$("#order_remark").val()};
		SoOrder.submitOrder(params);
		
	};
	
	//省里校验单
	var _checkOrder = function(prodInfo,oldoffer){
		OrderInfo.getOrderData(); //获取订单提交节点
		OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		OrderInfo.orderData.orderList.orderListInfo.areaId = OrderInfo.cust.areaId;
		var busiOrders = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;//获取业务对象数组
		_createDelOffer(busiOrders,oldoffer,prodInfo.prodInstId); //退订主销售品
		_createMainOffer(busiOrders,oldoffer,prodInfo); //订购主销售品	
		var data = query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));
		OrderInfo.orderData.orderList.custOrderList[0].busiOrder = []; //校验完清空
		if(data==undefined){
			return false;
		}
		if(data.resultCode==0 && ec.util.isObj(data.result)){ //预校验成功
			offerChange.resultOffer = data.result;
		}else {
			$.alert("预校验规则限制",data.resultMsg);
			offerChange.resultOffer = {}; 
			return false;
		}
		return true;
	};

	//创建退订主销售品节点
	var _createDelOffer = function(busiOrders,oldoffer,prodInstId){	
		oldoffer.offerTypeCd = 1;
		oldoffer.boActionTypeCd = CONST.BO_ACTION_TYPE.DEL_OFFER;
		OrderInfo.getOfferBusiOrder(busiOrders,oldoffer,prodInstId);
	};
	//创建主销售品节点
	var _createMainOffer = function(busiOrders,offer,prod) {
		var offerSpec = OrderInfo.offerSpec;
		var offerRole = getOfferRole();
		if(offerRole==undefined){
			alert("错误提示","无法加装到该套餐");
			return false;
		}
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
				objId : offerSpec.offerSpecId,  //业务规格ID
				offerTypeCd : "1", //1主销售品
				accessNumber : prod.accNbr  //接入号码
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
			}, 
			data:{
				ooRoles : [],
				ooOwners : [{
					partyId : OrderInfo.cust.custId, //客户ID
					state : "ADD" //动作
				}]
			}
		};
		//遍历主销售品构成
		if(ec.util.isArray(offer.offerMemberInfos)){ //遍历主销售品构成
			busiOrder.data.ooRoles = [];
			$.each(offer.offerMemberInfos,function(){
				var ooRoles = {
					objId : this.objId, //业务规格ID
					objInstId : this.objInstId, //业务对象实例ID,新装默认-1
					objType : this.objType, // 业务对象类型
					offerRoleId : offerRole.offerRoleId, //销售品角色ID
					state : "ADD" //动作
				};
				if(this.objType != CONST.OBJ_TYPE.PROD){ //不是接入产品
					ooRoles.prodId = prodId;//业务对象实例ID
				}
				busiOrder.data.ooRoles.push(ooRoles);
			});
		}

		//销售参数节点
		if(ec.util.isArray(offerSpec.offerSpecParams)){  
			busiOrder.data.ooParams = [];
			for (var i = 0; i < offerSpec.offerSpecParams.length; i++) {
				var param = offerSpec.offerSpecParams[i];
				var ooParam = {
	                itemSpecId : param.itemSpecId,
	                offerParamId : OrderInfo.SEQ.paramSeq--,
	                offerSpecParamId : param.offerSpecParamId,
	                value : param.value,
	                state : "ADD"
	            };
	            busiOrder.data.ooParams.push(ooParam);
			}				
		}
		
		//销售生失效时间节点
		if(offerSpec.ooTimes !=undefined ){
			busiOrder.data.ooTimes = [];
			busiOrder.data.ooTimes.push(offerSpec.ooTimes);
		}
		
		//发展人
		busiOrder.data.busiOrderAttrs = [];
		var $tr = $("tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");
		if($tr!=undefined){
			$tr.each(function(){   //遍历产品有几个发展人
				var dealer = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
					role : $(this).find("select").val(),
					value : $(this).find("input").attr("staffid"),
					channelNbr : $(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()
				};
				busiOrder.data.busiOrderAttrs.push(dealer);
				var dealer_name = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("value") 
				};
				busiOrder.data.busiOrderAttrs.push(dealer_name);	
			});
		}
		busiOrders.push(busiOrder);
	};
	var getOfferRole = function(){
		//新套餐是主副卡,获取主卡角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){  //主卡
				return offerRole;
			}
		}
		//新套餐不是主副卡，返回第一个包含接入产品的角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			for (var j = 0; j < offerRole.roleObjs.length; j++) {
				var roleObj = offerRole.roleObjs[j];
				if(roleObj.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
					return offerRole;
				}
			}
		}
	};
	
	//根据省内返回的数据校验
	var _checkOfferProd = function(oldoffer){
		if(offerChange.resultOffer==undefined){
			return;
		}
		//功能产品
		var prodInfos = offerChange.resultOffer.prodInfos;
		if(ec.util.isArray(prodInfos)){
			$.each(prodInfos,function(){
				var prodId = this.accProdInstId;
				//容错处理，省份接入产品实例id传错
				var flag = true;
				$.each(oldoffer.offerMemberInfos,function(){ //遍历旧套餐构成
					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var serv = CacheData.getServ(prodId,this.prodInstId);
					if(this.state=="DEL"){
						if(serv!=undefined){
							var $span = $("#li_"+prodId+"_"+this.prodInstId).find("span");
							$span.addClass("del");
							serv.isdel = "Y";
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined){  //在已开通里面，修改不让关闭
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}else{
							var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
							if(servSpec!=undefined){
								$("#del_"+prodId+"_"+this.productId).hide();
							}else {
								if(this.productId!=undefined && this.productId!=""){
									//AttachOffer.addOpenServList(prodId,this.productId,this.prodName,this.ifParams);
									AttachOffer.openServSpec(prodId,this.productId);
								}
							}
						}
					}
				}
			});
		}
		
		//可选包
		var offers = offerChange.resultOffer.prodOfferInfos;
		if(ec.util.isArray(offers)){
			if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){//多产品套餐
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					var prodId = this.objInstId;
					$.each(offers,function(){
						if(this.memberInfo==undefined){
							return true;
						}
						var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已开通里面查找
						var flag = true;
						$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
							if(prodId == this.accProdInstId){		
								if(ec.util.isObj(offer)){
									this.prodId = this.accProdInstId;
//									offer.offerMemberInfos = [];
//									offer.offerMemberInfos.push(this);
								}
								flag = false;
								return false;
							}
						});
						if(flag){
							return true;
						}
						if(this.state=="DEL"){
							if(offer!=undefined){
								var $span = $("#li_"+prodId+"_"+this.prodOfferInstId).find("span");
								$span.addClass("del");
								offer.isdel = "Y";
								if(this.isRepeat!="Y"){//如果可选包下面有多个接入类产品，到时候只拼一个退订节点
									this.isRepeat="Y";
								}else{
									offer.isRepeat="Y";
								}
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}	
						}else if(this.state=="ADD"){
							if(offer!=undefined){ //在已开通里面，修改不让关闭
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}else{
								var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已开通里面查找
								if(offerSpec!=undefined){
									$("#del_"+prodId+"_"+this.prodOfferId).hide();
								}else {
									if(ec.util.isObj(this.prodOfferId) && this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){
										//AttachOffer.addOpenList(prodId,this.prodOfferId);			
										AttachOffer.addOfferSpecByCheck(prodId,this.prodOfferId);
									}
								}
							}
						}
					});
				});
			}
		}
	};
	
	return {
		showOfferCfgDialog : _showOfferCfgDialog,
		closeDialog : _closeDialog,
		submit : _submit,
		offerProd:_offerProd,
		ischooseOffer :_ischooseOffer,
		removeAndAdd :_removeAndAdd,
		queryofferinfo:_queryofferinfo,
		addNum:_addNum,
		checkOrder:_checkOrder,
		checkOfferProd:_checkOfferProd,
		getSimulateData : _getSimulateData,
		fillmemberChange : _fillmemberChange,
		delNum:_delNum,
		reloadFlag: _reloadFlag,
		newSubPhoneNum: _newSubPhoneNum,
		oldSubPhoneNum: _oldSubPhoneNum,
		mktResInstCode:_mktResInstCode,
		newmembers:_newmembers,
		oldmembers:_oldmembers,
		delmembers:_delmembers,
		changemembers:_changemembers,
		rejson:_rejson,
		newMemberFlag:_newMemberFlag,
		oldMemberFlag:_oldMemberFlag,
		changeMemberFlag:_changeMemberFlag,
		viceCartNum:_viceCartNum,
		viceparams:_viceparams,
		ooRoless:_ooRoless,
		areaidJurisdiction:_areaidJurisdiction,
		viceCartNum:_viceCartNum
	};
}();
$(function(){
	$("#memeberChangeclose").click(function(){
		order.memberChange.closeDialog();
	});
	$("#memeberChange .btna_o:first").click(function(){
		$("#memeberChange .btna_o:first").removeClass("btna_o").addClass("btna_g");
		order.memberChange.submit();
		$("#memeberChange .btna_g:first").removeClass("btna_g").addClass("btna_o");
	});
	$("#memeberChange .btna_o:last").click(function(){
		order.memberChange.closeDialog();
	});
});
/**
 * 发展人管理
 * 
 * @author wukf
 * date 2014-01-20
 */
CommonUtils.regNamespace("order","dealers");

/** 发展人对象*/
order.dealers = (function() {
	//初始化发展人
	var _initDealer = function(prodInfo) {

		$("#dealerTbody").html("");
		    var data=OrderInfo.data;
		    var busiOrder="";
		    for(var i=0;i<data.orderList.custOrderList[0].busiOrder.length;i++){
            	   busiOrder=data.orderList.custOrderList[0].busiOrder[i];
            	if(busiOrder.boActionType.actionClassCd=="1200" && busiOrder.boActionType.boActionTypeCd=="S1" && busiOrder.busiObj.offerTypeCd=="1"){
            		break;
            	}
            }
		    var d=busiOrder.data;
		    var objId=busiOrder.busiObj.objId;
		    var accessNumber=busiOrder.busiObj.accessNumber;
		
			if(!ec.util.isArray(OrderInfo.order.dealerTypeList)){
				$.ecOverlay("<strong>正在查询发展人类型中,请稍后....</strong>");
				var response = $.callServiceAsJson(contextPath+"/order/queryPartyProfileSpecList",null); //发展人类型查询
				$.unecOverlay();
				if(response.code==0){
					OrderInfo.order.dealerTypeList = response.data;
				}else if(response.code==-2){
					$.alertM(response.data);
					return;
				}else{
					$.alert("信息提示",response.msg);
					return;
				}
			}
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==2 || OrderInfo.actionFlag==14){ //新装业务，套餐变更需要主套餐发展人
		
			var dealers=OrderInfo.dealers;
			var ooRoles=d.ooRoles;
			var busiOrderAttrs=d.busiOrderAttrs;
			var ooOwners=d.ooOwners;

			for(var i=0;i<busiOrderAttrs.length;i++){
                if(busiOrderAttrs.length==1){
                	var objInstId = objId;
					var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
					var $tdType = $('<td></td>');
					var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
					var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
					if(order.ysl!=undefined){
						$select.append("<option value='40020005'>第一发展人</option>");
						$select.append("<option value='40020006'>第二发展人</option>");
						$select.append("<option value='40020007'>第三发展人</option>");
					}else{
						$.each(OrderInfo.order.dealerTypeList,function(){
							$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
						});
					}
					$tdType.append($select);
					$tdType.append('<label class="f_red">*</label>');
					var accNbr = "主套餐";
					$tr.append("<td>"+accNbr+"</td>");
					$tr.append("<td>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</td>");
					$tr.append($tdType);
					if(order.ysl!=undefined){
						var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+busiOrderAttrs[i-1].value+'" value="'+busiOrderAttrs[i].value+'" class="inputWidth183px"></input></td>');
					}else{
						var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+busiOrderAttrs[i-1].value+'" value="'+busiOrderAttrs[i].value+'" class="inputWidth183px" readonly="readonly" ></input></td>');
					}
					$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
					$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
					$tr.append($td);
					$("#dealerTbody").append($tr);
					break;
                }
                else{
                	if(i % 2!=0){
                		//产品id
    					var prodId=OrderInfo.offerSpec.offerSpecId;

    					var objName=busiOrderAttrs[i].value;
    					
    					_addAttachDealerSub(prodId+"_"+objId,objName);
                	}
                }
			}
		}		
	};
	//校验发展人类型,并获取发展人类型列表
	var _getDealerTypeSub = function(objInstId,objId){
		var dealerType = "";
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":40020005,"NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":40020006,"NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":40020007,"NAME":"第三发展人"}];
		}
		if(OrderInfo.order.dealerTypeList!=undefined && OrderInfo.order.dealerTypeList.length>0){ //发展人类型列表
			$.each(OrderInfo.order.dealerTypeList,function(){
				var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
				var flag = true;
				$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
					if(dealerTypeId==$(this).val()){  //如果已经存在
						flag = false;
						return false;
					}
				});
				if(flag){ //如果发展人类型没有重复
					dealerType = dealerTypeId;
					return false;
				}
			});
		}else{
			$.alert("信息提示","没有发展人类型");
			return;
		}
		if(dealerType==undefined || dealerType==""){	
			$.alert("信息提示","每个业务发展人类型不能重复");
			return;
		}
		var $td = $('<td></td>'); //发展人类型
		var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		$.each(OrderInfo.order.dealerTypeList,function(){
			if(this.PARTYPRODUCTRELAROLECD==dealerType){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>");
			}else{
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			}
		});
		$td.append($select);
		$td.append('<label class="f_red">*</label>');
		return $td;
	};
	
	//点击确认，添加附属销售品发展人
	var _addAttachDealerSub = function(id,objName){
		var accNbr = "主套餐";
		var prodId = id.split("_")[0];
	
		if($("#tr_"+id)[0]==undefined){ //没有添加过
		
			var objId = id+"_"+OrderInfo.SEQ.dealerSeq;
			var $tdType = _getDealerTypeSub(id,objId);
			if($tdType==undefined){
				return false;
			}
		    
			var $tr = $("#atr_"+id);
			var $newTr = $('<tr name="tr_'+id+'"></tr>');
			$newTr.append("<td>"+accNbr+"</td>");
			$newTr.append("<td>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</td>");
			$newTr.append($tdType);
			
			var dealer = $("#tr_"+prodId).find("input"); //产品协销人
			var staffId = 1;
			var staffName = "";
			if(dealer[0]==undefined){
				staffId = OrderInfo.staff.staffId;
				staffName = OrderInfo.staff.staffName;
			}else {
				staffId = dealer.attr("staffId");
				staffName = dealer.attr("value");
			}
			if(order.ysl!=undefined){
				var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+objName+'" class="inputWidth183px" style="margin-left:45px;"></input></td>');
			}else{
				var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+objName+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>');
			}
			$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');	
			$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
			$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+id+'\')">添加</a><label class="f_red">*</label>');
			$newTr.append($td);
			
			$("#dealerTbody").append($newTr);
			OrderInfo.SEQ.dealerSeq++;
		}
	};
	
	//修改发展人角色
	var _changeDealer = function(select,objInstId,value){
		var i = 0;
		$("select[name="+objInstId+"]").each(function(){
			if($(this).val() == $(select).val()){
				i++;
			}
		});
		if(i>1){
			$.alert("信息提示","每个业务的发展人类型不能重复");
			$(select).val(value);
		}
	};
	
	//点击确认，添加附属销售品发展人
	var _addAttachDealer = function(){
		$("input[name=attach_dealer]:checked").each(function(){	
			var id = $(this).attr("id");	
			var prodId = id.split("_")[0];
			if($("#tr_"+id)[0]==undefined){ //没有添加过
				var objId = id+"_"+OrderInfo.SEQ.dealerSeq;
				var $tdType = _getDealerType(id,objId);
				if($tdType==undefined){
					return false;
				}
				var $tr = $("#atr_"+id);
				var $newTr = $('<tr name="tr_'+id+'"></tr>');
				$newTr.append("<td>"+$tr.children().eq(1).text()+"</td>");
				$newTr.append("<td>"+$tr.children().eq(2).text()+"</td>");
				$newTr.append($tdType);
				
				var dealer = $("#tr_"+prodId).find("input"); //产品协销人
				var staffId = 1;
				var staffName = "";
				if(dealer[0]==undefined){
					staffId = OrderInfo.staff.staffId;
					staffName = OrderInfo.staff.staffName;
				}else {
					staffId = dealer.attr("staffId");
					staffName = dealer.attr("value");
				}
				if(order.ysl!=undefined){
					var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" style="margin-left:45px;"></input></td>');
				}else{
					var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>');
				}
				$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');	
				$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
				$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+id+'\')">添加</a><label class="f_red">*</label>');
				$newTr.append($td);
				$("#dealerTbody").append($newTr);
				OrderInfo.SEQ.dealerSeq++;
			}	
		});
		easyDialog.close();
	};
	
	//添加一行产品协销人
	var _addProdDealer = function(obj,objInstId,type){
		var $oldTr = $(obj).parent().parent();
		var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
		var $tdType = _getDealerType(objInstId,objId);
		if($tdType==undefined){
			return;
		}
		var $tr = $('<tr name="tr_'+objInstId+'"></tr>');
		/*if(type==1){
			$tr.append("<td>"+CONST.EVENT.PROD_NEW+"</td>");
		}else{
			$tr.append("<td>"+CONST.EVENT.OFFER_BUY+"</td>");
		}*/
		if (OrderInfo.actionFlag != 13) {
			$tr.append("<td>"+$oldTr.find("td").eq(0).text()+"</td>");
			$tr.append("<td>"+$oldTr.find("td").eq(1).text()+"</td>");
		}
		$tr.append($tdType);
		if(order.ysl!=undefined){
			var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+objInstId+'" staffId="'+$oldTr.find("input").attr("staffId")+'" value="'+$oldTr.find("input").attr("value")+'" class="inputWidth183px" ></input></td>');
		}else{
			var $td = $('<td><input type="text" id="dealer_'+objId+'" name="dealer_'+objInstId+'" staffId="'+$oldTr.find("input").attr("staffId")+'" value="'+$oldTr.find("input").attr("value")+'" class="inputWidth183px" readonly="readonly" ></input></td>');
		}
		$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
		$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');
		/*if(type==1){
			$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');
		}else{
			$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
			$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+')">添加</a><label class="f_red">*</label>');
		}*/
		$tr.append($td);	
		$oldTr.after($tr);
		OrderInfo.SEQ.dealerSeq++;
	};
	
	//改变发展人号码
	var _changeAccNbr = function(prodId,accNbr){
		$("tr[name^='tr_"+prodId+"']").each(function(){
			$(this).find("td").eq(0).text(accNbr);
		});
	};
	
	//校验发展人类型,并获取发展人类型列表
	var _getDealerType = function(objInstId,objId){
		var dealerType = "";
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":40020005,"NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":40020006,"NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":40020007,"NAME":"第三发展人"}];
		}
		if(OrderInfo.order.dealerTypeList!=undefined && OrderInfo.order.dealerTypeList.length>0){ //发展人类型列表
			$.each(OrderInfo.order.dealerTypeList,function(){
				var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
				var flag = true;
				$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
					if(dealerTypeId==$(this).val()){  //如果已经存在
						flag = false;
						return false;
					}
				});
				if(flag){ //如果发展人类型没有重复
					dealerType = dealerTypeId;
					return false;
				}
			});
		}else{
			$.alert("信息提示","没有发展人类型");
			return;
		}
		if(dealerType==undefined || dealerType==""){	
			$.alert("信息提示","每个业务发展人类型不能重复");
			return;
		}
		var $td = $('<td></td>'); //发展人类型
		var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		$.each(OrderInfo.order.dealerTypeList,function(){
			if(this.PARTYPRODUCTRELAROLECD==dealerType){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>");
			}else{
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			}
		});
		$td.append($select);
		$td.append('<label class="f_red">*</label>');
		return $td;
	};
	
	//显示已经受理的业务列表
	var _showOfferList = function(){	
		$('#attach_tbody').empty();
		//主销售品
		/*if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 14 || OrderInfo.actionFlag == 2){
			var id = OrderInfo.offerSpec.offerSpecId;
			if($("tr[name='tr_"+id+"']")[0]==undefined){
				var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"></tr>');
				$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td>');
				$tr.append('<td>主套餐</td><td>'+OrderInfo.offerSpec.offerSpecName+'</td>');
				$('#attach_tbody').append($tr);
			}
		}*/
		//接入产品
		/*if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 14){
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				$.each(this.prodInsts,function(){
					var accNbr = "未选号";
					if(this.accNbr!=undefined && this.accNbr!=""){
						accNbr = prodInst.accNbr;
					}
					var id = this.prodInstId;
					var accNbr = OrderInfo.getProdAn(id).accessNumber;
					if(accNbr==undefined || accNbr==""){ 
						accNbr = "未选号";
					}
					if($("tr[name='tr_"+id+"']")[0]==undefined){
						var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')">');
						$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td></tr>');
						$tr.append('<td>'+accNbr+'</td><td>'+this.objName+'</td>');
						$('#attach_tbody').append($tr);
					}
				});
			});
		}*/
		//可选包
		$.each(AttachOffer.openList,function(){
			var prodId = this.prodId;
			var accNbr = "";
			if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
				for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
					if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
						accNbr = OrderInfo.oldprodInstInfos[i].accNbr;
					}
				}
			}else{
				accNbr = OrderInfo.getAccessNumber(prodId);
			}
			if(accNbr==undefined || accNbr==""){ 
				accNbr = "未选号";
			}
			$.each(this.specList,function(){
				var id = prodId+'_'+this.offerSpecId;
				if(this.isdel != "Y" && this.isdel != "C" && $("tr[name='tr_"+id+"']")[0]==undefined){  //订购的附属销售品	
					var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"></tr>');
					//var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"><td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td></tr>');
					$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td>');
					$tr.append('<td>'+accNbr+'</td><td>'+this.offerSpecName+'</td>');
					$('#attach_tbody').append($tr);
				};
			});
		});
		
		//预受理
		if(order.ysl!=undefined){
			if(order.ysl.yslbean.yslflag!=undefined){
				for (var j = 0; j < order.ysl.openList.length; j++) {
					if(order.ysl.openList[j].type=="1"){
						var prodId = "-1";
						var accNbr = $("#choosedNumSpan").val();
						if(accNbr==undefined || accNbr==""){ 
							accNbr = "未选号";
						}
						var dealerchecked = "N";
						var dealertr = $("#dealerTbody").find("tr");
						dealertr.each(function(){
							if($(this).attr("name")=="tr_-1_"+order.ysl.openList[j].id){
								dealerchecked = "Y";
							}else{
								dealerchecked = "N";
							}
						});
						if(dealerchecked=="N"){
							var id = prodId+'_'+order.ysl.openList[j].id;
							var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"></tr>');
							$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td>');
							$tr.append('<td>'+accNbr+'</td><td>'+order.ysl.openList[j].name+'</td>');
							$('#attach_tbody').append($tr);
						}
					}
				}
			}
		}
		//功能产品
		/*$.each(AttachOffer.openServList,function(){
			var prodId = this.prodId;
			var accNbr = OrderInfo.getAccessNumber(prodId);
			if(accNbr==undefined || accNbr==""){ 
				accNbr = "未选号";
			}
			$.each(this.servSpecList,function(){
				var id = prodId+'_'+this.servSpecId;
				if(this.isdel != "Y" && this.isdel != "C"  && $("tr[name='tr_"+id+"']")[0]==undefined){  //订购的附属销售品
					var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"><td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td></tr>');
					$tr.append('<td>'+accNbr+'</td><td>'+this.servSpecName+'</td>');
					$('#attach_tbody').append($tr);
				};
			});
		});*/
		easyDialog.open({
			container : "div_attach_dialog"
		});
	};
	
	//勾选一个附属
	var _checkAttach = function(id){
		var tr = $("#atr_"+id);
		var checkbox = $("#"+id);
		if(checkbox.attr("checked")=="checked"){
			tr.removeClass("plan_select");
			checkbox.attr("checked", false);
		}else {
			tr.addClass("plan_select");
			checkbox.attr("checked", true);
		}
	};
	
	//删除协销人
	var _removeDealer = function(obj){
		$(obj).parent().parent().remove();
	};
	
	//删除协销人
	var _removeAttDealer = function(id){
		$("tr[name^='tr_"+id+"']").each(function(){
			$(this).remove();
		});
	};
	
	return {
		getDealerTypeSub:_getDealerTypeSub,
		addAttachDealerSub:_addAttachDealerSub,
		initDealer 			: _initDealer,
		changeAccNbr		: _changeAccNbr,
		showOfferList		: _showOfferList,
		addProdDealer		: _addProdDealer,
		addAttachDealer		: _addAttachDealer,
		checkAttach			: _checkAttach,
		removeDealer		: _removeDealer,
		removeAttDealer		: _removeAttDealer,
		changeDealer		: _changeDealer
	};
})();
/**
 * 销售品变更
 * 
 * @author wukf
 * date 2013-9-22
 */
CommonUtils.regNamespace("offerChange");

offerChange = (function() {
	
	var _resultOffer = {}; //预校验单接口返回
	var num=0;
	var maxNum = 0;
	var _newAddList = [];
	var _newMemberFlag = false;
	var _oldMemberFlag = false;
	//初始化套餐变更页面
	var _init = function (){
		
		var prodInfo = order.prodModify.choosedProdInfo;
		if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
			$.alert("提示","请选择一个在用产品");
			return;
		}
		OrderInfo.actionFlag = 2;
		if(OrderInfo.provinceInfo.mergeFlag=="0"){
			if(!query.offer.setOffer()){ //必须先保存销售品实例构成，加载实例到缓存要使用
				return ;
			}
		}
		//规则校验入参
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		},{
			boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		}];
		if(!rule.rule.ruleCheck(boInfos)){ //规则校验失败
			return;
		}
		
		//初始化套餐查询页面
		$.ecOverlay("<strong>正在查询中,请稍后....</strong>");
	
		var response = $.callServiceAsHtmlGet(contextPath+"/token/pc/order/prodoffer/prepares",{});	
		$.unecOverlay();
		if(response.code != 0) {
			$.alert("提示","查询失败,稍后重试");
			return;
		}
		SoOrder.step(0,response.data); //订单准备
		$('#search').bind('click',function(){
			order.service.searchPack();
		});
		order.prodOffer.init();
		order.service.searchPack(); //查询可以变更套餐
	};
		
	//套餐变更页面显示
	var _offerChangeView=function(){
		_newAddList = [];
		offerChange.newMemberFlag = false;
		offerChange.oldMemberFlag = false;
		var oldLen = 0 ;
		$.each(OrderInfo.offer.offerMemberInfos,function(){
			if(this.objType==2){
				oldLen++;
			}
		});
		var memberNum = 1; //判断是否多成员 1 单成员2多成员
		var viceNum = 0;
		if(oldLen>1){ //多成员角色，目前只支持主副卡
			memberNum = 2;
		}
		//把旧套餐的产品自动匹配到新套餐中
		if(!_setChangeOfferSpec(memberNum,viceNum)){  
			return;
		};
		/*//4g系统需要
		if(CONST.getAppDesc()==0){ 
			//老套餐是3G，新套餐是4G
			if(order.prodModify.choosedProdInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){
				if(!offerChange.checkOrder()){ //省内校验单
					return;
				}
			}
			//根据UIM类型，设置产品是3G还是4G，并且保存旧卡
			if(!prod.uim.setProdUim()){ 
				return ;
			}
		}
		*/
		if(OrderInfo.actionFlag == 2){ //套餐变更	
			var newSubPhoneNumsize=[];
			var oldSubPhoneNumsize=[];
			if(order.memberChange.newSubPhoneNum!=""){
				newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
			}
			if(order.memberChange.oldSubPhoneNum!=""){
				oldSubPhoneNumsize = order.memberChange.oldSubPhoneNum.split(",");
			}
			var max = 0;
			var $tbody = $("#member_tbody");
			$tbody.html("");
			$("#main_title").text(OrderInfo.offerSpec.offerSpecName);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(this.memberRoleCd=="401"){
					var offerRole = this;
					var $tr = $("<tr style='background:#f8f8f8;'></tr>");
					var $td = $('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'
							+offerRole.offerRoleName+'</span>&nbsp;&nbsp;</td>');
					if(this.memberRoleCd == CONST.MEMBER_ROLE_CD.CONTENT){
						$tr.append($td).append($("<td colspan='3'></td>")).appendTo($tbody);
					}else{
						$tr.append($td).appendTo($tbody);
					}
					$.each(this.roleObjs,function(){
						var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
						if(this.objType == CONST.OBJ_TYPE.PROD){
							_newAddList.push(objInstId);
							if(offerRole.minQty == 0){ //加装角色
								this.minQty = 0;
								this.dfQty = 0;
							}
							var membernum = 0;
							$.each(OrderInfo.offer.offerMemberInfos,function(){
								if(this.roleCd=="401"){
									membernum++;
								}
							})
							max = this.maxQty<0?"不限制":this.maxQty-membernum;
							if(max<0){
								max = 0;
							}
							maxNum = max;
							$tr.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'>"+
									"<a class='add' href='javascript:order.service.subNum(\""+objInstId+"\","+this.minQty+");'></a>"+
									"<input id='"+objInstId+"' type='text' value='"+newSubPhoneNumsize.length+"' class='numberTextBox width22' readonly='readonly'>"+
									"<a class='add2' href='javascript:order.service.addNum(\""+objInstId+"\","+max+",\""+offerRole.parentOfferRoleId+"\");'> </a>"+
									"</i>"+this.minQty+"-"+max+"（张） </td>");	
							if(max>0){
								if(oldSubPhoneNumsize.length==0){
									var olro = "<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'>" +
									"<td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td>" +
									"<td align='left' colspan='3'><input value='' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' >" +
									"<a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+max+",\"\");'> </a>"+this.minQty+"-"+max+"（张）</td></tr>";	
									$tr.after(olro);
								}else{
									for(var k=0;k<oldSubPhoneNumsize.length;k++){
										if(k==0){
											var olro = "<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'>" +
											"<td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td>" +
											"<td align='left' colspan='3'><input value='"+oldSubPhoneNumsize[k]+"' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' >" +
											"<a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+max+",\"\");'> </a>"+this.minQty+"-"+max+"（张）</td></tr>";	
											$tr.after(olro);
										}else{
											order.memberChange.addNum(max,oldSubPhoneNumsize[k]);
										}
									}
								}
							}
						}
					});
				}
			});
			easyDialog.open({
				container : "member_dialog"
			});
//			$("#member_btn").off("click").on("click",function(){
//				offerChangeConfirm();
//				easyDialog.close();
//			});
		}
	};
	
	var _offerChangeConfirm = function(){
		if(CONST.getAppDesc()==0){ 
			//老套餐是3G，新套餐是4G
			if(order.prodModify.choosedProdInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){
				if(!offerChange.checkOrder()){ //省内校验单
					return;
				}
			}
			//根据UIM类型，设置产品是3G还是4G，并且保存旧卡
			if(!prod.uim.setProdUim()){ 
				return ;
			}
		}
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldprodAcctInfos = [];
		OrderInfo.oldAddNumList = [];
		var newnum = 0;
		var oldnum = 0;
		order.memberChange.viceCartNum = 0;
		var delprodInsts = [];
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			if(this.memberRoleCd=="401"){
				if(this.prodInsts!=undefined){
					var oldprodInsts = this.prodInsts;
					for(var i=0;i<this.prodInsts.length;i++){
						var prodInstId = '"'+this.prodInsts[i].prodInstId+'"';
						if(prodInstId.indexOf("-")!=-1){
							delprodInsts.push(this.prodInsts[i]);
						}
					}
					$.each(delprodInsts,function(){
						var delprodInstId = this.prodInstId;
						$.each(oldprodInsts,function(j){
							if(this.prodInstId = delprodInstId){
								oldprodInsts.splice(j,1);
							}
						});
					});
				}
			}
		});
		$.each(_newAddList,function(){
			newnum=newnum+Number($("#"+this).val());
		});
		$("#member_tbody").find("tr[name='oldnbr']").each(function(){
			var num = $.trim($(this).children("td").eq(1).children("input").val());
			if(ec.util.isObj(num)){
				oldnum++;
			}
		});
		if(newnum>0){
			offerChange.newMemberFlag = true;
			order.service.setOfferSpec();
		}
		if(oldnum>0){
			offerChange.oldMemberFlag = true;
			if(!order.memberChange.queryofferinfo()){
				return;
			}
		}
		if(parseInt(newnum)+parseInt(order.memberChange.viceCartNum)>maxNum){
			$.alert("提示","加装数量已经超过能加装的最大数量【"+maxNum+"】!");
			return;
		}
		//初始化填单页面
		var prodInfo = order.prodModify.choosedProdInfo;
		var param = {
			boActionTypeCd : "S2" ,
			boActionTypeName : "套餐变更",
			actionFlag :"2",
			offerSpec : OrderInfo.offerSpec,
			prodId : prodInfo.prodInstId,
			offerMembers : OrderInfo.offer.offerMemberInfos,
			oldOfferSpecName : prodInfo.prodOfferName,
			prodClass : prodInfo.prodClass,
			appDesc : CONST.getAppDesc(),
			areaId : order.prodModify.choosedProdInfo.areaId,
			newnum : parseInt(newnum),
			oldnum : parseInt(oldnum)
		};
		if(oldnum>0){
			param.oldprodInstInfos = OrderInfo.oldprodInstInfos;
			param.oldofferSpec = OrderInfo.oldofferSpec;
			param.oldoffer = OrderInfo.oldoffer;
		}
		order.main.buildMainView(param);
		$("#member_dialog").hide();
		$("#overlay").hide();
//		easyDialog.close();
	}
	
	//填充套餐变更页面
	var _fillOfferChange = function(response, param) {
		SoOrder.initFillPage(); //并且初始化订单数据
		$("#order_fill_content").html(response.data);
		$("#fillNextStep").off("click").on("click",function(){
			SoOrder.submitOrder();
		});
		$("#fillNextStep1").off("click").on("click",function(){
			SoOrder.submitOrder();
		});
		$("#fillLastStep").off("click").on("click",function(){
			order.main.lastStep();
		});
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		//遍历主销售品构成
		var uimDivShow=false;//是否已经展示了
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if(ec.util.isArray(this.prodInsts)){
				$.each(this.prodInsts,function(){
					var _prodInstId = "'"+this.prodInstId+"'";
					if(_prodInstId.indexOf("-") == -1){
						var prodId = this.prodInstId;
						var param = {
							areaId : OrderInfo.getProdAreaId(prodId),
							channelId : OrderInfo.staff.channelId,
							staffId : OrderInfo.staff.staffId,
						    prodId : prodId,
						    prodSpecId : this.objId,
						    offerSpecId : prodInfo.prodOfferId,
						    offerRoleId : this.offerRoleId,
						    acctNbr : this.accessNumber
						};
						//现在号码
						var nowPhoneNum=this.accessNumber;
						var res = query.offer.queryChangeAttachOffer(param);
						$("#attach_"+prodId).html(res);	
						//如果objId，objType，objType不为空才可以查询默认必须
						if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){
							param.queryType = "1,2";
							param.objId = this.objId;
							param.objType = this.objType;
							param.memberRoleCd = this.roleCd;
							param.offerSpecId=OrderInfo.offerSpec.offerSpecId;
							//默认必须可选包
							var data = query.offer.queryDefMustOfferSpec(param);
							CacheData.parseOffer(data);
							//默认必须功能产品
							param.queryType = "1";//只查询必选，不查默认
							var data = query.offer.queryServSpec(param);
							CacheData.parseServ(data);
						}
						/*if(CONST.getAppDesc()==0 && prodInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){	//预校验
						}else{	
						}*/
						AttachOffer.showMainRoleProd(prodId); //显示新套餐构成
						//根据已选功能产品查询带出的可选包
						var servSpecIds = [];
						if(AttachOffer.openServList!=null&&AttachOffer.openServList!=undefined){
							$.each(AttachOffer.openServList,function(){
								if(this.prodId == param.prodId){
									var servSpecList = this.servSpecList;
									if(servSpecList!=null&&servSpecList!=undefined){
										$.each(servSpecList,function(){
											if(this.servSpecId!=null&&this.servSpecId!=undefined){
												servSpecIds.push(this.servSpecId);
											}
											});
										}
								}
							});					
						}
						if(servSpecIds.length>0){
							param.queryType = "1,2";//查询必选，默认
							param.servSpecIds = servSpecIds;
							var queryData = query.offer.queryServSpecPost(param);
							if(queryData!=null&&queryData.resultCode==0){
								if(queryData.result.offerList!=null&&queryData.result.offerList!=undefined){
									$.each(queryData.result.offerList,function(){
										AttachOffer.addOpenList(param.prodId,this.offerSpecId); 
									});
								}					
							}	
						}
						AttachOffer.changeLabel(prodId,this.objId,""); //初始化第一个标签附属
						if(AttachOffer.isChangeUim(prodId)){ //需要补换卡
							//uim卡校验
							if(OrderInfo.mktResInstCode!=undefined && OrderInfo.mktResInstCode!="null" && OrderInfo.mktResInstCode!=null && OrderInfo.mktResInstCode!=""){
								var array=OrderInfo.mktResInstCode.split(",");
								if(array!=null && array.length>0){
									//首先进行UIM是否重复判断
									var checkPhone="";
									var checkUim="";
									var checkCode="0";
									for(var i=0;i<array.length;i++){
										var numAndUim=array[i].split("_");
										if(numAndUim!=null && numAndUim.length==2){
											var thisPhone=numAndUim[0];
											var thisUim=numAndUim[1]
											if(checkPhone!=null && checkPhone!=""){
												if(checkPhone==thisPhone || checkUim==thisUim){
													checkCode="1";
													break;
												}
											}else{
												checkPhone=thisPhone;
												checkUim=thisUim;
											}
										}
									}
									
									if(checkCode=="1"){
										$.alert("提示","传入的UIM参数中存在重复数据,参数为["+OrderInfo.mktResInstCode+"]");
									}else{
										//没有重复的数据再进行匹配
										var nowUim="";
										
										for(var i=0;i<array.length;i++){
											var numAndUim=array[i].split("_");
											if(numAndUim!=null && numAndUim.length==2){
												var phoneCode=numAndUim[0];
												var uimCode=numAndUim[1];
												
												if(phoneCode==nowPhoneNum){
													nowUim=uimCode;
												}
											}
										}
										
										if(nowUim!=null && nowUim!="" && nowUim!="null"){
											cleckUim(nowUim,prodId);
											$("#uim_check_btn_"+prodId).hide();
											$("#uim_release_btn_"+prodId).hide();
										}
									}
								}
							}
							
							num++;
							if(!uimDivShow){
								$("#uimDiv_"+prodId).show();
							}else{
								$("#uimDiv_"+prodId).hide();
							}
						}
						uimDivShow=true;
					}else{
						var prodInst = this;
						var param = {   
							offerSpecId : OrderInfo.offerSpec.offerSpecId,
							prodSpecId : prodInst.objId,
							offerRoleId: prodInst.offerRoleId,
							prodId : prodInst.prodInstId,
							queryType : "1,2",
							objType: prodInst.objType,
							objId: prodInst.objId,
							memberRoleCd : prodInst.memberRoleCd
						};
						AttachOffer.queryAttachOfferSpec(param);  //加载附属销售品
						var obj = {
							ul_id : "item_order_"+prodInst.prodInstId,
							prodId : prodInst.prodInstId,
							offerSpecId : OrderInfo.offerSpec.offerSpecId,
							compProdSpecId : "",
							prodSpecId : prodInst.objId,
							roleCd : offerRole.roleCd,
							offerRoleId : offerRole.offerRoleId,
							partyId : OrderInfo.cust.custId
						};
						order.main.spec_parm(obj); //加载产品属性
					}
				});
			}
		});
		if(offerChange.newMemberFlag){
			order.main.initAcct(0);
		}
		if(offerChange.oldMemberFlag){
			order.main.initAcct(1);//初始化副卡帐户列表
			order.main.loadAttachOffer();
		}
		$("#zhanghuclose").click(function(){
			easyDialog.close();
			//删除所有选择帐户监听
			$(document).removeJEventListener("queryAccount");
		});
		order.dealer.initDealer(); //初始化发展人
		_initOrderProvAttr();//初始化省内订单属性
		if(CONST.getAppDesc()==0 && order.prodModify.choosedProdInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){ //3G转4G需要校验
			offerChange.checkOfferProd();
		}
		//主副卡纳入新用户选号
		var nbrlist = [];
		var nbrflag = true;
		if(order.memberChange.newSubPhoneNum!="" && OrderInfo.reloadFlag=="Y"){
			var newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
			for(var n=0;n<newSubPhoneNumsize.length;n++){
				if(newSubPhoneNumsize[n]!=""&&newSubPhoneNumsize[n]!=null&&newSubPhoneNumsize[n]!="null"){
					$.each(nbrlist,function(){
						if(this==newSubPhoneNumsize[n]){
							nbrflag = false;
							return false;
						}else{
							nbrflag = true;
						}
					});
					if(nbrflag){
						nbrlist.push(newSubPhoneNumsize[n]);
						$("#nbr_btn_-"+(n+1)).removeAttr("onclick");
						$("#nbr_btn_-"+(n+1)).removeClass("selectBoxTwo");
						$("#nbr_btn_-"+(n+1)).addClass("selectBoxTwoOn");
						var param = {"phoneNum":newSubPhoneNumsize[n]};
						var data = order.phoneNumber.queryPhoneNumber(param);
						if(data.datamap.baseInfo){
							$("#nbr_btn_-"+(n+1)).html(newSubPhoneNumsize[n]+"<u></u>");
							var boProdAns={
									prodId : "-"+(n+1), //从填单页面头部div获取
									accessNumber : data.datamap.baseInfo.phoneNumber, //接入号
									anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
									anId : data.datamap.baseInfo.phoneNumId, //接入号ID
									pnLevelId : data.datamap.baseInfo.phoneLevelId,
									anTypeCd : data.datamap.baseInfo.pnTypeId, //号码类型
									state : "ADD", //动作	,新装默认ADD	
									areaId : data.datamap.baseInfo.areaId,
									areaCode:data.datamap.baseInfo.zoneNumber,
									memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,
									preStore:data.datamap.baseInfo.prePrice,
									minCharge:data.datamap.baseInfo.pnPrice
								};
							OrderInfo.boProdAns.push(boProdAns);
							order.dealer.changeAccNbr("-"+(n+1),newSubPhoneNumsize[n]);//选号玩要刷新发展人管理里面的号码
						}
					}else{
						$.alert("提示","号码"+newSubPhoneNumsize[n]+"重复输入");
					}
				}
			}
		}
		//主副卡纳入新用户UIM卡
		if(OrderInfo.mktResInstCode!="" && OrderInfo.reloadFlag=="Y"){
			nbrlist = [];
			nbrflag = true;
			var offerId = "-1";
//			offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
//			$.each(OrderInfo.oldprodInstInfos,function(){
//				if(this.prodInstId==prodId){
//					offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
//				}
//			});
			var mktResInstCodesize = OrderInfo.mktResInstCode.split(",");
			for(var u=0;u<mktResInstCodesize.length;u++){
				if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null" && order.memberChange.newSubPhoneNum!=""){
					var nbrAndUimCode = mktResInstCodesize[u].split("_");
					var _accNbr = nbrAndUimCode[0];
					var _uimCode = nbrAndUimCode[1];
					var newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
					var uimflag = false;
					$.each(nbrlist,function(){
						if(this==_accNbr){
							nbrflag = false;
							return false;
						}else{
							nbrflag = true;
						}
					});
					if(!nbrflag){
						$.alert("提示","UIM卡"+_uimCode+"对应的号码重复");
						return;
					}
					for(var n=0;n<newSubPhoneNumsize.length;n++){
						if(newSubPhoneNumsize[n]==_accNbr){
							nbrlist.push(newSubPhoneNumsize[n]);
							uimflag = true;
							$("#uim_txt_-"+(n+1)).attr("disabled",true);
							var uimParam = {
									"instCode":_uimCode
							};
							var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
							if (response.code==0) {
								if(response.data.mktResBaseInfo){
									if(response.data.mktResBaseInfo.statusCd=="1102"){
										$("#uim_check_btn_-"+(n+1)).attr("disabled",true);
										$("#uim_check_btn_-"+(n+1)).removeClass("purchase").addClass("disablepurchase");
										$("#uim_release_btn_-"+(n+1)).attr("disabled",false);
										$("#uim_release_btn_-"+(n+1)).removeClass("disablepurchase").addClass("purchase");
										$("#uim_txt_-"+(n+1)).val(_uimCode);
										var coupon = {
												couponUsageTypeCd : "3", //物品使用类型
												inOutTypeId : "1",  //出入库类型
												inOutReasonId : 0, //出入库原因
												saleId : 1, //销售类型
												couponId : response.data.mktResBaseInfo.mktResId, //物品ID
												couponinfoStatusCd : "A", //物品处理状态
												chargeItemCd : "3000", //物品费用项类型
												couponNum : response.data.mktResBaseInfo.qty, //物品数量
												storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
												storeName : "1", //仓库名称
												agentId : 1, //供应商ID
												apCharge : 0, //物品价格
												couponInstanceNumber : _uimCode, //物品实例编码
												terminalCode :_uimCode,//前台内部使用的UIM卡号
												ruleId : "", //物品规则ID
												partyId : OrderInfo.cust.custId, //客户ID
												prodId :  -(n+1), //产品ID
												offerId : offerId, //销售品实例ID
												state : "ADD", //动作
												relaSeq : "" //关联序列	
											};
										OrderInfo.clearProdUim(-(n+1));
										OrderInfo.boProd2Tds.push(coupon);
									}else{
										$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
									}
								}else{
									$.alert("提示","查询不到UIM信息");
								}
							}else if (response.code==-2){
								$.alertM(response.data);
							}else {
								$.alert("提示","UIM信息查询接口出错,稍后重试");
							}
							break;
						}
					}
					if(!uimflag){
						$.alert("提示","UIM卡"+_uimCode+"未匹配到接入号");
					}
				}
			}
		}
		//发展人
		if(OrderInfo.provinceInfo.salesCode!=""&&OrderInfo.reloadFlag=="Y"){
			order.main.queryDealer();
		}
	};
	
	function cleckUim(uim,prodId){
		var uimParam = {"instCode":uim};
		var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
		if (response.code==0) {
			if(response.data.mktResBaseInfo){
				if(response.data.mktResBaseInfo.statusCd=="1102"){
				//	$("#uim_check_btn_-"+(n+1)).attr("disabled",true);
				//	$("#uim_check_btn_-"+(n+1)).removeClass("purchase").addClass("disablepurchase");
				//	$("#uim_release_btn_-"+(n+1)).attr("disabled",false);
				//	$("#uim_release_btn_-"+(n+1)).removeClass("disablepurchase").addClass("purchase");
					$("#uim_txt_"+prodId).val(uim);
					var coupon = {
							couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
							inOutTypeId : "1",  //出入库类型
							inOutReasonId : 0, //出入库原因
							saleId : 1, //销售类型
							couponId :response.data.mktResBaseInfo.mktResId, //物品ID
							couponinfoStatusCd : "A", //物品处理状态
							chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
							couponNum : 1, //物品数量
							storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
							storeName : "1", //仓库名称
							agentId : 1, //供应商ID
							apCharge : 0, //物品价格
							couponInstanceNumber : uim, //物品实例编码
							ruleId : "", //物品规则ID
							partyId : OrderInfo.cust.custId, //客户ID
							prodId : prodId, //产品ID
							offerId : -1, //销售品实例ID
						//	attachSepcId : OrderInfo.offerSpec.offerSpecId,
							state : "ADD", //动作
							relaSeq : "" //关联序列	
						};
					OrderInfo.clearProdUim(prodId);
					OrderInfo.boProd2Tds.push(coupon);
				}else{
					$.alert("提示","UIM卡["+uim+"]不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
				}
			}else{
				$.alert("提示","查询不到UIM卡["+uim+"]信息");
			}
		}else if (response.code==-2){
			$.alertM(response.data);
		}else {
			$.alert("提示","UIM信息查询接口出错,稍后重试");
		}
	}
	//套餐变更提交组织报文
	var _changeOffer = function(busiOrders){
		_createDelOffer(busiOrders,OrderInfo.offer); //退订主销售品
		_createMainOffer(busiOrders,OrderInfo.offer); //订购主销售品	
		AttachOffer.setAttachBusiOrder(busiOrders);  //订购退订附属销售品
		if(CONST.getAppDesc()==0){ //4g系统需要,补换卡 
			if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //遍历主销售品构成
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
						if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
							var prod = {
								prodId : this.objInstId,
								prodSpecId : this.objId,
								accessNumber : this.accessNumber,
								isComp : "N",
								boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
							};
							var busiOrder = OrderInfo.getProdBusiOrder(prod);
							if(busiOrder){
								busiOrders.push(busiOrder);
							}
						}
					}
				});
			}
		}
	};
			
	//创建退订主销售品节点
	var _createDelOffer = function(busiOrders,offer){	
		offer.offerTypeCd = 1;
		offer.boActionTypeCd = CONST.BO_ACTION_TYPE.DEL_OFFER;
		var prodInfo = order.prodModify.choosedProdInfo;
		OrderInfo.getOfferBusiOrder(busiOrders,offer, prodInfo.prodInstId);
	};
	
	//创建主销售品节点
	var _createMainOffer = function(busiOrders,offer) {
		var prod = order.prodModify.choosedProdInfo;
		var offerSpec = OrderInfo.offerSpec;
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
				objName : offerSpec.offerSpecName,//业务名称
				objId : offerSpec.offerSpecId,  //业务规格ID
				offerTypeCd : "1", //1主销售品
				accessNumber : prod.accNbr  //接入号码
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
			}, 
			data:{
				ooRoles : [],
				ooOwners : [{
					partyId : OrderInfo.cust.custId, //客户ID
					state : "ADD" //动作
				}]
			}
		};
		//遍历主销售品构成
		$.each(offerSpec.offerRoles,function(){
			var offerRole = this;
			if(this.prodInsts!=undefined){
				$.each(this.prodInsts,function(){
					var prodInstId = '"'+this.prodInstId+'"';
					if(prodInstId.indexOf("-")==-1){
						var ooRoles = {
							objId : this.objId, //业务规格ID
							objInstId : this.prodInstId, //业务对象实例ID,新装默认-1
							objType : this.objType, // 业务对象类型
							offerRoleId : offerRole.offerRoleId, //销售品角色ID
							state : "ADD" //动作
						};
						busiOrder.data.ooRoles.push(ooRoles);
					}
				});
			}
		});
		
		if(offerChange.oldMemberFlag){//纳入老用户
			var offerRoleId = "";
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
							offerRoleId = offerRole.offerRoleId;
							break;
				} 
			}
			for(var q=0;q<OrderInfo.oldprodInstInfos.length;q++){
				var oldprodInfo = OrderInfo.oldprodInstInfos[q];
				var oldbusiOrder = {
						areaId : oldprodInfo.areaId,  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							objId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferId,  //业务规格ID
							instId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferInstId, //业务对象实例ID
							accessNumber : oldprodInfo.accNbr, //业务号码
							isComp : "Y", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER
						}, 
						data:{
							ooRoles : []			
						}
					};
					var memberid = -1;
					for ( var i = 0; i < OrderInfo.oldoffer.length; i++) {
						if(OrderInfo.oldoffer[i].accNbr==oldprodInfo.accNbr){
							$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
								if(this.objType==CONST.OBJ_TYPE.PROD){
									var ooRole = {
										objId : this.objId,
										objInstId : this.objInstId,
										objType : this.objType,
										offerMemberId : memberid,
										offerRoleId : offerRoleId,
										state : "ADD"
									};
									busiOrder.data.ooRoles.push(ooRole);
									var oldooRole = {
											objId : this.objId,
											objInstId : this.objInstId,
											objType : this.objType,
											offerMemberId : this.offerMemberId,
											offerRoleId : this.offerRoleId,
											state : "DEL"
										};
									oldbusiOrder.data.ooRoles.push(oldooRole);
									--memberid;
								}
							});
						}
					}
				busiOrders.push(oldbusiOrder);
			}
			if(CONST.getAppDesc()==0){ //4g系统需要,补换卡 
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) { //遍历主销售品构成
					$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
							if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
								var prod = {
									prodId : this.objInstId,
									prodSpecId : this.objId,
									accessNumber : this.accessNumber,
									isComp : "N",
									boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
								};
								var busiOrder = OrderInfo.getProdBusiOrder(prod);
								if(busiOrder){
									busiOrders.push(busiOrder);
								}
							}
						}
					});
				}
			}
		}
		if(offerChange.newMemberFlag){
			//遍历主销售品构成
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
					if(offerRole.prodInsts!=undefined && offerRole.prodInsts.length>0){
						for ( var j = 0; j < offerRole.prodInsts.length; j++) {
							var prodInst = offerRole.prodInsts[j];
							var instid = '"'+prodInst.prodInstId+'"';
							if(prodInst.memberRoleCd=="401" && instid.indexOf("-")!=-1){
								var ooRole = {
										objId : prodInst.objId,
										objInstId : prodInst.prodInstId,
										objType : prodInst.objType,
										offerMemberId : OrderInfo.SEQ.offerMemberSeq--,
										offerRoleId : prodInst.offerRoleId,
										state : "ADD"
									};
								busiOrder.data.ooRoles.push(ooRole);
								busiOrders.push(SoOrder.createProd(prodInst.prodInstId,prodInst.objId));	
							}
						}		
					}
				} 
			} 
		}

		//销售参数节点
		if(ec.util.isArray(offerSpec.offerSpecParams)){  
			busiOrder.data.ooParams = [];
			for (var i = 0; i < offerSpec.offerSpecParams.length; i++) {
				var param = offerSpec.offerSpecParams[i];
				var ooParam = {
	                itemSpecId : param.itemSpecId,
	                offerParamId : OrderInfo.SEQ.paramSeq--,
	                offerSpecParamId : param.offerSpecParamId,
	                value : param.value,
	                state : "ADD"
	            };
	            busiOrder.data.ooParams.push(ooParam);
			}				
		}
		
		//销售生失效时间节点
		if(offerSpec.ooTimes !=undefined ){
			busiOrder.data.ooTimes = [];
			busiOrder.data.ooTimes.push(offerSpec.ooTimes);
		}
		
		//发展人
		busiOrder.data.busiOrderAttrs = [];
		var $tr = $("tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");
		if($tr!=undefined){
			$tr.each(function(){   //遍历产品有几个发展人
				var dealer = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
					role : $(this).find("select").val(),
					value : $(this).find("input").attr("staffid"),
					channelNbr : $(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()
				};
				busiOrder.data.busiOrderAttrs.push(dealer);
				var dealer_name = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("value") 
				};
				busiOrder.data.busiOrderAttrs.push(dealer_name);	
			});
		}
		busiOrders.push(busiOrder);
	};
	
	//填单页面切换
	var _changeTab = function(prodId) {
		$.each($("#tab_"+prodId).parent().find("li"),function(){
			$(this).removeClass("setcon");
			$("#attach_tab_"+$(this).attr("prodId")).hide();
			$("#uimDiv_"+$(this).attr("prodId")).hide();
			$("#change_"+$(this).attr("prodId")).hide();
			$("#newProd_"+$(this).attr("prodId")).hide();
		});
		$("#tab_"+prodId).addClass("setcon");
		$("#attach_tab_"+prodId).show();
		$("#change_"+prodId).show();
		if(AttachOffer.isChangeUim(prodId)){
			$("#title_"+prodId).show();
			$("#uimDiv_"+prodId).show();
		}
		if(OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 2){
			var viceChangeFlag = false;
			if(OrderInfo.actionFlag == 6){
				$.each(order.memberChange.viceparams,function(){
					if(this.objInstId == prodId){
						viceChangeFlag = true;
						return false;
					}
				});
			}
			if(OrderInfo.actionFlag == 2){
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.objInstId == prodId){
						viceChangeFlag = true;
						return false;
					}
				});
			}
			if(viceChangeFlag){
				$("#accountDiv").hide();
				$("#orderAttrDiv").hide();
				$("#orderProvAttrDiv").show();
			}else{
				$("#accountDiv").show();
				$("#orderProvAttrDiv").hide();
				var newProdId = "'"+prodId+"'";
				if(newProdId.indexOf("-")!= -1){
					$("#newProd_"+prodId).show();
					$("#orderAttrDiv").show();
				}else{
					$("#orderAttrDiv").hide();
				}
			}
		}
	};
	
	//省里校验单
	var _checkOrder = function(prodId){
		if(OrderInfo.actionFlag==3){
			_getAttachOfferInfo();
		}else{
			_getChangeInfo();
		}
		var data = query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));
		OrderInfo.orderData.orderList.custOrderList[0].busiOrder = []; //校验完清空
		if(data==undefined){
			return false;
		}
		if(data.resultCode==0 && ec.util.isObj(data.result)){ //预校验成功
			offerChange.resultOffer = data.result;
		}else {
			$.alert("预校验规则限制",data.resultMsg);
			offerChange.resultOffer = {}; 
			return false;
		}
		return true;
	};
	
	//3G套餐订购4G流量包时预校验的入参封装
	var _getAttachOfferInfo=function(){
		OrderInfo.getOrderData(); //获取订单提交节点	
		OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		var busiOrders = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;//获取业务对象数组
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C" && spec.ifPackage4G=="Y"){  //订购的附属销售品
					spec.offerTypeCd = 2;
					spec.boActionTypeCd = CONST.BO_ACTION_TYPE.BUY_OFFER;
					spec.offerId = OrderInfo.SEQ.offerSeq--; 
					OrderInfo.getOfferBusiOrder(busiOrders,spec,open.prodId);	
				}
			}
		}
		$.each(busiOrders,function(){
			this.busiObj.state="ADD";
		});
	};
	
	//把旧套餐的产品自动匹配到新套餐中，由于现在暂时只支持主副卡跟单产品，所以可以自动匹配
	var _setChangeOfferSpec = function(memberNum,viceNum){
		if(memberNum==1){ //单产品变更
			var offerRole = getOfferRole();
			if(offerRole==undefined){
				alert("错误提示","无法变更到该套餐");
				return false;
			}
			offerRole.prodInsts = [];
			var flag=false;
			$.each(offerRole.roleObjs,function(){
				if(this.objType==CONST.OBJ_TYPE.PROD){
					var roleObj = this;
					flag=false;
					$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
						if(this.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
							if(roleObj.objId!=this.objId){
								$.alert("规则限制","新套餐【"+roleObj.offerRoleName+"】角色的规格ID【"+roleObj.objId+"】和旧套餐【"+this.roleName+"】角色的规格ID【"+this.objId+"】不一样");
								flag=true;
								return false;
							}
							roleObj.prodInstId = this.objInstId;
							roleObj.accessNumber = this.accessNumber;
							roleObj.memberRoleCd = this.roleCd;
							offerRole.prodInsts.push(roleObj);
						}
					});
					if(flag){
						return false;
					}
				}
			});
			if(flag){
				return false;
			}
		}else{  //多成员角色
			for (var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[i];
				if(offerMember.objType==CONST.OBJ_TYPE.PROD){
					var flag = true;
					for (var j = 0; j < OrderInfo.offerSpec.offerRoles.length; j++) {
						var offerRole = OrderInfo.offerSpec.offerRoles[j];
						if(offerMember.roleCd==offerRole.memberRoleCd){ //旧套餐对应新套餐角色
							for (var k = 0; k < offerRole.roleObjs.length; k++) {
								var roleObj = offerRole.roleObjs[k];
								if(roleObj.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
									if(roleObj.objId!=offerMember.objId){
										$.alert("规则限制","新套餐【"+roleObj.offerRoleName+"】角色的规格ID【"+roleObj.objId+"】和旧套餐【"+offerMember.roleName+"】角色的规格ID【"+offerMember.objId+"】不一样");
										return false;
									}
									if(!ec.util.isArray(offerRole.prodInsts)){
										offerRole.prodInsts = [];
									}
									var newObject = jQuery.extend(true, {}, roleObj); 
									newObject.prodInstId = offerMember.objInstId;
									newObject.accessNumber = offerMember.accessNumber;
									newObject.memberRoleCd = offerMember.roleCd;
									offerRole.prodInsts.push(newObject);
									if(offerRole.prodInsts.length>roleObj.maxQty){
										$.alert("规则限制","新套餐【"+offerRole.offerRoleName+"】角色最多可以办理数量为"+roleObj.maxQty+",而旧套餐数量大于"+roleObj.maxQty);
										return false;
									}
									break;
								}
							}
							flag = false;
							break;
						}
					}
					if(flag){
						$.alert("规则限制","旧套餐【"+offerMember.roleName+"】角色在新套餐中不存在，无法变更");
						return false;
					}
				}
			}
		}
		return true;
	};
	
	//获取单产品变更自动匹配的角色
	var getOfferRole = function(){
		//新套餐是主副卡,获取主卡角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){  //主卡
				return offerRole;
			}
		}
		//新套餐不是主副卡，返回第一个包含接入产品的角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			for (var j = 0; j < offerRole.roleObjs.length; j++) {
				var roleObj = offerRole.roleObjs[j];
				if(roleObj.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
					return offerRole;
				}
			}
		}
	};
	
	//获取套餐变更节点
	var _getChangeInfo = function(){
		OrderInfo.getOrderData(); //获取订单提交节点
		OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		OrderInfo.orderData.orderList.orderListInfo.areaId = OrderInfo.cust.areaId;
		var busiOrders = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;//获取业务对象数组
		_createDelOffer(busiOrders,OrderInfo.offer); //退订主销售品
		_createMainOffer(busiOrders,OrderInfo.offer); //订购主销售品	
	};
	
	//根据省内返回的数据校验
	var _checkOfferProd = function(){
		if(offerChange.resultOffer==undefined){
			return;
		}
		//功能产品
		var prodInfos = offerChange.resultOffer.prodInfos;
		if(ec.util.isArray(prodInfos)){
			$.each(prodInfos,function(){
				var prodId = this.accProdInstId;
				//容错处理，省份接入产品实例id传错
				var flag = true;
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var serv = CacheData.getServ(prodId,this.prodInstId);
					if(this.state=="DEL"){
						if(serv!=undefined){
							var $span = $("#li_"+prodId+"_"+this.prodInstId).find("span");
							$span.addClass("del");
							serv.isdel = "Y";
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined){  //在已开通里面，修改不让关闭
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}else{
							var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
							if(servSpec!=undefined){
								$("#del_"+prodId+"_"+this.productId).hide();
							}else {
								
								var productName=this.productName;
								if(this.productId!=undefined && this.productId!=""){
									//AttachOffer.addOpenServList(prodId,this.productId,this.prodName,this.ifParams);
									AttachOffer.openServSpec(prodId,this.productId,this.productName,this.ifParams);
								}
							}
						}
					}
				}
			});
		}
		
		//可选包
		var offers = offerChange.resultOffer.prodOfferInfos;
		if(ec.util.isArray(offers)){
			if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){//多产品套餐
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					var prodId = this.objInstId;
					$.each(offers,function(){
						if(this.memberInfo==undefined){
							return true;
						}
						var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已开通里面查找
						var flag = true;
						$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
							if(prodId == this.accProdInstId){		
								if(ec.util.isObj(offer)){
									this.prodId = this.accProdInstId;
//									offer.offerMemberInfos = [];
//									offer.offerMemberInfos.push(this);
								}
								flag = false;
								return false;
							}
						});
						if(flag){
							return true;
						}
						if(this.state=="DEL"){
							if(offer!=undefined){
								var $span = $("#li_"+prodId+"_"+this.prodOfferInstId).find("span");
								$span.addClass("del");
								offer.isdel = "Y";
								if(this.isRepeat!="Y"){//如果可选包下面有多个接入类产品，到时候只拼一个退订节点
									this.isRepeat="Y";
								}else{
									offer.isRepeat="Y";
								}
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}	
						}else if(this.state=="ADD"){
							if(offer!=undefined){ //在已开通里面，修改不让关闭
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}else{
								var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已开通里面查找
								if(offerSpec!=undefined){
									$("#del_"+prodId+"_"+this.prodOfferId).hide();
								}else {
									if(ec.util.isObj(this.prodOfferId) && this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){
										//AttachOffer.addOpenList(prodId,this.prodOfferId);			
										AttachOffer.addOfferSpecByCheck(prodId,this.prodOfferId);
									}
								}
							}
						}
					});
				});
			}
		}
	};
	
	//根据省内返回的数据校验拼成html
	var _checkAttachOffer = function(prodId){
		var content="";
		if(offerChange.resultOffer==undefined){
			return content;
		}
		//功能产品
		var prodInfos = offerChange.resultOffer.prodInfos;
		if(ec.util.isArray(prodInfos)){
			var str = "";
			$.each(prodInfos,function(){
//				var prodId = this.accProdInstId;
//				//容错处理，省份接入产品实例id传错
//				var flag = true;
//				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
//					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
//						flag = false;
//						return false;
//					}
//				});
				if(prodId!=this.accProdInstId){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var serv = CacheData.getServ(prodId,this.prodInstId);//已开通功能产品里面查找
					var servSpec = CacheData.getServSpec(prodId,this.productId);//已选功能产品里面查找
					if(this.state=="DEL"){
						if(serv!=undefined){
							str+='<li id="li_'+prodId+'_'+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N">'
									+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
									+'<span class="del">'+serv.servSpecName+'</span>'
								+'</li>';
						}else{
							if(servSpec!=undefined){
								str+='<li id="li_'+prodId+'_'+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N">'
										+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
										+'<span class="del">'+servSpec.servSpecName+'</span>'
									+'</li>';
							}else if(this.productName!=undefined && this.productName!=""){
								str+='<li id="li_'+prodId+'_'+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N">'
										+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
										+'<span class="del">'+this.productName+'</span>'
									+'</li>';
							}
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined){
							str+='<li id="li_'+prodId+'_'+this.prodInstId+'">'
									+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
									+'<span>'+serv.servSpecName+'</span>'
									+'<dd class="mustchoose"></dd>'
								+'</li>';
						}else{
							if(servSpec!=undefined){
								str+='<li id="li_'+prodId+'_'+this.prodInstId+'">'
										+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
										+'<span>'+servSpec.servSpecName+'</span>'
										+'<dd class="mustchoose"></dd>'
									+'</li>';
							}else if(this.productName!=undefined && this.productName!=""){
								str+='<li id="li_'+prodId+'_'+this.prodInstId+'">'
										+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
										+'<span>'+this.productName+'</span>'
										+'<dd class="mustchoose"></dd>'
									+'</li>';
								}
						}
					}
				}
			});
			if(str==""){
				content="";
			}else{
				content="<div class='fs_choosed'>订购4G流量包，需订购和取消如下功能产品：<br><ul>"+str+"</ul></div><br>";
			}
		}
		
		
		//可选包
		var offers = offerChange.resultOffer.prodOfferInfos;
		if(ec.util.isArray(offers)){
			var str="";
			$.each(offers,function(){
				if(this.memberInfo==undefined){
					return true;
				}
				var flag = true;
				$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
					if(ec.util.isObj(this.accProdInstId)&&prodId == this.accProdInstId){
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已订购里面查找
				var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已选里面查找
				if(this.state=="DEL"){
					if(offer!=undefined){
						str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N">'
								+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
								+'<span class="del">'+offer.offerSpecName+'</span>'
							+'</li>';
					}else{
						if(offerSpec!=undefined){
							str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N">'
									+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
									+'<span class="del">'+offerSpec.offerSpecName+'</span>'
								+'</li>';
						}else if(this.prodOfferName!=undefined && this.prodOfferName!=""){
							str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N">'
									+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
									+'<span class="del">'+this.prodOfferName+'</span>'
								+'</li>';
						}
					}	
				}else if(this.state=="ADD"){
					if(offer!=undefined){
						str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'">'
								+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
								+'<span>'+offer.offerSpecName+'</span>'
								+'<dd class="mustchoose"></dd>'
							+'</li>';
					}else{
						if(offerSpec!=undefined){
							str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'">'
									+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
									+'<span>'+offerSpec.offerSpecName+'</span>'
									+'<dd class="mustchoose"></dd>'
								+'</li>';
						}else if(this.prodOfferName!=undefined && this.prodOfferName!=""){
							str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'">'
									+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
									+'<span>'+this.prodOfferName+'</span>'
									+'<dd class="mustchoose"></dd>'
								+'</li>';
						}
					}
				}
			});
			if(str!=""){
				content+="<div class='fs_choosed'>订购4G流量包，需开通和关闭如下可选包：<br><ul>"+str+"</ul></div>";
			}
		}
		
		return content;
	};
	
	//初始化省内订单属性
	var _initOrderProvAttr = function(){
		//var obj=$("#orderProvAttrIsale").val;
		if($("#orderProvAttrIsale")){
			$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale);
		}
			
		
		var url=contextPath+"/order/provOrderAttrFlag";
		$.ecOverlay("<strong>正在查询是否显示省内订单属性,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,{});	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data!=undefined){
				if("0"==response.data){
					$("#orderProvAttrDiv").show();
					if(order.memberChange.reloadFlag=="N"){
						var custOrderAttrs = order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;
						$.each(custOrderAttrs,function(){
							//省内订单属性
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.PROV_ISALE){
								$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale);
							}
						});
					}
				}
			}
		}
	};
	
	return {
		init 					: _init,
		changeOffer 			: _changeOffer,
		offerChangeView			: _offerChangeView,
		changeTab				: _changeTab,
		checkOrder				: _checkOrder,
		checkAttachOffer		: _checkAttachOffer,
		fillOfferChange			: _fillOfferChange,
		resultOffer				: _resultOffer,
		checkOfferProd			: _checkOfferProd,
		getChangeInfo			: _getChangeInfo,
		initOrderProvAttr		: _initOrderProvAttr,
		setChangeOfferSpec		: _setChangeOfferSpec,
		offerChangeConfirm		: _offerChangeConfirm
	};
})();
/**
 * 销售品产品相关查询
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("query","offer");

query.offer = (function() {
	
	/**
	 * 销售品规格构成查询
	 * @param  offerSpecId 销售品规格ID
	 * @param  offerTypeCd 销售品类型,销售品主 1 ,附属2  
	 * @param  mainOfferSpecId  主套餐id
	 * @param  partyId  客户ID
	 * @callBackFun 回调函数
	 */
	var _queryOfferSpec = function(param,callBackFun) {
		param.areaId = OrderInfo.cust.areaId;
		var url= contextPath+"/token/pc/offer/queryOfferSpec";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data.offerSpec);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品规格构成失败,稍后重试");
					}
				}
			});
		}else{
			$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data.offerSpec;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品规格构成失败,稍后重试");
			}
		}
	};

	/**
	 * 销售品实例构成查询
	 * @param  offerId 销售品实例ID
	 * @param  areaId 地区ID
	 * @param  accessNumber 接入号
	 * @callBackFun 异步调用函数
	 */
	var _queryOfferInst = function(param,callBackFun) {
		var url= contextPath+"/offer/queryOfferInst";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品实例失败,稍后重试");
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品实例失败,稍后重试");
			}
		}
	};
	var _queryMainCartAttachOffer = function(param) {
		addParam(param);  //添加基本参数
		//新增能力开放标识
		param.isServiceOpen="Y";
		var url = contextPath+"/offer/queryMainCartAttachOffer";
		$.callServiceAsJsonGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				$.unecOverlay();
				if (response.code==0) {
					if(response.data){
						var offerLists = response.data.result.offerLists;
						//AttachOffer.mainCartOpenedList.push({"prodId":param.prodId,"offerLists":offerLists,"accessNumber":param.acctNbr});
					}
				}else {
					$.alert("提示","附属销售品实例查询失败,稍后重试");
					return;
				}
			}
		});
	};
	//根据选择产品查询销售品实例，并保存到OrderInfo.offer
	var _setOffer = function() {
		var prod = order.prodModify.choosedProdInfo ; 
		var param = {
			offerId : prod.prodOfferInstId,
			offerSpecId : prod.prodOfferId,
			acctNbr : prod.accNbr,
			areaId : prod.areaId,
			distributorId : ""
		};
		var data = query.offer.queryOfferInst(param); //查询销售品实例构成
		if(data && data.code == CONST.CODE.SUCC_CODE){
			var flag = true;
			if(ec.util.isArray(data.offerMemberInfos)){
				CacheData.sortOffer(data);
				for ( var i = 0; i < data.offerMemberInfos.length; i++) {
					var member = data.offerMemberInfos[i];
					if(member.objType==""){
						$.alert("提示","销售品实例构成 "+member.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");
						return false;
					}else if(member.objType==CONST.OBJ_TYPE.PROD){
						/*if(member.objId==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品规格【objId】节点为空，无法继续受理,请营业后台核实");
							return false;
						}*/
						if(member.accessNumber==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
							return false;
						}
					}
					if(member.objInstId==prod.prodInstId){
						flag = false;
					}
				}
				if(flag){
					$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+prod.accNbr+"】，无法继续受理，请业务后台核实");
					return false;
				}
				OrderInfo.offer.offerMemberInfos = data.offerMemberInfos; 
				OrderInfo.offer.offerId = prod.prodOfferInstId;
				OrderInfo.offer.offerSpecId = prod.prodOfferId;
				OrderInfo.offer.offerSpecName = prod.prodOfferName;
				return true;
			}else{//销售品成员实例为空
				$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");
				return false;
			}
		}
	};
	
	//销售品参数查询
	var _queryOfferParam = function(param,callBackFun) {
		var url= contextPath+"/offer/queryOfferParam";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品实例参数失败,稍后重试");
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品实例参数失败,稍后重试");
			}
		}
	};	
	
	/**
	 * 已订购附属查询 
	 */
	var _queryAttachOfferHtml = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryAttachOffer";
		if(OrderInfo.actionFlag==22){
			url = contextPath+"/offer/queryAttachOffer2";
		}
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else {
						$.alert("提示","附属销售品实例查询失败,稍后重试");
						return;
					}
				}
			});
		}else{
			$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}		
	};
	
	/**
	 * 已订购销售品和功能产品
	 */
	var _queryOpenedAttachAndServ = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryOpenedAttachAndServ";
		$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else {
			$.alert("提示","查询附属销售品失败,稍后重试");
			return;
		}
	};
	
	//套餐变更，查询附属销售品页面
	var _queryChangeAttachOffer = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		param.isServiceOpen="Y";
		var url = contextPath+"/token/pc/offer/queryChangeAttachOffer";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else {
						$.alert("提示","附属销售品实例查询失败,稍后重试");
						return;
					}
				}
			});
		}else{
			$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else {
				$.alert("提示","查询附属销售品实例失败,稍后重试");
				return;
			}
		}		
	};
	
	//附属销售品规格查询
	var _queryAttachSpec = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		
		param.isServiceOpen="Y";
		
		var url = contextPath+"/token/pc/offer/queryAttachSpec";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
						return;
					}else {
						$.alert("提示","附属销售品查询失败,稍后重试");
						return;
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
				return;
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}
	};
	
	//加载附属标签下的附属销售品
	var _queryCanBuyAttachSpec = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryCanBuyAttachSpec";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
						return;
					}else {
						$.alert("提示","附属销售品查询失败,稍后重试");
						return;
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");
			var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
				return;
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}
	};
	
	// 查询默认必须可选包
	var _queryDefMustOfferSpec = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryDefaultAndRequiredOfferSpec";
		$.ecOverlay("<strong>查询默认必须可选包中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			OrderInfo.isSuccess = "Y";
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购功能产品失败,稍后重试");
			return;
		}
	};
	// 查询默认必须可选包 + 功能产品 (补换卡加可选包)
	var _queryDefMustOfferSpecAndServ = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryDefaultAndRequiredOfferSpecAndServ";
		$.ecOverlay("<strong>查询默认必须可选包和功能产品中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			OrderInfo.isSuccess = "Y";
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购可选包和功能产品失败,稍后重试");
			return;
		}
	};
	
	// 查询功能产品规格,(默认1，必须2，可订购3)
	var _queryServSpec = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryServSpec";
		$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购功能产品失败,稍后重试");
			return;
		}
	};
	
	//销售品互斥依赖查询
	var _queryExcludeDepend = function(param){
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryExcludeDepend";
		$.ecOverlay("<strong>规则校验中,请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","数据查询异常，请稍后重试！");
		}
	};
		
	//功能产品互斥依赖查询
	var _queryServExcludeDepend = function(param){
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryServExcludeDepend";
		$.ecOverlay("<strong>规则校验中,请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","数据查询异常，请稍后重试！");
		}
	};
	
	//查询附属销售品规格
	var _searchAttachOfferSpec = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/searchAttachOfferSpec";
		$.ecOverlay("<strong>附属销售品查询中，请稍等...</strong>");
		var response = $.callServiceAsHtmlGet(url,{strParam:encodeURI(JSON.stringify(param),"utf-8")});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","查询附属销售失败，请稍后重试！");
		}
	};
	
	//受理权限查询
	var _checkOperate = function(param) {
		var url = contextPath+"/order/checkOperate";
		$.ecOverlay("<strong>受理权限查询中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,"");
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","受理权限查询失败，请稍后重试！");
		}
	};
	
	//订单提交
	var _orderSubmit = function(param) {
		var url = contextPath+"/order/orderSubmit";
		if(OrderInfo.order.token!=""){
			url = contextPath+"/order/orderSubmit?token="+OrderInfo.order.token;
		}
		$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
		var response = $.callServiceAsHtml(url,param);
		$.unecOverlay();
		if(!response || response.code != 0){
			 return;
		}
		return response.data;
	};
	
	//订单提交（一次性）
	var _orderSubmitComplete = function(param) {
		var url = contextPath+"/order/orderSubmitComplete";
		if(OrderInfo.order.token!=""){
			url = contextPath+"/order/orderSubmitComplete?token="+OrderInfo.order.token;
		}
		$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if(!response || response.code != 0){
			 return;
		}
		return response.data;
	};	
	
	/**
	 * 查询主销售品规格构成
	 * 并对结果进行数据校验
	 */
	var _queryMainOfferSpec = function(param){
		var offerSpec = query.offer.queryOfferSpec(param); //查询主销售品构成
		if(offerSpec ==undefined){
			return false;
		}
		if( offerSpec.offerRoles ==undefined){
			$.alert("错误提示","销售品规格构成查询: 返回的销售品规格构成结构不对！");
			return false;
		}
		if(offerSpec.offerSpecId==undefined || offerSpec.offerSpecId==""){
			$.alert("错误提示","销售品规格构成查询: 销售品规格ID未返回，无法继续受理！");
			return false;
		}
		if(offerSpec.offerRoles.length == 0){
			$.alert("错误提示","销售品规格构成查询: 成员角色为空，无法继续受理！");
			return false;
		}
		if(offerSpec.feeType ==undefined || offerSpec.feeType=="" || offerSpec.feeType=="null"){
			$.alert("错误提示","无付费类型，无法新装！");
			return false;
		}
		offerSpec = SoOrder.sortOfferSpec(offerSpec); //排序主副卡套餐	
		if((OrderInfo.actionFlag==6||OrderInfo.actionFlag==2||OrderInfo.actionFlag==1) && ec.util.isArray(OrderInfo.oldprodInstInfos)){//主副卡纳入老用户
			OrderInfo.oldofferSpec.push({"offerSpec":offerSpec,"accNbr":param.accNbr});
		}else{
			OrderInfo.offerSpec = offerSpec;
		}
		return offerSpec;
	};
	
	/**
	 * 同步查询销售品规格构成
	 * 并对结果进行数据校验
	 */
	var _queryAttachOfferSpec = function(prodId,offerSpecId){
		var param = {
			offerSpecId:offerSpecId,
			partyId : OrderInfo.cust.custId,
			offerTypeCd:2	
		};	
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==2 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==14){//新装业务,添加主套餐id用于查询终端
			param.mainOfferSpecId = OrderInfo.offerSpec.offerSpecId;
		}
		if(OrderInfo.actionFlag==3){//可选包
			param.mainOfferSpecId = order.prodModify.choosedProdInfo.prodOfferId;
		}
		if(OrderInfo.actionFlag==21){//副卡换挡
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					if(this.prodId==prodId){
						param.mainOfferSpecId=this.offerSpecId;
						return false;
					}
				});
			}
		}
		var offerSpec = query.offer.queryOfferSpec(param); //查询主销售品构成
		if(offerSpec ==undefined || offerSpec.offerRoles ==undefined){
			$.alert("提示","返回的销售品规格构成结构不对！");
			return false;
		}
		if(offerSpec.offerSpecId==undefined || offerSpec.offerSpecId==""){
			$.alert("提示","销售品规格ID未返回，继续受理将出现异常！");
			return false;
		}
		if(offerSpec.offerSpecName==undefined || offerSpec.offerSpecName==""){
			$.alert("提示","销售品规格名称未返回，继续受理将出现异常！");
			return false;
		}
		var offerRoles = []; //过滤角色
		var prodSpecId = OrderInfo.getProdSpecId(prodId);
		var flag = false;
		$.each(offerSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objId==prodSpecId){
					flag = true;
					return false;
				}
			});
			if(flag){
				offerRoles.push(this);
				return false;
			}
		});
		offerSpec.offerRoles = offerRoles;
		return offerSpec;
	};
	
	//预校验
	var _updateCheckByChange = function(param){
		var url = contextPath+"/order/prodModify/updateCheckByChange";
		$.ecOverlay("<strong>正在预校验中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == 0) {
			return response.data;
		}else if (response.code == -2) {
			$.alertM(response.data);
		}else{
		    if (response.data.resultMsg) {
		        $.alert("提示","预校验失败!失败原因为："+response.data.resultMsg);
		    } else {
		        $.alert("提示","预校验失败! 集团营业后台未给出原因。");
		    }
		}
	};
	
	/**
	 * 加载实例
	 * 如果传入了paramInfo，则使用它，否则拼入参
	 */
	var _loadInst = function(){
		if(OrderInfo.order.soNbr==null || OrderInfo.order.soNbr==undefined || OrderInfo.order.soNbr==""){
			OrderInfo.order.soNbr = UUID.getDataId();
		}
		if(CONST.getAppDesc()!=0){ //不是4g不需要加载
			return true;
		}
		
		if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 14 || OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){ //新装不要加载实例
			return true;
		}
		
		if (order.prodModify == undefined) { // 如果没有引入orderProdModify.js
			$.alert("提示","未获取到产品相关信息，无法办理二次业务！");
			return false;
		}
		var prod = order.prodModify.choosedProdInfo;
		if(prod==undefined || prod.prodInstId ==undefined){
			$.alert("提示","未获取到产品相关信息，无法办理二次业务！");
			return false;
		}
		
		var param = {
			areaId : OrderInfo.getProdAreaId(prod.prodInstId),
			acctNbr : prod.accNbr,
			custId : OrderInfo.cust.custId,
			soNbr : OrderInfo.order.soNbr,
			instId : prod.prodInstId,
			type : "2",
			queryType: "1,2,3,4,5",
			acctNbr : "",
			data:[]
		};
		
		//获取判断是调用新的全量接口是旧的全量接口
		var queryMergeFlag=OrderInfo.provinceInfo.mergeFlag;
		
		if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //遍历主销售品构成
			var flag = true;
			$.each(OrderInfo.offer.offerMemberInfos,function(){
				if(this.objType == CONST.OBJ_TYPE.PROD && this.accessNumber==prod.accNbr){ //选中号码在销售品实例构成中，为了防止销售品实例缓存
					flag = false;
					return false;
				}
			});
			
			if(flag){ //不在销售品实例缓存
				if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
					param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
					return _invokeLoadInstSub(param);
				}else{
					return query.offer.invokeLoadInst(param);
				}
			}else{
				var vFlag = true;
				
				//1调用新接口，如果是0，就是按照旧的方式调用
				if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD){
							param.data.push({accessNbr:this.accessNumber,instId:this.objInstId});
						}
					});
					
					if(param!=null){
						if (!_invokeLoadInstSub(param)) {
							vFlag = false;
							return false;
						}
					}
				}else{
					//按旧的方式调用
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD){
							param.acctNbr = this.accessNumber;
							param.instId = this.objInstId;
							if (!query.offer.invokeLoadInst(param)) {
								vFlag = false;
								return false;
							}
						}
					});
				}
				
				return vFlag;
			}
		}else{
			if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
				param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
				return _invokeLoadInstSub(param);
			}else{
				return query.offer.invokeLoadInst(param);
			}
		}
	};
	
	//补充查询基本条件
	var addParam = function(param){
		param.staffId = OrderInfo.staff.staffId;
		param.channelId = OrderInfo.staff.channelId;
		param.areaId = OrderInfo.getProdAreaId(param.prodId);
		param.partyId = OrderInfo.cust.custId;
		param.distributorId = OrderInfo.staff.distributorId;
		if(OrderInfo.actionFlag == 3){
			param.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId;
		}else if(OrderInfo.actionFlag==21){
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					if(this.prodId==param.prodId){
						param.mainOfferSpecId=this.offerSpecId;
						return false;
					}
				});
			}
		}else{
			param.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId;
		}
		if(ec.util.isObj(OrderInfo.order.soNbr)){  //缓存流水号
			param.soNbr = OrderInfo.order.soNbr;
		}
		if(order.ysl!=undefined){
			if(order.ysl.yslbean.yslflag!=undefined){
				param.yslflag = order.ysl.yslbean.yslflag;
			}
		}
		if(OrderInfo.actionFlag==6 || OrderInfo.actionFlag==2){//主副卡纳入老用户
			for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
				if(param.acctNbr==OrderInfo.oldprodInstInfos[i].accNbr){
					param.areaId = OrderInfo.oldprodInstInfos[i].areaId;
					param.partyId = OrderInfo.oldprodInstInfos[i].custId;
					param.mainOfferSpecId=OrderInfo.oldprodInstInfos[i].mainProdOfferInstInfos[0].prodOfferId;
				}
			}
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					if(this.prodId==param.prodId){
						param.mainOfferSpecId=this.offerSpecId;
						return false;
					}
				});
			}
		}
	};
	
	var _invokeLoadInstSub = function(param) {
		order.prepare.createorderlonger();
		var url = contextPath+"/token/pc/offer/loadInstNew";
		$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,JSON.stringify(param));
		$.unecOverlay();
		if (response.code== 0) {
			return true;
		}else if(response.code==-2){
			$.alertM(response.data);
			return false;
		}else {
			if (response.msg == undefined) {
				$.alert("提示", "全量信息查询失败");
			} else {				
				$.alert("提示",response.msg);
			}
			return false;
		}
	};
	
	var _invokeLoadInst = function(param) {
		order.prepare.createorderlonger();
		var url = contextPath+"/offer/loadInst";
		$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);
		$.unecOverlay();
		if (response.code== 0) {
			return true;
		}else if(response.code==-2){
			$.alertM(response.data);
			return false;
		}else {
			if (response.msg == undefined) {
				$.alert("提示", "全量信息查询失败");
			} else {				
				$.alert("提示",response.msg);
			}
			return false;
		}
	};
	
	/**
	 * 产品信息查询
	 */
	var _queryProduct = function(param) {
		var url = contextPath+"/cust/offerorderprod";
		$.ecOverlay("<strong>查询产品信息中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else {
			$.alert("提示","查询附属销售品失败,稍后重试");
			return;
		}
	};
	
	/**
	 * 查询产品实例属性
	 * param : {
	 * prodId : "", //产品实例id
	 * acctNbr : "", //接入号
	 * prodSpecId : "", //产品规格id
	 * areaId : "" //地区id
	 * }
	 */
	var _queryProdInstParam = function(param) {
		var url = contextPath+"/order/prodInstParam";
		$.ecOverlay("<strong>查询产品实例属性中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else {
			$.alert("提示","查询附属销售品失败,稍后重试");
			return;
		}
	};
	
	// 查询功能产品规格,(默认1，必须2，可订购3)
	var _queryServSpecPost = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryServSpecPost";
		$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购功能产品失败,稍后重试");
			return;
		}
	};
	
	return {
		checkOperate			: _checkOperate,
		loadInst				: _loadInst,
		invokeLoadInst			: _invokeLoadInst,
		setOffer				: _setOffer,
		searchAttachOfferSpec	: _searchAttachOfferSpec,
		queryOfferSpec			: _queryOfferSpec,
		queryServSpec			: _queryServSpec,
		queryOfferInst 			: _queryOfferInst,
		queryOfferParam 		: _queryOfferParam,
		queryAttachOfferHtml	: _queryAttachOfferHtml,
		queryChangeAttachOffer  : _queryChangeAttachOffer,
		queryCanBuyAttachSpec 	: _queryCanBuyAttachSpec,
		queryExcludeDepend		: _queryExcludeDepend,
		queryServExcludeDepend	: _queryServExcludeDepend,
		queryAttachSpec			: _queryAttachSpec,
		queryMainOfferSpec		: _queryMainOfferSpec,
		queryAttachOfferSpec	: _queryAttachOfferSpec,
		queryDefMustOfferSpec	: _queryDefMustOfferSpec,
		queryDefMustOfferSpecAndServ : _queryDefMustOfferSpecAndServ,
		orderSubmit				: _orderSubmit,
		orderSubmitComplete		: _orderSubmitComplete,
		updateCheckByChange		: _updateCheckByChange,
		queryProduct			: _queryProduct,
		queryOpenedAttachAndServ: _queryOpenedAttachAndServ,
		queryMainCartAttachOffer: _queryMainCartAttachOffer,
		queryProdInstParam		: _queryProdInstParam,
		invokeLoadInstSub		:_invokeLoadInstSub,
		queryServSpecPost		: _queryServSpecPost
		
	};
})();
CommonUtils.regNamespace("order", "service");

order.service = (function(){
	var _offerprice=""; 
	
	var _newMemberFlag = false;
	var _oldMemberFlag = false;
	var _newAddList = [];
	var maxNum = 0;
	
	//主套餐
	var _searchPack = function(pageIndex){

		var custId =OrderInfo.cust.custId;
		var searchtext = $('#searchtext').val();
		if(searchtext=="请输入您要搜索的套餐名称或首字母简拼"){
			searchtext="";
		}
//		var phoneLevel=order.pdshoneNumber.boProdAn.level;
		var phoneLevel='';
		var numsubPage=$("#numsubflag").val();
		if((phoneLevel==undefined&&phoneLevel==null)||numsubPage=='number'){
			phoneLevel='';
		}
		var subPage=$("#subpageFlag").val();
		var params={"subPage":subPage,"qryStr":searchtext,"pnLevelId":phoneLevel,"custId":custId,"PageIndex":pageIndex,"PageSize":10};
		
		if($("#price_basic").css("display") != "none"){
			var priceVal = $("#price_basic a.selected").attr("val");
			if(priceVal!=null&&priceVal!=""){
				var priceArr = priceVal.split("-");
				if(priceArr[0]!=null&&priceArr[0]!=""){
					params.priceMin = priceArr[0] ;
				}
				if(priceArr[1]!=null&&priceArr[1]!=""){
					params.priceMax = priceArr[1] ;
				}
			}
		}
		if($("#influx_basic").css("display") != "none"){
			var influxVal = $("#influx_basic a.selected").attr("val");
			if(influxVal!=null&&influxVal!=""){
				var influxArr = influxVal.split("-");
				if(influxArr[0]!=null&&influxArr[0]!=""){
					params.INFLUXMin = influxArr[0]*1024 ;
				}
				if(influxArr[1]!=null&&influxArr[1]!=""){
					params.INFLUXMax = influxArr[1]*1024 ;
				}
			}
		}
		if($("#invoice_basic").css("display") != "none"){
			var invoiceVal = $("#invoice_basic a.selected").attr("val");
			if(invoiceVal!=null&&invoiceVal!=""){
				var invoiceArr = invoiceVal.split("-");
				if(invoiceArr[0]!=null&&invoiceArr[0]!=""){
					params.INVOICEMin = invoiceArr[0] ;
				}
				if(invoiceArr[1]!=null&&invoiceArr[1]!=""){
					params.INVOICEMax = invoiceArr[1] ;
				}
			}
		}
		
		//查询套餐列表数据信息
		_queryData(params);
		
	};
	
	var _searchPackById = function(prodOfferId){
		var params={"prodOfferId":prodOfferId,"pnLevelId":"","PageIndex":1,"PageSize":10};
		_queryData(params);
	};
	
	var _queryData = function(params) {
		if(OrderInfo.actionFlag==2){
			var offerSpecId = order.prodModify.choosedProdInfo.prodOfferId;
			if(offerSpecId!=undefined){
				params.changeGradeProdOfferId = offerSpecId;
			}
			var prodSpecIds='';
			$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
				if(this.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
					if(this.objId!=undefined){
						prodSpecIds=prodSpecIds+","+this.objId;
					}
				}
			});
			if(prodSpecIds!=''){
				prodSpecIds=prodSpecIds.substring(1, prodSpecIds.length);
				params.prodSpecId=prodSpecIds;
			}
			//3G老套餐只能变更成4G新套餐，不支持3转3
//			var prodClass = order.prodModify.choosedProdInfo.prodClass;
//			if(prodClass==CONST.PROD_CLASS.THREE){
//				params.prodOfferFlag = "4G";
//			}
		}else if(CONST.getAppDesc()==0){
			params.prodOfferFlag = "4G";
		}
		var url = contextPath+"/token/pc/order/offerSpecList";
		$.callServiceAsHtmlGet(url,params, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"done" : function(response){
				if(!response){
					response.data='<li><a href="#" class="ft">暂无套餐</a></li>';
				}
				if (response.code == -2) {
					return;
				}else if(response.code != 0) {
					$.alert("提示","response.code");
					return;
				}
				
				//判断是否二次加载，二次不展示套餐
				var nowReloadFalg=OrderInfo.newOrderInfo.isReloadFlag;
				
				if(nowReloadFalg!="N"){
					jQuery("#service_detial").html(response.data).fadeIn();
					
					var show_per_page = 10; //每页显示条数
					var number_of_items = $('#offerlistcont').children().size();
					if(number_of_items==0){
						//var noitems_html = "<div style='text-align:center;'>抱歉，没有找到相关的套餐。</div>";
						var noitems_html = "<img width='25' height='25' src='"+contextPath+"/image/icon/tip.png'>抱歉，没有找到相关的套餐。";
						$("#errinfo").html(noitems_html);
						$('#page_navigation').html("");
					}else{
						var number_of_pages = Math.ceil(number_of_items/show_per_page);
						$('#current_page').val(0);
						$('#show_per_page').val(show_per_page);
						var navigation_html = '<label><span class="pageUpGray" onclick="order.service.previous();">上一页</span></label><label>';
						var current_link = 0;
						while(number_of_pages > current_link){
							navigation_html += '<a class="page_link" href="javascript:order.service.go_to_page(' + current_link +')" longdesc="' + current_link +'">'+ (current_link + 1) +'</a>';
							current_link++;
						}
						navigation_html += '</label><label><span class="nextPageGrayOrange" onclick="order.service.next();">下一页</span></label>';
						$('#page_navigation').html(navigation_html);
						$('#page_navigation .page_link:first').addClass('pagingSelect');
						//$('#page_navigation .page_link:first').removeClass('page_link');
						$('#offerlistcont').children().css('display', 'none');
						$('#offerlistcont').children().slice(0, show_per_page).css('display', 'table-row');
						if($('.pagingSelect').next('.page_link').length==false){
							$('.nextPageGrayOrange').removeClass('nextPageGrayOrange').addClass('nextPageGray');
						}
					}	
				}
			},
			"always":function(){
				$.unecOverlay();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","套餐加载失败，请稍后再试！");
			}
		});
	};
	
	/**
	 * 根据合约规格编码aoId查询主销售品
	 */
	var _queryPackForTerm = function(aoId, agreementType, numLevel){
		var params={
			"aoId":aoId,
			"agreementType":agreementType,
			"numLevel":numLevel
		};
		var url = contextPath+"/order/queryPackForTerm";
		var response = $.callServiceAsJson(url,params, {});
		return response;
	};
	
	//订购销售品
	var _buyService = function(specId,price) {
		
		var custId = OrderInfo.cust.custId;
		offerprice = price;
		if(OrderInfo.cust==undefined || custId==undefined || custId==""){
			$.alert("提示","在订购套餐之前请先进行客户定位！");
			return;
		}
		var param = {
			"price":price,
			"specId" : specId,
			"custId" : OrderInfo.cust.custId,
			"areaId" : OrderInfo.staff.soAreaId
		};
		
		if(OrderInfo.actionFlag == 2){  //套餐变更不做校验	
			order.service.opeSer(param);   
		}else {  //新装
			var boInfos = [{
	            boActionTypeCd: "S1",//动作类型
	            instId : "",
	            specId : specId //产品（销售品）规格ID
	        }];
	        if(rule.rule.ruleCheck(boInfos)){  //业务规则校验通过
	        	order.service.opeSer(param);   
	        }
		}
	};
	
	//获取销售品构成，并选择数量
	var _opeSer = function(inParam){
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldprodAcctInfos = [];
		OrderInfo.oldAddNumList = [];
		_newAddList = [];

		var param = {
			offerSpecId : inParam.specId,
			offerTypeCd : 1,
			partyId: OrderInfo.cust.custId
		};
		var offerSpec = query.offer.queryMainOfferSpec(param); //查询主销售品构成
		if(!offerSpec){
			return;
		}
		if(OrderInfo.actionFlag == 2){ //套餐变更			
			var url=contextPath+"/token/pc/order/queryFeeType";
			$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {			
				if(response.data!=undefined){
					if("0"==response.data){			
						var is_same_feeType=false;
						if(order.prodModify.choosedProdInfo.feeType=="2100" && (offerSpec.feeType=="2100"||offerSpec.feeType=="3100"||offerSpec.feeType=="3101"||offerSpec.feeType=="3103"||offerSpec.feeType=="1202"||offerSpec.feeType=="2101")){
							is_same_feeType=true;//预付费
						}else if(order.prodModify.choosedProdInfo.feeType=="1200" && (offerSpec.feeType=="1200"||offerSpec.feeType=="3100"||offerSpec.feeType=="3102"||offerSpec.feeType=="3103"||offerSpec.feeType=="1202"||offerSpec.feeType=="2101")){
							is_same_feeType=true;//后付费
						}else if(order.prodModify.choosedProdInfo.feeType=="1201" && (offerSpec.feeType=="1201"||offerSpec.feeType=="3101"||offerSpec.feeType=="3102"||offerSpec.feeType=="3103")){
							is_same_feeType=true;//准实时预付费
						}
						if(!is_same_feeType){
							$.alert("提示","付费类型不一致,无法进行套餐变更。");
							return;
						}
					}
				}
			}
			
//			if(OrderInfo.offid!=null && OrderInfo.offid!=""){
//				 $("#offer_title").text("订购新套餐："+OrderInfo.offerSpec.offerSpecName);
//				//弹出套餐确认
//				easyDialog.open({
//					container : "offer_dialog"
//				});
//				$("#offer_btn").off("click").on("click",function(){
//					easyDialog.close();
//					offerChange.offerChangeView();
//				});
//			}
//			else{
				offerChange.offerChangeView();
//			}
			return;
		}
		
		//老号码新增内容
		var areaidflag = order.memberChange.areaidJurisdiction();
		
		var iflag = 0; //判断是否弹出副卡选择框 false为不选择
		var $tbody = $("#member_tbody");
		$tbody.html("");
		$("#main_title").text(OrderInfo.offerSpec.offerSpecName);
		$.each(offerSpec.offerRoles,function(){
			var offerRole = this;
			var $tr = $("<tr style='background:#f8f8f8;'></tr>");
			var $td = $('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'
					+offerRole.offerRoleName+'</span>&nbsp;&nbsp;</td>');
			if(this.memberRoleCd == CONST.MEMBER_ROLE_CD.CONTENT){
				$tr.append($td).append($("<td colspan='3'></td>")).appendTo($tbody);
			}else{
				$tr.append($td).appendTo($tbody);
			}
			
			$.each(this.roleObjs,function(){
				var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
				if(this.objType == CONST.OBJ_TYPE.PROD){
					if(offerRole.memberRoleCd=="401"){
						_newAddList.push(objInstId);
					}
					
					if(offerRole.minQty == 0){ //加装角色
						this.minQty = 0;
						this.dfQty = 0;
					}
					
					var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
					maxNum = max;
					var min = this.minQty;
					
					//新装判断是否有传主副卡信息
					if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""&&offerRole.memberRoleCd=="401"){
						var subPhoneNums = OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");
						var nums = subPhoneNums.length;
						this.dfQty = nums;
						this.minQty = nums;
						this.maxQty = nums;
						max = nums;
					}
					
					if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""&&OrderInfo.newOrderNumInfo.newSubPhoneNum==""&&offerRole.memberRoleCd=="401"){
						this.maxQty = 0;
						max = 0;
					}
					
					$tr.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'>"+
							"<a class='add' href='javascript:order.service.subNum(\""+objInstId+"\","+this.minQty+");'></a>"+
							"<input id='"+objInstId+"' type='text' value='"+this.dfQty+"' class='numberTextBox width22' readonly='readonly'>"+
							"<a class='add2' href='javascript:order.service.addNum(\""+objInstId+"\","+this.maxQty+",\""+offerRole.parentOfferRoleId+"\");'> </a>"+
							"</i>"+this.minQty+"-"+max+"（张） </td>");	
					
					iflag++;
				}
			});
			var $trServ = $("<tr></tr>");
			var i = 0;
			$.each(this.roleObjs,function(){
				var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id	
				if(this.objType == CONST.OBJ_TYPE.SERV){  //是否有功能产品
					if(i%4==0){
						$trServ = $("<tr></tr>");
						$trServ.appendTo($tbody);
					}
					var $input = $('<input id="'+objInstId+'" name="'+offerRole.offerRoleId+'" type="checkbox">'+this.objName+'</input>');
					if(this.minQty == 0){
						if(this.dfQty>0){
							$input.attr("checked","checked");
						}
					}else if(this.minQty > 0){
						$input.attr("checked","checked");
						$input.attr("disabled","disabled");
					}
					var $td = $("<td></td>");
					$td.append($input).appendTo($trServ);
					i++;
					iflag++;
				}
			});
			
			if(offerRole.memberRoleCd=="401" && areaidflag!="" && areaidflag.net_vice_card=="0"){
				$.each(this.roleObjs,function(){
					if(this.objType == CONST.OBJ_TYPE.PROD){					
						var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
						var min = this.minQty;
						//获取老用户纳入号码
						var oldSubPhoneNums=OrderInfo.oldSubPhoneNum.oldSubPhoneNum;
						
						//如果最大个数为0，不展示老用户号码输入框
						if(this.maxQty!=0){
							var oldSubPhoneNum=OrderInfo.oldSubPhoneNum.oldSubPhoneNum;
							
							var $trOldNbr = "<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'>" +
							"<td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td>" +
							"<td align='left' colspan='3'><input value='' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' >" +
							"<a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+max+",\"\");'> </a>"+min+"-"+max+"（张）</td></tr>";	
							$tbody.append($trOldNbr);
							
							if(oldSubPhoneNums!=null && oldSubPhoneNums!=""){
								//order.memberChange.addNum(3,"");
								var oldSubPhoneNum=oldSubPhoneNums.split(",");
								
								if(oldSubPhoneNum!=null && oldSubPhoneNum.length>0){
									for(var i=0;i<oldSubPhoneNum.length;i++){
										if(i==0){
											$("#oldphonenum_1").val(oldSubPhoneNum[i]);
										}else{
											//添加输入框
											order.memberChange.addNum(max,"");
											$("#oldphonenum_"+(i+1)).val(oldSubPhoneNum[i]);
										}
									}
								}
							}
						}
					}
				});
			}
		});
		//页面初始化参数
		var param = {
			"boActionTypeCd" : "S1" ,
			"boActionTypeName" : "订购",
			"offerSpec" : offerSpec,
			"actionFlag" :1,
			"type" : 1
		};
		if(iflag>1){
			easyDialog.open({
				container : "member_dialog"
			});
			$("#member_btn").off("click").on("click",function(){
				order.service.confirm(param);
			});
		}else{
			if(!_setOfferSpec(1)){
				$.alert("错误提示","请选择一个接入产品");
				return;
			}
			if(OrderInfo.actionFlag!=14){ //合约套餐不初始化
				order.main.buildMainView(param);	
			}
		}
	};
	
	//选择完主套餐构成后确认
	var _confirm = function(param){
		order.memberChange.viceCartNum = 0;
		
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			this.prodInsts = [];
		});
		
		//新增内容
		var newnum = 0;
		$.each(_newAddList,function(){
			newnum=newnum+Number($("#"+this).val());
		});
		var oldnum = 0;
		$("#member_tbody").find("tr[name='oldnbr']").each(function(){
			var num = $.trim($(this).children("td").eq(1).children("input").val());
			if(ec.util.isObj(num)){
				oldnum++;
			}
		});
		
		if(!_setOfferSpec()){
			$.alert("错误提示","请选择一个接入产品");
			return;
		}
		
		if(newnum>0){
			order.service.newMemberFlag = true;
			param.newnum = newnum;
		}else{
			order.service.newMemberFlag = false;
		}
		
		if(oldnum>0){
			order.service.oldMemberFlag = true;
			if(!order.memberChange.queryofferinfo()){
				return;
			}
			param.oldprodInstInfos = OrderInfo.oldprodInstInfos;
			param.oldofferSpec = OrderInfo.oldofferSpec;
			param.oldoffer = OrderInfo.oldoffer;
			param.oldnum = oldnum;
		}else{
			order.service.oldMemberFlag = false;
		}
		
		if(parseInt(newnum)+parseInt(order.memberChange.viceCartNum)>maxNum){
			$.alert("提示","加装数量已经超过能加装的最大数量【"+maxNum+"】---!");
			return;
		}
		
		if(OrderInfo.actionFlag!=14){ //合约套餐不初始化
			order.main.buildMainView(param);	
		}else{
			mktRes.terminal.newnum = newnum;
			mktRes.terminal.oldnum = oldnum;
		}
		
		//弹出框无法关闭修复wangjz5
		jQuery("#easyDialogBox").hide();
		
		jQuery("#overlay").hide();
			
	};
	
	//根据页面选择成员数量保存销售品规格构成 offerType为1是单产品
	var _setOfferSpec = function(offerType){
		var k = -1;
		var flag = false;  //判断是否选接入产品
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if(offerRole.prodInsts==undefined){
				offerRole.prodInsts = [];
			}
			//offerRole.prodInsts = []; //角色对象实例
			$.each(this.roleObjs,function(){
				if(this.objType== CONST.OBJ_TYPE.PROD){  //接入类产品
					var num = 0;  //接入类产品数量选择
					if(offerType==1){  //单产品
						num = 1;
					}else{ //多成员销售品
						num = $("#"+offerRole.offerRoleId+"_"+this.objId).val();  //接入类产品数量选择
					}
					if(num==undefined || num==""){
						num = 0;
					}
					for ( var i = 0; i < num; i++) {
						var newObject = jQuery.extend(true, {}, this); 
						newObject.prodInstId = k--;
						if(num>1){ //同一个规格产品选择多个
							newObject.offerRoleName = offerRole.offerRoleName+(i+1);
						}else{
							newObject.offerRoleName = offerRole.offerRoleName;
						}
						newObject.memberRoleCd = offerRole.memberRoleCd;
						offerRole.prodInsts.push(newObject);   
						flag = true;
					}
					offerRole.selQty = num;
				}else{ //功能类产品
					if(this.minQty==0 && OrderInfo.actionFlag==1){
						if($("#"+offerRole.offerRoleId+"_"+this.objId).attr("checked")=="checked"){
							this.dfQty = 1;
						}else{
							this.dfQty = 0;
						}
					}
				}
			});
		});
		return flag;
	};
	
	//添加一个角色
	var _addNum = function(id,max,parentOfferRoleId){
		if(ec.util.isObj(parentOfferRoleId)){
			var viceNum = 0;
			var offerRoles = [];
			var parentMaxQty = 0;
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				var offerRole = this;
				$.each(this.roleObjs,function(){
					if(this.objType == CONST.OBJ_TYPE.PROD){
						var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
						if(ec.util.isObj(offerRole.parentOfferRoleId) && parentOfferRoleId==offerRole.parentOfferRoleId){
							offerRoles.push(offerRole);
							parentMaxQty = offerRole.parentMaxQty;
							viceNum += Number($("#"+objInstId).val());
						}
					}
				});
			});
			if(parentMaxQty>0){
				if(viceNum >= parentMaxQty){
					if(ec.util.isArray(offerRoles)){
						var str = "【";
						for ( var i = 0; i < offerRoles.length; i++) {
							var offerRole = offerRoles[i];
							str += offerRole.offerRoleName+",";
						}
						str = str.substr(0, str.lastIndexOf(','));
						str += "】角色成员数量总和不能超过"+parentMaxQty;
						$.alert("规则限制",str);
						return;
					}
				}
			}
		}
		var num = Number($("#"+id).val());
		if(max<0){
			num+=1;
			$("#"+id).val(num);
		}else{
			if(num<max){
				num+=1;
				$("#"+id).val(num);
			}
		}		
	};
	
	var _subNum = function(id,min){
		var num = Number($("#"+id).val());
		if(num>min){
			num-=1;
			$("#"+id).val(num);
		}		
	};
	
	var _addNumNoLim = function(id){
		var num = Number($("#"+id).val());
		num+=1;
		$("#"+id).val(num);		
	};
	
	var _subNumNoLim = function(id){
		var num = Number($("#"+id).val());
		num-=1;
		$("#"+id).val(num);		
	};
	
	var _previous= function(){
		new_page = parseInt($('#current_page').val()) - 1;
		if($('.pagingSelect').prev('.page_link').length==true){
			go_to_page(new_page);
		}
		
	};

	var _next=function(){
		new_page = parseInt($('#current_page').val()) + 1;
		if($('.pagingSelect').next('.page_link').length==true){
			go_to_page(new_page);
		}
		
	};
	
	var go_to_page = function(page_num){
		var show_per_page = parseInt($('#show_per_page').val());
		start_from = page_num * show_per_page;
		end_on = start_from + show_per_page;
		$('#offerlistcont').children().css('display', 'none').slice(start_from, end_on).css('display', 'table-row');
		$('.page_link[longdesc=' + page_num +']').addClass('pagingSelect').siblings('.pagingSelect').removeClass('pagingSelect');
		$('#current_page').val(page_num);
		if($('.pagingSelect').prev('.page_link').length==true){
			$('.pageUpGray').removeClass('pageUpGray').addClass('pageUpOrange');
		}else{
			$('.pageUpOrange').removeClass('pageUpOrange').addClass('pageUpGray');
		}
		
		if($('.pagingSelect').next('.page_link').length==true){
			$('.nextPageGray').removeClass('nextPageGray').addClass('nextPageGrayOrange');
		}else{
			$('.nextPageGrayOrange').removeClass('nextPageGrayOrange').addClass('nextPageGray');
		}
	};
	
	//订单取消时，释放已预占资源的入口标识。0：初始化状态，1：购机或选号入口，2：套餐入口
	var _releaseFlag = 0;
	//购机和选号入口的预占号码信息缓存
	var _boProdAn = {};

	var _initSpec = function(){
		$("#search").off("click").on("click",function(){order.service.searchPack();});
	};
	var _offerDialog=function(subPage){
		var param={};
		var url=contextPath+"/order/prodoffer/prepare?subPage="+subPage;
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>页面显示失败,稍后重试</strong></div>';
				}
				if(response.code != 0) {
					$.alert("提示","页面显示失败,稍后重试");
					return;
				}
				var content$=$("#offerspecContent");
				content$.html(response.data);
				order.prepare.backToInit();
				_initSpec();
				order.prodOffer.queryApConfig();
				order.service.searchPack();
				$("#chooseofferspecclose").click(function(){
					_closeChooseDialog();
				});
				easyDialog.open({
					container : 'chooseofferspec'
				});
			}
		});	
	};
	var _closeChooseDialog = function() {
		if (!$("#chooseofferspec").is(":hidden")){
			easyDialog.close();
		}
	};
	var _choosedOffer=function(id,specId,price,subpage,specName){
		var param={"offerSpecId":specId};
		var response = $.callServiceAsJson(contextPath+"/order/queryOfferSpec",param);
		if (response.code==0) {
			if(response.data){
				var offerRoleId="";
				var prodOfferSpec=response.data.offerSpec;
				if (prodOfferSpec && prodOfferSpec.offerRoles) {
					var offerRoles = prodOfferSpec.offerRoles;
					for (var i=0;i<offerRoles.length;i++){
						if (offerRoles[i].memberRoleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD
								|| offerRoles[i].memberRoleCd == CONST.MEMBER_ROLE_CD.VICE_CARD) {
							if(offerRoles[i].memberRoleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD){
								offerRoleId=offerRoles[i].offerRoleId;
								break;
							}
						}else{
							offerRoleId=offerRoles[i].offerRoleId;
							break;
						}
					}
				}
				if(offerRoleId!=""){
					_closeChooseDialog();
					var prodId=$("#li_"+subpage).attr("objinstid");
					var accessnumber=$("#li_"+subpage).attr("accessnumber");
					for ( var i = 0; i < OrderInfo.viceOfferSpec.length; i++) {//清除旧数据
						var viceOfferSpec = OrderInfo.viceOfferSpec[i];
						if(prodId == viceOfferSpec.prodId){
							OrderInfo.viceOfferSpec.splice(i,1);
							break;
						}
					}
					prodOfferSpec.prodId=prodId;
					prodOfferSpec.accessnumber=accessnumber;
					OrderInfo.viceOfferSpec.push(prodOfferSpec);
					order.prodModify.chooseOfferForMember(specId,subpage,specName,offerRoleId);
				}else{
					$.alert("提示","无法选择套餐，套餐规格查询失败！");
				}
			}
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","套餐详细加载失败，请稍后再试！");
		}
	};
	//二次加载部分
	//订购销售品
	var _buyServiceReload = function(specId,price,cardNum,callBack) {
		var custId = OrderInfo.cust.custId;
		offerprice = price;
		if(OrderInfo.cust==undefined || custId==undefined || custId==""){
			$.alert("提示","在订购套餐之前请先进行客户定位！");
			return;
		}
		var param = {
			"price":price,
			"specId" : specId,
			"custId" : OrderInfo.cust.custId,
			"areaId" : OrderInfo.staff.soAreaId
		};
		
		if(OrderInfo.actionFlag == 2){  //套餐变更不做校验	
			order.service.opeSer(param);   
		}else {  //新装
			var boInfos = [{
	            boActionTypeCd: "S1",//动作类型
	            instId : "",
	            specId : specId //产品（销售品）规格ID
	        }];
	        if(rule.rule.ruleCheck(boInfos)){  //业务规则校验通过
	        	order.service.opeSerReload(param,cardNum);
	        	if(typeof callBack=="function"){
	        		callBack();
	        	}
	        }
		}
		
	};
	
	//获取销售品构成，并选择数量
	var _opeSerReload = function(inParam,cardNum){
	    
		var param = {
			offerSpecId : inParam.specId,
			offerTypeCd : 1,
			partyId: OrderInfo.cust.custId
		};
		var offerSpec = query.offer.queryMainOfferSpec(param); //查询主销售品构成
		if(!offerSpec){
			return;
		}
		if(OrderInfo.actionFlag == 2){ //套餐变更			
			var url=contextPath+"/token/pc/order/queryFeeType";
			$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {			
				if(response.data!=undefined){
					if("0"==response.data){			
						var is_same_feeType=false;
						if(order.prodModify.choosedProdInfo.feeType=="2100" && (offerSpec.feeType=="2100"||offerSpec.feeType=="3100"||offerSpec.feeType=="3101"||offerSpec.feeType=="3103"||offerSpec.feeType=="1202"||offerSpec.feeType=="2101")){
							is_same_feeType=true;//预付费
						}else if(order.prodModify.choosedProdInfo.feeType=="1200" && (offerSpec.feeType=="1200"||offerSpec.feeType=="3100"||offerSpec.feeType=="3102"||offerSpec.feeType=="3103"||offerSpec.feeType=="1202"||offerSpec.feeType=="2101")){
							is_same_feeType=true;//后付费
						}else if(order.prodModify.choosedProdInfo.feeType=="1201" && (offerSpec.feeType=="1201"||offerSpec.feeType=="3101"||offerSpec.feeType=="3102"||offerSpec.feeType=="3103")){
							is_same_feeType=true;//准实时预付费
						}
						if(!is_same_feeType){
							$.alert("提示","付费类型不一致,无法进行套餐变更。");
							return;
						}
					}
				}
			}
			offerChange.offerChangeView();
			return;
		}
		//新装二次加载 主套餐名称
		if(OrderInfo.newOrderInfo.isReloadFlag=="N"){
			OrderInfo.newOrderInfo.prodOfferName=offerSpec.offerSpecName;
		}		
		var iflag = 0; //判断是否弹出副卡选择框 false为不选择
		var $tbody = $("#member_tbody");
		$tbody.html("");
		$("#main_title").text(OrderInfo.offerSpec.offerSpecName);
		$.each(offerSpec.offerRoles,function(){
			var offerRole = this;
			var $tr = $("<tr style='background:#f8f8f8;'></tr>");
			var $td = $('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'
					+offerRole.offerRoleName+'</span>&nbsp;&nbsp;</td>');
			if(this.memberRoleCd == CONST.MEMBER_ROLE_CD.CONTENT){
				$tr.append($td).append($("<td colspan='3'></td>")).appendTo($tbody);
			}else{
				$tr.append($td).appendTo($tbody);
			}
			$.each(this.roleObjs,function(){
				var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
				if(this.objType == CONST.OBJ_TYPE.PROD){
					if(offerRole.memberRoleCd=="401"){
						_newAddList.push(objInstId);
					}
					
					if(offerRole.minQty == 0){ //加装角色
						this.minQty = 0;
						this.dfQty = 0;
					}
					
					//如果是初始化副卡,则副卡数量直接固定
					if(cardNum && offerRole.memberRoleCd=="401"){
						this.dfQty = cardNum;
					}
					
					var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
					maxNum = max;
					var min = this.minQty;
					
					//新装判断是否有传主副卡信息
					if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""&&offerRole.memberRoleCd=="401"){
						var subPhoneNums = OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");
						var nums = subPhoneNums.length;
						this.dfQty = nums;
						this.minQty = nums;
						this.maxQty = nums;
						max = nums;
					}
					
					if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""&&OrderInfo.newOrderNumInfo.newSubPhoneNum==""&&offerRole.memberRoleCd=="401"){
						this.maxQty = 0;
						max = 0;
					}
					
					$tr.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'>"+
							"<a class='add' href='javascript:order.service.subNum(\""+objInstId+"\","+this.minQty+");'></a>"+
							"<input id='"+objInstId+"' type='text' value='"+this.dfQty+"' class='numberTextBox width22' readonly='readonly'>"+
							"<a class='add2' href='javascript:order.service.addNum(\""+objInstId+"\","+this.maxQty+",\""+offerRole.parentOfferRoleId+"\");'> </a>"+
							"</i>"+this.minQty+"-"+max+"（张） </td>");	
					
					iflag++;
				}
			});
			var $trServ = $("<tr></tr>");
			var i = 0;
			$.each(this.roleObjs,function(){
				var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id	
				if(this.objType == CONST.OBJ_TYPE.SERV){  //是否有功能产品
					if(i%4==0){
						$trServ = $("<tr></tr>");
						$trServ.appendTo($tbody);
					}
					var $input = $('<input id="'+objInstId+'" name="'+offerRole.offerRoleId+'" type="checkbox">'+this.objName+'</input>');
					if(this.minQty == 0){
						if(this.dfQty>0){
							$input.attr("checked","checked");
						}
					}else if(this.minQty > 0){
						$input.attr("checked","checked");
						$input.attr("disabled","disabled");
					}
					var $td = $("<td></td>");
					$td.append($input).appendTo($trServ);
					i++;
					iflag++;
				}
			});
			
			//老号码新增内容
			var areaidflag = order.memberChange.areaidJurisdiction();
			
			if(offerRole.memberRoleCd=="401" && areaidflag!="" && areaidflag.net_vice_card=="0"){
				$.each(this.roleObjs,function(){
					if(this.objType == CONST.OBJ_TYPE.PROD){						
						var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
						var min = this.minQty;
						//获取老用户纳入号码
						var oldSubPhoneNums="";
						
						var result=OrderInfo.newOrderInfo.result;
						
						var busiOrders = result.orderList.custOrderList[0].busiOrder;
						
						$.each(busiOrders,function(index,busiOrder){
							//老用户纳入
							if(busiOrder.boActionType.actionClassCd==1200 && busiOrder.boActionType.boActionTypeCd=="S2" && busiOrder.busiObj.offerTypeCd=="1"){
								var oldnum=busiOrder.busiObj.accessNumber;
								OrderInfo.oldAddNumList.push({"accNbr":oldnum});
								oldSubPhoneNums+=oldnum+",";
							}
						});
						
						//如果最大个数为0，不展示老用户号码输入框
						if(this.maxQty!=0){
							var oldSubPhoneNum=OrderInfo.oldSubPhoneNum.oldSubPhoneNum;
							
							var $trOldNbr = "<tr style='background:#f8f8f8;' id='oldnum_1' name='oldnbr'>" +
							"<td class='borderLTB' style='font-size:14px; padding:0px 0px 0px 12px'><span style='color:#518652; font-size:14px;'>已有移动电话</span></td>" +
							"<td align='left' colspan='3'><input value='' style='margin-top:10px' class='numberTextBox' id='oldphonenum_1' type='text' >" +
							"<a style='margin-top:15px' class='add2' href='javascript:order.memberChange.addNum("+max+",\"\");'> </a>"+min+"-"+max+"（张）</td></tr>";	
							$tbody.append($trOldNbr);
													
							if(oldSubPhoneNums!=null && oldSubPhoneNums!=""){
								//order.memberChange.addNum(3,"");
								var oldSubPhoneNum=oldSubPhoneNums.split(",");
								
								if(oldSubPhoneNum!=null && oldSubPhoneNum.length>0){
									for(var i=0;i<oldSubPhoneNum.length;i++){
										if(oldSubPhoneNum[i]!=null && oldSubPhoneNum[i]!=""){
											if(i==0){
												$("#oldphonenum_1").val(oldSubPhoneNum[i]);
											}else{
												//添加输入框
												order.memberChange.addNum(max,"");
												$("#oldphonenum_"+(i+1)).val(oldSubPhoneNum[i]);
											}
										}
									}
								}
							}
						}
					}
				});
			}
		});
		
		//页面初始化参数
		var param = {
			"boActionTypeCd" : "S1" ,
			"boActionTypeName" : "订购",
			"offerSpec" : offerSpec,
			"actionFlag" :1,
			"type" : 1
		};
		if(iflag>1){
			easyDialog.open({
				container : "member_dialog"
			});
			
			//直接调到填单界面
			//$("#member_btn").off("click").on("click",function(){
			order.service.confirm(param);
			//});
		}else{
			if(!_setOfferSpec(1)){
				$.alert("错误提示","请选择一个接入产品");
				return;
			}
			if(OrderInfo.actionFlag!=14){ //合约套餐不初始化
				order.main.buildMainView(param);	
			}
		}
	};
	var _callBackBuildOrder=function(result,prodOfferId,prodOfferName){
			var busiOrders = result.orderList.custOrderList[0].busiOrder;
			//产品信息
			var acctCd="";
			var acctName = "";
			var acctId="";//帐户信息中帐户id
			var mailingType = "";
			var param1 = "";
			var param2 = "";
			var param3 = "";
			var param7 = "";
			var bankAcct = "";
			var bankId = "";
			var paymentMan = "";
			var paymentAcctTypeCd = "";
			
			//取缓存中的已选可选包和已选功能产品
			//处理在缓存中，却不在二次加载返回的参数中----已选可选包
			$.each(AttachOffer.openList,function(index,openList){
				$.each(openList.specList,function(i,specList){
					if(!order.service.compareOrder(busiOrders,specList.offerSpecId,openList.prodId)){
						AttachOffer.delOfferSpecReload(openList.prodId,specList.offerSpecId);
					}
				});				
			});
			//处理在缓存中，却不在二次加载返回的参数中----已选功能产品
			$.each(AttachOffer.openServList,function(index,openServList){
				$.each(openServList.servSpecList,function(i,servSpecList){
					var servSpecId = servSpecList.servSpecId;
					var servSpecName = servSpecList.servSpecName;
					if(!order.service.compareServOrder(busiOrders,servSpecId,openServList.prodId)){						
						AttachOffer.closeServSpecReload(openServList.prodId,servSpecId,servSpecName,servSpecList.ifParams)
					}
				});
			});
			
			$.each(busiOrders,function(index,busiOrder){
				//主副卡信息
				if(busiOrder.boActionType.actionClassCd==1300&&busiOrder.boActionType.boActionTypeCd=="1"){
					var prodId = busiOrder.busiObj.instId;
					var accessNumber = busiOrder.busiObj.accessNumber;//接入号
					var terminalCode = busiOrder.data.bo2Coupons[0].terminalCode;//uim卡号
					var feeType = busiOrder.data.boProdFeeTypes[0].feeType;//付费类型
					var prodPwTypeCd = busiOrder.data.boProdPasswords[0].prodPwTypeCd;
					var pwd = busiOrder.data.boProdPasswords[0].pwd;//产品密码
					//主卡才有是否信控
					var isCheckMask = "20";//默认信控
					if(busiOrder.data.boProdItems&&busiOrder.data.boProdItems[0].itemSpecId){
						var itemSpecId = busiOrder.data.boProdItems[0].itemSpecId;
						if(itemSpecId=="40010030"){//是否信控
							isCheckMask = busiOrder.data.boProdItems[0].value;
						}
						//是否信控放在OrderInfo.newOrderInfo.isCheckMask中				
						var checkMark = {};
						checkMark.itemSpecId = itemSpecId;
						checkMark.prodId = prodId;
						checkMark.isCheckMask = isCheckMask;
						OrderInfo.newOrderInfo.checkMaskList.push(checkMark);
						
						$("#"+itemSpecId+"_"+prodId+"").find("option[value='"+isCheckMask+"']").attr("selected","selected");
					}
					
					
					$("#nbr_btn_"+prodId).html(accessNumber+"<u></u>");
					var boProdAns={
							prodId : this.data.boProdAns[0].prodId, //从填单页面头部div获取
							accessNumber : this.data.boProdAns[0].accessNumber, //接入号
							anChooseTypeCd : this.data.boProdAns[0].anChooseTypeCd, //接入号选择方式,自动生成或手工配号，默认传2
							anId : this.data.boProdAns[0].anId, //接入号ID
							pnLevelId:this.data.boProdAns[0].pnLevelId,
							anTypeCd : this.data.boProdAns[0].anTypeCd, //号码类型
							state : this.data.boProdAns[0].state, //动作	,新装默认ADD	
							areaId:this.data.boProdAns[0].areaId,
							areaCode:this.data.boProdAns[0].areaCode,
							memberRoleCd:this.data.boProdAns[0].memberRoleCd,
							preStore:this.data.boProdAns[0].preStore,
							minCharge:this.data.boProdAns[0].minCharge
						};
					OrderInfo.boProdAns.push(boProdAns);
					order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);//选号要刷新发展人管理里面的号码					
					//uim卡校验					
					$("#uim_txt_"+prodId).attr("disabled",true);
					$("#uim_txt_"+prodId).val(terminalCode);
					$("#uim_check_btn_"+prodId).attr("disabled",true);
					$("#uim_check_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
					$("#uim_release_btn_"+prodId).attr("disabled",false);
					$("#uim_release_btn_"+prodId).removeClass("disablepurchase").addClass("purchase");
					var coupon = {
							couponUsageTypeCd : this.data.bo2Coupons[0].couponUsageTypeCd, //物品使用类型
							inOutTypeId : this.data.bo2Coupons[0].inOutTypeId,  //出入库类型
							inOutReasonId : this.data.bo2Coupons[0].inOutReasonId, //出入库原因
							saleId : this.data.bo2Coupons[0].saleId, //销售类型
							couponId : this.data.bo2Coupons[0].couponId, //物品ID
							couponinfoStatusCd : this.data.bo2Coupons[0].couponinfoStatusCd, //物品处理状态
							chargeItemCd : this.data.bo2Coupons[0].chargeItemCd, //物品费用项类型
							couponNum : this.data.bo2Coupons[0].couponNum, //物品数量
							storeId : this.data.bo2Coupons[0].storeId, //仓库ID
							storeName : this.data.bo2Coupons[0].storeName, //仓库名称
							agentId : this.data.bo2Coupons[0].agentId, //供应商ID
							apCharge : this.data.bo2Coupons[0].apCharge, //物品价格
							couponInstanceNumber : this.data.bo2Coupons[0].couponInstanceNumber, //物品实例编码
							terminalCode : this.data.bo2Coupons[0].terminalCode,//前台内部使用的UIM卡号
							ruleId : this.data.bo2Coupons[0].ruleId, //物品规则ID
							partyId : this.data.bo2Coupons[0].partyId, //客户ID
							prodId :  this.data.bo2Coupons[0].prodId, //产品ID
							offerId : this.data.bo2Coupons[0].offerId, //销售品实例ID
							state : this.data.bo2Coupons[0].state, //动作
							relaSeq : this.data.bo2Coupons[0].relaSeq //关联序列	
						};
					OrderInfo.clearProdUim(this.busiObj.instId);
					OrderInfo.boProd2Tds.push(coupon);
					
					var payTypeOptions = $("select[name='pay_type_"+prodId+"']");
					$(payTypeOptions).find("option[value='"+feeType+"']").attr("selected","selected");
					$("#pwd_"+prodId).val(pwd);
				}
				//取订购套餐的公共信息
				if(busiOrder.boActionType.actionClassCd==1100&&busiOrder.boActionType.boActionTypeCd=="A1"){
					if(busiOrder.data.boAccountInfos.length>0){
						acctCd=busiOrder.data.boAccountInfos[0].acctCd;
						acctName = busiOrder.data.boAccountInfos[0].acctName;
						//将账单投递方式保存到公共变量中
						OrderInfo.newOrderInfo.acctCd=acctCd;
						OrderInfo.newOrderInfo.acctName=acctName;
					}
					if(busiOrder.data.boAccountMailings&&busiOrder.data.boAccountMailings.length>0){
						mailingType = busiOrder.data.boAccountMailings[0].mailingType;
						param1 = busiOrder.data.boAccountMailings[0].param1;
						param2 = busiOrder.data.boAccountMailings[0].param2;
						param3 = busiOrder.data.boAccountMailings[0].param3;
						param7 = busiOrder.data.boAccountMailings[0].param7;
						OrderInfo.newOrderInfo.mailingType=mailingType;
						OrderInfo.newOrderInfo.param1=param1;
						OrderInfo.newOrderInfo.param2=param2;
						OrderInfo.newOrderInfo.param3=param3;
						OrderInfo.newOrderInfo.param7=param7;
					}
					if(busiOrder.data.boPaymentAccounts&&busiOrder.data.boPaymentAccounts.length>0){
						bankAcct = busiOrder.data.boPaymentAccounts[0].bankAcct;
						bankId = busiOrder.data.boPaymentAccounts[0].bankId;
						limitQty = busiOrder.data.boPaymentAccounts[0].limitQty;
						paymentMan = busiOrder.data.boPaymentAccounts[0].paymentMan;
						paymentAcctTypeCd = busiOrder.data.boPaymentAccounts[0].paymentAcctTypeCd;
						OrderInfo.newOrderInfo.bankAcct=bankAcct;
						OrderInfo.newOrderInfo.bankId=bankId;
						OrderInfo.newOrderInfo.limitQty=limitQty;
						OrderInfo.newOrderInfo.paymentMan=paymentMan;
						OrderInfo.newOrderInfo.paymentAcctTypeCd=paymentAcctTypeCd;
					}
				}else if(busiOrder.boActionType.actionClassCd=="1300" && busiOrder.boActionType.boActionTypeCd=="1"){//当二次加载帐户信息不为新增帐户时
					if(busiOrder.data.boAccountRelas&&busiOrder.data.boAccountRelas.length>0){
						acctCd=busiOrder.data.boAccountRelas[0].acctCd;
						acctId=busiOrder.data.boAccountRelas[0].acctId;
					}
				}else{
					acctCd="";
				}
				//取缓存中的已选可选包和已选功能产品
				var openLists = AttachOffer.openList;
				var cloneOpenLists = $.extend(true, [], AttachOffer.openList);
				var openServLists = AttachOffer.openServList;
				var cloneOpenServLists =  $.extend(true, [], AttachOffer.openServList);
				//将二次加载回参做解析
				var resOpenLists = [];
				var resOpenServLists = [];				
				//可选包和功能产品
				if(busiOrder.boActionType.actionClassCd=="1200" && busiOrder.boActionType.boActionTypeCd=="S1"){
					var offermap = busiOrder;
					$.each(AttachOffer.openList,function(){
						if(this.prodId==offermap.data.ooRoles[0].prodId){
							var offerflag = false;
							$.each(this.specList,function(){
								if(this.offerSpecId==offermap.busiObj.objId){
									offerflag = true;
									return false;
								}
							});
							if(!offerflag){
								AttachOffer.addOfferSpecReload(this.prodId,offermap.busiObj.objId);
								//AttachOffer.addOpenList(offermap.data.ooRoles[0].prodId,offermap.busiObj.objId);							
								if(offermap.data.bo2Coupons!=undefined){
									for(var i=0;i<offermap.data.bo2Coupons.length;i++){
										var bo2Coupons = offermap.data.bo2Coupons[i];
										if(i==0){
											$("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num).val(bo2Coupons.couponInstanceNumber);
											AttachOffer.checkTerminalCodeReload($("#terminalBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num));
										}else{
											AttachOffer.addAndDelTerminal($("#terminalAddBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId));
											$("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num).val(bo2Coupons.couponInstanceNumber);
											AttachOffer.checkTerminalCodeReload($("#terminalBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num));
										}
										var coupon = {
												couponUsageTypeCd : bo2Coupons.couponUsageTypeCd, //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
												inOutTypeId : bo2Coupons.inOutTypeId,  //出入库类型
												inOutReasonId : bo2Coupons.inOutReasonId, //出入库原因
												saleId : bo2Coupons.saleId, //销售类型
												couponId : bo2Coupons.couponId, //物品ID
												couponinfoStatusCd : bo2Coupons.couponinfoStatusCd, //物品处理状态
												chargeItemCd : bo2Coupons.chargeItemCd, //物品费用项类型
												couponNum : bo2Coupons.couponNum, //物品数量
												storeId : bo2Coupons.storeId, //仓库ID
												storeName : bo2Coupons.storeName, //仓库名称
												agentId : bo2Coupons.agentId, //供应商ID
												apCharge : bo2Coupons.apCharge, //物品价格,约定取值为营销资源的
												couponInstanceNumber : bo2Coupons.couponInstanceNumber, //物品实例编码
												ruleId : bo2Coupons.ruleId, //物品规则ID
												partyId : bo2Coupons.partyId, //客户ID
												prodId : bo2Coupons.prodId, //产品ID
												offerId : bo2Coupons.offerId, //销售品实例ID
												attachSepcId : bo2Coupons.attachSepcId,
												state : bo2Coupons.state, //动作
												relaSeq : bo2Coupons.relaSeq, //关联序列	
												num	: bo2Coupons.num //第几个串码输入框
											};
											OrderInfo.attach2Coupons.push(coupon);
											//AttachOffer.checkTerminalCodeReload($("#terminalAddBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num));
									}
								}/*else{
									AttachOffer.addOfferSpecReload(this.prodId,offermap.busiObj.objId);
								}*/
							}
						}
					});
					
					//老用户纳入
					if(offermap.data.ooRoles[0].prodId>0){
						AttachOffer.addOfferSpecReload(offermap.data.ooRoles[0].prodId,offermap.busiObj.objId);
					}
				}else if(busiOrder.boActionType.actionClassCd=="1300" && busiOrder.boActionType.boActionTypeCd=="7"){
					if(busiOrder.data.boServs[0].state=="ADD"){
						var offermap = busiOrder;
						$.each(AttachOffer.openServList,function(){
							if(this.prodId==offermap.busiObj.instId){
								var offerflag = false;
								$.each(this.servSpecList,function(){
									if(this.servSpecId==offermap.data.boServOrders[0].servSpecId){
										offerflag = true;
										return false;
									}
								});
								if(!offerflag){
									var ifParams = "N";
									if(offermap.data.boServItems!=undefined){
										ifParams = "Y";
									}
									AttachOffer.openServSpecReload(this.prodId,offermap.data.boServOrders[0].servSpecId,offermap.data.boServOrders[0].servSpecName,ifParams);
									/*if(ifParams=="Y"){
										var spec = CacheData.getServSpec(this.prodId,offermap.data.boServOrders[0].servSpecId);
										if(!!spec.prodSpecParams){
											for (var i = 0; i < spec.prodSpecParams.length; i++) {
												var param = spec.prodSpecParams[i];
												var itemSpec = CacheData.getServSpecParam(this.prodId,offermap.data.boServOrders[0].servSpecId,param.itemSpecId);
												$.each(offermap.data.boServItems,function(){
													if(itemSpec.itemSpecId==this.itemSpecId){
														itemSpec.setValue = this.value;
													}
												});
											}
										}
										$("#can_"+this.prodId+"_"+offermap.data.boServOrders[0].servSpecId,param.itemSpecId).removeClass("canshu").addClass("canshu2");
										var attchSpec = CacheData.getServSpec(this.prodId,offermap.data.boServOrders[0].servSpecId,param.itemSpecId);
										attchSpec.isset = "Y";
									}*/
								}
							}
						});
						
						//老用户纳入
						if(offermap.busiObj.instId>0){
							var ifParams = "N";
							if(offermap.data.boServItems!=undefined){
								ifParams = "Y";
							}
							AttachOffer.openServSpecReload(offermap.busiObj.instId,offermap.data.boServOrders[0].servSpecId,offermap.data.boServOrders[0].servSpecName,ifParams);
						}
						
					}
				}
				//帐户信息
				//$("#acctSelect").find("option[value='"+acctCd+"']").attr("selected","selected");
				if(acctCd!=""&&acctCd!=-1){
					var acctQueryParam = {
						"acctCd" : acctCd,
						"isServiceOpen":"Y"   //是否能力开放,Y-是,N-否
					};			
					$.callServiceAsJson(contextPath+"/token/pc/order/account", acctQueryParam, {
						"before":function(){
							$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
						},
						"always":function(){
							$.unecOverlay();
						},
						"done" : function(response){
							if(response.code==-2){
								$.alertM(response.data);
								return;
							}
							if(response.code==0){
								var accountInfo = response.data.accountInfos;
								var returnMap = response.data;
								var found = false;	
								if(returnMap.resultCode==0){
									if(returnMap.accountInfos && returnMap.accountInfos.length > 0){
										$("#accountDiv").find("label:eq(0)").text("主卡帐户：");
										//将对应的帐号添加进去
										$.each(response.data.accountInfos, function(i, custAcct){
											if(acctId==custAcct.acctId){
												accountInfo=custAcct;
												//创建节点
												$("<option>").text(custAcct.name+" : "+custAcct.accountNumber).attr("value",custAcct.acctId)
												.attr("acctcd",custAcct.accountNumber).appendTo($("#acctSelect"));
												
												//选中节点
												$("#acctSelect").find("option[value="+custAcct.acctId+"]").attr("selected","selected");
												found = true;
												return false;
											}
										});
										$("#accountDiv").find("a:eq(0)").hide();
										$("#acctSelect").find("option[value='-1']").remove();//将新增的选项进行删除
										$("#acctSelect").parent().find("a:eq(1)").show();//显示帐户信息按钮
										$("#defineNewAcct").hide();//隐藏新增帐户对应内容
									}else{//未查询到帐户信息
									    $.alert("提示","没有查询到帐户合同号对应的帐户信息");
									}
								}else{
									$.alertM(returnMap.resultMsg);
								}	
								
								$(this).dispatchJEvent("chooseAcct",accountInfo);
								//隐藏
								$("#defineNewAcct").hide();
							}
							else{
								$("<tr><td colspan=4>"+response.data+"</td</tr>").appendTo($("#acctListTab tbody"));
							}
							$("#acctListTab tr").off("click");				
						}			
					});
				}
				//账户投递信息在初始化完投递信息后处理 acctModiy.js中处理
				/*else{
					if(busiOrder.boActionType.actionClassCd==1100&&busiOrder.boActionType.boActionTypeCd=="A1"){
						$("#acctName").val(acctName);//帐户名称为客户名称
						$("#paymentType").find("option[value='"+paymentAcctTypeCd+"']").attr("selected","selected");
						$("#postType").find("option[value='"+mailingType+"']").attr("selected","selected");
						if(mailingType!=-1){
							//显示其他信息
							$("#postAddress").show();
							$(".billPost").show();
							$("#billContent").show();
							$("#postCycle").show();
							//账单投递地址
							$("#postAddress").val(param1);
							//账单内容
							$("#billContent").find("option[value='"+param7+"']").attr("selected", "selected");
							//投递周期
							$("#postCycle").find("option[value='"+param3+"']").attr("selected", "selected");
						}
					}
				};*/
				//获取订单信息和经办人信息
				var orderListInfo = result.orderList.orderListInfo;
				var isTemplateOrder = orderListInfo.isTemplateOrder;
				var custOrderAttrs = orderListInfo.custOrderAttrs;
				var orderRemark="";
				var orderAttrName="";
				var orderAttrPhoneNbr="";
				var orderPartyTypeCd = "1";//TODO 需要查询的客户信息中获取
				var orderIdentidiesTypeCd="";
				var orderAttrIdCard="";
				var orderAttrAddr="";
				$.each(custOrderAttrs,function(index,custOrderAttr){
					if(custOrderAttr.itemSpecId=="111111118"){
						//备注 
						orderRemark = custOrderAttr.value;
					}else if(custOrderAttr.itemSpecId=="30010020"){
						//经办人姓名 
						orderAttrName = custOrderAttr.value;
					}else if(custOrderAttr.itemSpecId=="30010025"){
						// 经办人联系人号码 
						orderAttrPhoneNbr = custOrderAttr.value;
					}else if(custOrderAttr.itemSpecId=="30010026"){
						// 经办人证件类型 
						orderIdentidiesTypeCd = custOrderAttr.value;
					}else if(custOrderAttr.itemSpecId=="30010021"){
						// 经办人证件号码 
						orderAttrIdCard = custOrderAttr.value;
					}else if(custOrderAttr.itemSpecId=="30010022"){
						//经办人证件地址 
						orderAttrAddr = custOrderAttr.value;
					}
				});
				$("#order_remark").val(orderRemark);//备注信息
				//判断是否需要模板
				if(isTemplateOrder=="Y"){
					$("#isTemplateOrder").css("checked",true);
					var templateOrderName = orderListInfo.templateOrderName;
					var templateType = orderListInfo.templateType;
					$(".template_info_name").show();
					$(".template_info_type").show();
					$("#isActivation").removeAttr("checked");
					$("#isActivation").attr("disabled","disabled");
					$("#templateOrderName").val(templateOrderName);
					$("#template_info_type").find("option[value='"+templateType+"']").attr("selected", true);
				};	
				
			//经办人
			$("#orderAttrName").val(orderAttrName);
			$("#orderPartyTypeCd").find("option[value='"+orderPartyTypeCd+"']").attr("selected", true);
			$("#orderAttrPhoneNbr").val(orderAttrPhoneNbr);
			$("#orderIdentidiesTypeCd").find("option[value='"+orderIdentidiesTypeCd+"']").attr("selected", true);
			$("#orderAttrIdCard").val(orderAttrIdCard);
			$("#orderAttrAddr").val(orderAttrAddr);
		});
		
		//管理属性 发展人
		$("#dealerTbody").empty();
		order.service.dealDevelopingPerson(busiOrders,OrderInfo.newOrderInfo.prodOfferId,OrderInfo.newOrderInfo.prodOfferName);
		//清空新装二次加载标识
		//OrderInfo.newOrderInfo.isReloadFlag="";
	}	
	//处理不在二次加载回参中的可选包
	var _compareOrder=function(busiOrders,specId,prodId){
		var flag = false;
		var ordersLength = busiOrders.length;
		var i=0;
		while(i<ordersLength){
			if(busiOrders[i].boActionType.actionClassCd==1200&&busiOrders[i].boActionType.boActionTypeCd=="S1"){
				if(busiOrders[i].data.ooRoles&&busiOrders[i].data.ooRoles.length>0&&busiOrders[i].data.ooRoles[0].prodId==prodId&&busiOrders[i].busiObj.objId==specId){
					return true;
				}
			}
			i++;
		}
		return flag;
	}
	//处理不在二次加载回参中的功能产品
	var _compareServOrder=function(busiOrders,servSpecId,prodId){
		var flag = false;
		var ordersLength = busiOrders.length;
		var i=0;
		while(i<ordersLength){
			if(busiOrders[i].boActionType.actionClassCd==1300&&busiOrders[i].boActionType.boActionTypeCd=="7"){
				if(busiOrders[i].busiObj.instId==prodId&&busiOrders[i].data.boServOrders[0].servSpecId==servSpecId){
					 return true;
				}
			}
			i++;
		}
		return flag;
	}
	//处理发展人
	var _dealDevelopingPerson=function(busiOrders,prodOfferId,prodOfferName){
		$.each(busiOrders,function(index,busiOrder){
			//过滤掉 1300 ,1 的产品发展人属性
			if(busiOrder.boActionType.actionClassCd!=1300&&busiOrder.boActionType.boActionTypeCd!="1"){
				//发展人
				if(busiOrder.data.busiOrderAttrs!=undefined){
					var dealerlist = [];
					var dealerMap1 = {};
					var dealerMap2 = {};
					var dealerMap3 = {};
					$.each(busiOrder.data.busiOrderAttrs,function(){
						if(this.role=="40020005"){
							dealerMap1.role = this.role;
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
								dealerMap1.staffid = this.value;
								dealerMap1.channelNbr = this.channelNbr;
							}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
								dealerMap1.staffname = this.value;
							}
							if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"&&busiOrder.busiObj.instId==-1){
								dealerMap1.prodId=busiOrder.busiObj.instId;
							}
						}else if(this.role=="40020006"){
							dealerMap2.role = this.role;
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
								dealerMap2.staffid = this.value;
								dealerMap2.channelNbr = this.channelNbr;
							}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
								dealerMap2.staffname = this.value;
							}
							if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"&&busiOrder.busiObj.instId==-1){
								dealerMap2.prodId=busiOrder.busiObj.instId;
							}
						}else if(this.role=="40020007"){
							dealerMap3.role = this.role;
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
								dealerMap3.staffid = this.value;
								dealerMap3.channelNbr = this.channelNbr;
							}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
								dealerMap3.staffname = this.value;
							}
							if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"&&busiOrder.busiObj.instId==-1){
								dealerMap3.prodId=busiOrder.busiObj.instId;
							}
						}
						
					});
					if(ec.util.isObj(dealerMap1.role)){
						dealerlist.push(dealerMap1);
					}
					if(ec.util.isObj(dealerMap2.role)){
						dealerlist.push(dealerMap2);
					}
					if(ec.util.isObj(dealerMap3.role)){
						dealerlist.push(dealerMap3);
					}
					var objInstId = "";
					if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"){
						objInstId = this.data.ooRoles[0].prodId+"_"+this.busiObj.objId;
					}
					var dealeraccNbr = this.busiObj.accessNumber;
					for(var d=0;d<dealerlist.length;d++){
					  if(dealerlist[d].prodId&&dealerlist[d].prodId=="-1"){
						  	var objInstId = prodOfferId;
							var $tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
							var $tdType = $('<td></td>');
							var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
							var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
							$.each(OrderInfo.order.dealerTypeList,function(){
								if(dealerlist[d].role==this.PARTYPRODUCTRELAROLECD){
									$select.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
								}else{
									$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
								}
							});					
							$tdType.append($select);
							$tdType.append('<label class="f_red">*</label>');
							var accNbr = "主套餐";
							$tr.append("<td>"+accNbr+"</td>");
							$tr.append("<td>"+prodOfferName+"（包含接入产品）</td>");
							$tr.append($tdType);
							var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>');
							$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
							if(d==0){
								$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
							}else{
								$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');
							}					
							$tr.append($td);
							if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){
								OrderInfo.getChannelList();
							}
							var $tdChannel = $('<td></td>');
							var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
							$.each(OrderInfo.channelList,function(){
								if(dealerlist[d].channelNbr==this.channelNbr)
									$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
								else
									$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
							});
							$tdChannel.append($channelSelect);
							$tdChannel.append('<label class="f_red">*</label>');	
							$tr.append($tdChannel);
							OrderInfo.SEQ.dealerSeq++;
							$("#dealerTbody").append($tr);
					   }else{
							var $tr=$('<tr name="tr_'+objInstId+'"></tr>');
							var $tdType = $('<td></td>');
							var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
							var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
							$.each(OrderInfo.order.dealerTypeList,function(){
								if(dealerlist[d].role==this.PARTYPRODUCTRELAROLECD){
									$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected>"+this.NAME+"</option>");
								}else{
									$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
								}
							});
							$tdType.append($select);
							$tdType.append('<label class="f_red">*</label>');
							$tr.append("<td>"+dealeraccNbr+"</td>");
							if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){
								$tr.append("<td>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</td>");
							}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"){
								$tr.append("<td>"+this.busiObj.objName+"</td>");
							}
							$tr.append($tdType);
							var $td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>');
							$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
							if(d==0){
								$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
								$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+objInstId+'\')">添加</a><label class="f_red">*</label>');
							}else{
								$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');
							}
							$tr.append($td);
							if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){
								OrderInfo.getChannelList();
							}
							var $tdChannel = $('<td></td>');
							var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
							$.each(OrderInfo.channelList,function(){
								if(dealerlist[d].channelNbr==this.channelNbr)
									$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
								else
									$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
							});
							$tdChannel.append($channelSelect);
							$tdChannel.append('<label class="f_red">*</label>');	
							$tr.append($tdChannel);
							OrderInfo.SEQ.dealerSeq++;
							$("#dealerTbody").append($tr);
					   }
					}
				}
			}
		  });
		}
	
	return {
		searchPack	:_searchPack,
		queryPackForTerm:_queryPackForTerm,
		addNum:_addNum,
		subNum:_subNum,
		addNumNoLim:_addNumNoLim,
		subNumNoLim:_subNumNoLim,
		opeSer : _opeSer,
		buyService :_buyService,
		previous:_previous,
		next:_next,
		go_to_page:go_to_page,
		releaseFlag:_releaseFlag,
		boProdAn:_boProdAn,
		offerprice:_offerprice,
		initSpec:_initSpec,
		searchPackById:_searchPackById,
		offerDialog:_offerDialog,
		choosedOffer:_choosedOffer,
		setOfferSpec:_setOfferSpec,
		confirm		: _confirm,
		queryData:_queryData,
		buyServiceReload:_buyServiceReload,
		opeSerReload:_opeSerReload,
		callBackBuildOrder:_callBackBuildOrder,
		compareOrder:_compareOrder,
		compareServOrder:_compareServOrder,
		dealDevelopingPerson:_dealDevelopingPerson,
		oldMemberFlag:_oldMemberFlag,
		newMemberFlag:_newMemberFlag
		
	};
})();

/**
 * 订单信息对象
 * 
 * @author wukf
 */
CommonUtils.regNamespace("OrderInfo");

/** 订单信息对象*/
OrderInfo = (function() {
	//终端串码
	var _terminalCode="";
	//传入uim卡号
	var _mktResInstCode="";
	//传入的号码
	var acctNbr="";
	//套餐id
	var offid="";
	//判断是否二次加载
	var reloadFlag="";
	//二次加载的数据
	var data="";
	//保存发展人
	var dealers=new Array();
	/**
	 * UI集成页面信息
	 * provIsale 省份流水
	 * redirectUri 回调省份地址
	 * isFee  是否收费 1不收费  2收费
	 * extCustOrderID 集团流水
	 * mergeFlag 接口合并标识：1合并   0不合并
	 */
	var _provinceInfo={
		provIsale:"",
		redirectUri:"",
		isFee:"1",
		extCustOrderID:"",
		reloadFlag:"",
		prodOfferId:"",
		prodOfferName:"",
		mktResInstCode:"",
		codeMsg:"",
		mergeFlag:"0",
		salesCode:""
	};
	
	//新装是否带出主副卡号码和uim卡信息
	var _newOrderNumInfo = {
		mainPhoneNum:"",
		newSubPhoneNum:"",
		mktResInstCode:""
	};
	
	var _oldSubPhoneNum = {
		oldSubPhoneNum:""
	};
	
	//新装二次加载参数定义
	var _newOrderInfo={
		  result:{},
		  checkMaskList:[],//是否信控信息
		  prodOfferId:"",
		  prodOfferName:"",
		  isReloadFlag:"",
		  paymentAcctTypeCd:"",
		  mailingType:"",//投递方式
		  bankAcct:"",
		  bankId:"",
		  limitQty:"",
		  paymentMan:"",
		  param1:"",//投递地址
		  param2:"",//投递周期
		  param3:"",
		  param7:"", //账单内容
		  isLastFlag:""//判断是否需要上一步功能
		  
	};
	/*
	 * 每个功能点标识，0是产品变更等单业务动作订单提交，1新装，2变更,3可选包变更,4客户资料变更 5.拆副卡
	 * 
	 * 6 销售品成员变更加装副卡，7 拆主卡保留副卡 8单独新建客户,10 是公用节点传入 11 撤单，12 加入退出组合 
	 * 
	 * 13 购买裸机  14 合约套餐  15 补退费  16 改号	17 终端退货 18 终端换货 19返销 20返销,22补换卡,23异地补换卡
	 * 
	 * 31改产品密码，32重置产品密码，,33改产品属性，34修改短号，35分段受理（订单确认及后续受理）,36一卡双号订购
	 * 
	 */
	var _actionFlag = 0;
	
	var _isSuccess = "N";  // 补换卡  加载 可选包 是否成功 
	
	/*购物车业务动作
	1 新装
	2  套餐变更
	3  主副卡成员变更
	4  产品属性变更
	5  挂失/解挂
	6  停机保号/复机
	7  预拆机
	8  拆机
	9  违章拆机
	10  未激活拆机
	11  欠费拆机
	12  改客户资料返档
	13  补换卡
	14  可选包退订/订购
	15 过户
	16 改账务定制关系
	17 改产品密码*/
	
	var _busitypeflag = 0;
	
	var _orderlonger = "";
	
	var _custorderlonger = "";
	
	var _zcd_privilege ="";
	
	var _cust = { //保存客户信息
		custId : "",
		partyName : "",
		vipLevel : "",
		vipLevelName : "",
		custFlag :"1100"//1000：红客户，1100：白客户，1200：黑客户
	}; 
	
	var _staff = { //员工登陆信息
		staffId : 0,  //员工id
		channelId : 0,   //受理渠道id
		channelName: "",
		areaId : 0,    //受理地区id
		areaCode : 0,
		soAreaId : 0,    //新装受理地区id
		soAreaCode : 0, 
		distributorId : "" //转售商标识
	}; 
		
	var _offerSpec = {}; //主销售品构成
	
	var _offer = { //主销售品实例构成
		offerId : "",
		offerSpecId : "",
		offerMemberInfos : []
	}; 
	
	var _oldAddNumList = [];//老用户号码
	
	var _oldprodInstInfos = [];//老用户产品信息
	
	var _oldofferSpec = [];//老用户主销售品构成
	
	var _oldoffer = []; 
	
	var _oldprodAcctInfos = [];
	
	var _surplusNum = 0;//剩余可纳入副卡数量
	
	var _viceOfferSpec=[];//副卡换套餐，单产品套餐信息
	
	var _offerProdInst = { //主销售品实例构成查副卡信息
		offerId : "",
		offerSpecId : "",
		offerMemberInfos : []
	}; 
	
	var _actionClassCd = 0; //业务动作大类,订单初始化时赋值
	
	var _boActionTypeCd = ""; //业务动作小类,订单初始化时赋值
	
	var _actionTypeName = "订购"; //业务动作名称
	
	var _businessName = ""; //业务名称

	var _password_remark="";//lte产品密码鉴权
	
	var _confirmList = []; //保存特殊业务，确认页面展示使用
	
	var _orderResult = {};  //订单提交，返回结果报存
	
	var _checkresult = [];

	var _orderData = {}; //订单提交完整节点
	
	var _channelList = [];//渠道列表
	
	var _order = {  //订单常用全局变量
		dealerType : "",   //保存发展人类型
		soNbr : "", //购物车流水
		oldSoNbr : "", //撤单时用于保存选中某个订单的购物车流水
		oldSoId : "",//撤单时用于保存选中某个订单的购物车ID
		step : 0 , //页面步骤
		token : "", // 防止订单重复提交
		templateType : 1,   //模板类型: 0批量开活卡,1批量新装 ,2批量订购/退订附属, 3组合产品纳入退出 ,4批量修改产品属性,5批量换挡 ,8拆机 ,9批量修改发展人
		dealerTypeList : [] ////发展人类型列表
	};
	
	//权限控制
	var  _privilege = {
		effTime : ""
	};
	
	//序列号
	var _SEQ = {
		seq : -1,  //序列号，来区分每个业务对象动作,每次减1
		offerSeq : -1,  //序列号，用来实例化每个是销售品,每次减1
		prodSeq : -1,  //序列号，用来实例化每个是产品,每次减1
		servSeq : -1,  //序列号，用来实例化每个是服务,每次减1
		itemSeq : -1,  //序列号，用来实例化每个是产品属性,每次减1
		acctSeq : -1,  //序列号，用来实例化每个是帐户,每次减1
		acctCdSeq : -1,  //序列号，用来实例化每个是帐户合同号,每次减1
		paramSeq : -1,  //序列号，用来实例化每个附属销售品参数的每个值,每次减1
		atomActionSeq : -1,  //序列号，用来实例化每个原子动作的每个值,每次减1
		offerMemberSeq : -1, //序列号，用来实例化每个角色成员的每个值,每次减1
		dealerSeq : 1   //协销人序列号，
	};
	
	var _boCusts = []; //客户信息节点

	var _boProdItems = []; //产品属性节点列表
		
	var _boProdPasswords = []; //产品密码节点列表

	var _boProdAns = []; //号码信息节点列表
	
	var _boProd2Tds = []; //UIM卡节点信息列表
	
	var _boProd2OldTds = []; //保存旧UIM卡节点信息列表
	
	var _bo2Coupons = []; //物品信息节点
	
	var _attach2Coupons = []; //附属销售品需要的物品信息
	
	var _prodAttrs = []; //保存查询产品规格属性时返回的信息
	
	var _prodInstAttrs = []; //保存查询产品实例属性时返回的信息
	
	var _choosedUserInfos = []; //使用人信息
		
	var _checkUimData = []; //保存UIM校验后的返回数据
	 //window.localStorage.clear();
	//创建一个订单完整节点
	var _getOrderData = function(){
		//订单提交完整节点
		var data = { 
			orderList : {
				orderListInfo : { 
					isTemplateOrder : "N",   //是否批量
					templateType : OrderInfo.order.templateType,  //模板类型: 1 新装；8 拆机；2 订购附属；3 组合产品纳入/退出
					staffId : OrderInfo.staff.staffId,
					channelId : OrderInfo.staff.channelId,  //受理渠道id
					areaId : OrderInfo.staff.soAreaId,
					partyId : -1,  //新装默认-1
					distributorId : OrderInfo.staff.distributorId, //转售商标识
					olTypeCd : CONST.OL_TYPE_CD.UI_LTE  //UI能力开放标志
				},
				custOrderList :[{busiOrder : []}]   //客户订购列表节点
			}
		};
		OrderInfo.orderData = data;
		return OrderInfo.orderData;
	};		
		
	//创建客户节点
	var _createCust = function(busiOrders) {
		var accNbr = _getAccessNumber(-1);
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : -1 //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.CUST_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.CUST_CREATE
			}, 
			data:{
				boCustInfos : [],
				boCustIdentities : [],
				boPartyContactInfo : []
			}
		};
		if(ec.util.isObj(accNbr)){ //接入号
			busiOrder.busiObj.accessNumber = accNbr;
		}
		busiOrder.data.boCustInfos.push(OrderInfo.boCustInfos);
		busiOrder.data.boCustIdentities.push(OrderInfo.boCustIdentities);
		/*if($("#tabProfile0").attr("click")=="0"&&($("#contactName").val()!="")){
			busiOrder.data.boPartyContactInfo.push(OrderInfo.boPartyContactInfo);
		}*/
		// 联系人信息为空的情况下，新开户移动号码时，默认以本人及新办的手机号（如果是主副卡的，默认主号码）作为联系人信息
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14){
			if(OrderInfo.boPartyContactInfo.contactName == ""){
				var custName = OrderInfo.boCustInfos.name;
				OrderInfo.boPartyContactInfo.contactName = custName;
				OrderInfo.boPartyContactInfo.mobilePhone = accNbr;
			}
			busiOrder.data.boPartyContactInfo.push(OrderInfo.boPartyContactInfo);
		}
		if(OrderInfo.boCustProfiles!=undefined && OrderInfo.boCustProfiles!=""){
			busiOrder.data.boCustProfiles = [];
			busiOrder.data.boCustProfiles = OrderInfo.boCustProfiles;
		}
		busiOrders.push(busiOrder);
	};
	
	//创建帐户节点
	var _createAcct = function(busiOrders,acctId) {
		var acctName = $("#acctName").val();
		var paymentType = $("#paymentType").val();  //100000现金，110000银行
		var bankId = "";
		var bankAcct = "";
		var paymentMan = "";
		if(paymentType==110000){ //银行
			bankId = $("#bankId").val(); //银行ID
			bankAcct = $("#bankAcct").val(); //银行帐号
			paymentMan = $("#paymentMan").val(); //支付人
		}
		
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq-- 
			}, 
			busiObj : { //业务对象节点
				instId : acctId //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.ACCT_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.ACCT_CREATE
			}, 
			data : {
				boAccountInfos : [{  //帐户节点
					partyId : OrderInfo.cust.custId, //客户ID
					acctName : acctName, //帐户名称
					acctCd : acctId, //帐户CD
					acctId : acctId, //帐户ID
					businessPassword : "111111", //业务密码
					state : "ADD", //动作
					acctTypeCd : "1" // 默认1
				}],
				boPaymentAccounts : [{ //帐户托收节点
					paymentAcctTypeCd : paymentType, //类型
					bankId : bankId, //银行ID
					bankAcct : bankAcct, //银行帐户ID
					paymentMan : paymentMan, //付费人
					limitQty : "1", //数量
					state : "ADD" //动作
				}],
				boAcct2PaymentAccts : [{ //帐户付费关联关系节点
					priority : "1", //优先级
					state : "ADD" //动作
				}],
				boAccountItems : [],
				boAccountMailings : [] //账单投递信息节点	
			}
		};
		var accNbr = _getAccessNumber(-1);
		if(ec.util.isObj(accNbr)){ //接入号
			busiOrder.busiObj.accessNumber = accNbr;
		}
		//若选择了银行托收且填写了银行账户协议号则将该信息录入
		if($("#paymentType").val()==110000 && $.trim($("#protocalNbr").val())!=""){
			var boAccountItem_protocalNbr = {
					itemSpecId : CONST.ACCT_ATTR.PROTOCOL_NBR,  //账户属性：银行账户协议号 - 规格ID
					value : $.trim($("#protocalNbr").val()),
					state : "ADD"	
			};
			busiOrder.data.boAccountItems.push(boAccountItem_protocalNbr);
		}
		//若选择投递账单，则录入该信息
		if($("#postType").val()!=-1){
			var boAccountMailing = {
					mailingType : $("#postType").val(),   //*投递方式
					param1 : $("#postAddress").val(),     //*投递地址
					param2 : "1",                         //格式ID
					param3 : $("#postCycle").val(),       //*投递周期
					param7 : $("#billContent").val(),     //*账单内容
					state : "ADD"
			};
			if($("#postType").val()==11 || $("#postType").val()==15){				
				boAccountMailing.param1 = $("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val(); //*收件地址,邮编,收件人			
			}
			busiOrder.data.boAccountMailings.push(boAccountMailing);
		}
		busiOrders.push(busiOrder);
	};
	
	/**
	 * 获取销售品节点
	 * busiOrders 业务对象节点
	 * offer 销售品节点
	 * prodId 产品id
	 */
	var _getOfferBusiOrder = function (busiOrders,offer,prodId){
		var accNbr = _getAccessNumber(prodId);
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prodId),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq-- 
			}, 
			busiObj : { //业务对象节点
				instId : offer.offerId,  //业务对象实例ID
				objId : offer.offerSpecId,  //业务规格ID
				offerTypeCd : offer.offerTypeCd //2附属销售品
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : offer.boActionTypeCd
			}, 
			data:{}
		};
		
		if(ec.util.isObj(offer.offerSpecName)){ //销售品名称
			busiOrder.busiObj.objName = offer.offerSpecName;
		}
		if(ec.util.isObj(accNbr)){ //接入号
			busiOrder.busiObj.accessNumber = accNbr;
		}
		
		if(offer.boActionTypeCd == CONST.BO_ACTION_TYPE.BUY_OFFER){ //订购销售品
			//发展人
			var $tr = $("tr[name='tr_"+prodId+"_"+offer.offerSpecId+"']");
			if($tr!=undefined&&$tr.length>0){
				busiOrder.data.busiOrderAttrs = [];
				$tr.each(function(){   //遍历产品有几个发展人
					var dealer = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("staffid"),
						channelNbr : $(this).find("select[name ='dealerChannel_"+prodId+"_"+offer.offerSpecId+"']").val()
					};
					busiOrder.data.busiOrderAttrs.push(dealer);
					var dealer_name = {
							itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
							role : $(this).find("select").val(),
							value : $(this).find("input").attr("value") 
					};
					busiOrder.data.busiOrderAttrs.push(dealer_name);				
				});
			}
			//所属于人节点
			busiOrder.data.ooOwners = [];
			busiOrder.data.ooOwners.push({
				partyId : OrderInfo.cust.custId, //客户对象ID
				state : "ADD" //动作
			});
			//销售参数节点
			if(ec.util.isArray(offer.offerSpecParams)){  
				busiOrder.data.ooParams = [];
				$.each(offer.offerSpecParams,function(){
					if(this.setValue==undefined){
						this.setValue = this.value;
					}
					if(ec.util.isObj(this.setValue)){
						var ooParam = {
			                itemSpecId : this.itemSpecId,
			                offerParamId : OrderInfo.SEQ.paramSeq--,
			                offerSpecParamId : this.offerSpecParamId,
			                value : this.setValue,
			                state : "ADD"
			            };
						busiOrder.data.ooParams.push(ooParam);
					}
				});		
			}
			
			//销售生失效时间节点
			if(offer.ooTimes !=undefined ){  
				busiOrder.data.ooTimes = [];
				busiOrder.data.ooTimes.push(offer.ooTimes);
			}
			//销售品物品节点
			$.each(OrderInfo.attach2Coupons,function(){
				if(offer.offerSpecId == this.attachSepcId && prodId==this.prodId){
					busiOrder.data.bo2Coupons = [];//有多个
					return false;
				}	
			});
			$.each(OrderInfo.attach2Coupons,function(){
				if(offer.offerSpecId == this.attachSepcId && prodId==this.prodId){
					this.offerId = offer.offerId;
//					busiOrder.data.bo2Coupons = [];//有多个
					busiOrder.data.bo2Coupons.push(this);
//					return false;
				}	
			});
			//销售品成员角色节点
			busiOrder.data.ooRoles = [];
			//遍历附属销售品构成
			if(ec.util.isArray(offer.offerRoles)){
				$.each(offer.offerRoles,function(){
					var offerRole = this;
					$.each(this.roleObjs,function(){
						var ooRoles = {
							prodId : prodId, //产品id
							offerRoleId : offerRole.offerRoleId, //销售品角色ID
							objId : this.objId, //规格id
							objType : this.objType, // 业务对象类型
							relaType : this.relaTypeCd,
							state : "ADD" //动作
						};
						var flag = true;
						if(this.objType == CONST.OBJ_TYPE.PROD){ //产品
							var prodSpecId = OrderInfo.getProdSpecId(prodId);
							if(prodSpecId==this.objId || prodSpecId==""){//兼容省份空规格
								ooRoles.objInstId = prodId;//业务对象实例ID
							}else{
								return true;
							}
						}else if(this.objType == CONST.OBJ_TYPE.SERV){ //服务
							var serv = CacheData.getServBySpecId(prodId,this.objId); //从服务实例中取值
							if(serv!=undefined){
								ooRoles.objInstId = serv.servId;
							}else{
								var servSpec = CacheData.getServSpec(prodId,this.objId); //从服务规格中取值
								if(servSpec!=undefined && servSpec.isdel!="Y" && servSpec.isdel != "C" && servSpec.servId!=undefined && servSpec.servId!=""){
									ooRoles.objInstId = servSpec.servId;
								}else{
									flag = false;
								}
							}
						}else { // 7销售品
							ooRoles.objInstId = OrderInfo.SEQ.offerSeq--;//业务对象实例ID
						}
						if(flag){
							busiOrder.data.ooRoles.push(ooRoles);
						}
					});
				});
			}
			busiOrders.push(busiOrder);
		}else if(offer.boActionTypeCd == CONST.BO_ACTION_TYPE.DEL_OFFER){ //退订销售品
			busiOrder.data.ooOwners = [];
			busiOrder.data.ooOwners.push({
				partyId : OrderInfo.cust.custId, //客户对象ID
				state : "DEL" //动作
			});
			if(ec.util.isArray(offer.offerMemberInfos)){ //遍历主销售品构成
				busiOrder.data.ooRoles = [];
				$.each(offer.offerMemberInfos,function(){
					var ooRoles = {
						objId : this.objId, //业务规格ID
						objInstId : this.objInstId, //业务对象实例ID,新装默认-1
						objType : this.objType, // 业务对象类型
						offerRoleId : this.offerRoleId, //销售品角色ID
						state : "DEL" //动作
					};
					if(this.objType != CONST.OBJ_TYPE.PROD){ //不是接入产品
						ooRoles.prodId = prodId;//业务对象实例ID
					}
					if(this.offerMemberId!=undefined){  //兼容两级接口
						ooRoles.offerMemberId = this.offerMemberId; //成员id
					}
					busiOrder.data.ooRoles.push(ooRoles);
				});
			}
			if(offer.isRepeat!="Y"){//是否是用一个实例的销售品（用于3转4的预校验判断）
				busiOrders.push(busiOrder);
			}
		}else if(offer.boActionTypeCd == CONST.BO_ACTION_TYPE.UPDATE_OFFER){ //销售品成员变更,改参数
			if(offer.isUpdate=="Y"){ //销售品成员变更
				busiOrder.data.ooRoles = offer.data;
			}else{
				if(ec.util.isArray(offer.offerSpec.offerSpecParams)){
					busiOrder.data.ooParams = [];
					$.each(offer.offerSpec.offerSpecParams,function(){
						if(this.isUpdate=="Y"){
							if(ec.util.isObj(this.value)){
								var delParam = {
					                itemSpecId : this.itemSpecId,
					                offerParamId : this.offerParamId,
					                offerSpecParamId : this.offerSpecParamId,
					                value : this.value,
					                state : "DEL"
					            };
								busiOrder.data.ooParams.push(delParam);
							}
							if(ec.util.isObj(this.setValue)){
								var addParam = {
					                itemSpecId : this.itemSpecId,
					                offerParamId : OrderInfo.SEQ.paramSeq--,
					                offerSpecParamId : this.offerSpecParamId,
					                value : this.setValue,
					                state : "ADD"
					            };
					            busiOrder.data.ooParams.push(addParam);
							}
						}
					});	
				}
			}
			busiOrders.push(busiOrder);
		}
	};
			

	/*
	 * 获取产品节点
	 * @param  prodId 产品ID
	 * @param  servSpecName 产品名称
	 * @param  isComp  是否组合
	 * @param  boActionTypeCd  动作类型
	 */
	var _getProdBusiOrder = function (prodServ){
		var accNbr = _getAccessNumber(prodServ.prodId);
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prodServ.prodId),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq-- 
			}, 
			busiObj : { //业务对象节点
				objId : OrderInfo.getProdSpecId(prodServ.prodId),  //业务对象ID
				instId : prodServ.prodId //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,
				boActionTypeCd : prodServ.boActionTypeCd
			}, 
			data:{}
		};
		if(ec.util.isObj(prodServ.isComp)){ //是否组合
			busiOrder.busiObj.isComp = prodServ.isComp;
		}
		if(ec.util.isObj(accNbr)){ //接入号码
			busiOrder.busiObj.accessNumber = accNbr;
		}
		
		if(prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.PRODUCT_PARMS){ //改产品属性
			if(ec.util.isArray(prodServ.prodSpecParams)){
				busiOrder.data.boServOrders = [];
				busiOrder.data.boServOrders.push({
					servId: prodServ.memberId,
                    servSpecId: prodServ.servSpecId
				});
				busiOrder.data.boServItems = [];
				$.each(prodServ.prodSpecParams,function(){
					if(this.isUpdate=="Y"){
						if(ec.util.isObj(this.value)){
							var delParam = {
				                itemSpecId : this.itemSpecId,
				                servId : prodServ.memberId,
				                value : this.value,
				                state : "DEL"
				            };
							busiOrder.data.boServItems.push(delParam);
						}
						if(ec.util.isObj(this.setValue)){
							var addParam = {
				                itemSpecId : this.itemSpecId,
				                servId : prodServ.memberId,
				                value : this.setValue,
				                state : "ADD"
				            };
							busiOrder.data.boServItems.push(addParam);	
						}
					}
				});
			}
		}else if(prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.SERV_OPEN){  //服务开通或关闭
			var state = "ADD";
			if(prodServ.servClose == "Y"){ //服务关闭
				state = "DEL";
			}else {
				if(prodServ.servSpecId == undefined && prodServ.objId != undefined){
					prodServ.servSpecId = prodServ.objId;  //服务开通
				}
			}
			var servOrder = {
				servId: prodServ.servId,
                servSpecId: prodServ.servSpecId
			};
			if(ec.util.isObj(prodServ.servSpecName)){ //产品名称
				servOrder.servSpecName = prodServ.servSpecName;
			}
			busiOrder.data.boServOrders = [];
			busiOrder.data.boServOrders.push(servOrder);
			
			busiOrder.data.boServs = [];
			busiOrder.data.boServs.push({
				servId: prodServ.servId,
                state: state
			});
			if(prodServ.servClose != "Y"){ //服务开通
				if(ec.util.isArray(prodServ.prodSpecParams)){
					busiOrder.data.boServItems = [];
					$.each(prodServ.prodSpecParams,function(){
						if(this.setValue==undefined){
							this.setValue = this.value;
						}
						var feeType = $("select[name='pay_type_-1']").val();
						if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
						if(prodServ.servSpecId == CONST.YZFservSpecId && feeType == CONST.PAY_TYPE.AFTER_PAY){
							this.setValue = "";
						}
						if(ec.util.isObj(this.setValue)){
							var addParam = {
				                itemSpecId : this.itemSpecId,
				                servId : prodServ.servId,
				                value : this.setValue,
				                state : state
				            };
				            busiOrder.data.boServItems.push(addParam);
						}
					});
				}
				
				//发展人
				/*var $tr = $("tr[name='tr_"+prodId+"_"+prodServ.servSpecId+"']");
				if($tr!=undefined&&$tr.length>0){
					if(!ec.util.isArray(busiOrder.data.busiOrderAttrs)){
						busiOrder.data.busiOrderAttrs = [];
					}
					$tr.each(function(){   //遍历产品有几个发展人
						var dealer = {
							itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
							role : $(this).find("select").val(),
							value : $(this).find("input").attr("staffid") 
						};
						busiOrder.data.busiOrderAttrs.push(dealer);
					});
				}*/
			}
		}else if(prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.REMOVE_PROD){  //拆机
			busiOrder.data.boProdStatuses = [{ 
				prodStatusCd : CONST.PROD_STATUS_CD.NORMAL_PROD,
				state : "DEL"
			},{prodStatusCd : CONST.PROD_STATUS_CD.REMOVE_PROD,
				state : "ADD"
			}];
		}else if(prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.CHANGE_CARD ||
				prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD){  //补换卡	
			var proUim = OrderInfo.getProdUim(prodServ.prodId); //获取新卡
			if(ec.util.isObj(proUim.prodId)){ //有新卡
				busiOrder.data.bo2Coupons = [];
				busiOrder.data.bo2Coupons.push(proUim);
				busiOrder.data.bo2Coupons.push(OrderInfo.getProdOldUim(prodServ.prodId));
			}else if(OrderInfo.zcd_privilege==0){//暂存信息 只录入老卡
				busiOrder.data.bo2Coupons = [];
				busiOrder.data.bo2Coupons.push(OrderInfo.getProdOldUim(prodServ.prodId));
			}else{
				return false;
			}
 		}
		return busiOrder;
	};
	
	/**
	 * 设置产品修改类通用服务
	 * busiOrders 业务对象节点
	 * data 数据节点
	 */
	var _setProdModifyBusiOrder = function(busiOrders,data) {	
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息 
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				objId : prodInfo.productId,//prodInfo.productId, //业务对象规格ID
				instId : prodInfo.prodInstId, //业务对象实例ID
				accessNumber : prodInfo.accNbr  //业务号码
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		busiOrder.data =data;
		busiOrders.push(busiOrder);
	};
	
	//获取产品跟可选包的关联关系
	/*var _getRelaType = function(servSpecId){
		var relaType = "";
		//遍历已开通附属销售品列表
		$.each(AttachOffer.openList,function(){
			$.each(this.specList,function(){
				$.each(this.offerRoles,function(){
					$.each(this.roleObjs,function(){
						if(this.objId==servSpecId){
							relaType = this.relaTypeCd;
							return false;
						}
					});
				});
			});
		});
		return relaType;
	};*/
	
	//客户信息节点
	var _boCustInfos = {
		areaId : 0,
		defaultIdType:"1",//证件类型
		businessPassword : "", //客户密码
		name : "", //	客户名称
		partyTypeCd : 1,//客户类型
		state : "ADD", //状态
		telNumber : "",  //联系电话
		addressStr:"",//客户地址
		mailAddressStr:""//通信地址
	};
	
	//客户证件节点
	var _boCustIdentities = {
		identidiesTypeCd : "1", //证件类型
		identityNum : "", //证件号码
		isDefault : "Y", //是否首选
		state : "ADD"  //状态
	};

	//客户联系人节点
	var _boPartyContactInfo = {
		contactAddress : "",//参与人的联系地址
        contactDesc : "",//参与人联系详细信息
        contactEmployer  : "",//参与人的联系单位
        contactGender  : "",//参与人联系人的性别
        contactId : "",//参与人联系信息的唯一标识
        contactName : "",//参与人的联系人名称
        contactType : "",//联系人类型
        eMail : "",//参与人的eMail地址
        fax : "",//传真号
        headFlag : "",//是否首选联系人
        homePhone : "",//参与人的家庭联系电话
        mobilePhone : "",//参与人的移动电话号码
        officePhone : "",//参与人办公室的电话号码
        postAddress : "",//参与人的邮件地址
        postcode : "",//参与人联系地址的邮政编码
        staffId : 0,//员工ID
        state : "",//状态
        statusCd : "100001"//订单状态
	};
	
	//客户属性
	var _boCustProfiles = {};
	
	//初始化序列
	var _resetSeq = function(){
		OrderInfo.SEQ.seq = -1;  
		OrderInfo.SEQ.offerSeq = -1; 
		OrderInfo.SEQ.prodSeq = -1;  
		OrderInfo.SEQ.servSeq = -1;  
		OrderInfo.SEQ.itemSeq = -1;  
		OrderInfo.SEQ.acctSeq = -1;  
		OrderInfo.SEQ.acctCdSeq = -1;  
		OrderInfo.SEQ.paramSeq = -1;  
		OrderInfo.SEQ.atomActionSeq = -1;
		//OrderInfo.SEQ.dealerSeq = 1;
	};
	
	//初始化数据
	var _resetData = function(){
		OrderInfo.boProdAns = [];  
		OrderInfo.boProd2Tds = []; 
		//OrderInfo.boProd2OldTds = []; 
		OrderInfo.bo2Coupons = [];
		AttachOffer.openList = [];
		AttachOffer.openedList = [];
		AttachOffer.openServList = [];
		AttachOffer.openedServList = [];
		AttachOffer.openAppList = [];
		AttachOffer.labelList = [];
		AttachOffer.allOfferList = [];
		OrderInfo.confirmList = [];
		OrderInfo.orderResult = {}; 
		/*OrderInfo.offerSpec = {}; //主销售品构成
		OrderInfo.offer = { //主销售品实例构成
			offerId : "",
			offerSpecId : "",
			offerMemberInfos : []
		}; */
		OrderInfo.order.step = 1;   //填单页面步骤为1
	};
	
	//初始化基础数据，actionClassCd 动作大类，boActionTypeCd 动作小类，actionFlag 受理类型，actionTypeName 动作名称，批量模板使用 templateType
	var _initData = function(actionClassCd,boActionTypeCd,actionFlag,actionTypeName,templateType){
		if(actionClassCd!=""&&actionClassCd!=undefined){
			OrderInfo.actionClassCd = actionClassCd;
		}
		if(boActionTypeCd!=""&&boActionTypeCd!=undefined){
			OrderInfo.boActionTypeCd = boActionTypeCd;
		}
		if(actionFlag!=undefined){
			OrderInfo.actionFlag = actionFlag;
		}
		if(actionTypeName!=""&&actionTypeName!=undefined){
			OrderInfo.actionTypeName = actionTypeName;
		}
		if(templateType!=""&&templateType!=undefined){
			OrderInfo.order.templateType = templateType;
		}
	};
	
	//获取号码
	var _getProdAn = function(prodId){
		var prodAn = {};
		for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
			var an = OrderInfo.boProdAns[i];
			if(an==undefined){
				continue;
			}else{
				if(an.prodId == prodId){
					prodAn = an;
				}
			}
		}
		return prodAn;
	};

	//获取号码
	var _setProdAn = function(prodId,an){
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			$.each(this.prodInsts,function(){
				if(this.prodInstId == prodId){
					this.an = an;
					return false;
				}
			});
		});
	};
	
	
	//获取选号对应的地区
	var _getProdAreaId = function(prodId){
		try {
			//如果是分段受理,返回分段受理的受理地区ID
			if(stepOrder.main.isStepOrder){
				return stepOrder.main.areaId;
			}
		} catch (e) {
		}
		
		if(prodId!=undefined && prodId>0){ //二次业务
			var areaId = order.prodModify.choosedProdInfo.areaId;
			
			if(ec.util.isArray(OrderInfo.oldprodInstInfos) && order.service.oldMemberFlag){
				if(ec.util.isObj(OrderInfo.cust.areaId)){
					areaId = OrderInfo.cust.areaId;
				}else{
					areaId = OrderInfo.staff.soAreaId;
				}
			}
			
			if(areaId == undefined || areaId==""){
				$.alert("错误提示","产品信息未返回地区ID，请营业后台核实！");
				return ; 
			}
			return areaId;
		}else { //新装
			if(prodId!=undefined && prodId<0 && OrderInfo.actionFlag==6) {// 新装副卡取产品地区
				var areaId = order.prodModify.choosedProdInfo.areaId;
				if(areaId == undefined || areaId==""){
					$.alert("错误提示","产品信息未返回地区ID，请营业后台核实！");
					return ; 
				}
				return areaId;
			}
			if(ec.util.isObj(OrderInfo.cust.areaId)){
				return OrderInfo.cust.areaId;
			}else{
				return OrderInfo.staff.soAreaId;
			}
		}
	};
	
	//获取订单地区ID
	var _getAreaId = function(){
		//默认使用受理地区
		var areaId = OrderInfo.staff.soAreaId;		
		//裸机销售，终端退换货，分段受理订单还原 不需要定位客户，使用默认的受理地区
		if(OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18 || OrderInfo.actionFlag==35){			
		}
		//新装，合约机新装，客户资料修改，使用客户归属地区
		else if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14 || OrderInfo.actionFlag==4 || OrderInfo.actionFlag==9){
			if(ec.util.isObj(OrderInfo.cust.areaId)){
				areaId = OrderInfo.cust.areaId;
			}
		}		
		//其他二次业务使用产品的归属地区			
		else if(ec.util.isObj(order.prodModify.choosedProdInfo.areaId)){				
			areaId = order.prodModify.choosedProdInfo.areaId;			
		}	
		return areaId;
	};
		
	//获取uim对象
	var _getProdOldUim = function(prodId){
		for (var i = 0; i < OrderInfo.boProd2OldTds.length; i++) {
			var td = OrderInfo.boProd2OldTds[i];
			if(td.prodId == prodId){
				return td;
			}
		}
		return {};
	};
	
	//获取uim对象
	var _getProdUim = function(prodId){
		for (var i = 0; i < OrderInfo.boProd2Tds.length; i++) {
			var td = OrderInfo.boProd2Tds[i];
			if(td.prodId == prodId){
				return td;
			}
		}
		return {};
	};
	
	//清空旧uim
	var _clearProdUim = function(prodId){
		for (var i = 0; i < OrderInfo.boProd2Tds.length; i++) {
			var td = OrderInfo.boProd2Tds[i];
			if(td.prodId == prodId){
				OrderInfo.boProd2Tds.splice(i,1);
			}
		}
	};
	
	//清空校验UIM返回数据
	var _clearCheckUimData = function(prodId){
		for (var i = 0; i < OrderInfo.checkUimData.length; i++) {
			var td = OrderInfo.checkUimData[i];
			if(td.prodId == prodId){
				OrderInfo.checkUimData.splice(i,1);
			}
		}
	};
	
	//获取校验UIM返回数据
	var _getCheckUimData = function(prodId){
		for (var i = 0; i < OrderInfo.checkUimData.length; i++) {
			var td = OrderInfo.checkUimData[i];
			if(td.prodId == prodId){
				return td;
			}
		}
		return "";
	};
	
	//获取uim卡
	var _getProdTd = function(prodId){
		for (var i = 0; i < OrderInfo.boProd2Tds.length; i++) {
			var td = OrderInfo.boProd2Tds[i];
			if(td.prodId == prodId){
				return td.terminalCode;
			}
		}
		return "";
	};
	
	//获取物品
	var _getProdCoupon = function(prodId){
		var flag = true;
		for (var i = 0; i < OrderInfo.bo2Coupons.length; i++) {
			var coupon = OrderInfo.bo2Coupons[i];
			if(coupon.prodId == prodId){
				flag = false ;
				return coupon;
			}
		}
		if(flag){
			var bo2Coupon = {
				prodId : prodId,
				coupons : []
			};
			OrderInfo.bo2Coupons.push(bo2Coupon);
			return bo2Coupon;
		}
	};
	
	//初始化物品
	var _initProdCoupon = function(prodId){
		var flag = true;
		for (var i = 0; i < OrderInfo.bo2Coupons.length; i++) {
			var coupon = OrderInfo.bo2Coupons[i];
			if(coupon.prodId == prodId){
				coupon.coupons = [];
				return coupon;
			}
		}
		if(flag){
			var bo2Coupon = {
				prodId : prodId,
				coupons : []
			};
			OrderInfo.bo2Coupons.push(bo2Coupon);
			return bo2Coupon;
		}
	};
	
	//根据产品id获取号码
	var _getAccessNumber = function(prodId){
		var accessNumber = "";
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14){
			if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//判断是否是纳入老用户
				$.each(OrderInfo.oldoffer,function(){
					var oldoffer = this;
					$.each(oldoffer.offerMemberInfos,function(){
						if(this.objInstId==prodId){
							accessNumber = this.accessNumber;
							return false;
						}
					});
				});
			}else{
				for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
					var an = OrderInfo.boProdAns[i];
					if(an.prodId == prodId){
						if(an.accessNumber != undefined ){
							accessNumber =  an.accessNumber;
						}
					}
				}
			}
		}else if(OrderInfo.actionFlag==6 || OrderInfo.actionFlag==2){
			for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
				var an = OrderInfo.boProdAns[i];
				if(an.prodId == prodId){
					if(an.accessNumber != undefined ){
						accessNumber =  an.accessNumber;
					}
				}
			}
			$.each(OrderInfo.oldprodInstInfos,function(){
				if(this.prodInstId==prodId){
					accessNumber = this.accNbr;
					return false;
				}
			});
			$.each(OrderInfo.offer.offerMemberInfos,function(i){
				if(this.objInstId==prodId){
					accessNumber = this.accessNumber;
					return false;
				}
			});
		}else if(OrderInfo.actionFlag==21){
			$.each(OrderInfo.offer.offerMemberInfos,function(i){
				if(this.objInstId==prodId){
					accessNumber = this.accessNumber;
					return false;
				}
			});
		} else if(OrderInfo.actionFlag == 35){ //分段受理
			accessNumber = stepOrder.main.getAccessNumber(prodId);
		} else if(prodId!=undefined && prodId>0){
			accessNumber = order.prodModify.choosedProdInfo.accNbr;	
		}
		return accessNumber;
	};
	
	//根据产品id获取地区编码
	var _getAreaCode = function(prodId){
		var areaCode = "";
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==14){
			for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
				var an = OrderInfo.boProdAns[i];
				if(an.prodId == prodId){
					if(an.areaCode != undefined ){
						areaCode =  an.areaCode;
					}
				}
			}
		}else if(prodId!=undefined && prodId>0){
			areaCode = order.prodModify.choosedProdInfo.areaCode;	
		}
		if(areaCode ==undefined || areaCode==""){
			areaCode = OrderInfo.staff.areaCode;	
		}
		return areaCode;
		
	};
	
	//根据产品id获取号码
	var _getAccNbrByRoleCd = function(roleCd){
		var accNbr = "";
		$.each(OrderInfo.boProdAns,function(){
			if(this.memberRoleCd==roleCd){
				accNbr = this.accessNumber;
				return false;
			}
		});
		if(accNbr==undefined || accNbr==""){
			accNbr = OrderInfo.boProdAns[0].accessNumber;
		}
		return accNbr;
	};
	
	//获取产品对应的角色
	var _getOfferRoleName = function(prodId){
		var offerRoleName = "";
		if(OrderInfo.actionFlag==2 || OrderInfo.actionFlag==3){
			if(OrderInfo.offer.offerMemberInfos!=undefined){
				$.each(OrderInfo.offer.offerMemberInfos,function(i){
					if(this.objInstId == prodId){
						offerRoleName = this.roleName;  //角色名称
						return false;
					}
				});
			}
			$.each(OrderInfo.oldoffer,function(){
				$.each(this.offerMemberInfos,function(){
					if(this.objInstId == prodId){
						offerRoleName = this.roleName;  //角色名称
						return false;
					}
				});
			});
			if(OrderInfo.offerSpec.offerRoles!=undefined){
				$.each(OrderInfo.offerSpec.offerRoles,function(i){
					var roleName = this.offerRoleName;  //角色名称
					if(this.prodInsts!=undefined){
						$.each(this.prodInsts,function(){
							if(this.prodInstId == prodId){
								offerRoleName = roleName;
								return false;
							}
						});
					}
				});
			}
		}else{
			if(OrderInfo.offerSpec.offerRoles!=undefined){
				$.each(OrderInfo.offerSpec.offerRoles,function(i){
					var roleName = this.offerRoleName;  //角色名称
					if(this.prodInsts!=undefined){
						$.each(this.prodInsts,function(){
							if(this.prodInstId == prodId){
								offerRoleName = roleName;
								return false;
							}
						});
					}
				});
			}
		}
		return offerRoleName;
	};
	
	//根据产品Id获取缓存中的产品实例
	var _getProdInst = function(prodId){
		var prodInst = {};
		if(OrderInfo.actionFlag == 2){ //套餐变更
			$.each(OrderInfo.offer.offerMemberInfos,function(i){
				if(this.objInstId ==prodId){
					prodInst = this;
					prodInst.accNbr = this.accessNumber;
					return false;
				}
			});
			$.each(OrderInfo.offerSpec.offerRoles,function(i){
				if(this.prodInsts!=undefined){
					$.each(this.prodInsts,function(){
						if(this.prodInstId == prodId){
							prodInst = this;
							return false;
						}
					});
				}
			});
			$.each(OrderInfo.oldoffer,function(){
				$.each(this.offerMemberInfos,function(){
					if(this.objInstId == prodId){
						prodInst = this;
						prodInst.accNbr = this.accessNumber;
						return false;
					}
				});
			});
		}else if(OrderInfo.actionFlag == 3 || OrderInfo.actionFlag == 22){ //可选包变更
			prodInst = order.prodModify.choosedProdInfo;
		}else { //新装
			$.each(OrderInfo.offerSpec.offerRoles,function(i){
				if(this.prodInsts!=undefined){
					$.each(this.prodInsts,function(){
						if(this.prodInstId == prodId){
							prodInst = this;
							return false;
						}
					});
				}
			});
		}
		return prodInst;
	};
	
	//根据接入产品id获取接人产品规格
	var _getProdSpecId = function(prodId){
		var prodSpecId = CONST.PROD_SPEC.CDMA;  //默认CDMA
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14){
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				$.each(this.prodInsts,function(){
					if(this.prodInstId == prodId){
						prodSpecId = this.objId;
						return false;
					}
				});
			});
		}else if(OrderInfo.actionFlag==2){
			$.each(OrderInfo.offer.offerMemberInfos,function(i){
				if(this.objInstId==prodId){
					prodSpecId = this.objId;
					return false;
				}
			});
			if(offerChange.oldMemberFlag){
				$.each(OrderInfo.oldoffer,function(){
					$.each(this.offerMemberInfos,function(){
						if(this.objInstId==prodId){
							prodSpecId = this.objId;
							return false;
						}
					});
				});
			}
			if(offerChange.newMemberFlag){
				$.each(OrderInfo.offerSpec.offerRoles,function(){
					$.each(this.prodInsts,function(){
						if(this.prodInstId == prodId){
							prodSpecId = this.objId;
							return false;
						}
					});
				});
			}
		} else if(prodId!=undefined && prodId>0){
			if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//判断是否是纳入老用户
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.prodInstId==prodId){
						prodSpecId = this.productId;
					}
				});
			}else{
				prodSpecId = order.prodModify.choosedProdInfo.productId;
			}
		}
		return prodSpecId;
	};
	
	//获取权限
	var _getPrivilege = function(manageCode){
		if(OrderInfo.privilege.effTime==""){
			var param = {
				manageCode : manageCode	
			};
			return query.offer.checkOperate(param);
		}
	};
	
	var _updateChooseUserInfos = function(prodId, custInfo){
		if(!OrderInfo.choosedUserInfos){
			OrderInfo.choosedUserInfos = [];
		}
		var index = -1;
		for(var i=0; i<OrderInfo.choosedUserInfos.length; i++){
			if(OrderInfo.choosedUserInfos[i].prodId == prodId){
				index = i;
				break;
			}
		}
		if(index == -1){
			OrderInfo.choosedUserInfos.push({
				prodId : prodId,
				custInfo : custInfo
			});
		} else {
			OrderInfo.choosedUserInfos[index].custInfo = custInfo; 
		}
	};
	
	var _getChooseUserInfo = function(prodId){
		if(!!OrderInfo.choosedUserInfos && OrderInfo.choosedUserInfos.length){
			for(var i=0; i<OrderInfo.choosedUserInfos.length; i++){
				if(OrderInfo.choosedUserInfos[i].prodId == prodId){
					return OrderInfo.choosedUserInfos[i].custInfo;
				}
			}
		}
		return null;
	};
	
	var _resetChooseUserInfo = function(){
		order.cust.queryForChooseUser = false; //重置选择使用人标识
		order.cust.tmpChooseUserInfo = {};
		OrderInfo.choosedUserInfos = [];
	};
				
	_newofferSpecName = "";
	
	//是否是群功能产品
	var _isGroupProSpecId=function(specId){
		for(var i=0;i<CONST.GROUP_SERV_SPEC_ID.length;i++){
			if(CONST.GROUP_SERV_SPEC_ID[i]==specId){
				return true;
			}
		}
		return false;
	};
	
	/**
	 * 获取渠道List
	 */
	var _getChannelList = function (busiOrders,offer,prodId){
		OrderInfo.channelList = [];
		if($("i[name='channel_iofo_i']").length==0){
			OrderInfo.channelList = window.parent.OrderInfo.getChannelList();
		}else{
			$("i[name='channel_iofo_i']").each(function(){				
				var channelId = $(this).attr("channel_Id");
				var channelName = $(this).attr("channel_Name");
				var channelNbr = $(this).attr("channel_Nbr");
				var isSelect = 0;
				if($(this).hasClass("select"))
					var isSelect = 1;
				var channelInfo ={
						channelId : channelId,
						channelName : channelName,
						channelNbr : channelNbr,
						isSelect : isSelect
				}
				OrderInfo.channelList.push(channelInfo)
			});
		}
		return OrderInfo.channelList;
	};
				
	return {
		terminalCode:_terminalCode,
		mktResInstCode:_mktResInstCode,
		order					: _order,
		SEQ						: _SEQ,
		resetSeq				: _resetSeq,
		resetData				: _resetData,	
		orderResult				: _orderResult,
		cust					: _cust,
		staff					: _staff,
		offerSpec				: _offerSpec,
		offer 					: _offer,
		attach2Coupons			: _attach2Coupons,
		boCustInfos 			: _boCustInfos,
		boCustIdentities 		: _boCustIdentities,
		boPartyContactInfo 		: _boPartyContactInfo,
		boCustProfiles			: _boCustProfiles,
		boCusts					: _boCusts,
		boProdItems				: _boProdItems,
		boProdPasswords			: _boProdPasswords,
		boProdAns				: _boProdAns,
		boProd2Tds				: _boProd2Tds,
		bo2Coupons				: _bo2Coupons,
		boProd2OldTds			: _boProd2OldTds,
		clearProdUim			: _clearProdUim,
		clearCheckUimData		: _clearCheckUimData,
		getCheckUimData			: _getCheckUimData,
		orderData 				: _orderData,
		getOrderData 			: _getOrderData,
		actionClassCd			: _actionClassCd,
		boActionTypeCd			: _boActionTypeCd,
		actionFlag 				: _actionFlag,
		isSuccess 				: _isSuccess,
		actionTypeName			: _actionTypeName,
		initData				: _initData,
		getOfferBusiOrder		: _getOfferBusiOrder,
		getProdBusiOrder		: _getProdBusiOrder,
		createCust				: _createCust,
		createAcct				: _createAcct,
		getProdAn				: _getProdAn,
		getProdTd				: _getProdTd,
		getProdUim				: _getProdUim,
		getProdOldUim			: _getProdOldUim,
		getProdAreaId			: _getProdAreaId,
		getProdCoupon			: _getProdCoupon,
		getProdInst				: _getProdInst,
		getAccessNumber			: _getAccessNumber,
		getAreaCode				: _getAreaCode,
		getAreaId 				: _getAreaId,
		getOfferRoleName		: _getOfferRoleName,
		getAccNbrByRoleCd    	: _getAccNbrByRoleCd,
		getProdSpecId			: _getProdSpecId,
		getPrivilege			: _getPrivilege,
		initProdCoupon			: _initProdCoupon,
		setProdAn				: _setProdAn,
		setProdModifyBusiOrder	: _setProdModifyBusiOrder,
		confirmList				: _confirmList,	
		businessName			: _businessName,
		password_remark         : _password_remark,
		privilege				: _privilege,
		offerProdInst          	: _offerProdInst,
		orderlonger				:_orderlonger,
		busitypeflag			:_busitypeflag,
		checkresult				:_checkresult,
		custorderlonger			:_custorderlonger,
		prodAttrs				:_prodAttrs,
		zcd_privilege			:_zcd_privilege,
		oldprodInstInfos		:_oldprodInstInfos,
		oldofferSpec			:_oldofferSpec,
		oldoffer				:_oldoffer,
		oldprodAcctInfos		:_oldprodAcctInfos,
		oldAddNumList			:_oldAddNumList,
		newofferSpecName		:_newofferSpecName,
		viceOfferSpec			:_viceOfferSpec,
		prodInstAttrs			:_prodInstAttrs,
		isGroupProSpecId		:_isGroupProSpecId,
		choosedUserInfos 		:_choosedUserInfos,
		updateChooseUserInfos	:_updateChooseUserInfos,
		getChooseUserInfo		:_getChooseUserInfo,
		resetChooseUserInfo		:_resetChooseUserInfo,
		checkUimData			:_checkUimData,
		provinceInfo           	:_provinceInfo,
		newOrderInfo          	:_newOrderInfo,
		newOrderNumInfo        	:_newOrderNumInfo,
		surplusNum				:_surplusNum,
		oldSubPhoneNum			:_oldSubPhoneNum,
		channelList			 	:_channelList,
		getChannelList			:_getChannelList
	};
})();

CommonUtils.regNamespace("order", "main");

order.main = (function(){ 
	
	/**
	 * 填单页面展示
	 * param = {
	 * 		boActionTypeCd : S1,
	 * 		boActionTypeName : "订购",
	 *		offerSpecId : 1234,//销售品规格ID
	 *		offerSpecName : "乐享3G-129套餐",//销售品名称,
	 *		feeType : 2100,付费类型
	 *		viceCardNum : 2,//副卡数量
	 *		offerNum : 3,//销售品数量
	 *		type : 1,//1购套餐2购终端3选靓号
	 *		terminalInfo : {
	 *			terminalName : "iphone",
	 *			terminalCode : "2341234124"
	 *		},
	 *		offerRoles : [
	 *			{
	 *				offerRoleId : 1234,
	 *				offerRoleName : "主卡",
	 *				memberRoleCd : "0",
	 *				roleObjs : [{
	 *					offerRoleId : 1,
	 *					objId : ,
	 *					objName : "CDMA",
	 *					objType : 2
	 *				}]
	 *			},
	 *			{
	 *				offerRoleId : 2345,
	 *				offerRoleName : "副卡",
	 *				memberRoleCd : "1"
	 *			}
	 *		]
	 *	}
	 * 
	 */
	var _buildMainView = function(param) {
		//组装数据
		if (param == undefined || !param) {
			param = _getTestParam();
		}
		if(order.memberChange.newMemberFlag && OrderInfo.actionFlag == 6){//主副卡成员变更 付费类型判断 如果一致才可以进行加装
			var is_same_feeType=false;//
			if(param.feeTypeMain=="2100" && (OrderInfo.offerSpec.feeType=="2100"||OrderInfo.offerSpec.feeType=="3100"||OrderInfo.offerSpec.feeType=="3101"||OrderInfo.offerSpec.feeType=="3103")){
				is_same_feeType=true;
			}else if(param.feeTypeMain=="1200" && (OrderInfo.offerSpec.feeType=="1200"||OrderInfo.offerSpec.feeType=="3100"||OrderInfo.offerSpec.feeType=="3102"||OrderInfo.offerSpec.feeType=="3103")){
				is_same_feeType=true;
			}else if(param.feeTypeMain=="1201" && (OrderInfo.offerSpec.feeType=="1201"||OrderInfo.offerSpec.feeType=="3101"||OrderInfo.offerSpec.feeType=="3102"||OrderInfo.offerSpec.feeType=="3103")){
				is_same_feeType=true;
			}
			if(!is_same_feeType){
				$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");
				return;
			}
		}
		$.callServiceAsHtml(contextPath+"/token/pc/order/main",param,{
			"before":function(){
				$.ecOverlay("<strong>正在加载中,请稍等...</strong>");
			},"done" : function(response){
				if(!response){
					 response.data='查询失败,稍后重试';
				}
				if(response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				OrderInfo.actionFlag = param.actionFlag;
				if(OrderInfo.actionFlag == 2){
					offerChange.fillOfferChange(response,param);
				}else if(OrderInfo.actionFlag == 21){//副卡换套餐
					order.memberChange.fillmemberChange(response,param);
				}else {
					_callBackBuildView(response,param);
				}
				if(CONST.getAppDesc()==1 && (OrderInfo.actionFlag==1 ||OrderInfo.actionFlag==14)){
					$("#li_is_activation").show();
				}
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	//展示回调函数
	var _callBackBuildView = function(response, param) {
		order.prepare.showOrderTitle(OrderInfo.actionTypeName, param.offerSpecName, false);
		SoOrder.initFillPage(); //并且初始化订单数据
		$("#deal_package").css("display","none");
		$("#order_prod_list").css("display","none");
		$("#order_fill_content").html(response.data);	
		_initOrderLabel();//初始化订单标签
		_initOfferLabel();//初始化主副卡标签
		_initFeeType(param);//初始化付费方式
		_initOrderProvAttr();//初始化省内订单属性
		if(CONST.getAppDesc()==0){
			$("#orderAttrDiv").show();
			_initOrderAttr();//初始化4G经办人	
		}

		if(param.actionFlag==''){
			OrderInfo.actionFlag = 1;
		}
		
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==13 || OrderInfo.actionFlag==14){
			order.main.initAcct(0);//初始化主卡帐户列表 
			order.dealer.initDealer();//初始化协销	
		}
		if(OrderInfo.actionFlag==6){//主副卡纳入老用户
			if(order.memberChange.newMemberFlag){
				_loadOther(param);
			}
			if(order.memberChange.oldMemberFlag){
				_initAcct(1);//初始化副卡帐户列表
				_loadAttachOffer(param);
			}
			if(order.memberChange.changeMemberFlag){
				order.memberChange.fillmemberChange(response,param);
			}
		}else{
			if(order.service.oldMemberFlag){
				order.main.initAcct(1);//初始化副卡帐户列表
			}
			_loadOther(param);//页面加载完再加载其他元素
		}
		if(OrderInfo.actionFlag==1){
			$("#templateOrderDiv").show();
		}
		_addEvent();//添加页面事件
		order.phoneNumber.initOffer('-1');//主卡自动填充号码入口已选过的号码
		if(OrderInfo.actionFlag==1&&OrderInfo.newOrderInfo.isLastFlag=="true"){
			$("#fillLastStep").show();
		}
		$("#fillNextStep").off("click").on("click",function(){
			SoOrder.submitOrder();
		});	
		if (param.memberChange) {
			$("#orderedprod").hide();
			$("#order_prepare").hide();
			$("#productDiv .pdcardcon:first").show();
			order.prepare.step(1);
			$("#fillLastStep").off("click").on("click",function(){
				order.prodModify.cancel();
			});
		}else{
			$("#fillLastStep").off("click").on("click",function(){
				_lastStep();
			});
		}
		_initUimCode();//初始化uim卡号
		
		//判断是否初始化帐户信息
		if(OrderInfo.acct&&OrderInfo.acct.acctCd!=null&&OrderInfo.acct.acctCd!=""){//新装传帐户id
			_createAcctWithId();
		}
		
		//新装省份传主副卡信息
		if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""){
			//主卡选号需要的参数 
			var param = {"phoneNum":"",
						"prodId":""};
			//查询号码信息
			param.phoneNum = OrderInfo.newOrderNumInfo.mainPhoneNum;
			param.prodId = "-1";
			var result = order.phoneNumber.queryPhoneNumber(param);
			if(result==undefined||result.datamap==undefined||result.datamap.baseInfo==undefined){
				$("#nbr_btn_-1").html("<u></u>");
				$("#nbr_btn_-1").removeAttr("onclick");
			}else{
				if(result&&result.datamap.baseInfo!=undefined){					
					var phoneParam={
							prodId : param.prodId, //从填单页面头部div获取
							accessNumber : result.datamap.baseInfo.phoneNumber, //接入号
							anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
							anId : result.datamap.baseInfo.phoneNumId, //接入号ID
							pnLevelId:result.datamap.baseInfo.phoneLevelId,
							anTypeCd : result.datamap.baseInfo.pnTypeId, //号码类型
							state : "ADD", //动作	,新装默认ADD
							areaId:result.datamap.baseInfo.areaId,
							areaCode:result.datamap.baseInfo.zoneNumber,
							memberRoleCd:"",
							preStore:result.datamap.baseInfo.prePrice,
							minCharge:result.datamap.baseInfo.pnPrice,
							idFlag:"1"
						};
					if(param.prodId&&param.prodId=="-1"){
						phoneParam.memberRoleCd = CONST.MEMBER_ROLE_CD.MAIN_CARD;
					}
					$("#nbr_btn_-1").html(OrderInfo.newOrderNumInfo.mainPhoneNum+"<u></u>");
					$("#nbr_btn_-1").removeAttr("onclick");
					OrderInfo.boProdAns.push(phoneParam);
				}
			}
		}
		
		if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""){
			var param = {"phoneNum":"","prodId":""};
			var numBtns = $("a[id^='nbr_btn_']");
			var nums = OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");
			var subNums = [];
			$.each(numBtns,function(){
				if($(this).attr("id")!="nbr_btn_-1"){
					subNums.push(this);
				};
			});
			$.each(subNums,function(index,subNum){
				//副卡选号需要的参数  
				param.phoneNum = nums[index];
				param.prodId = -2-index;
				var resData = order.phoneNumber.queryPhoneNumber(param);
				if(resData==undefined||resData.datamap==undefined||resData.datamap.baseInfo==undefined){
					$(subNum).html("<u></u>");
					$(subNum).removeAttr("onclick");
				}else{
					if(resData&&resData.datamap.baseInfo!=undefined){
						var phoneParam={
								prodId : param.prodId, //从填单页面头部div获取
								accessNumber : resData.datamap.baseInfo.phoneNumber, //接入号
								anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
								anId : resData.datamap.baseInfo.phoneNumId, //接入号ID
								pnLevelId:resData.datamap.baseInfo.phoneLevelId,
								anTypeCd : resData.datamap.baseInfo.pnTypeId, //号码类型
								state : "ADD", //动作	,新装默认ADD
								areaId:resData.datamap.baseInfo.areaId,
								areaCode:resData.datamap.baseInfo.zoneNumber,
								memberRoleCd:"",
								preStore:resData.datamap.baseInfo.prePrice,
								minCharge:resData.datamap.baseInfo.pnPrice,
								idFlag:"1"
						};
						
						if(param.prodId&&param.prodId!="-1"){
							phoneParam.memberRoleCd = CONST.MEMBER_ROLE_CD.VICE_CARD;
						}		
						$(subNum).html(nums[index]+"<u></u>");
						$(subNum).removeAttr("onclick");
						OrderInfo.boProdAns.push(phoneParam);
					}
				}

			});
		}
		
		//新装暂存单二次加载
		if(OrderInfo.newOrderInfo.isReloadFlag=="N"){
			var result=OrderInfo.newOrderInfo.result;
			var prodOfferId=OrderInfo.newOrderInfo.prodOfferId;
			var prodOfferName=OrderInfo.newOrderInfo.prodOfferName;
			order.service.callBackBuildOrder(result,prodOfferId,prodOfferName);
		}
		
		//主副卡纳入新用户选号
		var nbrlist = [];
		var nbrflag = true;
		if(order.memberChange.newSubPhoneNum!="" && order.memberChange.reloadFlag=="Y"){
			var newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
			for(var n=0;n<newSubPhoneNumsize.length;n++){
				if(newSubPhoneNumsize[n]!=""&&newSubPhoneNumsize[n]!=null&&newSubPhoneNumsize[n]!="null"){
					$.each(nbrlist,function(){
						if(this==newSubPhoneNumsize[n]){
							nbrflag = false;
							return false;
						}else{
							nbrflag = true;
						}
					});
					if(nbrflag){
						nbrlist.push(newSubPhoneNumsize[n]);
						$("#nbr_btn_-"+(n+1)).removeAttr("onclick");
						$("#nbr_btn_-"+(n+1)).removeClass("selectBoxTwo");
						$("#nbr_btn_-"+(n+1)).addClass("selectBoxTwoOn");
						var param = {"phoneNum":newSubPhoneNumsize[n]};
						var data = order.phoneNumber.queryPhoneNumber(param);
						if(data.datamap.baseInfo){
							$("#nbr_btn_-"+(n+1)).html(newSubPhoneNumsize[n]+"<u></u>");
							var boProdAns={
									prodId : "-"+(n+1), //从填单页面头部div获取
									accessNumber : data.datamap.baseInfo.phoneNumber, //接入号
									anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
									anId : data.datamap.baseInfo.phoneNumId, //接入号ID
									pnLevelId : data.datamap.baseInfo.phoneLevelId,
									anTypeCd : data.datamap.baseInfo.pnTypeId, //号码类型
									state : "ADD", //动作	,新装默认ADD	
									areaId : data.datamap.baseInfo.areaId,
									areaCode:data.datamap.baseInfo.zoneNumber,
									memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,
									preStore:data.datamap.baseInfo.prePrice,
									minCharge:data.datamap.baseInfo.pnPrice
								};
							OrderInfo.boProdAns.push(boProdAns);
							order.dealer.changeAccNbr("-"+(n+1),newSubPhoneNumsize[n]);//选号玩要刷新发展人管理里面的号码
						}
					}else{
						$.alert("提示","号码"+newSubPhoneNumsize[n]+"重复输入");
					}
				}
			}
		}
		//主副卡纳入新用户UIM卡
		if(order.memberChange.mktResInstCode!="" && order.memberChange.reloadFlag=="Y"){
			nbrlist = [];
			nbrflag = true;
			var offerId = "-1";
			offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
			$.each(OrderInfo.oldprodInstInfos,function(){
				if(this.prodInstId==prodId){
					offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
				}
			});
			var mktResInstCodesize = order.memberChange.mktResInstCode.split(",");
			for(var u=0;u<mktResInstCodesize.length;u++){
				if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null" && order.memberChange.newSubPhoneNum!=""){
					var nbrAndUimCode = mktResInstCodesize[u].split("_");
					var _accNbr = nbrAndUimCode[0];
					var _uimCode = nbrAndUimCode[1];
					var newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
					var uimflag = false;
					$.each(nbrlist,function(){
						if(this==_accNbr){
							nbrflag = false;
							return false;
						}else{
							nbrflag = true;
						}
					});
					if(!nbrflag){
						$.alert("提示","UIM卡"+_uimCode+"对应的号码重复");
						return;
					}
					for(var n=0;n<newSubPhoneNumsize.length;n++){
						if(newSubPhoneNumsize[n]==_accNbr){
							nbrlist.push(newSubPhoneNumsize[n]);
							uimflag = true;
							$("#uim_txt_-"+(n+1)).attr("disabled",true);
							var uimParam = {
									"instCode":_uimCode
							};
							var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
							if (response.code==0) {
								if(response.data.mktResBaseInfo){
									if(response.data.mktResBaseInfo.statusCd=="1102"){
										$("#uim_check_btn_-"+(n+1)).attr("disabled",true);
										$("#uim_check_btn_-"+(n+1)).removeClass("purchase").addClass("disablepurchase");
										$("#uim_release_btn_-"+(n+1)).attr("disabled",false);
										$("#uim_release_btn_-"+(n+1)).removeClass("disablepurchase").addClass("purchase");
										$("#uim_txt_-"+(n+1)).val(_uimCode);
										var coupon = {
												couponUsageTypeCd : "3", //物品使用类型
												inOutTypeId : "1",  //出入库类型
												inOutReasonId : 0, //出入库原因
												saleId : 1, //销售类型
												couponId : response.data.mktResBaseInfo.mktResId, //物品ID
												couponinfoStatusCd : "A", //物品处理状态
												chargeItemCd : "3000", //物品费用项类型
												couponNum : response.data.mktResBaseInfo.qty, //物品数量
												storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
												storeName : "1", //仓库名称
												agentId : 1, //供应商ID
												apCharge : 0, //物品价格
												couponInstanceNumber : _uimCode, //物品实例编码
												terminalCode :_uimCode,//前台内部使用的UIM卡号
												ruleId : "", //物品规则ID
												partyId : OrderInfo.cust.custId, //客户ID
												prodId :  -(n+1), //产品ID
												offerId : offerId, //销售品实例ID
												state : "ADD", //动作
												relaSeq : "" //关联序列	
											};
										OrderInfo.clearProdUim(-(n+1));
										OrderInfo.boProd2Tds.push(coupon);
									}else{
										$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
									}
								}else{
									$.alert("提示","查询不到UIM信息");
								}
							}else if (response.code==-2){
								$.alertM(response.data);
							}else {
								$.alert("提示","UIM信息查询接口出错,稍后重试");
							}
							break;
						}
					}
					if(!uimflag){
						$.alert("提示","UIM卡"+_uimCode+"未匹配到接入号");
					}
				}
			}
		}
		//发展人
		if(OrderInfo.provinceInfo.salesCode!=""&&(OrderInfo.newOrderInfo.isReloadFlag!="N" || order.memberChange.reloadFlag=="Y")){
			order.main.queryDealer();
		}
		//主副卡暂存单二次加载
		if(order.memberChange.reloadFlag=="N"){
			$("#dealerTbody").empty();
			var custOrderList = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
			$.each(custOrderList,function(){
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="3"){//拆副卡
					
				}else if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员
					//选号
					$("#nbr_btn_"+this.data.boProdAns[0].prodId).removeClass("selectBoxTwo");
					$("#nbr_btn_"+this.data.boProdAns[0].prodId).addClass("selectBoxTwoOn");
					$("#nbr_btn_"+this.data.boProdAns[0].prodId).html(this.busiObj.accessNumber+"<u></u>");
					var boProdAns={
							prodId : this.data.boProdAns[0].prodId, //从填单页面头部div获取
							accessNumber : this.data.boProdAns[0].accessNumber, //接入号
							anChooseTypeCd : this.data.boProdAns[0].anChooseTypeCd, //接入号选择方式,自动生成或手工配号，默认传2
							anId : this.data.boProdAns[0].anId, //接入号ID
							pnLevelId:this.data.boProdAns[0].pnLevelId,
							anTypeCd : this.data.boProdAns[0].anTypeCd, //号码类型
							state : this.data.boProdAns[0].state, //动作	,新装默认ADD	
							areaId:this.data.boProdAns[0].areaId,
							areaCode:this.data.boProdAns[0].areaCode,
							memberRoleCd:this.data.boProdAns[0].memberRoleCd,
							preStore:this.data.boProdAns[0].preStore,
							minCharge:this.data.boProdAns[0].minCharge
						};
					OrderInfo.boProdAns.push(boProdAns);
					order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);//选号玩要刷新发展人管理里面的号码
					//uim卡校验
					$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);
					$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).removeClass("purchase").addClass("disablepurchase");
					$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);
					$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).removeClass("disablepurchase").addClass("purchase");
					$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);
					$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);
					var coupon = {
							couponUsageTypeCd : this.data.bo2Coupons[0].couponUsageTypeCd, //物品使用类型
							inOutTypeId : this.data.bo2Coupons[0].inOutTypeId,  //出入库类型
							inOutReasonId : this.data.bo2Coupons[0].inOutReasonId, //出入库原因
							saleId : this.data.bo2Coupons[0].saleId, //销售类型
							couponId : this.data.bo2Coupons[0].couponId, //物品ID
							couponinfoStatusCd : this.data.bo2Coupons[0].couponinfoStatusCd, //物品处理状态
							chargeItemCd : this.data.bo2Coupons[0].chargeItemCd, //物品费用项类型
							couponNum : this.data.bo2Coupons[0].couponNum, //物品数量
							storeId : this.data.bo2Coupons[0].storeId, //仓库ID
							storeName : this.data.bo2Coupons[0].storeName, //仓库名称
							agentId : this.data.bo2Coupons[0].agentId, //供应商ID
							apCharge : this.data.bo2Coupons[0].apCharge, //物品价格
							couponInstanceNumber : this.data.bo2Coupons[0].couponInstanceNumber, //物品实例编码
							terminalCode : this.data.bo2Coupons[0].terminalCode,//前台内部使用的UIM卡号
							ruleId : this.data.bo2Coupons[0].ruleId, //物品规则ID
							partyId : this.data.bo2Coupons[0].partyId, //客户ID
							prodId :  this.data.bo2Coupons[0].prodId, //产品ID
							offerId : this.data.bo2Coupons[0].offerId, //销售品实例ID
							state : this.data.bo2Coupons[0].state, //动作
							relaSeq : this.data.bo2Coupons[0].relaSeq //关联序列	
						};
					OrderInfo.clearProdUim(this.busiObj.instId);
					OrderInfo.boProd2Tds.push(coupon);
					//产品密码
					$("#pwd_"+this.busiObj.instId).val(this.data.boProdPasswords[0].pwd);
					//封装付费方式
					$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected");
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S2"){//纳入老成员
					
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="1"){//保留选择新套擦
					
				}
				//发展人
				if(this.data.busiOrderAttrs!=undefined){
					var dealerlist = [];
					var dealerMap1 = {};
					var dealerMap2 = {};
					var dealerMap3 = {};
					$.each(this.data.busiOrderAttrs,function(){
						if(this.role=="40020005"){
							dealerMap1.role = this.role;
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
								dealerMap1.staffid = this.value;
								dealerMap1.channelNbr = this.channelNbr;
							}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
								dealerMap1.staffname = this.value;
							}
						}else if(this.role=="40020006"){
							dealerMap2.role = this.role;
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
								dealerMap2.staffid = this.value;
								dealerMap2.channelNbr = this.channelNbr;
							}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
								dealerMap2.staffname = this.value;
							}
						}else if(this.role=="40020007"){
							dealerMap3.role = this.role;
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
								dealerMap3.staffid = this.value;
								dealerMap3.channelNbr = this.channelNbr;
							}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
								dealerMap3.staffname = this.value;
							}
						}
						
					});
					if(ec.util.isObj(dealerMap1.role)){
						dealerlist.push(dealerMap1);
					}
					if(ec.util.isObj(dealerMap2.role)){
						dealerlist.push(dealerMap2);
					}
					if(ec.util.isObj(dealerMap3.role)){
						dealerlist.push(dealerMap3);
					}
					var objInstId = "";
					var deldealerflag = "";
					if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){
						objInstId = this.busiObj.instId;
					}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"){
						objInstId = this.data.ooRoles[0].prodId+"_"+this.busiObj.objId;
						deldealerflag = "DEL";
					}
					var dealeraccNbr = this.busiObj.accessNumber;
					for(var d=0;d<dealerlist.length;d++){
						var $tr;
						if(d==0){
							$tr = $("<tr id='tr_"+objInstId+"' name='tr_"+objInstId+"'></tr>");
						}else{
							$tr = $('<tr name="tr_'+objInstId+'"></tr>');
						}
						var $tdType = $('<td></td>');
						var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
						var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
						$.each(OrderInfo.order.dealerTypeList,function(){
							if(dealerlist[d].role==this.PARTYPRODUCTRELAROLECD){
								$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected>"+this.NAME+"</option>");
							}else{
								$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
							}
						});
						$tdType.append($select);
						$tdType.append('<label class="f_red">*</label>');
						$tr.append("<td>"+dealeraccNbr+"</td>");
						if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){
							$tr.append("<td>移动电话（仅含本地语音）</td>");
						}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"){
							$tr.append("<td>"+this.busiObj.objName+"</td>");
						}
						$tr.append($tdType);
						var $td;
						if(deldealerflag=="DEL"){
							if(d==0){
								$td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>');
							}else{
								$td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>');
							}
						}else{
							$td = $('<td><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" class="inputWidth183px" readonly="readonly" ></input></td>');
						}
						$td.append('<a class="purchase" href="javascript:order.main.queryStaff(0,\'dealer\',\''+objId+'\');">选择</a>');
						if(d==0){
							if(deldealerflag=="DEL"){
								$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');
							}
							$td.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</a><label class="f_red">*</label>');
						}else{
							$td.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');
						}
						$tr.append($td);
						if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){
							OrderInfo.getChannelList();
						}
						var $tdChannel = $('<td></td>');
						var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
						$.each(OrderInfo.channelList,function(){
							if(dealerlist[d].channelNbr==this.channelNbr)
								$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
							else
								$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
						});
						$tdChannel.append($channelSelect);
						$tdChannel.append('<label class="f_red">*</label>');	
						$tr.append($tdChannel);
						OrderInfo.SEQ.dealerSeq++;
						$("#dealerTbody").append($tr);
					}
				}
				//帐户信息
				if(this.data.boAccountRelas!=undefined){
					var acctId = this.data.boAccountRelas[0].acctId;
					$("#acctSelect").find("option[value="+acctId+"]").attr("selected","selected");
				}
			});
			var custOrderAttrs = order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;
			$.each(custOrderAttrs,function(){
				//订单备注
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){
					$('#order_remark').val(this.value);
				}
				//经办人
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrName){
					$('#orderAttrName').val(this.value);
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrPhoneNbr){
					$('#orderAttrPhoneNbr').val(this.value);
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderIdentidiesTypeCd){
					$("#orderIdentidiesTypeCd").find("option[value="+this.value+"]").attr("selected","selected");
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrIdCard){
					$('#orderAttrIdCard').val(this.value);
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrAddr){
					$('#orderAttrAddr').val(this.value);
				}
				//省内订单属性
//				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.PROV_ISALE){
//					$('#orderProvAttrIsale').val(this.value);
//				}
			});
			order.main.reload();
		}
	};
	
	//开通功能产品
	function openServSpec(prodId,servSpecId,specName,ifParams){
		var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
		if(servSpec==undefined){   //在可订购功能产品里面 
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : specName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			if(servSpecId==CONST.YZFservSpecId){//翼支付助手根据付费类型改变默认值
				var feeType = $("select[name='pay_type_-1']").val();
				if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
				if(feeType == CONST.PAY_TYPE.AFTER_PAY){
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {
						var prodSpecParam = newSpec.prodSpecParams[j];
						prodSpecParam.setValue = "";
					}																			
				}else{
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {							
						var prodSpecParam = newSpec.prodSpecParams[j];
						if (prodSpecParam.value!="") {
							prodSpecParam.setValue = prodSpecParam.value;
						} else if (!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!="")
							//默认值为空则取第一个
							prodSpecParam.setValue = prodSpecParam.valueRange[0].value;
				}
			  }
			}
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			servSpec = newSpec;
		}
		var servSpecId = servSpec.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		AttachOffer.addOpenServList(prodId,servSpecId,servSpec.servSpecName,servSpec.ifParams);
//		AttachOffer.checkServExcludeDepend(prodId,servSpec);
	};
	
	//订购附属销售品
	function addOfferSpec(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		$.confirm("信息确认",content,{ 
			yes:function(){
				CacheData.setServ2OfferSpec(prodId,newSpec);
			},
			yesdo:function(){
				_checkOfferExcludeDepend(prodId,newSpec);
			},
			no:function(){
			}
		});
	};
	
	var _loadAttachOffer = function(param) {
		for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
			var prodInfo = OrderInfo.oldprodInstInfos[i]; //获取老用户产品信息
//			var uimDivShow=false;//是否已经展示了
			//var prodId = prodInfo.prodInstId;
			$.each(OrderInfo.oldoffer,function(){
				if(this.accNbr == prodInfo.accNbr){
					var oldoffer = this;
					$.each(oldoffer.offerMemberInfos,function(){
						var member = this;
						if(member.objType==CONST.OBJ_TYPE.PROD){
							var prodId = this.objInstId;
							var param = {
									areaId : OrderInfo.getProdAreaId(prodId),
									channelId : OrderInfo.staff.channelId,
									staffId : OrderInfo.staff.staffId,
								    prodId : prodId,
								    prodSpecId : member.objId,
								    offerSpecId : prodInfo.mainProdOfferInstInfos[0].prodOfferId,
								    offerRoleId : "",
								    acctNbr : member.accessNumber,
								    partyId:prodInfo.custId,
								    distributorId:OrderInfo.staff.distributorId,
								    mainOfferSpecId:prodInfo.mainProdOfferInstInfos[0].prodOfferId,
								    soNbr:OrderInfo.order.soNbr
								};
							if(ec.util.isObj(prodInfo.prodBigClass)){
								param.prodBigClass = prodInfo.prodBigClass;
							}
							$.each(OrderInfo.oldofferSpec,function(){
								if(this.accNbr==prodInfo.accNbr){
									$.each(this.offerSpec.offerRoles,function(){
										if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD || this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){
											param.offerRoleId = this.offerRoleId;
										}
									});
								}
							});
							var res = query.offer.queryChangeAttachOffer(param);
							$("#attach_"+prodId).html(res);	
							//如果objId，objType，objType不为空才可以查询默认必须
							if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){
								param.queryType = "1,2";
								param.objId = member.objId;
								param.objType = member.objType;
								param.memberRoleCd = "401";
								//默认必须可选包
								var data = query.offer.queryDefMustOfferSpec(param);
								CacheData.parseOffer(data);
								//默认必须功能产品
								var data = query.offer.queryServSpec(param);
								CacheData.parseServ(data);
							}
							if(ec.util.isArray(OrderInfo.oldofferSpec)){ //主套餐下的成员判断
	//								var member = CacheData.getOfferMember(prodId);
								$.each(OrderInfo.oldofferSpec,function(){
									if(this.accNbr == prodInfo.accNbr){
										var offerRoles = this.offerSpec.offerRoles;
										$.each(offerRoles,function(){
											if(this.offerRoleId==member.offerRoleId && member.objType==CONST.OBJ_TYPE.PROD){
												var offerRole = this;
												$.each(this.roleObjs,function(){
													if(this.objType==CONST.OBJ_TYPE.SERV){
														var serv = CacheData.getServBySpecId(prodId,this.objId);//从已订购功能产品中找
														if(serv!=undefined){ //不在已经开跟已经选里面
															var $oldLi = $('#li_'+prodId+'_'+serv.servId);
															if(this.minQty==1){
																$oldLi.append('<dd class="mustchoose"></dd>');
															}
															$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
														}
													}
												});
												return false;
											}
										});
									}
								});
							}
							AttachOffer.changeLabel(prodId,prodInfo.productId,"");
						}
					});
				}
			});
			
//				if(_isChangeUim(prodId)){ //需要补换卡
//					if(!uimDivShow){
//						$("#uimDiv_"+prodId).show();
//					}else{
//						$("#uimDiv_"+prodId).hide();
//					}
//				}
//				uimDivShow=true;
			
			var oldoffer = {};
			if(ec.util.isArray(OrderInfo.oldoffer)){ //主套餐下的成员判断
//				var member = CacheData.getOfferMember(prodId);
			    $.each(OrderInfo.oldoffer,function(){
			    	if(this.accNbr == prodInfo.accNbr){
			    		oldoffer = this;
			    	}
			    });
			}
			//老用户加入副卡需要预校验,主卡是4G，加入的老用户为3G
			if(order.prodModify.choosedProdInfo.is3G== "N" && prodInfo.mainProdOfferInstInfos[0].is3G =="Y"){
				if(!order.memberChange.checkOrder(prodInfo,oldoffer)){ //省内校验单
					return;
				}
				order.memberChange.checkOfferProd(oldoffer);
			}
			
		}
//		order.main.reload();
					
//				});
//			}
//		});
	};
	
	//判断是否需要补卡
	var _isChangeUim = function(objId){
		if(CONST.getAppDesc()==0){
			var prodClass = OrderInfo.oldprodInstInfos.prodClass;
			var prodId = OrderInfo.oldprodInstInfos.prodInstId;
			if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡，已经显示补卡,判断是否隐藏补卡
				var servSpec = CacheData.getServSpec(prodId,CONST.PROD_SPEC.PROD_FUN_4G);
				if(servSpec!=undefined && servSpec.isdel != "Y" && servSpec.isdel != "C"){ //有开通4G功能产品
					return true;
				}
			}
		}
		return false;
	};
	
	//根据产品id获取销售品成员
	var _getOfferMember = function(prodId){
		for(var j=0;j<OrderInfo.oldoffer.length;j++){
			for ( var i = 0; i < OrderInfo.oldoffer[j].offerMemberInfos.length; i++) {
				var offerMember = OrderInfo.oldoffer[j].offerMemberInfos[i];
				if(offerMember.objInstId==prodId){
					return offerMember;
				}
			}
		}
		return {};
	};
	
	//动态添加产品属性、附属销售品等
	var _loadOther = function(param) {
		$.each(OrderInfo.offerSpec.offerRoles,function(){ //遍历主套餐规格
			var offerRole = this;
			for ( var i = 0; i < this.prodInsts.length; i++) {
				var prodInst = this.prodInsts[i];
				var param = {   
					offerSpecId : OrderInfo.offerSpec.offerSpecId,
					prodSpecId : prodInst.objId,
					offerRoleId: prodInst.offerRoleId,
					prodId : prodInst.prodInstId,
					queryType : "1,2",
					objType: prodInst.objType,
					objId: prodInst.objId,
					memberRoleCd : prodInst.memberRoleCd
				};
				AttachOffer.queryAttachOfferSpec(param);  //加载附属销售品
				var obj = {
					ul_id : "item_order_"+prodInst.prodInstId,
					prodId : prodInst.prodInstId,
					offerSpecId : OrderInfo.offerSpec.offerSpecId,
					compProdSpecId : "",
					prodSpecId : prodInst.objId,
					roleCd : offerRole.roleCd,
					offerRoleId : offerRole.offerRoleId,
					partyId : OrderInfo.cust.custId
				};
				order.main.spec_parm(obj); //加载产品属性
			}			
		});
		
		if(order.service.oldMemberFlag){
			order.main.loadAttachOffer();
		}
	};
	
	var _paymethodChange = function(obj){
		$(".paymethodChange").each(function(){
			if($(this).attr("id")!=$(obj).attr("id")){
				$(this).val($(obj).val());
			}
		});
	};
	
	var _templateTypeCheck = function(obj){
		if($("#isTemplateOrder").attr("checked")=="checked"){//如果选择批量模板
			/*var paytype=$('select[name="pay_type_-1"]').val(); 
			if(obj&&$(obj).val()){//如果是 批量模板 选择 批开模板，直接提示
				if($(obj).val()=="0"&&paytype!="2100"){//如果不是预付费
					$.alert("提示","您选择批开活卡模板，付费方式需改成'预付费'！");
					$("html").scrollTop(0);
					return false ;
				}
			}else{//如果是 订单提交时 判断
				var templeVal = $("#templateOrderDiv select").val();
				if(templeVal){
					if(templeVal=="0"&&paytype!="2100"){//如果不是预付费
						$.alert("提示","您选择批开活卡模板，付费方式需改成预付费！");
						$("html").scrollTop(0);
						return false ;
					}
				}
			}*/
			/*
			var paymethod = null ;
			var paymethodid = null ;
			$(".paymethodChange").each(function(){//获取第一个付费方式
				if(paymethod==null){
					paymethod = $(this).val();
					paymethodid = $(this).attr("id");
				}
			});
			if(obj&&$(obj).val()){//如果是 批量模板 选择 批开模板，直接提示
				if($(obj).val()=="0"&&paymethod!="2100"){//如果不是预付费
					$.alert("提示","您选择批开活卡模板，付费方式需改成'预付费'！");
					$("html").scrollTop(0);
					return false ;
				}
			}else{//如果是 订单提交时 判断
				var templeVal = $("#templateOrderDiv select").val();
				if(templeVal){
					if(templeVal=="0"&&paymethod!="2100"){//如果不是预付费
						$.alert("提示","您选择批开活卡模板，付费方式需改成预付费！");
						$("html").scrollTop(0);
						return false ;
					}
				}
			}
			*/
		}
		return true ;
	};
	
	var _initFeeType = function(param) {
		if (param.feeType != undefined && param.feeType && param.feeType != CONST.PAY_TYPE.NOLIMIT_PAY) {
			$("input[name^=pay_type_][value="+param.feeType+"]").attr("checked","checked");
			$("input[name^=pay_type_]").attr("disabled","disabled");
		}
	};
	
	//初始化帐户展示
	var _initAcct = function(flag) {
		if((OrderInfo.actionFlag==1 || OrderInfo.actionFlag==13 || OrderInfo.actionFlag==14) && flag==0){
			//新装默认新建帐户
			_createAcct();
			return;
		}
			//主副卡成员变更业务不能更改帐户，只展示主卡帐户
			if(OrderInfo.actionFlag==6 || OrderInfo.actionFlag==2){
				var param = {};
				if(flag==1){
					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
						param.prodId=OrderInfo.oldprodInstInfos[i].prodInstId;
						param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr;
						param.areaId=OrderInfo.oldprodInstInfos[i].areaId;
						var jr = $.callServiceAsJson(contextPath+"/order/queryProdAcctInfo", param);
						if(jr.code==-2){
							$.alertM(jr.data);
							return;
						}
						var prodAcctInfos = jr.data;
						prodAcctInfos[0].accessNumber = OrderInfo.oldprodInstInfos.accNbr;
						OrderInfo.oldprodAcctInfos.push({"prodAcctInfos":prodAcctInfos});
					}
				}else{
					param.prodId=order.prodModify.choosedProdInfo.prodInstId;
					param.acctNbr=order.prodModify.choosedProdInfo.accNbr;
					param.areaId=order.prodModify.choosedProdInfo.areaId;
					var jr = $.callServiceAsJson(contextPath+"/order/queryProdAcctInfo", param);
					if(jr.code==-2){
						$.alertM(jr.data);
						return;
					}
					var prodAcctInfos = jr.data;
					$("#accountDiv").find("label:eq(0)").text("主卡帐户：");
					$.each(prodAcctInfos, function(i, prodAcctInfo){
						$("<option>").text(prodAcctInfo.name+" : "+prodAcctInfo.acctCd).attr("value",prodAcctInfo.acctId)
						.attr("acctcd",prodAcctInfo.acctCd).appendTo($("#acctSelect"));					
					});
					$("#accountDiv").find("a:eq(0)").hide();
				}
			}else{
				//新装默认新建帐户
				_createAcct();
			}
	};
	
	//初始化订单标签
	var _initOrderLabel = function() {
		//订单标签
		$(".ordertabcon:first").show();
		$(".ordertab li:first").addClass("setorder");
		$(".ordertab li").each(function(index){
			$(this).click(function(){
				var orderSeq = $(this).attr("order");
				if (orderSeq > 1) {
					$(".order_copy").show();
				} else {
					$(".order_copy").hide();
				}
				$(this).addClass("setorder").siblings().removeClass("setorder");
				$(this).parents(".ordernav").parent().siblings(".ordercon").find(".ordertabcon").eq(index).show().siblings().hide();
			});
		});
	};
	
	//初始化uim卡号
	var _initUimCode = function() {
		var codeMsg=OrderInfo.provinceInfo.codeMsg;
		if(codeMsg!=null && codeMsg!=""){
			$.alert("提示",codeMsg);
		}else{
			var mktResInstCode=OrderInfo.newOrderNumInfo.mktResInstCode
			
			if(OrderInfo.newOrderNumInfo.mktResInstCode && mktResInstCode!=null && mktResInstCode!=""){
				var mktResInstCode = OrderInfo.newOrderNumInfo.mktResInstCode.split(",");
				for (var i = 0; i <= mktResInstCode.length; i ++) {
					//numAndUim-->号码_UIM
					var numAndUim=mktResInstCode[i];
					
					if(numAndUim!=null && numAndUim!=""){
						var codes=numAndUim.split("_");
						if(codes!=null && codes.length==2){
							var num=codes[0];
							var uim=codes[1];
							
							var uimParam={"instCode":uim};
							var response=$.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
							if(response.code==0){//成功
								if(response.data && response.data.mktResBaseInfo){
									if(response.data.mktResBaseInfo.statusCd=="1102"){
										//填值&修改样式和可点击按钮
										$("#uim_check_btn_"+num).attr("disabled",true);
										$("#uim_check_btn_"+num).removeClass("purchase").addClass("disablepurchase");
										$("#uim_release_btn_"+num).attr("disabled",false);
										$("#uim_release_btn_"+num).removeClass("disablepurchase").addClass("purchase");
										$("#uim_txt_" + num).val(uim);
										
										var coupon = {
											couponUsageTypeCd : "3", //物品使用类型
											inOutTypeId : "1",  //出入库类型
											inOutReasonId : 0, //出入库原因
											saleId : 1, //销售类型
											couponId : response.data.mktResBaseInfo.mktResId, //物品ID
											couponinfoStatusCd : "A", //物品处理状态
											chargeItemCd : "3000", //物品费用项类型
											couponNum : response.data.mktResBaseInfo.qty, //物品数量
											storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
											storeName : "1", //仓库名称
											agentId : 1, //供应商ID
											apCharge : 0, //物品价格
											couponInstanceNumber : response.data.mktResBaseInfo.instCode, //物品实例编码
											terminalCode : response.data.mktResBaseInfo.instCode,//前台内部使用的UIM卡号
											ruleId : "", //物品规则ID
											partyId : OrderInfo.cust.custId, //客户ID
											prodId :  num, //产品ID
											offerId : "-1", //销售品实例ID
											state : "ADD", //动作
											relaSeq : "" //关联序列	
										};
										
										OrderInfo.clearProdUim(num);
										OrderInfo.boProd2Tds.push(coupon);
									}else{
										//处理umi卡不是预占状态
										$.alert("提示","UIM卡["+uim+"]不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
									}
								}else {
									//处理不存在情况
									$.alert("提示","没有查询到相应的UIM卡["+uim+"]信息");
								}
							}else if (response.code==-2){
								$.alert(response.data);
							}else {
								$.alert("提示","UIM信息查询接口出错,稍后重试");
							}
						}
					}
				}
			}
		}
	};
	
	//初始化主副卡标签
	var _initOfferLabel = function() {
		//主副卡标签
		$.each($(".pdcard"),function(i, pdcard){
			$(this).find("li:first").addClass("setcon");
			if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){
				$.each($(this).find("li"),function(j, li){
					$(this).click(function(){
						$(this).addClass("setcon").siblings().removeClass("setcon");
						$(this).parent().parent().next(".cardtabcon").find(".pdcardcon").eq(j).show().siblings().hide();
					});
				});
			}
		});
	};
	//初始化购物车属性
	var _initOrderAttr = function() {
		//客户类型,证件类型
		order.cust.partyTypeCdChoose($("#orderPartyTypeCd").children(":first-child"),"orderIdentidiesTypeCd");
		order.cust.identidiesTypeCdChoose($("#orderIdentidiesTypeCd").children(":first-child"),"orderAttrIdCard");
		
	};
	
	//初始化省内订单属性
	var _initOrderProvAttr = function(){
		if(order.cust.fromProvFlag == "1" && ec.util.isObj(order.cust.provIsale)){
			$("#orderProvAttrIsale").val(order.cust.provIsale);
		}
	};
	
	//帐户信息-添加页面点击事件
	var _addEvent = function() {
		//页面点击帐户查询
		$('#acctQueryForm').bind('formIsValid', function(event, form) {
			var acctQueryParam;
			//1.根据接入号查询帐户
			if($("#chooseQueryAcctType").val()==1){
				if(!CONST.LTE_PHONE_HEAD.test($.trim($("#d_query_nbr input").val()))){
					$.alert("提示", "请输入有效的中国电信手机号");
					return;
				}
//				var param = {
//						accessNumber : $("#d_query_nbr input").val(),
//						prodPwd : $("#d_query_pwd input").val()
//				};
				//根据接入号查询帐户需先经过产品密码鉴权
//				var jr = $.callServiceAsJson(contextPath + "/order/prodAuth", param);
//				if (jr.code==0){
					acctQueryParam = {
						accessNumber : $("#d_query_nbr input").val()							
					};
//				} 
//				else{
//					$.alert("提示",jr.data);
//				}				
			} 
			//2.根据合同号查询帐户
			else if($("#chooseQueryAcctType").val()==2){
				if($.trim($("#d_query_cd input").val()) == null || $.trim($("#d_query_cd input").val()) == ""){
					$.alert("提示", "请输入合同号");
					return;
				}
				acctQueryParam = {
					acctCd : $("#d_query_cd input").val()
				};
			}
			//0.查询当前客户下帐户
			else{
				acctQueryParam = {
					custId : OrderInfo.cust.custId,
					isServiceOpen:"Y"
				};
			}	
			acctQueryParam.areaId=OrderInfo.getAreaId();
			
			$.callServiceAsJson(contextPath+"/token/pc/order/account", acctQueryParam, {
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$("#acctListTab tbody").empty();
					if(response.code==-2){
						$.alertM(response.data);
						return;
					}
					if(response.code==0){
						var returnMap = response.data;
						if(returnMap.resultCode==0){
							if(returnMap.accountInfos && returnMap.accountInfos.length > 0){
								$("#acctPageDiv").empty();
								common.page.init("acctPageDiv", 5, "pageId","queryAccount", returnMap.accountInfos);
							} 
							else{
								$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"));
							}
						}
						else{
							$("<tr><td colspan=4>"+returnMap.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"));
						}				
					}
					else{
						$("<tr><td colspan=4>"+response.data+"</td</tr>").appendTo($("#acctListTab tbody"));
					}
				}
			});
		}).ketchup({bindElement:"querAcctBtn"});

		$("#zhanghuclose").click(function(){
			easyDialog.close();
			//删除所有选择帐户监听
			$(document).removeJEventListener("queryAccount");
		});
		$(this).addJEventListener("queryAccount",function(data){
			_showAcct(data);
		});
		///选择查询帐户的条件
		$("#chooseQueryAcctType").change(function(){
			if($(this).val() == 1){//1.根据接入号查询
				$("#d_query_cd").remove();
				$("#querAcctBtn").parent().before("<dd id='d_query_nbr'>&nbsp;<input type='text' data-validate='validate(required:接入号不能为空) on(keyup blur)'" +
						" value='' class='inputWidth150px'></dd>");
//				$("#querAcctBtn").parent().before("<dd id='d_query_pwd'>&nbsp; 产品密码：&nbsp;<input  type='password' data-validate='validate(required:密码不能为空) on(keyup blur)' " +
//						"value='' class='inputWidth150px'></dd>");
			}else if($(this).val()==2){//2.根据合同号查询
				$("#d_query_nbr").remove();
//				$("#d_query_pwd").remove();
				$("#querAcctBtn").parent().before("<dd id='d_query_cd'>&nbsp;<input type='text' data-validate='validate(required:合同号不能为空) on(keyup blur)'" +
						" value='' class='inputWidth150px' ></dd>");
			}else{//0.查询当前客户下账户（默认）
				$("#d_query_cd").remove();
				$("#d_query_nbr").remove();
			}
		});
		$("#chooseQueryAcctType").change();
		//当前是否选用新帐户（是否展示自定义属性）
		$("#acctSelect").change(function(){
			if($(this).val()==-1){
				$(this).parent().find("a:eq(1)").hide();
				$("#defineNewAcct").show();
			}
			else{
				$(this).parent().find("a:eq(1)").show();
				$("#defineNewAcct").hide();
			}
		});
	};
		
	//展示帐户
	var _showAcct = function(accountInfos){
		$("#acctListTab tbody").empty();
		$.each(accountInfos,function(i, accountInfo){
			var tr = $("<tr></tr>").appendTo($("#acctListTab tbody"));
			if(accountInfo.name){
				$("<td class='teleNum'>"+accountInfo.name+"</td>").appendTo(tr);
			}
			else{
				$("<td></td>").appendTo(tr);
			}
			if(accountInfo.acctId){
				$("<td acctId='"+accountInfo.acctId+"'>"+accountInfo.accountNumber+"</td>").appendTo(tr);
			}
			else{
				$("<td></td>").appendTo(tr);
			}
			if(accountInfo.owner){
				$("<td>"+accountInfo.owner+"</td>").appendTo(tr);
			}
			else{
				$("<td></td>").appendTo(tr);
			}
			if(accountInfo.accessNumber){
				$("<td>"+accountInfo.accessNumber+"</td>").appendTo(tr);
			}
			else{
				$("<td></td>").appendTo(tr);
			}
			tr.click(function(){
				var found = false;
				var custAccts = $("#acctSelect").find("option");
				$.each(custAccts, function(i, custAcct){
					if(custAcct.value==accountInfo.acctId){
						$("#acctSelect").find("option[value="+custAcct.value+"]").attr("selected","selected");
						found = true;
						return false;
					}					
				});					
				$(this).dispatchJEvent("chooseAcct",accountInfo);				
				easyDialog.close();
				$("#defineNewAcct").hide();
			});
		});
	};
	
	//复制订单一的数据到当前订单
	var _copyOrder = function(scope) {
		//获取订单一的数据
		//主卡数据
//		var param = {};
//		var tarOrderSeq = $(".order_confirmation:visible").attr("order");
//		//付费方式
//		var paymethod = $("input[name=order_1_main_pay_type]:checked").val().trim();
//		if (paymethod) {
//			$("input[name=order_"+tarOrderSeq+"_main_pay_type][value="+paymethod+"]").attr("checked","checked");
//		}
//		//产品密码
//		var mainPwd  = $("#order_1_main_pwd").val();
//		if (mainPwd) {
//			$("#order_"+tarOrderSeq+"_main_pwd").val(mainPwd);
//		}
//		//判断是否有副卡
//		if ($("input[name=order_1_vice_1_pay_type]")[0]) {
//			$.each($("div[order=1]").find("div[vice=1]"),function(i,div){
//				//付费方式
//				var method = $("input[name=order_1_vice_"+(i+1)+"_pay_type]:checked").val();
//				//产品密码
//				if (method) {
//					$("input[name=order_"+tarOrderSeq+"_vice_"+(i+1)+"_pay_type][value="+method+"]").attr("checked","checked");
//				}
//				var pwd = $("#order_1_vice_"+(i+1)+"_pwd").val();
//				if (pwd) {
//					$("#order_"+tarOrderSeq+"_vice_"+(i+1)+"_pwd").val(pwd);
//				}
//			});
//		}
//		//协销人
//		var dealer = $("#order_1_dealer").val().trim();
//		if (dealer) {
//			$("#order_"+tarOrderSeq+"_dealer").val(dealer);
//			$("#order_"+tarOrderSeq+"_dealer").attr("staffId",$("#order_1_dealer").attr("staffId"));
//		}
//		//订单备注
//		var remark = $("#order_1_remark").val().trim();
//		if (remark) {
//			$("#order_"+tarOrderSeq+"_remark").val(dealer);
//		}
	};
	
	function _spec_parm(param){
		$.callServiceAsHtmlGet(contextPath + "/order/orderSpecParam",param, {
			"done" : function(response){
				if(response && response.code == -2){
					if(param.prodId!=-1&&param.prodId!="-1"){
						$("#"+param.ul_id).append("<li><label> </label></li>");
					}
					return ;
				}else if(response && (response.data == 0||response.data == "0")){
					if(param.prodId!=-1&&param.prodId!="-1"){
						$("#"+param.ul_id).append("<li><label> </label></li>");
					}
					//$.alert("提示","该产品无产品规格属性！");
					return;
				}
				//$("#order_spec_parm").append(response.data);
				$("#"+param.ul_id).append(response.data);
				
				//判断使用人产品属性是否必填
				_checkUsersProdAttr(param.prodId, $("#"+param.ul_id));
				
				//只有在新装的时候才可编辑“是否信控”产品属性
				var xkDom = $("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+param.prodId);
				if(xkDom.length == 1){
					//如果是6主副卡成员变更副卡加装，使副卡的信控属性与主卡保持一致
					if(OrderInfo.actionFlag == 6){
						var exist = false; 
						if(OrderInfo.prodInstAttrs && OrderInfo.prodInstAttrs.length){
							$.each(OrderInfo.prodInstAttrs, function(){
								if(this.itemSpecId==CONST.PROD_ATTR.IS_XINKONG){
									$(xkDom).val(this.value);
									exist = true;
								}					
							});
						}
						if(exist){
							$(xkDom).attr("disabled","disabled");
						} else {
//							$.alert("提示","查询主卡产品实例属性未获取到“是否信控”属性值");
							$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+param.prodId+" option[value='']").remove(); //去除“请选择”空值选项
							$(xkDom).val("20"); //默认为“是”
							if(OrderInfo.offerSpec.feeType == CONST.PAY_TYPE.BEFORE_PAY){ //“预付费”默认选是，且不可编辑
								$(xkDom).attr("disabled","disabled");
							}
						}
					} else if (OrderInfo.actionFlag != 1 && OrderInfo.actionFlag != 14){
						$(xkDom).attr("disabled","disabled");
					} else {
						$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+param.prodId+" option[value='']").remove(); //去除“请选择”空值选项
						$(xkDom).val("20"); //默认为“是”
						if(OrderInfo.offerSpec.feeType == CONST.PAY_TYPE.BEFORE_PAY){ //“预付费”默认选是，且不可编辑
							$(xkDom).attr("disabled","disabled");
						}
					}
				}
				//新装--二次加载(是否信控)处理
				$.each(OrderInfo.newOrderInfo.checkMaskList,function(){
					$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+this.prodId+"").find("option[value='"+this.isCheckMask+"']").attr("selected","selected");
				});
				//判断是否是预付费，是：修改信控信息
				if(OrderInfo.newOrderInfo.isReloadFlag=="N"){
					var feetype = $("select[name='pay_type_-1']").find("option:selected").val();
					if(feetype=="2100"){
						order.main.feeTypeCascadeChange($("select[name='pay_type_-1']"),'-1');
					}
				}
				//主副卡暂存单二次加载
				if(order.memberChange.reloadFlag=="N"||OrderInfo.newOrderInfo.isReloadFlag=="N"||OrderInfo.reloadFlag=="N"){				
					var custOrderList ="";//order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
					if(order.memberChange.rejson&&order.memberChange.rejson.orderList&&order.memberChange.rejson.orderList.custOrderList[0].busiOrder){
						custOrderList = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
					}else if(OrderInfo.newOrderInfo.result&&OrderInfo.newOrderInfo.result.orderList){
						custOrderList = OrderInfo.newOrderInfo.result.orderList.custOrderList[0].busiOrder;
					}else if(OrderInfo.data&&OrderInfo.data.orderList){
						custOrderList = OrderInfo.data.orderList.custOrderList[0].busiOrder;
					}
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员
							//封装产品属性
							if(this.data.boProdItems){
								var newboProdItems = this.data.boProdItems;
								$("[name=prodSpec_"+this.busiObj.instId+"]").each(function(){
									var tagName = this.tagName;
									var itemSpecId=$(this).attr("id").split("_")[0];
									var newid = $(this).attr("id");
									for(var i=0;i<newboProdItems.length;i++){
										if(newboProdItems[i].itemSpecId == itemSpecId && newid.split("_")[1]==newboProdItems[i].prodSpecItemId){
											if(tagName=="SELECT"){
												$("#"+newid+" option[value='"+newboProdItems[i].value+"']").attr("selected","selected");
											}else{
												$("#"+newid).val(newboProdItems[i].value);
											}
										}
									}
								});
							}
						}
					});
				}
			},
			fail:function(response){
				$.unecOverlay();
			}
		});
	}
	
	//判断使用人产品属性是否必填，mantis 0147689: 关于政企单位用户实名制信息录入相关工作的要求 ；
	function _checkUsersProdAttr(prodId, dom){
		//1）新建客户新装，如果是政企客户，填单时必须填写使用人；
		//2）老客户新装，根据客户查询判断是政企客户（segmentId=1000）时，填单必须填写使用人；
		var itemId = CONST.PROD_ATTR.PROD_USER + '_' + prodId;
		if($('#'+itemId).length > 0){
			var isOptional = true;
			if(OrderInfo.cust && OrderInfo.cust.custId && OrderInfo.cust.custId != '-1'){ //老客户
				if(OrderInfo.cust.segmentId == '1000'){ //政企客户
					isOptional = false;
				}
			} else { //新建客户
				if(OrderInfo.boCustInfos && OrderInfo.boCustInfos.partyTypeCd == '2'){ //政企客户
					isOptional = false;
				}
			}
			if(!isOptional){
				for(var i=0;i<OrderInfo.prodAttrs.length;i++){
					if(OrderInfo.prodAttrs[i].id == itemId){
						OrderInfo.prodAttrs[i].isOptional = 'N';
						break;
					}
				}
				//绑定弹出框事件，用于定位客户
				$('#'+itemId).attr({'check_option':'N','readonly':'readonly','disabled':'disabled'}).show();
				$('#choose_user_btn_'+prodId).off('click').on('click',function(){
					order.main.toChooseUser(prodId);
				}).show();
				
			} else {
				$('#'+itemId).attr({'readonly':'readonly','disabled':'disabled'}).hide();
				$('#choose_user_btn_'+prodId).off('click').hide();
				$('#choose_user_btn_'+prodId).parent().hide();
			}
		}
	};
	
	//显示客户定位弹出框
	function _toChooseUser(prodId){
		order.cust.queryForChooseUser = true; //标识客户定位是为了选择使用人
		order.cust.bindCustQueryForChoose(); //客户定位查询按钮
		$('#chooseUserBtn').off('click').on('click',function(){
			if(!!order.cust.tmpChooseUserInfo && order.cust.tmpChooseUserInfo.custId){
				//保存并显示使用人信息，清空弹出框的客户信息、临时保存的客户信息，关闭弹出框
				OrderInfo.updateChooseUserInfos(prodId, order.cust.tmpChooseUserInfo);
				$('#'+CONST.PROD_ATTR.PROD_USER+'_'+prodId+'_name').val(order.cust.tmpChooseUserInfo.partyName);
				$('#'+CONST.PROD_ATTR.PROD_USER+'_'+prodId).val(order.cust.tmpChooseUserInfo.custId);
				order.cust.tmpChooseUserInfo = {};
				
				easyDialog.close();
//				$('#p_cust_identityNum_choose').val('');
//				$('#chooseUserInfo td').html('');
				$('#chooseUserList').hide();
			} else {
				$.alert("提示","请定位客户作为使用人");
				return false;
			}
		});
		_showChooseUserDialog(null, prodId);
	};
	
	/*
	 * 显示选择使用人弹出框，custInfo为空则使用prodId定位已保存的使用人信息，custInfo不为空则更新临时保存的使用人信息
	 */
	function _showChooseUserDialog(custInfo, prodId){
		custInfo = custInfo || OrderInfo.getChooseUserInfo(prodId);
		if(custInfo != null && custInfo.custId){
			//将客户信息作为使用人tmpChooseUserInfo，确认后保存到OrderInfo.choosedUserInfos
			order.cust.tmpChooseUserInfo = custInfo;
//			order.cust.tmpChooseUserInfo.prodId = '';
			$('#chooseUserInfoName').html(custInfo.partyName);
			$('#chooseUserInfoNum').html(custInfo.identityName + '/' + custInfo.idCardNumber);
			$('#chooseUserInfoAreaName').html(custInfo.areaName);
			$('#chooseUserList').show();
		} else {
			$('#chooseUserInfo td').html('');
			$('#chooseUserList').hide();
		}
		$('#p_cust_identityCd_choose option:first').attr('selected','selected');
		$('#p_cust_identityNum_choose').val('');
		order.cust.custidentidiesTypeCdChoose($('#p_cust_identityCd_choose'),'p_cust_identityNum_choose');
		if($.ketchup){
			$.ketchup.hideAllErrorContainer($("#custQueryForChooseForm"));
		}
		easyDialog.open({
			container : "choose_user_dialog",
			callback : function(){
				order.cust.queryForChooseUser = false; //关闭弹出框时重置标识位
				if($.ketchup){
					$.ketchup.hideAllErrorContainer($("#custQueryForChooseForm"));
				}
			}
		});
	};
	
	//产品属性 提交
	function _spec_parm_change_save(){
		//OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");
		if(!_check_parm("order_spc_update")){
			return ;
		}
		var boProdItems = new Array();
		//input
		var chang_row = 0;
		$("#order_spc_update input").each(function(){
			//订单属性 是否模板 由公共类自动添加，这里不加入属性
			if($(this).attr("id")!="order_remark"&&$(this).attr("id")!="isTemplateOrder"&&$(this).attr("id")!="templateOrderName"&&$(this).attr("id")!="templateOrderType"){
				if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){
					if("1"==$(this).attr("addtype")){//如果实例没有，通过规格带出的属性，做ADD
						if($(this).val()!=null&&$(this).val()!=""){
							var row1 = {
									"itemSpecId":$(this).attr("itemSpecId"),
									"prodSpecItemId":$(this).attr("prodSpecItemId"),
									"state":"ADD",
									"value":$(this).val()
							};
							boProdItems.push(row1);
							chang_row++;
						}
					}else{
						if($(this).val()!=$(this).attr("oldValue")){
							if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){
								var row2 = {
										"itemSpecId":$(this).attr("itemSpecId"),
										"prodSpecItemId":$(this).attr("prodSpecItemId"),
										"state":"DEL",
										"value":$(this).attr("oldValue")
								};
								boProdItems.push(row2);
								chang_row++;
							}
							if($(this).val()!=null&&$(this).val()!=""){
								var row3 = {
										"itemSpecId":$(this).attr("itemSpecId"),
										"prodSpecItemId":$(this).attr("prodSpecItemId"),
										"state":"ADD",
										"value":$(this).val()
								};
								boProdItems.push(row3);
								chang_row++;
							}
						}
					}
				}
			}
		});
		//select
		$("#order_spc_update select").each(function(){
			if($(this).attr("id")!="templateOrderType"){
				if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){
					if("1"==$(this).attr("addtype")){//如果实例没有，通过规格带出的属性，做ADD
						if($(this).val()!=null&&$(this).val()!=""){
							var row1 = {
									"itemSpecId":$(this).attr("itemSpecId"),
									"prodSpecItemId":$(this).attr("prodSpecItemId"),
									"state":"ADD",
									"value":$(this).val()
							};
							boProdItems.push(row1);
							chang_row++;
						}
					}else{
						if($(this).val()!=$(this).attr("oldValue")){
							if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){
								var row2 = {
										"itemSpecId":$(this).attr("itemSpecId"),
										"prodSpecItemId":$(this).attr("prodSpecItemId"),
										"state":"DEL",
										"value":$(this).attr("oldValue")
								};
								boProdItems.push(row2);
								chang_row++;
							}
							if($(this).val()!=null&&$(this).val()!=""){
								var row3 = {
										"itemSpecId":$(this).attr("itemSpecId"),
										"prodSpecItemId":$(this).attr("prodSpecItemId"),
										"state":"ADD",
										"value":$(this).val()
								};
								boProdItems.push(row3);
								chang_row++;
							}
						}
					}
				}
			}
		});
		var busiOrderAttrs ;
		if($("#order_remark").val()){
			busiOrderAttrs = [{
				atomActionId : OrderInfo.SEQ.atomActionSeq--,
				itemSpecId : CONST.ITEM_SPEC_ID_CODE.busiOrderAttrs ,//"111111122",//备注的ID，待修改
				value : $("#order_remark").val()
			}];
			chang_row++;
		}
		if(chang_row<1){
			$.alert("提示","您未修改订单属性");
			return ;
		}
		/*
		if(!SoOrder.builder()){//加载实例缓存，并且初始化订单数据
			return;
		} 
		*/
		//配置参数：来调用产品属性修改的ser
		//OrderInfo.boProdItems = boProdItems ;
		var data = {boProdItems:boProdItems} ;
		if(busiOrderAttrs){
			data.busiOrderAttrs = busiOrderAttrs ;
		}
		OrderInfo.actionFlag=33;//改产品属性
		SoOrder.submitOrder(data);

	}
	//产品属性-校验所有属性
	function _check_parm(ul_id){
		var f = true ;
		$("#"+ul_id).find("input").each(function(){
			if(f){
				f = _check_parm_self(this);
			}
		});
		return f;
	}
	//产品属性-校验单个属性
	function _check_parm_self(obj){
		//alert("---"+$(obj).val());
		if($(obj).attr("check_option")=="N"){
			if($(obj).val()==null||$(obj).val()==""){
				$.alert("提示",$(obj).attr("check_name")+" 尚未填写");
				return false;
			}
		}
		
		if($(obj).attr("check_type")=="check"){
			var len = $(obj).attr("check_len");
			//alert($(this).val()+"--"+len);
			if(len>0){
				//alert($(this).val().length+"---"+len);
				if($(obj).val().length>len){
					$.alert("提示",$(obj).attr("check_name")+" 长度过长(<"+len+")");
					return false;
				}
			}
			var mask = $(obj).attr("check_mask");
			if(mask!=null&&$(obj).val()!=null&&$(obj).val()!=""){
				//alert($(obj).val()+"---"+mask);
				//mask= "^[A-Za-z]+$";
				var pattern = new RegExp(mask) ;
				if(!pattern.test($(obj).val())){
					$.alert("提示",$(obj).attr("check_name")+ " 校验失败：" + $(obj).attr("check_mess"));
					return false;
				}
			}
			var v_len = $(obj).val().length;
			if(v_len>0&&$(obj).attr("dataType")=="3"){//整数
				if(!/^[0-9]+$/.test($(obj).val())){
					$.alert("提示",$(obj).attr("check_name")+ " 非数字，请修改");
					return false;
				}
			}else if(v_len>0&&$(obj).attr("dataType")=="5"){//小数
				if(!/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test($(obj).val())){
					$.alert("提示",$(obj).attr("check_name")+ " 非小数，请修改");
					return false;
				}
			}else if(v_len>0&&($(obj).attr("dataType")=="4"||$(obj).attr("dataType")=="16")){//日期
				/*
				if(/Invalid|NaN/.test(new Date($(obj).val().substring(0,10)))){
					$.alert("提示",$(obj).attr("check_name")+ " 非日期，请修改");
					return false;
				}
				*/
			}
		}
		return true ;
	}
	
	$('staff_dialog_close').onclick = function(){
		easyDialog.close();
	};
	
	//协销人-查询(发展人查询)
	function _queryStaffPage(qryPage){
		_queryStaff(qryPage,$("#dealer_id").val(),$("#objInstId").val());
	}
	
	//协销人-查询(发展人查询)
	function _queryStaff(qryPage,v_id,objInstId){
		if(qryPage == 0){
			$("#p_staff_areaId").val("");
			$("#p_staff_areaId_val").val("");
		}
		var param = {
				"dealerId":v_id,
				"areaId":$("#p_staff_areaId").val(),
				//"currentAreaAllName":$("#p_staff_areaId_val").val(),//去掉省市信息，因为带了>符号，会被过滤
				"currentAreaAllName":"",
				"staffName":$("#qryStaffName").val(),
				"staffCode":$("#qryStaffCode").val(),
				"salesCode":$("#qrySalesCode").val(),
				"pageIndex":qryPage,
				"objInstId":objInstId,
				"pageSize":10
		};
		
		$.callServiceAsHtml(contextPath + "/staffMgr/getStaffList",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					response.data='';
				}
				$("#div_staff_dialog").html(response.data);
				
				$("#staff_list_body tr").each(function(){$(this).off("click").on("click",function(event){
					_linkSelectPlan("#staff_list_body tr",this);
					event.stopPropagation();
					});});
				easyDialog.open({
					container : "div_staff_dialog"
				});
				
			}
		});	

	}
	
	var _linkSelectPlan=function(loc, selected){
		$(loc).removeClass("plan_select");
		$(loc).children(":first-child").html("");
		$(selected).addClass("plan_select");
		var nike="<i class='select'></i>";
		$(selected).children(":first").html(nike);
	};
	//协销人-修改
	function _setStaff(objInstId){			
		var $staff = $("#staff_list_body .plan_select");
		if($staff.length <= 0){
			$.alert("操作提示","请选择 协销人！");
			return;
		}
		$staff.each(function(){
			var $channelList = $(this).find("td select[name='channel_list']");
			$("#dealerChannel_"+objInstId).empty(); 
			var $channelListOptions ="";
			if($channelList.length <= 0){
				$.each(OrderInfo.channelList,function(){
					if(this.isSelect==1)
						$channelListOptions += "<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>";				
				});
			}else{			
				$($channelList).find("option").each(function(){
					var $channelListOptionVal  = $(this).val() ; 
					var $channelListOptionName = $(this).html() ; 
					if(this.selected==true){
						$channelListOptions += "<option value='"+$channelListOptionVal+"' selected ='selected'>"+$channelListOptionName+"</option>";
					}else{
						$channelListOptions += "<option value='"+$channelListOptionVal+"'>"+$channelListOptionName+"</option>";
					}
				});
			}
			$("#dealerChannel_"+objInstId).append($channelListOptions);
			$("#dealer_"+objInstId).val($(this).attr("staffName")).attr("staffId", $(this).attr("staffId"));
		});
		easyDialog.close();
	}
	/*
	function _setStaff(v_id,staffId,staffCode,staffName){
		//alert(v_id+"--"+staffId+"=="+staffName);
		$("#"+v_id).val(staffName+"("+staffCode+")").attr("staffId",staffId);
		if(!$("#acctDialog").is("hidden")) {
			easyDialog.close();
		}
	}
	*/
	
	//帐户查询
	var _chooseAcct = function() {
		$("#acctDialog .contract_list td").text("帐户查询");
		$("#acctDialog .selectList").show();
		easyDialog.open({
			container : 'acctDialog'
		});
		$("#acctPageDiv").show();
		if(OrderInfo.cust.custId<0){
			$("#chooseQueryAcctType option[value=0]").remove();
			$("#chooseQueryAcctType").val(1);
			$("#d_query_cd").remove();
			$("#d_query_nbr").remove();
			$("#querAcctBtn").parent().before("<dd id='d_query_nbr'>&nbsp;<input type='text' data-validate='validate(required:接入号不能为空) on(keyup blur)'" +
					" value='' class='inputWidth150px'></dd>");
		}
		var listenerName = "chooseAcct";
		var $sel = $("#acctSelect");
		if (!$sel.hasJEventListener(listenerName)) {
			$sel.addJEventListener(listenerName,function(data){
				//遍历当前帐户列表，如果已存在，则直接显示，如果不存在，则加上一个option
				var found = false;
				$.each($sel.find("option"), function(i, option) {
					if ($(option).val() == data.acctId) {
						found = true;
						return false;
					}
				});
				if (found==false) {
					$("<option>").text(data.name+" : "+data.accountNumber).attr("value",data.acctId).attr("acctcd",data.accountNumber).appendTo($sel);
				}
				$sel.find("option[value="+data.acctId+"]").attr("selected","selected");
				if(data.acctId>0){
					$("#account").find("a:eq(1)").show();
				}
			});
		}
		//初始化弹出框
		$("#acctListTab tbody").empty();
		$("#acctPageDiv").empty();
	};
	
	//新增帐户
	var _createAcct = function() {
		$("#acctSelect").append("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>");
		$("#acctSelect").find("option[value='-1']").attr("selected","selected");
		$("#acctName").val(OrderInfo.cust.partyName);//默认帐户名称为客户名称
		//新增帐户自定义支付属性
		$("#defineNewAcct").show();
		//隐藏帐户信息的按钮
		$("#account").find("a:gt(0)").hide();
		//获取账单投递信息主数据并初始化新建帐户自定义属性
		window.setTimeout("order.main.showNewAcct()", 0);
	};
	//增加传入帐户
	var _createAcctWithId = function() {
	   //帐户信息查询参数初始化 
		var acctQueryParam;
		acctQueryParam = {
			acctCd : OrderInfo.acct.acctCd,
			isServiceOpen:"Y"   //是否能力开放,Y-是,N-否
		};
		acctQueryParam.areaId=OrderInfo.getAreaId();
		
		$.callServiceAsJson(contextPath+"/token/pc/order/account", acctQueryParam, {
				"before":function(){	},
				"always":function(){},
				"done" : function(response){
					if(response.code==-2){//查询接口出错
						$.alertM(response.data);
						return;
					}
					if(response.code==0){//查询成功
						var returnMap = response.data;
						if(returnMap.resultCode==0){
							if(returnMap.accountInfos && returnMap.accountInfos.length > 0){
								$("#accountDiv").find("label:eq(0)").text("主卡帐户：");
								//将对应的帐号添加进去
								$.each(returnMap.accountInfos, function(i, prodAcctInfo){
									$("<option>").text(prodAcctInfo.name+" : "+prodAcctInfo.accountNumber).attr("value",prodAcctInfo.acctId)
									.attr("acctcd",prodAcctInfo.accountNumber).appendTo($("#acctSelect"));	
									//选中第一个传入的帐户
									if(i==0){
										$("#acctSelect").find("option[value="+prodAcctInfo.acctId+"]").attr("selected","selected");
									}
								});	
								$("#acctSelect").find("option[value='-1']").remove();//将新增的选项进行删除
								$("#accountDiv").find("a:eq(0)").hide();
								$("#acctSelect").parent().find("a:eq(1)").show();//显示帐户信息按钮
								$("#defineNewAcct").hide();//隐藏新增帐户对应内容
							} else{//未查询到帐户信息
							    $.alert("提示","没有查询到帐户合同号对应的帐户信息");
							}
						}
						else{
							$.alertM(returnMap.resultMsg);
						}				
					}else{
						$.alertM(response.data);
					}
				}
			});
	};
	
	//获取账单投递信息主数据并初始化新建帐户自定义属性
	var _showNewAcct = function(){
		acct.acctModify.ifCanAdjustBankPayment();//查询工号权限：能否选择银行托收
		acct.acctModify.getBILL_POST(function(){
			acct.acctModify.paymentType();
			acct.acctModify.billPostType();
		});
	};
	
	//展示帐户信息
	var _acctDetail = function() {
		var acctSel = $("#acctSelect");
		if(!acctSel.val()){
			$.alert("提示","请选择一个帐户");
			return
		}
		if(acctSel.val() == -1){
			$.alert("提示","该帐户是新建帐户");
			return;
		}
		$("#acctDialog .contract_list td").text("帐户信息");
		$("#acctDialog .selectList").hide();
		$("#acctPageDiv").hide();
		$("#acctListTab tbody").empty();
		easyDialog.open({
			container : 'acctDialog'
		});
		var acctQueryParam = {
			acctCd : acctSel.find("option:selected").attr("acctcd"),
			isServiceOpen:"Y"   //是否能力开放,Y-是,N-否
		};			
		
		$.callServiceAsJson(contextPath+"/token/pc/order/account", acctQueryParam, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code==-2){
					$.alertM(response.data);
					return;
				}
				if(response.code==0){
					_showAcct(response.data.accountInfos);					
				}
				else{
					$("<tr><td colspan=4>"+response.data+"</td</tr>").appendTo($("#acctListTab tbody"));
				}
				$("#acctListTab tr").off("click");				
			}			
		});
	};
	
	var _lastStep = function() {
		$.confirm("信息","确定回到上一步吗？",{
			yes:function(){
				OrderInfo.resetChooseUserInfo();
				
				//TODO　may initialize something;				
				var boProdAns = OrderInfo.boProdAns;
				var boProdAn = order.service.boProdAn;
				var boProd2Tds = OrderInfo.boProd2Tds;
				//取消订单时，释放被预占的UIM卡
				if(boProd2Tds.length>0){
					for(var n=0;n<boProd2Tds.length;n++){
						var param = {
								numType : 2,
								numValue : boProd2Tds[n].terminalCode
						};
						$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param, {
							"done" : function(){}
						});
					}
				}
				//若是购机或选号入口则将继续释放主卡以外的预占号码（过滤身份证预占的号码）
//				if(order.service.releaseFlag==1){
//					if(boProdAns.length>0){
//						for(var n=0;n<boProdAns.length;n++){
//							if(boProdAns[n].accessNumber==boProdAn.accessNumber || boProdAns[n].idFlag){
//								continue;
//							}
//							var param = {
//									numType : 1,
//									numValue : boProdAns[n].accessNumber
//							};
//							$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
//						}
//					}
//				}
				//若是套餐入口则将继续释放主副卡预占的号码（过滤身份证预占的号码）
//				if(order.service.releaseFlag==2){
//					if(boProdAns.length>0){
//						for(var n=0;n<boProdAns.length;n++){
//							if(boProdAns[n].idFlag){
//								continue;
//							}
//							var param = {
//									numType : 1,
//									numValue : boProdAns[n].accessNumber
//							};
//							$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
//						}
//					}
//					if(boProdAn.accessNumber!='')
//						order.phoneNumber.resetBoProdAn();
//				}
				//释放预占的号码
				if(boProdAns.length>0){
					for(var n=0;n<boProdAns.length;n++){
						if(boProdAns[n].idFlag!=undefined&&boProdAns[n].idFlag=='0'){
							continue;
						}
						var param = {
								numType : 1,
								numValue : boProdAns[n].accessNumber
						};
						$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
					}
				}
				//清除号码的缓存！
				order.phoneNumber.resetBoProdAn();
				
				$("#order_fill_content").empty();
				order.prepare.showOrderTitle();
				$("#order_tab_panel_content").show();
				order.prepare.step(1);
			},no:function(){
				
			}},"question");
	};
	
	var _getTestParam = function() {
		return {
			boActionTypeCd : S1,
			boActionTypeName : "订购",
			offerSpecId : 1234,
			offerSpecName : "乐享3G-129套餐",
			feeType : 1200,
			viceCardNum : 3,
			offerNum : 3,
			type : 1,//1购套餐2购终端3选靓号
			terminalInfo : {
				terminalName : "IPhone5",
				terminalCode : "46456457345"
			},
			offerRoles : [
				{
					offerRoleId : 1234,
					offerRoleName : "主卡",
					memberRoleCd : "0",
					roleObjs : [{
						offerRoleId : 1,
						objId : CONST.PROD_SPEC.CDMA,
						objName : "CDMA",
						objType : 2
					}]
				},
				{
					offerRoleId : 2345,
					offerRoleName : "副卡",
					memberRoleCd : "1"
				}
			]
		};
	};
	

	var _genRandPass6Input = function(id){
		var pass = _genRandPass6();
		$("#"+id).val(pass);
	};
	
	var _genRandPass6 = function(){
		var str = "" ;
		var lastOneS = "" ;
		var thisOneS = "" ;
		var thisOneI = 0 ;
		for(var k=0;k<6;k++){
			do{
				if(str.length>0){
					lastOneS = str.substring(str.length-1,str.length) ;
				}
				thisOneI = parseInt(Math.random()*9+1);
				thisOneS = ""+thisOneI ;
				if(str.length==5){
					if(_checkIncreace6(str + thisOneS)){
						continue;
					}
				}
			}while(lastOneS==thisOneS);
			str = str + thisOneS ;
		}
		if(str.length!=6){
			return null ;
		}
		return str ;
	}
	
	var _checkIncreace6 = function(str){
		var rownum = 0 ;
		if(str && str.length==6){
			for(var i=0;i<5;i++){
				var int1 = parseInt(str.substring(i,i+1));
				var int2 = parseInt(str.substring(i+1,i+2));
				rownum = rownum + (int1-int2);
			}
			if(rownum==5||rownum==-5){
				return true ;
			}else{
				return false ;
			}
		}else{
			return false ;
		}
	};
	
	var _passwordCheckInput = function(id,accNbr){
		var val = $("#"+id).val();
		return _passwordCheckVal(val,accNbr);
	};
	
	var _passwordCheckVal = function(val,accNbr){
		var detail = "<div style='text-indent:0px;'>密码设置规则：<br/>1、密码必须为六位全数字；<br/>2、密码不能与接入号中的信息重复；<br/>3、密码不能包含连续相同的数字；<br/>4、密码不能是连续的六位数字。</div>";
		var reg = new RegExp("^([0-9]{6})$");//6位纯数字 0~9
		if(val==null){
			$.alertMore("提示", "", "密码不可为空！", detail, "");
			return false ;
		}else if(!reg.test(val)){
			$.alertMore("提示", "", "密码包含非数字或长度不是6位", detail, "");
			return false ;
		}
		if(accNbr!=null && accNbr.indexOf(val)>=0){
			$.alertMore("提示", "", "密码不能与接入号中的信息重复，请修改！", detail, "");
			return false ;
		}
		for(var k=0;k<5;k++){
			lastOneS = val.substring(k,k+1) ;
			thisOneS = val.substring(k+1,k+2) ;
			if(lastOneS==thisOneS){
				$.alertMore("提示", "", "密码中包含连续相同数字，请修改！", detail, "");
				return false ;
			}
		}
		if(_checkIncreace6(val)){
			$.alertMore("提示", "", "密码不可是连续6位数字，请修改！", detail, "");
			return false ;
		}
		return true ;
	};
	
	//付费类型选项变更时级联更新相关的产品属性
	var _feeTypeCascadeChange = function(dom,prodId){
		var feeType = $(dom).val();
		//“是否信控”产品属性，预付费时默认为“是”且不可编辑，其他默认为“是”但可编辑
		if(feeType == CONST.PAY_TYPE.BEFORE_PAY){
			//增加付费方式对翼支付助手功能产品的限制
			if((OrderInfo.actionFlag==1||OrderInfo.actionFlag==3||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14)
					&&CacheData.getServSpec(-1,381000960)!=null){
				var spec = CacheData.getServSpec(-1,381000960);
				if(spec.isdel==undefined||spec.isdel!="Y"){
					$.confirm("信息确认","您已选择开通【翼支付交费助手】功能产品，如果修改付费类型为预付费，其属性将赋为默认值！",{ 
						yesdo:function(){
							for ( var j = 0; j < spec.prodSpecParams.length; j++) {							
								var prodSpecParam = spec.prodSpecParams[j];
								prodSpecParam.setValue = prodSpecParam.value;
//								if (!!prodSpecParam.valueRange[0]) 
//									prodSpecParam.setValue = prodSpecParam.valueRange[0].value;
								}
						},
						no:function(){
							$(dom).find("option[value='1200']").attr("selected",true);
							$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+prodId).val("20").removeAttr("disabled");
						}
					});
				}				
			}
			$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+prodId).val("20").attr("disabled","disabled");
		} else {
			if((OrderInfo.actionFlag==1||OrderInfo.actionFlag==3||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14)
					&&CacheData.getServSpec(-1,381000960)!=null){
				var spec = CacheData.getServSpec(-1,381000960);
				if(spec.isdel==undefined||spec.isdel!="Y"){
					$.confirm("信息确认","您已选择开通【翼支付交费助手】功能产品，如果修改付费类型为后付费，将置空其选择属性，且属性不再可选！！",{ 
						yesdo:function(){
							for ( var j = 0; j < spec.prodSpecParams.length; j++) {							
								var prodSpecParam = spec.prodSpecParams[j];
								prodSpecParam.setValue = "";
							}
						},
						no:function(){
							$(dom).find("option[value='2100']").attr("selected",true);
							$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+prodId).val("20").attr("disabled","disabled");
						}
					});
				}				
			}
			$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+prodId).val("20").removeAttr("disabled");
		}
	};
	
	var _reload = function(){
		//主副卡暂存单二次加载
		if(order.memberChange.reloadFlag=="N"){
			var custOrderList = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
			//订购可选包和功能产品
			$.each(custOrderList,function(){
				//可选包
				if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="2"){
					var offermap = this;
					var offerflag = false;
					$.each(AttachOffer.openList,function(){
						if(this.prodId==offermap.data.ooRoles[0].prodId){
							$.each(this.specList,function(){
								if(this.offerSpecId==offermap.busiObj.objId){
									offerflag = true;
									return false;
								}
							});
						}
					});
							if(!offerflag){
								AttachOffer.addOpenList(offermap.data.ooRoles[0].prodId,offermap.busiObj.objId);
								//参数
								if(offermap.data.ooParams!=undefined){
									if(offermap.data.ooParams.length>0){
										var ooParams = offermap.data.ooParams[0];
										var spec = CacheData.getOfferSpec(ooParams.offerParamId,ooParams.offerSpecParamId);
										if(!!spec.offerSpecParams){
											for (var i = 0; i < spec.offerSpecParams.length; i++) {
												var param = spec.offerSpecParams[i];
												var itemSpec = CacheData.getSpecParam(ooParams.offerParamId,ooParams.offerSpecParamId,param.itemSpecId);
												if(itemSpec.itemSpecId == CONST.ITEM_SPEC.PROT_NUMBER){
													itemSpec.setValue = $("#select1").val();
												}else{
													itemSpec.setValue = ooParams.value;
												}
											}
										}
										if(spec.offerRoles!=undefined && spec.offerRoles.length>0){
											for (var i = 0; i < spec.offerRoles.length; i++) {
												var offerRole = spec.offerRoles[i];
												for (var j = 0; j < offerRole.roleObjs.length; j++) {
													var roleObj = offerRole.roleObjs[j];
													if(!!roleObj.prodSpecParams){
														for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
															var prodParam = roleObj.prodSpecParams[k];
															var prodItem = CacheData.getProdSpecParam(ooParams.offerParamId,ooParams.offerSpecParamId,prodParam.itemSpecId);
															prodItem.value = ooParams.value;
														}
													}
												}
											}
										}
										$("#can_"+ooParams.offerParamId+"_"+ooParams.offerSpecParamId).removeClass("canshu").addClass("canshu2");
										var attchSpec = CacheData.getOfferSpec(ooParams.offerParamId,ooParams.offerSpecParamId);
										attchSpec.isset = "Y";
									}
								}
								//终端串码
								if(offermap.data.bo2Coupons!=undefined){
									var bo2Coupons = offermap.data.bo2Coupons[0];
									$("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num).val(bo2Coupons.couponInstanceNumber);
									var coupon = {
											couponUsageTypeCd : bo2Coupons.couponUsageTypeCd, //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
											inOutTypeId : bo2Coupons.inOutTypeId,  //出入库类型
											inOutReasonId : bo2Coupons.inOutReasonId, //出入库原因
											saleId : bo2Coupons.saleId, //销售类型
											couponId : bo2Coupons.couponId, //物品ID
											couponinfoStatusCd : bo2Coupons.couponinfoStatusCd, //物品处理状态
											chargeItemCd : bo2Coupons.chargeItemCd, //物品费用项类型
											couponNum : bo2Coupons.couponNum, //物品数量
											storeId : bo2Coupons.storeId, //仓库ID
											storeName : bo2Coupons.storeName, //仓库名称
											agentId : bo2Coupons.agentId, //供应商ID
											apCharge : bo2Coupons.apCharge, //物品价格,约定取值为营销资源的
											couponInstanceNumber : bo2Coupons.couponInstanceNumber, //物品实例编码
											ruleId : bo2Coupons.ruleId, //物品规则ID
											partyId : bo2Coupons.partyId, //客户ID
											prodId : bo2Coupons.prodId, //产品ID
											offerId : bo2Coupons.offerId, //销售品实例ID
											attachSepcId : bo2Coupons.attachSepcId,
											state : bo2Coupons.state, //动作
											relaSeq : bo2Coupons.relaSeq, //关联序列	
											num	: bo2Coupons.num //第几个串码输入框
										};
										OrderInfo.attach2Coupons.push(coupon);
								}
							}
						
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S2" && this.busiObj.offerTypeCd=="2"){
					var offermap = this;
					var objInstId = "";
					$.each(order.memberChange.oldmembers.objInstId,function(){
						if(this.instId==offermap.busiObj.instId){
							objInstId = this.objInstId;
							return false;
						}
					});
					AttachOffer.delOffer(objInstId,this.busiObj.instId,"reload");
				}else if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="7"){//功能产品
					if(this.data.boServs[0].state=="ADD"){
						var offermap = this;
						var offerflag = false;
						$.each(AttachOffer.openServList,function(){
							if(this.prodId==offermap.data.boServOrders[0].servId){
								$.each(this.servSpecList,function(){
									if(this.servSpecId==offermap.data.boServOrders[0].servSpecId){
										offerflag = true;
										return false;
									}
								});
							}
						});
								if(!offerflag){
									var ifParams = "N";
									if(offermap.data.boServItems!=undefined){
										ifParams = "Y";
									}
									openServSpec(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId,offermap.data.boServOrders[0].servSpecName,ifParams);
									if(ifParams=="Y"){
										var spec = CacheData.getServSpec(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId);
										if(!!spec.prodSpecParams){
											for (var i = 0; i < spec.prodSpecParams.length; i++) {
												var param = spec.prodSpecParams[i];
												var itemSpec = CacheData.getServSpecParam(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId,param.itemSpecId);
												$.each(offermap.data.boServItems,function(){
													if(itemSpec.itemSpecId==this.itemSpecId){
														itemSpec.setValue = this.value;
													}
												});
											}
										}
										$("#can_"+this.busiObj.instId+"_"+offermap.data.boServOrders[0].servSpecId,param.itemSpecId).removeClass("canshu").addClass("canshu2");
										var attchSpec = CacheData.getServSpec(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId,param.itemSpecId);
										attchSpec.isset = "Y";
									}
								}
							
					}else if(this.data.boServs[0].state=="DEL"){
						AttachOffer.closeServ(this.busiObj.instId,this.data.boServOrders[0].servId,"reload");
					}
				}
			});
			
			//退订可选包
			$.each(AttachOffer.openList,function(){
				var openmap = this;
				$.each(this.specList,function(){
					var offermap = this;
					var offerflag = false;
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="2"){
							if(this.busiObj.objId==offermap.offerSpecId){
								offerflag = true;
								return false;
							}
						}
					});
					if(!offerflag){
						AttachOffer.delOfferSpec(openmap.prodId,this.offerSpecId,"reload");
					}
				});
			});
			
			//退订功能产品
			$.each(AttachOffer.openServList,function(){
				var openmap = this;
				$.each(this.servSpecList,function(){
					var offermap = this;
					var offerflag = false;
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="7"){
							if(offermap.servSpecId==this.data.boServOrders[0].servSpecId && openmap.prodId==this.busiObj.instId){
								offerflag = true;
								return false;
							}
						}
					});
					if(!offerflag){
						var $span = $("#li_"+openmap.prodId+"_"+this.servSpecId).find("span"); //定位删除的附属
						var spec = CacheData.getServSpec(openmap.prodId,this.servSpecId);
						if(spec == undefined){ //没有在已开通附属销售列表中
							return;
						}
						$span.addClass("del");
						spec.isdel = "Y";
						AttachOffer.showHideUim(1,openmap.prodId,this.servSpecId);   //显示或者隐藏
						var serv = CacheData.getServBySpecId(openmap.prodId,this.servSpecId);
						if(ec.util.isObj(serv)){ //没有在已开通附属销售列表中
							$span.addClass("del");
							serv.isdel = "Y";
						}
					}
				});
			});
			//补换卡
			$.each(custOrderList,function(){
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="14"){
					var instId = this.busiObj.instId;
					$("#uim_check_btn_"+instId).attr("disabled",true);
					$("#uim_check_btn_"+instId).removeClass("purchase").addClass("disablepurchase");
					$("#uim_release_btn_"+instId).attr("disabled",false);
					$("#uim_release_btn_"+instId).removeClass("disablepurchase").addClass("purchase");
					$("#uim_txt_"+instId).attr("disabled",true);
					$.each(this.data.bo2Coupons,function(){
						if(this.state=="ADD"){
							$("#uim_txt_"+instId).val(this.terminalCode);
							var coupon = {
									couponUsageTypeCd : this.couponUsageTypeCd, //物品使用类型
									cardTypeFlag : this.cardTypeFlag,
									inOutTypeId : this.inOutTypeId,  //出入库类型
									inOutReasonId : this.inOutReasonId, //出入库原因
									saleId : this.saleId, //销售类型
									couponId : this.couponId, //物品ID
									couponinfoStatusCd : this.couponinfoStatusCd, //物品处理状态
									chargeItemCd : this.chargeItemCd, //物品费用项类型
									couponNum : this.couponNum, //物品数量
									storeId : this.storeId, //仓库ID
									storeName : this.storeName, //仓库名称
									agentId : this.agentId, //供应商ID
									apCharge : this.apCharge, //物品价格
									couponInstanceNumber : this.couponInstanceNumber, //物品实例编码
									terminalCode : this.terminalCode,//前台内部使用的UIM卡号
									ruleId : this.ruleId, //物品规则ID
									partyId : this.partyId, //客户ID
									prodId :  this.prodId, //产品ID
									offerId : this.offerId, //销售品实例ID
									state : this.state, //动作
									relaSeq : this.relaSeq //关联序列	
								};
							OrderInfo.clearProdUim(instId);
							OrderInfo.boProd2Tds.push(coupon);
						}
					});
				}
			});
		}
	};
	
	var _queryGroupPage=function(pageIndex){
		_queryGroup($("#queryType").val(),pageIndex,$("#id").val());
	};
	
	//群号查询
	function _queryGroup(queryType,pageIndex,id){
//		if(pageIndex!=0){
//			if($("#accessNbr").val()==""){
//				$.alert("提示","接入号不能为空");
//				return;
//			}
//			if($("#BIZID").val()==""){
//				$.alert("提示","群号码不能为空");
//				return;
//			}
//		}
		var param = {
				"custId":"",
				"curPage":pageIndex,
				"pageSize":10,
				"acctNbr":$("#accessNbr").val(),
				"areaId":OrderInfo.getAreaId(),
				"lanId":OrderInfo.getAreaId(),
				"extCustId":"",
				"BIZID":$("#BIZID").val(),
				"areaNbr":"",
				"prodClass":"12",
				"queryTypeTmp":queryType,
				"objInstId":id
		};
		$.callServiceAsHtml(contextPath + "/offer/getGroupList",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code == -2){
					$.alertM(response.data);
					return;
				}
//				if(!response){
//					response.data='';
//				}
				$("#div_staff_dialog").html(response.data);
				$("#group_list_body tr").each(function(){$(this).off("click").on("click",function(event){
					_linkSelectPlan("#group_list_body tr",this);
					event.stopPropagation();
					});});
				easyDialog.open({
					container : "div_staff_dialog"
				});
			}
		});	
	};
	
	//群信息-修改
	var _setGroup=function(objInstId){
		var $group = $("#group_list_body .plan_select");
		$group.each(function(){
			$("#"+objInstId).val($(this).attr("accessNumber"));
		});
		if($group.length > 0){
			easyDialog.close();
		}else{
			$.alert("操作提示","请选择群！");
		}
	};
	
	//发展人-查询
	function _queryDealer(){
		var param = {
				"dealerId":"",
				"areaId":OrderInfo.staff.soAreaId.substring(0,3) + "0000",
				"currentAreaAllName":"",
				"staffName":"",
				"staffCode":OrderInfo.provinceInfo.salesCode,
				"salesCode":"",
				"pageIndex":1,
				"objInstId":"",
				"pageSize":10
		};
		$.callServiceAsJson(contextPath + "/token/pc/cust/getDealerList",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if (response.code == 0) {
					var list = response.data;
					var staffName = list[0].staffName;
					var staffId = list[0].staffId;
					$("#dealerTbody").find("tr").each(function(){
						var td = $(this).children("td").eq(3).children("input");
						var id = td.attr("id");
						$("#"+id).attr("value",staffName);
						$("#"+id).attr("staffid",staffId);
						return false;
					});
				}else{
					$.alertM(response.data);
				}
			}
		});	
	}
	
	return {
		buildMainView : _buildMainView,
		copyOrder : _copyOrder,
		spec_parm:_spec_parm,
		check_parm:_check_parm,
		queryStaff:_queryStaff,
		queryStaffPage:_queryStaffPage,
		setStaff:_setStaff,
		chooseAcct : _chooseAcct,
		check_parm_self:_check_parm_self,
		createAcct : _createAcct,
		createAcctWithId:_createAcctWithId,
		showNewAcct : _showNewAcct,
		acctDetail : _acctDetail,
		//spec_parm_change: _spec_parm_change,
		spec_parm_change_save:_spec_parm_change_save,
		//spec_password_change:_spec_password_change,
		//spec_password_change_save:_spec_password_change_save,
		paymethodChange:_paymethodChange,
		templateTypeCheck:_templateTypeCheck,
		lastStep : _lastStep,
		genRandPass6:_genRandPass6,
		genRandPass6Input:_genRandPass6Input,
		passwordCheckInput:_passwordCheckInput,
		passwordCheckVal:_passwordCheckVal,
		checkIncreace6:_checkIncreace6,
		feeTypeCascadeChange:_feeTypeCascadeChange,
		isChangeUim:_isChangeUim,
		loadAttachOffer:_loadAttachOffer,
		queryGroupPage:_queryGroupPage,
		queryGroup:_queryGroup,
		setGroup:_setGroup,
		getOfferMember:_getOfferMember,
		toChooseUser : _toChooseUser,
		showChooseUserDialog : _showChooseUserDialog,
		reload:_reload,
		initAcct:_initAcct,
		queryDealer:_queryDealer
	};
})();


/**
 * 订单准备
 * 
 * @author tang
 */
CommonUtils.regNamespace("order", "prodModify");
/**
 * 订单准备
 */
order.prodModify = (function(){	
	var boActionTypeCd="";//业务动作小类
	var authFlag="";
	var _coupon="";
	var lteFlag=(CONST.getAppDesc()==0) ? true : false;//下省标志,给LHW
//	var lteFlag=false;//下省标志，给XH
	var _ischooseOffer=false;
	var _choosedProdInfo = {};
	//客户信息修改客户属性信息
	var _profiles=[];
	//客户属性分页列表
	var _profileTabLists =[];
	//帐户信息修改帐户邮寄信息
	//获取选中的产品信息
	var _getChooseProdInfo = function() {
		var prodInfoTr=$("#phoneNumListtbody tr[class='plan_select']").find("td:eq(0)");
		if(prodInfoTr.attr("accNbr")==undefined){
			prodInfoTr=$("#phoneNumListtbody tr[class='bg plan_select']").find("td:eq(0)");
		}
		var prodInfoChildTr=$("#subphoneNumListtbody tr[class='plan_select2']").find("td:eq(0)");
		_choosedProdInfo  = {
			accNbr :prodInfoTr.attr("accNbr"),//产品接入号
			productName :prodInfoTr.attr("productName"),//产品规格名称
			prodStateName :prodInfoTr.attr("prodStateName"),//产品状态名称
			feeTypeName :prodInfoTr.attr("feeTypeName"),//付费方式名称
			prodInstId :prodInfoTr.attr("prodInstId"),//产品ID
			extProdInstId : prodInfoTr.attr("extProdInstId"),//省内产品实例ID
			corProdInstId : prodInfoTr.attr("corProdInstId"),//外部产品实例ID
			prodStateCd :prodInfoTr.attr("prodStateCd"),//产品状态CD
			productId :prodInfoTr.attr("productId"),//产品规格ID
			feeType :prodInfoTr.attr("feeType"),//付费方式id
			prodClass :$(prodInfoTr).attr("prodClass"),//产品大类 4 表示4G；3表示3G
			stopRecordCd :prodInfoTr.attr("stopRecordCd"),//停机记录CD
			stopRecordName :prodInfoTr.attr("stopRecordName"),//停机记录名称
			prodOfferName :prodInfoChildTr.attr("prodOfferName"),//主套餐名称
			custName :prodInfoChildTr.attr("custName"),//所属人客户名称
			startDt :prodInfoChildTr.attr("startDt"),//生效时间
			endDt :prodInfoChildTr.attr("endDt"),//失效时间
			prodOfferId :prodInfoChildTr.attr("prodOfferId"),//主套餐规格ID
			prodOfferInstId :prodInfoChildTr.attr("prodOfferInstId"),//主套餐实例ID
			custId :prodInfoChildTr.attr("custId"),//所属人客户ID
			is3G :prodInfoChildTr.attr("is3G"),//3G/4G主销售品标识
			areaCode :prodInfoTr.attr("zoneNumber"),//产品地区CODE
			areaId : prodInfoTr.attr("areaId")//产品地区id
		};
		order.prodModify.choosedProdInfo=_choosedProdInfo;
//		window.localStorage.setItem("order.prodModify.choosedProdInfo",JSON.stringify(order.prodModify.choosedProdInfo));
	};
	//业务规则校验
	var _getCallRuleParam = function(boActionTypeCd,prodId) {
		return {
			areaId : OrderInfo.staff.areaId,
			staffId : OrderInfo.staff.staffId,
			channelId : OrderInfo.staff.channelId,
			custId : OrderInfo.cust.custId,
			custFlag :OrderInfo.cust.custFlag,
			boInfos : [{
				boActionTypeCd : boActionTypeCd,
				instId : prodId,
				specId : CONST.PROD_SPEC.CDMA,
				prodId : prodId
			}]
		};
	};
	//预校验单校验
	var _updateCheckByChange = function (actionClassCd,boActionTypeCd,prodStatusCd,toprodStatusCd) {
		var data = { 
				orderList : {
					orderListInfo : { 
						isTemplateOrder : "N",   //是否批量
						templateType : "1",  //模板类型: 1 新装；8 拆机；2 订购附属；3 组合产品纳入/退出
						staffId : OrderInfo.staff.staffId,
						channelId : OrderInfo.staff.channelId,  //受理渠道id
						areaId : OrderInfo.staff.areaId,  //受理地区ID
						partyId :  _choosedProdInfo.custId,  //新装默认-1
						olTypeCd : CONST.OL_TYPE_CD.UI_LTE  //4g标识
					},
					custOrderList :[{busiOrder : []}]   //客户订购列表节点
				}
			};
		data.orderList.custOrderList[0].busiOrder=[{
	    	areaId: OrderInfo.staff.areaId,  //受理地区ID
		    boActionType: {
		        actionClassCd: actionClassCd,//受理大类
		        boActionTypeCd: boActionTypeCd//退订销售品
		    }, busiObj: {
		        accessNumber: _choosedProdInfo.accNbr,
		        instId: _choosedProdInfo.prodInstId,
		        isComp: "N",
		        objId: CONST.PROD_SPEC.CDMA,
		        offerTypeCd: "1"
		    }, busiOrderInfo: {
		        seq: OrderInfo.SEQ.seq
		    },data: {
		    	boProdStatuses : [{
					atomActionId : OrderInfo.SEQ.atomActionSeq--,
					prodStatusCd : prodStatusCd,
					state : "DEL"
				},{
					atomActionId : OrderInfo.SEQ.atomActionSeq--,
					prodStatusCd : toprodStatusCd,
					state : "ADD"
				}
		        ]
		    }
	    }];
		params=JSON.stringify(data);
		var url=contextPath+"/token/pc/order/prodModify/updateCheckByChange";
		var response = $.callServiceAsJson(url, params, {});
		var msg="";
		if (response.code == 0) {
			return true;
		}else if(response.code == -2){
			$.alertM(response.data);
			return false;
		}else{
			if (response.data.resultMsg) {
		        $.alert("提示","预校验失败!失败原因为："+response.data.resultMsg);
		    } else {
		        $.alert("提示","预校验失败! 集团营业后台未给出原因。");
		    }
		}
	};
	//二次业务产品密码鉴权配置 
	var _remark_prodPass = function () {
		var params = {"tableName":"SYSTEM","columnName":"REMARK_PRODPASS"} ;
		var url=contextPath+"/order/prodModify/queryProdPwdConfig";
		if(OrderInfo.password_remark==""){
			var response = $.callServiceAsJson(url, params, {});
			var msg="";
			if (response.code == 0) {
				OrderInfo.password_remark=response.data;
			}else if(response.code == -2){
				$.alertM(response.data);
				OrderInfo.password_remark="0";
				return false;
			}else{
				OrderInfo.password_remark="0";
				return false;
			}
		}
		
	}
	//补换卡规则校验
	var _showChangeCard = function () {
		if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){
			$.alert("提示","停机产品不允许受理！");
			return;
		}
		OrderInfo.busitypeflag=13;
		prod.changeUim.init();
	};
	
	//加入群组规则校验
	var _showAddComp = function(){
		var compspecparam = {
				"productId":_choosedProdInfo.productId
		}
		if(getCompInfo(compspecparam)==""){
			return;
		}
		var param = {
				"areaId" : OrderInfo.staff.areaId, //地区ID
				"custId" : OrderInfo.cust.custId, //客户ID
				"staffId" : OrderInfo.staff.staffId,
				"channelId" : OrderInfo.staff.channelId,
				"boInfos":[{
					"boActionTypeCd": CONST.BO_ACTION_TYPE.ADD_COMP,//动作类型
				    "instId" : _choosedProdInfo.prodInstId, //实例ID
				    "specId" : CONST.PROD_SPEC.CDMA //产品（销售品）规格ID
				}]
		};
		var callParam = {
				"prodInstId" : _choosedProdInfo.prodInstId,
				"productId" : _choosedProdInfo.productId
		};
		var checkRule = rule.rule.prepare(param,'order.prodModify.addComp',callParam);
	}
	
	//退出群组规则校验
	var _showRemoveComp = function(){
		var compspecparam = {
				"productId":_choosedProdInfo.productId
		}
		if(getCompInfo(compspecparam)==""){
			return;
		}
		var param = {
				"areaId" : OrderInfo.staff.areaId, //地区ID
				"custId" : OrderInfo.cust.custId, //客户ID
				"staffId" : OrderInfo.staff.staffId,
				"channelId" : OrderInfo.staff.channelId,
				"boInfos":[{
					"boActionTypeCd": CONST.BO_ACTION_TYPE.ADD_COMP,//动作类型
				    "instId" : _choosedProdInfo.prodInstId, //实例ID
				    "specId" : CONST.PROD_SPEC.CDMA //产品（销售品）规格ID
				}]
		};
		var callParam = {
				"prodInstId" : _choosedProdInfo.prodInstId,
				"productId" : _choosedProdInfo.productId
		};
		var checkRule = rule.rule.prepare(param,'order.prodModify.removeComp',callParam);
	};
	var _queryOfferSpec=function(){
		var offerSpecId = _choosedProdInfo.prodOfferId;
		//offerSpecId = 300500003940;//TODO need delete
		var offerId=_choosedProdInfo.prodOfferInstId;
		//offerId=120000000645;//TODO need delete
		_offerProd.offerId=offerId;
		_offerProd.offerSpecId=offerSpecId;
		if(offerSpecId==undefined||offerSpecId==''){
			return {};
		}else{
			var param={"offerSpecId":offerSpecId};
			var response = $.callServiceAsJson(contextPath+"/order/queryOfferSpec",param);
			if (response.code==0) {
				if(response.data){
					_offerSpec = response.data.offerSpec;
				}
			}
		}
		return _offerSpec;
	};
	
	//挂失解挂准备
	var _showLossRepProd = function () {
		OrderInfo.busitypeflag=5;
		var submitState="";
        var BO_ACTION_TYPE="";
        var inprodStatusCd="";
        var intoprodStatusCd="";
			inprodStatusCd=_choosedProdInfo.prodStateCd;
			intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;
			BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.LOSSREP_PROD;
			if(inprodStatusCd==""){
				inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
			}
		var param = _getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd :inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			prodOfferName : _choosedProdInfo.prodOfferName,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
	};
	//解挂准备
	var _showLossRepProdReg = function () {
		OrderInfo.busitypeflag=5;
		var submitState="";
        var BO_ACTION_TYPE="";
        var inprodStatusCd="";
        var intoprodStatusCd="";
			inprodStatusCd=_choosedProdInfo.prodStateCd;
			intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;;
			BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISLOSSREP_PROD;
		var param = _getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd :inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			prodOfferName : _choosedProdInfo.prodOfferName,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
	};
	//停机保号/取消停机保号准备
	var _showStopKeepNumProd = function () {
		OrderInfo.busitypeflag=6;
		var submitState="";
        var BO_ACTION_TYPE="";
        var inprodStatusCd="";
        var intoprodStatusCd="";
			BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.STOPKEEPNUM;
			inprodStatusCd=_choosedProdInfo.prodStateCd;
			intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;
			if(inprodStatusCd==""){
				inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
			}
		var param = _getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd :inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			prodOfferName : _choosedProdInfo.prodOfferName,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
	};
	//停机保号/取消停机保号准备
	var _showStopKeepNumProdReg = function () {
		OrderInfo.busitypeflag=6;
		var submitState="";
        var BO_ACTION_TYPE="";
        var inprodStatusCd="";
        var intoprodStatusCd="";
			BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISSTOPKEEPNUM;
			inprodStatusCd=_choosedProdInfo.prodStateCd;
			intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		var param = _getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd :inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			prodOfferName : _choosedProdInfo.prodOfferName,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
	};
	//客户修改资料
	var _showCustInfoModify = function () {
		if("-1"==OrderInfo.cust.custId){
			$("#cCustName").val(OrderInfo.boCustInfos.name);
			$("#cCustIdCard").val(OrderInfo.boCustIdentities.identityNum);
			$("#partyTypeCd option[value='"+OrderInfo.boCustInfos.partyTypeCd+"']").attr("selected", true);
			$("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']").attr("selected", true);
			$("#cAddressStr").val(OrderInfo.boCustInfos.addressStr);
			//证件类型选择事件
			order.cust.identidiesTypeCdChoose($("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']"),"ccCustIdCard");
			tabProfileFlag="1";
			//客户联系人
			$("#contactAddress").val(OrderInfo.boPartyContactInfo.contactAddress);
			$("#contactDesc").val(OrderInfo.boPartyContactInfo.contactDesc);
			$("#contactEmployer").val(OrderInfo.boPartyContactInfo.contactEmployer);
			//$("#contactGender").val(OrderInfo.boPartyContactInfo.contactGender);
			$("#contactGender option[value='"+OrderInfo.boPartyContactInfo.contactGender+"']").attr("selected", true);
			$("#contactName").val(OrderInfo.boPartyContactInfo.contactName);
			//$("#contactType").val(OrderInfo.boPartyContactInfo.contactType);
			$("#contactType option[value='"+OrderInfo.boPartyContactInfo.contactType+"']").attr("selected", true);
			$("#eMail").val(OrderInfo.boPartyContactInfo.eMail);
			$("#fax").val(OrderInfo.boPartyContactInfo.fax);
			//$("#headFlag").val(OrderInfo.boPartyContactInfo.headFlag);
			$("#headFlag option[value='"+OrderInfo.boPartyContactInfo.headFlag+"']").attr("selected", true);
			$("#homePhone").val(OrderInfo.boPartyContactInfo.homePhone);
			$("#mobilePhone").val(OrderInfo.boPartyContactInfo.mobilePhone);
			$("#officePhone").val(OrderInfo.boPartyContactInfo.officePhone);
			$("#postAddress").val(OrderInfo.boPartyContactInfo.postAddress);
			$("#postcode").val(OrderInfo.boPartyContactInfo.postcode);
			easyDialog.open({
				container : 'user_add'
			});
		}else{
			var submitState="";
	        var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.CUSTINFOMODIFY;
			submitState="ADD";
			var param = _getCallRuleParam(BO_ACTION_TYPE, _choosedProdInfo.prodInstId);
			var callParam = {
				boActionTypeCd : BO_ACTION_TYPE,
				boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
				accessNumber : "",
				prodOfferName : "",
				state:submitState
			};
/*			SoOrder.builder(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE);
			OrderInfo.actionTypeName = CONST.getBoActionTypeName(BO_ACTION_TYPE);
			OrderInfo.actionFlag=4;*/
			OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,4,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
			var checkRule = rule.rule.prepare(param,'order.prodModify.custInfoModify',callParam);
			if (checkRule) return;
			//SoOrder.builder();
			
		}
	};
	//改客户资料返档
	var _showActiveReturn = function () {
		if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){
			$.alert("提示","停机产品不允许受理！");
			return;
		}
		OrderInfo.busitypeflag=12;
		/*if(_choosedProdInfo.prodStateCd!=CONST.PROD_STATUS_CD.READY_PROD){
			$.alert("提示","产品必须为预开通时才能进行改客户资料返档","information");
			return;
		}*/
		var submitState="";
        var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACTIVERETURN;
		submitState="ADD";
		var param = _getCallRuleParam(BO_ACTION_TYPE, _choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : "",
			prodOfferName : "",
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,9,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.custInfoModify',callParam);
		if (checkRule) return;
	};
	//修改帐户信息
	var _showAcctInfoModify = function () {
			var submitState="";
	        var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACCTINFOMODIFY;
			submitState="ADD";
			var param = _getCallRuleParam(BO_ACTION_TYPE, _choosedProdInfo.prodInstId);
			var callParam = {
				boActionTypeCd : BO_ACTION_TYPE,
				boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
				accessNumber : "",
				prodOfferName : "",
				state:submitState
			};
			OrderInfo.initData(CONST.ACTION_CLASS_CD.ACCT_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
			var checkRule = rule.rule.prepare(param,'order.prodModify.acctInfoModify',callParam);
			if (checkRule) return ;
			//SoOrder.builder();
			
	};
	var _form_custInfomodify_btn = function() {
		//修改客户下一步确认按钮
		$('#custModifyForm').off("formIsValid").on("formIsValid",function(event) {
			var modifyCustInfo={};
			modifyCustInfo = {
					custName : $.trim($("#cmCustName").val()),
					identidiesTypeCd :  $("#div_cm_identidiesType  option:selected").val(),
					custIdCard :  $.trim($("#cmCustIdCard").val()),
					addressStr: $.trim($("#cmAddressStr").val())
				};
			var data = {};
			data.boCustInfos = [{
				areaId : OrderInfo.cust.areaId,
				name : $("#boCustIdentities").attr("partyName"),
				norTaxPayerId : "0",
				partyTypeCd : $("#boCustIdentities").attr("partyTypeCd"),
				addressStr :$("#boCustIdentities").attr("addressStr"),
				state : "DEL"
			},{
				areaId : OrderInfo.cust.areaId,
				name : modifyCustInfo.custName,
				norTaxPayerId : "0",
				partyTypeCd : $("#cmPartyTypeCd  option:selected").val(),
				addressStr :modifyCustInfo.addressStr,
				state : "ADD"
			}];
			if(OrderInfo.cust.idCardNumber==""||OrderInfo.cust.idCardNumber==null){
				data.boCustIdentities = [{
					identidiesTypeCd :modifyCustInfo.identidiesTypeCd,
					identityNum : modifyCustInfo.custIdCard,
					isDefault : "Y",
					state : "ADD"
				}];	
			}else{
			data.boCustIdentities = [{
				identidiesTypeCd :OrderInfo.cust.identityCd,
				identityNum : OrderInfo.cust.idCardNumber,
				isDefault : "Y",
				state : "DEL"
			},{
				identidiesTypeCd :modifyCustInfo.identidiesTypeCd,
				identityNum : modifyCustInfo.custIdCard,
				isDefault : "Y",
				state : "ADD"
			}];
			}
			data.boCustProfiles=[];
			//客户属性信息
			for ( var i = 0; i < order.prodModify.profiles.length; i++) {
				var profilesObj = order.prodModify.profiles[i];
				var profilesDel ={};
				var profilesAdd ={};
				profilesDel={
					partyProfileCatgCd: profilesObj.attrId,
					profileValue: profilesObj.defaultValue,
					state : "DEL"};
				profilesAdd={
					partyProfileCatgCd: profilesObj.attrId,
					profileValue: $.trim($("#profiles_"+profilesObj.attrId).val()),
					state : "ADD"
				};
				if(document.getElementById("profiles_"+profilesObj.attrId)&&profilesObj.profileValue!=$.trim($("#profiles_"+profilesObj.attrId).val())){
					data.boCustProfiles.push(profilesDel);
					data.boCustProfiles.push(profilesAdd);
				}

			} 
			//客户联系人
			data.boPartyContactInfo=[];
			var _boPartyContactInfoOld = {
/*					contactAddress : $("#modTabProfile0").attr("contactAddress"),//参与人的联系地址
			        contactDesc : $("#modTabProfile0").attr("contactDesc"),//参与人联系详细信息
			        contactEmployer  : $("#modTabProfile0").attr("contactEmployer"),//参与人的联系单位
			        contactGender  : $("#modTabProfile0").attr("contactGender"),//参与人联系人的性别
*/			        contactId : $("#modTabProfile0").attr("contactId"),//参与人联系信息的唯一标识
                    statusCd : "100001",
                    contactName : $("#modTabProfile0").attr("contactName"),//参与人的联系人名称
                    headFlag :  $("#modTabProfile0").attr("headFlag"),//是否首选联系人
/*			        
			        contactType : $("#modTabProfile0").attr("contactType"),//联系人类型
			        eMail : $("#modTabProfile0").attr("eMail"),//参与人的eMail地址
			        fax : $("#modTabProfile0").attr("fax"),//传真号
			        
			        homePhone : $("#modTabProfile0").attr("homePhone"),//参与人的家庭联系电话
			        mobilePhone : $("#modTabProfile0").attr("mobilePhone"),//参与人的移动电话号码
			        officePhone : $("#modTabProfile0").attr("officePhone"),//参与人办公室的电话号码
			        postAddress : $("#modTabProfile0").attr("postAddress"),//参与人的邮件地址
			        postcode : $("#modTabProfile0").attr("postcode"),//参与人联系地址的邮政编码
			        staffId : OrderInfo.staff.staffId,//员工ID
*/			        state : "DEL"//状态
			};
			var _boPartyContactInfo = {
					contactAddress : $.trim($("#contactAddress").val()),//参与人的联系地址
			        contactDesc : $.trim($("#contactDesc").val()),//参与人联系详细信息
			        contactEmployer  : $.trim($("#contactEmployer").val()),//参与人的联系单位
			        contactGender  : $.trim($("#contactGender").val()),//参与人联系人的性别
			        contactId : $.trim($("#contactId").val()),//参与人联系信息的唯一标识
			        contactName : $.trim($("#contactName").val()),//参与人的联系人名称
			        contactType : $.trim($("#contactType").val()),//联系人类型
			        eMail : $.trim($("#eMail").val()),//参与人的eMail地址
			        fax : $.trim($("#fax").val()),//传真号
			        headFlag :  $.trim($("#headFlag  option:selected").val()),//是否首选联系人
			        homePhone : $.trim($("#homePhone").val()),//参与人的家庭联系电话
			        mobilePhone : $.trim($("#mobilePhone").val()),//参与人的移动电话号码
			        officePhone : $.trim($("#officePhone").val()),//参与人办公室的电话号码
			        postAddress : $.trim($("#postAddress").val()),//参与人的邮件地址
			        postcode : $.trim($("#postCode").val()),//参与人联系地址的邮政编码
			        staffId : OrderInfo.staff.staffId,//员工ID
			        state : "ADD",//状态
			        statusCd : "100001"//订单状态
			};
			if($("#modTabProfile0").attr("click")=="0"){
				if(_boPartyContactInfoOld.contactId!=""){
					data.boPartyContactInfo.push(_boPartyContactInfoOld);
					data.boPartyContactInfo.push(_boPartyContactInfo);
				}else{
					data.boPartyContactInfo.push(_boPartyContactInfo);
				}
				
			}
			SoOrder.submitOrder(data);
		}).ketchup({bindElement:"custInfoModifyBtn"});
	};
    //客户类型选择事件
	var _partyTypeCdChoose = function(scope) {
		var partyTypeCd=$(scope).val();
		//_partyType(partyTypeCd);
		$("#cm_identidiesTypeCd").empty();
		//客户类型关联证件类型下拉框
		_certTypeByPartyType(partyTypeCd);
		//证件类型选择事件
		_identidiesTypeCdChoose($("#div_cm_identidiesType").children(":first-child"));

	};
	var _partyType = function(partyTypeCd) {
		if(partyTypeCd==1){
			var identidiesTypeCdHtml="<select id=\"cmIdentidiesTypeCd\" onchange=\"order.prodModify.identidiesTypeCdChoose(this)\"><option value=\"1\" >身份证</option><option value=\"2\">军官证</option></select>";
		}else if(partyTypeCd==2){
			var identidiesTypeCdHtml="<select id=\"cmIdentidiesTypeCd\" onchange=\"order.prodModify.identidiesTypeCdChoose(this)\"><option value=\"3\">护照</option><option value=\"23\">ICP经营许可证</option><option value=\"39\">税务登记号</option></select>";
		};
		$("#div_cm_identidiesType").html(identidiesTypeCdHtml);
	};
	//客户类型关联证件类型下拉框
	var _certTypeByPartyType = function(_partyTypeCd){
		var params = {"partyTypeCd":_partyTypeCd} ;
		var url=contextPath+"/cust/queryCertType";
		var response = $.callServiceAsJson(url, params, {});
       if (response.code == -2) {
					$.alertM(response.data);
				}
	   if (response.code == 1002) {
					$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");
					return;
				}
	   if(response.code==0){
					var data = response.data ;
					if(data!=undefined && data.length>0){
						for(var i=0;i<data.length;i++){
							var certTypedate = data[i];
							$("#cm_identidiesTypeCd").append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>");
							
						}
					}
				}
	};
	//证件类型选择事件
	var _identidiesTypeCdChoose = function(scope) {
		var identidiesTypeCd=$(scope).val();
		if(identidiesTypeCd==undefined){
			identidiesTypeCd=$("#div_cm_identidiesType  option:selected").val();
		}
		if(identidiesTypeCd==1){
			$("#cmCustIdCard").attr("placeHolder","请输入合法身份证号码");
			$("#cmCustIdCard").attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)");
		}else if(identidiesTypeCd==2){
			$("#cmCustIdCard").attr("placeHolder","请输入合法军官证");
			$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}else if(identidiesTypeCd==3){
			$("#cmCustIdCard").attr("placeHolder","请输入合法护照");
			$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}else{
			$("#cmCustIdCard").attr("placeHolder","请输入合法证件号码");
			$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		_form_custInfomodify_btn();
	};
	var _custInfoModify = function(callParam) {
		var param={};
		param.partyName=OrderInfo.cust.partyName;
		param.custId=OrderInfo.cust.custId;
		//定位客户
		param.idCardNumber=OrderInfo.cust.idCardNumber;
		param.boActionTypeName=callParam.boActionTypeName;
		param.areaId=OrderInfo.getAreaId();
		$.callServiceAsHtml(contextPath + "/order/prodModify/custInfoModify", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if (response.code == -2) {
					$.alertM(response.data);
					return;
				}
				if(response.data.indexOf("false") >=0) {
					$.alert("提示","抱歉，查询无返回客户详情信息。");
					//$.alertM(response.data);
					return;
				}
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				//根据客户类型查询证件类型
				_partyTypeCdChoose($("#cmPartyTypeCd  option:selected"));
				//取客户证件类型
				$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected", true);
				//根据证件类型对行添加校验
				_identidiesTypeCdChoose($("#cm_identidiesTypeCd option[selected='selected']"));
				
				
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$(".ordercon").show();
				$(".ordertabcon").show();
				$("#step1").show();
				
				$(".ordercon a:first span").text("取 消");
				_form_custInfomodify_btn();
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	var _lossRepProd = function(callParam) {
		param=_choosedProdInfo;
		$.extend(param, callParam);
		$.callServiceAsHtml(contextPath + "/order/prodModify/lossRepProd", param, {
			"before":function(){
			},"done" : function(response){
				var content$ = $("#order_prepare");
				content$.html(response.data).show();
				$(".ordercon").show();
				$(".ordertabcon").show();
				$("#step1").show();
				$("#custInfo").hide();
				$(".ordercon a:first span").text("取 消");
			},"always":function(){
				$.unecOverlay();
			}
		});
		SoOrder.builder(CONST.ACTION_CLASS_CD.PROD_ACTION,param.boActionTypeCd);
/*		OrderInfo.actionClassCd = 1300;
		OrderInfo.boActionTypeCd = "1171";*/
/*		OrderInfo.actionClassCd = CONST.ACTION_CLASS_CD.PROD_ACTION;
		OrderInfo.boActionTypeCd = param.boActionTypeCd;
		SoOrder.builder(1300,"14");*/
	};
	//挂失 订单提交
	var _lossRepProdSubmit = function(param) {
		var data = {};
		data.orderRemark = $.trim($("#order_remark").val());
		data.boProdStatuses = [{
			prodStatusCd : 8,
			state : submitState
		}];
		SoOrder.submitOrder(data);
		//_commonSubmit(CONST.BO_ACTION_TYPE.LOSSREP_PROD,_choosedProdInfo.prodStateCd,"111111122");
	};
	var _closeDialog = function() {
		if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){
			order.prodModify.dialogForm.close(order.prodModify.dialog);
		}
	};
	var _removeCommit=function(prodStatusCd,boActionType,templateType){
		var inprodStatusCd="";
        var intoprodStatusCd="";
        inprodStatusCd=_choosedProdInfo.prodStateCd;
		intoprodStatusCd=prodStatusCd;
		if(inprodStatusCd==""){
			inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		var param = _getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : boActionType,
			boActionTypeName : CONST.getBoActionTypeName(boActionType),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd : inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:"ADD"
		};
		OrderInfo.order.templateType=templateType;
		var v_actionFlag = 0 ;
		if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK || boActionType==CONST.BO_ACTION_TYPE.BUY_BACK_CHANGE_CARD|| boActionType==CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){
			v_actionFlag =19;//OrderInfo.actionFlag
		}
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);
		var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
		if(flag) return;
		//SoOrder.builder();
		
	};
	var _showMemberWin=function(){
		//Mantis 0033139: 主副卡拆机，前台需要屏蔽保留副卡 ; by jinjian;
		if(OrderInfo.busitypeflag == 7 || OrderInfo.busitypeflag == 8 || OrderInfo.busitypeflag == 9 || OrderInfo.busitypeflag == 10 || OrderInfo.busitypeflag == 11){
			return false;
		}
		_ischooseOffer=false;
		var viceCount=0;
		var offerMemberInfos=OrderInfo.offer.offerMemberInfos;
		$.each($("#delPhoneNumber ul:last li"),function(i, li){
			$(this).remove();
		});
		$.each(offerMemberInfos,function(i,offerMember){
			/*if(offerMember.roleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD&&offerMember.roleCd !=CONST.MEMBER_ROLE_CD.VICE_CARD){//不是主卡卡套餐跳过
				return false;
			}*/
			if(offerMember.roleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD&&_choosedProdInfo.accNbr==offerMember.accessNumber){
				viceCount=0;
				return false;
			}
			if (offerMember.roleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD&& offerMember.objType==CONST.OBJ_TYPE.PROD) {
				$("#delPhoneNumber ul:first h5").text(offerMember.roleName);
				$("#delPhoneNumber ul:first li").text(offerMember.accessNumber);
			} else if (offerMember.roleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD&& offerMember.objType==CONST.OBJ_TYPE.PROD) {
				if (offerMember.accessNumber) {
					$("#delPhoneNumber ul:last h5").text(offerMember.roleName);
					var li = $("<li class='full'>").text(offerMember.accessNumber).appendTo($("#delPhoneNumber ul:last"));
					var objId=offerMember.objId;
					var objInstId=offerMember.objInstId;
					var objType=offerMember.objType;
					var offerMemberId=offerMember.offerMemberId;
					var offerRoleId=offerMember.offerRoleId;
                    var accessNumber=offerMember.accessNumber;
					li.attr("del","Y").attr("accessNumber",accessNumber).attr("objId",objId).attr("objInstId",objInstId).attr("objType",objType).attr("offerMemberId",offerMemberId).attr("offerRoleId",offerRoleId);
					$("<span  id='viceCard_"+offerMember.accessNumber+"'></span>").appendTo(li);
					var eleI = $("<i id='plan_no'><a id='' class='purchase' href='javascript:void(0)'>保留>>选择新套餐</a></i>").appendTo(li);
					eleI.click(function(){
						order.service.offerDialog('viceCard_'+offerMember.accessNumber);
					});		
				 }
			}
			 viceCount++;
		});
		if(viceCount>1){
			return true;
		}else{
			return false;
		}
	};
	//选中套餐返回
	var _chooseOfferForMember=function(specId,subpage,specName,offerRoleId){
		OrderInfo.newofferSpecName = specName;
		$("#"+subpage).html("&nbsp;&nbsp;<span style='color: #327501;'>订购新套餐：</span>"+specName);
		$("#"+subpage).parent().attr("addSpecId",specId).attr("addRoleId",offerRoleId).attr("del","N").attr("addSpecName",specName);
		_ischooseOffer=true;
		if(document.getElementById("li_"+subpage)){
			$("#li_"+subpage).css("text-decoration","").attr("del","N").attr("knew","Y");
			$("#li_"+subpage).find("i:first-child").find("a").text("拆副卡");
		}
		
	};
	//主卡拆机副卡新装套餐
	var _removeAndAdd=function(prodStatusCd,boActionType,templateType){
		var viceparam = [];
		$.each($("#delPhoneNumber ul:last li"),function(i, li){//所有副卡信息
				viceparam.push({
					objId : $(this).attr("objId"),
					objInstId : $(this).attr("objInstId"),
					objType : $(this).attr("objType"),
					offerRoleId : $(this).attr("addRoleId"),
					offerSpecId :$(this).attr("addSpecId"),
					offerMemberId:$(this).attr("offerMemberId"),
					accessNumber :$(this).attr("accessNumber"),
					del :$(this).attr("del")
				});
		});
		var inprodStatusCd="";
        var intoprodStatusCd="";
        inprodStatusCd=_choosedProdInfo.prodStateCd;
		intoprodStatusCd=prodStatusCd;
		if(inprodStatusCd==""){
			inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		var param = _getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);
		var submitFlag = (boActionType==CONST.BO_ACTION_TYPE.BUY_BACK?"buyBack":"removeAndRetainVice") ;
		var callParam = {
			boActionTypeCd : boActionType,
			boActionTypeName : CONST.getBoActionTypeName(boActionType),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd : inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:"ADD",
			submitFlag:submitFlag,//"removeAndRetainVice",
			viceParam:viceparam
		};
		OrderInfo.order.templateType=templateType;
		var v_actionFlag = 0 ;
		if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){
			v_actionFlag =20;//OrderInfo.actionFlag
		}
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);
		var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
		if(flag) return;
		//SoOrder.builder();
		
	};
	var _commonShowDialog=function(){
		$("#delPhoneNumber .btna_o:last").click(function(){
			_closeDialog();
		});
		ec.form.dialog.createDialog({
			"id":"-delephone",
			"width":480,
			"height":400,
			"initCallBack":function(dialogForm,dialog){
				order.prodModify.dialogForm=dialogForm;
				order.prodModify.dialog=dialog;
			},
			"submitCallBack":function(dialogForm,dialog){}
		});
	};
	//欠费拆机
	var _showOweRemoveProd = function () {
		OrderInfo.busitypeflag=11;
		/*
		 * 规则后移
		if(_choosedProdInfo.stopRecordCd.indexOf("130000") < 0){
			$.alert("提示","产品必须为\"欠费停机\"时才能欠费拆机","information");
			return;
		}
		*/
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD;
/*		if(lteFlag){
		var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
		if (!flag) return;
		}*/
		if(!query.offer.setOffer()){
			return;
		}
		if(_showMemberWin()){
			$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD)+'-是否保留成员');			
			$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){
				_closeDialog();
				_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8);
			});			
			_commonShowDialog();
		}else{
			_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8);
		}
	};
	
	//拆机
	var _showRemoveProd = function () {
		OrderInfo.busitypeflag=8;
		/*if(_choosedProdInfo.prodStateCd!='100000'){
			$.alert("提示","产品状态为\"在用\"时才能拆机","information");
			return;
		}*/
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.REMOVE_PROD;
/*		if(lteFlag){
			var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
			if (!flag) return;
		}*/
		if(!query.offer.setOffer()){
			return;
		}
		if(_showMemberWin()){
			$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.REMOVE_PROD)+'-是否保留成员');			
			$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){
				_closeDialog();
				_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1);
			});			
			_commonShowDialog();
		}else{
			_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1);
		}
	};
	
	//预拆机
	var _showOrderRemoveProd = function() {
		OrderInfo.busitypeflag=7;
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.PREMOVE_PROD;
/*		if(lteFlag){
			var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
			if (!flag) return;
		}*/
		if(!query.offer.setOffer()){
			return;
		}
		if(_showMemberWin()){
			$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_PROD)+'-是否保留成员');			
			$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){
				_closeDialog();
				_removeAndAdd(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1);
			});			
			_commonShowDialog();
		}else{
			_removeCommit(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1);
		}
	};
	
	//预拆机复机
	var _showCoverOrderRemoveProd = function() {
		OrderInfo.busitypeflag=0;
		/*
		 * 规则后移
		if(_choosedProdInfo.prodStateCd!='120000'){
			$.alert("提示","产品状态为\"拆机\"时才能复机","information");
			return;
		}
		*/
		var inprodStatusCd="";
        var intoprodStatusCd="";
        inprodStatusCd=_choosedProdInfo.prodStateCd;
		intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		if(inprodStatusCd==""){
			inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd : inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:"ADD"
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),"");
		var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
		if (flag) return;
		//SoOrder.builder();
		
	};
	
	//违章拆机
	var _showBreakRuleRemoveProd = function() {
		OrderInfo.busitypeflag=9;
		/*
		 * 规则后移
		if(_choosedProdInfo.prodStateCd!='100000'){
			$.alert("提示","产品状态为\"在用\"时才能拆机","information");
			return;
		}
		*/
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD;
/*		if(lteFlag){
			var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
			if (!flag) return;
		}*/
		if(!query.offer.setOffer()){
			return;
		}
		if(_showMemberWin()){
			$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD)+'-是否保留成员');			
			$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){
				_closeDialog();
				_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1);
			});			
			_commonShowDialog();
		}else{
			_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1);
		}
	};
	//未激活拆机
	var _showNoActiveRemoveProd = function() {
		OrderInfo.busitypeflag=10;
		/*if(_choosedProdInfo.prodStateCd!=CONST.PROD_STATUS_CD.READY_PROD){
			$.alert("提示","产品状态为未激活(预开通)时才能拆机","information");
			return;
		}*/
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD;
		/*if(lteFlag){
		var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
		if (!flag) return;
		}*/
		var inprodStatusCd="";
        var intoprodStatusCd="";
        inprodStatusCd=_choosedProdInfo.prodStateCd;
		intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		if(inprodStatusCd==""){
			inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd : inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:"ADD"
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),"");
		var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
		if (flag) return;
		//SoOrder.builder();
		
	};
	
	//只有订单信息的变更页面公共方法
	var _commonPrepare = function(param) {
		$.callServiceAsHtml(contextPath + "/order/prodModifyCommon", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#ordercon").show();
				$("#ordertabcon").show();
				order.prepare.step(1);
				OrderInfo.order.step=1;//订单备注页面
				$("#orderedprod").hide();
				$("#order_prepare").hide();
				$(".ordercon a:first span").text("取 消");
				$(".main_body").css("height","150px");
				$(".main_body").css("min-height","150px");
				$("#order_confirm").empty();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				if(lteFlag){
					_remark_prodPass();//二次业务产品密码鉴权配置 
					if(OrderInfo.password_remark!=null){
					if((OrderInfo.password_remark).indexOf("'"+OrderInfo.boActionTypeCd+"'") >= 0){
					  $("#orderPassRemarkDiv").show();
					}}
				}
				$("#fillNextStep").unbind("click").bind("click",function(){
					if(param.submitFlag=='removeAndRetainVice'){
						_commitRetainVice(param);
					}else if(param.submitFlag=='buyBack'){
						_commitBuyBack(param);
					}else if(param.submitFlag=='removeProd'){
						order.memberChange.removeAndAdd(param);
					}else{
						_commonSubmit(param.boActionTypeCd,param.prodStatusCd,param.toprodStatusCd,param.itemSpecId,param.state);
					}
					OrderInfo.order.step=2;//订单确认页面
				});
				$("#templateOrderDiv").hide();
				if(param.boActionTypeCd==CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD){
					$("#templateOrderDiv").show();
				}
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	var _commitRetainVice=function(param){
		//alert(param.submitFlag);
		//alert(OrderInfo.offer.offerId);
		OrderInfo.actionFlag=7;
		SoOrder.submitOrder(param.viceParam);
	};
	var _commitBuyBack=function(param){
		OrderInfo.actionFlag=20;
		var params = {viceParam:param.viceParam,remark:$("#order_remark").val()};
		SoOrder.submitOrder(params);
	};
	var _commonSubmit = function(boActionTypeCd,prodStatusCd,toprodStatusCd,itemSpecId,state) {
		//产品密码鉴权
		if(lteFlag){
			if((OrderInfo.password_remark).indexOf("'"+OrderInfo.boActionTypeCd+"'") >= 0){
				if(!_prodPassRemark()){
					return;
				};
			}
		};
		OrderInfo.actionClassCd = CONST.ACTION_CLASS_CD.PROD_ACTION;
		OrderInfo.boActionTypeCd = boActionTypeCd;
		if(_isNullParam(prodStatusCd)){
			prodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		if(_isNullParam(toprodStatusCd)){
			toprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;
		}
		var data = {};
		if(!_isNullParam(prodStatusCd)) {
			if(boActionTypeCd!=null &&boActionTypeCd!=''){
				if(boActionTypeCd!=CONST.BO_ACTION_TYPE.BUY_BACK_CHANGE_CARD && boActionTypeCd!=CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){
					data.boProdStatuses = [{
						//atomActionId : OrderInfo.SEQ.atomActionSeq--,
						prodStatusCd : prodStatusCd,
						state : "DEL"
					},{
						//atomActionId : OrderInfo.SEQ.atomActionSeq--,
						prodStatusCd : toprodStatusCd,
						state : "ADD"
					}
					];
				}
				if(boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){
					data.ooRoles =[{
						objId : OrderInfo.offer.offerMemberInfos[0].objId,
						objInstId : OrderInfo.offer.offerMemberInfos[0].objInstId,
						objType : OrderInfo.offer.offerMemberInfos[0].objType,
						offerRoleId : OrderInfo.offer.offerMemberInfos[0].offerRoleId,
						state : "DEL",
						roleName : OrderInfo.offer.offerMemberInfos[0].roleName
					}];
				}
			}else{
				data.boProdStatuses = [{
					//atomActionId : OrderInfo.SEQ.atomActionSeq--,
					prodStatusCd : prodStatusCd,
					state : "DEL"
				},{
					//atomActionId : OrderInfo.SEQ.atomActionSeq--,
					prodStatusCd : toprodStatusCd,
					state : "ADD"
				}
				];
			}
		}
		if(!_isNullParam(itemSpecId)) {
			data.busiOrderAttrs = [{
				//atomActionId : OrderInfo.SEQ.atomActionSeq--,
				itemSpecId : itemSpecId,
				value : $.trim($("textarea[id^=order_remark]").val())
			}];
		}
		SoOrder.submitOrder(data);
	};
	var _prodPassRemark = function (){
		var param = {};
		param.prodPwd = $.trim($("#remark_password").val());
		if(param.prodPwd==""){
			$.alert("提示","抱歉，您输入的密码不能为空，请重新输入!");
			return false;
		}
		//param.areaId = 21;//TODO need modify
		//param.accessNumber="11969577";;//TODO need modify
		param.accessNumber=order.prodModify.choosedProdInfo.accNbr;
		param.areaId=order.prodModify.choosedProdInfo.areaId;
		var url = contextPath+"/order/prodModify/prodAuth";
		var response = $.callServiceAsJson(url, param, {"before":function(){
			$.ecOverlay("<strong>产品密码鉴权中,请稍等...</strong>");
		}});
		if (response.code != 0||response.data!="true") {
			$.unecOverlay();
			$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
			return false;
		};
		$.unecOverlay();
		return true;
	};
	
	function _gotoOrderModify(response){
		var content$ = $("#order_fill_content");
		content$.html(response.data).show();
		
		$(".main_div .h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
		
		$("#ordercon").show();
		$("#ordertabcon").show();
		order.prepare.step(1);
		$("#orderedprod").hide();
		$("#order_prepare").hide();
		$(".ordercon a:first span").text("取 消");
		$(".main_body").css("height","150px");
		$(".main_body").css("min-height","150px");
		$("#order_confirm").empty();
		$("#fillLastStep").click(function(){
			order.prodModify.cancel();
		});
		/*
		$("#fillNextStep").unbind("click").bind("click",function(){
			_commonSubmit(param.boActionTypeCd,param.prodStatusCd,param.itemSpecId,param.state);
		});
		*/
		
	}
	
	//修改产品实例属性:修改使用人
	var _spec_parm_user_change = function(){
		var valid = false;
		if(OrderInfo.cust && OrderInfo.cust.custId && OrderInfo.cust.custId != '-1'){ //老客户
			valid = OrderInfo.cust.segmentId == '1000'; //政企客户
		}
		if(!valid){
			$.alert('提示', '非政企客户不能办理修改使用人业务');
			return;
		}
		
		OrderInfo.busitypeflag=4;
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PRODUCT_PARMS,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		//OrderInfo.actionFlag=33;//改产品属性
		rule.rule.prepare(param,'order.prodModify.spec_parm_user_show',callParam);
	};
	
	//产品实例属性:使用人-展示
	var _spec_parm_user_show = function(){
		var param={
				prodInstId:_choosedProdInfo.prodInstId,
				offerSpecId:_choosedProdInfo.prodOfferId,
				prodSpecId:_choosedProdInfo.productId,
				partyId:OrderInfo.cust.custId,
				acctNbr:_choosedProdInfo.accNbr,
				areaId:_choosedProdInfo.areaId
		};
		$.callServiceAsHtmlGet(contextPath + "/order/orderSpecParamUserChange",param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response && response.code == -2){
					return ;
				}
				if(response && response.data){
					if(response.data==0||response.data==1){
						$.alert("提示","该产品无使用人产品实例属性！");
					}else if(response.data==-1){
						$.alert("提示","产品实例属性加载异常！");
					}else{
						//$("#"+param.ul_id).append(response.data);
						_gotoOrderModify(response);		
					}
				}else{
					$.alert("提示","产品实例属性加载异常");
				}
			}
		});	
		
	};
	
	//修改产品实例属性
	var _spec_parm_change= function(){	
		OrderInfo.busitypeflag=4;
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PRODUCT_PARMS,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		//OrderInfo.actionFlag=33;//改产品属性
		var checkRule = rule.rule.prepare(param,'order.prodModify.spec_parm_show',callParam);
	};
	//产品实例属性-展示
	var _spec_parm_show = function(){
		var param={
				prodInstId:_choosedProdInfo.prodInstId,
				offerSpecId:_choosedProdInfo.prodOfferId,
				prodSpecId:_choosedProdInfo.productId,
				partyId:OrderInfo.cust.custId,
				acctNbr:_choosedProdInfo.accNbr,
				areaId:_choosedProdInfo.areaId
		};
		$.callServiceAsHtmlGet(contextPath + "/order/orderSpecParamChange",param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response && response.code == -2){
					return ;
				}
				if(response && response.data){
					if(response.data==0||response.data==1){
						$.alert("提示","该产品无产品实例属性！");
					}else if(response.data==-1){
						$.alert("提示","产品实例属性加载异常！");
					}else{
						//$("#"+param.ul_id).append(response.data);
						_gotoOrderModify(response);		
					}
				}else{
					$.alert("提示","产品实例属性加载异常");
				}
			}
		});	
		
	};
	
	//修改产品密码 
	var _showPasswordChange = function () {
		OrderInfo.busitypeflag=17;
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		OrderInfo.actionFlag=31;//改产品密码
		var checkRule = rule.rule.prepare(param,'order.prodModify.spec_password_change',callParam);
	};
	//修改产品密码
	var _spec_password_change= function(){
		var param={"accNbr":_choosedProdInfo.accNbr};
		$.callServiceAsHtmlGet(contextPath + "/order/orderPasswordChange",param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				_gotoOrderModify(response);
				$('#password_form').bind('formIsValid',_spec_password_change_check).ketchup({bindElement:"btsubmit"});
			}
		});	
	};
	//产品密码修改-鉴权
	function _spec_password_change_check(){
		//SoOrder.builder();
		//SoOrder.builder(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD);
		if("none"!=$("#li_password_old").css("display")){
			if(!$("#password_old").val()){
				$.alert("操作提示","请输入 原产品密码");
				return ;
			}
		}
		if(!$("#password_change1").val()){
			$.alert("操作提示","请输入 产品密码");	
			return ;
		}else if(!$("#password_change2").val()){
			$.alert("操作提示","请输入 确认密码");	
			return ;
		}else if($("#password_change1").val()!=$("#password_change2").val()){
			$.alert("操作提示","两次密码不一致");	
			return ;
		}
		var reg = new RegExp("^([0-9]{6})$");//6位纯数字 0~9
		if(!reg.test($("#password_change1").val())){
			$.alert("提示","密码包含非数字或长度不是6位！");
			return;
		}
		var param = {
				password_old:$("#password_old").val(),
				accessNumber:_choosedProdInfo.accNbr,
				areaId:_choosedProdInfo.areaId
		} ;
		$.callServiceAsHtml(contextPath+"/order/orderPasswordCheck",param,{
			"before":function(){
				$.ecOverlay("<strong>正在提交中,请稍等...</strong>");
			},"done" : function(response){
				if(response && response.code == -2){
					return ;
				}
				var data = eval("(" + response.data + ")");
				//alert("--"+data.successed);
				if(data.successed==true||data.successed=="true"){
					_spec_password_change_save();
				}else{
					$.alert("密码校验失败",data.data);
					$.unecOverlay();
					return;
				}
			}
		});
	}
	//产品密码修改-提交
	function _spec_password_change_save(){
		var boProdPasswords = new Array();
		var boProdPasswords_del = {
				prodId : _choosedProdInfo.prodInstId, //从页面头部div获取
				prodPwTypeCd : "2", //密码类型
				pwd : $("#password_old").val(), //密码
				state : "DEL"  //动作
			};
		var boProdPasswords_add = {
				prodId : _choosedProdInfo.prodInstId, //从页面头部div获取
				prodPwTypeCd : "2", //密码类型
				pwd : $("#password_change1").val(), //密码
				state : "ADD"  //动作
			};
		boProdPasswords.push(boProdPasswords_del);
		boProdPasswords.push(boProdPasswords_add);
		var data = {boProdPasswords:boProdPasswords} ;
		OrderInfo.actionFlag=31;//改产品密码
		SoOrder.submitOrder(data);
		
	}
	
	
	//密码重置 校验
	var _showPasswordReset = function () {
		OrderInfo.busitypeflag=0;
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		OrderInfo.actionFlag=32;//重置产品密码
		var checkRule = rule.rule.prepare(param,'order.prodModify.spec_password_reset',callParam);
	};
	//密码重置 修改
	var _spec_password_reset= function(){
		$.callServiceAsHtmlGet(contextPath + "/order/orderPasswordReset",null, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				_gotoOrderModify(response);
				//$('#password_form').bind('formIsValid').ketchup();
				$('#password_form').bind('formIsValid',_spec_password_reset_save).ketchup({bindElement:"btsubmit"});
			}
		});	
	};
	//密码重置 保存
	function _spec_password_reset_save(){
		/*
		if(!$("#password_change1").val()){
			$.alert("操作提示","请输入 产品密码");
			return ;
		}else if(!$("#password_change2").val()){
			$.alert("操作提示","请输入 确认密码");	
			return ;
		}else if($("#password_change1").val()!=$("#password_change2").val()){
			$.alert("操作提示","两次密码不一致");	
			return ;
		}
		*/
		
		var boProdPasswords = new Array();
		var boProdPasswords_del = {
				prodId : _choosedProdInfo.prodInstId, //从页面头部div获取
				prodPwTypeCd : "2", //密码类型
				pwd : "", //密码
				state : "DEL"  //动作
			};
		var boProdPasswords_add = {
				prodId : _choosedProdInfo.prodInstId, //从页面头部div获取
				prodPwTypeCd : "2", //密码类型
				pwd : "111111",//$("#password_change1").val(), //密码
				state : "ADD"  //动作
			};
		boProdPasswords.push(boProdPasswords_del);
		boProdPasswords.push(boProdPasswords_add);
		var data = {boProdPasswords:boProdPasswords} ;
		OrderInfo.actionFlag=32;//重置产品密码
		SoOrder.submitOrder(data);
	}
	
	//修改短号：校验
	function _shortnum_change(){
		//SoOrder.builder();
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PRODUCT_PARMS,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		OrderInfo.actionFlag=34;//修改短号
		var checkRule = rule.rule.prepare(param,'order.prodModify.shortnum_show',callParam);
	}
	//修改短号--展示
	function _shortnum_show(id){
		var param={"prodId":_choosedProdInfo.prodInstId,acctNbr:_choosedProdInfo.accNbr};
		$.callServiceAsHtmlGet(contextPath + "/order/orderShortnumChange",param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response && response.code == -2){
					return ;
				}
				if(response && response.data){
					if(response.data==0){
						$.alert("提示","该产品无短号信息！");
					}else if(response.data==-1){
						$.alert("提示","加载短号信息异常！");
					}else{
						_gotoOrderModify(response);		
					}
				}else{
					$.alert("提示","短号加载异常");
				}
			}
		});	
	}
	function _shortnum_change_val(obj){
		if($(obj).attr("checkSta")=="2"&&$(obj).val()!=$(obj).attr("changeval")){
			$(obj).attr("checkSta","0");
		}
		/*
		var shortnum_sel = $("#shortnum_sel").val();
		var id = $("#ul_"+shortnum_sel).attr("t_id");
		var shortnum_val = $("#"+id).val() ;
		if($("#"+id).attr("checkSta")=="2"&&shortnum_val!=$("#"+id).attr("changeval")){
			$("#"+id).attr("checkSta","0");
		}
		*/
	}
	function _shortnum_check(){
		var shortnum_sel = $("#shortnum_sel").val();
		var id = $("#ul_"+shortnum_sel).attr("t_id");
		var shortnum_val = $("#"+id).val() ;
		var reg = new RegExp("^[0-9]*$");
		if(null==shortnum_val||""==shortnum_val){
			$.alert("提示","请输入新的短号");
			return;
		}else if(shortnum_val==$("#"+id).attr("oldval")){
			$.alert("提示","短号未修改，请修改后再校验");
			return ;
		}else if(!reg.test(shortnum_val)){
			$.alert("提示", "短号只能为数字，请重新输入！");
			return;
		}else if(shortnum_val==$("#"+id).attr("changeval")){
			if($("#"+id).attr("checkSta")=="2"){
				$.alert("提示", "短号已校验成功，可以使用！");
				return;
			}else if($("#"+id).attr("checkSta")=="1"){
				$.alert("提示", "短号未通过校验，请修改再试！");
				return;
			}
		}
		var param = {
				groupNbr:$("#"+id).attr("groupNbr"),//"18900000000",//
				extProdId:$("#"+id).attr("extProdId"),//"255",//
				productNbr:"",
				accNbr:_choosedProdInfo.accNbr,//18108880390,//
				extPordInstId:$("#"+id).attr("extPordInstId"),
				groupShortNbr:shortnum_val,
				lanId:$("#"+id).attr("lanId"),//"8320100",//
				checkNbr:$("#"+id).attr("changeval")
			};
		var url = contextPath+"/order/checkReleaseShortNum";
		$.callServiceAsJson(url,param,{
			"before":function(){
				$.ecOverlay("<strong>短号校验中,请稍等...</strong>");
			},"always":function(){
				$.unecOverlay();
			},"done" : function(response){
				$("#"+id).attr("changeval",shortnum_val);
				if (response.code == 0) {
					$("#"+id).attr("checkSta","2");
					$("#uimCheck").removeClass().addClass("order_check");
					$.alert("提示",response.data);
					return ;
				}else{
					$("#"+id).attr("checkSta","1");
					$.alert("提示",response.data);
					$("#uimCheck").removeClass().addClass("order_check_error");
					return ;
				}
			},"fail":function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
				return ;
			}
		});	
	}
	
	//修改短号--提交
	function _shortnum_save(){
		var shortnum_sel = $("#shortnum_sel").val();
		var id = $("#ul_"+shortnum_sel).attr("t_id");
		var shortnum_val = $("#"+id).val() ;
		if(shortnum_val==$("#"+id).attr("oldval")){
			$.alert("提示","短号未修改，请修改并校验");
			return;
		}else if($("#"+id).attr("checkSta")=="0"){
			$.alert("提示","短号未校验，请校验后再提交！");
			return ;
		}else if($("#"+id).attr("checkSta")=="1"){
			$.alert("提示","短号未通过校验，请修改再试！");
			return ;
		}
		//SoOrder.builder(CONST.ACTION_CLASS_CD.SHORTNUM_ACTION,CONST.BO_ACTION_TYPE.SHORT_NUM);
		
		//OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");
		//SoOrder.builder();
		var boProdCompItems = new Array();
		var boProdCompItems_row = {itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"DEL",value:$("#"+id).attr("oldval")} ;
		boProdCompItems.push(boProdCompItems_row);
		boProdCompItems_row = {itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"ADD",value:$("#"+id).val()} ;
		boProdCompItems.push(boProdCompItems_row);
		var boProdCompOrders_row = {"prodCompRelaRoleCd":$("#"+id).attr("prodCompRelaRoleCd"),"compProdId":$("#"+id).attr("compProdId"),"prodCompId":$("#"+id).attr("prodCompId")} ;
		var boProdCompOrders = new Array();
		boProdCompOrders.push(boProdCompOrders_row);
		var data = {boProdCompItems:boProdCompItems,boProdCompOrders:boProdCompOrders} ;
		//alert(JSON.stringify(data));
		//return ;
		OrderInfo.actionFlag=34;//修改短号
		SoOrder.submitOrder(data);
		
	}
	
	
	
	var _isNullParam = function(data){
		return data == undefined || !data;
	};
	
	//补换卡
	var _changeCard = function(param){
		//SoOrder.builder();
		
		$.callServiceAsHtml(contextPath+"/order/changeCard", param, {
			"before":function(){
			},
			"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$(".ordercon").show();
				$(".ordertabcon").show();
				$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
				order.prepare.step(1);
				$("#orderedprod").hide();
				$("#order_prepare").hide();
			},
			"always":function(){
				$.unecOverlay();
			}
		});
		
	};	
	
	var compspecGrps = "";
	var getCompInfo = function(compspecparam){
		var grprlue = ""
		var returndata = $.callServiceAsJson(contextPath+"/order/compPspecGrps", compspecparam, {});
		if(returndata.code == 0){
			if(returndata.data.length!=0){
				grprlue = returndata.data;
				compspecGrps = grprlue;//compspecGrps 其他地方用，弹窗显示的角色分类。grprlue 判断存不存在角色
			}
			return grprlue;
		}else if(returndata.code == -2){
			$.alertM(returndata.data);
			return "";
		}else{
			$.alert("提示","该产品不是组合产品，请重新选择！");
			return "";
		}
	};
	var _addComp = function(param){
		
		OrderInfo.initData("","",12,"纳入成员");
		SoOrder.builder();
		var compparam ={};
		$.callServiceAsHtml(contextPath+"/order/addComp", compparam, {
			"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$(".ordercon").show();
				$(".ordertabcon").show();
				order.prepare.step(1);
				$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
				$("#orderedprod").hide();
				$("#order_prepare").hide();
			},
			"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	//退出群组
	var _removeComp = function(param){
		
		OrderInfo.initData("","",12,"退出成员");
		SoOrder.builder();
		var compparam ={};
		$.callServiceAsHtml(contextPath+"/order/removeComp", compparam, {
			"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
				$(".ordercon").show();
				$(".ordertabcon").show();
				order.prepare.step(1);
				$("#orderedprod").hide();
				$("#order_prepare").hide();
			},
			"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	//查询群组的账号
	var _queryRomveAcc = function(){
		var prodnum = $.trim($("#removeAcc").val());
		if(prodnum==""){
			$.alert("提示","请输入需要查询的接入号！");
			return;
		}else{
			var params = {
				"compProdId":_choosedProdInfo.prodInstId,
				"accessNumber":prodnum
			};
		}
		var removephones = getChoosedMenbr();
		if(removephones.length!=0){
			for(var i=0;i<removephones.length;i++){
				if(prodnum==removephones[i]){
					$.alert("提示","该号码已经在待退出成员中，请重新选择！");
					return;
				}
			}
		}
		var url = contextPath+"/order/queryCompmenber";
		$.callServiceAsJson(url,params, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"done" : function(response){
				if (response.code == 0) {
					var compProdMemberInfos = response.data;
					if(compProdMemberInfos.length>0){
						var prodmenber = compProdMemberInfos[0];
						var addnbrhtml="<li id='li_"+prodmenber.accessNumber+"' prodInstId='"+prodmenber.prodId+"' phonenumber='"+prodmenber.accessNumber+"' prodCompRelaRoleCd='"+prodmenber.prodCompRelaRoleCd+
						"' prodCompRelaRoleName='"+prodmenber.prodCompRelaRoleName+"' prodCompId='"+prodmenber.prodCompId+"'>"+
						"<dd class='delete' onclick='order.prodModify.removeCompDelSelect(this);'></dd><span id='addNbr'>"+prodmenber.accessNumber+"</span>";
						$("#choosed_menbers").append(addnbrhtml);
					}else{
						$.alert("提示","该号不在群组成员中，请重新选择！");
						return;
					}
				}else if(response.code == -2){
					$.alertM(response.data);
				}else{
					$.alert("提示",response.data);
					return;
				}
			},
			"always":function(){
				$.unecOverlay();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","套餐加载失败，请稍后再试！");
			}
		});		
	};
	
	//可选包订购退订
	var _orderAttachOffer = function () {
		OrderInfo.busitypeflag=14;
		AttachOffer.init();
	};
	
	//套餐变更
	var _changeOffer = function () {
		OrderInfo.busitypeflag=2;
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldAddNumList = [];
		offerChange.init();
	};
	
	//改付费帐户规则校验
	var _showChangeAccount = function(){
		OrderInfo.busitypeflag=16;
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,_choosedProdInfo.prodInstId);
		var callParam = {
				boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,
				boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),
				accessNumber : _choosedProdInfo.accNbr,
				prodOfferName : _choosedProdInfo.prodOfferName
			};
		var flag = rule.rule.prepare(param,'order.prodModify.changeAccount',callParam);
		if (flag) return;
		//SoOrder.builder();
	};
	
	//获取产品原帐户信息并转至改付费帐户页面
	var _changeAccount = function(){
		if(!_choosedProdInfo.prodInstId || !_choosedProdInfo.accNbr){
			$.alert("提示","产品信息定位异常，请联系管理员");
			$("#orderedprod").show();
			$("#order_prepare").show();
			$("#order_tab_panel_content").show();
			$("#order_confirm").show();
			$("#order_fill_content").hide();
			order.prepare.hideStep();
			return;
		}
		var param = {
			prodId : _choosedProdInfo.prodInstId,
			acctNbr : _choosedProdInfo.accNbr,
			areaId : _choosedProdInfo.areaId
		};
		$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo", param, {
			"before":function(){
				$.ecOverlay("<strong>正在确认当前产品帐户,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(jr){
				if(jr.code != 0||jr.data.length==0) {
					if(jr.code==-2){
						$.alertM(jr.data);
					}
					else{
						$.alert("提示","当前产品帐户定位失败，请联系管理员");
					}
					$("#orderedprod").show();
					$("#order_prepare").show();
					$("#order_tab_panel_content").show();
					$("#order_confirm").show();
					$("#order_fill_content").hide();
					order.prepare.hideStep();
					return;
				}				
				var prodAcctInfos = jr.data;
				$.callServiceAsHtml(contextPath+"/order/preChangeAccount", prodAcctInfos, {
					"before":function(){
						$.ecOverlay("<strong>当前产品帐户已确认</strong>");
					},
					"always":function(){
						$.unecOverlay();
					},
					"done":function(response){
						if(!response){
							 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';
						}
						if(response.code != 0) {
							$.alert("提示","查询失败,请稍后重试");
							return;
						}											
						$("#order_fill_content").html(response.data).show();
						$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
						$("#origAccts option:first").attr("selected", "selected");
						//获取账单投递信息主数据				
						acct.acctModify.getBILL_POST();
					},
					fail:function(response){
						$.unecOverlay();
						$.alert("提示","请求可能发生异常，请稍后再试！");
					}
				});
			}
		});
	};
	
	//产品下原有付费帐户展示（弹出框）
	var _showOrigAccts = function(){
		easyDialog.open({
			container : "origAcctDialog"
		});
		$("#origAcctClose").click(function(){
			easyDialog.close();
		});
	};
		
	//查询帐户信息并选择新的付费帐户（弹出框）
	var _chooseAcct = function() {
		$("#chooseQueryAcctType").find("option[value=1]").attr("selected","selected");
		$("#d_query_nbr").show();
//		$("#d_query_pwd").show();
		easyDialog.open({
			container : "queryAcctDialog"
		});
		$("#chooseQueryAcctType").change(function(){
			if($("#chooseQueryAcctType").val()==1){
				$("#d_query_cd").hide();
				$("#d_query_nbr").show();
//				$("#d_query_pwd").show();
			}
			else{				
				$("#d_query_nbr").hide();
				$("#d_query_pwd").hide();
				$("#d_query_cd").show();
			}
		});
		$("#queryAcctClose").click(function(){
			$("#acctListTab tbody").empty();
			$("#d_query_cd").hide();
			$("#d_query_nbr").hide();
//			$("#d_query_pwd").hide();
			easyDialog.close();
		});
	};
			
	//查询帐户,显示查询结果，记录选择的帐户信息
	var newAcctList = [];
	var _queryAccount = function(acctSelect){
		//根据接入号查询帐户
		var response;
		if($("#chooseQueryAcctType").val()==1){
			if(!CONST.LTE_PHONE_HEAD.test($.trim($("#d_query_nbr input").val()))){					
				$.alert("提示", "请输入有效的中国电信手机号");					
				return;				
			}
//			var param = {
//					accessNumber : $("#d_query_nbr input").val(),
//					prodPwd : $("#d_query_pwd input").val()
//			};
			//根据接入号查询帐户需先经过产品密码鉴权
//			var jr = $.callServiceAsJson(contextPath+"/order/prodAuth", param);
//			if(jr.code==0){
				var acctQueryParam = {
					accessNumber : $("#d_query_nbr input").val()
				};
				response = order.prodModify.returnAccount(acctQueryParam);		
//			}
//			else{
//				$.alert("提示",jr.data);
//			}
		}
		//根据合同号查询帐户
		else{
			var acctQueryParam = {
					acctCd : $("#d_query_cd input").val()
			};
			response = order.prodModify.returnAccount(acctQueryParam);
		}		
		$("#acctListTab tbody").empty();
		if(response.code==0){
			var returnMap = response.data;
			if(returnMap.resultCode==0){
				if(returnMap.accountInfos && returnMap.accountInfos.length>0){
					var accountInfos = returnMap.accountInfos;
					$.each(accountInfos, function(i, accountInfo){					
						var tr = $("<tr></tr>").appendTo($("#acctListTab tbody"));
						if(accountInfo.name){
							$("<td class='teleNum'>"+accountInfo.name+"</td>").appendTo(tr);
						}
						else{
							$("<td></td>").appendTo(tr);
						}
						if(accountInfo.acctId){
							$("<td acctId='"+accountInfo.acctId+"'>"+accountInfo.accountNumber+"</td>").appendTo(tr);
						}
						else{
							$("<td></td>").appendTo(tr);
						}
						if(accountInfo.owner){
							$("<td>"+accountInfo.owner+"</td>").appendTo(tr);
						}
						else{
							$("<td></td>").appendTo(tr);
						}
						if(accountInfo.accessNumber){
							$("<td>"+accountInfo.accessNumber+"</td>").appendTo(tr);
						}
						else{
							$("<td></td>").appendTo(tr);
						}
						tr.click(function(){
							var newAccount = {
									acctCd : accountInfo.accountNumber,
									acctId : accountInfo.acctId,
									acctRelaTypeCd : "1",
									chargeItemCd : 1,               //账目项标识，暂固定为1，表示支付所有账目项
									percent : "100",                //支付比重，该账目项占该产品的价格比重，与上一个属性相匹配，暂固定为100
									priority : "1",                 //支付优先级，暂固定为1，表示最高优先级
									prodAcctId : "-1",              //标识产品与帐户的支付匹配关系，新选的帐户和该产品无匹配关系，默认 -1
									state : "ADD"
							};
							newAcctList.push(newAccount);
							
							$("#acctListTab tbody").empty();
							$("#d_query_cd").hide();
							$("#d_query_nbr").hide();
							$("#d_query_pwd").hide();
							$("#defineNewAcct").hide();
							easyDialog.close();
							var found = false;
							$.each($(acctSelect).find("option"), function(i, option){
								if($(option).val()==accountInfo.acctId){
									found = true;
									return false;
								}								
							});
							if(found==false){										
								$("<option>").text(accountInfo.name+" : "+accountInfo.accountNumber).attr("value", accountInfo.acctId).appendTo($(acctSelect));
							}
							$(acctSelect).find("option[value=default]").remove();
							$(acctSelect).find("option[value="+accountInfo.acctId+"]").attr("selected","selected");
						});
					});			
				}
				else{
					$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"));
				}	
			}
			else{
				$("<tr><td colspan=4>"+returnMap.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"));
			}
		}
		else{
			$("<tr><td colspan=4>"+response.data+"</td></tr>").appendTo($("#acctListTab tbody"));
		}
	};
	
	//帐户查询请求（二次业务时查询已有帐户）
	var _returnAccount = function(acctQueryParam){
		acctQueryParam.areaId =  _choosedProdInfo.areaId;
		acctQueryParam.isServiceOpen="Y";   //是否能力开放,Y-是,N-否
		var response = $.callServiceAsJson(contextPath+"/token/pc/order/account", acctQueryParam);
		if(response.code==-2){
			$.alertM(response.data);
			return;
		}
		return response;
	};
	
	//新建帐户
	var _createAcct = function(){
		var newAccount = {
				acctCd : -1,
				acctId : -1,
				acctRelaTypeCd : "1",
				chargeItemCd : 1,               //账目项标识，暂固定为1，表示支付所有账目项
				percent : "100",                //支付比重，该账目项占该产品的价格比重，与上一个属性相匹配，暂固定为100
				priority : "1",                 //支付优先级，暂固定为1，表示最高优先级
				prodAcctId : "-1",              //标识产品与帐户的支付匹配关系，新选的帐户和该产品无匹配关系，默认 -1
				state : "ADD"
		};
		newAcctList.push(newAccount);
		$("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>").appendTo($("#newAccts"));
		$("#newAccts").find("option[value=default]").remove();
		$("#newAccts").find("option[value=-1]").attr("selected","selected");
		$("#acctName").val(OrderInfo.cust.partyName);//默认帐户名称为客户名称
		$("#newAccts").parent().find("a:eq(1)").hide();
		//新增帐户自定义支付属性
		$("#defineNewAcct").show();
		acct.acctModify.ifCanAdjustBankPayment();//查询工号权限：能否选择银行托收
		acct.acctModify.paymentType();
		acct.acctModify.billPostType();
	};
	
	//切换新付费帐户
	var _ifNewAcct = function(acctSelect){
		if($(acctSelect).val()<0){
			$("#defineNewAcct").show();
		}
		else{
			$("#defineNewAcct").hide();
		}
	};

	//改付费帐户提交（下一步）
	var _changeAccountSave = function(){
		
		//帐户信息校验
		if($("#newAccts").val()=="default"){
			$.alert("提示","请选择新帐户");
			return;
		}		
		//新建帐户支付信息与投递信息填写校验
		if($("#newAccts").val()<0){
			//帐户信息填写校验
			if(!SoOrder.checkAcctInfo()){
				return;
			}
		}

		var repick = false;
		var origAccts = $("#origAccts").find("option");
		$.each(origAccts, function(i, origAcct){
			if($("#newAccts").val()==$(origAcct).val()){
				repick = true;
				return false;
			}
		});
		if(repick==false){
			
			var delAcctId = $("#origAccts").val();
			var origAcct = $("#origAcctList tbody").find("tr[id="+delAcctId+"]");							
			
			var _acctCd = $(origAcct).find("td:eq(4)").text();					
			var _acctId = $(origAcct).find("td:eq(0)").text();					
			var _chargeItemCd = $(origAcct).find("td:eq(2)").text();					
			var _percent = $(origAcct).find("td:eq(7)").text();					
			var _priority = $(origAcct).find("td:eq(8)").text();
			if(_priority==""){
				_priority = 1;
			}
			var _prodAcctId = $(origAcct).find("td:eq(1)").text();	
			
			var origAcctInfo = {							
					acctCd : _acctCd,							
					acctId : _acctId,							
					acctRelaTypeCd : "1",							
					chargeItemCd : _chargeItemCd,				
					percent : _percent,							
					priority : _priority,							
					prodAcctId : _prodAcctId,						
					state : "DEL"					
			};
				
			var newAcctInfo;
			$.each(newAcctList, function(i, newAccount){
				if(newAccount.acctId==$("#newAccts").val()){
					newAcctInfo = newAccount;
					return false;
				}
			});
			
			var _boAccountRelas = [];
			_boAccountRelas.push(origAcctInfo);
			_boAccountRelas.push(newAcctInfo);
		
			var _busiOrderAttrs = [];
			var remark = $("#orderRemark").val();		
			_busiOrderAttrs.push({
				itemSpecId : "111111118",
				value : remark
			});
		
			var data = {
					boAccountRelas : _boAccountRelas,
					busiOrderAttrs : _busiOrderAttrs
			};
			//更换的帐户为新建帐户
			if($("#newAccts").val()==-1){
				OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,10,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");
				var busiOrder = [];
				//新建帐户节点
				OrderInfo.createAcct(busiOrder, -1);
				//更改帐户节点
				var acctChangeNode = {
						areaId : _choosedProdInfo.areaId,
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq-- 
						}, 
						busiObj : {
							accessNumber: _choosedProdInfo.accNbr,
                            instId: _choosedProdInfo.prodInstId,
                            isComp: "N",
                            objId: _choosedProdInfo.productId,
                            offerTypeCd: "1"
						},  
						boActionType : {
							actionClassCd : 1300,
							boActionTypeCd : "-6"
						}, 
						data : data
				};
				busiOrder.push(acctChangeNode);
				
				SoOrder.submitOrder(busiOrder);
			}
			//更换的帐户为已有帐户
			else{
				OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");
				SoOrder.submitOrder(data);
			}			
		}
		else{
			$.alert("提示","该帐户已经是付费帐户了，请重新选择");
			return;
		}		
	};
	
	//退出二次业务
	var _cancel = function() {
		$.confirm("信息","确定取消当前操作吗？",{
		yes:function(){		
			OrderInfo.resetChooseUserInfo();
			//退出二次业务时释放被预占的UIM卡
			var boProd2Tds = OrderInfo.boProd2Tds;
			if(boProd2Tds.length>0){
				for(var n=0;n<boProd2Tds.length;n++){
					var param = {
							numType : 2,
							numValue : boProd2Tds[n].terminalCode
					};
					$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
				}
			}
			//退出二次业务时释放被预占的号码（过滤身份证预占的号码）
			var boProdAns = OrderInfo.boProdAns;
			if(boProdAns.length>0){
				for(var n=0;n<boProdAns.length;n++){
					if(boProdAns[n].idFlag){
						continue;
					}
					var param = {
							numType : 1,
							numValue : boProdAns[n].accessNumber
					};
					$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
				}
				order.service.boProdAn = {};
				order.phoneNumber.resetBoProdAn();
			}			
			//页面变动
			$("#order_fill_content").empty();
			OrderInfo.order.step=0;//订单初始页面
			order.prepare.hideStep();
			$("#orderedprod").show();
			$("#order_prepare").show();
		},no:function(){
			
		}},"question");
	};
	
	//加入组合入参
	var compparam = "";
	var _queryCustProd = function(){
		var hasmeneber = false;
		var prodnum = $.trim($("#prodnbr").val());
		if(prodnum==""){
			$.alert("提示","请输入需要查询的接入号！");
			return;
		}else{
			hasmeneber = isExist(prodnum);
		}
		if(hasmeneber.flag){
			if(hasmeneber.data=="1"){
				var param = {};
				var prodnum = $.trim($("#prodnbr").val());
				param.acctNbr=prodnum;
				var url = contextPath+"/cust/queryprodbynbr";
			}else{
				$.alert("提示","该产品已经在组合中，请重新选择！");
				return;
			}
		}else{
			return;
		}
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>';
				}
				if(response.code == -2){
					return;
				}else if(response.code != 0) {
					$.alert("提示","客户查询失败,稍后重试");
					return;
				}
				var content$=$("#prodinst");
				content$.html(response.data);
			}
		});	
	};
	
	var _compChangeTab = function(num){
		if(num == 1){
			$("#tab_1").addClass("setcon");
			$("#tab_2").removeClass("setcon");
			$("#addCompPage").show();
			$("#releaseShortNum").hide();
			$("#compopr").show();
		}else{
			$("#tab_2").addClass("setcon");
			$("#tab_1").removeClass("setcon");
			$("#addCompPage").hide();
			$("#releaseShortNum").show();
			$("#compopr").hide();
		}
	};
	
	var _addToComp = function(obj){
		var phonenumber = $(obj).parent().parent().children(":first-child").next().text();
		var productId = $(obj).parent().parent().children(":last-child").text();
		var prodInstId = $(obj).parent().parent().children().eq(-2).text();
		var prodStateCd = $(obj).parent().parent().children().eq(-3).text();
		var linum = $("#choosed_menbers li").length;
		if(linum>12){
			$.alert("提示","已经超过了加入的最大数量！");
			return;
		}
		if(prodStateCd!="100000"){
			$.alert("提示","该产品状态不符，不能纳入成员！");
			return;
		}
		var addphones = getChoosedMenbr();
		if(addphones.length!=0){
			for(var i=0;i<addphones.length;i++){
				if(phonenumber==addphones[i]){
					$.alert("提示","该号码已经在待纳入成员中，请重新选择！");
					return;
				}
			}
		}
		ec.form.dialog.createDialog({
			"id":"-grps",
			"initCallBack":function(dialogForm,dialog){
				var compdata = compspecGrps;
				var compPspecCompGrp2Pspecs = compspecGrps[0].compPspecCompGrp2Pspecs;//成员角色
				var compPspecCompGrpRelas = compspecGrps[0].compPspecCompGrpRelas;//子组角色
				if(compPspecCompGrpRelas==undefined){
					compPspecCompGrpRelas = [];
				}
				var zNodes=[];
				var menber=[];
				for(var i=0;i<compPspecCompGrp2Pspecs.length;i++){
					var grpspec = {
						name:compPspecCompGrp2Pspecs[i].prodSpecName,
						prodCompRelaRoleCd:compPspecCompGrp2Pspecs[i].prodCompRelaRoleCd,
						prodCompRelaRoleName:compPspecCompGrp2Pspecs[i].prodCompRelaRoleName,
						prodSpecId:compPspecCompGrp2Pspecs[i].prodSpecId
					};
					menber.push(grpspec);
				}
				var childmenber = [];
				for(var i=0;i<compPspecCompGrpRelas.length;i++){
					var compPspecCompGrpRelasSpecs = compPspecCompGrpRelas[i];
					var childSpec = [];
					for(var j=0;j<compPspecCompGrpRelasSpecs.length;j++){
						var grpspec = {
							name:compPspecCompGrpRelasSpecs[j].prodSpecName,
							prodCompRelaRoleCd:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleCd,
							prodCompRelaRoleName:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleName,
							prodSpecId:compPspecCompGrpRelasSpecs[j].prodSpecId
						};
						childSpec.push(grpspec);
					}
					var childrole = {
						name:compPspecCompGrpRelasSpecs[i].compPspecCompGrpName,
						children:childSpec
					}
					childmenber.push(childrole);
				}
				var setting = {	
					data: {
						key: {
							title:"t"
						},
						simpleData: {
							enable: true
						}
					},
					callback: {
						onClick: onClick
					}
				};
				if(compPspecCompGrp2Pspecs.length!=0){
					var node = {
						name:"成员",
						open:true,
						children:menber
					};
					zNodes.push(node);
				}
				if(compPspecCompGrpRelas.length!=0){
					var node = {
						name:"子组",
						children:childmenber
					};
					zNodes.push(node);
				}
				if(compPspecCompGrp2Pspecs.length==0&&compPspecCompGrpRelas.length==0){
					$.alert("提示","该产品没有成员规则，请重新选择群组产品！");
					return;
				}
				var prodCompRelaRoleCd="";
				var prodCompRelaRoleName="";
				function onClick(event, treeId, treeNode, clickFlag) {
					prodCompRelaRoleCd="";
					prodCompRelaRoleName="";
					var prodSpecId = treeNode.prodSpecId;
					if(prodSpecId==productId){//不同产品只能加入到指定类别下
						prodCompRelaRoleCd=treeNode.prodCompRelaRoleCd;
						prodCompRelaRoleName=treeNode.prodCompRelaRoleName;
					}else{
						$.alert("提示","不能加入该角色，请重新选择！");
					}
				}	
				$.fn.zTree.init($("#rluename"), setting, zNodes);
				
				$("#nextstep").click(function(){
					if(prodCompRelaRoleCd!=""&&prodCompRelaRoleName!=""){
						$("#dialogtitle").html('设置短号');
						var shortnumhtml = "短号设置：<input type='text' id='shortnumtext' class='inputWidth183px'/>";
						$("#rluename").html('').html(shortnumhtml);
						$("#nextstep").hide();
						$("#submitbtn2").show();
					}else{
						$.alert("提示","请选择所需纳入的成员！");
						return;
					}
				});
				$("#submitbtn2").click(function(){
					var shortnum = $("#shortnumtext").val();
					var reg = new RegExp("^[0-9]*$");
					if(shortnum==''){
						$("#errinfo").html("对不起，请输入短号！");
						return;
					}
				    if(!reg.test(shortnum)){
				    	$("#errinfo").html("短号只能为数字，请重新输入！");
						return;
				    }
				    var param = {
				    	groupNbr:_choosedProdInfo.accNbr,
						extProdId:_choosedProdInfo.productId,
						productNbr:"",
						accNbr:phonenumber,
						extPordInstId:_choosedProdInfo.prodInstId,
						shortNbr:shortnum,
						statusCd:"1102"
					};
					var url = contextPath+"/order/checkGroupShortNum";
					var res = $.callServiceAsJson(url,param,{});	
					if (res.code == 0) {
						var addnbrhtml="<li id='li_"+phonenumber+"' prodInstId='"+prodInstId+"' phonenumber='"+phonenumber+"' prodCompRelaRoleCd='"+prodCompRelaRoleCd+
						"' prodCompRelaRoleName='"+prodCompRelaRoleName+"' productId='"+productId+"' style='width:280px;'>" +
						"<dd class='delete' onclick='order.prodModify.addCompDelSelect(this);'></dd>"+
						"<span id='addNbr' style='display:inline;padding:0 5px 0 22px;'>"+phonenumber+"</span>"+
						"<span style='display:inline;padding:0px;'>[短号：</span><span style='display:inline;padding:0px;' id='shortNumber'>"+shortnum+
						"</span><span class='modshortnum' onclick='order.prodModify.changeShortNum(this);' style='display:inline;padding:0 25px 0 20px;'></span>"+
						"<span style='display:inline;padding:0px;'>]</span>";
						$("#choosed_menbers").append(addnbrhtml);
						dialogForm.close(dialog);
					}else if(res.code == -2){
						$.alertM(res.data);
					}else{
						$.alert("提示",res.data);
					}
				});
			},
			"submitCallBack":function(dialogForm,dialog){},
			width:400,height:150
		});
	};
	
	var getChoosedMenbr = function(){
		var numbers = [];
		$("#choosed_menbers li").each(function(){
			var phonenum= $(this).children('span#addNbr').text();
			numbers.push(phonenum);
		});
		return numbers;
	};
	
	var boolHasShortNum = function(){
		var hasshrot = true;
		$("#choosed_menbers li").each(function(){
			var phonenum= $(this).children('span#shortNumber').text();
			if(phonenum==""){
				hasshrot = false;
			}
		});
		return hasshrot;
	};
	
	var _changeShortNum =function(obj){
		var phonenum = $(obj).parent().children('span#addNbr').text();
		var shortnum = $(obj).parent().children('span#shortNumber').text();
		ec.form.dialog.createDialog({
			"id":"-shrotnum",
			"initCallBack":function(dialogForm,dialog){
				$("#shortnumval").val(shortnum);
				$("#submitbtn3").click(function(){
					shortnum = $(obj).parent().children('span#shortNumber').text();
					var newshortnum = $("#shortnumval").val();
					if(shortnum==newshortnum){
						dialogForm.close(dialog);
					}
					if(shortnum==""&&newshortnum!=""){
						var result = getOprShortNumInfo(phonenum,newshortnum,"1102");
						if(result.code==0){
							$("#li_"+phonenum).children('span#shortNumber').html(newshortnum);
						}else if(result.code==-2){
							$.alertM(result.data);
							return;
						}else{
							$.alert("提示","短号预占失败！");
							return;
						}
						dialogForm.close(dialog);
					}
					if(shortnum!=""&&newshortnum==""){
						$.alert("提示","请输入短号！");
						return;
					}
					if(shortnum!=""&&newshortnum!=""){
						var resultremove = getOprShortNumInfo(phonenum,shortnum,"1000");
						if(resultremove.code==0){
							$("#li_"+phonenum).children('span#shortNumber').html('');
						}else if(resultremove.code==-2){
							$.alertM(resultremove.data);
							return;
						}else{
							$.alert("提示","短号预占失败！");
							return;
						}
						var resultadd = getOprShortNumInfo(phonenum,newshortnum,"1102");
						if(resultadd.code==0){
							$("#li_"+phonenum).children('span#shortNumber').html(newshortnum);
						}else if(resultadd.code==-2){
							$.alertM(resultadd.data);
							return;
						}else{
							$.alert("提示","预占失败！");
							return;
						}
						dialogForm.close(dialog);
					}
				});
			},
			"submitCallBack":function(dialogForm,dialog){},
			width:350,height:100
		});
	};
	
	var getOprShortNumInfo = function(accNbr,shortNbr,statusCd){
		var param = {
			groupNbr:_choosedProdInfo.accNbr,
			extProdId:_choosedProdInfo.productId,
			productNbr:"",
			accNbr:accNbr,
			extPordInstId:_choosedProdInfo.prodInstId,
			shortNbr:shortNbr,
			statusCd:statusCd
		};
		var url = contextPath+"/order/checkGroupShortNum";
		var res = $.callServiceAsJson(url,param,{});
		return res;
	};
	
	var _releaseShortNum = function(){
		var shortNbr = $("#resshortnum").val();
		var param = {
			groupNbr:_choosedProdInfo.accNbr,
			extProdId:_choosedProdInfo.productId,
			productNbr:"",
			accNbr:"",
			extPordInstId:_choosedProdInfo.prodInstId,
			shortNbr:shortNbr,
			statusCd:"1000"
		};
		var url = contextPath+"/order/checkGroupShortNum";
		var res = $.callServiceAsJson(url,param,{});
		if(res.code==0){
			$.alert("提示","短号释放成功！");
			$("#choosed_menbers li").each(function(){
				var shortNum= $(this).children('span#shortNumber').text();
				if(shortNbr==shortNum){
					$(this).children('span#shortNumber').html('');
				}
			});
		}else if(res.code==-2){
			$.alertM(res.data);
			return;
		}else{
			$.alert("提示",res.data);
		}
	};
	
	var canAddAnother = function(){
		var phonelist = $("#choosed_menbers").html();
		phonelist = phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");
		if(phonelist!=''){
			var lastspan = $("#choosed_menbers").children(':last-child').children('span').length;
			if(lastspan<2){
				return false;
			}else{
				return true;
			}
		}else{
			return true;	
		}
	};
	
	var isExist = function(prodnum){
		var params = {
			"compProdId":_choosedProdInfo.prodInstId,
			"accessNumber":prodnum
		};
		var url = contextPath+"/order/queryCompmenber";
		var returndata = {};
		var isexist = $.callServiceAsJson(url,params, {});
		if (isexist.code == 0) {
			returndata.flag = true;
			var compProdMemberInfos = isexist.data;
			if(compProdMemberInfos.length>0){
				returndata.data="0";//表示在群组里面
			}else{
				returndata.data="1";//表示不在群组里面
			}
			return returndata;
		}else if(isexist.code == -2){
			$.alertM(returndata.data);
			returndata.flag = false;
		}else{
			returndata.flag = false;
			$.alert("提示",isexist.data);
			return returndata;
		}
	};
	
	var _addCompSubmit = function(){
		var phonelist = $("#choosed_menbers").html();
		phonelist = phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");
		if(phonelist==""){
			$.alert("提示","请选择纳入组合的成员！");
			return;
		}
		var boolshort = boolHasShortNum();
		if(!boolshort){
			$.alert("提示","待加入成员未全部设置短号，请全部设置好后再提交！");
			return;
		}
		var busiOrder = [];
		var addMenbers = [];
		var prodCompId = -1;
		$("#choosed_menbers li").each(function(){
			var prodInstId = $(this).attr('prodInstId');
			var phonenumber = $(this).attr('phonenumber');
			var prodCompRelaRoleCd = $(this).attr('prodCompRelaRoleCd');
			var prodCompRelaRoleName = $(this).attr('prodCompRelaRoleName');
			var productId = $(this).attr('productId');
			var shortnum =$(this).children('span#shortNumber').text();
			addMenbers.push(phonenumber);
			var compparam = {
				"busiOrderInfo": {
					"seq": OrderInfo.SEQ.seq--
		        },
		        "busiObj": {
			        "objId": CONST.PROD_SPEC.CDMA,
			        "instId": prodInstId,
			        "accessNumber": phonenumber
		        },
	            "boActionType": {
	                "actionClassCd": CONST.ACTION_CLASS_CD.PROD_ACTION,
	                "boActionTypeCd": CONST.BO_ACTION_TYPE.ADD_COMP
	            },
	            "areaId": OrderInfo.staff.areaId,
	            "aggreementId": "",
	            "data": {
	            	"boProdCompOrders": [{
	            		"prodCompRelaRoleCd": prodCompRelaRoleCd,
	                    "prodCompRelaRoleName": prodCompRelaRoleName,
	                    "prodCompId": prodCompId,
	                    "compProdId": _choosedProdInfo.prodInstId
	                }],
	                "boProdCompRelas": [{
	                	"prodCompId": prodCompId,
	                    "state": "ADD",
	                    "atomActionId":OrderInfo.SEQ.atomActionSeq--
	                }],
	                "boProdSpecs": [{
	                	"prodSpecId": productId,
	                    "atomActionId": OrderInfo.SEQ.atomActionSeq--,
	                    "state": "KIP"
	                }],
	                "boProdCompItems":[{
	        			"itemSpecId": "37906",
	        			"name": "",
	        			"prodCompId": prodCompId,
	        			"state": "ADD",
	        			"value": shortnum,
	        			"atomActionId":OrderInfo.SEQ.atomActionSeq--
	        		}],
	        		"busiOrderAttrs":[{
	        			itemSpecId:"111111111",
	        			value:$("#orderRemark").val()
	        		}]
	            }
	        };
			busiOrder.push(compparam);
			prodCompId--;
		});
		OrderInfo.confirmList = [];
		var comfimProdInfo = {
			name:_choosedProdInfo.productName,
			accNbr : [_choosedProdInfo.accNbr]
		};
		OrderInfo.confirmList.push(comfimProdInfo);
		var comfimMeneber = {
			name:"纳入成员",
			accNbr : addMenbers
		};
		OrderInfo.confirmList.push(comfimMeneber);
		SoOrder.submitOrder(busiOrder);
	};
	
	var _removeCompSubmit = function(){
		var t = $("#choosed_menbers").html();
        t = t.replace(/[\r\n]/g,"").replace(/[ ]/g,"");
		if(t==""){
			$.alert("提示","请选择退出组合的成员！");
			return;
		}
		var busiOrder = [];
		var addMenbers = [];
		$("#choosed_menbers li").each(function(){
			var prodInstId = $(this).attr('prodInstId');
			var phonenumber = $(this).attr('phonenumber');
			var prodCompRelaRoleCd = $(this).attr('prodCompRelaRoleCd');
			var prodCompRelaRoleName = $(this).attr('prodCompRelaRoleName');
			var prodCompId = $(this).attr('prodCompId');
			addMenbers.push(phonenumber);
			var compparam = {
				"busiOrderInfo": {
					"seq": -1
				},
			    "busiObj": {
				    "objId": CONST.PROD_SPEC.CDMA,
				    "instId": prodInstId,
				    "accessNumber": phonenumber
			    },
		        "boActionType": {
		            "actionClassCd": CONST.ACTION_CLASS_CD.PROD_ACTION,
		            "boActionTypeCd": CONST.BO_ACTION_TYPE.ADD_COMP
		        },
		        "areaId": OrderInfo.staff.areaId,
		        "aggreementId": "",
		        "data": {
		        	"boProdCompOrders": [{
		            	"prodCompRelaRoleCd": prodCompRelaRoleCd,
		                "prodCompRelaRoleName": prodCompRelaRoleName,
		                "prodCompId": prodCompId,
		                "compProdId": _choosedProdInfo.prodInstId
		            }],
		            "boProdCompRelas": [{
		                "prodCompId": prodCompId,
		                "state": "DEL"
		            }],
		        	"busiOrderAttrs":[{
		    			itemSpecId:"111111111",
		    			value:$("#orderRemark").val()
		    		}]
		        }
			};
			busiOrder.push(compparam);
		});
		OrderInfo.confirmList=[];
		var comfimProdInfo = {
			name:_choosedProdInfo.productName,
			accNbr : [_choosedProdInfo.accNbr]
		};
		OrderInfo.confirmList.push(comfimProdInfo);
		var comfimMeneber = {
			name:"退出成员",
			accNbr : addMenbers
		};
		OrderInfo.confirmList.push(comfimMeneber);
		SoOrder.submitOrder(busiOrder);
	};
	
	var _removeCompDelSelect = function(obj){
		$.confirm("确认","确定要取消该号码吗?",{ 
			yes:function(){
				var accNbr = $(obj).next().text();
				$("#li_"+accNbr).remove();
			},
			no:function(){						
			}
		});
	};
	
	var _addCompDelSelect = function(obj){
		$.confirm("确认","确定要取消该号码吗?",{ 
			yes:function(){
				var accNbr = $(obj).parent().children('span#addNbr').text();
				var shortnum =$(obj).parent().children('span#shortNumber').text();
				if(shortnum!=""){
					var param = {
						groupNbr:_choosedProdInfo.accNbr,
						extProdId:_choosedProdInfo.productId,
						productNbr:"",
						accNbr:accNbr,
						extPordInstId:_choosedProdInfo.prodInstId,
						shortNbr:shortnum,
						statusCd:"1000"
					};
					var url = contextPath+"/order/checkGroupShortNum";
					var response = $.callServiceAsJson(url,param,{});
					if(response.code==0){
						$("#li_"+accNbr).remove();
					}else if(response.code==-2){
						$.alertM(response.data);
					}else{
						alert("删除失败");
					}
				}else{
					$("#li_"+accNbr).remove();
				}
				
			},
			no:function(){						
			}
		});
	};

	//返销
	var _showBuyBack = function () {
		if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){
			$.alert("提示","停机产品不允许受理！");
			return;
		}
		OrderInfo.busitypeflag=0;
		var queryParam = {
				objInstId : _choosedProdInfo.prodInstId,
				queryType : "1",
				areaId : OrderInfo.staff.areaId
		};
		var url = contextPath+"/order/queryOrderItemDetailForResale";
		$.callServiceAsHtmlGet(url,queryParam,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response||response.code != 0){
					 response.data='查询失败,稍后重试';
				}
				var objList =  eval('('+response.data+')');
				if(objList.data ==null){
					$.alert("提示","无法返销，不符合可以返销的规则，上一次购物车操作不是新装、订购合约或者补换卡中的一种。");
					return;
				}
				//动作类型1 新装，S1订购销售品,14补换卡 （返销优先级 新装返销-订购销售品返销-补换卡返销）
				for(var i=0;i<objList.data.length;i++){
					if(objList.data[i].boActionTypeCd == CONST.BO_ACTION_TYPE.NEW_PROD){
						boActionTypeCd = CONST.BO_ACTION_TYPE.BUY_BACK;
						OrderInfo.boRelas = [{
							relaTypeCd : CONST.RELATYPECD,
							relaBoId : objList.data[i].orderItemId
					    }];
						OrderInfo.orderItemCd =objList.data[i].orderItemCd;
						OrderInfo.buyBack_orderItemObjId = objList.data[i].orderItemObjId;
						OrderInfo.buyBack_orderItemObjInstId = objList.data[i].orderItemObjInstId;
						break;
					}
				}
				if(boActionTypeCd != CONST.BO_ACTION_TYPE.BUY_BACK){
				    for(var i=0;i<objList.data.length;i++){
					    if(objList.data[i].boActionTypeCd == CONST.BO_ACTION_TYPE.BUY_OFFER){
						    boActionTypeCd = CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT;
						    OrderInfo.boRelas = [{
							    relaTypeCd : CONST.RELATYPECD,
								relaBoId : objList.data[i].orderItemId
						    }];
						    OrderInfo.orderItemCd =objList.data[i].orderItemCd;
						    OrderInfo.buyBack_orderItemObjId = objList.data[i].orderItemObjId;
						    OrderInfo.buyBack_orderItemObjInstId = objList.data[i].orderItemObjInstId;
						    break;
					    }else if(objList.data[i].boActionTypeCd == CONST.BO_ACTION_TYPE.CHANGE_CARD){
						    boActionTypeCd = CONST.BO_ACTION_TYPE.BUY_BACK_CHANGE_CARD;
						    OrderInfo.boRelas = [{
								relaTypeCd : CONST.RELATYPECD,
								relaBoId : objList.data[i].orderItemId
						    }];
						    OrderInfo.orderItemCd =objList.data[i].orderItemCd;
						    OrderInfo.buyBack_orderItemObjId = objList.data[i].orderItemObjId;
						    OrderInfo.buyBack_orderItemObjInstId = objList.data[i].orderItemObjInstId;
					    }else {
						    $.alert("提示","当前业务动作类型【"+objList.data[i].boActionTypeCd +"】不能返销！");
						    return;
					    }
				    }
				}
				var param = _getCallRuleParam(boActionTypeCd,_choosedProdInfo.prodInstId);
				var callParam = {
					boActionTypeCd : boActionTypeCd,
					boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BUY_BACK),
					accessNumber : _choosedProdInfo.accNbr,
					prodOfferName : _choosedProdInfo.prodOfferName
				};
				var checkRule = rule.rule.prepare(param,'order.prodModify.showBuyBackDo',callParam);
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	
	//返销
	var _showBuyBackDo = function () {
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;// 产品状态,REMOVE_PROD		
        var orderItemId ="";
/*		if(lteFlag){
			var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
			if (!flag) return;
		}*/

		if(!query.offer.setOffer()){
			return;
		}
		_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,boActionTypeCd,1);

	};
	var _setCoupon = function (coupon) {
		_coupon = coupon;
	};
	//客户属性-展示 更多按钮
	var _btnMoreProfile=function(){
		if($("#modPartyProfile").is(":hidden")){
			$("#modPartyProfile").show();
			$("#proarroworder").removeClass();
			$("#proarroworder").addClass("arrowup");
			order.prodModify.changeLabel(0);
		}else{
			$("#modPartyProfile").hide();
			$("#proarroworder").removeClass();
			$("#proarroworder").addClass("arrow");
			$("#modTabProfile0").attr("click","1");
			$("#contactName").attr("data-validate","");
			_form_custInfomodify_btn();
		}
		/*$("#orderbutton").off("click").on("click",function(event){_btnQueryPhoneNumber();event.stopPropagation();});*/
	};
	//切换标签
	var _changeLabel = function(labelId){
		if($("#partyProfile").is(":visible")==false){
			$("#partyProfile").show();
		}
		if(labelId=="0"){
			$("#modTabProfile0").show();
			$("#cardtab_mod_0").addClass("setcon");
			$("#modTabProfile0").attr("click","0");
			$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(keyup)");
			_form_custInfomodify_btn();
		}else if(($("#modTabProfile0").attr("click")=="0")&&($("#contactName").val()=="")){
			$.alert("提示","联系人名称不能为空！","information");
			return;
		}
		for ( var i = 0; i < order.prodModify.profileTabLists.length; i++) {
			var profileTabLists = order.prodModify.profileTabLists[i];
			var tabProfileNum=profileTabLists.tabProfileNum;
			var partyProfileCatgTypeCd=profileTabLists.partyProfileCatgTypeCd;
			if(labelId==partyProfileCatgTypeCd){
				$("#"+tabProfileNum).show();
				$("#cardtab_mod_"+partyProfileCatgTypeCd).addClass("setcon");
				$("#modTabProfile0").hide();
				$("#cardtab_mod_0").removeClass("setcon");
			}else{
				$("#"+tabProfileNum).hide();
				$("#cardtab_mod_"+partyProfileCatgTypeCd).removeClass("setcon");
			}
		}
		
	};

	var _checkProPSW=function(psw){
		$("#"+psw).blur();
	};
	
	//一卡双号订购显示
	var _showNumberOrder = function () {
		if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){
			$.alert("提示","停机产品不允许受理！");
			return;
		}
		var param = {
			mainAccNbr : _choosedProdInfo.accNbr,
			areaId : _choosedProdInfo.areaId
		};
		//规则校验入参
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER,
			instId : _choosedProdInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : _choosedProdInfo.prodInstId
		}];
		if(!rule.rule.ruleCheck(boInfos)){ //规则校验失败
			return;
		}
		$.callServiceAsHtml(contextPath + "/order/cardNumberOrder", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#ordercon").show();
				$("#ordertabcon").show();
				order.prepare.step(1);
				OrderInfo.order.step=1;//订单备注页面
				$("#orderedprod").hide();
				$("#order_prepare").hide();
				$(".ordercon a:first span").text("取 消");
				$(".main_body").css("height","150px");
				$(".main_body").css("min-height","150px");
				$("#order_confirm").empty();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
                
				$("#queryAccNbrList").unbind("click").bind("click",function(){
					var param = {
					    areaId : $("#areaId").val(),
					    scene: "ADD", 
					    preHandle: "C", 
					    mainAccNbr: $("#mainAccNbr").val(),
					    virtualAreaId: $("#p_areaId").val(),
					    soChannelId: OrderInfo.staff.channelId
					};
					$.callServiceAsHtml(contextPath+"/order/queryAccNbrList",param,{
						"before":function(){
							$.ecOverlay("虚号号码查询中，请稍等...");
						},
						"always":function(){
							$.unecOverlay();
						},
						"done" : function(response){
							order.prepare.step(2);
							OrderInfo.order.step=2;//订单确认页面
							$("#order_fill_content").hide();
							var content$ = $("#order_confirm");
							content$.html(response.data).show();
							OrderInfo.actionFlag = 36;
							OrderInfo.orderAccNbr = _choosedProdInfo.accNbr;
							order.dealer.initDealer();
						},
						fail:function(response){
							$.unecOverlay();
							$.alert("提示","请求可能发生异常，请稍后再试！");
						}
					});
				});
			},"always":function(){
				$.unecOverlay();
			}
		});
	
	};
	//订购一卡双号
	var _orderAccNbr = function () {
		var virtualAccNbr = $("input[name='virtualAccNbr']:checked").val();
		if(virtualAccNbr==null ||virtualAccNbr==""||virtualAccNbr==undefined){
			$.alert("提示","请选择一个虚号号码！");
			return;
		};
		var mainAccNbr = $("#mainAccNbr").val();
		var param ={
		    areaId: $("#areaId").val(),
		    virtualAreaId: $("#virtualAreaId").val(),
			scene: "ADD",
			preHandle: "F",
			extCustOrderId: $("#extCustOrderId").val(),
			mainAccNbr: mainAccNbr,
			virtualAccNbr: virtualAccNbr,
			pageType:"orderAccNber",
			busiOrderAttrs:[]
		};
		//发展人
		var $tr = $("tr[name='tr_"+mainAccNbr+"']");
		if($tr!=undefined){
			$tr.each(function(){   //遍历产品有几个发展人
				var dealer = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
					role : $(this).find("select").val(),
					value : $(this).find("input").attr("staffid"),
					channelNbr : $(this).find("select[name ='dealerChannel_"+mainAccNbr+"']").val()
				};
				param.busiOrderAttrs.push(dealer);
				var dealer_name = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("value") 
				};
				param.busiOrderAttrs.push(dealer_name);	
			});
		}
		_exchangeAccNbr(param);
	};
	
	//一卡双号退订显示
	var _showNumberUnOrder = function () {
		if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){
			$.alert("提示","停机产品不允许受理！");
			return;
		}
		var param = {
			mainAccNbr : _choosedProdInfo.accNbr,
			areaId : _choosedProdInfo.areaId
		};
		//规则校验入参
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER,
			instId : _choosedProdInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : _choosedProdInfo.prodInstId
		}];
		if(!rule.rule.ruleCheck(boInfos)){ //规则校验失败
			return;
		}
		$.callServiceAsHtml(contextPath + "/order/queryVirtualInfo", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#ordercon").show();
				$("#ordertabcon").show();
				order.prepare.step(2);
				OrderInfo.order.step=2;
				$("#orderedprod").hide();
				$("#order_prepare").hide();
				$(".ordercon a:first span").text("取 消");
				$(".main_body").css("height","150px");
				$(".main_body").css("min-height","150px");
				$("#order_confirm").empty();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});

				$("#undoAccNbr").unbind("click").bind("click",function(){
					var param = {
						areaId: $("#areaId").val(),
					    scene: "DEL",
						preHandle: "C",
						extCustOrderId: $("#extCustOrderId").val(),
						mainAccNbr: $("#mainAccNbr").val(),
						virtualAreaId: $("#virtualAreaId").val(),
						virtualAccNbr: $("#virtualAccNbr").val(),
						pageType:"unOrderAccNber"
					};
					_exchangeAccNbr(param);
				});
			},"always":function(){
				$.unecOverlay();
			}
		});
	
	};
	
	//一卡双号订购退订正式单接口
	var _exchangeAccNbr = function (param) {
		$.callServiceAsHtml(contextPath+"/order/exchangeAccNbr",param,{
			"before":function(){
				$.ecOverlay("订单确认中，请稍等...");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				order.prepare.step(3);
				OrderInfo.order.step=3;
				$("#order_fill_content").hide();
				var content$ = $("#order_confirm");
				content$.html(response.data).show();
				$("#successTip_dialog_cnt").off("click").on("click",function(event){order.calcharge.backToEntr();});
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	var _chooseAccNbrArea = function(){
		order.area.chooseAreaTreeQueryManger("javascript:order.prodModify.showNumberOrder()","p_areaId_val","p_areaId",3);
	};
	
	return {
		changeCard : _changeCard,
		getChooseProdInfo : _getChooseProdInfo,
		lossRepProd : _lossRepProd,
		lossRepProdSubmit : _lossRepProdSubmit,
		choosedProdInfo : _choosedProdInfo,
		showLossRepProd : _showLossRepProd,
		showLossRepProdReg : _showLossRepProdReg,
		showStopKeepNumProd : _showStopKeepNumProd,
		showStopKeepNumProdReg :_showStopKeepNumProdReg,
		showCustInfoModify : _showCustInfoModify,
		custInfoModify : _custInfoModify,
		commonPrepare : _commonPrepare,
		showOweRemoveProd:_showOweRemoveProd,
		showRemoveProd : _showRemoveProd,
		showOrderRemoveProd : _showOrderRemoveProd,
		showCoverOrderRemoveProd : _showCoverOrderRemoveProd,
		showBreakRuleRemoveProd : _showBreakRuleRemoveProd,
		showNoActiveRemoveProd:_showNoActiveRemoveProd,
		spec_parm_change : _spec_parm_change,
		showChangeCard : _showChangeCard,
		spec_password_change : _spec_password_change,
		spec_password_change_save : _spec_password_change_save,
		showPasswordChange : _showPasswordChange,
		spec_password_change_check : _spec_password_change_check,
		getCallRuleParam : _getCallRuleParam,
		cancel : _cancel,
		orderAttachOffer : _orderAttachOffer,
		changeOffer		: _changeOffer,
		shortnum_change:_shortnum_change,
		shortnum_show:_shortnum_show,
		shortnum_save:_shortnum_save,
		spec_parm_show:_spec_parm_show,
		showAddComp : _showAddComp,
		addComp :_addComp,
		addToComp:_addToComp,
		compChangeTab:_compChangeTab,
		queryCustProd : _queryCustProd,
		addCompSubmit : _addCompSubmit,
		spec_parm_show:_spec_parm_show,
		showChangeAccount : _showChangeAccount,
		changeAccount : _changeAccount,
		showOrigAccts : _showOrigAccts,
		chooseAcct : _chooseAcct,
		queryAccount : _queryAccount,
		returnAccount : _returnAccount,
		createAcct : _createAcct,
		ifNewAcct : _ifNewAcct,
		changeAccountSave  :_changeAccountSave,
		showRemoveComp:_showRemoveComp,
		removeComp:_removeComp,
		profiles :_profiles,
		profileTabLists :_profileTabLists,
		partyTypeCdChoose:_partyTypeCdChoose,
		identidiesTypeCdChoose :_identidiesTypeCdChoose,
		removeCompSubmit :_removeCompSubmit,
		showPasswordReset:_showPasswordReset,
		spec_password_reset:_spec_password_reset,
		spec_password_reset_save:_spec_password_reset_save,
		queryRomveAcc:_queryRomveAcc,
		removeCompDelSelect:_removeCompDelSelect,
		addCompDelSelect:_addCompDelSelect,
		chooseOfferForMember:_chooseOfferForMember,
		shortnum_check:_shortnum_check,
		shortnum_change_val:_shortnum_change_val,
		changeShortNum:_changeShortNum,
		releaseShortNum:_releaseShortNum,
		showActiveReturn :_showActiveReturn,
		showBuyBack:_showBuyBack,
		showBuyBackDo:_showBuyBackDo,
		setCoupon:_setCoupon,
		lteFlag :lteFlag,
		btnMoreProfile :_btnMoreProfile,
		changeLabel : _changeLabel,
		remark_prodPass :_remark_prodPass,
		checkProPSW  :_checkProPSW,
		showNumberOrder :_showNumberOrder,
		orderAccNbr :_orderAccNbr,
		showNumberUnOrder:_showNumberUnOrder,
		exchangeAccNbr:_exchangeAccNbr,
		chooseAccNbrArea:_chooseAccNbrArea,
		spec_parm_user_change : _spec_parm_user_change,
		spec_parm_user_show : _spec_parm_user_show
	};
})();
/**
 * 订单准备
 * 
 * @author tang
 */
CommonUtils.regNamespace("order", "prepare");
/**
 * 订单准备
 */
order.prepare = (function(){
	//三个入口选择
	var _tabChange= function(){
		$("#order_quick_nav li").each(function(){$(this).off("click").on("click",function(event){
			OrderInfo.actionFlag= 1;
			var url=$(this).attr("url");
			var forTab = $(this).attr("for");
			if(forTab == "order_tab_panel_phonenumber"){
				var custId = OrderInfo.cust.custId;
				if(OrderInfo.cust==undefined || custId==undefined || custId==""){
					$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");
					return;
				}
			}
			_commonTab(url,forTab);
			event.stopPropagation();});});
		$("#order_nav li").each(function(){$(this).off("click").on("click",function(event){
			OrderInfo.actionFlag= 1;
			var url=$(this).attr("url");
			var forTab = $(this).attr("for");
			if(forTab == "order_tab_panel_phonenumber"){
				var custId = OrderInfo.cust.custId;
				if(OrderInfo.cust==undefined || custId==undefined || custId==""){
					$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");
					return;
				}
			}
			_commonTab(url,forTab);
			event.stopPropagation();});});
		//异地业务隐藏三个入口
		var diffPlaceFlag = $("#diffPlaceFlag").val();
		if (diffPlaceFlag == "diff") {
			$("#order_prepare").hide();
			$("#nothreelinks").show();
		}
		
		//如果有资源ID，则跳转到终端详情
		var mktResCd$ = $("#mktResHidId").attr("mktResCd");
		var offerSpecId$ = $("#offerSpecHidId").val();
		if (mktResCd$ && mktResCd$.length > 0) {
			var url = contextPath+"/mktRes/terminal/prepare";
			var param={};
			var response = $.callServiceAsHtmlGet(url,param);
			var content$=$("#order_tab_panel_content");
			content$.html(response.data);
			mktRes.terminal.selectTerminal($("#mktResHidId"));
			$("#order_prepare").hide();
			order.prepare.step(1);//显示"第一步：订单准备"
			_showOrderTitle("", "购手机", true);
			content$.show();
		}else if (offerSpecId$ && offerSpecId$.length > 0) {
			var url = contextPath+"/order/prodoffer/prepare";
			var param={"prodOfferId":offerSpecId$};
			var response = $.callServiceAsHtmlGet(url,param);
			var content$=$("#order_tab_panel_content");
			content$.html(response.data);
			$("#order_prepare").hide();
			order.prepare.step(1);//显示"第一步：订单准备"
			_showOrderTitle("", "办套餐", true);
			content$.show();
			order.service.initSpec();
			order.prodOffer.init();
		}
	};
	var _commonTab=function(url,forTab){
		var param={};
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>';
				}
				if(response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				if(order.cust.orderBtnflag=="1"){
					order.cust.btnQueryCustProdMore();
				};
				main.home.hideMainIco();
				$("#order_prepare").hide();
				$("#order_fill_content").hide();
				$("#orderedprod").hide();
				order.prepare.step(1);//显示"第一步：订单准备"
				var content$=$("#order_tab_panel_content");
				content$.html(response.data).show();
				if (forTab == "order_tab_panel_terminal") {
					_showOrderTitle("", "购手机", true);
					order.service.releaseFlag = 1;
					order.prepare.createorderlonger();
					OrderInfo.busitypeflag=1;
					mktRes.terminal.queryApConfig();
					mktRes.terminal.initInParam('', '', '', '', '');
					mktRes.terminal.btnQueryTerminal(1);
				}else if(forTab == "order_tab_panel_phonenumber"){
					_showOrderTitle("", "选号码", true);
					order.service.releaseFlag = 1;
					order.prepare.createorderlonger();
					OrderInfo.busitypeflag=1;
					order.phoneNumber.initPhonenumber();
				}else if(forTab == "order_tab_panel_offer"){
					_showOrderTitle("", "办套餐", true);
					//判断是否直接进入新装套餐入口
					if(order.service.releaseFlag==0){
						order.service.releaseFlag = 2;
					}
					order.prepare.createorderlonger();
					OrderInfo.busitypeflag=1;
					order.service.initSpec();
					order.prodOffer.init();
					order.service.searchPack();
					order.phoneNumber.resetBoProdAn();
				}
			}
		});	
	};
	//弹出选择号码窗口
	//subPage入口:终端入口，号码入口，订单填写入口:terminal\offer\number
	//subnum订单序号：O1、O2区分暂存单允许多个订单的情况
	//subFlag选号类型：新装主卡选号、新装副卡选号 Y1、Y2
	var _phoneNumDialog=function(subPage,subFlag,subnum){
		var position=["15%"];
		if ($.browser.mozilla) {
			position=["15%"];
		}
		ec.form.dialog.createDialog({
				"id":"-phonenumber",
				"width":970,
				"height":440,
				"position":position,
				"initCallBack":function(dialogForm,dialog){
					var param={"subPage":subPage};
					var url=contextPath+"/token/pc/mktRes/phonenumber/prepare";
					$.callServiceAsHtmlGet(url,param,{
						"before":function(){
							$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
						},
						"always":function(){
							$.unecOverlay();
						},
						"done" : function(response){
							if(!response){
								 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>';
							}
							if(response.code != 0) {
								$.alert("提示","查询失败,稍后重试");
								return;
							}
							order.phoneNumber.dialogForm=dialogForm;
							order.phoneNumber.dialog=dialog;
							var content$=$("#phonenumberContent");
							content$.html(response.data);
							$("#subPage").val(subPage);
							$("#subFlag").val(subFlag);
							$("#subnum").val(subnum);
							order.phoneNumber.initPhonenumber();
						}
					});	
				 },
				"submitCallBack":function(dialogForm,dialog){}
		});
	};
	/**
	 * uim卡号释放
	 */
	var _releaseUIM=function(subPage,subflag,subnum){
		if(_checkIsable(subflag,subnum)){
			return;
		}
		var cardNo=$.trim($("#uim_"+subnum).val());
		if(cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return;
		}
		param = {"oldInstCode":cardNo,"phoneNum":""};
		var url = contextPath+"/mktRes/uim/checkUim";
		$.callServiceAsJson(url,param,{
			"before":function(){
				$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>");
			},"always":function(){
				$.unecOverlay();
			},"done" : function(response){
				if (response.code == 0) {
					$.alert("提示","UIM卡释放成功!");
					$("#uim_btn_"+subnum).attr('unable','false');
					$("#uim_btn_"+subnum).removeClass("disablepurchase").addClass("purchase");
					$("#uimrelease_btn_"+subnum).attr('unable','true');
					$("#uimrelease_btn_"+subnum).removeClass("purchase").addClass("disablepurchase");
					$("#uim_"+subnum).removeAttr("disabled");
					$("#uim_"+subnum).val("");
					//alert(JSON.stringify(OrderInfo.boProd2Tds));
					//alert(JSON.stringify(OrderInfo.bo2Coupons));
					for(var i=0;i<OrderInfo.boProd2Tds.length;i++){
						if(OrderInfo.boProd2Tds[i].prodId==subnum){
							OrderInfo.boProd2Tds.splice(i,1);
						}
					}
					for(var i=0;i<OrderInfo.bo2Coupons.length;i++){
						if(OrderInfo.bo2Coupons[i].prodId==subnum){
							var coupons=OrderInfo.bo2Coupons[i].coupons;
							if(coupons.length>0){//节点的物品里面已经有数据
								for(var j=0;j<coupons.length;j++){
									if(coupons[j].couponInstanceNumber==cardNo){//之前已经有对应的UIM的物品，替换掉
										OrderInfo.bo2Coupons[i].coupons.splice(j,1);
										sonExist=true;
										break;
									}
								}
							}else{
								OrderInfo.bo2Coupons[i].coupons=[];
							}
						}
					}
					//alert(JSON.stringify(OrderInfo.boProd2Tds));
					//alert(JSON.stringify(OrderInfo.bo2Coupons));
				}else{
					if(typeof response == undefined){
						$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常");
					}else if (response.code == -2) {
						$.alertM(response.data);
					}else{
						var msg="";
						if(response.data!=undefined&&response.data.msg!=undefined){
							msg=response.data.msg;
						}else{
							msg="卡号["+cardNo+"]释放失败";
						}
						$.alert("提示","UIM卡释放失败，可能原因:"+msg);
					}
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
		
   var _checkIsable=function(subflag,subnum){
	   if(subflag=="0"){
		   if($("#uim_btn_"+subnum).attr('unable')=="true"){
			   return true;
		   }else{
			   return false;
		   }
	   }else if(subflag=="1"){
		   if($("#uimrelease_btn_"+subnum).attr('unable')=="true"){
			   return true;
		   }else{
			   return false;
		   }  
	   }else{
		   return true;
	   }
   };
	/**
	 * uim卡号校验
	 */
	var _checkUIM=function(subPage,subflag,subnum){
		if(_checkIsable(subflag,subnum)){
			return;
		}
		var cardNo=$.trim($("#uim_"+subnum).val());
		if(cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return;
		}
		for(var i=0;i<OrderInfo.boProd2Tds.length;i++){
			if(OrderInfo.boProd2Tds[i].terminalCode==cardNo){
				$.alert("提示","UIM卡已经被预占,请输入其它号码!");
				return;
			}
		}
		var hisCardNo="";
		//var hisCouponId="";
		for(var i=0;i<OrderInfo.boProd2Tds.length;i++){
			if(OrderInfo.boProd2Tds[i].prodId==subnum){
				hisCardNo=OrderInfo.boProd2Tds[i].terminalCode;
				//hisCouponId=OrderInfo.boProd2Tds[i].couponId;
				break;
			}
		}
		var phoneNumber="";
		for(var i=0;i<OrderInfo.boProdAns.length;i++){
			if(OrderInfo.boProdAns[i].prodId==subnum){
				phoneNumber=OrderInfo.boProdAns[i].accessNumber;
				break;
			}
		}
		var prodId = -1;
		var offerId = -1;
		if(OrderInfo.actionFlag==3){ //可选包变更使用	
			var prodInfo = order.prodModify.choosedProdInfo;
			phoneNumber = prodInfo.accNbr;
			prodId = prodInfo.prodInstId;
			offerId = prodInfo.prodOfferInstId;
		}
		if(phoneNumber==''){
			$.alert("提示","校验UIM卡前请先选号!");
			return;
		}
		var param = {"instCode":cardNo,"phoneNum":phoneNumber};
		if(hisCardNo!=""){
			param = {"oldInstCode":hisCardNo,"phoneNum":phoneNumber,"newInstCode":cardNo};
		}
		var url = contextPath+"/mktRes/uim/checkUim";
		$.callServiceAsJson(url,param,{
			"before":function(){
				$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");
			},"always":function(){
				$.unecOverlay();
			},"done" : function(response){
				if (response.code == 0) {
					$.alert("提示","UIM卡校验成功!");
					if(subPage=='offer'){
						$("#uim_btn_"+subnum).attr('unable','true');
						$("#uim_btn_"+subnum).removeClass("purchase").addClass("disablepurchase");
						$("#uimrelease_btn_"+subnum).attr('unable','false');
						$("#uimrelease_btn_"+subnum).removeClass("disablepurchase").addClass("purchase");
						$("#uim_"+subnum).attr("disabled",true);
						//$("#uimrelease_btn_"+subnum).off("click").on("click",function(){order.prepare.releaseUIM('offer','1',subnum);});
					}
					//$("#uimCheck_"+subnum).removeClass("order_check_error").addClass("order_check");
					var isExists=false;
					for(var i=0;i<OrderInfo.boProd2Tds.length;i++){
						if(OrderInfo.boProd2Tds[i].prodId==subnum){
							OrderInfo.boProd2Tds[i].terminalCode=cardNo;
							OrderInfo.boProd2Tds[i].couponId=response.data.baseInfo.mktResId;
							isExists=true;
							break;
						}
					}
					if(!isExists){
						var param={
							prodId : subnum, //从填单页面头部div获取
							anTypeCd : "",  //UIM号类型
							deviceModelId : 0, //设备类型ID
							maintainTypeCd : "1",  //默认1
							ownerTypeCd : "",  //待确定
							state : "", //动作
							terminalCode : cardNo, //卡号
							terminalDevId : "", //卡设备实例ID
							terminalDevSpecId : "", //卡设备类型ID
							couponId : response.data.baseInfo.mktResId, //物品ID
							anId : 0 //号码ID
						};
						OrderInfo.boProd2Tds.push(param);
					}
					isExists=false;
					var v_couponNum = response.data.baseInfo.qty ;
					if(v_couponNum==undefined||v_couponNum==null){
						v_couponNum = 1 ;
					}
					var coupon = {
						couponUsageTypeCd : "3", //物品使用类型
						inOutTypeId : "1",  //出入库类型
						inOutReasonId : 0, //出入库原因
						saleId : 1, //销售类型
						couponId :response.data.baseInfo.mktResId, //物品ID
						couponinfoStatusCd : "A", //物品处理状态
						chargeItemCd : CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD, //物品费用项类型
						couponNum : v_couponNum, //物品数量
						storeId : response.data.baseInfo.mktResStoreId, //仓库ID
						storeName : "1", //仓库名称
						agentId : 1, //供应商ID
						apCharge : 0, //物品价格
						couponInstanceNumber : response.data.baseInfo.mktResInstCode, //物品实例编码
						ruleId : "", //物品规则ID
						partyId : OrderInfo.cust.custId, //客户ID
						prodId :prodId, //产品ID
						offerId : offerId, //销售品实例ID
						state : "ADD", //动作
						relaSeq : "" //关联序列	
					};
					for(var i=0;i<OrderInfo.bo2Coupons.length;i++){
						var sonExist=false;
						if(OrderInfo.bo2Coupons[i].prodId==subnum){
							var coupons=OrderInfo.bo2Coupons[i].coupons;
							if(coupons.length>0){//节点的物品里面已经有数据
								for(var j=0;j<coupons.length;j++){
									if(coupons[j].couponInstanceNumber==hisCardNo){//之前已经有对应的UIM的物品，替换掉
										OrderInfo.bo2Coupons[i].coupons[j]=coupon;
										sonExist=true;
										break;
									}
								}
							}else{
								OrderInfo.bo2Coupons[i].coupons.push(coupon);
							}
							if(!sonExist){//没有对应的UIM卡
								OrderInfo.bo2Coupons[i].coupons.push(coupon);
							}
							isExists=true;
							break;
						}
					}
					if(!isExists){
						var coupons2=[];
						coupons2.push(coupon);
						var bo2Coupon = {
							prodId : subnum, //从填单页面头部div获取
							coupons : coupons2
						};
						OrderInfo.bo2Coupons.push(bo2Coupon);
					}
				}else{
					if(typeof response == undefined){
						$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常");
					}else if (response.code == -2) {
						$.alertM(response.data);
					}else{
						var msg="";
						if(response.data!=undefined&&response.data.msg!=undefined){
							msg=response.data.msg;
						}else{
							msg="卡号["+cardNo+"]预占失败";
						}
						$.alert("提示","UIM卡校验失败，可能原因:"+msg);
					}
//					$("#uimCheck_"+subnum).removeClass("order_check").addClass("order_check_error");
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	
	var _step = function(num) {
		//如果没传参数，默认显示第一步
		if (num == undefined || !num) {
			num = 1;
		}
		if(1==num){
			OrderInfo.order.step=0;
			//从填单界面返回到订购套餐界面
			if($("#deal_package").length>0&&$("#order_prod_list").length>0&&$("#old_offerSpecId").val()==null){
				$("#deal_package").css("display","block");
				$("#order_prod_list").css("display","block");
			}
			if($("#deal_package").length>0&&$("#order_prod_list").length>0&&$("#old_offerSpecId").val()!=null&&$("#old_offerSpecId").val()!=""){
				$("#deal_package").css("display","block");
				$("#order_prod_list").css("display","block");
				order.service.buyService($("#old_offerSpecId").val(),'${(price)?default("")}');
			}
		}
		$.each($("div[id^=step]"),function(i,stepDiv){
			if (num == (i+1)) {
				$(this).show();
			} else {
				$(this).hide();
			}
		});
	};
	
	var _hideStep = function() {
		$("div[id^=step]").hide();
	};
	
	var _showOrderTitle = function(action, titleName, backwardFlag){
//		var cont$ = $("<span id='orderTitleSpan'></span>").html(action);
//		var back$ = '';
//		if (backwardFlag == true) {
//			back$ = $("<a href='javascript:void(0);'><span style='float: right;'>返回</span></a>");
//			back$.addClass("numberSearch back3").show().click(function(){order.prepare.backToInit();});
//		}
//		$("#orderTitleDiv h2").html('').append(cont$).append(titleName).append(back$).parent().show();
	};
	var _hideOrderTitle = function() {
		$("#orderTitleDiv").hide();
	};

	var _backToInit=function(){
		//若是购机或选号入口，在退出业务办理时将释放主卡预占的号码（过滤身份证预占的号码）
		var boProdAn = order.service.boProdAn;
		if(boProdAn.idFlag!=undefined&&boProdAn.idFlag=='0'){			
		}else if(boProdAn.accessNumber){
			var param = {
				numType : 1,
				numValue : boProdAn.accessNumber
			};
			$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param, {
				"done" : function(){}
			});
		}
		order.service.boProdAn = {};
		order.phoneNumber.resetBoProdAn();
		_hideOrderTitle();
		$("#step1").hide();
		$("#main_div").hide();
		$("#order_prepare").show();
		$("#order_tab_panel_content").html('');
		if(OrderInfo.actionFlag == 2){
			$("#orderedprod").show();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
		}
	};
	
	//订单时长
	var _createorderlonger = function(){
		var url=contextPath+"/order/createorderlonger";
		var response = $.callServiceAsJson(url, {});
		if(response.code==0){
			OrderInfo.orderlonger=response.data;
		}
	};
	
	return {
		tabChange:_tabChange,
		phoneNumDialog:_phoneNumDialog,
		checkUIM:_checkUIM,
		step : _step,
		hideStep : _hideStep,
		showOrderTitle : _showOrderTitle,
		hideOrderTitle : _hideOrderTitle,
		backToInit:_backToInit,
		releaseUIM:_releaseUIM,
		createorderlonger:_createorderlonger
	};
})();
//初始化
$(function(){
	order.prepare.tabChange();
});
/**
 * 套餐入口
 * 
 * @author dujb3
 */
CommonUtils.regNamespace("order", "prodOffer");
/**
 * 套餐入口
 */
order.prodOffer = (function($){
	
	var _init = function(){
		order.prodOffer.queryApConfig();
		
	};
	
	
	//查询平台配置信息
	var _queryApConfig=function(){
		var configParam={"CONFIG_PARAM_TYPE":"PROD_AND_OFFER"};
		var qryConfigUrl=contextPath+"/order/queryApConf";
		$.callServiceAsJsonGet(qryConfigUrl, configParam,{
			"done" : call_back_success_queryApConfig
		});
	};
	
	var call_back_success_queryApConfig=function(response){
		var OFFER_PRICE ;
		var OFFER_INFLUX ;
		var OFFER_INVOICE ;
		
		var OFFER_PRICE_html   = "<a href='javascript:void(0);' class='selected' val='' >不限</a>";
		var OFFER_INFLUX_html  = "<a href='javascript:void(0);' class='selected' val='' >不限</a>";
		var OFFER_INVOICE_html = "<a href='javascript:void(0);' class='selected' val='' >不限</a>";
		if(response.data){
			var dataLength=response.data.length;
			for (var i=0; i < dataLength; i++) {
				if(response.data[i].OFFER_PRICE){
					OFFER_PRICE = response.data[i].OFFER_PRICE ;
					for(var j=0;j<OFFER_PRICE.length;j++){
						var rowKey=OFFER_PRICE[j].COLUMN_VALUE;
						var rowVal=OFFER_PRICE[j].COLUMN_VALUE_NAME;
						OFFER_PRICE_html=OFFER_PRICE_html+"<a href='javascript:void(0);' val='"+rowKey+"'>"+rowVal+"</a>";
					}
					$("#price_basic").html(OFFER_PRICE_html);
					$("#price_basic a").each(function(){
						$(this).off("click").on("click",function(event){
							$("#price_basic a").each(function(){$(this).removeClass("selected");});
							$(this).addClass("selected");
							event.stopPropagation();
							order.service.searchPack(1);
						});
					});
				}else if(response.data[i].OFFER_INFLUX){
					OFFER_INFLUX = response.data[i].OFFER_INFLUX ;
					for(var j=0;j<OFFER_INFLUX.length;j++){
						var rowKey=OFFER_INFLUX[j].COLUMN_VALUE;
						var rowVal=OFFER_INFLUX[j].COLUMN_VALUE_NAME;
						OFFER_INFLUX_html=OFFER_INFLUX_html+"<a href='javascript:void(0);' val='"+rowKey+"'>"+rowVal+"</a>";
					}
					$("#influx_basic").html(OFFER_INFLUX_html);
					$("#influx_basic a").each(function(){
						$(this).off("click").on("click",function(event){
							$("#influx_basic a").each(function(){$(this).removeClass("selected");});
							$(this).addClass("selected");
							event.stopPropagation();
							order.service.searchPack(1);
						});
					});
				}else if(response.data[i].OFFER_INVOICE){
					OFFER_INVOICE = response.data[i].OFFER_INVOICE ;
					for(var j=0;j<OFFER_INVOICE.length;j++){
						var rowKey=OFFER_INVOICE[j].COLUMN_VALUE;
						var rowVal=OFFER_INVOICE[j].COLUMN_VALUE_NAME;
						OFFER_INVOICE_html=OFFER_INVOICE_html+"<a href='javascript:void(0);' val='"+rowKey+"'>"+rowVal+"</a>";
					}
					$("#invoice_basic").html(OFFER_INVOICE_html);
					$("#invoice_basic a").each(function(){
						$(this).off("click").on("click",function(event){
							$("#invoice_basic a").each(function(){$(this).removeClass("selected");});
							$(this).addClass("selected");
							event.stopPropagation();
							order.service.searchPack(1);
						});
					});
				}
			}
		}
	};
	
	return {
		init:_init,
		queryApConfig:_queryApConfig
	};
})(jQuery);

//初始化
$(function(){
	
});
CommonUtils.regNamespace("order", "protocolnbr");

order.protocolnbr = (function(){
	var inputID = "input1"; 
	var selectID = "select1"; 
	var widt = 0; 
	var inputWi = 0; 
	var he = 0; 
	var _init = function(){
		inputID = "input1";
		selectID = "select1";
		widt = 200;
		inputWi = widt - 20;
		he = $("#div1").height() - 41;
		var offset = $("input[id=input1]").offset(); 
		$("#" + selectID).change(function() { 
			var newvar = $("#" + selectID).find("option:selected").text(); 
			$("#" + inputID).val(newvar); 
		}).click(function() { 
			$("#select_div_on_key" + selectID).remove(); 
			}).css({ "display": "block", "width": widt + "px", "z-index": 1, "clip": "rect(0px " + widt + "px 51px 151px)" }); 
		$("#" + inputID).keyup(function() { 
			_showSelectCombo(); 
		}).click(function() { 
			_showSelectCombo(); 
		}).css({ "z-index": 2, "width": inputWi + "px" }); ; 
	};
	var _showSelectCombo = function(){
	    var pob = $("#" + inputID); 
		var v = pob.val(); 
		var off = pob.offset(); 
		var wi = pob.width() + 20; 
		var tp = off.top + pob.height() - 100 + 7; 
		var lef = off.left - 200 + 2; 
		var html = "<div class='select_div_list' id='select_div_on_key" + selectID + "' style='width:" + wi + "px;top:" + tp + "px;left:" + lef + "px;'><ul class='select_div_list_ul'>"; 
		$("#" + selectID).find("option").each(function() { 
			var tk = $(this); 
			var matcher = new RegExp("^" + v, "i"); 
			if(matcher.test(tk.val())){
			   html += "<li val='" + tk.val() + "' ht='" + encodeURIComponent(tk.html()) + "'>" + tk.html().replace(v, "<span class='selectSPAN'>" + v + "</span>") + "</li>"; 
		    }
		}); 
		html += "</ul></div>"; 
		var ulDIV = $("#select_div_on_key" + selectID); 
		ulDIV.remove(); 
		$("#div1").append(html); 
		var ulDIV = $("#select_div_on_key" + selectID); 
		var hei = ulDIV.find("ul").height(); 
		var newHeight = hei > he ? he : hei; 
		ulDIV.css({ height: newHeight + "px" }); 
		ulDIV.find("li").hover(function() { 
		$(this).css({ "background-color": "#316ac5" }); 
		}, function() { 
		$(this).css({ "background-color": "white" }); 
		}); 
		ulDIV.find("li").click(function() { 
				var ki = $(this); 
				var va = ki.attr("val"); 
				var htm = ki.attr("ht"); 
				htm = decodeURIComponent(htm); 
				$("#" + inputID).val(htm); 
				$("#" + selectID).val(va); 
				ulDIV.remove(); 
		    }); 
	    };
		return {
			showSelectCombo : _showSelectCombo,
			init : _init
		};
})();
 
/**
 * 受理订单对象
 * 
 * @author wukf
 */
CommonUtils.regNamespace("SoOrder");

/** 受理订单对象*/
SoOrder = (function() {
	
	//订单准备
	var _builder = function() {
		if(query.offer.loadInst()){  //加载实例到缓存
			SoOrder.initFillPage();
			return true;
		}else{
			return false;
		};
	};
	//主副卡订单确认信息
	var _viceParam="";
	//初始化填单页面，为规则校验类型业务使用
	var _initFillPage = function(){
		SoOrder.initOrderData();
		SoOrder.step(1); //显示填单界面
		OrderInfo.order.step=1;//订单页面
		_getToken(); //获取页面步骤
	}; 
	
	//初始化订单数据
	var _initOrderData = function(){
		OrderInfo.resetSeq(); //重置序列
		OrderInfo.resetData(); //重置 数据
		OrderInfo.orderResult = {}; //清空购物车
		OrderInfo.getOrderData(); //获取订单提交节点	
		OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		OrderInfo.orderData.orderList.orderListInfo.areaId = OrderInfo.getAreaId();
		OrderInfo.resetChooseUserInfo();
	};
	
	var _getCheckOperatSpec=function(){
		var url=contextPath+"/token/pc/order/getCheckOperatSpec";//获取是否有分段的权限
		var response = $.callServiceAsJson(url, {});
		OrderInfo.zcd_privilege=response.data;
	};
	
	//提交订单节点
	var _submitOrder = function(data) {
		_getCheckOperatSpec();
		if(_getOrderInfo(data)){
			//订单提交
			var url = contextPath+"/token/pc/order/orderSubmit";
			if(OrderInfo.order.token!=""){
				url = contextPath+"/token/pc/order/orderSubmit?token="+OrderInfo.order.token;
			}
			$.callServiceAsJson(url,JSON.stringify(OrderInfo.orderData), {
				"before":function(){
					$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
				},"always":function(){
					//$.unecOverlay();
				},	
				"done" : function(response){
					$.unecOverlay();
					_getToken();
					if (response.code == 0) {
						var data = response.data;
						if(data.result.ruleInfos!=undefined && data.result.ruleInfos.length > 0){
							var ruleDesc = "";
							$.each(data.result.ruleInfos, function(){
								ruleDesc += this.ruleDesc+"<br/>";
							});
							$.alert("提示",ruleDesc);
							OrderInfo.orderData.orderList.custOrderList[0].busiOrder = [];
							OrderInfo.resetSeq(); //重置序列
						}else if(data.checkRule!=undefined){
							//新规则校验
							var orderdata=response.data;
							var checkParams={
								"olId":orderdata.rolId,
								"soNbr":orderdata.rsoNbr,
								"areaId" : OrderInfo.staff.areaId,
								"chargeItems":[]
							};
							
							var checkUrl=contextPath+"/token/pc/order/checkRuleToProv";
							$.callServiceAsJson(checkUrl,checkParams, {
								"before":function(){
									$.ecOverlay("<strong>正在下省校验中,请稍候...</strong>");
								},
								"always":function(){
									
								},	
								"done" : function(checkResponse){
									//关闭弹出提示
									$.unecOverlay();
									
									var provCheckResult;
									
									if (checkResponse.code == 0) {
										var dataSub = checkResponse.data;
										if(dataSub.checkResult!=undefined){
											OrderInfo.checkresult=dataSub.checkResult;		
										}
										
										var returnData = _gotosubmitOrder(response.data);
										_orderConfirm(returnData);
									}else{	
										data.provCheckError = "Y";
										if(checkResponse.data && checkResponse.data.resultMsg!=undefined && $.trim(checkResponse.data.resultMsg)!=""){
											data.provCheckErrorMsg = checkResponse.data.resultMsg;
										} else if(checkResponse.data.errMsg!=undefined && $.trim(checkResponse.data.errMsg)!=""){
											data.provCheckErrorMsg = checkResponse.data.errMsg;
											if(checkResponse.data.errCode){
												data.provCheckErrorMsg = "【错误编码："+checkResponse.data.errCode+"】" + data.provCheckErrorMsg;
											}
											if(checkResponse.data.errData){
												data.provCheckErrorData=checkResponse.data.errData;
												
												data.provCheckErrorMsg+=","+data.provCheckErrorData;
											}
											if(checkResponse.data.paramMap){
												data.provCheckErrorMsg += "【入参："+checkResponse.data.paramMap+"】";
											}
										} else{
											data.provCheckErrorMsg = "未返回错误信息，可能是下省请求超时，请返回填单页面并稍后重试订单提交。";
										}
										var returnData = _gotosubmitOrder(data);
										_orderConfirm(returnData);			
									}
								},
								"fail":function(response){
									$.unecOverlay();
									$.alert("提示","下省校验失败");
								}
							});
						}else{
							var returnData = _gotosubmitOrder(response.data);
							_orderConfirm(returnData);
						}
					}else{
						$.alertM(response.data);
						OrderInfo.orderData.orderList.custOrderList[0].busiOrder = [];
						OrderInfo.resetSeq(); //重置序列
					}
				}
			});
		}	
	};
	
	var _gotosubmitOrder = function(orderdata){
		var url = contextPath+"/token/pc/order/gotosubmitOrder";
		$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
		var response = $.callServiceAsHtml(url,JSON.stringify(orderdata));
		$.unecOverlay();
		return response.data;
	};
	
	//填充订单信息
	var _getOrderInfo = function(data){
		if(OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){ //终端购买、退换货
			//如果是合约机换货，已经加载缓存
			if (OrderInfo.actionFlag==18 && data.boActionType.actionClassCd==CONST.ACTION_CLASS_CD.OFFER_ACTION) {
				
			} else {
				query.offer.loadInst(); //加载实例到缓存
			}
			couponSale(data);
			if(OrderInfo.order.soNbr!=undefined && OrderInfo.order.soNbr != ""){  //缓存流水号
				OrderInfo.orderData.orderList.orderListInfo.soNbr = OrderInfo.order.soNbr;
			}
			return true;
		}
		var busiOrders = [];  //存放订单项数组
		var custOrderAttrs = []; //获取订单属性数组
		var itemValue="N";
		if(_setOfferType()){
			itemValue="Y";
		}
		custOrderAttrs.push({
			itemSpecId : CONST.BUSI_ORDER_ATTR.THRETOFOUR_ITEM,//3转4标志
			value : itemValue
		});
		custOrderAttrs.push({ //订单时长
			itemSpecId : "111111113",
			value : OrderInfo.orderlonger
		});	
		custOrderAttrs.push({ //业务类型
			itemSpecId : CONST.BUSI_ORDER_ATTR.BUSITYPE_FLAG,
			value : OrderInfo.busitypeflag
		});
		custOrderAttrs.push({ //定位客户时长
			itemSpecId : "30010050",
			value : OrderInfo.custorderlonger
		});	
		if(OrderInfo.zcd_privilege==='0'){
			custOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.ZCD_ITEM,//是否是暂存单
				value : 0
			});
		}
		if(ec.util.isObj(OrderInfo.order.soNbr)){
			custOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.SO_NBR,//全量查询的soNbr
				value : OrderInfo.order.soNbr
			});
		}
		//添加订单属性，isale下省流水号
//		if(order.cust.fromProvFlag == "1"){
		if($("#orderProvAttrIsale").length){
			order.cust.provIsale = $.trim($("#orderProvAttrIsale").val());
		}
		if(ec.util.isObj(order.cust.provIsale)){
			order.cust.fromProvFlag = "1";
			custOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.PROV_ISALE,
				value : order.cust.provIsale
			});	
		} else {
			order.cust.fromProvFlag = "0";
		}
//		}
		if(!_checkData()){ //校验通过
			return false;
		}
		//订单备注前置
		var remark = $('#order_remark').val(); 
		if(ec.util.isObj(remark)){
			custOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
				value : remark
			});	
		}
		//订单购物车属性(经办人)
		if(CONST.getAppDesc()==0){
			var orderAttrName = $.trim($("#orderAttrName").val()); //经办人姓名
			var orderIdentidiesTypeCd = $("#orderIdentidiesTypeCd  option:selected").val(); //证件类型
			var orderAttrIdCard =$.trim($("#orderAttrIdCard").val()); //证件号码
			var orderAttrAddr = $.trim($("#orderAttrAddr").val()); //地址
			var orderAttrPhoneNbr = $.trim($("#orderAttrPhoneNbr").val()); //联系人号码
			if(ec.util.isObj(orderAttrName)&&ec.util.isObj(orderAttrIdCard)&&ec.util.isObj(orderAttrPhoneNbr)){
				if(ec.util.isObj(orderAttrName)){
					custOrderAttrs.push({
						itemSpecId : CONST.BUSI_ORDER_ATTR.orderAttrName,
						value : orderAttrName
					});	
				}
				if(ec.util.isObj(orderAttrIdCard)){
					custOrderAttrs.push({
						itemSpecId : CONST.BUSI_ORDER_ATTR.orderIdentidiesTypeCd,
						value : orderIdentidiesTypeCd
					});	
					custOrderAttrs.push({
						itemSpecId : CONST.BUSI_ORDER_ATTR.orderAttrIdCard,
						value : orderAttrIdCard
					});	
				}
				if(ec.util.isObj(orderAttrPhoneNbr)){
					custOrderAttrs.push({
						itemSpecId : CONST.BUSI_ORDER_ATTR.orderAttrPhoneNbr,
						value : orderAttrPhoneNbr
					});	
				}
				if(ec.util.isObj(orderAttrAddr)){
					custOrderAttrs.push({
						itemSpecId : CONST.BUSI_ORDER_ATTR.orderAttrAddr,
						value : orderAttrAddr
					});	
				}
			}else if(ec.util.isObj(orderAttrName)||ec.util.isObj(orderAttrIdCard)||ec.util.isObj(orderAttrPhoneNbr)){
				if(!ec.util.isObj(orderAttrName)){
					$.alert("提示","经办人姓名为空，经办人姓名、联系人号码、证件号码必须同时为空或不为空，因此无法提交！");
					return false;
				}
				if(!ec.util.isObj(orderAttrPhoneNbr)){
					$.alert("提示","联系人号码为空，经办人姓名、联系人号码、证件号码必须同时为空或不为空，因此无法提交！");
					return false;
				}
				if(!ec.util.isObj(orderAttrIdCard)){
					$.alert("提示","证件号码为空，经办人姓名、联系人号码、证件号码必须同时为空或不为空，因此无法提交！");
					return false;
				}
			}
		}
		
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14){ //新装
			_createOrder(busiOrders); //新装
		}else if (OrderInfo.actionFlag==2){ //套餐变更
			offerChange.changeOffer(busiOrders);	
		}else if (OrderInfo.actionFlag==3){ //可选包变更		
			_createAttOrder(busiOrders); //附属销售品变更
			if(busiOrders.length==0){
				$.alert("提示","没有做任何业务，无法提交");
				return false;
			}
		}else if (OrderInfo.actionFlag==4){ //客户资料变更
			_createCustOrder(busiOrders,data); //附属销售品变更
		}else if (OrderInfo.actionFlag==5){//销售品成员变更拆副卡
			_delViceCard(busiOrders,data);
		}else if (OrderInfo.actionFlag==6){ //销售品成员变更加装副卡
			_createMainOrder(busiOrders);
		}else if (OrderInfo.actionFlag==7){ //拆主卡保留副卡
			_delAndNew(busiOrders,data); 
		}else if (OrderInfo.actionFlag==8){ //新建客户单独订单
			_createCustOrderOnly(busiOrders,data);
		}else if (OrderInfo.actionFlag==9){ //活卡销售返档
			_ActiveReturnOrder(busiOrders,data); 
		}else if (OrderInfo.actionFlag==10){ //传到节点busiOrder 
			busiOrders = data;
		}else if (OrderInfo.actionFlag==11){ //撤单,有做特殊处理
			busiOrders = data;
		}else if (OrderInfo.actionFlag==12){ //加入退出组合
			busiOrders = data;
		}else if(OrderInfo.actionFlag==16){ //改号
			_changeNumber(busiOrders);	
		}else if(OrderInfo.actionFlag==19){ //返销
			OrderInfo.actionClassCd = OrderInfo.orderItemCd;
			_fillBusiOrder(busiOrders,data,"N"); //填充业务对象节点	
		}else if(OrderInfo.actionFlag==20){ //返销
			_delAndNew(busiOrders,data); 
		}else if(OrderInfo.actionFlag==21){ //销售品成员变更保留副卡订购新套餐
			_delViceCardAndNew(busiOrders,data);
		}else if(OrderInfo.actionFlag== 22 ){ //补换卡
			busiOrders = data;
		}else if(OrderInfo.actionFlag == 23){//异地补换卡
			busiOrders = data;
			//异地补换卡的订单地区为当前渠道对应的地区
			OrderInfo.orderData.orderList.orderListInfo.areaId = OrderInfo.staff.areaId;
			//外部客户ID
			var corCustId = $("#custInfos").attr("corCustId");
			if(ec.util.isObj(corCustId)){
				var custOrderAttr1 = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.COR_CUST_ID,
					value : corCustId
				};
				custOrderAttrs.push(custOrderAttr1);
			}
			//省内客户ID
			var extCustId = $("#custInfos").attr("extCustId");
			if(ec.util.isObj(extCustId)){
				var custOrderAttr2 = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.EXT_CUST_ID,
					value : extCustId
				};
				custOrderAttrs.push(custOrderAttr2);
			}
			//省内产品实例ID
			var extProdInstId = order.prodModify.choosedProdInfo.extProdInstId;
			if(ec.util.isObj(extProdInstId)){
				var custOrderAttr3 = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.EXT_PROD_INST_ID,
						value : extProdInstId
				};
				custOrderAttrs.push(custOrderAttr3);
			}
			//外部产品实例ID
			var corProdInstId = order.prodModify.choosedProdInfo.corProdInstId;
			if(ec.util.isObj(corProdInstId)){
				var custOrderAttr4 = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.COR_PROD_INST_ID,
						value : corProdInstId
				};
				custOrderAttrs.push(custOrderAttr4);
			}
			//营销资源省内实例ID
			var extCouponInstanceId = order.prodModify.choosedProdInfo.extCouponInstanceId;
			if(ec.util.isObj(extCouponInstanceId)){
				var custOrderAttr5 = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.EXT_COUPON_INST_ID,
						value : extCouponInstanceId
				};
				custOrderAttrs.push(custOrderAttr5);
			}
			//营销资源外部实例ID
			var corCouponInstanceId = order.prodModify.choosedProdInfo.corCouponInstanceId;
			if(ec.util.isObj(corCouponInstanceId)){
				var custOrderAttr6 = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.COR_COUPON_INST_ID,
						value : corCouponInstanceId
				};
				custOrderAttrs.push(custOrderAttr6);
			}
		}else{  //默认单个业务动作
			_fillBusiOrder(busiOrders,data,"N"); //填充业务对象节点
		}
		OrderInfo.orderData.orderList.orderListInfo.custOrderAttrs = custOrderAttrs; //订单属性数组
		OrderInfo.orderData.orderList.orderListInfo.extCustOrderId = OrderInfo.provinceInfo.provIsale; //省份流水
		OrderInfo.orderData.orderList.custOrderList[0].busiOrder = busiOrders; //订单项数组
		if($("#isTemplateOrder").attr("checked")=="checked"){ //批量订单
			OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder ="Y";
			OrderInfo.orderData.orderList.orderListInfo.templateOrderName =$("#templateOrderName").val();
			if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){
				OrderInfo.orderData.orderList.orderListInfo.templateType = $("#templateOrderDiv").find("select").val(); //批量换挡
			}else if(OrderInfo.actionFlag==2){
				OrderInfo.orderData.orderList.orderListInfo.templateType = 5; //批量换挡
			}else if(OrderInfo.actionFlag==3){
				OrderInfo.orderData.orderList.orderListInfo.templateType = 2; //批量可选包订购退订
			}
		}else{
			OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder ="N";
		}
		if(OrderInfo.order.soNbr!=undefined && OrderInfo.order.soNbr != ""){  //缓存流水号
			OrderInfo.orderData.orderList.orderListInfo.soNbr = OrderInfo.order.soNbr;
		}
		return true;
	};
	
	//终端销售
	var couponSale = function(data){
		var coupons = data.coupons;
		OrderInfo.getOrderData(); //获取订单提交节点
		//新建客户、或是老客户、或是虚拟客户
		var busiOrders = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;//获取业务对象数组
		if (OrderInfo.cust.custId == -1) {
			OrderInfo.createCust(busiOrders);
		} else if (OrderInfo.cust.custId != undefined && OrderInfo.cust.custId != "") {
			OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		} else {
			OrderInfo.orderData.orderList.orderListInfo.partyId = CONST.CUST_COUPON_SALE;
		}
		if (OrderInfo.actionFlag == 18) {
			OrderInfo.orderData.orderList.orderListInfo.partyId = coupons[0].partyId;
		}
		//填入订单
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : data.busiObj,  
			boActionType : data.boActionType, 
			data:{
				bo2Coupons:[]
			}
		};
		busiOrder.data.bo2Coupons = coupons;
		if (data.dealers) {
			busiOrder.data.busiOrderAttrs = data.dealers;
		}
		busiOrders.push(busiOrder);
	};
	
	//订单确认
	var _orderConfirm = function(data){
		SoOrder.step(2,data);
		//记录olId到cookie，用于取消订单
		SoOrder.delOrderBegin();
		
		if(OrderInfo.actionFlag==1 ||OrderInfo.actionFlag==14){ //新装
			$("#orderTbody").append("<tr><td >套餐名称：</td><td>"+OrderInfo.offerSpec.offerSpecName+"</td></tr>");
			var $span = $("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName+"<span class='showhide'></span>");
			$("#tital").append($span);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				$.each(this.prodInsts,function(){
					$("#orderTbody").append("<tr ><td>"+this.offerRoleName+"号码：</td><td>"
							+OrderInfo.getProdAn(this.prodInstId).accessNumber+"</td></tr> ");
				});
			});
			
			if(order.service.oldMemberFlag){
				for(var j=0;j<OrderInfo.oldoffer.length;j++){
					for ( var i = 0; i < OrderInfo.oldoffer[j].offerMemberInfos.length; i++) {
						var offerMember = OrderInfo.oldoffer[j].offerMemberInfos[i];
						if(offerMember.objType==CONST.OBJ_TYPE.PROD){
							$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+offerMember.accessNumber+"</td></tr> ");	
						}
					}
				}
			}
		}else if(OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){ //裸机销售
			$("#orderedprod").hide();
			$("#order_prepare").hide();
			$("#order_tab_panel_content").hide();
			$("#orderTbody").append("<tr><td >终端名称：</td><td>"+OrderInfo.businessName+"</td></tr>");
			var busiOrder = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;
			var bo2Coupons = undefined;
			if (OrderInfo.actionFlag==13) {
				for(var i=0; i<busiOrder.length; i++) {
					var boActionType = busiOrder[i].boActionType;
					if (boActionType.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION
							&& boActionType.boActionTypeCd==CONST.BO_ACTION_TYPE.COUPON_SALE) {
						bo2Coupons = busiOrder[i].data.bo2Coupons;
					}
				}
				$("#orderTbody").append("<tr><td >终端串码：</td><td>"+bo2Coupons[0].couponInstanceNumber+"</td></tr>");
			} else if (OrderInfo.actionFlag==17) {
				for(var i=0; i<busiOrder.length; i++) {
					var boActionType = busiOrder[i].boActionType;
					if (boActionType.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION
							&& boActionType.boActionTypeCd==CONST.BO_ACTION_TYPE.RETURN_COUPON) {
						bo2Coupons = busiOrder[i].data.bo2Coupons;
					}
				}
				$("#orderTbody").append("<tr><td >终端串码：</td><td>"+bo2Coupons[0].couponInstanceNumber+"</td></tr>");
			} else if (OrderInfo.actionFlag==18) {
				for(var i=0; i<busiOrder.length; i++) {
					var boActionType = busiOrder[i].boActionType;
					if (boActionType.boActionTypeCd==CONST.BO_ACTION_TYPE.EXCHANGE_COUPON) {
						bo2Coupons = busiOrder[i].data.bo2Coupons;
					}
				}
				var oldCoupon = null;
				var newCoupon = null;
				if (bo2Coupons[0].state=="DEL") {
					oldCoupon = bo2Coupons[0];
					newCoupon = bo2Coupons[1];
				} else {
					oldCoupon = bo2Coupons[1];
					newCoupon = bo2Coupons[0];
				}
				$("#orderTbody").append("<tr><td >旧终端串码：</td><td>"+oldCoupon.couponInstanceNumber+"</td></tr>");
				$("#orderTbody").append("<tr><td >新终端串码：</td><td>"+newCoupon.couponInstanceNumber+"</td></tr>");
			}
			var $span = $("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName+"<span class='showhide'></span>");
			$("#tital").append($span);
		}else{ //二次业务
			var prod = order.prodModify.choosedProdInfo;
			$("#orderTbody").append("<tr id='offerSpecName'><td >套餐名称：</td><td>"+prod.prodOfferName+"</td></tr>");
			$("#orderTbody").append("<tr id='accNbrTr'><td>手机号码：</td><td>"+prod.accNbr+"</td></tr> ");	
			if(OrderInfo.actionFlag==2){ //套餐变更 
				OrderInfo.actionTypeName = "套餐变更";
				$("#orderTbody").append("<tr><td >新套餐名称：</td><td>"+OrderInfo.offerSpec.offerSpecName+"</td></tr>");
				$("#accNbrTr").hide();
				for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) { //遍历主销售品构成
					var offerMember = OrderInfo.offer.offerMemberInfos[i];
					if(offerMember.objType==CONST.OBJ_TYPE.PROD){
						$("#orderTbody").append("<tr ><td>"+offerMember.roleName+"号码：</td><td>"+offerMember.accessNumber+"</td></tr> ");	
					}
				}
				if(offerChange.newMemberFlag){
					$.each(OrderInfo.boProdAns,function(){
						$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+this.accessNumber+"</td></tr> ");	
					});
				}
				if(offerChange.oldMemberFlag){
					for(var j=0;j<OrderInfo.oldoffer.length;j++){
						for ( var i = 0; i < OrderInfo.oldoffer[j].offerMemberInfos.length; i++) {
							var offerMember = OrderInfo.oldoffer[j].offerMemberInfos[i];
							if(offerMember.objType==CONST.OBJ_TYPE.PROD){
								$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+offerMember.accessNumber+"</td></tr> ");	
							}
						}
					}
				}
			}else if(OrderInfo.actionFlag==3){ //可选包变更 
				OrderInfo.actionTypeName = "订购/退订可选包与功能产品";
			}else if(OrderInfo.actionFlag==4||OrderInfo.actionFlag==8){ //客户资料变更与新建客户单独
				$("#offerSpecName").hide();
				$("#accNbrTr").hide();
			}else if(OrderInfo.actionFlag==5){  //主副卡成员变更拆除副卡
				$("#accNbrTr").hide();
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.objType==CONST.OBJ_TYPE.PROD){
						if(this.roleCd == CONST.MEMBER_ROLE_CD.VICE_CARD && this.isRemove=="Y"){
							$("#orderTbody").append("<tr ><td>拆除副卡号码：</td><td>"+this.accessNumber+"</td></tr> ");	
						}else {
							$("#orderTbody").append("<tr ><td>"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");	
						}
					}
				});
				OrderInfo.actionTypeName = "主副卡成员变更";
			}else if(OrderInfo.actionFlag==6){ //主副卡成员变更纳入副卡
				$("#accNbrTr").hide();
				if(ec.util.isArray(OrderInfo.viceOfferSpec)){
					$.each(OrderInfo.viceOfferSpec,function(){
						$("#orderTbody").append("<tr><td >新套餐名称：</td><td>"+this.offerSpecName+"</td></tr>");
					});
				}
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.objType==CONST.OBJ_TYPE.PROD){
						$("#orderTbody").append("<tr ><td>"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");
					}
				});
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.objType==CONST.OBJ_TYPE.PROD){
						if(this.roleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD){
							var knew="";
							var del="";
							var objInstId=this.objInstId;
							$.each(_viceParam,function(i,val){
								if(val.objInstId==objInstId&&val.knew=="Y"){
									knew="Y";
								}
								if(val.objInstId==objInstId&&val.del=="Y"){
									del="Y";
								}
							});
							if(knew=="Y"){
								$("#orderTbody").append("<tr ><td>订购"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");
							}else if(del=="Y"){
								$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");	
							}
						}
					}
				});
				$.each(OrderInfo.boProdAns,function(){
					$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+this.accessNumber+"</td></tr> ");	
				});
				if(ec.util.isArray(OrderInfo.oldAddNumList)){
					for(var i=0;i<OrderInfo.oldAddNumList.length;i++){
						$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+OrderInfo.oldAddNumList[i].accNbr+"</td></tr> ");	
					}
				}
				OrderInfo.actionTypeName = "主副卡成员变更";
			}else if(OrderInfo.actionFlag==7){ //主副卡拆机保留副卡
				$("#accNbrTr").hide();
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.objType==CONST.OBJ_TYPE.PROD){
						if(this.roleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD){
							$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");	
						}else {
							var del="";
							var accessNumber=this.accessNumber;
							$.each(_viceParam,function(i,val){
								if(val.accessNumber==accessNumber&&val.del=="N"){
									del="N";
								}
							});
							if(del=="N"){
								$("#orderTbody").append("<tr ><td>订购"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");
							}else{
								$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");	
							}
						}
					}
				});
				OrderInfo.actionTypeName = CONST.getBoActionTypeName(OrderInfo.boActionTypeCd);
			}else if(OrderInfo.actionFlag==21){ //主副卡成员变更
				if(ec.util.isArray(OrderInfo.viceOfferSpec)){
					$.each(OrderInfo.viceOfferSpec,function(){
						$("#orderTbody").append("<tr><td >新套餐名称：</td><td>"+this.offerSpecName+"</td></tr>");
					});
				}
				$("#accNbrTr").hide();
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.objType==CONST.OBJ_TYPE.PROD){
						if(this.roleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD){
							var knew="";
							var del="";
							var objInstId=this.objInstId;
							$.each(_viceParam,function(i,val){
								if(val.objInstId==objInstId&&val.knew=="Y"){
									knew="Y";
								}
								if(val.objInstId==objInstId&&val.del=="Y"){
									del="Y";
								}
							});
							if(knew=="Y"){
								$("#orderTbody").append("<tr ><td>订购"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");
							}else if(del=="Y"){
								$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");	
							}
						}
					}
				});
				OrderInfo.actionTypeName = "主副卡成员变更";
			}else if(OrderInfo.actionFlag==20){ //主副卡拆机保留副卡
				$("#accNbrTr").hide();
				for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) { //遍历主销售品构成
					var offerMember = OrderInfo.offer.offerMemberInfos[i];
					if(offerMember.objType==CONST.OBJ_TYPE.PROD){
						if(offerMember.roleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD){
							$("#orderTbody").append("<tr ><td>拆除"+offerMember.roleName+"号码：</td><td>"+offerMember.accessNumber+"</td></tr> ");	
						}else {
							$("#orderTbody").append("<tr ><td>订购"+offerMember.roleName+"号码：</td><td>"+offerMember.accessNumber+"</td></tr> ");	
						}
					}
				}
				OrderInfo.actionTypeName = "返销";	
			}else if(OrderInfo.actionFlag==12){ //加入组合退出组合
				$("#accNbrTr").hide();
				for (var i = 0; i < OrderInfo.confirmList.length; i++) {
					var prod = OrderInfo.confirmList[i];
					for(var j = 0; j < prod.accNbr.length; j++){
						$("#orderTbody").append("<tr><td >"+prod.name+"：</td><td>"+prod.accNbr[j]+"</td></tr>");
					}
				}
			}else if(OrderInfo.actionFlag==16){ //改号
				OrderInfo.actionTypeName = "改号";
				$.each(OrderInfo.boProdAns,function(){
					if(this.state=="ADD"){
						$("#orderTbody").append("<tr id='accNbrTr'><td>新号码：</td><td>"+this.accessNumber+"</td></tr> ");	
					}
				});
			}else if(OrderInfo.actionFlag==0&&OrderInfo.actionTypeName=="拆机"){ //拆机
				$("#accNbrTr").hide();
				var isMainCard="";
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.roleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD&&this.objInstId==order.prodModify.choosedProdInfo.prodInstId){
						isMainCard="Y";	
					}
				});
				if(isMainCard=="Y"){
					$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
							$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ");	
					});
				}
				OrderInfo.actionTypeName = "拆机";
			}
			var $span = $("<span>"+OrderInfo.actionTypeName+"</span>");
			$("#tital").append($span);
		}
		
		var ruleFlag = true;
		if($("#ruleTbody tr").length>0){ //规则限制
			$("#ruleTbody tr").each(function (){
				var ruleLevel = $(this).attr("ruleLevel");
				if(ruleLevel == "1"){
					ruleFlag = false;
					return false; 
				}
			});
		}
		if(ruleFlag){
			if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14 ){
				_showOrderOffer(); //显示订购的销售品
			}else if(OrderInfo.actionFlag==2){ //套餐变更 
				_showChangeAttach();
			}else if (OrderInfo.actionFlag==3 || OrderInfo.actionFlag==22){
				_showAttachOffer(); //显示订购的销售品
			}else if (OrderInfo.actionFlag==6){
				_showAddViceOffer(); //加装副卡显示订购的销售品
			}else if(OrderInfo.actionFlag==21 && order.memberChange.getSimulateData()){
				_showMemberChangeAttach();
			}else{
				if(OrderInfo.orderResult.autoBoInfos!=undefined&&OrderInfo.orderResult.autoBoInfos.length>0){
					$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));
					$.each(OrderInfo.orderResult.autoBoInfos,function(){
						$("#chooseTable").append($('<tr><td width="50%">'+this.specName+'</td><td>'+this.boActionTypeName+'</td></tr>'));
					});
				}
			}
		}
	};
	
	//显示步骤
	var _showStep = function(k,data) {
		for (var i = 1; i < 4; i++) {
			$("#step"+i).hide();
		}
		$("#step"+k).show();
	};
	
	//页面步骤,优化页面显示功能
	var _step = function(k,data){
		if(k==0){   //订单准备页面
			$("#orderedprod").hide();
			$("#order_prepare").hide();
			$("#order_fill_content").hide();
			$("#order_tab_panel_content").html(data).show();
			k++;
		}else if(k==1){  //订单填写页面
			$("#orderedprod").hide();
			$("#order_prepare").hide();
			$("#order_tab_panel_content").hide();
			$("#order_confirm").hide();
			$("#order_fill_content").show();
		}else if(k==2){ //订单确认填写页面
			//修改客户按钮隐藏
            $("#custModifyId").attr("style","display: none;");
			$("#main_conetent").hide();
			$("#order_fill_content").hide();
			$("#order_tab_panel_content").hide();
			$("#order_confirm").html(data).show();	
		}
		for (var i = 1; i < 4; i++) {
			$("#step"+i).hide();
		}
		$("#step"+k).show();
	};
	
	// 新装，显示订购的销售品
	var _showOrderOffer = function(){
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			$.each(this.prodInsts,function(){
				$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+')</th><th>业务动作</th></tr>'));			
				_showAttOffer(this.prodInstId);
			});
		});
	};
	
	//显示加装副卡订购的销售品
	var _showAddViceOffer = function(){
		if(ec.util.isArray(OrderInfo.oldoffer)){
			$.each(OrderInfo.oldoffer,function(){
				$.each(this.offerMemberInfos,function(){
					if(this.objType==CONST.OBJ_TYPE.PROD){
						$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.roleName+')</th><th>业务动作</th></tr>'));
						_showAttOffer(this.objInstId);
					}
				});
			});
		}else{
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){
					$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+')</th><th>业务动作</th></tr>'));
					$.each(this.prodInsts,function(){
						_showAttOffer(this.prodInstId);	
					});
				}
			});
		}
	};
	
	//套餐变更销售附属
	var _showChangeAttach = function(){
		$.each(OrderInfo.offer.offerMemberInfos,function(){
			if(this.objType==CONST.OBJ_TYPE.PROD){
				$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.roleName+')</th><th>业务动作</th></tr>'));
				_showAttOffer(this.objInstId);
			}
		});
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			if(this.memberRoleCd==401){
				$.each(this.prodInsts,function(){
					var instid = '"'+this.prodInstId+'"';
					if(instid.indexOf("-")!=-1){
						_showAttOffer(this.prodInstId);
					}
				});
			}
		});
		if(offerChange.oldMemberFlag){
			$.each(OrderInfo.oldoffer,function(){
				$.each(this.offerMemberInfos,function(){
					if(this.objType==CONST.OBJ_TYPE.PROD){
						_showAttOffer(this.objInstId);
					}
				});
			});
		}
	};
	
	//副卡套餐变更销售附属
	var _showMemberChangeAttach = function(){
		if(ec.util.isArray(OrderInfo.viceOfferSpec)){
			$.each(OrderInfo.viceOfferSpec,function(){
//				var prodId=this.prodId;
//				$.each(OrderInfo.offer.offerMemberInfos,function(){
//					if(this.objType==CONST.OBJ_TYPE.PROD&&prodId==this.objInstId){
				$("#chooseTable").append($('<tr><th width="50%">业务名称(基础移动电话)</th><th>业务动作</th></tr>'));
				_showAttOffer(this.prodId);
//					}
//				});
			});
		}
	};
	
	//显示订购的销售品
	var _showAttachOffer = function(){
		var prod = order.prodModify.choosedProdInfo;
		if(prod==undefined || prod.prodInstId ==undefined){
			return true;
		}
		$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));
		_showAttOffer(prod.prodInstId);
	};
	
	//显示的可选包/功能产品
	var _showAttOffer = function(prodId){
		var offerSpecList = CacheData.getOfferSpecList(prodId);
		var offerList = CacheData.getOfferList(prodId);
		var servSpecList = CacheData.getServSpecList(prodId);
		var servList = CacheData.getServList(prodId);
		var appList = CacheData.getOpenAppList(prodId);
		//可选包显示
		if(offerSpecList!=undefined && offerSpecList.length>0){  
			$.each(offerSpecList,function(){ //遍历当前产品下面的附属销售品
				if(this.isdel != "Y" && this.isdel != "C"){  //订购的附属销售品
					if(ec.util.isObj(this.counts)){//组装重复订购的可选包
						for(var i=0;i<this.counts;i++){
							$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+'</td><td>'+CONST.EVENT.OFFER_BUY+'</td></tr>'));
						}
					}else{
						$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+'</td><td>'+CONST.EVENT.OFFER_BUY+'</td></tr>'));
					}
				}
			});
		}
		if(offerList!=undefined && offerList.length>0){
			$.each(offerList,function(){ //遍历当前产品下面的附属销售品
				if(this.isdel == "Y"){  //退订的附属销售品
					if(ec.util.isObj(this.counts)){//组装重复订购的可选包
						for(var i=0;i<this.counts;i++){
							$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+'</td><td>'+CONST.EVENT.OFFER_DEL+'</td></tr>'));
						}
					}else{
						$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+'</td><td>'+CONST.EVENT.OFFER_DEL+'</td></tr>'));
					}
				}else if(this.update == "Y"){
					$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+'</td><td>'+CONST.EVENT.OFFER_UPDATE+'</td></tr>'));
				}else if(ec.util.isObj(this.orderCount)&&ec.util.isObj(this.counts)){
					if(this.orderCount<this.counts){//订购附属销售品
						for(var k=0;k<(this.counts-this.orderCount);k++){
							$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+'</td><td>'+CONST.EVENT.OFFER_BUY+'</td></tr>'));
						}
					}
				}
			});
		}
		//功能产品显示
		if(servSpecList!=undefined && servSpecList.length>0){
			$.each(servSpecList,function(){ //遍历当前产品下面的附属销售品
				if(this.isdel != "Y"  && this.isdel != "C"){  //订购的附属销售品
					$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+'</td><td>'+CONST.EVENT.PROD_OPEN+'</td></tr>'));
				}
			});
		}
		if(servList!=undefined && servList.length>0){
			$.each(servList,function(){ //遍历当前产品下面的附属销售品
				if(this.isdel == "Y"){  //退订的附属销售品
					$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+'</td><td>'+CONST.EVENT.PROD_CLOSE+'</td></tr>'));
				}else if(this.update == "Y"){
					$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+'</td><td>'+CONST.EVENT.PROD_UPDATE+'</td></tr>'));
				}
			});
		}
		if(appList!=undefined && appList.length>0){
			$.each(appList,function(){ //遍历当前产品下面的增值业务
				if(this.dfQty == 1){  //开通增值业务
					$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+'</td><td>'+CONST.EVENT.PROD_OPEN+'</td></tr>'));
				}
			});
		}
		
		//动作链返回显示
		if(OrderInfo.orderResult.autoBoInfos!=undefined){
			$.each(OrderInfo.orderResult.autoBoInfos,function(){
//				if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
//					var instAccessNumber = this.instAccessNumber;
//					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
//						if(instAccessNumber==OrderInfo.oldprodInstInfos[i].accNbr && OrderInfo.oldprodInstInfos[i].prodInstId==prodId){
//							$("#chooseTable").append($('<tr><td width="50%">'+this.specName+'</td><td>'+this.boActionTypeName+'</td></tr>'));
//						}
//					}
//				}else{
					if(this.instAccessNumber==OrderInfo.getAccessNumber(prodId)){
						$("#chooseTable").append($('<tr><td width="50%">'+this.specName+'</td><td>'+this.boActionTypeName+'</td></tr>'));
					}
					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
						if(this.instAccessNumber==OrderInfo.oldprodInstInfos[i].accNbr && OrderInfo.oldprodInstInfos[i].prodInstId==prodId){
							$("#chooseTable").append($('<tr><td width="50%">'+this.specName+'</td><td>'+this.boActionTypeName+'</td></tr>'));
						}
					}
//				}
			});
		}
	};
	
	//订单返回
	var _orderBack = function(){
		//订单返回修改new
		//3G套餐订购4G流量包 订单返回需还原预校验前的缓存信息
		if(CONST.getAppDesc()==0 && OrderInfo.actionFlag==3){
			var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
			var prodId = order.prodModify.choosedProdInfo.prodInstId;
			var specList=CacheData.getOfferSpecList(prodId);
			var flag=false;
			if(ec.util.isArray(specList)){
				$.each(specList,function(){
					if(this.ifPackage4G=="Y" && this.isdel != "Y" && this.isdel != "C"){ //是否有开通4g流量包
						flag = true;
						return false;
					}
				});
			}
			if(flag && prodClass==CONST.PROD_CLASS.THREE){
				AttachOffer.reductionChangList(prodId);
			}
		}
		//不再绑定异常撤单
		SoOrder.delOrderFin();
	
		$("#order_fill_content").show();
		$("#main_conetent").show();
		if(OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){
			$("#order_tab_panel_content").show();
		}
		$("#order_confirm").hide();
		SoOrder.showStep(1);
		OrderInfo.orderData.orderList.custOrderList[0].busiOrder = [];
		OrderInfo.resetSeq(); //重置序列
		SoOrder.delOrder();
		_getToken(); //获取页面步骤
		if(CONST.getAppDesc()!=0){
			$("#custModifyId").show();
		}
	};
	
	//作废购物车
	var _delOrder = function(olId){
		if(olId==undefined){
			olId = OrderInfo.orderResult.olId;
		}
//		var olId = OrderInfo.orderResult.olId;
		if(olId!=0&&olId!=undefined){  //作废购物车
			var param = {
				olId : olId,
				areaId : OrderInfo.getAreaId()
			};
			$.callServiceAsJsonGet(contextPath+"/token/pc/order/delOrder",param,{
				"done" : function(response){
					if (response.code==0) {
						if(response.data.resultCode==0){
							$.alert("提示","购物车作废成功！");
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","购物车作废失败！");
					}
				},
				fail:function(response){
					$.alert("提示","信息","请求可能发生异常，请稍后再试");
				}
			});
		}
	};
	
	var _delOrderBegin = function(){
		$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID, OrderInfo.orderResult.olId);
		$("a[href^='/']").off("mousedown").on("mousedown", function(){
			SoOrder.delOrderSilent();
			window.location.href=this.href;
		});
		//在订单确认和收银台页面关闭浏览器时调用订单作废
		$(window).off("unload").on("unload", function(){
			SoOrder.delOrderSilent();
		});
	};
	var _delOrderSilent = function() {
//		var olId = OrderInfo.orderResult.olId;
		var olId = $.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID);
		$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID, null);
		if(olId!=0&&olId!=undefined && olId != null){  //作废购物车
			var param = {
				olId : olId,
				areaId : OrderInfo.getAreaId(),
				flag: "U"
			};
			var result = $.callServiceAsJsonGet(contextPath+"token/pc/order/delOrder",param);
			//自动撤单时后台会释放该单预占的号码，门户相应更新预占号码表状态（目前撤单不释放预占的UIM，这里也不更新UIM的状态）
			var resources  = [];
			for (var i = 0; i < OrderInfo.boProdAns.length; i++) {	
				var res = {
					accNbr :OrderInfo.boProdAns[i].accessNumber,
					accNbrType : 1,  //号码类型（1手机号码2.UIM卡）
					action : "UPDATE"
				};
				resources.push(res);
			}
			if(resources.length>0){
				var url= contextPath+"/common/updateResState";	 
				$.callServiceAsJsonGet(url,{strParam:JSON.stringify(resources)},{
					"done" : function(response){
						if (response.code==0) {
							if(response.data){
							}
						}
					}
				});	
			}
			OrderInfo.orderData.orderList.custOrderList[0].busiOrder = [];
			OrderInfo.resetSeq(); //重置序列
			_getToken();
			SoOrder.delOrderFin();
		}
	};
	var _delOrderFin = function(){
		$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID, null);
		$("a[href^='/']").off("mousedown");
		$(window).off("unload");
	};
	
	//拆副卡
	var _delViceCard = function(busiOrders,data){
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息 
		var param = {
			offerSpecId : prodInfo.prodOfferId,  //业务规格ID
			offerId : prodInfo.prodOfferInstId,  //业务对象实例ID
			offerTypeCd : "1",
			isUpdate : "Y",
			boActionTypeCd : CONST.BO_ACTION_TYPE.UPDATE_OFFER,
			data : data
		};
		OrderInfo.getOfferBusiOrder(busiOrders,param,data[0].objInstId);
		$.each(data,function(){
			var prod = {
				prodId : this.objInstId, 
				isComp : "Y",
				boActionTypeCd : CONST.BO_ACTION_TYPE.REMOVE_PROD
			};
			busiOrders.push(OrderInfo.getProdBusiOrder(prod));
			$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
				if(this.roleCd == CONST.MEMBER_ROLE_CD.VICE_CARD && this.objInstId== prodId){
					this.isRemove = "Y";//标志是否拆机
					return false;
				}
			});
		});
	};
	
	//销售品成员变更保留副卡订购新套餐拆副卡并订购新套餐
	var _delViceCardAndNew = function(busiOrders,data){		
		//var newData = data ;
		var objInstId="";
        var newData = data.viceParam ;
        _viceParam=newData;
        var ooRoles = data.ooRoles;
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息 
		var param = {
			offerSpecId : prodInfo.prodOfferId,  //业务规格ID
			offerId : prodInfo.prodOfferInstId,  //业务对象实例ID
			offerTypeCd : "1",
			isUpdate : "Y",
			boActionTypeCd : CONST.BO_ACTION_TYPE.UPDATE_OFFER,
			data : data.ooRoles
		};
		$.each(OrderInfo.offer.offerMemberInfos,function(i){
			if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){
				objInstId = this.objInstId;
				return false;
			}
		});
		OrderInfo.getOfferBusiOrder(busiOrders,param,objInstId);		
		//订购副卡主套餐
		for (var i = 0; i < newData.length; i++) {
			if(newData[i].knew=="Y"){
			var offerSpec = newData[i];
			var accessNumber="";
			$.each(OrderInfo.offer.offerMemberInfos,function(){
				if(this.objInstId==offerSpec.objInstId){
					accessNumber=this.accessNumber;
				}
			});
			var busiOrder2 = {
				areaId : prodInfo.areaId,  //受理地区ID
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					objId : offerSpec.offerSpecId,  //业务规格ID
					objName : offerSpec.offerSpecName,
					instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
					isComp : "N", //是否组合
					offerTypeCd : "1" //1主销售品
				},  
				boActionType : {
					actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
					boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
				}, 
				data:{
					ooRoles : [],
					ooOwners : [{
						partyId : OrderInfo.cust.custId, //客户ID
						state : "ADD" //动作
					}]
				}
			};
			if(ec.util.isObj(accessNumber)){
				busiOrder2.busiObj.accessNumber=accessNumber;
			}
			//遍历主销售品构成
			for ( var j = 0; j < OrderInfo.offer.offerMemberInfos.length; j++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[j];
				if(offerMember.objInstId==offerSpec.objInstId){
					var ooRoles = {
						objId : offerMember.objId, //业务规格ID
						objInstId : offerMember.objInstId, //业务对象实例ID,新装默认-1
						objType : offerMember.objType, // 业务对象类型
						offerRoleId : offerSpec.offerRoleId, //销售品角色ID
						state : "ADD" //动作
					};
					busiOrder2.data.ooRoles.push(ooRoles);
					break;
				}
			}
			
			//发展人
			var $tr = $("tr[name='tr_"+offerSpec.offerSpecId+"']");
			if($tr!=undefined){
				busiOrder2.data.busiOrderAttrs = [];
				$tr.each(function(){   //遍历产品有几个发展人
					var dealer = {
							itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
							role : $(this).find("select").val(),
							value : $(this).find("input").attr("staffid"),
							channelNbr : $(this).find("select[name ='dealerChannel_"+offerSpec.offerSpecId+"']").val()
					};
					busiOrder2.data.busiOrderAttrs.push(dealer);
					var dealer_name = {
							itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
							role : $(this).find("select").val(),
							value : $(this).find("input").attr("value") 
					};
					busiOrder2.data.busiOrderAttrs.push(dealer_name);
				});
			}
			
			busiOrders.push(busiOrder2);
			}else{
			var prod = {
						prodId : newData[i].objInstId, 
						isComp : "Y",
						boActionTypeCd : CONST.BO_ACTION_TYPE.REMOVE_PROD
					};
			busiOrders.push(OrderInfo.getProdBusiOrder(prod));
			}
			
			
		}
		
		if(order.memberChange.getSimulateData()){
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					var prodId=this.prodId;
					if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //遍历主销售品构成
						$.each(OrderInfo.offer.offerMemberInfos,function(){
							if(prodId==this.objInstId&&this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
								if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
									var prod = {
											prodId : this.objInstId,
											prodSpecId : this.objId,
											accessNumber : this.accessNumber,
											isComp : "N",
											boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
									};
									var busiOrder = OrderInfo.getProdBusiOrder(prod);
									if(busiOrder){
										busiOrders.push(busiOrder);
									}
								}
							}
						});
					}
				});
			}
			AttachOffer.setAttachBusiOrder(busiOrders);  //订购退订附属销售品
		}
	};
	
	//填充业务对象节点
	var _fillBusiOrder = function(busiOrders,data,isComp) {	
		var prod = order.prodModify.choosedProdInfo; //获取产品信息 
		var boActionTypeCd= OrderInfo.boActionTypeCd;
		var objId= prod.productId;
		var instId=prod.prodInstId;
		var classcd=OrderInfo.actionClassCd;
		var offerTypeCd = "1" ;//1主销售品 
		if(boActionTypeCd==CONST.BO_ACTION_TYPE.ADDOREXIT_COMP){
			objId=prod.prodOfferId;
			instId=prod.prodOfferInstId;
			classcd=CONST.ACTION_CLASS_CD.OFFER_ACTION;
		}
		if(boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){
			objId=OrderInfo.buyBack_orderItemObjId;
			instId=OrderInfo.buyBack_orderItemObjInstId;
			offerTypeCd = "2";//2可选包
		}
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				objId : objId,//prodInfo.productId, //业务对象规格ID
				instId : instId, //业务对象实例ID
				isComp : isComp, //是否组合
				accessNumber : prod.accNbr,   //业务号码
				offerTypeCd : offerTypeCd  //1主销售品
			},  
			boActionType : {
				actionClassCd : classcd,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		
		if(boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_BACK_CHANGE_CARD|| boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_BACK_ORDER_CONTRACT){
			busiOrder.boRelas = OrderInfo.boRelas;			
		}
		busiOrder.data =data;
		busiOrders.push(busiOrder);
	};
	
	//创建订单数据
	var _createOrder = function(busiOrders) {
		//添加客户节点
		if(OrderInfo.cust.custId == -1){
			OrderInfo.createCust(busiOrders);	
		}
		var acctId = $("#acctSelect").find("option:selected").attr("value"); //先写死
		if(acctId < 0 && acctId!=undefined ){
			OrderInfo.createAcct(busiOrders,acctId);	//添加帐户节点
		}
		var busiOrder = _createMainOffer(busiOrders); //添加主销售品节点	
		//遍历主销售品构成,添加产品节点
		for ( var i = 0; i < busiOrder.data.ooRoles.length; i++) {
			var ooRole = busiOrder.data.ooRoles[i];
			if(ooRole.objType==2 && ooRole.memberRoleCd!=undefined){
				busiOrders.push(_createProd(ooRole.objInstId,ooRole.objId));	
			}		
		}
		AttachOffer.setAttachBusiOrder(busiOrders);  //添加可选包跟功能产品
	};
	
	//初始化订单获取token
	var _getToken = function() {
		var response = $.callServiceAsHtmlGet(contextPath+"/token/pc/common/getToken");
		OrderInfo.order.token = response.data;
	};
	
	//获取token的同步请求
	var _getTokenSynchronize = function() {
		var response = $.callServiceAsHtmlGet(contextPath+"/token/pc/common/getToken");
		OrderInfo.order.token = response.data;
	};
	
	//创建主副卡订单数据
	var _createMainOrder = function(busiOrders) {
		var prodInfo = order.prodModify.choosedProdInfo;
		var busiOrder = {
			areaId : prodInfo.areaId,  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				objId : prodInfo.prodOfferId,  //业务规格ID
				instId : prodInfo.prodOfferInstId, //业务对象实例ID
				accessNumber : prodInfo.accNbr, //业务号码
				isComp : "Y", //是否组合
				offerTypeCd : "1" //1主销售品
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP
			}, 
			data:{
				ooRoles : []			
			}
		};
		
		if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//纳入老用户
			var offerRoleId = "";
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
//					if(offerRole.prodInsts!=undefined && offerRole.prodInsts.length>0){
//						for ( var j = 0; j < offerRole.prodInsts.length; j++) {
//							var prodInst = offerRole.prodInsts[j];
							offerRoleId = offerRole.offerRoleId;
							break;
//						}		
//					}
				} 
			}
			
			//[W]
			var action_type = (OrderInfo.hasMainCarFlag) ? CONST.BO_ACTION_TYPE.DEL_OFFER : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;
			
			for(var q=0;q<OrderInfo.oldprodInstInfos.length;q++){
				var oldprodInfo = OrderInfo.oldprodInstInfos[q];
				var oldbusiOrder = {
						areaId : oldprodInfo.areaId,  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							objId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferId,  //业务规格ID
							instId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferInstId, //业务对象实例ID
							accessNumber : oldprodInfo.accNbr, //业务号码
							isComp : "Y", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER
						}, 
						data:{
							ooRoles : []			
						}
					};
				var memberid = -1;
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) {
					if(OrderInfo.oldoffer[i].accNbr==oldprodInfo.accNbr){
						$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
							if(this.objType==CONST.OBJ_TYPE.PROD){
								var ooRole = {
									objId : this.objId,
									objInstId : this.objInstId,
									objType : this.objType,
									offerMemberId : memberid,
									offerRoleId : offerRoleId,
									state : "ADD"
								};
								busiOrder.data.ooRoles.push(ooRole);
								var oldooRole = {
										objId : this.objId,
										objInstId : this.objInstId,
										objType : this.objType,
										offerMemberId : this.offerMemberId,
										offerRoleId : this.offerRoleId,
										state : "DEL"
									};
								oldbusiOrder.data.ooRoles.push(oldooRole);
								--memberid;
							}
						});
					}
				}
				busiOrders.push(oldbusiOrder);
			}
			if(CONST.getAppDesc()==0){ //4g系统需要,补换卡 
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) { //遍历主销售品构成
					$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
							if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
								var prod = {
									prodId : this.objInstId,
									prodSpecId : this.objId,
									accessNumber : this.accessNumber,
									isComp : "N",
									boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
								};
								var busiOrder = OrderInfo.getProdBusiOrder(prod);
								if(busiOrder){
									busiOrders.push(busiOrder);
								}
							}
						}
					});
				}
			}
		}
		if(order.memberChange.newMemberFlag){
			//遍历主销售品构成
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
					if(offerRole.prodInsts!=undefined && offerRole.prodInsts.length>0){
						for ( var j = 0; j < offerRole.prodInsts.length; j++) {
							var prodInst = offerRole.prodInsts[j];
							var ooRole = {
								objId : prodInst.objId,
								objInstId : prodInst.prodInstId,
								objType : prodInst.objType,
								offerMemberId : OrderInfo.SEQ.offerMemberSeq--,
								offerRoleId : prodInst.offerRoleId,
								state : "ADD"
							};
							busiOrder.data.ooRoles.push(ooRole);
							busiOrders.push(_createProd(prodInst.prodInstId,prodInst.objId));	
						}		
					}
				} 
			} 
		}
		if(order.memberChange.changeMemberFlag){
//			var objInstId="";
	        var newData = order.memberChange.viceparams;
//	        _viceParam=newData;
	        var ooRoles = order.memberChange.ooRoless;
			var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息 
//			var param = {
//				offerSpecId : prodInfo.prodOfferId,  //业务规格ID
//				offerId : prodInfo.prodOfferInstId,  //业务对象实例ID
//				offerTypeCd : "1",
//				isUpdate : "Y",
//				boActionTypeCd : CONST.BO_ACTION_TYPE.UPDATE_OFFER,
//				data : data.ooRoles
//			};
//			$.each(OrderInfo.offer.offerMemberInfos,function(i){
//				if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){
//					objInstId = this.objInstId;
//					return false;
//				}
//			});
//			OrderInfo.getOfferBusiOrder(busiOrders,param,objInstId);	
	        $.each(ooRoles,function(){
	        	busiOrder.data.ooRoles.push(this);
	        });
//			busiOrder.data.ooRoles.push(ooRoles);
			//订购副卡主套餐
			for (var i = 0; i < newData.length; i++) {
				if(newData[i].knew=="Y"){
					var offerSpec = newData[i];
					var accessNumber="";
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objInstId==offerSpec.objInstId){
							accessNumber=this.accessNumber;
						}
					});
					var busiOrder2 = {
						areaId : prodInfo.areaId,  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							objId : offerSpec.offerSpecId,  //业务规格ID
							objName : offerSpec.offerSpecName,
							instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
							isComp : "N", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
						}, 
						data:{
							ooRoles : [],
							ooOwners : [{
								partyId : OrderInfo.cust.custId, //客户ID
								state : "ADD" //动作
							}]
						}
					};
					if(ec.util.isObj(accessNumber)){
						busiOrder2.busiObj.accessNumber=accessNumber;
					}
					//遍历主销售品构成
					for ( var j = 0; j < OrderInfo.offer.offerMemberInfos.length; j++) {
						var offerMember = OrderInfo.offer.offerMemberInfos[j];
						if(offerMember.objInstId==offerSpec.objInstId){
							var ooRoles = {
								objId : offerMember.objId, //业务规格ID
								objInstId : offerMember.objInstId, //业务对象实例ID,新装默认-1
								objType : offerMember.objType, // 业务对象类型
								offerRoleId : offerSpec.offerRoleId, //销售品角色ID
								state : "ADD" //动作
							};
							busiOrder2.data.ooRoles.push(ooRoles);
							break;
						}
					}
					
					//发展人
					var $tr = $("tr[name='tr_"+offerSpec.offerSpecId+"']");
					if($tr!=undefined){
						busiOrder2.data.busiOrderAttrs = [];
						$tr.each(function(){   //遍历产品有几个发展人
							var dealer = {
									itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
									role : $(this).find("select").val(),
									value : $(this).find("input").attr("staffid") 
							};
							busiOrder2.data.busiOrderAttrs.push(dealer);
							var dealer_name = {
									itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
									role : $(this).find("select").val(),
									value : $(this).find("input").attr("value") 
							};
							busiOrder2.data.busiOrderAttrs.push(dealer_name);
						});
					}
					
					busiOrders.push(busiOrder2);
				}else{
					var prod = {
								prodId : newData[i].objInstId, 
								isComp : "Y",
								boActionTypeCd : CONST.BO_ACTION_TYPE.REMOVE_PROD
							};
					busiOrders.push(OrderInfo.getProdBusiOrder(prod));
				}
				
				
			}
			if(order.memberChange.getSimulateData()){
				if(ec.util.isArray(OrderInfo.viceOfferSpec)){
					$.each(OrderInfo.viceOfferSpec,function(){
						var prodId=this.prodId;
						if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //遍历主销售品构成
							$.each(OrderInfo.offer.offerMemberInfos,function(){
								if(prodId==this.objInstId&&this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
									if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
										var prod = {
												prodId : this.objInstId,
												prodSpecId : this.objId,
												accessNumber : this.accessNumber,
												isComp : "N",
												boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
										};
										var busiOrder = OrderInfo.getProdBusiOrder(prod);
										if(busiOrder){
											busiOrders.push(busiOrder);
										}
									}
								}
							});
						}
					});
				}
//				AttachOffer.setAttachBusiOrder(busiOrders);  //订购退订附属销售品
			}
		}
		AttachOffer.setAttachBusiOrder(busiOrders);//添加附属
		busiOrders.push(busiOrder);
	};
	
	//创建主副卡订单数据
	var _delAndNew = function(busiOrders,newDataMap) {
		var newData = newDataMap ;
		var remark = "" ; 
		var allDel=true;
		var v_actionClassCd = CONST.ACTION_CLASS_CD.OFFER_ACTION;
		var v_boActionTypeCd = CONST.BO_ACTION_TYPE.DEL_OFFER;
		var v_actionClassCd2 = CONST.ACTION_CLASS_CD.OFFER_ACTION;
		var v_boActionTypeCd2 = CONST.BO_ACTION_TYPE.BUY_OFFER;
		if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
			v_actionClassCd = CONST.ACTION_CLASS_CD.PROD_ACTION;//产品及服务动作
			v_boActionTypeCd = CONST.BO_ACTION_TYPE.BUY_BACK;//返销
			v_actionClassCd2 = CONST.ACTION_CLASS_CD.OFFER_ACTION;//销售品动作
			v_boActionTypeCd2 = CONST.BO_ACTION_TYPE.BUY_OFFER;//订购销售品
			v_boActionTypeCdAdd =CONST.BO_ACTION_TYPE.BUY_BACK;//副卡带出动作小类
			newData = newDataMap.viceParam ;
			remark = newDataMap.remark; 
		}else if(OrderInfo.actionFlag==7){
			v_boActionTypeCdAdd =CONST.BO_ACTION_TYPE.REMOVE_PROD;//副卡带出动作小类
		}
		for (var i = 0; i < newData.length; i++) {
			var offerSpec = newData[i];
			if(offerSpec.del=='N'){
				allDel=false;
			}
		}
		if(allDel){
			_viceParam=newData;
			var busiOrder = {
					areaId : OrderInfo.getProdAreaId(order.prodModify.choosedProdInfo.prodInstId),  //受理地区ID
					busiOrderInfo : {
						seq : OrderInfo.SEQ.seq--
					}, 
					busiObj : { //业务对象节点
						accessNumber : order.prodModify.choosedProdInfo.accNbr,
						objId : order.prodModify.choosedProdInfo.productId,  //业务规格ID,prod.prodOfferId
						instId : order.prodModify.choosedProdInfo.prodInstId, //业务对象实例ID,prod.prodOfferInstId
						isComp : "N", //是否组合
						offerTypeCd : "1" //1主销售品
					},  
					boActionType : {
						actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
						boActionTypeCd : OrderInfo.boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
					},
					data:{
						boProdStatuses :[{
							prodStatusCd : order.prodModify.choosedProdInfo.prodStateCd,
							state : "DEL"
						},{
							prodStatusCd : (OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD) ? CONST.PROD_STATUS_CD.STOP_PROD : CONST.PROD_STATUS_CD.REMOVE_PROD,
							state : "ADD"
						}],
						busiOrderAttrs:[]
					}
				};
			/*var remark = $('#order_remark').val();   //订单备注
			if(remark!=""&&remark!=undefined){
				busiOrder.data.busiOrderAttrs.push({
					itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
					value : remark
				});	
			}*/
				busiOrders.push(busiOrder);	
			for (var i = 0; i < newData.length; i++) {
				var offerSpec = newData[i];
				var busiOrder = {
						areaId : OrderInfo.getProdAreaId(offerSpec.prodInstId),  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							accessNumber :offerSpec.accessNumber,
							objId : offerSpec.objId,  //业务规格ID,prod.prodOfferId
							instId : offerSpec.objInstId, //业务对象实例ID,prod.prodOfferInstId
							isComp : "N", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : OrderInfo.boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
						},
						data:{
							boProdStatuses :[/*{
								prodStatusCd :order.prodModify.choosedProdInfo.prodStateCd,
								state : "DEL"
							},*/
							{
								prodStatusCd : (OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD) ? CONST.PROD_STATUS_CD.STOP_PROD : CONST.PROD_STATUS_CD.REMOVE_PROD,
								state : "ADD"
							}],
							busiOrderAttrs:[]
						}
					};
				/*var remark = $('#order_remark').val();   //订单备注
				if(remark!=""&&remark!=undefined){
					busiOrder.data.busiOrderAttrs.push({
						itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
						value : remark
					});	
				}*/
					busiOrders.push(busiOrder);	
			}
			return;
		}
		if(OrderInfo.actionFlag==7){ //7 拆主卡保留副卡
			_viceParam=newData;
			//退订主套餐
			var prod = order.prodModify.choosedProdInfo;
			var busiOrder = {
				areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					objId : prod.prodOfferId,  //业务规格ID,prod.prodOfferId
					instId : prod.prodOfferInstId, //业务对象实例ID,prod.prodOfferInstId
					isComp : "N", //是否组合
					offerTypeCd : "1" //1主销售品
				},  
				boActionType : {
					actionClassCd : v_actionClassCd,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
					boActionTypeCd : v_boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
				},
				data:{
					ooRoles : [],	
					ooOwners : [{
						partyId : OrderInfo.cust.custId, //客户ID
						state : "DEL" //动作
					}]
				}
			};
			//遍历主销售品构成
			for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[i];
				var ooRoles = {
					objId : offerMember.objId, //业务规格ID
					objInstId : offerMember.objInstId, //业务对象实例ID,新装默认-1
					objType : offerMember.objType, // 业务对象类型
					offerMemberId : offerMember.offerMemberId, //成员id
					offerRoleId : offerMember.offerRoleId, //销售品角色ID
					state : "DEL" //动作
				};
				busiOrder.data.ooRoles.push(ooRoles);
			}
			busiOrders.push(busiOrder);	
			/*var prod = {
				prodId : this.objInstId, 
				isComp : "Y",
				boActionTypeCd : CONST.BO_ACTION_TYPE.REMOVE_PROD
			};
			busiOrders.push(OrderInfo.getProdBusiOrder(prod));*/
		}else {
			//反销主卡
			var prod = order.prodModify.choosedProdInfo;
			var busiOrder = {
				areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					objId : prod.productId,  //业务规格ID,prod.prodOfferId
					instId : prod.prodInstId, //业务对象实例ID,prod.prodOfferInstId
					accessNumber : prod.accNbr, //接入号码
					isComp : "N" //是否组合
				},  
				boActionType : {
					actionClassCd : v_actionClassCd,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
					boActionTypeCd : v_boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
				},
				data:{
					boProdStatuses : [
					  {
						  "prodStatusCd": CONST.PROD_STATUS_CD.NORMAL_PROD,
	                        "state": "DEL"
					  },{
						  "prodStatusCd": CONST.PROD_STATUS_CD.REMOVE_PROD,
	                        "state": "ADD"
					  }
					],	
					busiOrderAttrs : []
				}
			};
			/*//订单属性
			if(remark!=undefined&&remark!=""){
				busiOrder.data.busiOrderAttrs.push({
					itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
					value : remark
				});	
			}*/
			busiOrders.push(busiOrder);	
		}
		
		//订购副卡主套餐
		for (var i = 0; i < newData.length; i++) {
			var offerSpec = newData[i];
			if(offerSpec.del=="N"){
			var busiOrder2 = {
				areaId : OrderInfo.getAreaId(),  //受理地区ID
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					objId : offerSpec.offerSpecId,  //业务规格ID
					instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
					isComp : "N", //是否组合
					offerTypeCd : "1" //1主销售品
				},  
				boActionType : {
					actionClassCd : v_actionClassCd2,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
					boActionTypeCd : v_boActionTypeCd2//CONST.BO_ACTION_TYPE.BUY_OFFER
				}, 
				data:{
					ooRoles : [],
					ooOwners : [{
						partyId : OrderInfo.cust.custId, //客户ID
						state : "ADD" //动作
					}]
				}
			};
			//遍历主销售品构成
			for ( var j = 0; j < OrderInfo.offer.offerMemberInfos.length; j++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[j];
				if(offerMember.objInstId==offerSpec.objInstId){
					var ooRoles = {
						objId : offerMember.objId, //业务规格ID
						objInstId : offerMember.objInstId, //业务对象实例ID,新装默认-1
						objType : offerMember.objType, // 业务对象类型
						offerRoleId : offerSpec.offerRoleId, //销售品角色ID
						state : "ADD" //动作
					};
					busiOrder2.data.ooRoles.push(ooRoles);
					break;
				}
			}
			busiOrders.push(busiOrder2);
		}else{
				var busiOrder = {
						areaId : OrderInfo.getProdAreaId(offerSpec.prodInstId),  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							accessNumber :offerSpec.accessNumber,
							objId : offerSpec.objId,  //业务规格ID,prod.prodOfferId
							instId : offerSpec.objInstId, //业务对象实例ID,prod.prodOfferInstId
							isComp : "N", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : OrderInfo.boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
						},
						data:{
							boProdStatuses :[/*{
								prodStatusCd :order.prodModify.choosedProdInfo.prodStateCd,
								state : "DEL"
							},*/
							{
								prodStatusCd : (OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD) ? CONST.PROD_STATUS_CD.STOP_PROD : CONST.PROD_STATUS_CD.REMOVE_PROD,
								state : "ADD"
							}],
							busiOrderAttrs:[]
						}
					};
				/*var remark = $('#order_remark').val();   //订单备注
				if(remark!=""&&remark!=undefined){
					busiOrder.data.busiOrderAttrs.push({
						itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
						value : remark
					});	
				}*/
					busiOrders.push(busiOrder);	
		}
		}
	};
	
	//创建附属销售品订单数据
	var _createAttOrder = function(busiOrders){	
		AttachOffer.setAttachBusiOrder(busiOrders);		
		var prodInfo = order.prodModify.choosedProdInfo;
		if(AttachOffer.isChangeUim(prodInfo.prodInstId)){
			if(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0){
				var prod = {
					prodId : prodInfo.prodInstId,
					prodSpecId : prodInfo.productId,
					isComp : "N",
					accessNumber : prodInfo.accNbr,
					boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
				};
				busiOrders.push(OrderInfo.getProdBusiOrder(prod));
			}
		}
	};
	
	//创建附属销售品订单数据
	var _createCustOrder = function(busiOrders,data){	
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : OrderInfo.cust.custId //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : OrderInfo.actionClassCd,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		busiOrder.data =data;
		busiOrders.push(busiOrder);
	};
	//创建活卡销售返档订单数据
	var _ActiveReturnOrder = function(busiOrders,data){
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				accessNumber: order.prodModify.choosedProdInfo.accNbr,
				instId : OrderInfo.cust.custId //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : OrderInfo.actionClassCd,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		busiOrder.data =data;
		busiOrders.push(busiOrder);
		var busiOrderAdd = {
				areaId : OrderInfo.getAreaId(),  //受理地区ID		
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					accessNumber: order.prodModify.choosedProdInfo.accNbr,
					instId : order.prodModify.choosedProdInfo.prodInstId, //业务对象实例ID
					objId :order.prodModify.choosedProdInfo.productId
				},  
				boActionType : {
					actionClassCd: CONST.ACTION_CLASS_CD.PROD_ACTION,
                    boActionTypeCd: CONST.BO_ACTION_TYPE.ACTIVERETURNTWO
				}, 
				data:{}
			};
		busiOrderAdd.data.boProdStatuses = [{
			prodStatusCd : CONST.PROD_STATUS_CD.READY_PROD,
			state : "DEL"
		},{
			prodStatusCd : CONST.PROD_STATUS_CD.DONE_PROD,
			state : "ADD"
		}
		];
		busiOrders.push(busiOrderAdd);
	};
	//创建客户单独订单
	var _createCustOrderOnly = function(busiOrders,data){
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : -1 //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : OrderInfo.actionClassCd,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		busiOrder.data =data;
		busiOrders.push(busiOrder);
	};
	
	
	//创建主销售品节点
	var _createMainOffer = function(busiOrders) {
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(-1),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				objId : OrderInfo.offerSpec.offerSpecId,  //业务规格ID
				instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
				isComp : "N", //是否组合
				offerTypeCd : "1" //1主销售品
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
			}, 
			data:{
				ooRoles : [],
				ooOwners : [],
				busiOrderAttrs : []
			}
		};
		var accNbr = OrderInfo.getAccessNumber(-1);
		if(ec.util.isObj(accNbr)){ //接入号
			busiOrder.busiObj.accessNumber = accNbr;
		}		
		//遍历主销售品构成
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			$.each(this.prodInsts,function(){
				var ooRoles = {
					objId : this.objId, //业务规格ID
					objInstId : this.prodInstId, //业务对象实例ID,新装默认-1
					objType : this.objType, // 业务对象类型
					memberRoleCd : this.memberRoleCd, //成员角色类型
					offerRoleId : this.offerRoleId, //销售品角色ID
					state : "ADD" //动作
				};
				busiOrder.data.ooRoles.push(ooRoles);  //接入类产品
				var prodId = this.prodInstId;
				if(this.servInsts!=undefined && this.servInsts.length>0){ //功能类产品
					$.each(this.servInsts,function(){
						var ooRoles = {
							objId : this.objId, //业务规格ID
							objInstId : OrderInfo.SEQ.servSeq--, //业务对象实例ID,新装默认-1
							objType : this.objType, // 业务对象类型
							prodId : prodId,
							//memberRoleCd : this.memberRoleCd, //成员角色类型
							offerRoleId : this.offerRoleId, //销售品角色ID
							state : "ADD" //动作
						};
						busiOrder.data.ooRoles.push(ooRoles); //功能类产品
					});
				}
			});
		}); 
		
		if(order.service.oldMemberFlag){//纳入老用户
			var offerRoleId = "";
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
							offerRoleId = offerRole.offerRoleId;
							break;
				} 
			}
			for(var q=0;q<OrderInfo.oldprodInstInfos.length;q++){
				var oldprodInfo = OrderInfo.oldprodInstInfos[q];
				var oldbusiOrder = {
						areaId : oldprodInfo.areaId,  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							objId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferId,  //业务规格ID
							instId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferInstId, //业务对象实例ID
							accessNumber : oldprodInfo.accNbr, //业务号码
							isComp : "Y", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER
						}, 
						data:{
							ooRoles : []			
						}
					};
				
					var memberid = -1;
					for ( var i = 0; i < OrderInfo.oldoffer.length; i++) {
						if(OrderInfo.oldoffer[i].accNbr==oldprodInfo.accNbr){
							$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
								//if((this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD || this.roleCd=="1") && this.objType=="2"){
								if(this.objType==CONST.OBJ_TYPE.PROD){
									var ooRole = {
										objId : this.objId,
										objInstId : this.objInstId,
										objType : this.objType,
										offerMemberId : memberid,
										offerRoleId : offerRoleId,
										state : "ADD"
									};
									busiOrder.data.ooRoles.push(ooRole);
									var oldooRole = {
											objId : this.objId,
											objInstId : this.objInstId,
											objType : this.objType,
											offerMemberId : this.offerMemberId,
											offerRoleId : this.offerRoleId,
											state : "DEL"
										};
									oldbusiOrder.data.ooRoles.push(oldooRole);
									--memberid;
								}
							});
						}
					}
				busiOrders.push(oldbusiOrder);
			}
			if(CONST.getAppDesc()==0){ //4g系统需要,补换卡 
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) { //遍历主销售品构成
					$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
							if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
								var prod = {
									prodId : this.objInstId,
									prodSpecId : this.objId,
									accessNumber : this.accessNumber,
									isComp : "N",
									boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
								};
								var busiOrder = OrderInfo.getProdBusiOrder(prod);
								if(busiOrder){
									busiOrders.push(busiOrder);
								}
							}
						}
					});
				}
			}
		}
		
		//销售参数节点
		var offerSpecParams = OrderInfo.offerSpec.offerSpecParams;
		if(offerSpecParams!=undefined && offerSpecParams.length>0){  
			busiOrder.data.ooParams = [];
			for (var i = 0; i < offerSpecParams.length; i++) {
				var param = offerSpecParams[i];
				var ooParam = {
	                itemSpecId : param.itemSpecId,
	                offerParamId : OrderInfo.SEQ.paramSeq--,
	                offerSpecParamId : param.offerSpecParamId,
	                value : param.value,
	                state : "ADD"
	            };
	            busiOrder.data.ooParams.push(ooParam);
			}				
		}
		
		//销售生失效时间节点
		if(OrderInfo.offerSpec.ooTimes !=undefined ){  
			busiOrder.data.ooTimes = [];
			busiOrder.data.ooTimes.push(OrderInfo.offerSpec.ooTimes);
		}
		
		//所属人节点
		var ooOwners = {
			partyId : OrderInfo.cust.custId, //客户对象ID
			state : "ADD" //动作
		};
		busiOrder.data.ooOwners.push(ooOwners);
		
		//发展人
		var $tr = $("#dealerTbody tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");
		if($tr!=undefined){
			$tr.each(function(){   //遍历产品有几个发展人
				var dealer = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
					role : $(this).find("select").val(),
					value : $(this).find("input").attr("staffid"),
					channelNbr : $(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()
				};
				busiOrder.data.busiOrderAttrs.push(dealer);
				var dealer_name = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("value")
				};
				busiOrder.data.busiOrderAttrs.push(dealer_name);
			});
		}
		
		busiOrders.push(busiOrder);
		return busiOrder;
	};
	
	//创建产品节点
	var _createProd = function(prodId,prodSpecId) {	
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prodId),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq-- 
			}, 
			busiObj : { //业务对象节点
				objId : prodSpecId,  //业务对象ID
				instId : prodId, //业务对象实例ID
				isComp : "N"  //是否组合
				//accessNumber : "" //接入号码
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,
				boActionTypeCd : "1"
			}, 
			data:{
				boProdFeeTypes : [], //付费方式节点
				boProdSpecs : [{
					prodSpecId : prodSpecId,
					state : 'ADD'
				}], //产品规格节点
				boCusts : [],  //客户信息节点		
				boProdItems : [], //产品属性节点
				boProdPasswords : [], //产品密码节点
				boProdAns : [], //号码信息节点
				//boProd2Tds : [], //UIM卡节点信息
				bo2Coupons : [],  //物品信息节点
				boAccountRelas : [], //帐户关联关系节
				boProdStatuses : [], //产品状态节点
				busiOrderAttrs : [] //订单属性节点
			}
		};
		
		var prodStatus = CONST.PROD_STATUS_CD.NORMAL_PROD;
		if($("#isActivation").attr("checked")=="checked"){//首话单激活
			prodStatus = CONST.PROD_STATUS_CD.DONE_PROD;
		}else if($("#isTemplateOrder").attr("checked")=="checked"){ //批量订单
			if($("#templateOrderDiv").find("select").val()==0){ //批量开活卡
				prodStatus = CONST.PROD_STATUS_CD.READY_PROD;	
			}
		}
		//封装产品状态节点
		busiOrder.data.boProdStatuses.push({
			state : "ADD",
			prodStatusCd : prodStatus
		});	
			
		//封装号码信息节点
		var boProdAns = OrderInfo.boProdAns;
		for ( var i = 0; i < boProdAns.length; i++) {
			if(boProdAns[i].prodId==prodId){
				busiOrder.data.boProdAns.push(boProdAns[i]);
				busiOrder.busiObj.accessNumber = boProdAns[i].accessNumber;
				break;
			}
		}
		
		//封装UIM卡信息节点
		var boProd2Tds = OrderInfo.boProd2Tds;
		for ( var i = 0; i < boProd2Tds.length; i++) {
			if(boProd2Tds[i].prodId==prodId){
				busiOrder.data.bo2Coupons.push(boProd2Tds[i]);
				break;
			}
		}
		
		/*//封装物品信息节点
		var bo2Coupons = OrderInfo.bo2Coupons;
		for ( var i = 0; i < bo2Coupons.length; i++) {
			if( bo2Coupons[i].prodId==prodId){
				busiOrder.data.bo2Coupons = bo2Coupons[i].coupons;
				break;
			}
		}*/
		
		//封装客户与产品之间的关系信息
		busiOrder.data.boCusts.push({
			partyId	: OrderInfo.cust.custId, //客户ID
			partyProductRelaRoleCd : "0", //客户与产品之间的关系（担保关系）
			state : "ADD" //动作
		});
		
		//封装产品密码
		var pwd=$("#pwd_"+prodId).val();
		if(pwd=="******"){
			pwd = order.main.genRandPass6();
		}
		var boProdPassword = {
			prodPwTypeCd : 2, //密码类型
			pwd : pwd, //密码
			state : "ADD"  //动作
		};
		busiOrder.data.boProdPasswords.push(boProdPassword);
		
		//封装产品属性
		$("[name=prodSpec_"+prodId+"]").each(function(){
			var itemSpecId=$(this).attr("id").split("_")[0];
			//防止提交重复的产品属性
			var exist = false;
			for(var i=0;i<busiOrder.data.boProdItems.length;i++){
				if(busiOrder.data.boProdItems[i].itemSpecId == itemSpecId){
					exist = true;
					break;
				}
			}
			if(!exist){
				var val=$.trim($(this).val());
				if(val!=""&&val!=undefined){
					var prodSpecItem = {
							itemSpecId : itemSpecId,  //属性规格ID
							prodSpecItemId : OrderInfo.SEQ.itemSeq--, //产品属性实例ID
							state : "ADD", //动作
							value : val//属性值	
					};
					busiOrder.data.boProdItems.push(prodSpecItem);
				}
			}
		});
		
		//封装付费方式
		//var paytype=$('select[name="pay_type_'+prodId+'"]').val(); 
		var paytype=$('select[name="pay_type_-1"]').val();  //先写死
		if(paytype!= undefined){
			busiOrder.data.boProdFeeTypes.push({
				feeType : paytype,
				state : "ADD"
			});
		}
		
		//封装付费方式
		/*$("[name=prodSpec_"+prodId+"]").each(function(){
			var itemSpecId=$(this).attr("id").split("_")[0];
			if(itemSpecId==CONST.PROD_ATTR.FEE_TYPE){ //付费方式
				busiOrder.data.boProdFeeTypes.push({
					feeType : $(this).val(),
					state : "ADD"
				});
				return false;
			}
		});
		*/
		/*//订单属性
		var remark = $('#order_remark').val();   //订单备注
		if(remark!=""&&remark!=undefined){
			busiOrder.data.busiOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
				value : remark
			});	
		}*/
		//发展人
		var $tr;
		var objInstId_dealer;
		if(OrderInfo.actionFlag==6){ //加装发展人根据产品
			objInstId_dealer = prodId;
			$tr = $("tr[name='tr_"+prodId+"']");
		}else{
			objInstId_dealer = OrderInfo.offerSpec.offerSpecId;
			$tr = $("#dealerTbody tr[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");
		}
		if($tr!=undefined){
			$tr.each(function(){   //遍历产品有几个发展人
				var dealer = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
					role : $(this).find("select").val(),
					value : $(this).find("input").attr("staffid"),
					channelNbr : $(this).find("select[name ='dealerChannel_"+objInstId_dealer+"']").val()
				};
				busiOrder.data.busiOrderAttrs.push(dealer);
				var dealer_name = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("value") 
				};
				busiOrder.data.busiOrderAttrs.push(dealer_name);
			});
		}
		
		var $option = $("#acctSelect").find("option:selected");
		var acctId = $option.attr("value");
		var acctCd = -1;
		if(acctId==undefined){
			acctId = -1;
			acctCd = -1;
		}else if(acctId<0 ){ //新增
			acctCd = acctId;
		}else{
			acctCd = $option.attr("acctcd");
		}
		var boAccountRela = {
			acctId : acctId,
			acctCd : acctCd,
			acctRelaTypeCd : "1", //帐户和产品关联原因
			chargeItemCd : "0", //帐户主要费用类型
			percent : "100", //付费比例
			priority : "1",  //付费优先级
			state : "ADD" //动作
		};
		
		busiOrder.data.boAccountRelas.push(boAccountRela);	
		return busiOrder;
	};
	
	//创建附属销售品节点
	var _createAttOffer = function(offerSpec,prodId,flag,busiOrders) {
		if(flag==1){  //退订附属
			offerSpec.offerTypeCd = 2;
			offerSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.DEL_OFFER;
			OrderInfo.getOfferBusiOrder(busiOrders,offerSpec,prodId);
		}else if(flag==2){  //参数变更
			if(offerSpec.offerSpec.offerSpecParams!=undefined && offerSpec.offerSpec.offerSpecParams.length>0){  //销售参数节点
				offerSpec.offerTypeCd = 2;
				offerSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.UPDATE_OFFER;
				OrderInfo.getOfferBusiOrder(busiOrders,offerSpec,prodId);
			}
			/*if(offerSpec.offerMembers!=undefined && offerSpec.offerMembers.length>0){ //设置功能产品参数	 
				for (var i = 0; i < offerSpec.offerMembers.length; i++) {
					var offerMember = offerSpec.offerMembers[i];
					if(offerMember.prodParamInfos.length >0){
						offerMember.boActionTypeCd = CONST.BO_ACTION_TYPE.PRODUCT_PARMS;
						offerMember.prodId = prodId;
						offerMember.prodSpecId = offerMember.objId;
						busiOrders.push(OrderInfo.getProdBusiOrder(offerMember));
					}
				}
			}*/
		}else{ //订购
			offerSpec.offerTypeCd = 2;
			offerSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.BUY_OFFER;
			offerSpec.offerId = OrderInfo.SEQ.offerSeq--; 
			OrderInfo.getOfferBusiOrder(busiOrders,offerSpec,prodId);			
		}
	};
	
	//创建功能产品节点
	var _createServ = function(servSpec,prodId,flag,busiOrders) {
		servSpec.prodId = prodId;
		if(flag==1){  //退订附属
			servSpec.servClose = "Y";
			servSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.SERV_OPEN;
			busiOrders.push(OrderInfo.getProdBusiOrder(servSpec));	
		}else if(flag==2){  //参数变更
			if(servSpec.prodSpecParams!=undefined && servSpec.prodSpecParams.length>0){  //设置功能产品参数	
				servSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.PRODUCT_PARMS;
				servSpec.memberId = servSpec.servId;
				busiOrders.push(OrderInfo.getProdBusiOrder(servSpec));
			}
		}else{ //订购
			servSpec.servId = OrderInfo.SEQ.servSeq--;
			servSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.SERV_OPEN;		
			busiOrders.push(OrderInfo.getProdBusiOrder(servSpec));	
		}
	};
	
	//改号
	var _changeNumber = function(busiOrders){
		var data = {};
		data.boProdAns = OrderInfo.boProdAns;
		OrderInfo.setProdModifyBusiOrder(busiOrders,data);
	};	
	
	//订单数据校验
	var _checkData = function() {	
		if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 14 || (OrderInfo.actionFlag==2&&offerChange.newMemberFlag)){ //新装
			if(OrderInfo.cust.custId==""){
				$.alert("提示","客户信息不能为空！");
				return false ; 
			}
			//遍历主销售品构成
			if(OrderInfo.order.dealerTypeList==undefined ||OrderInfo.order.dealerTypeList.length == 0 ){
				$.alert("提示","发展人类型不能为空！");
				return false ; 
			}
			//纳入老用户判断主卡副卡账户一致
			if(ec.util.isArray(OrderInfo.oldprodAcctInfos)){
				for(var a=0;a<OrderInfo.oldprodAcctInfos.length;a++){
					var oldacctId = OrderInfo.oldprodAcctInfos[a].prodAcctInfos[0].acctId;
					var mainacctid = $("#acctSelect option:selected").val();
					if(oldacctId!=mainacctid){
						$.alert("提示","副卡和主卡的账户不一致！");
						return false ; 
					}
				}
			}
			
			if(order.service.oldMemberFlag){
				var paytype=$('select[name="pay_type_-1"]').val();
				var isNumberRight=0;
				var nowNum="";
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.feeType.feeType!=paytype){
						isNumberRight=1;
						nowNum=this.accNbr;
						return;
					}
				});
				
				if(isNumberRight==1){
					//$.alert("提示",nowNum+"和主卡的付费类型不一致！");
				//	return false;
				}
			}
			
			//校验号码跟UIM卡
			if(!(order.memberChange.oldMemberFlag && !order.memberChange.newMemberFlag  && !order.memberChange.changeMemberFlag) &&
					!(!order.memberChange.oldMemberFlag && !order.memberChange.newMemberFlag  && order.memberChange.changeMemberFlag)){
				for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
					var offerRole = OrderInfo.offerSpec.offerRoles[i];
					var prodInsts=OrderInfo.offerSpec.offerRoles[i].prodInsts;
					if(prodInsts!=undefined && prodInsts!=null && prodInsts!=""){
					for ( var j = 0; j < offerRole.prodInsts.length; j++) {
						var prodInst = offerRole.prodInsts[j];
						if(OrderInfo.actionFlag==2){
							var instid = '"'+prodInst.prodInstId+'"';
							if(prodInst.memberRoleCd=="401" && instid.indexOf("-")!=-1){
								var accNbr = OrderInfo.getProdAn(prodInst.prodInstId).accessNumber;
								var password = $("#pwd_"+prodInst.prodInstId).val();
								if(password!="******"){
									if(!order.main.passwordCheckVal(password, accNbr)){
										return false ;
									}
								}
								if(accNbr==undefined || accNbr == ""){
									$.alert("信息提示","【接入产品("+offerRole.offerRoleName+")】号码不能为空！");
									return false;
								} 
								if(OrderInfo.getProdTd(prodInst.prodInstId)==""&&(OrderInfo.zcd_privilege!=0||OrderInfo.actionFlag == 14)){
									$.alert("信息提示","【接入产品("+offerRole.offerRoleName+")】UIM卡不能为空！");
									$("#uim_txt_"+prodInst.prodInstId).css("border-color","red");
									return false;
								}
							}
						}else{
							var accNbr = OrderInfo.getProdAn(prodInst.prodInstId).accessNumber;
							var password = $("#pwd_"+prodInst.prodInstId).val();
								if(password!="******"){
									if(!order.main.passwordCheckVal(password, accNbr)){
										return false ;
									}
								}
								if(accNbr==undefined || accNbr == ""){
									$.alert("信息提示","【接入产品("+offerRole.offerRoleName+")】号码不能为空！");
									return false;
								} 
								if(OrderInfo.getProdTd(prodInst.prodInstId)==""&&(OrderInfo.zcd_privilege!=0||OrderInfo.actionFlag == 14)){
									$.alert("信息提示","【接入产品("+offerRole.offerRoleName+")】UIM卡不能为空！");
									$("#uim_txt_"+prodInst.prodInstId).css("border-color","red");
									return false;
								}
							}
							//封装产品属性
							var flag = false;
							$("[name='pay_type_-1']").each(function(){
								if($(this).val()!= undefined&&$(this).val()!=null&&$(this).val()!=""){
									flag = true ;
								}
							});
							if(!flag){
								$.alert("信息提示","没有配置付费类型，无法提交");
								return false;
							}
						//校验必填的产品属性和是否有重复的产品属性
						var prodAttrEmptyFlag = false; //必填产品属性是否已输入
						var prodAttrRepeatFlag = false; //是否包含重复的产品属性
						var prodAttrEmptyCheckName = null;
						var prodAttrRepeatCheckName = null;
						$(OrderInfo.prodAttrs).each(function(){
							var id = this.id;
							if(!prodAttrEmptyFlag){
								if(this.isOptional == "N" && id){
									var val=$.trim($("#"+id).val());
									if(val == "" || val == undefined){
										prodAttrEmptyCheckName = this.name;
										prodAttrEmptyFlag = true;
									}
								}
							}
							if(!prodAttrRepeatFlag){
								if($("[id='"+id+"']").length > 1){
									prodAttrRepeatCheckName = this.name;
									prodAttrRepeatFlag = true;
								}
							}
						});
						if(prodAttrEmptyFlag){
							$.alert("信息提示","没有配置产品属性("+prodAttrEmptyCheckName+")，无法提交");
							return false;
						}
						if(prodAttrRepeatFlag){
							$.alert("信息提示","产品属性("+prodAttrRepeatCheckName+")重复，无法提交");
							return false;
						}
						
						if(!order.main.templateTypeCheck()){
							return false;
						}
					}
				  }
				}
			}
			
			var oldMemberUimFlag = true;
			if(order.memberChange.oldMemberFlag || offerChange.oldMemberFlag){
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) {
					$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
						var member = this;
						if(member.objType == CONST.OBJ_TYPE.PROD){  //接入产品
							if(AttachOffer.isChangeUim(member.objInstId)){
								var td = OrderInfo.getProdTd(member.objInstId);
								if(td==""){
									$.alert("提示","加装移动电话"+member.accessNumber+" UIM卡不能为空！");
									oldMemberUimFlag = false;
									return false ; 
								}
							}
						}
					});
					if(!oldMemberUimFlag){
						break;
					}
				}
				if(!oldMemberUimFlag){
					return;
				}
			}
			var acctId = $("#acctSelect").val();
			if(acctId==undefined || $.trim(acctId)==""){
				$.alert("提示","请新建或者查询选择一个可用帐户");
				return false;
			}
			if(acctId<0){
				//帐户信息填写校验
				if(!_checkAcctInfo()){
					return false;
				}
			}
		}
		
		//补换卡校验
		if(OrderInfo.actionFlag == 22 || OrderInfo.actionFlag == 23){
			if(OrderInfo.boProd2OldTds.length==0){
				$.alert("提示","原UIM卡信息为空！");
				return false ; 
			}
			if(OrderInfo.boProd2Tds.length==0 && OrderInfo.zcd_privilege!=0){
				$.alert("提示","UIM卡不能为空！");
				return false ; 
			}
	        if(OrderInfo.actionFlag==22 &&  OrderInfo.boProd2Tds[0].cardTypeFlag==1  && order.prodModify.choosedProdInfo.productId != '280000000' && OrderInfo.isSuccess == "N"){
	        	$.alert("提示","可选包加载失败！不能正常受理业务！");
			    return false ; 
		    }
		}
		
		//销售品更功能产品参数校验
		if(OrderInfo.actionFlag == 1||OrderInfo.actionFlag == 2||OrderInfo.actionFlag == 3
				|| OrderInfo.actionFlag == 6||OrderInfo.actionFlag == 14||OrderInfo.actionFlag ==21 || OrderInfo.actionFlag ==22){
			//判断UIM卡校验是否与当前业务匹配
			for ( var i = 0; i < OrderInfo.checkUimData.length; i++) {
				var uimData = OrderInfo.checkUimData[i];
				if (uimData.isWireBusi == 1) { // 上网卡 - 移动电话业务
					$.alert("提示", "选择的UIM卡为【" + uimData.uimCode
							+ "+" + uimData.uimName
							+ "】，无法办理移动电话产品，请使用普通UIM卡办理业务。");
					return false;
				} else if (uimData.isWireBusi == 2) { // 普通卡 - 无线业务
					$.alert("提示", "选择的UIM卡为【" + uimData.uimCode
							+ "+" + uimData.uimName
							+ "】，无法办理天翼宽带-无线上网产品，请使用数据卡类型的UIM卡办理业务。");
					return false;
				}
			}
			//附属销售参数设置校验
			for ( var i = 0; i < AttachOffer.openList.length; i++) {
				var specList = AttachOffer.openList[i].specList;
				var roleName = OrderInfo.getOfferRoleName(AttachOffer.openList[i].prodId);
				for (var j = 0; j < specList.length; j++) {
					var spec = specList[j];
					if(spec.isdel!="Y" && spec.isdel!="C"){
						if(spec.ifParams){  //销售参数节点
							if(spec.isset !="Y"){
								$.alert("提示",roleName+" "+spec.offerSpecName+"：参数未设置");
								return false ; 
							}
						}
					}
				}
			}
			//功能产品参数设置校验
			for ( var i = 0; i < AttachOffer.openServList.length; i++) {
				var specList = AttachOffer.openServList[i].servSpecList;
				var roleName = OrderInfo.getOfferRoleName(AttachOffer.openServList[i].prodId);
				for (var j = 0; j < specList.length; j++) {
					var spec = specList[j];
					if(spec.isdel!="Y" && spec.isdel!="C"){
						if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID && CONST.APP_DESC==0){
							if("no"==$("#isMIFI_-"+(i+1)).val()){
								$.alert("提示","要开通"+spec.servSpecName+"功能，请选择4G上网卡-全球卡（MIFI卡）！");
								$("#uim_txt_-"+(i+1)).css("border-color","red");
								return false ; 
							}
						}
						if(spec.ifParams=="Y"){  //销售参数节点
							if(spec.isset !="Y"){
								$.alert("提示",roleName+" "+spec.servSpecName+"：参数未设置");
								return false ; 
							}
						}
					}
				}
			}
				//附属销售参数终端校验
				for ( var i = 0; i < AttachOffer.openList.length; i++) {
					var specList = AttachOffer.openList[i].specList;
					var prodId = AttachOffer.openList[i].prodId;
					var roleName = OrderInfo.getOfferRoleName(prodId);
					for (var j = 0; j < specList.length; j++) {
						var spec = specList[j];
						if(spec.isdel!="Y" && spec.isdel!="C"){
							if(spec.isTerminal==1){  //1表示有终端
								var min=spec.agreementInfos[0].minNum;
								var max=spec.agreementInfos[0].maxNum;
								var total=0;
								var flag = true;
								var isrepeat=false;
								var $input=$("input[id^=terminalText_"+prodId+"_"+spec.offerSpecId+"]");
								$input.each(function(){//遍历页面上面的串码输入框，为的是跟缓存里面的串码进行比对
									var finder=false;
									var instCode=$.trim(this.value);//页面上面的串码
									if(ec.util.isObj(instCode)){
										var objInstId = prodId+"_"+spec.offerSpecId;
										if(AttachOffer.checkData(objInstId,instCode)){
											isrepeat=true;
											return false;
										}
										$.each(OrderInfo.attach2Coupons,function(){
											if(spec.offerSpecId == this.attachSepcId && prodId==this.prodId){
												var couponInstanceNumber=this.couponInstanceNumber;//缓存里面的串码
												if($.trim(couponInstanceNumber)==instCode){
													total++;
													finder=true;
													flag=false;
													return false;
												}
											}	
										});
									}
									if(!finder){//没有找到
										flag=true;
										return false;
									}
								});
								if(isrepeat){
									return false ; 
								}
								if(total<min){//总的终端数比合约终端还小，无法提交
									$.alert("提示",roleName+" "+spec.offerSpecName+"：合约终端数必须不小于"+min);
									return false ; 
								}
								if(flag){
									$.alert("提示",roleName+" "+spec.offerSpecName+"：终端信息未填写全");
									return false ; 
								}
							}
							
						}
					}
			
			
			//套餐变更,可选包变更，补换卡校验
			if(CONST.getAppDesc()==0){
				if(OrderInfo.actionFlag == 2 ){ //套餐变更补换卡校验
					for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) {
						var member = OrderInfo.offer.offerMemberInfos[i];
						if(member.objType == CONST.OBJ_TYPE.PROD){  //接入产品
							if(AttachOffer.isChangeUim(member.objInstId)){
								var td = OrderInfo.getProdTd(member.objInstId);
								if(td==""){
									$.alert("提示",member.roleName+" UIM卡不能为空！");
									return false ; 
								}
							}
						}
					}
				}else if(OrderInfo.actionFlag == 3){ //可选包变更补换卡校验
					if(AttachOffer.isChangeUim()){
						if(OrderInfo.boProd2Tds.length==0){
							$.alert("提示","UIM卡不能为空！");
							return false ; 
						}
					}
				}else if(OrderInfo.actionFlag == 6){//主副卡变更，副卡换套餐
					if(ec.util.isArray(OrderInfo.viceOfferSpec)){//多张副卡同时进行换挡
						var flag=false;
						$.each(OrderInfo.viceOfferSpec,function(){
							var prodId=this.prodId;
							for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) {
								var member = OrderInfo.offer.offerMemberInfos[i];
								if(prodId==member.objInstId&&member.objType == CONST.OBJ_TYPE.PROD){  //接入产品
									if(AttachOffer.isChangeUim(member.objInstId)){
										var td = OrderInfo.getProdTd(member.objInstId);
										if(td==""){
											$.alert("提示","基础移动电话 "+member.accessNumber+" UIM卡不能为空！");
											flag=true;
											return false ; 
										}
									}
								}
							}
						});
						if(flag){
							return false;
						}
					}
				}
			}
		}
		
		//开通4G功能产品时，需要校验UIM，终端是否是4G
		if(CONST.getAppDesc()==0){
			//TODO tmp for Mantis 0042657: 临时为北京去掉终端卡匹配关系，仅对北京生效
			if(OrderInfo.getAreaId() == null || OrderInfo.getAreaId().indexOf("811") != 0){
				for ( var i = 0; i < AttachOffer.openServList.length; i++) {
					var specList = AttachOffer.openServList[i].servSpecList;
					var flag = false;//是否开通4G上网功能产品
					var isTerminal=false;//是否有终端
					$.each(specList,function(){//遍历是否有开通4G上网功能
						if(this.servSpecId == CONST.PROD_SPEC.PROD_FUN_4G && this.isdel != "Y" && this.isdel != "C"){ //开通4G功能产品
							flag = true;
							return false;
						}
					});
					var prodId=AttachOffer.openServList[i].prodId;
					var termTypeFlags=[];//终端类型,兼容多个终端
					
					if(AttachOffer.openList[i]!=undefined){
						var specListTemp = AttachOffer.openList[i].specList;
						for (var j = 0; j < specListTemp.length; j++) {
							var spec = specListTemp[j];
							if(spec.isdel!="Y" && spec.isdel!="C"){
								if(spec.isTerminal==1){  //1表示有终端
									$.each(OrderInfo.attach2Coupons,function(){//遍历是否有终端
										if(prodId==this.prodId){//有终端信息
											isTerminal = true;
											if(ec.util.isObj(this.termTypeFlag)){
												var param={
														termTypeFlag:this.termTypeFlag
												};
												termTypeFlags.push(param);
											}
										}	
									});
								}
							}
						}
					}
					
					var roleName = OrderInfo.getOfferRoleName(prodId);
					if(isTerminal&&!ec.util.isArray(termTypeFlags)&&OrderInfo.zcd_privilege!=0){
						$.alert("信息提示",roleName+"中,营销资源未返回终端机型，无法判断是3G终端还是4G终端!");
						return false;
					}
					
					if(flag){ //该产品已经开通4G功能产品，需要做4G卡终端校验
						if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 14 || order.memberChange.newMemberFlag || order.memberChange.oldMemberFlag){ //新装
							var uim = OrderInfo.getProdUim(prodId);
							if(uim.cardTypeFlag=="2"){ //3g卡
								$.alert("信息提示","您已开通【4G（LTE）上网】功能产品，不能使用3G卡，故无法提交");
								return false;
							}
							if(_isThreeTerminal(termTypeFlags,isTerminal)){
								$.alert("信息提示","您已开通【4G（LTE）上网】功能产品，不能使用3G终端，故无法提交");
								return false;
							}
						}else if(OrderInfo.actionFlag == 2 || OrderInfo.actionFlag == 3 || order.memberChange.changeMemberFlag){
							var oldUim = OrderInfo.getProdOldUim(prodId);
							if(oldUim.is4GCard!="Y"){//旧卡不是4G卡 就判断新卡是否是4G卡
								var uim = OrderInfo.getProdUim(prodId);
								if(uim.cardTypeFlag=="2"){
									$.alert("信息提示","您已开通【4G（LTE）上网】功能产品，不能使用3G卡，故无法提交");
									return false;
								}
							}
							if(_isThreeTerminal(termTypeFlags,isTerminal)){
								$.alert("信息提示","您已开通【4G（LTE）上网】功能产品，不能使用3G终端，故无法提交");
								return false;
							}
						}
					}else{//没有开通4G功能产品 就判断UIM卡和终端的类型要一致，4G终端匹配4GUIM卡 3G终端匹配3GUIM卡
						//if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 14){ //新装
							//if(isTerminal){
							//	var uim = OrderInfo.getProdUim(prodId);
							//	var threeOrFour=false;
							//	if(ec.util.isObj(uim) && ec.util.isObj(uim.cardTypeFlag)){
							//		$.each(termTypeFlags,function(){
							//			if(this.termTypeFlag!=uim.cardTypeFlag){
							//				var uimtype=uim.cardTypeFlag=="1"?"4G卡":"3G卡";
							//				var termtype=this.termTypeFlag=="1"?"4G机型":"3G机型";
							//				$.alert("信息提示",roleName+"中UIM卡是"+uimtype+" 终端是"+termtype+"，无法提交");
							//				threeOrFour=true;
							//				return false;
							//			}
							//		});
							//	}
							//	if(threeOrFour){ //终端和卡不匹配
							//		return false;
							//	}
							//}
						//}else if(OrderInfo.actionFlag == 2 || OrderInfo.actionFlag == 3 || OrderInfo.actionFlag == 21){
							//if(isTerminal){
								//var currentUimCoupon = OrderInfo.getProdUim(prodId); //当前uim卡物品信息，做套餐变更或可选包变更时可能带出补换卡业务，提交时使用新的uim检验终端
								//if(ec.util.isObj(currentUimCoupon) && ec.util.isObj(currentUimCoupon.cardTypeFlag)){ //补换卡
								//	var fourTerminal=false;
								//	$.each(termTypeFlags,function(){
								//		if(this.termTypeFlag=="1"){
								//			fourTerminal=true;
								//			return false;
								//		}
								//	});
									//if(currentUimCoupon.cardTypeFlag=="2" && fourTerminal){
									//	$.alert("信息提示",roleName+"中UIM卡是3G卡 终端是4G机型，无法提交");
									//	return false;
									//}
									//if(currentUimCoupon.cardTypeFlag=="1" && _isThreeTerminal(termTypeFlags,isTerminal)){
									//	$.alert("信息提示",roleName+"中UIM卡是4G卡 终端是3G机型，无法提交");
									//	return false;
									//}
								//} else {  //未做补换卡
									//var oldUim = OrderInfo.getProdOldUim(prodId);
									//if(ec.util.isObj(oldUim.is4GCard)){
									//	if(oldUim.is4GCard!="Y"){//旧卡不是4G卡
									//		var fourTerminal=false;
									//		$.each(termTypeFlags,function(){
									//			if(this.termTypeFlag=="1"){
									//				fourTerminal=true;
									//				return false;
									//			}
									//		});
									//		if(fourTerminal){
									//			$.alert("信息提示",roleName+"中UIM卡是3G卡 终端是4G机型，无法提交");
									//			return false;
									//		}
									//	}else{
									//		if(_isThreeTerminal(termTypeFlags,isTerminal)){
									//			$.alert("信息提示",roleName+"中UIM卡是4G卡 终端是3G机型，无法提交");
									//			return false;
									//		}
									//	}
									//}
								//}
							//
							//}
						//}
					}
				}
			} //TODO tmp for Mantis 0042657
		}
		}
		return true; 
	};
	//判断是否包含有3G的机型
	var _isThreeTerminal=function(termTypeFlags,isTerminal){
		var threeTerminal=false;
		$.each(termTypeFlags,function(){
			if(isTerminal && this.termTypeFlag=="2"){
				threeTerminal=true;
				return false;
			}
		});
		return threeTerminal;
	};
	//帐户信息填写校验公用方法（新装，过户，帐户信息修改，改帐务定制关系）
	var _checkAcctInfo = function(){
		if($.trim($("#acctName").val())==""){
			$.alert("提示","帐户名称不能为空");
			return false;
		}
		if($("#paymentType").val()==110000){
			if($("#bankId").val()=="" || $.trim($("#bankAcct").val())=="" || $.trim($("#paymentMan").val())==""){
				$.alert("提示","若选择银行支付请填写必要的银行支付信息");
				return false;
			}
		}			
		if($("#postType").val()!=-1){
			if($.trim($("#postAddress").val())==""){
				$.alert("提示","若选择投递账单请填写必要的账单投递信息");
				return false;
			}
			if($("#postType").val()==13){
				var EmailType = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/; // /^[^\.@]+@[^\.@]+\.[a-z]+$/;
				if(EmailType.test($("#postAddress").val())==false){
					$.alert("提示","若选择 Email 投递帐单请输入有效的 Email 地址");
					return false;
				}
			}
		}
		return true;
	};
	
	//修改资源状态
	var _updateResState= function() {
		var resources  = [];
		for (var i = 0; i < OrderInfo.boProdAns.length; i++) {	
			var res = {
				accNbr :OrderInfo.boProdAns[i].accessNumber,
				accNbrType : 1,  //号码类型（1手机号码2.UIM卡）
				action : "UPDATE"
			};
			resources.push(res);
		}
		for (var i = 0; i < OrderInfo.boProd2Tds.length; i++) {
			var res = {
				accNbr :OrderInfo.boProd2Tds[i].terminalCode,
				accNbrType : 2,  //号码类型（1手机号码2.UIM卡）
				action : "UPDATE"
			};
			resources.push(res);
		}
		if(resources.length>0){
			var url= contextPath+"/common/updateResState";	 
			$.callServiceAsJsonGet(url,{strParam:JSON.stringify(resources)},{
				"done" : function(response){
					if (response.code==0) {
						if(response.data){
						}
					}
				}
			});	
		}
	};
	
	//显示模板名称
	var _showTemplateOrderName = function(id){
		if($("#isTemplateOrder").attr("checked")=="checked"){
			if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){
				$(".template_info_type").show();
				$("#isActivation").removeAttr("checked");
				$("#isActivation").attr("disabled","disabled");
				//$("#templateTypeDiv").show();
				//$("#templateOrderName").show();
				//$("#templateOrderTitle").show();
			}
			$(".template_info_name").show();
		}else {
			$(".template_info_name").hide();
			$(".template_info_type").hide();
			$("#templateOrderName").val("");
			$("#isActivation").removeAttr("disabled");
			//$("#templateOrderTitle").hide();
			//$("#templateTypeDiv").hide();
			//$("#templateOrderName").val("");	
		}
	};
	
	//首话单激活
	var _showActivation = function(){
		if($("#isActivation").attr("checked")=="checked"){
			$("#isTemplateOrder").removeAttr("checked");
			$("#isTemplateOrder").attr("disabled","disabled");
			$(".template_info_name").hide();
			$(".template_info_type").hide();
			$("#templateOrderName").val("");
		}else {
			$("#isTemplateOrder").removeAttr("disabled");
		}
	};
	
	//重新排列offerRole 把按顺序把主卡角色提前
	var _sortOfferSpec = function(offerSpec){
		var tmpOfferSpecRole = [];
		for ( var i = 0; i < offerSpec.offerRoles.length; i++) {
			var offerRole = offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){ //主卡
				tmpOfferSpecRole.push(offerRole);
			}
		}
		for ( var i = 0; i < offerSpec.offerRoles.length; i++) {
			var offerRole = offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){
				tmpOfferSpecRole.push(offerRole);
			}
		}
		offerSpec.offerRoles = tmpOfferSpecRole;
		return offerSpec;
	};
	
	var _checkOrder=function(){
		var flag = false;
		var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
		var prodId = order.prodModify.choosedProdInfo.prodInstId;
		var specList=CacheData.getOfferSpecList(prodId);
		if(ec.util.isArray(specList)){
			$.each(specList,function(){
				if(this.ifPackage4G=="Y" && this.isdel != "Y" && this.isdel != "C"){ //是否有开通4g流量包
					flag = true;
					return false;
				}
			});
		}
		if(CONST.getAppDesc()==0 && flag && prodClass==CONST.PROD_CLASS.THREE && OrderInfo.actionFlag==3){//可选包变更 且是3G用户套餐 开通了4G流量包 必须进行省预校验
			if(offerChange.checkOrder()){//省预校验
				var content=offerChange.checkAttachOffer(prodId);
				if(content!=""){
					if(_checkData()){
						$("#offer_serv").html(content);
						easyDialog.open({
							container : 'offer_dialog'
						});
					}
//					$.confirm("信息确认",content,{ 
//						yesdo:function(){
//							if(_checkData()){
//								AttachOffer.setChangeList(prodId);
//								SoOrder.submitOrder();
//							}
//						},
//						no:function(){
//						}
//					});
				}else{
					SoOrder.submitOrder();
				}
			}
		}else{
			SoOrder.submitOrder();
		}
	};
	var _orderPrepare=function(){
		var prodId = order.prodModify.choosedProdInfo.prodInstId;
		AttachOffer.setChangeList(prodId);
		SoOrder.submitOrder();
		easyDialog.close();
	};
	
	//判断是否是3G转4G
	var _setOfferType=function(){
		var oldType=order.prodModify.choosedProdInfo.is3G;
		if(OrderInfo.actionFlag==2){
			var newType=OrderInfo.offerSpec.is3G;
			if(ec.util.isObj(oldType)){
				if(ec.util.isObj(newType)){
					if(oldType=="Y"&&newType=="N"){
						return true;
					}
				}
			}
		}else if(OrderInfo.actionFlag==3){
			if(ec.util.isObj(oldType)){
				if(oldType=="Y"){
					for ( var i = 0; i < AttachOffer.openServList.length; i++) {
						var specList = AttachOffer.openServList[i].servSpecList;
						var flag = false;//是否开通4G上网功能产品
						$.each(specList,function(){//遍历是否有开通4G上网功能
							if(this.servSpecId == CONST.PROD_SPEC.PROD_FUN_4G && this.isdel != "Y" && this.isdel != "C"){ //开通4G功能产品
								flag = true;
								return false;
							}
						});
						if(flag){
							return true;
						}
					}
				}
			}
		}
		return false;
	};
	return {
		builder 				: _builder,
		createAttOffer  		: _createAttOffer,
		createServ				: _createServ,
		delOrder 				: _delOrder,
		delAndNew				: _delAndNew,
		getOrderInfo 			: _getOrderInfo,
		getToken				: _getToken,
		getTokenSynchronize : _getTokenSynchronize,
		initFillPage			: _initFillPage,
		initOrderData			: _initOrderData,
		orderBack				: _orderBack,
		step					: _step,
		showStep				: _showStep,
		submitOrder 			: _submitOrder,
		checkAcctInfo  			: _checkAcctInfo,
		showTemplateOrderName   : _showTemplateOrderName,
		sortOfferSpec			: _sortOfferSpec,
		updateResState			: _updateResState,
		delOrderBegin			: _delOrderBegin,
		delOrderSilent			: _delOrderSilent,
		delOrderFin				: _delOrderFin,
		showActivation			: _showActivation,
		checkOrder				: _checkOrder,
		orderPrepare			: _orderPrepare,
		getCheckOperatSpec		: _getCheckOperatSpec,
		createProd				: _createProd
	};
})();
/**
 * 打印方法-回执、发票、押金票据
 * 
 * @author dujb3
 */
CommonUtils.regNamespace("common", "print");
/**
 * 打印方法-回执、发票、押金票据
 */
common.print = (function($){
	var _voucherCommon=function(olId){
		var ifPrint = $('a[olId=' + olId + ']').attr("ifPrint");
		if (CONST.getAppDesc() == 0 && 'N' == ifPrint) {
			var trList = $("#tab_orderList tr[olId=" + olId + "]");
			var areaId = '';
			var instList = [];
			var newProdFlag = 'false';
			for (var i=0; i < trList.length; i++) {
				var tr = trList[i];
				var actionClass = $(tr).attr("actionClass");
				if (actionClass == '1600') {
					continue;
				}
				newProdFlag = $(tr).attr("newProdFlag");
				if (newProdFlag == 'true') {
					break;
				}
				var instId = $(tr).attr("objInstId");
				if (instId == undefined || instId == '') {
					$.alert("提示", "objInstId为空，请核查接口返回的数据！");
					return false;
				}
				var accessNumber = $(tr).attr("accessNumber");
				if (accessNumber == undefined || accessNumber == '') {
					$.alert("提示", "accessNumber为空，请核查接口返回的数据！");
					return false;
				}
			}
			for (var i=0; newProdFlag == 'false' && i < trList.length; i++) {
				var tr = trList[i];
				var actionClass = $(tr).attr("actionClass");
				if (actionClass == '1600') {
					continue;
				}
				var instId = $(tr).attr("objInstId");
				var accessNumber = $(tr).attr("accessNumber");
				if ($.inArray(instId, instList) >= 0) {
					continue;
				}
				areaId = $(tr).attr("areaId");
				OrderInfo.orderResult.olNbr = $(tr).attr("olNbr");
				var custId = '';
				OrderInfo.order.soNbr = UUID.getDataId();
				var param = {
						areaId : areaId,
						acctNbr : accessNumber,
						custId : custId,
						soNbr : OrderInfo.order.soNbr ,
						//queryType : "1,2,3,4,5",
						instId : instId,
						type : "2"
				};
				var loadInstFlag = query.offer.invokeLoadInst(param);
				if (!loadInstFlag) {
					$.alert("提示", "加载订单回执信息失败");
					return false;
				}
				instList.push(instId);
			}
			$('a[olId=' + olId + ']').attr("ifPrint", "Y");
		}
		if (OrderInfo.order.soNbr == undefined || OrderInfo.order.soNbr==''){
			OrderInfo.order.soNbr = UUID.getDataId();
		}
		OrderInfo.orderResult.olId = olId;
		return true;
	};
	var _preSign=function(olId,chargeItems){
		_voucherCommon(olId);
		var voucherInfo = {
			"olId":OrderInfo.orderResult.olId,
			"soNbr": OrderInfo.order.soNbr
		};
		if(_getCookie('_session_pad_flag')=='1'){
			var arr=new Array(3);
			if(ec.util.browser.versions.android){
				arr[0]='order/sign/downVoucher';				
			}else{
				arr[0]='print/iosVoucher';				
			}
			arr[1]='voucherInfo';
			arr[2]=JSON.stringify(voucherInfo);
			MyPlugin.printShow(arr,
                function(result) {
                },
                function(error) {
                }
			);
		}else{
			$("<form>", {
		    	id: "voucherForm",
		    	style: "display:none;",
				target: "_blank",
				method: "POST",
				action: contextPath + "/order/sign/downVoucher"
		    }).append($("<input>", {
		    	id : "voucherInfo",
		    	name : "voucherInfo",
		    	type: "hidden",
		    	value: JSON.stringify(voucherInfo)
		    })).appendTo("body").submit();
		}
	};
	var _signVoucher=function(params){
		var PcFlag="0";
		if(_getCookie('_session_pad_flag')=='1'){
			PcFlag="1";
		}else{
			$.alert("提示","目前只支持客户端的数字签名,请在客户端登录!");
			return;
		}
		params.PcFlag=PcFlag;
		var url=contextPath+"/order/sign/previewForSign";
		$.callServiceAsJson(url, params, {
			"before":function(){
				$.ecOverlay("<strong>生成回执预览的html,请稍等会儿....</strong>");
			},"always":function(){
				$.unecOverlay();
			},	
			"done" : function(response){
				if (response.code == 0) {
					if(PcFlag=="1"){
						SignPlugin.datasign(response.data,JSON.stringify(params),function(){}, function(){});
					}
				}else if (response.code == -2) {
					$.alertM(response.data);
				}else{
					$.alert("提示","生成回执预览的html失败!");
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","服务忙，请稍后再试！");
			}
		});
	};
	var _preVoucher=function(olId, chargeItems){
		if(!_voucherCommon(olId)){
			return;
		};
		var voucherInfo = {
			"olId":OrderInfo.orderResult.olId,
			"soNbr": OrderInfo.order.soNbr,
			"busiType":"1",
			"chargeItems":chargeItems
		};
		common.print.printVoucher(voucherInfo);
	};
	var _printVoucher=function(voucherInfo){
		$("#voucherForm").remove();
		if(_getCookie('_session_pad_flag')=='1'){
			var arr=new Array(3);
			if(ec.util.browser.versions.android){
				arr[0]='/token/pc/print/voucher';				
			}else{
				arr[0]='print/iosVoucher';				
			}
			arr[1]='voucherInfo';
			arr[2]=JSON.stringify(voucherInfo);
			MyPlugin.printShow(arr,
                function(result) {
                },
                function(error) {
                }
			);
		}else{
		    $("<form>", {
		    	id: "voucherForm",
		    	style: "display:none;",
				target: "_blank",
				method: "POST",
				action: contextPath + "/token/pc/print/voucher"
		    }).append($("<input>", {
		    	id : "voucherInfo",
		    	name : "voucherInfo",
		    	type: "hidden",
		    	value: JSON.stringify(voucherInfo)
		    })).appendTo("body").submit();
		}
	};
	
	var _preInvoice=function(olId,olNbr, printFlag){
		var ifInvoice = $('a[olId=' + olId + ']').attr("ifInvoice");
		var areaId = $('a[olId=' + olId + ']').attr("areaId");
		if (CONST.getAppDesc() == 0 && 'N' == ifInvoice) {
			var trList = $("#tab_orderList tr[olId=" + olId + "]");
			var instList = [];
			var newProdFlag = 'false';
			for (var i=0; i < trList.length; i++) {
				var tr = trList[i];
				var actionClass = $(tr).attr("actionClass");
				if (actionClass == '1600') {
					continue;
				}
				newProdFlag = $(tr).attr("newProdFlag");
				if (newProdFlag == 'true') {
					break;
				}
				var instId = $(tr).attr("objInstId");
				if (instId == undefined || instId == '') {
					$.alert("提示", "objInstId为空，请核查接口返回的数据！");
					return ;
				}
				var accessNumber = $(tr).attr("accessNumber");
				if (accessNumber == undefined || accessNumber == '') {
					$.alert("提示", "accessNumber为空，请核查接口返回的数据！");
					return ;
				}
			}
			for (var i=0; newProdFlag == 'false' && i < trList.length; i++) {
				var tr = trList[i];
				var actionClass = $(tr).attr("actionClass");
				if (actionClass == '1600') {
					continue;
				}
				var instId = $(tr).attr("objInstId");
				var accessNumber = $(tr).attr("accessNumber");
				if ($.inArray(instId, instList) >= 0) {
					continue;
				}
				areaId = $(tr).attr("areaId");
				OrderInfo.orderResult.olNbr = $(tr).attr("olNbr");
				var custId = '';
				OrderInfo.order.soNbr = UUID.getDataId();
				var param = {
						areaId : areaId,
						acctNbr : accessNumber,
						custId : custId,
						soNbr : OrderInfo.order.soNbr ,
						//queryType : "1,2,3,4,5",
						instId : instId,
						type : "2"
				};
				var loadInstFlag = query.offer.invokeLoadInst(param);
				if (!loadInstFlag) {
					return;
				}
				instList.push(instId);
			}
			$('a[olId=' + olId + ']').attr("ifInvoice", "Y");
		}
		if (OrderInfo.order.soNbr == undefined || OrderInfo.order.soNbr==''){
			OrderInfo.order.soNbr = UUID.getDataId();
		}
		OrderInfo.orderResult.olNbr = olNbr;
		OrderInfo.orderResult.olId = olId;
		var param = {
			"olId" : OrderInfo.orderResult.olId,
			"soNbr": OrderInfo.order.soNbr,
			"billType" : 0,
			"printFlag": printFlag,
			"areaId" : areaId,
			"acctItemIds":[]
		};
		common.print.prepareInvoiceInfo(param);
	};
	var _closePrintDialog=function(){
		if(common.print.dialogForm!=undefined&&common.print.dialog!=undefined){
			common.print.dialogForm.close(common.print.dialog);
		}
	};
	
	//可打印费用项查询
	var _queryComputeCharge=function(param) {
		$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
		var url=contextPath+"/print/getInvoiceItems";
		var response = $.callServiceAsJson(url,param,{});
		$.unecOverlay();
		if(!response){
			$.alert("提示","<br/>查询可打印费用项失败，请稍后重试");
			return false;
		}
		if(response.code == -2) {
			$.alertM(response.data);
			return false;
		}
		if(response.code != 0) {
			$.alert("提示","<br/>查询可打印费用项失败，请稍后重试");
			return false;
		}
		if(response.data.resultCode != '0') {
			$.alert("提示", response.data.resultMsg);
			return false;
		}
		//判断是否有可打印费用项
		if (response.data.chargeItems == undefined || response.data.chargeItems.length==0) {
			$.alert("提示", "没有可打印的费用项");
			return false;
		} else {
			var i = 0;
			for(; i < response.data.chargeItems.length; i++){
				var item = response.data.chargeItems[i];
				if (item.paymentAmount!=0) {
					break;
				}
			}
			if (i == response.data.chargeItems.length) {
				$.alert("提示", "没有可打印的费用项");
				return false;
			}
		}
		return response;
	};
	//发票代码、发票号码查询
	var _queryInvoiceInfo = function(sobillType) {
		var param = {
			"staffId" : OrderInfo.staff.staffId,
			"areaId" : OrderInfo.staff.areaId,
			"custSoNbr" : OrderInfo.orderResult.olNbr,
			"custOrderId" : OrderInfo.orderResult.olId,
			"invoiceType" : sobillType //目前阶段我们用到的是：100 普通发票和 200 收据。待后续有营改增需求后再 用其它类型。
		};
		var url=contextPath+"/print/getInvoiceInfo";
		var response = $.callServiceAsJson(url,param,{});
		if(!response){
//			$.alert("提示","<br/>查询发票代码发票号码失败，请稍后重试");
			return false;
		}
		if(response.code == -2) {
			$.alertM(response.data);
			return false;
		}
		if(response.code != 0) {
//			$.alert("提示","<br/>查询发票代码发票号码失败，请稍后重试");
			return false;
		}
		if (response.data.invoiceInfos != undefined && response.data.invoiceInfos instanceof Array && response.data.invoiceInfos.length > 0) {
		
		} else {
//			$.alert("提示","<br/>查询发票代码发票号码失败，返回结果中未获取到发票信息，请稍后重试");
			return false;
		}
		return response;
	};
	/**
	 * 填写打印发票信息
	 */
	var _prepareInvoiceInfo=function(param){
		
		//判断是否一般纳税人，如果是的话提示
		if (OrderInfo.cust.norTaxPayer == "Y") {
			$.alert("提示", "客户为一般纳税人，请到省份CRM系统打印专用增值税发票！");
			$.confirm("提示信息","客户为一般纳税人，专用增值税发票需要到省份CRM系统打印。是否只打印普通发票?", {
				yes : function(){
					_prepareInvoiceInfoCore(param);
				},
				no : function(){
					return;
				}
			}, "question");
		}else{
			_prepareInvoiceInfoCore(param);
		}
	}
	var _prepareInvoiceInfoCore=function(param){
		//可打印费用项查询
		var qccResp = _queryComputeCharge(param);
		if (!qccResp) {
			return;
		}
		//发票代码、发票号码查询
		getInvoiceNumber(100);//默认查发票
		function getInvoiceNumber(billType) {
			var iiqResp = _queryInvoiceInfo(billType);
			if (iiqResp) {
				var iiqInfos = iiqResp.data.invoiceInfos;
				if (ec.util.isArray(iiqInfos[0].invoiceInfos)) {
					$("#invoiceNbrInp").val(iiqInfos[0].invoiceInfos[0].invoiceNbr);
					$("#invoiceNumInp").val(iiqInfos[0].invoiceInfos[0].invoiceNum);
				} else {
					$("#invoiceNbrInp").val(iiqInfos[0].invoiceNbr);
					$("#invoiceNumInp").val(iiqInfos[0].invoiceNum);
				}
			}
		}
		var invoiceInfos = qccResp.data.invoiceInfos;
		if (invoiceInfos != undefined && invoiceInfos instanceof Array && invoiceInfos.length > 0) {
			
		} else {
			//没有发票信息，需要进行初始化
			var initParam={
				"soNbr":OrderInfo.order.soNbr,
				"billType" : 0,
				"olId" : param.olId,
				"printFlag" : -1,
				"areaId" : OrderInfo.staff.areaId,
				"acctItemIds":[]
			};
			var initResult = common.print.initPrintInfo(initParam);
			if(!initResult) {
				return;
			}
			//提示到发票补打页面操作
			if (param.printFlag == 1) {
				$.alert("信息", "此购物车对应的发票未打印过，请到发票补打页面。");
				return;
			}
			//可打印费用项查询
			qccResp = _queryComputeCharge(param);
			if (!qccResp) {
				return;
			}
		}
		//判断是否是重打还是补打
		common.print.oldInvoiceFlag = '0';
		if (_checkCanReOrAdd(qccResp.data.invoiceInfos, param.printFlag)) {
			return;
		}
		
		
		//查询可打印费用项成功，接下去查询模板组
		var tempUrl = contextPath+"/print/getInvoiceTemplates";
		var tempParam = {
			'areaId' : OrderInfo.staff.areaId
		};
		var tempResp = $.callServiceAsJson(tempUrl, tempParam, {});
		if (tempResp.code == -2) {
			$.alertM(tempResp.data);
			return;
		} else if (tempResp.code != 0) {
			$.alert("提示",ec.util.defaultStr(tempResp.data, "获取打印模板出错"));
			return;
		} else {
			var tempData = tempResp.data;
			if (tempData.resultCode != 'POR-0000') {
				$.alert("提示",ec.util.defaultStr(tempData.resultMsg, "获取打印模板异常"));
				return;
			}
			if (tempData.length == 0) {
				$.alert("提示", "没有获取到可用的打印模板");
				return;
			}
			var tempHtml = "";
			var tempList = tempData.tempList;
			if (typeof tempList != undefined && tempList.length > 0) {
				tempHtml += "<option selected='selected' value="+tempList[0].templateId+">"+tempList[0].templateName+"</option>";
				for(var i = 1; i < tempList.length; i++){
					var template = tempList[i];
					tempHtml += "<option value="+template.templateId+">"+template.templateName+"</option>";
				}
			}
			$("#tempListSel").html(tempHtml);
		}
		
		
		//显示接入号
		var selHtml = "";
		var prodInfo = qccResp.data.prodInfo;
		if (prodInfo != undefined && prodInfo.length > 0) {
			selHtml+="<option selected='selected' value="+prodInfo[0].accessNumber+">"+prodInfo[0].accessNumber+"</option>";
			for(var i=1;i<prodInfo.length;i++){
				var prod = prodInfo[i];
				selHtml+="<option value="+prod.accessNumber+">"+prod.accessNumber+"</option>";
			}
		}
		$("#acceNbrSel").html(selHtml);
		
		
		//显示费用项
		var contHtml = "";
		contHtml+="<div id='invoiceContDiv' class='plan_second_list cashier_tr'>";
		contHtml+="  <table class='contract_list'>";
		contHtml+="  <thead>";
		contHtml+="    <tr>";
		contHtml+="      <td>是否打印</td><td>费用名称</td><td>费用(元)</td><td>税金(元)</td><td>付费方式</td>";
		contHtml+="    </tr>";
		contHtml+="  </thead>";
		contHtml+="  <tbody>";
		var chargeItems = qccResp.data.chargeItems;
		for(var i=0;i<chargeItems.length;i++){
			var item = chargeItems[i];
			if (i == 0) {
				$("#invoiceTitleInp").val(item.custName);
			}
			if (item.paymentAmount==0) {
				continue;
			}
			contHtml+="    <tr acctItemId="+item.acctItemId+" acctItemTypeId="+item.acctItemTypeId+" ";
			contHtml+="        acctItemTypeName='"+item.acctItemTypeName+"' boActionType='"+item.boActionType+"' ";
			contHtml+="        boActionType='"+item.boActionType+"' boId="+item.boId+" feeAmount="+item.feeAmount+" ";
			contHtml+="        invoiceId="+item.invoiceId+" objId="+item.objId+" objType="+item.objType+" ";
			contHtml+="        payMethodCd="+item.payMethodCd+" payMethodName="+item.payMethodName+" ";
			contHtml+="        realAmount="+item.realAmount + " ";
			contHtml+="        tax="+item.tax+" taxRate="+item.taxRate+" >";
			if (_checkChargeItem(item)) {
				contHtml+="      <td><input type='checkbox' name='invoiceItemsChkBox' checked='checked'/></td>";
			} else {
				contHtml+="      <td><input type='checkbox' name='invoiceItemsChkBox' disabled='disabled'/></td>";
			}
			contHtml+="      <td>"+item.acctItemTypeName+"</td>";
			contHtml+="      <td>"+(item.realAmount / 100).toFixed(2)+"</td>";
			contHtml+="      <td>"+(item.tax / 100).toFixed(2)+"</td>";
			contHtml+="      <td>"+item.payMethodName+"</td>";
			contHtml+="    </tr>";
		}
		contHtml+="  </tbody>";
		contHtml+="  </table>";
		contHtml+="</div>";
		$("#invoiceItemsContDiv").html(contHtml);
		$("#ec-dialog-form-content").css("height", "auto");
		$("input[name=billType]").off("click").on("click",function(event){
			if ($("input[name=billType]:checked").val()=="0") {
				$("#invoiceNbrNumDl").show();
				$("#titleDt").html("发票抬头：");
				$("#tempDt").html("发票模板：");
				$("#codeTitleDt").html("发票代码：");
				$("#numTitleDt").html("发票号码：");
				param.billType = 0;
				getInvoiceNumber(100);
			} else {
				$("#invoiceNbrNumDl").hide();
				$("#titleDt").html("票据抬头：");
				$("#tempDt").html("票据模板：");
				$("#codeTitleDt").html("票据代码：");
				$("#numTitleDt").html("票据号码：");
				param.billType = 1;
				getInvoiceNumber(200);
			}
		});
		$("#invoiceItemsConfirm").off("click").on("click",function(event){
			if (common.print.oldInvoiceFlag != '0') {
				$.alert("信息", "存在未作废发票，请先确定作废发票");
				return;
			}
			_saveInvoiceInfo(param, qccResp.data);
		});
		
		ec.form.dialog.createDialog({
			"id":"-invoice-items",
			"width":580,
//			"height":450,
			"zIndex":1100,
			"initCallBack":function(dialogForm,dialog){
				common.print.dialogForm=dialogForm;
				common.print.dialog=dialog;
				$("#invoiceItemsConCancel").off("click").on("click",function(event){
					common.print.closePrintDialog();
				});
			},
			"submitCallBack":function(dialogForm,dialog){
			
			},
			"closeCallBack":function(dialogForm,dialog){
			
			}
		});
	};
	var _initPrintInfo=function(param) {
		var url=contextPath+"/print/getInvoiceItems";
		var queryResult = $.callServiceAsJson(url,param);
		if(!queryResult){
			$.alert("提示","<br/>查询可打印费用项失败，请稍后重试");
			return;
		}
		if(queryResult.code == -2) {
			$.alertM(queryResult.data);
			return;
		}
		if(queryResult.code != 0) {
			$.alert("提示","<br/>查询可打印费用项失败，请稍后重试");
			return;
		}
		if(queryResult.data.resultCode != '0') {
			$.alert("提示", queryResult.data.resultMsg);
			return;
		}
		//判断是否有可打印费用项
		if (queryResult.data.chargeItems == undefined || queryResult.data.chargeItems.length==0) {
			$.alert("提示", "没有可打印的费用项");
			return;
		}
		var result = _prepareInitParam(param, queryResult.data);
		var invoiceInfos = result.invoiceInfos;
		
		var params={"invoiceInfos" : invoiceInfos};
		var smResp = _invokeSavingMethod(params, param.printFlag);
		if (smResp == false) {
			return false;
		}
		invoiceInfos = _setInvoiceId(invoiceInfos, smResp.data.invoiceIds, '0');
		return invoiceInfos;
	};
	
	var _getPrintState=function(printFlag) {
		if (printFlag == '-1') {
			return '初始打印';
		} else if (printFlag == '0') {
			return '正常打印';
		} else if (printFlag == '1') {
			return '重打';
		} else if (printFlag == '2') {
			return '补打';
		} else {
			return '未知操作';
		}
	};
	//判断是否能重打或补打  true - 限制 , false - 允许打印
	var _checkCanReOrAdd=function(invoiceInfos, printFlag) {
		if (invoiceInfos != undefined && invoiceInfos instanceof Array && invoiceInfos.length > 0) {
			for (var i=0; i < invoiceInfos.length; i++) {
				if (!invoiceInfos[i]) {
					$.alert("信息", "接口返回的发票信息不是有效值，请确认。");
					return true;
				}
				if (invoiceInfos[i].printFlag=='-1') {
					//未打印时，允许正常打印和补打
					if (printFlag == '0' || printFlag == '2') {
						
					} else {
						$.alert("信息", "此购物车对应的发票未打印过，请到发票补打页面。");
						return true;
					}
				} else if (invoiceInfos[i].printFlag == '0') {
					//如果是收据，就允许操作
					if (invoiceInfos[i].billType == '1') {
						return false;
					}
					//正常打印状态，允许重打
					if (printFlag == '1') {
						//弹出作废发票提示
						_invalidInvoice(invoiceInfos, printFlag);
					} else {
						$.alert("信息", "此购物车对应的发票正常打印过，只允许重打。");
						return true;
					}
				} else if (invoiceInfos[i].printFlag == '1' || invoiceInfos[i].printFlag == '2') {
					//重打或补打状态，允许重打
					if (printFlag == '1') {
						//弹出作废发票提示
						_invalidInvoice(invoiceInfos, printFlag);
					} else {
						$.alert("信息", "此购物车对应的发票已打印过，只允许重打。");
						return true;
					}
				} else {
					//默认不允许
					$.alert("信息", "发票信息中打印标识值不规范");
					return true;
				}
			}
			//走出循环，代表允许打印
			return false;
		} else {
			//没有发票信息，允许正常打印
			if (printFlag == '0') {
				return false;
			} else {
				$.alert("信息", "此购物车没有对应的发票信息，不能进行补打或重打");
				return true;
			}
		}
	};
	
	//判断是否已打印过发票，true-有旧发票需要作废,false-没有旧发票
	var _invalidInvoice=function(invoiceInfos, printFlag) {
		if (invoiceInfos != undefined && invoiceInfos instanceof Array && invoiceInfos.length > 0) {
			//筛选invoiceId，展示需要作废的发票代码和发票号码
			$('#invalidInvoiceDiv').remove();
			var html = '';
			html += '<div class="easyDialogdiv" style="width:481px;height:300px;" id="invalidInvoiceDiv">';
			html += '  <div class="easyDialogclose" id="invalidInvoiceClose"></div>';
			html += '  <h5 class="s_title">存在未作废发票，请先作废发票</h5>';
			html += '  <div class="form-content" id="infoDiv">';
			html += '  </div>';
			html += '  <div align="center" style="margin: 20px auto;">';
			html += '    <a id="invalidInvoiceConfirm" class="btna_o" href="javascript:void(0)"><span >确认</span></a>';
			html += '    <a id="invalidInvoiceCancel" class="btna_o" style="margin-left:20px;" href="javascript:void(0)"><span>取消</span></a>';
			html += '  </div>'; 
			html += '</div>';
			$('body').append(html);
			
			var infoHtml = '';
			var invoiceIds = [];
			for (var i=0; i < invoiceInfos.length; i++) {
				var info = invoiceInfos[i];
				if ($.inArray(info.invoiceId, invoiceIds) >= 0) {
					
				} else {
					infoHtml += '<div class="marginAndFont">发票代码：' + info.invoiceNbr + '; 发票号码：' + info.invoiceNum + '</div><br>';
					invoiceIds.push(info.invoiceId);
				}
			}
			if (invoiceIds.length > 0) {
				//需要作废发票
				common.print.oldInvoiceFlag = '1';
				$("#infoDiv").html(infoHtml);
				easyDialog.open({
					container : 'invalidInvoiceDiv'
				});
				$("#invalidInvoiceConfirm").off("click").on("click", function() {
					common.print.oldInvoiceFlag = '0';
					easyDialog.close();
				});
				$("#invalidInvoiceCancel").off("click").on("click", function() {
					easyDialog.close();
				});
			}
			return false;
		} else {
			return false;
		}
	};
	//校验费用项能否被打印，true-可以打印；false-不可打印
	var _checkChargeItem=function(item){
		var payMethodCd = item.payMethodCd;
		if (payMethodCd == CONST.PAYMETHOD_CD.ZHANG_WU_DAI_SHOU) {
			return false;
		}
		return true;
	};
	
	//校验发票抬头，发票代码，发票号码等
	var _chkInput=function(param){
		try {
			//发票的需要校验代码和号码
			if (param.billType != 1) {
				if ($("#invoiceNbrInp").val() == "") {
					$.alert("提示","请输入发票代码");
					return true;
				}
				//原17位发票代码，现12位
				if (!/^\d{0,12}$/.test($("#invoiceNbrInp").val())) {
					$.alert("提示","请输入正确的发票代码");
					return true;
				}
				if ($("#invoiceNumInp").val() == "") {
					$.alert("提示","请输入发票号码");
					return true;
				}
				//8位发票号码
				if (!/^\d{0,12}$/.test($("#invoiceNumInp").val())) {
					$.alert("提示","请输入正确的发票号码");
					return true;
				}
			}
			if ($("#invoiceTitleInp").val() == "") {
				$.alert("提示","请输入发票抬头");
				return true;
			}
			
			if($("#invoiceContDiv tbody input:checked").length < 1) {
				$.alert("提示","请选择要打印的费用项");
				return true;
			}
		} catch (e) {
			return true;
		}
		return false;
	};
	var _prepareInitParam=function(param, queryResult) {
		var invoiceInfos =[];
		var invoiceInfo = {
			"acctItemIds": [],
			"instanceType": 2,//根据过滤取值，优先为产品或销售品，2-产品，7-销售品
			"instanceId": 0,//根据过滤取值，优先为产品或销售品
			"invoiceType": "100", //目前阶段我们用到的是：100 普通发票和 200 收据。待后续有营改增需求后再 用其它类型。
			"staffId": OrderInfo.staff.staffId,
			"amount": 0,
			"realPay": 0,
			"tax": 0,//可为空，暂为0
			"invoiceNbr": 0,//发票代码，前台人工输入，票据时可为空
			"invoiceNum": "0",//发票号码，前台人工输入，票据时可为空
			"custOrderId": OrderInfo.orderResult.olId,
			"custSoNumber": OrderInfo.orderResult.olNbr,
			"custId": OrderInfo.cust.custId,
			"commonRegionId": OrderInfo.staff.areaId,
			"channelId": OrderInfo.staff.channelId,
			"bssOrgId": OrderInfo.staff.orgId,
			"acctNbr": 0,//接入号码，根据5.12接口返回展示，前台选择
			"paymethod": 100000,
			"busiName": "具体业务说明",//可为空
			"rmbUpper": "人民币大写",//固定此值
			"accountUpper": "零圆整",
			"account": 0,
			"billType": param.billType,//票据类型：0发票，1收据
			"printFlag": param.printFlag,//打印标记：0正常打印，1重打票据，2补打票据，-1未打印
			"invoiceId": 0
		};
		
		var instanceFlag = false;
		var sumFeeAmount = 0;
		var sumRealAmount = 0;
		var sumTax = 0;
		var items = [];
		var payMethodName = "";
		var chargeItems = queryResult.chargeItems;
		for(var i=0;i<chargeItems.length;i++){
			var item = chargeItems[i];
			invoiceInfo.acctItemIds.push({"acctItemId": item.acctItemId});
			if (item.objType == "2") {
				invoiceInfo.instanceType = item.objType;
				invoiceInfo.instanceId = item.objId;
				invoiceInfo.paymethod = item.payMethodCd;
				instanceFlag = true;
			} else if (!instanceFlag && item.objType == "7") {
				invoiceInfo.instanceType =item.objType;
				invoiceInfo.instanceId = item.objId;
				invoiceInfo.paymethod = item.payMethodCd;
			}
			//计算金额
			sumFeeAmount += parseInt(item.feeAmount);
			sumRealAmount += parseInt(item.realAmount);
			sumTax += parseInt(item.tax);
			payMethodName = item.payMethodName;
		}
		
		//设置金额
		invoiceInfo.amount = sumFeeAmount;
		invoiceInfo.realPay = sumRealAmount;
		invoiceInfo.tax = sumTax;
		invoiceInfo.account = sumRealAmount;
		invoiceInfo.accountUpper = ec.util.atoc(sumRealAmount);
		//取实例ID和类型
		invoiceInfo.invoiceNbr = 0;
		invoiceInfo.invoiceNum = "0";
		//取接入号
		var prodInfo = queryResult.prodInfo;
		if (prodInfo != undefined && prodInfo.length > 0) {
			invoiceInfo.acctNbr = prodInfo[0].accessNumber;
		}
		
		invoiceInfos.push(invoiceInfo);
		var result = {
			"payMethodName" : payMethodName,
			"items" : items,
			"invoiceInfos" : invoiceInfos
		};
		return result;
	};
	var _addParam=function(param, queryResult) {
		var invoiceInfos = [];
		var invoiceInfo = {
			"acctItemIds": [],
			"instanceType": 2,//根据过滤取值，优先为产品或销售品，2-产品，7-销售品
			"instanceId": 0,//根据过滤取值，优先为产品或销售品
			"invoiceType": "100", //目前阶段我们用到的是：100 普通发票和 200 收据。待后续有营改增需求后再 用其它类型。
			"staffId": OrderInfo.staff.staffId,
			"amount": 0,
			"realPay": 0,
			"tax": 0,//可为空，暂为0
			"invoiceNbr": 0,//发票代码，前台人工输入，票据时可为空
			"invoiceNum": "0",//发票号码，前台人工输入，票据时可为空
			"custOrderId": OrderInfo.orderResult.olId,
			"custSoNumber": OrderInfo.orderResult.olNbr,
			"custId": OrderInfo.cust.custId,
			"commonRegionId": OrderInfo.staff.areaId,
			"channelId": OrderInfo.staff.channelId,
			"bssOrgId": OrderInfo.staff.orgId,
			"acctNbr": 0,//接入号码，根据5.12接口返回展示，前台选择
			"paymethod": 100000,
			"busiName": "具体业务说明",//可为空
			"rmbUpper": "人民币大写",//固定此值
			"accountUpper": "零圆整",
			"account": 0,
			"billType": param.billType,//票据类型：0发票，1收据
			"printFlag": param.printFlag,//打印标记：0正常打印，1重打票据，2补打票据，-1未打印
			"invoiceId": 0
		};
		//设置invoiceId
		invoiceInfo.invoiceId = queryResult.invoiceInfos[0].invoiceId;
		//设置票据类型
		invoiceInfo.billType = $("input[name='billType']:checked").val();
		//设置发票类型
		if (invoiceInfo.billType == '0') {
			invoiceInfo.invoiceType = '100';
		} else {
			invoiceInfo.invoiceType = '200';
		}
		
		
		var instanceFlag = false;
		var sumFeeAmount = 0;
		var sumRealAmount = 0;
		var sumTax = 0;
		var items = [];
		var payMethodName = "";
		//获取费用项和接入号的关系
		var rela = _getAcceNbrBoIdRela(queryResult);
		invoiceInfo.acctItemIds = [];
		$("#invoiceContDiv tbody input:checked").parent().parent().each(function(){
			//设置账单项ID
			invoiceInfo.acctItemIds.push({"acctItemId": $(this).attr("acctItemId")});
			//设置实例id和类型，优先为产品或销售品，2-产品，7-销售品
			if ($(this).attr("objType") == "2") {
				invoiceInfo.instanceType = $(this).attr("objType");
				invoiceInfo.instanceId = $(this).attr("objId");
				invoiceInfo.paymethod = $(this).attr("payMethodCd");
				instanceFlag = true;
			} else if (!instanceFlag && $(this).attr("objType") == "7") {
				invoiceInfo.instanceType = $(this).attr("objType");
				invoiceInfo.instanceId = $(this).attr("objId");
				invoiceInfo.paymethod = $(this).attr("payMethodCd");
			}
			//计算金额
			sumFeeAmount += parseInt($(this).attr("feeAmount"));
			sumRealAmount += parseInt($(this).attr("realAmount"));
			sumTax += parseInt($(this).attr("tax"));
			var accessNumber = '';
			var boId = $(this).attr("boId");
			for (var i=0; i < rela.length; i++) {
				if (boId == rela[i].boId) {
					accessNumber = rela[i].accessNumber;
				}
			}
			
			items.push({
				"itemName" : $(this).attr("acctItemTypeName"),
				"charge" : parseInt($(this).attr("realAmount")),
				"tax" : parseInt($(this).attr("tax")),
				"acceNumber" : accessNumber
			});
			payMethodName = $(this).attr("payMethodName");
		});
		if(OrderInfo.actionFlag==11){
			invoiceInfo.printFlag = 0;
		}
		
		//设置金额
		invoiceInfo.amount = sumFeeAmount;
		invoiceInfo.realPay = sumRealAmount;
		invoiceInfo.tax = sumTax;
		invoiceInfo.account = sumRealAmount;
		invoiceInfo.accountUpper = ec.util.atoc(sumRealAmount);
		//取实例ID和类型
		invoiceInfo.invoiceNbr = $("#invoiceNbrInp").val();
		invoiceInfo.invoiceNum = "" + $("#invoiceNumInp").val();
		//取接入号
		invoiceInfo.acctNbr = $("#acceNbrSel option:selected").val();
		
		invoiceInfos.push(invoiceInfo);
		var result = {
			"payMethodName" : payMethodName,
			"items" : items,
			"invoiceInfos" : invoiceInfos
		};
		return result;
	};
	var _getAcceNbrBoIdRela=function(queryResult) {
		var rela = [];
		var chargeItems = queryResult.chargeItems;
		var prodInfo = queryResult.prodInfo;
		for (var i=0; i < chargeItems.length; i++) {
			var boId = chargeItems[i].boId;
			for(var j=0; j < prodInfo.length; j++) {
				var accessNumber = prodInfo[j].accessNumber;
				var busiOrders = prodInfo[j].busiOrders;
				for (var k=0; k < busiOrders.length; k++) {
					if (busiOrders[k].boId == boId) {
						var tmp = {
							"boId" : boId,
							"accessNumber" : accessNumber
						};
						rela.push(tmp);
					}
				}
			}
		}
		return rela;
	};
	
	var _saveInvoiceInfo=function(param, queryResult){
		
		if (_chkInput(param)) {
			return;
		}
		if (!queryResult.invoiceInfos[0]) {
			$.alert("提示","集团营业受理后台接口返回缺少发票信息，请确认。");
			return;
		}
		var result = _addParam(param, queryResult);
		var invoiceInfos = result.invoiceInfos;
		
		var params={"invoiceInfos" : invoiceInfos};
		var smResp = _invokeSavingMethod(params, param.printFlag);
		if (smResp == false) {
			return;
		}
		
		//调用受理后台结束，开始调用生成PDF
		var invoiceParam = {
			"partyName" : $("#invoiceTitleInp").val(),
			"templateId" : $("#tempListSel :selected").val(),
			"prodInfo" : queryResult.prodInfo,
			"items" : result.items,
			"payMethod" : result.payMethodName,
			"invoiceInfos" : invoiceInfos
		};
		_printInvoice(invoiceParam);
		//最终关闭窗口
		if (OrderInfo.cust.norTaxPayer != "Y") {
			common.print.closePrintDialog();
		}
		return;
	};
	var _invokeSavingMethod=function(params, printFlag){
		$.ecOverlay("<strong>正在提交中,请稍等会儿....</strong>");
		var response = $.callServiceAsJson(contextPath+"/print/saveInvoiceInfo",params);
		$.unecOverlay();
		if(response.code == -2) {
			$.alertM(response.data);
			return false;
		} else if(response.code != 0 || response.data.resultCode != "0") {
			$.alert("提示", _getPrintState(printFlag) + "调用集团发票打印处理接口失败，请稍后重试");
			return false;
		}
		return response;
	};
	var _setInvoiceId=function(invoiceInfos, invoiceIds, printFlag) {
		for(var i=0;i<invoiceInfos.length;i++){
			invoiceInfos[i].invoiceId = invoiceIds[i];
			invoiceInfos[i].printFlag = printFlag;
		}
		return invoiceInfos;
	};
	
	var _getCookie = function(name){
		var cookievalue = "";
		var arr = document.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));
		if(arr != null) {
			cookievalue = unescape(arr[2]);
		}
		return cookievalue;
	};
	var _printInvoice=function(invoiceParam){
		$("#invoiceForm").remove();
		if(_getCookie('_session_pad_flag')=='1'){
			var arr=new Array(3);
			if(ec.util.browser.versions.android){
				arr[0]='print/invoice';
			}else{
				arr[0]='print/iosInvoice';
			}
			arr[1]='invoiceParam';
			arr[2]=encodeURI(JSON.stringify(invoiceParam));
			MyPlugin.printShow(arr,
                function(result) {
                },
                function(error) {
                }
			);
		}else{
		    $("<form>", {
		    	id: "invoiceForm",
		    	style: "display:none;",
		    	target: "_blank",
		    	method: "POST",
		    	action: contextPath + "/print/invoice"
		    }).append($("<input>", {
		    	id : "invoiceParam",
		    	name : "invoiceParam",
		    	type: "hidden",
		    	value: encodeURI(JSON.stringify(invoiceParam))
		    })).appendTo("body").submit();
		}
	};
	return {
		preVoucher:_preVoucher,
		printVoucher:_printVoucher,
		preInvoice:_preInvoice,
		initPrintInfo:_initPrintInfo,
		closePrintDialog : _closePrintDialog,
		prepareInvoiceInfo:_prepareInvoiceInfo,
		saveInvoiceInfo:_saveInvoiceInfo,
		chkInput : _chkInput,
		printInvoice : _printInvoice,
		preSign:_preSign,
		signVoucher:_signVoucher
	};
})(jQuery);

//初始化
$(function(){
	
});
CommonUtils.regNamespace("product", "query");

/**
 * 产品通用查询
 */
product.query = (function(){
		
	var _areaId = "";
	
	//页面初始化
	var _init = function(){
		$("#accurate").attr("checked","checked");
		$("#num").attr("disabled", false);
		$("#custName").attr("disabled", true);
		
		$("#accurate").change(function(){
			if($("#accurate").attr("checked")){
				$("#num").attr("disabled", false);
				$("#custName").attr("disabled", true);
			}
			else{
				$("#num").attr("disabled", true);
				$("#custName").attr("disabled", false);
			}
		});
		
		$(".easyDialogclose").click(function(){
			easyDialog.close();			
		});						
	};
	
	//地区选择（系统管理维度列表弹出框）	
	var _chooseArea = function(){
		order.area.chooseAreaTreeManger("prod/preProdQuery","p_areaId_val","p_areaId",3);
	};
	
	//客户查询（弹出框）
	var _showQueryCust = function(){
		if($("#p_areaId_val").val()!=""){
			if($("#p_areaId").val().substring(3, 7)=="0000"){
				$.alert("提示","请选择本地网（地市级）地区进行查询");
				return;
			}
		}else{
			$.alert("提示","请先选择所属地区再进行客户查询");
			return;
		}
		easyDialog.open({
			container : "d_cust"
		});
		$("#cust").val("");
		$("#custlist").html("");
	};
	
	//初始化客户认证类型弹出框
	var _initCustIdType = function(){
		var param = {attrSpecCode : "PTY-0004"};
		$.callServiceAsJson(contextPath+"/staffMgr/getCTGMainData",param,{
			"done" : function(response){
				if(response.code==0){
					var data = response.data ;
					if(data!=undefined && data.length>0){
						for(var i=0;i<data.length;i++){
							var busiStatus = data[i];
							$("#cust_id_type").append("<option value='"+busiStatus.attrValueCode+"' >"+busiStatus.attrValueName+"</option>");							
						}
					}
				}else if(response.code==-2){
					$.alertM(response.data);
					return;
				}else{
					$.alert("提示","调用主数据接口失败！");
					return;
				}
			}
		});
	};
	
	//变更客户认证类型
	var _changeCustIdType = function(option){
		var type = $(option).val();
		if(type==0){
			$("#cust").attr("placeHolder","请输入有效的中国电信手机号");
			$("#cust").attr("data-validate","validate(isTelecomSection:请输入有效的中国电信号码) on(blur)");
		}
		else if(type==1){
			$("#cust").attr("placeHolder","请输入合法的身份证号码");
			$("#cust").attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(blur)");
		}
		else if(type==2){
			$("#cust").attr("placeHolder","请输入合法的军官证");
			$("#cust").attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}
		else if(type==3){
			$("#cust").attr("placeHolder","请输入合法的护照");
			$("#cust").attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}
		else{
			$("#cust").attr("placeHolder","请输入合法的证件号码");
			$("#cust").attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		$("#cust").val("");
		_queryCust();
	};
	
	//查询客户
	var _queryCust = function(){
		$("#custQueryForm").off().bind("formIsValid", function(event, form){			
			var _acctNbr = "";
			var _identityNum = "";
			var _identityCd = "";
			if($("#cust_id_type").val()==0){
				_acctNbr = $("#cust").val();
			}
			else{
				_identityCd = $("#cust_id_type").val();
				_identityNum = $("#cust").val();
			}
			var param = {
					acctNbr : _acctNbr,
					identityCd : _identityCd,
					identityNum : _identityNum,
					partyName : "",
					custQueryType : $("#custQueryType").val(),
					diffPlace : "maybe",
					areaId : $("#p_areaId").val(),
					query : "prod"  //产品通用查询的页面标志
			};
			$.callServiceAsHtml(contextPath+"/cust/queryCust",param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done":function(response){
					if(response.code != 0) {
						$.alert("提示","查询失败,稍后重试");
						return;
					}
					if(response.data.indexOf("false") >=0) {
						$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
						return;
					}
					$("#custlist").html(response.data).show();
				},
				fail:function(response){
					$.unecOverlay();
					$.alert("提示","查询失败，请稍后再试！");
				}				
			});
		}).ketchup({bindElement:"bt_cust_query"});
	};
	
	//选定客户
	var _chooseCust = function(tr){
		var custName = $(tr).find("td:eq(0)").text();
		var custId = $(tr).find("td:eq(3)").text();
		$("#custName").val(custName).attr("name", custId);
		easyDialog.close();
	};
	
	//产品信息查询
	var _queryProduct = function(page){
	
		var _curPage = 1;
		if(page>0){
			_curPage = page;
		}
		var _pageSize = 12;		
		var param = {
				curPage : _curPage,
				pageSize : _pageSize,
				areaId : $("#p_areaId").val()
			};
					
		if($("#accurate").attr("checked")){//使用接入号精确查询
			if($("#p_areaId_val").val()!=""){
				if($("#p_areaId").val().substring(3, 7)=="0000"){
					$.alert("提示","请选择本地网（地市级）地区进行查询");
					return;
				}
			}else{
				$.alert("提示","请先选择所属地区再进行客户查询");
				return;
			}
			var _acctNbr = $.trim($("#num").val());
			var check = /^(180|189|133|134|153|181|108|170|177)\d{8}$/.test(_acctNbr);
			if(check==false){
				$.alert("提示","若要进行精确查询，请输入有效的中国电信手机号");
				return;
			}
			param.acctNbr = _acctNbr;
		}else{//使用客户下查询
			if($("#custName").val()==""){
				$.alert("提示","请先定位客户再进行查询");
				return;
			}
			var _custId = $("#custName").attr("name");
			param.custId = _custId;
			param.acctNbr = "";
		}
		$.callServiceAsHtmlGet(contextPath+"/prod/prodQuery", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if(!response){
					response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';					
				}
				if(response.data =="fail\r\n"){
					$.alert("提示","查询失败，请稍后再试");
					return;
				}
				if(response.data =="error\r\n"){
					$.alert("提示","数据异常，请联系管理员");
					return;
				}
				$("#prodList").html(response.data).show();	
				$("#prodDetail").hide();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	
	//产品实例详情查询
	var _queryProdDetail = function(_prodId, _acctNbr, _areaId){
		
		var param = {
				prodId : _prodId,
				acctNbr : _acctNbr,
				areaId : _areaId
		};
		$.callServiceAsHtmlGet(contextPath+"/prod/prodDetailQuery", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if(!response){
					response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';					
				}
				if(response.data =="fail\r\n"){
					$.alert("提示","查询失败，请稍后再试");
					return;
				}
				if(response.data =="error\r\n"){
					$.alert("提示","数据异常，请联系管理员");
					return;
				}
				$("#prodDetail").html(response.data).show();
				$("#prodInfo h2").html("产品详情");
				$("#prodInfo").show();
				$("#prodList").hide();
				$("#orderedprod").hide();
				$("#orderContent").hide();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	
	//切换帐户标签
	var _changeAcct = function(n){		
		$("#acct_tab").find("li[class=setcon]").removeClass();
		$("#acct_tab_"+n).addClass("setcon");
		$("#acct_div").find("div[class=show]").removeClass().hide();		
		$("#acct_div_"+n).addClass("show").show();		
	};
	
	//返回按钮
	var _back = function(){
		$("#prodDetail").hide();
		$("#prodInfo").hide();
		$("#prodList").show();
		$("#orderedprod").show();
		$("#orderContent").show();
	};
	
	return{
		init : _init,
		areaId : _areaId,
		chooseArea : _chooseArea,
		showQueryCust : _showQueryCust,
		initCustIdType : _initCustIdType,
		changeCustIdType : _changeCustIdType,
		queryCust : _queryCust,
		chooseCust : _chooseCust,
		queryProduct : _queryProduct,
		queryProdDetail : _queryProdDetail,
		changeAcct : _changeAcct,
		back : _back
	};
	
})();

$(function(){
	
	product.query.init();
	product.query.initCustIdType();
	product.query.queryCust();
	
});
/**
 * 订单准备
 * 
 * @author tang
 */
CommonUtils.regNamespace("prod", "transferModify");
/**
 * 订单准备
 */
prod.transferModify = (function(){
	var _toCustName="";
	var _transchoosedCustInfo={};
	var _BO_ACTION_TYPE="";
	//选中的帐户信息
	var _choosedAcctInfo = {};
	//过户
	var _showCustTransfer = function () {
		OrderInfo.busitypeflag=15;
/*if(order.prodModify.choosedProdInfo.prodStateCd!="100000"||order.prodModify.choosedProdInfo.prodStateCd!="140000"){
			$.alert("提示","产品状态为\"在用\"才能进行过户","information");
			return;
		}*/
			var submitState="";
	        _BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.TRANSFER;
			submitState="ADD";
			var param = order.prodModify.getCallRuleParam(_BO_ACTION_TYPE, order.prodModify.choosedProdInfo.prodInstId);
			var callParam = {
				boActionTypeCd : _BO_ACTION_TYPE,
				boActionTypeName : CONST.getBoActionTypeName(_BO_ACTION_TYPE),
				accessNumber : "",
				prodOfferName : "",
				state:submitState
			};
			var checkRule = rule.rule.prepare(param,'prod.transferModify.custTransfer',callParam);
			if (checkRule) return;
	};
	//过户返档
	var _showCustTransferReturn = function () {
		OrderInfo.busitypeflag=0;
		/*	if(order.prodModify.choosedProdInfo.prodStateCd!="100000"||order.prodModify.choosedProdInfo.prodStateCd!="140000"){
					$.alert("提示","产品状态为\"在用\"才能进行过户","information");
					return;
				}*/
					var submitState="";
			        _BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.TRANSFERRETURN;
					submitState="ADD";
					var param = order.prodModify.getCallRuleParam(_BO_ACTION_TYPE, order.prodModify.choosedProdInfo.prodInstId);
					var callParam = {
						boActionTypeCd : _BO_ACTION_TYPE,
						boActionTypeName : CONST.getBoActionTypeName(_BO_ACTION_TYPE),
						accessNumber : "",
						prodOfferName : "",
						state:submitState
					};
					var checkRule = rule.rule.prepare(param,'prod.transferModify.custTransfer',callParam);
					if (checkRule) return;
			};
			
	//过户订单提交
	var _custTransfer_Submit = function() {
		
		var toCustId = $("#litransCustId").attr("transCustId");
		var _toCustId = -1;
		if(toCustId!=""){
			_toCustId = toCustId;
		}
		var toCustName = $("#litransCustId").attr("transCustName");
		var toAddressStr = $("#litransCustId").attr("transAddressStr");
		var toIdentidiesTypeCd = $("#div_tra_identidiesTypeCd option:selected").val();
		var toIdCardNumber = $("#litransidCardNumber").attr("transidCardNumber");
		
		if(toCustId==OrderInfo.cust.custId){
			$.alert("提示","同一客户，无需过户，请确认！","information");
			return;		   
		}
		if(toIdCardNumber==undefined || toCustId==undefined){		
			$.alert("提示","未定位目标客户，请先定位！","information");		
			return;
	    }
		//帐户信息校验
		if(!$("#acctSelect").val()){
			$.alert("提示","请新建或者查询选择一个可用帐户");
			return;
		}
		if($("#acctSelect").val()<0){
			//帐户信息填写校验
			if(!SoOrder.checkAcctInfo()){
				return;
			}
		}
		
		var acctId = $("#acctSelect").val(); //要更换的帐户ID
		var acctCd = -1;
		if(acctId>0){
			acctCd = $("#acctSelect").find("option:selected").attr("acctcd"); //要更换的帐户合同号
		}
		SoOrder.builder();
		//查询产品下帐户信息
		var param = {
				prodId : order.prodModify.choosedProdInfo.prodInstId,
				acctNbr : order.prodModify.choosedProdInfo.accNbr,
				areaId : order.prodModify.choosedProdInfo.areaId
			};
		var jr = $.callServiceAsJson(contextPath+"/order/queryProdAcctInfo", param);
		if(jr.code != 0||jr.data.length==0) {
			if(jr.code==-2){
				$.alertM(jr.data);
			}
			else{
				$.alert("提示","当前产品帐户定位失败，请联系管理员");
			}
			return;
		}
		var origAcct = jr.data[0]; //原帐户信息
		var changeAcct = true;		
		if(origAcct.acctId==acctId){				
			changeAcct = false;							
		}
		if(origAcct.priority==""){
			origAcct.priority = 1;
		}
        OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,_BO_ACTION_TYPE,10,CONST.getBoActionTypeName(_BO_ACTION_TYPE),"");
			
			var busiOrder = [	];
			//新建客户节点
			if(toCustId==""){
				var createCust = {						
						areaId : order.prodModify.choosedProdInfo.areaId,						
						boActionType : {							
							actionClassCd : CONST.ACTION_CLASS_CD.CUST_ACTION, //动作大类：客户动作							
							boActionTypeCd : CONST.BO_ACTION_TYPE.CUST_CREATE //动作小类：新建客户							
						},						
						busiObj : {					        
							instId : -1				        								
						},						
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						},						
						data : {
							boCustIdentities: [ {				                
								identidiesTypeCd : toIdentidiesTypeCd,	//证件类型编码			                
								identityNum : toIdCardNumber, //证件号码
								defaultIdType :toIdentidiesTypeCd,	//证件类型编码		
								state : "ADD"
				            }],				        
				            boCustInfos: [{				                
				            	areaId : order.prodModify.choosedProdInfo.areaId,  
				                businessPassword : "111111",
				                name :  toCustName,
								addressStr :toAddressStr,//客户地址
				                partyTypeCd : 1,
				                state : "ADD"
				            }]
						}
				};
				busiOrder.push(createCust);
			}
			//更换客户节点
			var transferCust = {
					areaId : order.prodModify.choosedProdInfo.areaId,	
					boActionType : {
						actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION, //动作大类：产品动作
						boActionTypeCd : _BO_ACTION_TYPE //动作小类：过户
					},
					busiObj : {				        
						accessNumber : order.prodModify.choosedProdInfo.accNbr,			        
						instId : order.prodModify.choosedProdInfo.prodInstId,			        
						isComp : "N",			        
						objId : order.prodModify.choosedProdInfo.productId,			        
						offerTypeCd : "1"			    
					}, 
					busiOrderInfo : {
						seq : OrderInfo.SEQ.seq--
					},	
					data : {
						boCusts : [{			                
							partyId : order.prodModify.choosedProdInfo.custId,			                
							partyProductRelaRoleCd : 0,			                
							state : "DEL"			            
						},
			            {
			                partyId : _toCustId,
			                partyProductRelaRoleCd : 0,
			                state : "ADD"
			            }],
			            busiOrderAttrs : [{			            				    				
			            	itemSpecId : "111111118",	    				
			            	value : $("#order_remark").val() //订单备注		    			
			            }]
					}
			};
			busiOrder.push(transferCust);
			//过户返档
			if(_BO_ACTION_TYPE==CONST.BO_ACTION_TYPE.TRANSFERRETURN){
				var busiOrderAdd = {
						areaId : order.prodModify.choosedProdInfo.areaId,  //受理地区ID		
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							accessNumber: order.prodModify.choosedProdInfo.accNbr,
							instId : order.prodModify.choosedProdInfo.prodInstId, //业务对象实例ID
							objId :order.prodModify.choosedProdInfo.productId
						},  
						boActionType : {
							actionClassCd: CONST.ACTION_CLASS_CD.PROD_ACTION,
		                    boActionTypeCd: CONST.BO_ACTION_TYPE.ACTIVERETURNTWO
						}, 
						data:{}
					};
				busiOrderAdd.data.boProdStatuses = [{
					prodStatusCd : CONST.PROD_STATUS_CD.READY_PROD,
					state : "DEL"
				},{
					prodStatusCd : CONST.PROD_STATUS_CD.DONE_PROD,
					state : "ADD"
				}
				];
				busiOrder.push(busiOrderAdd);
				
			}
			//新建帐户节点
			if($("#acctSelect").val()==-1){
				OrderInfo.createAcct(busiOrder, -1);
			}
			//更换帐户节点
			if(changeAcct){
				var transferAcct = {
						areaId : order.prodModify.choosedProdInfo.areaId,
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION, //动作大类：产品动作
							boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT //动作小类：改帐务定制关系
						}, 
						busiObj : {				        
							accessNumber : order.prodModify.choosedProdInfo.accNbr,			        
							instId : order.prodModify.choosedProdInfo.prodInstId,			        
							isComp : "N",			        
							objId : order.prodModify.choosedProdInfo.productId,			        
							offerTypeCd : "1"			    
						}, 
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						},	
						data : {
							boAccountRelas : [{
								acctCd : origAcct.acctCd,							
								acctId : origAcct.acctId,							
								acctRelaTypeCd : 1,							
								chargeItemCd : origAcct.chargeItemCd,				
								percent : origAcct.percent,							
								priority : origAcct.priority,							
								prodAcctId : origAcct.prodAcctId,						
								state : "DEL"			
							},
							{
								acctCd : acctCd,
								acctId : acctId,
								acctRelaTypeCd : 1,
								chargeItemCd : 1,               
								percent : 100,               
								priority : 1,                 
								prodAcctId : -1,              
								state : "ADD"
							}]							                
						}
				};
				busiOrder.push(transferAcct);
				//订单提交
				SoOrder.submitOrder(busiOrder);
				
			}
			else{
				$.confirm("提示信息","只更换了所属客户，而没有更换付费帐户<br/>确定吗？", {
					yes : function(){
						SoOrder.submitOrder(busiOrder);
					},
					no : function(){
						return;
					}
				}, "question");
			};
	};
    //客户类型选择事件
	var _partyTypeCdChoose = function(scope) {
		var partyTypeCd=$(scope).val();
		//_partyType(partyTypeCd);
		//客户类型关联证件类型下拉框
		$("#div_tra_identidiesTypeCd").empty();
		_certTypeByPartyType(partyTypeCd);
		_identidiesTypeCdChoose($("#div_tra_identidiesTypeCd").children(":first-child"));

	};
	var _partyType = function(partyTypeCd) {
		if(partyTypeCd=="1"){
			var identidiesTypeCdHtml="<select id=\"tra_IdentidiesTypeCd\" onchange=\"order.transferModify.identidiesTypeCdChoose(this)\"><option value=\"1\" >身份证</option><option value=\"2\">军官证</option></select>";
		}else if(partyTypeCd=="2"){
			var identidiesTypeCdHtml="<select id=\"tra_IdentidiesTypeCd\" onchange=\"order.transferModify.identidiesTypeCdChoose(this)\"><option value=\"3\">护照</option><option value=\"23\">ICP经营许可证</option><option value=\"39\">税务登记号</option></select>";
		};
		$("#div_tra_identidiesTypeCd").html(identidiesTypeCdHtml);
	};
	//证件类型选择事件
	var _identidiesTypeCdChoose = function(scope) {
		var identidiesTypeCd=$(scope).val();
		if(identidiesTypeCd==1||identidiesTypeCd=="undefined"){
			$("#transfercCustIdCard").attr("placeHolder","请输入合法身份证号码");
			$("#transfercCustIdCard").attr("data-validate","validate(idCardCheck:请输入合法身份证号码) on(blur)");
		}else if(identidiesTypeCd==2){
			$("#transfercCustIdCard").attr("placeHolder","请输入合法军官证");
			$("#transfercCustIdCard").attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}else if(identidiesTypeCd==3){
			$("#transfercCustIdCard").attr("placeHolder","请输入合法护照");
			$("#transfercCustIdCard").attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}else{
			$("#transfercCustIdCard").attr("placeHolder","请输入合法证件号码");
			$("#transfercCustIdCard").attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		_form_TransfercustCreate_btn();
	};
	var _form_custTransfer_btn = function() {
		//过户至客户定位按钮
		$('#custTransferForm').off("formIsValid").on("formIsValid",function(event) {
			var identityCd="";
			var acctNbr="";
			var identityNum="";
			identityCd=$("#p_cust_tra_identityCd").val();
			identityNum=$.trim($("#TransferNum").val());
			if(identityNum==""){
				$.alert("提示","请输入证件号码！");
				return;
			}
			if($("#TransferNum").val().length<14){
				 authFlag="0";
				}
				else{
				 authFlag="1";
				}
			//判断是否是号码或身份证输入
			if(identityCd==1){
			 identityCd=$("#p_cust_tra_identityCd").val();
			}
			if(identityCd==-1){
				acctNbr=identityNum;
				identityNum="";
				identityCd="";
			}
			/*{"acctNbr":"13301543143","identityCd":"","areaId":"2,74,77,20,21,75,1000,23,76","identityNum":"","staffId":"1001"}*/
			var param = {
					"acctNbr":acctNbr,
					"identityCd":identityCd,
					"identityNum":identityNum,
					"partyName":"",
					"custQueryType":$("#custQueryType").val()
			};
			$.callServiceAsHtml(contextPath+"/order/prodModify/transferQueryCust",param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
				},"done" : function(response){
					if(response.code != 0) {
						$.alert("提示","查询失败,稍后重试");
						return;
					}
					_queryCallBack(response);
				},fail:function(response){
					$.unecOverlay();
					$.alert("提示","查询失败，请稍后再试！");
				},"always":function(){
					$.unecOverlay();
					$("#usersearchbtn").attr("disabled",false);
				}
			});
		}).ketchup({bindElement:"custTransferBtn"});
	};
	var _form_TransferAuth_btn = function() {
		//过户至客户客户鉴权按钮
	$('#transCustAuthForm').unbind("click").bind('formIsValid', function(event, form) {
		var param = _transchoosedCustInfo;
		param.prodPwd = $.trim($("#transAuthPassword").val());
		//param.accessNumber="11969577";//TODO need modify
		//param.accessNumber=choosedCustInfo.accessNumber;
		param.authFlag=authFlag;
		$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				if(response.data.indexOf("false") >=0) {
					$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
					return;
				}
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
	}).ketchup({bindElement:"transCustAuthbtn"});
	};
	var _form_TransfercustCreate_btn = function() {
	//过户创建客户确认按钮
	$('#ransferCustCreateForm').unbind("click").bind('formIsValid',function(event) {
		var createCustInfo = {
				cCustName : $.trim($("#transfercCustName").val()),
				cCustIdCard :  $.trim($("#transfercCustIdCard").val()),
				cAddressStr :  $.trim($("#transfercAddressStr").val())
			};
		easyDialog.close();
		var param = {};
		param.prodPwd = "";
		param.accessNumber="";
		param.authFlag="1";
		authFlag="";
		param.idCardNumber=createCustInfo.cCustIdCard;
		param.partyName=createCustInfo.cCustName;
		param.identityName=$("#div_tra_identidiesTypeCd option:selected").text();
		param.addressStr=createCustInfo.cAddressStr;
		$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				if(response.data.indexOf("false") >=0) {
					$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
					return;
				}
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
	}).ketchup({bindElement:"ransferAddcustsussbtn"});
	};
	//过户客户定位查询列表
	var _queryCallBack = function(response) {
		if(response.data.indexOf("false") >=0) {
			$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
			return;
		}
		var content$ = $("#custTransferList");
		content$.html(response.data).show();
		$(".userclose").off("click").on("click",function(event) {
			authFlag="";
			$(".usersearchtranscon").hide();
		});
		$(".usersearchtranscon").show();
/*		$("#transCustAuth").off("click").on("click",function(event) {
			_showCustAuth(this);
		});*/
		_form_TransferAuth_btn();
	};
	//过户客户列表点击
	var _showCustAuth = function(scope) {
		_transchoosedCustInfo = {
			custId : $(scope).find("td:eq(3)").text(),
			partyName : $(scope).find("td:eq(0)").text(),
			idCardNumber : $(scope).attr("idCardNumber"),
			identityName : $(scope).attr("identityName"),
			areaName : $(scope).attr("areaName")
		};
		
		if($("#TransferNum").val().length<14){
			//TODO init view 
			easyDialog.open({
				container : 'Transferauth'
			});
			$("#transAuthClose").off("click").on("click",function(event){
				easyDialog.close();
				authFlag="";
				$("#transAuthPassword").val("");
			});
			}
			else{
				_custAuth(scope);
			}

	};
	/**
	 * 客户鉴权
	 */
	var _custAuth = function(scope) {
		var param = _transchoosedCustInfo;
		param.prodPwd = $.trim($("#transAuthPassword").val());
		//param.areaId = 21;//TODO need modify
		//param.accessNumber="11969577"; //need update
		//param.accessNumber=choosedCustInfo.accessNumber;
		param.authFlag=authFlag;
		$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				custInfo = param;
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	// cust auth callback
	var _custAuthCallBack = function(response) {
		if(authFlag=="0"){
			easyDialog.close();
		};
		if($.ketchup)
			$.ketchup.hideAllErrorContainer($("#custCreateForm"));
		var content$ = $("#custTransferInfo");
		content$.html(response.data).show();
		$("#custTransferList").hide();
		$(".usersearchtranscon").hide();
		
		if($("#litransCustId").attr("transCustId")==""){
			$("#TransferNum").val("");
			_transchoosedCustInfo.custId=-1;
			_toCustName=$.trim($("#transfercCustName").val());
		}else{		
			_toCustName=$("#litransCustId").attr("transcustname");
		}
		_initAcct();
		$("#accountDiv").show();
	};
	//过户创键客户
	var _showCustCreate = function(scope) {
		easyDialog.open({
			container : 'transfer_cust_add'
		});
		_partyTypeCdChoose($("#div_tra_partyTypeCd").children(":first-child"));
		
		$("#usercreateclose").off("click").on("click",function(event){
			easyDialog.close();
			$("#transfercCustName").val("");
			$("#transfercCustIdCard").val("");
			authFlag="";
			if($.ketchup)
				$.ketchup.hideAllErrorContainer($("#ransferCustCreateForm"));
		});
		_form_TransfercustCreate_btn();

	};
	var _jumpAuth = function() {
		var param = _transchoosedCustInfo;
		param.authFlag="1";
		$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	//每次定位客户后，初始化帐户展示
	var _initAcct = function() {
		//新建客户自动新建帐户
		if ($("#litransCustId").attr("transCustId")=="") {
			_whetherCreateAcct();
		} 
		//老客户默认查询使用其已有帐户，若没有老帐户则使用新建帐户
		else {
			var param = {
				custId : $("#litransCustId").attr("transCustId")
			};
			var response = order.prodModify.returnAccount(param);
			if(response.code==0){
				var returnMap = response.data;
				if(returnMap.resultCode==0){
					if(returnMap.accountInfos && returnMap.accountInfos.length > 0){
						$.each(returnMap.accountInfos, function(i, accountInfo){
							var found = false;
							$.each($("#acctSelect option"), function(i, option){
								if($(option).val()==accountInfo.acctId){
									found = true;
									return false;
								}
							});
							if(!found){
								$("<option>").text(accountInfo.name+" : "+accountInfo.accountNumber).attr("value",accountInfo.acctId).attr("acctcd",accountInfo.accountNumber).appendTo($("#acctSelect"));
							}							
							$("#acctSelect").find("option[value="+accountInfo.acctId+"]").attr("selected","selected");							
						});
						$("#defineNewAcct").hide();
					} 
					else{
						_whetherCreateAcct();
					}
				}
				else{
					$.alert("提示", "客户的帐户定位失败，请联系管理员，若要办理新装业务请稍后再试或者新建帐户。错误细节："+returnMap.resultMsg);	
				}				
			} 
			else{
				$.alert("提示",response.data);
			}
		}
	};
	
	//判断是否已新增过帐户，酌情新建或者切换帐户展示 
	var _whetherCreateAcct = function() {		
		var alreadyCreateAcct = false;
		if($("#acctSelect option").size()>0){
			$.each($("#acctSelect option"), function(i, option){
				if($(option).val()==-1){
					alreadyCreateAcct = true;
					return false;
				}
			});
			if(!alreadyCreateAcct){
				order.main.createAcct();
			}
			else{
				$("#acctSelect").find("option[value=-1]").attr("selected","selected");
				$("#defineNewAcct").show();
			}
		}
		else{
			order.main.createAcct();
		}
	};
		
	var _custTransfer = function(callParam) {
		var param = callParam;		
		param.custName=OrderInfo.cust.custName;
		param.custId=OrderInfo.cust.custId;
		param.accessNumber=order.prodModify.choosedProdInfo.accNbr;
		$.callServiceAsHtml(contextPath + "/order/prodModify/custTransfer", param, {		
			"done" : function(response){				
				$("#order_fill_content").html(response.data).show();
				$(".h2_title").append(order.prodModify.choosedProdInfo.productName+"-"+order.prodModify.choosedProdInfo.accNbr);
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				_initDic();
				_form_custTransfer_btn();
			}
		});
	};
	//定位客户证件类型下拉框
	var _initDic = function(){
		var param = {"attrSpecCode":"PTY-0004"} ;
		$.callServiceAsJson(contextPath+"/staffMgr/getCTGMainData",param,{
			"done" : function(response){
				if(response.code==0){
					var data = response.data ;
					if(data!=undefined && data.length>0){
						for(var i=0;i<data.length;i++){
							var busiStatus = data[i];
							$("#p_cust_tra_identityCd").append("<option value='"+busiStatus.attrValueCode+"' >"+busiStatus.attrValueName+"</option>");
							
						}
					}
				}else if(response.code==-2){
					$.alertM(response.data);
					return;
				}else{
					$.alert("提示","调用主数据接口失败！");
					return;
				}
			}
		});
	};
	//客户类型关联证件类型下拉框
	var _certTypeByPartyType = function(_partyTypeCd){
		var params = {"partyTypeCd":_partyTypeCd} ;
		var url=contextPath+"/cust/queryCertType";
		var response = $.callServiceAsJson(url, params, {});
       if (response.code == -2) {
					$.alertM(response.data);
				}
	   if (response.code == 1002) {
					$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");
					return;
				}
	   if(response.code==0){
					var data = response.data ;
					if(data!=undefined && data.length>0){
						for(var i=0;i<data.length;i++){
							var certTypedate = data[i];
							$("#div_tra_identidiesTypeCd").append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>");
							
						}
					}
				}
	};

	return {
		showCustTransfer : _showCustTransfer,
		custTransfer : _custTransfer,
		showCustCreate :_showCustCreate,
		custTransfer_Submit :_custTransfer_Submit,
		jumpAuth:_jumpAuth,
		partyTypeCdChoose :_partyTypeCdChoose,
		identidiesTypeCdChoose :_identidiesTypeCdChoose,
		showCustTransferReturn :_showCustTransferReturn,
		showCustAuth :_showCustAuth
	};
})();
/**
 * uim卡管理
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("prod","uim");

prod.uim = (function() {
	
	//uim卡号校验
	var _checkUim = function(prodId){
		var phoneNumber = OrderInfo.getAccessNumber(prodId);
		var offerId = "-1"; //新装默认，主销售品ID
		if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){ //新装需要选号
			if(phoneNumber==''){
				$.alert("提示","校验UIM卡前请先选号!");
				return false;
			}
		}
		if(OrderInfo.actionFlag==3 || OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23 || OrderInfo.actionFlag==6 ){ //可选包变更，补换卡，加装副卡
			if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//判断是否是纳入老用户
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.prodInstId==prodId){
						offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
					}
				});
			}else{
				offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
			}
		}
		var selUimType = $("#selUimType").val();
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}
		var inParam = {
			"instCode" : cardNo,
			"selUimType":selUimType,
			"phoneNum" : phoneNumber,
			"serialNumberCode":$.trim($("#uim_txt_"+prodId).val()),
			"areaId"   : OrderInfo.getProdAreaId(prodId)
		};

		var prodSpecId = OrderInfo.getProdSpecId(prodId);
		var mktResCd="";
		if(CONST.getAppDesc()==0){
			if(getIsMIFICheck(prodId)){
				mktResCd =getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID);
			}else{
				mktResCd = getMktResCd(prodSpecId);
			}
			if(ec.util.isObj(mktResCd)){
//				inParam.mktResCd = mktResCd;
			}else{
				$.alert("提示","查询卡类型失败！");
				return;
			}
			if(OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23){ //补换卡和异地补换卡
				if(prod.changeUim.is4GProdInst){ //如果已办理4G业务，则校验uim卡是否是4G卡
					inParam.onlyLTE = "1";
				}
			}
		}
		var data = query.prod.checkUim(inParam);//校验uim卡
	
		if(data==undefined || data.baseInfo==undefined){
			return false;
		}
		else
		{
			var uimData = {
					prodId :  prodId, //产品ID
					isWireBusi : "",
					isWireUIM : false, //判断是否为无线上网卡
					wireType : 0, //1-普通上网卡 2-全球上网卡 0-默认
					uimCode  : data.baseInfo.mktResInstCode,
					uimName  : data.baseInfo.mktResName
			};
			$.each(data.attrList, function() {
				if (this.attrId == '60020007') {
					uimData.isWireUIM = true;
					uimData.wireType = this.attrValue;
					return false;
				}
			});
			if(uimData.isWireUIM){
				if (prodSpecId == CONST.PROD_SPEC.CDMA) {
					uimData.isWireBusi = 1; // 上网卡 - 移动电话业务
				}
			}else{
				if(prodSpecId == CONST.PROD_SPEC.DATA_CARD){
					uimData.isWireBusi = 2; // 普通卡 - 无线业务
				}
			}
			OrderInfo.clearCheckUimData(prodId);
			OrderInfo.checkUimData.push(uimData);
		}
		//根据uim返回数据组织物品节点
		var couponNum = data.baseInfo.qty ;
		if(couponNum==undefined||couponNum==null){
			couponNum = 1 ;
		}
		var coupon = {
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "1",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId : data.baseInfo.mktResId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : "3000", //物品费用项类型
			couponNum : couponNum, //物品数量
			storeId : data.baseInfo.mktResStoreId, //仓库ID
			storeName : "1", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : data.baseInfo.mktResInstCode, //物品实例编码
			terminalCode : data.baseInfo.mktResInstCode,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId :  prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "ADD", //动作
			relaSeq : "" //关联序列	
		};
		if(CONST.getAppDesc()==0){
			coupon.cardTypeFlag=data.baseInfo.cardTypeFlag;//UIM卡类型
		}
		$("#uim_check_btn_"+prodId).attr("disabled",true);
		$("#uim_check_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
		$("#uim_release_btn_"+prodId).attr("disabled",false);
		$("#uim_release_btn_"+prodId).removeClass("disablepurchase").addClass("purchase");
		$("#uim_txt_"+prodId).attr("disabled",true);
		if(getIsMIFICheck(prodId)){//判断是否通过MIFI 校验
			$("#isMIFI_"+prodId).val("yes");
		}else{
			$("#isMIFI_"+prodId).val("no");
		}
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
		if(OrderInfo.actionFlag==22 && data.baseInfo.cardTypeFlag==1 && order.prodModify.choosedProdInfo.productId != '280000000'){
		//	_queryAttachOffer();
		  AttachOffer.queryCardAttachOffer(data.baseInfo.cardTypeFlag);  //加载附属销售品
	    }
		// 办理上网卡套餐，UIM校验当卡为全球上网卡自动带出天翼宽带-国际及港澳台数据漫游
		if (OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 14) {
			if (uimData.isWireUIM && uimData.wireType == '02'
					&& prodSpecId == CONST.PROD_SPEC.DATA_CARD) {
				// AttachOffer.openServSpec(prodId,13409441,'天翼宽带-国际及港澳台数据漫游','N');
				AttachOffer.addOpenServList(prodId,
						CONST.PROD_SPEC_ID.WIRE_GLOBAL, '天翼宽带-国际及港澳台数据漫游', 'N');
				var $li = $("#li_" + prodId + "_"
						+ CONST.PROD_SPEC_ID.WIRE_GLOBAL);
				if ($li.length > 0) {
					$li.find("dd").removeClass("delete").addClass("mustchoose")
							.attr("onclick", '');
				}
			}
		}
	};
	
	/*
	 * 是否是MIFI卡类型校验
	 */
	var getIsMIFICheck=function(prodId){
		var prodIdTmp=(Math.abs(prodId)-1);
		if(AttachOffer.openServList.length>prodIdTmp){
			var specList = AttachOffer.openServList[prodIdTmp].servSpecList;
			for (var j = 0; j < specList.length; j++) {
				var spec = specList[j];
				if(spec.isdel!="Y" && spec.isdel!="C"){
					if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID && CONST.APP_DESC==0){
						return true ; 
					}
				}
			}
		}
		return false;
	};
	
	var getMktResCd = function(prodSpecId){
		var param={
			"prodSpecId":prodSpecId
		};
		var url = contextPath+"/mktRes/uim/getMktResCd";
		$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == "0") {
			return response.data;
		}else{
			return "";
		}
	};
	
	//uim卡号释放
	var _releaseUim = function(prodId){	
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}
/*		var phoneNumber = OrderInfo.getAccessNumber(prodId);
		var inParam = {
			"oldInstCode":cardNo,
			"phoneNum":phoneNumber
		};
		var data = query.prod.releaseUim(inParam);//释放uim卡
		if(data==undefined){
			return false;
		}*/
		//释放UIM并更新门户记录
		var param = {
				numType : 2,
				numValue : cardNo
		};
		var jr = $.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);			
		if(jr.code==-2){
			$.alertM(jr.data);
			return;
		}
		if(jr.code==-1){
			$.alert("提示",jr.data);
			return;
		}
		$.alert("提示","成功释放UIM卡："+cardNo);
		if(OrderInfo.actionFlag==22){
			$('#attach').children().remove();
			AttachOffer.openServList = [];
			AttachOffer.openList = [];
	    }
		if (OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 14) {
			var prodSpecId = OrderInfo.getProdSpecId(prodId);
			var uimData = OrderInfo.getCheckUimData(prodId);
			if (uimData.isWireUIM && uimData.wireType == '02'
				&& prodSpecId == CONST.PROD_SPEC.DATA_CARD) {
				AttachOffer.closeServSpec(prodId,
						CONST.PROD_SPEC_ID.WIRE_GLOBAL, '天翼宽带-国际及港澳台数据漫游', 'N');
				var $li = $("#li_" + prodId + "_"
						+ CONST.PROD_SPEC_ID.WIRE_GLOBAL);
				if ($li.length > 0) {
					$li.find("dd").removeClass("mustchoose").addClass("delete")
							.attr("onclick","AttachOffer.closeServSpec('" + prodId
											+ "','"
											+ CONST.PROD_SPEC_ID.WIRE_GLOBAL
											+ "','天翼宽带-国际及港澳台数据漫游','N')");
				}
			}
		}
		$("#uim_check_btn_"+prodId).attr("disabled",false);
		$("#uim_check_btn_"+prodId).removeClass("disablepurchase").addClass("purchase");
		$("#uim_release_btn_"+prodId).attr("disabled",true);
		$("#uim_release_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
		$("#uim_txt_"+prodId).attr("disabled",false);
		$("#uim_txt_"+prodId).val("");
		OrderInfo.clearCheckUimData(prodId);
		OrderInfo.clearProdUim(prodId);
	};
	
	//保存旧卡
	var _setOldUim = function(offerId ,prodId,uim){
		var oldUim={
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "2",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId :uim.couponId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD, //物品费用项类型
			couponNum : 1, //物品数量
			//storeId : oldUimInfo.storeId, //仓库ID
			storeId : 1, //仓库ID
			storeName : "11", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : uim.couponInsNumber, //物品实例编码
			terminalCode : uim.couponInsNumber,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId : prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "DEL", //动作
			relaSeq : "", //关联序列
			id:0,
			isOld : "T",  //旧卡
			is4GCard : uim.is4GCard
		};
		OrderInfo.boProd2OldTds.push(oldUim);
		order.prodModify.choosedProdInfo.extCouponInstanceId = uim.extCouponInstanceId;
		order.prodModify.choosedProdInfo.corCouponInstanceId = uim.corCouponInstanceId;
	};

	//根据UIM类型，设置产品是3G还是4G，并且保存uim卡
	var _setProdUim = function(){
		OrderInfo.boProd2OldTds = []; //清空旧卡
		var flag = true;
		if(OrderInfo.actionFlag==3 || OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23){ //可选包变更，补换卡
			var prod = order.prodModify.choosedProdInfo; 
			var uim = query.prod.getTerminalInfo(prod);
			if(uim == undefined){  //查询旧卡信息失败返回
				return false;
			}
			_setOldUim(prod.prodOfferInstId,prod.prodInstId,uim); //保存旧卡信息
			if(uim.is4GCard=="Y"){
				prod.prodClass = CONST.PROD_CLASS.FOUR;
			}else{
				prod.prodClass = CONST.PROD_CLASS.THREE;
			}
		}else if(OrderInfo.actionFlag==21){
			var prod = {};
			$.each(OrderInfo.viceOfferSpec,function(){
				var prodId=this.prodId;
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==prodId){ //接入类产品
						prod.prodInstId = this.objInstId;
						prod.accNbr = this.accessNumber;
						var uim = query.prod.getTerminalInfo(prod);
						if(uim == undefined){  //查询旧卡信息失败返回
							flag = false;
							return false;
						}
						_setOldUim(this.offerId,this.objInstId,uim); //保存旧卡信息
						if(uim.is4GCard=="Y"){
							this.prodClass = CONST.PROD_CLASS.FOUR;
						}else{
							this.prodClass = CONST.PROD_CLASS.THREE;
						}
					}
				});
			});
		}else{
			var prod = {};
			$.each(OrderInfo.offer.offerMemberInfos,function(){
				if(this.objType==CONST.OBJ_TYPE.PROD){ //接入类产品
					prod.prodInstId = this.objInstId;
					prod.accNbr = this.accessNumber;
					var uim = query.prod.getTerminalInfo(prod);
					if(uim == undefined){  //查询旧卡信息失败返回
						flag = false;
						return false;
					}
					_setOldUim(this.offerId,this.objInstId,uim); //保存旧卡信息
					if(uim.is4GCard=="Y"){
						this.prodClass = CONST.PROD_CLASS.FOUR;
					}else{
						this.prodClass = CONST.PROD_CLASS.THREE;
					}
					var prodInfo = order.prodModify.choosedProdInfo; 
					if(prodInfo!=undefined && prodInfo.prodInstId==this.objInstId){
						prodInfo.prodClass = this.prodClass;
					}
				}
			});
		}
		return flag;	
	};
	
	var _getCardType=function(mktResCd,mktResId,instCode){
		var param = {
			"mktResCd": mktResCd,
			"mktResId": mktResId,
			"instCode": instCode
		};
		var url = contextPath + "/mktRes/uim/getResCardType";
		$.ecOverlay("<strong>获取获取卡类型中,请稍等...</strong>");
		var response = $.callServiceAsJson(url, param);
		$.unecOverlay();
		if (response.code == 0) {
			var result = response.data;
			if (ec.util.isObj(result) && ec.util.isObj(result[0].uimTypeFlag)) {
				return result[0].uimTypeFlag;
			} else {
				return "";
			}
		} else if (response.code == -2) {
			$.alertM(response.data);
			return "";
		} else {
			return "";
		}
	};
	return {
		getMktResCd:getMktResCd,
		checkUim				: _checkUim,
		releaseUim 				: _releaseUim,
		setProdUim				: _setProdUim,
		getCardType				: _getCardType,
		setOldUim				: _setOldUim
	};
})();
/**
 * 系统配置等通用信息查询
 * 没有任何业务逻辑
 * @author wukf
 * date 2014-07-29
 */
CommonUtils.regNamespace("query","common");

query.common = (function() {
	
	/**
	 * 查询门户层配置信息
	 * @String  configParamType 门户配置类型
	 * @callBackFun 回调函数
	 */
	var _queryApConfig = function(configParamType,callBackFun){
		var url= contextPath+"/order/queryApConf";
		var configParam={"CONFIG_PARAM_TYPE" : configParamType};
		if(typeof(callBackFun)=="function"){			
			$.callServiceAsJsonGet(url, configParam,{				
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询门户层配置信息失败,稍后重试");
					}
				}
			});
		}
	};

	return {
		queryApConfig			: _queryApConfig
	};
})();
/**
 * 产品相关查询
 * 没有任何业务逻辑
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("query","prod");

query.prod = (function() {
	
	/**
	 * 产品规格属性查询
	 * @param  offerSpecId 销售品规格ID
	 * @param  prodSpecId 产品规格ID
	 */
	var _prodSpecParamQuery = function(param){
		addParam(param);
		var url = contextPath + "/prod/prodSpecParamQuery";
		$.ecOverlay("<strong>正在查询产品规格属性中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,param);
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","产品规格属性失败,稍后重试");
			return;
		}
	};
	
	/**
	 * 产品实例属性查询
	 * @param  prodId 产品实例ID
	 * @param  acctNbr 产品接入号码
	 * @param  ifServItem 是否是功能产品
	 */
	var _prodInstParamQuery = function(param){
		addParam(param);
		var url = contextPath + "/prod/prodInstParamQuery";
		$.ecOverlay("<strong>正在查询产品实例属性中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,param);
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","产品规格属性失败,稍后重试");
			return;
		}
	};
	
	/**
	 * 产品下终端实例数据查询
	 * @param  prodId 产品实例ID
	 * @param  accNbr 产品接入号
	 * @param  areaId  受理地区
	 * @callBackFun 回调函数
	 * @service/intf.soService/queryOfferCouponById
	 */
	var _getTerminalInfo = function(prod){
		var params = {
			prodId: prod.prodInstId,
			areaId: OrderInfo.getProdAreaId(prod.prodInstId),
			acctNbr: prod.accNbr,
			isServiceOpen:"Y"
		};
		$.ecOverlay("<strong>正在查询产品下终端实例数据中,请稍后....</strong>");
		var response = $.callServiceAsJson(contextPath+"/token/pc/order/queryTerminalInfo", params, {});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if (response.code == -2) {
			$.alertM(response.data);
		}else{
			$.alert("错误提示","接口未返回号码["+params.acctNbr+"]产品原UIM卡数据，无法继续受理！");
		}
	};
	
	/**
	 * 产品下账号信息查询
	 * @param  prodId 产品实例ID
	 * @param  acctCd 账号信息
	 * @param  areaId  受理地区
	 * @callBackFun 回调函数
	 * @service/intf.soService/queryOfferCouponById
	 */
	var _queryAcct = function(param,callBackFun) {
		param.isServiceOpen="Y";
		var url= contextPath+"/token/pc/order/account";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>");
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						callBackFun(response.data);
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询账户信息失败,稍后重试");
					}
				}
			});
		}else{
			$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data.offerSpec;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询账户信息失败,稍后重试");
			}
		}
	};
	
	/**
	 * 终端串号校验
	 */
	var _checkTerminal = function(param){
		var url = contextPath+"/mktRes/terminal/checkTerminal";
		$.ecOverlay("<strong>终端校验中,请稍后....</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == -2) {
			$.alertM(response.data);
		}else if(response.data && response.data.code == 0) {
			return response.data;
		}else if( response.data.code == 1){
			$.alert("提示", response.data.message);
		}else{
			$.alert("提示","<br/>校验失败，请稍后重试！");
		}
	};
	
	//校验UIM卡
	var _checkUim=function(param){
		var url = contextPath+"/mktRes/uim/checkUim";
		$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == 0) {
			$.alert("提示","UIM卡校验成功!");
			return response.data;
		}else{
			if(typeof response == undefined){
				$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常");
			}else if (response.code == -2) {
				$.alertM(response.data);
			}else{
				var msg="";
				if(response.data!=undefined && response.data.msg!=undefined){
					msg=response.data.msg;
				}else{
					msg="卡号["+cardNo+"]预占失败";
				}
				$.alert("提示","UIM卡校验失败，可能原因:"+msg);
			}
		}
	};
	
	//释放UIM卡
	var _releaseUim = function(param){
		var url = contextPath+"/mktRes/uim/checkUim";
		$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == 0) {
			$.alert("提示","UIM卡释放成功!");
			return response.data;
		}else{
			if(typeof response == undefined){
				$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常");
			}else if (response.code == -2) {
				$.alertM(response.data);
			}else{
				var msg="";
				if(response.data!=undefined && response.data.msg!=undefined){
					msg=response.data.msg;
				}else{
					msg="卡号["+cardNo+"]预占失败";
				}
				$.alert("提示","UIM卡释放失败，可能原因:"+msg);
			}
		}
	};
	
	var _getOldUim = function(){
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		var oldUimInfo = _getTerminalInfo(prodInfo);
		if(oldUimInfo==undefined){
			return;
		}
		var oldUimdata={
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "2",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId :oldUimInfo.couponId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : "3000", //物品费用项类型
			couponNum : 1, //物品数量
			//storeId : oldUimInfo.storeId, //仓库ID
			storeId : 1, //仓库ID
			storeName : "11", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : oldUimInfo.couponInsNumber, //物品实例编码
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId :prodInfo.prodInstId, //产品ID
			offerId : prodInfo.prodOfferInstId, //销售品实例ID
			state : "DEL", //动作
			relaSeq : "", //关联序列
			id:0,
			isOld : "T"  //旧卡
		};
		return oldUimdata;
	};
	
	//检查是否是4G产品实例（是否已开通4G功能产品）
	var _checkIs4GProdInst = function(prodInfo){
		var param = {
			    prodId : prodInfo.prodInstId,
			    prodSpecId : prodInfo.productId,
			    offerSpecId : prodInfo.prodOfferId,
			    acctNbr : prodInfo.accNbr
		};
		var data = query.offer.queryOpenedAttachAndServ(param);
		if(data && data.result && data.result.servLists){
			var is4G = false;
			$.each(data.result.servLists,function(){//遍历是否有开通4G上网功能
				if(this.servSpecId == CONST.PROD_SPEC.PROD_FUN_4G){ //开通4G功能产品
					is4G = true; //已开通4G上网功能产品
				}
			});
			return is4G;
		} 
		return false;
	};
	
	//补充查询基本条件
	var addParam = function(param){
		param.staffId = OrderInfo.staff.staffId;
		param.channelId = OrderInfo.staff.channelId;
		param.partyId = OrderInfo.cust.custId;
		param.areaId = OrderInfo.getProdAreaId(param.prodId);
		param.distributorId = OrderInfo.staff.distributorId;
		if(OrderInfo.order.soNbr!=undefined && OrderInfo.order.soNbr != ""){  //缓存流水号
			param.soNbr = OrderInfo.order.soNbr;
		}
	};
	
	return {
		checkUim				: _checkUim,
		releaseUim 				: _releaseUim,
		getTerminalInfo 		: _getTerminalInfo,
		prodSpecParamQuery		: _prodSpecParamQuery,
		prodInstParamQuery		: _prodInstParamQuery,
		getOldUim 				: _getOldUim,
		queryAcct				: _queryAcct,
		checkTerminal			: _checkTerminal,
		checkIs4GProdInst		: _checkIs4GProdInst
	};
})();
/**
 * 规则
 */
CommonUtils.regNamespace("rule", "rule");

rule.rule = (function(){

	
	var checkFlag = false;
	var checkObj = {};
	var _callBackStr = "";
	var _callBackParam = {};
	
	var _init = function() {
		$("#ruleBody").html("");
		$("#ruleclose").click(function(){
			_closeRuleDiv();
		});
		//授信
		$("#credit").click(function(){
			_credit();
		});
		$("#closedialog").click(function(){
			_cancel();
		});
	};
	/**
	 * 受理准备调用规则
	 * param : {
	 * 		
	 *  	ruleParam : {
	 *  		boActionTypeCd : 'S1', //动作类型
	 *  		instId : '1200001', //实例ID
	 *  		specId : '1201201', //产品（销售品）规格ID
	 *  		custId : '345903434', //客户ID
	 *  		areaId : '899990',//地区ID
	 *  	}
	 *  	
	 * }
	 */
	var _prepare = function(param,callBackStr,callBackParam){
		_init();
		_callBackStr = callBackStr;
		_callBackParam = callBackParam;
		if(!query.offer.loadInst()){  //加载实例到缓存
			return;
		};
		var inParam ={
			prodInfo : order.prodModify.choosedProdInfo,
			areaId : param.areaId,
			staffId : param.staffId,
			channelId : param.channelId,
			custId : param.custId,
			boInfos : param.boInfos,
			soNbr : OrderInfo.order.soNbr
		};
		$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");
		var response = $.callServiceAsJson(contextPath+"/rule/prepare",inParam); //调用规则校验
		$.unecOverlay();
		var checkData = response.data;
		if(response.code==0){
			if(checkData == null){
				$.alert("提示","规则校验异常，请联系管理人员！");
				return;
			}
		}else{
			$.alertM(response.data);
			return;
		}
		
		if(checkData.ruleType == "portal"){
			if (checkData.resultCode == "0"){
				$.alert("提示",checkData.resultMsg);
				return true;
			}
		}		
		if (checkData.result && checkData.result.resultInfo) {
			var checkRuleInfo = checkData.result.resultInfo;
			if (checkRuleInfo != null && checkRuleInfo.length > 0) {
				$.each(checkRuleInfo, function(i, ruleInfo) {
					$("<tr>" +
							"<td>"+ruleInfo.resultCode+"</td>" +
							"<td>"+ruleInfo.ruleDesc+"</td>" +
							"<td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td>" +
							"<td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td>" +
					"</tr>").appendTo($("#ruleBody"));
				});
				easyDialog.open({
					container : 'ruleDiv'
				});
			} else {
				_credit();	
				SoOrder.initFillPage();		
			}
		} else {
			_credit();
			SoOrder.initFillPage();	
		}
		if (checkData.resultCode != 0) {
			$("#ruleSubmit").hide();
		} else {
			checkObj = param;
			checkFlag = true;
		}
	};
	
	var _getRuleImgClass = function(ruleLevel) {
		if (ruleLevel < 4) {
			return "correct";
		} else {
			return "error";
		}
	};
	
	var _getRuleLevelName = function(ruleLevel) {
		if (ruleLevel == 0) {
			return "提示级";
		} else if (ruleLevel == 1) {
			return "中级";
		} else if (ruleLevel == 2) {
			return "高级";
		} else if (ruleLevel == 3) {
			return "特技";
		} else if (ruleLevel == 4) {
			return "限制级";
		}
	};
	
	var _prepareCallBack = function(response) {
		var content$ = $("#ruleDiv");
		content$.html(response.data).show();
	};
	
	
	/**
	 * 规则页面点击确定按钮
	 */
	var _submit = function() {
		if (!checkFlag) {
			return;
		}
		$.callServiceAsHtml(contextPath+checkObj.uri, checkObj.param, checkObj.callObj);
		easyDialog.close();
	};
	
	/**
	 * 关闭规则窗口
	 */
	var _closeRuleDiv = function() {
		if (!$("#ruleDiv").is(":hidden")) {
			easyDialog.close();
		}
	};
	
	var _cancel = function() {
		//TODO may do other things;
		if (!$("#ruleDiv").is(":hidden")) {
			easyDialog.close();
		}
	};
	
	var _showRuleDiv = function(ruleInfo) {
		
	};
	
	var _credit = function() {
		eval(_callBackStr + "("+JSON.stringify(_callBackParam) + ")");
		_closeRuleDiv();
	};
	
	//生成订单流水号，加载实例到缓存,规则校验
	var _ruleCheck = function(boInfos){
		_init();
		if(!query.offer.loadInst()){  //生成订单流水号，加载实例到缓存，如果失败
			return false;
		};
		if(boInfos==undefined){  //没有传，表示不做业务规则校验
			return true;
		}
		var inParam ={
			areaId : OrderInfo.staff.soAreaId,
			staffId : OrderInfo.staff.staffId,
			channelId : OrderInfo.staff.channelId,
			custId : OrderInfo.cust.custId,
			soNbr : OrderInfo.order.soNbr,
			boInfos : boInfos,
			prodInfo : order.prodModify.choosedProdInfo	
		};
		$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");
		var response = $.callServiceAsJson(contextPath+"/rule/prepare",inParam); //调用规则校验
		$.unecOverlay();
		if(response!=undefined && response.code==0){
			var checkData = response.data;
			if(checkData.result.resultInfo!=undefined && checkData.result.resultInfo.length > 0){
				var ruleDesc = "";
				$.each(checkData.result.resultInfo, function(){
					ruleDesc += this.ruleDesc+"<br/>";
				});
				$.alert("提示",ruleDesc);
				return false;
			}
			
			if(checkData == null){
				$.alert("提示","规则校验异常，请联系管理人员！");
				return false;
			}
			if(checkData.ruleType == "portal"){  //门户层校验
				if (checkData.resultCode == "0"){  // 0为门户层校验为通过
					$.alert("提示",checkData.resultMsg);
					return false;
				}
			}		
			var checkRuleInfo = checkData.result.resultInfo;  //业务规则校验
			if(checkRuleInfo!=undefined && checkRuleInfo.length > 0){
				$.each(checkRuleInfo, function(i, ruleInfo) {
					$("<tr><td>"+ruleInfo.resultCode+"</td>" +
							"<td>"+ruleInfo.ruleDesc+"</td>" +
							"<td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td>" +
							"<td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td>" +
					"</tr>").appendTo($("#ruleBody"));
				});
				easyDialog.open({
					container : 'ruleDiv'
				});
				return false;
			}else {
				return true;
			}
		}else{
			$.alertM(response.data);
			return;
		}
	};
	
	return {
		submit 			: _submit,
		prepare 		: _prepare,
		showRuleDiv 	: _showRuleDiv,
		ruleCheck		: _ruleCheck,
		init			: _init,
		getRuleLevelName: _getRuleLevelName,
		getRuleImgClass : _getRuleImgClass
	};
})();
$(function(){

});

