CommonUtils.regNamespace("order","writeCard");var ty_plugin=null;var g_realWriteCard=true;if($.browser.msie){try{ty_plugin=new ActiveXObject("HBW0001.HBW0001Ctrl.1")}catch(e){}}order.writeCard=(function(){var d={busiComponentCode:"",session:{staffId:"",staffSerial:"",staffAreaId:"",staffAreaName:"",staffName:"",staffNumber:"",channelId:"",channelName:""},renderTo:"",params:{switchId:"",phoneNumber:"",lanId:"",dstOrgId:"",dstSysId:"",scene:"",terminalCode:""},config:{rscAreaId:"",cardAreaId:"",isUnLoad:true}};var g=false;var j=false;var m="";var b="N";var o=[];var i=null;var k={iccid:"",imsi:"",imsig:"",data:"",dataLength:"0",state:"N",prodId:""};this._cardDllInfoJson={dllId:"",dllName:"","":"",password:"",factoryCode:""};var p={serialNumber:"",factoryCode:"",cardTypeId:"",cardName:"",materialId:"",canWrite:"N"};var f;var l=function(r){var q=OrderInfo.getAccessNumber(r);if(q==""){$.alert("提示","请选择号码!","confirmation");return}ec.form.dialog.createDialog({id:"-card"+r,width:350,initCallBack:function(){$("#write_card_phone_number"+r).val(q);f=document.getElementById("ocx"+r);$("#btnReadCard"+r).click(function(){$("#btnReadCard"+r).attr("disabled","disabled");if(!order.writeCard.readCard(r)){$("#serialNum"+r).val("");$("#cardTypeId"+r).val("")}else{$.alert("提示","成功读卡!","confirmation")}$("#btnReadCard"+r).removeAttr("disabled")});$("#btnWriteCard"+r).click(function(){$("#btnWriteCard"+r).attr("disabled","disabled");var s=order.writeCard.writeCard(r);if(!s){return}$("#btnWriteCard"+r).removeAttr("disabled");if(s){$.modal.close()}})},submitCallBack:function(t,s){}})};var a=function(s){g=true;if(!g_realWriteCard){var q=new Date();k.imsi="1111111111111"+q.getMilliseconds();k.iccid="82300074073120061092";if(k.iccid.length==20){k.iccid=k.iccid.substr(0,k.iccid.length-1)}$("#serialNum"+s).val(k.iccid);return true}var u=null;try{u=ec.util.defaultStr(f.strGetICCID())}catch(v){$.alert("提示","加载读卡插件失败,请检查是否已正确安装插件!错误信息："+v.message,"error");return false}var r=u.substring(u.length-4,u.length);if(r==""){$.alert("提示","读取卡失败!请确认卡连接是否正常!");return false}if(r!=""&&r!="FFFF"){$.alert("提示","卡片已有数据,不能重复写入!");return false}var w=u;var t="";var z=ec.util.defaultStr(f.GetEmptyCardFile());var x=z.substring(z.length-5,z.length);if(x!=""&&x!="FFFF"){t=z.substring(0,z.length-2);factoryCode=z.substring(z.length-2,z.length)}if(ec.util.defaultStr(t)!=""&&t.length==20){p.serialNumber=t;p.factoryCode=factoryCode;p.cardTypeId=t.substr(5,5)}if(w=="FFFFFFFFFFFFFFFFFFFF"||w=="00000000000000000000"){p.canWrite="Y";$("#btnWriteCard"+s).css("display","");$("#serialNum"+s).val(p.serialNumber);$("#iccid"+s).val(k.iccid);$("#imsi"+s).val(k.imsi);$("#cardTypeId"+s).val(p.cardTypeId)}else{p.canWrite="N";if(d.params.scene=="1"){$("#btnWriteCard"+s).css("display","none")}if(t!=null){$("#serialNum"+s).val(p.serialNumber);$("#cardTypeId"+s).val(p.cardTypeId)}else{var y=w.substring(0,19);$("#serialNum"+s).val(y)}}return true};var c=function(y){j=false;if(!g_realWriteCard){j=true;$.alert("提示","写卡成功!","confirmation");$("#uim_txt_"+y).val(k.iccid);var s={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:"10",couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:"1",storeId:"8230010",storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:"8230007407312006106",ruleId:"",partyId:OrderInfo.cust.custId,prodId:y,state:"ADD",relaSeq:""};if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){s.offerId="-1"}else{s.offerId=order.prodModify.choosedProdInfo.prodOfferInstId}OrderInfo.clearProdUim(y);OrderInfo.boProd2Tds.push(s);return true}if(!g){$.alert("提示","请先读卡!","error");return false}if(!a()){$.alert("提示","写卡前验证读卡验证时读卡失败，请确认设备是否连接好!","error");return false}var C=$("#pesn").val();if(C!=undefined&&C!=""&&C!=null){cardType=p.serialNumber.substr(6,2);if(cardType!="10"){$.alert("提示","黑莓手机终端配套的手机卡必须是支持EVDO的CG双模卡，请换支持EVDO的CG双模卡进行写卡!","error");return false}}if(!n()){return false}var t=f.DisConnectReader();if(t!="0"){$.alert("提示","写卡之前,断开写卡器失败!","error");return false}var z=f.GetRandNum();if(z.length!=16){$.alert("提示","写卡异常:获取随机数失败！"+result,"error");return false}var B=z;if(B.length!=16){$.alert("提示","写卡异常:从卡商组件获取随机数不是8字节长的随机数！","error");return false}if(_cardDllInfoJson.dllPassword==""){$.alert("提示","写卡异常(组件鉴权密码不可为空)，请检查！","error");return false}var q=null;serviceName=contextPath+"/mktRes/writeCard/authCode";try{var u={randomNum:B,dllPassword:_cardDllInfoJson.password,factoryCode:_cardDllInfoJson.factoryCode,authCodeType:_cardDllInfoJson.authcodeType};var x=$.callServiceAsJson(serviceName,u);var w;if(x.code==0){w=x.data}else{$.alertM(x.data);return false}var r=w.code;if(r!=null&&r=="POR-0000"){q=w.authCode}else{$.alert("提示","用获取的随机数生成鉴权码失败！","error");return false}}catch(A){$.alert("提示","用获取的随机数生成鉴权码异常!"+A.message,"error");return false}var v=f.Authentication(q);var D=v;if(D!="0"){$.alert("提示","鉴权失败！"+v,"error");return false}if(!_applyResourceData(y)){return false}j=true;var E=f.YXPersonalize(q,"",1,k.data,"");if(E!="0"){$.alert("提示","写卡失败，请将白卡取出！错误编码="+E,"error");_completeWriteCard("1",E);return false}else{if(_completeWriteCard("00000000",E)){$.alert("提示","恭喜，您已经成功写卡！");return true}else{$.alert("提示","写卡成功，但卡资源下发异常","error");return false}}return false};var n=function(){_cardDllInfoJson={authcodeType:"",dllId:"",dllName:"",dllVersion:"",password:"",factoryCode:""};var s=p.serialNumber;if(s!=undefined&&s.length==20){var r=p.factoryCode;if(!_getCardDllInfo(r)){alert("提示","不能把厂商写卡组件下载到本机客户端!","error");return false}var q=_updateOrLoadDll();if(!q){return false}return true}else{$.alert("提示","卡序列号值(serialNum="+s+")不符合规范!","error");return false}};var h=function(z){if(confirm("请你确定，你是否有权限进行清除卡数据操作！！")){if(!a(z)){$.alert("提示","清卡前验证读卡验证时读卡失败，请确认设备是否连接好","error");return false}if(!n(z)){return false}var A=i.TyJsRps_CheckData();var y=A.substring(A.length-4,A.length);if(y!="0000"){$.alert("提示","卡片合法性检测失败，请检查卡是否正确插入写卡设备中！","error");return false}var v=A.substr(0,1);if(v!=0){$.alert("提示","您插入的是成品卡，可以进行清卡操作！","error")}else{$.alert("提示","您插入的不是成品卡，不可以进行清卡操作！","error");return false}var A=i.TyJsRps_GetRandNum();var y=A.substring(A.length-4,A.length);if(y!="0000"){$.alert("提示","获取随机数失败！","error");return false}randomNum=A.substring(0,A.length-5);if(randomNum.length!=16){$.alert("提示","从卡商组件获取随机数不是8字节长的随机数！","error");return false}var q=null;var r=new bss.serviceframework.ajax.client({timeout:40000,timeoutHandle:function(){$.alert("提示","超时","error");return false}});var w="bss.writeCard.writeCardFacade.getAuthCode";var r=new bss.serviceframework.ajax.client({timeout:40000,timeoutHandle:function(){$.alert("提示","超时","error");return false}});try{var t=r.callServiceAsJson(w,{randomNum:randomNum,dllInfo:_cardDllInfoJson});var s=t.getBodyAsJson();var x=s.flag;if(x!=null&&x=="0"){q=s.authCode}else{$.alert("提示","利用组件鉴权密码对随机数进行3DES加密失败！","error")}}catch(u){$.alert("提示","请求组件鉴权密码对随机数进行3DES加密失败!","error");return false}var A=i.TyJsRps_ClearCard(q);var y=A.substring(A.length-4,A.length);if(y!="0000"){alert("清除卡数据失败！");return false}else{alert("除卡数据成功！")}var A=i.TyJsRps_CheckData();var y=A.substring(A.length-4,A.length);if(y!="0000"){$.alert("提示","卡片合法性检测失败，请检查卡是否正确插入写卡设备中！","error");return false}var v=A.substr(0,1);if(v==0){}_unloadDll(z);return true}};_getCardDllInfo=function(t,s){_cardDllInfoJson=null;try{if(t!=undefined){var r=contextPath+"/mktRes/writeCard/cardDllInfo";var w={factoryCode:t};var v;var q=$.callServiceAsJson(r,w);if(q.code==0){v=q.data.cardDllInfo}else{$.alertM(q.data);return false}var x=v.dllId;if(x==undefined||x==null||x==""){$.alert("提示","卡商(编码="+t+")获取不到对应的组件信息！","error");return false}_cardDllInfoJson=v;return true}else{$.alert("提示","卡商编码值不可为空！","error");return false}}catch(u){$.alert("提示","获取卡商组件信息时异常!"+u.message,"error");return false}};_updateOrLoadDll=function(){var s=new ActiveXObject("Scripting.FileSystemObject");try{s.GetFile("C:\\WINDOWS\\system32\\"+_cardDllInfoJson.dllName+".DLL")}catch(t){$.alert("提示","您插入白卡的卡商写卡组件不存在，请将组件下载保存到C:\\WINDOWS\\system32 目录下！","error");var r=contextPath+"/card/"+_cardDllInfoJson.dllName+".DLL";
location.href=r;return false}var u=f.TransferDll(_cardDllInfoJson.dllName+".DLL");if(u!="0"){$.alert("提示","您插入白卡的卡商写卡组件不存在，请将组件下载保存到C:\\WINDOWS\\system32 目录下！","error");var r=contextPath+"/card/"+_cardDllInfoJson.dllName+".DLL";location.href=r;return false}var q=f.GetDllVersion();return true};_applyResourceData=function(t){k={iccid:"",imsi:"",data:"",dataLength:"0",state:"N",prodId:""};var w=contextPath+"/mktRes/writeCard/cardInfo";try{var u=OrderInfo.getAreaCode(t);if(u==undefined||u==""){u=OrderInfo.staff.areaCode}var r={factoryCode:_cardDllInfoJson.factoryCode,authCodeType:_cardDllInfoJson.authCodeType,hmUimid:"",cardNo:p.cardTypeId,phoneNumber:OrderInfo.getAccessNumber(t),areaId:OrderInfo.getProdAreaId(t),areaCode:u};var y;var s=$.callServiceAsJson(w,r);if(s.code==0){y=s.data.cardInfo}else{$.alertM(s.data);return false}var x=y.flag;if(x!=undefined&&x=="0"){k={iccid:"",imsi:"",imsig:"",data:"",state:"Y",prodId:""};k.iccid=y.iccid;k.imsi=y.imsi;k.imsig=y.imsig;k.data=y.data;k.dataLength=y.dataLength;k.prodId=t;return true}else{var q=y.msg;if(q!=undefined){$.alert("提示","请求可写卡的资源数据失败:"+q,"error")}else{$.alert("提示","请求可写卡的资源数据失败","error")}return false}}catch(v){$.alert("提示","请求可写卡的资源数据异常!"+v.message,"error");return false}};_completeWriteCard=function(z,y){var v=contextPath+"/mktRes/writeCard/completeWriteCard";var x={InoutInfo:{ApplyNo:"001",InoutId:"",BillType:"2",SaleNo:"",BatchId:"",OperationType:"1100",MktResStoreId:"",ChannelId:OrderInfo.staff.channelId,AreaId:OrderInfo.getProdAreaId(k.prodId),StaffId:OrderInfo.staff.staffId},MktResInstInfos:[{MktResInstInfo:{BaseInfo:{MktResTypeCd:"",MktResId:"",MktResCd:p.cardTypeId.substr(1,p.cardTypeId.length),MktResInstCode:k.iccid,SalesPrice:"0",CostPrice:"0",Quantity:"1",Unit:"101"},AttrList:[]}}]};var r={imsi:k.imsi,iccserial:p.serialNumber,iccid:k.iccid,resultCode:z,resultMessage:"写卡器返回结果编码"+y,phoneNumber:order.prodModify.choosedProdInfo.accNbr,cardType:p.cardTypeId,eventType:"2",areaId:OrderInfo.getProdAreaId(k.prodId),srInParam:x};try{var t;var s=$.callServiceAsJson(v,r);t=s.data;var w=t.code;var q=t.message;if(w!="0"){$.alertM(s.data);return false}_backFillOrderCardInfo(t.result);return true}catch(u){$.alert("提示","调用卡资源回填到卡管系统异常！"+u.message,"error");return false}};_backFillOrderCardInfo=function(q){if(k.iccid.length==20){k.iccid=k.iccid.substr(0,k.iccid.length-1)}$("#uim_txt_"+k.prodId).val(k.iccid);var r={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:q.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:"1",storeId:q.mktStoreId,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:k.iccid,ruleId:"",partyId:OrderInfo.cust.custId,prodId:k.prodId,offerId:"",state:"ADD",relaSeq:""};if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){r.offerId="-1"}else{r.offerId=order.prodModify.choosedProdInfo.prodOfferInstId}OrderInfo.clearProdUim(prodId);OrderInfo.boProd2Tds.push(r)};return{writeReadCard:l,readCard:a,writeCard:c}})();CommonUtils.regNamespace("AttachOffer");AttachOffer=(function(){var W=[];var A=[];var V=[];var k=[];var j=[];var z=[];var O=0;var ae=function(){var aj=order.prodModify.choosedProdInfo;if(aj.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=3;if(!query.offer.setOffer()){return}if(!rule.rule.ruleCheck()){return}var ak={offerSpecId:aj.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};if(p(aj.prodOfferId)){if(!query.offer.queryMainOfferSpec(ak)){return}}else{OrderInfo.offerSpec={}}if(CONST.getAppDesc()==0){if(!prod.uim.setProdUim()){return}}SoOrder.initFillPage();AttachOffer.queryAttachOffer();order.dealer.initDealer()};var t=function(aj){query.offer.queryAttachSpec(aj,function(ak){if(ak){$("#attach_"+aj.prodId).html(ak);b(aj.prodId);AttachOffer.changeLabel(aj.prodId,aj.prodSpecId,"");if(aj.prodId==-1&&OrderInfo.actionFlag==14){AttachOffer.addOpenList(aj.prodId,mktRes.terminal.offerSpecId)}}})};var R=function(al){var aj=CacheData.getOpenAppList(al);var ak=CacheData.getAppContent(al,aj);$.confirm("增值业务设置： ",ak[0].innerHTML,{yes:function(){$.each(aj,function(){if($("#"+al+"_"+this.objId).attr("checked")=="checked"){this.dfQty=1}else{this.dfQty=0}})},no:function(){}})};var u=function(am){for(var ak=0;ak<OrderInfo.offerSpec.offerRoles.length;ak++){var al=OrderInfo.offerSpec.offerRoles[ak];if(al.prodInsts!=undefined){for(var aj=0;aj<al.prodInsts.length;aj++){if(al.prodInsts[aj].prodInstId==am){return al.prodInsts[aj]}}}}};var b=function(ao){var am=u(ao);var ap={prodId:ao,appList:[]};AttachOffer.openAppList.push(ap);for(var al=0;al<OrderInfo.offerSpec.offerRoles.length;al++){var an=OrderInfo.offerSpec.offerRoles[al];if(an.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){for(var ak=0;ak<an.roleObjs.length;ak++){var aj=an.roleObjs[ak];if(aj.objType==CONST.OBJ_TYPE.SERV){if(am.objId==aj.parentProdId&&am.componentTypeCd.substring(0,1)==aj.componentTypeCd.substring(0,1)){ap.appList.push(aj);if(aj.servSpecId==undefined){aj.servSpecId=aj.objId}if(aj.servSpecName==undefined){aj.servSpecName=aj.objName}}}}if(ap.appList.length>0){var aq=$('<li id="li_'+ao+"_"+an.offerRoleId+'"></li>');aq.append('<dd class="mustchoose" ></dd>');aq.append("<span>"+an.offerRoleName+"</span>");aq.append('<dd id="can_'+ao+"_"+an.offerRoleId+'" class="gou2" onclick="AttachOffer.showApp('+ao+');"></dd>');$("#open_app_ul_"+ao).append(aq)}}else{if(an.prodInsts==undefined){continue}$.each(an.prodInsts,function(){if(this.prodInstId==ao){for(var au=0;au<an.roleObjs.length;au++){var ar=an.roleObjs[au];if(ar.objType==CONST.OBJ_TYPE.SERV){var ax=ar.objId;var av=$("#li_"+ao+"_"+ax);var at=CacheData.getServSpec(ao,ax);if(at!=undefined){if(ar.minQty==1){av.append('<dd class="mustchoose"></dd>')}av.append('<dd id="jue_'+ao+"_"+ax+'" class="jue2" title="'+an.offerRoleName+'"></dd>');continue}var aw=CacheData.getServBySpecId(ao,ax);if(aw!=undefined){var av=$("#li_"+ao+"_"+aw.servId);if(ar.minQty==1){av.append('<dd class="mustchoose"></dd>')}av.append('<dd id="jue_'+ao+"_"+aw.servId+'" class="jue2" title="'+an.offerRoleName+'"></dd>');continue}if(ar.dfQty>0){l(ao,ar);at=ar;if(B(at.prodSpecParams)){at.ifParams="Y"}$("#li_"+ao+"_"+ax).remove();var ay=$('<li id="li_'+ao+"_"+ax+'"></li>');if(ar.minQty==0){ay.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+ao+","+ax+",'"+at.servSpecName+"','"+at.ifParams+"')\"></dd>")}else{ay.append('<dd class="mustchoose"></dd>')}ay.append("<span>"+at.servSpecName+"</span>");if(at.ifParams=="Y"){if(CacheData.setServParam(ao,at)){ay.append('<dd id="can_'+ao+"_"+ax+'" class="canshu2" onclick="AttachOffer.showServParam('+ao+","+ax+');"></dd>')}else{ay.append('<dd id="can_'+ao+"_"+ax+'" class="canshu" onclick="AttachOffer.showServParam('+ao+","+ax+');"></dd>')}}ay.append('<dd id="jue_'+ao+"_"+ax+'" class="jue2" title="'+an.offerRoleName+'"></dd>');$("#open_serv_ul_"+ao).append(ay);at.isdel="N";P(0,ao,ax)}}}}})}}};var Z=function(am,ao,aj){var an={prodId:am,prodSpecId:aj,offerSpecIds:[ao],ifCommonUse:""};var ak=$("#search_text_"+am).val();if(ak.replace(/\ /g,"")==""){$.alert("提示","请输入查询条件！");return}an.offerSpecName=ak;var al=query.offer.searchAttachOfferSpec(an);if(al!=undefined){$("#attach_div_"+am).html(al).show()}};var Q=function(aj,ak){$("#attach_div_"+aj).hide();y(aj,ak)};var v=function(ak,al,am,aj){$("#attach_div_"+ak).hide();J(ak,al,am,aj)};var H=function(aj){$("#attach_div_"+aj).hide()};var F=function(){var aj=order.prodModify.choosedProdInfo;var ak=aj.prodInstId;var al={prodId:ak,prodSpecId:aj.productId,offerSpecId:aj.prodOfferId,acctNbr:aj.accNbr};query.offer.queryAttachOffer(al,function(am){$("#order_fill_content").html(am).show();$("#dealer").val(OrderInfo.staff.staffName).attr("staffId",OrderInfo.staff.staffId);if(B(OrderInfo.offerSpec.offerRoles)){var an=CacheData.getOfferMember(ak);$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.offerRoleId==an.offerRoleId&&an.objType==CONST.OBJ_TYPE.PROD){var ao=this;$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var aq=CacheData.getServBySpecId(ak,this.objId);
if(aq!=undefined){var ap=$("#li_"+ak+"_"+aq.servId);if(this.minQty==1){ap.append('<dd class="mustchoose"></dd>')}ap.append('<dd id="jue_'+ak+"_"+aq.servId+'" class="jue2" title="'+ao.offerRoleName+'"></dd>')}}});return false}})}AttachOffer.changeLabel(ak,aj.productId,"")})};var ag=function(am,an){var aj=$("#li_"+am+"_"+an).find("span");if(aj.attr("class")=="del"){AttachOffer.addOfferSpec(am,an)}else{var ak=CacheData.getOfferSpec(am,an);var al=CacheData.getOfferProdStr(am,ak,2);$.confirm("信息确认",al,{yes:function(){aj.addClass("del");ak.isdel="Y";a(am,ak);order.dealer.removeAttDealer(am+"_"+an);$("#terminalUl_"+am+"_"+an).remove();ak.isTerminal=0},no:function(){}})}};var L=function(ao,ak){var aj=$("#li_"+ao+"_"+ak).find("span");if(aj.attr("class")=="del"){AttachOffer.addOffer(ao,ak,aj.text())}else{var am=CacheData.getOffer(ao,ak);if(!B(am.offerMemberInfos)){var ap={prodId:ao,offerId:ak};ap.acctNbr=OrderInfo.getAccessNumber(ao);var an=query.offer.queryOfferInst(ap);if(an==undefined){return}am.offerMemberInfos=an.offerMemberInfos;am.offerSpec=an.offerSpec}var al="";if(am.offerSpec!=undefined){al=CacheData.getOfferProdStr(ao,am,1)}else{al="退订【"+aj.text()+"】可选包"}$.confirm("信息确认",al,{yes:function(){am.isdel="Y";aj.addClass("del");ac(ao,am)},no:function(){}})}};var T=function(al,am,an,ak){var aj=$("#li_"+al+"_"+am).find("span");if(aj.attr("class")=="del"){AttachOffer.openServSpec(al,am,an,ak)}else{$.confirm("信息确认","取消开通【"+aj.text()+"】功能产品",{yesdo:function(){var ao=CacheData.getServSpec(al,am);if(ao==undefined){return}aj.addClass("del");ao.isdel="Y";P(1,al,am)},no:function(){}})}};var s=function(ak,am){var al=CacheData.getServ(ak,am);var aj=$("#li_"+ak+"_"+al.servId).find("span");if(aj.attr("class")=="del"){w(ak,al)}else{$.confirm("信息确认","关闭【"+aj.text()+"】功能产品",{yesdo:function(){aj.addClass("del");al.isdel="Y"},no:function(){}})}};var J=function(ak,al,am,aj){$.confirm("信息确认","开通【"+am+"】功能产品",{yesdo:function(){var ao=CacheData.getServSpec(ak,al);if(ao==undefined){var an={objId:al,servSpecId:al,servSpecName:am,ifParams:aj,isdel:"C"};var ap={prodSpecId:al};if(aj=="Y"){var aq=query.prod.prodSpecParamQuery(ap);if(aq==undefined||aq.result==undefined){return}an.prodSpecParams=aq.result.prodSpecParams}l(ak,an);ao=an}aa(ak,ao)},no:function(){}})};var w=function(aj,ak){$.confirm("信息确认","取消关闭【"+ak.servSpecName+"】功能产品",{yesdo:function(){if(ak!=undefined){if(ak.servSpecId==""){var al=$("#li_"+aj+"_"+ak.servId).find("span");al.removeClass("del");ak.isdel="N"}else{aa(aj,ak)}}},no:function(){}})};var f=function(am,ao){var ap=ao.offerSpecId;var an={prodId:am,offerSpecId:ap,orderedOfferSpecIds:[]};var aj=CacheData.getOfferList(am);if(B(aj)){$.each(aj,function(){if(this.offerSpecId!=ap&&this.isdel!="Y"&&this.isdel!="N"){if(this.offerSpecId!=undefined){an.orderedOfferSpecIds.push(this.offerSpecId)}}})}var al=CacheData.getOfferSpecList(am);if(B(al)){$.each(al,function(){if(this.offerSpecId!=ap&&this.isdel!="Y"){if(this.offerSpecId!=undefined){an.orderedOfferSpecIds.push(this.offerSpecId)}}})}if(an.orderedOfferSpecIds.length==0){AttachOffer.addOpenList(am,ap)}else{var ak=query.offer.queryExcludeDepend(an);if(ak!=undefined){c(ak.result,am,ap,ao.offerSpecName)}}};var aa=function(an,aq,ak){var ap=aq.servSpecId;var ao={servSpecId:ap,prodId:an,orderedServSpecIds:[]};var aj=CacheData.getServSpecList(an);if(B(aj)){$.each(aj,function(){if(this.servSpecId!=ap&&this.isdel!="Y"&&this.isdel!="C"){ao.orderedServSpecIds.push(this.servSpecId)}})}var al=CacheData.getServList(an);if(B(al)){$.each(al,function(){if(this.servSpecId!=ap&&this.isdel!="Y"&&this.isdel!="C"){ao.orderedServSpecIds.push(this.servSpecId)}})}if(ao.orderedServSpecIds.length==0){AttachOffer.addOpenServList(an,ap,aq.servSpecName,aq.ifParams)}else{var am=query.offer.queryExcludeDepend(ao);if(am!=undefined){N(am.result,an,aq)}}};var m=function(al,am){var aj=o(al,am);if(aj==undefined){return}var ak=CacheData.getOfferProdStr(al,aj,0);$.confirm("信息确认",ak,{yes:function(){r(al,aj)},yesdo:function(){f(al,aj)},no:function(){}})};var d=function(al,am){var aj=o(al,am);if(aj==undefined){return}var ak=CacheData.getOfferProdStr(al,aj,0);$.confirm("信息确认",ak,{yes:function(){r(al,aj)},yesdo:function(){f(al,aj)}})};var a=function(aj,ak){$.each(ak.offerRoles,function(){$.each(this.roleObjs,function(){var am=this.objId;if($("#check_"+aj+"_"+am).attr("checked")=="checked"){var al=CacheData.getServSpec(aj,am);al.isdel="Y";var an=$("#li_"+aj+"_"+am);an.removeClass("canshu").addClass("canshu2");an.find("span").addClass("del");P(1,aj,am)}})})};var ac=function(ak,aj){$.each(aj.offerMemberInfos,function(){var an=this.objInstId;if($("#check_"+ak+"_"+an).attr("checked")=="checked"){var al=CacheData.getServ(ak,an);if(al!=undefined){return false}al.isdel="Y";var am=$("#li_"+ak+"_"+an);am.removeClass("canshu").addClass("canshu2");am.find("span").addClass("del")}})};var r=function(aj,ak){if(ak!=undefined){$.each(ak.offerRoles,function(){$.each(this.roleObjs,function(){if($("#check_"+aj+"_"+this.objId).attr("checked")=="checked"){this.selQty=1}})})}};var n=function(ak,aj){var al=$("#li_"+ak+"_"+aj).find("span").text();$.confirm("信息确认","取消退订【"+al+"】可选包",{yesdo:function(){var an=CacheData.getOffer(ak,aj);if(an!=undefined){if(an.offerSpecId==""){var am=$("#li_"+ak+"_"+an.offerId).find("span");am.removeClass("del");an.isdel="N"}else{f(ak,an)}}},no:function(){}})};var y=function(aj,al,ak){m(aj,al)};var c=function(ax,aq,av,ak){var am=ax.offerSpec.exclude;var al=ax.offerSpec.depend;var ar="";var an={excludeOffer:[],dependOffer:{dependOffers:[],offerGrpInfos:[]}};if(B(am)){for(var ap=0;ap<am.length;ap++){var aw=CacheData.getOfferList(aq);var at=true;if(aw!=undefined){for(var ao=0;ao<aw.length;ao++){if(aw[ao].isdel=="Y"){if(aw[ao].offerSpecId==am[ap].offerSpecId){at=false;break}}}}if(at){ar+="需要关闭：   "+am[ap].offerSpecName+"<br>";an.excludeOffer.push(am[ap].offerSpecId)}}}if(al!=undefined&&B(al.offerInfos)){for(var ap=0;ap<al.offerInfos.length;ap++){ar+="需要开通： "+al.offerInfos[ap].offerSpecName+"<br>";an.dependOffer.dependOffers.push(al.offerInfos[ap].offerSpecId)}}if(al!=undefined&&B(al.offerGrpInfos)){for(var ap=0;ap<al.offerGrpInfos.length;ap++){var aj=al.offerGrpInfos[ap];an.dependOffer.offerGrpInfos.push(aj);ar+="需要开通： 开通"+aj.minQty+"-"+aj.maxQty+"个以下业务:<br>";if(aj.subOfferSpecInfos!="undefined"&&aj.subOfferSpecInfos.length>0){for(var ao=0;ao<aj.subOfferSpecInfos.length;ao++){var au=aj.subOfferSpecInfos[ao];ar+='<input id="'+au.offerSpecId+'" type="checkbox" name="'+aj.grpId+'" value="'+au.offerSpecId+'">'+au.offerSpecName+"</input><br>"}}}}if(ar==""){AttachOffer.addOpenList(aq,av)}else{$.confirm("开通： "+ak,ar,{yesdo:function(){ah(aq,av,an)},no:function(){}})}};var N=function(aj,an,aq){var ap=aq.servSpecId;var ak=aj.servSpec.exclude;var al=aj.servSpec.depend;var am="";var ao={excludeServ:[],dependServ:[]};if(B(ak)){$.each(ak,function(){var au=CacheData.getServList(an);var ar=true;if(au!=undefined){for(var at=0;at<au.length;at++){if(au[at].isdel=="Y"){if(au[at].servSpecId==this.servSpecId){ar=false;break}}}}if(ar){am+="需要关闭：   "+this.servSpecName+"<br>";ao.excludeServ.push(this)}})}if(B(al)){$.each(al,function(){am+="需要开通：   "+this.servSpecName+"<br>";ao.dependServ.push(this)})}if(am==""){AttachOffer.addOpenServList(an,ap,aq.servSpecName,aq.ifParams)}else{$.confirm("开通： "+aq.servSpecName,am,{yesdo:function(){AttachOffer.addOpenServList(an,ap,aq.servSpecName,aq.ifParams);x(an,ap,ao)},no:function(){}})}};var x=function(an,ao,al){if(B(al.excludeServ)){for(var am=0;am<al.excludeServ.length;am++){var ar=al.excludeServ[am].servSpecId;var aq=CacheData.getServSpec(an,ar);if(aq!=undefined){var ap=$("#li_"+an+"_"+ar).find("span");ap.addClass("del");aq.isdel="Y"}else{var ak=CacheData.getServ(an,ar);if(ak!=undefined){var ap=$("#li_"+an+"_"+ak.servId).find("span");ap.addClass("del");ak.isdel="Y"}}}}if(B(al.dependServ)){for(var am=0;am<al.dependServ.length;am++){var aj=al.dependServ[am];AttachOffer.addOpenServList(an,aj.servSpecId,aj.servSpecName,aj.ifParams)}}};var ah=function(an,av,al){if(al.dependOffer.offerGrpInfos.length>0){for(var am=0;
am<dependOffer.offerGrpInfos.length;am++){var aj=dependOffer.offerGrpInfos[am];var aq=$("input[name="+aj.grpId+"]:checked");var ao=aq.length;if(ao>=aj.minQty&&ao<=aj.maxQty){aq.each(function(ax,aw){AttachOffer.addOpenList(an,aw.id)})}else{$.alert("错误信息","依赖组选择出错！");return}}}AttachOffer.addOpenList(an,av);if(al.excludeOffer.length>0){for(var am=0;am<al.excludeOffer.length;am++){var ak=al.excludeOffer[am];var au=CacheData.getOfferSpec(an,ak);if(au!=undefined){var ap=$("#li_"+an+"_"+ak).find("span");ap.addClass("del");au.isdel="Y"}var ar=CacheData.getOfferBySpecId(an,ak);if(ar!=undefined){var ap=$("#li_"+an+"_"+ar.offerId).find("span");ap.addClass("del");ar.isdel="Y"}}}if(al.dependOffer.dependOffers.length>0){for(var am=0;am<al.dependOffer.dependOffers.length;am++){var at=al.dependOffer.dependOffers[am];AttachOffer.addOpenList(an,at)}}};var U=function(ao,ax){var aw=CacheData.getOfferBySpecId(ao,ax);if(aw!=undefined){var at=$("#li_"+ao+"_"+aw.offerId).find("span");at.removeClass("del");aw.isdel="N";return}var ap=o(ao,ax);if(ap==undefined){return}if(ap.isdel=="C"){var av=$("#li_"+ao+"_"+ax);av.remove();var ar=$('<li id="li_'+ao+"_"+ax+'"></li>');ar.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+ao+","+ax+')"></dd>');ar.append("<span>"+ap.offerSpecName+"</span>");if(ap.ifParams){if(CacheData.setParam(ao,ap)){ar.append('<dd id="can_'+ao+"_"+ax+'" class="canshu2" onclick="AttachOffer.showParam('+ao+","+ax+');"></dd>')}else{ar.append('<dd id="can_'+ao+"_"+ax+'" class="canshu" onclick="AttachOffer.showParam('+ao+","+ax+');"></dd>')}}if(ap.ifShowTime=="Y"){ar.append('<dd class="time" id="time_'+ao+"_"+ax+'" onclick="AttachOffer.showTime('+ao+","+ax+",'"+ap.offerSpecName+"');\"></dd>")}$("#open_ul_"+ao).append(ar);ap.isdel="N"}else{if((ap.isdel=="Y")){var at=$("#li_"+ao+"_"+ax).find("span");at.removeClass("del");ap.isdel="N"}else{if((ap.isdel=="N")){var av=$("#li_"+ao+"_"+ax);av.remove();var ar=$('<li id="li_'+ao+"_"+ax+'"></li>');ar.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+ao+","+ax+')"></dd>');ar.append("<span>"+ap.offerSpecName+"</span>");if(ap.ifParams){if(CacheData.setParam(ao,ap)){ar.append('<dd id="can_'+ao+"_"+ax+'" class="canshu2" onclick="AttachOffer.showParam('+ao+","+ax+');"></dd>')}else{ar.append('<dd id="can_'+ao+"_"+ax+'" class="canshu" onclick="AttachOffer.showParam('+ao+","+ax+');"></dd>')}}if(ap.ifShowTime=="Y"){ar.append('<dd class="time" id="time_'+ao+"_"+ax+'" onclick="AttachOffer.showTime('+ao+","+ax+",'"+ap.offerSpecName+"');\"></dd>")}$("#open_ul_"+ao).append(ar)}}}if(ap!=undefined){$.each(ap.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4&&this.selQty==1){var ay="N";if(B(this.prodSpecParams)){ay="Y"}K(ao,this.objId,this.objName,ay)}})})}if(B(ap.agreementInfos)){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){var aj=ao+"_"+ap.offerSpecId;var an=$('<ul id="terminalUl_'+aj+'" class="fillin show"></ul>');var au=$('<select id="terminalSel_'+aj+'"></select>');var am=$('<li class="full"><label style="width:auto; margin:0px 10px;"><span style="color:#71AB5A;font-size:16px">'+ap.offerSpecName+"</span></label></li>");var al=$("<li><label> 可选终端规格：</label></li>");$.each(ap.agreementInfos,function(){var ay=$('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+"</option>");au.append(ay)});al.append(au).append('<label class="f_red">*</label>');var ak=$('<li><label>终端校验：</label><input id="terminalText_'+aj+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" /><a onclick="AttachOffer.checkTerminalCode('+ao+","+ap.offerSpecId+')" class="purchase" style="float:left">校验</a></li>');var aq=$("#terminalDiv_"+ao);an.append(am).append(al).append(ak).appendTo(aq);aq.show();ap.isTerminal=1}}};var ai=function(ao,at){for(var an=0;an<OrderInfo.attach2Coupons.length;an++){var ar=OrderInfo.attach2Coupons[an];if(at==ar.attachSepcId&&ao==ar.prodId){OrderInfo.attach2Coupons.splice(an,1);break}}var aj=ao+"_"+at;var au=$("#terminalSel_"+aj).val();if(au==undefined||$.trim(au)==""){$.alert("信息提示","终端规格不能为空！");return}var aq=$("#terminalText_"+aj).val();if(aq==undefined||$.trim(aq)==""){$.alert("信息提示","终端串码不能为空！");return}var al={instCode:aq,mktResId:au};var am=query.prod.checkTerminal(al);if(am==undefined){return}if(am.statusCd==CONST.MKTRES_STATUS.USABLE){$.alert("信息提示",am.message);var ap=$("#terminalSel_"+aj).find("option:selected").attr("price");var ak={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:am.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:am.mktResStoreId,storeName:"1",agentId:1,apCharge:ap/100,couponInstanceNumber:am.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:ao,offerId:-1,attachSepcId:at,state:"ADD",relaSeq:""};OrderInfo.attach2Coupons.push(ak)}else{$.alert("提示",am.message)}};var o=function(an,ao){var aj=CacheData.getOfferSpec(an,ao);if(aj==undefined){aj=query.offer.queryAttachOfferSpec(ao);if(!aj){return}aj.isdel="C";var ak=true;for(var am=0;am<AttachOffer.openList.length;am++){var al=AttachOffer.openList[am];if(al.prodId==an){ak=false;break}}if(ak){var al={prodId:an,specList:[]};AttachOffer.openList.push(al)}CacheData.getOfferSpecList(an).push(aj)}return aj};var l=function(an,ak){if(ak.servSpecId==undefined){ak.servSpecId=ak.objId}if(ak.servSpecName==undefined){ak.servSpecName=ak.objName}var aj=true;for(var am=0;am<AttachOffer.openServList.length;am++){var al=AttachOffer.openServList[am];if(al.prodId==an){aj=false;break}}if(aj){var al={prodId:an,servSpecList:[]};AttachOffer.openServList.push(al)}CacheData.getServSpecList(an).push(ak)};var K=function(al,an,aq,at){var aj=CacheData.getServBySpecId(al,an);if(aj!=undefined){$("#li_"+al+"_"+aj.servId).find("span").removeClass("del");aj.isdel="N";return}var ar=CacheData.getServSpec(al,an);if(ar==undefined){var am={objId:an,servSpecId:an,servSpecName:aq,ifParams:at,isdel:"C"};var ao={prodSpecId:an};if(at=="Y"){var ak=query.prod.prodSpecParamQuery(ao);if(ak==undefined||ak.result==undefined){return}am.prodSpecParams=ak.result.prodSpecParams}l(al,am);ar=am}if(ar.isdel=="C"){$("#li_"+al+"_"+an).remove();var ap=$('<li id="li_'+al+"_"+an+'"></li>');ap.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+al+","+an+",'"+aq+"','"+at+"')\"></dd>");ap.append("<span>"+ar.servSpecName+"</span>");if(ar.ifParams=="Y"){if(CacheData.setServParam(al,ar)){ap.append('<dd id="can_'+al+"_"+an+'" class="canshu2" onclick="AttachOffer.showServParam('+al+","+an+');"></dd>')}else{ap.append('<dd id="can_'+al+"_"+an+'" class="canshu" onclick="AttachOffer.showServParam('+al+","+an+');"></dd>')}}$("#open_serv_ul_"+al).append(ap);ar.isdel="N";P(0,al,an)}else{$("#li_"+al+"_"+an).find("span").removeClass("del");ar.isdel="N";P(0,al,an)}};var E=function(){var aj=CacheData.getParamContent(-1,OrderInfo.offerSpec,0);$.confirm("参数设置： ",aj,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(al,ak){}).ketchup({bindElement:"easyDialogYesBtn"})};var D=function(am,ar,ao){if(ao==1){var ap=CacheData.getOfferBySpecId(am,ar);if(!B(ap.offerMemberInfos)){var aj={prodId:am,offerId:ap.offerId};aj.acctNbr=OrderInfo.getAccessNumber(am);var al=query.offer.queryOfferInst(aj);if(al==undefined){return}ap.offerMemberInfos=al.offerMemberInfos;ap.offerSpec=al.offerSpec}if(!ap.isGetParam){var aj={offerTypeCd:"2",offerId:ap.offerId,offerSpecId:ap.offerSpecId};var ak=query.offer.queryOfferParam(aj);if(ak==undefined){return}else{ap.offerParamInfos=ak.offerParamInfos;ap.isGetParam=true}}var an=CacheData.getParamContent(am,ap,ao);$.confirm("参数设置： ",an,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(au,at){var av=false;$.each(ap.offerSpec.offerSpecParams,function(){var aw=CacheData.getOfferParam(am,ap.offerId,this.itemSpecId);aw.setValue=$("#"+am+"_"+this.itemSpecId).val();if(aw.value!=aw.setValue){aw.isUpdate="Y";
av=true}});if(av){$("#can_"+am+"_"+ap.offerId).removeClass("canshu").addClass("canshu2");ap.isset="Y";ap.update="Y"}else{$("#can_"+am+"_"+ap.offerId).removeClass("canshu2").addClass("canshu");ap.isset="N";ap.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var aq=CacheData.getOfferSpec(am,ar);if(aq==undefined){aq=query.offer.queryAttachOfferSpec(ar);if(!aq){return}}var an=CacheData.getParamContent(am,aq,ao);$.confirm("参数设置： ",an,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(at,au){if(!!aq.offerSpecParams){for(var az=0;az<aq.offerSpecParams.length;az++){var av=aq.offerSpecParams[az];var aD=CacheData.getSpecParam(am,ar,av.itemSpecId);aD.setValue=$("#"+am+"_"+av.itemSpecId).val()}}if(aq.offerRoles!=undefined&&aq.offerRoles.length>0){for(var az=0;az<aq.offerRoles.length;az++){var aC=aq.offerRoles[az];for(var ay=0;ay<aC.roleObjs.length;ay++){var aB=aC.roleObjs[ay];if(!!aB.prodSpecParams){for(var aw=0;aw<aB.prodSpecParams.length;aw++){var aE=aB.prodSpecParams[aw];var ax=CacheData.getProdSpecParam(am,ar,aE.itemSpecId);ax.value=$("#"+am+"_"+aE.itemSpecId).val()}}}}}$("#can_"+am+"_"+ar).removeClass("canshu").addClass("canshu2");var aA=CacheData.getOfferSpec(am,ar);aA.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var G=function(am,an,ap){if(ap==1){var aj=CacheData.getServBySpecId(am,an);var ak={prodId:aj.servId,ifServItem:"Y"};if(!aj.isGetParamSpec){ak.prodSpecId=aj.servSpecId;var aq=query.prod.prodSpecParamQuery(ak);if(aq==undefined){return}else{aj.prodSpecParams=aq.result.prodSpecParams;aj.isGetParamSpec=true}}if(!aj.isGetParamInst){var al=query.prod.prodInstParamQuery(ak);if(al==undefined){return}else{aj.prodInstParams=al.result.prodInstParams;aj.isGetParamInst=true}}var ao=CacheData.getParamContent(am,aj,3);$.confirm("参数设置： ",ao,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(au,at){var av=false;$.each(aj.prodSpecParams,function(){var aw=CacheData.getServInstParam(am,aj.servId,this.itemSpecId);aw.setValue=$("#"+am+"_"+this.itemSpecId).val();if(aw.value!=aw.setValue){aw.isUpdate="Y";av=true}});if(av){$("#can_"+am+"_"+aj.servId).removeClass("canshu").addClass("canshu2");aj.isset="Y";aj.update="Y"}else{$("#can_"+am+"_"+aj.servId).removeClass("canshu2").addClass("canshu");aj.isset="N";aj.update="N"}$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}else{var ar=CacheData.getServSpec(am,an);if(ar==undefined){return}var ao=CacheData.getParamContent(am,ar,2);$.confirm("参数设置： ",ao,{yes:function(){},no:function(){}});$("#paramForm").bind("formIsValid",function(ax,aw){if(!!ar.prodSpecParams){for(var at=0;at<ar.prodSpecParams.length;at++){var ay=ar.prodSpecParams[at];var av=CacheData.getServSpecParam(am,an,ay.itemSpecId);av.setValue=$("#"+am+"_"+ay.itemSpecId).val()}}$("#can_"+am+"_"+an).removeClass("canshu").addClass("canshu2");var au=CacheData.getServSpec(am,an);au.isset="Y";$(".ZebraDialog").remove();$(".ZebraDialogOverlay").remove()}).ketchup({bindElementByClass:"ZebraDialog_Button1"})}};var i=function(am,an,ak){var al=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(ak+"--生失效设置");var aj=CacheData.getOfferSpec(am,an);h(aj);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){I(am,an)});if(al==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var M=function(){var aj=DateUtil.Format("yyyy-MM-dd",new Date());var ak=$("#endDt").val();if(ak==""){$.calendar({minDate:aj})}else{$.calendar({minDate:aj,maxDate:ak})}};var ad=function(){var aj=$("#startDt").val();if(aj==""){aj=DateUtil.Format("yyyy-MM-dd",new Date())}$.calendar({minDate:aj})};var h=function(ak){if(ak!=undefined&&ak.ooTimes!=undefined){var aj=ak.ooTimes;$("input[name=startTimeType][value='"+aj.startType+"']").attr("checked","checked");$("input[name=endTimeType][value='"+aj.endType+"']").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("");if(aj.startType==4){$("#startDt").val(aj.startDt)}if(aj.endType==4){$("#endDt").val(aj.endDt)}else{if(aj.endType==5){$("#endTime").val(aj.effTime);$("#endTimeUnit").val(aj.effTimeUnitCd)}}}else{$("input[name=startTimeType][value=1]").attr("checked","checked");$("input[name=endTimeType][value=1]").attr("checked","checked");$("#startDt").val("");$("#endDt").val("");$("#endTime").val("")}};var S=function(){var aj=OrderInfo.getPrivilege("EFF_TIME");$("#attachName").text(OrderInfo.offerSpec.offerSpecName+"-生失效设置");h(OrderInfo.offerSpec);easyDialog.open({container:"div_time_dialog"});$("#timeSpan").off("click").on("click",function(){ab()});if(aj==0){$("#startTimeTr").show();$("#endTimeTr").show()}else{$("#startTimeTr").hide();$("#endTimeTr").hide()}};var Y=function(){$("#memberName").text(OrderInfo.offerSpec.offerSpecName+"-构成");$("#main_member_div").empty();$.each(OrderInfo.offerSpec.offerRoles,function(){var al=this;if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){var ak=$('</div><ul id="serv_ul_'+prodId+'"></ul>');var aj=$('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append(aj.append(ak));$.each(al.roleObjs,function(){var an=$('<li id="li_'+prodId+"_"+this.objId+'">'+this.objName+"</li>");var am=$('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');ak.append(am).append(an)});$("#main_member_div").append('<div class="clear"></div>')}else{$.each(al.prodInsts,function(){var ao=this.prodInstId;var an=$('</div><ul id="serv_ul_'+ao+'"></ul>');var am=$('<div id="serv_div_'+ao+'" class="fs_choosed"></div>');$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append(am.append(an));$.each(al.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.SERV){var aq=$('<li id="li_'+ao+"_"+this.objId+'">'+this.objName+"</li>");var ap=$('<input type="checkbox" name="serv_check_'+ao+'" servSpecId="'+this.objId+'"></input>');an.append(ap).append(aq)}});$("#main_member_div").append('<div class="clear"></div>')})}});easyDialog.open({container:"div_member_dialog"});$.each(OrderInfo.offerSpec.offerRoles,function(){var aj=this;$.each(aj.prodInsts,function(){var ak=this;$.each(aj.roleObjs,function(){var al=this.objId;if(this.minQty>0){$("input[name='serv_check_"+ak.prodInstId+"']").each(function(){if(al==$(this).attr("servSpecId")){$(this).attr("checked","checked");$(this).attr("disabled","disabled")}})}});if(!!ak.servInsts){$.each(ak.servInsts,function(){var al=this.objId;$("input[name='serv_check_"+ak.prodInstId+"']").each(function(){if(al==$(this).attr("servSpecId")){$(this).attr("checked","checked")}})})}})});$("#memberSpan").off("click").on("click",function(){g()})};var g=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){var aj=this;$.each(this.prodInsts,function(){var ak=this;ak.servInsts=[];$("input[name='serv_check_"+this.prodInstId+"']:checked").each(function(){var al=$(this).attr("servSpecId");$.each(aj.roleObjs,function(){if(this.objId==al){ak.servInsts.push(this)}})})})});easyDialog.close()};var X=function(){var ak={state:"ADD"};var am=$("input[name=startTimeType]:checked").attr("value");ak.startType=am;if(am==1){ak.isDefaultStart="Y"}else{if(am==2){}else{if(am==3){ak.startTime=1;ak.startTimeUnitCd=7}else{if(am==4){if($("#startDt").val()==""){$.alert("提示","指定生效时间不能为空!");return}ak.startDt=$("#startDt").val()}}}}var al=$("input[name=endTimeType]:checked").attr("value");ak.endType=al;if(al==1){ak.isDefaultEnd="Y"}else{if(al==4){if($("#endDt").val()==""){$.alert("提示","指定失效时间不能为空!");return}ak.endDt=$("#endDt").val()}else{if(al==5){var aj=$("#endTime").val();if(aj==""){$.alert("提示","有效时长不能为空!");return}if(isNaN(aj)){$.alert("提示","有效时长必须为数字!");return}if(aj<=0){$.alert("提示","有效时长必须大于0!");return}ak.effTime=aj;ak.effTimeUnitCd=$("#endTimeUnit").val()
}}}return ak};var ab=function(){var aj=X();if(aj==undefined){return}OrderInfo.offerSpec.ooTimes=aj;$("#mainTime").removeClass("time").addClass("time2");easyDialog.close()};var I=function(al,am){var aj=X();if(aj==undefined){return}var ak=CacheData.getOfferSpec(al,am);ak.ooTimes=aj;$("#time_"+al+"_"+am).removeClass("time").addClass("time2");easyDialog.close()};var C=function(aj){if($("#checkbox_"+aj).attr("checked")){AttachOffer.isChangeUim=1;$("#uimDiv_"+aj).show()}else{AttachOffer.isChangeUim=0;$("#uimDiv_"+aj).hide()}};var af=function(ap,at,aj){$.each(AttachOffer.labelList,function(){if(this.prodId==ap){$.each(this.labels,function(){if(aj==""){aj=this.label;$("#tab_"+ap+"_"+this.label).addClass("setcon")}else{if(aj==this.label){$("#tab_"+ap+"_"+this.label).addClass("setcon");$("#ul_"+ap+"_"+this.label).show()}else{$("#tab_"+ap+"_"+this.label).removeClass("setcon");$("#ul_"+ap+"_"+this.label).hide()}}})}});var ao=$("#ul_"+ap+"_"+aj);if(ao[0]==undefined){var al="3";if(ap>0){al=""}if(aj==CONST.LABEL.SERV){var ak={prodId:ap,prodSpecId:at,queryType:al,labelId:aj};var an=query.offer.queryCanBuyServ(ak);var ao=$('<ul id="ul_'+ap+"_"+aj+'"></ul>');if(an!=undefined&&an.resultCode=="0"){if(B(an.result.servSpec)){var ar=CacheData.getServList(ap);var am=CacheData.getServSpecList(ap);$.each(an.result.servSpec,function(){var aw=this.servSpecId;var av=true;$.each(ar,function(){if(this.servSpecId==aw&&this.isDel!="C"){av=false;return false}});$.each(am,function(){if(this.servSpecId==aw){av=false;return false}});if(av){var ay=$('<li id="li_'+ap+"_"+this.servSpecId+'"></li>');var ax=$('<dd class="canchoose" onclick="AttachOffer.openServSpec('+ap+","+this.servSpecId+",'"+this.servSpecName+"','"+this.ifParams+"')\"></dd>");var au=$('<span><a href="javascript:AttachOffer.openServSpec('+ap+","+this.servSpecId+",'"+this.servSpecName+"','"+this.ifParams+"')\">"+this.servSpecName+"</a></span>");ay.append(ax).append(au).appendTo(ao)}})}}$("#div_"+ap).append(ao)}else{var ak={prodSpecId:at,offerSpecIds:[],queryType:al,prodId:ap,partyId:OrderInfo.cust.custId,labelId:aj,ifCommonUse:""};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objInstId==ap){ak.acctNbr=this.accessNumber;ak.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);return false}})}else{if(OrderInfo.actionFlag==3){var aq=order.prodModify.choosedProdInfo;ak.acctNbr=aq.accNbr;if(!p(aq.prodOfferId)){aq.prodOfferId=""}ak.offerSpecIds.push(aq.prodOfferId)}else{ak.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId)}}query.offer.queryCanBuyAttachSpec(ak,function(ax){var av=$('<ul id="ul_'+ap+"_"+aj+'"></ul>');if(ax!=undefined&&ax.resultCode=="0"){if(B(ax.result.offerSpecList)){var au=CacheData.getOfferList(ap);var aw=CacheData.getOfferSpecList(ap);$.each(ax.result.offerSpecList,function(){var aC=this.offerSpecId;var az=true;$.each(au,function(){if(this.offerSpecId==aC&&this.isDel!="C"){az=false;return false}});$.each(aw,function(){if(this.offerSpecId==aC){az=false;return false}});if(az){var aB=$('<li id="li_'+ap+"_"+this.offerSpecId+'"></li>');var aA=$('<dd class="canchoose" onclick="AttachOffer.addOfferSpec('+ap+","+this.offerSpecId+')"></dd>');var ay=$('<span><a href="javascript:AttachOffer.addOfferSpec('+ap+","+this.offerSpecId+')" >'+this.offerSpecName+"</a></span>");aB.append(aA).append(ay).appendTo(av)}})}}$("#div_"+ap).append(av)})}}};var P=function(aj,al,am){if(aj==0){if(OrderInfo.actionFlag==3&&order.prodModify.choosedProdInfo.prodClass==CONST.PROD_CLASS.THREE&&am==CONST.PROD_SPEC.PROD_FUN_4G&&AttachOffer.isChangeUim==0&&CONST.getAppDesc()==0){$("#uimDiv_"+al).show();AttachOffer.isChangeUim=1}}else{if(aj==1){if(OrderInfo.actionFlag==3&&order.prodModify.choosedProdInfo.prodClass==CONST.PROD_CLASS.THREE&&am==CONST.PROD_SPEC.PROD_FUN_4G&&AttachOffer.isChangeUim==1&&CONST.getAppDesc()==0){var ak=CacheData.getServSpecList(al);var aj=true;if(ak!=undefined){$.each(ak,function(){if(this.servSpecId==CONST.PROD_SPEC.PROD_FUN_4G&&this.servSpecId!=am&&this.isdel!="Y"&&this.isdel!="C"){aj=false;return false}})}if(aj==true){$("#uimDiv_"+al).hide();AttachOffer.isChangeUim=0}}}}};var q=function(an){for(var am=0;am<AttachOffer.openList.length;am++){var al=AttachOffer.openList[am];for(var ak=0;ak<al.specList.length;ak++){var aj=al.specList[ak];if(aj.isdel!="Y"&&aj.isdel!="C"){SoOrder.createAttOffer(aj,al.prodId,0,an)}}}for(var am=0;am<AttachOffer.openedList.length;am++){var ap=AttachOffer.openedList[am];for(var ak=0;ak<ap.offerList.length;ak++){var ao=ap.offerList[ak];if(ao.isdel=="Y"){SoOrder.createAttOffer(ao,ap.prodId,1,an)}else{if(ao.update=="Y"){SoOrder.createAttOffer(ao,ap.prodId,2,an)}}}}$.each(AttachOffer.openServList,function(){var aq=this.prodId;$.each(this.servSpecList,function(){if(this.isdel!="Y"&&this.isdel!="C"&&this.isdel!="P"){SoOrder.createServ(this,aq,0,an)}})});$.each(AttachOffer.openedServList,function(){var aq=this.prodId;$.each(this.servList,function(){if(this.isdel=="Y"){SoOrder.createServ(this,aq,1,an)}else{if(this.update=="Y"){SoOrder.createServ(this,aq,2,an)}}})});$.each(AttachOffer.openAppList,function(){var aq=this.prodId;$.each(this.appList,function(){if(this.dfQty==1){SoOrder.createServ(this,aq,0,an)}})})};var p=function(ak){var aj=false;if(ak!=undefined&&$.trim(ak)!=""&&ak!=null){aj=true}return aj};var B=function(aj){if(!!aj&&aj.length>0){return true}else{return false}};return{addOffer:n,addOfferSpec:m,addOpenList:U,addOpenServList:K,addOfferSpecByCheck:d,closeAttachSearch:H,changeLabel:af,closeServ:s,closeServSpec:T,delOffer:L,delOfferSpec:ag,labelList:z,isChangeUim:O,isCheckUim:C,init:ae,openList:W,openedList:A,openServList:V,openedServList:k,openServSpec:J,openAppList:j,queryAttachOffer:F,queryAttachOfferSpec:t,showParam:D,showServParam:G,showTime:i,setAttachTime:I,searchAttachOfferSpec:Z,selectAttachOffer:Q,showOfferTime:S,showMainParam:E,showMainMember:Y,selectServ:v,showStartTime:M,showEndTime:ad,setAttachBusiOrder:q,showApp:R,showMainRoleProd:b,checkTerminalCode:ai}})();CommonUtils.regNamespace("offerChange");offerChange=(function(){var f={};var l=function(){var p=order.prodModify.choosedProdInfo;if(p.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){$.alert("提示","请选择一个在用产品");return}OrderInfo.actionFlag=2;if(!query.offer.setOffer()){return}var q=[{boActionTypeCd:CONST.BO_ACTION_TYPE.DEL_OFFER,instId:p.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:p.prodInstId},{boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER,instId:p.prodInstId,specId:CONST.PROD_SPEC.CDMA,prodId:p.prodInstId}];if(!rule.rule.ruleCheck(q)){return}$.ecOverlay("<strong>正在查询中,请稍后....</strong>");var o=$.callServiceAsHtmlGet(contextPath+"/order/prodoffer/prepare",{});$.unecOverlay();if(o.code!=0){$.alert("提示","查询失败,稍后重试");return}SoOrder.step(0,o.data);$("#search").bind("click",function(){order.service.searchPack()});order.prodOffer.init();order.service.searchPack()};var b=function(){var q=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==2){q++}});var t=1;var p=0;if(q>1){var o=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){o=false}else{if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){p++}else{o=true;return false}}}});if(o){$.alert("错误提示","目前只支持单产品或者集团集约化主副卡的套餐变更");return}t=2}if(!k(t,p)){return}if(CONST.getAppDesc()==0){if(order.prodModify.choosedProdInfo.is3G=="Y"){if(!offerChange.checkOrder()){return}}if(!prod.uim.setProdUim()){return}}var r=order.prodModify.choosedProdInfo;var s={boActionTypeCd:"S2",boActionTypeName:"套餐变更",actionFlag:"2",offerSpec:OrderInfo.offerSpec,prodId:r.prodInstId,offerMembers:OrderInfo.offer.offerMemberInfos,oldOfferSpecName:r.prodOfferName,prodClass:r.prodClass,appDesc:CONST.getAppDesc()};order.main.buildMainView(s)};var m=function(o,q){order.prepare.showOrderTitle(OrderInfo.actionTypeName,order.prodModify.choosedProdInfo.accNbr,false);SoOrder.initFillPage();$("#order_fill_content").html(o.data);$("#fillNextStep").off("click").on("click",function(){SoOrder.submitOrder()
});$("#fillLastStep").off("click").on("click",function(){order.main.lastStep()});var p=order.prodModify.choosedProdInfo;$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.prodInsts!=undefined&&this.prodInsts.length>0){$.each(this.prodInsts,function(){var s=this.prodInstId;var t={areaId:OrderInfo.getProdAreaId(s),channelId:OrderInfo.staff.channelId,staffId:OrderInfo.staff.staffId,prodId:s,prodSpecId:this.objId,offerSpecId:p.prodOfferId,acctNbr:this.accessNumber};var r=query.offer.queryChangeAttachOffer(t);$("#attach_"+s).html(r);AttachOffer.showMainRoleProd(s);AttachOffer.changeLabel(s,this.objId,"")})}});order.dealer.initDealer();if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"){offerChange.checkOfferProd()}};var i=function(o){j(o,OrderInfo.offer);n(o,OrderInfo.offer);AttachOffer.setAttachBusiOrder(o);if(CONST.getAppDesc()==0){if(!!OrderInfo.offer.offerMemberInfos){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.prodClass==CONST.PROD_CLASS.THREE&&OrderInfo.offerSpec.is3G=="N"){if(OrderInfo.boProd2Tds.length>0){var p={prodId:this.objInstId,prodSpecId:this.objId,accessNumber:this.accessNumber,isComp:"N",boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};var q=OrderInfo.getProdBusiOrder(p);if(q){o.push(q)}}}})}}};var j=function(o,q){q.offerTypeCd=1;q.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;var p=order.prodModify.choosedProdInfo;OrderInfo.getOfferBusiOrder(o,q,p.prodInstId)};var n=function(v,w){var u=order.prodModify.choosedProdInfo;var p=OrderInfo.offerSpec;var o={areaId:OrderInfo.getProdAreaId(u.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.SEQ.offerSeq--,objId:p.offerSpecId,offerTypeCd:"1",accessNumber:u.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};$.each(p.offerRoles,function(){var x=this;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){var y={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,offerRoleId:x.offerRoleId,state:"ADD"};o.data.ooRoles.push(y)})}});var t=$("#order_remark").val();if(t!=""&&t!=undefined){o.data.busiOrderAttrs=[];o.data.busiOrderAttrs.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:t})}if(p.offerSpecParams!=undefined&&p.offerSpecParams.length>0){o.data.ooParams=[];for(var s=0;s<p.offerSpecParams.length;s++){var q=p.offerSpecParams[s];var r={itemSpecId:q.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:q.offerSpecParamId,value:q.value,state:"ADD"};o.data.ooParams.push(r)}}if(p.ooTimes!=undefined){o.data.ooTimes=[];o.data.ooTimes.push(p.ooTimes)}v.push(o)};var h=function(o){$.each($("#tab_"+o).parent().find("li"),function(){$(this).removeClass("setcon");$("#attach_tab_"+$(this).attr("prodId")).hide();$("#uimDiv_"+$(this).attr("prodId")).hide()});$("#tab_"+o).addClass("setcon");$("#attach_tab_"+o).show();$("#uimDiv_"+o).show()};var d=function(p){c();var o=query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];if(o==undefined){return false}if(o.result!=undefined){offerChange.resultOffer=o.result}else{offerChange.resultOffer={}}return true};var k=function(u,s){if(u==1){var t=g();if(t==undefined){alert("错误提示","无法变更到该套餐");return false}t.prodInsts=[];$.each(t.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var v=this;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){v.prodInstId=this.objInstId;v.accessNumber=this.accessNumber;t.prodInsts.push(v)}})}})}else{var p=true;for(var r=0;r<OrderInfo.offerSpec.offerRoles.length;r++){var t=OrderInfo.offerSpec.offerRoles[r];if(t.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){p=false}else{if(t.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){for(var q=0;q<t.roleObjs.length;q++){var o=t.roleObjs[q];if(o.objType==CONST.OBJ_TYPE.PROD){if(o.maxQty<s){$.alert("信息提示","新套餐最多可以办理副卡数量为"+o.maxQty+",旧套餐为"+s+"需要拆副卡");return false}}}}}}if(p){$.alert("信息提示","旧套餐是多成员主副卡套餐，新套餐不是主副卡套餐，不能变更");return false}else{$.each(OrderInfo.offerSpec.offerRoles,function(){var v=this;v.prodInsts=[];$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var w=jQuery.extend(true,{},this);$.each(OrderInfo.offer.offerMemberInfos,function(){if(v.memberRoleCd==this.roleCd&&this.objType==CONST.OBJ_TYPE.PROD){w.prodInstId=this.objInstId;w.accessNumber=this.accessNumber;v.prodInsts.push(w)}})}})})}}return true};var g=function(){for(var q=0;q<OrderInfo.offerSpec.offerRoles.length;q++){var r=OrderInfo.offerSpec.offerRoles[q];if(r.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){return r}}for(var q=0;q<OrderInfo.offerSpec.offerRoles.length;q++){var r=OrderInfo.offerSpec.offerRoles[q];for(var p=0;p<r.roleObjs.length;p++){var o=r.roleObjs[p];if(o.objType==CONST.OBJ_TYPE.PROD){return r}}}};var c=function(){OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId;var o=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;j(o,OrderInfo.offer);n(o,OrderInfo.offer)};var a=function(){if(offerChange.resultOffer==undefined){return}var o=offerChange.resultOffer.prodInfos;if(o!=undefined&&o.length>0){$.each(o,function(){var t=this.accProdInstId;var s=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==t){s=false;return false}});if(s){return true}if(t!=this.prodInstId){var u=CacheData.getServ(t,this.prodInstId);if(this.state=="DEL"){if(u!=undefined){var r=$("#li_"+t+"_"+this.prodInstId).find("span");r.addClass("del");u.isdel="Y";$("#del_"+t+"_"+this.prodInstId).hide()}}else{if(this.state=="ADD"){if(u!=undefined){$("#del_"+t+"_"+this.prodInstId).hide()}else{var q=CacheData.getServSpec(t,this.productId);if(q!=undefined){$("#del_"+t+"_"+this.productId).hide()}else{if(this.productId!=undefined&&this.productId!=""){AttachOffer.openServSpec(t,this.productId)}}}}}}})}var p=offerChange.resultOffer.prodOfferInfos;if(p!=undefined&&p.length>0){$.each(p,function(){var t=0;if(this.memberInfo==undefined){return false}$.each(this.memberInfo,function(){if(this.objType==CONST.OBJ_TYPE.PROD){t=this.objInstId}});var r=true;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD&&this.objInstId==t){r=false;return false}});if(r){return true}var s=CacheData.getOffer(t,this.prodOfferInstId);if(this.state=="DEL"){if(s!=undefined){var q=$("#li_"+this.prodId+"_"+this.prodOfferInstId).find("span");q.addClass("del");s.isdel="Y";$("#del_"+this.prodId+"_"+this.prodOfferInstId).hide()}}else{if(this.state=="ADD"){if(s!=undefined){$("#del_"+this.prodId+"_"+this.prodOfferInstId).hide()}else{var u=CacheData.getOfferSpec(t,this.prodOfferId);if(u!=undefined){$("#del_"+this.prodId+"_"+this.prodOfferId).hide()}else{if(this.prodOfferId!=undefined&&this.prodOfferId!=""&&this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){AttachOffer.addOfferSpecByCheck(t,this.prodOfferId)}}}}}})}};return{init:l,changeOffer:i,offerChangeView:b,changeTab:h,checkOrder:d,fillOfferChange:m,resultOffer:f,checkOfferProd:a,getChangeInfo:c,setChangeOfferSpec:k}})();CommonUtils.regNamespace("query","offer");query.offer=(function(){var s=function(z,y){var x=contextPath+"/offer/queryOfferSpec";if(typeof(y)=="function"){$.callServiceAsJsonGet(x,z,{before:function(){$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>")},done:function(A){$.unecOverlay();if(A.code==0){if(A.data){y(A.data.offerSpec)}}else{if(A.code==-2){$.alertM(A.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");var w=$.callServiceAsJsonGet(x,z);$.unecOverlay();if(w.code==0){if(w.data){return w.data.offerSpec}}else{if(w.code==-2){$.alertM(w.data)}else{$.alert("提示","查询销售品规格构成失败,稍后重试")}}}};var o=function(z,y){var x=contextPath+"/offer/queryOfferInst";d(z);if(typeof(y)=="function"){$.callServiceAsJsonGet(x,z,{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")
},always:function(){$.unecOverlay()},done:function(A){$.unecOverlay();if(A.code==0){if(A.data){y(A.data)}}else{if(A.code==-2){$.alertM(A.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");var w=$.callServiceAsJsonGet(x,z);$.unecOverlay();if(w.code==0){if(w.data){return w.data}}else{if(w.code==-2){$.alertM(w.data)}else{$.alert("提示","查询销售品实例失败,稍后重试")}}}};var p=function(){var w=order.prodModify.choosedProdInfo;var A={offerId:w.prodOfferInstId,offerSpecId:w.prodOfferId,acctNbr:w.accNbr,areaId:OrderInfo.getProdAreaId(w.prodInstId),distributorId:""};var z=query.offer.queryOfferInst(A);if(z&&z.code==CONST.CODE.SUCC_CODE){var x=true;if(z.offerMemberInfos!=undefined&&z.offerMemberInfos.length>0){for(var y=0;y<z.offerMemberInfos.length;y++){var B=z.offerMemberInfos[y];if(B.objType==""){$.alert("提示","销售品实例构成 "+B.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");return false}else{if(B.objType==CONST.OBJ_TYPE.PROD){if(B.accessNumber==""){$.alert("提示","销售品实例构成 "+B.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");return false}}}if(B.objInstId==w.prodInstId){x=false}}if(x){$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+w.accNbr+"】，无法继续受理，请业务后台核实");return false}OrderInfo.offer.offerMemberInfos=z.offerMemberInfos;OrderInfo.offer.offerId=w.prodOfferInstId;OrderInfo.offer.offerSpecId=w.prodOfferId;OrderInfo.offer.offerName=w.prodOfferName;return true}else{$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");return false}}};var g=function(z,y){var x=contextPath+"/offer/queryOfferParam";if(typeof(y)=="function"){$.callServiceAsJsonGet(x,z,{before:function(){$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(A){$.unecOverlay();if(A.code==0){if(A.data){y(A.data)}}else{if(A.code==-2){$.alertM(A.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}})}else{$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");var w=$.callServiceAsJsonGet(x,z);$.unecOverlay();if(w.code==0){if(w.data){return w.data}}else{if(w.code==-2){$.alertM(w.data)}else{$.alert("提示","查询销售品实例参数失败,稍后重试")}}}};var c=function(z,y){d(z);var x=contextPath+"/offer/queryAttachOffer";if(typeof(y)=="function"){$.callServiceAsHtmlGet(x,{strParam:JSON.stringify(z)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(A){$.unecOverlay();if(A.code==0){if(A.data){y(A.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询查询附属销售品实例中，请稍等...</strong>");var w=$.callServiceAsHtmlGet(x,{strParam:JSON.stringify(z)});$.unecOverlay();if(w.code==0){if(w.data){return w.data}}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}};var v=function(z,y){d(z);var x=contextPath+"/offer/queryChangeAttachOffer";if(typeof(y)=="function"){$.callServiceAsHtmlGet(x,{strParam:JSON.stringify(z)},{before:function(){$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(A){$.unecOverlay();if(A.code==0){if(A.data){y(A.data)}}else{$.alert("提示","附属销售品实例查询失败,稍后重试");return}}})}else{$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");var w=$.callServiceAsHtmlGet(x,{strParam:JSON.stringify(z)});$.unecOverlay();if(w.code==0){if(w.data){return w.data}}else{$.alert("提示","查询附属销售品实例失败,稍后重试");return}}};var r=function(z,y){d(z);var x=contextPath+"/offer/queryAttachSpec";if(typeof(y)=="function"){$.callServiceAsHtmlGet(x,{strParam:JSON.stringify(z)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(A){if(A.code==0){if(A.data){y(A.data)}}else{if(A.code==-2){$.alertM(A.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询查询附属销售品中，请稍等...</strong>");var w=$.callServiceAsHtmlGet(x,{strParam:JSON.stringify(z)});$.unecOverlay();if(w.code==0){if(w.data){return w.data}}else{if(w.code==-2){$.alertM(w.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var l=function(z,y){d(z);var x=contextPath+"/offer/queryCanBuyAttachSpec";if(typeof(y)=="function"){$.callServiceAsJsonGet(x,{strParam:JSON.stringify(z)},{before:function(){$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>")},always:function(){$.unecOverlay()},done:function(A){if(A.code==0){if(A.data){y(A.data)}}else{if(A.code==-2){$.alertM(A.data);return}else{$.alert("提示","附属销售品查询失败,稍后重试");return}}}})}else{$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");var w=$.callServiceAsJsonGet(x,{strParam:JSON.stringify(z)});$.unecOverlay();if(w.code==0){if(w.data){return w.data}}else{if(w.code==-2){$.alertM(w.data);return}else{$.alert("提示","查询附属销售品失败,稍后重试");return}}}};var q=function(y){d(y);var x=contextPath+"/offer/queryCanBuyServ";$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");var w=$.callServiceAsJsonGet(x,y);$.unecOverlay();if(w.code==0){if(w.data){return w.data}}else{if(w.code==-2){$.alertM(w.data);return}else{$.alert("提示","可订购功能产品失败,稍后重试");return}}};var f=function(y){d(y);var x=contextPath+"/offer/queryExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var w=$.callServiceAsJsonGet(x,{strParam:JSON.stringify(y)});$.unecOverlay();if(w.code==0){return w.data}else{if(w.code==-2){$.alertM(w.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var b=function(y){d(y);var x=contextPath+"/offer/queryServExcludeDepend";$.ecOverlay("<strong>规则校验中,请稍等...</strong>");var w=$.callServiceAsJsonGet(x,{strParam:JSON.stringify(y)});$.unecOverlay();if(w.code==0){return w.data}else{if(w.code==-2){$.alertM(w.data)}else{$.alert("提示","数据查询异常，请稍后重试！")}}};var i=function(y){d(y);var x=contextPath+"/offer/searchAttachOfferSpec";$.ecOverlay("<strong>附属销售品查询中，请稍等...</strong>");var w=$.callServiceAsHtmlGet(x,{strParam:JSON.stringify(y)});$.unecOverlay();if(w.code==0){return w.data}else{if(w.code==-2){$.alertM(w.data)}else{$.alert("提示","查询附属销售失败，请稍后重试！")}}};var a=function(y){var x=contextPath+"/order/checkOperate";$.ecOverlay("<strong>受理权限查询中，请稍等...</strong>");var w=$.callServiceAsJsonGet(x,"");$.unecOverlay();if(w.code==0){return w.data}else{if(w.code==-2){$.alertM(w.data)}else{$.alert("提示","受理权限查询失败，请稍后重试！")}}};var u=function(y){var x=contextPath+"/order/orderSubmit";if(OrderInfo.order.token!=""){x=contextPath+"/order/orderSubmit?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var w=$.callServiceAsHtml(x,y);$.unecOverlay();if(!w||w.code!=0){return}return w.data};var n=function(y){var x=contextPath+"/order/orderSubmitComplete";if(OrderInfo.order.token!=""){x=contextPath+"/order/orderSubmitComplete?token="+OrderInfo.order.token}$.ecOverlay("<strong>订单提交中，请稍等...</strong>");var w=$.callServiceAsJson(x,y);$.unecOverlay();if(!w||w.code!=0){return}return w.data};var t=function(x){var w=query.offer.queryOfferSpec(x);if(w==undefined||w.offerRoles==undefined){$.alert("提示","返回的销售品规格构成结构不对！");return false}if(w.offerSpecId==undefined||w.offerSpecId==""){$.alert("提示","销售品规格ID未返回，无法继续受理！");return false}if(w.offerRoles.length==0){$.alert("提示","套餐角色为空，你重新选择！");return false}if(w.feeType==undefined||w.feeType==""||w.feeType=="null"){$.alert("提示","无付费类型，无法新装！");return false}w=SoOrder.sortOfferSpec(w);OrderInfo.offerSpec=w;return w};var m=function(y){var x={offerSpecId:y,partyId:OrderInfo.cust.custId,offerTypeCd:2};if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){x.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId}var w=query.offer.queryOfferSpec(x);if(w==undefined||w.offerRoles==undefined){$.alert("提示","返回的销售品规格构成结构不对！");return false}if(w.offerSpecId==undefined||w.offerSpecId==""){$.alert("提示","销售品规格ID未返回，继续受理将出现异常！");return false}if(w.offerSpecName==undefined||w.offerSpecName==""){$.alert("提示","销售品规格名称未返回，继续受理将出现异常！");return false}return w};var k=function(y){var x=contextPath+"/order/prodModify/updateCheckByChange";$.ecOverlay("<strong>正在预校验中，请稍等...</strong>");var w=$.callServiceAsJson(x,y);$.unecOverlay();if(w.code==0){return w.data}else{if(w.code==-2){$.alertM(w.data)}else{$.alert("提示","预校验失败!失败原因为："+w.data)}}};var j=function(){OrderInfo.order.soNbr=UUID.getDataId();if(CONST.getAppDesc()!=0){return true}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14||OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){return true
}if(order.prodModify==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var w=order.prodModify.choosedProdInfo;if(w==undefined||w.prodInstId==undefined){$.alert("提示","未获取到产品相关信息，无法办理二次业务！");return false}var z={areaId:OrderInfo.getProdAreaId(w.prodInstId),acctNbr:w.accNbr,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,instId:w.prodInstId,type:"2"};if(OrderInfo.offer.offerMemberInfos!=undefined&&OrderInfo.offer.offerMemberInfos.length>0){var x=true;var y=0;$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){y++;z.acctNbr=this.accessNumber;z.instId=this.objInstId;if(!query.offer.invokeLoadInst(z)){x=false;return false}}});if(y==0){return query.offer.invokeLoadInst(z)}return x}else{return query.offer.invokeLoadInst(z)}};var d=function(w){w.staffId=OrderInfo.staff.staffId;w.channelId=OrderInfo.staff.channelId;w.areaId=OrderInfo.getProdAreaId(w.prodId);w.partyId=OrderInfo.cust.custId;w.distributorId=OrderInfo.staff.distributorId;if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){w.soNbr=OrderInfo.order.soNbr}};var h=function(y){var x=contextPath+"/offer/loadInst";$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");var w=$.callServiceAsJsonGet(x,y);$.unecOverlay();if(w.code==0){return true}else{if(w.code==-2){$.alertM(w.data);return false}else{if(w.msg==undefined){$.alert("提示","全量信息查询失败")}else{$.alert("提示",w.msg)}return false}}};return{queryOfferSpec:s,queryOfferInst:o,queryOfferParam:g,queryAttachOffer:c,queryChangeAttachOffer:v,orderSubmit:u,orderSubmitComplete:n,queryAttachSpec:r,setOffer:p,loadInst:j,invokeLoadInst:h,queryCanBuyAttachSpec:l,queryCanBuyServ:q,queryExcludeDepend:f,queryServExcludeDepend:b,searchAttachOfferSpec:i,queryMainOfferSpec:t,queryAttachOfferSpec:m,checkOperate:a,updateCheckByChange:k}})();CommonUtils.regNamespace("OrderInfo");OrderInfo=(function(){var Y=0;var v={custId:"",partyName:""};var I={staffId:0,channelId:0,channelName:"",areaId:0,areaCode:0,distributorId:""};var s={};var H={offerId:"",offerSpecId:"",offerMemberInfos:[]};var g={offerId:"",offerSpecId:"",offerMemberInfos:[]};var u=0;var c="";var Q="订购";var ae="";var aa=[];var af={};var ac={};var S={dealerType:"",soNbr:"",oldSoNbr:"",oldSoId:"",step:0,token:"",templateType:1,dealerTypeList:[]};var U={effTime:""};var a={seq:-1,offerSeq:-1,prodSeq:-1,servSeq:-1,itemSeq:-1,acctSeq:-1,acctCdSeq:-1,paramSeq:-1,atomActionSeq:-1,offerMemberSeq:-1,dealerSeq:1};var t=[];var f=[];var j=[];var p=[];var F=[];var w=[];var C=[];var q=[];var W=function(){var ag={orderList:{orderListInfo:{isTemplateOrder:"N",templateType:OrderInfo.order.templateType,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,areaId:OrderInfo.staff.areaId,partyId:-1,distributorId:OrderInfo.staff.distributorId,olTypeCd:CONST.OL_TYPE_CD.FOUR_G},custOrderList:[{busiOrder:[]}]}};OrderInfo.orderData=ag;return OrderInfo.orderData};var l=function(ag){var ah={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.CUST_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.CUST_CREATE},data:{boCustInfos:[],boCustIdentities:[],boPartyContactInfo:[]}};ah.data.boCustInfos.push(OrderInfo.boCustInfos);ah.data.boCustIdentities.push(OrderInfo.boCustIdentities);if($("#tabProfile0").attr("click")=="0"&&($("#contactName").val()!="")){ah.data.boPartyContactInfo.push(OrderInfo.boPartyContactInfo)}if(OrderInfo.boCustProfiles!=undefined&&OrderInfo.boCustProfiles!=""){ah.data.boCustProfiles=[];ah.data.boCustProfiles=OrderInfo.boCustProfiles}ag.push(ah)};var P=function(am,an){var ah=$("#acctName").val();var ao=$("#paymentType").val();var ai="";var ak="";var al="";if(ao==110000){ai=$("#bankId").val();ak=$("#bankAcct").val();al=$("#paymentMan").val()}var ag={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:an},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.ACCT_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACCT_CREATE},data:{boAccountInfos:[{partyId:OrderInfo.cust.custId,acctName:ah,acctCd:an,acctId:an,businessPassword:"111111",state:"ADD",acctTypeCd:"1"}],boPaymentAccounts:[{paymentAcctTypeCd:ao,bankId:ai,bankAcct:ak,paymentMan:al,limitQty:"1",state:"ADD"}],boAcct2PaymentAccts:[{priority:"1",state:"ADD"}],boAccountItems:[],boAccountMailings:[]}};if($("#postType").val()!=-1){var aj={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"ADD"};if($("#postType").val()==11||$("#postType").val()==15){aj.param1=$("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val()}ag.data.boAccountMailings.push(aj)}am.push(ag)};var Z=function(ah,aj,al){var ag=ab(al);var ak={areaId:OrderInfo.getProdAreaId(al),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aj.offerSpecId,instId:aj.offerId,offerTypeCd:aj.offerTypeCd},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:aj.boActionTypeCd},data:{}};if(n(aj.offerSpecName)){ak.busiObj.objName=aj.offerSpecName}if(n(ag)){ak.busiObj.accessNumber=ag}var am=$("#order_remark").val();if(am!=""&&am!=undefined){ak.data.busiOrderAttrs=[];ak.data.busiOrderAttrs.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:am})}if(aj.boActionTypeCd==CONST.BO_ACTION_TYPE.BUY_OFFER){var ai=$("tr[name='tr_"+al+"_"+aj.offerSpecId+"']");if(ai!=undefined&&ai.length>0){ak.data.busiOrderAttrs=[];ai.each(function(){var an={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};ak.data.busiOrderAttrs.push(an)})}ak.data.ooOwners=[];ak.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"ADD"});if(B(aj.offerSpecParams)){ak.data.ooParams=[];$.each(aj.offerSpecParams,function(){if(n(this.setValue)){var an={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};ak.data.ooParams.push(an)}})}if(aj.ooTimes!=undefined){ak.data.ooTimes=[];ak.data.ooTimes.push(aj.ooTimes)}$.each(OrderInfo.attach2Coupons,function(){if(aj.offerSpecId==this.attachSepcId&&al==this.prodId){this.offerId=aj.offerId;ak.data.bo2Coupons=[];ak.data.bo2Coupons.push(this);return false}});ak.data.ooRoles=[];$.each(aj.offerRoles,function(){var an=this;$.each(this.roleObjs,function(){var aq={prodId:al,offerRoleId:an.offerRoleId,objId:this.objId,objType:this.objType,relaType:this.relaTypeCd,state:"ADD"};if(this.objType==CONST.OBJ_TYPE.PROD){var ap=OrderInfo.getProdSpecId(al);if(ap==this.objId||ap==""){aq.objInstId=al}else{return true}}else{if(this.objType==CONST.OBJ_TYPE.SERV){var ar=CacheData.getServBySpecId(al,this.objId);if(ar!=undefined){aq.objInstId=ar.servId}else{var at=OrderInfo.SEQ.servSeq--;this.servId=at;this.prodId=al;aq.objInstId=at;if(n(ag)){this.accessNumber=ag}this.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;this.servSpecName=this.objName;ah.push(i(this));var ao=CacheData.getServSpec(al,this.objId);if(ao!=undefined){ao.isdel="P"}}}else{aq.objInstId=OrderInfo.SEQ.offerSeq--}}ak.data.ooRoles.push(aq)})});ah.push(ak)}else{if(aj.boActionTypeCd==CONST.BO_ACTION_TYPE.DEL_OFFER){ak.data.ooOwners=[];ak.data.ooOwners.push({partyId:OrderInfo.cust.custId,state:"DEL"});if(B(aj.offerMemberInfos)){ak.data.ooRoles=[];$.each(aj.offerMemberInfos,function(){var an={objId:this.objId,objInstId:this.objInstId,objType:this.objType,offerRoleId:this.offerRoleId,state:"DEL"};if(this.objType!=CONST.OBJ_TYPE.PROD){an.prodId=al}if(this.offerMemberId!=undefined){an.offerMemberId=this.offerMemberId}ak.data.ooRoles.push(an)})}ah.push(ak)}else{if(aj.boActionTypeCd==CONST.BO_ACTION_TYPE.UPDATE_OFFER){if(aj.isUpdate=="Y"){ak.data.ooRoles=aj.data}else{if(B(aj.offerSpec.offerSpecParams)){ak.data.ooParams=[];$.each(aj.offerSpec.offerSpecParams,function(){if(this.isUpdate=="Y"){if(n(this.value)){var an={itemSpecId:this.itemSpecId,offerParamId:this.offerParamId,offerSpecParamId:this.offerSpecParamId,value:this.value,state:"DEL"};ak.data.ooParams.push(an)
}if(n(this.setValue)){var ao={itemSpecId:this.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:this.offerSpecParamId,value:this.setValue,state:"ADD"};ak.data.ooParams.push(ao)}}})}}ah.push(ak)}}}};var i=function(am){var ai=ab(am.prodId);var ag={areaId:OrderInfo.getProdAreaId(am.prodId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.getProdSpecId(am.prodId),instId:am.prodId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:am.boActionTypeCd},data:{}};if(n(am.isComp)){ag.busiObj.isComp=am.isComp}if(n(ai)){ag.busiObj.accessNumber=ai}var ak=$("#order_remark").val();if(ak!=""&&ak!=undefined){if(!B(ag.data.busiOrderAttrs)){ag.data.busiOrderAttrs=[]}ag.data.busiOrderAttrs.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:ak})}if(am.boActionTypeCd==CONST.BO_ACTION_TYPE.PRODUCT_PARMS){if(B(am.prodSpecParams)){ag.data.boServOrders=[];ag.data.boServOrders.push({servId:am.memberId,servSpecId:am.servSpecId});ag.data.boServItems=[];$.each(am.prodSpecParams,function(){if(this.isUpdate=="Y"){if(n(this.value)){var ap={itemSpecId:this.itemSpecId,servId:am.memberId,value:this.value,state:"DEL"};ag.data.boServItems.push(ap)}if(n(this.setValue)){var aq={itemSpecId:this.itemSpecId,servId:am.memberId,value:this.setValue,state:"ADD"};ag.data.boServItems.push(aq)}}})}}else{if(am.boActionTypeCd==CONST.BO_ACTION_TYPE.SERV_OPEN){var ah="ADD";if(am.servClose=="Y"){ah="DEL"}else{if(am.servSpecId==undefined&&am.objId!=undefined){am.servSpecId=am.objId}}var an={servId:am.servId,servSpecId:am.servSpecId};if(n(am.servSpecName)){an.servSpecName=am.servSpecName}ag.data.boServOrders=[];ag.data.boServOrders.push(an);ag.data.boServs=[];ag.data.boServs.push({servId:am.servId,state:ah});if(am.servClose!="Y"){ag.data.boServItems=[];if(B(am.prodSpecParams)){$.each(am.prodSpecParams,function(){if(n(this.setValue)){var ap={itemSpecId:this.itemSpecId,servId:am.servId,value:this.setValue,state:ah};ag.data.boServItems.push(ap)}})}var al=$("tr[name='tr_"+prodId+"_"+am.servSpecId+"']");if(al!=undefined&&al.length>0){if(!B(ag.data.busiOrderAttrs)){ag.data.busiOrderAttrs=[]}al.each(function(){var ap={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};ag.data.busiOrderAttrs.push(ap)})}}}else{if(am.boActionTypeCd==CONST.BO_ACTION_TYPE.REMOVE_PROD){ag.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}]}else{if(am.boActionTypeCd==CONST.BO_ACTION_TYPE.CHANGE_CARD||am.boActionTypeCd==CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD){var ao=OrderInfo.getProdUim(am.prodId);if(n(ao.prodId)){ag.data.bo2Coupons=[];ag.data.bo2Coupons.push(ao);ag.data.bo2Coupons.push(OrderInfo.getProdOldUim(am.prodId));if(n(am.remark)){var aj={itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:am.remark};ag.data.busiOrderAttrs=[];ag.data.busiOrderAttrs.push(aj)}}else{return false}}}}}return ag};var h=function(ag,aj){var ah=order.prodModify.choosedProdInfo;var ai={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ah.productId,instId:ah.prodInstId,accessNumber:ah.accNbr},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};ai.data=aj;ag.push(ai)};var r=function(ah){var ag="";$.each(AttachOffer.openList,function(){$.each(this.specList,function(){$.each(this.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objId==ah){ag=this.relaTypeCd;return false}})})})});return ag};var X={areaId:0,defaultIdType:"1",businessPassword:"",name:"",partyTypeCd:1,state:"ADD",telNumber:"",addressStr:""};var V={identidiesTypeCd:"1",identityNum:"",isDefault:"Y",state:"ADD"};var R={contactAddress:"",contactDesc:"",contactEmployer:"",contactGender:"",contactId:"",contactName:"",contactType:"",eMail:"",fax:"",headFlag:"",homePhone:"",mobilePhone:"",officePhone:"",postAddress:"",postcode:"",staffId:0,state:"",statusCd:"100001"};var m={};var O=function(){var ag={couponUsageTypeCd:"",inOutTypeId:"",inOutReasonId:0,saleId:0,couponId:0,couponinfoStatusCd:"",chargeItemCd:"",couponNum:"",storeId:0,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:"",ruleId:0,partyId:0,prodId:0,offerId:0,state:"",relaSeq:""};return ag};var k=function(){OrderInfo.SEQ.seq=-1;OrderInfo.SEQ.offerSeq=-1;OrderInfo.SEQ.prodSeq=-1;OrderInfo.SEQ.servSeq=-1;OrderInfo.SEQ.itemSeq=-1;OrderInfo.SEQ.acctSeq=-1;OrderInfo.SEQ.acctCdSeq=-1;OrderInfo.SEQ.paramSeq=-1;OrderInfo.SEQ.atomActionSeq=-1};var N=function(){OrderInfo.boProdAns=[];OrderInfo.boProd2Tds=[];OrderInfo.bo2Coupons=[];AttachOffer.openList=[];AttachOffer.openedList=[];AttachOffer.openServList=[];AttachOffer.openedServList=[];AttachOffer.openAppList=[];AttachOffer.labelList=[];AttachOffer.isChangeUim=0;OrderInfo.confirmList=[];OrderInfo.orderResult={};OrderInfo.order.step=1};var o=function(ag,aj,ak,ai,ah){if(ag!=""&&ag!=undefined){OrderInfo.actionClassCd=ag}if(aj!=""&&aj!=undefined){OrderInfo.boActionTypeCd=aj}if(ak!=undefined){OrderInfo.actionFlag=ak}if(ai!=""&&ai!=undefined){OrderInfo.actionTypeName=ai}if(ah!=""&&ah!=undefined){OrderInfo.order.templateType=ah}};var D=function(aj){var ag={};for(var ah=0;ah<OrderInfo.boProdAns.length;ah++){var ai=OrderInfo.boProdAns[ah];if(ai==undefined){continue}else{if(ai.prodId==aj){ag=ai}}}return ag};var K=function(ah,ag){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==ah){this.an=ag;return false}})})};var x=function(ai){if(ai!=undefined&&ai>0){var aj=order.prodModify.choosedProdInfo.areaId;if(aj==undefined||aj==""){return OrderInfo.staff.areaId}return aj}else{for(var ag=0;ag<OrderInfo.boProdAns.length;ag++){var ah=OrderInfo.boProdAns[ag];if(ah.prodId==ai){if(ah.areaId==undefined||ah.areaId==""){return OrderInfo.staff.areaId}else{return ah.areaId}}}return OrderInfo.staff.areaId}};var M=function(ah){for(var ag=0;ag<OrderInfo.boProd2OldTds.length;ag++){var ai=OrderInfo.boProd2OldTds[ag];if(ai.prodId==ah){return ai}}return{}};var z=function(ah){for(var ag=0;ag<OrderInfo.boProd2Tds.length;ag++){var ai=OrderInfo.boProd2Tds[ag];if(ai.prodId==ah){return ai}}return{}};var T=function(ah){for(var ag=0;ag<OrderInfo.boProd2Tds.length;ag++){var ai=OrderInfo.boProd2Tds[ag];if(ai.prodId==ah){OrderInfo.boProd2Tds.splice(ag,1)}}};var y=function(ah){for(var ag=0;ag<OrderInfo.boProd2Tds.length;ag++){var ai=OrderInfo.boProd2Tds[ag];if(ai.prodId==ah){return ai.terminalCode}}return""};var G=function(ak){var ah=true;for(var aj=0;aj<OrderInfo.bo2Coupons.length;aj++){var ai=OrderInfo.bo2Coupons[aj];if(ai.prodId==ak){ah=false;return ai}}if(ah){var ag={prodId:ak,coupons:[]};OrderInfo.bo2Coupons.push(ag);return ag}};var b=function(ak){var ah=true;for(var aj=0;aj<OrderInfo.bo2Coupons.length;aj++){var ai=OrderInfo.bo2Coupons[aj];if(ai.prodId==ak){ai.coupons=[];return ai}}if(ah){var ag={prodId:ak,coupons:[]};OrderInfo.bo2Coupons.push(ag);return ag}};var ab=function(aj){var ag="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var ah=0;ah<OrderInfo.boProdAns.length;ah++){var ai=OrderInfo.boProdAns[ah];if(ai.prodId==aj){if(ai.accessNumber!=undefined){ag=ai.accessNumber}}}}else{if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){$.each(OrderInfo.offer.offerMemberInfos,function(ak){if(this.objInstId==aj){ag=this.accessNumber;return false}})}else{if(aj!=undefined&&aj>0){ag=order.prodModify.choosedProdInfo.accNbr}}}return ag};var A=function(aj){var ag="";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var ah=0;ah<OrderInfo.boProdAns.length;ah++){var ai=OrderInfo.boProdAns[ah];if(ai.prodId==aj){if(ai.areaCode!=undefined){ag=ai.areaCode}}}}else{if(aj!=undefined&&aj>0){ag=order.prodModify.choosedProdInfo.areaCode}}if(ag==undefined||ag==""){ag=OrderInfo.staff.areaCode}return ag};var d=function(ag){var ah="";$.each(OrderInfo.boProdAns,function(){if(this.memberRoleCd==ag){ah=this.accessNumber;return false
}});if(ah==undefined||ah==""){ah=OrderInfo.boProdAns[0].accessNumber}return ah};var J=function(ah){var ag="";if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==3){if(OrderInfo.offer.offerMemberInfos!=undefined){$.each(OrderInfo.offer.offerMemberInfos,function(ai){if(this.objInstId==ah){ag=this.roleName;return false}})}}else{if(OrderInfo.offerSpec.offerRoles!=undefined){$.each(OrderInfo.offerSpec.offerRoles,function(aj){var ai=this.offerRoleName;if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==ah){ag=ai;return false}})}})}}return ag};var E=function(ah){var ag={};if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(ai){if(this.objInstId==ah){ag=this;ag.accNbr=this.accessNumber;return false}})}else{if(OrderInfo.actionFlag==3){ag=order.prodModify.choosedProdInfo}else{$.each(OrderInfo.offerSpec.offerRoles,function(ai){if(this.prodInsts!=undefined){$.each(this.prodInsts,function(){if(this.prodInstId==ah){ag=this;return false}})}})}}return ag};var ad=function(ah){var ag=CONST.PROD_SPEC.CDMA;if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){if(this.prodInstId==ah){ag=this.objId;return false}})})}else{if(OrderInfo.actionFlag==2){$.each(OrderInfo.offer.offerMemberInfos,function(ai){if(this.objInstId==ah){ag=this.objId;return false}})}else{if(ah!=undefined&&ah>0){ag=order.prodModify.choosedProdInfo.productId}}}return ag};var L=function(ag){if(OrderInfo.privilege.effTime==""){var ah={manageCode:ag};return query.offer.checkOperate(ah)}};var n=function(ah){var ag=false;if(ah!=undefined&&$.trim(ah)!=""){ag=true}return ag};var B=function(ag){if(!!ag&&ag.length>0){return true}else{return false}};return{order:S,SEQ:a,resetSeq:k,resetData:N,orderResult:af,cust:v,staff:I,offerSpec:s,offer:H,attach2Coupons:q,boCustInfos:X,boCustIdentities:V,boPartyContactInfo:R,boCustProfiles:m,boCusts:t,boProdItems:f,boProdPasswords:j,boProdAns:p,boProd2Tds:F,bo2Coupons:C,boProd2OldTds:w,clearProdUim:T,getCoupon:O,orderData:ac,getOrderData:W,actionClassCd:u,boActionTypeCd:c,actionFlag:Y,actionTypeName:Q,initData:o,getOfferBusiOrder:Z,getProdBusiOrder:i,createCust:l,createAcct:P,getProdAn:D,getProdTd:y,getProdUim:z,getProdOldUim:M,getProdAreaId:x,getProdCoupon:G,getProdInst:E,getAccessNumber:ab,getAreaCode:A,initProdCoupon:b,setProdAn:K,setProdModifyBusiOrder:h,confirmList:aa,getOfferRoleName:J,getAccNbrByRoleCd:d,businessName:ae,getProdSpecId:ad,privilege:U,getPrivilege:L,offerProdInst:g}})();CommonUtils.regNamespace("SoOrder");SoOrder=(function(){var L=function(){if(query.offer.loadInst()){SoOrder.initFillPage();return true}else{return false}};var q="";var j=function(){SoOrder.initOrderData();SoOrder.step(1);OrderInfo.order.step=1;C()};var B=function(){OrderInfo.resetSeq();OrderInfo.resetData();OrderInfo.orderResult={};OrderInfo.getOrderData();OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId};var s=function(R){if(F(R)){var Q=query.offer.orderSubmit(JSON.stringify(OrderInfo.orderData));if(Q){x(Q)}else{OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq()}}};var F=function(R){if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){if(OrderInfo.actionFlag==18&&R.boActionType.actionClassCd==CONST.ACTION_CLASS_CD.OFFER_ACTION){}else{query.offer.loadInst()}a(R);if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){OrderInfo.orderData.orderList.orderListInfo.soNbr=OrderInfo.order.soNbr}return true}var Q=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;if(!J()){return false}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){w(Q)}else{if(OrderInfo.actionFlag==2){offerChange.changeOffer(Q)}else{if(OrderInfo.actionFlag==3){G(Q);if(Q.length==0){$.alert("提示","没有做任何业务，无法提交");return false}}else{if(OrderInfo.actionFlag==4){O(Q,R)}else{if(OrderInfo.actionFlag==5){k(Q,R)}else{if(OrderInfo.actionFlag==6){t(Q)}else{if(OrderInfo.actionFlag==7){E(Q,R)}else{if(OrderInfo.actionFlag==8){g(Q,R)}else{if(OrderInfo.actionFlag==9){r(Q,R)}else{if(OrderInfo.actionFlag==10){OrderInfo.orderData.orderList.custOrderList[0].busiOrder=R}else{if(OrderInfo.actionFlag==11){OrderInfo.orderData.orderList.custOrderList[0].busiOrder=R}else{if(OrderInfo.actionFlag==12){OrderInfo.orderData.orderList.custOrderList[0].busiOrder=R}else{if(OrderInfo.actionFlag==16){d(Q)}else{if(OrderInfo.actionFlag==19){f(Q,R,"N")}else{if(OrderInfo.actionFlag==20){E(Q,R)}else{if(OrderInfo.actionFlag==21){N(Q,R)}else{if(OrderInfo.actionFlag==22){OrderInfo.orderData.orderList.custOrderList[0].busiOrder=R}else{f(Q,R,"N")}}}}}}}}}}}}}}}}}if($("#isTemplateOrder").attr("checked")=="checked"){OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="Y";OrderInfo.orderData.orderList.orderListInfo.templateOrderName=$("#templateOrderName").val();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){OrderInfo.orderData.orderList.orderListInfo.templateType=$("#templateOrderDiv").find("select").val()}else{if(OrderInfo.actionFlag==2){OrderInfo.orderData.orderList.orderListInfo.templateType=5}else{if(OrderInfo.actionFlag==3){OrderInfo.orderData.orderList.orderListInfo.templateType=2}}}}else{OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder="N"}if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){OrderInfo.orderData.orderList.orderListInfo.soNbr=OrderInfo.order.soNbr}return true};var a=function(S){var T=S.coupons;OrderInfo.getOrderData();var Q=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;if(OrderInfo.cust.custId==-1){OrderInfo.createCust(Q)}else{if(OrderInfo.cust.custId!=undefined&&OrderInfo.cust.custId!=""){OrderInfo.orderData.orderList.orderListInfo.partyId=OrderInfo.cust.custId}else{OrderInfo.orderData.orderList.orderListInfo.partyId=CONST.CUST_COUPON_SALE}}var R={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:S.busiObj,boActionType:S.boActionType,data:{bo2Coupons:[]}};R.data.bo2Coupons=T;Q.push(R)};var x=function(X){SoOrder.step(2,X);SoOrder.delOrderBegin();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$("#orderTbody").append("<tr><td >套餐名称：</td><td>"+OrderInfo.offerSpec.offerSpecName+"</td></tr>");var aa=$("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName+"<span class='showhide'></span>");$("#tital").append(aa);$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){$("#orderTbody").append("<tr ><td>"+this.offerRoleName+"号码：</td><td>"+OrderInfo.getProdAn(this.prodInstId).accessNumber+"</td></tr> ")})})}else{if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#orderedprod").hide();$("#order_prepare").hide();$("#order_tab_panel_content").hide();$("#orderTbody").append("<tr><td >终端名称：</td><td>"+OrderInfo.businessName+"</td></tr>");var Q=OrderInfo.orderData.orderList.custOrderList[0].busiOrder;var S=undefined;if(OrderInfo.actionFlag==13){for(var Y=0;Y<Q.length;Y++){var ab=Q[Y].boActionType;if(ab.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&ab.boActionTypeCd==CONST.BO_ACTION_TYPE.COUPON_SALE){S=Q[Y].data.bo2Coupons}}$("#orderTbody").append("<tr><td >终端串码：</td><td>"+S[0].couponInstanceNumber+"</td></tr>")}else{if(OrderInfo.actionFlag==17){for(var Y=0;Y<Q.length;Y++){var ab=Q[Y].boActionType;if(ab.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&ab.boActionTypeCd==CONST.BO_ACTION_TYPE.RETURN_COUPON){S=Q[Y].data.bo2Coupons}}$("#orderTbody").append("<tr><td >终端串码：</td><td>"+S[0].couponInstanceNumber+"</td></tr>")}else{if(OrderInfo.actionFlag==18){for(var Y=0;Y<Q.length;Y++){var ab=Q[Y].boActionType;if(ab.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION&&ab.boActionTypeCd==CONST.BO_ACTION_TYPE.EXCHANGE_COUPON){S=Q[Y].data.bo2Coupons}}var R=null;var T=null;if(S[0].state=="DEL"){R=S[0];T=S[1]}else{R=S[1];T=S[0]}$("#orderTbody").append("<tr><td >旧终端串码：</td><td>"+R.couponInstanceNumber+"</td></tr>");$("#orderTbody").append("<tr><td >新终端串码：</td><td>"+T.couponInstanceNumber+"</td></tr>")}}}var aa=$("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName+"<span class='showhide'></span>");
$("#tital").append(aa)}else{var Z=order.prodModify.choosedProdInfo;$("#orderTbody").append("<tr id='offerSpecName'><td >套餐名称：</td><td>"+Z.prodOfferName+"</td></tr>");$("#orderTbody").append("<tr id='accNbrTr'><td>手机号码：</td><td>"+Z.accNbr+"</td></tr> ");if(OrderInfo.actionFlag==2){OrderInfo.actionTypeName="套餐变更";$("#orderTbody").append("<tr><td >新套餐名称：</td><td>"+OrderInfo.offerSpec.offerSpecName+"</td></tr>");$("#accNbrTr").hide();for(var Y=0;Y<OrderInfo.offer.offerMemberInfos.length;Y++){var W=OrderInfo.offer.offerMemberInfos[Y];if(W.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append("<tr ><td>"+W.roleName+"号码：</td><td>"+W.accessNumber+"</td></tr> ")}}}else{if(OrderInfo.actionFlag==3){OrderInfo.actionTypeName="订购/退订可选包与功能产品"}else{if(OrderInfo.actionFlag==4||OrderInfo.actionFlag==8){$("#offerSpecName").hide();$("#accNbrTr").hide()}else{if(OrderInfo.actionFlag==5){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.isRemove=="Y"){$("#orderTbody").append("<tr ><td>拆除副卡号码：</td><td>"+this.accessNumber+"</td></tr> ")}else{$("#orderTbody").append("<tr ><td>"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==6){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#orderTbody").append("<tr ><td>"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}});$.each(OrderInfo.boProdAns,function(){$("#orderTbody").append("<tr ><td>纳入副卡号码：</td><td>"+this.accessNumber+"</td></tr> ")});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==7){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}else{var ad="";var ae=this.accessNumber;$.each(q,function(af,ag){if(ag.accessNumber==ae&&ag.del=="N"){ad="N"}});if(ad=="N"){$("#orderTbody").append("<tr ><td>订购"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}else{$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}}}});OrderInfo.actionTypeName=CONST.getBoActionTypeName(OrderInfo.boActionTypeCd)}else{if(OrderInfo.actionFlag==21){$("#accNbrTr").hide();$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){if(this.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){var ae="";var ad="";var af=this.objInstId;$.each(q,function(ag,ah){if(ah.objInstId==af&&ah.knew=="Y"){ae="Y"}if(ah.objInstId==af&&ah.del=="Y"){ad="Y"}});if(ae=="Y"){$("#orderTbody").append("<tr ><td>订购"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}else{if(ad=="Y"){$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")}}}}});OrderInfo.actionTypeName="主副卡成员变更"}else{if(OrderInfo.actionFlag==20){$("#accNbrTr").hide();for(var Y=0;Y<OrderInfo.offer.offerMemberInfos.length;Y++){var W=OrderInfo.offer.offerMemberInfos[Y];if(W.objType==CONST.OBJ_TYPE.PROD){if(W.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$("#orderTbody").append("<tr ><td>拆除"+W.roleName+"号码：</td><td>"+W.accessNumber+"</td></tr> ")}else{$("#orderTbody").append("<tr ><td>订购"+W.roleName+"号码：</td><td>"+W.accessNumber+"</td></tr> ")}}}OrderInfo.actionTypeName="返销"}else{if(OrderInfo.actionFlag==12){$("#accNbrTr").hide();for(var Y=0;Y<OrderInfo.confirmList.length;Y++){var Z=OrderInfo.confirmList[Y];for(var V=0;V<Z.accNbr.length;V++){$("#orderTbody").append("<tr><td >"+Z.name+"：</td><td>"+Z.accNbr[V]+"</td></tr>")}}}else{if(OrderInfo.actionFlag==16){OrderInfo.actionTypeName="改号";$.each(OrderInfo.boProdAns,function(){if(this.state=="ADD"){$("#orderTbody").append("<tr id='accNbrTr'><td>新号码：</td><td>"+this.accessNumber+"</td></tr> ")}})}else{if(OrderInfo.actionFlag==0&&OrderInfo.actionTypeName=="拆机"){$("#accNbrTr").hide();var ac="";$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&this.objInstId==order.prodModify.choosedProdInfo.prodInstId){ac="Y"}});if(ac=="Y"){$.each(OrderInfo.offer.offerMemberInfos,function(){$("#orderTbody").append("<tr ><td>拆除"+this.roleName+"号码：</td><td>"+this.accessNumber+"</td></tr> ")})}OrderInfo.actionTypeName="拆机"}}}}}}}}}}}var aa=$("<span>"+OrderInfo.actionTypeName+"</span>");$("#tital").append(aa)}}var U=true;if($("#ruleTbody tr").length>0){$("#ruleTbody tr").each(function(){var ad=$(this).attr("ruleLevel");if(ad=="1"){U=false;return false}})}if(U){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){H()}else{if(OrderInfo.actionFlag==2){P()}else{if(OrderInfo.actionFlag==3){c()}else{if(OrderInfo.actionFlag==6){l()}else{if(OrderInfo.orderResult.autoBoInfos!=undefined&&OrderInfo.orderResult.autoBoInfos.length>0){$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));$.each(OrderInfo.orderResult.autoBoInfos,function(){$("#chooseTable").append($('<tr><td width="50%">'+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))})}}}}}}};var M=function(Q,S){for(var R=1;R<4;R++){$("#step"+R).hide()}$("#step"+Q).show()};var z=function(Q,S){if(Q==0){$("#orderedprod").hide();$("#order_prepare").hide();$("#order_fill_content").hide();$("#order_tab_panel_content").html(S).show();Q++}else{if(Q==1){$("#orderedprod").hide();$("#order_prepare").hide();$("#order_tab_panel_content").hide();$("#order_confirm").hide();$("#order_fill_content").show()}else{if(Q==2){$("#custModifyId").attr("style","display: none;");$("#main_conetent").hide();$("#order_fill_content").hide();$("#order_tab_panel_content").hide();$("#order_confirm").html(S).show()}}}for(var R=1;R<4;R++){$("#step"+R).hide()}$("#step"+Q).show()};var H=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr>"));i(this.prodInstId)})})};var l=function(){$.each(OrderInfo.offerSpec.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+")</th><th>业务动作</th></tr>"));$.each(this.prodInsts,function(){i(this.prodInstId)})}})};var P=function(){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.roleName+")</th><th>业务动作</th></tr>"));i(this.objInstId)}})};var c=function(){var Q=order.prodModify.choosedProdInfo;if(Q==undefined||Q.prodInstId==undefined){return true}$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));i(Q.prodInstId)};var i=function(V){var U=CacheData.getOfferSpecList(V);var R=CacheData.getOfferList(V);var Q=CacheData.getServSpecList(V);var T=CacheData.getServList(V);var S=CacheData.getOpenAppList(V);if(U!=undefined&&U.length>0){$.each(U,function(){if(this.isdel!="Y"&&this.isdel!="C"){$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_BUY+"</td></tr>"))}})}if(R!=undefined&&R.length>0){$.each(R,function(){if(this.isdel=="Y"){$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_DEL+"</td></tr>"))}else{if(this.update=="Y"){$("#chooseTable").append($('<tr><td width="50%">'+this.offerSpecName+"</td><td>"+CONST.EVENT.OFFER_UPDATE+"</td></tr>"))}}})}if(Q!=undefined&&Q.length>0){$.each(Q,function(){if(this.isdel!="Y"&&this.isdel!="C"){$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(T!=undefined&&T.length>0){$.each(T,function(){if(this.isdel=="Y"){$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_CLOSE+"</td></tr>"))}else{if(this.update=="Y"){$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_UPDATE+"</td></tr>"))
}}})}if(S!=undefined&&S.length>0){$.each(S,function(){if(this.dfQty==1){$("#chooseTable").append($('<tr><td width="50%">'+this.servSpecName+"</td><td>"+CONST.EVENT.PROD_OPEN+"</td></tr>"))}})}if(OrderInfo.orderResult.autoBoInfos!=undefined){$.each(OrderInfo.orderResult.autoBoInfos,function(){if(this.instAccessNumber==OrderInfo.getAccessNumber(V)){$("#chooseTable").append($('<tr><td width="50%">'+this.specName+"</td><td>"+this.boActionTypeName+"</td></tr>"))}})}};var v=function(){SoOrder.delOrderFin();$("#order_fill_content").show();$("#main_conetent").show();if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#order_tab_panel_content").show()}$("#order_confirm").hide();SoOrder.showStep(1);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();SoOrder.delOrder();C();if(CONST.getAppDesc()!=0){$("#custModifyId").show()}};var D=function(){var Q=OrderInfo.orderResult.olId;if(Q!=0&&Q!=undefined){var R={olId:Q,areaId:OrderInfo.staff.areaId};$.callServiceAsJsonGet(contextPath+"/order/delOrder",R,{done:function(S){if(S.code==0){if(S.data.resultCode==0){$.alert("提示","购物车作废成功！")}}else{if(S.code==-2){$.alertM(S.data)}else{$.alert("提示","购物车作废失败！")}}},fail:function(S){$.alert("提示","信息","服务忙，请稍后再试！")}})}};var I=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,OrderInfo.orderResult.olId);$("a[href^='/']").off("mousedown").on("mousedown",function(){SoOrder.delOrderSilent();window.location.href=this.href});$(window).off("unload").on("unload",function(){SoOrder.delOrderSilent()})};var y=function(){var R=$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID);$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);if(R!=0&&R!=undefined&&R!=null){var S={olId:R,areaId:OrderInfo.staff.areaId};var Q=$.callServiceAsJsonGet(contextPath+"/order/delOrder",S);OrderInfo.orderData.orderList.custOrderList[0].busiOrder=[];OrderInfo.resetSeq();C();SoOrder.delOrderFin()}};var u=function(){$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID,null);$("a[href^='/']").off("mousedown");$(window).off("unload")};var k=function(Q,S){var R=order.prodModify.choosedProdInfo;var T={offerSpecId:R.prodOfferId,offerId:R.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:S};OrderInfo.getOfferBusiOrder(Q,T,S[0].objInstId);$.each(S,function(){var U={prodId:this.objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};Q.push(OrderInfo.getProdBusiOrder(U));$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&this.objInstId==prodId){this.isRemove="Y";return false}})})};var N=function(ab,V){var Q="";var ac=V.viceParam;q=ac;var Y=V.ooRoles;var aa=order.prodModify.choosedProdInfo;var S={offerSpecId:aa.prodOfferId,offerId:aa.prodOfferInstId,offerTypeCd:"1",isUpdate:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_OFFER,data:V.ooRoles};$.each(OrderInfo.offer.offerMemberInfos,function(ad){if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){Q=this.objInstId;return false}});OrderInfo.getOfferBusiOrder(ab,S,Q);for(var W=0;W<ac.length;W++){if(ac[W].knew=="Y"){var R=ac[W];var X={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:R.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};for(var U=0;U<OrderInfo.offer.offerMemberInfos.length;U++){var T=OrderInfo.offer.offerMemberInfos[U];if(T.objInstId==R.objInstId){var Y={objId:T.objId,objInstId:T.objInstId,objType:T.objType,offerRoleId:R.offerRoleId,state:"ADD"};X.data.ooRoles.push(Y);break}}ab.push(X)}else{var Z={prodId:ac[W].objInstId,isComp:"Y",boActionTypeCd:CONST.BO_ACTION_TYPE.REMOVE_PROD};ab.push(OrderInfo.getProdBusiOrder(Z))}}};var f=function(Y,U,S){var W=order.prodModify.choosedProdInfo;var V=OrderInfo.boActionTypeCd;var R=W.productId;var T=W.prodInstId;var X=OrderInfo.actionClassCd;if(V==CONST.BO_ACTION_TYPE.ADDOREXIT_COMP){R=W.prodOfferId;T=W.prodOfferInstId;X=CONST.ACTION_CLASS_CD.OFFER_ACTION}var Q={areaId:OrderInfo.getProdAreaId(W.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:R,instId:T,isComp:S,accessNumber:W.accNbr,offerTypeCd:"1"},boActionType:{actionClassCd:X,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};Q.data=U;Y.push(Q)};var w=function(T){if(OrderInfo.cust.custId==-1){OrderInfo.createCust(T)}var R=$("#acctSelect").find("option:selected").attr("value");if(R<0&&R!=undefined){OrderInfo.createAcct(T,R)}var U=n(T);for(var S=0;S<U.data.ooRoles.length;S++){var Q=U.data.ooRoles[S];if(Q.objType==2){T.push(m(Q.objInstId,Q.objId))}}AttachOffer.setAttachBusiOrder(T)};var C=function(){$.callServiceAsHtmlGet(contextPath+"/common/getToken",{done:function(Q){OrderInfo.order.token=Q.data}})};var t=function(V){var U=order.prodModify.choosedProdInfo;var Q={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:U.prodOfferId,instId:U.prodOfferInstId,accessNumber:U.accNbr,isComp:"Y",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP},data:{ooRoles:[],ooOwners:[]}};var X={partyId:OrderInfo.cust.custId,state:"ADD"};Q.data.ooOwners.push(X);for(var T=0;T<OrderInfo.offerSpec.offerRoles.length;T++){var W=OrderInfo.offerSpec.offerRoles[T];if(W.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(W.prodInsts!=undefined&&W.prodInsts.length>0){for(var S=0;S<W.prodInsts.length;S++){var Y=W.prodInsts[S];var R={objId:Y.objId,objInstId:Y.prodInstId,objType:Y.objType,offerMemberId:OrderInfo.SEQ.offerMemberSeq--,offerRoleId:Y.offerRoleId,state:"ADD"};Q.data.ooRoles.push(R);V.push(m(Y.prodInstId,Y.objId))}}}}AttachOffer.setAttachBusiOrder(V);V.push(Q)};var E=function(ae,af){var ag=af;var X="";var R=true;var ad=CONST.ACTION_CLASS_CD.OFFER_ACTION;var ac=CONST.BO_ACTION_TYPE.DEL_OFFER;var S=CONST.ACTION_CLASS_CD.OFFER_ACTION;var ab=CONST.BO_ACTION_TYPE.BUY_OFFER;if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){ad=CONST.ACTION_CLASS_CD.PROD_ACTION;ac=CONST.BO_ACTION_TYPE.BUY_BACK;S=CONST.ACTION_CLASS_CD.OFFER_ACTION;ab=CONST.BO_ACTION_TYPE.BUY_OFFER;v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.BUY_BACK;ag=af.viceParam;X=af.remark}else{if(OrderInfo.actionFlag==7){v_boActionTypeCdAdd=CONST.BO_ACTION_TYPE.REMOVE_PROD}}for(var W=0;W<ag.length;W++){var T=ag[W];if(T.del=="N"){R=false}}if(R){var Q={areaId:OrderInfo.getProdAreaId(order.prodModify.choosedProdInfo.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,objId:order.prodModify.choosedProdInfo.productId,instId:order.prodModify.choosedProdInfo.prodInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:order.prodModify.choosedProdInfo.prodStateCd,state:"DEL"},{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};var X=$("#order_remark").val();if(X!=""&&X!=undefined){Q.data.busiOrderAttrs.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:X})}ae.push(Q);for(var W=0;W<ag.length;W++){var T=ag[W];var Q={areaId:OrderInfo.getProdAreaId(T.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:T.accessNumber,objId:T.objId,instId:T.objInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:OrderInfo.boActionTypeCd},data:{boProdStatuses:[{prodStatusCd:(OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD)?CONST.PROD_STATUS_CD.STOP_PROD:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};var X=$("#order_remark").val();if(X!=""&&X!=undefined){Q.data.busiOrderAttrs.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:X})}ae.push(Q)}return}if(OrderInfo.actionFlag==7){q=ag;
var aa=order.prodModify.choosedProdInfo;var Q={areaId:OrderInfo.getProdAreaId(aa.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aa.prodOfferId,instId:aa.prodOfferInstId,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:ad,boActionTypeCd:ac},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"DEL"}]}};for(var W=0;W<OrderInfo.offer.offerMemberInfos.length;W++){var V=OrderInfo.offer.offerMemberInfos[W];var Z={objId:V.objId,objInstId:V.objInstId,objType:V.objType,offerMemberId:V.offerMemberId,offerRoleId:V.offerRoleId,state:"DEL"};Q.data.ooRoles.push(Z)}ae.push(Q)}else{var aa=order.prodModify.choosedProdInfo;var Q={areaId:OrderInfo.getProdAreaId(aa.prodInstId),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:aa.productId,instId:aa.prodInstId,accessNumber:aa.accNbr,isComp:"N"},boActionType:{actionClassCd:ad,boActionTypeCd:ac},data:{boProdStatuses:[{prodStatusCd:CONST.PROD_STATUS_CD.NORMAL_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.REMOVE_PROD,state:"ADD"}],busiOrderAttrs:[]}};if(X!=undefined&&X!=""){Q.data.busiOrderAttrs.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:X})}ae.push(Q)}for(var W=0;W<ag.length;W++){var T=ag[W];var Y={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:T.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:S,boActionTypeCd:ab},data:{ooRoles:[],ooOwners:[{partyId:OrderInfo.cust.custId,state:"ADD"}]}};for(var U=0;U<OrderInfo.offer.offerMemberInfos.length;U++){var V=OrderInfo.offer.offerMemberInfos[U];if(V.objInstId==T.objInstId){var Z={objId:V.objId,objInstId:V.objInstId,objType:V.objType,offerRoleId:T.offerRoleId,state:"ADD"};Y.data.ooRoles.push(Z);break}}ae.push(Y)}};var G=function(R){AttachOffer.setAttachBusiOrder(R);var S=order.prodModify.choosedProdInfo;if(AttachOffer.isChangeUim==1&&S.prodClass==CONST.PROD_CLASS.THREE){if(OrderInfo.boProd2Tds.length>0){var Q={prodId:S.prodInstId,prodSpecId:S.productId,isComp:"N",accessNumber:S.accNbr,boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD};R.push(OrderInfo.getProdBusiOrder(Q))}}};var O=function(Q,S){var R={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};R.data=S;Q.push(R)};var r=function(R,T){var S={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:OrderInfo.cust.custId},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};S.data=T;R.push(S);var Q={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,objId:order.prodModify.choosedProdInfo.productId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACTIVERETURNTWO},data:{}};Q.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.READY_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.DONE_PROD,state:"ADD"}];R.push(Q)};var g=function(Q,S){var R={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:OrderInfo.actionClassCd,boActionTypeCd:OrderInfo.boActionTypeCd},data:{}};R.data=S;Q.push(R)};var n=function(T){var U={areaId:OrderInfo.getProdAreaId(-1),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:OrderInfo.offerSpec.offerSpecId,instId:OrderInfo.SEQ.offerSeq--,isComp:"N",offerTypeCd:"1"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_OFFER},data:{ooRoles:[],ooOwners:[]}};$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var Y={objId:this.objId,objInstId:this.prodInstId,objType:this.objType,memberRoleCd:this.memberRoleCd,offerRoleId:this.offerRoleId,state:"ADD"};U.data.ooRoles.push(Y);var X=this.prodInstId;if(this.servInsts!=undefined&&this.servInsts.length>0){$.each(this.servInsts,function(){var Z={objId:this.objId,objInstId:OrderInfo.SEQ.servSeq--,objType:this.objType,prodId:X,offerRoleId:this.offerRoleId,state:"ADD"};U.data.ooRoles.push(Z)})}})});var W=OrderInfo.offerSpec.offerSpecParams;if(W!=undefined&&W.length>0){U.data.ooParams=[];for(var S=0;S<W.length;S++){var V=W[S];var Q={itemSpecId:V.itemSpecId,offerParamId:OrderInfo.SEQ.paramSeq--,offerSpecParamId:V.offerSpecParamId,value:V.value,state:"ADD"};U.data.ooParams.push(Q)}}if(OrderInfo.offerSpec.ooTimes!=undefined){U.data.ooTimes=[];U.data.ooTimes.push(OrderInfo.offerSpec.ooTimes)}var R={partyId:OrderInfo.cust.custId,state:"ADD"};U.data.ooOwners.push(R);T.push(U);return U};var m=function(X,ae){var R={areaId:OrderInfo.getProdAreaId(X),busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:ae,instId:X,isComp:"N"},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:"1"},data:{boProdFeeTypes:[],boProdSpecs:[{prodSpecId:ae,state:"ADD"}],boCusts:[],boProdItems:[],boProdPasswords:[],boProdAns:[],bo2Coupons:[],boAccountRelas:[],boProdStatuses:[],busiOrderAttrs:[]}};var U=CONST.PROD_STATUS_CD.NEW_PROD;if($("#isTemplateOrder").attr("checked")=="checked"){if($("#templateOrderDiv").find("select").val()==0){U=CONST.PROD_STATUS_CD.READY_PROD}}R.data.boProdStatuses.push({state:"ADD",prodStatusCd:U});var S=OrderInfo.boProdAns;for(var W=0;W<S.length;W++){if(S[W].prodId==X){R.data.boProdAns.push(S[W]);break}}var ac=OrderInfo.boProd2Tds;for(var W=0;W<ac.length;W++){if(ac[W].prodId==X){R.data.bo2Coupons.push(ac[W]);break}}R.data.boCusts.push({partyId:OrderInfo.cust.custId,partyProductRelaRoleCd:"0",state:"ADD"});var aa=$("#pwd_"+X).val();var V={prodPwTypeCd:2,pwd:aa,state:"ADD"};R.data.boProdPasswords.push(V);$("[name=prodSpec_"+X+"]").each(function(){var ag=$(this).attr("id").split("_")[0];var ai=$.trim($(this).val());if(ai!=""&&ai!=undefined){var ah={itemSpecId:ag,prodSpecItemId:OrderInfo.SEQ.itemSeq--,state:"ADD",value:ai};R.data.boProdItems.push(ah)}});var ab=$('select[name="pay_type_-1"]').val();if(ab!=undefined){R.data.boProdFeeTypes.push({feeType:ab,state:"ADD"})}var Z=$("#order_remark").val();if(Z!=""&&Z!=undefined){R.data.busiOrderAttrs.push({itemSpecId:CONST.BUSI_ORDER_ATTR.REMARK,value:Z})}var Y=$("tr[name='tr_"+X+"']");if(Y!=undefined){Y.each(function(){var ag={itemSpecId:CONST.BUSI_ORDER_ATTR.DEALER,role:$(this).find("select").val(),value:$(this).find("input").attr("staffid")};R.data.busiOrderAttrs.push(ag)})}var Q=$("#acctSelect").find("option:selected");var ad=Q.attr("value");var af=-1;if(ad==undefined){ad=-1;af=-1}else{if(ad<0){af=ad}else{af=Q.attr("acctcd")}}var T={acctId:ad,acctCd:af,acctRelaTypeCd:"1",chargeItemCd:"0",percent:"100",priority:"1",state:"ADD"};R.data.boAccountRelas.push(T);return R};var A=function(T,S,Q,R){if(Q==1){T.offerTypeCd=2;T.boActionTypeCd=CONST.BO_ACTION_TYPE.DEL_OFFER;OrderInfo.getOfferBusiOrder(R,T,S)}else{if(Q==2){if(T.offerSpec.offerSpecParams!=undefined&&T.offerSpec.offerSpecParams.length>0){T.offerTypeCd=2;T.boActionTypeCd=CONST.BO_ACTION_TYPE.UPDATE_OFFER;OrderInfo.getOfferBusiOrder(R,T,S)}}else{T.offerTypeCd=2;T.boActionTypeCd=CONST.BO_ACTION_TYPE.BUY_OFFER;T.offerId=OrderInfo.SEQ.offerSeq--;OrderInfo.getOfferBusiOrder(R,T,S)}}};var K=function(R,T,Q,S){R.prodId=T;if(Q==1){R.servClose="Y";R.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;S.push(OrderInfo.getProdBusiOrder(R))}else{if(Q==2){if(R.prodSpecParams!=undefined&&R.prodSpecParams.length>0){R.boActionTypeCd=CONST.BO_ACTION_TYPE.PRODUCT_PARMS;R.memberId=R.servId;S.push(OrderInfo.getProdBusiOrder(R))}}else{R.servId=OrderInfo.SEQ.servSeq--;R.boActionTypeCd=CONST.BO_ACTION_TYPE.SERV_OPEN;S.push(OrderInfo.getProdBusiOrder(R))}}};var d=function(Q){var R={};R.boProdAns=OrderInfo.boProdAns;OrderInfo.setProdModifyBusiOrder(Q,R)};var J=function(){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(OrderInfo.cust.custId==""){$.alert("提示","客户信息不能为空！");
return false}if(OrderInfo.order.dealerTypeList==undefined||OrderInfo.order.dealerTypeList.length==0){$.alert("提示","发展人类型不能为空！");return false}for(var V=0;V<OrderInfo.offerSpec.offerRoles.length;V++){var Z=OrderInfo.offerSpec.offerRoles[V];for(var S=0;S<Z.prodInsts.length;S++){var ac=Z.prodInsts[S];var Q=OrderInfo.getProdAn(ac.prodInstId).accessNumber;if(Q==undefined||Q==""){$.alert("信息提示","【接入产品("+Z.offerRoleName+")】号码不能为空！");return false}if(OrderInfo.getProdTd(ac.prodInstId)==""){$.alert("信息提示","【接入产品("+Z.offerRoleName+")】UIM卡不能为空！");$("#uim_txt_"+ac.prodInstId).css("border-color","red");return false}var Y=false;$("[name='pay_type_-1']").each(function(){if($(this).val()!=undefined&&$(this).val()!=null&&$(this).val()!=""){Y=true}});if(!Y){$.alert("信息提示","没有配置付费类型，无法提交");return false}if(!order.main.templateTypeCheck()){return false}}}var aa=$("#acctSelect").val();if(aa==undefined||$.trim(aa)==""){$.alert("提示","请新建或者查询选择一个可用帐户");return false}if(aa<0){if(!o()){return false}}}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==2||OrderInfo.actionFlag==3||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){for(var V=0;V<AttachOffer.openList.length;V++){var X=AttachOffer.openList[V].specList;var U=OrderInfo.getOfferRoleName(AttachOffer.openList[V].prodId);for(var S=0;S<X.length;S++){var ab=X[S];if(ab.isdel!="Y"&&ab.isdel!="C"){if(ab.ifParams){if(ab.isset!="Y"){$.alert("提示",U+" "+ab.offerSpecName+"：参数未设置");return false}}}}}for(var V=0;V<AttachOffer.openServList.length;V++){var X=AttachOffer.openServList[V].servSpecList;var U=OrderInfo.getOfferRoleName(AttachOffer.openServList[V].prodId);for(var S=0;S<X.length;S++){var ab=X[S];if(ab.isdel!="Y"&&ab.isdel!="C"){if(ab.ifParams=="Y"){if(ab.isset!="Y"){$.alert("提示",U+" "+ab.servSpecName+"：参数未设置");return false}}}}}for(var V=0;V<AttachOffer.openList.length;V++){var X=AttachOffer.openList[V].specList;var W=AttachOffer.openList[V].prodId;var U=OrderInfo.getOfferRoleName(W);for(var S=0;S<X.length;S++){var ab=X[S];if(ab.isdel!="Y"&&ab.isdel!="C"){if(ab.isTerminal==1){var Y=true;$.each(OrderInfo.attach2Coupons,function(){if(ab.offerSpecId==this.attachSepcId&&W==this.prodId){Y=false;return false}});if(Y){$.alert("提示",U+" "+ab.offerSpecName+"：终端信息未填写");return false}}}}}}if(OrderInfo.actionFlag==2){for(var V=0;V<OrderInfo.offer.offerMemberInfos.length;V++){var T=OrderInfo.offer.offerMemberInfos[V];if(T.objType==CONST.OBJ_TYPE.PROD){if(T.prodClass==CONST.PROD_CLASS.THREE&&CONST.getAppDesc()==0&&OrderInfo.offerSpec.is3G=="N"){var R=OrderInfo.getProdTd(T.objInstId);if(R==""){$.alert("提示",T.roleName+" UIM卡不能为空！");return false}}}}}if(OrderInfo.actionFlag==3){if(AttachOffer.isChangeUim==1&&CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.prodClass==CONST.PROD_CLASS.THREE){if(OrderInfo.boProd2Tds.length==0){$.alert("提示","UIM卡不能为空！");return false}}}if(OrderInfo.actionFlag==22){if(OrderInfo.boProd2Tds.length==0){$.alert("提示","UIM卡不能为空！");return false}}return true};var o=function(){if($.trim($("#acctName").val())==""){$.alert("提示","帐户名称不能为空");return false}if($("#paymentType").val()==110000){if($("#bankId").val()==""||$.trim($("#bankAcct").val())==""){$.alert("提示","若选择银行支付请填写必要的银行支付信息");return false}}if($("#postType").val()!=-1){if($.trim($("#postAddress").val())==""){$.alert("提示","若选择投递账单请填写必要的账单投递信息");return false}if($("#postType").val()==13){var Q=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;if(Q.test($("#postAddress").val())==false){$.alert("提示","若选择 Email 投递帐单请输入有效的 Email 地址");return false}}}return true};var b=function(){var T=[];for(var S=0;S<OrderInfo.boProdAns.length;S++){var R={accNbr:OrderInfo.boProdAns[S].accessNumber,accNbrType:1,action:"UPDATE"};T.push(R)}for(var S=0;S<OrderInfo.boProd2Tds.length;S++){var R={accNbr:OrderInfo.boProd2Tds[S].terminalCode,accNbrType:2,action:"UPDATE"};T.push(R)}if(T.length>0){var Q=contextPath+"/common/updateResState";$.callServiceAsJsonGet(Q,{strParam:JSON.stringify(T)},{done:function(U){if(U.code==0){if(U.data){}}}})}};var h=function(Q){if($("#isTemplateOrder").attr("checked")=="checked"){if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){$(".template_info_type").show()}$(".template_info_name").show()}else{$(".template_info_name").hide();$(".template_info_type").hide();$("#templateOrderName").val("")}};var p=function(T){var R=[];for(var Q=0;Q<T.offerRoles.length;Q++){var S=T.offerRoles[Q];if(S.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){R.push(S)}}for(var Q=0;Q<T.offerRoles.length;Q++){var S=T.offerRoles[Q];if(S.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){R.push(S)}}T.offerRoles=R;return T};return{builder:L,createAttOffer:A,createServ:K,delOrder:D,delAndNew:E,getOrderInfo:F,getToken:C,initFillPage:j,initOrderData:B,orderBack:v,step:z,showStep:M,submitOrder:s,checkAcctInfo:o,showTemplateOrderName:h,sortOfferSpec:p,updateResState:b,delOrderBegin:I,delOrderSilent:y,delOrderFin:u}})();CommonUtils.regNamespace("acct","acctModify");acct.acctModify=(function(){var l={};var c={};var f={};var i=function(){var s=order.prodModify.getCallRuleParam(CONST.BO_ACTION_TYPE.ACCTINFOMODIFY,order.prodModify.choosedProdInfo.prodInstId);var q={boActionTypeCd:CONST.BO_ACTION_TYPE.ACCTINFOMODIFY,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ACCTINFOMODIFY),accessNumber:order.prodModify.choosedProdInfo.accNbr,prodOfferName:order.prodModify.choosedProdInfo.prodOfferName};var r=rule.rule.prepare(s,"acct.acctModify.acctInfoModify",q);if(r){return}OrderInfo.initData(CONST.ACTION_CLASS_CD.ACCT_ACTION,CONST.BO_ACTION_TYPE.ACCTINFOMODIFY,10,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ACCTINFOMODIFY),"")};var j=function(){if(!order.prodModify.choosedProdInfo.prodInstId||!order.prodModify.choosedProdInfo.accNbr){$.alert("提示","产品信息定位异常，请联系管理员");$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}var q={prodId:order.prodModify.choosedProdInfo.prodInstId,acctNbr:order.prodModify.choosedProdInfo.accNbr};$.callServiceAsHtml(contextPath+"/order/prodModify/acctInfoModify",q,{before:function(){$.ecOverlay("<strong>正在确认当前产品帐户,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(r){if(r.code!=0){$.alert("提示","无法确认当前产品帐户，请联系管理员");$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}$("#order_fill_content").html(r.data).show();$(".h2_title").append(order.prodModify.choosedProdInfo.productName+"-"+order.prodModify.choosedProdInfo.accNbr);h("#acctInfoList tr",$("#acctInfoList").children(":first-child"));$("#acctInfoList tr").each(function(){$(this).off("click").on("click",function(s){h("#acctInfoList tr",this);s.stopPropagation()})});$("#fillLastStep").click(function(){order.prodModify.cancel()})}})};var h=function(q,u){$(q).removeClass("plan_select");$(q).children(":first-child").html("");$(u).addClass("plan_select");$(u).children(":first").html("<i class='select'></i>");var w={acctId:u.attr("id")};var r=$.callServiceAsHtml(contextPath+"/order/prodModify/queryAcctDetailInfo",w);if(r.code!=0){$("#acctInfoDetail").html("账户信息加载失败").show();return}$("#acctInfoDetail").html(r.data).show();p();var s=$("#postType option:not(:first)");$.each(s,function(x,y){if($(y).val()==$("#postType option:first").val()){$(y).remove();return false}});var t=$("#billContent option:not(:first)");$.each(t,function(y,x){if($(x).val()==$("#billContent option:first").val()){$(x).remove();return false}});var v=$("#postCycle option:not(:first)");$.each(v,function(y,x){if($(x).val()==$("#postCycle option:first").val()){$(x).remove();return false}});o();k();if($("#billContent").val()==14){$("#receipt").show()}l={acctCd:$("#acctInfoList .plan_select td:eq(0)").attr("id"),acctName:$("#acctName").val(),acctTypeCd:"1",partyId:$("#partyId").val(),prodId:order.prodModify.choosedProdInfo.prodInstId,state:"DEL"};c={bankAcct:$("#bankAcct").val(),bankId:$("#bankId").val(),limitQty:"1",paymentAcctTypeCd:$("#paymentType").val(),paymentAccountId:$("#paymentType").attr("name"),paymentMan:$("#paymentMan").val(),state:"DEL"};
if($("#postType").val()!=-1){f={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"DEL"};if($("#postType").val()==11||$("#postType").val()==15){f.param1=$("#postAddress").val()+","+$("#zipCode").val()+","+$("#consignee").val()}}else{f={}}};var p=function(s){var r={CONFIG_PARAM_TYPE:"BILL_POST"};var q=contextPath+"/order/queryApConf";var t=$.callServiceAsJsonGet(q,r);if(t.code==0&&t.data){for(var u=0;u<t.data.length;u++){if(t.data[u].BILL_POST_TYPE){$.each(t.data[u].BILL_POST_TYPE,function(v,w){$("<option>").attr("value",w.COLUMN_VALUE).text(w.COLUMN_VALUE_NAME).appendTo($("#postType"))})}else{if(t.data[u].BILL_POST_CONTENT){$.each(t.data[u].BILL_POST_CONTENT,function(w,v){$("<option>").attr("value",v.COLUMN_VALUE).text(v.COLUMN_VALUE_NAME).appendTo($("#billContent"))})}else{if(t.data[u].BILL_POST_CYCLE){$.each(t.data[u].BILL_POST_CYCLE,function(w,v){$("<option>").attr("value",v.COLUMN_VALUE).text(v.COLUMN_VALUE_NAME).appendTo($("#postCycle"))})}}}}if(s){s()}}};var o=function(){if($("#paymentType").val()==100000){$(".bank").hide();$("#paymentType").parent().addClass("full")}else{$(".bank").show();$("#paymentType").parent().removeClass("full")}};var k=function(){if($("#postType").val()==-1){$(".billPost").hide();$("#postType").parent().addClass("full");$("#billContent").find("option[value=11]").attr("selected","selected");$("#postType").find("option[value=12]").show();$("#postType").find("option[value=13]").show();$("#postType").find("option[value=14]").show();$("#receipt").hide()}else{$(".billPost").show();$("#postType").parent().removeClass("full");if($("#postType").val()==12){$("#postAddress").attr("placeHolder","请输入有效的传真号码")}else{if($("#postType").val()==13){$("#postAddress").attr("placeHolder","请输入有效的Email地址")}else{if($("#postType").val()==14){$("#postAddress").attr("placeHolder","请输入有效的手机号")}else{$("#postAddress").attr("placeHolder","请输入准确的收件地址")}}}}};var g=function(){if($("#billContent").val()==14){if($("#postType").val()==12||$("#postType").val()==13||$("#postType").val()==14){$("#postType").find("option[value=11]").attr("selected","selected");$("#postAddress").val("");$("#postAddress").attr("placeHolder","请输入准确的收件地址")}$("#postType").find("option[value=12]").hide();$("#postType").find("option[value=13]").hide();$("#postType").find("option[value=14]").hide();$("#receipt").fadeIn("slow")}else{$("#postType").find("option[value=12]").show();$("#postType").find("option[value=13]").show();$("#postType").find("option[value=14]").show();$("#receipt").fadeOut("slow")}};var a=function(){order.area.chooseAreaTreeAll("p_bank_areaId_val","p_bank_areaId",3)};var b=function(r){var q;var s=1;if(r==0){q={name:"",bankId:"",simpleSpell:"",commonRegionId:""}}if(r>0){s=r;q={name:$("#p_bandkname").val(),bankId:"",simpleSpell:$("#p_simpleSpell").val(),commonRegionId:$("#p_bank_areaId").val()}}var t={bank:q,curPage:s,pageSize:10};$.callServiceAsHtml(contextPath+"/acct/getBankList",t,{before:function(){$.ecOverlay("<strong>银行查询中,请稍等....</strong>")},always:function(){$.unecOverlay()},done:function(u){if(!u){u.data=""}$("#div_bank_dialog").html(u.data);$("#bank_list tr").each(function(){$(this).off("click").on("click",function(v){m("#bank_list tr",this);v.stopPropagation()})});easyDialog.open({container:"div_bank_dialog"})}})};var m=function(q,r){$(q).removeClass("plan_select");$(q).children(":first-child").html("");$(r).addClass("plan_select");$(r).children(":first").html("<i class='select'></i>")};var n=function(){var q=$("#bank_list .plan_select");$("#bankId").val($(q).attr("id"));$("#bankName").val($(q).find("td:eq(2)").text());if(q.length>0){easyDialog.close()}else{$.alert("操作提示","请选择银行！")}};var d=function(){if(!SoOrder.checkAcctInfo()){return}var u={areaId:OrderInfo.staff.areaId,boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.ACCT_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACCTINFOMODIFY},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:$("#acctInfoList .plan_select").attr("id"),isComp:"N",objId:"",offerTypeCd:"1"},busiOrderInfo:{seq:OrderInfo.SEQ.seq--},data:{boAccountInfos:[],boAcct2PaymentAccts:[],boAccountItems:[],boPaymentAccounts:[],boAccountMailings:[]}};var t={acctCd:$("#acctInfoList .plan_select td:eq(0)").attr("id"),acctName:$("#acctName").val(),acctTypeCd:"1",partyId:$("#partyId").val(),prodId:order.prodModify.choosedProdInfo.prodInstId,state:"ADD"};u.data.boAccountInfos.push(l);u.data.boAccountInfos.push(t);var v={priority:"1",paymentAccountId:$("#paymentType").attr("name"),state:"ADD"};u.data.boAcct2PaymentAccts.push(v);var q={bankAcct:"",bankId:"",limitQty:"1",paymentAcctTypeCd:$("#paymentType").val(),paymentAccountId:$("#paymentType").attr("name"),paymentMan:"",state:"ADD"};if($("#paymentType").val()==110000){q.bankAcct=$("#bankAcct").val();q.bankId=$("#bankId").val();q.paymentMan=$("#paymentMan").val()}u.data.boPaymentAccounts.push(c);u.data.boPaymentAccounts.push(q);if(f.mailingType){u.data.boAccountMailings.push(f)}if($("#postType").val()!=-1){var s={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"ADD"};if($("#postType").val()==11||$("#postType").val()==15){s.param1=$("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val()}u.data.boAccountMailings.push(s)}var r=[];r.push(u);SoOrder.submitOrder(r)};return{showAcctInfoModify:i,acctInfoModify:j,getBILL_POST:p,paymentType:o,billPostType:k,billContent:g,queryAllArea:a,queryBank:b,fillBankInfo:n,acctInfoModify_Submit:d}})();CommonUtils.regNamespace("account","query");account.query=(function(){var f="";var b=function(){order.area.chooseAreaTreeManger("acct/preQueryAccount","p_areaId_val","p_areaId",3)};var i=function(){if($("#p_areaId_val").val()==""){$.alert("提示","请先选择所属地区再进行客户查询");return}easyDialog.open({container:"d_cust"});$("#cust").val("");$("#custlist").html("");$(".easyDialogclose").click(function(){easyDialog.close()})};var m=function(){var n={attrSpecCode:"PTY-0004"};$.callServiceAsJson(contextPath+"/staffMgr/getCTGMainData",n,{done:function(p){if(p.code==0){var r=p.data;if(r!=undefined&&r.length>0){for(var q=0;q<r.length;q++){var o=r[q];$("#cust_id_type").append("<option value='"+o.attrValueCode+"' >"+o.attrValueName+"</option>")}}}else{if(p.code==-2){$.alertM(p.data);return}else{$.alert("提示","调用主数据接口失败！");return}}}})};var l=function(o){var n=$(o).val();if(n==0){$("#cust").attr("placeHolder","请输入有效的中国电信手机号");$("#cust").attr("data-validate","validate(isTelecomSection:请输入有效的中国电信号码) on(blur)")}else{if(n==1){$("#cust").attr("placeHolder","请输入合法的身份证号码");$("#cust").attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(blur)")}else{if(n==2){$("#cust").attr("placeHolder","请输入合法的军官证");$("#cust").attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(n==3){$("#cust").attr("placeHolder","请输入合法的护照");$("#cust").attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#cust").attr("placeHolder","请输入合法的证件号码");$("#cust").attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}}$("#cust").val("");c()};var c=function(){$("#custQueryForm").off().bind("formIsValid",function(r,q){var n="";var p="";var o="";if($("#cust_id_type").val()==0){n=$("#cust").val()}else{o=$("#cust_id_type").val();p=$("#cust").val()}var s={acctNbr:n,identityCd:o,identityNum:p,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:"maybe",areaId:$("#p_areaId").val(),query:"acct"};$.callServiceAsHtml(contextPath+"/cust/queryCust",s,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(t){if(t.code!=0){$.alert("提示","查询失败,稍后重试");return}if(t.data=="false\r\n"){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}$("#custlist").html(t.data).show()},fail:function(t){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")}})}).ketchup({bindElement:"bt_cust_query"})};var j=function(o){var p=$(o).find("td:eq(0)").text();var n=$(o).find("td:eq(3)").text();
$("#custName").val(p).attr("name",n);easyDialog.close()};var h=function(){$("#custName").val("").removeAttr("name")};var a=function(n){if($(n).val()==1){$("#num").attr("placeHolder","请输入有效的中国电信手机号")}else{$("#num").attr("placeHolder","请输入帐户合同号")}};var k=function(){if($("#p_areaId_val").val()==""){$.alert("提示","请选择所属地区");return}var o=$.trim($("#num").val());if($("#custName").val()==""&&o==""){$.alert("提示","请至少再输入以下一个查询条件：所属客户，接入号，合同号");return}if(o!=""){if($("#query_type").val()==1){var n=/^(180|189|133|134|153|181|108|170|177)\d{8}$/.test(o);if(n==false){$.alert("提示","请输入有效的中国电信手机号");return}}}var p={areaId:$("#p_areaId").val()};if($("#custName").val()!=""){p.custId=$("#custName").attr("name")}if(o!=""){if($("#query_type").val()==1){p.accessNumber=o}else{p.acctCd=o}}$.callServiceAsHtmlGet(contextPath+"/acct/queryAccount",p,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(q){if(!q){q.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(q.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(q.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctList").html(q.data).show();$("#acctDetail").hide()},fail:function(q){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var g=function(n){var o={acctId:n,areaId:$("#p_areaId").val()};$.callServiceAsHtmlGet(contextPath+"/acct/queryAcctDetail",o,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(p){if(!p){p.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(p.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(p.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctDetail").html(p.data).show();$("#acctList").hide()},fail:function(p){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var d=function(){$("#acctDetail").hide();$("#acctList").show()};return{areaId:f,chooseArea:b,showQueryCust:i,initCustIdType:m,changeCustIdType:l,queryCust:c,chooseCust:j,resetCust:h,changeQueryType:a,queryAccount:k,queryAcctDetail:g,back:d}})();$(function(){account.query.initCustIdType();account.query.queryCust()});CommonUtils.regNamespace("order","cust");order.cust=(function(){var a={};var O={};var x=null;var F=null;var m=[];var B="";var K=[];var p=[];var z=function(){return x};var y="";var H=function(){$("#custAuthForm").bind("formIsValid",function(U,T){var V=a;V.prodPwd=$.trim($("#authPassword").val());V.accessNumber=a.accessNumber;V.authFlag=F;$.callServiceAsHtml(contextPath+"/cust/custAuth",V,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(W){if(W.code==-2){return}if(W.data=="false\r\n"){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}try{var Y=$.parseJSON(W.data);$.alertMore("异常信息",Y.resultMsg,Y.errorStack,"error");return}catch(X){}x=V;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;u(W)},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"custAuthbtn"});$("#useraddclose").off("click").on("click",function(T){easyDialog.close();$("#cCustName").val("");$("#cCustIdCard").val("");F="";if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}});$("#custresetBtn").off("click").on("click",function(T){if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}$("#btncustreset").click()})};var q=function(U){var T=$(U).val();$("#identidiesTypeCd").empty();j(T);g($("#identidiesTypeCd").children(":first-child"));t()};var j=function(Z){var Y={partyTypeCd:Z};var U=contextPath+"/cust/queryCertType";var T=$.callServiceAsJson(U,Y,{});if(T.code==-2){$.alertM(T.data)}if(T.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(T.code==0){var X=T.data;if(X!=undefined&&X.length>0){for(var V=0;V<X.length;V++){var W=X[V];$("#identidiesTypeCd").append("<option value='"+W.certTypeCd+"' >"+W.name+"</option>")}}}};var J=function(T){var U=$(T).val();if(U==-1){$("#p_cust_identityNum").attr("placeHolder","请输入合法的接入号码");$("#p_cust_identityNum").attr("data-validate","validate(required:请准确填写接入号码) on(keyup)")}else{if(U==1){$("#p_cust_identityNum").attr("placeHolder","请输入合法的身份证号码");$("#p_cust_identityNum").attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(keyup)")}else{if(U==2){$("#p_cust_identityNum").attr("placeHolder","请输入合法的军官证");$("#p_cust_identityNum").attr("data-validate","validate(required:请准确填写军官证) on(keyup)")}else{if(U==3){$("#p_cust_identityNum").attr("placeHolder","请输入合法的护照");$("#p_cust_identityNum").attr("data-validate","validate(required:请准确填写护照) on(keyup)")}else{$("#p_cust_identityNum").attr("placeHolder","请输入合法的证件号码");$("#p_cust_identityNum").attr("data-validate","validate(required:请准确填写证件号码) on(keyup)")}}}}if(U!=-1){$("#isAppointNum").attr("checked",false)}f()};var g=function(T){var U=$(T).val();if(U==1){$("#cCustIdCard").attr("placeHolder","请输入合法身份证号码");$("#cCustIdCard").attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(U==2){$("#cCustIdCard").attr("placeHolder","请输入合法军官证");$("#cCustIdCard").attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(U==3){$("#cCustIdCard").attr("placeHolder","请输入合法护照");$("#cCustIdCard").attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#cCustIdCard").attr("placeHolder","请输入合法证件号码");$("#cCustIdCard").attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}t()};var f=function(){$("#custQueryFirstForm").off().bind("formIsValid",function(U,W){var ac="";var ab="";var V="";var T="";var Z="";var Y="";var aa="";ac=$("#p_cust_identityCd").val();Z=$.trim($("#p_cust_identityNum").val());if(ac!=-1){ac=$("#p_cust_identityCd").val();F="1"}else{F="0"}if(ac==-1){T=Z;Z="";ac=""}else{if(ac=="acctCd"||ac=="custNumber"){T="";Z="";ac="";Y=$("#p_cust_identityCd").val();aa=$.trim($("#p_cust_identityNum").val())}}V=$("#DiffPlaceFlag").val();areaId=$("#p_cust_areaId").val();var X={acctNbr:T,identityCd:ac,identityNum:Z,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:V,areaId:areaId,queryType:Y,queryTypeValue:aa};$.callServiceAsHtml(contextPath+"/cust/queryCust",X,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(ad){if(ad.code==-2){return}P(ad)},fail:function(ad){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})}).ketchup({bindElement:"usersearchbtn"})};var t=function(){$("#custCreateForm").off().bind("formIsValid",function(T){k()}).ketchup({bindElement:"createcustsussbtn"})};var P=function(T){if(T.data=="false\r\n"){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}var U=$("#custList");U.html(T.data).show();$(".userclose").off("click").on("click",function(V){F="";$(".usersearchcon").hide()});if($("#custListTable").attr("custInfoSize")=="1"){$(".usersearchcon").hide()}};var E=function(){if(0!=OrderInfo.order.step){window.location.reload()}$("#custQryDiv").show();$("#custInfo").hide();$("#p_cust_identityNum").val("");$("#authPassword").val("");F="";OrderInfo.boCusts.partyId="";OrderInfo.boCustInfos.name="";OrderInfo.boCustIdentities.identityNum="";OrderInfo.cust={custId:-1,custName:"",areaId:""};OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId="";OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.cust="";order.cust.orderBtnflag="";OrderInfo.order.step=0;if((CONST.getAppDesc()!=0)&&($("#custModifyId").is(":hidden"))){$("#custModifyId").show()}};var n=function(T){var U=a;U.prodPwd=$.trim($("#authPassword").val());U.authFlag=F;$.callServiceAsHtml(contextPath+"/cust/custAuth",U,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(V){if(V.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}x=U;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";
OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;u(V)},always:function(){$.unecOverlay()}})};var L=function(){var T=a;T.authFlag="1";$.callServiceAsHtml(contextPath+"/cust/custAuth",T,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(U){if(U.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}x=T;OrderInfo.boCusts.prodId=-1;OrderInfo.boCusts.partyId=a.custId;OrderInfo.boCusts.partyProductRelaRoleCd="0";OrderInfo.boCusts.state="ADD";OrderInfo.boCusts.norTaxPayer=a.norTaxPayer;OrderInfo.cust=a;u(U)},always:function(){$.unecOverlay()}})};var u=function(T){if(F=="0"){easyDialog.close()}$("#custList").hide();$("#custQryDiv").hide();if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}var U=$("#custInfo");U.html(T.data).show();if((OrderInfo.boCusts.partyId!="-1"&&OrderInfo.boCusts.partyId!=""&&OrderInfo.boCusts.partyId!=undefined)&&order.prodModify.lteFlag==true){$("#custModifyId").attr("style","display: none;")}else{$("#custModifyId").attr("style","")}$("#cCustName").val("");$("#cCustIdCard").val("");main.home.hideMainIco()};var b=function(T){a={custId:$(T).find("td:eq(3)").text(),partyName:$(T).find("td:eq(0)").text(),idCardNumber:$(T).find("td:eq(4)").text(),identityName:$(T).attr("identityName"),areaName:$(T).attr("areaName"),areaId:$(T).attr("areaId"),identityCd:$(T).attr("identityCd"),addressStr:$(T).attr("addressStr"),norTaxPayer:$(T).attr("norTaxPayer"),segmentId:$(T).attr("segmentId"),segmentName:$(T).attr("segmentName")};if(F=="0"){easyDialog.open({container:"auth"});if(order.cust.jumpAuthflag=="0"){$("#jumpAuth").show()}$("#authClose").off("click").on("click",function(U){easyDialog.close();$("#authPassword").val("")})}else{n(T)}};var w=function(T){tabProfileFlag="1";q($("#partyTypeCd").children(":first-child"));g($("#identidiesTypeCd").children(":first-child"));t();v();$("#partyProfile").attr("style","display:none");easyDialog.open({container:"user_add"})};var N=function(U){var V={};if(a==null){V.custId=""}else{V.custId=a.custId;V.areaId=$("#area").attr("areaId")}if(document.getElementById("accNbrQuery")){V.acctNbr=$.trim($("#accNbrQuery").val())}else{if($("#isAppointNum").attr("checked")=="checked"){V.acctNbr=$.trim($("#p_cust_identityNum").val())}else{V.acctNbr=""}}if(document.getElementById("custPageSize")){V.pageSize=$.trim($("#custPageSize").val());if(!(/^[1-9]\d*$/.test(V.pageSize))&&(V.pageSize!="")){$.alert("提示信息","页码格式不正确，必须为有效数字。");return false}if(V.pageSize>15){$.alert("提示信息","页数大小不能超过15。");return false}}else{V.pageSize=""}V.curPage=U;V.DiffPlaceFlag=$("#DiffPlaceFlag").val();if(V.custId==null||V.custId==""){$.alert("提示","无法查询已订购产品");return}var T=contextPath+"/cust/orderprod";$.callServiceAsHtmlGet(T,V,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(W){if(!W){W.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(W.code==-2){return}else{if(W.code!=0){$.alert("提示","查询失败,稍后重试");return}}var X=$("#orderedprod");X.html(W.data);$("#phoneNumListtbody tr").off("click").on("click",function(Y){var Z=this;if(1==OrderInfo.order.step&&(!$(Z).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){r();c(Z);OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(Z).hasClass("plan_select"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();r();c(Z);OrderInfo.order.step=0},no:function(){null}})}else{c(this)}}});$("#plan2ndDiv tbody tr").each(function(){$(this).off("click").on("click",function(Z){var Y=this;if(1==OrderInfo.order.step&&(!$(Y).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{yes:function(){r();order.cust.linkSelectPlan(Y);Z.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{if(2==OrderInfo.order.step&&(!$(Y).hasClass("plan_select2"))){$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{yes:function(){SoOrder.orderBack();r();order.cust.linkSelectPlan(Y);Z.stopPropagation();OrderInfo.order.step=0},no:function(){null}})}else{order.cust.linkSelectPlan(this);Z.stopPropagation()}}})});$("#phoneNumListtbody").children(":first-child").next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click();$("#phoneNumListtbody").children(":first-child").click()}})};var c=function(U){$("#is3GCheckbox").off().change(function(){order.prodModify.getChooseProdInfo()});$("#phoneNumListtbody tr").filter(".plan_select").children(":first-child").html("");$("#phoneNumListtbody tr").filter(".plan_select").removeClass("plan_select").next("#plan2ndTr").hide();$(U).addClass("plan_select").next("#plan2ndTr").show();var T="<i class='select'></i>";$(U).children(":first-child").html(T);$(U).next("#plan2ndTr").find("#plan2ndDiv tbody tr:first").click()};var o=function(U){$("#plan2ndDiv tbody tr").removeClass("plan_select2");$("#plan2ndDiv tbody tr").children(":first-child").next().html("");$(U).addClass("plan_select2");var T="<i class='select'></i>";$(U).children(":first-child").next().html(T);order.prodModify.getChooseProdInfo()};var R=function(U){if(OrderInfo.cust.custId==-1){$.alert("提示","新建客户无法查询已订购产品！");return}var T=1;$("#prodDetail").hide();$("#prodInfo").hide();$("#prodList").show();$("#orderContent").show();if(order.cust.orderBtnflag==""){main.home.hideMainIco();N(T);$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{if(order.cust.orderBtnflag=="0"||$("#orderedprod").is(":hidden")){$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup");$(".main_div.location .s_title").css("border-bottom","0px solid #4f7d3f");$("#orderbutton").css({height:"35px","border-bottom":"1px solid #fff"});$("#orderbutton span").css({color:"#327501"});order.cust.orderBtnflag="1"}else{$("#orderedprod").hide();$("#arroworder").removeClass();$("#arroworder").addClass("arrow");order.cust.orderBtnflag="0";$("#orderbutton").css({height:"24px","border-bottom":"1px solid #4f7d3f"})}}};var A=function(){order.area.chooseAreaTree("order/prepare","p_cust_areaId_val","p_cust_areaId",3)};var C=function(){order.area.chooseAreaTreeManger("cust/preQueryCust","p_areaId_val","p_areaId",3)};var Q=function(){order.area.chooseAreaTreeAll("p_cust_areaId_val","p_cust_areaId",3)};var d=function(){order.area.chooseAreaTree("order/prepare","p_ncust_areaId_val","p_ncust_areaId",3)};var D=function(){order.area.chooseAreaTree("order/prepare","prodareaName","prodareaid",3);order.prodModify.choosedProdInfo.areaId=$("#prodareaid").val()};var h=function(){var T={attrSpecCode:"PTY-0004"};$.callServiceAsJson(contextPath+"/staffMgr/getCTGMainData",T,{done:function(V){if(V.code==0){var X=V.data;if(X!=undefined&&X.length>0){for(var W=0;W<X.length;W++){var U=X[W];$("#p_cust_identityCd").append("<option value='"+U.attrValueCode+"' >"+U.attrValueName+"</option>")}}}else{if(V.code==-2){$.alertM(V.data);return}else{$.alert("提示","调用主数据接口失败！");return}}}});J($("#p_cust_identityCd").children(":first-child"))};var v=function(){var T={};$.callServiceAsHtmlGet(contextPath+"/cust/partyProfileSpecList",T,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(U){if(U.code==-2){return}$("#partyProfile").html(U.data)}})};var s=function(){if($("#partyProfile").is(":hidden")){$("#partyProfile").show();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrowup");order.cust.changeLabel(0)}else{$("#partyProfile").hide();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrow");$("#tabProfile0").attr("click","1");$("#contactName").attr("data-validate","");t()}};var i=function(){var V="";var T="";var U="";V=$("#p_cust_identityCd").val();
U=$.trim($("#p_cust_identityNum").val());if(U==""){$.alert("提示","请输入证件号码！");return}if(V==1){V=$("#p_cust_identityCd").val()}if(V==-1){T=U;U="";V=""}diffPlace=$("#DiffPlaceFlag").val();areaId=$("#p_areaId").val();var W={acctNbr:T,identityCd:V,identityNum:U,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:areaId};$.callServiceAsHtmlGet(contextPath+"/cust/queryCustAlone",W,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(X){if(X.code==-2){return}if(!X){X.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(X.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(X.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctList").html(X.data).show();$("#acctDetail").hide()},fail:function(X){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var l=function(U){var T={partyId:U,areaId:$("#p_areaId").val()};$.callServiceAsHtml(contextPath+"/cust/custInfo",T,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(V){if(V.code==-2){return}if(!V){V.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(V.data=="fail\r\n"){$.alert("提示","查询失败，请稍后再试");return}if(V.data=="error\r\n"){$.alert("提示","数据异常，请联系管理员");return}$("#acctDetail").html(V.data).show();$("#acctList").hide()},fail:function(V){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var I=function(T){var U={};U.partyName=OrderInfo.cust.partyName;U.custId=OrderInfo.cust.custId;U.idCardNumber=OrderInfo.cust.idCardNumber;$.callServiceAsHtml(contextPath+"/cust/mvnoCustCreate",U,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(V){if(V.code==-2){return}var W=$("#order_fill_content");W.html(V.data).show();q($("#cmPartyTypeCd").children(":first-child"));g($("#div_cm_identidiesType").children(":first-child"));$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();$("#step1").show();$(".ordercon a:first span").text("取 消");_form_custInfomodify_btn()},always:function(){$.unecOverlay()}})};var G=function(){O={cAreaId:$("#p_ncust_areaId").val(),cAreaName:$("#p_ncust_areaId_val").val(),cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cPartyTypeName:($.trim($("#partyTypeCd  option:selected").val())==1)?"个人客户":"政企客户",cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};var T={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$("#headFlag  option:selected").val(),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postcode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};OrderInfo.boCustInfos.name=O.cCustName;OrderInfo.boCustInfos.areaId=O.cAreaId;OrderInfo.boCustInfos.partyTypeCd=O.cPartyTypeCd;OrderInfo.boCustInfos.defaultIdType=O.cIdentidiesTypeCd;OrderInfo.boCustInfos.addressStr=O.cAddressStr;OrderInfo.boCustIdentities.identidiesTypeCd=O.cIdentidiesTypeCd;OrderInfo.boCustIdentities.identityNum=O.cCustIdCard;OrderInfo.boPartyContactInfo.contactAddress=T.contactAddress,OrderInfo.boPartyContactInfo.contactDesc=T.contactDesc,OrderInfo.boPartyContactInfo.contactEmployer=T.contactEmployer,OrderInfo.boPartyContactInfo.contactGender=T.contactGender,OrderInfo.boPartyContactInfo.contactId=T.contactId,OrderInfo.boPartyContactInfo.contactName=T.contactName,OrderInfo.boPartyContactInfo.contactType=T.contactType,OrderInfo.boPartyContactInfo.eMail=T.eMail,OrderInfo.boPartyContactInfo.fax=T.fax,OrderInfo.boPartyContactInfo.headFlag=T.headFlag,OrderInfo.boPartyContactInfo.homePhone=T.homePhone,OrderInfo.boPartyContactInfo.mobilePhone=T.mobilePhone,OrderInfo.boPartyContactInfo.officePhone=T.officePhone,OrderInfo.boPartyContactInfo.postAddress=T.postAddress,OrderInfo.boPartyContactInfo.postcode=T.postcode,OrderInfo.boPartyContactInfo.staffId=T.staffId,OrderInfo.boPartyContactInfo.state=T.state,OrderInfo.boPartyContactInfo.statusCd=T.statusCd;OrderInfo.cust={custId:-1,partyName:O.cCustName,areaId:O.cAreaId};OrderInfo.boCustProfiles=[];for(var U=0;U<order.cust.partyProfiles.length;U++){var W=order.cust.partyProfiles[U];var V=$("#"+W.attrId).val();if(""==V||undefined==V){V==$("#"+W.attrId+"option:selected").val()}var W={partyProfileCatgCd:W.attrId,profileValue:V,state:"ADD"};if(""!=V&&V!=undefined){OrderInfo.boCustProfiles.push(W)}}easyDialog.close();var X={};X.prodPwd="";X.accessNumber="";X.authFlag="1";F="";X.identityCd=O.cIdentidiesTypeCd;X.idCardNumber=O.cCustIdCard;X.partyName=O.cCustName;X.areaId=O.cAreaId;X.areaName=O.cAreaName;X.segmentName=O.cPartyTypeName;X.identityName=$("#identidiesTypeCd  option:selected").text();$.callServiceAsHtml(contextPath+"/cust/custAuth",X,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(Y){if(Y.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(Y.data=="false\r\n"){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}u(Y)},always:function(){$.unecOverlay()}})};var k=function(){O={cAreaId:$("#p_ncust_areaId").val(),cAreaName:$("#p_ncust_areaId_val").val(),cCustName:$.trim($("#cCustName").val()),cCustIdCard:$.trim($("#cCustIdCard").val()),cPartyTypeCd:$.trim($("#partyTypeCd  option:selected").val()),cIdentidiesTypeCd:$.trim($("#identidiesTypeCd  option:selected").val()),cAddressStr:$.trim($("#cAddressStr").val())};diffPlace=$("#DiffPlaceFlag").val();var W={acctNbr:"",identityCd:O.cIdentidiesTypeCd,identityNum:O.cCustIdCard,partyName:"",custQueryType:$("#custQueryType").val(),diffPlace:diffPlace,areaId:O.cAreaId};var U=contextPath+"/cust/checkIdentity";var T=$.callServiceAsJson(U,W,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")}});var V="";if(T.code==0){$.unecOverlay();$.confirm("确认","此证件号码已存在,是否确认新建?",{yes:function(){G()},no:function(){}})}else{$.unecOverlay();G()}};var M=function(V){if($("#partyProfile").is(":visible")==false){$("#partyProfile").show()}if(V=="0"){$("#tabProfile0").show();$("#cardtab_pro_0").addClass("setcon");$("#tabProfile0").attr("click","0");$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(blur)").attr("placeholder","请准确填写联系人名称");t()}else{if(($("#tabProfile0").attr("click")=="0")&&($("#contactName").val()=="")){$.alert("提示","联系人名称不能为空！","information");return}}for(var U=0;U<order.cust.profileTabLists.length;U++){var X=order.cust.profileTabLists[U];var T=X.tabProfileNum;var W=X.partyProfileCatgTypeCd;if(V==W){$("#"+T).show();$("#cardtab_pro_"+W).addClass("setcon");$("#tabProfile0").hide();$("#cardtab_pro_0").removeClass("setcon")}else{$("#"+T).hide();$("#cardtab_pro_"+W).removeClass("setcon")}}};var S=function(){if($("#p_cust_identityCd").val()!=-1){$.alert("提示","只能接入号码才能指定号码！","information");$("#isAppointNum").attr("checked",false);return}};var r=function(){var T=OrderInfo.boProd2Tds;if(T.length>0){for(var W=0;W<T.length;W++){var V={numType:2,numValue:T[W].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",V)}}var U=OrderInfo.boProdAns;if(U.length>0){for(var W=0;W<U.length;W++){if(U[W].idFlag){continue}var V={numType:1,numValue:U[W].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",V)}order.service.boProdAn={};order.phoneNumber.resetBoProdAn()}$("#order_fill_content").empty();order.prepare.hideStep();$("#orderedprod").show();
$("#order_prepare").show()};return{form_valid_init:H,showCustAuth:b,showCustCreate:w,custAuth:n,getCustInfo:z,custReset:E,btnQueryCustProd:N,btnQueryCustProdMore:R,jumpAuth:L,identidiesTypeCdChoose:g,custidentidiesTypeCdChoose:J,choosedCustInfo:a,partyTypeCdChoose:q,chooseArea:A,chooseAllArea:Q,newCustChooseArea:d,prodChooseArea:D,initDic:h,btnMoreProfile:s,partyProfiles:K,profileTabLists:p,queryCust:i,queryCustDetail:l,mvnoCustCreate:I,changeLabel:M,jumpAuthflag:B,orderBtnflag:y,custcreateButton:t,isAppointNum:S,preQueryCustChooseArea:C,linkSelectPlan:o}})();$(function(){order.cust.form_valid_init();order.cust.initDic()});CommonUtils.regNamespace("main","home");$(function(){});main.home=(function(){var m=function(){var p="";$.callServiceAsHtmlGet(contextPath+"/main/notice",p,{done:function(q){if(!q){q={};q.data='<li><a href="#" class="ft">暂无公告</a></li>'}$(".news").html(q.data);var s=document.getElementById("new"),r=true;s.innerHTML+=s.innerHTML;s.onmouseover=function(){r=false};s.onmouseout=function(){r=true};void function(){var t=s.scrollTop%41==0&&!r;if(!t){s.scrollTop==parseInt(s.scrollHeight/2)?s.scrollTop=0:s.scrollTop++}setTimeout(arguments.callee,s.scrollTop%41?10:3000)}()},fail:function(q){$.unecOverlay()}})};var d=function(){$.callServiceAsHtmlGet(contextPath+"/menu/mainshortcut",{done:function(p){$("#faster_ul").html(p.data).show()},fail:function(p){$.unecOverlay()}})};var n=function(){$(".allsort").removeClass("showme");$(".main_quick_div").css("display","none");$(".news").css("display","none");$(".homecon").css("width","100%").css("margin-left","0px");$("#div_main_index").removeClass("main_index").addClass("main_div")};var a=function(){$(".allsort").removeClass("showme");var p=$.callServiceAsJson(contextPath+"/staff/login/isLogin");if(p.code!=0){login.windowpub.alertLoginWindow(p.data);return}easyDialog.open({container:"q_menu_dialog"});main.home.getMyList();main.home.getLv1();$("#q_menuclose").click(function(){easyDialog.close();$(".allsort").addClass("showme");main.home.queryMainShortcut()})};var j=function(){var p={setShortcut:1};$.callServiceAsHtmlGet(contextPath+"/menu/mainshortcut",p,{always:function(){$.unecOverlay()},done:function(q){$("#shortcut_getmylist").html(q.data).show()},fail:function(q){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var i=function(){var p=contextPath+"/menu/inquireLv1";$.callServiceAsHtmlGet(p,{done:function(q){$("#parentslist").html(q.data).show();$("#first_level a:first").addClass("side_nav_hover");var r=$("#first_level").find("a[class=side_nav_hover]").attr("id");main.home.getLv2(r)}})};var b=function(p){$("#first_level").find("a[class=side_nav_hover]").removeClass();$("#first_level").find("a[id="+p+"]").addClass("side_nav_hover");main.home.getLv2(p)};var h=function(r){var p=contextPath+"/menu/inquireLv2";var q={parentId:r};$.callServiceAsHtmlGet(p,q,{before:function(){$.ecOverlay("<strong>菜单查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(s){if(s.data==""){$("#son_list").html("<font style='color:#FA3D03;'>您没有权限添加此菜单</font>").show()}else{$("#son_list").html(s.data).show();$("#shortcut_getmylist").find("li").each(function(){var u=$(this).attr("id");var t=$("#second_level").find("ul[id="+u+"]");if(t&&t.length>0){t.addClass("ul_sel").removeAttr("onclick").css("cursor","auto").find("a.close").show()}})}}})};var f=function(s,r){var p=contextPath+"/menu/inquireLv3";var q={grandParentId:s,parentId:r};$.callServiceAsHtmlGet(p,q,{before:function(){$.ecOverlay("<strong>菜单查询中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(t){if(t.data==""){$("#son_list").html("<font style='color:#FA3D03;'>您没有权限添加此菜单</font>").show()}else{$("#son_list").html(t.data).show();$("#shortcut_getmylist").find("li").each(function(){var v=$(this).attr("id");var u=$("#son_list").find("ul[id="+v+"]");if(u&&u.length>0){u.addClass("ul_sel").removeAttr("onclick").css("cursor","auto").find("a.close").show()}})}}})};var g=function(w,p){var u=$("#son_list").find("ul[id="+w+"]");var v=1;var r=$("#shortcut_getmylist");if(!p){var x=$("#shortcut_getmylist ul li");var t=r.find("li:last");if(x.length>=8){$.alert("提示","最多允许添加8个图标,请取消已选图标后再添加！");return}if(t.length>0){v=t.attr("disporder")/1+1}else{v=1}}else{v=$("#shortcut_getmylist").find("#"+w).index()+1}var q=contextPath+"/menu/setShortcut";var s={dispOrder:v,resourceId:w,actionType:"ADD"};$.callServiceAsJson(q,s,{before:function(){$.ecOverlay("添加中...")},always:function(){$.unecOverlay()},done:function(A){if(A.code==0){if(!p){u.addClass("ul_sel").removeAttr("onclick").css("cursor","auto").find("a.close").show();var z=c(u.clone());var y=r.find("ul").append(z.html()).find("#"+z.attr("id")).attr("disporder",v)}}else{if(A.code==-2){$.alertM(A.data)}}},fail:function(y){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};function c(p){p.find("a").remove();p.find("div").removeClass("ul_list_img").addClass("quick_top_ul_img");p.find("li").attr("id",p.attr("id")).attr("onclick","main.home.deleteShortcut("+p.attr("id")+")");return p}var l=function(s,q){var p=contextPath+"/menu/setShortcut";var r={resourceId:s,actionType:"DEL"};$.callServiceAsJson(p,r,{before:function(){$.ecOverlay("删除中...")},always:function(){$.unecOverlay()},done:function(t){if(t.code==0){var u=$("#son_list").find("#"+s);if(u&&u.length>0){u.removeClass("ul_sel").attr("onclick","main.home.addShortcut("+s+")").css("cursor","pointer").find("a.close").hide()}if(!q){}$("#shortcut_getmylist ul").find("li[id="+s+"]").remove()}else{if(t.code==-2){$.alertM(t.data)}}},fail:function(t){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};function k(p){$("#mktResTypeCd").val($("#"+p).attr("mktResTypeCd"));$("#mktResCd").val($("#"+p).attr("mktResCd"));$("#mktResId").val($("#"+p).attr("mktResId"));$("#brand").val($("#"+p).attr("brand"));$("#phoneType").val($("#"+p).attr("phoneType"));$("#phoneColor").val($("#"+p).attr("phoneColor"));$("#mktName").val($("#"+p).attr("mktName"));$("#mktPrice").val($("#"+p).attr("mktPrice"));$("#mktPicA").val($("#"+p).attr("mktPicA"));$("#oprepare_form").submit()}function o(p){$("#prodOfferId").val(p);$("#oprepare_form2").submit()}return{queryNotice:m,queryMainShortcut:d,getMyList:j,getLv1:i,getLv2:h,getLv3:f,createDialog:a,addShortcut:g,deleteShortcut:l,changeParent:b,gotoPrepare:k,gotoPrepare2:o,hideMainIco:n}})();CommonUtils.regNamespace("mktRes","terminal");mktRes.terminal=(function(h){var w="";var B=12;var x={};var l={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"cfsj",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false};_initBuyChk=function(){l={buyType:"lj",numFlag:false,numLevel:"0",hyFlag:false,hyType:"cfsj",hyOfferSpecId:0,hyOfferSpecName:"",hyOfferSpecQty:0,hyOfferSpecFt:0,hyOfferRoles:null,tsnFlag:false}};var s=function(){if("lj"==l.buyType){OrderInfo.actionFlag=13;h("#treaty").hide();h("#sel_number").hide();h("#lj").addClass("selectBoxTwoOn").removeClass("selectBoxTwo");h("#hy").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");if(l.tsnFlag){h("#purchaseTermA").removeClass("btna_g").addClass("btna_o")}}else{if("hy"==l.buyType){OrderInfo.actionFlag=14;h("#treaty").show();h("#sel_number").show();h("#lj").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");h("#hy").addClass("selectBoxTwoOn").removeClass("selectBoxTwo");if(l.numFlag&&l.hyFlag&&l.tsnFlag){h("#purchaseTermA").removeClass("btna_g").addClass("btna_o")}else{h("#purchaseTermA").removeClass("btna_o").addClass("btna_g")}if(l.hyFlag){if(l.hyType=="cfsj"){h("#cfsjA").addClass("selectBoxTwoOn").removeClass("selectBoxTwo")}else{h("#gjsfA").addClass("selectBoxTwoOn").removeClass("selectBoxTwo")}}else{h("#cfsjA,#gjsfA").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");h("#choosedOfferPlan").html("")}if(l.numFlag){h("#cNumA").addClass("selectBoxTwoOn").removeClass("selectBoxTwo")}else{h("#cNumA").addClass("selectBoxTwo").removeClass("selectBoxTwoOn");h("#choosedNumSpan").html("")}}}};var b=function(E,D){h("#choosedNumSpan").html(E);l.numFlag=true;l.numLevel=D;
s()};var n=function(){};var q=function(E){var D=contextPath+"/mktRes/terminal/list";var F=j(E);h.callServiceAsHtml(D,F,{before:function(){h.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){h.unecOverlay()},done:function(G){if(G.code!=0){h.alert("提示","<br/>查询失败,稍后重试");return}var H=h("#order_term_list");H.show();H.html(G.data).fadeIn()}})};var f=function(E,D){d(E,D);q(1)};var j=function(J){var D="";var L="";var K=h("#priceArea a[class='selected']");var H=K.attr("minPrice");var F=K.attr("maxPrice");var G=h("#commCond").val();if(h("#termManf_small").css("display")!="none"){D=h("#termManf_small a[class='selected']").attr("val")}if(h("#termManf_all").css("display")!="none"){D=h("#termManf_all a[class='selected']").attr("val")}D=ec.util.defaultStr(D);if(h("#phoneType_small").css("display")!="none"){L=h("#phoneType_small a[class='selected']").attr("val")}if(h("#phoneType_all").css("display")!="none"){L=h("#phoneType_all a[class='selected']").attr("val")}L=ec.util.defaultStr(L);H=ec.util.defaultStr(H);F=ec.util.defaultStr(F);G=ec.util.defaultStr(G);if(H!=""){H=parseInt(H)*100}if(F!=""){F=parseInt(F)*100}var E=[];if(D!=""&&D!="无限"){var I={attrId:CONST.TERMINAL_SPEC_ATTR_ID.BRAND,attrValue:D};E.push(I)}if(L!=""&&L!="无限"){var I={attrId:CONST.TERMINAL_SPEC_ATTR_ID.PHONE_TYPE,attrValue:L};E.push(I)}return{mktResCd:"",mktResName:G,mktResType:"",minPrice:H,maxPrice:F,pageInfo:{pageIndex:J,pageSize:B},attrList:E}};var d=function(E,D){h(E).removeClass("selected");h(D).addClass("selected")};var z=function(H,F,G,D){h("#commCond").val(D);h("#commCond").off("keydown").on("keydown",function(J){var I=document.all?window.event:J;if(I.keyCode==13){h("#btn_term_search").click()}});var E=false;h("#termManf_small a").each(function(){if(h(this).attr("val")==H){h(this).addClass("selected");E=true}else{h(this).removeClass("selected")}});if(!E){h("#termManf_all a").each(function(){if(h(this).attr("val")==H){h(this).addClass("selected")}else{h(this).removeClass("selected")}})}h("#priceArea a").removeClass("selected");h("#priceArea a[minPrice='"+F+"'][maxPrice='"+G+"']").addClass("selected")};var C=function(D){var I=D.data.length;var N;var F;var S;var L='<a href="javascript:void(0);" class="selected " val="">不限</a>';var M='<a href="javascript:void(0);" class="selected " val="">不限</a>';var J='<a href="javascript:void(0);" class="selected" minPrice="" maxPrice="">不限</a>';var G='<a href="javascript:void(0);" class="selected " val="">不限</a>';var K='<a href="javascript:void(0);" class="selected " val="">不限</a>';for(var U=0;U<I;U++){if(D.data[U].PHONE_BRAND){N=D.data[U].PHONE_BRAND;var H;if(N.length<=6){H=N.length}else{H=6}for(var T=0;T<H;T++){var R=(N[T].COLUMN_VALUE_NAME).replace(/\"/g,"");L=L+'<a href="javascript:void(0);" val='+R+">"+R+"</a>"}if(N.length>6){for(var P=0;P<N.length;P++){var R=(N[P].COLUMN_VALUE_NAME).replace(/\"/g,"");M=M+'<a href="javascript:void(0);" val='+R+">"+R+"</a>"}h("#termManfId_more").show();h("#termManfId_more").off("click").on("click",function(W){y("#termManf_all","#termManf_small");W.stopPropagation()});h("#termManfId_more").toggle(function(){h("#termManfId_more a").addClass("btn_less");h("#termManfId_more a").text("收起")},function(){h("#termManfId_more a").removeClass("btn_less");h("#termManfId_more a").text("展开")})}h("#termManf_small").html(L);h("#termManf_all").html(M);continue}}for(var U=0;U<I;U++){if(D.data[U].PHONE_PRICE_AREA){F=D.data[U].PHONE_PRICE_AREA;for(var T=0;T<F.length;T++){var E=(F[T].COLUMN_VALUE_NAME).replace(/\"/g,"");var O=E.split("-");if(O.length!=1){minPrice=O[0];maxPrice=O[1]}else{O=O.toString();minPrice=O.substring(0,O.length-2);maxPrice='""'}J=J+'<a href="javascript:void(0);" minPrice='+minPrice+" maxPrice="+maxPrice+">"+E+"</a>"}h("#priceArea").html(J);continue}}for(var U=0;U<I;U++){if(D.data[U].PHONE_TYPE){S=D.data[U].PHONE_TYPE;var Q;if(S.length<=6){Q=S.length}else{Q=6}for(var T=0;T<Q;T++){var V=(S[T].COLUMN_VALUE_NAME).replace(/\"/g,"");G=G+'<a href="javascript:void(0);" val='+V+">"+V+"</a>"}if(S.length>6){for(var P=0;P<S.length;P++){var V=(S[P].COLUMN_VALUE_NAME).replace(/\"/g,"");K=K+'<a href="javascript:void(0);" val='+V+">"+V+"</a>"}h("#phoneTypeId_more").show();h("#phoneTypeId_more").off("click").on("click",function(W){y("#phoneType_all","#phoneType_small");W.stopPropagation()})}h("#phoneType_small").html(G);h("#phoneType_all").html(K);continue}}h("#btn_term_search").off("click").on("click",function(W){q(1);W.stopPropagation()});h("#termManf_small a[val!='更多']").off("click").on("click",function(W){f("#termManf_small a[val!='更多']",this)});h("#termManf_all a[val!='更多']").off("click").on("click",function(W){f("#termManf_all a[val!='更多']",this)});h("#priceArea a").off("click").on("click",function(W){f("#priceArea a",this)});h("#phoneType_small a[val!='更多']").off("click").on("click",function(W){f("#phoneType_small a[val!='更多']",this)});h("#phoneType_all a[val!='更多']").off("click").on("click",function(W){f("#phoneType_all a[val!='更多']",this)})};var t=function(){var E={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var D=contextPath+"/order/queryApConf";h.callServiceAsJsonGet(D,E,{done:C})};var y=function(E,D){if(h(E).is(":hidden")){h(E).css("display","");h(D).css("display","none");h(D).parent("dl").css("overflow","auto")}else{h(E).css("display","none");h(D).css("display","");h(D).parent("dl").css("overflow","hidden")}};var m=function(E){var F={mktResTypeCd:h(E).attr("mktResTypeCd"),mktResCd:h(E).attr("mktResCd"),mktResId:h(E).attr("mktResId"),brand:h(E).attr("brand"),phoneType:h(E).attr("phoneType"),phoneColor:h(E).attr("phoneColor"),mktName:h(E).attr("mktName"),mktPrice:h(E).attr("mktPrice"),mktPicA:h(E).attr("mktPicA")};var D=contextPath+"/mktRes/terminal/detail";h.callServiceAsHtml(D,F,{before:function(){h.ecOverlay("<strong>在处理中,请稍等会儿....</strong>")},always:function(){h.unecOverlay()},done:function(H){if(!H){h.alert("提示","<br/>处理失败，请稍后重试！");return}if(H.code!=0){h.alert("提示","<br/>处理失败，请稍后重试！");return}var G=h("#order_term_detail");h("#order_tab_panel_terminal .order_tab_header").hide();h("#order_term_list").hide();G.show();G.html(H.data).fadeIn();h("#hy").click(function(){_initBuyChk();l.buyType="hy";s()});h("#lj").click(function(){_initBuyChk();l.buyType="lj";s()});h("#cNumA").click(function(){s();order.prepare.phoneNumDialog("terminal","Y1","01")});h("#cfsjA").click(function(){p(1)});h("#gjsfA").click(function(){p(2)});h("#chkTsnA").click(function(){u("tsn")});h("#purchaseTermA").click(function(){k()})}})};var p=function(D){h("#choosedOfferPlan").html("");l.hyFlag=false;if(D==1){l.hyType="cfsj"}else{l.hyType="gjsf"}s();if(!l.numFlag){h.alert("提示","请先选号！");return}ec.form.dialog.createDialog({id:"-gjhy",width:980,height:550,initCallBack:function(H,F){var G={mktResCd:h("#mktResId").val(),agreementType:D};var E=contextPath+"/mktRes/terminal/mktplan";h.callServiceAsHtmlGet(E,G,{before:function(){},always:function(){},done:function(I){mktRes.terminal.dialogForm=H;mktRes.terminal.dialog=F;if(!I){h.alert("提示","<br/>处理失败，请稍后重试！");return}if(I.code!=0){if(I.code==1006){h.alert("提示","<br/>查询不到，请稍后重试")}else{h.alert("提示","<br/>查询失败，请稍后重试")}if(mktRes.terminal.dialogForm!=undefined&&mktRes.terminal.dialog!=undefined){mktRes.terminal.dialogForm.close(mktRes.terminal.dialog)}return}h("#gjhyContent").html(I.data);h("#tab_content_0").show();h("#contract_nav_agreement li").off("click").on("click",function(J){g(this,h(this).attr("itemIndex"))});h("#phone_warp_id .contract_tab_content tr:gt(0)").off("click").on("click",function(J){r(this)});h("#hy_nav_confirm_a").off("click").on("click",function(J){o()})}})},submitCallBack:function(F,E){l.hyFlag=true},closeCallBack:function(G,E){s();var F=h("#gjhyContent");F.html("")}})};var g=function(D,E){if(h(D).hasClass("current")){return}h("#contract_nav_agreement li").removeClass("current");h("#tab_"+E).addClass("current");h(".contract_tab_content").hide();h("#tab_content_"+E).show()};var r=function(D){if(h(D).hasClass("plan_select")){h(D).removeClass("bg plan_select").next("#plan2ndTr").hide();return false
}h("#phone_warp_id .contract_tab_content tr").filter(".plan_select").removeClass("bg plan_select").next("#plan2ndTr").hide();h(D).addClass("bg").addClass("plan_select");var F=h(D).attr("offerSpecId");var E=h(D).attr("agreementType");a(D,F,E)};var a=function(E,K,G){var L=h(E).next("#plan2ndTr");if(L.length>0){L.show();return}var D=order.service.queryPackForTerm(K,G,"");if(typeof(D)=="undefined"||D==null){h.alert("提示","<br/>未查到套餐，请稍后再试！");return}if(D.code==-2){h.alertM(D.data);h.unecOverlay();return}if(D.code!=0||D.data.code!="POR-0000"){h.alert("提示","<br/>未查到合适套餐，请稍后再试！");return}var J="";J+="<tr id='plan2ndTr' class='nocolor'>";J+="<td class='nopadding' colspan='7'>";J+="<div id='plan2ndDiv' class='plan_second_list cashier_tr'>";J+="  <table class='contract_list'>";J+="  <thead>";J+="    <tr>";J+="      <td class='borderLTB'>&nbsp;</td><td>套餐名称</td><td>价格</td>";J+="      <td>流量</td><td>语音分钟数</td><td>WIFI时长</td><td>点对点短信</td>";J+="      <td>点对点彩信</td><td>套餐外流量</td><td>套餐外通话分钟数</td>";J+="    </tr>";J+="  </thead>";J+="  <tbody>";var I=D.data.prodOfferInfos;if(I.length==0){h.alert("提示","<br/>未查到套餐，请稍后再试！")}for(var F=0;F<I.length;F++){var H=I[F];J+="    <tr offerSpecId='"+H.offerSpecId+"' ";J+="   offerSpecName='"+H.offerSpecName+"' ";J+="   price='"+H.price+"' >";J+="      <td></td>";J+="      <td style='width:240px;'>"+ec.util.defaultStr(H.offerSpecName)+"</td>";J+="      <td>"+ec.util.defaultStr(H.price)+"</td>";var M="";if(H.inFlux>=1024){M=H.inFlux/1024+"G"}else{M=H.inFlux+"M"}J+="      <td>"+ec.util.defaultStr(M)+"</td>";J+="      <td>"+ec.util.defaultStr(H.inVoice)+"</td>";J+="      <td>"+ec.util.defaultStr(H.inWIFI)+"</td>";J+="      <td>"+ec.util.defaultStr(H.inSMS)+"</td>";J+="      <td>"+ec.util.defaultStr(H.inMMS)+"</td>";J+="      <td style='width:140px;'>"+ec.util.defaultStr(H.outFlux)+"</td>";J+="      <td>"+ec.util.defaultStr(H.outVoice)+"</td>";J+="    </tr>"}J+="  </tbody>";J+="  </table>";J+="</div>";J+="</td>";J+="</tr>";h(E).after(J);h("#plan2ndDiv tbody tr").off("click").on("click",function(N){i(this);N.stopPropagation()})};var i=function(F){h("#plan2ndDiv tbody tr").removeClass("plan_select2");h("#plan2ndDiv tbody tr").children(":first-child").html("");var G=h(F).attr("offerSpecId");var E=A(G,F);if(E){h(F).addClass("plan_select2");var D="<i class='terminalSelect'></i>";h(F).children(":first").html(D)}};var A=function(F,E){var D={price:h(E).attr("price"),id:"tcnum1",specId:F,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.areaId};order.service.opeSer(D);return true};var v=function(P,I){l.hyOfferSpecQty=0;l.hyOfferSpecFt=0;var K=h(I).data("__offerSpec");if(typeof(K)=="undefined"){var G={offerSpecId:Number(P)};var D=contextPath+"/order/queryOfferSpec";var H=h.callServiceAsJson(D,G);K=H.data.offerSpec;h(I).data("__offerSpec",K);if(typeof(H)=="undefined"||H==null){h.alert("提示","<br/>未查到销售品构成，请稍后再试！");return false}if(H.code!="0"||!H.isjson){h.alert("提示","<br/>未查到销售品构成，请稍后再试！");return false}if(H.data.code!="POR-0000"){h.alert("提示","<br/>未查到销售品构成，请稍后再试！");return false}}var F=SoOrder.sortOfferSpec(K);var L=F.offerRoles;l.hyOfferRoles=L;var J;var N=0;var M=0;for(J=0;J<L.length;J++){var O=L[J];if(CONST.MEMBER_ROLE_CD.VICE_CARD==L[J].memberRoleCd){if(O.roleObjs){h.each(O.roleObjs,function(){if(this.objType==2){N=this.maxQty<0?"不限制":this.maxQty;M=this.minQty<0?"0":this.minQty}})}}else{L[J].selectQty=1}}F.offerRoles=L;OrderInfo.offerSpec=F;l.hyOfferSpecFt=F.feeType;if(N==0){return true}var E=h("#termOfferSpecViceLi");E.find("input").val(M);E.find(".addinfo").html("&nbsp;&nbsp;&nbsp;"+M+"-"+N+"（张） ");E.find("a:first").off("click").on("click",function(R){var Q=parseInt(E.find("input").val());if(Q<=M){h.alert("提示","副卡数量已经达到最小值，不能再减少。");return}else{E.find("input").val(Q-1)}});E.find("a:last").off("click").on("click",function(R){var Q=parseInt(E.find("input").val());if(Q>=N){h.alert("提示","副卡数量已经达到最大值，不能再增加。");return}else{E.find("input").val(Q+1)}});easyDialog.open({container:"termOfferSpec"});h("#termOfferSpecClose").off("click").on("click",function(Q){easyDialog.close()});h("#termOfferSpecCancel").off("click").on("click",function(Q){easyDialog.close()});h("#termOfferSpecConfirm").off("click").on("click",function(R){var Q=E.find("input").val();l.hyOfferSpecQty=Q;for(J=0;J<L.length;J++){if(CONST.MEMBER_ROLE_CD.VICE_CARD==L[J].memberRoleCd){L[J].selectQty=Q}else{L[J].selectQty=1}}OrderInfo.offerSpec.offerRoles=L;easyDialog.close()});return true};var o=function(){var E=h("#plan2ndDiv tbody tr[class='plan_select2']");if(E.length!=1){h.alert("提示","请选择一个套餐！");return}var D=E.parents("#plan2ndTr").prev();if(D.length!=1){h.alert("提示","请选择一个合约！");return}mktRes.terminal.offerSpecId=D.attr("offerSpecId");l.hyFlag=true;l.hyOfferSpecId=E.attr("offerSpecId");l.hyOfferSpecName=E.attr("offerSpecName");s();h("#choosedOfferPlan").html(D.attr("offerSpecName"));if(mktRes.terminal.dialogForm!=undefined&&mktRes.terminal.dialog!=undefined){mktRes.terminal.dialogForm.close(mktRes.terminal.dialog)}};var c=function(H,K,D){var E={offerSpecId:K,prodId:H};var J=[];var I=AttachOffer.getSpecList(H);if(I!=undefined){for(var G=0;G<I.length;G++){if(I[G].offerSpecId!=K&&I[G].isdel!="Y"){J.push(I[G].offerSpecId)}}}var L=AttachOffer.getOfferList(H);if(L!=undefined){for(var G=0;G<L.length;G++){if(L[G].offerSpecId!=K&&L[G].isdel!="Y"){J.push(L[G].offerSpecId)}}}if(J.length>0){E.orderedOfferSpecIds=J}var F=h.callServiceAsJsonGet(contextPath+"/offer/queryExcludeDepend",{strParam:JSON.stringify(E)},{});if(F.code==0){AttachOffer.parseRuleData(F.data,K,H,D);return true}else{if(F.code==1){h.alert("提示","<strong>"+F.errorsList[0].msg+"("+F.errorsList[0].code+")</strong>")}else{h.alert("提示","数据查询异常，请稍后重试！")}}return false};var u=function(G){x={};l.tsnFlag=false;s();h("#tsn_hid").val("");var D=h("#"+G).val();if(D==""){return}var F={instCode:D,mktResId:h("#mktResId").val(),mktResTypeCd:h("#mktResType").val(),orderNo:""};var E=contextPath+"/mktRes/terminal/checkTerminal";h.callServiceAsJson(E,F,{before:function(){},always:function(){},done:function(H){if(H&&H.code==-2){h.alertM(H.data)}else{if(H&&H.data&&H.data.code==0){if(H.data.statusCd==CONST.MKTRES_STATUS.USABLE){h.alert("提示","<br/>此终端串号可以使用");l.tsnFlag=true;s();h("#tsn_hid").val(D);x=H.data}else{h.alert("提示",H.data.message)}}else{if(H&&H.data&&H.data.message&&H.data.code==1){h.alert("提示",H.data.message)}else{h.alert("提示","<br/>校验失败，请稍后重试！")}}}}})};var k=function(){if("lj"==l.buyType){if(!l.tsnFlag){h.alert("提示","<br/>请先校验终端串号。");return}var F=h("#price").val()/100;var H=[{couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:x.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:x.mktResStoreId,storeName:"1",agentId:1,apCharge:F,couponInstanceNumber:x.instCode,ruleId:"",partyId:CONST.CUST_COUPON_SALE,prodId:0,offerId:0,state:"ADD",relaSeq:""}];if(OrderInfo.cust.custId!=undefined&&OrderInfo.cust.custId!=""){H[0].partyId=OrderInfo.cust.custId}OrderInfo.actionTypeName="订购";OrderInfo.businessName=h("#mktResName").val();var E={};E.busiObj={instId:x.mktResId};E.boActionType={actionClassCd:CONST.ACTION_CLASS_CD.MKTRES_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.COUPON_SALE};E.coupons=H;SoOrder.submitOrder(E);return}else{if("hy"==l.buyType){if(!l.numFlag){h.alert("提示","<br/>请先选号。");return}else{if(!l.hyFlag){h.alert("提示","<br/>请先选择合约套餐。");return}else{if(!l.tsnFlag){h.alert("提示","<br/>请先校验终端串号。");return}}}if(OrderInfo.cust.custId==undefined||OrderInfo.cust.custId==""){h.alert("提示","<br/>在订购套餐之前请先进行客户定位！");return}}else{return}}var D={couponUsageTypeCd:"5",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:x.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:x.mktResStoreId,storeName:"1",agentId:1,apCharge:h("#price").val()/100,couponInstanceNumber:x.instCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:-1,offerId:-1,attachSepcId:mktRes.terminal.offerSpecId,state:"ADD",relaSeq:""};OrderInfo.attach2Coupons=[];OrderInfo.attach2Coupons.push(D);var G={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:OrderInfo.offerSpec,offerSpecId:l.hyOfferSpecId,offerSpecName:l.hyOfferSpecName,viceCardNum:Number(l.hyOfferSpecQty),feeType:l.hyOfferSpecFt,offerNum:1,type:2,actionFlag:OrderInfo.actionFlag,terminalInfo:{terminalName:h("#mktResName").val(),terminalCode:h("#tsn_hid").val()},offerRoles:l.hyOfferRoles};
OrderInfo.actionTypeName="订购";SoOrder.builder();order.main.buildMainView(G)};return{init:n,btnQueryTerminal:q,initInParam:z,queryApConfig:t,selectTerminal:m,setNumber:b,offerSpecId:w}})(jQuery);$(function(){});CommonUtils.regNamespace("mktRes","terminal","exchange");mktRes.terminal.exchange=(function(g){var f=function(){g("#bt_terminalQry").off("click").on("click",function(){d(g("#p_qryNumber").val())})};var d=function(i){if(i==""){g.alert("提示","<br/>请先输入终端串码。");return}var j=contextPath+"/mktRes/terminal/queryCoupon";var k={couponNumber:i};g.callServiceAsJson(j,k,{before:function(){g.ecOverlay("<strong>正在查询中,请稍等...</strong>")},always:function(){g.unecOverlay()},done:function(l){g("#coupon_tab tbody").html("");g("#terminalTr").removeData("couponInfo");if(l.code==-2){g.alertM(l.data);return}else{if(l.code!=0){g.alert("提示","<br/>查询失败,请稍后重试。");return}}var o=l.data;if(o.code!=0){g.alert("提示",o.msg);return}if(o.id==undefined){g.alert("提示","返回的数据中缺少ID，请确认。");return}if(o.instInfo&&o.instInfo.length>0&&o.instInfo[0].prodId!=undefined){o.instFlag=true}else{o.instFlag=false}var n="";n+='<tr id="terminalTr">';n+="<td>"+o.couponNumber+"</td>";n+="<td>"+o.couponName+"</td>";n+="<td>"+o.channelName+"</td>";n+="<td>"+o.staffName+"</td>";n+="<td>"+o.statusDate+"</td>";n+="<td>"+o.olId+"</td>";if(o.instFlag){n+="<td>";n+="产品信息："+o.instInfo[0].prodSpecName+" - "+o.instInfo[0].accessNbr+"<br/>";n+="销售品信息："+o.instInfo[0].offerSpecName;n+="</td>"}else{n+="<td></td>"}var m="";m+='<a id="exchangeTerminalA" class="purchase">换货</a>';if(!o.instFlag){m+='<a id="returnTerminalA" class="purchase">退货</a>'}n+="<td>"+m+"</td>";n+="</tr>";g("#coupon_tab tbody").html(n);g("#terminalTr").data("couponInfo",o);g("#exchangeTerminalA").off("click").on("click",function(){c(g("#terminalTr").data("couponInfo"))});g("#returnTerminalA").off("click").on("click",function(){h(g("#terminalTr").data("couponInfo"))})}})};var c=function(){ec.form.dialog.createDialog({id:"-exchange-terminal",width:450,height:180,initCallBack:function(j,i){g("#exchangeConfirmA").off("click").on("click",function(){var l=g("#terminalTr").data("couponInfo");var k=b(l);if(k){j.close(i);a(l,k)}});g("#exchangeCancelA").off("click").on("click",function(){j.close(i)})},submitCallBack:function(j,i){}})};var b=function(l){var j=g("#couponInstNbrInp").val();if(j==""){g.alert("提示","<br/>请输入有效的终端串码。");return}var m={instCode:j,mktResId:""+l.couponId,mktResTypeCd:""+l.couponTypeCd,orderNo:""};var k=contextPath+"/mktRes/terminal/checkTerminal";g.ecOverlay("<strong>终端串码校验中,请稍等...</strong>");var i=g.callServiceAsJson(k,m,{});g.unecOverlay();if(i.code==-2){g.alertM(i.data)}else{if(i.code!=0){g.alert("提示","<br/>校验失败请稍后再试。")}else{if(i.data){if(i.data.code==0){if(i.data.statusCd==CONST.MKTRES_STATUS.USABLE){return i.data}else{g.alert("提示",i.data.message)}}else{if(i.data.code==1&&i.data.message){g.alert("提示",i.data.message)}}}else{g.alert("提示","<br/>校验失败请稍后再试。")}}}};var a=function(n,l){OrderInfo.actionTypeName="退换";OrderInfo.businessName=n.couponName;OrderInfo.actionFlag=18;var o=[];var i={id:n.id,couponUsageTypeCd:"5",inOutTypeId:"2",inOutStatusId:"1",inOutReasonId:0,saleId:1,couponId:n.couponId,couponinfoStatusCd:"R",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:n.storeId,storeName:"1",agentId:1,apCharge:n.realAmount/-100,couponInstanceNumber:n.couponNumber,ruleId:"",partyId:CONST.CUST_COUPON_SALE,prodId:0,offerId:0,state:"DEL",relaSeq:"",isOld:"Y"};var j={id:-1,couponUsageTypeCd:"5",inOutTypeId:"1",inOutStatusId:"1",inOutReasonId:0,saleId:1,couponId:l.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:l.mktResStoreId,storeName:"1",agentId:1,apCharge:n.realAmount/100,couponInstanceNumber:l.instCode,ruleId:"",partyId:CONST.CUST_COUPON_SALE,prodId:0,offerId:0,state:"ADD",relaSeq:"",isOld:"N"};var m={};if(n.instFlag){i.prodId=n.instInfo[0].prodId;i.offerId=n.instInfo[0].offerId;j.prodId=n.instInfo[0].prodId;j.offerId=n.instInfo[0].offerId;m.busiObj={accessNumber:n.instInfo[0].accessNbr,instId:n.instInfo[0].offerId,isComp:"N",objId:n.instInfo[0].offerSpecId,offerTypeCd:"1"};m.boActionType={actionClassCd:CONST.ACTION_CLASS_CD.OFFER_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.EXCHANGE_COUPON};if(CONST.getAppDesc()==0){OrderInfo.order.soNbr=UUID.getDataId();var k={areaId:OrderInfo.staff.areaId,acctNbr:n.instInfo[0].accessNbr,custId:"",soNbr:OrderInfo.order.soNbr,instId:n.instInfo[0].prodId,type:"2"};if(!query.offer.invokeLoadInst(k)){return false}}}else{m.busiObj={instId:n.id,isComp:"N",objId:n.couponId};m.boActionType={actionClassCd:CONST.ACTION_CLASS_CD.MKTRES_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.EXCHANGE_COUPON}}o.push(i);o.push(j);m.coupons=o;SoOrder.submitOrder(m)};var h=function(j){OrderInfo.actionTypeName="退换";OrderInfo.businessName=j.couponName;OrderInfo.actionFlag=17;var k=[{id:j.id,couponUsageTypeCd:"3",inOutTypeId:"2",inOutStatusId:"1",inOutReasonId:0,saleId:1,couponId:j.couponId,couponinfoStatusCd:"A",chargeItemCd:CONST.CHARGE_ITEM_CD.COUPON_SALE,couponNum:1,storeId:j.storeId,storeName:"1",agentId:1,apCharge:j.realAmount/-100,couponInstanceNumber:j.couponNumber,ruleId:"",partyId:CONST.CUST_COUPON_SALE,prodId:0,offerId:0,state:"DEL",relaSeq:"",isOld:"Y"}];var i={};i.busiObj={instId:j.id,isComp:"N",objId:j.couponId};i.boActionType={actionClassCd:CONST.ACTION_CLASS_CD.MKTRES_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.RETURN_COUPON};i.coupons=k;SoOrder.submitOrder(i)};return{init:f}})(jQuery);$(function(){mktRes.terminal.exchange.init()});CommonUtils.regNamespace("order","area");var ztree=null;var areaType=null;var areaNameVal="";order.area=(function(){var d=function(n,l,m,o){i(n,l,m,o,contextPath+"/orderQuery/areaTreeManger")};var h=function(n,l,m,o){i(n,l,m,o,contextPath+"/orderQuery/areaTree")};var i=function(o,l,m,p,n){if(!login.windowpub.checkLogin()){return}var q=m;var r=l;$.ligerDialog.open({width:350,height:350,title:"请选择地区(*不可选)",url:n+"?areaType="+o+"&areaLeve="+p,buttons:[{text:"确定",onclick:function(u,s){if(!ztree){return}var t=ztree.getSelected();if(t){if(t.data.isAllRegionFlag=="Y"){$("#"+q).val(t.data.commonRegionId);$("#"+q).attr("areaCode",t.data.regionCode);$("#"+r).val(areaNameVal);s.close();if(o=="prod/preProdQuery"){if(product.query.areaId!=$("#p_areaId").val()){if($("#custName").val()!=""||$("#num").val()!=""){$.alert("提示","地区已变更，请重新定位产品")}$("#prodList").html("");$("#custName").val("").attr("name","");$("#num").val("");product.query.areaId=$("#p_areaId").val()}}if(o=="acct/preQueryAccount"){if(account.query.areaId!=$("#p_areaId").val()){if($("#custName").val()!=""||$("#num").val()!=""){$.alert("提示","地区已变更，请重新定位帐户")}$("#acctList").html("");$("#custName").val("").attr("name","");$("#num").val("");account.query.areaId=$("#p_areaId").val()}}}else{alert("当前地区不可选！")}}else{alert("请选择地区！")}}},{text:"取消",onclick:function(t,s){s.close()}}]})};var g=function(l,m,n){if(!login.windowpub.checkLogin()){return}var o=m;var p=l;$.ligerDialog.open({width:350,height:350,title:"请选择地区",url:contextPath+"/orderQuery/areaTreeAll?areaLeve="+n,buttons:[{text:"确定",onclick:function(s,q){if(!ztree){return}var r=ztree.getSelected();if(r){$("#"+o).val(r.data.commonRegionId);$("#"+o).attr("areaCode",r.data.regionCode);$("#"+p).val(areaNameVal);q.close()}else{alert("请选择地区！")}}},{text:"取消",onclick:function(r,q){q.close()}}]})};var k=null;var a;var c;var j=function(l,m){a=m;c=l;k=$.ligerDialog.open({width:400,height:320,title:"请选择地区",url:contextPath+"/orderQuery/tree_flat",buttons:[{text:"取消",onclick:function(o,n){n.close()}}]})};var b=function(m,l){if(k!=null){if(c&&$("#"+c)){$("#"+c).val(m)}if(a&&$("#"+a)){$("#"+a).val(l)}k.close()}};var f=function(){$.unecOverlay();$("#dic_mess").hide();alert(111);$("#commonRegionTree").show()};return{areaChecked:b,flatAreaPage:j,chooseAreaTree:h,chooseAreaTreeAll:g,chooseAreaTreeManger:d,dicInitEnd:f}})();CommonUtils.regNamespace("CacheData");CacheData=(function(){var B=function(I,F,E){var H='<form id="paramForm">';if(E==2){if(m(F.prodSpecParams)){for(var G=0;
G<F.prodSpecParams.length;G++){var K=F.prodSpecParams[G];if(K.value==undefined){K.value=""}H+=l(I,K,K.itemSpecId,K.value)}}}else{if(E==3){if(m(F.prodSpecParams)){for(var G=0;G<F.prodSpecParams.length;G++){var K=F.prodSpecParams[G];if(m(F.prodInstParams)){$.each(F.prodInstParams,function(){if(this.itemSpecId==K.itemSpecId){K.value=this.value}})}if(K.value==undefined){K.value=""}H+=l(I,K,K.itemSpecId,K.value)}}}else{if(E==1){if(F.offerSpec!=undefined){if(m(F.offerSpec.offerSpecParams)){var J=F.offerSpec.offerSpecParams;$.each(J,function(){var L=this;if(m(F.offerParamInfos)){$.each(F.offerParamInfos,function(){if(this.itemSpecId==L.itemSpecId){L.value=this.value}})}H+=l(I,this,this.itemSpecId,this.value)})}}}else{if(m(F.offerSpecParams)){var J=F.offerSpecParams;$.each(J,function(){H+=l(I,this,this.itemSpecId,this.value)})}}}}H+="</form>";return H};var d=function(G,F){var E=$('<form id="appForm"></form>');if(!!F&&F.length>0){$.each(F,function(){var H=$('<input id="'+G+"_"+this.objId+'" name="'+G+'" type="checkbox">'+this.objName+"</input></br>");if(this.minQty==0){if(this.dfQty>0){H.attr("checked","checked")}}else{if(this.minQty>0){H.attr("checked","checked");H.attr("disabled","disabled")}}E.append(H)})}return E};var l=function(J,L,G,H){var E="";if(r(L.setValue)){H=L.setValue}else{L.setValue=L.value}if(!!L.valueRange&&L.valueRange.length>0){if(L.rule.isConstant=="Y"){E=L.name+": <select class='inputWidth183px' id="+J+"_"+G+" disabled='disabled'>"}else{if(L.rule.isOptional=="N"){E=L.name+": <select class='inputWidth183px' id="+J+"_"+G+" data-validate='validate(required,reg:"+L.rule.maskMsg+"("+L.rule.mask+")) on(blur)'><label class='f_red'>*</label><br>"}else{E=L.name+": <select class='inputWidth183px' id="+J+"_"+G+"><br>"}}var I="";if(L.value==""){I+='<option value="" >请选择</option>'}for(var F=0;F<L.valueRange.length;F++){var K=L.valueRange[F];if(K.value==H){I+='<option value="'+K.value+'" selected="selected" >'+K.text+"</option>"}else{I+='<option value="'+K.value+'">'+K.text+"</option>"}}E+=I+"</select><br>"}else{if(L.dataTypeCd==1){if(L.rule==undefined){E+=L.name+' : <input id="'+J+"_"+G+'" class="inputWidth183px" type="text" value="'+H+'" ><br>'}else{if(L.rule.isConstant=="Y"){E+=L.name+' : <input id="'+J+"_"+G+'" class="inputWidth183px" type="text" disabled="disabled" value="'+H+'" ><br>'}else{if(L.rule.isOptional=="N"){E+=L.name+' : <input id="'+J+"_"+G+'" class="inputWidth183px" type="text" data-validate="validate(required,reg:'+L.rule.maskMsg+"("+L.rule.mask+')) on(blur)" value="'+H+'" ><label class="f_red">*</label><br>'}else{E+=L.name+' : <input id="'+J+"_"+G+'" class="inputWidth183px" type="text" data-validate="validate(reg:'+L.rule.maskMsg+"("+L.rule.mask+')) on(blur)" value="'+H+'" ><br>'}}}}else{if(L.dataTypeCd==8){if(L.rule==undefined){E+=L.name+' : <input id="'+J+"_"+G+'" class="inputWidth183px" type="password" value="'+H+'" ><br>'}else{if(L.rule.isConstant=="Y"){E+=L.name+' : <input id="'+J+"_"+G+'" class="inputWidth183px" type="password"  disabled="disabled" value="'+H+'" ><br>'}else{if(L.rule.isOptional=="N"){E+=L.name+' : <input id="'+J+"_"+G+'" class="inputWidth183px" type="password" data-validate="validate(required,reg:'+L.rule.maskMsg+"("+L.rule.mask+')) on(blur)" value="'+H+'" ><label class="f_red">*</label><br>'}else{E+=L.name+' : <input id="'+J+"_"+G+'" class="inputWidth183px" type="password" data-validate="validate(reg:'+L.rule.maskMsg+"("+L.rule.mask+')) on(blur)" value="'+H+'" ><br>'}}}}else{if(L.dataTypeCd==4){}}}}return E};var o=function(H,F,E){var G='<form id="paramForm">';var I="";if(E==0){$.each(F.offerRoles,function(){$.each(this.roleObjs,function(){if(this.objType==4){if(this.minQty==0&&this.maxQty>0){I+='<input id="check_'+H+"_"+this.objId+'" type="checkbox" checked="checked">'+this.objName+"<br>"}else{if(this.minQty>0){I+='<input id="check_'+H+"_"+this.objId+'"  type="checkbox" checked="checked" disabled="disabled">'+this.objName+"<br>"}}}})});if(I==""){G="订购【"+F.offerSpecName+"】可选包"}else{G="订购【"+F.offerSpecName+"】可选包，需要开通以下勾选的功能产品：<br>"+I}}else{if(E==1){$.each(F.offerMemberInfos,function(){var J=this;$.each(F.offerSpec.offerRoles,function(){$.each(this.roleObjs,function(){if(J.objId==this.objId&&this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){var K=J.objInstId;if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE){I+='<input id="check_'+H+"_"+K+'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+"<br>"}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE){I+='<input id="check_'+H+"_"+K+'" type="checkbox" checked="checked">'+this.objName+"<br>"}}}})})});if(I==""){G="退订【"+F.offerSpecName+"】可选包"}else{G="退订【"+F.offerSpecName+"】可选包，需要关闭以下勾选的功能产品：<br>"+I}}else{if(E==2){$.each(F.offerRoles,function(){$.each(this.roleObjs,function(){if(this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE){I+='<input id="check_'+H+"_"+this.objId+'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+"<br>"}else{if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE){I+='<input id="check_'+H+"_"+this.objId+'" type="checkbox" checked="checked">'+this.objName+"<br>"}}}})});if(I==""){G="取消订购【"+F.offerSpecName+"】可选包"}else{G="取消订购【"+F.offerSpecName+"】可选包，需要取消开通以下勾选的功能产品：<br>"+I}}}}G+="</form>";return G};var v=function(G,F,E){};var u=function(G,F,E){};var C=function(F,H){if(!!H.offerSpecParams){for(var E=0;E<H.offerSpecParams.length;E++){var G=H.offerSpecParams[E];if(m(G.valueRange)){if(G.value==undefined||G.value==""){if(G.rule.isOptional=="N"){return false}}}else{if(G.value==undefined||G.value==""){if(G.rule.isOptional=="N"){return false}}}}}H.isset="Y";return true};var q=function(G,E){if(!!E.prodSpecParams){for(var F=0;F<E.prodSpecParams.length;F++){var H=E.prodSpecParams[F];if(m(H.valueRange)){if(H.value==undefined||H.value==""){if(H.rule.isOptional=="N"){return false}}}else{if(H.value==undefined||H.value==""){if(H.rule.isOptional=="N"){return false}}}}}E.isset="Y";return true};var w=function(G){for(var F=0;F<AttachOffer.openList.length;F++){var E=AttachOffer.openList[F];if(E.prodId==G){return E.specList}}return[]};var t=function(G,H){var E=w(G);if(E!=undefined){for(var F=0;F<E.length;F++){if(E[F].offerSpecId==H){return E[F]}}}};var n=function(H,I,F){var E=t(H,I);if(typeof(E)!="undefined"){for(var G=0;G<E.offerSpecParams.length;G++){if(E.offerSpecParams[G].itemSpecId==F){return E.offerSpecParams[G]}}}};var a=function(I,L,F){var M=t(I,L);if(!!M.offerRoles){for(var H=0;H<M.offerRoles.length;H++){var K=M.offerRoles[H];for(var G=0;G<K.roleObjs.length;G++){var J=K.roleObjs[G];if(J.prodSpecParams!=undefined&&J.prodSpecParams.length>0){for(var E=0;E<J.prodSpecParams.length;E++){if(J.prodSpecParams[E].itemSpecId==F){return J.prodSpecParams[E]}}}}}}};var c=function(F){for(var E=0;E<AttachOffer.openedList.length;E++){var G=AttachOffer.openedList[E];if(G.prodId==F){return G.offerList}}return[]};var x=function(H,E){var F=c(H);if(F!=undefined){for(var G=0;G<F.length;G++){if(F[G].offerId==E){return F[G]}}}};var h=function(G,H){var E=c(G);if(E!=undefined){for(var F=0;F<E.length;F++){if(E[F].offerSpecId==H){return E[F]}}}};var k=function(I,E,F){var H=x(I,E);if(H.offerSpec.offerSpecParams!=undefined){for(var G=0;G<H.offerSpec.offerSpecParams.length;G++){if(H.offerSpec.offerSpecParams[G].itemSpecId==F){return H.offerSpec.offerSpecParams[G]}}}};var D=function(K,I,E){var L=x(K,I);if(m(L.offerMembers)){for(var J=0;J<L.offerMembers.length;J++){var G=L.offerMembers[J];for(var H=0;H<G.prodParamInfos.length;H++){for(var F=0;F<G.prodParamInfos.length;F++){var M=G.prodParamInfos[F];if(M.itemSpecId==E){return M}}}}}};var z=function(G){for(var F=0;F<AttachOffer.openServList.length;F++){var E=AttachOffer.openServList[F];if(E.prodId==G){return E.servSpecList}}return[]};var b=function(G,H){var E=z(G);if(E!=undefined){for(var F=0;F<E.length;F++){if(E[F].servSpecId==H){return E[F]}}}};var i=function(H,I,F){var E=b(H,I);if(m(E.prodSpecParams)){for(var G=0;G<E.prodSpecParams.length;G++){if(E.prodSpecParams[G].itemSpecId==F){return E.prodSpecParams[G]
}}}};var s=function(F){for(var E=0;E<AttachOffer.openedServList.length;E++){var G=AttachOffer.openedServList[E];if(G.prodId==F){return G.servList}}return[]};var y=function(G,H){var F=s(G);if(m(F)){for(var E=0;E<F.length;E++){if(F[E].servId==H){return F[E]}}}};var j=function(G,H){var F=s(G);if(m(F)){for(var E=0;E<F.length;E++){if(F[E].servSpecId==H){return F[E]}}}};var g=function(H,J,E){var I=y(H,J);if(m(I.prodSpecParams)){for(var F=0;F<I.prodSpecParams.length;F++){var G=I.prodSpecParams[F];if(G.itemSpecId==E){return G}}}};var p=function(G){for(var F=0;F<AttachOffer.openAppList.length;F++){var E=AttachOffer.openAppList[F];if(E.prodId==G){return E.appList}}return[]};var A=function(G){if(m(OrderInfo.offer.offerMemberInfos)){for(var E=0;E<OrderInfo.offer.offerMemberInfos.length;E++){var F=OrderInfo.offer.offerMemberInfos[E];if(F.objInstId==G){return F}}}};var f=function(E){E.sort(function(G,F){if(G.itemSpecId<F.itemSpecId){return -1}if(G.itemSpecId>F.itemSpecId){return 1}return 0})};var r=function(E){if(E!=undefined&&E!=""){return true}else{return false}};var m=function(E){if(!!E&&E.length>0){return true}else{return false}};return{getParamContent:B,setParam:C,setServParam:q,getOfferSpecList:w,getOfferSpec:t,getSpecParam:n,getOfferList:c,getOffer:x,getOfferParam:k,getOfferBySpecId:h,getServList:s,getServ:y,getServBySpecId:j,getServSpec:b,getServSpecList:z,getProdInstParam:D,getProdSpecParam:a,getServInstParam:g,getServSpecParam:i,getOfferProdStr:o,getOpenAppList:p,getAppContent:d,getOfferMember:A,getCanBuyServHtml:v,getCanBuyOfferHtml:u}})();CommonUtils.regNamespace("order","calcharge");order.calcharge=(function(){var f=[];var F=[];var w=0;var h=0;var o=0;var s=0;var n="newOrder";var D=false;var z=function(I,H){var G=$("#pro_"+I).html();if(G!=undefined&&G!=""){easyDialog.open({container:"moneyAdd"});$("#addContent").html("");$("#addContent").html(G);$("#moneyclose").off("click").on("click",function(J){easyDialog.close()});order.calcharge.trObj=H}else{$.alert("提示","没有可添加费用项的业务对象！")}};var E=function(O,L,I,H,M,N,G,K){var P="0";if(OrderInfo.actionFlag==11){P="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){P="2"}}var J={boId:O,objInstId:G,prodId:K,boActionTypeCd:L,actionFlag:OrderInfo.actionFlag,objType:I,objId:H,itemNum:o,objName:M,actionName:N,refundType:P};$.callServiceAsHtml(contextPath+"/order/getChargeAddByObjId",J,{before:function(){$.ecOverlay("<strong>正在增加收费项,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(Q){if(Q.code!=0){$.alert("提示","查询失败,稍后重试");return}A(O,Q.data)},fail:function(Q){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var A=function(G,H){easyDialog.close();if(H!=""){$(order.calcharge.trObj).parent().parent().after(H);o--;v()}else{$.alert("提示","没有可添加的费用项");return}};var i=function(H,J,I){if(I=="old"){var G=$("#feeAmount_"+J).val();if(($("#realAmount_"+J).val())*100==0){$("#realAmount_"+J).val(((G/100).toFixed(2))+"")}else{$("#realAmount_"+J).val("0")}var K=($("#realAmount_"+J).val())*100;if(K!=G){$("#chargeModifyReasonCd_"+J).show()}else{$("#chargeModifyReasonCd_"+J).hide()}}else{$(H).parent().parent().remove()}v()};var k=function(J,I,L,K){var H=m(I,L,null);if(H){if(K=="old"){var G=$("#feeAmount_"+L).val();if(($("#realAmount_"+L).val())*100!=0){$("#realAmount_"+L).val(((G/100).toFixed(2))+"")}else{$("#realAmount_"+L).val("0")}var M=($("#realAmount_"+L).val())*100;if(M!=G){$("#chargeModifyReasonCd_"+L).show()}else{$("#chargeModifyReasonCd_"+L).hide()}}else{$(J).parent().parent().remove()}v()}};var v=function(){f=[];F=[];var H=0;$("#calTab tbody tr").each(function(){var J=$(this).attr("id");if(J!=undefined&&J!=""){J=J.substr(5,J.length);var I=($("#realAmount_"+J).val())*1;if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){I=($("#backAmount_"+J).val())*1}H=H+I;l(J)}});if(OrderInfo.actionFlag==15){var G=0;$("#calTab tbody tr").each(function(){var J=$(this).attr("id");if(J!=undefined&&J!=""){J=J.substr(5,J.length);var I=($("#backAmount_"+J).val())*1;G=G+I}});$("#backAmount").val(Number(G).toFixed(2))}$("#realmoney").val(Number(H).toFixed(2));if(OrderInfo.actionFlag==15){order.refund.conBtns()}else{c()}};var q=function(){var G=true;$("#calTab tbody tr").each(function(){var H=$(this).attr("id");if(H!=undefined&&H!=""){H=H.substr(5,H.length);var I=$("#chargeModifyReasonCd_"+H).val();if(I=="1"){if($("#remark_"+H).val()==undefined||$("#remark_"+H).val()==null||$("#remark_"+H).val()==""){G=false}}}});if(!G){$.alert("提示信息","请填写修改原因");return false}f=[];$("#calTab tbody tr").each(function(){var K=$(this).attr("id");if(K!=undefined&&K!=""){K=K.substr(5,K.length);var W=($("#realAmount_"+K).val())*100+"";var P=$("#feeAmount_"+K).val();var M="";if(P!=undefined&&P!=""){M=P+""}else{M=W}if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){M=$("#feeAmount_"+K).val()*1+"";W=(0-($("#backAmount_"+K).val())*100)+""}var O=$("#acctItemTypeId_"+K).val();var I=$("#objId_"+K).val();var J=$("#objType_"+K).val();var V=$("#acctItemId_"+K).val();var U=$("#boId_"+K).val();var R=$("#payMethodCd_"+K).val();var H=$("#objInstId_"+K).val();var N=$("#prodId_"+K).val();var T=$("#boActionType_"+K).val();var S=$("#chargeModifyReasonCd_"+K).val();var Q=$("#chargeModifyReasonCd_"+K).find("option:selected").text();if(S=="1"){Q=$("#remark_"+K).val()}var L={realAmount:W,feeAmount:M,acctItemTypeId:O,objId:I,objType:J,acctItemId:V,boId:U,prodId:N,objInstId:H,payMethodCd:R,posSeriaNbr:"-1",chargeModifyReasonCd:S,remark:Q,boActionType:T};f.push(L)}});return true};var x=function(G){var H=$("#changeMethod_"+G).val();$("#payMethodCd_"+G).val(H)};var m=function(K,N,M){var I={acctItemTypeId:K};var G=contextPath+"/order/queryPayMethodByItem";var J=$.callServiceAsJson(G,I);if(J.code==0){if(J.data!=undefined&&J.data!=null){if(J.data.length>0){var O=J.data;var P=false;if(OrderInfo.actionFlag==11){if(O[0].limitChange=="N"){return true}}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){if(O[0].limitBuyBack=="N"){return true}}else{if(OrderInfo.actionFlag==15){if(O[0].limitRedo=="N"){P=true}}else{if(O[0].limitChange=="N"){P=true}}}}if(P){var Q=O[0].payMethods;if(Q.length>0){if(N){var H="'"+N+"'";var L='<select id="changeMethod_'+N+'" style="border: 1px solid #DCDCDC;height: 23px;line-height: 23px;padding: 1px; width: 120px;" onchange="order.calcharge.selectChangePayMethodCd('+H+')">';$.each(Q,function(R,S){if(S.payMethodCd==M){L+='<option value="'+S.payMethodCd+'" selected="selected">'+S.payMethodName+"</option>"}else{L+='<option value="'+S.payMethodCd+'">'+S.payMethodName+"</option>"}});L+="</select>";$("#payMethodText_"+N).html(L)}}return true}else{$.alert("提示","当前产品不可修改费用!");return false}}}}else{if(J.code==-2){$.alertM(J.data);return false}else{$.alert("提示","查询付费方式失败!");return false}}};var b=function(G){if($("#chargeModifyReasonCd_"+G).val()=="1"){$("#remark_"+G).css("display","inline")}else{$("#remark_"+G).css("display","none")}};var r=function(H,K,I,J){var G=m(H,K,I);if(G){$("#chargeModifyReasonCd_"+K).off("change").on("change",function(){if($(this).val()=="1"){$("#remark_"+K).css("display","inline")}else{$("#remark_"+K).css("display","none")}});if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20||OrderInfo.actionFlag==15){$("#backAmount_"+K).removeAttr("disabled").css("border","1px solid #DCDCDC").focus()}else{$("#realAmount_"+K).removeAttr("disabled").css("border","1px solid #DCDCDC").focus()}}$(J).removeAttr("onclick").removeClass("money_edit").addClass("money_edit_gray")};var l=function(J){var P=($("#realAmount_"+J).val())*100+"";var N=$("#feeAmount_"+J).val();var L="";if(N!=undefined&&N!=""){L=N+""}else{L=P}var M=$("#acctItemTypeId_"+J).val();var G=$("#objId_"+J).val();var I=$("#objType_"+J).val();var O=$("#acctItemId_"+J).val();var K=$("#acctItemTypeName_"+J).val();var H={realmoney:P,feeAmount:L,acctItemTypeId:M,objId:G,objType:I,acctItemId:O,acctItemTypeName:K};F.push(H)};var u=function(K,M,L){var H=$.trim($(K).val());if(H==""){$(K).val("0");order.calcharge.reflashTotal()
}else{if(L=="old"){var J=$("#feeAmount_"+M).val();var G=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(H)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");G=false}else{if(H*100>J*1){$.alert("提示","实收费用金额不能高于应收金额！");G=false}}if(G){var N=($(K).val())*100;if(N!=J){$("#chargeModifyReasonCd_"+M).show()}else{$("#chargeModifyReasonCd_"+M).hide();$("#remark_"+M).hide()}v()}else{if(s!=""){$(K).val(s)}s=""}}else{if(L=="undo"){var G=true;if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(H)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");G=false}else{if(H<0){$.alert("提示","退费金额不能为负值！");G=false}else{var J=$("#realhidden_"+M).val();var I=H*-1;if(I<J*1){$.alert("提示","退费金额不能高于实收金额！");G=false}}}if(G){var N=($(K).val())*-1;var J=$("#realhidden_"+M).val();if(N!=0){$("#chargeModifyReasonCd_"+M).show()}else{$("#chargeModifyReasonCd_"+M).hide();$("#remark_"+M).hide()}v()}else{if(s!=""){$(K).val(s)}s=""}}else{if(L=="new"){if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(H)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");if(s!=""){$(K).val(s)}s=""}else{v()}}}}}};var C=function(G){s=$.trim($(G).val())};var c=function(){var G=($("#realmoney").val())*1;if(OrderInfo.actionFlag==11){$("#orderCancel").off("click").on("click",function(H){order.undo.orderBack()})}else{$("#orderCancel").off("click").on("click",function(H){SoOrder.orderBack()})}if(!D){if(G!=0){$("#toCharge").removeClass("btna_g").addClass("btna_o");$("#toComplate").removeClass("btna_o").addClass("btna_g");$("#toCharge").off("click").on("click",function(H){p("1")});$("#toComplate").off("click")}else{$("#toCharge").removeClass("btna_o").addClass("btna_g");$("#toComplate").removeClass("btna_g").addClass("btna_o");$("#toCharge").off("click");$("#toComplate").off("click").on("click",function(H){p("0")})}}else{$("#toCharge").removeClass("btna_o").addClass("btna_g");$("#toComplate").removeClass("btna_o").addClass("btna_g");$("#toCharge").off("click");$("#toComplate").off("click")}};var p=function(G){if(D){$.alert("提示","订单已经激活,不能重复操作!");return}if(!q()){return}var I={olId:w,soNbr:OrderInfo.order.soNbr,areaId:OrderInfo.staff.areaId,chargeItems:f};var H=contextPath+"/order/chargeSubmit";$.callServiceAsJson(H,I,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(L){var O="";if(L.code==0){SoOrder.delOrderFin();if(OrderInfo.actionFlag==31){var M=contextPath+"/cust/passwordReset";var L=$.callServiceAsJson(M,null,{})}D=true;if(G=="1"){if(OrderInfo.actionFlag==11){O="退费成功"}else{O="收费成功"}}else{O="受理成功"}$("#toCharge").removeClass("btna_o").addClass("btna_g");$("#toComplate").removeClass("btna_o").addClass("btna_g");$("#printVoucherA").removeClass("btna_o").addClass("btna_g").off("click");$("#toComplate").off("click");$("#toCharge").off("click");$(".charge_add").remove();$(".cash_inp_dis").attr("disabled","disabled");if(OrderInfo.actionFlag==11){$("#orderCancel").html("<span>返回首页</span>");$("#orderCancel").off("click").on("click",function(P){order.undo.toUndoMain(1)})}else{$("#orderCancel span").html("继续受理");$("#orderCancel").off("click").on("click",function(P){a()})}SoOrder.updateResState();if(G=="1"){var K=($("#realmoney").val())*1;if(K>0){var N={soNbr:OrderInfo.order.soNbr,billType:0,olId:w,printFlag:-1,areaId:OrderInfo.staff.areaId,acctItemIds:[]};var J=common.print.initPrintInfo(N);if(!J){return}$.confirm("信息提示","收费成功，是否打印发票?",{names:["是","否"],yesdo:function(){var P={soNbr:OrderInfo.order.soNbr,billType:0,olId:w,printFlag:0,areaId:OrderInfo.staff.areaId,acctItemIds:[]};common.print.prepareInvoiceInfo(P);return},no:function(){}})}else{g(G,O)}}else{g(G,O)}return}else{if(L.code==-2){$.alertM(L.data)}else{if(L.data!=undefined){$.alert("提示",L.data)}else{$.alert("提示","费用信息提交失败!")}}}},fail:function(J){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var g=function(G,I){var H='<table class="contract_list rule">';if(G=="1"){if(OrderInfo.actionFlag==11){H+='<thead><tr> <td colspan="2">退费结果</td></tr></thead></table>'}else{H+='<thead><tr> <td colspan="2">收费结果</td></tr></thead></table>'}}else{H+='<thead><tr> <td colspan="2">受理结果</td></tr></thead></table>'}H+='<div id="rules_div">';H+='<table width="100%" border="0" cellspacing="0" cellpadding="0">';H+="<tr>";H+='<td align="right"><i class="rule_icon"></i></td>';H+='<td><span class="rule_font">'+I+"</span></td>";H+="</tr>";H+="</table>";H+="</div>";easyDialog.open({container:"successTip_dialog"});$("#successTipContent").html("");$("#successTipContent").html(H);$("#successTipclose,#successTip_dialog_cls").off("click").on("click",function(J){easyDialog.close();order.cust.custReset()});if(OrderInfo.actionFlag==11){$("#successTip_dialog_cnt").off("click").on("click",function(J){order.undo.toUndoMain(1)})}else{$("#successTip_dialog_cnt").off("click").on("click",function(J){a()})}if(G=="1"){if(OrderInfo.actionFlag==11){$("#successTip_dialog_inv").show();$("#successTip_dialog_inv").off("click").on("click",function(J){t()});$("#successTip_dialog_inv").css("margin-left","30px");$("#successTip_dialog_cnt").css("margin-left","30px")}}};var j=function(){if($("#sumitErrorInfo").is(":hidden")){$("#sumitErrorInfo").css("display","")}else{$("#sumitErrorInfo").css("display","none")}};var B=function(I,H){var G=$("#payMethodCd_"+I);G.empty();$("select[@id=backpayMethodCd_"+I+"] option").each(function(){var K=$(this).val();if(K!=undefined){var J=$(this).text();if(K.split("_")[1]==$(H).val()){$("<option value='"+K.split("_")[0]+"'>"+J+"</option>").appendTo(G)}}})};var a=function(){if($("#successTip_dialog").is(":visible")){easyDialog.close()}if(OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){window.location.href=contextPath+"/mktRes/terminal/exchangePrepare";return}else{if(OrderInfo.actionFlag==8){window.location.href=contextPath+"/cust/mvnoCustCreate";return}}$("#order_confirm,#order_fill_content,#order_tab_panel_content").empty();$("#order_prepare").show();order.cust.custReset();if(OrderInfo.cust.custId==-1){order.cust.custReset()}};var y=function(){$("#step1").hide();$("#step2").hide();$("#step3").show();w=OrderInfo.orderResult.olId;h=OrderInfo.orderResult.soNbr;f=[];F=[];o=0;s=0;D=false;var G="0";if(OrderInfo.actionFlag==11){G="1"}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){G="2"}}var H={olId:w,actionFlag:OrderInfo.actionFlag,actionTypeName:encodeURI(OrderInfo.actionTypeName),businessName:encodeURI(OrderInfo.businessName),olNbr:OrderInfo.orderResult.olNbr,soNbr:OrderInfo.order.soNbr,refundType:G};$.callServiceAsHtmlGet(contextPath+"/order/getChargeList",H,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(I){if(I.code!=0){$.alert("提示","收费页面加载失败，请稍后重试");return}var J=$("#order_confirm");J.html(I.data).show();if(OrderInfo.actionFlag==1){$("#buytitle").html("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName)}else{if(OrderInfo.actionFlag==11){$("#buytitle").html("撤单");$("#toCharge").html("<span>退费</span>")}else{if(OrderInfo.actionFlag==13||OrderInfo.actionFlag==17||OrderInfo.actionFlag==18){$("#buytitle").html("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName)}else{if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){$("#buytitle").html("返销");$("#toCharge").html("<span>退费</span>")}else{$("#buytitle").html("<span>"+OrderInfo.actionTypeName+"</span>")}}}}$.each($(".cashier_td"),function(){var K=$(this).attr("id");var L=$(this);if($.trim($(this).html())==""&&$("#phoneNumListtbody")!=undefined){$.each($("#phoneNumListtbody tr").find("td:eq(0)"),function(){var N=$(this).attr("prodInstId");var O=$(this).attr("accNbr");var M=$(this).attr("productName");if(N!=undefined&&O!=undefined){if(K==N){L.html(M+"&nbsp;-&nbsp;"+O)}}})}});$("#printVoucherA").off("click").on("click",function(K){if(!q()){return}var L={olId:w,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:f};common.print.printVoucher(L)});v()},fail:function(I){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var d=function(H){if(H.acctItemTypeId=="2090000"||H.acctItemTypeId=="2091000"){return""}if(H.feeAmount==0){return""}var G="<tr>";G+="<td>";H.printTimes=0;if(H.printTimes==0){G+='<input type="checkbox" checked="checked" name="acctItem" value="'
}else{G+='<input type="checkbox" disabled="disabled" name="acctItem" value="'}G+=H.acctItemTypeId+"_"+H.objId+'"/>';G+="</td>";G+='<td style="width: 200px">'+H.acctItemTypeName+"</td>";G+="<td>"+(parseFloat(H.realmoney)/100).toFixed(2)+"</td>";G+="</tr>";return G};var t=function(){var G={olId:OrderInfo.order.oldSoId,soNbr:OrderInfo.order.oldSoNbr};$.callServiceAsHtmlGet(contextPath+"/order/invaideInvoice",G,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(H){if(H.code==0){var I=$.parseJSON(H.data);if(I.code==0){$("#successTip_dialog_inv").off("click");$.alert("提示","作废发票成功！")}else{if(I.code==1){$.alert("提示","作废发票失败！")}else{if(I.code==2){$.alert("提示","未获取到发票信息！")}else{if(I.code==3){$.alert("提示","获取发票失败！")}else{$.alert("提示","作废发票异常！")}}}}}else{if(H.code==-2){}else{$.alert("提示","作废发票异常！")}}},fail:function(H){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};return{addItems:A,delItems:i,reflashTotal:v,editMoney:u,setGlobeMoney:C,conBtns:c,addbusiOrder:z,addSubmit:E,selePaymethod:B,calchargeInit:y,showErrorInfo:j,pageFlag:n,changePayMethod:r,selectChangePayMethodCd:x,bindChargeModifyReason:b,invaideInvoice:t}})();CommonUtils.regNamespace("order","dealer");order.dealer=(function(){var b=function(){$.ecOverlay("<strong>正在查询发展人类型中,请稍后....</strong>");var l=$.callServiceAsJson(contextPath+"/order/queryPartyProfileSpecList",null);$.unecOverlay();if(l.code==0){OrderInfo.order.dealerTypeList=l.data}else{if(l.code==-2){$.alertM(l.data);return}else{$.alert("信息提示",l.msg);return}}if(OrderInfo.actionFlag!=2&&OrderInfo.actionFlag!=3){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var s=this.prodInstId;var p=$("<tr id='tr_"+s+"' name='tr_"+s+"'></tr>");var q=$("<td></td>");var o=s+"_"+OrderInfo.SEQ.dealerSeq;var m=$('<select id="dealerType_'+o+'" name="dealerType_'+s+'" class="inputWidth183px" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+s+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){m.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")});q.append(m);q.append('<label class="f_red">*</label>');var n="未选号";if(this.accNbr!=undefined&&this.accNbr!=""){n=prodInst.accNbr}p.append("<td>"+n+"</td>");p.append("<td>"+this.objName+"</td>");p.append(q);var r=$('<td><input type="text" id="dealer_'+o+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" class="inputWidth183px" readonly="readonly" ></input></td>');r.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+o+"');\">选择</a>");r.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,'+s+',1)">添加</a><label class="f_red">*</label>');p.append(r);OrderInfo.SEQ.dealerSeq++;$("#dealerTbody").append(p)})})}};var f=function(l,o,n){var m=0;$("select[name="+o+"]").each(function(){if($(this).val()==$(l).val()){m++}});if(m>1){$.alert("信息提示","每个业务的发展人类型不能重复");$(l).val(n)}};var d=function(){$("input[name=attach_dealer]:checked").each(function(){var n=$(this).attr("id");var p=n.split("_")[0];if($("#tr_"+n)[0]==undefined){var l=n+"_"+OrderInfo.SEQ.dealerSeq;var q=c(n,l);if(q==undefined){return false}var s=$("#atr_"+n);var t=$('<tr name="tr_'+n+'"></tr>');t.append("<td>"+s.children().eq(1).text()+"</td>");t.append("<td>"+s.children().eq(2).text()+"</td>");t.append(q);var u=$("#tr_"+p).find("input");var r=1;var o="";if(u[0]==undefined){r=OrderInfo.staff.staffId;o=OrderInfo.staff.staffName}else{r=u.attr("staffId");o=u.attr("value")}var m=$('<td><input type="text" id="dealer_'+l+'" name="dealer_'+n+'" staffId="'+r+'" value="'+o+'" class="inputWidth183px" readonly="readonly" style="margin-left:45px;"></input></td>');m.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+l+"');\">选择</a>");m.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a>');m.append('<a class="purchase" onclick="order.dealer.addProdDealer(this,\''+n+'\')">添加</a><label class="f_red">*</label>');t.append(m);$("#dealerTbody").append(t);OrderInfo.SEQ.dealerSeq++}});easyDialog.close()};var g=function(q,s,n){var l=$(q).parent().parent();var m=s+"_"+OrderInfo.SEQ.dealerSeq;var p=c(s,m);if(p==undefined){return}var o=$('<tr name="tr_'+s+'"></tr>');o.append("<td>"+l.find("td").eq(0).text()+"</td>");o.append("<td>"+l.find("td").eq(1).text()+"</td>");o.append(p);var r=$('<td><input type="text" id="dealer_'+m+'" name="dealer_'+s+'" staffId="'+l.find("input").attr("staffId")+'" value="'+l.find("input").attr("value")+'" class="inputWidth183px" readonly="readonly" ></input></td>');r.append("<a class=\"purchase\" href=\"javascript:order.main.queryStaff(0,'dealer','"+m+"');\">选择</a>");r.append('<a class="purchase" onclick="order.dealer.removeDealer(this);">删除</a><label class="f_red">*</label>');o.append(r);l.after(o);OrderInfo.SEQ.dealerSeq++};var j=function(m,l){$("tr[name^='tr_"+m+"']").each(function(){$(this).find("td").eq(0).text(l)})};var c=function(p,m){var o="";if(OrderInfo.order.dealerTypeList!=undefined&&OrderInfo.order.dealerTypeList.length>0){$.each(OrderInfo.order.dealerTypeList,function(){var r=this.PARTYPRODUCTRELAROLECD;var q=true;$("select[name='dealerType_"+p+"']").each(function(){if(r==$(this).val()){q=false;return false}});if(q){o=r;return false}})}else{$.alert("信息提示","没有发展人类型");return}if(o==undefined||o==""){$.alert("信息提示","每个业务发展人类型不能重复");return}var n=$("<td></td>");var l=$('<select id="dealerType_'+m+'" name="dealerType_'+p+'" class="inputWidth250px" style="width:183px;" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+p+"',a)\"></select>");$.each(OrderInfo.order.dealerTypeList,function(){if(this.PARTYPRODUCTRELAROLECD==o){l.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>")}else{l.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>")}});n.append(l);n.append('<label class="f_red">*</label>');return n};var k=function(){$("#attach_tbody").empty();if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){$.each(OrderInfo.offerSpec.offerRoles,function(){$.each(this.prodInsts,function(){var n=this.prodInstId;var l=OrderInfo.getProdAn(n).accessNumber;if(l==undefined||l==""){l="未选号"}if($("tr[name='tr_"+n+"']")[0]==undefined){var m=$('<tr id="atr_'+n+'" onclick="order.dealer.checkAttach(\''+n+"')\">");m.append('<td><input type="checkbox" id="'+n+'" onclick="order.dealer.checkAttach(\''+n+'\')" name="attach_dealer"/></td></tr>');m.append("<td>"+l+"</td><td>"+this.objName+"</td>");$("#attach_tbody").append(m)}})})}$.each(AttachOffer.openList,function(){var m=this.prodId;var l=OrderInfo.getAccessNumber(m);if(l==undefined||l==""){l="未选号"}$.each(this.specList,function(){var o=m+"_"+this.offerSpecId;if(this.isdel!="Y"&&this.isdel!="C"&&$("tr[name='tr_"+o+"']")[0]==undefined){var n=$('<tr id="atr_'+o+'" onclick="order.dealer.checkAttach(\''+o+"')\">");n.append('<td><input type="checkbox" id="'+o+'" onclick="order.dealer.checkAttach(\''+o+'\')" name="attach_dealer"/></td></tr>');n.append("<td>"+l+"</td><td>"+this.offerSpecName+"</td>");$("#attach_tbody").append(n)}})});$.each(AttachOffer.openServList,function(){var m=this.prodId;var l=OrderInfo.getAccessNumber(m);if(l==undefined||l==""){l="未选号"}$.each(this.servSpecList,function(){var o=m+"_"+this.servSpecId;if(this.isdel!="Y"&&this.isdel!="C"&&$("tr[name='tr_"+o+"']")[0]==undefined){var n=$('<tr id="atr_'+o+'" onclick="order.dealer.checkAttach(\''+o+'\')"><td><input type="checkbox" id="'+o+'" onclick="order.dealer.checkAttach(\''+o+'\')" name="attach_dealer"/></td></tr>');n.append("<td>"+l+"</td><td>"+this.servSpecName+"</td>");$("#attach_tbody").append(n)}})});easyDialog.open({container:"div_attach_dialog"})};var i=function(n){var m=$("#atr_"+n);var l=$("#"+n);if(l.attr("checked")=="checked"){m.removeClass("plan_select");l.attr("checked",false)}else{m.addClass("plan_select");l.attr("checked",true)}};var a=function(l){$(l).parent().parent().remove()
};var h=function(l){$("tr[name^='tr_"+l+"']").each(function(){$(this).remove()})};return{initDealer:b,changeAccNbr:j,showOfferList:k,addProdDealer:g,addAttachDealer:d,checkAttach:i,removeDealer:a,removeAttDealer:h,changeDealer:f}})();CommonUtils.regNamespace("order","memberChange");order.memberChange=function(){var h={};var g=false;var b=function(){if(CONST.getAppDesc()==0&&order.prodModify.choosedProdInfo.is3G=="Y"){$.alert("提示","3G套餐不允许做主副卡成员变更业务！","information");return}var p={offerSpecId:order.prodModify.choosedProdInfo.prodOfferId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var o=query.offer.queryMainOfferSpec(p);if(!o){return}var j=true;$.each(o.offerRoles,function(){if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){j=false;return false}});if(j){$.alert("错误","你选择的套餐不是主副卡套餐，不能进行主副卡成员变更");return}if(!query.offer.setOffer()){return}var i=0;var m=0;var l=0;var k="";$("#memeberChange ul:last li").remove();$.each(OrderInfo.offerSpec.offerRoles,function(q,r){if(r.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==r.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){$("#memeberChange ul:first li").text(this.accessNumber).attr("prodId",r.prodId);h.objInstId=this.objInstId;h.accessNumber=this.accessNumber;return}})}else{if(r.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.offerRoleId==r.offerRoleId&&this.objType==CONST.OBJ_TYPE.PROD){var t=$('<li  id="li_viceCard_new_'+this.accessNumber+'" style="width:100%">').text(this.accessNumber).appendTo($("#memeberChange ul:last"));t.attr("del","N").attr("knew","N").attr("objId",this.objId).attr("objInstId",this.objInstId).attr("objType",this.objType).attr("offerMemberId",this.offerMemberId).attr("offerRoleId",this.offerRoleId);var u=$("<i id='plan_no'><a id='' accNbr='"+this.accessNumber+"' class='purchase' href='javascript:void(0)'>拆副卡</a></i>").appendTo(t);u.click(function(){if(($(this).parent().attr("del")=="N")){$(this).parent().css("text-decoration","line-through").attr("del","Y").attr("knew","N");$(this).find("a").text("不 拆")}else{$(this).parent().css("text-decoration","").attr("del","N").attr("knew","N");$(this).find("a").text("拆副卡");$("#viceCard_new_"+$(this).find("a").attr("accNbr")).html("")}});$("<span  id='viceCard_new_"+this.accessNumber+"'></span>").appendTo(t);var s=$("<i id='plan_no_remain'><a id='' accNbr='"+this.accessNumber+"' class='purchase' href='javascript:void(0)'>保留>>选择新套餐</a></i>").appendTo(t);s.click(function(){order.service.offerDialog("viceCard_new_"+$(this).find("a").attr("accNbr"))});i++}});$.each(r.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){this.minQty=0;this.dfQty=0;m=0;l=this.maxQty;k=r.offerRoleId+"_"+this.objId}})}}});$("#memeberChange h5:last i").remove();if(i<l){l=l-i;var n=$("<i id='plan_no'><label>新增副卡：</label><a class='add'></a><input id='"+k+"' type='text' value='0' class='numberTextBox width22' disabled='disabled'><a class='add2'></a></i>").appendTo($("#memeberChange h5:last"));n.find("a:first").click(function(){var s=parseInt(n.find("input").val());var q=false;var r=$("#memeberChange ul:last li");for(var u=0;u<r.length;u++){if($(r).attr("del")=="Y"){q=true;break}}var t=m;if(q){t=0}if(s<=t){$.alert("提示","副卡数量已经达到最小值，不能再减少。");return}else{n.find("input").val(s-1)}});n.find("a:last").click(function(){var q=parseInt(n.find("input").val());if(q>=l){$.alert("提示","副卡数量已经达到最大值，不能再增加。");return}else{n.find("input").val(q+1)}})}$("#memeberChange .btna_o:last").click(function(){f()});ec.form.dialog.createDialog({id:"-memeberChange",width:480,height:400,initCallBack:function(r,q){order.prodModify.dialogForm=r;order.prodModify.dialog=q},submitCallBack:function(r,q){}})};var a=function(){var w=$("#memeberChange ul li");var t=false;for(var n=0;n<w.length;n++){if($(w[n]).attr("del")=="Y"||$(w[n]).attr("knew")=="Y"){t=true;break}}var o=$("#memeberChange ul:last h5 i input").val();if((t)&&o>0){$.alert("提示","副卡拆机和副卡新装不能同时做，请分开两次操作");return}if(!(t)&&o<=0){$.alert("提示","没有对副卡进行操作。");return}var q=order.prodModify.choosedProdInfo;var v=[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:q.prodOfferInstId,specId:q.prodOfferId,prodId:h.objInstId}];if(o>0){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");var l={memberChange:"Y",type:1,boActionTypeName:"主副卡成员变更",viceCardNum:parseInt(o),feeTypeMain:order.prodModify.choosedProdInfo.feeType,offerNum:1,custId:OrderInfo.cust.custId,actionFlag:6,accessNumber:h.accessNumber,offerSpec:OrderInfo.offerSpec};order.service.setOfferSpec();if(rule.rule.ruleCheck(v)){order.main.buildMainView(l)}order.memberChange.closeDialog()}if(t){var k=[];var m=[];$.each($("#memeberChange ul: li"),function(y,x){if($(this).attr("knew")=="Y"||$(this).attr("del")=="Y"){k.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerRoleId:$(this).attr("addRoleId"),offerSpecId:$(this).attr("addSpecId"),offerMemberId:$(this).attr("offerMemberId"),del:$(this).attr("del"),knew:$(this).attr("knew")})}});var p=[];$.each($("#memeberChange ul: li"),function(y,x){if($(this).attr("del")=="Y"||$(this).attr("knew")=="Y"){p.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerMemberId:$(this).attr("offerMemberId"),offerRoleId:$(this).attr("offerRoleId"),state:"DEL"})}});OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,21,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");var v=[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,instId:h.offerId,specId:h.offerSpecId,prodId:h.objInstId}];var s="removeProd";var u=CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;var j={boActionTypeCd:u,boActionTypeName:CONST.getBoActionTypeName(u),submitFlag:s,viceParam:k,ooRoles:p};var l={areaId:OrderInfo.staff.areaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,boInfos:[]};l.boInfos=v;var r=rule.rule.prepare(l,"order.prodModify.commonPrepare",j);if(r){return}}};var f=function(){if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){order.prodModify.dialogForm.close(order.prodModify.dialog)}};var d=function(i){var j=[];var k=[];var l=[];j=i.viceParam;k=i.ooRoles;l={viceParam:j,ooRoles:k,remark:$("#order_remark").val()};SoOrder.submitOrder(l)};var c=function(j,i){return{areaId:OrderInfo.staff.areaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,boInfos:[{boActionTypeCd:j,instId:i,specId:CONST.PROD_SPEC.CDMA,prodId:i}]}};return{showOfferCfgDialog:b,closeDialog:f,submit:a,offerProd:h,ischooseOffer:g,removeAndAdd:d}}();$(function(){$("#memeberChangeclose").click(function(){order.memberChange.closeDialog()});$("#memeberChange .btna_o:first").click(function(){order.memberChange.closeDialog();order.memberChange.submit()});$("#memeberChange .btna_o:last").click(function(){order.memberChange.closeDialog()})});CommonUtils.regNamespace("order","service");order.service=(function(){var v="";var j=function(z){var G=OrderInfo.cust.custId;var E=$("#searchtext").val();if(E=="请输入您要搜索的套餐名称或首字母简拼"){E=""}var F=order.phoneNumber.boProdAn.level;if(F==undefined&&F==null){F=""}var H=$("#subpageFlag").val();var B={subPage:H,qryStr:E,pnLevelId:F,custId:G,PageIndex:z,PageSize:10};if($("#price_basic").css("display")!="none"){var A=$("#price_basic a.selected").attr("val");if(A!=null&&A!=""){var D=A.split("-");if(D[0]!=null&&D[0]!=""){B.priceMin=D[0]}if(D[1]!=null&&D[1]!=""){B.priceMax=D[1]}}}if($("#influx_basic").css("display")!="none"){var I=$("#influx_basic a.selected").attr("val");if(I!=null&&I!=""){var y=I.split("-");if(y[0]!=null&&y[0]!=""){B.INFLUXMin=y[0]*1024}if(y[1]!=null&&y[1]!=""){B.INFLUXMax=y[1]*1024}}}if($("#invoice_basic").css("display")!="none"){var x=$("#invoice_basic a.selected").attr("val");if(x!=null&&x!=""){var C=x.split("-");
if(C[0]!=null&&C[0]!=""){B.INVOICEMin=C[0]}if(C[1]!=null&&C[1]!=""){B.INVOICEMax=C[1]}}}n(B)};var b=function(y){var x={prodOfferId:y,pnLevelId:"",PageIndex:1,PageSize:10};n(x)};var n=function(y){if(OrderInfo.actionFlag==2){var z=order.prodModify.choosedProdInfo.prodOfferId;if(z!=undefined){y.changeGradeProdOfferId=z}}else{if(CONST.getAppDesc()==0){y.prodOfferFlag="4G"}}var x=contextPath+"/order/offerSpecList";$.callServiceAsHtmlGet(x,y,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(A){if(!A){A.data='<li><a href="#" class="ft">暂无套餐</a></li>'}if(A.code==-2){return}else{if(A.code!=0){$.alert("提示","response.code");return}}$("#service_detial").html(A.data).fadeIn();var B=10;var E=$("#offerlistcont").children().size();if(E==0){var G="<img width='25' height='25' src='"+contextPath+"/image/icon/tip.png'>抱歉，没有找到相关的套餐。";$("#errinfo").html(G);$("#page_navigation").html("")}else{var C=Math.ceil(E/B);$("#current_page").val(0);$("#show_per_page").val(B);var F='<label><span class="pageUpGray" onclick="order.service.previous();">上一页</span></label><label>';var D=0;while(C>D){F+='<a class="page_link" href="javascript:order.service.go_to_page('+D+')" longdesc="'+D+'">'+(D+1)+"</a>";D++}F+='</label><label><span class="nextPageGrayOrange" onclick="order.service.next();">下一页</span></label>';$("#page_navigation").html(F);$("#page_navigation .page_link:first").addClass("pagingSelect");$("#offerlistcont").children().css("display","none");$("#offerlistcont").children().slice(0,B).css("display","table-row");if($(".pagingSelect").next(".page_link").length==false){$(".nextPageGrayOrange").removeClass("nextPageGrayOrange").addClass("nextPageGray")}}},always:function(){$.unecOverlay()},fail:function(A){$.unecOverlay();$.alert("提示","套餐加载失败，请稍后再试！")}})};var q=function(A,B,x){var C={aoId:A,agreementType:B,numLevel:x};var z=contextPath+"/order/queryPackForTerm";var y=$.callServiceAsJson(z,C,{});return y};var r=function(C,x,z){var y=OrderInfo.cust.custId;offerprice=z;if(y==""){$.alert("提示","在订购套餐之前请先进行客户定位！");return}var B={price:z,id:C,specId:x,custId:OrderInfo.cust.custId,areaId:OrderInfo.staff.areaId};if(OrderInfo.actionFlag==2){order.service.opeSer(B)}else{var A=[{boActionTypeCd:"S1",instId:"",specId:x}];if(rule.rule.ruleCheck(A)){order.service.opeSer(B)}}};var a=function(z){var B={offerSpecId:z.specId,offerTypeCd:1,partyId:OrderInfo.cust.custId};var A=query.offer.queryMainOfferSpec(B);if(!A){return}if(OrderInfo.actionFlag==2){offerChange.offerChangeView();return}var y=0;var x=$("#member_tbody");x.html("");$("#main_title").text(OrderInfo.offerSpec.offerSpecName);$.each(A.offerRoles,function(){var E=this;var D=$("<tr style='background:#f8f8f8;'></tr>");var G=$('<td class="borderLTB" style="font-size:14px; padding:0px 0px 0px 12px"><span style="color:#518652; font-size:14px;">'+E.offerRoleName+"</span>&nbsp;&nbsp;</td>");if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){D.append(G).append($("<td colspan='3'></td>")).appendTo(x)}else{D.append(G).appendTo(x)}$.each(this.roleObjs,function(){var I=E.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.PROD){if(E.minQty==0){this.minQty=0;this.dfQty=0}var H=this.maxQty<0?"不限制":this.maxQty;D.append("<td align='left' colspan='3'>"+this.objName+" :<i id='plan_no' style='margin-top: 3px; display: inline-block; vertical-align: middle;'><a class='add' href='javascript:order.service.subNum(\""+I+'",'+this.minQty+");'></a><input id='"+I+"' type='text' value='"+this.dfQty+"' class='numberTextBox width22' readonly='readonly'><a class='add2' href='javascript:order.service.addNum(\""+I+'",'+this.maxQty+");'> </a></i>"+this.minQty+"-"+H+"（张） </td>");y++}});var F=$("<tr></tr>");var C=0;$.each(this.roleObjs,function(){var J=E.offerRoleId+"_"+this.objId;if(this.objType==CONST.OBJ_TYPE.SERV){if(C%4==0){F=$("<tr></tr>");F.appendTo(x)}var I=$('<input id="'+J+'" name="'+E.offerRoleId+'" type="checkbox">'+this.objName+"</input>");if(this.minQty==0){if(this.dfQty>0){I.attr("checked","checked")}}else{if(this.minQty>0){I.attr("checked","checked");I.attr("disabled","disabled")}}var H=$("<td></td>");H.append(I).appendTo(F);C++;y++}})});var B={boActionTypeCd:"S1",boActionTypeName:"订购",offerSpec:A,actionFlag:1,type:1};if(y>1){easyDialog.open({container:"member_dialog"});$("#member_btn").off("click").on("click",function(){order.service.confirm(B)})}else{if(!f(1)){$.alert("错误提示","请选择一个接入产品");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(B)}}};var t=function(x){if(!f()){$.alert("错误提示","请选择一个接入产品");return}if(OrderInfo.actionFlag!=14){order.main.buildMainView(x)}easyDialog.close()};var f=function(y){var z=-1;var x=false;$.each(OrderInfo.offerSpec.offerRoles,function(){var A=this;A.prodInsts=[];$.each(this.roleObjs,function(){if(this.objType==CONST.OBJ_TYPE.PROD){var B=0;if(y==1){B=1}else{B=$("#"+A.offerRoleId+"_"+this.objId).val()}if(B==undefined||B==""){B=0}for(var D=0;D<B;D++){var C=jQuery.extend(true,{},this);C.prodInstId=z--;if(B>1){C.offerRoleName=A.offerRoleName+(D+1)}else{C.offerRoleName=A.offerRoleName}C.memberRoleCd=A.memberRoleCd;A.prodInsts.push(C);x=true}A.selQty=B}else{if(this.minQty==0&&$("#"+A.offerRoleId+"_"+this.objId).attr("checked")=="checked"){this.dfQty=1}}})});return x};var l=function(z,x){var y=Number($("#"+z).val());if(x<0){y+=1;$("#"+z).val(y)}else{if(y<x){y+=1;$("#"+z).val(y)}}};var u=function(z,y){var x=Number($("#"+z).val());if(x>y){x-=1;$("#"+z).val(x)}};var o=function(y){var x=Number($("#"+y).val());x+=1;$("#"+y).val(x)};var i=function(y){var x=Number($("#"+y).val());x-=1;$("#"+y).val(x)};var k=function(){new_page=parseInt($("#current_page").val())-1;if($(".pagingSelect").prev(".page_link").length==true){w(new_page)}};var h=function(){new_page=parseInt($("#current_page").val())+1;if($(".pagingSelect").next(".page_link").length==true){w(new_page)}};var w=function(y){var x=parseInt($("#show_per_page").val());start_from=y*x;end_on=start_from+x;$("#offerlistcont").children().css("display","none").slice(start_from,end_on).css("display","table-row");$(".page_link[longdesc="+y+"]").addClass("pagingSelect").siblings(".pagingSelect").removeClass("pagingSelect");$("#current_page").val(y);if($(".pagingSelect").prev(".page_link").length==true){$(".pageUpGray").removeClass("pageUpGray").addClass("pageUpOrange")}else{$(".pageUpOrange").removeClass("pageUpOrange").addClass("pageUpGray")}if($(".pagingSelect").next(".page_link").length==true){$(".nextPageGray").removeClass("nextPageGray").addClass("nextPageGrayOrange")}else{$(".nextPageGrayOrange").removeClass("nextPageGrayOrange").addClass("nextPageGray")}};var c=0;var d={};var p=function(){$("#search").off("click").on("click",function(){order.service.searchPack()})};var s=function(x){var z={};var y=contextPath+"/order/prodoffer/prepare?subPage="+x;$.callServiceAsHtmlGet(y,z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(A){if(!A){A.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>页面显示失败,稍后重试</strong></div>'}if(A.code!=0){$.alert("提示","页面显示失败,稍后重试");return}var B=$("#offerspecContent");B.html(A.data);order.prepare.backToInit();p();order.prodOffer.queryApConfig();order.service.searchPack();$("#chooseofferspecclose").click(function(){m()});easyDialog.open({container:"chooseofferspec"})}})};var m=function(){if(!$("#chooseofferspec").is(":hidden")){easyDialog.close()}};var g=function(z,H,E,F,x){var A={offerSpecId:H};var C=$.callServiceAsJson(contextPath+"/order/queryOfferSpec",A);if(C.code==0){if(C.data){var B="";var y=C.data.offerSpec;if(y&&y.offerRoles){var G=y.offerRoles;for(var D=0;D<G.length;D++){if(G[D].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD||G[D].memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){if(G[D].memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){B=G[D].offerRoleId;break}}else{B=G[D].offerRoleId;break}}}if(B!=""){m();order.prodModify.chooseOfferForMember(H,F,x,B)}else{$.alert("提示","无法选择套餐，套餐规格查询失败！")}}}else{if(C.code==-2){$.alertM(C.data)}else{$.alert("提示","套餐详细加载失败，请稍后再试！")
}}};return{searchPack:j,queryPackForTerm:q,addNum:l,subNum:u,addNumNoLim:o,subNumNoLim:i,opeSer:a,buyService:r,previous:k,next:h,go_to_page:w,releaseFlag:c,boProdAn:d,offerprice:v,initSpec:p,searchPackById:b,offerDialog:s,choosedOffer:g,setOfferSpec:f,confirm:t}})();CommonUtils.regNamespace("order","main");order.main=(function(){var x=function(C){if(C==undefined||!C){C=u()}$.callServiceAsHtml(contextPath+"/order/main",C,{before:function(){$.ecOverlay("<strong>正在加载中,请稍等...</strong>")},done:function(D){if(!D){D.data="查询失败,稍后重试"}if(D.code!=0){$.alert("提示","查询失败,稍后重试");return}OrderInfo.actionFlag=C.actionFlag;if(OrderInfo.actionFlag==2){offerChange.fillOfferChange(D,C)}else{t(D,C)}},always:function(){$.unecOverlay()}})};var t=function(C,D){order.prepare.showOrderTitle(OrderInfo.actionTypeName,D.offerSpecName,false);SoOrder.initFillPage();$("#order_fill_content").html(C.data);i();p();d(D);if(D.actionFlag==""){OrderInfo.actionFlag=1}if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==13||OrderInfo.actionFlag==14){r();order.dealer.initDealer()}k(D);if(OrderInfo.actionFlag==1){$("#templateOrderDiv").show()}y();order.phoneNumber.initOffer("-1");$("#fillNextStep").off("click").on("click",function(){SoOrder.submitOrder()});if(D.memberChange){$("#orderedprod").hide();$("#order_prepare").hide();$("#productDiv .pdcardcon:first").show();order.prepare.step(1);$("#fillLastStep").off("click").on("click",function(){order.prodModify.cancel()})}else{$("#fillLastStep").off("click").on("click",function(){c()})}};var k=function(C){$.each(OrderInfo.offerSpec.offerRoles,function(){var F=this;for(var D=0;D<this.prodInsts.length;D++){var E=this.prodInsts[D];var H={offerSpecId:OrderInfo.offerSpec.offerSpecId,prodSpecId:E.objId,offerRoleId:E.offerRoleId,prodId:E.prodInstId,queryType:"1,2",objType:E.objType,objId:E.objId,memberRoleCd:E.memberRoleCd};AttachOffer.queryAttachOfferSpec(H);var G={ul_id:"item_order_"+E.prodInstId,prodId:E.prodInstId,offerSpecId:OrderInfo.offerSpec.offerSpecId,compProdSpecId:"",prodSpecId:E.objId,roleCd:F.roleCd,offerRoleId:F.offerRoleId,partyId:OrderInfo.cust.custId};order.main.spec_parm(G)}})};var m=function(C){$(".paymethodChange").each(function(){if($(this).attr("id")!=$(C).attr("id")){$(this).val($(C).val())}})};var j=function(E){if($("#isTemplateOrder").attr("checked")=="checked"){var D=$('select[name="pay_type_-1"]').val();if(E&&$(E).val()){if($(E).val()=="0"&&D!="2100"){$.alert("提示","您选择批开活卡模板，付费方式需改成'预付费'！");$("html").scrollTop(0);return false}}else{var C=$("#templateOrderDiv select").val();if(C){if(C=="0"&&D!="2100"){$.alert("提示","您选择批开活卡模板，付费方式需改成预付费！");$("html").scrollTop(0);return false}}}}return true};var d=function(C){if(C.feeType!=undefined&&C.feeType&&C.feeType!=CONST.PAY_TYPE.NOLIMIT_PAY){$("input[name^=pay_type_][value="+C.feeType+"]").attr("checked","checked");$("input[name^=pay_type_]").attr("disabled","disabled")}};var r=function(){if(OrderInfo.cust.custId==-1){f()}else{if(OrderInfo.actionFlag==6){var E={prodId:order.prodModify.choosedProdInfo.prodInstId,acctNbr:order.prodModify.choosedProdInfo.accNbr};var D=$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",E);if(D.code==-2){$.alertM(D.data);return}var C=D.data;$("#accountDiv").find("label:eq(0)").text("主卡帐户：");$.each(C,function(F,G){$("<option>").text(G.owner+" : "+G.name).attr("value",G.acctId).attr("acctcd",G.acctCd).appendTo($("#acctSelect"))});$("#accountDiv").find("a:eq(0)").hide()}else{var E={custId:OrderInfo.cust.custId};$.callServiceAsJson(contextPath+"/order/account",E,{done:function(F){if(F==undefined){$.alert("提示","帐户查询失败");return}if(F.code==0){var G=F.data;if(G.resultCode==0){if(G.accountInfos&&G.accountInfos.length>0){$.each(G.accountInfos,function(H,I){$("<option>").text("[已有] "+I.owner+" : "+I.name).attr("value",I.acctId).attr("acctcd",I.accountNumber).appendTo($("#acctSelect"))})}}else{$.alert("提示","客户的帐户定位失败，请联系管理员，若要办理新装业务请稍后再试或者使用新建帐户。错误细节："+G.resultMsg)}}else{if(F.code==-2){$.alertM(F.data);return}else{$.alert("提示",F.data)}}f()}})}}};var i=function(){$(".ordertabcon:first").show();$(".ordertab li:first").addClass("setorder");$(".ordertab li").each(function(C){$(this).click(function(){var D=$(this).attr("order");if(D>1){$(".order_copy").show()}else{$(".order_copy").hide()}$(this).addClass("setorder").siblings().removeClass("setorder");$(this).parents(".ordernav").parent().siblings(".ordercon").find(".ordertabcon").eq(C).show().siblings().hide()})})};var p=function(){$.each($(".pdcard"),function(C,D){$(this).find("li:first").addClass("setcon");$.each($(this).find("li"),function(F,E){$(this).click(function(){$(this).addClass("setcon").siblings().removeClass("setcon");$(this).parent().parent().next(".cardtabcon").find(".pdcardcon").eq(F).show().siblings().hide()})})})};var y=function(){$("#acctQueryForm").bind("formIsValid",function(F,E){var C;if($("#chooseQueryAcctType").val()==1){var G={accessNumber:$("#d_query_nbr input").val()};C=z(G)}else{var G={acctCd:$("#d_query_cd input").val()};C=z(G)}$("#acctListTab tbody").empty();if(C.code==0){var D=C.data;if(D.resultCode==0){if(D.accountInfos&&D.accountInfos.length>0){$("#acctPageDiv").empty();common.page.init("acctPageDiv",5,"pageId","queryAccount",D.accountInfos)}else{$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+D.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+C.data+"</td</tr>").appendTo($("#acctListTab tbody"))}}).ketchup({bindElement:"querAcctBtn"});$("#zhanghuclose").click(function(){easyDialog.close();$(document).removeJEventListener("chooseAcct")});$(this).addJEventListener("queryAccount",function(C){h(C)});$("#chooseQueryAcctType").change(function(){if($(this).val()==1){$("#d_query_cd").remove();$("#querAcctBtn").parent().before("<dd id='d_query_nbr'>&nbsp;<input type='text' data-validate='validate(required:接入号不能为空) on(keyup blur)' value='' class='inputWidth150px'></dd>")}else{$("#d_query_nbr").remove();$("#querAcctBtn").parent().before("<dd id='d_query_cd'>&nbsp;<input type='text' data-validate='validate(required:合同号不能为空) on(keyup blur)' value='' class='inputWidth150px' ></dd>")}});$("#chooseQueryAcctType").change();$("#acctSelect").change(function(){if($(this).val()>0){$(this).parent().find("a:eq(1)").show();$("#defineNewAcct").hide()}else{$(this).parent().find("a:eq(1)").hide();$("#defineNewAcct").show()}})};var z=function(D){var C=$.callServiceAsJson(contextPath+"/order/account",D);if(C.code==-2){$.alertM(C.data);return}return C};var h=function(C){$("#acctListTab tbody").empty();$.each(C,function(D,F){var E=$("<tr></tr>").appendTo($("#acctListTab tbody"));if(F.name){$("<td class='teleNum'>"+F.name+"</td>").appendTo(E)}else{$("<td></td>").appendTo(E)}if(F.acctId){$("<td acctId='"+F.acctId+"'>"+F.accountNumber+"</td>").appendTo(E)}else{$("<td></td>").appendTo(E)}if(F.owner){$("<td>"+F.owner+"</td>").appendTo(E)}else{$("<td></td>").appendTo(E)}if(F.accessNumber){$("<td>"+F.accessNumber+"</td>").appendTo(E)}else{$("<td></td>").appendTo(E)}E.click(function(){var H=false;var G=$("#acctSelect").find("option");$.each(G,function(J,I){if(I.value==F.acctId){$("#acctSelect").find("option[value="+I.value+"]").attr("selected","selected");H=true;return false}});$(this).dispatchJEvent("chooseAcct",F);easyDialog.close();$("#defineNewAcct").hide()})})};var a=function(C){};function g(C){$.callServiceAsHtmlGet(contextPath+"/order/orderSpecParam",C,{done:function(D){if(D&&D.code==-2){if(C.prodId!=-1&&C.prodId!="-1"){$("#"+C.ul_id).append("<li><label> </label></li>")}return}else{if(D&&(D.data==0||D.data=="0")){if(C.prodId!=-1&&C.prodId!="-1"){$("#"+C.ul_id).append("<li><label> </label></li>")}return}}$("#"+C.ul_id).append(D.data)},fail:function(D){$.unecOverlay()}})}function w(){if(!B("order_spc_update")){return}var D=new Array();var E=0;$("#order_spc_update input").each(function(){if($(this).attr("id")!="order_remark"&&$(this).attr("id")!="isTemplateOrder"&&$(this).attr("id")!="templateOrderName"&&$(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var I={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};
D.push(I);E++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var H={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};D.push(H);E++}if($(this).val()!=null&&$(this).val()!=""){var G={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};D.push(G);E++}}}}}});$("#order_spc_update select").each(function(){if($(this).attr("id")!="templateOrderType"){if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){if("1"==$(this).attr("addtype")){if($(this).val()!=null&&$(this).val()!=""){var I={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};D.push(I);E++}}else{if($(this).val()!=$(this).attr("oldValue")){if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){var H={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"DEL",value:$(this).attr("oldValue")};D.push(H);E++}if($(this).val()!=null&&$(this).val()!=""){var G={itemSpecId:$(this).attr("itemSpecId"),prodSpecItemId:$(this).attr("prodSpecItemId"),state:"ADD",value:$(this).val()};D.push(G);E++}}}}}});var C;if($("#order_remark").val()){C=[{atomActionId:OrderInfo.SEQ.atomActionSeq--,itemSpecId:CONST.ITEM_SPEC_ID_CODE.busiOrderAttrs,value:$("#order_remark").val()}];E++}if(E<1){$.alert("提示","您未修改订单属性");return}var F={boProdItems:D};if(C){F.busiOrderAttrs=C}OrderInfo.actionFlag=33;SoOrder.submitOrder(F)}function B(D){var C=true;$("#"+D).find("input").each(function(){if(C){C=o(this)}});return C}function o(G){if($(G).attr("check_option")=="N"){if($(G).val()==null||$(G).val()==""){$.alert("提示",$(G).attr("check_name")+" 尚未填写");return false}}if($(G).attr("check_type")=="check"){var C=$(G).attr("check_len");if(C>0){if($(G).val().length>C){$.alert("提示",$(G).attr("check_name")+" 长度过长(<"+C+")");return false}}var D=$(G).attr("check_mask");if(D!=null&&$(G).val()!=null&&$(G).val()!=""){var F=new RegExp(D);if(!F.test($(G).val())){$.alert("提示",$(G).attr("check_name")+" 校验失败："+$(G).attr("check_mess"));return false}}var E=$(G).val().length;if(E>0&&$(G).attr("dataType")=="3"){if(!/^[0-9]+$/.test($(G).val())){$.alert("提示",$(G).attr("check_name")+" 非数字，请修改");return false}}else{if(E>0&&$(G).attr("dataType")=="5"){if(!/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test($(G).val())){$.alert("提示",$(G).attr("check_name")+" 非小数，请修改");return false}}else{if(E>0&&($(G).attr("dataType")=="4"||$(G).attr("dataType")=="16")){}}}}return true}$("staff_dialog_close").onclick=function(){easyDialog.close()};function v(C){q(C,$("#dealer_id").val(),$("#objInstId").val())}function q(D,C,F){var E={dealerId:C,staffName:$("#qryStaffName").val(),staffCode:$("#qryStaffCode").val(),salesCode:$("#qrySalesCode").val(),pageIndex:D,objInstId:F,pageSize:10};$.callServiceAsHtml(contextPath+"/staffMgr/getStaffList",E,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(G){if(!G){G.data=""}$("#div_staff_dialog").html(G.data);$("#staff_list_body tr").each(function(){$(this).off("click").on("click",function(H){l("#staff_list_body tr",this);H.stopPropagation()})});easyDialog.open({container:"div_staff_dialog"})}})}var l=function(E,D){$(E).removeClass("plan_select");$(E).children(":first-child").html("");$(D).addClass("plan_select");var C="<i class='select'></i>";$(D).children(":first").html(C)};function b(D){var C=$("#staff_list_body .plan_select");C.each(function(){$("#dealer_"+D).val($(this).attr("staffName")).attr("staffId",$(this).attr("staffId"))});if(C.length>0){easyDialog.close()}else{$.alert("操作提示","请选择 协销人！")}}var n=function(){$("#acctDialog .contract_list td").text("帐户查询");$("#acctDialog .selectList").show();easyDialog.open({container:"acctDialog"});var C="chooseAcct";var D=$("#acctSelect");if(!D.hasJEventListener(C)){D.addJEventListener(C,function(F){var E=false;$.each(D.find("option"),function(G,H){if($(H).val()==F.acctId){E=true;return false}});if(E==false){$("<option>").text(F.owner+" : "+F.name).attr("value",F.acctId).attr("acctcd",F.accountNumber).appendTo(D)}D.find("option[value="+F.acctId+"]").attr("selected","selected");if(F.acctId>0){$("#account").find("a:eq(1)").show()}})}$("#acctListTab tbody").empty();$("#acctPageDiv").empty()};var f=function(){$("#acctSelect").append("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>");$("#acctSelect").find("option[value='-1']").attr("selected","selected");$("#acctName").val(OrderInfo.cust.partyName);$("#defineNewAcct").show();$("#account").find("a:gt(0)").hide();window.setTimeout("order.main.showNewAcct()",0)};var s=function(){acct.acctModify.getBILL_POST(function(){acct.acctModify.paymentType();acct.acctModify.billPostType()})};var A=function(){var E=$("#acctSelect");if(!E.val()){$.alert("提示","请选择一个帐户")}if(E.val()==-1){$.alert("提示","该帐户是新建帐户");return}else{$("#acctDialog .contract_list td").text("帐户信息");$("#acctDialog .selectList").hide();var F={acctCd:E.find("option:selected").attr("acctcd")};var C=z(F);var D=C.data;h(D.accountInfos);$("#acctListTab tr").off("click");easyDialog.open({container:"acctDialog"})}};var c=function(){$.confirm("信息","确定回到上一步吗？",{yes:function(){var E=OrderInfo.boProdAns;var D=order.service.boProdAn;var C=OrderInfo.boProd2Tds;if(C.length>0){for(var G=0;G<C.length;G++){var F={numType:2,numValue:C[G].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",F,{done:function(){}})}}if(E.length>0){for(var G=0;G<E.length;G++){if(E[G].idFlag){continue}var F={numType:1,numValue:E[G].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",F)}}order.phoneNumber.resetBoProdAn();$("#order_fill_content").empty();order.prepare.showOrderTitle();$("#order_tab_panel_content").show();order.prepare.step(1)},no:function(){}},"question")};var u=function(){return{boActionTypeCd:S1,boActionTypeName:"订购",offerSpecId:1234,offerSpecName:"乐享3G-129套餐",feeType:1200,viceCardNum:3,offerNum:3,type:1,terminalInfo:{terminalName:"IPhone5",terminalCode:"46456457345"},offerRoles:[{offerRoleId:1234,offerRoleName:"主卡",memberRoleCd:"0",roleObjs:[{offerRoleId:1,objId:CONST.PROD_SPEC.CDMA,objName:"CDMA",objType:2}]},{offerRoleId:2345,offerRoleName:"副卡",memberRoleCd:"1"}]}};return{buildMainView:x,copyOrder:a,spec_parm:g,check_parm:B,queryStaff:q,queryStaffPage:v,setStaff:b,chooseAcct:n,check_parm_self:o,createAcct:f,showNewAcct:s,acctDetail:A,spec_parm_change_save:w,paymethodChange:m,templateTypeCheck:j,lastStep:c}})();CommonUtils.regNamespace("order","prodModify");order.prodModify=(function(){var authFlag="";var _coupon="";var lteFlag=(CONST.getAppDesc()==0)?true:false;var _ischooseOffer=false;var _choosedProdInfo={};var _profiles=[];var _profileTabLists=[];var _getChooseProdInfo=function(){var prodInfoTr=$("#phoneNumListtbody tr[class='plan_select']").find("td:eq(0)");if(prodInfoTr.attr("accNbr")==undefined){prodInfoTr=$("#phoneNumListtbody tr[class='bg plan_select']").find("td:eq(0)")}var prodInfoChildTr=$("#subphoneNumListtbody tr[class='plan_select2']").find("td:eq(0)");_choosedProdInfo={accNbr:prodInfoTr.attr("accNbr"),productName:prodInfoTr.attr("productName"),prodStateName:prodInfoTr.attr("prodStateName"),feeTypeName:prodInfoTr.attr("feeTypeName"),prodInstId:prodInfoTr.attr("prodInstId"),prodStateCd:prodInfoTr.attr("prodStateCd"),productId:prodInfoTr.attr("productId"),feeType:prodInfoTr.attr("feeType"),prodClass:$(prodInfoTr).attr("prodClass"),stopRecordCd:prodInfoTr.attr("stopRecordCd"),stopRecordName:prodInfoTr.attr("stopRecordName"),prodOfferName:prodInfoChildTr.attr("prodOfferName"),custName:prodInfoChildTr.attr("custName"),startDt:prodInfoChildTr.attr("startDt"),endDt:prodInfoChildTr.attr("endDt"),prodOfferId:prodInfoChildTr.attr("prodOfferId"),prodOfferInstId:prodInfoChildTr.attr("prodOfferInstId"),custId:prodInfoChildTr.attr("custId"),is3G:prodInfoChildTr.attr("is3G"),areaCode:prodInfoTr.attr("zoneNumber"),areaId:prodInfoTr.attr("areaId")};
order.prodModify.choosedProdInfo=_choosedProdInfo};var _getCallRuleParam=function(boActionTypeCd,prodId){return{areaId:OrderInfo.staff.areaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,boInfos:[{boActionTypeCd:boActionTypeCd,instId:prodId,specId:CONST.PROD_SPEC.CDMA,prodId:prodId}]}};var _updateCheckByChange=function(actionClassCd,boActionTypeCd,prodStatusCd,toprodStatusCd){var data={orderList:{orderListInfo:{isTemplateOrder:"N",templateType:"1",staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,areaId:OrderInfo.staff.areaId,partyId:_choosedProdInfo.custId,olTypeCd:CONST.OL_TYPE_CD.FOUR_G},custOrderList:[{busiOrder:[]}]}};data.orderList.custOrderList[0].busiOrder=[{areaId:OrderInfo.staff.areaId,boActionType:{actionClassCd:actionClassCd,boActionTypeCd:boActionTypeCd},busiObj:{accessNumber:_choosedProdInfo.accNbr,instId:_choosedProdInfo.prodInstId,isComp:"N",objId:CONST.PROD_SPEC.CDMA,offerTypeCd:"1"},busiOrderInfo:{seq:OrderInfo.SEQ.seq},data:{boProdStatuses:[{atomActionId:OrderInfo.SEQ.atomActionSeq--,prodStatusCd:prodStatusCd,state:"DEL"},{atomActionId:OrderInfo.SEQ.atomActionSeq--,prodStatusCd:toprodStatusCd,state:"ADD"}]}}];params=JSON.stringify(data);var url=contextPath+"/order/prodModify/updateCheckByChange";var response=$.callServiceAsJson(url,params,{});var msg="";if(response.code==0){return true}else{if(response.code==-2){$.alertM(response.data);return false}else{msg=response.data;$.alert("提示","预校验失败!失败原因为："+msg);return false}}};var _showChangeCard=function(){prod.changeUim.init()};var _showAddComp=function(){var compspecparam={productId:_choosedProdInfo.productId};if(getCompInfo(compspecparam)==""){return}var param={areaId:OrderInfo.staff.areaId,custId:OrderInfo.cust.custId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,boInfos:[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP,instId:_choosedProdInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA}]};var callParam={prodInstId:_choosedProdInfo.prodInstId,productId:_choosedProdInfo.productId};var checkRule=rule.rule.prepare(param,"order.prodModify.addComp",callParam)};var _showRemoveComp=function(){var compspecparam={productId:_choosedProdInfo.productId};if(getCompInfo(compspecparam)==""){return}var param={areaId:OrderInfo.staff.areaId,custId:OrderInfo.cust.custId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,boInfos:[{boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP,instId:_choosedProdInfo.prodInstId,specId:CONST.PROD_SPEC.CDMA}]};var callParam={prodInstId:_choosedProdInfo.prodInstId,productId:_choosedProdInfo.productId};var checkRule=rule.rule.prepare(param,"order.prodModify.removeComp",callParam)};var _queryOfferSpec=function(){var offerSpecId=_choosedProdInfo.prodOfferId;var offerId=_choosedProdInfo.prodOfferInstId;_offerProd.offerId=offerId;_offerProd.offerSpecId=offerSpecId;if(offerSpecId==undefined||offerSpecId==""){return{}}else{var param={offerSpecId:offerSpecId};var response=$.callServiceAsJson(contextPath+"/order/queryOfferSpec",param);if(response.code==0){if(response.data){_offerSpec=response.data.offerSpec}}}return _offerSpec};var _showLossRepProd=function(){var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";if(_choosedProdInfo.prodStateCd=="100000"){inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.LOSSREP_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}}else{if((_choosedProdInfo.stopRecordCd.indexOf("110000")>=0)&&(_choosedProdInfo.prodStateCd=="120000")){inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISLOSSREP_PROD}else{if(_choosedProdInfo.prodStateCd=="120000"){$.alert("提示","产品状态为停机且有挂失过才能解挂","information");return}else{if(_choosedProdInfo.prodStateCd!="100000"){$.alert("提示","产品状态为在用时才能挂失","information");return}}}}var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showStopKeepNumProd=function(){var submitState="";var BO_ACTION_TYPE="";var inprodStatusCd="";var intoprodStatusCd="";if(_choosedProdInfo.prodStateCd=="100000"){BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.STOPKEEPNUM;inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}}else{if((_choosedProdInfo.stopRecordCd.indexOf("120000")>=0)&&(_choosedProdInfo.prodStateCd=="120000")){BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISSTOPKEEPNUM;inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}else{$.alert("提示","产品状态为在用时才能停机保号或停机保号才能进行停机保号复机","information");return}}var param=_getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,prodOfferName:_choosedProdInfo.prodOfferName,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam)};var _showCustInfoModify=function(){if("-1"==OrderInfo.cust.custId){$("#cCustName").val(OrderInfo.boCustInfos.name);$("#cCustIdCard").val(OrderInfo.boCustIdentities.identityNum);$("#partyTypeCd option[value='"+OrderInfo.boCustInfos.partyTypeCd+"']").attr("selected",true);$("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']").attr("selected",true);$("#cAddressStr").val(OrderInfo.boCustInfos.addressStr);order.cust.identidiesTypeCdChoose($("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']"));tabProfileFlag="1";$("#contactAddress").val(OrderInfo.boPartyContactInfo.contactAddress);$("#contactDesc").val(OrderInfo.boPartyContactInfo.contactDesc);$("#contactEmployer").val(OrderInfo.boPartyContactInfo.contactEmployer);$("#contactGender option[value='"+OrderInfo.boPartyContactInfo.contactGender+"']").attr("selected",true);$("#contactName").val(OrderInfo.boPartyContactInfo.contactName);$("#contactType option[value='"+OrderInfo.boPartyContactInfo.contactType+"']").attr("selected",true);$("#eMail").val(OrderInfo.boPartyContactInfo.eMail);$("#fax").val(OrderInfo.boPartyContactInfo.fax);$("#headFlag option[value='"+OrderInfo.boPartyContactInfo.headFlag+"']").attr("selected",true);$("#homePhone").val(OrderInfo.boPartyContactInfo.homePhone);$("#mobilePhone").val(OrderInfo.boPartyContactInfo.mobilePhone);$("#officePhone").val(OrderInfo.boPartyContactInfo.officePhone);$("#postAddress").val(OrderInfo.boPartyContactInfo.postAddress);$("#postcode").val(OrderInfo.boPartyContactInfo.postcode);easyDialog.open({container:"user_add"})}else{var submitState="";var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.CUSTINFOMODIFY;submitState="ADD";var param=_getCallRuleParam(BO_ACTION_TYPE,null);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:"",prodOfferName:"",state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,4,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.custInfoModify",callParam);if(checkRule){return}}};var _showActiveReturn=function(){if(_choosedProdInfo.prodStateCd!=CONST.PROD_STATUS_CD.READY_PROD){$.alert("提示","产品必须为预开通时才能进行改客户资料返档","information");
return}var submitState="";var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACTIVERETURN;submitState="ADD";var param=_getCallRuleParam(BO_ACTION_TYPE,null);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:"",prodOfferName:"",state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,9,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.custInfoModify",callParam);if(checkRule){return}};var _showAcctInfoModify=function(){var submitState="";var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACCTINFOMODIFY;submitState="ADD";var param=_getCallRuleParam(BO_ACTION_TYPE,null);var callParam={boActionTypeCd:BO_ACTION_TYPE,boActionTypeName:CONST.getBoActionTypeName(BO_ACTION_TYPE),accessNumber:"",prodOfferName:"",state:submitState};OrderInfo.initData(CONST.ACTION_CLASS_CD.ACCT_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");var checkRule=rule.rule.prepare(param,"order.prodModify.acctInfoModify",callParam);if(checkRule){return}};var _form_custInfomodify_btn=function(){$("#custModifyForm").off("formIsValid").on("formIsValid",function(event){var modifyCustInfo={};modifyCustInfo={custName:$.trim($("#cmCustName").val()),identidiesTypeCd:$("#div_cm_identidiesType  option:selected").val(),custIdCard:$.trim($("#cmCustIdCard").val()),addressStr:$.trim($("#cmAddressStr").val())};var data={};data.boCustInfos=[{areaId:OrderInfo.staff.areaId,name:$("#boCustIdentities").attr("partyName"),norTaxPayerId:"0",partyTypeCd:$("#boCustIdentities").attr("partyTypeCd"),addressStr:$("#boCustIdentities").attr("addressStr"),state:"DEL"},{areaId:OrderInfo.staff.areaId,name:modifyCustInfo.custName,norTaxPayerId:"0",partyTypeCd:$("#cmPartyTypeCd  option:selected").val(),addressStr:modifyCustInfo.addressStr,state:"ADD"}];if(OrderInfo.cust.idCardNumber==""||OrderInfo.cust.idCardNumber==null){data.boCustIdentities=[{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD"}]}else{data.boCustIdentities=[{identidiesTypeCd:OrderInfo.cust.identityCd,identityNum:OrderInfo.cust.idCardNumber,isDefault:"Y",state:"DEL"},{identidiesTypeCd:modifyCustInfo.identidiesTypeCd,identityNum:modifyCustInfo.custIdCard,isDefault:"Y",state:"ADD"}]}data.boCustProfiles=[];for(var i=0;i<order.prodModify.profiles.length;i++){var profilesObj=order.prodModify.profiles[i];var profilesDel={};var profilesAdd={};profilesDel={partyProfileCatgCd:profilesObj.attrId,profileValue:profilesObj.defaultValue,state:"DEL"};profilesAdd={partyProfileCatgCd:profilesObj.attrId,profileValue:$.trim($("#profiles_"+profilesObj.attrId).val()),state:"ADD"};if(document.getElementById("profiles_"+profilesObj.attrId)&&profilesObj.profileValue!=$.trim($("#profiles_"+profilesObj.attrId).val())){data.boCustProfiles.push(profilesDel);data.boCustProfiles.push(profilesAdd)}}data.boPartyContactInfo=[];var _boPartyContactInfoOld={contactId:$("#modTabProfile0").attr("contactId"),statusCd:"100001",contactName:$("#modTabProfile0").attr("contactName"),headFlag:$("#modTabProfile0").attr("headFlag"),state:"DEL"};var _boPartyContactInfo={contactAddress:$.trim($("#contactAddress").val()),contactDesc:$.trim($("#contactDesc").val()),contactEmployer:$.trim($("#contactEmployer").val()),contactGender:$.trim($("#contactGender").val()),contactId:$.trim($("#contactId").val()),contactName:$.trim($("#contactName").val()),contactType:$.trim($("#contactType").val()),eMail:$.trim($("#eMail").val()),fax:$.trim($("#fax").val()),headFlag:$("#headFlag  option:selected").val(),homePhone:$.trim($("#homePhone").val()),mobilePhone:$.trim($("#mobilePhone").val()),officePhone:$.trim($("#officePhone").val()),postAddress:$.trim($("#postAddress").val()),postcode:$.trim($("#postCode").val()),staffId:OrderInfo.staff.staffId,state:"ADD",statusCd:"100001"};if($("#modTabProfile0").attr("click")=="0"){if(_boPartyContactInfoOld.contactId!=""){data.boPartyContactInfo.push(_boPartyContactInfoOld);data.boPartyContactInfo.push(_boPartyContactInfo)}else{data.boPartyContactInfo.push(_boPartyContactInfo)}}SoOrder.submitOrder(data)}).ketchup({bindElement:"custInfoModifyBtn"})};var _partyTypeCdChoose=function(scope){var partyTypeCd=$(scope).val();$("#cm_identidiesTypeCd").empty();_certTypeByPartyType(partyTypeCd);_identidiesTypeCdChoose($("#div_cm_identidiesType").children(":first-child"))};var _partyType=function(partyTypeCd){if(partyTypeCd==1){var identidiesTypeCdHtml='<select id="cmIdentidiesTypeCd" onchange="order.prodModify.identidiesTypeCdChoose(this)"><option value="1" >身份证</option><option value="2">军官证</option></select>'}else{if(partyTypeCd==2){var identidiesTypeCdHtml='<select id="cmIdentidiesTypeCd" onchange="order.prodModify.identidiesTypeCdChoose(this)"><option value="3">护照</option><option value="23">ICP经营许可证</option><option value="39">税务登记号</option></select>'}}$("#div_cm_identidiesType").html(identidiesTypeCdHtml)};var _certTypeByPartyType=function(_partyTypeCd){var params={partyTypeCd:_partyTypeCd};var url=contextPath+"/cust/queryCertType";var response=$.callServiceAsJson(url,params,{});if(response.code==-2){$.alertM(response.data)}if(response.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(response.code==0){var data=response.data;if(data!=undefined&&data.length>0){for(var i=0;i<data.length;i++){var certTypedate=data[i];$("#cm_identidiesTypeCd").append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>")}}}};var _identidiesTypeCdChoose=function(scope){var identidiesTypeCd=$(scope).val();if(identidiesTypeCd==undefined){identidiesTypeCd=$("#div_cm_identidiesType  option:selected").val()}if(identidiesTypeCd==1){$("#cmCustIdCard").attr("placeHolder","请输入合法身份证号码");$("#cmCustIdCard").attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)")}else{if(identidiesTypeCd==2){$("#cmCustIdCard").attr("placeHolder","请输入合法军官证");$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(identidiesTypeCd==3){$("#cmCustIdCard").attr("placeHolder","请输入合法护照");$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#cmCustIdCard").attr("placeHolder","请输入合法证件号码");$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}_form_custInfomodify_btn()};var _custInfoModify=function(callParam){var param={};param.partyName=OrderInfo.cust.partyName;param.custId=OrderInfo.cust.custId;param.idCardNumber=OrderInfo.cust.idCardNumber;param.boActionTypeName=callParam.boActionTypeName;$.callServiceAsHtml(contextPath+"/order/prodModify/custInfoModify",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(response){if(response.code==-2){$.alertM(response.data);return}if(response.data=="false\r\n"){$.alert("提示","抱歉，查询无返回客户详情信息。");return}var content$=$("#order_fill_content");content$.html(response.data).show();_partyTypeCdChoose($("#cmPartyTypeCd  option:selected"));$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected",true);_identidiesTypeCdChoose($("#cm_identidiesTypeCd option[selected='selected']"));$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();$("#step1").show();$(".ordercon a:first span").text("取 消");_form_custInfomodify_btn()},always:function(){$.unecOverlay()}})};var _lossRepProd=function(callParam){param=_choosedProdInfo;$.extend(param,callParam);$.callServiceAsHtml(contextPath+"/order/prodModify/lossRepProd",param,{before:function(){},done:function(response){var content$=$("#order_prepare");content$.html(response.data).show();$(".ordercon").show();$(".ordertabcon").show();$("#step1").show();$("#custInfo").hide();$(".ordercon a:first span").text("取 消")},always:function(){$.unecOverlay()}});SoOrder.builder(CONST.ACTION_CLASS_CD.PROD_ACTION,param.boActionTypeCd)};var _lossRepProdSubmit=function(param){var data={};data.orderRemark=$.trim($("#order_remark").val());
data.boProdStatuses=[{prodStatusCd:8,state:submitState}];SoOrder.submitOrder(data)};var _closeDialog=function(){if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){order.prodModify.dialogForm.close(order.prodModify.dialog)}};var _removeCommit=function(prodStatusCd,boActionType,templateType){var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=prodStatusCd;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:boActionType,boActionTypeName:CONST.getBoActionTypeName(boActionType),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD"};OrderInfo.order.templateType=templateType;var v_actionFlag=0;if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){v_actionFlag=19}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _showMemberWin=function(){_ischooseOffer=false;var viceCount=0;var offerMemberInfos=OrderInfo.offer.offerMemberInfos;$.each($("#delPhoneNumber ul:last li"),function(i,li){$(this).remove()});$.each(offerMemberInfos,function(i,offerMember){if(offerMember.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD&&offerMember.roleCd!=CONST.MEMBER_ROLE_CD.VICE_CARD){return false}if(offerMember.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&_choosedProdInfo.accNbr==offerMember.accessNumber){return false}if(offerMember.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD&&offerMember.objType==CONST.OBJ_TYPE.PROD){$("#delPhoneNumber ul:first h5").text(offerMember.roleName);$("#delPhoneNumber ul:first li").text(offerMember.accessNumber)}else{if(offerMember.roleCd==CONST.MEMBER_ROLE_CD.VICE_CARD&&offerMember.objType==CONST.OBJ_TYPE.PROD){if(offerMember.accessNumber){$("#delPhoneNumber ul:last h5").text(offerMember.roleName);var li=$("<li class='full'>").text(offerMember.accessNumber).appendTo($("#delPhoneNumber ul:last"));var objId=offerMember.objId;var objInstId=offerMember.objInstId;var objType=offerMember.objType;var offerMemberId=offerMember.offerMemberId;var offerRoleId=offerMember.offerRoleId;var accessNumber=offerMember.accessNumber;li.attr("del","Y").attr("accessNumber",accessNumber).attr("objId",objId).attr("objInstId",objInstId).attr("objType",objType).attr("offerMemberId",offerMemberId).attr("offerRoleId",offerRoleId);$("<span  id='viceCard_"+offerMember.accessNumber+"'></span>").appendTo(li);var eleI=$("<i id='plan_no'><a id='' class='purchase' href='javascript:void(0)'>保留>>选择新套餐</a></i>").appendTo(li);eleI.click(function(){order.service.offerDialog("viceCard_"+offerMember.accessNumber)})}}}viceCount++});if(viceCount>1){return true}else{return false}};var _chooseOfferForMember=function(specId,subpage,specName,offerRoleId){$("#"+subpage).html("&nbsp;&nbsp;<span style='color: #327501;'>订购新套餐：</span>"+specName);$("#"+subpage).parent().attr("addSpecId",specId).attr("addRoleId",offerRoleId).attr("del","N");_ischooseOffer=true;if(document.getElementById("li_"+subpage)){$("#li_"+subpage).css("text-decoration","").attr("del","N").attr("knew","Y");$("#li_"+subpage).find("i:first-child").find("a").text("拆副卡")}};var _removeAndAdd=function(prodStatusCd,boActionType,templateType){var viceparam=[];$.each($("#delPhoneNumber ul:last li"),function(i,li){viceparam.push({objId:$(this).attr("objId"),objInstId:$(this).attr("objInstId"),objType:$(this).attr("objType"),offerRoleId:$(this).attr("addRoleId"),offerSpecId:$(this).attr("addSpecId"),offerMemberId:$(this).attr("offerMemberId"),accessNumber:$(this).attr("accessNumber"),del:$(this).attr("del")})});var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=prodStatusCd;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);var submitFlag=(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK?"buyBack":"removeAndRetainVice");var callParam={boActionTypeCd:boActionType,boActionTypeName:CONST.getBoActionTypeName(boActionType),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD",submitFlag:submitFlag,viceParam:viceparam};OrderInfo.order.templateType=templateType;var v_actionFlag=0;if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){v_actionFlag=20}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _commonShowDialog=function(){$("#delPhoneNumber .btna_o:last").click(function(){_closeDialog()});ec.form.dialog.createDialog({id:"-delephone",width:480,height:400,initCallBack:function(dialogForm,dialog){order.prodModify.dialogForm=dialogForm;order.prodModify.dialog=dialog},submitCallBack:function(dialogForm,dialog){}})};var _showOweRemoveProd=function(){var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8)}};var _showRemoveProd=function(){var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.REMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.REMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1)}};var _showOrderRemoveProd=function(){var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.PREMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1)}};var _showCoverOrderRemoveProd=function(){var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD"};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),"");var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _showBreakRuleRemoveProd=function(){var inprodStatusCd=_choosedProdInfo.prodStateCd;
var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1)}};var _showNoActiveRemoveProd=function(){if(_choosedProdInfo.prodStateCd!="140000"){$.alert("提示","产品状态为未激活(预开通)时才能拆机","information");return}var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD;var inprodStatusCd="";var intoprodStatusCd="";inprodStatusCd=_choosedProdInfo.prodStateCd;intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;if(inprodStatusCd==""){inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),accessNumber:_choosedProdInfo.accNbr,prodStatusCd:inprodStatusCd,toprodStatusCd:intoprodStatusCd,itemSpecId:CONST.BUSI_ORDER_ATTR.REMOVE_REASON,state:"ADD"};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),"");var flag=rule.rule.prepare(param,"order.prodModify.commonPrepare",callParam);if(flag){return}};var _commonPrepare=function(param){$.callServiceAsHtml(contextPath+"/order/prodModifyCommon",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#ordercon").show();$("#ordertabcon").show();order.prepare.step(1);OrderInfo.order.step=1;$("#orderedprod").hide();$("#order_prepare").hide();$(".ordercon a:first span").text("取 消");$(".main_body").css("height","150px");$(".main_body").css("min-height","150px");$("#order_confirm").empty();$("#fillLastStep").click(function(){order.prodModify.cancel()});$("#fillNextStep").unbind("click").bind("click",function(){if(param.submitFlag=="removeAndRetainVice"){_commitRetainVice(param)}else{if(param.submitFlag=="buyBack"){_commitBuyBack(param)}else{if(param.submitFlag=="removeProd"){order.memberChange.removeAndAdd(param)}else{_commonSubmit(param.boActionTypeCd,param.prodStatusCd,param.toprodStatusCd,param.itemSpecId,param.state)}}}OrderInfo.order.step=2});$("#templateOrderDiv").hide();if(param.boActionTypeCd==CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD){$("#templateOrderDiv").show()}},always:function(){$.unecOverlay()}})};var _commitRetainVice=function(param){OrderInfo.actionFlag=7;SoOrder.submitOrder(param.viceParam)};var _commitBuyBack=function(param){OrderInfo.actionFlag=20;var params={viceParam:param.viceParam,remark:$("#order_remark").val()};SoOrder.submitOrder(params)};var _commonSubmit=function(boActionTypeCd,prodStatusCd,toprodStatusCd,itemSpecId,state){OrderInfo.actionClassCd=CONST.ACTION_CLASS_CD.PROD_ACTION;OrderInfo.boActionTypeCd=boActionTypeCd;if(_isNullParam(prodStatusCd)){prodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD}if(_isNullParam(toprodStatusCd)){toprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD}var data={};if(!_isNullParam(prodStatusCd)){data.boProdStatuses=[{prodStatusCd:prodStatusCd,state:"DEL"},{prodStatusCd:toprodStatusCd,state:"ADD"}]}if(!_isNullParam(itemSpecId)){data.busiOrderAttrs=[{itemSpecId:itemSpecId,value:$.trim($("textarea[id^=order_remark]").val())}]}SoOrder.submitOrder(data)};function _gotoOrderModify(response){var content$=$("#order_fill_content");content$.html(response.data).show();$(".main_div .h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$("#ordercon").show();$("#ordertabcon").show();order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide();$(".ordercon a:first span").text("取 消");$(".main_body").css("height","150px");$(".main_body").css("min-height","150px");$("#order_confirm").empty();$("#fillLastStep").click(function(){order.prodModify.cancel()})}var _spec_parm_change=function(){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PARMS,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};var checkRule=rule.rule.prepare(param,"order.prodModify.spec_parm_show",callParam)};var _spec_parm_show=function(){var param={prodInstId:_choosedProdInfo.prodInstId,offerSpecId:_choosedProdInfo.prodOfferId,prodSpecId:_choosedProdInfo.productId,partyId:OrderInfo.cust.custId,acctNbr:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};$.callServiceAsHtmlGet(contextPath+"/order/orderSpecParamChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(response&&response.code==-2){return}if(response&&response.data){if(response.data==0||response.data==1){$.alert("提示","该产品无产品实例属性！")}else{if(response.data==-1){$.alert("提示","产品实例属性加载异常！")}else{_gotoOrderModify(response)}}}else{$.alert("提示","产品实例属性加载异常")}}})};var _showPasswordChange=function(){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};OrderInfo.actionFlag=31;var checkRule=rule.rule.prepare(param,"order.prodModify.spec_password_change",callParam)};var _spec_password_change=function(){var param={accNbr:_choosedProdInfo.accNbr};$.callServiceAsHtmlGet(contextPath+"/order/orderPasswordChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){_gotoOrderModify(response);$("#password_form").bind("formIsValid",_spec_password_change_check).ketchup({bindElement:"btsubmit"})}})};function _spec_password_change_check(){if("none"!=$("#li_password_old").css("display")){if(!$("#password_old").val()){$.alert("操作提示","请输入 原产品密码");return}}if(!$("#password_change1").val()){$.alert("操作提示","请输入 产品密码");return}else{if(!$("#password_change2").val()){$.alert("操作提示","请输入 确认密码");return}else{if($("#password_change1").val()!=$("#password_change2").val()){$.alert("操作提示","两次密码不一致");return}}}var param={password_old:$("#password_old").val(),accessNumber:_choosedProdInfo.accNbr,areaId:_choosedProdInfo.areaId};$.callServiceAsHtml(contextPath+"/order/orderPasswordCheck",param,{before:function(){$.ecOverlay("<strong>正在提交中,请稍等...</strong>")},done:function(response){if(response&&response.code==-2){return}var data=eval("("+response.data+")");if(data.successed==true||data.successed=="true"){_spec_password_change_save()}else{$.alert("密码校验失败",data.data);$.unecOverlay();return}}})}function _spec_password_change_save(){var boProdPasswords=new Array();var boProdPasswords_del={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:$("#password_old").val(),state:"DEL"};var boProdPasswords_add={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:$("#password_change1").val(),state:"ADD"};boProdPasswords.push(boProdPasswords_del);boProdPasswords.push(boProdPasswords_add);
var data={boProdPasswords:boProdPasswords};OrderInfo.actionFlag=31;SoOrder.submitOrder(data)}var _showPasswordReset=function(){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};OrderInfo.actionFlag=32;var checkRule=rule.rule.prepare(param,"order.prodModify.spec_password_reset",callParam)};var _spec_password_reset=function(){$.callServiceAsHtmlGet(contextPath+"/order/orderPasswordReset",null,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){_gotoOrderModify(response);$("#password_form").bind("formIsValid",_spec_password_reset_save).ketchup({bindElement:"btsubmit"})}})};function _spec_password_reset_save(){var boProdPasswords=new Array();var boProdPasswords_del={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:"",state:"DEL"};var boProdPasswords_add={prodId:_choosedProdInfo.prodInstId,prodPwTypeCd:"2",pwd:"111111",state:"ADD"};boProdPasswords.push(boProdPasswords_del);boProdPasswords.push(boProdPasswords_add);var data={boProdPasswords:boProdPasswords};OrderInfo.actionFlag=32;SoOrder.submitOrder(data)}function _shortnum_change(){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.PRODUCT_PARMS,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};OrderInfo.actionFlag=34;var checkRule=rule.rule.prepare(param,"order.prodModify.shortnum_show",callParam)}function _shortnum_show(id){var param={prodId:_choosedProdInfo.prodInstId,acctNbr:_choosedProdInfo.accNbr};$.callServiceAsHtmlGet(contextPath+"/order/orderShortnumChange",param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(response&&response.code==-2){return}if(response&&response.data){if(response.data==0){$.alert("提示","该产品无短号信息！")}else{if(response.data==-1){$.alert("提示","加载短号信息异常！")}else{_gotoOrderModify(response)}}}else{$.alert("提示","短号加载异常")}}})}function _shortnum_change_val(obj){if($(obj).attr("checkSta")=="2"&&$(obj).val()!=$(obj).attr("changeval")){$(obj).attr("checkSta","0")}}function _shortnum_check(){var shortnum_sel=$("#shortnum_sel").val();var id=$("#ul_"+shortnum_sel).attr("t_id");var shortnum_val=$("#"+id).val();var reg=new RegExp("^[0-9]*$");if(null==shortnum_val||""==shortnum_val){$.alert("提示","请输入新的短号");return}else{if(shortnum_val==$("#"+id).attr("oldval")){$.alert("提示","短号未修改，请修改后再校验");return}else{if(!reg.test(shortnum_val)){$.alert("提示","短号只能为数字，请重新输入！");return}else{if(shortnum_val==$("#"+id).attr("changeval")){if($("#"+id).attr("checkSta")=="2"){$.alert("提示","短号已校验成功，可以使用！");return}else{if($("#"+id).attr("checkSta")=="1"){$.alert("提示","短号未通过校验，请修改再试！");return}}}}}}var param={groupNbr:$("#"+id).attr("groupNbr"),extProdId:$("#"+id).attr("extProdId"),productNbr:"",accNbr:_choosedProdInfo.accNbr,extPordInstId:$("#"+id).attr("extPordInstId"),groupShortNbr:shortnum_val,lanId:$("#"+id).attr("lanId"),checkNbr:$("#"+id).attr("changeval")};var url=contextPath+"/order/checkReleaseShortNum";$.callServiceAsJson(url,param,{before:function(){$.ecOverlay("<strong>短号校验中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(response){$("#"+id).attr("changeval",shortnum_val);if(response.code==0){$("#"+id).attr("checkSta","2");$("#uimCheck").removeClass().addClass("order_check");$.alert("提示",response.data);return}else{$("#"+id).attr("checkSta","1");$.alert("提示",response.data);$("#uimCheck").removeClass().addClass("order_check_error");return}},fail:function(response){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！");return}})}function _shortnum_save(){var shortnum_sel=$("#shortnum_sel").val();var id=$("#ul_"+shortnum_sel).attr("t_id");var shortnum_val=$("#"+id).val();if(shortnum_val==$("#"+id).attr("oldval")){$.alert("提示","短号未修改，请修改并校验");return}else{if($("#"+id).attr("checkSta")=="0"){$.alert("提示","短号未校验，请校验后再提交！");return}else{if($("#"+id).attr("checkSta")=="1"){$.alert("提示","短号未通过校验，请修改再试！");return}}}var boProdCompItems=new Array();var boProdCompItems_row={itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"DEL",value:$("#"+id).attr("oldval")};boProdCompItems.push(boProdCompItems_row);boProdCompItems_row={itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"ADD",value:$("#"+id).val()};boProdCompItems.push(boProdCompItems_row);var boProdCompOrders_row={prodCompRelaRoleCd:$("#"+id).attr("prodCompRelaRoleCd"),compProdId:$("#"+id).attr("compProdId"),prodCompId:$("#"+id).attr("prodCompId")};var boProdCompOrders=new Array();boProdCompOrders.push(boProdCompOrders_row);var data={boProdCompItems:boProdCompItems,boProdCompOrders:boProdCompOrders};OrderInfo.actionFlag=34;SoOrder.submitOrder(data)}var _isNullParam=function(data){return data==undefined||!data};var _changeCard=function(param){$.callServiceAsHtml(contextPath+"/order/changeCard",param,{before:function(){},done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var compspecGrps="";var getCompInfo=function(compspecparam){var grprlue="";var returndata=$.callServiceAsJson(contextPath+"/order/compPspecGrps",compspecparam,{});if(returndata.code==0){if(returndata.data.length!=0){grprlue=returndata.data;compspecGrps=grprlue}return grprlue}else{if(returndata.code==-2){$.alertM(returndata.data);return""}else{$.alert("提示","该产品不是组合产品，请重新选择！");return""}}};var _addComp=function(param){OrderInfo.initData("","",12,"纳入成员");SoOrder.builder();var compparam={};$.callServiceAsHtml(contextPath+"/order/addComp",compparam,{done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".ordercon").show();$(".ordertabcon").show();order.prepare.step(1);$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var _removeComp=function(param){OrderInfo.initData("","",12,"退出成员");SoOrder.builder();var compparam={};$.callServiceAsHtml(contextPath+"/order/removeComp",compparam,{done:function(response){var content$=$("#order_fill_content");content$.html(response.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$(".ordercon").show();$(".ordertabcon").show();order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var _queryRomveAcc=function(){var prodnum=$.trim($("#removeAcc").val());if(prodnum==""){$.alert("提示","请输入需要查询的接入号！");return}else{var params={compProdId:_choosedProdInfo.prodInstId,accessNumber:prodnum}}var removephones=getChoosedMenbr();if(removephones.length!=0){for(var i=0;i<removephones.length;i++){if(prodnum==removephones[i]){$.alert("提示","该号码已经在待退出成员中，请重新选择！");return}}}var url=contextPath+"/order/queryCompmenber";$.callServiceAsJson(url,params,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")
},done:function(response){if(response.code==0){var compProdMemberInfos=response.data;if(compProdMemberInfos.length>0){var prodmenber=compProdMemberInfos[0];var addnbrhtml="<li id='li_"+prodmenber.accessNumber+"' prodInstId='"+prodmenber.prodId+"' phonenumber='"+prodmenber.accessNumber+"' prodCompRelaRoleCd='"+prodmenber.prodCompRelaRoleCd+"' prodCompRelaRoleName='"+prodmenber.prodCompRelaRoleName+"' prodCompId='"+prodmenber.prodCompId+"'><dd class='delete' onclick='order.prodModify.removeCompDelSelect(this);'></dd><span id='addNbr'>"+prodmenber.accessNumber+"</span>";$("#choosed_menbers").append(addnbrhtml)}else{$.alert("提示","该号不在群组成员中，请重新选择！");return}}else{if(response.code==-2){$.alertM(response.data)}else{$.alert("提示",response.data);return}}},always:function(){$.unecOverlay()},fail:function(response){$.unecOverlay();$.alert("提示","套餐加载失败，请稍后再试！")}})};var _orderAttachOffer=function(){AttachOffer.init()};var _changeOffer=function(){offerChange.init()};var _showChangeAccount=function(){var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};var flag=rule.rule.prepare(param,"order.prodModify.changeAccount",callParam);if(flag){return}};var _changeAccount=function(){if(!_choosedProdInfo.prodInstId||!_choosedProdInfo.accNbr){$.alert("提示","产品信息定位异常，请联系管理员");$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}var param={prodId:_choosedProdInfo.prodInstId,acctNbr:_choosedProdInfo.accNbr};$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",param,{before:function(){$.ecOverlay("<strong>正在确认当前产品帐户,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(jr){if(jr.code!=0||jr.data.length==0){if(jr.code==-2){$.alertM(jr.data)}else{$.alert("提示","当前产品帐户定位失败，请联系管理员")}$("#orderedprod").show();$("#order_prepare").show();$("#order_tab_panel_content").show();$("#order_confirm").show();$("#order_fill_content").hide();order.prepare.hideStep();return}var prodAcctInfos=jr.data;$.callServiceAsHtml(contextPath+"/order/preChangeAccount",prodAcctInfos,{before:function(){$.ecOverlay("<strong>当前产品帐户已确认</strong>")},always:function(){$.unecOverlay()},done:function(response){if(!response){response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>'}if(response.code!=0){$.alert("提示","查询失败,请稍后重试");return}$("#order_fill_content").html(response.data).show();$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);$("#origAccts option:first").attr("selected","selected");acct.acctModify.getBILL_POST()},fail:function(response){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})}})};var _showOrigAccts=function(){easyDialog.open({container:"origAcctDialog"});$("#origAcctClose").click(function(){easyDialog.close()})};var _chooseAcct=function(){$("#chooseQueryAcctType").find("option[value=1]").attr("selected","selected");$("#d_query_nbr").show();easyDialog.open({container:"queryAcctDialog"});$("#chooseQueryAcctType").change(function(){if($("#chooseQueryAcctType").val()==1){$("#d_query_cd").hide();$("#d_query_nbr").show()}else{$("#d_query_nbr").hide();$("#d_query_pwd").hide();$("#d_query_cd").show()}});$("#queryAcctClose").click(function(){$("#acctListTab tbody").empty();$("#d_query_cd").hide();$("#d_query_nbr").hide();easyDialog.close()})};var newAcctList=[];var _queryAccount=function(acctSelect){var response;if($("#chooseQueryAcctType").val()==1){var acctQueryParam={accessNumber:$("#d_query_nbr input").val()};response=order.prodModify.returnAccount(acctQueryParam)}else{var acctQueryParam={acctCd:$("#d_query_cd input").val()};response=order.prodModify.returnAccount(acctQueryParam)}$("#acctListTab tbody").empty();if(response.code==0){var returnMap=response.data;if(returnMap.resultCode==0){if(returnMap.accountInfos&&returnMap.accountInfos.length>0){var accountInfos=returnMap.accountInfos;$.each(accountInfos,function(i,accountInfo){var tr=$("<tr></tr>").appendTo($("#acctListTab tbody"));if(accountInfo.name){$("<td class='teleNum'>"+accountInfo.name+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}if(accountInfo.acctId){$("<td acctId='"+accountInfo.acctId+"'>"+accountInfo.accountNumber+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}if(accountInfo.owner){$("<td>"+accountInfo.owner+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}if(accountInfo.accessNumber){$("<td>"+accountInfo.accessNumber+"</td>").appendTo(tr)}else{$("<td></td>").appendTo(tr)}tr.click(function(){var newAccount={acctCd:accountInfo.accountNumber,acctId:accountInfo.acctId,acctRelaTypeCd:"1",chargeItemCd:1,percent:"100",priority:"1",prodAcctId:"-1",state:"ADD"};newAcctList.push(newAccount);$("#acctListTab tbody").empty();$("#d_query_cd").hide();$("#d_query_nbr").hide();$("#d_query_pwd").hide();$("#defineNewAcct").hide();easyDialog.close();var found=false;$.each($(acctSelect).find("option"),function(i,option){if($(option).val()==accountInfo.acctId){found=true;return false}});if(found==false){$("<option>").text(accountInfo.owner+" : "+accountInfo.name).attr("value",accountInfo.acctId).appendTo($(acctSelect))}$(acctSelect).find("option[value=default]").remove();$(acctSelect).find("option[value="+accountInfo.acctId+"]").attr("selected","selected")})})}else{$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+returnMap.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"))}}else{$("<tr><td colspan=4>"+response.data+"</td></tr>").appendTo($("#acctListTab tbody"))}};var _returnAccount=function(acctQueryParam){acctQueryParam.areaId=_choosedProdInfo.areaId;var response=$.callServiceAsJson(contextPath+"/order/account",acctQueryParam);if(response.code==-2){$.alertM(response.data);return}return response};var _createAcct=function(){var newAccount={acctCd:-1,acctId:-1,acctRelaTypeCd:"1",chargeItemCd:1,percent:"100",priority:"1",prodAcctId:"-1",state:"ADD"};newAcctList.push(newAccount);$("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>").appendTo($("#newAccts"));$("#newAccts").find("option[value=default]").remove();$("#newAccts").find("option[value=-1]").attr("selected","selected");$("#acctName").val(OrderInfo.cust.partyName);$("#newAccts").parent().find("a:eq(1)").hide();$("#defineNewAcct").show();acct.acctModify.paymentType();acct.acctModify.billPostType()};var _ifNewAcct=function(acctSelect){if($(acctSelect).val()<0){$("#defineNewAcct").show()}else{$("#defineNewAcct").hide()}};var _changeAccountSave=function(){if($("#newAccts").val()=="default"){$.alert("提示","请选择新帐户");return}if($("#newAccts").val()<0){if(!SoOrder.checkAcctInfo()){return}}var repick=false;var origAccts=$("#origAccts").find("option");$.each(origAccts,function(i,origAcct){if($("#newAccts").val()==$(origAcct).val()){repick=true;return false}});if(repick==false){var delAcctId=$("#origAccts").val();var origAcct=$("#origAcctList tbody").find("tr[id="+delAcctId+"]");var _acctCd=$(origAcct).find("td:eq(4)").text();var _acctId=$(origAcct).find("td:eq(0)").text();var _chargeItemCd=$(origAcct).find("td:eq(2)").text();var _percent=$(origAcct).find("td:eq(7)").text();var _priority=$(origAcct).find("td:eq(8)").text();if(_priority==""){_priority=1}var _prodAcctId=$(origAcct).find("td:eq(1)").text();var origAcctInfo={acctCd:_acctCd,acctId:_acctId,acctRelaTypeCd:"1",chargeItemCd:_chargeItemCd,percent:_percent,priority:_priority,prodAcctId:_prodAcctId,state:"DEL"};var newAcctInfo;$.each(newAcctList,function(i,newAccount){if(newAccount.acctId==$("#newAccts").val()){newAcctInfo=newAccount;return false}});var _boAccountRelas=[];_boAccountRelas.push(origAcctInfo);_boAccountRelas.push(newAcctInfo);
var _busiOrderAttrs=[];var remark=$("#orderRemark").val();_busiOrderAttrs.push({itemSpecId:"111111118",value:remark});var data={boAccountRelas:_boAccountRelas,busiOrderAttrs:_busiOrderAttrs};if($("#newAccts").val()==-1){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,10,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");var busiOrder=[];OrderInfo.createAcct(busiOrder,-1);var acctChangeNode={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:_choosedProdInfo.accNbr,instId:_choosedProdInfo.prodInstId,isComp:"N",objId:_choosedProdInfo.productId,offerTypeCd:"1"},boActionType:{actionClassCd:1300,boActionTypeCd:"-6"},data:data};busiOrder.push(acctChangeNode);SoOrder.submitOrder(busiOrder)}else{OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");SoOrder.submitOrder(data)}}else{$.alert("提示","该帐户已经是付费帐户了，请重新选择");return}};var _cancel=function(){$.confirm("信息","确定取消当前操作吗？",{yes:function(){var boProd2Tds=OrderInfo.boProd2Tds;if(boProd2Tds.length>0){for(var n=0;n<boProd2Tds.length;n++){var param={numType:2,numValue:boProd2Tds[n].terminalCode};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",param)}}var boProdAns=OrderInfo.boProdAns;if(boProdAns.length>0){for(var n=0;n<boProdAns.length;n++){if(boProdAns[n].idFlag){continue}var param={numType:1,numValue:boProdAns[n].accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",param)}order.service.boProdAn={};order.phoneNumber.resetBoProdAn()}$("#order_fill_content").empty();OrderInfo.order.step=0;order.prepare.hideStep();$("#orderedprod").show();$("#order_prepare").show()},no:function(){}},"question")};var compparam="";var _queryCustProd=function(){var hasmeneber=false;var prodnum=$.trim($("#prodnbr").val());if(prodnum==""){$.alert("提示","请输入需要查询的接入号！");return}else{hasmeneber=isExist(prodnum)}if(hasmeneber.flag){if(hasmeneber.data=="1"){var param={};var prodnum=$.trim($("#prodnbr").val());param.acctNbr=prodnum;var url=contextPath+"/cust/queryprodbynbr"}else{$.alert("提示","该产品已经在组合中，请重新选择！");return}}else{return}$.callServiceAsHtmlGet(url,param,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(response){if(!response){response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(response.code==-2){return}else{if(response.code!=0){$.alert("提示","客户查询失败,稍后重试");return}}var content$=$("#prodinst");content$.html(response.data)}})};var _compChangeTab=function(num){if(num==1){$("#tab_1").addClass("setcon");$("#tab_2").removeClass("setcon");$("#addCompPage").show();$("#releaseShortNum").hide();$("#compopr").show()}else{$("#tab_2").addClass("setcon");$("#tab_1").removeClass("setcon");$("#addCompPage").hide();$("#releaseShortNum").show();$("#compopr").hide()}};var _addToComp=function(obj){var phonenumber=$(obj).parent().parent().children(":first-child").next().text();var productId=$(obj).parent().parent().children(":last-child").text();var prodInstId=$(obj).parent().parent().children().eq(-2).text();var prodStateCd=$(obj).parent().parent().children().eq(-3).text();var linum=$("#choosed_menbers li").length;if(linum>12){$.alert("提示","已经超过了加入的最大数量！");return}if(prodStateCd!="100000"){$.alert("提示","该产品状态不符，不能纳入成员！");return}var addphones=getChoosedMenbr();if(addphones.length!=0){for(var i=0;i<addphones.length;i++){if(phonenumber==addphones[i]){$.alert("提示","该号码已经在待纳入成员中，请重新选择！");return}}}ec.form.dialog.createDialog({id:"-grps",initCallBack:function(dialogForm,dialog){var compdata=compspecGrps;var compPspecCompGrp2Pspecs=compspecGrps[0].compPspecCompGrp2Pspecs;var compPspecCompGrpRelas=compspecGrps[0].compPspecCompGrpRelas;if(compPspecCompGrpRelas==undefined){compPspecCompGrpRelas=[]}var zNodes=[];var menber=[];for(var i=0;i<compPspecCompGrp2Pspecs.length;i++){var grpspec={name:compPspecCompGrp2Pspecs[i].prodSpecName,prodCompRelaRoleCd:compPspecCompGrp2Pspecs[i].prodCompRelaRoleCd,prodCompRelaRoleName:compPspecCompGrp2Pspecs[i].prodCompRelaRoleName,prodSpecId:compPspecCompGrp2Pspecs[i].prodSpecId};menber.push(grpspec)}var childmenber=[];for(var i=0;i<compPspecCompGrpRelas.length;i++){var compPspecCompGrpRelasSpecs=compPspecCompGrpRelas[i];var childSpec=[];for(var j=0;j<compPspecCompGrpRelasSpecs.length;j++){var grpspec={name:compPspecCompGrpRelasSpecs[j].prodSpecName,prodCompRelaRoleCd:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleCd,prodCompRelaRoleName:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleName,prodSpecId:compPspecCompGrpRelasSpecs[j].prodSpecId};childSpec.push(grpspec)}var childrole={name:compPspecCompGrpRelasSpecs[i].compPspecCompGrpName,children:childSpec};childmenber.push(childrole)}var setting={data:{key:{title:"t"},simpleData:{enable:true}},callback:{onClick:onClick}};if(compPspecCompGrp2Pspecs.length!=0){var node={name:"成员",open:true,children:menber};zNodes.push(node)}if(compPspecCompGrpRelas.length!=0){var node={name:"子组",children:childmenber};zNodes.push(node)}if(compPspecCompGrp2Pspecs.length==0&&compPspecCompGrpRelas.length==0){$.alert("提示","该产品没有成员规则，请重新选择群组产品！");return}var prodCompRelaRoleCd="";var prodCompRelaRoleName="";function onClick(event,treeId,treeNode,clickFlag){prodCompRelaRoleCd="";prodCompRelaRoleName="";var prodSpecId=treeNode.prodSpecId;if(prodSpecId==productId){prodCompRelaRoleCd=treeNode.prodCompRelaRoleCd;prodCompRelaRoleName=treeNode.prodCompRelaRoleName}else{$.alert("提示","不能加入该角色，请重新选择！")}}$.fn.zTree.init($("#rluename"),setting,zNodes);$("#nextstep").click(function(){if(prodCompRelaRoleCd!=""&&prodCompRelaRoleName!=""){$("#dialogtitle").html("设置短号");var shortnumhtml="短号设置：<input type='text' id='shortnumtext' class='inputWidth183px'/>";$("#rluename").html("").html(shortnumhtml);$("#nextstep").hide();$("#submitbtn2").show()}else{$.alert("提示","请选择所需纳入的成员！");return}});$("#submitbtn2").click(function(){var shortnum=$("#shortnumtext").val();var reg=new RegExp("^[0-9]*$");if(shortnum==""){$("#errinfo").html("对不起，请输入短号！");return}if(!reg.test(shortnum)){$("#errinfo").html("短号只能为数字，请重新输入！");return}var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:phonenumber,extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortnum,statusCd:"1102"};var url=contextPath+"/order/checkGroupShortNum";var res=$.callServiceAsJson(url,param,{});if(res.code==0){var addnbrhtml="<li id='li_"+phonenumber+"' prodInstId='"+prodInstId+"' phonenumber='"+phonenumber+"' prodCompRelaRoleCd='"+prodCompRelaRoleCd+"' prodCompRelaRoleName='"+prodCompRelaRoleName+"' productId='"+productId+"' style='width:280px;'><dd class='delete' onclick='order.prodModify.addCompDelSelect(this);'></dd><span id='addNbr' style='display:inline;padding:0 5px 0 22px;'>"+phonenumber+"</span><span style='display:inline;padding:0px;'>[短号：</span><span style='display:inline;padding:0px;' id='shortNumber'>"+shortnum+"</span><span class='modshortnum' onclick='order.prodModify.changeShortNum(this);' style='display:inline;padding:0 25px 0 20px;'></span><span style='display:inline;padding:0px;'>]</span>";$("#choosed_menbers").append(addnbrhtml);dialogForm.close(dialog)}else{if(res.code==-2){$.alertM(res.data)}else{$.alert("提示",res.data)}}})},submitCallBack:function(dialogForm,dialog){},width:400,height:150})};var getChoosedMenbr=function(){var numbers=[];$("#choosed_menbers li").each(function(){var phonenum=$(this).children("span#addNbr").text();numbers.push(phonenum)});return numbers};var boolHasShortNum=function(){var hasshrot=true;$("#choosed_menbers li").each(function(){var phonenum=$(this).children("span#shortNumber").text();if(phonenum==""){hasshrot=false}});return hasshrot};var _changeShortNum=function(obj){var phonenum=$(obj).parent().children("span#addNbr").text();var shortnum=$(obj).parent().children("span#shortNumber").text();
ec.form.dialog.createDialog({id:"-shrotnum",initCallBack:function(dialogForm,dialog){$("#shortnumval").val(shortnum);$("#submitbtn3").click(function(){shortnum=$(obj).parent().children("span#shortNumber").text();var newshortnum=$("#shortnumval").val();if(shortnum==newshortnum){dialogForm.close(dialog)}if(shortnum==""&&newshortnum!=""){var result=getOprShortNumInfo(phonenum,newshortnum,"1102");if(result.code==0){$("#li_"+phonenum).children("span#shortNumber").html(newshortnum)}else{if(result.code==-2){$.alertM(result.data);return}else{$.alert("提示","短号预占失败！");return}}dialogForm.close(dialog)}if(shortnum!=""&&newshortnum==""){$.alert("提示","请输入短号！");return}if(shortnum!=""&&newshortnum!=""){var resultremove=getOprShortNumInfo(phonenum,shortnum,"1000");if(resultremove.code==0){$("#li_"+phonenum).children("span#shortNumber").html("")}else{if(resultremove.code==-2){$.alertM(resultremove.data);return}else{$.alert("提示","短号预占失败！");return}}var resultadd=getOprShortNumInfo(phonenum,newshortnum,"1102");if(resultadd.code==0){$("#li_"+phonenum).children("span#shortNumber").html(newshortnum)}else{if(resultadd.code==-2){$.alertM(resultadd.data);return}else{$.alert("提示","预占失败！");return}}dialogForm.close(dialog)}})},submitCallBack:function(dialogForm,dialog){},width:350,height:100})};var getOprShortNumInfo=function(accNbr,shortNbr,statusCd){var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:accNbr,extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortNbr,statusCd:statusCd};var url=contextPath+"/order/checkGroupShortNum";var res=$.callServiceAsJson(url,param,{});return res};var _releaseShortNum=function(){var shortNbr=$("#resshortnum").val();var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:"",extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortNbr,statusCd:"1000"};var url=contextPath+"/order/checkGroupShortNum";var res=$.callServiceAsJson(url,param,{});if(res.code==0){$.alert("提示","短号释放成功！");$("#choosed_menbers li").each(function(){var shortNum=$(this).children("span#shortNumber").text();if(shortNbr==shortNum){$(this).children("span#shortNumber").html("")}})}else{if(res.code==-2){$.alertM(res.data);return}else{$.alert("提示",res.data)}}};var canAddAnother=function(){var phonelist=$("#choosed_menbers").html();phonelist=phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");if(phonelist!=""){var lastspan=$("#choosed_menbers").children(":last-child").children("span").length;if(lastspan<2){return false}else{return true}}else{return true}};var isExist=function(prodnum){var params={compProdId:_choosedProdInfo.prodInstId,accessNumber:prodnum};var url=contextPath+"/order/queryCompmenber";var returndata={};var isexist=$.callServiceAsJson(url,params,{});if(isexist.code==0){returndata.flag=true;var compProdMemberInfos=isexist.data;if(compProdMemberInfos.length>0){returndata.data="0"}else{returndata.data="1"}return returndata}else{if(isexist.code==-2){$.alertM(returndata.data);returndata.flag=false}else{returndata.flag=false;$.alert("提示",isexist.data);return returndata}}};var _addCompSubmit=function(){var phonelist=$("#choosed_menbers").html();phonelist=phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");if(phonelist==""){$.alert("提示","请选择纳入组合的成员！");return}var boolshort=boolHasShortNum();if(!boolshort){$.alert("提示","待加入成员未全部设置短号，请全部设置好后再提交！");return}var busiOrder=[];var addMenbers=[];var prodCompId=-1;$("#choosed_menbers li").each(function(){var prodInstId=$(this).attr("prodInstId");var phonenumber=$(this).attr("phonenumber");var prodCompRelaRoleCd=$(this).attr("prodCompRelaRoleCd");var prodCompRelaRoleName=$(this).attr("prodCompRelaRoleName");var productId=$(this).attr("productId");var shortnum=$(this).children("span#shortNumber").text();addMenbers.push(phonenumber);var compparam={busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{objId:CONST.PROD_SPEC.CDMA,instId:prodInstId,accessNumber:phonenumber},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP},areaId:OrderInfo.staff.areaId,aggreementId:"",data:{boProdCompOrders:[{prodCompRelaRoleCd:prodCompRelaRoleCd,prodCompRelaRoleName:prodCompRelaRoleName,prodCompId:prodCompId,compProdId:_choosedProdInfo.prodInstId}],boProdCompRelas:[{prodCompId:prodCompId,state:"ADD",atomActionId:OrderInfo.SEQ.atomActionSeq--}],boProdSpecs:[{prodSpecId:productId,atomActionId:OrderInfo.SEQ.atomActionSeq--,state:"KIP"}],boProdCompItems:[{itemSpecId:"37906",name:"",prodCompId:prodCompId,state:"ADD",value:shortnum,atomActionId:OrderInfo.SEQ.atomActionSeq--}],busiOrderAttrs:[{itemSpecId:"111111111",value:$("#orderRemark").val()}]}};busiOrder.push(compparam);prodCompId--});OrderInfo.confirmList=[];var comfimProdInfo={name:_choosedProdInfo.productName,accNbr:[_choosedProdInfo.accNbr]};OrderInfo.confirmList.push(comfimProdInfo);var comfimMeneber={name:"纳入成员",accNbr:addMenbers};OrderInfo.confirmList.push(comfimMeneber);SoOrder.submitOrder(busiOrder)};var _removeCompSubmit=function(){var t=$("#choosed_menbers").html();t=t.replace(/[\r\n]/g,"").replace(/[ ]/g,"");if(t==""){$.alert("提示","请选择退出组合的成员！");return}var busiOrder=[];var addMenbers=[];$("#choosed_menbers li").each(function(){var prodInstId=$(this).attr("prodInstId");var phonenumber=$(this).attr("phonenumber");var prodCompRelaRoleCd=$(this).attr("prodCompRelaRoleCd");var prodCompRelaRoleName=$(this).attr("prodCompRelaRoleName");var prodCompId=$(this).attr("prodCompId");addMenbers.push(phonenumber);var compparam={busiOrderInfo:{seq:-1},busiObj:{objId:CONST.PROD_SPEC.CDMA,instId:prodInstId,accessNumber:phonenumber},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ADD_COMP},areaId:OrderInfo.staff.areaId,aggreementId:"",data:{boProdCompOrders:[{prodCompRelaRoleCd:prodCompRelaRoleCd,prodCompRelaRoleName:prodCompRelaRoleName,prodCompId:prodCompId,compProdId:_choosedProdInfo.prodInstId}],boProdCompRelas:[{prodCompId:prodCompId,state:"DEL"}],busiOrderAttrs:[{itemSpecId:"111111111",value:$("#orderRemark").val()}]}};busiOrder.push(compparam)});OrderInfo.confirmList=[];var comfimProdInfo={name:_choosedProdInfo.productName,accNbr:[_choosedProdInfo.accNbr]};OrderInfo.confirmList.push(comfimProdInfo);var comfimMeneber={name:"退出成员",accNbr:addMenbers};OrderInfo.confirmList.push(comfimMeneber);SoOrder.submitOrder(busiOrder)};var _removeCompDelSelect=function(obj){$.confirm("确认","确定要取消该号码吗?",{yes:function(){var accNbr=$(obj).next().text();$("#li_"+accNbr).remove()},no:function(){}})};var _addCompDelSelect=function(obj){$.confirm("确认","确定要取消该号码吗?",{yes:function(){var accNbr=$(obj).parent().children("span#addNbr").text();var shortnum=$(obj).parent().children("span#shortNumber").text();if(shortnum!=""){var param={groupNbr:_choosedProdInfo.accNbr,extProdId:_choosedProdInfo.productId,productNbr:"",accNbr:accNbr,extPordInstId:_choosedProdInfo.prodInstId,shortNbr:shortnum,statusCd:"1000"};var url=contextPath+"/order/checkGroupShortNum";var response=$.callServiceAsJson(url,param,{});if(response.code==0){$("#li_"+accNbr).remove()}else{if(response.code==-2){$.alertM(response.data)}else{alert("删除失败")}}}else{$("#li_"+accNbr).remove()}},no:function(){}})};var _showBuyBack=function(){var param=_getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);var callParam={boActionTypeCd:CONST.BO_ACTION_TYPE.BUY_BACK,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BUY_BACK),accessNumber:_choosedProdInfo.accNbr,prodOfferName:_choosedProdInfo.prodOfferName};var checkRule=rule.rule.prepare(param,"order.prodModify.showBuyBackDo",callParam)};var _showBuyBackDo=function(){var inprodStatusCd=_choosedProdInfo.prodStateCd;var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.BUY_BACK;if(!query.offer.setOffer()){return}if(_showMemberWin()){$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BUY_BACK)+"-是否保留成员");$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){_closeDialog();
_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BUY_BACK,1)});_commonShowDialog()}else{_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BUY_BACK,1)}};var _setCoupon=function(coupon){_coupon=coupon};var _btnMoreProfile=function(){if($("#modPartyProfile").is(":hidden")){$("#modPartyProfile").show();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrowup");order.prodModify.changeLabel(0)}else{$("#modPartyProfile").hide();$("#proarroworder").removeClass();$("#proarroworder").addClass("arrow");$("#modTabProfile0").attr("click","1");$("#contactName").attr("data-validate","");_form_custInfomodify_btn()}};var _changeLabel=function(labelId){if($("#partyProfile").is(":visible")==false){$("#partyProfile").show()}if(labelId=="0"){$("#modTabProfile0").show();$("#cardtab_mod_0").addClass("setcon");$("#modTabProfile0").attr("click","0");$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(keyup)");_form_custInfomodify_btn()}else{if(($("#modTabProfile0").attr("click")=="0")&&($("#contactName").val()=="")){$.alert("提示","联系人名称不能为空！","information");return}}for(var i=0;i<order.prodModify.profileTabLists.length;i++){var profileTabLists=order.prodModify.profileTabLists[i];var tabProfileNum=profileTabLists.tabProfileNum;var partyProfileCatgTypeCd=profileTabLists.partyProfileCatgTypeCd;if(labelId==partyProfileCatgTypeCd){$("#"+tabProfileNum).show();$("#cardtab_mod_"+partyProfileCatgTypeCd).addClass("setcon");$("#modTabProfile0").hide();$("#cardtab_mod_0").removeClass("setcon")}else{$("#"+tabProfileNum).hide();$("#cardtab_mod_"+partyProfileCatgTypeCd).removeClass("setcon")}}};return{changeCard:_changeCard,getChooseProdInfo:_getChooseProdInfo,lossRepProd:_lossRepProd,lossRepProdSubmit:_lossRepProdSubmit,choosedProdInfo:_choosedProdInfo,showLossRepProd:_showLossRepProd,showStopKeepNumProd:_showStopKeepNumProd,showCustInfoModify:_showCustInfoModify,custInfoModify:_custInfoModify,commonPrepare:_commonPrepare,showOweRemoveProd:_showOweRemoveProd,showRemoveProd:_showRemoveProd,showOrderRemoveProd:_showOrderRemoveProd,showCoverOrderRemoveProd:_showCoverOrderRemoveProd,showBreakRuleRemoveProd:_showBreakRuleRemoveProd,showNoActiveRemoveProd:_showNoActiveRemoveProd,spec_parm_change:_spec_parm_change,showChangeCard:_showChangeCard,spec_password_change:_spec_password_change,spec_password_change_save:_spec_password_change_save,showPasswordChange:_showPasswordChange,spec_password_change_check:_spec_password_change_check,getCallRuleParam:_getCallRuleParam,cancel:_cancel,orderAttachOffer:_orderAttachOffer,changeOffer:_changeOffer,shortnum_change:_shortnum_change,shortnum_show:_shortnum_show,shortnum_save:_shortnum_save,spec_parm_show:_spec_parm_show,showAddComp:_showAddComp,addComp:_addComp,addToComp:_addToComp,compChangeTab:_compChangeTab,queryCustProd:_queryCustProd,addCompSubmit:_addCompSubmit,spec_parm_show:_spec_parm_show,showChangeAccount:_showChangeAccount,changeAccount:_changeAccount,showOrigAccts:_showOrigAccts,chooseAcct:_chooseAcct,queryAccount:_queryAccount,returnAccount:_returnAccount,createAcct:_createAcct,ifNewAcct:_ifNewAcct,changeAccountSave:_changeAccountSave,showRemoveComp:_showRemoveComp,removeComp:_removeComp,profiles:_profiles,profileTabLists:_profileTabLists,partyTypeCdChoose:_partyTypeCdChoose,identidiesTypeCdChoose:_identidiesTypeCdChoose,removeCompSubmit:_removeCompSubmit,showPasswordReset:_showPasswordReset,spec_password_reset:_spec_password_reset,spec_password_reset_save:_spec_password_reset_save,queryRomveAcc:_queryRomveAcc,removeCompDelSelect:_removeCompDelSelect,addCompDelSelect:_addCompDelSelect,chooseOfferForMember:_chooseOfferForMember,shortnum_check:_shortnum_check,shortnum_change_val:_shortnum_change_val,changeShortNum:_changeShortNum,releaseShortNum:_releaseShortNum,showActiveReturn:_showActiveReturn,showBuyBack:_showBuyBack,showBuyBackDo:_showBuyBackDo,setCoupon:_setCoupon,lteFlag:lteFlag,btnMoreProfile:_btnMoreProfile,changeLabel:_changeLabel}})();CommonUtils.regNamespace("order","phoneNumber");var phoneNum_level="";order.phoneNumber=(function(){var d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",memberRoleCd:""};var w=function(){d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",memberRoleCd:""}};var p=[];var h=contextPath+"/mktRes/phonenumber/list";var c="";var m=function(A){A=i(A);$.callServiceAsHtmlGet(h,A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(B){if(!B||B.code!=0){B.data="查询失败,稍后重试"}var C=$("#order_phonenumber .phone_warp");C.html(B.data);$("#btnSwitchNbr").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber({})})},fail:function(B){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var b=function(){var A=$.trim($("#idCode").val());if(A==""){$.alert("提示","请先输入身份证号码!");return}if(!a(A)){$.alert("提示","身份证号码输入有误!");return}var C=$("#p_phone_areaId").val();var B={identityId:A,areaId:C};$.callServiceAsHtmlGet(contextPath+"/mktRes/phonenumber/listByIdentity",B,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(D){if(!D||D.code!=0){D.data="查询失败,稍后重试"}var E=$("#order_phonenumber .phone_warp");E.html(D.data)},fail:function(D){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var g=function(O){c=$(O).attr("numberVal");var P=CONST.MEMBER_ROLE_CD.MAIN_CARD;var K=$("#subFlag").val();if(K=="Y2"){P=CONST.MEMBER_ROLE_CD.VICE_CARD}var H=$("#subnum").val();var V=$("#subPage").val();var C=c.split("_")[1];var G=c.split("_")[2];if(order.service.offerprice!=""){var X=parseInt(G);var M=parseInt(order.service.offerprice);if(M<X){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var J=c.split("_")[0];var W=c.split("_")[3];var T=c.split("_")[5];var Q=c.split("_")[6];var R=$("#p_phone_areaId").val();if(R==null||R==""){R=OrderInfo.staff.areaId}var A=$("#p_phone_areaId").attr("areaCode");if(A==null||A==""){A=OrderInfo.staff.areaCode}if(J){var D=false;var B="";var N="";if(V=="terminal"||V=="number"){B=d.accessNumber;N=d.anTypeCd}else{if(V=="offer"){for(var S=0;S<OrderInfo.boProdAns.length;S++){if(OrderInfo.boProdAns[S].prodId==H){B=OrderInfo.boProdAns[S].accessNumber;N=OrderInfo.boProdAns[S].anTypeCd;break}}for(var S=0;S<OrderInfo.boProdAns.length;S++){if(OrderInfo.boProdAns[S].prodId!=H){if(OrderInfo.boProdAns[S].accessNumber==J){$.alert("提示","你已经选择了该号码,请选择其它号码!");return}}}}}if(B!=""){D=true;for(var S=0;S<p.length;S++){if(p[S]==B){D=false;break}}if(D){var F=contextPath+"/mktRes/phonenumber/purchase";var U={oldPhoneNumber:B,oldAnTypeCd:N};$.callServiceAsJson(F,U,{})}}p.push(J);if(V=="number"){var L=$("#order_fill_content");L.html("");d.accessNumber=J;d.anTypeCd=W;d.level=T;d.org_level=response.data.phoneLevelId;d.anId=Q;d.areaId=R;d.areaCode=A;d.memberRoleCd=P;d.idFlag=0;order.service.boProdAn=d}else{if(V=="terminal"){mktRes.terminal.setNumber(J,T);d.accessNumber=J;d.anTypeCd=W;d.level=T;d.org_level=response.data.phoneLevelId;d.anId=Q;d.areaId=R;d.areaCode=A;d.memberRoleCd=P;d.idFlag=0;order.service.boProdAn=d}else{if(V=="offer"){d.anTypeCd=W;d.anId=Q;d.accessNumber=J;d.level=response.data.phoneLevelId;d.org_level=response.data.phoneLevelId;d.areaId=R;d.areaCode=A;$("#nbr_btn_"+H).removeClass("selectBoxTwo");$("#nbr_btn_"+H).addClass("selectBoxTwoOn");$("#nbr_btn_"+H).html(J+"<u></u>");var E=false;if(OrderInfo.boProdAns.length>0){for(var S=0;S<OrderInfo.boProdAns.length;S++){if(OrderInfo.boProdAns[S].prodId==H){OrderInfo.boProdAns[S].accessNumber=J;OrderInfo.boProdAns[S].anTypeCd=W;OrderInfo.boProdAns[S].pnLevelId=T;OrderInfo.boProdAns[S].anId=Q;OrderInfo.boProdAns[S].areaId=R;OrderInfo.boProdAns[S].areaCode=A;OrderInfo.boProdAns[S].memberRoleCd=P;OrderInfo.boProdAns[S].idFlag=0;E=true;OrderInfo.setProdAn(OrderInfo.boProdAns[S]);order.dealer.changeAccNbr(H,J);break}}}if(!E){var I={prodId:H,accessNumber:J,anChooseTypeCd:"2",anId:Q,anTypeCd:W,pnLevelId:T,state:"ADD",areaId:R,areaCode:A,memberRoleCd:P,idFlag:0};
OrderInfo.boProdAns.push(I)}if(H=="-1"){OrderInfo.boCustInfos.telNumber=J}}}}}else{$.alert("提示","号码格式不正确!")}};var n=function(A){if(d.accessNumber!=""){$("#nbr_btn_"+A).removeClass("selectBoxTwo");$("#nbr_btn_"+A).addClass("selectBoxTwoOn");$("#nbr_btn_"+A).html(d.accessNumber+"<u></u>");order.dealer.changeAccNbr(A,d.accessNumber)}if(d.accessNumber!=""){var B=false;if(OrderInfo.boProdAns.length>0){for(var C=0;C<OrderInfo.boProdAns.length;C++){if(OrderInfo.boProdAns[C].prodId==A){OrderInfo.boProdAns[C].accessNumber=d.accessNumber;OrderInfo.boProdAns[C].anTypeCd=d.anTypeCd;OrderInfo.boProdAns[C].anId=d.anId;OrderInfo.boProdAns[C].pnLevelId=d.level;OrderInfo.boProdAns[C].areaId=d.areaId;OrderInfo.boProdAns[C].memberRoleCd=d.memberRoleCd;if(d.idFlag){OrderInfo.boProdAns[C].idFlag=d.idFlag}OrderInfo.setProdAn(OrderInfo.boProdAns[C]);order.dealer.changeAccNbr(A,phoneNumber);B=true;break}}}if(!B){var D={prodId:A,accessNumber:d.accessNumber,anChooseTypeCd:"2",anId:d.anId,pnLevelId:d.level,anTypeCd:d.anTypeCd,state:"ADD",areaId:d.areaId,memberRoleCd:d.memberRoleCd};if(d.idFlag){D.idFlag=d.idFlag}OrderInfo.boProdAns.push(D)}if(A=="-1"){OrderInfo.boCustInfos.telNumber=d.accessNumber}}};var o=function(){var A={};$.callServiceAsHtmlGet(contextPath+"/order/prodoffer/prepare",A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(B){if(!B||B.code!=0){B.data="查询失败,稍后重试"}var C=$("#order_tab_panel_content");C.html(B.data);order.service.initSpec();order.prodOffer.init();order.service.searchPack()},fail:function(B){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var s=function(L){c=$(L).attr("numberVal");var M=CONST.MEMBER_ROLE_CD.MAIN_CARD;var I=$("#subFlag").val();if(I=="Y2"){M=CONST.MEMBER_ROLE_CD.VICE_CARD}var G=$("#subnum").val();var R=$("#subPage").val();var C=c.split("_")[1];var F=c.split("_")[2];var N=$("#p_phone_areaId").val();if(N==null||N==""){N=OrderInfo.staff.areaId}var A=$("#p_phone_areaId").attr("areaCode");if(A==null||A==""){A=OrderInfo.staff.areaCode}if(order.service.offerprice!=""){var U=parseInt(F);var J=parseInt(order.service.offerprice);if(J<U){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var H=c.split("_")[0];var T=c.split("_")[3];var P=c.split("_")[5];if(H){var Q=$("#p_phone_areaId").val();var S={phoneNumber:H,actionType:"E",anTypeCd:T,areaId:Q};var D=false;var B="";var K="";if(R=="terminal"||R=="number"){B=d.accessNumber;K=d.anTypeCd;if(B==H){$.alert("提示","号码已经被预占,请选择其它号码!");return}else{d={}}}else{if(R=="offer"){for(var O=0;O<OrderInfo.boProdAns.length;O++){if(OrderInfo.boProdAns[O].prodId==G){B=OrderInfo.boProdAns[O].accessNumber;K=OrderInfo.boProdAns[O].anTypeCd;break}}for(var O=0;O<OrderInfo.boProdAns.length;O++){if(OrderInfo.boProdAns[O].accessNumber==H){$.alert("提示","号码已经被预占,请选择其它号码!");return}}}}if(B&&B!=""){D=true;for(var O=0;O<p.length;O++){if(p[O]==B){D=false;break}}if(D){S={newPhoneNumber:H,oldPhoneNumber:B,newAnTypeCd:T,oldAnTypeCd:K,areaId:Q}}}var E=contextPath+"/mktRes/phonenumber/purchase";$.callServiceAsJson(E,S,{before:function(){$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(V){if(V.code==0){$(L).siblings().each(function(){$(this).removeClass("select");var ac=$(this).attr("numberval").split("_");var ab="<span style='padding-left:10px;'>预存<span class='orange'>"+ac[1]+"</span>元</span> <span style='padding-left:10px;'> 保底<span class='orange'>"+ac[2]+"</span>元</span>";$(this).find("div").html(ab)});$(L).addClass("select");if(R=="number"){var Y=$("#order_fill_content");Y.html("");d.accessNumber=H;d.anTypeCd=T;d.level=V.data.phoneLevelId;d.org_level=V.data.phoneLevelId;d.anId=V.data.phoneNumId;d.areaId=N;d.areaCode=A;d.memberRoleCd=M;order.service.boProdAn=d}else{if(R=="terminal"){mktRes.terminal.setNumber(H,V.data.phoneLevelId);d.accessNumber=H;d.anTypeCd=T;d.level=V.data.phoneLevelId;d.org_level=V.data.phoneLevelId;d.anId=V.data.phoneNumId;d.areaId=N;d.areaCode=A;d.memberRoleCd=M;order.service.boProdAn=d}else{if(R=="offer"){$("#nbr_btn_"+G).removeClass("selectBoxTwo");$("#nbr_btn_"+G).addClass("selectBoxTwoOn");$("#nbr_btn_"+G).html(H+"<u></u>");d.accessNumber=H;d.level=V.data.phoneLevelId;d.org_level=V.data.phoneLevelId;d.areaId=N;d.anTypeCd=T;d.anId=V.data.phoneNumId;var W=false;if(OrderInfo.boProdAns.length>0){for(var X=0;X<OrderInfo.boProdAns.length;X++){if(OrderInfo.boProdAns[X].prodId==G){OrderInfo.boProdAns[X].accessNumber=H;OrderInfo.boProdAns[X].anTypeCd=T;OrderInfo.boProdAns[X].pnLevelId=V.data.phoneLevelId;OrderInfo.boProdAns[X].anId=V.data.phoneNumId;OrderInfo.boProdAns[X].areaId=N;OrderInfo.boProdAns[X].areaCode=A;OrderInfo.boProdAns[X].memberRoleCd=M;W=true;OrderInfo.setProdAn(OrderInfo.boProdAns[X]);order.dealer.changeAccNbr(G,H);break}}}if(!W){var aa={prodId:G,accessNumber:H,anChooseTypeCd:"2",anId:V.data.phoneNumId,pnLevelId:V.data.phoneLevelId,anTypeCd:T,state:"ADD",areaId:N,areaCode:A,memberRoleCd:M};OrderInfo.boProdAns.push(aa);OrderInfo.setProdAn(aa);order.dealer.changeAccNbr(G,H)}if(G=="-1"){OrderInfo.boCustInfos.telNumber=H}}}}}else{if(V.code==-2){$.alertM(V.data)}else{var Z="";if(V.data!=undefined&&V.data.msg!=undefined){Z=V.data.msg}else{Z="号码["+H+"]预占失败"}$.alert("提示","号码预占失败，可能原因:"+Z)}}},fail:function(V){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})}else{$.alert("提示","号码格式不正确!")}};var t=function(B,A){f(B,A);m()};var i=function(B){var G=$("#p_phone_areaId").val();var H=$("#pnHead").find("a.selected").attr("val");var I=$.trim($("#pnEnd").val());if(I=="最后四位"){I=""}var J=$.trim($("#phoneNum").val());if(J=="任意四位"){J=""}var D="";var E="";var A="";var C=$("#preStore").find("a.selected");if(C.length>0){E=C.attr("Greater");A=C.attr("Less")}var F=$("#nbrPool option:selected").val();if($("#pnCharacterId_basic").css("display")!="none"){D=$("#pnCharacterId_basic a.selected").attr("val")}if($("#pnCharacterId_all").css("display")!="none"){D=$("#pnCharacterId_all a.selected").attr("val")}D=ec.util.defaultStr(D);return{pnHead:H,pnEnd:I,goodNumFlag:D,maxPrePrice:A,minPrePrice:E,pnLevelId:"",pageSize:"15",phoneNum:J,areaId:G,poolId:F}};var f=function(B,A){$(B).each(function(){$(this).removeClass("selected")});$(A).addClass("selected")};var z=function(A){var B={pageIndex:A};order.phoneNumber.btnQueryPhoneNumber(B)};var a=function(E){E=E.toUpperCase();if(!(/(^\d{15}$)|(^\d{17}([0-9]|X)$)/.test(E))){return false}var F,K;F=E.length;if(F==15){K=new RegExp(/^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/);var J=E.match(K);var C=new Date("19"+J[2]+"/"+J[3]+"/"+J[4]);var B;B=(C.getYear()==Number(J[2]))&&((C.getMonth()+1)==Number(J[3]))&&(C.getDate()==Number(J[4]));if(!B){return false}else{var H=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var I=new Array("1","0","X","9","8","7","6","5","4","3","2");var G=0,D;E=E.substr(0,6)+"19"+E.substr(6,E.length-6);for(D=0;D<17;D++){G+=E.substr(D,1)*H[D]}E+=I[G%11];return E}}if(F==18){K=new RegExp(/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/);var J=E.match(K);var C=new Date(J[2]+"/"+J[3]+"/"+J[4]);var B;B=(C.getFullYear()==Number(J[2]))&&((C.getMonth()+1)==Number(J[3]))&&(C.getDate()==Number(J[4]));if(!B){return false}else{var A;var H=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var I=new Array("1","0","X","9","8","7","6","5","4","3","2");var G=0,D;for(D=0;D<17;D++){G+=E.substr(D,1)*H[D]}A=I[G%11];if(A!=E.substr(17,1)){return false}return E}}return false};var r=function(){var B={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var A=contextPath+"/order/queryApConf";$.callServiceAsJsonGet(A,B,{done:x})};var x=function(B){var K;var H;var L;var C='<a href="javascript:void(0);" class="selected" Greater="" Less="">不限</a>';var R='<a href="javascript:void(0);" class="selected" val="">不限</a>';var G='<a href="javascript:void(0);" class="selected " val="">不限</a>';var I='<a href="javascript:void(0);" class="selected " val="">不限</a>';if(B.data){var E=B.data.length;for(var Q=0;Q<E;Q++){if(B.data[Q].PHONE_NUMBER_PRESTORE){K=B.data[Q].PHONE_NUMBER_PRESTORE;for(var O=0;O<K.length;O++){var J=K[O].COLUMN_VALUE_NAME.replace(/\"/g,"");
var P;var N;var F=J.split("-");if(F.length!=1){P=F[0];N=F[1]}else{F=F.toString();P=F.substring(0,F.length-2);N='""'}J=J.replace(/\"/g,"");C=C+'<a href="javascript:void(0);" Greater='+P+" Less="+N+">"+J+"</a>"}$("#preStore").html(C);continue}}for(var Q=0;Q<E;Q++){if(B.data[Q].PHONE_NUMBER_SEGMENT){H=B.data[Q].PHONE_NUMBER_SEGMENT;for(var O=0;O<H.length;O++){var D=H[O].COLUMN_VALUE_NAME;D=D.replace(/\"/g,"");R=R+'<a href="javascript:void(0);" val='+D+">"+D+"</a>"}$("#pnHead").html(R);continue}}for(var Q=0;Q<E;Q++){if(B.data[Q].PHONE_NUMBER_FEATURE){L=B.data[Q].PHONE_NUMBER_FEATURE;var T;if(L.length<=9){T=L.length}else{T=9}for(var O=0;O<T;O++){var S=(L[O].COLUMN_VALUE_NAME).replace(/\"/g,"");var A=(L[O].COLUMN_VALUE).replace(/\"/g,"");G=G+'<a href="javascript:void(0);" val='+A+">"+S+"</a>"}if(L.length>9){for(var M=0;M<L.length;M++){var S=(L[M].COLUMN_VALUE_NAME).replace(/\"/g,"");var A=(L[M].COLUMN_VALUE).replace(/\"/g,"");I=I+'<a href="javascript:void(0);" val='+A+">"+S+"</a>"}$("#pnCharacterId_more").show();$("#pnCharacterId_more").off("click").on("click",function(U){v();U.stopPropagation()})}$("#pnCharacterId_basic").html(G);$("#pnCharacterId_all").html(I);continue}}}$("#pnCharacterId_basic a").each(function(){$(this).off("click").on("click",function(U){order.phoneNumber.linkQueryPhoneNumber("#pnCharacterId_basic a",this);U.stopPropagation()})});$("#pnCharacterId_all a").each(function(){$(this).off("click").on("click",function(U){order.phoneNumber.linkQueryPhoneNumber("#pnCharacterId_all a",this);U.stopPropagation()})});$("#pnHead a").each(function(){$(this).off("click");$(this).on("click",function(U){order.phoneNumber.linkQueryPhoneNumber("#pnHead a",this);U.stopPropagation()})});$("#preStore a").each(function(){$(this).off("click");$(this).on("click",function(U){order.phoneNumber.linkQueryPhoneNumber("#preStore a",this);U.stopPropagation()})})};var v=function(){if($("#pnCharacterId_basic").is(":hidden")){$("#pnCharacterId_basic").css("display","");$("#pnCharacterId_all").css("display","none");$("#pnCharacterId_all").parent("dl").css("overflow","inherit")}else{$("#pnCharacterId_basic").css("display","none");$("#pnCharacterId_all").css("display","");$("#pnCharacterId_all").parent("dl").css("overflow","hidden")}};var j=function(){order.phoneNumber.queryApConfig();u();var A={};order.phoneNumber.btnQueryPhoneNumber(A);$("#btnNumSearch").off("click").on("click",function(){order.phoneNumber.btnQueryPhoneNumber(A)});$("#btnNumExistSearch").off("click").on("click",function(B){order.phoneNumber.btnIBydentityQuery(A);B.stopPropagation()})};var u=function(){var C=contextPath+"/mktRes/phonenumber/queryPhoneNbrPool";var F={};var A=$.callServiceAsJson(C,F);if(A.code==0){if(A.data){var B=A.data.phoneNbrPoolList;var E=$('<select id="nbrPool" style="width:200px;"></select>');var D=$('<option value="" selected="selected">请选择号池</option>');E.append(D);if(B!=null){$.each(B,function(){var G=$('<option value="'+this.poolId+'">'+this.poolName+"</option>");E.append(G)})}$("#nbrPool").append(E)}}else{if(A.code==-2){$.alertM(A.data)}else{$.alert("提示","号池加载失败，请稍后再试！")}}};var q=function(){order.area.chooseAreaTree("order/prepare","p_phone_areaId_val","p_phone_areaId",3)};var k=function(){var B=contextPath+"/mktRes/phonenumber/prepare";var D={};if(d.accessNumber!=""&&d.anTypeCd!=""){var A=true;for(var C=0;C<p.length;C++){if(p[C]==d.accessNumber){A=false;break}}if(A){D={oldPhoneNumber:d.accessNumber,oldAnTypeCd:d.anTypeCd}}}$.callServiceAsHtmlGet(B,D,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(E){if(!E){E.data="选号页面加载异常,稍后重试"}if(E.code!=0){$.alert("提示","查询失败,稍后重试");return}var F=$("#order_tab_panel_content");F.html(E.data);d={accessNumber:"",level:"",anId:"",anTypeCd:""};j()}})};var l=function(){var D=false;$(".select_nbr_li").each(function(){if($(this).hasClass("select")){D=true}});if(!D){$.alert("提示","请先选择号码！");return}var B=$("#subPage").val();var C=$("#subnum").val();var A=contextPath+"/mktRes/qryPhoneNbrLevelInfoList";$.ligerDialog.open({width:560,height:350,allowClose:false,title:"设置号码等级",url:A+"?pnLevelId="+d.level+"&areaId="+d.areaId+"&org_level="+d.org_level,buttons:[{text:"确定",onclick:function(G,F){var H=phoneNum_level.split("_");F.close();$(".select_nbr_li").each(function(){if($(this).hasClass("select")){var J=$(this).attr("numberval").split("_");var I;if(phoneNum_level!=undefined&&phoneNum_level!=""&&J[5]!=H[0]){I="<span style='float:left;margin-left:10px;'>预存<span class='orange'>"+J[1]+"</span>元<br/>保底<span class='orange'>"+J[2]+"</span>元</span><span style='float:right;margin-right:10px;'>预存<span class='orange'>"+H[1]+"</span>元<br/>保底<span class='orange'>"+H[2]+"</span>元</span><span style='width: 15px; display: table; height: 30px; padding-top: 10px;'><img  src='"+contextPath+"/image/common/levelArrow.png'></span>"}else{I="<span style='padding-left:10px;'>预存<span class='orange'>"+J[1]+"</span>元</span> <span style='padding-left:10px;'> 保底<span class='orange'>"+J[2]+"</span>元</span>"}$(this).find("div").html(I)}});if(B=="number"){d.level=H[0]}else{if(B=="terminal"){d.level=H[0]}else{if(B=="offer"){for(var E=0;E<OrderInfo.boProdAns.length;E++){if(OrderInfo.boProdAns[E].prodId==C){OrderInfo.boProdAns[E].pnLevelId=H[0];break}}}}}}},{text:"关闭",onclick:function(F,E){E.close()}}]})};var y=function(){if(d.level==""||d.level==undefined){$.alert("提示","请先选择号码！");return}var A=$("#subPage").val();if(A=="number"){o()}else{if(A=="terminal"){if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){order.phoneNumber.dialogForm.close(order.phoneNumber.dialog)}}else{if(A=="offer"){if(order.phoneNumber.dialogForm!=undefined&&order.phoneNumber.dialog!=undefined){order.phoneNumber.dialogForm.close(order.phoneNumber.dialog)}}}}};return{qryPhoneNbrLevelInfoList:l,endSelectNum:y,btnPurchase:s,btnQueryPhoneNumber:m,linkQueryPhoneNumber:t,getIndexPagePhoneNumber:z,queryApConfig:r,initPhonenumber:j,boProdAn:d,resetBoProdAn:w,btnIBydentityQuery:b,btnToOffer:g,initOffer:n,initPage:k,chooseArea:q}})();CommonUtils.regNamespace("order","prepare");order.prepare=(function(){var h=function(){$("#order_quick_nav li").each(function(){$(this).off("click").on("click",function(v){OrderInfo.actionFlag=1;var t=$(this).attr("url");var u=$(this).attr("for");f(t,u);v.stopPropagation()})});$("#order_nav li").each(function(){$(this).off("click").on("click",function(v){OrderInfo.actionFlag=1;var t=$(this).attr("url");var u=$(this).attr("for");f(t,u);v.stopPropagation()})});var n=$("#diffPlaceFlag").val();if(n=="diff"){$("#order_prepare").hide();$("#nothreelinks").show()}var p=$("#mktResHidId").attr("mktResCd");var q=$("#offerSpecHidId").val();if(p&&p.length>0){var o=contextPath+"/mktRes/terminal/prepare";var s={};var m=$.callServiceAsHtmlGet(o,s);var r=$("#order_tab_panel_content");r.html(m.data);mktRes.terminal.selectTerminal($("#mktResHidId"));$("#order_prepare").hide();order.prepare.step(1);a("","购手机",true);r.show()}else{if(q&&q.length>0){var o=contextPath+"/order/prodoffer/prepare";var s={prodOfferId:q};var m=$.callServiceAsHtmlGet(o,s);var r=$("#order_tab_panel_content");r.html(m.data);$("#order_prepare").hide();order.prepare.step(1);a("","办套餐",true);r.show();order.service.initSpec();order.prodOffer.init()}}};var f=function(m,n){var o={};$.callServiceAsHtmlGet(m,o,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(p){if(!p){p.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(p.code!=0){$.alert("提示","查询失败,稍后重试");return}if(order.cust.orderBtnflag=="1"){order.cust.btnQueryCustProdMore()}main.home.hideMainIco();$("#order_prepare").hide();$("#order_fill_content").hide();$("#orderedprod").hide();order.prepare.step(1);var q=$("#order_tab_panel_content");q.html(p.data).show();if(n=="order_tab_panel_terminal"){a("","购手机",true);order.service.releaseFlag=1;mktRes.terminal.queryApConfig();
mktRes.terminal.initInParam("","","","","");mktRes.terminal.btnQueryTerminal(1)}else{if(n=="order_tab_panel_phonenumber"){a("","选号码",true);order.service.releaseFlag=1;order.phoneNumber.initPhonenumber()}else{if(n=="order_tab_panel_offer"){a("","办套餐",true);if(order.service.releaseFlag==0){order.service.releaseFlag=2}order.service.initSpec();order.prodOffer.init();order.service.searchPack();order.phoneNumber.resetBoProdAn()}}}}})};var d=function(n,p,o){var m=["8%"];if($.browser.mozilla){m=["8%"]}ec.form.dialog.createDialog({id:"-phonenumber",width:970,height:440,position:m,initCallBack:function(t,r){var s={subPage:n};var q=contextPath+"/mktRes/phonenumber/prepare";$.callServiceAsHtmlGet(q,s,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(u){if(!u){u.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>'}if(u.code!=0){$.alert("提示","查询失败,稍后重试");return}order.phoneNumber.dialogForm=t;order.phoneNumber.dialog=r;var v=$("#phonenumberContent");v.html(u.data);$("#subPage").val(n);$("#subFlag").val(p);$("#subnum").val(o);order.phoneNumber.initPhonenumber()}})},submitCallBack:function(r,q){}})};var b=function(m,q,n){if(c(q,n)){return}var p=$.trim($("#uim_"+n).val());if(p==""){$.alert("提示","UIM卡不能为空!");return}param={oldInstCode:p,phoneNum:""};var o=contextPath+"/mktRes/uim/checkUim";$.callServiceAsJson(o,param,{before:function(){$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(r){if(r.code==0){$.alert("提示","UIM卡释放成功!");$("#uim_btn_"+n).attr("unable","false");$("#uim_btn_"+n).removeClass("disablepurchase").addClass("purchase");$("#uimrelease_btn_"+n).attr("unable","true");$("#uimrelease_btn_"+n).removeClass("purchase").addClass("disablepurchase");$("#uim_"+n).removeAttr("disabled");$("#uim_"+n).val("");for(var t=0;t<OrderInfo.boProd2Tds.length;t++){if(OrderInfo.boProd2Tds[t].prodId==n){OrderInfo.boProd2Tds.splice(t,1)}}for(var t=0;t<OrderInfo.bo2Coupons.length;t++){if(OrderInfo.bo2Coupons[t].prodId==n){var v=OrderInfo.bo2Coupons[t].coupons;if(v.length>0){for(var s=0;s<v.length;s++){if(v[s].couponInstanceNumber==p){OrderInfo.bo2Coupons[t].coupons.splice(s,1);sonExist=true;break}}}else{OrderInfo.bo2Coupons[t].coupons=[]}}}}else{if(typeof r==undefined){$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常")}else{if(r.code==-2){$.alertM(r.data)}else{var u="";if(r.data!=undefined&&r.data.msg!=undefined){u=r.data.msg}else{u="卡号["+p+"]释放失败"}$.alert("提示","UIM卡释放失败，可能原因:"+u)}}}},fail:function(r){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var c=function(n,m){if(n=="0"){if($("#uim_btn_"+m).attr("unable")=="true"){return true}else{return false}}else{if(n=="1"){if($("#uimrelease_btn_"+m).attr("unable")=="true"){return true}else{return false}}else{return true}}};var i=function(u,r,x){if(c(r,x)){return}var v=$.trim($("#uim_"+x).val());if(v==""){$.alert("提示","UIM卡不能为空!");return}for(var p=0;p<OrderInfo.boProd2Tds.length;p++){if(OrderInfo.boProd2Tds[p].terminalCode==v){$.alert("提示","UIM卡已经被预占,请输入其它号码!");return}}var t="";for(var p=0;p<OrderInfo.boProd2Tds.length;p++){if(OrderInfo.boProd2Tds[p].prodId==x){t=OrderInfo.boProd2Tds[p].terminalCode;break}}var w="";for(var p=0;p<OrderInfo.boProdAns.length;p++){if(OrderInfo.boProdAns[p].prodId==x){w=OrderInfo.boProdAns[p].accessNumber;break}}var q=-1;var o=-1;if(OrderInfo.actionFlag==3){var s=order.prodModify.choosedProdInfo;w=s.accNbr;q=s.prodInstId;o=s.prodOfferInstId}if(w==""){$.alert("提示","校验UIM卡前请先选号!");return}var n={instCode:v,phoneNum:w};if(t!=""){n={oldInstCode:t,phoneNum:w,newInstCode:v}}var m=contextPath+"/mktRes/uim/checkUim";$.callServiceAsJson(m,n,{before:function(){$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>")},always:function(){$.unecOverlay()},done:function(E){if(E.code==0){$.alert("提示","UIM卡校验成功!");if(u=="offer"){$("#uim_btn_"+x).attr("unable","true");$("#uim_btn_"+x).removeClass("purchase").addClass("disablepurchase");$("#uimrelease_btn_"+x).attr("unable","false");$("#uimrelease_btn_"+x).removeClass("disablepurchase").addClass("purchase");$("#uim_"+x).attr("disabled",true)}var H=false;for(var G=0;G<OrderInfo.boProd2Tds.length;G++){if(OrderInfo.boProd2Tds[G].prodId==x){OrderInfo.boProd2Tds[G].terminalCode=v;OrderInfo.boProd2Tds[G].couponId=E.data.baseInfo.mktResId;H=true;break}}if(!H){var C={prodId:x,anTypeCd:"",deviceModelId:0,maintainTypeCd:"1",ownerTypeCd:"",state:"",terminalCode:v,terminalDevId:"",terminalDevSpecId:"",couponId:E.data.baseInfo.mktResId,anId:0};OrderInfo.boProd2Tds.push(C)}H=false;var y=E.data.baseInfo.qty;if(y==undefined||y==null){y=1}var z={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:E.data.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:y,storeId:E.data.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:E.data.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:q,offerId:o,state:"ADD",relaSeq:""};for(var G=0;G<OrderInfo.bo2Coupons.length;G++){var I=false;if(OrderInfo.bo2Coupons[G].prodId==x){var B=OrderInfo.bo2Coupons[G].coupons;if(B.length>0){for(var F=0;F<B.length;F++){if(B[F].couponInstanceNumber==t){OrderInfo.bo2Coupons[G].coupons[F]=z;I=true;break}}}else{OrderInfo.bo2Coupons[G].coupons.push(z)}if(!I){OrderInfo.bo2Coupons[G].coupons.push(z)}H=true;break}}if(!H){var D=[];D.push(z);var J={prodId:x,coupons:D};OrderInfo.bo2Coupons.push(J)}}else{if(typeof E==undefined){$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常")}else{if(E.code==-2){$.alertM(E.data)}else{var A="";if(E.data!=undefined&&E.data.msg!=undefined){A=E.data.msg}else{A="卡号["+v+"]预占失败"}$.alert("提示","UIM卡校验失败，可能原因:"+A)}}}},fail:function(y){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var k=function(m){if(m==undefined||!m){m=1}$.each($("div[id^=step]"),function(o,n){if(m==(o+1)){$(this).show()}else{$(this).hide()}})};var j=function(){$("div[id^=step]").hide()};var a=function(n,m,o){};var g=function(){$("#orderTitleDiv").hide()};var l=function(){var m=order.service.boProdAn;if(m.accessNumber&&!m.idFlag){var n={numType:1,numValue:m.accessNumber};$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum",n,{done:function(){}});order.service.boProdAn={}}order.phoneNumber.resetBoProdAn();g();$("#step1").hide();$("#main_div").hide();$("#order_prepare").show();$("#order_tab_panel_content").html("");if(OrderInfo.actionFlag==2){$("#orderedprod").show();$("#arroworder").removeClass();$("#arroworder").addClass("arrowup")}};return{tabChange:h,phoneNumDialog:d,checkUIM:i,step:k,hideStep:j,showOrderTitle:a,hideOrderTitle:g,backToInit:l,releaseUIM:b}})();$(function(){order.prepare.tabChange()});CommonUtils.regNamespace("order","prodOffer");order.prodOffer=(function(d){var c=function(){order.prodOffer.queryApConfig()};var a=function(){var g={CONFIG_PARAM_TYPE:"PROD_AND_OFFER"};var f=contextPath+"/order/queryApConf";d.callServiceAsJsonGet(f,g,{done:b})};var b=function(l){var s;var p;var k;var f="<a href='javascript:void(0);' class='selected' val='' >不限</a>";var n="<a href='javascript:void(0);' class='selected' val='' >不限</a>";var q="<a href='javascript:void(0);' class='selected' val='' >不限</a>";if(l.data){var h=l.data.length;for(var o=0;o<h;o++){if(l.data[o].OFFER_PRICE){s=l.data[o].OFFER_PRICE;for(var m=0;m<s.length;m++){var g=s[m].COLUMN_VALUE;var r=s[m].COLUMN_VALUE_NAME;f=f+"<a href='javascript:void(0);' val='"+g+"'>"+r+"</a>"}d("#price_basic").html(f);d("#price_basic a").each(function(){d(this).off("click").on("click",function(i){d("#price_basic a").each(function(){d(this).removeClass("selected")});d(this).addClass("selected");i.stopPropagation();order.service.searchPack(1)})})}else{if(l.data[o].OFFER_INFLUX){p=l.data[o].OFFER_INFLUX;for(var m=0;m<p.length;m++){var g=p[m].COLUMN_VALUE;var r=p[m].COLUMN_VALUE_NAME;n=n+"<a href='javascript:void(0);' val='"+g+"'>"+r+"</a>"}d("#influx_basic").html(n);d("#influx_basic a").each(function(){d(this).off("click").on("click",function(i){d("#influx_basic a").each(function(){d(this).removeClass("selected")
});d(this).addClass("selected");i.stopPropagation();order.service.searchPack(1)})})}else{if(l.data[o].OFFER_INVOICE){k=l.data[o].OFFER_INVOICE;for(var m=0;m<k.length;m++){var g=k[m].COLUMN_VALUE;var r=k[m].COLUMN_VALUE_NAME;q=q+"<a href='javascript:void(0);' val='"+g+"'>"+r+"</a>"}d("#invoice_basic").html(q);d("#invoice_basic a").each(function(){d(this).off("click").on("click",function(i){d("#invoice_basic a").each(function(){d(this).removeClass("selected")});d(this).addClass("selected");i.stopPropagation();order.service.searchPack(1)})})}}}}}};return{init:c,queryApConfig:a}})(jQuery);$(function(){});CommonUtils.regNamespace("order","refund");order.refund=(function(){var o=false;var m=0;var d=0;var a=0;var g=OrderInfo.staff.areaId;var b=0;var k=function(p){if(!$("#p_areaId_val").val()||$("#p_areaId_val").val()==""){$.alert("提示","请选择'地区'再查询");return}var q=1;if(p>0){q=p}var r={areaId:$("#p_areaId").val(),startDt:$("#p_startDt").val().replace(/-/g,""),endDt:$("#p_endDt").val().replace(/-/g,""),qryNumber:$("#p_qryNumber").val(),channelId:$("#p_channelId").val(),busiStatusCd:"301200",olNbr:$("#p_olNbr").val(),refundFlag:"refund",olStatusCd:"",qryBusiOrder:1,nowPage:q,pageSize:10};$.callServiceAsHtmlGet(contextPath+"/report/cartList",r,{before:function(){$.ecOverlay("订单查询中，请稍等...")},always:function(){$.unecOverlay()},done:function(s){if(!s){s.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>数据加载失败，请稍后重试</strong></div>'}var t=$("#order_list");t.html(s.data).removeClass("cuberight in out").addClass("pop in")},fail:function(s){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var c=function(s,u,t){var q=$.trim($(s).val());if(q==""){$(s).val("0");order.calcharge.reflashTotal()}else{if(t=="old"){var p=true;if(!/^[0-9]+([.]\d{1,2})?$/.test(q)){$.alert("提示","费用金额请输入数字，最高保留两位小数！");p=false}else{if(q<0){$.alert("提示","退费金额不能为负值！");p=false}else{var r=$("#realhidden_"+u).val();if(q*1>r*1){$.alert("提示","退费金额不能高于实收金额！");p=false}}}if(p){var r=$("#realhidden_"+u).val();if(q!=0){$("#chargeModifyReasonCd_"+u).show()}else{$("#chargeModifyReasonCd_"+u).hide();$("#remark_"+u).hide()}order.calcharge.reflashTotal()}else{if(a!=""){$(s).val(a)}a=""}}}};var j=function(p){a=$.trim($(p).val())};var l=function(r,t,s){if(s=="old"){var p=$("#realhidden_"+t).val();if(($("#realAmount_"+t).val())*100==0){$("#realAmount_"+t).val(p);$("#backAmount_"+t).val("0.00")}else{$("#realAmount_"+t).val("0.00");$("#backAmount_"+t).val(p)}var q=($("#backAmount_"+t).val())*1;if(q>0){$("#chargeModifyReasonCd_"+t).show()}else{$("#chargeModifyReasonCd_"+t).hide();$("#remark_"+t).hide()}}else{$(r).parent().parent().remove()}order.calcharge.reflashTotal()};var i=function(r,p,t){m=r;g=t;d=p;b=UUID.getDataId();OrderInfo.order.soNbr=b;var s={olId:r,areaId:t,olNbr:p,soNbr:b};var q=contextPath+"/order/refund/chargeList";$.callServiceAsHtmlGet(q,s,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(u){if(u.code!=0){$.alert("提示","数据加载失败，请稍后重试");return}o=false;$("#d_refund_order").hide();var v=$("#order_charge");v.html(u.data).show();OrderInfo.actionFlag=15;order.calcharge.reflashTotal()},fail:function(u){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var n=function(){var r=($("#realmoney").val())*1;$("#orderCancel").off("click").on("click",function(s){$("#d_refund_order").show();$("#order_charge").hide()});var p=false;var q=0;$("#calTab tbody tr").each(function(){var u=$(this).attr("id");if(u!=undefined&&u!=""){u=u.substr(5,u.length);var s=($("#backAmount_"+u).val())*1;var t=$("#acctItemId_"+u).val();var v=$("#realAmount_"+u).val();if(t=="-1"&&v*1>0){p=true}q=q+s}});if(q>0){p=true}if(!o){if(r>0){$("#printInvoiceA").removeClass("btna_g").addClass("btna_o");$("#printInvoiceA").off("click").on("click",function(s){var t={soNbr:OrderInfo.order.soNbr,billType:0,olId:m,areaId:OrderInfo.staff.areaId,acctItemIds:[]};OrderInfo.orderResult.olId=m;OrderInfo.orderResult.olNbr=d;common.print.prepareInvoiceInfo(t)})}else{$("#printInvoiceA").removeClass("btna_o").addClass("btna_g");$("#printInvoiceA").off("click")}if(p){$("#toComplate").removeClass("btna_g").addClass("btna_o");$("#toComplate").off("click").on("click",function(s){f()})}else{$("#toComplate").removeClass("btna_o").addClass("btna_g");$("#toComplate").off("click")}}else{if(r>0){$("#printInvoiceA").removeClass("btna_g").addClass("btna_o")}else{$("#printInvoiceA").removeClass("btna_o").addClass("btna_g");$("#printInvoiceA").off("click")}$("#toComplate").removeClass("btna_o").addClass("btna_g");$("#toComplate").off("click")}};var h=function(){var p=true;$("#calTab tbody tr").each(function(){var q=$(this).attr("id");if(q!=undefined&&q!=""){q=q.substr(5,q.length);var r=$("#chargeModifyReasonCd_"+q).val();if(r=="1"){if($("#remark_"+q).val()==undefined||$("#remark_"+q).val()==null||$("#remark_"+q).val()==""){p=false}}}});if(!p){$.alert("提示信息","请填写修改原因");return false}_chargeItems=[];$("#calTab tbody tr").each(function(){var t=$(this).attr("id");if(t!=undefined&&t!=""){t=t.substr(5,t.length);var D=$("#acctItemId_"+t).val();var G=($("#realAmount_"+t).val())*100+"";var y=$("#feeAmount_"+t).val();var F=$("#backAmount_"+t).val();var v="";if(y!=undefined&&y!=""){v=y+""}else{v=G}if(OrderInfo.actionFlag==15){v=$("#feeAmount_"+t).val()*1;G=$("#realAmount_"+t).val()*100-$("#backAmount_"+t).val()*100}var E="";if(D=="-1"||(F*1>0)){var x=$("#acctItemTypeId_"+t).val();var r=$("#objId_"+t).val();var s=$("#objType_"+t).val();var C=$("#boId_"+t).val();var A=$("#payMethodCd_"+t).val();var q=$("#objInstId_"+t).val();var w=$("#prodId_"+t).val();var B=$("#chargeModifyReasonCd_"+t).val();var z=$("#chargeModifyReasonCd_"+t).find("option:selected").text();if(B==1){z=$("#remark_"+t).val()}if(D=="-1"){E="1"}else{if(F*1>0){E="-1"}}var u={realAmount:G,feeAmount:v,acctItemTypeId:x,objId:r,objType:s,acctItemId:D,boId:C,prodId:w,objInstId:q,payMethodCd:A,posSeriaNbr:"-1",chargeModifyReasonCd:B,remark:z,operType:E};_chargeItems.push(u)}}});return true};var f=function(){if(o){$.alert("提示","订单已经激活,不能重复操作!");return}if(!h()){return}var q={olId:m,areaId:g,chargeItems:_chargeItems};var p=contextPath+"/order/refund/addOrReturnSubmit";$.callServiceAsJson(p,q,{before:function(){$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(r){var t="";if(r.code==0){o=true;t="提交成功";$("#toComplate").removeClass("btna_o").addClass("btna_g");$("#toComplate").off("click");var s='<table class="contract_list rule">';s+='<thead><tr> <td colspan="2">受理结果</td></tr></thead></table>';s+='<div id="rules_div">';s+='<table width="100%" border="0" cellspacing="0" cellpadding="0">';s+="<tr>";s+='<td align="right"><i class="rule_icon"></i></td>';s+='<td><span class="rule_font">'+t+"</span></td>";s+="</tr>";s+="</table>";s+="</div>";easyDialog.open({container:"successTip_dialog"});$("#successTipContent").html("");$("#successTipContent").html(s);$("#successTipclose").off("click").on("click",function(u){easyDialog.close();$("#d_refund_order").show();$("#order_charge").hide()})}else{if(r.code==-2){$.alertM(r.data)}else{if(r.data!=undefined){$.alert("提示",r.data)}else{$.alert("提示","费用信息提交失败!")}}}},fail:function(r){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};return{queryOrderList:k,queryChargeItems:i,conBtns:n,editMoney:c,setGlobeMoney:j,delItems:l}})();CommonUtils.regNamespace("common","print");common.print=(function(f){var s=function(G,B){if(CONST.getAppDesc()==0){var C=f("#tab_orderList tr[olId="+G+"]");var H="";var v=[];for(var z=0;z<C.length;z++){var F=C[z];var w=f(F).attr("objInstId");if(w==undefined||w==""){f.alert("提示","objInstId为空，请核查接口返回的数据！");return}var A=f(F).attr("accessNumber");if(A==undefined||A==""){f.alert("提示","accessNumber为空，请核查接口返回的数据！");return}}for(var z=0;z<C.length;z++){var F=C[z];var w=f(F).attr("objInstId");var A=f(F).attr("accessNumber");if(f.inArray(w,v)>=0){continue}H=f(F).attr("areaId");OrderInfo.orderResult.olNbr=f(F).attr("olNbr");var E="";OrderInfo.order.soNbr=UUID.getDataId();
var x={areaId:H,acctNbr:A,custId:E,soNbr:OrderInfo.order.soNbr,instId:w,type:"2"};var y=query.offer.invokeLoadInst(x);if(!y){return}v.push(w)}}else{OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olId=G;var D={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,busiType:"1",chargeItems:B};common.print.printVoucher(D)};var p=function(w){f("#voucherForm").remove();if(d("_session_pad_flag")=="1"){var v=new Array(3);if(ec.util.browser.versions.android){v[0]="print/voucher"}else{v[0]="print/iosVoucher"}v[1]="voucherInfo";v[2]=JSON.stringify(w);MyPlugin.printShow(v,function(x){},function(x){})}else{f("<form>",{id:"voucherForm",style:"display:none;",target:"_blank",method:"POST",action:contextPath+"/print/voucher"}).append(f("<input>",{id:"voucherInfo",name:"voucherInfo",type:"hidden",value:JSON.stringify(w)})).appendTo("body").submit()}};var g=function(F,E){if(CONST.getAppDesc()==0){var B=f("#tab_orderList tr[olId="+F+"]");var G="";var v=[];for(var z=0;z<B.length;z++){var D=B[z];var w=f(D).attr("objInstId");if(w==undefined||w==""){f.alert("提示","objInstId为空，请核查接口返回的数据！");return}var A=f(D).attr("accessNumber");if(A==undefined||A==""){f.alert("提示","accessNumber为空，请核查接口返回的数据！");return}}for(var z=0;z<B.length;z++){var D=B[z];var w=f(D).attr("objInstId");var A=f(D).attr("accessNumber");if(f.inArray(w,v)>=0){continue}G=f(D).attr("areaId");OrderInfo.orderResult.olNbr=f(D).attr("olNbr");var C="";OrderInfo.order.soNbr=UUID.getDataId();var x={areaId:G,acctNbr:A,custId:C,soNbr:OrderInfo.order.soNbr,instId:w,type:"2"};var y=query.offer.invokeLoadInst(x);if(!y){return}v.push(w)}}else{OrderInfo.order.soNbr=UUID.getDataId()}OrderInfo.orderResult.olId=F;var x={olId:OrderInfo.orderResult.olId,soNbr:OrderInfo.order.soNbr,billType:0,printFlag:E,areaId:G,acctItemIds:[]};common.print.prepareInvoiceInfo(x)};var k=function(){if(common.print.dialogForm!=undefined&&common.print.dialog!=undefined){common.print.dialogForm.close(common.print.dialog)}};var l=function(v){if(OrderInfo.cust.norTaxPayer=="Y"){f.alert("提示","客户为一般纳税人，请到省份CRM系统打印专用增值税发票！");return}ec.form.dialog.createDialog({id:"-invoice-items",width:580,zIndex:1100,initCallBack:function(y,x){var w=contextPath+"/print/getInvoiceItems";f.callServiceAsJson(w,v,{before:function(){},always:function(){},done:function(z){common.print.dialogForm=y;common.print.dialog=x;f("#invoiceItemsConCancel").off("click").on("click",function(O){common.print.closePrintDialog()});if(!z){f.alert("提示","<br/>查询失败，请稍后重试");common.print.closePrintDialog();return}if(z.code==-2){f.alertM(z.data);common.print.closePrintDialog();return}if(z.code!=0){f.alert("提示","<br/>查询失败，请稍后重试");common.print.closePrintDialog();return}if(z.data.resultCode!="0"){f.alert("提示",z.data.resultMsg);common.print.closePrintDialog();return}if(z.data.chargeItems==undefined||z.data.chargeItems.length==0){f.alert("提示","没有可打印的费用项");common.print.closePrintDialog();return}if(CONST.getAppDesc()==0){var B=contextPath+"/print/getInvoiceTemplates";var E={areaId:OrderInfo.staff.areaId};var A=f.callServiceAsJson(B,E,{});if(A.code==-2){f.alertM(A.data);common.print.closePrintDialog();return}else{if(A.code!=0){f.alert("提示",ec.util.defaultStr(A.data,"获取打印模板出错"));common.print.closePrintDialog();return}else{var D=A.data;if(D.resultCode!="POR-0000"){f.alert("提示",ec.util.defaultStr(D.resultMsg,"获取打印模板异常"));common.print.closePrintDialog();return}if(D.length==0){f.alert("提示","没有获取到可用的打印模板");common.print.closePrintDialog();return}var F="";var J=D.tempList;if(typeof J!=undefined&&J.length>0){F+="<option selected='selected' value="+J[0].templateId+">"+J[0].templateName+"</option>";for(var C=1;C<J.length;C++){var M=J[C];F+="<option value="+M.templateId+">"+M.templateName+"</option>"}}f("#tempListSel").html(F)}}}else{f("#tempListSel").parent().parent().hide()}if(v.billType==1){f("#dialog-form-invoice-items dl[billType='1']").hide();f("#titleDt").html("票据抬头：");f("#tempDt").html("票据模板：")}var K="";var I=z.data.prodInfo;if(I!=undefined&&I.length>0){K+="<option selected='selected' value="+I[0].accessNumber+">"+I[0].accessNumber+"</option>";for(var C=1;C<I.length;C++){var H=I[C];K+="<option value="+H.accessNumber+">"+H.accessNumber+"</option>"}f("#acceNbrSel").data("prodInfo",I)}f("#acceNbrSel").html(K);common.print.oldInvoiceFlag="0";if(n(z.data.invoiceInfos,v.printFlag)){common.print.closePrintDialog();return}var L="";L+="<div id='invoiceContDiv' class='plan_second_list cashier_tr'>";L+="  <table class='contract_list'>";L+="  <thead>";L+="    <tr>";L+="      <td>是否打印</td><td>费用名称</td><td>费用(元)</td><td>税金(元)</td><td>付费方式</td>";L+="    </tr>";L+="  </thead>";L+="  <tbody>";var G=z.data.chargeItems;for(var C=0;C<G.length;C++){var N=G[C];L+="    <tr acctItemId="+N.acctItemId+" acctItemTypeId="+N.acctItemTypeId+" ";L+="        acctItemTypeName='"+N.acctItemTypeName+"' boActionType='"+N.boActionType+"' ";L+="        boActionType='"+N.boActionType+"' boId="+N.boId+" feeAmount="+N.feeAmount+" ";L+="        invoiceId="+N.invoiceId+" objId="+N.objId+" objType="+N.objType+" ";L+="        payMethodCd="+N.payMethodCd+" payMethodName="+N.payMethodName+" ";L+="        realAmount="+N.realAmount+" ";L+="        tax="+N.tax+" taxRate="+N.taxRate+" >";if(a(N)){L+="      <td><input type='checkbox' name='invoiceItemsChkBox' checked='checked'/></td>"}else{L+="      <td><input type='checkbox' name='invoiceItemsChkBox' disabled='disabled'/></td>"}L+="      <td>"+N.acctItemTypeName+"</td>";L+="      <td>"+(N.realAmount/100).toFixed(2)+"</td>";L+="      <td>"+(N.tax/100).toFixed(2)+"</td>";L+="      <td>"+N.payMethodName+"</td>";L+="    </tr>"}L+="  </tbody>";L+="  </table>";L+="</div>";f("#invoiceItemsContDiv").html(L);f("#ec-dialog-form-content").css("height","auto");f("#invoiceItemsConfirm").off("click").on("click",function(O){if(common.print.oldInvoiceFlag!="0"){f.alert("信息","存在未作废发票，请先作废发票");common.print.closePrintDialog();return}j(v,z.data)})}})},submitCallBack:function(x,w){},closeCallBack:function(x,w){}})};var m=function(B){var x=contextPath+"/print/getInvoiceItems";var z=f.callServiceAsJson(x,B);if(!z){f.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(z.code==-2){f.alertM(z.data);return}if(z.code!=0){f.alert("提示","<br/>查询可打印费用项失败，请稍后重试");return}if(z.data.resultCode!="0"){f.alert("提示",z.data.resultMsg);return}if(z.data.chargeItems==undefined||z.data.chargeItems.length==0){f.alert("提示","没有可打印的费用项");return}var v=r(B,z.data);var y=v.invoiceInfos;var A={invoiceInfos:y};var w=h(A,B.printFlag);if(w==false){return false}y=o(y,w.data.invoiceIds,"0");return y};var c=function(v){if(v=="-1"){return"初始打印"}else{if(v=="0"){return"正常打印"}else{if(v=="1"){return"重打"}else{if(v=="2"){return"补打"}else{return"未知操作"}}}}};var n=function(x,w){if(x!=undefined&&x instanceof Array&&x.length>0){for(var v=0;v<x.length;v++){if(x[v].printFlag=="-1"){if(w=="0"||w=="2"){}else{f.alert("信息","此购物车对应的发票未打印过，请到发票补打页面。");return true}}else{if(x[v].printFlag=="0"){if(w=="1"){b(x,w)}else{f.alert("信息","此购物车对应的发票正常打印过，只允许重打。");return true}}else{if(x[v].printFlag=="1"||x[v].printFlag=="2"){if(w=="1"){b(x,w)}else{f.alert("信息","此购物车对应的发票已打印过，只允许重打。");return true}}else{f.alert("信息","发票信息中打印标识值不规范");return true}}}}return false}else{if(w=="0"){return false}else{f.alert("信息","此购物车没有对应的发票信息，只允许正常打印");return true}}};var b=function(A,y){if(A!=undefined&&A instanceof Array&&A.length>0){f("#invalidInvoiceDiv").remove();var x="";x+='<div class="easyDialogdiv" style="width:481px;height:300px;" id="invalidInvoiceDiv">';x+='  <div class="easyDialogclose" id="invalidInvoiceClose"></div>';x+='  <h5 class="s_title">存在未作废发票，请先作废发票</h5>';x+='  <div class="form-content" id="infoDiv">';x+="  </div>";x+='  <div align="center" style="margin: 20px auto;">';x+='    <a id="invalidInvoiceConfirm" class="btna_o" href="javascript:void(0)"><span >确认</span></a>';x+='    <a id="invalidInvoiceCancel" class="btna_o" style="margin-left:20px;" href="javascript:void(0)"><span>取消</span></a>';x+="  </div>";x+="</div>";f("body").append(x);var v="";var z=[];for(var w=0;w<A.length;w++){var B=A[w];
if(f.inArray(B.invoiceId,z)>=0){}else{v+='<div class="marginAndFont">发票代码：'+B.invoiceNbr+"; 发票号码："+B.invoiceNum+"</div><br>";z.push(B.invoiceId)}}if(z.length>0){common.print.oldInvoiceFlag="1";f("#infoDiv").html(v);easyDialog.open({container:"invalidInvoiceDiv"});f("#invalidInvoiceConfirm").off("click").on("click",function(){var E={invoiceIds:z,areaId:OrderInfo.staff.areaId};var C=f.callServiceAsJson(contextPath+"/print/invalidInvoices",E);if(C.code==0){var D=C.data;if(D.resultCode==0){f.alert("信息","作废发票成功");common.print.oldInvoiceFlag="0"}else{if(D.resultMsg!=undefined&&D.resultMsg!=""){f.alert("信息",D.resultMsg)}else{f.alert("信息","作废发票失败")}}}else{if(C.code==-2){f.alertM(C.data);return}else{f.alert("信息","作废发票失败");return}}easyDialog.close()});f("#invalidInvoiceCancel").off("click").on("click",function(){easyDialog.close()})}return false}else{return false}};var a=function(v){var w=v.payMethodCd;if(w==CONST.PAYMETHOD_CD.ZHANG_WU_DAI_SHOU){return false}return true};var q=function(w){try{if(w.billType!=1){if(f("#invoiceNbrInp").val()==""){f.alert("提示","请输入发票代码");return true}if(!/^\d{0,12}$/.test(f("#invoiceNbrInp").val())){f.alert("提示","请输入正确的发票代码");return true}if(f("#invoiceNumInp").val()==""){f.alert("提示","请输入发票号码");return true}if(!/^\d{0,12}$/.test(f("#invoiceNumInp").val())){f.alert("提示","请输入正确的发票号码");return true}}if(f("#invoiceTitleInp").val()==""){f.alert("提示","请输入发票抬头");return true}if(f("#invoiceContDiv tbody input:checked").length<1){f.alert("提示","请选择要打印的费用项");return true}}catch(v){return true}return false};var r=function(v,A){var I=[];var E={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"58B",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:v.billType,printFlag:v.printFlag,invoiceId:0};var x=false;var z=0;var J=0;var G=0;var D=[];var w="";var B=A.chargeItems;for(var y=0;y<B.length;y++){var F=B[y];E.acctItemIds.push({acctItemId:F.acctItemId});if(F.objType=="2"){E.instanceType=F.objType;E.instanceId=F.objId;E.paymethod=F.payMethodCd;x=true}else{if(!x&&F.objType=="7"){E.instanceType=F.objType;E.instanceId=F.objId;E.paymethod=F.payMethodCd}}z+=parseInt(F.feeAmount);J+=parseInt(F.realAmount);G+=parseInt(F.tax);w=F.payMethodName}E.amount=z;E.realPay=J;E.tax=G;E.account=J;E.accountUpper=ec.util.atoc(J);E.invoiceNbr=0;E.invoiceNum="0";var C=A.prodInfo;if(C!=undefined&&C.length>0){E.acctNbr=C[0].accessNumber}I.push(E);var H={payMethodName:w,items:D,invoiceInfos:I};return H};var i=function(v,A){var F=[];var C={acctItemIds:[],instanceType:2,instanceId:0,invoiceType:"58B",staffId:OrderInfo.staff.staffId,amount:0,realPay:0,tax:0,invoiceNbr:0,invoiceNum:"0",custOrderId:OrderInfo.orderResult.olId,custSoNumber:OrderInfo.orderResult.olNbr,custId:OrderInfo.cust.custId,commonRegionId:OrderInfo.staff.areaId,channelId:OrderInfo.staff.channelId,bssOrgId:OrderInfo.staff.orgId,acctNbr:0,paymethod:100000,busiName:"具体业务说明",rmbUpper:"人民币大写",accountUpper:"零圆整",account:0,billType:v.billType,printFlag:v.printFlag,invoiceId:0};C.invoiceId=A.invoiceInfos[0].invoiceId;var x=false;var z=0;var G=0;var D=0;var B=[];var w="";var y=u(A);C.acctItemIds=[];f("#invoiceContDiv tbody input:checked").parent().parent().each(function(){C.acctItemIds.push({acctItemId:f(this).attr("acctItemId")});if(f(this).attr("objType")=="2"){C.instanceType=f(this).attr("objType");C.instanceId=f(this).attr("objId");C.paymethod=f(this).attr("payMethodCd");x=true}else{if(!x&&f(this).attr("objType")=="7"){C.instanceType=f(this).attr("objType");C.instanceId=f(this).attr("objId");C.paymethod=f(this).attr("payMethodCd")}}z+=parseInt(f(this).attr("feeAmount"));G+=parseInt(f(this).attr("realAmount"));D+=parseInt(f(this).attr("tax"));var I="";var H=f(this).attr("boId");for(var J=0;J<y.length;J++){if(H==y[J].boId){I=y[J].accessNumber}}B.push({itemName:f(this).attr("acctItemTypeName"),charge:parseInt(f(this).attr("realAmount")),tax:parseInt(f(this).attr("tax")),accessNumber:I});w=f(this).attr("payMethodName")});if(OrderInfo.actionFlag==11){C.printFlag=0}C.amount=z;C.realPay=G;C.tax=D;C.account=G;C.accountUpper=ec.util.atoc(G);C.invoiceNbr=f("#invoiceNbrInp").val();C.invoiceNum=""+f("#invoiceNumInp").val();C.acctNbr=f("#acceNbrSel option:selected").val();F.push(C);var E={payMethodName:w,items:B,invoiceInfos:F};return E};var u=function(B){var y=[];var C=B.chargeItems;var D=B.prodInfo;for(var z=0;z<C.length;z++){var F=C[z].boId;for(var w=0;w<D.length;w++){var A=D[w].accessNumber;var E=D[w].busiOrders;for(var v=0;v<E.length;v++){if(E[v].boId==F){var x={boId:F,accessNumber:A};y.push(x)}}}}return y};var j=function(B,z){if(q(B)){return}var v=i(B,z);var y=v.invoiceInfos;var A={invoiceInfos:y};var w=h(A,B.printFlag);if(w==false){return}var x={partyName:f("#invoiceTitleInp").val(),templateId:f("#tempListSel :selected").val(),prodInfo:f("#acceNbrSel").data("prodInfo"),items:v.items,payMethod:v.payMethodName,invoiceInfos:y};t(x);common.print.closePrintDialog();return};var h=function(x,w){f.ecOverlay("<strong>正在提交中,请稍等会儿....</strong>");var v=f.callServiceAsJson(contextPath+"/print/saveInvoiceInfo",x);f.unecOverlay();if(v.code==-2){f.alertM(v.data);return false}else{if(v.code!=0||v.data.resultCode!="0"){f.alert("提示",c(w)+"调用集团发票打印处理接口失败，请稍后重试");return false}}return v};var o=function(y,x,w){for(var v=0;v<y.length;v++){y[v].invoiceId=x[v];y[v].printFlag=w}return y};var d=function(x){var w="";var v=document.cookie.match(new RegExp("(^| )"+x+"=([^;]*)(;|$)"));if(v!=null){w=unescape(v[2])}return w};var t=function(w){f("#invoiceForm").remove();if(d("_session_pad_flag")=="1"){var v=new Array(3);if(ec.util.browser.versions.android){v[0]="print/invoice"}else{v[0]="print/iosInvoice"}v[1]="invoiceParam";v[2]=encodeURI(JSON.stringify(w));MyPlugin.printShow(v,function(x){},function(x){})}else{f("<form>",{id:"invoiceForm",style:"display:none;",target:"_blank",method:"POST",action:contextPath+"/print/invoice"}).append(f("<input>",{id:"invoiceParam",name:"invoiceParam",type:"hidden",value:encodeURI(JSON.stringify(w))})).appendTo("body").submit()}};return{preVoucher:s,printVoucher:p,preInvoice:g,initPrintInfo:m,closePrintDialog:k,prepareInvoiceInfo:l,saveInvoiceInfo:j,printInvoice:t}})(jQuery);$(function(){});CommonUtils.regNamespace("prod","changeUim");prod.changeUim=(function(){var c=function(){var g=order.prodModify.choosedProdInfo;var k={areaId:OrderInfo.staff.areaId,custId:OrderInfo.cust.custId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,boInfos:[{boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_CARD,instId:g.prodInstId,specId:CONST.PROD_SPEC.CDMA}]};var h=$("#DiffPlaceFlag").val();var f="";var j="";if(h=="diff"){f=CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD;j="异地补换卡";var i=g.areaId;if(i==undefined||i==""){$.alert("提示","营业后台未返回产品归属地区，无法办理异地补换卡业务！");return false}}else{f=CONST.BO_ACTION_TYPE.CHANGE_CARD;j="补换卡"}var d={prodId:g.prodInstId};OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,f,22,j,"");rule.rule.prepare(k,"prod.changeUim.initFillPage",d)};var b=function(f){if(!prod.uim.setProdUim()){return false}var d=order.prodModify.choosedProdInfo;$.callServiceAsHtml(contextPath+"/prod/changeCard",f,{before:function(){},done:function(g){$("#order_fill_content").html(g.data).show();$("#fillLastStep").click(function(){order.prodModify.cancel()});$("#nothreelinks").css("display","none");$(".ordercon").show();$(".ordertabcon").show();$(".h2_title").append(d.productName+"-"+d.accNbr);order.prepare.step(1);$("#orderedprod").hide();$("#order_prepare").hide()},always:function(){$.unecOverlay()}})};var a=function(){var d=order.prodModify.choosedProdInfo;var g={prodId:d.prodInstId,boActionTypeCd:OrderInfo.boActionTypeCd,remark:$("#orderRemark").val()};var f=[];f.push(OrderInfo.getProdBusiOrder(g));
SoOrder.submitOrder(f)};return{init:c,initFillPage:b,submit:a}})();CommonUtils.regNamespace("prod","telnum");var phoneNum_level="";prod.telnum=(function(){var d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",memberRoleCd:""};var v=function(){d={accessNumber:"",org_level:"",level:"",anId:"",anTypeCd:"",areaId:"",memberRoleCd:""}};var p=[];var h=contextPath+"/mktRes/telnumcg/list";var c="";var m=function(A){A=i(A);$.callServiceAsHtmlGet(h,A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(B){if(!B||B.code!=0){B.data="查询失败,稍后重试"}var C=$("#order_phonenumber .phone_warp");C.html(B.data);$("#btnSwitchNbr").off("click").on("click",function(){prod.telnum.btnQueryPhoneNumber({})})},fail:function(B){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var b=function(){var A=$.trim($("#idCode").val());if(A==""){$.alert("提示","请先输入身份证号码!");return}if(!a(A)){$.alert("提示","身份证号码输入有误!");return}var C=$("#p_phone_areaId").val();var B={identityId:A,areaId:C};$.callServiceAsHtmlGet(contextPath+"/mktRes/telnumcg/listByIdentity",B,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(D){if(!D||D.code!=0){D.data="查询失败,稍后重试"}else{if(D.code==-2){return}}var E=$("#order_phonenumber .phone_warp");E.html(D.data)},fail:function(D){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var g=function(K){c=$(K).attr("numberVal");var L=CONST.MEMBER_ROLE_CD.MAIN_CARD;var H=$("#subFlag").val();if(H=="Y2"){L=CONST.MEMBER_ROLE_CD.VICE_CARD}var F=$("#subnum").val();var R=$("#subPage").val();var B=c.split("_")[1];var E=c.split("_")[2];if(order.service.offerprice!=""){var T=parseInt(E);var I=parseInt(order.service.offerprice);if(I<T){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var G=c.split("_")[0];var S=c.split("_")[3];var P=c.split("_")[5];var M=c.split("_")[6];var N=$("#chooseAreaId").val();if(N==null||N==""){N=OrderInfo.staff.areaId}if(G){var C=false;var A="";var J="";A=d.accessNumber;J=d.anTypeCd;if(A!=""){C=true;for(var O=0;O<p.length;O++){if(p[O]==A){C=false;break}}if(C){var D=contextPath+"/mktRes/phonenumber/purchase";var Q={oldPhoneNumber:A,oldAnTypeCd:J};$.callServiceAsJson(D,Q,{})}}p.push(G);d.accessNumber=G;d.anTypeCd=S;d.level=response.data.phoneLevelId;d.org_level=response.data.phoneLevelId;d.anId=response.data.phoneNumId;d.areaId=N;d.memberRoleCd=L;order.service.boProdAn=d;$(K).siblings().each(function(){$(this).removeClass("select")});$(K).addClass("select")}else{$.alert("提示","号码格式不正确!")}};var n=function(A){if(d.accessNumber!=""){$("#nbr_btn_"+A).removeClass("selectBoxTwo");$("#nbr_btn_"+A).addClass("selectBoxTwoOn");$("#nbr_btn_"+A).html(d.accessNumber+"<u></u>")}if(d.accessNumber!=""){var B=false;if(OrderInfo.boProdAns.length>0){for(var C=0;C<OrderInfo.boProdAns.length;C++){if(OrderInfo.boProdAns[C].prodId==A){OrderInfo.boProdAns[C].accessNumber=d.accessNumber;OrderInfo.boProdAns[C].anTypeCd=d.anTypeCd;OrderInfo.boProdAns[C].anId=d.anId;OrderInfo.boProdAns[C].pnLevelId=d.level;OrderInfo.boProdAns[C].areaId=d.areaId;OrderInfo.boProdAns[C].memberRoleCd=d.memberRoleCd;if(d.idFlag){OrderInfo.boProdAns[C].idFlag=d.idFlag}B=true;break}}}if(!B){var D={prodId:A,accessNumber:d.accessNumber,anChooseTypeCd:"2",anId:d.anId,pnLevelId:d.level,anTypeCd:d.anTypeCd,state:"ADD",areaId:d.areaId,memberRoleCd:d.memberRoleCd};if(d.idFlag){D.idFlag=d.idFlag}OrderInfo.boProdAns.push(D)}if(A=="-1"){OrderInfo.boCustInfos.telNumber=d.accessNumber}}};var o=function(){var A={};$.callServiceAsHtmlGet(contextPath+"/order/prodoffer/prepare",A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(B){if(!B||B.code!=0){B.data="查询失败,稍后重试"}var C=$("#order_tab_panel_content");C.html(B.data);order.service.initSpec();order.prodOffer.init();order.service.searchPack()},fail:function(B){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})};var s=function(F){c=$(F).attr("numberVal");var H=CONST.MEMBER_ROLE_CD.MAIN_CARD;var M=$("#subFlag").val();if(M=="Y2"){H=CONST.MEMBER_ROLE_CD.VICE_CARD}var Q=c.split("_")[1];var J=c.split("_")[2];var L=$("#chooseAreaId").val();if(L==null||L==""){L=OrderInfo.staff.areaId}if(order.service.offerprice!=""){var G=parseInt(J);var O=parseInt(order.service.offerprice);if(O<G){$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");return}}var P=c.split("_")[0];var I=c.split("_")[3];var E=c.split("_")[5];if(P){var C={phoneNumber:P,actionType:"E",anTypeCd:I};var A=false;var K="";var N="";K=d.accessNumber;N=d.anTypeCd;if(K==P){$.alert("提示","号码已经被预占,请选择其它号码!");return}else{d={}}if(K!=""){A=true;for(var D=0;D<p.length;D++){if(p[D]==K){A=false;break}}if(A){C={newPhoneNumber:P,oldPhoneNumber:K,newAnTypeCd:I,oldAnTypeCd:N}}}var B=contextPath+"/mktRes/phonenumber/purchase";$.callServiceAsJson(B,C,{before:function(){$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(R){if(R.code==0){d.accessNumber=P;d.anTypeCd=I;d.level=R.data.phoneLevelId;d.org_level=R.data.phoneLevelId;d.anId=R.data.phoneNumId;d.areaId=L;d.memberRoleCd=H;order.service.boProdAn=d;$(F).siblings().each(function(){$(this).removeClass("select");var T=$(this).attr("numberval").split("_");var S="<span style='padding-left:10px;'>预存<span class='orange'>"+T[1]+"</span>元</span><span style='padding-left:10px;'>保底<span color='orange'>"+T[2]+"</span>元</span>";$(this).find("div").html(S)});$(F).addClass("select")}else{if(R.code==-2){$.alertM(R.data)}else{$.alert("提示","号码预占失败!")}}},fail:function(R){$.unecOverlay();$.alert("提示","服务忙，请稍后再试！")}})}else{$.alert("提示","号码格式不正确!")}};var t=function(B,A){f(B,A);m()};var i=function(B){var F=$("#p_phone_areaId").val();var G=$("#pnHead").find("a.selected").attr("val");var H=$.trim($("#pnEnd").val());if(H=="最后四位"){H=""}var I=$.trim($("#phoneNum").val());if(I=="任意四位"){I=""}var D;var E="";var A="";var C=$("#preStore").find("a.selected");if(C.length>0){E=C.attr("Greater");A=C.attr("Less")}if($("#pnCharacterId_basic").css("display")!="none"){D=$("#pnCharacterId_basic a.selected").attr("val")}if($("#pnCharacterId_all").css("display")!="none"){D=$("#pnCharacterId_all a.selected").attr("val")}D=ec.util.defaultStr(D);return{pnHead:G,pnEnd:H,pnCharacterId:D,maxPrePrice:A,minPrePrice:E,pnLevelId:"",pageSize:"20",phoneNum:I,areaId:F}};var f=function(B,A){$(B).each(function(){$(this).removeClass("selected")});$(A).addClass("selected")};var z=function(A){var B={pageIndex:A};prod.telnum.btnQueryPhoneNumber(B)};var a=function(E){E=E.toUpperCase();if(!(/(^\d{15}$)|(^\d{17}([0-9]|X)$)/.test(E))){return false}var F,K;F=E.length;if(F==15){K=new RegExp(/^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/);var J=E.match(K);var C=new Date("19"+J[2]+"/"+J[3]+"/"+J[4]);var B;B=(C.getYear()==Number(J[2]))&&((C.getMonth()+1)==Number(J[3]))&&(C.getDate()==Number(J[4]));if(!B){return false}else{var H=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var I=new Array("1","0","X","9","8","7","6","5","4","3","2");var G=0,D;E=E.substr(0,6)+"19"+E.substr(6,E.length-6);for(D=0;D<17;D++){G+=E.substr(D,1)*H[D]}E+=I[G%11];return E}}if(F==18){K=new RegExp(/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/);var J=E.match(K);var C=new Date(J[2]+"/"+J[3]+"/"+J[4]);var B;B=(C.getFullYear()==Number(J[2]))&&((C.getMonth()+1)==Number(J[3]))&&(C.getDate()==Number(J[4]));if(!B){return false}else{var A;var H=new Array(7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2);var I=new Array("1","0","X","9","8","7","6","5","4","3","2");var G=0,D;for(D=0;D<17;D++){G+=E.substr(D,1)*H[D]}A=I[G%11];if(A!=E.substr(17,1)){return false}return E}}return false};var r=function(){var B={CONFIG_PARAM_TYPE:"TERMINAL_AND_PHONENUMBER"};var A=contextPath+"/order/queryApConf";$.callServiceAsJsonGet(A,B,{done:w})};var w=function(B){var K;var H;var L;var C='<a href="javascript:void(0);" class="selected" Greater="" Less="">不限</a>';var R='<a href="javascript:void(0);" class="selected" val="">不限</a>';var G='<a href="javascript:void(0);" class="selected " val="">不限</a>';
var I='<a href="javascript:void(0);" class="selected " val="">不限</a>';if(B.data){var E=B.data.length;for(var Q=0;Q<E;Q++){if(B.data[Q].PHONE_NUMBER_PRESTORE){K=B.data[Q].PHONE_NUMBER_PRESTORE;for(var O=0;O<K.length;O++){var J=K[O].COLUMN_VALUE_NAME.replace(/\"/g,"");var P;var N;var F=J.split("-");if(F.length!=1){P=F[0];N=F[1]}else{F=F.toString();P=F.substring(0,F.length-2);N='""'}J=J.replace(/\"/g,"");C=C+'<a href="javascript:void(0);" Greater='+P+" Less="+N+">"+J+"</a>"}$("#preStore").html(C);continue}}for(var Q=0;Q<E;Q++){if(B.data[Q].PHONE_NUMBER_SEGMENT){H=B.data[Q].PHONE_NUMBER_SEGMENT;for(var O=0;O<H.length;O++){var D=H[O].COLUMN_VALUE_NAME;D=D.replace(/\"/g,"");R=R+'<a href="javascript:void(0);" val='+D+">"+D+"</a>"}$("#pnHead").html(R);continue}}for(var Q=0;Q<E;Q++){if(B.data[Q].PHONE_NUMBER_FEATURE){L=B.data[Q].PHONE_NUMBER_FEATURE;var T;if(L.length<=6){T=L.length}else{T=6}for(var O=0;O<T;O++){var S=(L[O].COLUMN_VALUE_NAME).replace(/\"/g,"");var A=(L[O].COLUMN_VALUE).replace(/\"/g,"");G=G+'<a href="javascript:void(0);" val='+A+">"+S+"</a>"}if(L.length>6){for(var M=0;M<L.length;M++){var S=(L[M].COLUMN_VALUE_NAME).replace(/\"/g,"");var A=(L[M].COLUMN_VALUE).replace(/\"/g,"");I=I+'<a href="javascript:void(0);" val='+A+">"+S+"</a>"}$("#pnCharacterId_more").show();$("#pnCharacterId_more").off("click").on("click",function(U){u();U.stopPropagation()})}$("#pnCharacterId_basic").html(G);$("#pnCharacterId_all").html(I);continue}}}$("#pnCharacterId_basic a").each(function(){$(this).off("click").on("click",function(U){prod.telnum.linkQueryPhoneNumber("#pnCharacterId_basic a",this);U.stopPropagation()})});$("#pnCharacterId_all a").each(function(){$(this).off("click").on("click",function(U){prod.telnum.linkQueryPhoneNumber("#pnCharacterId_all a",this);U.stopPropagation()})});$("#pnHead a").each(function(){$(this).off("click");$(this).on("click",function(U){prod.telnum.linkQueryPhoneNumber("#pnHead a",this);U.stopPropagation()})});$("#preStore a").each(function(){$(this).off("click");$(this).on("click",function(U){prod.telnum.linkQueryPhoneNumber("#preStore a",this);U.stopPropagation()})})};var u=function(){if($("#pnCharacterId_basic").is(":hidden")){$("#pnCharacterId_basic").css("display","");$("#pnCharacterId_all").css("display","none");$("#pnCharacterId_all").parent("dl").css("overflow","inherit")}else{$("#pnCharacterId_basic").css("display","none");$("#pnCharacterId_all").css("display","");$("#pnCharacterId_all").parent("dl").css("overflow","hidden")}};var j=function(){prod.telnum.queryApConfig();var A={};prod.telnum.btnQueryPhoneNumber(A);$("#btnNumSearch").off("click").on("click",function(){prod.telnum.btnQueryPhoneNumber(A)});$("#btnNumExistSearch").off("click").on("click",function(B){prod.telnum.btnIBydentityQuery(A);B.stopPropagation()})};var q=function(){order.area.chooseAreaTree("order/prepare","p_phone_areaId_val","p_phone_areaId",3)};var k=function(){var C=order.prodModify.getCallRuleParam(CONST.BO_ACTION_TYPE.UPDATE_ACCNBR,order.prodModify.choosedProdInfo.prodInstId);var A={boActionTypeCd:CONST.BO_ACTION_TYPE.UPDATE_ACCNBR,boActionTypeName:CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.UPDATE_ACCNBR),accessNumber:order.prodModify.choosedProdInfo.accNbr,prodOfferName:order.prodModify.choosedProdInfo.prodOfferName};var B=rule.rule.prepare(C,"prod.telnum.showTelnumChange",A);if(B){return}};var x=function(){OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.UPDATE_ACCNBR,16,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.UPDATE_ACCNBR),"");SoOrder.builder();var B=contextPath+"/mktRes/telnumcg-prepare";var D={};if(d.accessNumber!=""&&d.anTypeCd!=""){var A=true;for(var C=0;C<p.length;C++){if(p[C]==d.accessNumber){A=false;break}}if(A){D={oldPhoneNumber:d.accessNumber,oldAnTypeCd:d.anTypeCd}}}$.callServiceAsHtmlGet(B,D,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>")},always:function(){$.unecOverlay()},done:function(E){if(!E){E.data="选号页面加载异常,稍后重试"}if(E.code!=0){$.alert("提示","查询失败,稍后重试");return}var F=$("#order_fill_content").show();F.html(E.data);$("#cgnum_view").html(order.prodModify.choosedProdInfo.productName+"："+order.prodModify.choosedProdInfo.accNbr);d={accessNumber:"",level:"",anId:"",anTypeCd:""};j()}})};var y=function(){if(d.accessNumber){OrderInfo.boProdAns=[];d.state="ADD";OrderInfo.boProdAns.push(d);var B={prodInstId:order.prodModify.choosedProdInfo.prodInstId,areaId:order.prodModify.choosedProdInfo.areaId};var A=contextPath+"/mktRes/telnumcg/queryProdInstAccNbr";$.callServiceAsJson(A,B,{done:function(C){if(C.code==0){if(C.data.prodInstAccNbrList&&C.data.prodInstAccNbrList.length>0){var D=C.data.prodInstAccNbrList[0];var E={accessNumber:D.accNbr,anTypeCd:d.anTypeCd,anId:D.anId,state:"DEL"};OrderInfo.boProdAns.push(E);SoOrder.submitOrder()}else{$.alert("提示","该产品实例未返回原号码信息")}}else{if(C.code==-2){$.alertM(C.data)}else{if(C.data){$.alert("提示","产品实例与号码关系查询异常！"+C.data)}else{$.alert("提示","产品实例与号码关系查询异常！")}return}}}})}else{$.alert("提示","请选择新号码！")}};var l=function(){if(d.level==""){$.alert("提示","请先选择新号码！");return}var A=contextPath+"/mktRes/qryPhoneNbrLevelInfoList";$.ligerDialog.open({width:560,height:350,title:"设置号码等级",allowClose:false,url:A+"?pnLevelId="+d.level+"&areaId="+d.areaId+"&org_level="+d.org_level,buttons:[{text:"确定",onclick:function(C,B){var D=phoneNum_level.split("_");B.close();$(".select_nbr_li").each(function(){if($(this).hasClass("select")){var F=$(this).attr("numberval").split("_");var E;if(phoneNum_level!=undefined&&phoneNum_level!=""&&F[5]!=D[0]){E="<span style='float:left;margin-left:10px;'>预存<span class='orange'>"+F[1]+"</span>元<br/>保底<span class='orange'>"+F[2]+"</span>元</span><span style='float:right;margin-right:10px;'>预存<span class='orange'>"+D[1]+"</span>元<br/>保底<span class='orange'>"+D[2]+"</span>元</span><span style='width: 15px; display: table; height: 30px; padding-top: 10px;'><img  src='"+contextPath+"/image/common/levelArrow.png'></span>"}else{E="<span style='padding-left:10px;'>预存<span class='orange'>"+F[1]+"</span>元</span> <span style='padding-left:10px;'> 保底<span class='orange'>"+F[2]+"</span>元</span>"}$(this).find("div").html(E)}});d.level=D[0]}},{text:"关闭",onclick:function(C,B){B.close()}}]})};return{qryPhoneNbrLevelInfoList:l,nextStep:y,btnPurchase:s,btnQueryPhoneNumber:m,linkQueryPhoneNumber:t,getIndexPagePhoneNumber:z,queryApConfig:r,initPhonenumber:j,boProdAn:d,resetBoProdAn:v,btnIBydentityQuery:b,btnToOffer:g,initOffer:n,initPage:k,showTelnumChange:x,chooseArea:q}})();CommonUtils.regNamespace("prod","transferModify");prod.transferModify=(function(){var b="";var v={};var r="";var j={};var w=function(){var B="";r=CONST.BO_ACTION_TYPE.TRANSFER;B="ADD";var C=order.prodModify.getCallRuleParam(r,order.prodModify.choosedProdInfo.prodInstId);var z={boActionTypeCd:r,boActionTypeName:CONST.getBoActionTypeName(r),accessNumber:"",prodOfferName:"",state:B};var A=rule.rule.prepare(C,"prod.transferModify.custTransfer",z);if(A){return}};var p=function(){var B="";r=CONST.BO_ACTION_TYPE.TRANSFERRETURN;B="ADD";var C=order.prodModify.getCallRuleParam(r,order.prodModify.choosedProdInfo.prodInstId);var z={boActionTypeCd:r,boActionTypeName:CONST.getBoActionTypeName(r),accessNumber:"",prodOfferName:"",state:B};var A=rule.rule.prepare(C,"prod.transferModify.custTransfer",z);if(A){return}};var x=function(){var O=$("#litransCustId").attr("transCustId");var C=-1;if(O!=""){C=O}var B=$("#litransCustId").attr("transCustName");var V=$("#litransCustId").attr("transAddressStr");var Q=$("#div_tra_identidiesTypeCd option:selected").val();var J=$("#litransidCardNumber").attr("transidCardNumber");if(O==OrderInfo.cust.custId){$.alert("提示","同一客户，无需过户，请确认！","information");return}if(J==undefined||O==undefined){$.alert("提示","未定位目标客户，请先定位！","information");return}if(!$("#acctSelect").val()){$.alert("提示","请新建或者查询选择一个可用帐户");return}if($("#acctSelect").val()<0){if(!SoOrder.checkAcctInfo()){return}}var P=$("#acctSelect").val();var N=-1;if(P>0){N=$("#acctSelect").find("option:selected").attr("acctcd")}SoOrder.builder();
var H={prodId:order.prodModify.choosedProdInfo.prodInstId,acctNbr:order.prodModify.choosedProdInfo.accNbr};var R=$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo",H);if(R.code!=0||R.data.length==0){if(R.code==-2){$.alertM(R.data)}else{$.alert("提示","当前产品帐户定位失败，请联系管理员")}return}var D=R.data[0];var W=true;if(D.acctId==P){W=false}if(D.priority==""){D.priority=1}OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,r,10,CONST.getBoActionTypeName(r),"");var M=[];if(O==""){var K={areaId:OrderInfo.staff.areaId,boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.CUST_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.CUST_CREATE},busiObj:{instId:-1},busiOrderInfo:{seq:OrderInfo.SEQ.seq--},data:{boCustIdentities:[{identidiesTypeCd:Q,identityNum:J,defaultIdType:Q,state:"ADD"}],boCustInfos:[{areaId:OrderInfo.staff.areaId,businessPassword:"111111",name:B,addressStr:V,partyTypeCd:1,state:"ADD"}]}};M.push(K)}var E={areaId:OrderInfo.staff.areaId,boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:r},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,isComp:"N",objId:CONST.PROD_SPEC.CDMA,offerTypeCd:"1"},busiOrderInfo:{seq:OrderInfo.SEQ.seq--},data:{boCusts:[{partyId:order.prodModify.choosedProdInfo.custId,partyProductRelaRoleCd:0,state:"DEL"},{partyId:C,partyProductRelaRoleCd:0,state:"ADD"}],busiOrderAttrs:[{itemSpecId:"111111118",value:$("#order_remark").val()}]}};M.push(E);if(r==CONST.BO_ACTION_TYPE.TRANSFERRETURN){var G={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,objId:order.prodModify.choosedProdInfo.productId},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACTIVERETURNTWO},data:{}};G.data.boProdStatuses=[{prodStatusCd:CONST.PROD_STATUS_CD.READY_PROD,state:"DEL"},{prodStatusCd:CONST.PROD_STATUS_CD.DONE_PROD,state:"ADD"}];M.push(G)}if($("#acctSelect").val()==-1){var I=$("#acctName").val();var S=$("#paymentType").val();var z="";var U="";var A="";if(S==110000){z=$("#bankId").val();U=$("#bankAcct").val();A=$("#paymentMan").val()}var T={areaId:OrderInfo.staff.areaId,busiOrderInfo:{seq:OrderInfo.SEQ.seq--},busiObj:{instId:-1},boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.ACCT_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.ACCT_CREATE},data:{boAccountInfos:[{partyId:C,acctName:I,acctCd:-1,acctId:-1,businessPassword:"111111",state:"ADD",acctTypeCd:"1"}],boPaymentAccounts:[{paymentAcctTypeCd:S,bankId:z,bankAcct:U,paymentMan:A,limitQty:"1",state:"ADD"}],boAcct2PaymentAccts:[{priority:"1",state:"ADD"}],boAccountItems:[],boAccountMailings:[]}};if($("#postType").val()!=-1){var F={mailingType:$("#postType").val(),param1:$("#postAddress").val(),param2:"1",param3:$("#postCycle").val(),param7:$("#billContent").val(),state:"ADD"};if($("#postType").val()==11||$("#postType").val()==15){F.param1=$("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val()}T.data.boAccountMailings.push(F)}M.push(T)}if(W){var L={areaId:OrderInfo.staff.areaId,boActionType:{actionClassCd:CONST.ACTION_CLASS_CD.PROD_ACTION,boActionTypeCd:CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT},busiObj:{accessNumber:order.prodModify.choosedProdInfo.accNbr,instId:order.prodModify.choosedProdInfo.prodInstId,isComp:"N",objId:CONST.PROD_SPEC.CDMA,offerTypeCd:"1"},busiOrderInfo:{seq:OrderInfo.SEQ.seq--},data:{boAccountRelas:[{acctCd:D.acctCd,acctId:D.acctId,acctRelaTypeCd:1,chargeItemCd:D.chargeItemCd,percent:D.percent,priority:D.priority,prodAcctId:D.prodAcctId,state:"DEL"},{acctCd:N,acctId:P,acctRelaTypeCd:1,chargeItemCd:1,percent:100,priority:1,prodAcctId:-1,state:"ADD"}]}};M.push(L);SoOrder.submitOrder(M)}else{$.confirm("提示信息","只更换了所属客户，而没有更换付费帐户<br/>确定吗？",{yes:function(){SoOrder.submitOrder(M)},no:function(){return}},"question")}};var a=function(A){var z=$(A).val();$("#div_tra_identidiesTypeCd").empty();u(z);c($("#div_tra_identidiesTypeCd").children(":first-child"))};var f=function(z){if(z=="1"){var A='<select id="tra_IdentidiesTypeCd" onchange="order.transferModify.identidiesTypeCdChoose(this)"><option value="1" >身份证</option><option value="2">军官证</option></select>'}else{if(z=="2"){var A='<select id="tra_IdentidiesTypeCd" onchange="order.transferModify.identidiesTypeCdChoose(this)"><option value="3">护照</option><option value="23">ICP经营许可证</option><option value="39">税务登记号</option></select>'}}$("#div_tra_identidiesTypeCd").html(A)};var c=function(z){var A=$(z).val();if(A==1||A=="undefined"){$("#transfercCustIdCard").attr("placeHolder","请输入合法身份证号码");$("#transfercCustIdCard").attr("data-validate","validate(idCardCheck:请输入合法身份证号码) on(blur)")}else{if(A==2){$("#transfercCustIdCard").attr("placeHolder","请输入合法军官证");$("#transfercCustIdCard").attr("data-validate","validate(required:请准确填写军官证) on(blur)")}else{if(A==3){$("#transfercCustIdCard").attr("placeHolder","请输入合法护照");$("#transfercCustIdCard").attr("data-validate","validate(required:请准确填写护照) on(blur)")}else{$("#transfercCustIdCard").attr("placeHolder","请输入合法证件号码");$("#transfercCustIdCard").attr("data-validate","validate(required:请准确填写证件号码) on(blur)")}}}g()};var s=function(){$("#custTransferForm").off("formIsValid").on("formIsValid",function(A){var C="";var z="";var B="";C=$("#p_cust_tra_identityCd").val();B=$.trim($("#TransferNum").val());if(B==""){$.alert("提示","请输入证件号码！");return}if($("#TransferNum").val().length<14){authFlag="0"}else{authFlag="1"}if(C==1){C=$("#p_cust_tra_identityCd").val()}if(C==-1){z=B;B="";C=""}var D={acctNbr:z,identityCd:C,identityNum:B,partyName:"",custQueryType:$("#custQueryType").val()};$.callServiceAsHtml(contextPath+"/order/prodModify/transferQueryCust",D,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(E){if(E.code!=0){$.alert("提示","查询失败,稍后重试");return}n(E)},fail:function(E){$.unecOverlay();$.alert("提示","查询失败，请稍后再试！")},always:function(){$.unecOverlay();$("#usersearchbtn").attr("disabled",false)}})}).ketchup({bindElement:"custTransferBtn"})};var d=function(){$("#transCustAuthForm").unbind("click").bind("formIsValid",function(A,z){var B=v;B.prodPwd=$.trim($("#transAuthPassword").val());B.authFlag=authFlag;$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",B,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(C){if(C.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(C.data=="false\r\n"){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}o(C)},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"transCustAuthbtn"})};var g=function(){$("#ransferCustCreateForm").unbind("click").bind("formIsValid",function(A){var z={cCustName:$.trim($("#transfercCustName").val()),cCustIdCard:$.trim($("#transfercCustIdCard").val()),cAddressStr:$.trim($("#transfercAddressStr").val())};easyDialog.close();var B={};B.prodPwd="";B.accessNumber="";B.authFlag="1";authFlag="";B.idCardNumber=z.cCustIdCard;B.partyName=z.cCustName;B.identityName=$("#div_tra_identidiesTypeCd option:selected").text();B.addressStr=z.cAddressStr;$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",B,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(C){if(C.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}if(C.data=="false\r\n"){$.alert("提示","抱歉，您输入的密码有误，请重新输入。");return}o(C)},always:function(){$.unecOverlay()}})}).ketchup({bindElement:"ransferAddcustsussbtn"})};var n=function(z){if(z.data=="false\r\n"){$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");return}var A=$("#custTransferList");A.html(z.data).show();$(".userclose").off("click").on("click",function(B){authFlag="";$(".usersearchtranscon").hide()});$(".usersearchtranscon").show();d()};var m=function(z){v={custId:$(z).find("td:eq(3)").text(),partyName:$(z).find("td:eq(0)").text(),idCardNumber:$(z).attr("idCardNumber"),identityName:$(z).attr("identityName"),areaName:$(z).attr("areaName")};if($("#TransferNum").val().length<14){easyDialog.open({container:"Transferauth"});$("#transAuthClose").off("click").on("click",function(A){easyDialog.close();
authFlag="";$("#transAuthPassword").val("")})}else{i(z)}};var i=function(z){var A=v;A.prodPwd=$.trim($("#transAuthPassword").val());A.authFlag=authFlag;$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",A,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(B){if(B.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}custInfo=A;o(B)},always:function(){$.unecOverlay()}})};var o=function(z){if(authFlag=="0"){easyDialog.close()}if($.ketchup){$.ketchup.hideAllErrorContainer($("#custCreateForm"))}var A=$("#custTransferInfo");A.html(z.data).show();$("#custTransferList").hide();$(".usersearchtranscon").hide();if($("#litransCustId").attr("transCustId")==""){$("#TransferNum").val("");v.custId=-1;b=$.trim($("#transfercCustName").val())}else{b=$("#litransCustId").attr("transcustname")}q();$("#accountDiv").show()};var l=function(z){easyDialog.open({container:"transfer_cust_add"});a($("#div_tra_partyTypeCd").children(":first-child"));$("#usercreateclose").off("click").on("click",function(A){easyDialog.close();$("#transfercCustName").val("");$("#transfercCustIdCard").val("");authFlag="";if($.ketchup){$.ketchup.hideAllErrorContainer($("#ransferCustCreateForm"))}});g()};var t=function(){var z=v;z.authFlag="1";$.callServiceAsHtml(contextPath+"/order/prodModify/transCustAuth",z,{before:function(){$.ecOverlay("<strong>正在查询中,请稍等...</strong>")},done:function(A){if(A.code!=0){$.alert("提示","客户鉴权失败,稍后重试");return}o(A)},always:function(){$.unecOverlay()}})};var q=function(){if($("#litransCustId").attr("transCustId")==""){k()}else{var B={custId:$("#litransCustId").attr("transCustId")};var z=order.prodModify.returnAccount(B);if(z.code==0){var A=z.data;if(A.resultCode==0){if(A.accountInfos&&A.accountInfos.length>0){$.each(A.accountInfos,function(C,E){var D=false;$.each($("#acctSelect option"),function(F,G){if($(G).val()==E.acctId){D=true;return false}});if(!D){$("<option>").text(E.owner+" : "+E.name).attr("value",E.acctId).attr("acctcd",E.accountNumber).appendTo($("#acctSelect"))}$("#acctSelect").find("option[value="+E.acctId+"]").attr("selected","selected")});$("#defineNewAcct").hide()}else{k()}}else{$.alert("提示","客户的帐户定位失败，请联系管理员，若要办理新装业务请稍后再试或者新建帐户。错误细节："+A.resultMsg)}}else{$.alert("提示",z.data)}}};var k=function(){var z=false;if($("#acctSelect option").size()>0){$.each($("#acctSelect option"),function(A,B){if($(B).val()==-1){z=true;return false}});if(!z){order.main.createAcct()}else{$("#acctSelect").find("option[value=-1]").attr("selected","selected");$("#defineNewAcct").show()}}else{order.main.createAcct()}};var y=function(z){var A=z;A.custName=OrderInfo.cust.custName;A.custId=OrderInfo.cust.custId;A.accessNumber=order.prodModify.choosedProdInfo.accNbr;$.callServiceAsHtml(contextPath+"/order/prodModify/custTransfer",A,{done:function(B){$("#order_fill_content").html(B.data).show();$(".h2_title").append(order.prodModify.choosedProdInfo.productName+"-"+order.prodModify.choosedProdInfo.accNbr);$("#fillLastStep").click(function(){order.prodModify.cancel()});h();s()}})};var h=function(){var z={attrSpecCode:"PTY-0004"};$.callServiceAsJson(contextPath+"/staffMgr/getCTGMainData",z,{done:function(B){if(B.code==0){var D=B.data;if(D!=undefined&&D.length>0){for(var C=0;C<D.length;C++){var A=D[C];$("#p_cust_tra_identityCd").append("<option value='"+A.attrValueCode+"' >"+A.attrValueName+"</option>")}}}else{if(B.code==-2){$.alertM(B.data);return}else{$.alert("提示","调用主数据接口失败！");return}}}})};var u=function(F){var E={partyTypeCd:F};var A=contextPath+"/cust/queryCertType";var z=$.callServiceAsJson(A,E,{});if(z.code==-2){$.alertM(z.data)}if(z.code==1002){$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");return}if(z.code==0){var D=z.data;if(D!=undefined&&D.length>0){for(var B=0;B<D.length;B++){var C=D[B];$("#div_tra_identidiesTypeCd").append("<option value='"+C.certTypeCd+"' >"+C.name+"</option>")}}}};return{showCustTransfer:w,custTransfer:y,showCustCreate:l,custTransfer_Submit:x,jumpAuth:t,partyTypeCdChoose:a,identidiesTypeCdChoose:c,showCustTransferReturn:p,showCustAuth:m}})();CommonUtils.regNamespace("prod","uim");prod.uim=(function(){var b=function(j){var q=OrderInfo.getAccessNumber(j);var h="-1";if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){if(q==""){$.alert("提示","校验UIM卡前请先选号!");return false}}if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22||OrderInfo.actionFlag==6){h=order.prodModify.choosedProdInfo.prodOfferInstId}var p=$.trim($("#uim_txt_"+j).val());if(p==undefined||p==""){$.alert("提示","UIM卡不能为空!");return false}var l={instCode:p,phoneNum:q};var m=OrderInfo.getProdSpecId(j);var k=function(t){var u={prodSpecId:t};var s=contextPath+"/mktRes/uim/getMktResCd";$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");var r=$.callServiceAsJson(s,u);$.unecOverlay();if(r.code=="0"){return r.data}else{return""}};if(CONST.getAppDesc()==0){var o=k(m);if(c(o)){l.mktResCd=o}else{$.alert("提示","查询卡类型失败！");return}}var i=query.prod.checkUim(l);if(i==undefined||i.baseInfo==undefined){return false}var n=i.baseInfo.qty;if(n==undefined||n==null){n=1}var g={couponUsageTypeCd:"3",inOutTypeId:"1",inOutReasonId:0,saleId:1,couponId:i.baseInfo.mktResId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:n,storeId:i.baseInfo.mktResStoreId,storeName:"1",agentId:1,apCharge:0,couponInstanceNumber:i.baseInfo.mktResInstCode,terminalCode:i.baseInfo.mktResInstCode,ruleId:"",partyId:OrderInfo.cust.custId,prodId:j,offerId:h,state:"ADD",relaSeq:""};$("#uim_check_btn_"+j).attr("disabled",true);$("#uim_check_btn_"+j).removeClass("purchase").addClass("disablepurchase");$("#uim_release_btn_"+j).attr("disabled",false);$("#uim_release_btn_"+j).removeClass("disablepurchase").addClass("purchase");$("#uim_txt_"+j).attr("disabled",true);OrderInfo.clearProdUim(j);OrderInfo.boProd2Tds.push(g)};var f=function(k){var j=$.trim($("#uim_txt_"+k).val());if(j==undefined||j==""){$.alert("提示","UIM卡不能为空!");return false}var g=OrderInfo.getAccessNumber(k);var h={oldInstCode:j,phoneNum:g};var i=query.prod.releaseUim(h);if(i==undefined){return false}$("#uim_check_btn_"+k).attr("disabled",false);$("#uim_check_btn_"+k).removeClass("disablepurchase").addClass("purchase");$("#uim_release_btn_"+k).attr("disabled",true);$("#uim_release_btn_"+k).removeClass("purchase").addClass("disablepurchase");$("#uim_txt_"+k).attr("disabled",false);OrderInfo.clearProdUim(k)};var a=function(g,i,h){var j={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:h.couponId,couponinfoStatusCd:"A",chargeItemCd:CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD,couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:h.couponInsNumber,terminalCode:h.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:i,offerId:g,state:"DEL",relaSeq:"",id:0,isOld:"T"};OrderInfo.boProd2OldTds.push(j)};var d=function(){OrderInfo.boProd2OldTds=[];var h=true;if(OrderInfo.actionFlag==3||OrderInfo.actionFlag==22){var g=order.prodModify.choosedProdInfo;var i=query.prod.getTerminalInfo(g);if(i==undefined){return false}a(g.prodOfferInstId,g.prodInstId,i);if(i.is4GCard=="Y"){g.prodClass=CONST.PROD_CLASS.FOUR}else{g.prodClass=CONST.PROD_CLASS.THREE}}else{var g={};$.each(OrderInfo.offer.offerMemberInfos,function(){if(this.objType==CONST.OBJ_TYPE.PROD){g.prodInstId=this.objInstId;g.accNbr=this.accessNumber;var k=query.prod.getTerminalInfo(g);if(k==undefined){h=false;return false}a(this.offerId,this.objInstId,k);if(k.is4GCard=="Y"){this.prodClass=CONST.PROD_CLASS.FOUR}else{this.prodClass=CONST.PROD_CLASS.THREE}var j=order.prodModify.choosedProdInfo;if(j!=undefined&&j.prodInstId==this.objInstId){j.prodClass=this.prodClass}}})}return h};var c=function(g){if(g!=undefined&&g!=""){return true}else{return false}};return{checkUim:b,releaseUim:f,setProdUim:d}})();CommonUtils.regNamespace("query","prod");query.prod=(function(){var i=function(m){g(m);var l=contextPath+"/prod/prodSpecParamQuery";$.ecOverlay("<strong>正在查询产品规格属性中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,m);$.unecOverlay();if(k.code==0){if(k.data){return k.data
}}else{if(k.code==-2){$.alertM(k.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var j=function(m){g(m);var l=contextPath+"/prod/prodInstParamQuery";$.ecOverlay("<strong>正在查询产品实例属性中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,m);$.unecOverlay();if(k.code==0){if(k.data){return k.data}}else{if(k.code==-2){$.alertM(k.data);return}else{$.alert("提示","产品规格属性失败,稍后重试");return}}};var a=function(k){var m={prodId:k.prodInstId,areaId:OrderInfo.getProdAreaId(k.prodInstId),acctNbr:k.accNbr};$.ecOverlay("<strong>正在查询产品下终端实例数据中,请稍后....</strong>");var l=$.callServiceAsJson(contextPath+"/order/queryTerminalInfo",m,{});$.unecOverlay();if(l.code==0){return l.data}else{if(l.code==-2){$.alertM(l.data)}else{$.alert("提示","接口未返回产品原UIM卡数据！")}}};var b=function(n,m){var l=contextPath+"/order/account";if(typeof(m)=="function"){$.callServiceAsJsonGet(l,n,{before:function(){$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>")},done:function(o){$.unecOverlay();if(o.code==0){m(o.data)}else{if(o.code==-2){$.alertM(o.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}})}else{$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>");var k=$.callServiceAsJsonGet(l,n);$.unecOverlay();if(k.code==0){if(k.data){return k.data.offerSpec}}else{if(k.code==-2){$.alertM(k.data)}else{$.alert("提示","查询账户信息失败,稍后重试")}}}};var d=function(m){var l=contextPath+"/mktRes/terminal/checkTerminal";$.ecOverlay("<strong>终端校验中,请稍后....</strong>");var k=$.callServiceAsJson(l,m);$.unecOverlay();if(k.code==-2){$.alertM(k.data)}else{if(k.data&&k.data.code==0){return k.data}else{if(k.data.code==1){$.alert("提示",k.data.message)}else{$.alert("提示","<br/>校验失败，请稍后重试！")}}}};var f=function(n){var l=contextPath+"/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");var k=$.callServiceAsJson(l,n);$.unecOverlay();if(k.code==0){$.alert("提示","UIM卡校验成功!");return k.data}else{if(typeof k==undefined){$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常")}else{if(k.code==-2){$.alertM(k.data)}else{var m="";if(k.data!=undefined&&k.data.msg!=undefined){m=k.data.msg}else{m="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡校验失败，可能原因:"+m)}}}};var h=function(n){var l=contextPath+"/mktRes/uim/checkUim";$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>");var k=$.callServiceAsJson(l,n);$.unecOverlay();if(k.code==0){$.alert("提示","UIM卡释放成功!");return k.data}else{if(typeof k==undefined){$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常")}else{if(k.code==-2){$.alertM(k.data)}else{var m="";if(k.data!=undefined&&k.data.msg!=undefined){m=k.data.msg}else{m="卡号["+cardNo+"]预占失败"}$.alert("提示","UIM卡释放失败，可能原因:"+m)}}}};var c=function(){var l=order.prodModify.choosedProdInfo;var k=a(l);if(k==undefined){return}var m={couponUsageTypeCd:"3",inOutTypeId:"2",inOutReasonId:0,saleId:1,couponId:k.couponId,couponinfoStatusCd:"A",chargeItemCd:"3000",couponNum:1,storeId:1,storeName:"11",agentId:1,apCharge:0,couponInstanceNumber:k.couponInsNumber,ruleId:"",partyId:OrderInfo.cust.custId,prodId:l.prodInstId,offerId:l.prodOfferInstId,state:"DEL",relaSeq:"",id:0,isOld:"T"};return m};var g=function(k){k.staffId=OrderInfo.staff.staffId;k.channelId=OrderInfo.staff.channelId;k.partyId=OrderInfo.cust.custId;k.areaId=OrderInfo.getProdAreaId(k.prodId);k.distributorId=OrderInfo.staff.distributorId;if(OrderInfo.order.soNbr!=undefined&&OrderInfo.order.soNbr!=""){k.soNbr=OrderInfo.order.soNbr}};return{checkUim:f,releaseUim:h,getTerminalInfo:a,prodSpecParamQuery:i,prodInstParamQuery:j,getOldUim:c,queryAcct:b,checkTerminal:d}})();CommonUtils.regNamespace("rule","rule");rule.rule=(function(){var checkFlag=false;var checkObj={};var _callBackStr="";var _callBackParam={};var _init=function(){$("#ruleBody").html("");$("#ruleclose").click(function(){_closeRuleDiv()});$("#credit").click(function(){_credit()});$("#closedialog").click(function(){_cancel()})};var _prepare=function(param,callBackStr,callBackParam){_init();_callBackStr=callBackStr;_callBackParam=callBackParam;if(!query.offer.loadInst()){return}var inParam={prodInfo:order.prodModify.choosedProdInfo,areaId:param.areaId,staffId:param.staffId,channelId:param.channelId,custId:param.custId,boInfos:param.boInfos,soNbr:OrderInfo.order.soNbr};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var response=$.callServiceAsJson(contextPath+"/rule/prepare",inParam);$.unecOverlay();var checkData=response.data;if(response.code==0){if(checkData==null){$.alert("提示","规则校验异常，请联系管理人员！");return}}else{$.alertM(response.data);return}if(checkData.ruleType=="portal"){if(checkData.resultCode=="0"){$.alert("提示",checkData.resultMsg);return true}}if(checkData.result&&checkData.result.resultInfo){var checkRuleInfo=checkData.result.resultInfo;if(checkRuleInfo!=null&&checkRuleInfo.length>0){$.each(checkRuleInfo,function(i,ruleInfo){$("<tr><td>"+ruleInfo.resultCode+"</td><td>"+ruleInfo.ruleDesc+"</td><td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});easyDialog.open({container:"ruleDiv"})}else{_credit();SoOrder.initFillPage()}}else{_credit();SoOrder.initFillPage()}if(checkData.resultCode!=0){$("#ruleSubmit").hide()}else{checkObj=param;checkFlag=true}};var _getRuleImgClass=function(ruleLevel){if(ruleLevel<4){return"correct"}else{return"error"}};var _getRuleLevelName=function(ruleLevel){if(ruleLevel==0){return"提示级"}else{if(ruleLevel==1){return"中级"}else{if(ruleLevel==2){return"高级"}else{if(ruleLevel==3){return"特技"}else{if(ruleLevel==4){return"限制级"}}}}}};var _prepareCallBack=function(response){var content$=$("#ruleDiv");content$.html(response.data).show()};var _submit=function(){if(!checkFlag){return}$.callServiceAsHtml(contextPath+checkObj.uri,checkObj.param,checkObj.callObj);easyDialog.close()};var _closeRuleDiv=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _cancel=function(){if(!$("#ruleDiv").is(":hidden")){easyDialog.close()}};var _showRuleDiv=function(ruleInfo){};var _credit=function(){eval(_callBackStr+"("+JSON.stringify(_callBackParam)+")");_closeRuleDiv()};var _ruleCheck=function(boInfos){_init();if(!query.offer.loadInst()){return false}if(boInfos==undefined){return true}OrderInfo.order.step=1;var inParam={areaId:OrderInfo.staff.areaId,staffId:OrderInfo.staff.staffId,channelId:OrderInfo.staff.channelId,custId:OrderInfo.cust.custId,soNbr:OrderInfo.order.soNbr,boInfos:boInfos,prodInfo:order.prodModify.choosedProdInfo};$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");var response=$.callServiceAsJson(contextPath+"/rule/prepare",inParam);$.unecOverlay();if(response!=undefined&&response.code==0){var checkData=response.data;if(checkData==null){$.alert("提示","规则校验异常，请联系管理人员！");return false}if(checkData.ruleType=="portal"){if(checkData.resultCode=="0"){$.alert("提示",checkData.resultMsg);return false}}var checkRuleInfo=checkData.result.resultInfo;if(checkRuleInfo!=undefined&&checkRuleInfo.length>0){$.each(checkRuleInfo,function(i,ruleInfo){$("<tr><td>"+ruleInfo.resultCode+"</td><td>"+ruleInfo.ruleDesc+"</td><td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td><td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td></tr>").appendTo($("#ruleBody"))});easyDialog.open({container:"ruleDiv"});return false}else{return true}}else{$.alertM(response.data);return}};return{submit:_submit,prepare:_prepare,showRuleDiv:_showRuleDiv,ruleCheck:_ruleCheck}})();$(function(){});