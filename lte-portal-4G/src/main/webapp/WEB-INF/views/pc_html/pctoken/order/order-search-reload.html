<@override name="title">中国电信4G营业受理</@override> 
<@override name="header">
<#include "/pcpublic/busi-js-tpl.html"/>
<#include "/pcpublic/common-js-tpl.html"/>
</@override>
<@override name="content">
<h2 class="h2_title" style="display: none" >
	<span>办套餐</span>

</h2>
<div class="order"  style="display: none" >
	<div class="order_content" style="border: none; padding: 10px">
		<!--选套餐-->
		<div class="order_tab_panel" style="display: block">
			<div class="selectList">
				<dl>
					<dt>
						选择套餐：
					</dt>
					<dd>
						<input type="text" id="searchtext" class="numberTextBox width330" maxlength="11" value="请输入您要搜索的套餐名称或首字母简拼"
							onblur="javascript:if($(this).val()==''){$(this).val('请输入您要搜索的套餐名称或首字母简拼');}" 
							onfocus="javascript:if($(this).val()=='请输入您要搜索的套餐名称或首字母简拼'){$(this).val('')}"/>
						<input type="hidden" id="subpageFlag" value="${subPage}"/>
						<input type="hidden" id="numsubflag" value="${numsubflag}"/>
						<input type="button" id="search" value="搜&nbsp;索" class="numberSearch" />
					</dd>
				</dl>
                <dl>
                     <dt>价格范围：</dt>
                     <dd id="price_basic" style="width: 700px;">
					 </dd>
					 <dd id="price_all" style="display: none;width: 700px;" >
				     </dd>
				     <span id="price_more" style="display: none;">
				     <a href="javascript:void(0);" val="更多" class="btn_price_more" style="display: none;">展开</a>
				     </span>
				     <div class="clear"></div>
                 </dl>
                 <dl>
                     <dt>流量范围：</dt>
                     <dd id="influx_basic" style="width: 700px;">
					 </dd>
					 <dd id="influx_all" style="display: none;width: 700px;" >
				     </dd>
				     <span id="influx_more" style="display: none;">
				     <a href="javascript:void(0);" val="更多" class="btn_influx_more" style="display: none;">展开</a>
				     </span>
				     <div class="clear"></div>
                 </dl>
				 <dl class="noBorder">
                     <dt>语音分钟数：</dt>
                     <dd id="invoice_basic" style="width: 700px;">
					 </dd>
					 <dd id="invoice_all" style="display: none;width: 700px;" >
				     </dd>
				     <span id="invoice_more" style="display: none;">
				     <a href="javascript:void(0);" val="更多" class="btn_invoice_more" style="display: none;">展开</a>
				     </span>
				     <div class="clear"></div>
                 </dl>
				
				
			</div>
			<!-- 主套餐内容 -->
			<div class="contract_tab_panel" style="display: block;" id="service_detial">
			</div>
			<!--上下步按钮-->
			<div align="right" style="margin: 20px auto;">
			</div>
			<!--上下步按钮 end-->
		</div>
		<!--选套餐 end-->
	</div>
</div>
<!-- 销售品构成-->  
<div id="div_member_dialog" class="easyDialogdiv" style="width:650px;height:420px;z-index: 1" id="yilai_dialog" >
	<div class="easyDialogclose" onclick="easyDialog.close()"></div>
  	<table class="contract_list rule">
    	<thead>
       		<tr>
                <td colspan="2" id="memberName"></td>
            </tr>                                                    
         </thead>
  	</table>	          	
  	<br/>
  	<div id="main_member_div" class="fs_choosed">
		
	</div>
  	
  	<div align="center" style="margin: 20px auto;">
		<a class="btna_o" href="javascript:void(0)"><span id="memberSpan">确认</span></a>
		<a class="btna_o" href="javascript:void(0)" style=" margin-left:20px;" onclick="easyDialog.close()"><span>取消</span></a>
	</div>
</div>
<!--弹出框的内容-->
<div class="easyDialogdiv" style="width:700px;height:450px;" id="member_dialog">
	
  	<table class="contract_list rule">
        <thead>
            <tr>
                <td colspan="2" id="main_title"></td>
            </tr>                                                    
        </thead>
  	</table>
  	<br/>
  	<div class="form-content">
	    <div class="phone_warp" style="margin:0px 10px;">
	    	<table class="numberList">
	        	<tbody id="member_tbody">	
	        	</tbody>
	      	</table>
	      	<div align="center" style="margin: 20px auto;">
	      		<a href="javascript:void(0)" id="member_btn" class="btna_o"><span>确认</span></a>
	      	</div>
	    </div>
  	</div>
</div>


<!--弹出款-客户定位，选择使用人-->
<div id="choose_user_dialog" class="easyDialogdiv" style="width:700px;height:250px;">
<div class="easyDialogclose" id="chooseUserClose" onclick="easyDialog.close()"></div>
    	<table class="contract_list">
            <thead>
                <tr>
                    <td>选择使用人</td>
                </tr>                                                    
            </thead>
        </table>
        <div id="chooseUserDiv" class="main_div location main_warp">
		<form id="custQueryForChooseForm">
	    <ul class="usercon">
	    <li class="ulocation" >
		<h2 style="margin: 4px 8px 0 5px;">受理地区</h2>
		</li>
		<li class="usersearch">
		   <input id="diffPlaceFlag_choose" type="hidden" value="${DiffPlaceFlag}"> 
			<#if Session["_ecs_login_session_key"].currentChannelId ?? && (Session["_ecs_login_session_key"].currentChannelId!="") >
			  <input type="text" class="numberTextBox" style="margin-left:5px; width:100px" readonly="readonly" id="p_cust_areaId_val_choose"  <#if DiffPlaceFlag=="local">onclick="order.cust.chooseAreaForChooseUser();"</#if> value="${Session["_ecs_login_session_key"].currentAreaAllName}" placeholder="请选择地区" />
	          <input type="hidden" id="p_cust_areaId_choose" value="${Session["_ecs_login_session_key"].currentAreaId}" />
	          <input type="hidden" DiffPlaceFlag="${DiffPlaceFlag}" />
	         </#if>
        </li>
		<li class="ulocation">
			<h2 style="margin: 4px 8px 0 5px;">客户定位</h2>
		</li>
		<li class="usersearch">
		<select onchange="order.cust.custidentidiesTypeCdChoose(this,'p_cust_identityNum_choose')" id="p_cust_identityCd_choose" class="selectNumbertype" style="width:118px;">
                                  	  	<option value="-1" >接入号码</option>
                                  	  	<option value="acctCd" >合同号</option>
                                  	  	<option value="custNumber" >客户编码</option>
        </select>
        <div id="custList" class="usersearchcon" ></div>
        </li>
		<li class="usersearch">
			<input name="" type="text" class="numberTextBox" id="p_cust_identityNum_choose" onkeyup="value=value.replace(/[^\w]|_/ig,'')" 
				placeHolder="请输入接入号码" data-validate="validate(isTelecomOridCardCheck:请输入合法接入号码) on(blur)" style="width:158px;"/>
		</li>
		<!-- 
        <li>
        <input id="isAppointNum" type="checkbox" checked="true" style="margin: 15px 5px 0px 5px;float:left" onclick="order.cust.isAppointNum('p_cust_identityCd_choose')">
        <label style="float:left; margin:10px 5px 0px 0px">指定号码</label>
        </li>
		 -->
        <li class="ubtn">
		    <a id="userSearchForChooseBtn" href="javascript:void(0)"  class="btn_h30 btn" style="margin-left:30px;" onclick=""><span>查 询</span></a>
		</li>
		
		</ul>
		</form>
		
		<table class="contract_list" id="chooseUserList" style="display: none;">
		<thead>
			<tr>
				<td width="100">姓名</td>
				<td width="350">证件号码</td>
				<td width="100">地区</td>
			</tr>
		</thead>
		<tbody>
			<tr id="chooseUserInfo">
				<td id="chooseUserInfoName"></td>
				<td id="chooseUserInfoNum"></td>
				<td id="chooseUserInfoAreaName"></td>
			</tr>
		</tbody>
	</table>
	
	
	</div>
  	<div align="center" style="margin: 20px auto;">
        <a id="chooseUserBtn" class="btna_o" href="javascript:void(0)"><span >确认</span></a>
        <a id="cancelChooseUserBtn" class="btna_o" href="javascript:void(0)" style=" margin-left:20px;" onclick="easyDialog.close()"><span>取消</span></a>
    </div>
</div>

<!--用户鉴权弹窗-->
	<div class="easyDialogdiv" style="height:300px;display:none" id="auth">
	<div class="easyDialogclose" id="authClose"></div>
	<form id="custAuthForm">
	<h1 class="easyDialogTitle">客户身份鉴权</h1>
	<div class="infoBox">
		<table class="network">
                          <tbody>
                          <tr>
                                <td width="100"><label class="f_red">*</label><label id="custAuthTypeName">产品密码：</label></td>
                                <td width="300"><input id="authPassword" type="password" placeHolder="请输入密码" data-validate="validate(required:密码不能为空, maxlength:密码长度最多为{arg1}(12)) on(blur)" class="inputWidth150px"><a  class="purchase" id="custAuthbtn" href="javascript:void(0)">校验</a><a class="purchase" id="jumpAuth" style="display:none" onclick="order.cust.jumpAuth()">跳过校验</a>
                                </td>
                          </tr>   

                        </tbody>
         </table>
    </div>
    </form>
	</div>
<!--用户鉴权弹窗 end-->

<!--订单准备 end-->
<script type="text/javascript">
	var nextFlag = false;
	var mergeFlag = "${mergeFlag}";
	if(mergeFlag=="0"){
		var custInfos = ${custInfo};
	 	var addressStr="";
		var areaId="";
		var areaName="";
		var authFlag="1";
		var custFlag="";
		var custId="";
		var idCardNumber="";
		var identityCd="";
		var identityName="";
		var norTaxPayer="";
		var partyName="";
		var segmentId="";
		var segmentName="";
		var vipLevel="";
		var vipLevelName="";
		$.each(custInfos.custInfos,function(index,custInfo){
			 addressStr=custInfo.addressStr;
			 areaId=custInfo.areaId;
			 areaName=custInfo.areaName;
			 authFlag="1";
			 custFlag=custInfo.custFlag;
			 custId=custInfo.custId;
			 idCardNumber=custInfo.idCardNumber;
			 identityCd=custInfo.identityCd;
			 identityName=custInfo.identityName;
			 norTaxPayer="";
			 partyName=custInfo.partyName;
			 segmentId=custInfo.segmentId;
			 segmentName=custInfo.segmentName;
			 vipLevel=custInfo.vipLevel;
			 vipLevelName=custInfo.vipLevelName;
			OrderInfo.cust={addressStr: addressStr,areaId: areaId,areaName: areaName,authFlag: "1",custFlag: custFlag,custId: custId,idCardNumber: idCardNumber,identityCd: identityCd,identityName: identityName,norTaxPayer: "",partyName: partyName,segmentId: segmentId,segmentName: segmentName,vipLevel: vipLevel,vipLevelName: vipLevelName};
			nextFlag = true;
		});
	}else{
		var custNumber = "${custNumber}";
		var provCustAreaId = "${provCustAreaId}";
		nextFlag = order.cust.queryCustCompreInfo(custNumber,provCustAreaId,1,'');
	}
	if(nextFlag){
		OrderInfo.staff={
				staffId : '${staffId}',
				channelId : '${channelId}',
				channelName : '${channelName}',
				areaId : areaId,
				areaCode : "",
				areaName : areaName,
				areaAllName : "",
				operatorsId:"",
				operatorsName:"",
				operatorsNbr:"",
				soAreaId : areaId,
				soAreaCode : "",
				channelType:""
		};
		OrderInfo.provinceInfo.provIsale = '${provIsale}';
		OrderInfo.provinceInfo.redirectUri = '${redirectUri}';
		OrderInfo.provinceInfo.isFee = '${isFee}';
		OrderInfo.provinceInfo.mergeFlag = "${mergeFlag}";
		OrderInfo.actionFlag=1;
		OrderInfo.newOrderInfo.isReloadFlag="N";
		order.prepare.createorderlonger();
		OrderInfo.busitypeflag=1;
		order.service.initSpec();
		order.prodOffer.init();
		order.service.searchPack();
		order.phoneNumber.resetBoProdAn();
	}
</script>
	<!-- 选号界面需要获取的 areaId -->
	<input type="hidden" id="p_cust_areaId" value="">
	<input type="hidden" id="old_offerSpecId" value="${prodOfferId}"/>
	
  	<div class="main_warp" id="order_tab_panel_content" style="display:none">
        
    </div>
    <!-- 填单页面用 -->
    <div class="main_warp" id="order_fill_content" style="display:none">
    
    </div>
    <!-- 订单确认页面-->
    <div class="main_warp" id="order_confirm" style="display:none"></div>
    
    <!-- 订单确认页面（分段受理专用）-->
    <div class="main_warp" id="step_order_confirm" style="display:none"></div>
    
    <!--弹出款-选择号码的内容-->
	<div style="display:none" id="ec-dialog-form-container-phonenumber" class="ec-dialog-form-container">
	  <div class="ec-dialog-form-top">
	    <h1 class="ec-dialog-form-title">选择号码</h1>
	  </div>
	  <div class="ec-dialog-form-content">
	    <div class="ec-dialog-form-loading" style="display:none"></div>
	    <div class="ec-dialog-form-message" style="display:none"></div>
	    <div class="ec-dialog-form-form" >
	      <form action="#" style="" id="dialogForm">
	        <div class="form-content" id="phonenumberContent" style="min-height:200px">      
	        </div>
	      </form>
	    </div>
	  </div>
	  <div class="ec-dialog-form-bottom"></div>
	</div>
	<!-- 选择号码弹出框结束 -->
	<!--帐户选择弹窗-->
	<div class="easyDialogdiv" style="width:1080px;height:460px;" id="div_staff_dialog">
	
	</div>
	<!-- 发展人管理弹窗 -->  
	<div id="div_attach_dialog" class="easyDialogdiv" style="width:980px;height:460px;">
		<div class="easyDialogclose" id="staff_dialog_close" onclick="easyDialog.close()"></div>
		<table class="contract_list">
			<thead>
				<tr><td>操作</td><td>号码</td><td>发展业务</td></tr>
			</thead>
			<tbody id="attach_tbody">
			</tbody>
		</table>
		<div align="center" style="margin: 20px auto;">
			<a class="btna_o" href="javascript:void(0)" onclick="order.dealer.addAttachDealer()"><span>确认</span></a>
			<a class="btna_o" href="javascript:void(0)" onclick="easyDialog.close()" style=" margin-left:20px;"><span>取消</span></a>
		</div>
	</div>
	
	<!-- 功能产品销售品详情弹窗 -->
	<div id="div_detail_dialog" class="easyDialogdiv" style="width:980px;height:460px;">
		<div class="easyDialogclose" id="staff_dialog_close" onclick="easyDialog.close()"></div>
		<table class="contract_list">
			<thead>
				<tr><td>产品名称</td><td>描述</td></tr>
			</thead>
			<tbody id="detail_tbody">
			</tbody>
		</table>
		<div align="center" style="margin: 20px auto;">
			<a class="btna_o" href="javascript:void(0)" onclick="easyDialog.close()" style=" margin-left:20px;"><span>返回</span></a>
		</div>
	</div> 
	
	<!--弹出框的内容-->
<div class="easyDialogdiv" style="width:500px;height:400px;" id="moneyAdd">
   	<div class="easyDialogclose" id="moneyclose"></div>
   	<div id="addContent"></div>
</div>
<div class="easyDialogdiv" style="width:400px;height:200px;vertical-align: middle;" id="packageTip_dialog" >
  <div id="infoTipContent" style="height: 200px;"></div>
</div>
</@override>
<@extends name="/pcpublic/main-template.html"/>
<script type="text/javascript">
var _showPackageDialog=function(msg){
	var html="<table class=\"contract_list rule\">";
	html+='<thead><tr> <td colspan="2">提示</td></tr></thead></table>';
	html+="<div id=\"rules_div\" height=\"height:140px;\">";
	html+='<table width="100%" height="120px;" border="0" cellspacing="0" cellpadding="0">';
	html+='<tr>';
	html+='<td align="right"></td>';
	html+="<td><div class=\"rule_font\" style=\"width:100%;font-size:15px; text-align:center;\">"+msg+"</div></td>";
	html+='</tr>';
	html+='</table>';
	html+='</div>';
	easyDialog.open({
		container : 'packageTip_dialog'
	});
	$("#infoTipContent").html("");
	$("#infoTipContent").html(html);
};

window.onload=function(){
	$("#p_cust_areaId").val(areaId);
	var prodOfferId = '${prodOfferId}';
	var prodOfferName = '${prodOfferName}';
	var result =  ${result};
	OrderInfo.newOrderInfo.result=result;	
	OrderInfo.newOrderInfo.prodOfferName=prodOfferName;
	OrderInfo.newOrderInfo.isReloadFlag="N";
	var busiOrders = result.orderList.custOrderList[0].busiOrder;
	var terminalCode='${terminalCode}'; //终端串码
	//终端串码
	if(terminalCode!=null && terminalCode!="" && terminalCode!="null"){
		OrderInfo.terminalCode=terminalCode;
	}
	//进行数据信息验证，是否是新装数据
	var custOrderAttrs =result.orderList.orderListInfo.custOrderAttrs;
	
	if(custOrderAttrs==null || custOrderAttrs==""){
		_showPackageDialog("二次加载数据不完整，无法操作!")
		return;
	}
	
	var isRight="0";
	
	$.each(custOrderAttrs,function(){
		if(this.itemSpecId=="30010024"){
			if(this.value!="1"){
				isRight="1";
			}
		}
	});
	
	if(isRight=="1"){
		_showPackageDialog("不是新装受理流水号，请重试!");
		return;
	}
	
	//解析数据,订购几张副卡
	var cardNum = 0;
	var prodOfferId = "";
	$.each(busiOrders,function(index,busiOrder){
		if(busiOrder.boActionType.actionClassCd==1300&&busiOrder.boActionType.boActionTypeCd=="1"&&busiOrder.busiObj.instId!="-1"){
			cardNum = cardNum+1;
		}
		//主套餐id
		if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"&&busiOrder.busiObj.instId=="-1"){
			prodOfferId = busiOrder.busiObj.objId;
			OrderInfo.newOrderInfo.prodOfferId=prodOfferId;
		}
	});
	if(prodOfferId!="" && prodOfferId!=null){		
		order.service.buyServiceReload(prodOfferId,'${(price)?default("")}',cardNum);	
	}			
}
</script> 