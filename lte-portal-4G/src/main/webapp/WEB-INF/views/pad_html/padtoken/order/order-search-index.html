<@override name="title">中国电信4G营业受理</@override>
<@override name="header">



<!-- 这块js类似原来的busi-js-tpl.html后期优化20140731 lsd -->

<#if COMPRESS_JS_LEVEL?? && COMPRESS_JS_LEVEL == "BUSI" >
   <script src="${contextPath}/js/pad-js/op-js/order/order.js?${jsversion}" type="text/javascript"></script>
   <script src="${contextPath}/merge/js/busiPAD-1.0.0.min.js" type="text/javascript"></script>
<#else>
<script src="${contextPath}/js/pad-js/op-js/order/memberChange.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/busi-js/common/const.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/busi-js/query/common.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/orderInfo.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/orderProdModify.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/cust/cust.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/cust/custMgr.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/common/areaMgr.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/rule/rule.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/order/cacheData.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/offerQuery.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/calCharge.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/orderMain.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/order/dealer.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/mktRes/terminal.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/mktRes/phoneNumber.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/prod/uim.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/queryProd.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/print/print.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/prepare.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/order/prodOffer.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/attachOffer.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/offerChange.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/soOrder.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/prod/changeUim.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/op-js/order/uiCust2.js?${jsversion}" type="text/javascript"></script>
<script src="${contextPath}/js/pad-js/busi-js/main/main.js?${jsversion}" type="text/javascript"></script>
 <script src="${contextPath}/js/pad-js/op-js/order/order.js?${jsversion}" type="text/javascript"></script>
</#if>
<script src="${contextPath}/js/busi-js/prod/changeUim.js?${jsversion}" type="text/javascript"></script>
-->
</@override>
<@override name="content">
<div data-role="content">
	<input id="p_cust_areaId" type="hidden" value=""/>
	<!-- 省份传入主副卡号码 -->
	<input type="hidden" id="mainPhoneNum" value="${mainPhoneNum}"/>
	<input type="hidden" id="newSubPhoneNum" value="${newSubPhoneNum}"/>
	<input type="hidden" id="oldSubPhoneNum" value="${oldSubPhoneNum}"/>
	<!--  
	<div id="div_notice" class="width100" style="display:none">
		<span class="iconindex icon-news"></span>
		<span id="span_scroll_notice" style="height:40px;overflow:hidden;">
			<span id="span_notice_body">
				<span class="time"></span><a href="#" class="news">[ 暂无公告 ]</a><br>
			</span><br>
			<span id="span_notice_hide"></span>
		</span>
    </div>
    -->
    <div id="div_user_info" class="w100" style="display:none">
	    <div class="wleft">
	    	<span class="iconindex icon-user">&nbsp;</span>
	       <span class="font20">${Session["_ecs_login_session_key"].staffName}</span>
	       <span class="font12">欢迎使用4G营业门户</span>
	       <a id="a_sys_exit" href="#" title="退出" data-role="button" data-icon="out" data-iconpos="notext" data-theme="i">退出</a>
	    </div>
	    <div class="wright">
	    	<span class="iconindex icon-channel">&nbsp;</span>
	        <span class="font16">
	        	<#if Session["_ecs_login_session_key"].currentChannelId ?? && (Session["_ecs_login_session_key"].currentChannelId!="") >
	        	<span id="_session_staff_info" 
					staffId="${Session["_ecs_login_session_key"].staffId}" 
					staffCode="${Session["_ecs_login_session_key"].staffCode}" 
					staffName="${Session["_ecs_login_session_key"].staffName}" 
					channelId='${Session["_ecs_login_session_key"].currentChannelId}' 
					channelName='${Session["_ecs_login_session_key"].currentChannelName}' 
					areaId='${Session["_ecs_login_session_key"].currentAreaId}'
					areaCode='${Session["_ecs_login_session_key"].currentAreaCode}'
					areaName='${Session["_ecs_login_session_key"].currentAreaName}'
					areaAllName='${Session["_ecs_login_session_key"].currentAreaAllName}'
					orgId='${Session["_ecs_login_session_key"].orgId}' 
					operatorsId = '${Session["_ecs_login_session_key"].currentOperatorsId}' 
					operatorsName = '${Session["_ecs_login_session_key"].currentOperatorsName}' 
					operatorsNbr = '${Session["_ecs_login_session_key"].currentOperatorsNbr}' 
					channelType = '${Session["_ecs_login_session_key"].currentChannelType}' 
	               	 >
	               	${Session["_ecs_login_session_key"].currentChannelName}
	            </span>
	        	<#else>
	           	<span id="_session_staff_info" 
					staffId="${Session["_ecs_login_session_key"].staffId}" 
					staffCode="${Session["_ecs_login_session_key"].staffCode}" 
					staffName="${Session["_ecs_login_session_key"].staffName}" 
					channelId='' 
					channelName='' 
					areaId=''
					areaCode=''
					areaName=''
					orgId='${Session["_ecs_login_session_key"].orgId}' 
					operatorsId = '' 
					operatorsName = '' 
					operatorsNbr = ''  >
	               	无受理渠道</span>
	            </#if>
	        </span>
	        <a id="a_channel_exchange" href="#" data-role="button" data-icon="choose" data-iconpos="notext" data-theme="i">退出</a>
	    </div>
    </div>
    <ul id="ul_busi_area" class="go" style="display:none">
    	<li id="li_busi_package" for="order_tab_panel_offer" url="${contextPath}/pad/order/prodoffer/prepare.html">
        	<span class="goimg icon-package"><p>Package</p></span>
           	<a>办套餐</a>
       </li>
       <li id="li_busi_phone" for="order_tab_panel_terminal" url="${contextPath}/pad/mktRes/terminal/prepare.html">
       		<span class="goimg icon-phone"><p>Phone</p></span>
           	<a>购手机</a>
       </li>
       <li id="li_busi_phone" for="order_tab_panel_phonenumber" url="${contextPath}/pad/mktRes/phonenumber/prepare">
	   		<span class="goimg icon-number"><p>Number</p></span>
	       	<a>挑靓号</a>
       </li>
    </ul>
    <div id="div_quick_set" class="width100" style="display:none">
    	<span class="iconindex icon-quick">&nbsp;</span>
       	<span class="font16">常用操作</span>
       	<a href="javascript:;" data-role="button" data-icon="settings" data-iconpos="notext" data-theme="i">设置</a>
    </div>
    <ul id="ul_quick_set" class="quick ul-slide-left" style="display:none">
    	
    </ul>
    <!-- business part begin -->
    <div id="order_prepare"></div>
    <div id="order_fill"></div>
    <div id="order_bill"></div>
    <div id="order_confirm"></div>
    <!-- business part end -->
</div>
<div style="height:300px;display:none;background:#fff; -webkit-border-radius:5px; -moz-border-radius:5px; border-radius:5px;-webkit-box-shadow:0 8px 8px rgba(0,0,0,0.4);-moz-box-shadow:0 8px 8px rgba(0,0,0,0.4);box-shadow:0 8px 8px rgba(0,0,0,0.4); border:5px solid #cbced0;
	
	overflow-y:auto;" id="auth2">
</div>
</@override>
	<!--用户鉴权弹窗-->

<@extends name="/padtoken/main/main-template.html"/>
<script type="text/javascript">

 
    OrderInfo.actionFlag==1;
	var provinceInfo = ${provinceInfo};
	var areaId = "";
	var nextFlag = false;
	var mergeFlag = "${mergeFlag}";
	if(mergeFlag=="0"){
		var custInfo = ${custInfo};
		$.each(custInfo.custInfos,function(index,custInfo){
			var addressStr=custInfo.addressStr;
			areaId=custInfo.areaId;
			var areaName=custInfo.areaName;
			var authFlag="1";
			var custFlag=custInfo.custFlag;
			var custId=custInfo.custId;
			var idCardNumber=custInfo.idCardNumber;
			var identityCd=custInfo.identityCd;
			var identityName=custInfo.identityName;
			var norTaxPayer="";
			var partyName=custInfo.partyName;
			var segmentId=custInfo.segmentId;
			var segmentName=custInfo.segmentName;
			var vipLevel=custInfo.vipLevel;
			var vipLevelName=custInfo.vipLevelName;
			OrderInfo.cust={addressStr: addressStr,areaId: areaId,areaName: areaName,authFlag: "1",custFlag: custFlag,custId: custId,idCardNumber: idCardNumber,identityCd: identityCd,identityName: identityName,norTaxPayer: "",partyName: partyName,segmentId: segmentId,segmentName: segmentName,vipLevel: vipLevel,vipLevelName: vipLevelName};
			return false;
		});
		nextFlag = true;
	}else{
		var custNumber = "${custNumber}";
		var provCustAreaId = "${provCustAreaId}";
		nextFlag = order.cust.mgr.queryCustCompreInfo(custNumber,provCustAreaId,1,'');
	}
	OrderInfo.provinceInfo.provIsale = provinceInfo.provIsale;
	OrderInfo.provinceInfo.redirectUri= provinceInfo.redirectUri;
	OrderInfo.provinceInfo.isFee = provinceInfo.isFee;
	OrderInfo.provinceInfo.reloadFlag = provinceInfo.reloadFlag;
	OrderInfo.provinceInfo.mergeFlag = "${mergeFlag}";
	OrderInfo.actionFlag = provinceInfo.actionFlag;
	OrderInfo.busitypeflag=1;
	OrderInfo.provinceInfo.codeMsg = provinceInfo.codeMsg;
	
	//获取uim卡号
	if(provinceInfo.mktResInstCode&&provinceInfo.mktResInstCode!=""){
		OrderInfo.newOrderNumInfo.mktResInstCode=provinceInfo.mktResInstCode;
	}
	
	//账户合同号
	OrderInfo.acct={acctCd:'${acctCd}'};
	if(provinceInfo.prodOfferId!=undefined&&provinceInfo.prodOfferId!=""){
		OrderInfo.provinceInfo.prodOfferId=provinceInfo.prodOfferId;
	}	
	var result = "";
	if(OrderInfo.provinceInfo.reloadFlag=="N"){
		result = ${result};
		OrderInfo.reloadOrderInfo = result;
	}
	
	window.onload= function(){
		OrderInfo.staff={
				staffId : "${Session['_ecs_login_session_key'].staffId}",
				staffName : "${Session['_ecs_login_session_key'].staffName}",
				channelId : '${Session["_ecs_login_session_key"].currentChannelId}',
				channelName : '${Session["_ecs_login_session_key"].currentChannelName}',
				areaId : '${Session["_ecs_login_session_key"].currentAreaId}',
				areaCode : '${Session["_ecs_login_session_key"].currentAreaCode}',
				areaName : '${Session["_ecs_login_session_key"].currentAreaName}',
				areaAllName : '${Session["_ecs_login_session_key"].currentAreaAllName}',
				operatorsId:'${Session["_ecs_login_session_key"].operatorsId}',
				operatorsName:'${Session["_ecs_login_session_key"].currentOperatorsName}',
				operatorsNbr:'${Session["_ecs_login_session_key"].currentOperatorsNbr}',
				soAreaId : '${Session["_ecs_login_session_key"].currentAreaId}',
				soAreaCode : '${Session["_ecs_login_session_key"].currentAreaCode}',
				channelType:'${Session["_ecs_login_session_key"].currentChannelType}'
			};
		//进行数据信息验证，是否是新装数据
		if(OrderInfo.provinceInfo.reloadFlag=="N"){
			var custOrderAttrs =OrderInfo.reloadOrderInfo.orderList.orderListInfo.custOrderAttrs;
			
			if(custOrderAttrs==null || custOrderAttrs==""){
				$.alert("提示","二次加载数据不完整，无法操作!")
				return false;
			}
			
			var isRight="0";
			
			$.each(custOrderAttrs,function(){
				if(this.itemSpecId=="30010024"){
					if(this.value!="1"){
						isRight="1";
					}
				}
			});
			
			if(isRight=="1"){
				$.alert("提示","不是新装受理流水号，请重试!");
				return false;
			}
		}
		OrderInfo.typeCd="${typeCd}";
		OrderInfo.verifyLevel='${verifyLevel}';
		$("#p_cust_areaId").val(areaId);
		var terminalCode='${terminalCode}'; //终端串码
		var mainPhoneNum='${mainPhoneNum}';
		var newSubPhoneNum='${newSubPhoneNum}';
		var oldSubPhoneNum='${oldSubPhoneNum}';
		//终端串码
		if(terminalCode!=null && terminalCode!="" && terminalCode!="null"){
			OrderInfo.terminalCode=terminalCode;
		}
		var salesCode='${salesCode}'; //终端串码
		//发展人
		if(salesCode!=null && salesCode!="" && salesCode!="null"){
			OrderInfo.salesCode=salesCode;
		}
		if(mainPhoneNum!=null && mainPhoneNum!="" && mainPhoneNum!="null"){
			OrderInfo.newOrderNumInfo.mainPhoneNum = mainPhoneNum;
		}
		if(newSubPhoneNum!=null && newSubPhoneNum!="" && newSubPhoneNum!="null"){
			OrderInfo.newOrderNumInfo.newSubPhoneNum =newSubPhoneNum;
		}
		if(oldSubPhoneNum!=null && oldSubPhoneNum!="" && oldSubPhoneNum!="null"){
			//OrderInfo.newOrderNumInfo.newSubPhoneNum = $("#newSubPhoneNum").val();
			OrderInfo.newOrderNumInfo.oldSubPhoneNum =oldSubPhoneNum; 
		}
		if(nextFlag){
			if(OrderInfo.provinceInfo.prodOfferId!=undefined&&OrderInfo.provinceInfo.prodOfferId!=""&&OrderInfo.provinceInfo.reloadFlag!="N"){
				//order.prepare.commonTab("${contextPath}/pad/order/prodoffer/prepare.html","order_tab_panel_offer");
				//二次鉴权
				order.prodModify.querySecondBusinessAuth();
			}else if(OrderInfo.provinceInfo.reloadFlag=="N"){
				//解析二次加载返回数据
				//解析数据,订购几张副卡
				var busiOrders = result.orderList.custOrderList[0].busiOrder;
				//解析数据,订购几张副卡
				var cardNum = 0;
				$.each(busiOrders,function(index,busiOrder){
					if(busiOrder.boActionType.actionClassCd==1300&&busiOrder.boActionType.boActionTypeCd=="1"&&busiOrder.busiObj.instId!="-1"){
						cardNum = cardNum+1;
					}
					if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"&&busiOrder.busiObj.instId=="-1"){
						prodOfferId = busiOrder.busiObj.objId;
						OrderInfo.reloadProdInfo.prodOfferId=prodOfferId;
					}
				});
				OrderInfo.reloadProdInfo.cardNum = cardNum;
				if(OrderInfo.reloadProdInfo.prodOfferId!=undefined&&OrderInfo.reloadProdInfo.prodOfferId!=""){
					order.prepare.commonTab("${contextPath}/pad/order/prodoffer/prepare.html","order_tab_panel_offer");
					//order.service.buyService("",OrderInfo.reloadProdInfo.prodOfferId,"");
				}
			}else{
				//二次鉴权
				order.prodModify.querySecondBusinessAuth();
				//order.prepare.commonTab("${contextPath}/pad/order/prodoffer/prepare.html","order_tab_panel_offer");
			}
		}
	}	
</script>