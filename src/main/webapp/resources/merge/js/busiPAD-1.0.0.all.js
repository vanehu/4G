CommonUtils.regNamespace("order", "memberChange");
order.memberChange = function(){
	var _offerProd={};
	var _memberAddList=[];
	var _ischooseOffer=false;
	var choosenum = 1;//纳入老用户数量
	var idnum = 1;
	var _reloadFlag = "";
	var _newSubPhoneNum;
	var _oldSubPhoneNum;
	var _mktResInstCode;
	var _newmembers = {};
	var _oldmembers = {
			objInstId:[]
	};
	var _delmembers = {
			accessNumbers:[]
	};
	var _changemembers = {
			accessNumbers:[]
	};
	var _rejson = {};
	var maxNum = 0;
	var _newMemberFlag = false;
	var _oldMemberFlag = false;
	var _changeMemberFlag = false;
	var _viceparams = [];
	var _ooRoless = [];
	
	//点击主副卡成员变更跳出一个div
	var _showOfferCfgDialog=function(){
		if(order.prodModify.choosedProdInfo.prodStateCd==CONST.PROD_STATUS_CD.STOP_PROD){
			$.alert("提示","停机产品不允许受理！");
			return;
		}
		_memberAddList=[];
		choosenum = 1;
		idnum = 1;
		OrderInfo.busitypeflag=3;
		OrderInfo.actionFlag=6;
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldprodAcctInfos = [];
		OrderInfo.oldAddNumList = [];
		OrderInfo.viceOfferSpec=[];
		
		//页面变动
		$("#order_fill_content").empty();
		OrderInfo.order.step=0;//订单初始页面
		order.prepare.hideStep();
		$("#orderedprod").show();
		$("#order_prepare").show();
		$("#order_confirm").hide();
		
		order.prepare.createorderlonger();
		//4G系统判断，如果是3g套餐不能做该业务
		if(CONST.getAppDesc()==0 && order.prodModify.choosedProdInfo.is3G=="Y"){
			$.alert("提示","3G套餐不允许做主副卡成员变更业务！","information");
			return;
		}
		//根据省份来限制纳入老用户入口,开关在portal.properties
		var areaidflag = _areaidJurisdiction();
		//暂存单二次加载	
		if(order.memberChange.reloadFlag=="N"){
			if(!queryReOrder()){
				return;
			}
//			order.memberChange.rejson={};
			var custOrderAttrs = order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;
			var busiTypeFlag = true;
			$.each(custOrderAttrs,function(){
				if(this.itemSpecId=="30010024"){
					if(this.value!="3"){
						busiTypeFlag = false;
						return false;
					}
				}
			});
			if(!busiTypeFlag){
				$.alert("提示","不是主副卡成员变更受理流水号，请重试！");
				return;
			}
			var custOrderList = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
			var splitflag = 1;
			order.memberChange.newSubPhoneNum="";
			order.memberChange.oldSubPhoneNum="";
			$.each(custOrderList,function(){
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="3"){//拆副卡
					order.memberChange.delmembers.flag = true;
					order.memberChange.delmembers.accessNumbers.push({"nbr":this.busiObj.accessNumber});
				}else if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员
					order.memberChange.newmembers.flag = true;
					if(splitflag==1){
						order.memberChange.newSubPhoneNum += this.busiObj.accessNumber;
						splitflag++;
					}else{
						order.memberChange.newSubPhoneNum += ","+this.busiObj.accessNumber;
					}
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S2"){//纳入老成员
					if(this.busiObj.offerTypeCd=="1"){
						order.memberChange.oldmembers.flag = true;
						if(splitflag==1){
							order.memberChange.oldSubPhoneNum += this.busiObj.accessNumber;
							splitflag++;
						}else{
							order.memberChange.oldSubPhoneNum += ","+this.busiObj.accessNumber;
						}
					}
					var objInstId = this.data.ooRoles[0].objInstId;
					var instId = this.busiObj.instId;
					order.memberChange.oldmembers.objInstId.push({"instId":instId,"objInstId":objInstId});
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="1"){//保留选择新套擦
					order.memberChange.changemembers.flag = true;
					order.memberChange.changemembers.accessNumbers.push({"nbr":this.busiObj.accessNumber,"specId":this.busiObj.objId,"name":this.busiObj.objName});
				}
			});
		}
		var newSubPhoneNumsize=[];
		var oldSubPhoneNumsize=[];
		if(order.memberChange.newSubPhoneNum!=""){
			newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
		}
		if(order.memberChange.oldSubPhoneNum!=""){
			oldSubPhoneNumsize = order.memberChange.oldSubPhoneNum.split(",");
		}
		//查询销售品规格并且保存
		var param = {
			offerSpecId : order.prodModify.choosedProdInfo.prodOfferId, 
			offerTypeCd : 1,
			partyId : OrderInfo.cust.custId
		};
		var offerSpec = query.offer.queryMainOfferSpec(param); //查询主销售品构成
		if(!offerSpec){
			return;
		}
		//根据销售品规格验证是否是主副卡套餐
		var flag = true;
		$.each(offerSpec.offerRoles,function(){
			if (this.memberRoleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD) {
				flag = false;
				return false;
			}
		});
		if(flag){
			$.alert("错误","你选择的套餐不是主副卡套餐，不能进行主副卡成员变更");
			return;
		}
		//查询销售品实例并且保存
		if(OrderInfo.provinceInfo.mergeFlag=="0"){
			if(!query.offer.setOffer()){  
				return;
			}
		}
		//改造中...
		var iflag = 0; //判断是否弹出副卡选择框 false为不选择
		var errorflag = true;		
		$("#main_title").text(OrderInfo.offerSpec.offerSpecName);
		SoOrder.initFillPage();
		var data = query.offer.queryMemberHtml(param);//查询主副卡实例页面	
		SoOrder.step(0,data); //订单准备
		$.jqmRefresh($("#order_tab_panel_content"));
		$.each(offerSpec.offerRoles,function(index){
			var offerRole = this;
			if(index == 0){				
				$("#firstHtml").html("<label for=\"money\">"+offerRole.offerRoleName+"：</label>");
			}else if(index ==1){
				$("#secondHtml").html("<label for=\"recommend\">"+offerRole.offerRoleName+"：</label>");				
			}			
			//销售品规格
			//主卡
			if (offerRole.memberRoleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD) {
				$.each(this.roleObjs,function(){
					if(this.objType == CONST.OBJ_TYPE.PROD){
						$("#objHtml").html(this.objName);
					}
				});
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.offerRoleId==offerRole.offerRoleId && this.objType==CONST.OBJ_TYPE.PROD){
						$("#accessNumberHtml").html(this.accessNumber);						
						return;
					}
				});
			}else{
				//副卡添加
				$.each(offerRole.roleObjs,function(){  //遍历副卡角色下的成员
					if(this.objType == CONST.OBJ_TYPE.PROD){
						this.minQty = 0;
						this.dfQty = 0;
						viceMinQty = 0;
						viceMaxQty = this.maxQty;
						numId = offerRole.offerRoleId+"_"+this.objId;//offerRole.memberRoleCd;
					}
				});
				var existViceCardNum = 0;//已有副卡数量
				//副卡个数
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.offerRoleId == offerRole.offerRoleId  && this.objType==CONST.OBJ_TYPE.PROD){
						existViceCardNum++;
					}
				});
				//副卡添加
				$.each(this.roleObjs,function(){
					var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
					if(this.objType == CONST.OBJ_TYPE.PROD){
						_memberAddList.push(objInstId);
						if(offerRole.minQty == 0){ //加装角色
							this.minQty = 0;
							this.dfQty = 0;
						}
						var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量						
						max = max -existViceCardNum;
						maxNum = max;
						if(max>0){						
							if(newSubPhoneNumsize.length==0 && oldSubPhoneNumsize.length==0){						
								$("#pointsHtml").html("<input type=\"range\" id=\""+objInstId+"\" value=\""+newSubPhoneNumsize.length+"\" min=\""+this.minQty+"\" max=\""+max+"\" readonly=\"readonly\">");
							}else if(newSubPhoneNumsize.length>max){
								$.alert("规则限制","newSubPhoneNum的角色成员数量总和不能超过"+max);
								errorflag = false;
								return false;
							}else{
								$("#pointsHtml").html("<input type=\"text\" id=\""+objInstId+"\" value=\""+newSubPhoneNumsize.length+"\" readonly=\"readonly\">");
							}
							$("#limitHtml").html("(仅含本地语音）"+this.minQty+"-"+max+"（张）")
						}
						$.jqmRefresh($("#order_tab_panel_content"));
						iflag++;
					}
				});
				if(areaidflag){
					//添加老用户
					var oldCardHtml = "";
					$.each(this.roleObjs,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD){
							var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量						
							max = max - existViceCardNum;		
							if(max>0){
								var addNumpic = "";
								if(newSubPhoneNumsize.length==0 && oldSubPhoneNumsize.length==0){							
									oldCardHtml += "<div class=\"ui-block-a\">";
									oldCardHtml += "<div class=\"ui-grid-c\">";									
									oldCardHtml += "<div class=\"ui-block-a\">";
									oldCardHtml += "<label for=\"recommend\">已有移动电话：</label>";
									oldCardHtml += "</div>";
									oldCardHtml += "<div class=\"ui-block-b\">";
									oldCardHtml += "<input type=\"text\" id=\"oldphonenum_1\">";
									oldCardHtml += "</div>";
									oldCardHtml += "<div class=\"ui-block-c\">";
									oldCardHtml += "<button data-mini=\"ture\" onclick=\"order.memberChange.addNum('"+max+"','')\">+</button>";
									oldCardHtml += "</div>";
									oldCardHtml += "<div class=\"ui-block-d\">";
									//oldCardHtml += "<button data-mini=\"ture\" onclick=\"order.memberChange.queryofferinfo()\">加装</button>";
									oldCardHtml += "</div>";								
									oldCardHtml += "</div>";
									oldCardHtml += "</div>";					
								}else if(oldSubPhoneNumsize.length>max){
									$.alert("规则限制","oldSubPhoneNum的角色成员数量总和不能超过"+max);
									errorflag = false;
									return false;
								}else{
									for(var k=0;k<oldSubPhoneNumsize.length;k++){
										if(k==0){										
											oldCardHtml += "<div class=\"ui-block-a\">";
											oldCardHtml += "<div class=\"ui-grid-c\">";									
											oldCardHtml += "<div class=\"ui-block-a\">";
											oldCardHtml += "<label for=\"recommend\">已有移动电话：</label>";
											oldCardHtml += "</div>";
											oldCardHtml += "<div class=\"ui-block-b\">";
											oldCardHtml += "<input type=\"text\" id=\"oldphonenum_1\" value='"+oldSubPhoneNumsize[k]+"' readonly=\"readonly\">";
											oldCardHtml += "</div>";
											oldCardHtml += "<div class=\"ui-block-c\">";
											oldCardHtml += "<button data-mini=\"ture\" onclick=\"order.memberChange.addNum('"+max+"','')\">+</button>";
											oldCardHtml += "</div>";
											oldCardHtml += "<div class=\"ui-block-d\">";
											//oldCardHtml += "<button data-mini=\"ture\" onclick=\"order.memberChange.queryofferinfo()\">加装</button>";
											oldCardHtml += "</div>";								
											oldCardHtml += "</div>";
											oldCardHtml += "</div>";																	
										}else{
											order.memberChange.addNum(max,oldSubPhoneNumsize[k]);
										}
									}
								}
							}
						}
					});					
					$("#oldnum_1").html(oldCardHtml);
				}
			
				//副卡成员
				var otherCardHtml = "";
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.offerRoleId == offerRole.offerRoleId  && this.objType==CONST.OBJ_TYPE.PROD){						 
						otherCardHtml += "<div class=\"ui-grid-a\" id=\"li_viceCard_new_"+this.accessNumber+"\" del=\"N\" knew=\"N\" objId=\""+this.objId+"\" objInstId=\""+this.objInstId+"\" " +
								" objType=\""+this.objType+"\" offerMemberId=\""+this.offerMemberId+"\" offerRoleId=\""+this.offerRoleId+"\" accessNumber=\""+this.accessNumber+"\">";
						otherCardHtml += "<div class=\"ui-block-a\">";
						otherCardHtml += "<div class=\"ui-grid-c\">";
						otherCardHtml += "<div class=\"ui-block-a\">";						
						otherCardHtml += "</div>";
						otherCardHtml += "<div class=\"ui-block-b\" id=\"label_viceCard_new_"+this.accessNumber+"\" style=\"height:53px;line-height:53px;padding-left:18px;\">";
						otherCardHtml += this.accessNumber;
						otherCardHtml += "</div>";
						otherCardHtml += "<div class=\"ui-block-c\">";
						otherCardHtml += "<button data-mini=\"ture\" id=\"button_viceCard_new_"+this.accessNumber+"\" accNbr=\""+this.accessNumber+"\" onclick=\"order.memberChange.removeOtherCard('"+this.accessNumber+"');\">拆副卡</button>";
						otherCardHtml += "</div>";						
						if(areaidflag){
							otherCardHtml += "<div class=\"ui-block-d\">";
							otherCardHtml += "<button data-mini=\"ture\" accNbr=\""+this.accessNumber+"\" onclick=\"order.service.offerDialog('viceCard_new_"+this.accessNumber+"')\">保留>>选择新套餐</button>";
							otherCardHtml += "</div>";
						}
						otherCardHtml += "</div>";
						otherCardHtml += "</div>";
						otherCardHtml += "<div class=\"ui-block-b\" style=\"height:53px;line-height:53px;padding-left:18px;\"><span id='viceCard_new_"+this.accessNumber+"'></span></div>";
						otherCardHtml += "</div>";					
					}
				});
				$("#other_member").html(otherCardHtml);
				$("#other_member").show();				
			}
		});		
		if(order.memberChange.reloadFlag=="Y"){
			$("#memeberChange .btna_o:last").click(function(){
				_closeDialog();
			});		
		}else if(order.memberChange.reloadFlag=="N"){					
				order.memberChange.submit();			
		}		
		$.jqmRefresh($("#order_tab_panel_content"));
	};
	
	function _areaidJurisdiction(){
		var provid = OrderInfo.staff.soAreaId.substring(0,3) + "0000";
		var areaparam = {"areaid":provid};
		$.ecOverlay("<strong>正在查询中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(contextPath+"/pad/offer/areaidJurisdiction",areaparam);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data=="ON"){
				return true;
			}else{
				return false;
			}
		}else {
			return false;
		}
	};
	
	function queryReOrder(){
		var provTransId = OrderInfo.provinceInfo.provIsale;
		var areaparam = {"provTransId":provTransId,"backFlag":"Y"};
		$.ecOverlay("<strong>正在查询中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(contextPath+"/accessToken/queryOrderInfos",areaparam);	
		$.unecOverlay();
		if (response.code==0) {
			order.memberChange.rejson = response.data;
			return true;
		}else if(response.code==1002){
			$.alert("错误",response.data);
			return false;
		}else{
			$.alertM(response.data);
			return false;
		}
	}
	
	var _addNum = function(max,addnum){
		if(choosenum>=max){
			return;
		}
		idnum++;
		choosenum++;	
		var olro = "<div class=\"ui-grid-a\" id='oldnum_"+idnum+"'>" + 
		   "<div class=\"ui-block-a\">" + 
		   "<div class=\"ui-grid-c\">" +
		   "<div class=\"ui-block-a\"><label for=\"recommend\">已有移动电话：</label></div>" +
		   "<div class=\"ui-block-b\"><input type=\"text\" id=\"oldphonenum_"+idnum+"\"></div>" + 
		   "<div class=\"ui-block-c\"><button data-mini=\"ture\" onclick=\"order.memberChange.delNum('oldnum_"+idnum+"')\">-</button></div>" +
		   "<div class=\"ui-block-d\"></div>" + 
		   "</div></div></div>";		
		$("#maincard_member_div").append(olro);
		$.jqmRefresh($("#order_tab_panel_content"));
	};
	
	var _delNum = function(id){
		idnum--;
		choosenum--;
		$("#"+id).remove();	
	};
	
	var custinfolist = [];
	
	// 判断能加装的最大数量
	var checkCanAddNum = function(num){
		var flag = true;
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if (offerRole.memberRoleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD) {
				var existViceCardNum = 0;//已有副卡数量
				//副卡个数
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.offerRoleId == offerRole.offerRoleId  && this.objType==CONST.OBJ_TYPE.PROD){
						existViceCardNum++;
					}
				});
				$.each(this.roleObjs,function(){
					if(this.objType == CONST.OBJ_TYPE.PROD){
						var max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
						if(max > 0 && (max - existViceCardNum - num) < 0){
							$.alert("提示","加装数量已经超过能加装的最大数量【"+max+"】!");
							flag = false;
							return false;
						}
					}
				});
			}
		});
		return flag;
	};
	
	
	//套餐变更融合新装纳入老用户  用
	var _queryofferinfoSub = function(){
		OrderInfo.oldAddNumList = [];
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldAddNumList = [];
		custinfolist = [];
		
		var oldAddNumList_flag = true;
		
		
		if(OrderInfo.actionFlag==1 && OrderInfo.provinceInfo.reloadFlag=="N"){
			
			var custOrderList = OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;	
			 for(var i=0;i<custOrderList.length;i++){
				 //纳入老用户 
				 if(custOrderList[i].boActionType.actionClassCd=="1200" && custOrderList[i].boActionType.boActionTypeCd=="S2" && custOrderList[i].busiObj.offerTypeCd=="1"){

					 var accNbr=custOrderList[i].busiObj.accessNumber;
				     OrderInfo.oldAddNumList.push({"accNbr":accNbr});
					
				 }
			 }
		}else{
			for(var i=1;i<=idnum;i++){
				var num = $.trim($("#oldphonenum_"+i).val());	
				if(ec.util.isObj(num)){
					if(ec.util.isArray(OrderInfo.oldAddNumList)){
						if(!oldAddNumList_flag){
							return false;
						}
						$.each(OrderInfo.oldAddNumList,function(){
							if(num==this.accNbr){
								oldAddNumList_flag = false;
								$.alert("提示",num+"重复，请重新输入！");
								return false;
							}
						});
						if(oldAddNumList_flag){
							OrderInfo.oldAddNumList.push({"accNbr":num});
						}
					}else{
						OrderInfo.oldAddNumList.push({"accNbr":num});
					}
				}
			}
		}
		
		if(!oldAddNumList_flag){
			return false;
		}
		
		if(OrderInfo.oldAddNumList.length==0){
			$.alert("提示","请输入手机号码!");
			return false;
		}
		
		var custflag = true;
		for(var i=0;i<OrderInfo.oldAddNumList.length;i++){
			for(var v=0;v<OrderInfo.offer.offerMemberInfos.length;v++){
				if(OrderInfo.oldAddNumList[i].accNbr==OrderInfo.offer.offerMemberInfos[v].accessNumber){
					$.alert("提示",OrderInfo.oldAddNumList[i].accNbr+"号码重复，请重新输入！");
					custflag = false;
					return false;
				}
			}
			if(OrderInfo.provinceInfo.mergeFlag=="0"){
				var param = {
						"acctNbr":OrderInfo.oldAddNumList[i].accNbr,
						"identityCd":"",
						"identityNum":"",
						"partyName":"",
						"diffPlace":"local",
						"areaId" : OrderInfo.staff.soAreaId,
						"queryType" :"",
						"queryTypeValue":"",
						"prodClass":"12"
				};
				var response = $.callServiceAsJson(contextPath+"/cust/queryoffercust", param, {"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
				}});
				if (response.code == 0) {
					$.unecOverlay();
					if(response.data.custInfos.length==0){
						$.alert("提示","抱歉，没有定位到"+OrderInfo.oldAddNumList[i].accNbr+"客户，请尝试其他客户。");
						custflag = false;
						return false;
					}
					var custId = response.data.custInfos[0].custId;
					// 主副卡客户校验取客户查询返回结果中的custId,旧的取order.prodModify.choosedProdInfo.custId
					
					if(OrderInfo.actionFlag!=1 && custId!=OrderInfo.cust.custId){
						custflag = false;
						$.alert("提示",OrderInfo.oldAddNumList[i].accNbr+"和主卡的客户不一致！");
						return false;
					}
				   
					custinfolist.push({"accNbr":OrderInfo.oldAddNumList[i].accNbr,"custId":custId});
	
				}else{
					custflag = false;
					$.unecOverlay();
					$.alertM(response.data);
					return false;
				}
			}else{
				var provCustAreaId = OrderInfo.staff.soAreaId;
				custflag = order.cust.mgr.queryCustCompreInfo(OrderInfo.oldAddNumList[i].accNbr,provCustAreaId,3,'OLD');
				if(!custflag){
					break;
				}
			}
		}
		if(custflag){
			if(OrderInfo.provinceInfo.mergeFlag=="0"){
				return QueryofferCustProd();
			}else{
				if(checkCanAddNum(order.memberChange.viceCartNum)){
					return queryMainOfferSpec();
				}
			}
		}
	};
	
	var _queryofferinfo = function(){
		OrderInfo.oldAddNumList = [];
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldAddNumList = [];
		custinfolist = [];
		
		var oldAddNumList_flag = true;
	//	alert("idnum:"+idnum);
		for(var i=1;i<=idnum;i++){
			var num = $.trim($("#oldphonenum_"+i).val());	
			if(ec.util.isObj(num)){
				if(ec.util.isArray(OrderInfo.oldAddNumList)){
					if(!oldAddNumList_flag){
						return false;
					}
					$.each(OrderInfo.oldAddNumList,function(){
						if(num==this.accNbr){
							oldAddNumList_flag = false;
							$.alert("提示",num+"重复，请重新输入！");
							return false;
						}
					});
					if(oldAddNumList_flag){
						OrderInfo.oldAddNumList.push({"accNbr":num});
					}
				}else{
					OrderInfo.oldAddNumList.push({"accNbr":num});
				}
			}
		}

		if(!oldAddNumList_flag){
			return;
		}
		if(OrderInfo.oldAddNumList.length==0){
			$.alert("提示","请输入手机号码!");
			return;
		}
		var custflag = true;
		for(var i=0;i<OrderInfo.oldAddNumList.length;i++){
			for(var v=0;v<OrderInfo.offer.offerMemberInfos.length;v++){
				if(OrderInfo.oldAddNumList[i].accNbr==OrderInfo.offer.offerMemberInfos[v].accessNumber){
					$.alert("提示",OrderInfo.oldAddNumList[i].accNbr+"号码重复，请重新输入！");
					custflag = false;
					return;
				}
			}
			var param = {
					"acctNbr":OrderInfo.oldAddNumList[i].accNbr,
					"identityCd":"",
					"identityNum":"",
					"partyName":"",
					"diffPlace":"local",
					"areaId" : $("#p_cust_areaId").val(),
					"queryType" :"",
					"queryTypeValue":""
			};
			var response = $.callServiceAsJson(contextPath+"/cust/queryoffercust", param, {"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			}});
			if (response.code == 0) {
				$.unecOverlay();
				if(response.data.custInfos.length==0){
					$.alert("提示","抱歉，没有定位到"+OrderInfo.oldAddNumList[i].accNbr+"客户，请尝试其他客户。");
					custflag = false;
					return;
				}
				var custId = response.data.custInfos[0].custId;
				// 主副卡客户校验取客户查询返回结果中的custId,旧的取order.prodModify.choosedProdInfo.custId
				if(custId!=OrderInfo.cust.custId){
					custflag = false;
					$.alert("提示",OrderInfo.oldAddNumList[i].accNbr+"和主卡的客户不一致！");
					return;
				}
				custinfolist.push({"accNbr":OrderInfo.oldAddNumList[i].accNbr,"custId":custId});
//				QueryofferCustProd(response.data);
			}else{
				custflag = false;
				$.unecOverlay();
				$.alertM(response.data);
				return;
			}
		}
		if(custflag){
			return QueryofferCustProd();
		}
	};
	
	var QueryofferCustProd = function(){
		var orderflag = true;
		for(var i=0;i<custinfolist.length;i++){
			var param={};
			param.custId=custinfolist[i].custId;
			param.acctNbr=custinfolist[i].accNbr;
			param.areaId=$("#p_cust_areaId").val();
			param.pageSize="";
			param.curPage="";
			param.DiffPlaceFlag="local";
			if(param.custId==null||param.custId==""){
				orderflag = false;
				$.alert("提示",custinfolist[i].accNbr+"无法查询已订购产品");
				return false;
			}
			var response = $.callServiceAsJson(contextPath+"/cust/offerorderprod", param, {"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			}});
			if (response.code == 0) {
				$.unecOverlay();
				var list = response.data;
				for(var j=0;j<list.length;j++){
					if (list[j].accNbr == custinfolist[i].accNbr){
						var prodInstInfos = list[j];
						prodInstInfos.custId = custinfolist[i].custId;
						
						if(prodInstInfos.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
							orderflag = false;
							$.alert("提示",custinfolist[i].accNbr+"不是在用产品！");
							return false;
						}
	
						if(OrderInfo.actionFlag!=1 && prodInstInfos.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){
							orderflag = false;
							$.alert("提示",custinfolist[i].accNbr+"和主卡的付费类型不一致！");
							return false;
						}
						
						if(prodInstInfos.productId=="280000000"){
							$.alert("提示",custinfolist[i].accNbr+"是无线宽带，不能纳入！");
							return false;
						}
						
						OrderInfo.oldprodInstInfos.push(prodInstInfos);
						break;
					}
				}
			}else{
				orderflag = false;
				$.unecOverlay();
				$.alertM(response.data);
				return false;
			}
		}
		if(orderflag){
			return setOffer();
		}
	};
	
	var queryMainOfferSpec = function(){
		var specflag = true;
		for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
			var prodOfferId = OrderInfo.oldprodInstInfos[i].mainProdOfferInstInfos[0].prodOfferId;
			if(ec.util.isObj(prodOfferId)){
				var param = {
						offerSpecId : prodOfferId, 
						offerTypeCd : 1,
						partyId : OrderInfo.oldprodInstInfos[i].custId,
						accNbr : OrderInfo.oldprodInstInfos[i].accNbr
					};
				if(!query.offer.queryMainOfferSpec(param)){ //查询主套餐规格构成，并且保存
					specflag = false;
					return false;
				}
			}
		}
		if(specflag){
			return setProdUim();
		}
	};
	
	
	var setOffer = function() {
		var offerflag = true;
		var addNum = 0; // 加装副卡数量
		var exitNum = [];
		for(var z=0;z<OrderInfo.oldprodInstInfos.length;z++){
			if(ec.util.isArray(exitNum)){
				for(var i in exitNum){
					if(OrderInfo.oldprodInstInfos[z].accNbr == exitNum[i].accessNumber){
						$.alert("提示","号码【"+OrderInfo.oldprodInstInfos[z].accNbr+"】与【"+exitNum[i].accNbr+"】为同一套餐下的实例成员，不能重复加装!");
						return false;
					}
				}
			}
			var param = {
					offerId : OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferInstId,
					offerSpecId : OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferId,
					acctNbr : OrderInfo.oldprodInstInfos[z].accNbr,
					areaId : OrderInfo.oldprodInstInfos[z].areaId,
					distributorId : ""
			};
			var data = query.offer.queryOfferInst(param); //查询销售品实例构成
			if(data&&data.code == CONST.CODE.SUCC_CODE){
				var flag = true;
				if(ec.util.isArray(data.offerMemberInfos)){
					CacheData.sortOffer(data);
					var objTypeflag = 0;
					for ( var i = 0; i < data.offerMemberInfos.length; i++) {
						var member = data.offerMemberInfos[i];
						member.prodClass = OrderInfo.oldprodInstInfos[z].prodClass;
						if(member.objType==""){
							offerflag = false;
							$.alert("提示","销售品实例构成 "+member.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");
							return false;
						}else if(member.objType==CONST.OBJ_TYPE.PROD){
							if(member.accessNumber==""){
								offerflag = false;
								$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
								return false;
							}
							objTypeflag++;
							addNum++;
							exitNum.push({"accNbr":OrderInfo.oldprodInstInfos[z].accNbr,"accessNumber":member.accessNumber});
						}
						if(member.objInstId==OrderInfo.oldprodInstInfos[z].prodInstId){
							flag = false;
						}
					}
					if(flag){
						offerflag = false;
						$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+OrderInfo.oldprodInstInfos[z].accNbr+"】，无法继续受理，请业务后台核实");
						return false;
					}
					/*if(objTypeflag>1){
						offerflag = false;
						$.alert("提示",OrderInfo.oldprodInstInfos[z].accNbr+"不是单产品，请选择【已有主副卡】入口纳入!");
						return;
					}*/
					var offerinfos = {
						"offerMemberInfos":	data.offerMemberInfos,
						"offerId":OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferInstId,
						"offerSpecId":OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferId,
						"offerSpecName":OrderInfo.oldprodInstInfos[z].mainProdOfferInstInfos[0].prodOfferName,
						"accNbr":OrderInfo.oldprodInstInfos[z].accNbr
					};
					OrderInfo.oldoffer.push(offerinfos);
				}else{//销售品成员实例为空
					offerflag = false;
					$.alert("提示",OrderInfo.oldprodInstInfos[z].accNbr+"查询销售品实例构成，没有返回成员实例无法继续受理");
					return false;
				}
			}
		}
		order.memberChange.viceCartNum = addNum;
		if(offerflag && checkCanAddNum(addNum)){
			return queryMainOfferSpec();
		}
	};
	
	var setProdUim = function(){
		var produimflag = true;
		OrderInfo.boProd2OldTds = []; //清空旧卡
		for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
			var prod = OrderInfo.oldprodInstInfos[i]; 
			var uim = query.prod.getTerminalInfo(prod);
			if(uim == undefined){  //查询旧卡信息失败返回
				produimflag = false;
				return false;
			}
			var prodOfferInstId = OrderInfo.oldprodInstInfos[i].mainProdOfferInstInfos[0].prodOfferInstId;
			var prodInstId = OrderInfo.oldprodInstInfos[i].prodInstId;
			setOldUim(prodOfferInstId,prodInstId,uim); //保存旧卡信息
			if(uim.is4GCard=="Y"){
				prod.prodClass = CONST.PROD_CLASS.FOUR;
			}else{
				prod.prodClass = CONST.PROD_CLASS.THREE;
			}
		}
		if(produimflag){
			var instflag = true;
			if(OrderInfo.order.soNbr==null || OrderInfo.order.soNbr==undefined || OrderInfo.order.soNbr==""){
				OrderInfo.order.soNbr = UUID.getDataId();
			}
			for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
				var prod = OrderInfo.oldprodInstInfos[i];
				if(prod==undefined || prod.prodInstId ==undefined){
					instflag = false;
					$.alert("提示",OrderInfo.oldprodInstInfos[i].accNbr+"未获取到老用户产品相关信息，无法办理二次业务！");
					return false;
				}
				var param = {
					areaId : prod.areaId,
					acctNbr : prod.accNbr,
					custId : prod.custId,
					soNbr : OrderInfo.order.soNbr,
					instId : prod.prodInstId,
					type : "2",
					queryType: "1,2,3,4,5",
					acctNbr : "",
					data:[]
				};
				if(!loadInst(param,prod)){  //加载实例到缓存
					instflag = false;
					return false;
				};
			}
			if(instflag){
				return ruleCheck();
//				return true;
			}
//			loadInst();
		}
	};
	
	//保存旧卡
	var setOldUim = function(offerId ,prodId,uim){
		var oldUim={
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "2",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId :uim.couponId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD, //物品费用项类型
			couponNum : 1, //物品数量
			//storeId : oldUimInfo.storeId, //仓库ID
			storeId : 1, //仓库ID
			storeName : "11", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : uim.couponInsNumber, //物品实例编码
			terminalCode : uim.couponInsNumber,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId : prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "DEL", //动作
			relaSeq : "", //关联序列
			id:0,
			isOld : "T",  //旧卡
			is4GCard : uim.is4GCard
		};
		OrderInfo.boProd2OldTds.push(oldUim);
	};
	
	/**
	 * 加载实例
	 */
	var loadInst = function(param,prod){
		var queryMergeFlag=OrderInfo.provinceInfo.mergeFlag;
		
		for(var j=0;j<OrderInfo.oldoffer.length;j++){
			if(OrderInfo.oldoffer[j].accNbr==prod.accNbr){
				if(ec.util.isArray(OrderInfo.oldoffer[j].offerMemberInfos)){ //遍历主销售品构成
					var flag = true;
					$.each(OrderInfo.oldoffer[j].offerMemberInfos,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD && this.accessNumber==prod.accNbr){ //选中号码在销售品实例构成中，为了防止销售品实例缓存
							instflag = false;
							flag = false;
							return;
						}
					});
					
					if(flag){ //不在销售品实例缓存
						if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
							param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
							return  query.offer.invokeLoadInstSub(param);
						}else{
							return query.offer.invokeLoadInst(param);
						}
					}else{
						var vFlag = true;
						
						//1调用新接口，如果是0，就是按照旧的方式调用
						if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
							$.each(OrderInfo.oldoffer[j].offerMemberInfos,function(){
								if(this.objType == CONST.OBJ_TYPE.PROD){
									param.data.push({accessNbr:this.accessNumber,instId:this.objInstId});
								}
							});
							
							if(param!=null){
								if (!query.offer.invokeLoadInstSub(param)) {
									vFlag = false;
									return false;
								}
							}
						}else{
							$.each(OrderInfo.oldoffer[j].offerMemberInfos,function(){
								if(this.objType == CONST.OBJ_TYPE.PROD){
									param.acctNbr = this.accessNumber;
									param.instId = this.objInstId;
									if (!query.offer.invokeLoadInst(param)) {
										vFlag = false;
										return false;
									}
								}
							});
						}
						
						return vFlag;
					}
				}else{
					if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
						param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
						return query.offer.invokeLoadInstSub(param);
					}else{
						return query.offer.invokeLoadInst(param);
					}
				}
			}
		}
	};
	
	//生成订单流水号，规则校验
	var ruleCheck = function(){
		rule.rule.init();
		var ruleflag = true;
		for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
			var prod = OrderInfo.oldprodInstInfos[i];
			var oldinfo = {
					boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,
					instId : prod.mainProdOfferInstInfos[0].prodOfferInstId,
//					specId : OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].prodOfferId,
					prodId : prod.prodInstId
				};
			if(prod.mainProdOfferInstInfos[0].prodOfferId!=""){
				oldinfo.specId = prod.mainProdOfferInstInfos[0].prodOfferId;
			}
			var boInfos = []; 
			boInfos.push(oldinfo);
//			var choosedProdInfo  = {
//					accNbr :OrderInfo.oldprodInstInfos.accNbr,//产品接入号
//					productName :OrderInfo.oldprodInstInfos.productName,//产品规格名称
//					prodStateName :OrderInfo.oldprodInstInfos.prodStateName,//产品状态名称
//					feeTypeName :OrderInfo.oldprodInstInfos.feeType.feeTypeName,//付费方式名称
//					prodInstId :OrderInfo.oldprodInstInfos.prodInstId,//产品ID
//					extProdInstId : OrderInfo.oldprodInstInfos.extProdInstId,//省内产品实例ID
//					corProdInstId : OrderInfo.oldprodInstInfos.corProdInstId,//外部产品实例ID
//					prodStateCd :OrderInfo.oldprodInstInfos.prodStateCd,//产品状态CD
//					productId :OrderInfo.oldprodInstInfos.productId,//产品规格ID
//					feeType :OrderInfo.oldprodInstInfos.feeType.feeType,//付费方式id
//					prodClass :OrderInfo.oldprodInstInfos.prodClass,//产品大类 4 表示4G；3表示3G
//					stopRecordCd :"",//停机记录CD
//					stopRecordName :"",//停机记录名称
//					prodOfferName :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].prodOfferName,//主套餐名称
//					custName :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].custName,//所属人客户名称
//					startDt :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].startDt,//生效时间
//					endDt :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].endDt,//失效时间
//					prodOfferId :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].prodOfferId,//主套餐规格ID
//					prodOfferInstId :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].prodOfferInstId,//主套餐实例ID
//					custId :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].custId,//所属人客户ID
//					is3G :OrderInfo.oldprodInstInfos.mainProdOfferInstInfos[0].is3G,//3G/4G主销售品标识
//					areaCode :OrderInfo.oldprodInstInfos.zoneNumber,//产品地区CODE
//					areaId : OrderInfo.oldprodInstInfos.areaId//产品地区id
//				};
//			if(OrderInfo.oldprodInstInfos.prodStopRecords.length>0){
//				choosedProdInfo.stopRecordCd=OrderInfo.oldprodInstInfos.prodStopRecords[0].stopRecordCd;
//				choosedProdInfo.stopRecordName=OrderInfo.oldprodInstInfos.prodStopRecords[0].stopRecordName;
//			}
			var inParam ={
					areaId : OrderInfo.staff.soAreaId,
					staffId : OrderInfo.staff.staffId,
					channelId : OrderInfo.staff.channelId,
					custId : prod.custId,
					soNbr : OrderInfo.order.soNbr,
					boInfos : boInfos,
					prodInfo : prod	
				};
				$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");
				var response = $.callServiceAsJson(contextPath+"/rule/prepare",inParam); //调用规则校验
				$.unecOverlay();
				if(response!=undefined && response.code==0){
					var checkData = response.data;
					if(checkData == null){
						ruleflag = false;
						$.alert("提示","规则校验异常，请联系管理人员！");
						return false;
					}
					if(checkData.ruleType == "portal"){  //门户层校验
						if (checkData.resultCode == "0"){  // 0为门户层校验为通过
							ruleflag = false;
							$.alert("提示",checkData.resultMsg);
							return false;
						}
					}		
					var checkRuleInfo = checkData.result.resultInfo;  //业务规则校验
					if(checkRuleInfo!=undefined && checkRuleInfo.length > 0){
						_showRuleCreate();
						var ruleStr = "";
						$("#ruleTable").html("");
						$.each(checkRuleInfo, function(i, ruleInfo) {
							ruleStr += "<tr>";
							ruleStr += "<th>"+ruleInfo.resultCode+"</th>";
							ruleStr += "<th>"+ruleInfo.ruleDesc+"</th>";
							ruleStr += "<th>"+rule.rule.getRuleLevelName(ruleInfo.ruleLevel)+"</th>";
							ruleStr += "<th>"+rule.rule.getRuleImgClass(ruleInfo.ruleLevel)+"</th>";
							ruleStr += "</tr>";
						});	
						ruleflag = false;
						setTimeout(function(){
							$("#ruleTable").append(ruleStr);
							$.jqmRefresh($("#order_tab_panel_content"));
						},100);
						return false;
					}

				}else{
					ruleflag = false;
					$.alertM(response.data);
					return false;
				}
		}
		if(ruleflag){
			return true;

		}
	};
	
	//创键客户 ok
	var _showRuleCreate = function() {	
		$.callServiceAsHtmlGet(contextPath+"/pad/order/rulecreate",{},{
			"done" : function(response){
				if (!response || !response.data) {
					return;
				}
				//统一弹出框
				var popup = $.popup("#div_rule_create",response.data,{
					cache:true,
					width:$(window).width()-200,
					height:$(window).height(),
					contentHeight:$(window).height()-120,
					afterClose:function(){}
				});				
			}});
	};
	
	var addOldSubmit = function(){
		//老用户纳入
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,
				CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
		var param = {
			memberChange : "Y",
			type : 1,
			boActionTypeName : "主副卡成员变更",
			viceCardNum : parseInt(OrderInfo.oldAddNumList.length),
			offerNum : 1,
			actionFlag:6,
			offerSpec:OrderInfo.oldofferSpec,
			prodInstInfos:OrderInfo.oldprodInstInfos,
			offer:OrderInfo.oldoffer,
			addflag:"ADD",
			oldnum:parseInt(OrderInfo.oldAddNumList.length)
		};
//		order.service.setOfferSpec(); //把选择的主副卡数量保存
		var prod = order.prodModify.choosedProdInfo; 
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,
			instId : prod.prodOfferInstId,
			specId : prod.prodOfferId,
			prodId : _offerProd.objInstId//纳入产品成员这些动作时出入宿主产品实例ID
		}];
		if(rule.rule.ruleCheck(boInfos)){  //业务规则校验
			order.main.buildMainView(param);	
		}
		order.memberChange.closeDialog();
	};

	var _submit = function() {
		OrderInfo.oldAddNumList = [];
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldprodAcctInfos = [];
		var num=0;
		var lis = $("#maincard_member_tbody .othermember .ui-grid-a");
		$.each(lis,function(){
			var accessnumber = $(this).attr("accessnumber");				
			if(order.memberChange.delmembers.flag){
				$.each(order.memberChange.delmembers.accessNumbers,function(){					
					if(this.nbr == accessnumber){
						$("#label_viceCard_new_"+accessnumber).attr({style:"height:53px;line-height:53px;padding-left:18px;text-decoration:line-through"});
						$("#li_viceCard_new_"+accessnumber).attr("del","Y").attr("knew","N");
						document.getElementById("button_viceCard_new_" + accessnumber).innerHTML = "不 拆";
					}
				});
			}			
			if(order.memberChange.changemembers.flag){
				$.each(order.memberChange.changemembers.accessNumbers,function(){
					if(this.nbr == accessnumber){
						order.service.choosedOffer('tcnum'+1,this.specId,'','viceCard_new_'+this.nbr,this.name);
					}
				});
			}			
		});	
		
		var ifRemoveProd = false;
		$.each(lis,function(){		
			if($(this).attr("del") == "Y" || $(this).attr("knew") == "Y"){				
				ifRemoveProd = true;
				return false;
			}
		});	
		
		$.each(_memberAddList,function(){			
			num=num+Number($("#"+this).val());		
		});
		
		var oldnum = 0;
		for(var i=1;i<=idnum;i++){
			var _oldphonenum = $.trim($("#oldphonenum_"+i).val());	
			if(ec.util.isObj(_oldphonenum)){
				oldnum++;
			}
		}
		
		//var num = $("#memeberChange ul:last h5 i input").val();
		/*if ((ifRemoveProd) && num> 0) {
			$.alert("提示","副卡拆机和副卡新装不能同时做，请分开两次操作");
			return;
		}*/
		if (!(ifRemoveProd) && num <=0 && oldnum <= 0) {
			$.alert("提示","没有对副卡进行操作。");
			return;
		}
		var prod = order.prodModify.choosedProdInfo; 
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,
			instId : prod.prodOfferInstId,
			specId : prod.prodOfferId,
			prodId : _offerProd.objInstId//纳入产品成员这些动作时出入宿主产品实例ID
		}];
		if(!rule.rule.ruleCheck(boInfos)){  //业务规则校验
			return;
		}
		
		var paramMap = {};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,
				CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
//		if(oldnum>0){
//			order.memberChange.oldMemberFlag = true;
//			if(!order.memberChange.queryofferinfo()){
//				return;
//			}
//			paramMap.oldprodInstInfos = OrderInfo.oldprodInstInfos;
//			paramMap.oldofferSpec = OrderInfo.oldofferSpec;
//			paramMap.oldoffer = OrderInfo.oldoffer;
//			paramMap.oldnum = oldnum;
//		}else{
//			order.memberChange.oldMemberFlag = false;
//		}
		if(num>0){//新装副卡
			order.memberChange.newMemberFlag = true;
			//查询主卡的产品属性并保存
			var param = {
				prodId : prod.prodInstId, // 产品实例id
				acctNbr : prod.accNbr, // 接入号
				prodSpecId : prod.productId, // 产品规格id
				areaId : prod.areaId // 地区id
			};
			var resData = query.offer.queryProdInstParam(param);
			if(resData && resData.prodSpecParams){
				OrderInfo.prodInstAttrs = resData.prodSpecParams;
			}
			
//			OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,6,
//					CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
			paramMap = {
				memberChange : "Y",
				type : 1,
				boActionTypeName : "主副卡成员变更",
//				viceCardNum : parseInt(num),
				feeTypeMain:prod.feeType,
				offerNum : 1,
				custId : OrderInfo.cust.custId,
				actionFlag:6,
				accessNumber:_offerProd.accessNumber,
				offerSpec: OrderInfo.offerSpec,
//				oldofferSpec: OrderInfo.oldofferSpec,
//				oldprodInstInfos:OrderInfo.oldprodInstInfos,
//				oldoffer:OrderInfo.oldoffer,
				newnum:parseInt(num)
//				oldnum:parseInt(OrderInfo.oldAddNumList.length)
			};
			order.service.setOfferSpec(); //把选择的主副卡数量保存
//			if(rule.rule.ruleCheck(boInfos)){  //业务规则校验
//				order.main.buildMainView(param);	
//			}
//			order.memberChange.closeDialog();
		}else{
			order.memberChange.newMemberFlag = false;
		}
		if(oldnum>0){
			order.memberChange.oldMemberFlag = true;
			if(!order.memberChange.queryofferinfo()){
				return;
			}
			paramMap.memberChange = "Y";
			paramMap.type = 1;
			paramMap.offerNum = 1;
			paramMap.actionFlag=6;
			paramMap.oldprodInstInfos = OrderInfo.oldprodInstInfos;
			paramMap.oldofferSpec = OrderInfo.oldofferSpec;
			paramMap.oldoffer = OrderInfo.oldoffer;
			paramMap.oldnum = oldnum;
		}else{
			order.memberChange.oldMemberFlag = false;
		}
		if(parseInt(num)+parseInt(order.memberChange.viceCartNum)>maxNum && order.memberChange.reloadFlag!="N"){
			$.alert("提示","加装数量已经超过能加装的最大数量【"+maxNum+"】!");
			return;
		}
	   if(ifRemoveProd){//保留副卡
		   var viceparam = [];
			$.each(lis,function(i, li){//所有副卡信息
				if ($(this).attr("knew") == "Y"||$(this).attr("del") == "Y") {
					viceparam.push({
						objId : $(this).attr("objId"),
						objInstId : $(this).attr("objInstId"),
						objType : $(this).attr("objType"),
						offerRoleId : $(this).attr("addRoleId"),
						offerSpecId :$(this).attr("addSpecId"),
						offerMemberId:$(this).attr("offerMemberId"),
						del : $(this).attr("del"),
						accessNumber : $(this).attr("accessNumber"),
						offerSpecName : $(this).attr("addSpecName"),
						roleName : "基础移动电话",
						knew : $(this).attr("knew")
					});
				}
			});
			order.memberChange.viceparams = viceparam;
			var ooRoles = [];
			$.each(lis,function(i, li){
				if ($(this).attr("del") == "Y"||$(this).attr("knew") == "Y") {
					ooRoles.push({
						objId : $(this).attr("objId"),
						objInstId : $(this).attr("objInstId"),
						objType : $(this).attr("objType"),
						offerMemberId : $(this).attr("offerMemberId"),
						offerRoleId : $(this).attr("offerRoleId"),
						state:'DEL'
					});
				}
			});
			order.memberChange.ooRoless = ooRoles;
			//params = {viceParam:viceparam,ooRoles:ooRoles};
		   OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,21,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.ADDOREXIT_COMP),"3");
//		   var boInfos = [{
//				boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP,
//				instId : _offerProd.offerId,
//				specId : _offerProd.offerSpecId,
//				prodId : _offerProd.objInstId//纳入产品成员这些动作时出入宿主产品实例ID
//			}];
/*		   if(rule.rule.ruleCheck(boInfos)){  //业务规则校验
		   _removeAndAdd();
		   }*/
		   var submitFlag = "removeProd" ;
		   var boActionType=CONST.BO_ACTION_TYPE.ADDOREXIT_COMP;
			var callParam = {
				boActionTypeCd : boActionType,
//				boActionTypeName : CONST.getBoActionTypeName(boActionType),
				//accessNumber : _choosedProdInfo.accNbr,
				submitFlag:submitFlag,
				viceParam:viceparam,
				ooRoles:ooRoles
			};
/*			OrderInfo.order.templateType=templateType;
			var v_actionFlag = 0 ;
			if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){
				v_actionFlag =20;//OrderInfo.actionFlag
			}*/
			var param={
				areaId : OrderInfo.staff.areaId,
				staffId : OrderInfo.staff.staffId,
				channelId : OrderInfo.staff.channelId,
				custId : OrderInfo.cust.custId,
				boInfos : []
			};
			param.boInfos=boInfos;
//			if(_getSimulateData()){			
//				if(rule.rule.ruleCheck(boInfos)){  //业务规则校验
				//根据UIM类型，设置产品是3G还是4G，并且保存旧卡
				if(!prodUimSetProdUim()){ 
					return ;
				}
				var prodInfo = order.prodModify.choosedProdInfo;
//				var paramTmp = {
				paramMap.boActionTypeCd = boActionType;
						//boActionTypeName : CONST.getBoActionTypeName(boActionType),
				paramMap.actionFlag ="6";
				paramMap.prodId = prodInfo.prodInstId;
				paramMap.offerMembers = OrderInfo.offer.offerMemberInfos;
				paramMap.oldOfferSpecName = prodInfo.prodOfferName;
				paramMap.prodClass = prodInfo.prodClass;
				paramMap.appDesc = CONST.getAppDesc();
				paramMap.submitFlag=submitFlag;
				paramMap.viceParam=viceparam;
				paramMap.ooRoles=ooRoles;
				order.memberChange.changeMemberFlag = true;
//					};
//					order.main.buildMainView(paramTmp);	
//				}
//			}else{
//				//OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);
//				var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
//				if(flag) return;
//			}
//			order.memberChange.closeDialog();
	   }else{
		   order.memberChange.changeMemberFlag = false;
	   }
	   order.main.buildMainView(paramMap);	
	   order.memberChange.closeDialog();
	};
	
	var prodUimSetProdUim=function(){
		return prod.uim.setProdUim();
	};
	
	/**
	 * 从缓存里面获取标识
	 */
	var _getSimulateData=function(){
		var param={
			code:"old_memberchange"
		};
		var url=contextPath+"/order/getSimulateData";
		$.ecOverlay("<strong>正在查询公共数据查询的服务中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data!=undefined){
				if("Y"==response.data){
					return false;
				}
			}
		}
		return true;
	};
	
	var _fillmemberChange=function(response,param){
//		SoOrder.initFillPage(); //并且初始化订单数据
//		$("#order_fill_content").html(response.data);
//		$("#fillNextStep").off("click").on("click",function(){
//			SoOrder.submitOrder();
//			_removeAndAdd(param);
//		});
//		$("#fillLastStep").off("click").on("click",function(){
//			order.main.lastStep();
//		});
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		//遍历主销售品构成
		var uimDivShow=false;//是否已经展示了
		$.each(param.viceParam,function(){
			var prodId = this.objInstId;
			var param = {
				areaId : OrderInfo.getProdAreaId(prodId),
				channelId : OrderInfo.staff.channelId,
				staffId : OrderInfo.staff.staffId,
			    prodId : prodId,
			    prodSpecId : this.objId,
			    offerSpecId : prodInfo.prodOfferId,
			    offerRoleId : this.offerRoleId,
			    acctNbr : this.accessNumber
			};
			var res = query.offer.queryChangeAttachOffer(param);
			$("#attach_"+prodId).html(res);
			$.jqmRefresh($("#attach_"+prodId));
			//如果objId，objType，objType不为空才可以查询默认必须
			if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){
				param.queryType = "1,2";
				param.objId = this.objId;
				param.objType = this.objType;
				param.memberRoleCd = "400";
				param.offerSpecId=this.offerSpecId;
				//默认必须可选包
				var data = query.offer.queryDefMustOfferSpec(param);
				CacheData.parseOffer(data,prodId);
				//默认必须功能产品
				var data = query.offer.queryServSpec(param);
				CacheData.parseServ(data,prodId);
			}
			/*if(CONST.getAppDesc()==0 && prodInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){	//预校验
			}else{	
			}*/
			AttachOffer.showMainMemberRoleProd(prodId); //显示新套餐构成
			AttachOffer.changeLabel(prodId,this.objId,""); //初始化第一个标签附属
			if(AttachOffer.isChangeUim(prodId)){ //需要补换卡
				if(!uimDivShow){
					$("#uimDiv_"+prodId).show();
				}else{
					$("#uimDiv_"+prodId).hide();
				}
			}
			uimDivShow=true;
		});
//		order.dealer.initDealer(); //初始化发展人
//		offerChange.initOrderProvAttr();//初始化省内订单属性
//		order.main.reload();
	};
	
	var _closeDialog = function() {
		if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){
			order.prodModify.dialogForm.close(order.prodModify.dialog);
		}
	};
	//主卡不变副卡新装套餐
	var _removeAndAdd=function(date){
		var viceparam = [];
		var ooRoles =[];
		var params =[];
		viceparam=date.viceParam;
		ooRoles=date.ooRoles;
		params = {viceParam:viceparam,ooRoles:ooRoles,remark:$("#order_remark").val()};
		SoOrder.submitOrder(params);
		
	};
	
	//省里校验单
	var _checkOrder = function(prodInfo,oldoffer){
		OrderInfo.getOrderData(); //获取订单提交节点
		OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		OrderInfo.orderData.orderList.orderListInfo.areaId = OrderInfo.cust.areaId;
		var busiOrders = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;//获取业务对象数组
		_createDelOffer(busiOrders,oldoffer,prodInfo.prodInstId); //退订主销售品
		_createMainOffer(busiOrders,oldoffer,prodInfo); //订购主销售品	
		var data = query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));
		OrderInfo.orderData.orderList.custOrderList[0].busiOrder = []; //校验完清空
		if(data==undefined){
			return false;
		}
		if(data.resultCode==0 && ec.util.isObj(data.result)){ //预校验成功
			offerChange.resultOffer = data.result;
		}else {
			$.alert("预校验规则限制",data.resultMsg);
			offerChange.resultOffer = {}; 
			return false;
		}
		return true;
	};

	//创建退订主销售品节点
	var _createDelOffer = function(busiOrders,oldoffer,prodInstId){	
		oldoffer.offerTypeCd = 1;
		oldoffer.boActionTypeCd = CONST.BO_ACTION_TYPE.DEL_OFFER;
		OrderInfo.getOfferBusiOrder(busiOrders,oldoffer,prodInstId);
	};
	//创建主销售品节点
	var _createMainOffer = function(busiOrders,offer,prod) {
		var offerSpec = OrderInfo.offerSpec;
		var offerRole = getOfferRole();
		if(offerRole==undefined){
			alert("错误提示","无法加装到该套餐");
			return false;
		}
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
				objId : offerSpec.offerSpecId,  //业务规格ID
				offerTypeCd : "1", //1主销售品
				accessNumber : prod.accNbr  //接入号码
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
			}, 
			data:{
				ooRoles : [],
				ooOwners : [{
					partyId : OrderInfo.cust.custId, //客户ID
					state : "ADD" //动作
				}]
			}
		};
		//遍历主销售品构成
		if(ec.util.isArray(offer.offerMemberInfos)){ //遍历主销售品构成
			busiOrder.data.ooRoles = [];
			$.each(offer.offerMemberInfos,function(){
				var ooRoles = {
					objId : this.objId, //业务规格ID
					objInstId : this.objInstId, //业务对象实例ID,新装默认-1
					objType : this.objType, // 业务对象类型
					offerRoleId : offerRole.offerRoleId, //销售品角色ID
					state : "ADD" //动作
				};
				if(this.objType != CONST.OBJ_TYPE.PROD){ //不是接入产品
					ooRoles.prodId = prodId;//业务对象实例ID
				}
				busiOrder.data.ooRoles.push(ooRoles);
			});
		}

		//销售参数节点
		if(ec.util.isArray(offerSpec.offerSpecParams)){  
			busiOrder.data.ooParams = [];
			for (var i = 0; i < offerSpec.offerSpecParams.length; i++) {
				var param = offerSpec.offerSpecParams[i];
				var ooParam = {
	                itemSpecId : param.itemSpecId,
	                offerParamId : OrderInfo.SEQ.paramSeq--,
	                offerSpecParamId : param.offerSpecParamId,
	                value : param.value,
	                state : "ADD"
	            };
	            busiOrder.data.ooParams.push(ooParam);
			}				
		}
		
		//销售生失效时间节点
		if(offerSpec.ooTimes !=undefined ){
			busiOrder.data.ooTimes = [];
			busiOrder.data.ooTimes.push(offerSpec.ooTimes);
		}
		
		//发展人
		busiOrder.data.busiOrderAttrs = [];
		var $tr = $("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");
		if($tr!=undefined){
			$tr.each(function(){   //遍历产品有几个发展人
				var dealer = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
					role : $(this).find("select").val(),
					value : $(this).find("input").attr("staffid"),
					channelNbr : $(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()
				};
				busiOrder.data.busiOrderAttrs.push(dealer);
				var dealer_name = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("value") 
				};
				busiOrder.data.busiOrderAttrs.push(dealer_name);	
			});
		}
		busiOrders.push(busiOrder);
	};
	var getOfferRole = function(){
		//新套餐是主副卡,获取主卡角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){  //主卡
				return offerRole;
			}
		}
		//新套餐不是主副卡，返回第一个包含接入产品的角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			for (var j = 0; j < offerRole.roleObjs.length; j++) {
				var roleObj = offerRole.roleObjs[j];
				if(roleObj.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
					return offerRole;
				}
			}
		}
	};
	
	//根据省内返回的数据校验
	var _checkOfferProd = function(oldoffer){
		if(offerChange.resultOffer==undefined){
			return;
		}
		//功能产品
		var prodInfos = offerChange.resultOffer.prodInfos;
		if(ec.util.isArray(prodInfos)){
			$.each(prodInfos,function(){
				var prodId = this.accProdInstId;
				//容错处理，省份接入产品实例id传错
				var flag = true;
				$.each(oldoffer.offerMemberInfos,function(){ //遍历旧套餐构成
					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var serv = CacheData.getServ(prodId,this.prodInstId);
					if(this.state=="DEL"){
						if(serv!=undefined){
							var $span = $("#li_"+prodId+"_"+this.prodInstId).find("span");
							$span.addClass("del");
							serv.isdel = "Y";
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined){  //在已开通里面，修改不让关闭
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}else{
							var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
							if(servSpec!=undefined){
								$("#del_"+prodId+"_"+this.productId).hide();
							}else {
								if(this.productId!=undefined && this.productId!=""){
									//AttachOffer.addOpenServList(prodId,this.productId,this.prodName,this.ifParams);
									AttachOffer.openServSpec(prodId,this.productId);
								}
							}
						}
					}
				}
			});
		}
		
		//可选包
		var offers = offerChange.resultOffer.prodOfferInfos;
		if(ec.util.isArray(offers)){
			if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){//多产品套餐
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					var prodId = this.objInstId;
					$.each(offers,function(){
						if(this.memberInfo==undefined){
							return true;
						}
						var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已开通里面查找
						var flag = true;
						$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
							if(prodId == this.accProdInstId){		
								if(ec.util.isObj(offer)){
									this.prodId = this.accProdInstId;
//									offer.offerMemberInfos = [];
//									offer.offerMemberInfos.push(this);
								}
								flag = false;
								return false;
							}
						});
						if(flag){
							return true;
						}
						if(this.state=="DEL"){
							if(offer!=undefined){
								var $span = $("#li_"+prodId+"_"+this.prodOfferInstId).find("span");
								$span.addClass("del");
								offer.isdel = "Y";
								if(this.isRepeat!="Y"){//如果可选包下面有多个接入类产品，到时候只拼一个退订节点
									this.isRepeat="Y";
								}else{
									offer.isRepeat="Y";
								}
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}	
						}else if(this.state=="ADD"){
							if(offer!=undefined){ //在已开通里面，修改不让关闭
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}else{
								var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已开通里面查找
								if(offerSpec!=undefined){
									$("#del_"+prodId+"_"+this.prodOfferId).hide();
								}else {
									if(ec.util.isObj(this.prodOfferId) && this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){
										//AttachOffer.addOpenList(prodId,this.prodOfferId);			
										AttachOffer.addOfferSpecByCheck(prodId,this.prodOfferId);
									}
								}
							}
						}
					});
				});
			}
		}
	};
	
	//省里校验单
	var _checkOrder = function(prodInfo,oldoffer){
		OrderInfo.getOrderData(); //获取订单提交节点
		OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		OrderInfo.orderData.orderList.orderListInfo.areaId = OrderInfo.cust.areaId;
		var busiOrders = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;//获取业务对象数组
		_createDelOffer(busiOrders,oldoffer,prodInfo.prodInstId); //退订主销售品
		_createMainOffer(busiOrders,oldoffer,prodInfo); //订购主销售品	
		var data = query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));
		OrderInfo.orderData.orderList.custOrderList[0].busiOrder = []; //校验完清空
		if(data==undefined){
			return false;
		}
		if(data.resultCode==0 && ec.util.isObj(data.result)){ //预校验成功
			offerChange.resultOffer = data.result;
		}else {
			$.alert("预校验规则限制",data.resultMsg);
			offerChange.resultOffer = {}; 
			return false;
		}
		return true;
	};
	
	//根据省内返回的数据校验
	var _checkOfferProd = function(oldoffer){
		if(offerChange.resultOffer==undefined){
			return;
		}
		//功能产品
		var prodInfos = offerChange.resultOffer.prodInfos;
		if(ec.util.isArray(prodInfos)){
			$.each(prodInfos,function(){
				var prodId = this.accProdInstId;
				//容错处理，省份接入产品实例id传错
				var flag = true;
				$.each(oldoffer.offerMemberInfos,function(){ //遍历旧套餐构成
					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var serv = CacheData.getServ(prodId,this.prodInstId);
					if(this.state=="DEL"){
						if(serv!=undefined){
							var $span = $("#li_"+prodId+"_"+this.prodInstId).find("span");
							$span.addClass("del");
							serv.isdel = "Y";
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined){  //在已开通里面，修改不让关闭
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}else{
							var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
							if(servSpec!=undefined){
								$("#del_"+prodId+"_"+this.productId).hide();
							}else {
								if(this.productId!=undefined && this.productId!=""){
									//AttachOffer.addOpenServList(prodId,this.productId,this.prodName,this.ifParams);
									AttachOffer.openServSpec(prodId,this.productId);
								}
							}
						}
					}
				}
			});
		}
		
		//可选包
		var offers = offerChange.resultOffer.prodOfferInfos;
		if(ec.util.isArray(offers)){
			if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){//多产品套餐
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					var prodId = this.objInstId;
					$.each(offers,function(){
						if(this.memberInfo==undefined){
							return true;
						}
						var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已开通里面查找
						var flag = true;
						$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
							if(prodId == this.accProdInstId){		
								if(ec.util.isObj(offer)){
									this.prodId = this.accProdInstId;
//									offer.offerMemberInfos = [];
//									offer.offerMemberInfos.push(this);
								}
								flag = false;
								return false;
							}
						});
						if(flag){
							return true;
						}
						if(this.state=="DEL"){
							if(offer!=undefined){
								var $span = $("#li_"+prodId+"_"+this.prodOfferInstId).find("span");
								$span.addClass("del");
								offer.isdel = "Y";
								if(this.isRepeat!="Y"){//如果可选包下面有多个接入类产品，到时候只拼一个退订节点
									this.isRepeat="Y";
								}else{
									offer.isRepeat="Y";
								}
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}	
						}else if(this.state=="ADD"){
							if(offer!=undefined){ //在已开通里面，修改不让关闭
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}else{
								var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已开通里面查找
								if(offerSpec!=undefined){
									$("#del_"+prodId+"_"+this.prodOfferId).hide();
								}else {
									if(ec.util.isObj(this.prodOfferId) && this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){
										//AttachOffer.addOpenList(prodId,this.prodOfferId);			
										AttachOffer.addOfferSpecByCheck(prodId,this.prodOfferId);
									}
								}
							}
						}
					});
				});
			}
		}
	};
	
	//主卡不变副卡新装套餐
	var _removeAndAdd=function(date){
		var viceparam = [];
		var ooRoles =[];
		var params =[];
		viceparam=date.viceParam;
		ooRoles=date.ooRoles;
		params = {viceParam:viceparam,ooRoles:ooRoles,remark:$("#order_remark").val()};
		SoOrder.submitOrder(params);
		
	};
	
	//拆副卡
	var _removeOtherCard = function(accessNumber) {
		var obj = $("#li_viceCard_new_" + accessNumber);		
		if(obj.attr("del") == "N"){	
			$("#label_viceCard_new_"+accessNumber).attr({style:"height:53px;line-height:53px;padding-left:18px;text-decoration:line-through"});
			obj.attr("del","Y").attr("knew","N");
			document.getElementById("button_viceCard_new_" + accessNumber).innerHTML = "不 拆";
			$("#button_"+accessNumber).attr("accNbr",accessNumber);
		}else{
			$("#label_viceCard_new_"+accessNumber).attr({style:"height:53px;line-height:53px;padding-left:18px;text-decoration:''"});
			obj.attr("del","N").attr("knew","N");	
			document.getElementById("button_viceCard_new_" + accessNumber).innerHTML = "拆副卡";			
			$("#button_"+accessNumber).attr("accNbr","");
		}		
	};
	
	return {
		idnum:idnum,
		showOfferCfgDialog : _showOfferCfgDialog,
		closeDialog : _closeDialog,
		submit : _submit,
		offerProd:_offerProd,
		ischooseOffer :_ischooseOffer,
		removeAndAdd :_removeAndAdd,
		queryofferinfo:_queryofferinfo,
		addNum:_addNum,
		checkOrder:_checkOrder,
		checkOfferProd:_checkOfferProd,
		getSimulateData : _getSimulateData,
		fillmemberChange : _fillmemberChange,
		delNum:_delNum,
		reloadFlag: _reloadFlag,
		newSubPhoneNum: _newSubPhoneNum,
		oldSubPhoneNum: _oldSubPhoneNum,
		mktResInstCode:_mktResInstCode,
		newmembers:_newmembers,
		oldmembers:_oldmembers,
		delmembers:_delmembers,
		changemembers:_changemembers,
		rejson:_rejson,	
		removeOtherCard:_removeOtherCard,
		oldMemberFlag:_oldMemberFlag,
		newMemberFlag:_newMemberFlag,
		changeMemberFlag:_changeMemberFlag,
		viceparams:_viceparams,
		ooRoless:_ooRoless,
		queryofferinfoSub:_queryofferinfoSub
	};
}();
$(function(){
	$("#memeberChangeclose").click(function(){
		order.memberChange.closeDialog();
	});
	$("#memeberChange .btna_o:first").click(function(){
		$("#memeberChange .btna_o:first").removeClass("btna_o").addClass("btna_g");
		order.memberChange.submit();
		$("#memeberChange .btna_g:first").removeClass("btna_g").addClass("btna_o");
	});
	$("#memeberChange .btna_o:last").click(function(){
		order.memberChange.closeDialog();
	});
});
CommonUtils.regNamespace("CONST");

//页面常量
CONST = (function(){
	// LTE : 0, MVNO : 1, 其他: -1
	var _APP_DESC = -1; //-1时需要调用后台加载
	
	//裸机销售虚拟客户ID
	var _CUST_COUPON_SALE = "10000";
	
	var _OFFER_FAST_FILL =  "20020054";
	
	//4g标识
	var _OL_TYPE_CD = {
		FOUR_G : 11,
		APP : 15, // app 标示
		LTE : 10,
		UI_LTE : 8,
		ZDYY : 14
	};
	
	//附属销售品标签分类
	var _LABEL = {
		FLOW : "100",
		SERV : "10000"
	};
	
	//产品规格
	var _PROD_SPEC = {
		CDMA : 235010000, // test-235010000 dev-379
		DATA_CARD : 280000000,
		PROD_FUN_4G : "280000020"
	};
	
	//功能产品规格ID
	var _PROD_SPEC_ID={
		MIFI_ID:"235010076", //MIFI 功能产品ID	
		WIRE_GLOBAL : "13409441"
	};
	
	//产品属性
	var _PROD_ATTR = {
		FEE_TYPE : "10020030",
		IS_XINKONG : "40010030", //是否信控
		PROD_USER : "800000011" //使用人
	};
	
	//产品属性值
	var _PROD_ATTR_VALUE = {
		IS_XINKONG_YES : "20",//是否信控 是
		IS_XINKONG_NO : "10" //是否信控 否
	};
	
	//账户属性
	var _ACCT_ATTR = {
			CREDIT_LIMIT : "30010040", //信用额度
			PROTOCOL_NBR : "30020008"//协议号
	};
	
	var _ACCT_ITEM_TYPE = {
		UIM_CHARGE_ITEM_CD:"2014000"
	} ;
	
	var _PROD_CLASS = {
		THREE : 3,
		FOUR : 4
	};
	
	//关联关系原因
	var _RELA_TYPE_CD = {
		MUST : "1000",  //归属关系
		SELECT : "1001", //优惠构成关系
		ZDYY : "100004" //终端预约退订
	};
	
	//销售品退订时产品处理方式
	var _UNSS_PROCESS_MODE = {
		CLOSE : "1000",
		KIP : "1001",
		CHOOSE : "1002"
	};
	
	//产品状态
	var _PROD_STATUS_CD = {
		REMOVE_PROD : 110000,//TODO 拆机，需要找CRM确定拆机产品状态的主数据
		NORMAL_PROD : 100000, //在用
		STOP_PROD : 120000, //停机
		READY_PROD : 140001, //预开通
		DONE_PROD : 140002, //未激活
		NEW_PROD : 130000 //未竣工
	};
	
	//付费类型
	var _PAY_TYPE = { 
		AFTER_PAY : 1200,  //后付费 -后付费用户
		BEFORE_PAY : 2100,  //预付费-预付费用户
		NOLIMIT_PAY : 3100,  //预后不限  -后付费用户，预付费用户
		BEFORE_AFTER_PAY: 2101, //可预可后，默认预付 -后付费用户，预付费用户
		BEFORE_AFTER_QUASIREALTIME_PAY: 3103, //预付+后附+准实时预付费 -后付费用户，准实时预付费用户,预付费用户
		QUASIREALTIME_AFTER_PAY : 3102, //实时预付费+后附 -后付费用户，准实时预付费用户
		AFTER_BEFORE_PAY : 1202, //可预可后，默认后附 -后付费用户，预付费用户
		QUASIREALTIME_BEFORE_PAY: 3101, //预付+准实时预付费 -准实时预付费用户，预付费用户
		QUASIREALTIME_PAY : 1201 //准实时预付费 -准实时预付费用户
	};
	
	//业务动作大类
	var _ACTION_CLASS_CD = {
		CUST_ACTION : 1000,//客户动作
		ACCT_ACTION : 1100,//帐户动作
		OFFER_ACTION : 1200,//销售品动作
		PROD_ACTION : 1300,//产品及服务动作
		MKTRES_ACTION : 1600//产品及服务动作
	};
	
	var _OBJ_TYPE = {
		PROD : 2, //接入类产品
		FUN_PROD : 4, //功能类产品	
		SERV : 4, //功能类产品	
		OFFER : 7 //销售品	
	};
	
	//业务动作小类
	var _BO_ACTION_TYPE = {
		BUY_OFFER : "S1",//订购销售品
		DEL_OFFER : "S2",//退订销售品
		ADDOREXIT_COMP:"S3", //销售品成员变更
		UPDATE_OFFER : "S3",//变更销售品参数
		CUST_CREATE:"C1",//新建客户
		CUSTINFOMODIFY:"C2",//修改客户信息
		ACCT_CREATE : "A1",//帐户创建
		ACCTINFOMODIFY : "A2",//帐户修改
		NEW_PROD : "1",//新装
		UPDATE_ACCNBR : "2",//改号
		REMOVE_PROD : "3",//拆机和预拆机
		PREMOVE_PROD :"4020200000",//预拆机
		SERV_OPEN : "7", //服务开通
		PREMOVE_BACK_PROD :"4070100003",//预拆机复机
		BREAK_RULE_REMOVE_PROD : "4020300002",//TODO 违章拆机 跟CRM确定
		OWE_REMOVE_PROD:"66",//欠费拆机跟crm确定
		NOACTIVE_REMOVE_PROD:"4020400000",//未激活拆机
		DIFF_AREA_CHANGE_CARD:"4040600001",//异地补换卡
		CHANGE_CARD:"14",//补换卡
		LOSSREP_PROD :"1171",//挂失
		DISLOSSREP_PROD :"1172",//解挂
		STOPKEEPNUM:"19",//停机保号
		DISSTOPKEEPNUM:"20",//停机保号复机
		PRODUCT_PASSWORD:"18",//改产品密码
		PRODUCT_PASSWORD_RESET:"4040800003",//产品密码重置（4G目前不区分产品密码修改和重置，该编码目前不使用）
		PRODUCT_PARMS:"1179",//改产品属性，改短号
		PRODUCT_INFOS:"4040100000",//改产品信息（如：改使用人）
		TRANSFER :"11",//过户
		ACTIVERETURN :"1020500000",//产品返档(活卡销售返档)
		TRANSFERRETURN:"4041700000",//产品返档(过户)
		ACTIVERETURNTWO :"4070400000",//产品返档(返档复机)1020500000
		CHANGE_ACCOUNT : "-6",
		ADD_COMP : "998", //加入组合
	    REMOVE_COMP : "999",//退出组合
	    COUPON_SALE : "3010200000", //实物销售
	    RETURN_COUPON : "3030300000", //终端退货
	    EXCHANGE_COUPON : "4040800002", //终端换货
	    CHANGE_FEE_TYPE:"1244", //变更付费类型
	    BUY_BACK:"5010100002", //新装返销
	    BUY_BACK_CHANGE_CARD:"7040100001", //补换卡返销
	    BUY_BACK_ORDER_CONTRACT:"3030200000", //订购合约返销
	    TERMINAL_RESERVATION:"3010300000" ,//终端预约
	    RETURN_TERMINAL : "3030400000" //终端预约取消
	};
	
	//业务动作小类对应的名称
	var _BO_ACTION_TYPE_MAP = {
		"S1" : "订购",
		"1" : "新装",
		"3" : "拆机",
		"4020300002" : "违章拆机",
		"66" : "欠费拆机",
		"4020400000":"未激活拆机",
		"1171":"挂失",
		"1172":"解挂",
		"19":"停机保号",
		"20":"停机保号复机",
		"18":"产品密码修改",
		"4040800003":"产品密码重置",//4G目前不区分产品密码修改和重置，该编码目前不使用
		"C1":"新建客户",
		"C2":"修改客户信息",
		"1179":"修改产品属性",//改短号
		"S3":"主副卡成员变更",
		"11":"过户",
		"1020500000" :"改客户资料返档",
		"4041700000" :"过户返档",
		"-6":"改帐务定制关系",
		"A2":"修改帐户信息",
		"4020200000":"预拆机",
		"4070100003":"预拆机复机",
		"5010100002":"新装返销",
		"2":"改号",
		"7040100001":"补换卡返销",
		"3030200000":"订购合约返销"
	};
	
	//客户交互事件
	var _EVENT = {
		OFFER_BUY : "订购销售品",
		OFFER_DEL : "退订销售品",
		OFFER_UPDATE : "变更销售品 ",
		PROD_NEW : "新装",
		PROD_UPDATE : "变更功能产品",
		PROD_OPEN : "开通功能产品",
		PROD_CLOSE : "关闭功能产品"
	};

	//订单属性
	var _BUSI_ORDER_ATTR = {
		REMOVE_REASON : "111111122",//拆机原因
		DEALER : "111111116",//发展人staffId
		DEALER_NAME : "111111120",//发展人名称
		DEALER_CODE : "111111125",//发展人工号
		REMARK : "111111118",
		orderAttrName :"30010020",//经办人姓名
		orderAttrPhoneNbr :"30010025",//经办人联系号码
		orderIdentidiesTypeCd :"30010026",//经办人证件类型
		orderAttrIdCard :"30010021",//证件号码
		orderAttrAddr :"30010022" ,//经办人证件地址
		EXT_CUST_ID : "20900011", //省内客户实例ID保存在订单属性中的规格ID
		COR_CUST_ID : "30010027", //集团外部客户实例ID保存在订单属性中的规格ID
		EXT_PROD_INST_ID : "30010045", //省内产品实例ID
		COR_PROD_INST_ID : "30010044", //外部产品实例ID
		EXT_COUPON_INST_ID	: "30010047", //营销资源省内实例ID
		COR_COUPON_INST_ID : "30010046", //营销资源外部实例ID
		PROV_ISALE : "40010029",	 //省份isale流水号
		THRETOFOUR_ITEM : "111111199",   //3转4标志
		BUSITYPE_FLAG : "30010024", //购物车业务动作类型
		ZCD_ITEM : "111111198",//是否是暂存单
		SO_NBR : "111111196", //购物车受理流水
		STEP_ORDER_CHARGE_STAFF : "111111197" ,//暂存单收费员工--分段受理
		DELIVERY_TYPE : "800000013" ,//预约类型
		DELIVERY_METHOD : "800000014" ,//提货方式
		DELIVERY_TIME : "800000015" ,//提货时间
		DELIVERY_ADDRESS : "800000016" ,//提货地址
		DELIVERY_POLICY : "800000018", //预约政策
		itemSpecID : "800000036" //客户等级属性标识ID
		
	};
	
	//属性规格
	var _ITEM_SPEC = {
		FEE_TYPE : "10020030",	 //付费方式
		PROT_NUMBER : "11251741"          //协议编码
	};
	
	var _getBoActionTypeName = function(boActionTypeCd) {
		return _BO_ACTION_TYPE_MAP[boActionTypeCd];
	};
	
	//销售品角色类型
	var _MEMBER_ROLE_CD = {
		COMMON_MEMBER : 1,//普通成员
		MAIN_CARD : 400, //天翼主卡
		VICE_CARD : 401, //天翼副卡
		BROADBAND_MAIN_CARD : 500, //基础无线宽带
		BROADBAND_VICE_CARD : 501, //加装无线宽带
		CONTENT : 99991  //内容产品
	};
	//销售品角色类型
	var _MEMBER_ROLE_LIST = [
	    {
	    	MEMBER_ROLE_CD : 1,
	    	MEMBER_ROLE_NAME : "普通成员"
	    },{
	    	MEMBER_ROLE_CD : 400,
	    	MEMBER_ROLE_NAME : "天翼主卡"
	    },{	    	
	    	MEMBER_ROLE_CD : 401,
	    	MEMBER_ROLE_NAME : "天翼副卡"
	    },{	    	
	    	MEMBER_ROLE_CD : 500,
	    	MEMBER_ROLE_NAME : "天翼宽带主卡"
	    },{	    	
	    	MEMBER_ROLE_CD : 501,
	    	MEMBER_ROLE_NAME : "天翼宽带副卡"
	    },{	    
	    	MEMBER_ROLE_CD : 600,
	    	MEMBER_ROLE_NAME : "基础套餐级可选包"
	    },{	    	
	    	MEMBER_ROLE_CD : 601,
	    	MEMBER_ROLE_NAME : "加装套餐级可选包"
	    },{	   
	    	MEMBER_ROLE_CD : 99991,
	    	MEMBER_ROLE_NAME : "内容产品"
	}];
	
	//结果码
	var _CODE = {
		SUCC_CODE : "POR-0000",
		FAIL_CODE : "POR-2004"
	};
	
	//订单提交时，订单部分属性ID 配置成常量，如 订单备注
	var _ITEM_SPEC_ID_CODE = {
		busiOrderAttrs:111111122
	};
	
	//模板类型
	var _TEMPLATE_TYPE = {
		NEW_PROD : 1,
		ATTACH_OFFER_CHANGE : 2,
		OFFER_CHANGE : 5,
		NEW_PROD : 1,
		NEW_PROD : 1
	};
	
	var _CHARGE_ITEM_CD = {
		COUPON_SALE : "2007000", //2007000  实物销售费用项类型
		COUPON_RESERVATION_SALE : "2007002" //2007002  终端预约费用项类型
	};
	
	var _MKTRES_STATUS = {
		USABLE : "1001",
	    HAVESALE:"1115"   //已销售未补贴
	};
	
	var _TERMINAL_SPEC_ATTR_ID = {
		BRAND : 60010002,
		PHONE_TYPE : 60010003,
		COLOR: 60010004,
		TERMINAL_TYPE: 60010013,
		SUPPORT4G: 60010023,
		SUPPORT4NFC: 60010024
	};
	
	var _PAYMETHOD_CD = {
		XIAN_JIN : 100000,
		YIN_HANG : 110000,
		POS : 110100,
		WANG_YIN : 110200,
		TUO_SHOU : 110300,
		ZHI_PIAO : 110400,
		FEN_QI_FU_KUAN : 110500,
		YIN_HANG_DAI_KOU : 110600,
		DI_SAN_FANG_ZHI_FU_PING_TAI : 120000,
		YI_ZHI_FU : 120100,
		ZHI_FU_BAO : 120200,
		TAO_BAO_XIN_YONG_KA : 120201,
		CAI_FU_TONG : 120300,
		QU_DAO_DAI_SHOU : 130000,
		JI_TUAN_DAI_SHOU : 130100,
		ZHENG_QI_DAI_SHOU : 130200,
		ZHANG_WU_DAI_SHOU : 140000,
		HUA_FEI_YU_E : 140100,
		DI_KOU_LEI : 150000,
		DIAN_XIN_KA_DI_KOU : 150100,
		JI_FEN_DI_KOU : 150200,
		TAO_BAO_JI_FEN_DI_KOU : 150201,
		DAI_JIN_QUAN_DI_KOU : 150300,
		HUO_DAO_FU_KUAN : 160000,
		XIAN_JIN_DAO_FU : 160100,
		POS_DAO_FU : 160200
	};
	
	var _DEL_ORDER_FLAG = {
		SILENT_OLID : "silentOlId"
	};
	
	var _getAppDesc = function(){
		if(CONST.APP_DESC== -1 ){
			_setAppDesc();
			return CONST.APP_DESC;
		}else{
			return CONST.APP_DESC;
		}
	};
	
	var _setAppDesc = function(){
		CONST.APP_DESC = globalAppDesc;
	};
	
	var _LTE_PHONE_HEAD = /^(180|189|133|134|153|181|108|170|177)\d{8}$/;
	
	var _MVNO_PHONE_HEAD = /^(170)\d{8}$/;
	
	var  _RELATYPECD = "100003";
		 
	var _YZFservSpecId = 381000960; //翼支付助手产品ID
	
	var _YZFitemSpecId1 = 10020034; //翼支付助手阀值级别属性编码
	var _YZFitemSpecId2 = 10020035; //翼支付助手单次充值额度属性编码
	var _YZFitemSpecId3 = 10020036; //翼支付助手是否需要代扣确认属性编码
	
	//渠道大类
	var _CHANNEL_TYPE_CD ={
			ZQZXDL : 100100,		//政企直销经理
			GZZXDL : 100300,		//公众直销经理
			HYKHZXDL : 100101,		//行业客户直销经理
			SYKHZXDL : 100102,		//商业客户直销经理
			XYKHZXDL:100103,		//校园客户直销经理
			GZZXJL:100301,		//公众直销经理
			ZYOUT:110100,		//自有厅
			ZYINGT:110101,		//直营厅
			WBT:110102		//外包厅
	};
	
	//群产品规格
	var _GROUP_PROD_SPEC = ["381001824","13409900"];
	
	//群功能产品规格ID	旺铺助手（网络版）-235010013	
	var _GROUP_SERV_SPEC_ID=["235010013","381001823"];
	
	//群功能产品对应的群产品
	var _GROUP_SERV_TO_PROD_MAP={
		"235010013" : "10020047",
		"381001823" : "10020047"
	};
	
	//根据群功能产品规格获取群产品规格
	var _getGroupServProdMap = function(servId,itemSpecId) {
		if(_GROUP_SERV_TO_PROD_MAP[servId]==itemSpecId){
			return _GROUP_SERV_TO_PROD_MAP[servId];
		}else{
			return "";
		}
	};
	

	//UIM卡类型
	var _UIMTYPE3G4G = {
		IS4G: "1",
		IS3G: "0"
	};
	
	var _BATCHORDER_FLAG = {
			BATCHORDER_QRY_FLAG : "N",
			BATCHORDER_AUTH_FLAG : "N"
			
	};
	
	return {
		//批量受理查询，是否执行改造后的新代码的开关标识，用于暂时记录是否执行新代码。Y执行改造后的新代码，N执行改造前的旧代码，默认为N。 By ZhangYu 2015-10-20
		BATCHORDER_FLAG : _BATCHORDER_FLAG,
		
		APP_DESC			: _APP_DESC,
		OFFER_FAST_FILL    :  _OFFER_FAST_FILL,
		setAppDesc			: _setAppDesc,
		BO_ACTION_TYPE 		: _BO_ACTION_TYPE,
		ACTION_CLASS_CD 	: _ACTION_CLASS_CD,
		PROD_STATUS_CD 		: _PROD_STATUS_CD,
		BUSI_ORDER_ATTR 	: _BUSI_ORDER_ATTR,
		MEMBER_ROLE_CD 		: _MEMBER_ROLE_CD,
		MEMBER_ROLE_LIST    : _MEMBER_ROLE_LIST,
		PROD_SPEC			: _PROD_SPEC,
		PROD_ATTR			: _PROD_ATTR,
		ACCT_ATTR      : _ACCT_ATTR,
		getBoActionTypeName : _getBoActionTypeName,
		PAY_TYPE			: _PAY_TYPE,
		CODE 				: _CODE,
		OL_TYPE_CD			: _OL_TYPE_CD,
		LABEL				: _LABEL,
		PROD_CLASS			: _PROD_CLASS,
		ITEM_SPEC_ID_CODE	: _ITEM_SPEC_ID_CODE,
		EVENT				: _EVENT,
		TEMPLATE_TYPE 		: _TEMPLATE_TYPE,
		CUST_COUPON_SALE	: _CUST_COUPON_SALE,
		CHARGE_ITEM_CD		: _CHARGE_ITEM_CD,
		MKTRES_STATUS		: _MKTRES_STATUS,
		ITEM_SPEC			: _ITEM_SPEC,
		OBJ_TYPE 			: _OBJ_TYPE,
		ACCT_ITEM_TYPE		: _ACCT_ITEM_TYPE,
		getAppDesc			: _getAppDesc,
		RELA_TYPE_CD		: _RELA_TYPE_CD,
		UNSS_PROCESS_MODE	: _UNSS_PROCESS_MODE,
		TERMINAL_SPEC_ATTR_ID : _TERMINAL_SPEC_ATTR_ID,
		PAYMETHOD_CD		: _PAYMETHOD_CD,
		DEL_ORDER_FLAG		: _DEL_ORDER_FLAG,
		PROD_SPEC_ID        : _PROD_SPEC_ID,
		LTE_PHONE_HEAD : _LTE_PHONE_HEAD,
		MVNO_PHONE_HEAD : _MVNO_PHONE_HEAD,
		RELATYPECD : _RELATYPECD,
		YZFservSpecId : _YZFservSpecId,
		YZFitemSpecId1 : _YZFitemSpecId1,
		YZFitemSpecId2 : _YZFitemSpecId2,
		YZFitemSpecId3 : _YZFitemSpecId3,
		CHANNEL_TYPE_CD : _CHANNEL_TYPE_CD,
		GROUP_SERV_SPEC_ID:_GROUP_SERV_SPEC_ID,
		GROUP_PROD_SPEC:_GROUP_PROD_SPEC,
		getGroupServProdMap:_getGroupServProdMap,
		CHANNEL_TYPE_CD : _CHANNEL_TYPE_CD,
		UIMTYPE3G4G:_UIMTYPE3G4G,
		PROD_ATTR_VALUE : _PROD_ATTR_VALUE
	};
})();

//初始化
$(function(){
	CONST.getAppDesc();
});
/**
 * 系统配置等通用信息查询
 * 没有任何业务逻辑
 * @author wukf
 * date 2014-07-29
 */
CommonUtils.regNamespace("query","common");

query.common = (function() {
	
	/**
	 * 查询门户层配置信息
	 * @String  configParamType 门户配置类型
	 * @callBackFun 回调函数
	 */
	var _queryApConfig = function(configParamType,callBackFun){
		var url= contextPath+"/order/queryApConf";
		var configParam={"CONFIG_PARAM_TYPE" : configParamType};
		if(typeof(callBackFun)=="function"){			
			$.callServiceAsJsonGet(url, configParam,{				
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询门户层配置信息失败,稍后重试");
					}
				}
			});
		}
	};

	return {
		queryApConfig			: _queryApConfig
	};
})();
/**
 * 订单信息对象
 * 
 * @author wukf
 */
CommonUtils.regNamespace("OrderInfo");

/** 订单信息对象*/
OrderInfo = (function() {
	
	/*
	 * 每个功能点标识，0是产品变更等单业务动作订单提交，1新装，2变更,3可选包变更,4客户资料变更 5.拆副卡
	 * 
	 * 6 销售品成员变更加装副卡，7 拆主卡保留副卡 8单独新建客户,10 是公用节点传入 11 撤单，12 加入退出组合 
	 * 
	 * 13 购买裸机  14 合约套餐  15 补退费  16 改号	17 终端退货 18 终端换货 19返销 20返销,22补换卡,23异地补换卡
	 * 
	 * 31改产品密码，32重置产品密码，,33改产品属性，34修改短号，
	 * 
	 */
	var _actionFlag = 0;
	
	/*购物车业务动作
	1 新装
	2  套餐变更
	3  主副卡成员变更
	4  产品属性变更
	5  挂失/解挂
	6  停机保号/复机
	7  预拆机
	8  拆机
	9  违章拆机
	10  未激活拆机
	11  欠费拆机
	12  改客户资料返档
	13  补换卡
	14  可选包退订/订购
	15 过户
	16 改账务定制关系
	17 改产品密码*/
	
	var _busitypeflag = 0;
	
	var _orderlonger = "";
	
	var _custorderlonger = "";
	
	var _oldprodAcctInfos = [];
	var mktResInstCode="";  //保存uim卡
	//终端串码
	var _terminalCode="";
	//发展人
	var _salesCode="";
	var _provinceInfo={
		provIsale:"",
		redirectUri:"",
		isFee:"1",
		extCustOrderID:"",
		reloadFlag:"",
		prodOfferId:"",
		prodOfferName:"",
		mktResInstCode:"",
		codeMsg:"",
		mergeFlag:"0"
	}
			
	var _reloadOrderInfo;
	//新装是否带出主副卡号码
	var _newOrderNumInfo = {
		mainPhoneNum:"",
		newSubPhoneNum:"",
		oldSubPhoneNum:"",
		mktResInstCode:""
	}
	var _channelList = [];//渠道列表
	//新装二次加载功能参数
	var _reloadProdInfo={
			  prodOfferId:"",
			  cardNum:"",
			  checkMaskList:[],//是否信控信息
			  feeType:"",//付费方式
			  orderMark:"",//备注
			  isReloadFlag:"",
			  reloadFlag:"",
			  objInstId:"",//发展人id信息
			  dealerlist:[],//发展人填单信息
			  paymentAcctTypeCd:"",
			  mailingType:"",//投递方式
			  bankAcct:"",
			  bankId:"",
			  limitQty:"",
			  paymentMan:"",
			  param1:"",//投递地址
			  param2:"",//投递周期
			  param3:"",
			  param7:"" //账单内容
			  
		}

	//新装二次加载参数定义
	var _newOrderInfo={
		  result:{},
		  checkMaskList:[],//是否信控信息
		  prodOfferId:"",
		  prodOfferName:"",
		  isReloadFlag:"",
		  paymentAcctTypeCd:"",
		  mailingType:"",//投递方式
		  bankAcct:"",
		  bankId:"",
		  limitQty:"",
		  paymentMan:"",
		  param1:"",//投递地址
		  param2:"",//投递周期
		  param3:"",
		  param7:"", //账单内容
		  isLastFlag:""//判断是否需要上一步功能
		  
	}
	
	var _checkUimData = []; //保存UIM校验后的返回数据
	var _cust = { //保存客户信息
		custId : "",
		partyName : "",
		vipLevel : "",
		vipLevelName : "",
		custFlag :"1100"//1000：红客户，1100：白客户，1200：黑客户
	}; 
	
	var _staff = { //员工登陆信息
		staffId : 0,  //员工id
		channelId : 0,   //受理渠道id
		channelName: "",
		areaId : 0,    //受理地区id
		areaCode : 0,
		soAreaId : 0,    //新装受理地区id
		soAreaCode : 0, 
		distributorId : "" //转售商标识
	}; 
		
	var _offerSpec = {}; //主销售品构成
	
	var _offer = { //主销售品实例构成
		offerId : "",
		offerSpecId : "",
		offerMemberInfos : []
	}; 
	
	var _offerProdInst = { //主销售品实例构成查副卡信息
		offerId : "",
		offerSpecId : "",
		offerMemberInfos : []
	}; 
	
	var _actionClassCd = 0; //业务动作大类,订单初始化时赋值
	
	var _boActionTypeCd = ""; //业务动作小类,订单初始化时赋值
	
	var _actionTypeName = "订购"; //业务动作名称
	
	var _businessName = ""; //业务名称

	var _password_remark="";//lte产品密码鉴权
	
	var _confirmList = []; //保存特殊业务，确认页面展示使用
	
	var _orderResult = {};  //订单提交，返回结果报存
	
	var _checkresult = [];

	var _orderData = {}; //订单提交完整节点
	
	var _order = {  //订单常用全局变量
		dealerType : "",   //保存发展人类型
		soNbr : "", //购物车流水
		oldSoNbr : "", //撤单时用于保存选中某个订单的购物车流水
		oldSoId : "",//撤单时用于保存选中某个订单的购物车ID
		step : 0 , //页面步骤
		token : "", // 防止订单重复提交
		templateType : 1,   //模板类型: 0批量开活卡,1批量新装 ,2批量订购/退订附属, 3组合产品纳入退出 ,4批量修改产品属性,5批量换挡 ,8拆机 ,9批量修改发展人
		dealerTypeList : [] ////发展人类型列表
	};
	
	//权限控制
	var  _privilege = {
		effTime : ""
	};
	
	//序列号
	var _SEQ = {
		seq : -1,  //序列号，来区分每个业务对象动作,每次减1
		offerSeq : -1,  //序列号，用来实例化每个是销售品,每次减1
		prodSeq : -1,  //序列号，用来实例化每个是产品,每次减1
		servSeq : -1,  //序列号，用来实例化每个是服务,每次减1
		itemSeq : -1,  //序列号，用来实例化每个是产品属性,每次减1
		acctSeq : -1,  //序列号，用来实例化每个是帐户,每次减1
		acctCdSeq : -1,  //序列号，用来实例化每个是帐户合同号,每次减1
		paramSeq : -1,  //序列号，用来实例化每个附属销售品参数的每个值,每次减1
		atomActionSeq : -1,  //序列号，用来实例化每个原子动作的每个值,每次减1
		offerMemberSeq : -1, //序列号，用来实例化每个角色成员的每个值,每次减1
		dealerSeq : 1   //协销人序列号，
	};
	
	//清空校验UIM返回数据
	var _clearCheckUimData = function(prodId){
		for (var i = 0; i < OrderInfo.checkUimData.length; i++) {
			var td = OrderInfo.checkUimData[i];
			if(td.prodId == prodId){
				OrderInfo.checkUimData.splice(i,1);
			}
		}
	};
	
	//获取校验UIM返回数据
	var _getCheckUimData = function(prodId){
		for (var i = 0; i < OrderInfo.checkUimData.length; i++) {
			var td = OrderInfo.checkUimData[i];
			if(td.prodId == prodId){
				return td;
			}
		}
		return "";
	};
	/**
	 * 获取渠道List
	 */
	var _getChannelList = function (busiOrders,offer,prodId){
		OrderInfo.channelList = [];
		if($("i[name='channel_iofo_i']").length==0){
			OrderInfo.channelList = window.parent.OrderInfo.getChannelList();
		}else{
			$("i[name='channel_iofo_i']").each(function(){				
				var channelId = $(this).attr("channel_Id");
				var channelName = $(this).attr("channel_Name");
				var channelNbr = $(this).attr("channel_Nbr");
				var isSelect = 0;
				if($(this).hasClass("select"))
					var isSelect = 1;
				var channelInfo ={
						channelId : channelId,
						channelName : channelName,
						channelNbr : channelNbr,
						isSelect : isSelect
				}
				OrderInfo.channelList.push(channelInfo)
			});
		}
		return OrderInfo.channelList;
	};
	var _boCusts = []; //客户信息节点

	var _boProdItems = []; //产品属性节点列表
		
	var _boProdPasswords = []; //产品密码节点列表

	var _boProdAns = []; //号码信息节点列表
	
	var _boProd2Tds = []; //UIM卡节点信息列表
	
	var _boProd2OldTds = []; //保存旧UIM卡节点信息列表
	
	var _bo2Coupons = []; //物品信息节点
	
	var _attach2Coupons = []; //附属销售品需要的物品信息
	
	var _prodAttrs = []; //保存查询产品规格属性时返回的信息
	
	//创建一个订单完整节点
	var _getOrderData = function(){
		//订单提交完整节点
		var data = { 
			orderList : {
				orderListInfo : { 
					isTemplateOrder : "N",   //是否批量
					templateType : OrderInfo.order.templateType,  //模板类型: 1 新装；8 拆机；2 订购附属；3 组合产品纳入/退出
					staffId : OrderInfo.staff.staffId,
					channelId : OrderInfo.staff.channelId,  //受理渠道id
					areaId : OrderInfo.staff.soAreaId,
					partyId : -1,  //新装默认-1
					distributorId : OrderInfo.staff.distributorId, //转售商标识
					olTypeCd : CONST.OL_TYPE_CD.UI_LTE  //4g标识
				},
				custOrderList :[{busiOrder : []}]   //客户订购列表节点
			}
		};
		OrderInfo.orderData = data;
		return OrderInfo.orderData;
	};		
		
	//创建客户节点
	var _createCust = function(busiOrders) {
		var accNbr = _getAccessNumber(-1);
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : -1 //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.CUST_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.CUST_CREATE
			}, 
			data:{
				boCustInfos : [],
				boCustIdentities : [],
				boPartyContactInfo : []
			}
		};
		if(ec.util.isObj(accNbr)){ //接入号
			busiOrder.busiObj.accessNumber = accNbr;
		}
		busiOrder.data.boCustInfos.push(OrderInfo.boCustInfos);
		busiOrder.data.boCustIdentities.push(OrderInfo.boCustIdentities);
		if($("#tabProfile0").attr("click")=="0"&&($("#contactName").val()!="")){
			busiOrder.data.boPartyContactInfo.push(OrderInfo.boPartyContactInfo);
		}
		
		if(OrderInfo.boCustProfiles!=undefined && OrderInfo.boCustProfiles!=""){
			busiOrder.data.boCustProfiles = [];
			busiOrder.data.boCustProfiles = OrderInfo.boCustProfiles;
		}
		busiOrders.push(busiOrder);
	};
	
	//创建帐户节点
	var _createAcct = function(busiOrders,acctId) {
		var acctName = $("#acctName").val();
		var paymentType = $("#paymentType").val();  //100000现金，110000银行
		var bankId = "";
		var bankAcct = "";
		var paymentMan = "";
		if(paymentType==110000){ //银行
			bankId = $("#bankId").val(); //银行ID
			bankAcct = $("#bankAcct").val(); //银行帐号
			paymentMan = $("#paymentMan").val(); //支付人
		}
		
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq-- 
			}, 
			busiObj : { //业务对象节点
				instId : acctId //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.ACCT_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.ACCT_CREATE
			}, 
			data : {
				boAccountInfos : [{  //帐户节点
					partyId : OrderInfo.cust.custId, //客户ID
					acctName : acctName, //帐户名称
					acctCd : acctId, //帐户CD
					acctId : acctId, //帐户ID
					businessPassword : "111111", //业务密码
					state : "ADD", //动作
					acctTypeCd : "1" // 默认1
				}],
				boPaymentAccounts : [{ //帐户托收节点
					paymentAcctTypeCd : paymentType, //类型
					bankId : bankId, //银行ID
					bankAcct : bankAcct, //银行帐户ID
					paymentMan : paymentMan, //付费人
					limitQty : "1", //数量
					state : "ADD" //动作
				}],
				boAcct2PaymentAccts : [{ //帐户付费关联关系节点
					priority : "1", //优先级
					state : "ADD" //动作
				}],
				boAccountItems : [],
				boAccountMailings : [] //账单投递信息节点	
			}
		};
		var accNbr = _getAccessNumber(-1);
		if(ec.util.isObj(accNbr)){ //接入号
			busiOrder.busiObj.accessNumber = accNbr;
		}
		//若选择了银行托收且填写了银行账户协议号则将该信息录入
		if($("#paymentType").val()==110000 && $.trim($("#protocalNbr").val())!=""){
			var boAccountItem_protocalNbr = {
					itemSpecId : CONST.ACCT_ATTR.PROTOCOL_NBR,  //账户属性：银行账户协议号 - 规格ID
					value : $.trim($("#protocalNbr").val()),
					state : "ADD"	
			};
			busiOrder.data.boAccountItems.push(boAccountItem_protocalNbr);
		}
		//若选择投递账单，则录入该信息
		if($("#postType").val()!=-1){
			var boAccountMailing = {
					mailingType : $("#postType").val(),   //*投递方式
					param1 : $("#postAddress").val(),     //*投递地址
					param2 : "1",                         //格式ID
					param3 : $("#postCycle").val(),       //*投递周期
					param7 : $("#billContent").val(),     //*账单内容
					state : "ADD"
			};
			if($("#postType").val()==11 || $("#postType").val()==15){				
				boAccountMailing.param1 = $("#postAddress").val()+","+$("#zipCode").val()+" , "+$("#consignee").val(); //*收件地址,邮编,收件人			
			}
			busiOrder.data.boAccountMailings.push(boAccountMailing);
		}
		busiOrders.push(busiOrder);
	};
	
	/**
	 * 获取销售品节点
	 * busiOrders 业务对象节点
	 * offer 销售品节点
	 * prodId 产品id
	 */
	var _getOfferBusiOrder = function (busiOrders,offer,prodId){
		var accNbr = _getAccessNumber(prodId);
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prodId),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq-- 
			}, 
			busiObj : { //业务对象节点
				instId : offer.offerId,  //业务对象实例ID
				objId : offer.offerSpecId,  //业务规格ID
				offerTypeCd : offer.offerTypeCd //2附属销售品
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : offer.boActionTypeCd
			}, 
			data:{}
		};
		
		if(ec.util.isObj(offer.offerSpecName)){ //销售品名称
			busiOrder.busiObj.objName = offer.offerSpecName;
		}
		if(ec.util.isObj(accNbr)){ //接入号
			busiOrder.busiObj.accessNumber = accNbr;
		}
		
		if(offer.boActionTypeCd == CONST.BO_ACTION_TYPE.BUY_OFFER){ //订购销售品
			//发展人
			var $tr = $("li[name='tr_"+prodId+"_"+offer.offerSpecId+"']");
			if($tr!=undefined&&$tr.length>0){
				busiOrder.data.busiOrderAttrs = [];
				$tr.each(function(){   //遍历产品有几个发展人
					var dealer = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("staffid"),
						channelNbr : $(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()
					};
					busiOrder.data.busiOrderAttrs.push(dealer);
					var dealer_name = {
							itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
							role : $(this).find("select").val(),
							value : $(this).find("input").attr("value") 
					};
					busiOrder.data.busiOrderAttrs.push(dealer_name);
				});
			}
			//所属于人节点
			busiOrder.data.ooOwners = [];
			busiOrder.data.ooOwners.push({
				partyId : OrderInfo.cust.custId, //客户对象ID
				state : "ADD" //动作
			});
			//销售参数节点
			if(ec.util.isArray(offer.offerSpecParams)){  
				busiOrder.data.ooParams = [];
				$.each(offer.offerSpecParams,function(){
					if(this.setValue==undefined){
						this.setValue = this.value;
					}
					if(ec.util.isObj(this.setValue)){
						var ooParam = {
			                itemSpecId : this.itemSpecId,
			                offerParamId : OrderInfo.SEQ.paramSeq--,
			                offerSpecParamId : this.offerSpecParamId,
			                value : this.setValue,
			                state : "ADD"
			            };
						busiOrder.data.ooParams.push(ooParam);
					}
				});		
			}
			
			//销售生失效时间节点
			if(offer.ooTimes !=undefined ){  
				busiOrder.data.ooTimes = [];
				busiOrder.data.ooTimes.push(offer.ooTimes);
			}
			//销售品物品节点
			$.each(OrderInfo.attach2Coupons,function(){
				if(offer.offerSpecId == this.attachSepcId && prodId==this.prodId){
					this.offerId = offer.offerId;
					busiOrder.data.bo2Coupons = [];
					busiOrder.data.bo2Coupons.push(this);
					return false;
				}	
			});
			//销售品成员角色节点
			busiOrder.data.ooRoles = [];
			//遍历附属销售品构成
			if(ec.util.isArray(offer.offerRoles)){
				$.each(offer.offerRoles,function(){
					var offerRole = this;
					$.each(this.roleObjs,function(){
						var ooRoles = {
							prodId : prodId, //产品id
							offerRoleId : offerRole.offerRoleId, //销售品角色ID
							objId : this.objId, //规格id
							objType : this.objType, // 业务对象类型
							relaType : this.relaTypeCd,
							state : "ADD" //动作
						};
						var flag = true;
						if(this.objType == CONST.OBJ_TYPE.PROD){ //产品
							var prodSpecId = OrderInfo.getProdSpecId(prodId);
							if(prodSpecId==this.objId || prodSpecId==""){//兼容省份空规格
								ooRoles.objInstId = prodId;//业务对象实例ID
							}else{
								return true;
							}
						}else if(this.objType == CONST.OBJ_TYPE.SERV){ //服务
							var serv = CacheData.getServBySpecId(prodId,this.objId); //从服务实例中取值
							if(serv!=undefined){
								ooRoles.objInstId = serv.servId;
							}else{
								var servSpec = CacheData.getServSpec(prodId,this.objId); //从服务规格中取值
								if(servSpec!=undefined && servSpec.isdel!="Y" && servSpec.isdel != "C" && servSpec.servId!=undefined && servSpec.servId!=""){
									ooRoles.objInstId = servSpec.servId;
								}else{
									flag = false;
								}
							}
						}else { // 7销售品
							ooRoles.objInstId = OrderInfo.SEQ.offerSeq--;//业务对象实例ID
						}
						if(flag){
							busiOrder.data.ooRoles.push(ooRoles);
						}
					});
				});
			}
			busiOrders.push(busiOrder);
		}else if(offer.boActionTypeCd == CONST.BO_ACTION_TYPE.DEL_OFFER){ //退订销售品
			busiOrder.data.ooOwners = [];
			busiOrder.data.ooOwners.push({
				partyId : OrderInfo.cust.custId, //客户对象ID
				state : "DEL" //动作
			});
			if(ec.util.isArray(offer.offerMemberInfos)){ //遍历主销售品构成
				busiOrder.data.ooRoles = [];
				$.each(offer.offerMemberInfos,function(){
					var ooRoles = {
						objId : this.objId, //业务规格ID
						objInstId : this.objInstId, //业务对象实例ID,新装默认-1
						objType : this.objType, // 业务对象类型
						offerRoleId : this.offerRoleId, //销售品角色ID
						state : "DEL" //动作
					};
					if(this.objType != CONST.OBJ_TYPE.PROD){ //不是接入产品
						ooRoles.prodId = prodId;//业务对象实例ID
					}
					if(this.offerMemberId!=undefined){  //兼容两级接口
						ooRoles.offerMemberId = this.offerMemberId; //成员id
					}
					busiOrder.data.ooRoles.push(ooRoles);
				});
			}
			if(offer.isRepeat!="Y"){//是否是用一个实例的销售品（用于3转4的预校验判断）
				busiOrders.push(busiOrder);
			}
		}else if(offer.boActionTypeCd == CONST.BO_ACTION_TYPE.UPDATE_OFFER){ //销售品成员变更,改参数
			if(offer.isUpdate=="Y"){ //销售品成员变更
				busiOrder.data.ooRoles = offer.data;
			}else{
				if(ec.util.isArray(offer.offerSpec.offerSpecParams)){
					busiOrder.data.ooParams = [];
					$.each(offer.offerSpec.offerSpecParams,function(){
						if(this.isUpdate=="Y"){
							if(ec.util.isObj(this.value)){
								var delParam = {
					                itemSpecId : this.itemSpecId,
					                offerParamId : this.offerParamId,
					                offerSpecParamId : this.offerSpecParamId,
					                value : this.value,
					                state : "DEL"
					            };
								busiOrder.data.ooParams.push(delParam);
							}
							if(ec.util.isObj(this.setValue)){
								var addParam = {
					                itemSpecId : this.itemSpecId,
					                offerParamId : OrderInfo.SEQ.paramSeq--,
					                offerSpecParamId : this.offerSpecParamId,
					                value : this.setValue,
					                state : "ADD"
					            };
					            busiOrder.data.ooParams.push(addParam);
							}
						}
					});	
				}
			}
			busiOrders.push(busiOrder);
		}
	};
			

	/*
	 * 获取产品节点
	 * @param  prodId 产品ID
	 * @param  servSpecName 产品名称
	 * @param  isComp  是否组合
	 * @param  boActionTypeCd  动作类型
	 */
	var _getProdBusiOrder = function (prodServ){
		var accNbr = _getAccessNumber(prodServ.prodId);
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prodServ.prodId),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq-- 
			}, 
			busiObj : { //业务对象节点
				objId : OrderInfo.getProdSpecId(prodServ.prodId),  //业务对象ID
				instId : prodServ.prodId //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,
				boActionTypeCd : prodServ.boActionTypeCd
			}, 
			data:{}
		};
		if(ec.util.isObj(prodServ.isComp)){ //是否组合
			busiOrder.busiObj.isComp = prodServ.isComp;
		}
		if(ec.util.isObj(accNbr)){ //接入号码
			busiOrder.busiObj.accessNumber = accNbr;
		}
		
		if(prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.PRODUCT_PARMS){ //改产品属性
			if(ec.util.isArray(prodServ.prodSpecParams)){
				busiOrder.data.boServOrders = [];
				busiOrder.data.boServOrders.push({
					servId: prodServ.memberId,
                    servSpecId: prodServ.servSpecId
				});
				busiOrder.data.boServItems = [];
				$.each(prodServ.prodSpecParams,function(){
					if(this.isUpdate=="Y"){
						if(ec.util.isObj(this.value)){
							var delParam = {
				                itemSpecId : this.itemSpecId,
				                servId : prodServ.memberId,
				                value : this.value,
				                state : "DEL"
				            };
							busiOrder.data.boServItems.push(delParam);
						}
						if(ec.util.isObj(this.setValue)){
							var addParam = {
				                itemSpecId : this.itemSpecId,
				                servId : prodServ.memberId,
				                value : this.setValue,
				                state : "ADD"
				            };
							busiOrder.data.boServItems.push(addParam);	
						}
					}
				});
			}
		}else if(prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.SERV_OPEN){  //服务开通或关闭
			var state = "ADD";
			if(prodServ.servClose == "Y"){ //服务关闭
				state = "DEL";
			}else {
				if(prodServ.servSpecId == undefined && prodServ.objId != undefined){
					prodServ.servSpecId = prodServ.objId;  //服务开通
				}
			}
			var servOrder = {
				servId: prodServ.servId,
                servSpecId: prodServ.servSpecId
			};
			if(ec.util.isObj(prodServ.servSpecName)){ //产品名称
				servOrder.servSpecName = prodServ.servSpecName;
			}
			busiOrder.data.boServOrders = [];
			busiOrder.data.boServOrders.push(servOrder);
			
			busiOrder.data.boServs = [];
			busiOrder.data.boServs.push({
				servId: prodServ.servId,
                state: state
			});
			if(prodServ.servClose != "Y"){ //服务开通
				if(ec.util.isArray(prodServ.prodSpecParams)){
					busiOrder.data.boServItems = [];
					$.each(prodServ.prodSpecParams,function(){
						if(this.setValue==undefined){
							this.setValue = this.value;
						}
						var feeType = $("select[name='pay_type_-1']").val();
						if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
						if(prodServ.servSpecId == CONST.YZFservSpecId && feeType == CONST.PAY_TYPE.AFTER_PAY){
							this.setValue = "";
						}
						if(ec.util.isObj(this.setValue)){
							var addParam = {
				                itemSpecId : this.itemSpecId,
				                servId : prodServ.servId,
				                value : this.setValue,
				                state : state
				            };
				            busiOrder.data.boServItems.push(addParam);
						}
					});
				}
				
				//发展人
				/*var $tr = $("tr[name='tr_"+prodId+"_"+prodServ.servSpecId+"']");
				if($tr!=undefined&&$tr.length>0){
					if(!ec.util.isArray(busiOrder.data.busiOrderAttrs)){
						busiOrder.data.busiOrderAttrs = [];
					}
					$tr.each(function(){   //遍历产品有几个发展人
						var dealer = {
							itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
							role : $(this).find("select").val(),
							value : $(this).find("input").attr("staffid") 
						};
						busiOrder.data.busiOrderAttrs.push(dealer);
					});
				}*/
			}
		}else if(prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.REMOVE_PROD){  //拆机
			busiOrder.data.boProdStatuses = [{ 
				prodStatusCd : CONST.PROD_STATUS_CD.NORMAL_PROD,
				state : "DEL"
			},{prodStatusCd : CONST.PROD_STATUS_CD.REMOVE_PROD,
				state : "ADD"
			}];
		}else if(prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.CHANGE_CARD ||
				prodServ.boActionTypeCd == CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD){  //补换卡	
			var proUim = OrderInfo.getProdUim(prodServ.prodId); //获取新卡
			if(ec.util.isObj(proUim.prodId)){ //有新卡
				busiOrder.data.bo2Coupons = [];
				busiOrder.data.bo2Coupons.push(proUim);
				busiOrder.data.bo2Coupons.push(OrderInfo.getProdOldUim(prodServ.prodId));
			}else if(OrderInfo.zcd_privilege==0){//暂存信息 只录入老卡
				busiOrder.data.bo2Coupons = [];
				busiOrder.data.bo2Coupons.push(OrderInfo.getProdOldUim(prodServ.prodId));
			}else{
				return false;
			}
 		}
		return busiOrder;
	};
	
	/**
	 * 设置产品修改类通用服务
	 * busiOrders 业务对象节点
	 * data 数据节点
	 */
	var _setProdModifyBusiOrder = function(busiOrders,data) {	
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息 
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				objId : prodInfo.productId,//prodInfo.productId, //业务对象规格ID
				instId : prodInfo.prodInstId, //业务对象实例ID
				accessNumber : prodInfo.accNbr  //业务号码
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		busiOrder.data =data;
		busiOrders.push(busiOrder);
	};
	
	//获取产品跟可选包的关联关系
	/*var _getRelaType = function(servSpecId){
		var relaType = "";
		//遍历已开通附属销售品列表
		$.each(AttachOffer.openList,function(){
			$.each(this.specList,function(){
				$.each(this.offerRoles,function(){
					$.each(this.roleObjs,function(){
						if(this.objId==servSpecId){
							relaType = this.relaTypeCd;
							return false;
						}
					});
				});
			});
		});
		return relaType;
	};*/
	
	//客户信息节点
	var _boCustInfos = {
		areaId : 0,
		defaultIdType:"1",//证件类型
		businessPassword : "", //客户密码
		name : "", //	客户名称
		partyTypeCd : 1,//客户类型
		state : "ADD", //状态
		telNumber : "",  //联系电话
		addressStr:"",//客户地址
		mailAddressStr:""//通信地址
	};
	
	//客户证件节点
	var _boCustIdentities = {
		identidiesTypeCd : "1", //证件类型
		identityNum : "", //证件号码
		isDefault : "Y", //是否首选
		state : "ADD"  //状态
	};

	//客户联系人节点
	var _boPartyContactInfo = {
		contactAddress : "",//参与人的联系地址
        contactDesc : "",//参与人联系详细信息
        contactEmployer  : "",//参与人的联系单位
        contactGender  : "",//参与人联系人的性别
        contactId : "",//参与人联系信息的唯一标识
        contactName : "",//参与人的联系人名称
        contactType : "",//联系人类型
        eMail : "",//参与人的eMail地址
        fax : "",//传真号
        headFlag : "",//是否首选联系人
        homePhone : "",//参与人的家庭联系电话
        mobilePhone : "",//参与人的移动电话号码
        officePhone : "",//参与人办公室的电话号码
        postAddress : "",//参与人的邮件地址
        postcode : "",//参与人联系地址的邮政编码
        staffId : 0,//员工ID
        state : "",//状态
        statusCd : "100001"//订单状态
	};
	
	//客户属性
	var _boCustProfiles = {};
	
	//初始化序列
	var _resetSeq = function(){
		OrderInfo.SEQ.seq = -1;  
		OrderInfo.SEQ.offerSeq = -1; 
		OrderInfo.SEQ.prodSeq = -1;  
		OrderInfo.SEQ.servSeq = -1;  
		OrderInfo.SEQ.itemSeq = -1;  
		OrderInfo.SEQ.acctSeq = -1;  
		OrderInfo.SEQ.acctCdSeq = -1;  
		OrderInfo.SEQ.paramSeq = -1;  
		OrderInfo.SEQ.atomActionSeq = -1;
		//OrderInfo.SEQ.dealerSeq = 1;
	};
	
	//初始化数据
	var _resetData = function(){
		OrderInfo.boProdAns = [];  
		OrderInfo.boProd2Tds = []; 
		//OrderInfo.boProd2OldTds = []; 
		OrderInfo.bo2Coupons = [];
		AttachOffer.openList = [];
		AttachOffer.openedList = [];
		AttachOffer.openServList = [];
		AttachOffer.openedServList = [];
		AttachOffer.openAppList = [];
		AttachOffer.labelList = [];
		OrderInfo.confirmList = [];
		OrderInfo.orderResult = {}; 
		/*OrderInfo.offerSpec = {}; //主销售品构成
		OrderInfo.offer = { //主销售品实例构成
			offerId : "",
			offerSpecId : "",
			offerMemberInfos : []
		}; */
		OrderInfo.order.step = 1;   //填单页面步骤为1
	};
	
	//初始化基础数据，actionClassCd 动作大类，boActionTypeCd 动作小类，actionFlag 受理类型，actionTypeName 动作名称，批量模板使用 templateType
	var _initData = function(actionClassCd,boActionTypeCd,actionFlag,actionTypeName,templateType){
		if(actionClassCd!=""&&actionClassCd!=undefined){
			OrderInfo.actionClassCd = actionClassCd;
		}
		if(boActionTypeCd!=""&&boActionTypeCd!=undefined){
			OrderInfo.boActionTypeCd = boActionTypeCd;
		}
		if(actionFlag!=undefined){
			OrderInfo.actionFlag = actionFlag;
		}
		if(actionTypeName!=""&&actionTypeName!=undefined){
			OrderInfo.actionTypeName = actionTypeName;
		}
		if(templateType!=""&&templateType!=undefined){
			OrderInfo.order.templateType = templateType;
		}
	};
	
	//获取号码
	var _getProdAn = function(prodId){
		var prodAn = {};
		for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
			var an = OrderInfo.boProdAns[i];
			if(an==undefined){
				continue;
			}else{
				if(an.prodId == prodId){
					prodAn = an;
				}
			}
		}
		return prodAn;
	};

	//获取号码
	var _setProdAn = function(prodId,an){
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			$.each(this.prodInsts,function(){
				if(this.prodInstId == prodId){
					this.an = an;
					return false;
				}
			});
		});
	};
	
	
	//获取选号对应的地区
	var _getProdAreaId = function(prodId){
		if(prodId!=undefined && prodId>0){ //二次业务
			
			if(OrderInfo.actionFlag==1)
			 {
				return OrderInfo.cust.areaId;
			}
			else{
				var areaId = order.prodModify.choosedProdInfo.areaId;
				if(areaId == undefined || areaId==""){
					$.alert("错误提示","产品信息未返回地区ID，请营业后台核实！");
					return ; 
				}
				return areaId;
			}
			
		}else { //新装
			if(ec.util.isObj(OrderInfo.cust.areaId)){
				return OrderInfo.cust.areaId;
			}else{
				return OrderInfo.staff.soAreaId;
			}
		}
	};
	
	//获取订单地区ID
	var _getAreaId = function(){
		//默认使用受理地区
		var areaId = OrderInfo.staff.soAreaId;		
		//裸机销售，终端退换货不需要定位客户，使用默认的受理地区
		if(OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){			
		}
		//新装，合约机新装，客户资料修改，使用客户归属地区
		else if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14 || OrderInfo.actionFlag==4 || OrderInfo.actionFlag==9){
			if(ec.util.isObj(OrderInfo.cust.areaId)){
				areaId = OrderInfo.cust.areaId;
			}
		}		
		//其他二次业务使用产品的归属地区			
		else if(ec.util.isObj(order.prodModify.choosedProdInfo.areaId)){				
			areaId = order.prodModify.choosedProdInfo.areaId;			
		}	
		return areaId;
	};
		
	//获取uim对象
	var _getProdOldUim = function(prodId){
		for (var i = 0; i < OrderInfo.boProd2OldTds.length; i++) {
			var td = OrderInfo.boProd2OldTds[i];
			if(td.prodId == prodId){
				return td;
			}
		}
		return {};
	};
	
	//获取uim对象
	var _getProdUim = function(prodId){
		for (var i = 0; i < OrderInfo.boProd2Tds.length; i++) {
			var td = OrderInfo.boProd2Tds[i];
			if(td.prodId == prodId){
				return td;
			}
		}
		return {};
	};
	
	//清空旧uim
	var _clearProdUim = function(prodId){
		for (var i = 0; i < OrderInfo.boProd2Tds.length; i++) {
			var td = OrderInfo.boProd2Tds[i];
			if(td.prodId == prodId){
				OrderInfo.boProd2Tds.splice(i,1);
			}
		}
	};
	
	//获取uim卡
	var _getProdTd = function(prodId){
		for (var i = 0; i < OrderInfo.boProd2Tds.length; i++) {
			var td = OrderInfo.boProd2Tds[i];
			if(td.prodId == prodId){
				return td.terminalCode;
			}
		}
		return "";
	};
	
	//获取物品
	var _getProdCoupon = function(prodId){
		var flag = true;
		for (var i = 0; i < OrderInfo.bo2Coupons.length; i++) {
			var coupon = OrderInfo.bo2Coupons[i];
			if(coupon.prodId == prodId){
				flag = false ;
				return coupon;
			}
		}
		if(flag){
			var bo2Coupon = {
				prodId : prodId,
				coupons : []
			};
			OrderInfo.bo2Coupons.push(bo2Coupon);
			return bo2Coupon;
		}
	};
	
	//初始化物品
	var _initProdCoupon = function(prodId){
		var flag = true;
		for (var i = 0; i < OrderInfo.bo2Coupons.length; i++) {
			var coupon = OrderInfo.bo2Coupons[i];
			if(coupon.prodId == prodId){
				coupon.coupons = [];
				return coupon;
			}
		}
		if(flag){
			var bo2Coupon = {
				prodId : prodId,
				coupons : []
			};
			OrderInfo.bo2Coupons.push(bo2Coupon);
			return bo2Coupon;
		}
	};
	
//	//根据产品id获取号码
//	var _getAccessNumber = function(prodId){
//		var accessNumber = "";
//		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==14){
//			for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
//				var an = OrderInfo.boProdAns[i];
//				if(an.prodId == prodId){
//					if(an.accessNumber != undefined ){
//						accessNumber =  an.accessNumber;
//					}
//				}
//			}
//		}else if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){
//			$.each(OrderInfo.offer.offerMemberInfos,function(i){
//				if(this.objInstId==prodId){
//					accessNumber = this.accessNumber;
//					return false;
//				}
//			});
//		} else if(prodId!=undefined && prodId>0){
//			accessNumber = order.prodModify.choosedProdInfo.accNbr;	
//		}
//		return accessNumber;
//	};
	
	//根据产品id获取号码
	var _getAccessNumber = function(prodId){
		var accessNumber = "";
		if(OrderInfo.actionFlag==1){
			var newProdId = "'"+prodId+"'";
			if(newProdId.indexOf("-")!= -1){
				for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
					var an = OrderInfo.boProdAns[i];
					if(an.prodId == prodId){
						if(an.accessNumber != undefined ){
							accessNumber =  an.accessNumber;
						}
					}
				}
			}
			else{
				
				$.each(OrderInfo.offer.offerMemberInfos,function(i){
					if(this.objInstId==prodId){
						accessNumber = this.accessNumber;
						return false;
					}
				});
				if((accessNumber==undefined || accessNumber=="") && offerChange.oldMemberFlag){
					$.each(OrderInfo.oldoffer,function(){
						$.each(this.offerMemberInfos,function(){
							if(this.objInstId==prodId){
								accessNumber = this.accessNumber;
								return false;
							}
						});
					});
				}
				
			}
			
		}
		else if(OrderInfo.actionFlag==14){
			for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
				var an = OrderInfo.boProdAns[i];
				if(an.prodId == prodId){
					if(an.accessNumber != undefined ){
						accessNumber =  an.accessNumber;
					}
				}
			}
		}else if(OrderInfo.actionFlag==6){
			for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
				var an = OrderInfo.boProdAns[i];
				if(an.prodId == prodId){
					if(an.accessNumber != undefined ){
						accessNumber =  an.accessNumber;
					}
				}
			}
			$.each(OrderInfo.oldprodInstInfos,function(){
				if(this.prodInstId==prodId){
					accessNumber = this.accNbr;
					return false;
				}
			});
			$.each(OrderInfo.offer.offerMemberInfos,function(i){
				if(this.objInstId==prodId){
					accessNumber = this.accessNumber;
					return false;
				}
			});
		}else if(OrderInfo.actionFlag==2||OrderInfo.actionFlag==21){
			var newProdId = "'"+prodId+"'";
			if(newProdId.indexOf("-")!= -1){
				for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
					var an = OrderInfo.boProdAns[i];
					if(an.prodId == prodId){
						if(an.accessNumber != undefined ){
							accessNumber =  an.accessNumber;
						}
					}
				}
			}else{
				$.each(OrderInfo.offer.offerMemberInfos,function(i){
					if(this.objInstId==prodId){
						accessNumber = this.accessNumber;
						return false;
					}
				});
				if((accessNumber==undefined || accessNumber=="") && offerChange.oldMemberFlag){
					$.each(OrderInfo.oldoffer,function(){
						$.each(this.offerMemberInfos,function(){
							if(this.objInstId==prodId){
								accessNumber = this.accessNumber;
								return false;
							}
						});
					});
				}
			}
		} else if(OrderInfo.actionFlag == 35){ //分段受理
			accessNumber = stepOrder.main.getAccessNumber(prodId);
		} else if(prodId!=undefined && prodId>0){
			accessNumber = order.prodModify.choosedProdInfo.accNbr;	
		}
		return accessNumber;
	};
	
	//根据产品id获取地区编码
	var _getAreaCode = function(prodId){
		var areaCode = "";
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==14){
			for (var i = 0; i < OrderInfo.boProdAns.length; i++) {
				var an = OrderInfo.boProdAns[i];
				if(an.prodId == prodId){
					if(an.areaCode != undefined ){
						areaCode =  an.areaCode;
					}
				}
			}
		}else if(prodId!=undefined && prodId>0){
			areaCode = order.prodModify.choosedProdInfo.areaCode;	
		}
		if(areaCode ==undefined || areaCode==""){
			areaCode = OrderInfo.staff.areaCode;	
		}
		return areaCode;
		
	};
	
	//根据产品id获取号码
	var _getAccNbrByRoleCd = function(roleCd){
		var accNbr = "";
		$.each(OrderInfo.boProdAns,function(){
			if(this.memberRoleCd==roleCd){
				accNbr = this.accessNumber;
				return false;
			}
		});
		if(accNbr==undefined || accNbr==""){
			accNbr = OrderInfo.boProdAns[0].accessNumber;
		}
		return accNbr;
	};
	
	//获取产品对应的角色
	var _getOfferRoleName = function(prodId){
		var offerRoleName = "";
		if(OrderInfo.actionFlag==2 || OrderInfo.actionFlag==3){
			if(OrderInfo.offer.offerMemberInfos!=undefined){
				$.each(OrderInfo.offer.offerMemberInfos,function(i){
					if(this.objInstId == prodId){
						offerRoleName = this.roleName;  //角色名称
						return false;
					}
				});
			}
		}else{
			if(OrderInfo.offerSpec.offerRoles!=undefined){
				$.each(OrderInfo.offerSpec.offerRoles,function(i){
					var roleName = this.offerRoleName;  //角色名称
					if(this.prodInsts!=undefined){
						$.each(this.prodInsts,function(){
							if(this.prodInstId == prodId){
								offerRoleName = roleName;
								return false;
							}
						});
					}
				});
			}
		}
		return offerRoleName;
	};
	
	//根据产品Id获取缓存中的产品实例
	var _getProdInst = function(prodId){
		var prodInst = {};
		if(OrderInfo.actionFlag == 2){ //套餐变更
			$.each(OrderInfo.offer.offerMemberInfos,function(i){
				if(this.objInstId ==prodId){
					prodInst = this;
					prodInst.accNbr = this.accessNumber;
					return false;
				}
			});
		}else if(OrderInfo.actionFlag == 3){ //可选包变更
			prodInst = order.prodModify.choosedProdInfo;
		}else { //新装
			$.each(OrderInfo.offerSpec.offerRoles,function(i){
				if(this.prodInsts!=undefined){
					$.each(this.prodInsts,function(){
						if(this.prodInstId == prodId){
							prodInst = this;
							return false;
						}
					});
				}
			});
		}
		return prodInst;
	};
	
	//根据接入产品id获取接人产品规格
	var _getProdSpecId = function(prodId){
		var prodSpecId = CONST.PROD_SPEC.CDMA;  //默认CDMA
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14){
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				$.each(this.prodInsts,function(){
					if(this.prodInstId == prodId){
						prodSpecId = this.objId;
						return false;
					}
				});
			});
		}else if(OrderInfo.actionFlag==2){
			$.each(OrderInfo.offer.offerMemberInfos,function(i){
				if(this.objInstId==prodId){
					prodSpecId = this.objId;
					return false;
				}
			});
		} else if(prodId!=undefined && prodId>0){
			prodSpecId = order.prodModify.choosedProdInfo.productId;	
		}
		return prodSpecId;
	};
	
	//获取权限
	var _getPrivilege = function(manageCode){
		if(OrderInfo.privilege.effTime==""){
			var param = {
				manageCode : manageCode	
			};
			return query.offer.checkOperate(param);
		}
	};
				
	return {
		getChannelList			: _getChannelList,
		channelList				: _channelList,
		salesCode:_salesCode,
		terminalCode:_terminalCode,
		mktResInstCode:mktResInstCode,
		checkUimData:_checkUimData,
		getCheckUimData:_getCheckUimData,
		clearCheckUimData:_clearCheckUimData,
		order					: _order,
		SEQ						: _SEQ,
		resetSeq				: _resetSeq,
		resetData				: _resetData,	
		orderResult				: _orderResult,
		cust					: _cust,
		staff					: _staff,
		offerSpec				: _offerSpec,
		offer 					: _offer,
		attach2Coupons			: _attach2Coupons,
		boCustInfos 			: _boCustInfos,
		boCustIdentities 		: _boCustIdentities,
		boPartyContactInfo 		: _boPartyContactInfo,
		boCustProfiles			: _boCustProfiles,
		boCusts					: _boCusts,
		boProdItems				: _boProdItems,
		boProdPasswords			: _boProdPasswords,
		boProdAns				: _boProdAns,
		boProd2Tds				: _boProd2Tds,
		bo2Coupons				: _bo2Coupons,
		boProd2OldTds			: _boProd2OldTds,
		clearProdUim			: _clearProdUim,
		orderData 				: _orderData,
		getOrderData 			: _getOrderData,
		actionClassCd			: _actionClassCd,
		boActionTypeCd			: _boActionTypeCd,
		actionFlag 				: _actionFlag,
		actionTypeName			: _actionTypeName,
		initData				: _initData,
		getOfferBusiOrder		: _getOfferBusiOrder,
		getProdBusiOrder		: _getProdBusiOrder,
		createCust				: _createCust,
		createAcct				: _createAcct,
		getProdAn				: _getProdAn,
		getProdTd				: _getProdTd,
		getProdUim				: _getProdUim,
		getProdOldUim			: _getProdOldUim,
		getProdAreaId			: _getProdAreaId,
		getProdCoupon			: _getProdCoupon,
		getProdInst				: _getProdInst,
		getAccessNumber			: _getAccessNumber,
		getAreaCode				: _getAreaCode,
		getAreaId 				: _getAreaId,
		getOfferRoleName		: _getOfferRoleName,
		getAccNbrByRoleCd    	: _getAccNbrByRoleCd,
		getProdSpecId			: _getProdSpecId,
		getPrivilege			: _getPrivilege,
		initProdCoupon			: _initProdCoupon,
		setProdAn				: _setProdAn,
		setProdModifyBusiOrder	: _setProdModifyBusiOrder,
		confirmList				: _confirmList,	
		businessName			: _businessName,
		password_remark         : _password_remark,
		privilege				: _privilege,
		offerProdInst          	: _offerProdInst,
		orderlonger				:_orderlonger,
		busitypeflag			:_busitypeflag,
		checkresult				:_checkresult,
		custorderlonger			:_custorderlonger,
		prodAttrs				:_prodAttrs,
		provinceInfo : _provinceInfo,
		reloadOrderInfo : _reloadOrderInfo,
		reloadProdInfo :_reloadProdInfo,
		newOrderInfo          	:_newOrderInfo,
		newOrderNumInfo			:_newOrderNumInfo,
		oldprodAcctInfos:_oldprodAcctInfos
	};
})();
/**
 * 订单准备
 * 
 * @author tang
 */
CommonUtils.regNamespace("order", "prodModify");
/**
 * 订单准备
 */
order.prodModify = (function(){
	var authFlag="";
	var _coupon="";
	var lteFlag=(CONST.getAppDesc()==0) ? true : false;//下省标志,给LHW
//	var lteFlag=false;//下省标志，给XH
	var _ischooseOffer=false;
	var _choosedProdInfo = {};
	//客户信息修改客户属性信息
	var _profiles=[];
	//客户属性分页列表
	var _profileTabLists =[];
	//帐户信息修改帐户邮寄信息
	//获取选中的产品信息
	var _getChooseProdInfo = function() {
		//var prodInfoTr=$("#prodNumberInfo li[class='ui-li-static ui-body-inherit ui-first-child userorderlistlibg']").find("dl:eq(0)");
		var prodInfoTr=$("#prodNumberInfo").find("li.userorderlistlibg").find("dl:eq(0)");
		//var prodInfoTr=$("#userorderlist li[class='userorderlistlibg']").find("li:eq(0)");
//		if(prodInfoTr.attr("accNbr")==undefined){
//			prodInfoTr=$("#phoneNumListtbody tr[class='bg plan_select']").find("td:eq(0)");
//		}
		var prodInfoChildTr=$("#prodNumberInfo").find("div.multidiv").find("li:eq(0)")
		//var prodInfoChildTr=$("#subphoneNumListtbody tr[class='plan_select2']").find("td:eq(0)");
		_choosedProdInfo  = {
			accNbr :prodInfoTr.attr("accNbr"),//产品接入号
			productName :prodInfoTr.attr("productName"),//产品规格名称
			prodStateName :prodInfoTr.attr("prodStateName"),//产品状态名称
			feeTypeName :prodInfoTr.attr("feeTypeName"),//付费方式名称
			prodInstId :prodInfoTr.attr("prodInstId"),//产品ID
			extProdInstId : prodInfoTr.attr("extProdInstId"),//省内产品实例ID
			corProdInstId : prodInfoTr.attr("corProdInstId"),//外部产品实例ID
			prodStateCd :prodInfoTr.attr("prodStateCd"),//产品状态CD
			productId :prodInfoTr.attr("productId"),//产品规格ID
			feeType :prodInfoTr.attr("feeType"),//付费方式id
			prodClass :$(prodInfoTr).attr("prodClass"),//产品大类 4 表示4G；3表示3G
			stopRecordCd :prodInfoTr.attr("stopRecordCd"),//停机记录CD
			stopRecordName :prodInfoTr.attr("stopRecordName"),//停机记录名称
			prodOfferName :prodInfoChildTr.attr("prodOfferName"),//主套餐名称
			custName :prodInfoChildTr.attr("custName"),//所属人客户名称
			startDt :prodInfoChildTr.attr("startDt"),//生效时间
			endDt :prodInfoChildTr.attr("endDt"),//失效时间
			prodOfferId :prodInfoChildTr.attr("prodOfferId"),//主套餐规格ID
			prodOfferInstId :prodInfoChildTr.attr("prodOfferInstId"),//主套餐实例ID
			custId :prodInfoChildTr.attr("custId"),//所属人客户ID
			is3G :prodInfoChildTr.attr("is3G"),//3G/4G主销售品标识
			areaCode :prodInfoTr.attr("zoneNumber"),//产品地区CODE
			areaId : prodInfoTr.attr("areaId")//产品地区id
		};
		order.prodModify.choosedProdInfo=_choosedProdInfo;
	};
	
	//业务规则校验
	var _getCallRuleParam = function(boActionTypeCd,prodId) {
		return {
			areaId : OrderInfo.staff.areaId,
			staffId : OrderInfo.staff.staffId,
			channelId : OrderInfo.staff.channelId,
			custId : OrderInfo.cust.custId,
			custFlag :OrderInfo.cust.custFlag,
			boInfos : [{
				boActionTypeCd : boActionTypeCd,
				instId : prodId,
				specId : CONST.PROD_SPEC.CDMA,
				prodId : prodId
			}]
		};
	};
	//预校验单校验
	var _updateCheckByChange = function (actionClassCd,boActionTypeCd,prodStatusCd,toprodStatusCd) {
		var data = { 
				orderList : {
					orderListInfo : { 
						isTemplateOrder : "N",   //是否批量
						templateType : "1",  //模板类型: 1 新装；8 拆机；2 订购附属；3 组合产品纳入/退出
						staffId : OrderInfo.staff.staffId,
						channelId : OrderInfo.staff.channelId,  //受理渠道id
						areaId : OrderInfo.staff.areaId,  //受理地区ID
						partyId :  _choosedProdInfo.custId,  //新装默认-1
						olTypeCd : CONST.OL_TYPE_CD.UI_LTE  //4g标识
					},
					custOrderList :[{busiOrder : []}]   //客户订购列表节点
				}
			};
		data.orderList.custOrderList[0].busiOrder=[{
	    	areaId: OrderInfo.staff.areaId,  //受理地区ID
		    boActionType: {
		        actionClassCd: actionClassCd,//受理大类
		        boActionTypeCd: boActionTypeCd//退订销售品
		    }, busiObj: {
		        accessNumber: _choosedProdInfo.accNbr,
		        instId: _choosedProdInfo.prodInstId,
		        isComp: "N",
		        objId: CONST.PROD_SPEC.CDMA,
		        offerTypeCd: "1"
		    }, busiOrderInfo: {
		        seq: OrderInfo.SEQ.seq
		    },data: {
		    	boProdStatuses : [{
					atomActionId : OrderInfo.SEQ.atomActionSeq--,
					prodStatusCd : prodStatusCd,
					state : "DEL"
				},{
					atomActionId : OrderInfo.SEQ.atomActionSeq--,
					prodStatusCd : toprodStatusCd,
					state : "ADD"
				}
		        ]
		    }
	    }];
		params=JSON.stringify(data);
		var url=contextPath+"/order/prodModify/updateCheckByChange";
		var response = $.callServiceAsJson(url, params, {});
		var msg="";
		if (response.code == 0) {
			return true;
		}else if(response.code == -2){
			$.alertM(response.data);
			return false;
		}else{
			msg=response.data;
			$.alert("提示","预校验失败!失败原因为："+msg);
			return false;
		}
	};
	//二次业务产品密码鉴权配置 
	var _remark_prodPass = function () {
		var params = {"tableName":"SYSTEM","columnName":"REMARK_PRODPASS"} ;
		var url=contextPath+"/order/prodModify/queryProdPwdConfig";
		if(OrderInfo.password_remark==""){
			var response = $.callServiceAsJson(url, params, {});
			var msg="";
			if (response.code == 0) {
				OrderInfo.password_remark=response.data;
			}else if(response.code == -2){
				$.alertM(response.data);
				OrderInfo.password_remark="0";
				return false;
			}else{
				OrderInfo.password_remark="0";
				return false;
			}
		}
		
	}
	//补换卡规则校验
	var _showChangeCard = function () {
		OrderInfo.busitypeflag=13;
		prod.changeUim.init();
	};
	
	//加入群组规则校验
	var _showAddComp = function(){
		var compspecparam = {
				"productId":_choosedProdInfo.productId
		}
		if(getCompInfo(compspecparam)==""){
			return;
		}
		var param = {
				"areaId" : OrderInfo.staff.areaId, //地区ID
				"custId" : OrderInfo.cust.custId, //客户ID
				"staffId" : OrderInfo.staff.staffId,
				"channelId" : OrderInfo.staff.channelId,
				"boInfos":[{
					"boActionTypeCd": CONST.BO_ACTION_TYPE.ADD_COMP,//动作类型
				    "instId" : _choosedProdInfo.prodInstId, //实例ID
				    "specId" : CONST.PROD_SPEC.CDMA //产品（销售品）规格ID
				}]
		};
		var callParam = {
				"prodInstId" : _choosedProdInfo.prodInstId,
				"productId" : _choosedProdInfo.productId
		};
		var checkRule = rule.rule.prepare(param,'order.prodModify.addComp',callParam);
	}
	
	//退出群组规则校验
	var _showRemoveComp = function(){
		var compspecparam = {
				"productId":_choosedProdInfo.productId
		}
		if(getCompInfo(compspecparam)==""){
			return;
		}
		var param = {
				"areaId" : OrderInfo.staff.areaId, //地区ID
				"custId" : OrderInfo.cust.custId, //客户ID
				"staffId" : OrderInfo.staff.staffId,
				"channelId" : OrderInfo.staff.channelId,
				"boInfos":[{
					"boActionTypeCd": CONST.BO_ACTION_TYPE.ADD_COMP,//动作类型
				    "instId" : _choosedProdInfo.prodInstId, //实例ID
				    "specId" : CONST.PROD_SPEC.CDMA //产品（销售品）规格ID
				}]
		};
		var callParam = {
				"prodInstId" : _choosedProdInfo.prodInstId,
				"productId" : _choosedProdInfo.productId
		};
		var checkRule = rule.rule.prepare(param,'order.prodModify.removeComp',callParam);
	};
	var _queryOfferSpec=function(){
		var offerSpecId = _choosedProdInfo.prodOfferId;
		//offerSpecId = 300500003940;//TODO need delete
		var offerId=_choosedProdInfo.prodOfferInstId;
		//offerId=120000000645;//TODO need delete
		_offerProd.offerId=offerId;
		_offerProd.offerSpecId=offerSpecId;
		if(offerSpecId==undefined||offerSpecId==''){
			return {};
		}else{
			var param={"offerSpecId":offerSpecId};
			var response = $.callServiceAsJson(contextPath+"/order/queryOfferSpec",param);
			if (response.code==0) {
				if(response.data){
					_offerSpec = response.data.offerSpec;
				}
			}
		}
		return _offerSpec;
	};
	
	//挂失解挂准备
	var _showLossRepProd = function () {
		OrderInfo.busitypeflag=5;
		var submitState="";
        var BO_ACTION_TYPE="";
        var inprodStatusCd="";
        var intoprodStatusCd="";
			inprodStatusCd=_choosedProdInfo.prodStateCd;
			intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;
			BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.LOSSREP_PROD;
			if(inprodStatusCd==""){
				inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
			}
		var param = _getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd :inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			prodOfferName : _choosedProdInfo.prodOfferName,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
	};
	//解挂准备
	var _showLossRepProdReg = function () {
		OrderInfo.busitypeflag=5;
		var submitState="";
        var BO_ACTION_TYPE="";
        var inprodStatusCd="";
        var intoprodStatusCd="";
			inprodStatusCd=_choosedProdInfo.prodStateCd;
			intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;;
			BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISLOSSREP_PROD;
		var param = _getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd :inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			prodOfferName : _choosedProdInfo.prodOfferName,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
	};
	//停机保号/取消停机保号准备
	var _showStopKeepNumProd = function () {
		OrderInfo.busitypeflag=6;
		var submitState="";
        var BO_ACTION_TYPE="";
        var inprodStatusCd="";
        var intoprodStatusCd="";
			BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.STOPKEEPNUM;
			inprodStatusCd=_choosedProdInfo.prodStateCd;
			intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;
			if(inprodStatusCd==""){
				inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
			}
		var param = _getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd :inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			prodOfferName : _choosedProdInfo.prodOfferName,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
	};
	//停机保号/取消停机保号准备
	var _showStopKeepNumProdReg = function () {
		OrderInfo.busitypeflag=6;
		var submitState="";
        var BO_ACTION_TYPE="";
        var inprodStatusCd="";
        var intoprodStatusCd="";
			BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.DISSTOPKEEPNUM;
			inprodStatusCd=_choosedProdInfo.prodStateCd;
			intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		var param = _getCallRuleParam(BO_ACTION_TYPE,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd :inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			prodOfferName : _choosedProdInfo.prodOfferName,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
	};
	//客户修改资料
	var _showCustInfoModify = function () {
		if("-1"==OrderInfo.cust.custId){
			$("#div_cust_create").popup("open");
			$("#cCustName").val(OrderInfo.boCustInfos.name);
			$("#cCustIdCard").val(OrderInfo.boCustIdentities.identityNum);
			$("#partyTypeCd option[value='"+OrderInfo.boCustInfos.partyTypeCd+"']").attr("selected", true);
			$("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']").attr("selected", true);
			$("#cAddressStr").val(OrderInfo.boCustInfos.addressStr);
			//证件类型选择事件
			order.cust.mgr.identidiesTypeCdChoose($("#identidiesTypeCd option[value='"+OrderInfo.boCustIdentities.identidiesTypeCd+"']"),"ccCustIdCard");
			tabProfileFlag="1";
			//客户联系人
			$("#contactAddress").val(OrderInfo.boPartyContactInfo.contactAddress);
			$("#contactDesc").val(OrderInfo.boPartyContactInfo.contactDesc);
			$("#contactEmployer").val(OrderInfo.boPartyContactInfo.contactEmployer);
			//$("#contactGender").val(OrderInfo.boPartyContactInfo.contactGender);
			$("#contactGender option[value='"+OrderInfo.boPartyContactInfo.contactGender+"']").attr("selected", true);
			$("#contactName").val(OrderInfo.boPartyContactInfo.contactName);
			//$("#contactType").val(OrderInfo.boPartyContactInfo.contactType);
			$("#contactType option[value='"+OrderInfo.boPartyContactInfo.contactType+"']").attr("selected", true);
			$("#eMail").val(OrderInfo.boPartyContactInfo.eMail);
			$("#fax").val(OrderInfo.boPartyContactInfo.fax);
			//$("#headFlag").val(OrderInfo.boPartyContactInfo.headFlag);
			$("#headFlag option[value='"+OrderInfo.boPartyContactInfo.headFlag+"']").attr("selected", true);
			$("#homePhone").val(OrderInfo.boPartyContactInfo.homePhone);
			$("#mobilePhone").val(OrderInfo.boPartyContactInfo.mobilePhone);
			$("#officePhone").val(OrderInfo.boPartyContactInfo.officePhone);
			$("#postAddress").val(OrderInfo.boPartyContactInfo.postAddress);
			$("#postcode").val(OrderInfo.boPartyContactInfo.postcode);
		}else{
			var submitState="";
	        var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.CUSTINFOMODIFY;
			submitState="ADD";
			var param = _getCallRuleParam(BO_ACTION_TYPE, _choosedProdInfo.prodInstId);
			var callParam = {
				boActionTypeCd : BO_ACTION_TYPE,
				boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
				accessNumber : "",
				prodOfferName : "",
				state:submitState
			};
/*			SoOrder.builder(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE);
			OrderInfo.actionTypeName = CONST.getBoActionTypeName(BO_ACTION_TYPE);
			OrderInfo.actionFlag=4;*/
			OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,4,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
			var checkRule = rule.rule.prepare(param,'order.prodModify.custInfoModify',callParam);
			if (checkRule) return;
			//SoOrder.builder();
			
		}
	};
	//改客户资料返档
	var _showActiveReturn = function () {
		OrderInfo.busitypeflag=12;
		/*if(_choosedProdInfo.prodStateCd!=CONST.PROD_STATUS_CD.READY_PROD){
			$.alert("提示","产品必须为预开通时才能进行改客户资料返档","information");
			return;
		}*/
		var submitState="";
        var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACTIVERETURN;
		submitState="ADD";
		var param = _getCallRuleParam(BO_ACTION_TYPE, _choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : BO_ACTION_TYPE,
			boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
			accessNumber : "",
			prodOfferName : "",
			state:submitState
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.CUST_ACTION,BO_ACTION_TYPE,9,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
		var checkRule = rule.rule.prepare(param,'order.prodModify.custInfoModify',callParam);
		if (checkRule) return;
	};
	//修改帐户信息
	var _showAcctInfoModify = function () {
			var submitState="";
	        var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.ACCTINFOMODIFY;
			submitState="ADD";
			var param = _getCallRuleParam(BO_ACTION_TYPE, _choosedProdInfo.prodInstId);
			var callParam = {
				boActionTypeCd : BO_ACTION_TYPE,
				boActionTypeName : CONST.getBoActionTypeName(BO_ACTION_TYPE),
				accessNumber : "",
				prodOfferName : "",
				state:submitState
			};
			OrderInfo.initData(CONST.ACTION_CLASS_CD.ACCT_ACTION,BO_ACTION_TYPE,0,CONST.getBoActionTypeName(BO_ACTION_TYPE),"");
			var checkRule = rule.rule.prepare(param,'order.prodModify.acctInfoModify',callParam);
			if (checkRule) return ;
			//SoOrder.builder();
			
	};
	var _form_custInfomodify_btn = function() {
		//修改客户下一步确认按钮
		$('#custModifyForm').off("formIsValid").on("formIsValid",function(event) {
			var modifyCustInfo={};
			modifyCustInfo = {
					custName : $.trim($("#cmCustName").val()),
					identidiesTypeCd :  $("#div_cm_identidiesType  option:selected").val(),
					custIdCard :  $.trim($("#cmCustIdCard").val()),
					addressStr: $.trim($("#cmAddressStr").val())
				};
			var data = {};
			data.boCustInfos = [{
				areaId : OrderInfo.cust.areaId,
				name : $("#boCustIdentities").attr("partyName"),
				norTaxPayerId : "0",
				partyTypeCd : $("#boCustIdentities").attr("partyTypeCd"),
				addressStr :$("#boCustIdentities").attr("addressStr"),
				state : "DEL"
			},{
				areaId : OrderInfo.cust.areaId,
				name : modifyCustInfo.custName,
				norTaxPayerId : "0",
				partyTypeCd : $("#cmPartyTypeCd  option:selected").val(),
				addressStr :modifyCustInfo.addressStr,
				state : "ADD"
			}];
			if(OrderInfo.cust.idCardNumber==""||OrderInfo.cust.idCardNumber==null){
				data.boCustIdentities = [{
					identidiesTypeCd :modifyCustInfo.identidiesTypeCd,
					identityNum : modifyCustInfo.custIdCard,
					isDefault : "Y",
					state : "ADD"
				}];	
			}else{
			data.boCustIdentities = [{
				identidiesTypeCd :OrderInfo.cust.identityCd,
				identityNum : OrderInfo.cust.idCardNumber,
				isDefault : "Y",
				state : "DEL"
			},{
				identidiesTypeCd :modifyCustInfo.identidiesTypeCd,
				identityNum : modifyCustInfo.custIdCard,
				isDefault : "Y",
				state : "ADD"
			}];
			}
			data.boCustProfiles=[];
			//客户属性信息
			for ( var i = 0; i < order.prodModify.profiles.length; i++) {
				var profilesObj = order.prodModify.profiles[i];
				var profilesDel ={};
				var profilesAdd ={};
				profilesDel={
					partyProfileCatgCd: profilesObj.attrId,
					profileValue: profilesObj.defaultValue,
					state : "DEL"};
				profilesAdd={
					partyProfileCatgCd: profilesObj.attrId,
					profileValue: $.trim($("#profiles_"+profilesObj.attrId).val()),
					state : "ADD"
				};
				if(document.getElementById("profiles_"+profilesObj.attrId)&&profilesObj.profileValue!=$.trim($("#profiles_"+profilesObj.attrId).val())){
					data.boCustProfiles.push(profilesDel);
					data.boCustProfiles.push(profilesAdd);
				}

			} 
			//客户联系人
			data.boPartyContactInfo=[];
			var _boPartyContactInfoOld = {
/*					contactAddress : $("#modTabProfile0").attr("contactAddress"),//参与人的联系地址
			        contactDesc : $("#modTabProfile0").attr("contactDesc"),//参与人联系详细信息
			        contactEmployer  : $("#modTabProfile0").attr("contactEmployer"),//参与人的联系单位
			        contactGender  : $("#modTabProfile0").attr("contactGender"),//参与人联系人的性别
*/			        contactId : $("#modTabProfile0").attr("contactId"),//参与人联系信息的唯一标识
                    statusCd : "100001",
                    contactName : $("#modTabProfile0").attr("contactName"),//参与人的联系人名称
                    headFlag :  $("#modTabProfile0").attr("headFlag"),//是否首选联系人
/*			        
			        contactType : $("#modTabProfile0").attr("contactType"),//联系人类型
			        eMail : $("#modTabProfile0").attr("eMail"),//参与人的eMail地址
			        fax : $("#modTabProfile0").attr("fax"),//传真号
			        
			        homePhone : $("#modTabProfile0").attr("homePhone"),//参与人的家庭联系电话
			        mobilePhone : $("#modTabProfile0").attr("mobilePhone"),//参与人的移动电话号码
			        officePhone : $("#modTabProfile0").attr("officePhone"),//参与人办公室的电话号码
			        postAddress : $("#modTabProfile0").attr("postAddress"),//参与人的邮件地址
			        postcode : $("#modTabProfile0").attr("postcode"),//参与人联系地址的邮政编码
			        staffId : OrderInfo.staff.staffId,//员工ID
*/			        state : "DEL"//状态
			};
			var _boPartyContactInfo = {
					contactAddress : $.trim($("#contactAddress").val()),//参与人的联系地址
			        contactDesc : $.trim($("#contactDesc").val()),//参与人联系详细信息
			        contactEmployer  : $.trim($("#contactEmployer").val()),//参与人的联系单位
			        contactGender  : $.trim($("#contactGender").val()),//参与人联系人的性别
			        contactId : $.trim($("#contactId").val()),//参与人联系信息的唯一标识
			        contactName : $.trim($("#contactName").val()),//参与人的联系人名称
			        contactType : $.trim($("#contactType").val()),//联系人类型
			        eMail : $.trim($("#eMail").val()),//参与人的eMail地址
			        fax : $.trim($("#fax").val()),//传真号
			        headFlag :  $.trim($("#headFlag  option:selected").val()),//是否首选联系人
			        homePhone : $.trim($("#homePhone").val()),//参与人的家庭联系电话
			        mobilePhone : $.trim($("#mobilePhone").val()),//参与人的移动电话号码
			        officePhone : $.trim($("#officePhone").val()),//参与人办公室的电话号码
			        postAddress : $.trim($("#postAddress").val()),//参与人的邮件地址
			        postcode : $.trim($("#postCode").val()),//参与人联系地址的邮政编码
			        staffId : OrderInfo.staff.staffId,//员工ID
			        state : "ADD",//状态
			        statusCd : "100001"//订单状态
			};
			if($("#modTabProfile0").attr("click")=="0"){
				if(_boPartyContactInfoOld.contactId!=""){
					data.boPartyContactInfo.push(_boPartyContactInfoOld);
					data.boPartyContactInfo.push(_boPartyContactInfo);
				}else{
					data.boPartyContactInfo.push(_boPartyContactInfo);
				}
				
			}
			SoOrder.submitOrder(data);
		}).ketchup({bindElement:"custInfoModifyBtn"});
	};
    //客户类型选择事件
	var _partyTypeCdChoose = function(scope) {
		var partyTypeCd=$(scope).val();
		//_partyType(partyTypeCd);
		$("#cm_identidiesTypeCd").empty();
		//客户类型关联证件类型下拉框
		_certTypeByPartyType(partyTypeCd);
		//证件类型选择事件
		_identidiesTypeCdChoose($("#div_cm_identidiesType").children(":first-child"));

	};
	var _partyType = function(partyTypeCd) {
		if(partyTypeCd==1){
			var identidiesTypeCdHtml="<select id=\"cmIdentidiesTypeCd\" onchange=\"order.prodModify.identidiesTypeCdChoose(this)\"><option value=\"1\" >身份证</option><option value=\"2\">军官证</option></select>";
		}else if(partyTypeCd==2){
			var identidiesTypeCdHtml="<select id=\"cmIdentidiesTypeCd\" onchange=\"order.prodModify.identidiesTypeCdChoose(this)\"><option value=\"3\">护照</option><option value=\"23\">ICP经营许可证</option><option value=\"39\">税务登记号</option></select>";
		};
		$("#div_cm_identidiesType").html(identidiesTypeCdHtml);
	};
	//客户类型关联证件类型下拉框
	var _certTypeByPartyType = function(_partyTypeCd){
		var params = {"partyTypeCd":_partyTypeCd} ;
		var url=contextPath+"/cust/queryCertType";
		var response = $.callServiceAsJson(url, params, {});
       if (response.code == -2) {
					$.alertM(response.data);
				}
	   if (response.code == 1002) {
					$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");
					return;
				}
	   if(response.code==0){
					var data = response.data ;
					if(data!=undefined && data.length>0){
						for(var i=0;i<data.length;i++){
							var certTypedate = data[i];
							$("#cm_identidiesTypeCd").append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>");
							
						}
					}
				}
	};
	//证件类型选择事件
	var _identidiesTypeCdChoose = function(scope) {
		var identidiesTypeCd=$(scope).val();
		if(identidiesTypeCd==undefined){
			identidiesTypeCd=$("#div_cm_identidiesType  option:selected").val();
		}
		if(identidiesTypeCd==1){
			$("#cmCustIdCard").attr("placeHolder","请输入合法身份证号码");
			$("#cmCustIdCard").attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)");
		}else if(identidiesTypeCd==2){
			$("#cmCustIdCard").attr("placeHolder","请输入合法军官证");
			$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}else if(identidiesTypeCd==3){
			$("#cmCustIdCard").attr("placeHolder","请输入合法护照");
			$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}else{
			$("#cmCustIdCard").attr("placeHolder","请输入合法证件号码");
			$("#cmCustIdCard").attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		_form_custInfomodify_btn();
	};
	var _custInfoModify = function(callParam) {
		var param={};
		param.partyName=OrderInfo.cust.partyName;
		param.custId=OrderInfo.cust.custId;
		//定位客户
		param.idCardNumber=OrderInfo.cust.idCardNumber;
		param.boActionTypeName=callParam.boActionTypeName;
		$.callServiceAsHtml(contextPath + "/order/prodModify/custInfoModify", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if (response.code == -2) {
					$.alertM(response.data);
					return;
				}
				if(response.data.indexOf("false") >=0) {
					$.alert("提示","抱歉，查询无返回客户详情信息。");
					//$.alertM(response.data);
					return;
				}
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				//根据客户类型查询证件类型
				_partyTypeCdChoose($("#cmPartyTypeCd  option:selected"));
				//取客户证件类型
				$("#cm_identidiesTypeCd option[value='"+$("#boCustIdentities").attr("identidiesTypeCd")+"']").attr("selected", true);
				//根据证件类型对行添加校验
				_identidiesTypeCdChoose($("#cm_identidiesTypeCd option[selected='selected']"));
				
				
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$(".ordercon").show();
				$(".ordertabcon").show();
				$("#step1").show();
				
				$(".ordercon a:first span").text("取 消");
				_form_custInfomodify_btn();
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	var _lossRepProd = function(callParam) {
		param=_choosedProdInfo;
		$.extend(param, callParam);
		$.callServiceAsHtml(contextPath + "/order/prodModify/lossRepProd", param, {
			"before":function(){
			},"done" : function(response){
				var content$ = $("#order_prepare");
				content$.html(response.data).show();
				$(".ordercon").show();
				$(".ordertabcon").show();
				$("#step1").show();
				$("#custInfo").hide();
				$(".ordercon a:first span").text("取 消");
			},"always":function(){
				$.unecOverlay();
			}
		});
		SoOrder.builder(CONST.ACTION_CLASS_CD.PROD_ACTION,param.boActionTypeCd);
/*		OrderInfo.actionClassCd = 1300;
		OrderInfo.boActionTypeCd = "1171";*/
/*		OrderInfo.actionClassCd = CONST.ACTION_CLASS_CD.PROD_ACTION;
		OrderInfo.boActionTypeCd = param.boActionTypeCd;
		SoOrder.builder(1300,"14");*/
	};
	//挂失 订单提交
	var _lossRepProdSubmit = function(param) {
		var data = {};
		data.orderRemark = $.trim($("#order_remark").val());
		data.boProdStatuses = [{
			prodStatusCd : 8,
			state : submitState
		}];
		SoOrder.submitOrder(data);
		//_commonSubmit(CONST.BO_ACTION_TYPE.LOSSREP_PROD,_choosedProdInfo.prodStateCd,"111111122");
	};
	var _closeDialog = function() {
		if(order.prodModify.dialogForm!=undefined&&order.prodModify.dialog!=undefined){
			order.prodModify.dialogForm.close(order.prodModify.dialog);
		}
	};
	var _removeCommit=function(prodStatusCd,boActionType,templateType){
		var inprodStatusCd="";
        var intoprodStatusCd="";
        inprodStatusCd=_choosedProdInfo.prodStateCd;
		intoprodStatusCd=prodStatusCd;
		if(inprodStatusCd==""){
			inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		var param = _getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : boActionType,
			boActionTypeName : CONST.getBoActionTypeName(boActionType),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd : inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:"ADD"
		};
		OrderInfo.order.templateType=templateType;
		var v_actionFlag = 0 ;
		if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){
			v_actionFlag =19;//OrderInfo.actionFlag
		}
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);
		var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
		if(flag) return;
		//SoOrder.builder();
		
	};
	var _showMemberWin=function(){
		_ischooseOffer=false;
		var viceCount=0;
		var offerMemberInfos=OrderInfo.offer.offerMemberInfos;
		$.each($("#delPhoneNumber ul:last li"),function(i, li){
			$(this).remove();
		});
		$.each(offerMemberInfos,function(i,offerMember){
			/*if(offerMember.roleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD&&offerMember.roleCd !=CONST.MEMBER_ROLE_CD.VICE_CARD){//不是主卡卡套餐跳过
				return false;
			}*/
			if(offerMember.roleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD&&_choosedProdInfo.accNbr==offerMember.accessNumber){
				viceCount=0;
				return false;
			}
			if (offerMember.roleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD&& offerMember.objType==CONST.OBJ_TYPE.PROD) {
				$("#delPhoneNumber ul:first h5").text(offerMember.roleName);
				$("#delPhoneNumber ul:first li").text(offerMember.accessNumber);
			} else if (offerMember.roleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD&& offerMember.objType==CONST.OBJ_TYPE.PROD) {
				if (offerMember.accessNumber) {
					$("#delPhoneNumber ul:last h5").text(offerMember.roleName);
					var li = $("<li class='full'>").text(offerMember.accessNumber).appendTo($("#delPhoneNumber ul:last"));
					var objId=offerMember.objId;
					var objInstId=offerMember.objInstId;
					var objType=offerMember.objType;
					var offerMemberId=offerMember.offerMemberId;
					var offerRoleId=offerMember.offerRoleId;
                    var accessNumber=offerMember.accessNumber;
					li.attr("del","Y").attr("accessNumber",accessNumber).attr("objId",objId).attr("objInstId",objInstId).attr("objType",objType).attr("offerMemberId",offerMemberId).attr("offerRoleId",offerRoleId);
					$("<span  id='viceCard_"+offerMember.accessNumber+"'></span>").appendTo(li);
					var eleI = $("<i id='plan_no'><a id='' class='purchase' href='javascript:void(0)'>保留>>选择新套餐</a></i>").appendTo(li);
					eleI.click(function(){
						order.service.offerDialog('viceCard_'+offerMember.accessNumber);
					});		
				 }
			}
			 viceCount++;
		});
		if(viceCount>1){
			return true;
		}else{
			return false;
		}
	};
	//选中套餐返回
	var _chooseOfferForMember=function(specId,subpage,specName,offerRoleId){
		$("#"+subpage).html("&nbsp;&nbsp;<span style='color: #327501;'>订购新套餐：</span>"+specName);
		$("#li_"+subpage).attr("addSpecId",specId).attr("addRoleId",offerRoleId).attr("del","N").attr("addSpecName",specName);
		_ischooseOffer=true;
		if(document.getElementById("li_"+subpage)){
			$("#label_"+subpage).attr({style:"height:53px;line-height:53px;padding-left:18px;text-decoration:''"});
			$("#li_"+subpage).attr("del","N").attr("knew","Y");
			document.getElementById("button_" + subpage).innerHTML = "拆副卡";
		}	
	};
	//主卡拆机副卡新装套餐
	var _removeAndAdd=function(prodStatusCd,boActionType,templateType){
		var viceparam = [];
		$.each($("#delPhoneNumber ul:last li"),function(i, li){//所有副卡信息
				viceparam.push({
					objId : $(this).attr("objId"),
					objInstId : $(this).attr("objInstId"),
					objType : $(this).attr("objType"),
					offerRoleId : $(this).attr("addRoleId"),
					offerSpecId :$(this).attr("addSpecId"),
					offerMemberId:$(this).attr("offerMemberId"),
					accessNumber :$(this).attr("accessNumber"),
					del :$(this).attr("del")
				});
		});
		var inprodStatusCd="";
        var intoprodStatusCd="";
        inprodStatusCd=_choosedProdInfo.prodStateCd;
		intoprodStatusCd=prodStatusCd;
		if(inprodStatusCd==""){
			inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		var param = _getCallRuleParam(boActionType,_choosedProdInfo.prodInstId);
		var submitFlag = (boActionType==CONST.BO_ACTION_TYPE.BUY_BACK?"buyBack":"removeAndRetainVice") ;
		var callParam = {
			boActionTypeCd : boActionType,
			boActionTypeName : CONST.getBoActionTypeName(boActionType),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd : inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:"ADD",
			submitFlag:submitFlag,//"removeAndRetainVice",
			viceParam:viceparam
		};
		OrderInfo.order.templateType=templateType;
		var v_actionFlag = 0 ;
		if(boActionType==CONST.BO_ACTION_TYPE.BUY_BACK){
			v_actionFlag =20;//OrderInfo.actionFlag
		}
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,boActionType,v_actionFlag,CONST.getBoActionTypeName(boActionType),templateType);
		var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
		if(flag) return;
		//SoOrder.builder();
		
	};
	var _commonShowDialog=function(){
		$("#delPhoneNumber .btna_o:last").click(function(){
			_closeDialog();
		});
		ec.form.dialog.createDialog({
			"id":"-delephone",
			"width":480,
			"height":400,
			"initCallBack":function(dialogForm,dialog){
				order.prodModify.dialogForm=dialogForm;
				order.prodModify.dialog=dialog;
			},
			"submitCallBack":function(dialogForm,dialog){}
		});
	};
	//欠费拆机
	var _showOweRemoveProd = function () {
		OrderInfo.busitypeflag=11;
		/*
		 * 规则后移
		if(_choosedProdInfo.stopRecordCd.indexOf("130000") < 0){
			$.alert("提示","产品必须为\"欠费停机\"时才能欠费拆机","information");
			return;
		}
		*/
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD;
/*		if(lteFlag){
		var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
		if (!flag) return;
		}*/
		if(!query.offer.setOffer()){
			return;
		}
		if(_showMemberWin()){
			$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD)+'-是否保留成员');			
			$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){
				_closeDialog();
				_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8);
			});			
			_commonShowDialog();
		}else{
			_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD,8);
		}
	};
	
	//拆机
	var _showRemoveProd = function () {
		OrderInfo.busitypeflag=8;
		/*if(_choosedProdInfo.prodStateCd!='100000'){
			$.alert("提示","产品状态为\"在用\"时才能拆机","information");
			return;
		}*/
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.REMOVE_PROD;
/*		if(lteFlag){
			var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
			if (!flag) return;
		}*/
		if(!query.offer.setOffer()){
			return;
		}
		if(_showMemberWin()){
			$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.REMOVE_PROD)+'-是否保留成员');			
			$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){
				_closeDialog();
				_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1);
			});			
			_commonShowDialog();
		}else{
			_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.REMOVE_PROD,1);
		}
	};
	
	//预拆机
	var _showOrderRemoveProd = function() {
		OrderInfo.busitypeflag=7;
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.PREMOVE_PROD;
/*		if(lteFlag){
			var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
			if (!flag) return;
		}*/
		if(!query.offer.setOffer()){
			return;
		}
		if(_showMemberWin()){
			$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_PROD)+'-是否保留成员');			
			$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){
				_closeDialog();
				_removeAndAdd(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1);
			});			
			_commonShowDialog();
		}else{
			_removeCommit(CONST.PROD_STATUS_CD.STOP_PROD,CONST.BO_ACTION_TYPE.PREMOVE_PROD,1);
		}
	};
	
	//预拆机复机
	var _showCoverOrderRemoveProd = function() {
		OrderInfo.busitypeflag=0;
		/*
		 * 规则后移
		if(_choosedProdInfo.prodStateCd!='120000'){
			$.alert("提示","产品状态为\"拆机\"时才能复机","information");
			return;
		}
		*/
		var inprodStatusCd="";
        var intoprodStatusCd="";
        inprodStatusCd=_choosedProdInfo.prodStateCd;
		intoprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		if(inprodStatusCd==""){
			inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd : inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:"ADD"
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PREMOVE_BACK_PROD),"");
		var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
		if (flag) return;
		//SoOrder.builder();
		
	};
	
	//违章拆机
	var _showBreakRuleRemoveProd = function() {
		OrderInfo.busitypeflag=9;
		/*
		 * 规则后移
		if(_choosedProdInfo.prodStateCd!='100000'){
			$.alert("提示","产品状态为\"在用\"时才能拆机","information");
			return;
		}
		*/
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD;
/*		if(lteFlag){
			var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
			if (!flag) return;
		}*/
		if(!query.offer.setOffer()){
			return;
		}
		if(_showMemberWin()){
			$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD)+'-是否保留成员');			
			$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){
				_closeDialog();
				_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1);
			});			
			_commonShowDialog();
		}else{
			_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BREAK_RULE_REMOVE_PROD,1);
		}
	};
	//未激活拆机
	var _showNoActiveRemoveProd = function() {
		OrderInfo.busitypeflag=10;
		/*if(_choosedProdInfo.prodStateCd!=CONST.PROD_STATUS_CD.READY_PROD){
			$.alert("提示","产品状态为未激活(预开通)时才能拆机","information");
			return;
		}*/
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD;
		/*if(lteFlag){
		var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
		if (!flag) return;
		}*/
		var inprodStatusCd="";
        var intoprodStatusCd="";
        inprodStatusCd=_choosedProdInfo.prodStateCd;
		intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;
		if(inprodStatusCd==""){
			inprodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),
			accessNumber : _choosedProdInfo.accNbr,
			prodStatusCd : inprodStatusCd,
			toprodStatusCd : intoprodStatusCd,
			itemSpecId : CONST.BUSI_ORDER_ATTR.REMOVE_REASON,
			state:"ADD"
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.NOACTIVE_REMOVE_PROD),"");
		var flag = rule.rule.prepare(param,'order.prodModify.commonPrepare',callParam);
		if (flag) return;
		//SoOrder.builder();
		
	};
	
	//只有订单信息的变更页面公共方法
	var _commonPrepare = function(param) {
		$.callServiceAsHtml(contextPath + "/order/prodModifyCommon", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#ordercon").show();
				$("#ordertabcon").show();
				order.prepare.step(1);
				OrderInfo.order.step=1;//订单备注页面
				$("#orderedprod").hide();
				$("#order_prepare").hide();
				$(".ordercon a:first span").text("取 消");
				$(".main_body").css("height","150px");
				$(".main_body").css("min-height","150px");
				$("#order_confirm").empty();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				if(lteFlag){
					_remark_prodPass();//二次业务产品密码鉴权配置 
					if(OrderInfo.password_remark!=null){
					if((OrderInfo.password_remark).indexOf("'"+OrderInfo.boActionTypeCd+"'") >= 0){
					  $("#orderPassRemarkDiv").show();
					}}
				}
				$("#fillNextStep").unbind("click").bind("click",function(){
					if(param.submitFlag=='removeAndRetainVice'){
						_commitRetainVice(param);
					}else if(param.submitFlag=='buyBack'){
						_commitBuyBack(param);
					}else if(param.submitFlag=='removeProd'){
						order.memberChange.removeAndAdd(param);
					}else{
						_commonSubmit(param.boActionTypeCd,param.prodStatusCd,param.toprodStatusCd,param.itemSpecId,param.state);
					}
					OrderInfo.order.step=2;//订单确认页面
				});
				$("#templateOrderDiv").hide();
				if(param.boActionTypeCd==CONST.BO_ACTION_TYPE.OWE_REMOVE_PROD){
					$("#templateOrderDiv").show();
				}
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	var _commitRetainVice=function(param){
		//alert(param.submitFlag);
		//alert(OrderInfo.offer.offerId);
		OrderInfo.actionFlag=7;
		SoOrder.submitOrder(param.viceParam);
	};
	var _commitBuyBack=function(param){
		OrderInfo.actionFlag=20;
		var params = {viceParam:param.viceParam,remark:$("#order_remark").val()};
		SoOrder.submitOrder(params);
	};
	var _commonSubmit = function(boActionTypeCd,prodStatusCd,toprodStatusCd,itemSpecId,state) {
		//产品密码鉴权
		if(lteFlag){
			if((OrderInfo.password_remark).indexOf("'"+OrderInfo.boActionTypeCd+"'") >= 0){
				if(!_prodPassRemark()){
					return;
				};
			}
		};
		OrderInfo.actionClassCd = CONST.ACTION_CLASS_CD.PROD_ACTION;
		OrderInfo.boActionTypeCd = boActionTypeCd;
		if(_isNullParam(prodStatusCd)){
			prodStatusCd=CONST.PROD_STATUS_CD.NORMAL_PROD;
		}
		if(_isNullParam(toprodStatusCd)){
			toprodStatusCd=CONST.PROD_STATUS_CD.STOP_PROD;
		}
		var data = {};
		if(!_isNullParam(prodStatusCd)) {
			data.boProdStatuses = [{
				//atomActionId : OrderInfo.SEQ.atomActionSeq--,
				prodStatusCd : prodStatusCd,
				state : "DEL"
			},{
				//atomActionId : OrderInfo.SEQ.atomActionSeq--,
				prodStatusCd : toprodStatusCd,
				state : "ADD"
			}
			];
		}
		if(!_isNullParam(itemSpecId)) {
			data.busiOrderAttrs = [{
				//atomActionId : OrderInfo.SEQ.atomActionSeq--,
				itemSpecId : itemSpecId,
				value : $.trim($("textarea[id^=order_remark]").val())
			}];
		}
		SoOrder.submitOrder(data);
	};
	var _prodPassRemark = function (){
		var param = {};
		param.prodPwd = $.trim($("#remark_password").val());
		if(param.prodPwd==""){
			$.alert("提示","抱歉，您输入的密码不能为空，请重新输入!");
			return false;
		}
		//param.areaId = 21;//TODO need modify
		//param.accessNumber="11969577";;//TODO need modify
		param.accessNumber=order.prodModify.choosedProdInfo.accNbr;
		param.areaId=order.prodModify.choosedProdInfo.areaId;
		var url = contextPath+"/order/prodModify/prodAuth";
		var response = $.callServiceAsJson(url, param, {"before":function(){
			$.ecOverlay("<strong>产品密码鉴权中,请稍等...</strong>");
		}});
		if (response.code != 0||response.data!="true") {
			$.unecOverlay();
			$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
			return false;
		};
		$.unecOverlay();
		return true;
	};
	
	function _gotoOrderModify(response){
		var content$ = $("#order_fill_content");
		content$.html(response.data).show();
		
		$(".main_div .h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
		
		$("#ordercon").show();
		$("#ordertabcon").show();
		order.prepare.step(1);
		$("#orderedprod").hide();
		$("#order_prepare").hide();
		$(".ordercon a:first span").text("取 消");
		$(".main_body").css("height","150px");
		$(".main_body").css("min-height","150px");
		$("#order_confirm").empty();
		$("#fillLastStep").click(function(){
			order.prodModify.cancel();
		});
		/*
		$("#fillNextStep").unbind("click").bind("click",function(){
			_commonSubmit(param.boActionTypeCd,param.prodStatusCd,param.itemSpecId,param.state);
		});
		*/
		
	}
	
	//修改产品实例属性
	var _spec_parm_change= function(){	
		OrderInfo.busitypeflag=4;
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PRODUCT_PARMS,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		//OrderInfo.actionFlag=33;//改产品属性
		var checkRule = rule.rule.prepare(param,'order.prodModify.spec_parm_show',callParam);
	};
	//产品实例属性-展示
	var _spec_parm_show = function(){
		var param={
				prodInstId:_choosedProdInfo.prodInstId,
				offerSpecId:_choosedProdInfo.prodOfferId,
				prodSpecId:_choosedProdInfo.productId,
				partyId:OrderInfo.cust.custId,
				acctNbr:_choosedProdInfo.accNbr,
				areaId:_choosedProdInfo.areaId
		};
		$.callServiceAsHtmlGet(contextPath + "/order/orderSpecParamChange",param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response && response.code == -2){
					return ;
				}
				if(response && response.data){
					if(response.data==0||response.data==1){
						$.alert("提示","该产品无产品实例属性！");
					}else if(response.data==-1){
						$.alert("提示","产品实例属性加载异常！");
					}else{
						//$("#"+param.ul_id).append(response.data);
						_gotoOrderModify(response);		
					}
				}else{
					$.alert("提示","产品实例属性加载异常");
				}
			}
		});	
		
	};
	
	//修改产品密码 
	var _showPasswordChange = function () {
		OrderInfo.busitypeflag=17;
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		OrderInfo.actionFlag=31;//改产品密码
		var checkRule = rule.rule.prepare(param,'order.prodModify.spec_password_change',callParam);
	};
	//修改产品密码
	var _spec_password_change= function(){
		var param={"accNbr":_choosedProdInfo.accNbr};
		$.callServiceAsHtmlGet(contextPath + "/order/orderPasswordChange",param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				_gotoOrderModify(response);
				$('#password_form').bind('formIsValid',_spec_password_change_check).ketchup({bindElement:"btsubmit"});
			}
		});	
	};
	//产品密码修改-鉴权
	function _spec_password_change_check(){
		//SoOrder.builder();
		//SoOrder.builder(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD);
		if("none"!=$("#li_password_old").css("display")){
			if(!$("#password_old").val()){
				$.alert("操作提示","请输入 原产品密码");
				return ;
			}
		}
		if(!$("#password_change1").val()){
			$.alert("操作提示","请输入 产品密码");	
			return ;
		}else if(!$("#password_change2").val()){
			$.alert("操作提示","请输入 确认密码");	
			return ;
		}else if($("#password_change1").val()!=$("#password_change2").val()){
			$.alert("操作提示","两次密码不一致");	
			return ;
		}
		var reg = new RegExp("^([0-9]{6})$");//6位纯数字 0~9
		if(!reg.test($("#password_change1").val())){
			$.alert("提示","密码包含非数字或长度不是6位！");
			return;
		}
		var param = {
				password_old:$("#password_old").val(),
				accessNumber:_choosedProdInfo.accNbr,
				areaId:_choosedProdInfo.areaId
		} ;
		$.callServiceAsHtml(contextPath+"/order/orderPasswordCheck",param,{
			"before":function(){
				$.ecOverlay("<strong>正在提交中,请稍等...</strong>");
			},"done" : function(response){
				if(response && response.code == -2){
					return ;
				}
				var data = eval("(" + response.data + ")");
				//alert("--"+data.successed);
				if(data.successed==true||data.successed=="true"){
					_spec_password_change_save();
				}else{
					$.alert("密码校验失败",data.data);
					$.unecOverlay();
					return;
				}
			}
		});
	}
	//产品密码修改-提交
	function _spec_password_change_save(){
		var boProdPasswords = new Array();
		var boProdPasswords_del = {
				prodId : _choosedProdInfo.prodInstId, //从页面头部div获取
				prodPwTypeCd : "2", //密码类型
				pwd : $("#password_old").val(), //密码
				state : "DEL"  //动作
			};
		var boProdPasswords_add = {
				prodId : _choosedProdInfo.prodInstId, //从页面头部div获取
				prodPwTypeCd : "2", //密码类型
				pwd : $("#password_change1").val(), //密码
				state : "ADD"  //动作
			};
		boProdPasswords.push(boProdPasswords_del);
		boProdPasswords.push(boProdPasswords_add);
		var data = {boProdPasswords:boProdPasswords} ;
		OrderInfo.actionFlag=31;//改产品密码
		SoOrder.submitOrder(data);
		
	}
	
	
	//密码重置 校验
	var _showPasswordReset = function () {
		OrderInfo.busitypeflag=0;
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),"");
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PASSWORD),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		OrderInfo.actionFlag=32;//重置产品密码
		var checkRule = rule.rule.prepare(param,'order.prodModify.spec_password_reset',callParam);
	};
	//密码重置 修改
	var _spec_password_reset= function(){
		$.callServiceAsHtmlGet(contextPath + "/order/orderPasswordReset",null, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				_gotoOrderModify(response);
				//$('#password_form').bind('formIsValid').ketchup();
				$('#password_form').bind('formIsValid',_spec_password_reset_save).ketchup({bindElement:"btsubmit"});
			}
		});	
	};
	//密码重置 保存
	function _spec_password_reset_save(){
		/*
		if(!$("#password_change1").val()){
			$.alert("操作提示","请输入 产品密码");
			return ;
		}else if(!$("#password_change2").val()){
			$.alert("操作提示","请输入 确认密码");	
			return ;
		}else if($("#password_change1").val()!=$("#password_change2").val()){
			$.alert("操作提示","两次密码不一致");	
			return ;
		}
		*/
		
		var boProdPasswords = new Array();
		var boProdPasswords_del = {
				prodId : _choosedProdInfo.prodInstId, //从页面头部div获取
				prodPwTypeCd : "2", //密码类型
				pwd : "", //密码
				state : "DEL"  //动作
			};
		var boProdPasswords_add = {
				prodId : _choosedProdInfo.prodInstId, //从页面头部div获取
				prodPwTypeCd : "2", //密码类型
				pwd : "111111",//$("#password_change1").val(), //密码
				state : "ADD"  //动作
			};
		boProdPasswords.push(boProdPasswords_del);
		boProdPasswords.push(boProdPasswords_add);
		var data = {boProdPasswords:boProdPasswords} ;
		OrderInfo.actionFlag=32;//重置产品密码
		SoOrder.submitOrder(data);
	}
	
	//修改短号：校验
	function _shortnum_change(){
		//SoOrder.builder();
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.PRODUCT_PARMS,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.PRODUCT_PARMS,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		OrderInfo.actionFlag=34;//修改短号
		var checkRule = rule.rule.prepare(param,'order.prodModify.shortnum_show',callParam);
	}
	//修改短号--展示
	function _shortnum_show(id){
		var param={"prodId":_choosedProdInfo.prodInstId,acctNbr:_choosedProdInfo.accNbr};
		$.callServiceAsHtmlGet(contextPath + "/order/orderShortnumChange",param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response && response.code == -2){
					return ;
				}
				if(response && response.data){
					if(response.data==0){
						$.alert("提示","该产品无短号信息！");
					}else if(response.data==-1){
						$.alert("提示","加载短号信息异常！");
					}else{
						_gotoOrderModify(response);		
					}
				}else{
					$.alert("提示","短号加载异常");
				}
			}
		});	
	}
	function _shortnum_change_val(obj){
		if($(obj).attr("checkSta")=="2"&&$(obj).val()!=$(obj).attr("changeval")){
			$(obj).attr("checkSta","0");
		}
		/*
		var shortnum_sel = $("#shortnum_sel").val();
		var id = $("#ul_"+shortnum_sel).attr("t_id");
		var shortnum_val = $("#"+id).val() ;
		if($("#"+id).attr("checkSta")=="2"&&shortnum_val!=$("#"+id).attr("changeval")){
			$("#"+id).attr("checkSta","0");
		}
		*/
	}
	function _shortnum_check(){
		var shortnum_sel = $("#shortnum_sel").val();
		var id = $("#ul_"+shortnum_sel).attr("t_id");
		var shortnum_val = $("#"+id).val() ;
		var reg = new RegExp("^[0-9]*$");
		if(null==shortnum_val||""==shortnum_val){
			$.alert("提示","请输入新的短号");
			return;
		}else if(shortnum_val==$("#"+id).attr("oldval")){
			$.alert("提示","短号未修改，请修改后再校验");
			return ;
		}else if(!reg.test(shortnum_val)){
			$.alert("提示", "短号只能为数字，请重新输入！");
			return;
		}else if(shortnum_val==$("#"+id).attr("changeval")){
			if($("#"+id).attr("checkSta")=="2"){
				$.alert("提示", "短号已校验成功，可以使用！");
				return;
			}else if($("#"+id).attr("checkSta")=="1"){
				$.alert("提示", "短号未通过校验，请修改再试！");
				return;
			}
		}
		var param = {
				groupNbr:$("#"+id).attr("groupNbr"),//"18900000000",//
				extProdId:$("#"+id).attr("extProdId"),//"255",//
				productNbr:"",
				accNbr:_choosedProdInfo.accNbr,//18108880390,//
				extPordInstId:$("#"+id).attr("extPordInstId"),
				groupShortNbr:shortnum_val,
				lanId:$("#"+id).attr("lanId"),//"8320100",//
				checkNbr:$("#"+id).attr("changeval")
			};
		var url = contextPath+"/order/checkReleaseShortNum";
		$.callServiceAsJson(url,param,{
			"before":function(){
				$.ecOverlay("<strong>短号校验中,请稍等...</strong>");
			},"always":function(){
				$.unecOverlay();
			},"done" : function(response){
				$("#"+id).attr("changeval",shortnum_val);
				if (response.code == 0) {
					$("#"+id).attr("checkSta","2");
					$("#uimCheck").removeClass().addClass("order_check");
					$.alert("提示",response.data);
					return ;
				}else{
					$("#"+id).attr("checkSta","1");
					$.alert("提示",response.data);
					$("#uimCheck").removeClass().addClass("order_check_error");
					return ;
				}
			},"fail":function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
				return ;
			}
		});	
	}
	
	//修改短号--提交
	function _shortnum_save(){
		var shortnum_sel = $("#shortnum_sel").val();
		var id = $("#ul_"+shortnum_sel).attr("t_id");
		var shortnum_val = $("#"+id).val() ;
		if(shortnum_val==$("#"+id).attr("oldval")){
			$.alert("提示","短号未修改，请修改并校验");
			return;
		}else if($("#"+id).attr("checkSta")=="0"){
			$.alert("提示","短号未校验，请校验后再提交！");
			return ;
		}else if($("#"+id).attr("checkSta")=="1"){
			$.alert("提示","短号未通过校验，请修改再试！");
			return ;
		}
		//SoOrder.builder(CONST.ACTION_CLASS_CD.SHORTNUM_ACTION,CONST.BO_ACTION_TYPE.SHORT_NUM);
		
		//OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");
		//SoOrder.builder();
		var boProdCompItems = new Array();
		var boProdCompItems_row = {itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"DEL",value:$("#"+id).attr("oldval")} ;
		boProdCompItems.push(boProdCompItems_row);
		boProdCompItems_row = {itemSpecId:$("#"+id).attr("itemSpecId"),name:"",prodCompId:$("#"+id).attr("prodCompId"),state:"ADD",value:$("#"+id).val()} ;
		boProdCompItems.push(boProdCompItems_row);
		var boProdCompOrders_row = {"prodCompRelaRoleCd":$("#"+id).attr("prodCompRelaRoleCd"),"compProdId":$("#"+id).attr("compProdId"),"prodCompId":$("#"+id).attr("prodCompId")} ;
		var boProdCompOrders = new Array();
		boProdCompOrders.push(boProdCompOrders_row);
		var data = {boProdCompItems:boProdCompItems,boProdCompOrders:boProdCompOrders} ;
		//alert(JSON.stringify(data));
		//return ;
		OrderInfo.actionFlag=34;//修改短号
		SoOrder.submitOrder(data);
		
	}
	
	
	
	var _isNullParam = function(data){
		return data == undefined || !data;
	};
	
	//补换卡
	var _changeCard = function(param){
		//SoOrder.builder();
		
		$.callServiceAsHtml(contextPath+"/order/changeCard", param, {
			"before":function(){
			},
			"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$(".ordercon").show();
				$(".ordertabcon").show();
				$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
				order.prepare.step(1);
				$("#orderedprod").hide();
				$("#order_prepare").hide();
			},
			"always":function(){
				$.unecOverlay();
			}
		});
		
	};	
	
	var compspecGrps = "";
	var getCompInfo = function(compspecparam){
		var grprlue = ""
		var returndata = $.callServiceAsJson(contextPath+"/order/compPspecGrps", compspecparam, {});
		if(returndata.code == 0){
			if(returndata.data.length!=0){
				grprlue = returndata.data;
				compspecGrps = grprlue;//compspecGrps 其他地方用，弹窗显示的角色分类。grprlue 判断存不存在角色
			}
			return grprlue;
		}else if(returndata.code == -2){
			$.alertM(returndata.data);
			return "";
		}else{
			$.alert("提示","该产品不是组合产品，请重新选择！");
			return "";
		}
	};
	var _addComp = function(param){
		
		OrderInfo.initData("","",12,"纳入成员");
		SoOrder.builder();
		var compparam ={};
		$.callServiceAsHtml(contextPath+"/order/addComp", compparam, {
			"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$(".ordercon").show();
				$(".ordertabcon").show();
				order.prepare.step(1);
				$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
				$("#orderedprod").hide();
				$("#order_prepare").hide();
			},
			"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	//退出群组
	var _removeComp = function(param){
		
		OrderInfo.initData("","",12,"退出成员");
		SoOrder.builder();
		var compparam ={};
		$.callServiceAsHtml(contextPath+"/order/removeComp", compparam, {
			"done" : function(response){
				var content$ = $("#order_fill_content");
				content$.html(response.data).show();
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
				$(".ordercon").show();
				$(".ordertabcon").show();
				order.prepare.step(1);
				$("#orderedprod").hide();
				$("#order_prepare").hide();
			},
			"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	//查询群组的账号
	var _queryRomveAcc = function(){
		var prodnum = $.trim($("#removeAcc").val());
		if(prodnum==""){
			$.alert("提示","请输入需要查询的接入号！");
			return;
		}else{
			var params = {
				"compProdId":_choosedProdInfo.prodInstId,
				"accessNumber":prodnum
			};
		}
		var removephones = getChoosedMenbr();
		if(removephones.length!=0){
			for(var i=0;i<removephones.length;i++){
				if(prodnum==removephones[i]){
					$.alert("提示","该号码已经在待退出成员中，请重新选择！");
					return;
				}
			}
		}
		var url = contextPath+"/order/queryCompmenber";
		$.callServiceAsJson(url,params, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"done" : function(response){
				if (response.code == 0) {
					var compProdMemberInfos = response.data;
					if(compProdMemberInfos.length>0){
						var prodmenber = compProdMemberInfos[0];
						var addnbrhtml="<li id='li_"+prodmenber.accessNumber+"' prodInstId='"+prodmenber.prodId+"' phonenumber='"+prodmenber.accessNumber+"' prodCompRelaRoleCd='"+prodmenber.prodCompRelaRoleCd+
						"' prodCompRelaRoleName='"+prodmenber.prodCompRelaRoleName+"' prodCompId='"+prodmenber.prodCompId+"'>"+
						"<dd class='delete' onclick='order.prodModify.removeCompDelSelect(this);'></dd><span id='addNbr'>"+prodmenber.accessNumber+"</span>";
						$("#choosed_menbers").append(addnbrhtml);
					}else{
						$.alert("提示","该号不在群组成员中，请重新选择！");
						return;
					}
				}else if(response.code == -2){
					$.alertM(response.data);
				}else{
					$.alert("提示",response.data);
					return;
				}
			},
			"always":function(){
				$.unecOverlay();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","套餐加载失败，请稍后再试！");
			}
		});		
	};
	
	//可选包订购退订
	var _orderAttachOffer = function () {
		OrderInfo.busitypeflag=14;
		AttachOffer.init();
	};
	
	//套餐变更
	var _changeOffer = function () {
		OrderInfo.busitypeflag=2;
		offerChange.init();
	};
	
	//改付费帐户规则校验
	var _showChangeAccount = function(){
		OrderInfo.busitypeflag=16;
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,_choosedProdInfo.prodInstId);
		var callParam = {
				boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,
				boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),
				accessNumber : _choosedProdInfo.accNbr,
				prodOfferName : _choosedProdInfo.prodOfferName
			};
		var flag = rule.rule.prepare(param,'order.prodModify.changeAccount',callParam);
		if (flag) return;
		//SoOrder.builder();
	};
	
	//获取产品原帐户信息并转至改付费帐户页面
	var _changeAccount = function(){
		if(!_choosedProdInfo.prodInstId || !_choosedProdInfo.accNbr){
			$.alert("提示","产品信息定位异常，请联系管理员");
			$("#orderedprod").show();
			$("#order_prepare").show();
			$("#order_tab_panel_content").show();
			$("#order_confirm").show();
			$("#order_fill_content").hide();
			order.prepare.hideStep();
			return;
		}
		var param = {
			prodId : _choosedProdInfo.prodInstId,
			acctNbr : _choosedProdInfo.accNbr,
			areaId : _choosedProdInfo.areaId
		};
		$.callServiceAsJson(contextPath+"/order/queryProdAcctInfo", param, {
			"before":function(){
				$.ecOverlay("<strong>正在确认当前产品帐户,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(jr){
				if(jr.code != 0||jr.data.length==0) {
					if(jr.code==-2){
						$.alertM(jr.data);
					}
					else{
						$.alert("提示","当前产品帐户定位失败，请联系管理员");
					}
					$("#orderedprod").show();
					$("#order_prepare").show();
					$("#order_tab_panel_content").show();
					$("#order_confirm").show();
					$("#order_fill_content").hide();
					order.prepare.hideStep();
					return;
				}				
				var prodAcctInfos = jr.data;
				$.callServiceAsHtml(contextPath+"/order/preChangeAccount", prodAcctInfos, {
					"before":function(){
						$.ecOverlay("<strong>当前产品帐户已确认</strong>");
					},
					"always":function(){
						$.unecOverlay();
					},
					"done":function(response){
						if(!response){
							 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';
						}
						if(response.code != 0) {
							$.alert("提示","查询失败,请稍后重试");
							return;
						}											
						$("#order_fill_content").html(response.data).show();
						$(".h2_title").append(_choosedProdInfo.productName+"-"+_choosedProdInfo.accNbr);
						$("#origAccts option:first").attr("selected", "selected");
						//获取账单投递信息主数据				
						acct.acctModify.getBILL_POST();
					},
					fail:function(response){
						$.unecOverlay();
						$.alert("提示","请求可能发生异常，请稍后再试！");
					}
				});
			}
		});
	};
	
	//产品下原有付费帐户展示（弹出框）
	var _showOrigAccts = function(){
		easyDialog.open({
			container : "origAcctDialog"
		});
		$("#origAcctClose").click(function(){
			easyDialog.close();
		});
	};
		
	//查询帐户信息并选择新的付费帐户（弹出框）
	var _chooseAcct = function() {
		$("#chooseQueryAcctType").find("option[value=1]").attr("selected","selected");
		$("#d_query_nbr").show();
//		$("#d_query_pwd").show();
		easyDialog.open({
			container : "queryAcctDialog"
		});
		$("#chooseQueryAcctType").change(function(){
			if($("#chooseQueryAcctType").val()==1){
				$("#d_query_cd").hide();
				$("#d_query_nbr").show();
//				$("#d_query_pwd").show();
			}
			else{				
				$("#d_query_nbr").hide();
				$("#d_query_pwd").hide();
				$("#d_query_cd").show();
			}
		});
		$("#queryAcctClose").click(function(){
			$("#acctListTab tbody").empty();
			$("#d_query_cd").hide();
			$("#d_query_nbr").hide();
//			$("#d_query_pwd").hide();
			easyDialog.close();
		});
	};
			
	//查询帐户,显示查询结果，记录选择的帐户信息
	var newAcctList = [];
	var _queryAccount = function(acctSelect){
		//根据接入号查询帐户
		var response;
		if($("#chooseQueryAcctType").val()==1){
			if(!CONST.LTE_PHONE_HEAD.test($.trim($("#d_query_nbr input").val()))){					
				$.alert("提示", "请输入有效的中国电信手机号");					
				return;				
			}
//			var param = {
//					accessNumber : $("#d_query_nbr input").val(),
//					prodPwd : $("#d_query_pwd input").val()
//			};
			//根据接入号查询帐户需先经过产品密码鉴权
//			var jr = $.callServiceAsJson(contextPath+"/order/prodAuth", param);
//			if(jr.code==0){
				var acctQueryParam = {
					accessNumber : $("#d_query_nbr input").val()
				};
				response = order.prodModify.returnAccount(acctQueryParam);		
//			}
//			else{
//				$.alert("提示",jr.data);
//			}
		}
		//根据合同号查询帐户
		else{
			var acctQueryParam = {
					acctCd : $("#d_query_cd input").val()
			};
			response = order.prodModify.returnAccount(acctQueryParam);
		}		
		$("#acctListTab tbody").empty();
		if(response.code==0){
			var returnMap = response.data;
			if(returnMap.resultCode==0){
				if(returnMap.accountInfos && returnMap.accountInfos.length>0){
					var accountInfos = returnMap.accountInfos;
					$.each(accountInfos, function(i, accountInfo){					
						var tr = $("<tr></tr>").appendTo($("#acctListTab tbody"));
						if(accountInfo.name){
							$("<td class='teleNum'>"+accountInfo.name+"</td>").appendTo(tr);
						}
						else{
							$("<td></td>").appendTo(tr);
						}
						if(accountInfo.acctId){
							$("<td acctId='"+accountInfo.acctId+"'>"+accountInfo.accountNumber+"</td>").appendTo(tr);
						}
						else{
							$("<td></td>").appendTo(tr);
						}
						if(accountInfo.owner){
							$("<td>"+accountInfo.owner+"</td>").appendTo(tr);
						}
						else{
							$("<td></td>").appendTo(tr);
						}
						if(accountInfo.accessNumber){
							$("<td>"+accountInfo.accessNumber+"</td>").appendTo(tr);
						}
						else{
							$("<td></td>").appendTo(tr);
						}
						tr.click(function(){
							var newAccount = {
									acctCd : accountInfo.accountNumber,
									acctId : accountInfo.acctId,
									acctRelaTypeCd : "1",
									chargeItemCd : 1,               //账目项标识，暂固定为1，表示支付所有账目项
									percent : "100",                //支付比重，该账目项占该产品的价格比重，与上一个属性相匹配，暂固定为100
									priority : "1",                 //支付优先级，暂固定为1，表示最高优先级
									prodAcctId : "-1",              //标识产品与帐户的支付匹配关系，新选的帐户和该产品无匹配关系，默认 -1
									state : "ADD"
							};
							newAcctList.push(newAccount);
							
							$("#acctListTab tbody").empty();
							$("#d_query_cd").hide();
							$("#d_query_nbr").hide();
							$("#d_query_pwd").hide();
							$("#defineNewAcct").hide();
							easyDialog.close();
							var found = false;
							$.each($(acctSelect).find("option"), function(i, option){
								if($(option).val()==accountInfo.acctId){
									found = true;
									return false;
								}								
							});
							if(found==false){										
								$("<option>").text(accountInfo.name+" : "+accountInfo.accountNumber).attr("value", accountInfo.acctId).appendTo($(acctSelect));
							}
							$(acctSelect).find("option[value=default]").remove();
							$(acctSelect).find("option[value="+accountInfo.acctId+"]").attr("selected","selected");
						});
					});			
				}
				else{
					$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"));
				}	
			}
			else{
				$("<tr><td colspan=4>"+returnMap.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"));
			}
		}
		else{
			$("<tr><td colspan=4>"+response.data+"</td></tr>").appendTo($("#acctListTab tbody"));
		}
	};
	
	//帐户查询请求（二次业务时查询已有帐户）
	var _returnAccount = function(acctQueryParam){
		acctQueryParam.areaId =  _choosedProdInfo.areaId;
		acctQueryParam.isServiceOpen="Y";
		var response = $.callServiceAsJson(contextPath+"/order/account", acctQueryParam);
		if(response.code==-2){
			$.alertM(response.data);
			return;
		}
		return response;
	};
	
	//新建帐户
	var _createAcct = function(){
		var newAccount = {
				acctCd : -1,
				acctId : -1,
				acctRelaTypeCd : "1",
				chargeItemCd : 1,               //账目项标识，暂固定为1，表示支付所有账目项
				percent : "100",                //支付比重，该账目项占该产品的价格比重，与上一个属性相匹配，暂固定为100
				priority : "1",                 //支付优先级，暂固定为1，表示最高优先级
				prodAcctId : "-1",              //标识产品与帐户的支付匹配关系，新选的帐户和该产品无匹配关系，默认 -1
				state : "ADD"
		};
		newAcctList.push(newAccount);
		$("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>").appendTo($("#newAccts"));
		$("#newAccts").find("option[value=default]").remove();
		$("#newAccts").find("option[value=-1]").attr("selected","selected");
		$("#acctName").val(OrderInfo.cust.partyName);//默认帐户名称为客户名称
		$("#newAccts").parent().find("a:eq(1)").hide();
		//新增帐户自定义支付属性
		$("#defineNewAcct").show();
		acct.acctModify.ifCanAdjustBankPayment();//查询工号权限：能否选择银行托收
		acct.acctModify.paymentType();
		acct.acctModify.billPostType();
	};
	
	//切换新付费帐户
	var _ifNewAcct = function(acctSelect){
		if($(acctSelect).val()<0){
			if(OrderInfo.actionFlag!=2){
				$("#defineNewAcct").show();
			}
		}
		else{
			$("#defineNewAcct").hide();
		}
	};

	//改付费帐户提交（下一步）
	var _changeAccountSave = function(){
		
		//帐户信息校验
		if($("#newAccts").val()=="default"){
			$.alert("提示","请选择新帐户");
			return;
		}		
		//新建帐户支付信息与投递信息填写校验
		if($("#newAccts").val()<0){
			//帐户信息填写校验
			if(!SoOrder.checkAcctInfo()){
				return;
			}
		}

		var repick = false;
		var origAccts = $("#origAccts").find("option");
		$.each(origAccts, function(i, origAcct){
			if($("#newAccts").val()==$(origAcct).val()){
				repick = true;
				return false;
			}
		});
		if(repick==false){
			
			var delAcctId = $("#origAccts").val();
			var origAcct = $("#origAcctList tbody").find("tr[id="+delAcctId+"]");							
			
			var _acctCd = $(origAcct).find("td:eq(4)").text();					
			var _acctId = $(origAcct).find("td:eq(0)").text();					
			var _chargeItemCd = $(origAcct).find("td:eq(2)").text();					
			var _percent = $(origAcct).find("td:eq(7)").text();					
			var _priority = $(origAcct).find("td:eq(8)").text();
			if(_priority==""){
				_priority = 1;
			}
			var _prodAcctId = $(origAcct).find("td:eq(1)").text();	
			
			var origAcctInfo = {							
					acctCd : _acctCd,							
					acctId : _acctId,							
					acctRelaTypeCd : "1",							
					chargeItemCd : _chargeItemCd,				
					percent : _percent,							
					priority : _priority,							
					prodAcctId : _prodAcctId,						
					state : "DEL"					
			};
				
			var newAcctInfo;
			$.each(newAcctList, function(i, newAccount){
				if(newAccount.acctId==$("#newAccts").val()){
					newAcctInfo = newAccount;
					return false;
				}
			});
			
			var _boAccountRelas = [];
			_boAccountRelas.push(origAcctInfo);
			_boAccountRelas.push(newAcctInfo);
		
			var _busiOrderAttrs = [];
			var remark = $("#orderRemark").val();		
			_busiOrderAttrs.push({
				itemSpecId : "111111118",
				value : remark
			});
		
			var data = {
					boAccountRelas : _boAccountRelas,
					busiOrderAttrs : _busiOrderAttrs
			};
			//更换的帐户为新建帐户
			if($("#newAccts").val()==-1){
				OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,10,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");
				var busiOrder = [];
				//新建帐户节点
				OrderInfo.createAcct(busiOrder, -1);
				//更改帐户节点
				var acctChangeNode = {
						areaId : _choosedProdInfo.areaId,
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq-- 
						}, 
						busiObj : {
							accessNumber: _choosedProdInfo.accNbr,
                            instId: _choosedProdInfo.prodInstId,
                            isComp: "N",
                            objId: _choosedProdInfo.productId,
                            offerTypeCd: "1"
						},  
						boActionType : {
							actionClassCd : 1300,
							boActionTypeCd : "-6"
						}, 
						data : data
				};
				busiOrder.push(acctChangeNode);
				
				SoOrder.submitOrder(busiOrder);
			}
			//更换的帐户为已有帐户
			else{
				OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.CHANGE_ACCOUNT),"");
				SoOrder.submitOrder(data);
			}			
		}
		else{
			$.alert("提示","该帐户已经是付费帐户了，请重新选择");
			return;
		}		
	};
	
	//退出二次业务
	var _cancel = function() {
		$.confirm("信息","确定取消当前操作吗？",{
		yes:function(){			
			//退出二次业务时释放被预占的UIM卡
			var boProd2Tds = OrderInfo.boProd2Tds;
			if(boProd2Tds.length>0){
				for(var n=0;n<boProd2Tds.length;n++){
					var param = {
							numType : 2,
							numValue : boProd2Tds[n].terminalCode
					};
					$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
				}
			}
			//退出二次业务时释放被预占的号码（过滤身份证预占的号码）
			var boProdAns = OrderInfo.boProdAns;
			if(boProdAns.length>0){
				for(var n=0;n<boProdAns.length;n++){
					if(boProdAns[n].idFlag){
						continue;
					}
					var param = {
							numType : 1,
							numValue : boProdAns[n].accessNumber
					};
					$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
				}
				order.service.boProdAn = {};
				order.phoneNumber.resetBoProdAn();
			}			
			//页面变动
			$("#order_fill_content").empty();
			OrderInfo.order.step=0;//订单初始页面
			order.prepare.hideStep();
			$("#orderedprod").show();
			$("#order_prepare").show();
			if(OrderInfo.actionFlag == 6){
				$("#order_tab_panel_content").hide();
			}
		},no:function(){
			
		}},"question");
	};
	
	//加入组合入参
	var compparam = "";
	var _queryCustProd = function(){
		var hasmeneber = false;
		var prodnum = $.trim($("#prodnbr").val());
		if(prodnum==""){
			$.alert("提示","请输入需要查询的接入号！");
			return;
		}else{
			hasmeneber = isExist(prodnum);
		}
		if(hasmeneber.flag){
			if(hasmeneber.data=="1"){
				var param = {};
				var prodnum = $.trim($("#prodnbr").val());
				param.acctNbr=prodnum;
				var url = contextPath+"/cust/queryprodbynbr";
			}else{
				$.alert("提示","该产品已经在组合中，请重新选择！");
				return;
			}
		}else{
			return;
		}
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>';
				}
				if(response.code == -2){
					return;
				}else if(response.code != 0) {
					$.alert("提示","客户查询失败,稍后重试");
					return;
				}
				var content$=$("#prodinst");
				content$.html(response.data);
			}
		});	
	};
	
	var _compChangeTab = function(num){
		if(num == 1){
			$("#tab_1").addClass("setcon");
			$("#tab_2").removeClass("setcon");
			$("#addCompPage").show();
			$("#releaseShortNum").hide();
			$("#compopr").show();
		}else{
			$("#tab_2").addClass("setcon");
			$("#tab_1").removeClass("setcon");
			$("#addCompPage").hide();
			$("#releaseShortNum").show();
			$("#compopr").hide();
		}
	};
	
	var _addToComp = function(obj){
		var phonenumber = $(obj).parent().parent().children(":first-child").next().text();
		var productId = $(obj).parent().parent().children(":last-child").text();
		var prodInstId = $(obj).parent().parent().children().eq(-2).text();
		var prodStateCd = $(obj).parent().parent().children().eq(-3).text();
		var linum = $("#choosed_menbers li").length;
		if(linum>12){
			$.alert("提示","已经超过了加入的最大数量！");
			return;
		}
		if(prodStateCd!="100000"){
			$.alert("提示","该产品状态不符，不能纳入成员！");
			return;
		}
		var addphones = getChoosedMenbr();
		if(addphones.length!=0){
			for(var i=0;i<addphones.length;i++){
				if(phonenumber==addphones[i]){
					$.alert("提示","该号码已经在待纳入成员中，请重新选择！");
					return;
				}
			}
		}
		ec.form.dialog.createDialog({
			"id":"-grps",
			"initCallBack":function(dialogForm,dialog){
				var compdata = compspecGrps;
				var compPspecCompGrp2Pspecs = compspecGrps[0].compPspecCompGrp2Pspecs;//成员角色
				var compPspecCompGrpRelas = compspecGrps[0].compPspecCompGrpRelas;//子组角色
				if(compPspecCompGrpRelas==undefined){
					compPspecCompGrpRelas = [];
				}
				var zNodes=[];
				var menber=[];
				for(var i=0;i<compPspecCompGrp2Pspecs.length;i++){
					var grpspec = {
						name:compPspecCompGrp2Pspecs[i].prodSpecName,
						prodCompRelaRoleCd:compPspecCompGrp2Pspecs[i].prodCompRelaRoleCd,
						prodCompRelaRoleName:compPspecCompGrp2Pspecs[i].prodCompRelaRoleName,
						prodSpecId:compPspecCompGrp2Pspecs[i].prodSpecId
					};
					menber.push(grpspec);
				}
				var childmenber = [];
				for(var i=0;i<compPspecCompGrpRelas.length;i++){
					var compPspecCompGrpRelasSpecs = compPspecCompGrpRelas[i];
					var childSpec = [];
					for(var j=0;j<compPspecCompGrpRelasSpecs.length;j++){
						var grpspec = {
							name:compPspecCompGrpRelasSpecs[j].prodSpecName,
							prodCompRelaRoleCd:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleCd,
							prodCompRelaRoleName:compPspecCompGrpRelasSpecs[j].prodCompRelaRoleName,
							prodSpecId:compPspecCompGrpRelasSpecs[j].prodSpecId
						};
						childSpec.push(grpspec);
					}
					var childrole = {
						name:compPspecCompGrpRelasSpecs[i].compPspecCompGrpName,
						children:childSpec
					}
					childmenber.push(childrole);
				}
				var setting = {	
					data: {
						key: {
							title:"t"
						},
						simpleData: {
							enable: true
						}
					},
					callback: {
						onClick: onClick
					}
				};
				if(compPspecCompGrp2Pspecs.length!=0){
					var node = {
						name:"成员",
						open:true,
						children:menber
					};
					zNodes.push(node);
				}
				if(compPspecCompGrpRelas.length!=0){
					var node = {
						name:"子组",
						children:childmenber
					};
					zNodes.push(node);
				}
				if(compPspecCompGrp2Pspecs.length==0&&compPspecCompGrpRelas.length==0){
					$.alert("提示","该产品没有成员规则，请重新选择群组产品！");
					return;
				}
				var prodCompRelaRoleCd="";
				var prodCompRelaRoleName="";
				function onClick(event, treeId, treeNode, clickFlag) {
					prodCompRelaRoleCd="";
					prodCompRelaRoleName="";
					var prodSpecId = treeNode.prodSpecId;
					if(prodSpecId==productId){//不同产品只能加入到指定类别下
						prodCompRelaRoleCd=treeNode.prodCompRelaRoleCd;
						prodCompRelaRoleName=treeNode.prodCompRelaRoleName;
					}else{
						$.alert("提示","不能加入该角色，请重新选择！");
					}
				}	
				$.fn.zTree.init($("#rluename"), setting, zNodes);
				
				$("#nextstep").click(function(){
					if(prodCompRelaRoleCd!=""&&prodCompRelaRoleName!=""){
						$("#dialogtitle").html('设置短号');
						var shortnumhtml = "短号设置：<input type='text' id='shortnumtext' class='inputWidth183px'/>";
						$("#rluename").html('').html(shortnumhtml);
						$("#nextstep").hide();
						$("#submitbtn2").show();
					}else{
						$.alert("提示","请选择所需纳入的成员！");
						return;
					}
				});
				$("#submitbtn2").click(function(){
					var shortnum = $("#shortnumtext").val();
					var reg = new RegExp("^[0-9]*$");
					if(shortnum==''){
						$("#errinfo").html("对不起，请输入短号！");
						return;
					}
				    if(!reg.test(shortnum)){
				    	$("#errinfo").html("短号只能为数字，请重新输入！");
						return;
				    }
				    var param = {
				    	groupNbr:_choosedProdInfo.accNbr,
						extProdId:_choosedProdInfo.productId,
						productNbr:"",
						accNbr:phonenumber,
						extPordInstId:_choosedProdInfo.prodInstId,
						shortNbr:shortnum,
						statusCd:"1102"
					};
					var url = contextPath+"/order/checkGroupShortNum";
					var res = $.callServiceAsJson(url,param,{});	
					if (res.code == 0) {
						var addnbrhtml="<li id='li_"+phonenumber+"' prodInstId='"+prodInstId+"' phonenumber='"+phonenumber+"' prodCompRelaRoleCd='"+prodCompRelaRoleCd+
						"' prodCompRelaRoleName='"+prodCompRelaRoleName+"' productId='"+productId+"' style='width:280px;'>" +
						"<dd class='delete' onclick='order.prodModify.addCompDelSelect(this);'></dd>"+
						"<span id='addNbr' style='display:inline;padding:0 5px 0 22px;'>"+phonenumber+"</span>"+
						"<span style='display:inline;padding:0px;'>[短号：</span><span style='display:inline;padding:0px;' id='shortNumber'>"+shortnum+
						"</span><span class='modshortnum' onclick='order.prodModify.changeShortNum(this);' style='display:inline;padding:0 25px 0 20px;'></span>"+
						"<span style='display:inline;padding:0px;'>]</span>";
						$("#choosed_menbers").append(addnbrhtml);
						dialogForm.close(dialog);
					}else if(res.code == -2){
						$.alertM(res.data);
					}else{
						$.alert("提示",res.data);
					}
				});
			},
			"submitCallBack":function(dialogForm,dialog){},
			width:400,height:150
		});
	};
	
	var getChoosedMenbr = function(){
		var numbers = [];
		$("#choosed_menbers li").each(function(){
			var phonenum= $(this).children('span#addNbr').text();
			numbers.push(phonenum);
		});
		return numbers;
	};
	
	var boolHasShortNum = function(){
		var hasshrot = true;
		$("#choosed_menbers li").each(function(){
			var phonenum= $(this).children('span#shortNumber').text();
			if(phonenum==""){
				hasshrot = false;
			}
		});
		return hasshrot;
	};
	
	var _changeShortNum =function(obj){
		var phonenum = $(obj).parent().children('span#addNbr').text();
		var shortnum = $(obj).parent().children('span#shortNumber').text();
		ec.form.dialog.createDialog({
			"id":"-shrotnum",
			"initCallBack":function(dialogForm,dialog){
				$("#shortnumval").val(shortnum);
				$("#submitbtn3").click(function(){
					shortnum = $(obj).parent().children('span#shortNumber').text();
					var newshortnum = $("#shortnumval").val();
					if(shortnum==newshortnum){
						dialogForm.close(dialog);
					}
					if(shortnum==""&&newshortnum!=""){
						var result = getOprShortNumInfo(phonenum,newshortnum,"1102");
						if(result.code==0){
							$("#li_"+phonenum).children('span#shortNumber').html(newshortnum);
						}else if(result.code==-2){
							$.alertM(result.data);
							return;
						}else{
							$.alert("提示","短号预占失败！");
							return;
						}
						dialogForm.close(dialog);
					}
					if(shortnum!=""&&newshortnum==""){
						$.alert("提示","请输入短号！");
						return;
					}
					if(shortnum!=""&&newshortnum!=""){
						var resultremove = getOprShortNumInfo(phonenum,shortnum,"1000");
						if(resultremove.code==0){
							$("#li_"+phonenum).children('span#shortNumber').html('');
						}else if(resultremove.code==-2){
							$.alertM(resultremove.data);
							return;
						}else{
							$.alert("提示","短号预占失败！");
							return;
						}
						var resultadd = getOprShortNumInfo(phonenum,newshortnum,"1102");
						if(resultadd.code==0){
							$("#li_"+phonenum).children('span#shortNumber').html(newshortnum);
						}else if(resultadd.code==-2){
							$.alertM(resultadd.data);
							return;
						}else{
							$.alert("提示","预占失败！");
							return;
						}
						dialogForm.close(dialog);
					}
				});
			},
			"submitCallBack":function(dialogForm,dialog){},
			width:350,height:100
		});
	};
	
	var getOprShortNumInfo = function(accNbr,shortNbr,statusCd){
		var param = {
			groupNbr:_choosedProdInfo.accNbr,
			extProdId:_choosedProdInfo.productId,
			productNbr:"",
			accNbr:accNbr,
			extPordInstId:_choosedProdInfo.prodInstId,
			shortNbr:shortNbr,
			statusCd:statusCd
		};
		var url = contextPath+"/order/checkGroupShortNum";
		var res = $.callServiceAsJson(url,param,{});
		return res;
	};
	
	var _releaseShortNum = function(){
		var shortNbr = $("#resshortnum").val();
		var param = {
			groupNbr:_choosedProdInfo.accNbr,
			extProdId:_choosedProdInfo.productId,
			productNbr:"",
			accNbr:"",
			extPordInstId:_choosedProdInfo.prodInstId,
			shortNbr:shortNbr,
			statusCd:"1000"
		};
		var url = contextPath+"/order/checkGroupShortNum";
		var res = $.callServiceAsJson(url,param,{});
		if(res.code==0){
			$.alert("提示","短号释放成功！");
			$("#choosed_menbers li").each(function(){
				var shortNum= $(this).children('span#shortNumber').text();
				if(shortNbr==shortNum){
					$(this).children('span#shortNumber').html('');
				}
			});
		}else if(res.code==-2){
			$.alertM(res.data);
			return;
		}else{
			$.alert("提示",res.data);
		}
	};
	
	var canAddAnother = function(){
		var phonelist = $("#choosed_menbers").html();
		phonelist = phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");
		if(phonelist!=''){
			var lastspan = $("#choosed_menbers").children(':last-child').children('span').length;
			if(lastspan<2){
				return false;
			}else{
				return true;
			}
		}else{
			return true;	
		}
	};
	
	var isExist = function(prodnum){
		var params = {
			"compProdId":_choosedProdInfo.prodInstId,
			"accessNumber":prodnum
		};
		var url = contextPath+"/order/queryCompmenber";
		var returndata = {};
		var isexist = $.callServiceAsJson(url,params, {});
		if (isexist.code == 0) {
			returndata.flag = true;
			var compProdMemberInfos = isexist.data;
			if(compProdMemberInfos.length>0){
				returndata.data="0";//表示在群组里面
			}else{
				returndata.data="1";//表示不在群组里面
			}
			return returndata;
		}else if(isexist.code == -2){
			$.alertM(returndata.data);
			returndata.flag = false;
		}else{
			returndata.flag = false;
			$.alert("提示",isexist.data);
			return returndata;
		}
	};
	
	var _addCompSubmit = function(){
		var phonelist = $("#choosed_menbers").html();
		phonelist = phonelist.replace(/[\r\n]/g,"").replace(/[ ]/g,"");
		if(phonelist==""){
			$.alert("提示","请选择纳入组合的成员！");
			return;
		}
		var boolshort = boolHasShortNum();
		if(!boolshort){
			$.alert("提示","待加入成员未全部设置短号，请全部设置好后再提交！");
			return;
		}
		var busiOrder = [];
		var addMenbers = [];
		var prodCompId = -1;
		$("#choosed_menbers li").each(function(){
			var prodInstId = $(this).attr('prodInstId');
			var phonenumber = $(this).attr('phonenumber');
			var prodCompRelaRoleCd = $(this).attr('prodCompRelaRoleCd');
			var prodCompRelaRoleName = $(this).attr('prodCompRelaRoleName');
			var productId = $(this).attr('productId');
			var shortnum =$(this).children('span#shortNumber').text();
			addMenbers.push(phonenumber);
			var compparam = {
				"busiOrderInfo": {
					"seq": OrderInfo.SEQ.seq--
		        },
		        "busiObj": {
			        "objId": CONST.PROD_SPEC.CDMA,
			        "instId": prodInstId,
			        "accessNumber": phonenumber
		        },
	            "boActionType": {
	                "actionClassCd": CONST.ACTION_CLASS_CD.PROD_ACTION,
	                "boActionTypeCd": CONST.BO_ACTION_TYPE.ADD_COMP
	            },
	            "areaId": OrderInfo.staff.areaId,
	            "aggreementId": "",
	            "data": {
	            	"boProdCompOrders": [{
	            		"prodCompRelaRoleCd": prodCompRelaRoleCd,
	                    "prodCompRelaRoleName": prodCompRelaRoleName,
	                    "prodCompId": prodCompId,
	                    "compProdId": _choosedProdInfo.prodInstId
	                }],
	                "boProdCompRelas": [{
	                	"prodCompId": prodCompId,
	                    "state": "ADD",
	                    "atomActionId":OrderInfo.SEQ.atomActionSeq--
	                }],
	                "boProdSpecs": [{
	                	"prodSpecId": productId,
	                    "atomActionId": OrderInfo.SEQ.atomActionSeq--,
	                    "state": "KIP"
	                }],
	                "boProdCompItems":[{
	        			"itemSpecId": "37906",
	        			"name": "",
	        			"prodCompId": prodCompId,
	        			"state": "ADD",
	        			"value": shortnum,
	        			"atomActionId":OrderInfo.SEQ.atomActionSeq--
	        		}],
	        		"busiOrderAttrs":[{
	        			itemSpecId:"111111111",
	        			value:$("#orderRemark").val()
	        		}]
	            }
	        };
			busiOrder.push(compparam);
			prodCompId--;
		});
		OrderInfo.confirmList = [];
		var comfimProdInfo = {
			name:_choosedProdInfo.productName,
			accNbr : [_choosedProdInfo.accNbr]
		};
		OrderInfo.confirmList.push(comfimProdInfo);
		var comfimMeneber = {
			name:"纳入成员",
			accNbr : addMenbers
		};
		OrderInfo.confirmList.push(comfimMeneber);
		SoOrder.submitOrder(busiOrder);
	};
	
	var _removeCompSubmit = function(){
		var t = $("#choosed_menbers").html();
        t = t.replace(/[\r\n]/g,"").replace(/[ ]/g,"");
		if(t==""){
			$.alert("提示","请选择退出组合的成员！");
			return;
		}
		var busiOrder = [];
		var addMenbers = [];
		$("#choosed_menbers li").each(function(){
			var prodInstId = $(this).attr('prodInstId');
			var phonenumber = $(this).attr('phonenumber');
			var prodCompRelaRoleCd = $(this).attr('prodCompRelaRoleCd');
			var prodCompRelaRoleName = $(this).attr('prodCompRelaRoleName');
			var prodCompId = $(this).attr('prodCompId');
			addMenbers.push(phonenumber);
			var compparam = {
				"busiOrderInfo": {
					"seq": -1
				},
			    "busiObj": {
				    "objId": CONST.PROD_SPEC.CDMA,
				    "instId": prodInstId,
				    "accessNumber": phonenumber
			    },
		        "boActionType": {
		            "actionClassCd": CONST.ACTION_CLASS_CD.PROD_ACTION,
		            "boActionTypeCd": CONST.BO_ACTION_TYPE.ADD_COMP
		        },
		        "areaId": OrderInfo.staff.areaId,
		        "aggreementId": "",
		        "data": {
		        	"boProdCompOrders": [{
		            	"prodCompRelaRoleCd": prodCompRelaRoleCd,
		                "prodCompRelaRoleName": prodCompRelaRoleName,
		                "prodCompId": prodCompId,
		                "compProdId": _choosedProdInfo.prodInstId
		            }],
		            "boProdCompRelas": [{
		                "prodCompId": prodCompId,
		                "state": "DEL"
		            }],
		        	"busiOrderAttrs":[{
		    			itemSpecId:"111111111",
		    			value:$("#orderRemark").val()
		    		}]
		        }
			};
			busiOrder.push(compparam);
		});
		OrderInfo.confirmList=[];
		var comfimProdInfo = {
			name:_choosedProdInfo.productName,
			accNbr : [_choosedProdInfo.accNbr]
		};
		OrderInfo.confirmList.push(comfimProdInfo);
		var comfimMeneber = {
			name:"退出成员",
			accNbr : addMenbers
		};
		OrderInfo.confirmList.push(comfimMeneber);
		SoOrder.submitOrder(busiOrder);
	};
	
	var _removeCompDelSelect = function(obj){
		$.confirm("确认","确定要取消该号码吗?",{ 
			yes:function(){
				var accNbr = $(obj).next().text();
				$("#li_"+accNbr).remove();
			},
			no:function(){						
			}
		});
	};
	
	var _addCompDelSelect = function(obj){
		$.confirm("确认","确定要取消该号码吗?",{ 
			yes:function(){
				var accNbr = $(obj).parent().children('span#addNbr').text();
				var shortnum =$(obj).parent().children('span#shortNumber').text();
				if(shortnum!=""){
					var param = {
						groupNbr:_choosedProdInfo.accNbr,
						extProdId:_choosedProdInfo.productId,
						productNbr:"",
						accNbr:accNbr,
						extPordInstId:_choosedProdInfo.prodInstId,
						shortNbr:shortnum,
						statusCd:"1000"
					};
					var url = contextPath+"/order/checkGroupShortNum";
					var response = $.callServiceAsJson(url,param,{});
					if(response.code==0){
						$("#li_"+accNbr).remove();
					}else if(response.code==-2){
						$.alertM(response.data);
					}else{
						alert("删除失败");
					}
				}else{
					$("#li_"+accNbr).remove();
				}
				
			},
			no:function(){						
			}
		});
	};

	//返销
	var _showBuyBack = function () {
		OrderInfo.busitypeflag=0;
		var param = _getCallRuleParam(CONST.BO_ACTION_TYPE.BUY_BACK,_choosedProdInfo.prodInstId);
		var callParam = {
			boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_BACK,
			boActionTypeName : CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BUY_BACK),
			accessNumber : _choosedProdInfo.accNbr,
			prodOfferName : _choosedProdInfo.prodOfferName
		};
		var checkRule = rule.rule.prepare(param,'order.prodModify.showBuyBackDo',callParam);
	};
	
	//返销
	var _showBuyBackDo = function () {
		//预校验
		var inprodStatusCd=_choosedProdInfo.prodStateCd;
		var intoprodStatusCd=CONST.PROD_STATUS_CD.REMOVE_PROD;// 产品状态,REMOVE_PROD
		var BO_ACTION_TYPE=CONST.BO_ACTION_TYPE.BUY_BACK;//业务动作小类
/*		if(lteFlag){
			var flag=_updateCheckByChange(CONST.ACTION_CLASS_CD.PROD_ACTION,BO_ACTION_TYPE,inprodStatusCd,intoprodStatusCd);
			if (!flag) return;
		}*/
		if(!query.offer.setOffer()){
			return;
		}
		if(_showMemberWin()){
			$("#delPhoneTitle").html(CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.BUY_BACK)+'-是否保留成员');			
			$("#delPhoneNumber .btna_o:first").off("click").on("click",function(event){
				_closeDialog();
				_removeAndAdd(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BUY_BACK,1);
			});			
			_commonShowDialog();
		}else{
			_removeCommit(CONST.PROD_STATUS_CD.REMOVE_PROD,CONST.BO_ACTION_TYPE.BUY_BACK,1);
		}
	};
	var _setCoupon = function (coupon) {
		_coupon = coupon;
	};
	//客户属性-展示 更多按钮
	var _btnMoreProfile=function(){
		if($("#modPartyProfile").is(":hidden")){
			$("#modPartyProfile").show();
			$("#proarroworder").removeClass();
			$("#proarroworder").addClass("arrowup");
			order.prodModify.changeLabel(0);
		}else{
			$("#modPartyProfile").hide();
			$("#proarroworder").removeClass();
			$("#proarroworder").addClass("arrow");
			$("#modTabProfile0").attr("click","1");
			$("#contactName").attr("data-validate","");
			_form_custInfomodify_btn();
		}
		/*$("#orderbutton").off("click").on("click",function(event){_btnQueryPhoneNumber();event.stopPropagation();});*/
	};
	//切换标签
	var _changeLabel = function(labelId){
		if($("#partyProfile").is(":visible")==false){
			$("#partyProfile").show();
		}
		if(labelId=="0"){
			$("#modTabProfile0").show();
			$("#cardtab_mod_0").addClass("setcon");
			$("#modTabProfile0").attr("click","0");
			$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(keyup)");
			_form_custInfomodify_btn();
		}else if(($("#modTabProfile0").attr("click")=="0")&&($("#contactName").val()=="")){
			$.alert("提示","联系人名称不能为空！","information");
			return;
		}
		for ( var i = 0; i < order.prodModify.profileTabLists.length; i++) {
			var profileTabLists = order.prodModify.profileTabLists[i];
			var tabProfileNum=profileTabLists.tabProfileNum;
			var partyProfileCatgTypeCd=profileTabLists.partyProfileCatgTypeCd;
			if(labelId==partyProfileCatgTypeCd){
				$("#"+tabProfileNum).show();
				$("#cardtab_mod_"+partyProfileCatgTypeCd).addClass("setcon");
				$("#modTabProfile0").hide();
				$("#cardtab_mod_0").removeClass("setcon");
			}else{
				$("#"+tabProfileNum).hide();
				$("#cardtab_mod_"+partyProfileCatgTypeCd).removeClass("setcon");
			}
		}
		
	};
	
	var _checkProPSW=function(psw){
		$("#"+psw).blur();
	};
	return {
		changeCard : _changeCard,
		getChooseProdInfo : _getChooseProdInfo,
		lossRepProd : _lossRepProd,
		lossRepProdSubmit : _lossRepProdSubmit,
		choosedProdInfo : _choosedProdInfo,
		showLossRepProd : _showLossRepProd,
		showLossRepProdReg : _showLossRepProdReg,
		showStopKeepNumProd : _showStopKeepNumProd,
		showStopKeepNumProdReg :_showStopKeepNumProdReg,
		showCustInfoModify : _showCustInfoModify,
		custInfoModify : _custInfoModify,
		commonPrepare : _commonPrepare,
		showOweRemoveProd:_showOweRemoveProd,
		showRemoveProd : _showRemoveProd,
		showOrderRemoveProd : _showOrderRemoveProd,
		showCoverOrderRemoveProd : _showCoverOrderRemoveProd,
		showBreakRuleRemoveProd : _showBreakRuleRemoveProd,
		showNoActiveRemoveProd:_showNoActiveRemoveProd,
		spec_parm_change : _spec_parm_change,
		showChangeCard : _showChangeCard,
		spec_password_change : _spec_password_change,
		spec_password_change_save : _spec_password_change_save,
		showPasswordChange : _showPasswordChange,
		spec_password_change_check : _spec_password_change_check,
		getCallRuleParam : _getCallRuleParam,
		cancel : _cancel,
		orderAttachOffer : _orderAttachOffer,
		changeOffer		: _changeOffer,
		shortnum_change:_shortnum_change,
		shortnum_show:_shortnum_show,
		shortnum_save:_shortnum_save,
		spec_parm_show:_spec_parm_show,
		showAddComp : _showAddComp,
		addComp :_addComp,
		addToComp:_addToComp,
		compChangeTab:_compChangeTab,
		queryCustProd : _queryCustProd,
		addCompSubmit : _addCompSubmit,
		spec_parm_show:_spec_parm_show,
		showChangeAccount : _showChangeAccount,
		changeAccount : _changeAccount,
		showOrigAccts : _showOrigAccts,
		chooseAcct : _chooseAcct,
		queryAccount : _queryAccount,
		returnAccount : _returnAccount,
		createAcct : _createAcct,
		ifNewAcct : _ifNewAcct,
		changeAccountSave  :_changeAccountSave,
		showRemoveComp:_showRemoveComp,
		removeComp:_removeComp,
		profiles :_profiles,
		profileTabLists :_profileTabLists,
		partyTypeCdChoose:_partyTypeCdChoose,
		identidiesTypeCdChoose :_identidiesTypeCdChoose,
		removeCompSubmit :_removeCompSubmit,
		showPasswordReset:_showPasswordReset,
		spec_password_reset:_spec_password_reset,
		spec_password_reset_save:_spec_password_reset_save,
		queryRomveAcc:_queryRomveAcc,
		removeCompDelSelect:_removeCompDelSelect,
		addCompDelSelect:_addCompDelSelect,
		chooseOfferForMember:_chooseOfferForMember,
		shortnum_check:_shortnum_check,
		shortnum_change_val:_shortnum_change_val,
		changeShortNum:_changeShortNum,
		releaseShortNum:_releaseShortNum,
		showActiveReturn :_showActiveReturn,
		showBuyBack:_showBuyBack,
		showBuyBackDo:_showBuyBackDo,
		setCoupon:_setCoupon,
		lteFlag :lteFlag,
		btnMoreProfile :_btnMoreProfile,
		changeLabel : _changeLabel,
		remark_prodPass :_remark_prodPass,
		checkProPSW  :_checkProPSW
	};
})();
/**
 * 客户资料管理
 */
CommonUtils.regNamespace("order", "cust");

order.cust = (function(){
	//客户类型选择事件
	var _partyTypeCdChoose = function(scope,id) {
		var partyTypeCd=$(scope).val();	
		//客户类型关联证件类型下拉框
		$("#"+id).empty();
		_certTypeByPartyType(partyTypeCd,id);
		//创建客户证件类型选择事件
		//_identidiesTypeCdChoose($("#"+id).children(":first-child"),"cCustIdCard");
		//创建客户确认按钮
		//_custcreateButton();

	};
	
	//创建客户证件类型选择事件
	var _identidiesTypeCdChoose = function(scope,id) {
		var identidiesTypeCd=$(scope).val();
		if(identidiesTypeCd==1){
			$("#"+id).attr("placeHolder","请输入合法身份证号码");
			$("#"+id).attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)");
		}else if(identidiesTypeCd==2){
			$("#"+id).attr("placeHolder","请输入合法军官证");
			$("#"+id).attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}else if(identidiesTypeCd==3){
			$("#"+id).attr("placeHolder","请输入合法护照");
			$("#"+id).attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}else{
			$("#"+id).attr("placeHolder","请输入合法证件号码");
			$("#"+id).attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		_custcreateButton();
		
		//启用读卡时禁用的控件
		$('#cCustIdCard').attr("disabled",false);
		$('#cCustName').attr("disabled",false);
		$('#cAddressStr').attr("disabled",false);
	};
	
	//客户类型关联证件类型下拉框
	var _certTypeByPartyType = function(_partyTypeCd,id){
		var _obj = $("#"+id);
		var params = {"partyTypeCd":_partyTypeCd} ;
		var url=contextPath+"/cust/queryCertType";
		var response = $.callServiceAsJson(url, params, {});
       if (response.code == -2) {
					$.alertM(response.data);
				}
	   if (response.code == 1002) {
					$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");
					return;
				}
	   if(response.code==0){
					var data = response.data ;
					if(data!=undefined && data.length>0){
						//去除重复的证件类型编码
						var uniData = [];
						for(var i=0;i<data.length;i++){
							var unique = true;
							var certTypeCd = data[i].certTypeCd;
							for(var j=0;j<uniData.length;j++){
								unique = unique && data[i].certTypeCd != uniData[j].certTypeCd;
								if(!unique){
									break;
								}
							}
						    //只有定义的渠道类型新建客户的时候可以选择非身份证类型,其他的渠道类型只能选择身份证类型。
							var isAllowChannelType = false;
							if(OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZQZXDL || OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.GZZXDL
									|| OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.HYKHZXDL || OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.SYKHZXDL
									|| OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.XYKHZXDL || OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.GZZXJL
									|| OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZYOUT || OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.ZYINGT
									|| OrderInfo.staff.channelType==CONST.CHANNEL_TYPE_CD.WBT || _partyTypeCd != "1" ){
								isAllowChannelType = true;
							}
							if(!isAllowChannelType && certTypeCd == "1"){
								isAllowChannelType= true;
							}
							if(unique && isAllowChannelType){
								uniData.push(data[i]);
							}
						}
						
						for(var i=0;i<uniData.length;i++){
							var certTypedate = uniData[i];
							_obj.append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>");
						}
						//jquery mobile 需要刷新才能生效
						_obj.selectmenu().selectmenu('refresh');
						if(id=='identidiesTypeCd'){
							//创建客户证件类型选择事件
							_identidiesTypeCdChoose($("#"+id).children(":first-child"),"cCustIdCard");
						}
					}
				}
	};
	
	//创建客户确认按钮
    var _custcreateButton = function() {
	    $('#custCreateForm').off().bind('formIsValid',function(event) {
	    	var url=contextPath+"/order/createorderlonger";
			var response = $.callServiceAsJson(url, {});
			if(response.code==0){
				OrderInfo.custorderlonger=response.data;
			}
			_checkIdentity();
	     }).ketchup({bindElement:"createcustsussbtn"});
    };
    
  //验证证件号码是否存在
	var _checkIdentity = function() {
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		var custName=$("#p_cust_areaId_val").val();
		createCustInfo = {
			cAreaId : areaId,
			cAreaName : custName,
			cCustName : $.trim($("#cCustName").val()),
			cCustIdCard :  $.trim($("#cCustIdCard").val()),
			cPartyTypeCd : $.trim($("#partyTypeCd option:selected").val()),
			cIdentidiesTypeCd : $.trim($("#identidiesTypeCd option:selected").val()),
			cAddressStr :$.trim($("#cAddressStr").val())
		};
		diffPlace=$("#DiffPlaceFlag").val();
		var params = {
			"acctNbr":"",
			"identityCd":createCustInfo.cIdentidiesTypeCd,
			"identityNum":createCustInfo.cCustIdCard,
			"partyName":"",
			"custQueryType":$("#custQueryType").val(),
			"diffPlace":diffPlace,
			"areaId" : createCustInfo.cAreaId
		};
		var url=contextPath+"/pad/cust/checkIdentity";
		var response = $.callServiceAsJson(url, params, {"before":function(){
			$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
		}});
		var msg="";
		if (response.code == 0) {
			$.unecOverlay();
			$.confirm("确认","此证件号码已存在,是否确认新建?",{ 
				yes:function(){	
					_createCustConfirm();
				},
				no:function(){
					
				}
			});
		}else{
			$.unecOverlay();
			_createCustConfirm();
		}
	};
	
	//保存静态客户信息
	var _createCustConfirm = function() {
		createCustInfo = {
			cAreaId 			: OrderInfo.staff.soAreaId,
			cAreaName 			: OrderInfo.staff.soAreaName,
			cCustName 			: $.trim($("#cCustName").val()),
			cCustIdCard 		: $.trim($("#cCustIdCard").val()),
			cPartyTypeCd 		: $.trim($("#partyTypeCd  option:selected").val()),
			cPartyTypeName 		: ($.trim($("#partyTypeCd  option:selected").val())==1) ? "个人客户":"政企客户",
			cIdentidiesTypeCd 	: $.trim($("#identidiesTypeCd  option:selected").val()),
			cAddressStr 		: $.trim($("#cAddressStr").val()),
			cMailAddressStr 	: $.trim($("#cMailAddressStr").val())
		};
		var _boPartyContactInfo = {
			contactAddress 	: $.trim($("#contactAddress").val()),//参与人的联系地址
	        contactDesc 	: $.trim($("#contactDesc").val()),//参与人联系详细信息
	        contactEmployer : $.trim($("#contactEmployer").val()),//参与人的联系单位
	        contactGender  	: $.trim($("#contactGender").val()),//参与人联系人的性别
	        contactId 		: $.trim($("#contactId").val()),//参与人联系信息的唯一标识
	        contactName 	: $.trim($("#contactName").val()),//参与人的联系人名称
	        contactType 	: $.trim($("#contactType").val()),//联系人类型
	        eMail 			: $.trim($("#eMail").val()),//参与人的eMail地址
	        fax 			: $.trim($("#fax").val()),//传真号
	        headFlag 		: $.trim($("#headFlag  option:selected").val()),//是否首选联系人
	        homePhone 		: $.trim($("#homePhone").val()),//参与人的家庭联系电话
	        mobilePhone 	: $.trim($("#mobilePhone").val()),//参与人的移动电话号码
	        officePhone 	: $.trim($("#officePhone").val()),//参与人办公室的电话号码
	        postAddress 	: $.trim($("#postAddress").val()),//参与人的邮件地址
	        postcode 		: $.trim($("#postcode").val()),//参与人联系地址的邮政编码
	        staffId 		: OrderInfo.staff.staffId,//员工ID
	        state 			: "ADD",//状态
	        statusCd 		: "100001"//订单状态
		};
		OrderInfo.boCustInfos.name					= createCustInfo.cCustName;//客户名称
		OrderInfo.boCustInfos.areaId				= createCustInfo.cAreaId;//客户地区
		OrderInfo.boCustInfos.partyTypeCd			= createCustInfo.cPartyTypeCd;//客户类型
		OrderInfo.boCustInfos.defaultIdType			= createCustInfo.cIdentidiesTypeCd;//证件类型
		OrderInfo.boCustInfos.addressStr			= createCustInfo.cAddressStr;//客户地址
		OrderInfo.boCustInfos.mailAddressStr		= createCustInfo.cMailAddressStr;//通信地址
		OrderInfo.boCustIdentities.identidiesTypeCd	= createCustInfo.cIdentidiesTypeCd;//证件类型
		OrderInfo.boCustIdentities.identityNum		= createCustInfo.cCustIdCard;//证件号码
		//boPartyContactInfo
		OrderInfo.boPartyContactInfo.contactAddress	=_boPartyContactInfo.contactAddress,//参与人的联系地址
		OrderInfo.boPartyContactInfo.contactDesc 	=_boPartyContactInfo.contactDesc,//参与人联系详细信息
		OrderInfo.boPartyContactInfo.contactEmployer=_boPartyContactInfo.contactEmployer,//参与人的联系单位
		OrderInfo.boPartyContactInfo.contactGender  =_boPartyContactInfo.contactGender,//参与人联系人的性别
		OrderInfo.boPartyContactInfo.contactId 		=_boPartyContactInfo.contactId,//参与人联系信息的唯一标识
		OrderInfo.boPartyContactInfo.contactName 	=_boPartyContactInfo.contactName,//参与人的联系人名称
		OrderInfo.boPartyContactInfo.contactType 	=_boPartyContactInfo.contactType,//联系人类型
		OrderInfo.boPartyContactInfo.eMail 			=_boPartyContactInfo.eMail,//参与人的eMail地址
		OrderInfo.boPartyContactInfo.fax 			=_boPartyContactInfo.fax,//传真号
		OrderInfo.boPartyContactInfo.headFlag 		=_boPartyContactInfo.headFlag,//是否首选联系人
		OrderInfo.boPartyContactInfo.homePhone 		=_boPartyContactInfo.homePhone,//参与人的家庭联系电话
		OrderInfo.boPartyContactInfo.mobilePhone 	=_boPartyContactInfo.mobilePhone,//参与人的移动电话号码
		OrderInfo.boPartyContactInfo.officePhone 	=_boPartyContactInfo.officePhone,//参与人办公室的电话号码
		OrderInfo.boPartyContactInfo.postAddress 	=_boPartyContactInfo.postAddress,//参与人的邮件地址
		OrderInfo.boPartyContactInfo.postcode		=_boPartyContactInfo.postcode,//参与人联系地址的邮政编码
		OrderInfo.boPartyContactInfo.staffId 		=_boPartyContactInfo.staffId,//员工ID
		OrderInfo.boPartyContactInfo.state 			=_boPartyContactInfo.state,//状态
		OrderInfo.boPartyContactInfo.statusCd 		=_boPartyContactInfo.statusCd//订单状态

		OrderInfo.cust = {
			custId		: -1,	
			partyName 	: createCustInfo.cCustName,
			areaId		: createCustInfo.cAreaId
		};
		//客户属性
		OrderInfo.boCustProfiles=[];
		//客户属性节点
		for ( var i = 0; i < _partyProfiles.length; i++) {
			var partyProfiles = _partyProfiles[i];
			var profileValue  = $("#"+partyProfiles.attrId).val();
			if(""==profileValue||undefined==profileValue){
				profileValue==$("#"+partyProfiles.attrId+"option:selected").val();
			}
			var partyProfiles = {
				partyProfileCatgCd: partyProfiles.attrId,
				profileValue: profileValue,
                state: "ADD"
			};
			if(""!=profileValue && profileValue!=undefined){
				OrderInfo.boCustProfiles.push(partyProfiles);
			}
		}
		$("#div_cust_create").popup("close");
		var param = {};
		param.prodPwd 		= "";
		param.accessNumber	="";
		param.authFlag		="1";
		authFlag			="";
		param.identityCd	=createCustInfo.cIdentidiesTypeCd;
		param.idCardNumber	=createCustInfo.cCustIdCard;
		param.partyName		=createCustInfo.cCustName;
		param.areaId		=createCustInfo.cAreaId;
		param.areaName		=createCustInfo.cAreaName;
		param.segmentName	=createCustInfo.cPartyTypeName;
		param.identityName	=$("#identidiesTypeCd option:selected").text();
		$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				if(response.data.indexOf("false") >=0) {
					$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
					return;
				}
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
   };
   
	return {	
		identidiesTypeCdChoose :_identidiesTypeCdChoose,
		partyTypeCdChoose :_partyTypeCdChoose,
		certTypeByPartyType : _certTypeByPartyType,
		custcreateButton :_custcreateButton
	};
})();
$(function() {
//   order.cust.form_valid_init();
//   order.cust.initDic();
});
/**
 * 客户资料管理查询
 * @createUser liusd
 */
CommonUtils.regNamespace("order.cust", "mgr");

order.cust.mgr = (function(){
	var _called = false;
	var _choosedCustInfo = {};
	var _createCustInfo = {};
	var _custInfo = null;
	var _authFlag = null;
	var _fromProvFlag = "0"; //省份甩单标志
	var _provIsale = null; //省份isale流水号
	//客户鉴权跳转权限
	var _jumpAuthflag="";
	//客户属性
	var _partyProfiles =[];
	//客户属性分页列表
	var _profileTabLists =[];
	
	var _getCustInfo = function() {
		return _custInfo;
	};
	var _orderBtnflag="";
	//绑定鉴权事件
	var _bindChkAuth = function(){
		$('#custAuthForm').off("formIsValid").on('formIsValid', function(event, form) {
			var param = _choosedCustInfo;
			param.prodPwd = $.trim($("#authPassword").val());
			param.accessNumber=_choosedCustInfo.accessNumber;
			param.authFlag=_authFlag;
			$.callServiceAsHtml(contextPath+"/cust/custAuth",param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
				},"done" : function(response){
					if (response.code == -2) {
						return;
					}
					if(response.data.indexOf("false") >=0) {
						$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
						return;
					}
					//判断能否转为json，可以的话返回的就是错误信息
					try {
						var errorData = $.parseJSON(response.data);
						$.alertMore("异常信息", errorData.resultMsg, errorData.errorStack,"error");
						return;
					} catch(e){
						
					}
					_custInfo = param;
					OrderInfo.boCusts.prodId=-1;
					OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
					OrderInfo.boCusts.partyProductRelaRoleCd="0";
					OrderInfo.boCusts.state="ADD";
					OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
					
					OrderInfo.cust = _choosedCustInfo;
					_custAuthCallBack(response);
				},"always":function(){
					$.unecOverlay();
				}
			});
		}).ketchup({bindElement:"custAuthbtn"});
	}
	//客户类型选择事件 ok
	var _partyTypeCdChoose = function(scope,id) {
		var partyTypeCd=$(scope).val();
		//客户类型关联证件类型下拉框
		$("#"+id).empty();
		_certTypeByPartyType(partyTypeCd,id);
		//创建客户确认按钮
		_custCreateButton();

	};
	//客户类型关联证件类型下拉框     ok
	var _certTypeByPartyType = function(_partyTypeCd,id){
		var _obj = $("#"+id);
		$.callServiceAsJson(contextPath+"/cust/queryCertType", {"partyTypeCd":_partyTypeCd}, {
			"before":function(){
			},"done" : function(response){
				if (response.code == -2) {
					$.alertM(response.data);
					return false;
			  	}
			   	if (response.code == 1002) {
					$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");
					return;
			   	}
			   	if(response.code==0){
					var data = response.data ;
					if(data!=undefined && data.length>0){
						//去除重复的证件类型编码
						var uniData = [];
						for(var i=0;i<data.length;i++){
							var unique = true;
							for(var j=0;j<uniData.length;j++){
								unique = unique && data[i].certTypeCd != uniData[j].certTypeCd;
								if(!unique){
									break;
								}
							}
							if(unique){
								uniData.push(data[i]);
							}
						}
						for(var i=0;i<uniData.length;i++){
							var certTypedate = uniData[i];
							_obj.append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>");
						}
						//jquery mobile 需要刷新才能生效
						_obj.selectmenu().selectmenu('refresh');
						if(id=='identidiesTypeCd'){
							//创建客户证件类型选择事件
							_identidiesTypeCdChoose($("#"+id).children(":first-child"),"cCustIdCard");
						}
					}
				}
			},fail:function(response){
			},always:function(){
				
			}
	   });
	};
	//客户定位证件类型选择事件  ok
	var _custidentidiesTypeCdChoose = function(scope,id) {
		var identidiesTypeCd=$(scope).val();
		if(identidiesTypeCd==-1){
			$("#"+id).attr("placeHolder","请输入接入号码");
			$("#"+id).attr("data-validate","validate(required:请准确填写接入号码) on(blur)");
		}else if (identidiesTypeCd==1){
			$("#"+id).attr("placeHolder","请输入身份证号码");
			$("#"+id).attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(blur)");
		}else if(identidiesTypeCd==2){
			$("#"+id).attr("placeHolder","请输入军官证");
			$("#"+id).attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}else if(identidiesTypeCd==3){
			$("#"+id).attr("placeHolder","请输入护照");
			$("#"+id).attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}else{
			$("#"+id).attr("placeHolder","请输入证件号码");
			$("#"+id).attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		if(identidiesTypeCd!=-1){
			$("#isAppointNum").val("0").slider().slider("refresh");
		}
		_custLookforButton();

	};
	//创建客户证件类型选择事件
	var _identidiesTypeCdChoose = function(scope,id) {
		var identidiesTypeCd=$(scope).val();
		var _obj = $("#"+id);
		if(identidiesTypeCd==1){
			_obj.attr("placeHolder","请输入合法身份证号码");
			_obj.attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)");
		}else if(identidiesTypeCd==2){
			_obj.attr("placeHolder","请输入合法军官证");
			_obj.attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}else if(identidiesTypeCd==3){
			_obj.attr("placeHolder","请输入合法护照");
			_obj.attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}else{
			_obj.attr("placeHolder","请输入合法证件号码");
			_obj.attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		_custCreateButton();

	};
	//客户资料查询 ok 
	 var _custLookforButton = function() {
		//客户定位查询按钮
		$('#custQueryFirstForm').off('formIsValid').on('formIsValid', function(event, form) {
			var identityCd="";
			var idcard="";
			var diffPlace="";
			var acctNbr="";
			var identityNum="";
			var queryType="";
			var queryTypeValue="";
			identityCd=$("#p_cust_identityCd").val();
			identityNum=$.trim($("#p_cust_identityNum").val());
			//判断是否是号码或身份证输入
	
			//省份甩单定位客户不需要进行客户鉴权
			if(order.cust.mgr.fromProvFlag == "1" || (identityCd!=-1 && CONST.getAppDesc()!=0)){
				identityCd=$("#p_cust_identityCd").val();
				_authFlag="1";
			}else{
				//4G所有证件类型定位都需要客户鉴权
				_authFlag="0";
			}
			if(identityCd==-1){
				acctNbr=identityNum;
				identityNum="";
				identityCd="";
			}else if(identityCd=="acctCd"||identityCd=="custNumber"){
				acctNbr="";
				identityNum="";
				identityCd="";
				queryType=$("#p_cust_identityCd").val();
				queryTypeValue=$.trim($("#p_cust_identityNum").val());
	
			}
			diffPlace=$("#DiffPlaceFlag").val();
			areaId=$("#p_cust_areaId").val();
			//lte进行受理地区市级验证
			if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){
				$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");
				return;
			}
			var param = {
				"acctNbr"		:acctNbr,
				"identityCd"	:identityCd,
				"identityNum"	:identityNum,
				"partyName"		:"",
				"custQueryType"	:$("#custQueryType").val(),
				"diffPlace"		:diffPlace,
				"areaId" 		:areaId,
				"queryType" 	:queryType,
				"queryTypeValue":queryTypeValue
			};
			$.callServiceAsHtml(contextPath+"/pad/cust/queryCust",param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
				},"done" : function(response){
					if (response.code == -2) {
						return;
					}
					_queryCallBack(response);
				},fail:function(response){
					$.unecOverlay();
					$.alert("提示","查询失败，请稍后再试！");
				},"always":function(){
					$.unecOverlay();
					$("#usersearchbtn").attr("disabled",false);
				}
			});
		}).ketchup({bindElement:"a_user_search"});
	 };
	//创建客户确认按钮
    var _custCreateButton = function() {
	    $('#custCreateForm').off('formIsValid').on('formIsValid',function(event) {
	    	var url=contextPath+"/order/createorderlonger";
			var response = $.callServiceAsJson(url, {});
			if(response.code==0){
				OrderInfo.custorderlonger=response.data;
			}
			_checkIdentity();
	     }).ketchup({bindElement:"btn_cust_create_save"});
    };
	//客户查询列表 ok
	var _queryCallBack = function(response) {
		if(response.data.indexOf("false") >=0) {
			$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
			return;
		}
		var _qry_result = $("#div_user_qry_result");
		_qry_result.find("ul").html(response.data);
		$("#a_cust_qry_back").off("tap").on("tap",function(event) {
			_authFlag="";
		});
		$.jqmRefresh(_qry_result);
	};
	
	// 客户重新定位 ok
	var _custReset = function() {
		//填单页面
		//if(0!=OrderInfo.order.step){
			window.location.reload();
		//}
		$("#custQueryFirstForm").show();
		$("#custInfo").hide();
		$("#p_cust_identityNum").val("");
		$("#authPassword").val("");
		_authFlag="";
		OrderInfo.boCusts.partyId="";
		//新建客户
		OrderInfo.boCustInfos.name="";
		OrderInfo.boCustIdentities.identityNum="";
		OrderInfo.cust = {
			custId:-1,	
			custName : "",
			areaId:""
		};
		//定位客户
		OrderInfo.boCusts.prodId=-1;
		OrderInfo.boCusts.partyId="";
		OrderInfo.boCusts.partyProductRelaRoleCd="0";
		OrderInfo.boCusts.state="ADD";
		OrderInfo.cust = "";
		//已订购查询是不是查询标志
		_orderBtnflag="";
		//填单步骤
		OrderInfo.order.step=0;
		if((CONST.getAppDesc()!=0)&&($("#custModifyId").is(":hidden"))){
			$("#a-cust-modify").show();
		}
		
	};
	
	//客户鉴权 ok
	var _custAuth = function(scope) {
		var param = _choosedCustInfo;
		param.prodPwd = $.trim($("#authPassword").val());
		param.authFlag=_authFlag;
		$.callServiceAsHtml(contextPath+"/cust/custAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				_custInfo = param;
				OrderInfo.boCusts.prodId=-1;
				OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
				OrderInfo.boCusts.partyProductRelaRoleCd="0";
				OrderInfo.boCusts.state="ADD";
				OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
				
				OrderInfo.cust = _choosedCustInfo;
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	//跳过验证 ok
	var _jumpAuth = function() {
		if(order.cust.mgr.jumpAuthflag!="0"){
			$.alert("提示","没有跳过校验权限！");
			return;
		}
		var param = _choosedCustInfo;
		param.authFlag="1";
		$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				_custInfo = param;
				OrderInfo.boCusts.prodId=-1;
				OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
				OrderInfo.boCusts.partyProductRelaRoleCd="0";
				OrderInfo.boCusts.state="ADD";
				OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
				
				OrderInfo.cust = _choosedCustInfo;
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	//鉴权回调 ok
	var _custAuthCallBack = function(response) {
		if(_authFlag=="0"){
			$("#dlg-chk-auth").popup("close");
		}
		//隐藏查询选项,展示查询后结果
		$("#custQueryFirstForm").hide();
		$("#custInfo").html(response.data).show().enhanceWithin();
		
		if((OrderInfo.boCusts.partyId != "-1" && OrderInfo.boCusts.partyId != ""	
			 && OrderInfo.boCusts.partyId != undefined) && order.prodModify.lteFlag == true){
			$("#a-cust-modify").hide();
		}else{
			$("#a-cust-modify").show();
			$("#a-cust-modify").off("tap").on("tap",order.prodModify.showCustInfoModify);
		}
		//绑定事件
		$("#a-cust-rechk").off("tap").on("tap",_custReset);
		$("#a-qry-cust-prod").off("tap").on("tap",_btnQueryCustProdMore);
		$("#cCustName").val("");
		$("#cCustIdCard").val("");
		
		main.home.hideMainIco();
		
	};
	//客户列表点击 ok
	var _showCustAuth = function(scope) {
		var _this = $(scope);
		_choosedCustInfo = {
			custId 			: _this.attr("custId"),
			partyName 		: _this.attr("partyName"),
			idCardNumber 	: _this.attr("idCardNumber"),
			identityName 	: _this.attr("identityName"),
			areaName 		: _this.attr("areaName"),
			areaId 			: _this.attr("areaId"),
			identityCd 		: _this.attr("identityCd"),
			addressStr 		: _this.attr("addressStr"),
			norTaxPayer 	: _this.attr("norTaxPayer"),
			segmentId 		: _this.attr("segmentId"),
			segmentName 	: _this.attr("segmentName"),
			custFlag 		: _this.attr("custFlag"),
			vipLevel 		: _this.attr("vipLevel"),
			vipLevelName 	: _this.attr("vipLevelName")
		};
		if(_authFlag=="0"){
			if(order.cust.mgr.authType == '00'){//动态追加,内部没定义
				$("#custAuthTypeName").html("客户密码：");
			} else {
				$("#custAuthTypeName").html("产品密码：");
			}
			if(order.cust.mgr.jumpAuthflag=="0"){
				$("#jumpAuth").show();
				$("#jumpAuth").off("tap").on("tap",_jumpAuth);
			}else{
				$("#jumpAuth").hide();				
			}
			$("#authPassword").val("");
			$("#custAuthbtn").off("tap").on("tap",_bindChkAuth);
			
			$("#dlg-chk-auth").popup("open");
		} else{
			_custAuth(scope);
		}
	};
	//创键客户 ok
	var _showCustCreate = function() {
		var areaId=$("#p_cust_areaId").val();
		if(areaId.indexOf("0000")>0){
			$.alert("提示","前页受理地区为省级地区无法进行创建,请先选择市级地区！");
			return;
		}
		$.callServiceAsHtmlGet(contextPath+"/pad/cust/create.html",{},{
			"done" : function(response){
				if (!response || !response.data) {
					return;
				}
				//统一弹出框
				var popup = $.popup("#div_cust_create",response.data,{
					cache:true,
					width:$(window).width()-200,
					height:$(window).height(),
					contentHeight:$(window).height()-120,
					afterClose:function(){if($.ketchup) $.ketchup.hideAllErrorContainer($("#custCreateForm"));}
				});
				//由于脚本静态,所以要清理之前有可能创建的客户资料信息
				$("#div_cust_create input[type='text']").val("");
				//初始化页面数据
				_partyTypeCdChoose($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");
				_spec_parm_show();
				//更多属性默认隐藏,并绑定打开事件
				popup.find("div[data-role='collapsible']").collapsible({
				  	collapsed: true,
					collapse: function( event, ui ) {
						$("#contactName").attr("data-validate","");
						_custCreateButton();
					},
				  	expand: function(event,ui) {
						$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(blur)").attr("placeholder","请准确填写联系人名称");
						_custCreateButton();
				  	}
				});
			}});
	};
	
	var _linkSelectPlan=function(selected){
		//二层选择取消
		$("#plan2ndDiv tbody tr").removeClass("plan_select2");
		//勾取消
		$("#plan2ndDiv tbody tr").children(":first-child").next().html("");
		$(selected).addClass("plan_select2");
		//打勾操作
		var nike="<i class='select'></i>";
		$(selected).children(":first-child").next().html(nike);
		order.prodModify.getChooseProdInfo();
		
	};
	//已订购业务查询 入口 ok
	_btnQueryCustProdPrepare = function(){
		$.callServiceAsHtmlGet(contextPath+"/pad/cust/orderProdPrepare.html",{"diffPlaceFlag":$("#diffPlaceFlag").val()},{
			"before":function(){
				//$.ecOverlay("<strong>查询中,请稍等...</strong>");
			},
			"always":function(){
				//$.unecOverlay();
			},
			"done" : function(response){
				if(!response || response.code != 0) {
					$.alert("提示","已订购业务查询失败,稍后重试");
					return;
				}
				$.popup("#dlg_cust_prod",response.data,{
					width:$(window).width()-200,
					height:$(window).height(),
					contentHeight:$(window).height()-120,
					afterClose:function(){},
					cache:true
				});
				$(".ui-panel-inner > .ui-listview").height($(window).height());
				_btnQueryCustProd(1);
			}
		});
	}
	//已订购业务 页面 ok
	var _btnQueryCustProdMore=function(){
		if(OrderInfo.cust.custId==-1){
			$.alert("提示","新建客户无法查询已订购业务！");
			return;
		}		
		//初次查询
		if(_orderBtnflag==""){
			_btnQueryCustProdPrepare();
			_orderBtnflag="1";
			//二次进入
		}else if(_orderBtnflag=="1"){
			$("#dlg_cust_prod").popup("open",{transition:"slide"});
			_orderBtnflag="1";
			//关闭
		}else{
			$("#dlg_cust_prod").popup("close");
			_orderBtnflag="1";
		}
	};
	//已订购业务查询分页   ok
	var _btnQueryCustProd=function(curPage,scroller){
		//收集参数
		var param={};
		if(!_choosedCustInfo || !$.isPlainObject(_choosedCustInfo) || $.isEmptyObject(_choosedCustInfo)){
			param.custId="";
		}else{
			param.custId=_choosedCustInfo.custId;
			param.areaId =$("#area").attr("areaId");
		}
		//产品号码查询条件
		if($("#p_cust_identityNum").length == 1){
			param.acctNbr=$.trim($("#p_cust_identityNum").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
			//是否指定号码
		} else if($("#isAppointNum").attr("value")=="1"){
			param.acctNbr=$.trim($("#p_cust_identityNum").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
		}else {
			param.acctNbr="";
		}
		param.pageSize="8";
		param.curPage=curPage;
		//param.diffPlaceFlag=$("#diffPlaceFlag").val();
		if(!(param.custId) || param.custId==""){
			$.alert("提示","无法查询已订购产品");
			return;
		}
		//订购产品查询
		var url = contextPath+"/pad/cust/orderprod";
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response || response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				//填充数据,
				var ul$ = $("#dlg_cust_prod").find("ul:first");
				if(curPage == 1)ul$.html(response.data);
				else ul$.append(response.data);
				ul$.listview().listview("refresh");
				//绑定每行合约tap事件 父级
				ul$.find("li").off("tap").on("tap",function(){
					var _this = $(this);
					if(_this.hasClass("multi")){
						if(_this.next(".multidiv").is(":hidden")){
							_this.next(".multidiv").show().siblings(".multidiv").hide();
						} else {
							_this.next(".multidiv").hide().siblings(".multidiv").hide();
						}
					}
					_chk2ndOrderFinish(this,function(){
						_this.addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg");
						$("#div_2nd_order").panel( "open" );
					});
				});
				//子级
				ul$.find("div.multidiv li").off("tap").on("tap",function(){
					_chk2ndOrderFinish(this,function(){
						$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").parent().siblings("li").removeClass("userorderlistlibg");
						$("#div_2nd_order").panel( "open" );
						order.prodModify.getChooseProdInfo();
					});
				});
				//如果存在数据,默认选中首行
				ul$.find("li:first").trigger("tap").next("div.multidiv li:first").trigger("tap");
				order.prodModify.getChooseProdInfo();
			}
		});	
	};
	//判断二次业务办理时,切换已订购
	var _chk2ndOrderFinish = function(obj,cb){
		if(1==OrderInfo.order.step&&(!$(obj).hasClass("userorderlistlibg"))){
			$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
				yes:function(){
					_cancel();
					OrderInfo.order.step=0;
					cb.apply(this,[]);
				},
				no:function(){}
			});
		}else if(2==OrderInfo.order.step&&(!$(obj).hasClass("userorderlistlibg"))){
			$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
				yes:function(){
					SoOrder.orderBack();
					_cancel();
					OrderInfo.order.step=0;
					cb.apply(this,[]);
				},
				no:function(){}
			});
		}else{
			cb.apply(this,[]);
		}
	}
	
	//定位客户选择地区 ok
	var _chooseArea = function(){
		order.pad.area.chooseAreaTree("order/prepare","p_cust_areaId_val","p_cust_areaId",3);
	};
	//客户信息查询户选择地区
	var _preQueryCustChooseArea = function(){
		order.area.chooseAreaTreeManger("cust/preQueryCust","p_areaId_val","p_areaId",3);
	};
	//异地定位客户选择地区
	var _chooseAllArea = function(){
		order.area.chooseAreaTreeAll("p_cust_areaId_val","p_cust_areaId",3,"limitProvince");
	};
	//新建客户选择地区
	var _newCustChooseArea = function(){
		order.area.chooseAreaTree("order/prepare","p_ncust_areaId_val","p_ncust_areaId",3);
	};
	//已订购选择地区
	var _prodChooseArea = function(){
		order.area.chooseAreaTree("order/prepare","prodareaName","prodareaid",3);
		order.prodModify.choosedProdInfo.areaId=$("#prodareaid").val();
	};
	//定位客户证件类型下拉框 ok
	var _init = function(){
		$("#p_cust_identityCd").off("change").on("change",function(){
			_custidentidiesTypeCdChoose($(this).find("option:selected"),"p_cust_identityNum");
			$("#p_cust_identityCd").selectmenu().selectmenu('refresh');
		})
		_certTypeByPartyType("-1","p_cust_identityCd"); //客户定位也使用根据客户类型查询证件类型接口，p_cust_identityCd=-1表示查询所有已关联的证件类型
		$("#isAppointNum").off("change").on("change",_isAppointNum);
		//省份甩单，自动定位客户
		_checkAutoCustQry();
		//绑定创建客户事件
		$("#a_user_create").off("tap").on("tap",_showCustCreate);
		//绑定查询校验事件
		_custLookforButton();
	};
	//使用带入的客户信息自动定位客户 ok
	var _checkAutoCustQry = function(){
		if($("#fromProvFlag").length && $("#fromProvFlag").val() == "1"){
			order.cust.mgr.fromProvFlag = "1";
			order.cust.mgr.provIsale = $("#provIsale").val();
			$("#p_cust_areaId_val").val("");
			$("#p_cust_areaId").val($("#provAreaId").val());
			$("#p_cust_identityCd").val($("#provIdentityCd").val());
			$("#p_cust_identityNum").val($("#provIdentityNum").val());
			if($("#provIdentityCd").val()!=-1){
				$("#isAppointNum").attr("checked",false);
			}
			$("#a_user_search").click();
		} else {
			order.cust.fromProvFlag = "0";
			order.cust.provIsale = null;
		}
	};
	//客户所有属性初始化-展示 ok
	var _spec_parm_show = function(){
		$.callServiceAsHtmlGet(contextPath + "/pad/cust/partyProfileSpecList",{}, {
			"before":function(){
				$.ecOverlay("<strong>加载更多属性,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},"fail":function(){
				$.alert("提示","属性加载异常,请稍后重试.");
				$.unecOverlay();
			},
			"done" : function(response){
				if (response.code == -2) {
					return;
				}
				var pp = $("#partyProfile").html(response.data);
				$("#otabs li").on("tap",function(){_changeLabel($(this));});
				$.jqmRefresh(pp);
			}
		});	
		
	};
	//客户信息查询定位客户
	var _queryCust = function(){
		var identityCd="";
		var acctNbr="";
		var identityNum="";
		identityCd=$("#p_cust_identityCd").val();
		identityNum=$.trim($("#p_cust_identityNum").val());
		if(identityNum==""){
			$.alert("提示","请输入证件号码！");
			return;
		}
		//判断是否是号码或身份证输入
		if(identityCd==1){
		 identityCd=$("#p_cust_identityCd").val();
		}
		if(identityCd==-1){
			acctNbr=identityNum;
			identityNum="";
			identityCd="";
		}

		diffPlace=$("#DiffPlaceFlag").val();
		areaId=$("#p_areaId").val();
		var param = {
			"acctNbr":acctNbr,
			"identityCd":identityCd,
			"identityNum":identityNum,
			"partyName":"",
			"custQueryType":$("#custQueryType").val(),
			"diffPlace":diffPlace,
			"areaId" : areaId
		};
		$.callServiceAsHtmlGet(contextPath+"/cust/queryCustAlone", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if (response.code == -2) {
					return;
				}
				if(!response){
					response.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';					
				}
				if(response.data =="fail\r\n"){
					$.alert("提示","查询失败，请稍后再试");
					return;
				}
				if(response.data =="error\r\n"){
					$.alert("提示","数据异常，请联系管理员");
					return;
				}
				$("#acctList").html(response.data).show();	
				$("#acctDetail").hide();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
		
	};
	//查询客户详情
	var _queryCustDetail = function(_custId){
		var param = {
				partyId : _custId,
				areaId : $("#p_areaId").val()
		};
		$.callServiceAsHtml(contextPath+"/cust/custInfo", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if (response.code == -2) {
					return;
				}
				if(!response){
					response.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';					
				}
				if(response.data =="fail\r\n"){
					$.alert("提示","查询失败，请稍后再试");
					return;
				}
				if(response.data =="error\r\n"){
					$.alert("提示","数据异常，请联系管理员");
					return;
				}
				$("#acctDetail").html(response.data).show();	
				$("#acctList").hide();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	
	//保存静态客户信息
	var _createCustConfirm = function() {
		createCustInfo = {
			cAreaId 			: OrderInfo.staff.soAreaId,
			cAreaName 			: OrderInfo.staff.soAreaName,
			cCustName 			: $.trim($("#cCustName").val()),
			cCustIdCard 		: $.trim($("#cCustIdCard").val()),
			cPartyTypeCd 		: $.trim($("#partyTypeCd  option:selected").val()),
			cPartyTypeName 		: ($.trim($("#partyTypeCd  option:selected").val())==1) ? "个人客户":"政企客户",
			cIdentidiesTypeCd 	: $.trim($("#identidiesTypeCd  option:selected").val()),
			cAddressStr 		: $.trim($("#cAddressStr").val()),
			cMailAddressStr 	: $.trim($("#cMailAddressStr").val())
		};
		var _boPartyContactInfo = {
			contactAddress 	: $.trim($("#contactAddress").val()),//参与人的联系地址
	        contactDesc 	: $.trim($("#contactDesc").val()),//参与人联系详细信息
	        contactEmployer : $.trim($("#contactEmployer").val()),//参与人的联系单位
	        contactGender  	: $.trim($("#contactGender").val()),//参与人联系人的性别
	        contactId 		: $.trim($("#contactId").val()),//参与人联系信息的唯一标识
	        contactName 	: $.trim($("#contactName").val()),//参与人的联系人名称
	        contactType 	: $.trim($("#contactType").val()),//联系人类型
	        eMail 			: $.trim($("#eMail").val()),//参与人的eMail地址
	        fax 			: $.trim($("#fax").val()),//传真号
	        headFlag 		: $.trim($("#headFlag  option:selected").val()),//是否首选联系人
	        homePhone 		: $.trim($("#homePhone").val()),//参与人的家庭联系电话
	        mobilePhone 	: $.trim($("#mobilePhone").val()),//参与人的移动电话号码
	        officePhone 	: $.trim($("#officePhone").val()),//参与人办公室的电话号码
	        postAddress 	: $.trim($("#postAddress").val()),//参与人的邮件地址
	        postcode 		: $.trim($("#postcode").val()),//参与人联系地址的邮政编码
	        staffId 		: OrderInfo.staff.staffId,//员工ID
	        state 			: "ADD",//状态
	        statusCd 		: "100001"//订单状态
		};
		OrderInfo.boCustInfos.name					= createCustInfo.cCustName;//客户名称
		OrderInfo.boCustInfos.areaId				= createCustInfo.cAreaId;//客户地区
		OrderInfo.boCustInfos.partyTypeCd			= createCustInfo.cPartyTypeCd;//客户类型
		OrderInfo.boCustInfos.defaultIdType			= createCustInfo.cIdentidiesTypeCd;//证件类型
		OrderInfo.boCustInfos.addressStr			= createCustInfo.cAddressStr;//客户地址
		OrderInfo.boCustInfos.mailAddressStr		= createCustInfo.cMailAddressStr;//通信地址
		OrderInfo.boCustIdentities.identidiesTypeCd	= createCustInfo.cIdentidiesTypeCd;//证件类型
		OrderInfo.boCustIdentities.identityNum		= createCustInfo.cCustIdCard;//证件号码
		//boPartyContactInfo
		OrderInfo.boPartyContactInfo.contactAddress	=_boPartyContactInfo.contactAddress,//参与人的联系地址
		OrderInfo.boPartyContactInfo.contactDesc 	=_boPartyContactInfo.contactDesc,//参与人联系详细信息
		OrderInfo.boPartyContactInfo.contactEmployer=_boPartyContactInfo.contactEmployer,//参与人的联系单位
		OrderInfo.boPartyContactInfo.contactGender  =_boPartyContactInfo.contactGender,//参与人联系人的性别
		OrderInfo.boPartyContactInfo.contactId 		=_boPartyContactInfo.contactId,//参与人联系信息的唯一标识
		OrderInfo.boPartyContactInfo.contactName 	=_boPartyContactInfo.contactName,//参与人的联系人名称
		OrderInfo.boPartyContactInfo.contactType 	=_boPartyContactInfo.contactType,//联系人类型
		OrderInfo.boPartyContactInfo.eMail 			=_boPartyContactInfo.eMail,//参与人的eMail地址
		OrderInfo.boPartyContactInfo.fax 			=_boPartyContactInfo.fax,//传真号
		OrderInfo.boPartyContactInfo.headFlag 		=_boPartyContactInfo.headFlag,//是否首选联系人
		OrderInfo.boPartyContactInfo.homePhone 		=_boPartyContactInfo.homePhone,//参与人的家庭联系电话
		OrderInfo.boPartyContactInfo.mobilePhone 	=_boPartyContactInfo.mobilePhone,//参与人的移动电话号码
		OrderInfo.boPartyContactInfo.officePhone 	=_boPartyContactInfo.officePhone,//参与人办公室的电话号码
		OrderInfo.boPartyContactInfo.postAddress 	=_boPartyContactInfo.postAddress,//参与人的邮件地址
		OrderInfo.boPartyContactInfo.postcode		=_boPartyContactInfo.postcode,//参与人联系地址的邮政编码
		OrderInfo.boPartyContactInfo.staffId 		=_boPartyContactInfo.staffId,//员工ID
		OrderInfo.boPartyContactInfo.state 			=_boPartyContactInfo.state,//状态
		OrderInfo.boPartyContactInfo.statusCd 		=_boPartyContactInfo.statusCd//订单状态

		OrderInfo.cust = {
			custId		: -1,	
			partyName 	: createCustInfo.cCustName,
			areaId		: createCustInfo.cAreaId
		};
		//客户属性
		OrderInfo.boCustProfiles=[];
		//客户属性节点
		for ( var i = 0; i < _partyProfiles.length; i++) {
			var partyProfiles = _partyProfiles[i];
			var profileValue  = $("#"+partyProfiles.attrId).val();
			if(""==profileValue||undefined==profileValue){
				profileValue==$("#"+partyProfiles.attrId+"option:selected").val();
			}
			var partyProfiles = {
				partyProfileCatgCd: partyProfiles.attrId,
				profileValue: profileValue,
                state: "ADD"
			};
			if(""!=profileValue && profileValue!=undefined){
				OrderInfo.boCustProfiles.push(partyProfiles);
			}
		}
		$("#div_cust_create").popup("close");
		var param = {};
		param.prodPwd 		= "";
		param.accessNumber	="";
		param.authFlag		="1";
		authFlag			="";
		param.identityCd	=createCustInfo.cIdentidiesTypeCd;
		param.idCardNumber	=createCustInfo.cCustIdCard;
		param.partyName		=createCustInfo.cCustName;
		param.areaId		=createCustInfo.cAreaId;
		param.areaName		=createCustInfo.cAreaName;
		param.segmentName	=createCustInfo.cPartyTypeName;
		param.identityName	=$("#identidiesTypeCd option:selected").text();
		$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				if(response.data.indexOf("false") >=0) {
					$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
					return;
				}
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
   };
	//验证证件号码是否存在
	var _checkIdentity = function() {
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		var custName=$("#p_cust_areaId_val").val();
		createCustInfo = {
			cAreaId : areaId,
			cAreaName : custName,
			cCustName : $.trim($("#cCustName").val()),
			cCustIdCard :  $.trim($("#cCustIdCard").val()),
			cPartyTypeCd : $.trim($("#partyTypeCd option:selected").val()),
			cIdentidiesTypeCd : $.trim($("#identidiesTypeCd option:selected").val()),
			cAddressStr :$.trim($("#cAddressStr").val())
		};
		diffPlace=$("#DiffPlaceFlag").val();
		var params = {
			"acctNbr":"",
			"identityCd":createCustInfo.cIdentidiesTypeCd,
			"identityNum":createCustInfo.cCustIdCard,
			"partyName":"",
			"custQueryType":$("#custQueryType").val(),
			"diffPlace":diffPlace,
			"areaId" : createCustInfo.cAreaId
		};
		var url=contextPath+"/pad/cust/checkIdentity";
		var response = $.callServiceAsJson(url, params, {"before":function(){
			$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
		}});
		var msg="";
		if (response.code == 0) {
			$.unecOverlay();
			$.confirm("确认","此证件号码已存在,是否确认新建?",{ 
				yes:function(){	
					_createCustConfirm();
				},
				no:function(){
					
				}
			});
		}else{
			$.unecOverlay();
			_createCustConfirm();
		}
	};
	//更多属性标签 切换
	var _changeLabel = function(tabObj){
        var labId = $(tabObj).attr("tabid");
        if(labId !="0" && $("#contactName").val()==""){
        	$("#contactName").blur();
			return;
		}
        var index = $(tabObj).index();
        var divs = $("#otabs-body > div");
        $(tabObj).parent().children("li").attr("class", "otab-nav");//将所有选项置为未选中
        $(tabObj).attr("class", "otab-nav-action"); //设置当前选中项为选中样式
		$(tabObj).parent().children("li").find(".ui-input-search").hide();
		$(tabObj).parent().children("li").find(".ui-select").hide(); 
		$(tabObj).children("div").show();
        divs.hide();//隐藏所有选中项内容
        divs.eq(index).show(); //显示选中项对应内容
	};
	//指定号码 切换时控制,ok 
	var _isAppointNum = function(){
		if(!_called){
			_called = true;
			if($("#p_cust_identityCd").find("option:selected").val()!=-1){
				$.alertSync("提示","只能接入号码才能指定号码！","information",function(){
					$("#isAppointNum").val("0").slider().slider("refresh");
					_called = false;
				});
			}
		}
	};
	//退出二次业务
	var _cancel = function() {
		//退出二次业务时释放被预占的UIM卡
		var boProd2Tds = OrderInfo.boProd2Tds;
		if(boProd2Tds.length>0){
			for(var n=0;n<boProd2Tds.length;n++){
				var param = {
					numType : 2,
					numValue : boProd2Tds[n].terminalCode
				};
				$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
			}
		}
		//退出二次业务时释放被预占的号码（过滤身份证预占的号码）
		var boProdAns = OrderInfo.boProdAns;
		if(boProdAns.length>0){
			for(var n=0;n<boProdAns.length;n++){
				if(boProdAns[n].idFlag){
					continue;
				}
				var param = {
						numType : 1,
						numValue : boProdAns[n].accessNumber
				};
				$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
			}
			order.service.boProdAn = {};
			order.phoneNumber.resetBoProdAn();
		}			
		//页面变动
		$("#order_fill_content").empty();
		order.prepare.hideStep();
		$("#orderedprod").show();
		$("#order_prepare").show();
	};
	//返回按钮
	var _back = function(){
		$("#acctDetail").hide();
		$("#acctList").show();
	};
	
	//客户架构信息查询接口
	var _queryCustCompreInfo = function(mainPhoneNum,provCustAreaId,busitypeflag,oldFlag){
		var param = {
			    "acctNbr": "",
			    "areaId": provCustAreaId,
			    "diffPlace": "local",
			    "identidies_type": "",
			    "identityCd": "",
			    "identityNum": "",
			    "olTypeCd": "8",
			    "operType": busitypeflag,
			    "partyName": "",
			    "prodClass": "12",
			    "queryType": "",
			    "queryTypeValue": ""
			};
		if(busitypeflag==1){
			param.queryTypeValue = mainPhoneNum;
			param.identidies_type = "客户编码";
			param.queryType = "custNumber";
		}else{
			param.acctNbr = mainPhoneNum;
			param.identidies_type = "接入号码";
		}
		//$.ecOverlay("<strong>正在查询客户架构信息中,请稍等...</strong>");
		var response = $.callServiceAsJson(contextPath+"/token/pc/cust/queryCustCompreInfo", param);
		//$.unecOverlay();
		if(response.code == 0) {
			if(response.data == null){
				$.alert("提示","客户架构信息接口无数据返回。");
				return false;
			}
			if(response.data.custInfos==undefined){
				$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
				return false;
			}else if(!ec.util.isArray(response.data.custInfos)){
				$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
				return false;
			}
			if(response.data.prodInstInfos==undefined && busitypeflag!=1){
				$.alert("提示","客户下没有可以办理业务的移动用户。");
				return false;
			}
			if(response.data.offerMemberInfos==undefined && busitypeflag!=1){
				$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理。");
				return false;
			}
			if(oldFlag=="OLD"){
				var custInfos = response.data.custInfos;
				if(OrderInfo.actionFlag!=1 && custInfos[0].custId!=OrderInfo.cust.custId){
					$.alert("提示",mainPhoneNum+"和主卡的客户不一致！");
					return false;
				}
				var prodInstInfos = {};
				var prodInfos = response.data.prodInstInfos;
				$.each(prodInfos,function(){
					if(this.accNbr==mainPhoneNum){
						prodInstInfos = this;
						if(prodInstInfos.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
							$.alert("提示",mainPhoneNum+"不是在用产品！");
							return false;
						}
						if(OrderInfo.actionFlag!=1 && prodInstInfos.feeType.feeType!=order.prodModify.choosedProdInfo.feeType){
							$.alert("提示",mainPhoneNum+"和主卡的付费类型不一致！");
							return false;
						}
						if(prodInstInfos.productId=="280000000"){
							$.alert("提示",mainPhoneNum+"是无线宽带，不能纳入！");
							return false;
						}
						prodInstInfos.custId = custInfos[0].custId;
						OrderInfo.oldprodInstInfos.push(prodInstInfos);
					}
				})
				
				var flag = true;
				for ( var i = 0; i < response.data.offerMemberInfos.length; i++) {
					var member = response.data.offerMemberInfos[i];
					if(member.objType==""){
						$.alert("提示","销售品实例构成 "+member.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");
						return false;
					}else if(member.objType==CONST.OBJ_TYPE.PROD){
						if(member.accessNumber==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
							return false;
						}
					}
					if(member.objInstId==prodInstInfos.prodInstId){
						flag = false;
					}
				}
				if(flag){
					$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+prodInstInfos.accNbr+"】，无法继续受理，请业务后台核实");
					return false;
				}
				var offerInfos = {
					"offerMemberInfos":	response.data.offerMemberInfos,
					"offerId":prodInstInfos.mainProdOfferInstInfos[0].prodOfferInstId,
					"offerSpecId":prodInstInfos.mainProdOfferInstInfos[0].prodOfferId,
					"offerSpecName":prodInstInfos.mainProdOfferInstInfos[0].prodOfferName,
					"accNbr":prodInstInfos.accNbr
				};
				OrderInfo.oldoffer.push(offerInfos);
				order.memberChange.viceCartNum = 0;
				$.each(OrderInfo.oldoffer,function(){
					$.each(this.offerMemberInfos,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD){
							order.memberChange.viceCartNum++;
						}
					})
				});
			}else{
				var custInfos = response.data.custInfos;
				OrderInfo.cust={
					addressStr: custInfos[0].addressStr,
					areaId: custInfos[0].areaId,
					areaName: custInfos[0].areaName,
					authFlag: custInfos[0].authType,
					custFlag: custInfos[0].custFlag,
					custId: custInfos[0].custId,
					idCardNumber: custInfos[0].idCardNumber,
					identityCd: custInfos[0].identityCd,
					identityName: custInfos[0].identityName,
					norTaxPayer: "",
					partyName: custInfos[0].partyName,
					segmentId: custInfos[0].segmentId,
					segmentName: custInfos[0].segmentName,
					vipLevel: custInfos[0].vipLevel,
					vipLevelName: custInfos[0].vipLevelName
				}
				if(busitypeflag!=1){
					var prodInstInfos = response.data.prodInstInfos;
					order.prodModify.choosedProdInfo={
						accNbr: prodInstInfos[0].accNbr,
						areaCode: prodInstInfos[0].zoneNumber,
						areaId: prodInstInfos[0].areaId,
						corProdInstId: prodInstInfos[0].corProdInstId,
						custId: prodInstInfos[0].mainProdOfferInstInfos[0].custId,
						custName: prodInstInfos[0].mainProdOfferInstInfos[0].custName,
						endDt: prodInstInfos[0].mainProdOfferInstInfos[0].endDt,
						extProdInstId: prodInstInfos[0].extProductId,
						feeType: prodInstInfos[0].feeType.feeType,
						feeTypeName: prodInstInfos[0].feeType.feeTypeName,
						is3G: prodInstInfos[0].mainProdOfferInstInfos[0].is3G,
						prodBigClass: prodInstInfos[0].prodBigClass,
						prodClass: prodInstInfos[0].prodClass,
						prodInstId: prodInstInfos[0].prodInstId,
						prodOfferId: prodInstInfos[0].mainProdOfferInstInfos[0].prodOfferId,
						prodOfferInstId: prodInstInfos[0].mainProdOfferInstInfos[0].prodOfferInstId,
						prodOfferName: prodInstInfos[0].mainProdOfferInstInfos[0].prodOfferName,
						prodStateCd: prodInstInfos[0].prodStateCd,
						prodStateName: prodInstInfos[0].prodStateName,
						productId: prodInstInfos[0].productId,
						productName: prodInstInfos[0].productName,
						startDt: prodInstInfos[0].mainProdOfferInstInfos[0].startDt,
						stopRecordCd: prodInstInfos[0].prodStopRecords[0].stopRecordCd,
						stopRecordName: prodInstInfos[0].prodStopRecords[0].stopRecordName
					}
					var flag = true;
					for ( var i = 0; i < response.data.offerMemberInfos.length; i++) {
						var member = response.data.offerMemberInfos[i];
						if(member.objType==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");
							return false;
						}else if(member.objType==CONST.OBJ_TYPE.PROD){
							if(member.accessNumber==""){
								$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
								return false;
							}
						}
						if(member.objInstId==order.prodModify.choosedProdInfo.prodInstId){
							flag = false;
						}
					}
					if(flag){
						$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+order.prodModify.choosedProdInfo.accNbr+"】，无法继续受理，请业务后台核实");
						return false;
					}
					OrderInfo.offer.offerMemberInfos = response.data.offerMemberInfos; 
					OrderInfo.offer.offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
					OrderInfo.offer.offerSpecId = order.prodModify.choosedProdInfo.prodOfferId;
					OrderInfo.offer.offerSpecName = order.prodModify.choosedProdInfo.prodOfferName;
				}
			}
		}else{
			$.alertM(response.data);
			return false;
		}
		return true;
	};
	
	return {
		showCustAuth 			: _showCustAuth,
		showCustCreate 			: _showCustCreate,
		custAuth 				: _custAuth,
		getCustInfo 			: _getCustInfo,
		custReset				: _custReset,
		btnQueryCustProd		: _btnQueryCustProd,
		btnQueryCustProdMore	: _btnQueryCustProdMore,
		jumpAuth 				: _jumpAuth,
		identidiesTypeCdChoose 	: _identidiesTypeCdChoose,
		custidentidiesTypeCdChoose :_custidentidiesTypeCdChoose,
		choosedCustInfo 		: _choosedCustInfo,
		partyTypeCdChoose 		: _partyTypeCdChoose,
		chooseArea 				: _chooseArea,
		chooseAllArea 			: _chooseAllArea,
		newCustChooseArea 		: _newCustChooseArea,
		prodChooseArea 			: _prodChooseArea,
		init	 				: _init,
		partyProfiles 			: _partyProfiles,
		profileTabLists 		: _profileTabLists,
		queryCust 				: _queryCust,
		queryCustDetail 		: _queryCustDetail,
		changeLabel 			: _changeLabel,
		jumpAuthflag 			: _jumpAuthflag,
		orderBtnflag 			: _orderBtnflag,
		custCreateButton 		: _custCreateButton,
		isAppointNum 			: _isAppointNum,
		preQueryCustChooseArea 	: _preQueryCustChooseArea,
		linkSelectPlan			: _linkSelectPlan,
		back 					: _back,
		fromProvFlag 			: _fromProvFlag,
		provIsale 				: _provIsale,
		queryCustCompreInfo		: _queryCustCompreInfo
	};
})();
/**
 *地区树选择
 */
CommonUtils.regNamespace("order.pad", "area");
order.pad.area = (function(){
	//首次初始化地区列表时,所输入参数用于后面取子节点判断
	var _area_param = {"areaType":"","areaId":"","areaName":"","areaLevel":3,"areaLimit":0}
	//获取查询类维度权限
	var _chooseAreaTreeManger = function(_areaType,_areaName,_areaId,_areaLevel,_areaLimit){
		_area_param.areaType = _areaType;
		_area_param.areaId = _areaId;
		_area_param.areaName = _areaName;
		_area_param.areaLevel = _areaLevel;
		_area_param.areaLimit = !_areaLimit?"":_areaLimit;
		_chooseAreaTreeMain(contextPath + '/orderQuery/areaTreeManger');
	};
	//获取业务类维度权限
	var _chooseAreaTree = function(_areaType,_areaName,_areaId,_areaLevel){
		_area_param.areaType = _areaType;
		_area_param.areaId = _areaId;
		_area_param.areaName = _areaName;
		_area_param.areaLevel = _areaLevel;
		_chooseAreaTreeMain(contextPath + '/orderQuery/area');
	};
	var _chooseAreaTreeMain = function(url){
		if(!login.windowpub.checkLogin()){
			return ;
		}
		
		$.callServiceAsJson(url , {"areaType":_area_param.areaType,"areaLeve":_area_param.areaLeve,"areaLimit":_area_param.areaLimit}, {
			"before":function(){
				$.ecOverlay("地区查询中，请稍等...");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done": function(response){
				if(response && response.data && ec.util.getJSONValByKey(response,"code")==0){
					var data = response.data ;
					_showArea(data);
				}else{
					$.alertM(response.data);
				}
			},
			"fail":function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	//选择树中某一地区 ok 
	var _chooseArea = function(obj){
		var _this = $(obj);
		var _areaType = _area_param.areaType;
		var _isAllRegionFlag = _this.attr("isAllRegionFlag");
		var _regionCode = _this.attr("regionCode");
		var _areaId = _area_param.areaId;
		var _areaName = _area_param.areaName;
		var _areaNameVal = _this.attr("showAreaName");
		if(_isAllRegionFlag=="Y"){
			//余额查询/支取以及反销账，限制选择本地网，确保areaCode入参
			if(_areaType=="bill/preQueryBalance" || _areaType=="bill/prePayBalance" || _areaType=="bill/reversewriteoffcash"){
				if(!_regionCode || _regionCode==""){
					$.alert("提示", "请选择本地网（地市级）地区");
					return;
				}
			}
			var areaIdTemp = _this.attr("commonRegionId");
			areaIdTemp = (""+areaIdTemp).replace("ch","");
			$('#'+_areaId).val(areaIdTemp);
			$('#'+_areaId).attr("areaCode",_regionCode);
			var showAreaName= _this.attr("showAreaName");
			showAreaName = typeof showAreaName != undefined?showAreaName.replace("[受理渠道地区]","").replace("*",""):"请选择地区";
			$('#'+_areaName).val(showAreaName);
			$('#'+_areaName).attr("title",showAreaName);
			//
			OrderInfo.staff.soAreaId =areaIdTemp;
			OrderInfo.staff.soAreaCode =_regionCode;
			OrderInfo.staff.soAreaName=_areaNameVal;
			//产品通用查询页面更改地区时初始化查询条件
			if(_areaType=="prod/preProdQuery"){
				if(product.query.areaId!=$("#p_areaId").val()){
					if($("#custName").val()!="" || $("#num").val()!=""){
						$.alert("提示","地区已变更，请重新定位产品");
					}
					$("#prodList").html("");
					$("#custName").val("").attr("name", "");
					$("#num").val("");
					product.query.areaId = $("#p_areaId").val();	
				}
			}
			//帐户详情查询页面更改地区时初始化查询条件
			if(_areaType=="acct/preQueryAccount"){
				if(account.query.areaId!=$("#p_areaId").val()){
					if($("#custName").val()!="" || $("#num").val()!=""){
						$.alert("提示","地区已变更，请重新定位帐户");
					}
					$("#acctList").html("");
					$("#custName").val("").attr("name", "");
					$("#num").val("");
					account.query.areaId = $("#p_areaId").val();	
				}
			}
			$("#dlg-select-area").popup( "close" );
		}
	}
	//显示地区树 内部 ok
	var _showArea = function(data){
		var html = '';
		if(data && $.isArray(data) && data.length > 0){
			var showAreaName = "";
			for(var i=0;i<data.length;i++){			
			    showAreaName = data[i].regionName;
		    	if(data[i].isAllRegionFlag == 'Y'){
		    		html +='<ul data-role="listview"><li><a href="javascript:;" onclick="javascript:order.pad.area.chooseArea(this);" areaLevel="'
		    			+data[i].areaLevel+'" commonRegionId="'
		    			+data[i].commonRegionId+'" isAllRegionFlag="'
		    			+data[i].isAllRegionFlag+'" isChannelArea="'
		    			+data[i].isChannelArea+'" parentNodeId="'
		    			+data[i].parentNodeId+'" regionCode="'
		    			+data[i].regionCode+'" showAreaName="'
		    			+showAreaName+'" regionName="'
		    			+data[i].regionName+'" data-corners="false">'+data[i].regionName+'</a>';
		    			+'</li></ul>'
		    	}else{
		    		html+='<div data-role="collapsible" data-mini="true" data-corners="false">'
				        +'<h2 onclick="order.pad.area.getAreaChildren(this);" areaLevel="'
		    			+data[i].areaLevel+'" commonRegionId="'
		    			+data[i].commonRegionId+'" isAllRegionFlag="'
		    			+data[i].isAllRegionFlag+'" isChannelArea="'
		    			+data[i].isChannelArea+'" parentId="'
		    			+data[i].parentId+'" regionName="'
		    			+data[i].regionName+'" showAreaName="'
		    			+showAreaName+'" regionCode="'
		    			+data[i].regionCode+'">'+data[i].regionName+'</h2>'
				        +'<ul data-role="listview"></ul>'
				        +'</div>';
				}
			}		
		}else{
			html += '<ul data-role="listview"><li><a href="#" data-corners="false" >抱歉,没有找到相关地区信息.</a></li></ul>';
		}
		$("#dlg-select-area").find("div[data-role='content']").html(html).trigger('create');
		$("#dlg-select-area").popup("open");
	}
	//取子地区
	var _getAreaChildren = function(obj){
		var _this = $(obj);
		var collapsed = _this.parent().collapsible( "option", "collapsed" );
		if(_this && collapsed && !_area_param.cached){
			var parentNodeId=_this.attr("commonRegionId");
			var parentNodeName = _this.attr("regionName");
			var nodeLevel = _this.attr("areaLevel");
			var areaType = _area_param.areaType;
			var isChannelArea = _this.attr("isChannelArea");
			if(parentNodeId == 'undefined'){
				return;
			}
			if(nodeLevel <= _area_param.areaLevel){
				var params = {
					'leve': nodeLevel,
					'parentAreaId': parentNodeId,
					'areaType':areaType,
					"areaLimit":_area_param.areaLimit,
					"isChannelArea":isChannelArea
				};
				$.callServiceAsJson(contextPath + "/orderQuery/commonRegionChilden", params, {
					"before":function(){
						$.ecOverlay("地区查询中，请稍等...");
					},
					"always":function(){
						$.unecOverlay();
					},
					"done": function(response){
						var html ='';
						if(response && response.data && ec.util.getJSONValByKey(response,"code")==0 && $.isArray(response.data) && response.data.length > 0){
							var data = response.data;
							var showAreaName = _this.attr("showAreaName");
							showAreaName = typeof showAreaName=='undefined'?"":parentNodeName;
							var temp = "";
							for(var i=0;i<data.length;i++){			
								temp = showAreaName==''?data[i].regionName:showAreaName+ ' > '+data[i].regionName;
						    	if(data[i].isAllRegionFlag == 'Y'){
						    		html +='<li><a href="javascript:;" onclick="javascript:order.pad.area.chooseArea(this);" areaLevel="'
						    			+data[i].areaLevel+'" commonRegionId="'
						    			+data[i].commonRegionId+'" isAllRegionFlag="'
						    			+data[i].isAllRegionFlag+'" isChannelArea="'
						    			+data[i].isChannelArea+'" parentNodeId="'
						    			+data[i].parentNodeId+'" regionCode="'
						    			+data[i].regionCode+'" showAreaName="'
						    			+temp+'" regionName="'
						    			+data[i].regionName+'" data-corners="false">'+data[i].regionName+'</a></li>';
						    	}else{
						    		html+='<li><div data-role="collapsible" data-mini="true" data-corners="false">'
								        +'<h2 onclick="order.pad.area.getAreaChildren(this);" areaLevel="'
						    			+data[i].areaLevel+'" commonRegionId="'
						    			+data[i].commonRegionId+'" isAllRegionFlag="'
						    			+data[i].isAllRegionFlag+'" isChannelArea="'
						    			+data[i].isChannelArea+'" parentId="'
						    			+data[i].parentId+'" regionName="'
						    			+data[i].regionName+'" showAreaName="'
						    			+temp+'" regionCode="'
						    			+data[i].regionCode+'">'+data[i].regionName+'</h2>'
								        +'<ul data-role="listview"></ul>'
								        +'</div></li>';
								}
						    	temp = "";
							}
						}else{
							html += '<li><a href="#" data-corners="false">抱歉,没有找到相关地区信息.</a></li>';
						}
						_this.parent().find("ul").html(html).listview("refresh");
					}}
				);
			}
		}
	}
	//获取全部地区维度
	var _chooseAreaTreeAll = function(_areaName,_areaId,_areaLeve,_areaLimit){
		if(!login.windowpub.checkLogin()){
			return ;
		}
		var areaId = _areaId;
		var areaName = _areaName ;
		$.ligerDialog.open({
			width:350,
			height:350,
			title:'请选择地区',
			url:contextPath + '/orderQuery/areaTreeAll?areaLeve='+_areaLeve+"&areaLimit="+_areaLimit,
			buttons: [ { text: '确定', onclick: function (item, dialog) { 
						if(!ztree) {
							return;
						}
						var node=ztree.getSelected();
						if(node){
							if(node.data.isAllRegionFlag=="Y"){
								$('#'+areaId).val(node.data.commonRegionId);
								$('#'+areaId).attr("areaCode",node.data.regionCode);
								$('#'+areaName).val(areaNameVal);
								dialog.close();
							}else{
								alert("当前地区不可选！");
							}
						}else{
							alert("请选择地区！");
						}
					} },
			           { text: '取消', onclick: function (item, dialog) { dialog.close(); } } ] 	
		});
	};
	
	//获取计费功能地区维度与省份编码（原计费使用，已弃用）
	var _flatAreaPageDialog=null;
	var nameId;
	var valId;
	var _flatAreaPage = function(val_id,name_id){
		nameId=name_id;
		valId=val_id;
		_flatAreaPageDialog=$.ligerDialog.open({
			width:400,
			height:320,
			title:'请选择地区',
			url:contextPath + '/orderQuery/tree_flat',
			buttons: [ 
			   { text: '取消',onclick: function (item, dialog) { dialog.close(); } } ]
		});
	};
	var _areaChecked=function( val,name){
		if(_flatAreaPageDialog!=null){
			if(valId&&$("#"+valId)){
				$("#"+valId).val(val);
			}
			if(nameId&&$("#"+nameId)){
				$("#"+nameId).val(name);
			}
			_flatAreaPageDialog.close();
		}
	};
	
	return {
		areaChecked			: _areaChecked,
		flatAreaPage		: _flatAreaPage,
		chooseAreaTree		: _chooseAreaTree,
		chooseAreaTreeAll	: _chooseAreaTreeAll,
		chooseAreaTreeManger: _chooseAreaTreeManger,
		chooseArea			: _chooseArea,
		getAreaChildren		: _getAreaChildren
	};
	
})();


/**
 * 规则
 */
CommonUtils.regNamespace("rule", "rule");

rule.rule = (function(){

	
	var checkFlag = false;
	var checkObj = {};
	var _callBackStr = "";
	var _callBackParam = {};
	
	var _init = function() {
		$("#ruleBody").html("");
		$("#ruleclose").click(function(){
			_closeRuleDiv();
		});
		//授信
		$("#credit").click(function(){
			_credit();
		});
		$("#closedialog").click(function(){
			_cancel();
		});
	};
	/**
	 * 受理准备调用规则
	 * param : {
	 * 		
	 *  	ruleParam : {
	 *  		boActionTypeCd : 'S1', //动作类型
	 *  		instId : '1200001', //实例ID
	 *  		specId : '1201201', //产品（销售品）规格ID
	 *  		custId : '345903434', //客户ID
	 *  		areaId : '899990',//地区ID
	 *  	}
	 *  	
	 * }
	 */
	var _prepare = function(param,callBackStr,callBackParam){
		_init();
		_callBackStr = callBackStr;
		_callBackParam = callBackParam;
		if(!query.offer.loadInst()){  //加载实例到缓存
			return;
		};
		var inParam ={
			prodInfo : order.prodModify.choosedProdInfo,
			areaId : param.areaId,
			staffId : param.staffId,
			channelId : param.channelId,
			custId : param.custId,
			boInfos : param.boInfos,
			soNbr : OrderInfo.order.soNbr
		};
		$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");
		var response = $.callServiceAsJson(contextPath+"/rule/prepare",inParam); //调用规则校验
		$.unecOverlay();
		var checkData = response.data;
		if(response.code==0){
			if(checkData == null){
				$.alert("提示","规则校验异常，请联系管理人员！");
				return;
			}
		}else{
			$.alertM(response.data);
			return;
		}
		
		if(checkData.ruleType == "portal"){
			if (checkData.resultCode == "0"){
				$.alert("提示",checkData.resultMsg);
				return true;
			}
		}		
		if (checkData.result && checkData.result.resultInfo) {
			var checkRuleInfo = checkData.result.resultInfo;
			if (checkRuleInfo != null && checkRuleInfo.length > 0) {
				$.each(checkRuleInfo, function(i, ruleInfo) {
					$("<tr>" +
							"<td>"+ruleInfo.resultCode+"</td>" +
							"<td>"+ruleInfo.ruleDesc+"</td>" +
							"<td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td>" +
							"<td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td>" +
					"</tr>").appendTo($("#ruleBody"));
				});
				easyDialog.open({
					container : 'ruleDiv'
				});
			} else {
				_credit();	
				SoOrder.initFillPage();		
			}
		} else {
			_credit();
			SoOrder.initFillPage();	
		}
		if (checkData.resultCode != 0) {
			$("#ruleSubmit").hide();
		} else {
			checkObj = param;
			checkFlag = true;
		}
	};
	
	var _getRuleImgClass = function(ruleLevel) {
		if (ruleLevel < 4) {
			return "correct";
		} else {
			return "error";
		}
	};
	
	var _getRuleLevelName = function(ruleLevel) {
		if (ruleLevel == 0) {
			return "提示级";
		} else if (ruleLevel == 1) {
			return "中级";
		} else if (ruleLevel == 2) {
			return "高级";
		} else if (ruleLevel == 3) {
			return "特技";
		} else if (ruleLevel == 4) {
			return "限制级";
		}
	};
	
	var _prepareCallBack = function(response) {
		var content$ = $("#ruleDiv");
		content$.html(response.data).show();
	};
	
	
	/**
	 * 规则页面点击确定按钮
	 */
	var _submit = function() {
		if (!checkFlag) {
			return;
		}
		$.callServiceAsHtml(contextPath+checkObj.uri, checkObj.param, checkObj.callObj);
		easyDialog.close();
	};
	
	/**
	 * 关闭规则窗口
	 */
	var _closeRuleDiv = function() {
		if (!$("#ruleDiv").is(":hidden")) {
			easyDialog.close();
		}
	};
	
	var _cancel = function() {
		//TODO may do other things;
		if (!$("#ruleDiv").is(":hidden")) {
			easyDialog.close();
		}
	};
	
	var _showRuleDiv = function(ruleInfo) {
		
	};
	
	var _credit = function() {
		eval(_callBackStr + "("+JSON.stringify(_callBackParam) + ")");
		//_closeRuleDiv();
	};
	
	//生成订单流水号，加载实例到缓存,规则校验
	var _ruleCheck = function(boInfos){
		//_init();
		if(!query.offer.loadInst()){  //生成订单流水号，加载实例到缓存，如果失败
			return false;
		};
		if(boInfos==undefined){  //没有传，表示不做业务规则校验
			return true;
		}
		var inParam ={
			areaId : OrderInfo.staff.soAreaId,
			staffId : OrderInfo.staff.staffId,
			channelId : OrderInfo.staff.channelId,
			custId : OrderInfo.cust.custId,
			soNbr : OrderInfo.order.soNbr,
			boInfos : boInfos,
			prodInfo : order.prodModify.choosedProdInfo	
		};
		$.ecOverlay("<strong>客户级规则校验中，请稍等...</strong>");
		var response = $.callServiceAsJson(contextPath+"/rule/prepare",inParam); //调用规则校验
		$.unecOverlay();
		if(response!=undefined && response.code==0){
			var checkData = response.data;
			if(checkData == null){
				$.alert("提示","规则校验异常，请联系管理人员！");
				return false;
			}
			if(checkData.ruleType == "portal"){  //门户层校验
				if (checkData.resultCode == "0"){  // 0为门户层校验为通过
					$.alert("提示",checkData.resultMsg);
					return false;
				}
			}		
			var checkRuleInfo = checkData.result.resultInfo;  //业务规则校验
			$("#ruleBody").empty();
			if(checkRuleInfo!=undefined && checkRuleInfo.length > 0){
				$.each(checkRuleInfo, function(i, ruleInfo) {
					$("<tr><td>"+ruleInfo.resultCode+"</td>" +
							"<td>"+ruleInfo.ruleDesc+"</td>" +
							"<td>"+_getRuleLevelName(ruleInfo.ruleLevel)+"</td>" +
							"<td><div style='display:block;margin-left:30px;' class='"+_getRuleImgClass(ruleInfo.ruleLevel)+"'></div></td>" +
					"</tr>").appendTo($("#ruleBody"));
				});
//				easyDialog.open({
//					container : 'ruleDiv'
//				});
				$.popupSmall("#poppopdialog",{
					width:500,
					height:300
				});
				return false;
			}else {
				return true;
			}
		}else{
			$.alertM(response.data);
			return;
		}
	};
	
	return {
		submit 			: _submit,
		prepare 		: _prepare,
		showRuleDiv 	: _showRuleDiv,
		ruleCheck		: _ruleCheck,
		init			: _init,
		getRuleLevelName: _getRuleLevelName,
		getRuleImgClass : _getRuleImgClass
	};
})();
$(function(){

});

/**
 * 对缓存数据操作
 * 
 * @author wukf
 * date 2014-01-15
 */
CommonUtils.regNamespace("CacheData");

/** 缓存数据对象*/
CacheData = (function() {
	
	//把销售品规格保存到开通列表里面
	var _setOfferSpec = function(prodId,offerSpec){
		offerSpec.isdel="C";
		var flag = true ; 
		for (var i = 0; i < AttachOffer.openList.length; i++) { //没有开通任何附属
			var open = AttachOffer.openList[i];
			if(open.prodId==prodId){
				flag = false;
				break;
			}
		} 
		if(flag){
			var open = {
				prodId : prodId,
				specList : []
			};
			AttachOffer.openList.push(open);
		}
		CacheData.getOfferSpecList(prodId).push(offerSpec);//添加到已开通列表里
	};
	
	//添加功能产品到缓存列表
	var _setServSpec = function(prodId,spec){
		spec.isdel="C";
		if(spec.servSpecId==undefined){
			spec.servSpecId = spec.objId;
		}
		if(spec.servSpecName==undefined){
			spec.servSpecName = spec.objName;
		}
		var flag = true ;	
		for (var i = 0; i < AttachOffer.openServList.length; i++) { //没有开通任何附属
			var open = AttachOffer.openServList[i];
			if(open.prodId==prodId){
				flag = false;
				break;
			}
		} 
		if(flag){
			var open = {
				prodId : prodId,
				servSpecList : []
			};
			AttachOffer.openServList.push(open);
		}
		CacheData.getServSpecList(prodId).push(spec);//添加到已开通列表里
	};
	
	//把选中的服务保存到销售品规格中
	var _setServ2OfferSpec = function(prodId,offerSpec){
		if(offerSpec!=undefined){
			$.each(offerSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					if($("#check_"+prodId+"_"+this.objId).attr("checked")=="checked"){
						this.selQty = 1;
					}else{
						this.selQty = 2;//未选中
					}
				});
			});
		}
	};
	
	//获取参数内容
	var _getParamContent = function(prodId,spec,flag){
		var content = '<form id="paramForm">' ;
		if(flag==2){  //功能产品规格参数
			if(ec.util.isArray(spec.prodSpecParams)){ //拼接功能产品规格参数
				for (var i = 0; i < spec.prodSpecParams.length; i++) { 
					var param = spec.prodSpecParams[i];
					if(param.value==undefined){
						param.value = "";
					}
					content += _getStrByParam(prodId,param,param.itemSpecId,param.value);
				}
			}
		}else if(flag==3){ //功能产品实例参数
			if(ec.util.isArray(spec.prodSpecParams)){ //拼接功能产品规格参数
				for (var i = 0; i < spec.prodSpecParams.length; i++) { 
					var param = spec.prodSpecParams[i];
					if(ec.util.isArray(spec.prodInstParams)){ //拼接功能产品实例参数
						$.each(spec.prodInstParams,function(){
							if(this.itemSpecId==param.itemSpecId){
								param.value = this.value;
							}
						});
					}
					if(param.value==undefined){
						param.value = "";
					}
					content += _getStrByParam(prodId,param,param.itemSpecId,param.value);
				}
			}
		} else if(flag==1){  //销售品实例参数
			if(spec.offerSpec!=undefined){
				if(ec.util.isArray(spec.offerSpec.offerSpecParams)){
					var offerSpecParams = spec.offerSpec.offerSpecParams;//sortParam(spec.offerSpec.offerSpecParams);
					$.each(offerSpecParams,function(){
						var param = this;
						if(ec.util.isArray(spec.offerParamInfos)){ //销售品实例参数
							$.each(spec.offerParamInfos,function(){  
								if(this.itemSpecId==param.itemSpecId){
									param.value = this.value;
								}
							});
						}
						content += _getStrByParam(prodId,this,this.itemSpecId,this.value);
					});
				}
			}
		}else {  //销售品规格参数
			if(ec.util.isArray(spec.offerSpecParams)){
				var offerSpecParams = spec.offerSpecParams;
				$.each(offerSpecParams,function(){
					content += _getStrByParam(prodId,this,this.itemSpecId,this.value);
				});
			}
			/*if(spec.offerRoles!=undefined && spec.offerRoles.length>0){
				for (var i = 0; i < spec.offerRoles.length; i++) {
					var offerRole = spec.offerRoles[i];
					for (var j = 0; j < offerRole.roleObjs.length; j++) {
						var roleObj = offerRole.roleObjs[j];
						if(roleObj.prodSpecParams !=undefined && roleObj.prodSpecParams.length>0){
							for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
								content += _getStrByParam(prodId,roleObj.prodSpecParams[k],roleObj.prodSpecParams[k].itemSpecId,flag);
							}
						}
					}
				}
			}*/
		}
		content +='</form>' ;
		return content;
	};
	
	//获取增值业务内容
	var _getAppContent = function(prodId,appList){
		var $form = $('<form id="appForm"></form>');
		if(!!appList && appList.length>0){ //下拉框
			$.each(appList,function(){
				var $input = $('<input id="'+prodId+'_'+this.objId+'" name="'+prodId+'" type="checkbox">'+this.objName+'</input></br>');
				if(this.minQty == 0){
					if(this.dfQty>0){
						$input.attr("checked","checked");
					}
				}else if(this.minQty > 0){
					$input.attr("checked","checked");
					$input.attr("disabled","disabled");
				}
				$form.append($input);
			});
		}
		return $form;
	};
	
	//根据参数获取字符串
	var _getStrByParam = function(prodId,param){
		var itemSpecId = param.itemSpecId;
		if(param.setValue==undefined){  //没有设置过参数
			param.setValue = param.value; //赋值成默认值
		}
		var paramVal = param.setValue;
		var selectStr = ""; //返回字符串
		if(ec.util.isArray(param.valueRange)){ //下拉框
			var optionStr = "";
			if(param.rule.isConstant=='Y'){ //不可修改
				selectStr = param.name + ": <select class='inputWidth183px' id="+prodId+"_"+itemSpecId+" disabled='disabled'>"; 
			}else {
				if(param.rule.isOptional=="N") { //必填
					selectStr = param.name + ": <select class='inputWidth183px' id="+prodId+"_"+itemSpecId+" data-validate='validate(required,reg:"
							  + param.rule.maskMsg+"("+param.rule.mask+")) on(blur)'><label class='f_red'>*</label><br>"; 
				}else{
					selectStr = param.name + ": <select class='inputWidth183px' id="+prodId+"_"+itemSpecId+"><br>"; 
					optionStr +='<option value="" >请选择</option>';  //不是必填可以不选
				}
			}
			for ( var j = 0; j < param.valueRange.length; j++) {
				var valueRange = param.valueRange[j];
				if(valueRange.value== param.setValue){
					optionStr +='<option value="'+valueRange.value+'" selected="selected" >'+valueRange.text+'</option>';
				}else {
					optionStr +='<option value="'+valueRange.value+'">'+valueRange.text+'</option>';
				}
			}
			selectStr += optionStr + "</select><br>"; 
		}else { 
			 if(param.dataTypeCd==1){  //文本框
				if(param.rule==undefined){
					selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId +'" class="inputWidth183px" type="text" value="'+paramVal+'" ><br>'; 
				}else {
					if(param.rule.isConstant=='Y'){ //不可修改
						selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId
						+'" class="inputWidth183px" type="text" disabled="disabled" value="'+paramVal+'" ><br>';
					}else {
						if(param.rule.isOptional=="N") { //必填
							selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId  
							+'" class="inputWidth183px" type="text" mask="'+param.rule.mask+'" maskmsg="'+param.rule.maskMsg+'" value="'+paramVal+'" ><label class="f_red">*</label><br>'; 
						}else{
							selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId  
							+'" class="inputWidth183px" type="text" mask="'+param.rule.mask+'" maskmsg="'+param.rule.maskMsg+'" value="'+paramVal+'" ><br>'; 
						}
					}
				}
			} else if(param.dataTypeCd==8){  //密码框
				if(param.rule==undefined){
					selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId +'" class="inputWidth183px" type="password" value="'+paramVal+'" ><br>'; 
				}else{
					if(param.rule.isConstant=='Y'){
						selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId
						+'" class="inputWidth183px" type="password"  disabled="disabled" value="'+paramVal+'" ><br>';
					}else {
						if(param.rule.isOptional=="N") {
							selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId  
							+'" class="inputWidth183px" type="password" data-validate="validate(required,reg:'+param.rule.maskMsg+'('+param.rule.mask+')) on(blur)" value="'+paramVal+'" ><label class="f_red">*</label><br>'; 
						}else{
							selectStr += param.name + ' : <input id="'+prodId+'_'+itemSpecId  
							+'" class="inputWidth183px" type="password" data-validate="validate(reg:'+param.rule.maskMsg+'('+param.rule.mask+')) on(blur)" value="'+paramVal+'" ><br>'; 
						}
					}
				}
			}else if(param.dataTypeCd==4){ //日期，暂时不写
			
			
			}
		}
		return selectStr;
	};
	
	//获取销售品下的功能产品拼接成字符串
	var _getOfferProdStr = function(prodId,spec,flag){
		var content = '<form id="paramForm">' ;
		var str = "";
		if(flag==0){  //订购可选包
			$.each(spec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					if(this.objType==4){
						if(this.minQty==0 && this.maxQty>0){
							str += '<input id="check_'+prodId+'_'+this.objId +'" type="checkbox" checked="checked">'+this.objName+'<br>'; 
						}else if(this.minQty>0){
							str += '<input id="check_'+prodId+'_'+this.objId +'"  type="checkbox" checked="checked" disabled="disabled">'+this.objName+'<br>';
						}
					}
				});
			});
			if(str==""){
				content = '订购【'+spec.offerSpecName+'】可选包' ;
			}else{
				content = '订购【'+spec.offerSpecName+'】可选包，需要开通以下勾选的功能产品：<br>' +str;
			}
		}else if(flag==1) { //退订可选包
			$.each(spec.offerMemberInfos,function(){  //退订时候spec当成serv
				var offerMember = this;
				$.each(spec.offerSpec.offerRoles,function(){
					$.each(this.roleObjs,function(){
						if(offerMember.objId==this.objId && this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){ //优惠构成关系
							var servId = offerMember.objInstId;
							if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE){
								str += '<input id="check_'+prodId+'_'+servId+'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+'<br>'; 
							}else if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE){
								str += '<input id="check_'+prodId+'_'+servId+'" type="checkbox" checked="checked">'+this.objName+'<br>';
							}
						}
					});
				});
			});
			if(str==""){
				content = '退订【'+spec.offerSpecName+'】可选包' ;
			}else{
				content = '退订【'+spec.offerSpecName+'】可选包，需要关闭以下勾选的功能产品：<br>' +str;
			}
		}else if(flag==2) { //取消订购可选包
			$.each(spec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					if(this.relaTypeCd==CONST.RELA_TYPE_CD.SELECT){ //优惠构成关系
						if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CLOSE){
							str += '<input id="check_'+prodId+'_'+this.objId +'" type="checkbox" checked="checked" disabled="disabled">'+this.objName+'<br>'; 
						}else if(this.unssProcessMode==CONST.UNSS_PROCESS_MODE.CHOOSE){
							str += '<input id="check_'+prodId+'_'+this.objId +'" type="checkbox" checked="checked">'+this.objName+'<br>';
						}
					}
				});
			});
			if(str==""){
				content = '取消订购【'+spec.offerSpecName+'】可选包' ;
			}else{
				content = '取消订购【'+spec.offerSpecName+'】可选包，需要取消开通以下勾选的功能产品：<br>' +str;
			}
		}
		content +='</form>';
		return content;
	};
	
	//自动设置参数
	var _setParam = function(prodId,offerSpec){
		//自动设置销售品参数
		if(ec.util.isArray(offerSpec.offerSpecParams)){
			for (var i = 0; i < offerSpec.offerSpecParams.length; i++) {
				var param = offerSpec.offerSpecParams[i];
				if(ec.util.isArray(param.valueRange)){ //不是下拉框
					if(param.value==undefined || param.value==""){ //必须手工填写
						if(param.rule.isOptional=="N"){ //必填
							return false;
						}
					}
				}else{
					if(param.value==undefined || param.value==""){
						if(param.rule.isOptional=="N"){ //必填
							return false;
						}
					}
				}
			}
		}
		//自动设置服务参数
		/*if(!!offerSpec.offerRoles){
			for (var i = 0; i < offerSpec.offerRoles.length; i++) {
				var offerRole = offerSpec.offerRoles[i];
				for (var j = 0; j < offerRole.roleObjs.length; j++) {
					var roleObj = offerRole.roleObjs[j];
					if(!!roleObj.prodSpecParams){
						for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
							var param = roleObj.prodSpecParams[k];
							if(param.valueRange.length == 0){ //不是下拉框
								if(param.value===""){ //必须手工填写
									return false;
								}
							}else{
								if(param.value==undefined || param.value==""){
									param.value = param.valueRange[0].value; 
								}
							}
						}
					}
				}
			}
		}*/
		offerSpec.isset = "Y";
		return true;
	};

	//自动设置服务参数
	var _setServParam = function(prodId,servSpec){
		if(ec.util.isArray(servSpec.prodSpecParams)){
			for (var k = 0; k < servSpec.prodSpecParams.length; k++) {
				var param = servSpec.prodSpecParams[k];
				if(ec.util.isArray(param.valueRange)){ //下拉框
					if(param.value==undefined || param.value==""){ //必须手工填写
						if(param.rule.isOptional=="N"){ //必填
							return false;
						}
					}
				}else{
					if(param.value==undefined || param.value==""){
						if(param.rule.isOptional=="N"){ //必填
							return false;
						}
					}
				}
			}
		}
		servSpec.isset = "Y";
		return true;
	};
	
	//通过产品id获取产品已开通附属规格列表
	var _getOfferSpecList = function (prodId){
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			if(open.prodId == prodId){
				return open.specList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//通过产品id,跟销售品规格id获取销售品构成
	var _getOfferSpec = function(prodId,offerSpecId){
		var specList = _getOfferSpecList(prodId);
		if(specList!=undefined){
			for ( var i = 0; i < specList.length; i++) {
				if(specList[i].offerSpecId==offerSpecId){
					return specList[i];
				}
			}
		}
	};
	
	//获取某个销售品规格参数  
	var _getSpecParam = function(prodId,offerSpecId,itemSpecId){
		var spec = _getOfferSpec(prodId,offerSpecId);
		if(ec.util.isObj(spec)){
			for ( var i = 0; i < spec.offerSpecParams.length; i++) {
				if(spec.offerSpecParams[i].itemSpecId==itemSpecId){
					return spec.offerSpecParams[i];
				}
			}
		}
	};
	
	//获取销售品下某个功能产品参数  
	var _getProdSpecParam = function(prodId,offerSpecId,itemSpecId){
		var spec = _getOfferSpec(prodId,offerSpecId);
		if(!!spec.offerRoles){
			for (var i = 0; i < spec.offerRoles.length; i++) {
				var offerRole = spec.offerRoles[i];
				for (var j = 0; j < offerRole.roleObjs.length; j++) {
					var roleObj = offerRole.roleObjs[j];
					if(roleObj.prodSpecParams !=undefined && roleObj.prodSpecParams.length>0){
						for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
							if(roleObj.prodSpecParams[k].itemSpecId==itemSpecId){
								return roleObj.prodSpecParams[k];
							}
						}
					}
				}
			}
		}
	};
	
	//通过产品id获取产品已开通附属实例列表
	var _getOfferList = function (prodId){
		for ( var i = 0; i < AttachOffer.openedList.length; i++) {
			var opened = AttachOffer.openedList[i];
			if(opened.prodId == prodId){
				return opened.offerList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//获取销售品实例构成
	var _getOffer = function(prodId,offerId){
		var offerList = _getOfferList(prodId);
		if(ec.util.isArray(offerList)){
			for ( var i = 0; i < offerList.length; i++) {
				if(offerList[i].offerId==offerId){
					return offerList[i];
				}
			}
		}
	};
	
	//根据规格ID获取销售品实例构成
	var _getOfferBySpecId = function(prodId,offerSpecId){
		var offerList = _getOfferList(prodId);
		if(ec.util.isArray(offerList)){
			for ( var i = 0; i < offerList.length; i++) {
				if(offerList[i].offerSpecId==offerSpecId){
					return offerList[i];
				}
			}
		}
	};
	
	//获取某个销售品参数  
	var _getOfferParam = function(prodId,offerId,itemSpecId){
		var offer = _getOffer(prodId,offerId);
		if(ec.util.isArray(offer.offerSpec.offerSpecParams)){
			for ( var i = 0; i < offer.offerSpec.offerSpecParams.length; i++) {
				if(offer.offerSpec.offerSpecParams[i].itemSpecId==itemSpecId){
					return offer.offerSpec.offerSpecParams[i];
				}
			}
		}
		/*if(offer.offerParamInfos!=undefined){
			for ( var i = 0; i < offer.offerParamInfos.length; i++) {
				if(offer.offerParamInfos[i].offerParamId==offerParamId){
					return offer.offerParamInfos[i];
				}
			}
		}*/
	};
	
	//获取某个实例功能产品参数  
	var _getProdInstParam = function(prodId,offerId,itemSpecId){
		var offer = _getOffer(prodId,offerId);
		if(ec.util.isArray(offer.offerMembers)){
			for (var i = 0; i < offer.offerMembers.length; i++) {
				var offerMember = offer.offerMembers[i];
				for (var j = 0; j < offerMember.prodParamInfos.length; j++) {
					for (var k = 0; k < offerMember.prodParamInfos.length; k++) {
						var prodParam = offerMember.prodParamInfos[k];
						if(prodParam.itemSpecId==itemSpecId){
							return prodParam;
						}
					}
				}
			}
		}
	};
	
	//通过产品id获取产品已选功能产品规格列表
	var _getServSpecList = function(prodId){
		for ( var i = 0; i < AttachOffer.openServList.length; i++) {
			var open = AttachOffer.openServList[i];
			if(open.prodId == prodId){
				return open.servSpecList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//根据产品id,跟规格ID获取功能产品
	var _getServSpec = function(prodId,servSpecId){
		var servSpecList = _getServSpecList(prodId);
		if(servSpecList != undefined){
			for ( var i = 0; i < servSpecList.length; i++) {
				if(servSpecList[i].servSpecId==servSpecId){
					return servSpecList[i];
				}
			}
		}
	};
	
	//获取某个功能产品一个参数  
	var _getServSpecParam = function(prodId,servSpecId,itemSpecId){
		var servSpec = _getServSpec(prodId,servSpecId);
		if(ec.util.isArray(servSpec.prodSpecParams)){
			for (var i = 0; i < servSpec.prodSpecParams.length; i++) {
				if(servSpec.prodSpecParams[i].itemSpecId==itemSpecId){
					return servSpec.prodSpecParams[i];
				}
			}
		}
	};
	
	//通过产品id获取产品已选功能产品实例列表
	var _getServList = function(prodId){
		for ( var i = 0; i < AttachOffer.openedServList.length; i++) {
			var opened = AttachOffer.openedServList[i];
			if(opened.prodId == prodId){
				return opened.servList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//通过功能产品id获取功能产品
	var _getServ = function(prodId,servId){
		var servList = _getServList(prodId);
		if(ec.util.isArray(servList)){
			for ( var i = 0; i < servList.length; i++) {
				if(servList[i].servId==servId){
					return servList[i];
				}
			}
		}
	};
	
	//通过功能产品id获取功能产品
	var _getServBySpecId = function(prodId,servSpecId){
		var servList = _getServList(prodId);
		if(ec.util.isArray(servList)){
			for ( var i = 0; i < servList.length; i++) {
				if(servList[i].servSpecId==servSpecId){
					return servList[i];
				}
			}
		}
	};
	
	//获取某个实例功能产品参数  
	var _getServInstParam = function(prodId,servId,itemSpecId){
		var serv = _getServ(prodId,servId);
		if(ec.util.isArray(serv.prodSpecParams)){
			for ( var i = 0; i < serv.prodSpecParams.length; i++) {
				var servParam = serv.prodSpecParams[i];
				if(servParam.itemSpecId==itemSpecId){
					return servParam;
				}
			}
		}
		/*if(ec.util.isArray(serv.prodInstParams)){
			for ( var i = 0; i < serv.prodInstParams.length; i++) {
				var servParam = serv.prodInstParams[i];
				if(servParam.itemSpecId==itemSpecId){
					return servParam;
				}
			}
		}*/
	};
	
	//获取增值业务列表
	var _getOpenAppList = function(prodId){
		for ( var i = 0; i < AttachOffer.openAppList.length; i++) {
			var open = AttachOffer.openAppList[i];
			if(open.prodId == prodId){
				return open.appList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//根据产品id获取销售品成员
	var _getOfferMember = function(prodId){
		if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //销售品实例构成
			for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[i];
				if(offerMember.objInstId==prodId){
					return offerMember;
				}
			}
		}
		return {};
	};
	
	//获取功能产品互斥依赖参数
	var _getExcDepServParam = function(prodId,servSpecId){
		//互斥依赖入参
		var param = { 
			servSpecId:servSpecId,
			prodId:prodId,
			orderedServSpecIds : [] //销售品互斥依赖查询入场数组
		};
		//遍历已选功能产品
		var servSpecList = CacheData.getServSpecList(prodId);
		if(ec.util.isArray(servSpecList)){
			$.each(servSpecList,function(){ //遍历已选择功能产品
				if(this.servSpecId!=servSpecId && this.isdel!="Y" && this.isdel!="C"){
					param.orderedServSpecIds.push(this.servSpecId);
				}
			});
		}
		//遍历已选功能产品
		var servList = CacheData.getServList(prodId);
		if(ec.util.isArray(servList)){
			$.each(servList,function(){ //遍历已选择功能产品
				if(this.servSpecId!=servSpecId && this.isdel!="Y" && this.isdel!="C"){
					param.orderedServSpecIds.push(this.servSpecId);
				}
			});
		}
		return param;
	};
	
	//获取可选包互斥依赖参数
	var _getExcDepOfferParam = function(prodId,offerSpecId){
		//互斥依赖入参
		var param = {
			prodId : prodId,
			offerSpecId : offerSpecId,
			orderedOfferSpecIds : [] //可选包互斥依赖查询入场数组
		};
		//已开通销售品列表
		var offerList = CacheData.getOfferList(prodId); 
		if(ec.util.isArray(offerList)){
			$.each(offerList,function(){
				if(this.offerSpecId!=offerSpecId && this.isdel!="Y"  && this.isdel!="N"){
					if(this.offerSpecId!=undefined){
						param.orderedOfferSpecIds.push(this.offerSpecId);
					}
				}
			});
		}
		//已选销售品列表
		var offerSpecList = CacheData.getOfferSpecList(prodId); 
		if(ec.util.isArray(offerSpecList)){
			$.each(offerSpecList,function(){
				if(this.offerSpecId!=offerSpecId && this.isdel!="Y"){
					if(this.offerSpecId!=undefined){
						param.orderedOfferSpecIds.push(this.offerSpecId);
					}
				}
			});
		}
		return param;
	};
	
	//二次业务把必须功能产品改成不能删除
	var _parseServ = function(data,objInstId){
		if(ec.util.isObj(data)){
			if(ec.util.isArray(data.result.servSpec)){
				if(ec.util.isObj(objInstId)){
					prodId=objInstId;
				}
				for (var i = 0; i < data.result.servSpec.length; i++) {
					var servSpec = data.result.servSpec[i];
					var serv = CacheData.getServBySpecId(prodId,servSpec.servSpecId); //已开通里面查找
					var newSpec = CacheData.getServSpec(prodId,servSpec.servSpecId); //已选里面查找
					if(servSpec.ifDault==0){
						if(ec.util.isObj(serv)){
							var $dd = $("#del_"+prodId+"_"+serv.servId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("delete").addClass("mustchoose");
								$dd.removeAttr("onclick");
								serv.isdel = "N";
							}
						}	
						else if(ec.util.isObj(newSpec)){
							var $dd = $("#del_"+prodId+"_"+newSpec.servSpecId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("delete").addClass("mustchoose");
								$dd.removeAttr("onclick");
								newSpec.isdel = "N";
							}
						}else {
							if(OrderInfo.actionFlag==2){//套餐变更
								servSpec.isdel = "C";
								CacheData.setServSpec(prodId,servSpec);
								AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams);
								//AttachOffer.checkServExcludeDepend(prodId,servSpec);
							}
						}
					}else if((OrderInfo.actionFlag==2||OrderInfo.actionFlag==21)&&servSpec.ifDault==1){//套餐变更需要展示默认的功能产品
						if(ec.util.isObj(serv)){
							var $dd = $("#del_"+prodId+"_"+serv.servId);
							if(ec.util.isObj($dd)){
								serv.isdel = "N";
							}
						}	
						else if(ec.util.isObj(newSpec)){
							var $dd = $("#del_"+prodId+"_"+newSpec.servSpecId);
							if(ec.util.isObj($dd)){
								newSpec.isdel = "N";
							}
						}else {
							servSpec.isdel = "C";
							CacheData.setServSpec(prodId,servSpec);
							AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams);
							//AttachOffer.checkServExcludeDepend(prodId,servSpec);
						}
					}
				}
			}
		}
	};
	
	//二次业务把必须可选包改成不能删除
	var _parseOffer = function(data){
		if(ec.util.isObj(data)){
			if(ec.util.isArray(data.result.offerSpec)){
				for (var i = 0; i < data.result.offerSpec.length; i++) {
					var offerSpec = data.result.offerSpec[i];
					if(offerSpec.ifDault==0){
						var offer = CacheData.getOfferBySpecId(prodId,offerSpec.offerSpecId); //已开通里面查找
						if(ec.util.isObj(offer)){
							var $dd = $("#del_"+prodId+"_"+offerSpec.offerId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("delete").addClass("mustchoose");
								$dd.removeAttr("onclick");
								offer.isdel = "N";
							}
						}	
						var newSpec = CacheData.getOfferSpec(prodId,offerSpec.offerSpecId); //已开通里面查找
						if(ec.util.isObj(newSpec)){
							var $dd = $("#del_"+prodId+"_"+newSpec.offerSpecId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("delete").addClass("mustchoose");
								$dd.removeAttr("onclick");
								newSpec.isdel = "N";
							}
						}else {
							if(OrderInfo.actionFlag==2){
								offerSpec.isdel = "C";
								CacheData.setOfferSpec(prodId,offerSpec);
								var param = CacheData.getExcDepOfferParam(prodId,offerSpec.offerSpecId);
								AttachOffer.addOpenList(prodId,offerSpec.offerSpecId); 
								if(param.orderedOfferSpecIds.length > 0 ){
									var data = query.offer.queryExcludeDepend(param);//查询规则校验
									if(data!=undefined && data.result!=undefined){
										var excludes = data.result.offerSpec.exclude;
										if(ec.util.isArray(excludes)){ //有互斥
											//删除已开通
											for (var i = 0; i < excludes.length; i++) {
												var excludeSpecId = excludes[i];
												var offer = CacheData.getOfferBySpecId(prodId,excludeSpecId);
												if(offer!=undefined){
													var $div = $("#li_span_"+prodId+"_"+offerId).parent();
													//var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
													$div.addClass("deldiv");
													offer.isdel = "Y";
													var $dd = $("#del_"+prodId+"_"+offer.offerId);
													if(ec.util.isObj($dd)){
														$dd.removeClass("delete").addClass("mustchoose");
														$dd.removeAttr("onclick");
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	};
	var _parseOffer = function(data,prodId){
		if(ec.util.isObj(data)){
			if(ec.util.isArray(data.result.offerSpec)){
				for (var i = 0; i < data.result.offerSpec.length; i++) {
					var offerSpec = data.result.offerSpec[i];
					if(offerSpec.ifDault==0){
						var offer = CacheData.getOfferBySpecId(prodId,offerSpec.offerSpecId); //已开通里面查找
						if(ec.util.isObj(offer)){
							var $dd = $("#del_"+prodId+"_"+offerSpec.offerId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("deldiv").addClass("mustchoose");
								$dd.removeAttr("onclick");
								offer.isdel = "N";
							}
						}	
						var newSpec = CacheData.getOfferSpec(prodId,offerSpec.offerSpecId); //已开通里面查找
						if(ec.util.isObj(newSpec)){
							var $dd = $("#del_"+prodId+"_"+newSpec.offerSpecId);
							if(ec.util.isObj($dd)){
								$dd.removeClass("deldiv").addClass("mustchoose");
								$dd.removeAttr("onclick");
								newSpec.isdel = "N";
							}
						}else {
							if(OrderInfo.actionFlag==2){
								offerSpec.isdel = "C";
								CacheData.setOfferSpec(prodId,offerSpec);
								var param = CacheData.getExcDepOfferParam(prodId,offerSpec.offerSpecId);
								AttachOffer.addOpenList(prodId,offerSpec.offerSpecId); 
								if(param.orderedOfferSpecIds.length > 0 ){
									var ruleData = query.offer.queryExcludeDepend(param);//查询规则校验
									if(ruleData!=undefined && ruleData.result!=undefined){
										var excludes = ruleData.result.offerSpec.exclude;
										if(ec.util.isArray(excludes)){ //有互斥
											//删除已开通
											for (var i = 0; i < excludes.length; i++) {
												var excludeSpecId = excludes[i];
												var offer = CacheData.getOfferBySpecId(prodId,excludeSpecId);
												if(offer!=undefined){
													var $div = $("#li_span_"+prodId+"_"+offerId).parent();
													//var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
													$div.addClass("deldiv");
													offer.isdel = "Y";
													var $dd = $("#del_"+prodId+"_"+offer.offerId);
													if(ec.util.isObj($dd)){
														$dd.removeClass("deldiv").addClass("mustchoose");
														$dd.removeAttr("onclick");
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	};
	
	//获取产品对应的角色
	var _getOfferRoleId = function(prodId){
		var offerRoleId = "";
		if(prodId>0){ //二次业务
			if(OrderInfo.offer.offerMemberInfos!=undefined){
				$.each(OrderInfo.offer.offerMemberInfos,function(i){
					if(this.objInstId == prodId){
						offerRoleId = this.offerRoleId;  //角色ID
						return false;
					}
				});
			}
		}else if(prodId<0){ //新装
			if(OrderInfo.offerSpec.offerRoles!=undefined){
				$.each(OrderInfo.offerSpec.offerRoles,function(i){
					var roleId = this.offerRoleId;  //角色ID
					if(this.prodInsts!=undefined){
						$.each(this.prodInsts,function(){
							if(this.prodInstId == prodId){
								offerRoleId = roleId;
								return false;
							}
						});
					}
				});
			}
		}
		return offerRoleId;
	};
	
	//重新排列offerMemberInfos 把按顺序把主卡角色提前
	var _sortOffer = function(data){
		var tmpOfferMemberInfos = [];
		for ( var i = 0; i < data.offerMemberInfos.length; i++) {
			var offerMember = data.offerMemberInfos[i];
			if(offerMember.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){ //主卡
				tmpOfferMemberInfos.push(offerMember);
			}
		}
		for ( var i = 0; i < data.offerMemberInfos.length; i++) {
			var offerMember = data.offerMemberInfos[i];
			if(offerMember.roleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){
				tmpOfferMemberInfos.push(offerMember);
			}
		}
		data.offerMemberInfos = tmpOfferMemberInfos;
	};
	
	//把选中的销售品保存到依赖或互斥的销售品规格中
	var _setOffer2ExcludeOfferSpec = function(param){
		if(param.dependOffer.offerGrpInfos.length>0){  // 依赖组
			var dependOffer=param.dependOffer;
			for (var i = 0; i < dependOffer.offerGrpInfos.length; i++) {
				var offerGrpInfo = dependOffer.offerGrpInfos[i];
				var $offerSpecs = $("input[name="+offerGrpInfo.grpId+"]:checked");
				var len  = $offerSpecs.length;
				dependOffer.offerGrpInfos[i].checkLen=len;
				for(var j=0;j<offerGrpInfo.subOfferSpecInfos.length;j++){
					var subOfferSpecInfo=offerGrpInfo.subOfferSpecInfos[j];
					$offerSpecs.each(function(){
						if($(this).val()==subOfferSpecInfo.offerSpecId){
							subOfferSpecInfo.isCheck=true;
						}
					});
				}
			}
		}
	};
	
	return {
		setParam				: _setParam,
		setServParam			: _setServParam,
		setOfferSpec			: _setOfferSpec,
		setServSpec				: _setServSpec,
		setServ2OfferSpec		: _setServ2OfferSpec,
		sortOffer				: _sortOffer,
		getParamContent			: _getParamContent,
		getOfferSpecList		: _getOfferSpecList,
		getOfferSpec			: _getOfferSpec,
		getSpecParam			: _getSpecParam,
		getOfferList			: _getOfferList,
		getOffer				: _getOffer,
		getOfferParam			: _getOfferParam,
		getOfferBySpecId		: _getOfferBySpecId,
		getServList				: _getServList,
		getServ					: _getServ,
		getServBySpecId			: _getServBySpecId,
		getServSpec				: _getServSpec,
		getServSpecList			: _getServSpecList,
		getProdInstParam		: _getProdInstParam,
		getProdSpecParam		: _getProdSpecParam,
		getServInstParam		: _getServInstParam,
		getServSpecParam		: _getServSpecParam,
		getOfferProdStr			: _getOfferProdStr,
		getOpenAppList			: _getOpenAppList,
		getAppContent			: _getAppContent,
		getOfferMember			: _getOfferMember,
		getExcDepServParam		: _getExcDepServParam,
		getExcDepOfferParam		: _getExcDepOfferParam,
		getOfferRoleId 			: _getOfferRoleId,
		parseServ				: _parseServ,
		parseOffer				: _parseOffer,
		setOffer2ExcludeOfferSpec : _setOffer2ExcludeOfferSpec
	};
})();
/**
 * 销售品产品相关查询
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("query","offer");

query.offer = (function() {
	
	/**
	 * 销售品规格构成查询
	 * @param  offerSpecId 销售品规格ID
	 * @param  offerTypeCd 销售品类型,销售品主 1 ,附属2  
	 * @param  mainOfferSpecId  主套餐id
	 * @param  partyId  客户ID
	 * @callBackFun 回调函数
	 */
	var _queryOfferSpec = function(param,callBackFun) {
		var url= contextPath+"/offer/queryOfferSpec";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data.offerSpec);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品规格构成失败,稍后重试");
					}
				}
			});
		}else{
			$.ecOverlay("<strong>正在查询销售品规格构成中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data.offerSpec;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品规格构成失败,稍后重试");
			}
		}
	};

	/**
	 * 销售品实例构成查询
	 * @param  offerId 销售品实例ID
	 * @param  areaId 地区ID
	 * @param  accessNumber 接入号
	 * @callBackFun 异步调用函数
	 */
	var _queryOfferInst = function(param,callBackFun) {
		var url= contextPath+"/offer/queryOfferInst";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品实例失败,稍后重试");
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品实例失败,稍后重试");
			}
		}
	};
	
	//根据选择产品查询销售品实例，并保存到OrderInfo.offer
	var _setOffer = function() {
		var prod = order.prodModify.choosedProdInfo ; 
		var param = {
			offerId : prod.prodOfferInstId,
			offerSpecId : prod.prodOfferId,
			acctNbr : prod.accNbr,
			areaId : prod.areaId,
			distributorId : ""
		};
		var data = query.offer.queryOfferInst(param); //查询销售品实例构成
		if(data&&data.code == CONST.CODE.SUCC_CODE){
			var flag = true;
			if(ec.util.isArray(data.offerMemberInfos)){
				CacheData.sortOffer(data);
				for ( var i = 0; i < data.offerMemberInfos.length; i++) {
					var member = data.offerMemberInfos[i];
					if(member.objType==""){
						$.alert("提示","销售品实例构成 "+member.roleName+" 成员类型【objType】节点为空，无法继续受理,请营业后台核实");
						return false;
					}else if(member.objType==CONST.OBJ_TYPE.PROD){
						/*if(member.objId==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品规格【objId】节点为空，无法继续受理,请营业后台核实");
							return false;
						}*/
						if(member.accessNumber==""){
							$.alert("提示","销售品实例构成 "+member.roleName+" 接入产品号码【accessNumber】节点为空，无法继续受理,请营业后台核实");
							return false;
						}
					}
					if(member.objInstId==prod.prodInstId){
						flag = false;
					}
				}
				if(flag){
					$.alert("提示","销售品实例构成中 没有包含选中接入号码【"+prod.accNbr+"】，无法继续受理，请业务后台核实");
					return false;
				}
				OrderInfo.offer.offerMemberInfos = data.offerMemberInfos; 
				OrderInfo.offer.offerId = prod.prodOfferInstId;
				OrderInfo.offer.offerSpecId = prod.prodOfferId;
				OrderInfo.offer.offerSpecName = prod.prodOfferName;
				return true;
			}else{//销售品成员实例为空
				$.alert("提示","查询销售品实例构成，没有返回成员实例无法继续受理");
				return false;
			}
		}
	};
	
	//销售品参数查询
	var _queryOfferParam = function(param,callBackFun) {
		var url= contextPath+"/offer/queryOfferParam";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品实例参数失败,稍后重试");
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>查询销售品实例参数中，请稍等...</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品实例参数失败,稍后重试");
			}
		}
	};	
	
	/**
	 * 已订购附属查询 
	 */
	var _queryAttachOfferHtml = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		param.isServiceOpen="Y";
		
		var url = contextPath+"/token/pad/offer/queryAttachOffer";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else {
						$.alert("提示","附属销售品实例查询失败,稍后重试");
						return;
					}
				}
			});
		}else{
			$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}		
	};
	
	/**
	 * 已订购销售品和功能产品
	 */
	var _queryOpenedAttachAndServ = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryOpenedAttachAndServ";
		$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else {
			$.alert("提示","查询附属销售品失败,稍后重试");
			return;
		}
	};
	
	//套餐变更，查询附属销售品页面
	var _queryChangeAttachOffer = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		param.isServiceOpen="Y";//Y-能力平台,N或不传-非能力平台
		var url = contextPath+"/pad/offer/queryChangeAttachOffer";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else {
						$.alert("提示","附属销售品实例查询失败,稍后重试");
						return;
					}
				}
			});
		}else{
			$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else {
				$.alert("提示","查询附属销售品实例失败,稍后重试");
				return;
			}
		}		
	};
	// 查询功能产品规格,(默认1，必须2，可订购3)
	var _queryServSpecPost = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryServSpecPost";
		$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购功能产品失败,稍后重试");
			return;
		}
	};
	// 查询功能产品规格,(默认1，必须2，可订购3)
	var _queryServSpecPost = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryServSpecPost";
		$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购功能产品失败,稍后重试");
			return;
		}
	};
	//附属销售品规格查询
	var _queryAttachSpec = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		param.isServiceOpen="Y";
		var url = contextPath+"/pad/offer/queryAttachSpec";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
						return;
					}else {
						$.alert("提示","附属销售品查询失败,稍后重试");
						return;
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
				return;
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}
	};
	
	//加载附属标签下的附属销售品
	var _queryCanBuyAttachSpec = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryCanBuyAttachSpec";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询附属销售品中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
						return;
					}else {
						$.alert("提示","附属销售品查询失败,稍后重试");
						return;
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>查询附属销售品中，请稍等...</strong>");
			var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
				return;
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}
	};
	
	// 查询默认必须可选包
	var _queryDefMustOfferSpec = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryDefaultAndRequiredOfferSpec";
		$.ecOverlay("<strong>查询默认必须可选包中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购功能产品失败,稍后重试");
			return;
		}
	};
	
	// 查询功能产品规格,(默认1，必须2，可订购3)
	var _queryServSpec = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryServSpec";
		$.ecOverlay("<strong>查询可订购功能产品中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","可订购功能产品失败,稍后重试");
			return;
		}
	};
	
	//销售品互斥依赖查询
	var _queryExcludeDepend = function(param){
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryExcludeDepend";
		$.ecOverlay("<strong>规则校验中,请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","数据查询异常，请稍后重试！");
		}
	};
		
	//功能产品互斥依赖查询
	var _queryServExcludeDepend = function(param){
		addParam(param);  //添加基本参数
		var url = contextPath+"/offer/queryServExcludeDepend";
		$.ecOverlay("<strong>规则校验中,请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,{strParam:JSON.stringify(param)});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","数据查询异常，请稍后重试！");
		}
	};
	
	//查询附属销售品规格
	var _searchAttachOfferSpec = function(param) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/token/pad/offer/searchAttachOfferSpec";
		$.ecOverlay("<strong>附属销售品查询中，请稍等...</strong>");
		var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","查询附属销售失败，请稍后重试！");
		}
	};
	
	//受理权限查询
	var _checkOperate = function(param) {
		var url = contextPath+"/order/checkOperate";
		$.ecOverlay("<strong>受理权限查询中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,"");
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","受理权限查询失败，请稍后重试！");
		}
	};
	
	//订单提交
	var _orderSubmit = function(param) {
		var url = contextPath+"/order/orderSubmit";
		if(OrderInfo.order.token!=""){
			url = contextPath+"/order/orderSubmit?token="+OrderInfo.order.token;
		}
		$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
		var response = $.callServiceAsHtml(url,param);
		$.unecOverlay();
		if(!response || response.code != 0){
			 return;
		}
		return response.data;
	};
	
	//订单提交（一次性）
	var _orderSubmitComplete = function(param) {
		var url = contextPath+"/order/orderSubmitComplete";
		if(OrderInfo.order.token!=""){
			url = contextPath+"/order/orderSubmitComplete?token="+OrderInfo.order.token;
		}
		$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if(!response || response.code != 0){
			 return;
		}
		return response.data;
	};	
	
	/**
	 * 查询主销售品规格构成
	 * 并对结果进行数据校验
	 */
	var _queryMainOfferSpec = function(param){
		var offerSpec = query.offer.queryOfferSpec(param); //查询主销售品构成
		if(offerSpec ==undefined){
			return false;
		}
		if( offerSpec.offerRoles ==undefined){
			$.alert("错误提示","销售品规格构成查询: 返回的销售品规格构成结构不对！");
			return false;
		}
		if(offerSpec.offerSpecId==undefined || offerSpec.offerSpecId==""){
			$.alert("错误提示","销售品规格构成查询: 销售品规格ID未返回，无法继续受理！");
			return false;
		}
		if(offerSpec.offerRoles.length == 0){
			$.alert("错误提示","销售品规格构成查询: 成员角色为空，无法继续受理！");
			return false;
		}
		if(offerSpec.feeType ==undefined || offerSpec.feeType=="" || offerSpec.feeType=="null"){
			$.alert("错误提示","无付费类型，无法新装！");
			return false;
		}
		offerSpec = SoOrder.sortOfferSpec(offerSpec); //排序主副卡套餐	
		if((OrderInfo.actionFlag==6||OrderInfo.actionFlag==2 || OrderInfo.actionFlag==1) && ec.util.isArray(OrderInfo.oldprodInstInfos)){//主副卡纳入老用户
			OrderInfo.oldofferSpec.push({"offerSpec":offerSpec,"accNbr":param.accNbr});
		}else{
			OrderInfo.offerSpec = offerSpec;
		}	
		return offerSpec;
	};
	
	/**
	 * 同步查询销售品规格构成
	 * 并对结果进行数据校验
	 */
	var _queryAttachOfferSpec = function(prodId,offerSpecId){
		var param = {
			offerSpecId:offerSpecId,
			partyId : OrderInfo.cust.custId,
			offerTypeCd:2	
		};	
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==2 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==14){//新装业务,添加主套餐id用于查询终端
			param.mainOfferSpecId = OrderInfo.offerSpec.offerSpecId;
		}
		if(OrderInfo.actionFlag==3){//可选包
			param.mainOfferSpecId = order.prodModify.choosedProdInfo.prodOfferId;
		}
		var offerSpec = query.offer.queryOfferSpec(param); //查询主销售品构成
		if(offerSpec ==undefined || offerSpec.offerRoles ==undefined){
			$.alert("提示","返回的销售品规格构成结构不对！");
			return false;
		}
		if(offerSpec.offerSpecId==undefined || offerSpec.offerSpecId==""){
			$.alert("提示","销售品规格ID未返回，继续受理将出现异常！");
			return false;
		}
		if(offerSpec.offerSpecName==undefined || offerSpec.offerSpecName==""){
			$.alert("提示","销售品规格名称未返回，继续受理将出现异常！");
			return false;
		}
		var offerRoles = []; //过滤角色
		var prodSpecId = OrderInfo.getProdSpecId(prodId);
		var flag = false;
		$.each(offerSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objId==prodSpecId){
					flag = true;
					return false;
				}
			});
			if(flag){
				offerRoles.push(this);
				return false;
			}
		});
		offerSpec.offerRoles = offerRoles;
		return offerSpec;
	};
	
	//预校验
	var _updateCheckByChange = function(param){
		var url = contextPath+"/order/prodModify/updateCheckByChange";
		$.ecOverlay("<strong>正在预校验中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == 0) {
			return response.data;
		}else if (response.code == -2) {
			$.alertM(response.data);
		}else{
		    if (response.data.resultMsg) {
		        $.alert("提示","预校验失败!失败原因为："+response.data.resultMsg);
		    } else {
		        $.alert("提示","预校验失败! 集团营业后台未给出原因。");
		    }
		}
	};
	
	/**
	 * 加载实例
	 * 如果传入了paramInfo，则使用它，否则拼入参
	 */
	var _loadInst = function(){
		if(OrderInfo.order.soNbr==null || OrderInfo.order.soNbr==undefined || OrderInfo.order.soNbr==""){
			OrderInfo.order.soNbr = UUID.getDataId();
		}
		if(CONST.getAppDesc()!=0){ //不是4g不需要加载
			return true;
		}
		if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 14 || OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){ //新装不要加载实例
			return true;
		}
		if (order.prodModify == undefined) { // 如果没有引入orderProdModify.js
			$.alert("提示","未获取到产品相关信息，无法办理二次业务！");
			return false;
		}
		
		var prod = order.prodModify.choosedProdInfo;
		
		if(prod==undefined || prod.prodInstId ==undefined){
			$.alert("提示","未获取到产品相关信息，无法办理二次业务！");
			return false;
		}
		
		var param = {
			areaId : OrderInfo.getProdAreaId(prod.prodInstId),
			acctNbr : prod.accNbr,
			custId : OrderInfo.cust.custId,
			soNbr : OrderInfo.order.soNbr,
			instId : prod.prodInstId,
			type : "2",
			queryType: "1,2,3,4,5",
			acctNbr : "",
			data:[]
		};
		
		//获取判断是调用新的全量接口是旧的全量接口
		var queryMergeFlag=OrderInfo.provinceInfo.mergeFlag;
		
		if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //遍历主销售品构成
			var flag = true;
			$.each(OrderInfo.offer.offerMemberInfos,function(){
				if(this.objType == CONST.OBJ_TYPE.PROD && this.accessNumber==prod.accNbr){ //选中号码在销售品实例构成中，为了防止销售品实例缓存
					flag = false;
					return false;
				}
			});
			
			if(flag){ //不在销售品实例缓存
				if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
					param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
					return _invokeLoadInstSub(param);
				}else{
					return query.offer.invokeLoadInst(param);
				}
				return query.offer.invokeLoadInst(param);
			}else{
				var vFlag = true;
				
				//1调用新接口，如果是0，就是按照旧的方式调用
				if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD){
							param.data.push({accessNbr:this.accessNumber,instId:this.objInstId});
						}
					});
					
					if(param!=null){
						if (!_invokeLoadInstSub(param)) {
							vFlag = false;
							return false;
						}
					}
				}else{
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objType == CONST.OBJ_TYPE.PROD){
							param.acctNbr = this.accessNumber;
							param.instId = this.objInstId;
							if (!query.offer.invokeLoadInst(param)) {
								vFlag = false;
								return false;
							}
						}
					});
				}
				
				return vFlag;
			}
		}else{
			if(queryMergeFlag!=null && queryMergeFlag!="" && queryMergeFlag!="undefined" && queryMergeFlag=="1"){
				param.data.push({accessNbr:prod.accNbr,instId:prod.prodInstId});
				return _invokeLoadInstSub(param);
			}else{
				return query.offer.invokeLoadInst(param);
			}
		}
	};
	
	//补充查询基本条件
	var addParam = function(param){
		param.staffId = OrderInfo.staff.staffId;
		param.channelId = OrderInfo.staff.channelId;
		param.areaId = OrderInfo.getProdAreaId(param.prodId);
		param.partyId = OrderInfo.cust.custId;
		param.distributorId = OrderInfo.staff.distributorId;
		
		if(OrderInfo.actionFlag == 3){
			param.mainOfferSpecId=order.prodModify.choosedProdInfo.prodOfferId;
		}else if(OrderInfo.actionFlag==21){
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					if(this.prodId==param.prodId){
						param.mainOfferSpecId=this.offerSpecId;
						return false;
					}
				});
			}
		}else{
			param.mainOfferSpecId=OrderInfo.offerSpec.offerSpecId;
		}
		
		if(ec.util.isObj(OrderInfo.order.soNbr)){  //缓存流水号
			param.soNbr = OrderInfo.order.soNbr;
		}
		
		if(order.ysl!=undefined){
			if(order.ysl.yslbean.yslflag!=undefined){
				param.yslflag = order.ysl.yslbean.yslflag;
			}
		}
		
		if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//主副卡纳入老用户
			for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
				if(param.acctNbr==OrderInfo.oldprodInstInfos[i].accNbr){
					param.areaId = OrderInfo.oldprodInstInfos[i].areaId;
					param.partyId = OrderInfo.oldprodInstInfos[i].custId;
					param.mainOfferSpecId=OrderInfo.oldprodInstInfos[i].mainProdOfferInstInfos[0].prodOfferId;
				}
			}
		}
	};
	
	var _invokeLoadInst = function(param) {
		order.prepare.createorderlonger();
		var url = contextPath+"/offer/loadInst";
		$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");
		var response = $.callServiceAsJsonGet(url,param);
		$.unecOverlay();
		if (response.code== 0) {
			return true;
		}else if(response.code==-2){
			$.alertM(response.data);
			return false;
		}else {
			if (response.msg == undefined) {
				$.alert("提示", "全量信息查询失败");
			} else {				
				$.alert("提示",response.msg);
			}
			return false;
		}
	};
	
	var _invokeLoadInstSub = function(param) {
		order.prepare.createorderlonger();
		var url = contextPath+"/token/pad/offer/loadInstNew";
		$.ecOverlay("<strong>全量信息加载中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,JSON.stringify(param));
		$.unecOverlay();
		if (response.code== 0) {
			return true;
		}else if(response.code==-2){
			$.alertM(response.data);
			return false;
		}else {
			if (response.msg == undefined) {
				$.alert("提示", "全量信息查询失败");
			} else {				
				$.alert("提示",response.msg);
			}
			return false;
		}
	};
	
	/**
	 * 主副卡页面查询 
	 */
	var _queryMemberHtml = function(param,callBackFun) {
		addParam(param);  //添加基本参数
		var url = contextPath+"/token/pad/offer/queryMember";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)},{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else {
						$.alert("提示","附属销售品实例查询失败,稍后重试");
						return;
					}
				}
			});
		}else{
			$.ecOverlay("<strong>查询附属销售品实例中，请稍等...</strong>");
			var response = $.callServiceAsHtmlGet(url,{strParam:JSON.stringify(param)});	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else {
				$.alert("提示","查询附属销售品失败,稍后重试");
				return;
			}
		}		
	};
	
	/**
	 * 查询产品实例属性
	 * param : {
	 * prodId : "", //产品实例id
	 * acctNbr : "", //接入号
	 * prodSpecId : "", //产品规格id
	 * areaId : "" //地区id
	 * }
	 */
	var _queryProdInstParam = function(param) {
		var url = contextPath+"/order/prodInstParam";
		$.ecOverlay("<strong>查询产品实例属性中，请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else {
			$.alert("提示","查询附属销售品失败,稍后重试");
			return;
		}
	};
	
	return {
		queryServSpecPost:_queryServSpecPost,
		checkOperate			: _checkOperate,
		loadInst				: _loadInst,
		invokeLoadInst			: _invokeLoadInst,
		setOffer				: _setOffer,
		searchAttachOfferSpec	: _searchAttachOfferSpec,
		queryOfferSpec			: _queryOfferSpec,
		queryServSpec			: _queryServSpec,
		queryOfferInst 			: _queryOfferInst,
		queryOfferParam 		: _queryOfferParam,
		queryAttachOfferHtml	: _queryAttachOfferHtml,
		queryChangeAttachOffer  : _queryChangeAttachOffer,
		queryCanBuyAttachSpec 	: _queryCanBuyAttachSpec,
		queryExcludeDepend		: _queryExcludeDepend,
		queryServExcludeDepend	: _queryServExcludeDepend,
		queryAttachSpec			: _queryAttachSpec,
		queryMainOfferSpec		: _queryMainOfferSpec,
		queryAttachOfferSpec	: _queryAttachOfferSpec,
		queryDefMustOfferSpec	: _queryDefMustOfferSpec,
		orderSubmit				: _orderSubmit,
		orderSubmitComplete		: _orderSubmitComplete,
		updateCheckByChange		: _updateCheckByChange,
		queryOpenedAttachAndServ: _queryOpenedAttachAndServ,
		queryMemberHtml			: _queryMemberHtml,
		queryProdInstParam		: _queryProdInstParam,
		invokeLoadInstSub:_invokeLoadInstSub
	};
})();
/**
 * 订单算费
 * 
 * @author tang
 */
CommonUtils.regNamespace("order", "calcharge");
/**
 * 订单算费
 */
order.calcharge = (function(){
	var _chargeItems = [];
	var _prints=[];
	var _olId=0;
	var _soNbr=0;
	var num=0;
	var money=0;
	var _pageFlag='newOrder';
	var submit_success=false;
	var inOpetate=false;
	//弹出业务对象窗口
	var _addbusiOrder=function(proId,obj){
		if($("#div_payitem_"+proId)!=undefined&&$("#div_payitem_"+proId).html()!=undefined){
			var htmlStr=$("#div_payitem_"+proId).html();
			var dialogStr=$("#paydialog").html();
			var popup = $.popup("#div_payitem_choose_"+proId,htmlStr,{
				width:600,
				height:500,
				contentHeight:400,
				afterClose:function(){
					$("#paydialog").html(dialogStr);
				}
			});
			
			order.calcharge.trObj=obj;
		}else{
			$.alert("提示","没有可添加费用项的业务对象！");
		}
	};
	//查询可添加的费用项
	var _addSubmit=function(boId,boActionTypeCd,objType,objId,objName,actionName,objInstId,prodId){
		var refundType = "0" ;
		//撤单 if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
		if(OrderInfo.actionFlag==11){
			refundType = "1" ;
		}else if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
			refundType = "2" ;
		}
		var param={"boId":boId,"objInstId":objInstId,"prodId":prodId,"boActionTypeCd":boActionTypeCd,"actionFlag":OrderInfo.actionFlag,
				"objType":objType,"objId":objId,"itemNum":num,"objName":objName,"actionName":actionName,"refundType":refundType};
		$.callServiceAsHtml(contextPath+"/pad/order/getChargeAddByObjId",param,{
			"before":function(){
				$.ecOverlay("<strong>正在增加收费项,请稍等会儿....</strong>");
			},"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				$("#div_payitem_choose_"+prodId).popup("close");
				_addItems(boId,response.data);
			},
			"fail":function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	//返回可添加的费用项
	var _addItems=function(boId,html){
		if(html!=''){
			$(order.calcharge.trObj).parent().parent().parent().after(html);
			var content$ = $("#order_confirm");
			$.jqmRefresh(content$);
			num--;
			_reflashTotal();
		}else{
			$.alert("提示","没有可添加的费用项");
			return;
		}
	};
	//删除费用项
	var _delItems=function(obj,val,str){
		if(str=='old'){
			var fee=$("#feeAmount_"+val).val();
			if(($("#realAmount_"+val).val())*100==0){
				$("#realAmount_"+val).val(((fee/100).toFixed(2))+"");
			}else{
				$("#realAmount_"+val).val('0');
			}			
			var real=($("#realAmount_"+val).val())*100;
			if(real!=fee){
				$("#chargeModifyReasonCd_"+val).show();
			}else{
				$("#chargeModifyReasonCd_"+val).hide();
			}
		}else{
			$(obj).parent().parent().parent().remove();
		}
		_reflashTotal();
	};
	//动态刷新页面信息
	var _reflashTotal=function(){
		_chargeItems=[];
		_prints=[];
		var realAmount=0;
		$("#calTab li").each(function() {
			var val = $(this).attr("id");
			if(val!=undefined&&val!=''){
				val=val.substr(5,val.length);
				if($("#paymentAmount_"+val) && $("#paymentAmount_"+val).val()*1==0){
					
				}else{
					var aa=($("#realAmount_"+val).val())*1;
					if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
						aa=($("#backAmount_"+val).val())*1;
					}
					realAmount=realAmount+aa;
					_commitParam(val);
				}
			}
		});
		if(OrderInfo.actionFlag==15){
			var backAmount=0;
			$("#calTab li").each(function() {
				var val = $(this).attr("id");
				if(val!=undefined&&val!=''){
					if($("#paymentAmount_"+val) && $("#paymentAmount_"+val).val()*1==0){
						
					}else{
						val=val.substr(5,val.length);
						var aa=($("#backAmount_"+val).val())*1;
						backAmount=backAmount+aa;
					}
				}
			});
			$('#backAmount').val(Number(backAmount).toFixed(2));
		}
		$('#realmoney').html(Number(realAmount).toFixed(2));
		if(OrderInfo.actionFlag==15){
			order.refund.conBtns();
		}else{
			_conBtns();
		}
	};
	//提交参数封装
	var _submitParam=function(){
		var remakrFlag = true ;
		var posLenFlag = true ;
		var posNvlFlag = true ;
		$("#calTab li").each(function() {
			var val = $(this).attr("id");
			if(val!=undefined&&val!=''){
				val=val.substr(5,val.length);
				var chargeModifyReasonCd=$("#chargeModifyReasonCd_"+val).val();
				if(chargeModifyReasonCd=="1"){
					if($("#remark_"+val).val()==undefined||$("#remark_"+val).val()==null||$("#remark_"+val).val()==''){
						remakrFlag = false ;
					}
				}
				var payMethodCd=$("#payMethodCd_"+val).val();
				var terminalNumber=$("#terminalNumber").val();
				var serialNumber=$("#serialNumber").val();
				if(payMethodCd == '110101'){
					if(terminalNumber==undefined || $.trim(terminalNumber)==""){
						posNvlFlag = false;
					}
					if(serialNumber==undefined || $.trim(serialNumber)==""){
						posNvlFlag = false;
					}
					
					if(terminalNumber.length >100){
						posLenFlag = false;
					}
					if(serialNumber.length >100){
						posLenFlag = false;
					}
				}
			}
		});
		if(!remakrFlag){
			$.alert("提示信息","请填写修改原因");
			return false ;
		}
		if(!posNvlFlag){
			$.alert("提示信息","pos流水号或者终端号不能为空，请重新输入！");
			return false ;
		}
		if(!posLenFlag){
			$.alert("提示信息","pos流水号或者终端号长度超过100位，请重新输入！");
			return false ;
		}
		
		_chargeItems=[];
		_buildChargeItems();
		return true ;
	};
	//费用项封装
	var _buildChargeItems = function(){
		$("#calTab li").each(function() {
			var val = $(this).attr("id");
			if(val!=undefined&&val!=''){
				val=val.substr(5,val.length);
				var realmoney=($("#realAmount_"+val).val())*100+'';
				var amount=$("#feeAmount_"+val).val();
				var feeAmount="";
				if(amount!=undefined&&amount!=''){
					feeAmount=amount+'';
				}else{
					feeAmount=realmoney;
				}
				if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
					feeAmount = $("#feeAmount_"+val).val()*1+'';
					realmoney = (0-($("#backAmount_"+val).val())*100)+'';
					//realmoney = (parseInt(feeAmount) + parseInt(realmoney))+'';
					//alert("feeAmount="+feeAmount+"||realmoney="+realmoney);
				}
				var acctItemTypeId=$("#acctItemTypeId_"+val).val();
				var objId=$("#objId_"+val).val();
				var objType=$("#objType_"+val).val();
				var acctItemId=$("#acctItemId_"+val).val();
				var boId=$("#boId_"+val).val();
				var payMethodCd=$("#payMethodCd_"+val).val();
				var objInstId=$("#objInstId_"+val).val();
				var prodId=$("#prodId_"+val).val();
				var boActionType=$("#boActionType_"+val).val();
				var paymentAmount = $("#paymentAmount_"+val).val();
				var chargeModifyReasonCd = 1 ;
				var remark="";
				if($("#chargeModifyReasonCd_"+val).parent(".ui-select").parent().is(":hidden")){
					if(feeAmount!=realmoney){
						remark="其他";
					}
				}else{
					chargeModifyReasonCd = $("#chargeModifyReasonCd_"+val).val();
					remark=$('#chargeModifyReasonCd_'+val).find("option:selected").text();
					if(chargeModifyReasonCd=="1"){
						remark = $("#remark_"+val).val();
					}
				}
				if(feeAmount!=realmoney&&remark==""){
					remark="其他";
				}
				var terminalNumber = "";
				var serialNumber = "";
				if(payMethodCd == '110101'){
					 terminalNumber=$("#terminalNumber").val();
					 serialNumber=$("#serialNumber").val();
				}
				
				var param={"realAmount":realmoney,
						"feeAmount":feeAmount,
						"paymentAmount":paymentAmount,
						"acctItemTypeId":acctItemTypeId,
						"objId":objId,
						"objType":objType,
						"acctItemId":acctItemId,
						"boId":boId,
						"prodId":prodId,
						"objInstId":objInstId,
						"payMethodCd":payMethodCd,
						"terminalNo":terminalNumber,
						"posSeriaNbr":serialNumber,
						"chargeModifyReasonCd":chargeModifyReasonCd,
						"remark":remark,
						"boActionType":boActionType
				};
				_chargeItems.push(param);
			}
		});
	};
	//调用接口，判断用户是否可以修改金额，并加载付费类型
	var _queryPayMethodByItem = function(itemTypeId,trid,defmethod){
		var params={"acctItemTypeId":itemTypeId};
		var url=contextPath+"/order/queryPayMethodByItem";
		
		var response = $.callServiceAsJson(url, params);
		if (response.code == 0) {
			if(response.data!=undefined&&response.data!=null){
				if(response.data.length>0){
					var items=response.data;
					var flag=false;
					if(OrderInfo.actionFlag==11){//撤单
						if(items[0].limitChange=="N"){
							return true ;
						}
					}else if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){//返销
						if(items[0].limitBuyBack=="N"){
							return true ;
						}
					}else if(OrderInfo.actionFlag==15){
						if(items[0].limitRedo=="N"){
							flag=true;
						}
					}else{
						if(items[0].limitChange=="N"){
							flag=true;
						}
					}
					var methodsInfo=items[0].payMethods;
					if(methodsInfo.length>0){
						if(trid){
							var html='<select  id="changeMethod_'+trid+'"  data-native-menu="false">';
							$.each(methodsInfo,function(i,method){
								if(method.payMethodCd==defmethod){
									html+='<option value="'+method.payMethodCd+'" selected="selected">'+method.payMethodName+'</option>';
								}else{
									html+='<option value="'+method.payMethodCd+'">'+method.payMethodName+'</option>';
								}
							});
							html+='</select>';
							$("#payMethodText_"+trid).html(html);
							$.jqmRefresh($("#payMethodText_"+trid));
							$("#changeMethod_"+trid).selectmenu("refresh");
							//$("#payMethodText_"+trid).html(html).trigger('create');  
						}
					}
					return flag ;
					
				}else{
					return false ;
				}
			}else{
				return false ;
			}
		}else if (response.code == -2) {
			$.alertM(response.data);
			return false ;
		}else{
			$.alert("提示","查询付费方式失败!");
			return false ;
		}
		
		
		
	};
	//修改原因选择
	var _bindChargeModifyReason = function(trid){
		if($("#chargeModifyReasonCd_"+trid).val()=="1"){
			$("#chargeModifySpan_"+trid).hide();
			$("#chargeModifySpan_"+trid).next(".edit").show();
		}
		$("#chargeModifyButton_"+trid).on("tap",function(){
			$(this).parents().find(".edit").hide();
			$("#chargeModifyReasonCd_"+trid+" option").each(function() { 
				if($(this).val()=='3'){
					$(this).attr("selected", true);
				}
			});
			$("#chargeModifyReasonCd_"+trid).selectmenu("refresh");
			$("#chargeModifySpan_"+trid).show();
		});
	};
	//付费方式修改
	var _changePayMethod=function(itemTypeId,trid,defmethod,obj){
		var flag = _queryPayMethodByItem(itemTypeId,trid,defmethod);
		if(flag){
			if(_queryAuthenticDataRange(trid)){
				$("#chargeModifyReasonCd_"+trid).change(function(){  
					if($(this).val()=="1"){
						$(this).parent(".ui-select").parent().hide().next(".edit").show();
					}
				});
				$("#chargeModifyButton_"+trid).on("tap",function(){
					$(this).parents().find(".edit").hide();
					$("#chargeModifyReasonCd_"+trid+" option").each(function() { 
						if($(this).val()=='3'){
							$(this).attr("selected", true);
						}
					});
					$("#chargeModifyReasonCd_"+trid).selectmenu("refresh");
					$("#chargeModifySpan_"+trid).show();
				});
				if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20||OrderInfo.actionFlag==15){//撤单，返销，补退费
					$("#backAmount_"+trid).removeAttr("disabled").focus() ;
					$("#backAmount_"+trid).parent().removeClass("ui-state-disabled");
				}else{
					$("#realAmount_"+trid).removeAttr("disabled").focus() ;
					$("#realAmount_"+trid).parent().removeClass("ui-state-disabled");
				}
			}
			
			$("#changeMethod_"+trid).off("change").on("change",function(){
				var methodCd=$(this).val();
				$("#payMethodCd_"+trid).val(methodCd);
				$("#changeMethod_"+trid).selectmenu("refresh");
				if(methodCd == '110101'){ //pos
					$("#posDiv").css("display","inline");
					$("#posDiv").css("disabled","");
				}
				else{
					$("#posDiv").css("display","none");
					$("#posDiv").css("disabled","disabled");
				}
			});
			
			
			
		}
		$(obj).removeAttr("onclick").attr("disabled","disabled");
	};
	//查询修改费用项维度权限
	var _queryAuthenticDataRange = function(trid){
		var params={};
		var url=contextPath+"/order/queryAuthenticDataRange";
		var response = $.callServiceAsJson(url, params);
		if (response.code == 0) {
			var dataRanges = response.data;
			var flag = false;
			for(var i=0;i<dataRanges.length;i++){
				if($("#acctItemTypeId_"+trid).val()==dataRanges[i].dataDimensionName){
					flag = true;
					break;
				}else{
					flag = false;
				}
			}
			if(flag){
				return true;
			}else{
				$.alert("提示","当前费用项不允许修改!");
				return false;
			}
		}else if (response.code == -2) {
			$.alertM(response.data);
			return false ;
		}else{
			$.alert("提示","权限数据范围查询失败!");
			return false ;
		}
	};
	
	var _commitParam=function(val){
		var realmoney=($("#realAmount_"+val).val())*100+'';
		var amount=$("#feeAmount_"+val).val();
		var feeAmount="";
		if(amount!=undefined&&amount!=''){
			feeAmount=amount+'';
		}else{
			feeAmount=realmoney;
		}
		var acctItemTypeId=$("#acctItemTypeId_"+val).val();
		var objId=$("#objId_"+val).val();
		var objType=$("#objType_"+val).val();
		var acctItemId=$("#acctItemId_"+val).val();
		var acctItemTypeName=$("#acctItemTypeName_"+val).val();
		var paymentAmount = $("#paymentAmount_"+val).val();
		var param2={"realmoney":realmoney,
				"feeAmount":feeAmount,
				"paymentAmount":paymentAmount,
				"acctItemTypeId":acctItemTypeId,
				"objId":objId,
				"objType":objType,
				"acctItemId":acctItemId,
				"acctItemTypeName":acctItemTypeName
		};
		_prints.push(param2);
	};
	//修改金额效果
	var _editMoney=function(obj,val,str){//obj:对象,val:id,str:类型
		var cash=$.trim($(obj).val());//当前费用
		if(cash==''){
			$(obj).val('0');
			order.calcharge.reflashTotal();
		}else{
			if(str=="old"){//修改费用
				var amount=$("#feeAmount_"+val).val();
				var check = true ;
				if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(cash)){
			  		$.alert("提示","费用金额请输入数字，最高保留两位小数！");
			  		check = false ;
				}else if((cash*100>amount*1)&&amount>0){
					$.alert("提示","实收费用金额不能高于应收金额！");
					check = false ;
				}else if((cash*100<amount*1)&&amount<0){
					$.alert("提示","实收费用金额不能低于应收金额！");
					check = false ;
				}
				if(check){
					var real=($(obj).val())*100;
		  			if(real!=amount){
		  				$("#chargeModifySpan_"+val).show();
					}else{
						$("#chargeModifySpan_"+val).hide();
						$("#chargeModifySpan_"+val).next(".edit").hide();
					}
					_reflashTotal();
				}else{
					if(money!=''){
			  			$(obj).val(money);
			  		}
			  		money="";
				}
			}else if(str=="undo"){//退费：撤单和返销
				var check = true ;
				if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(cash)){//金额非数字，恢复金额
			  		$.alert("提示","费用金额请输入数字，最高保留两位小数！");
			  		check = false ;
				}else{
					if(cash<0){//退费金额 不能填负值
						$.alert("提示","退费金额不能为负值！");
						check = false ;
					}else{
						var amount=$("#realhidden_"+val).val();
						var v_cash = cash*-1 ;
						if(v_cash<amount*1){//要退-100，不能退120
							$.alert("提示","退费金额不能高于实收金额！");
							check = false ;
						}
					}
				}
				if(check){
					var real=($(obj).val())*-1;
					if(real!=0){
						$("#chargeModifySpan_"+val).show();
					}else{
						$("#chargeModifySpan_"+val).hide();
						$("#chargeModifySpan_"+val).next(".edit").hide();
					}
					_reflashTotal();
				}else{
					if(money!=''){
			  			$(obj).val(money);
			  		}
			  		money="";
				}
			}else if(str=="new"){//新增费用
				if(!/^(-)?[0-9]+([.]\d{1,2})?$/.test(cash)){
			  		$.alert("提示","费用金额请输入数字，最高保留两位小数！");
			  		if(money!=''){
			  			$(obj).val(money);
			  		}
			  		money="";
				}else if(cash<0){//
					$.alert("提示","实收费用金额不能为负值！");
				}else{
					_reflashTotal();
				}
			}
		}
	};
	var _setGlobeMoney=function(obj){
		money=$.trim($(obj).val());
	};
	var _disableButton=function(){
		$("#toCharge").attr("disabled","disabled");
		$("#toComplate").attr("disabled","disabled");
		$("#orderCancel").attr("disabled","disabled");
		$("#orderCancel").off("tap");
		$("#toComplate").off("tap");
		$("#toCharge").off("tap");
	};
	var _conBtns=function(){
		$("#orderCancel").removeAttr("disabled");
		var val=$.trim($('#realmoney').html())*1;
		if(OrderInfo.actionFlag==11){
			$("#orderCancel").off("tap").on("tap",function(event){
				order.undo.orderBack();
			});
		}else{
			$("#orderCancel").off("tap").on("tap",function(event){
				SoOrder.orderBack();
			});
		}
		
		if(!submit_success){
			if(val!=0){
				$("#toCharge").removeAttr("disabled");
				$("#toCharge").parent().removeClass("ui-state-disabled");
				$("#toComplate").attr("disabled","disabled");
				$("#toCharge").off("tap").on("tap",function(event){
					_updateChargeInfoForCheck('1');
				});
				$("#toComplate").off("tap");
			}else{
				$("#toCharge").attr("disabled","disabled");
				$("#toComplate").removeAttr("disabled");
				$("#toCharge").off("tap");
				$("#toComplate").off("tap").on("tap",function(event){
					_chargeSave('0',false);
				});
			}
		}else{
			$("#toCharge").removeAttr("disabled");
			$("#toComplate").attr("disabled","disabled");
			$("#toCharge").off("tap");
			$("#toComplate").off("tap");
		}
	};
	
	var _updateChargeInfoForCheck=function(flag){
		_disableButton();
		if(submit_success){
			$.alert("提示","订单已经建档成功,不能重复操作!");
			return;
		}
		if(inOpetate){
			return;
		}
		if(!_submitParam()){
			_conBtns();
			return ;
		}
		inOpetate=true;
		var url=contextPath+"/order/updateChargeInfoForCheck";
		var params={
				"olId":_olId,
				"soNbr":OrderInfo.order.soNbr,
				"areaId" : OrderInfo.staff.areaId,
				"chargeItems":_chargeItems,
				"custId":OrderInfo.cust.custId
		};
		$.callServiceAsJson(url,params, {
			"before":function(){
				$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>");
			},"always":function(){
				$.unecOverlay();
			},	
			"done" : function(response){
				if (response.code == 0) {
					_chargeSave(flag,true);
				}else if (response.code == -2) {
					_conBtns();
					inOpetate=false;
					$.alertM(response.data);
				}else{
					_conBtns();
					inOpetate=false;
					if(response.data!=undefined){
						$.alert("提示",response.data);
					}else{
						$.alert("提示","代理商保证金校验失败!");
					}
				}
			}
		});
	};
	
	var _tochargeSubmit=function(orderdata){	
		var url=contextPath+"/order/checkRuleToProv";
		var params={
				"olId":orderdata.rolId,
				"soNbr":orderdata.rsoNbr,
				"areaId" : OrderInfo.staff.areaId,
				"chargeItems":[]
		};
		$.ecOverlay("<strong>正在下省校验,请稍等会儿....</strong>");
		var response = $.callServiceAsJson(url,params);
		$.unecOverlay();		
		var provCheckResult;				
		if (response.code == 0) {					
			var data = response.data;
			if(data.checkResult!=undefined){
				OrderInfo.checkresult=data.checkResult;		
			}
			provCheckResult = {							
					code : 0				
			};				
		}else{					
			provCheckResult = {							
					code : 1,							
					data : response.data
			};
		}
		return provCheckResult;
	};
	var _chargeSave = function(flag,isparam){
		if(!isparam){
			_disableButton();
			if(submit_success){
				$.alert("提示","订单已经建档成功,不能重复操作!");
				return;
			}
			if(inOpetate){
				return;
			}
			if(!_submitParam()){
				_conBtns();
				return ;
			}
			inOpetate=true;
		}
		var params={
				"olId":_olId,
				"soNbr":OrderInfo.order.soNbr,
				"areaId" : OrderInfo.staff.areaId,
				"chargeItems":_chargeItems
		};
		var url=contextPath+"/token/pad/order/chargeSubmit?token="+OrderInfo.order.token;
		var response=$.callServiceAsJson(url, params, {});
		var msg="";
		if (response.code == 0) {
			submit_success=true;
			//受理成功，不再取消订单
			SoOrder.delOrderFin();
			
			if(OrderInfo.actionFlag==31){//改产品密码，则将session中密码重置，用户需要重新输入密码
				var url=contextPath+"/cust/passwordReset";
				var response2 = $.callServiceAsJson(url, null, {});
			}
			if(flag=='1'){
				if(OrderInfo.actionFlag==11){
					msg="退费成功";
				}else{
					msg="收费成功";
				}
			}else{
				msg="受理成功";
			}	
			$("#orderCancel").removeAttr("disabled");
			$("#printVoucherA").attr("disabled","disabled");
			//移除费用新增、费用修改按钮
			$(".ui-icon-plus").remove();
			$(".ui-icon-gear").remove();
			$(".ui-icon-delete").remove();
			$("#calTab li").each(function() {
				var trid = $(this).attr("id");
				if(trid!=undefined&&trid!=''){
					trid=trid.substr(5,trid.length);
					if(OrderInfo.actionFlag==11||OrderInfo.actionFlag==19||OrderInfo.actionFlag==20||OrderInfo.actionFlag==15){//撤单，返销，补退费
						$("#backAmount_"+trid).attr("disabled","disabled");
						$("#backAmount_"+trid).parent().addClass("ui-state-disabled");
					}else{
						$("#realAmount_"+trid).attr("disabled","disabled");
						$("#realAmount_"+trid).parent().addClass("ui-state-disabled");
					}
				}
			});
			if(OrderInfo.actionFlag==11){
				$("#orderCancel").html("<span>返回首页</span>");
				$("#orderCancel").off("tap").on("tap",function(event){
					order.undo.toUndoMain(1);
				});
			}else{
				/*$("#orderCancel").html("继续受理");
				$("#orderCancel").off("tap").on("tap",function(event){
					_backToEntr();
				});*/
				var redirectUri = OrderInfo.provinceInfo.redirectUri;//回调地址
				if(redirectUri != null && redirectUri!=undefined && redirectUri!=""){
					$("#orderCancel").html("返回省份");
					//$("#orderCancel").off("click").on("click",function(event){_backToEntr();});
					$("#orderCancel").off("click").on("click",function(event){_backToProvince();});	
				}else{
					$("#orderCancel").hide();
					$("#ordermessage").show();
					$("#ordermessage").html("订单已"+msg);						
				}
			}
			SoOrder.updateResState(); //修改UIM，号码状态
			//金额不为零，提示收费成功
			if(flag=='1'){
				var realmoney=($('#realmoney').html())*1;
				//realmoney=0;
				//费用大于0，才可以打印发票
				if (realmoney > 0) {
					//收费成功，先调初始化发票信息
					var param={
						"soNbr":OrderInfo.order.soNbr,
						"billType" : 0,
						"olId" : _olId,
						"printFlag" : -1,
						"areaId" : OrderInfo.staff.areaId,
						"acctItemIds":[]
					};
					var initResult = common.print.initPrintInfo(param);
					if(!initResult) {
						return;
					}
					//然后提示是否打印发票
					$.confirm("信息提示","收费成功，是否打印发票?",{
						names:["是","否"],
						yesdo:function(){
							var param={
								"soNbr":OrderInfo.order.soNbr,
								"billType" : 0,
								"olId" : _olId,
								"printFlag" : 0,
								"areaId" : OrderInfo.staff.areaId,
								"acctItemIds":[]
							};
							common.print.prepareInvoiceInfo(param);
							return;
						},
						no:function(){
							var redirectUri = OrderInfo.provinceInfo.redirectUri;//回调地址
							if(redirectUri != null && redirectUri!=undefined && redirectUri!=""){
								_backToProvince();
							}
						}
					});
				} else {
					//提示收费成功
					_showFinDialog(flag, msg);
				}
			} else {
				//提示受理完成
				_showFinDialog(flag, msg);
			}
			return;
			
		}else if (response.code == -2) {
			_conBtns();
			SoOrder.getToken();
			inOpetate=false;
			$.alertM(response.data);
		}else{
			_conBtns();
			SoOrder.getToken();
			inOpetate=false;
			if(response.data!=undefined){
				$.alert("提示",response.data);
			}else{
				$.alert("提示","费用信息提交失败!");
			}
		}	
	};
	var _showFinDialog=function(flag, msg){
		var title='';
		if(flag=='1'){
			if(OrderInfo.actionFlag==11){
				title='退费结果';
			}else{
				title='收费结果';
			}
		}else{
			title='受理结果';
		}
		$("#payresultitle").html(title);
		$("#payresultMsg").html(msg);
		var htmlStr=$("#div_payresult").html();
		var dialogStr=$("#paydialog").html();
		var popup = $.popup("#div_payresult_choose",htmlStr,{
			width:400,
			height:270,
			contentHeight:150,
			afterClose:function(){
				$("#paydialog").html(dialogStr);
				order.cust.mgr.custReset();
			}
		});
		//返回三个入口
		/*if(OrderInfo.actionFlag==11){
			$("#successTip_dialog_cnt").off("tap").on("tap",function(event){
				$("#div_payresult_choose").popup("close");
				order.undo.toUndoMain(1);
			});
		}else{
			$("#successTip_dialog_cnt").off("tap").on("tap",function(event){
				$("#div_payresult_choose").popup("close");
				_backToEntr();
			});
		}*/
		
		var redirectUri = OrderInfo.provinceInfo.redirectUri;//回调地址
		if(redirectUri != null && redirectUri!="" && redirectUri!=undefined){
			$("#successTip_dialog_comfirm").show();
			$("#successTip_dialog_comfirm").off("click").on("click",function(event){_backToProvince();});		
		}
		
		if(flag=='1'){
			if(OrderInfo.actionFlag==11){
				$("#successTip_dialog_inv").show();
				$("#successTip_dialog_inv").off("tap").on("tap",function(event){_invaideInvoice();});
			}	
		}
	};
	
	var _selePaymethod=function(str,obj){
		var selObj =$("#payMethodCd_"+str);
		selObj.empty();
		$("select[@id=backpayMethodCd_"+str+"] option").each(function(){
			var vv=$(this).val();
			if(vv!=undefined){
				var tt=$(this).text();
				if(vv.split("_")[1]==$(obj).val()){
					$("<option value='"+vv.split("_")[0]+"'>"+tt+"</option>").appendTo(selObj);
				}
			}
	    });

	};
	var _backToEntr=function(){
		/*if (OrderInfo.actionFlag == 17 || OrderInfo.actionFlag == 18) {
			window.location.href = contextPath+"/mktRes/terminal/exchangePrepare";
			return;
		}else if(OrderInfo.actionFlag ==8){
			window.location.href = contextPath+"/cust/mvnoCustCreate";
			return;
		}*/
		/*$("#order_confirm,#order_fill,#order_bill,#order_prepare").empty();
		$("#ul_busi_area").show();
		order.cust.mgr.custReset();
		//如果是新建客户，则要重置客户信息
		if(OrderInfo.cust.custId == -1) {
			order.cust.mgr.custReset();
		}*/
		window.location.reload();
	};
	var _calchargeInit=function(){
		
		$("#step1").hide();
		$("#step2").hide();
		$("#step3").show();
		
		_olId = OrderInfo.orderResult.olId;
		_soNbr = OrderInfo.orderResult.soNbr;
		_chargeItems = [];
		_prints=[];
		num=0;
		money=0;
		submit_success=false;
		inOpetate=false;
		var refundType = "0" ;
		if(OrderInfo.actionFlag==11){
			refundType = "1" ;
		}else if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
			refundType = "2" ;
		}
		var params={
			"olId":_olId,
			'custVipLevel':OrderInfo.cust.vipLevel,
			"actionFlag":OrderInfo.actionFlag,
			"actionTypeName" : encodeURI(OrderInfo.actionTypeName),
			"businessName" : encodeURI(OrderInfo.businessName),
			"olNbr":OrderInfo.orderResult.olNbr,
			"soNbr" : OrderInfo.order.soNbr,
			"refundType":refundType,
			"checkResult":JSON.stringify(OrderInfo.checkresult)
		};
		$.callServiceAsHtmlGet(contextPath+"/token/pad/order/getChargeList",params,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				//$.unecOverlay();
			},
			"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","收费页面加载失败，请稍后重试");
					return;
				}
				
				SoOrder.getToken();
				
				$.unecOverlay();
				
				if(OrderInfo.provinceInfo.isFee == "1"){//不收费	
					//暂存成功，不再取消订单
					SoOrder.delOrderFin();
					var redirectUri = OrderInfo.provinceInfo.redirectUri;//回调地址
					if(redirectUri == null || redirectUri=="" || redirectUri==undefined){
						$.Zebra_Dialog("<div style='width:100%;font-size:15px;'>订单暂存成功</div>", {
							'open_speed':0,
							'keyboard':false,
			            	'modal':true,
			            	'overlay_close':false,
			            	'overlay_opacity':.5,
			                'type':     'information',
			                'title':    "提示",
			                'buttons' :  []
						});
						
						//$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>订单暂存成功</div>");
						return;
					}
					$.alert("提示","订单暂存成功");
					_backToProvince();	
				}else if(OrderInfo.provinceInfo.isFee == "2"){
					var content$ = $("#order_confirm").html(response.data).fadeIn();
					var htmls=$("#paydialog").html();
					$("#paydialog").html('');
					$.jqmRefresh(content$);
					$("#paydialog").html(htmls);
					//$("#navbar").slideUp(500);
					$.each($(".cashier_dd"),function(){
						var prodId=$(this).attr("id");
						var obj=$(this);
						if($.trim($(this).html())==""&&$(".userorderlist")!=undefined){
							$.each($("#userorderlist li").find("dl:eq(0)"),function(){
								 var prodInstId=$(this).attr("prodInstId");
								 var accNbr=$(this).attr("accNbr");
								 var prodName=$(this).attr("productName");
								 if(prodInstId!=undefined&&accNbr!=undefined){
									 if(prodId==prodInstId){
										 obj.html(prodName+"&nbsp;-&nbsp;"+accNbr);
									 }
								 }
							});	
						}
						
					});
					$("#printVoucherA").off("tap").on("tap", function(event){
						if(!_submitParam()){
							return ;
						}
						var voucherInfo = {
							"olId":_olId,
							"soNbr":OrderInfo.order.soNbr,
							"busiType":"1",
							"chargeItems":_chargeItems,
							"areaId":OrderInfo.getAreaId()
						};
						common.print.signVoucher(voucherInfo);
					});
					_reflashTotal();
				}
			},
			"fail":function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	
	var _invaideInvoice = function(){
		var params = {"olId":OrderInfo.order.oldSoId,"soNbr":OrderInfo.order.oldSoNbr} ;
		$.callServiceAsHtmlGet(contextPath+"/order/invaideInvoice",params,{
			"before":function(){
				$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code==0){
					var data = $.parseJSON(response.data) ;
					if(data.code==0){
						$("#successTip_dialog_inv").off("tap");
						$.alert("提示","作废发票成功！");	
					}else if(data.code==1){
						$.alert("提示","作废发票失败！");
					}else if(data.code==2){
						$.alert("提示","未获取到发票信息！");
					}else if(data.code==3){
						$.alert("提示","获取发票失败！");
					}else{
						$.alert("提示","作废发票异常！");
					}
				} else if(response.code == -2){
				}else{
					$.alert("提示","作废发票异常！");
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	
	var _backToProvince=function(){
		var reParams = {
				provIsale:OrderInfo.provinceInfo.provIsale,
				extCustOrderID:OrderInfo.orderResult.olId,
				resultCode:'0',
				redirectUri:OrderInfo.provinceInfo.redirectUri
			};
		$.callServiceAsHtmlGet(contextPath+"/mode/pad/backProvince",reParams,{
			"before":function(){
				$.ecOverlay("<strong>正在处理中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code==0){								
					var data = $.parseJSON(response.data) ;
					if(data.code==0){
						//判断
						if(data.data.indexOf("&amp;")!=-1){
							data.data=data.data.replace(/\&amp;/g,"&");
						}
						window.location.href = data.data;
						return;									
					}else if(data.code==1){
						$.alert("提示",data.data);
					}
				}else{
					$.alert("提示","页面回调异常！");
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","页面回调可能发生异常，请稍后再试！");
			}
		});	
	};
	
	return {
		addItems:_addItems,
		delItems:_delItems,
		reflashTotal:_reflashTotal,
		editMoney:_editMoney,
		setGlobeMoney:_setGlobeMoney,
		addbusiOrder:_addbusiOrder,
		addSubmit:_addSubmit,
		selePaymethod:_selePaymethod,
		calchargeInit:_calchargeInit,
		pageFlag:_pageFlag,
		changePayMethod:_changePayMethod,
		bindChargeModifyReason:_bindChargeModifyReason,
		invaideInvoice:_invaideInvoice,
		tochargeSubmit:_tochargeSubmit,
		backToProvince:_backToProvince
	};
})();



CommonUtils.regNamespace("order", "main");

order.main = (function(){ 
	
	/**
	 * 填单页面展示
	 * param = {
	 * 		boActionTypeCd : S1,
	 * 		boActionTypeName : "订购",
	 *		offerSpecId : 1234,//销售品规格ID
	 *		offerSpecName : "乐享3G-129套餐",//销售品名称,
	 *		feeType : 2100,付费类型
	 *		viceCardNum : 2,//副卡数量
	 *		offerNum : 3,//销售品数量
	 *		type : 1,//1购套餐2购终端3选靓号
	 *		terminalInfo : {
	 *			terminalName : "iphone",
	 *			terminalCode : "2341234124"
	 *		},
	 *		offerRoles : [
	 *			{
	 *				offerRoleId : 1234,
	 *				offerRoleName : "主卡",
	 *				memberRoleCd : "0",
	 *				roleObjs : [{
	 *					offerRoleId : 1,
	 *					objId : ,
	 *					objName : "CDMA",
	 *					objType : 2
	 *				}]
	 *			},
	 *			{
	 *				offerRoleId : 2345,
	 *				offerRoleName : "副卡",
	 *				memberRoleCd : "1"
	 *			}
	 *		]
	 *	}
	 * 
	 */
	var _buildMainView = function(param) {
		if (param == undefined || !param) {
			param = _getTestParam();
		}
		
		if(order.memberChange.newMemberFlag && OrderInfo.actionFlag == 6){//主副卡成员变更 付费类型判断 如果一致才可以进行加装
			var is_same_feeType=false;//
			if(param.feeTypeMain=="2100" && (param.offerSpec.feeType=="2100"||param.offerSpec.feeType=="3100"||param.offerSpec.feeType=="3101"||param.offerSpec.feeType=="3103")){
				is_same_feeType=true;
			}else if(param.feeTypeMain=="1200" && (param.offerSpec.feeType=="1200"||param.offerSpec.feeType=="3100"||param.offerSpec.feeType=="3102"||param.offerSpec.feeType=="3103")){
				is_same_feeType=true;
			}else if(param.feeTypeMain=="1201" && (param.offerSpec.feeType=="1201"||param.offerSpec.feeType=="3101"||param.offerSpec.feeType=="3102"||param.offerSpec.feeType=="3103")){
				is_same_feeType=true;
			}
			if(!is_same_feeType){
				$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");
				return;
			}
		}
		$.callServiceAsHtml(contextPath+"/token/pad/order/main",param,{
			"before":function(){
				$.ecOverlay("<strong>正在加载中,请稍等...</strong>");
			},"done" : function(response){
				if(!response){
					 response.data='查询失败,稍后重试';
				}
				if(response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				OrderInfo.actionFlag = param.actionFlag;
				if(OrderInfo.actionFlag == 2){
					offerChange.fillOfferChange(response,param);
					$.jqmRefresh($("#order_fill_content"));
				}else if(OrderInfo.actionFlag == 6){	
					_callBackMemberView(response,param);
					$.jqmRefresh($("#order_fill_content"));
				}else {
					if(OrderInfo.actionFlag==1){
						_callBackBuildViewSub(response,param);
					}
					else{
						_callBackBuildView(response,param);
					}
					
				}
				/*if(CONST.getAppDesc()==1 && (OrderInfo.actionFlag==1 ||OrderInfo.actionFlag==14)){
					$("#li_is_activation").show();
				}*/
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	var _callBackBuildViewSub = function(response, param) {
		order.prepare.showOrderTitle(OrderInfo.actionTypeName, param.offerSpecName, false);
		SoOrder.initFillPage(); //并且初始化订单数据
		var content$ = $("#order_fill").html(response.data).fadeIn();
		$.jqmRefresh(content$);
		_initOfferLabel();//初始化主副卡标签
		_initFeeType(param);//初始化付费方式
		if(param.actionFlag==''){
			OrderInfo.actionFlag = 1;
		}
		mktRes.phoneNbr.initOffer('-1');//主卡自动填充号码入口已选过的号码
		_loadOther(param);//页面加载完再加载其他元素
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==13 || OrderInfo.actionFlag==14){
			//_initAcct();//初始化帐户列表 
			$("#acctName").val(OrderInfo.cust.partyName);
			order.dealer.initDealer();//初始化协销		
		}
		/*if(OrderInfo.actionFlag==1){
			$("#templateOrderDiv").show();
		}
		_addEvent();//添加页面事件*/
		$("#fillNextStep").off("click").on("click",function(){
			SoOrder.submitOrder();
		});
		if (param.memberChange) {
			$("#orderedprod").hide();
			$("#order_prepare").hide();
			$("#productDiv .pdcardcon:first").show();
			order.prepare.step(1);
			$("#fillLastStep").off("click").on("click",function(){
				order.prodModify.cancel();
			});
		}else{
			$("#fillLastStep").off("click").on("click",function(){
				_lastStep();
			});
		}
		
		
		
		//新装省份传主副卡信息
		if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""){
			//主卡选号需要的参数 
			var param = {"phoneNum":"",
						"prodId":""};
			//查询号码信息
			param.phoneNum = OrderInfo.newOrderNumInfo.mainPhoneNum;
			param.prodId = "-1";
			var result = mktRes.phoneNbr.queryPhoneNumber(param);
			if(result==undefined||result.datamap.undefined||result.datamap.baseInfo==undefined){
				$("#choosedNum_-1").val("");			
				$("#btn_choosedNum_-1").removeAttr("onclick");
			}else{
				if(result&&result.datamap.baseInfo!=undefined){					
					var phoneParam={
							prodId : param.prodId, //从填单页面头部div获取
							accessNumber : result.datamap.baseInfo.phoneNumber, //接入号
							anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
							anId : result.datamap.baseInfo.phoneNumId, //接入号ID
							pnLevelId:result.datamap.baseInfo.phoneLevelId,
							anTypeCd : result.datamap.baseInfo.pnTypeId, //号码类型
							state : "ADD", //动作	,新装默认ADD
							areaId:result.datamap.baseInfo.areaId,
							areaCode:result.datamap.baseInfo.zoneNumber,
							memberRoleCd:"",
							preStore:result.datamap.baseInfo.prePrice,
							minCharge:result.datamap.baseInfo.pnPrice,
							idFlag:"1"
						};
					if(param.prodId&&param.prodId=="-1"){
						phoneParam.memberRoleCd = CONST.MEMBER_ROLE_CD.MAIN_CARD;
					}
					$("#choosedNum_-1").val(OrderInfo.newOrderNumInfo.mainPhoneNum);
					$("#btn_choosedNum_-1").removeAttr("onclick");
					OrderInfo.boProdAns.push(phoneParam);
				}
			}
		}
		if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""){
			var param = {"phoneNum":"","prodId":""};			
			var numBtns = $("input[id^='choosedNum_']");		
			var nums = OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");
			var subNums = [];
			$.each(numBtns,function(){
				if($(this).attr("id")!="choosedNum_-1"){
					subNums.push(this);
				};
			});
			$.each(subNums,function(index,subNum){
				//副卡选号需要的参数  
				param.phoneNum = nums[index];
				param.prodId = -2-index;
				var resData = mktRes.phoneNbr.queryPhoneNumber(param);
				if(resData==undefined||resData.datamap.undefined||resData.datamap.baseInfo==undefined){
					$(subNum).val("");
					$("#btn_choosedNum_"+param.prodId).removeAttr("onclick");
				}else{
					if(resData&&resData.datamap.baseInfo!=undefined){
						var phoneParam={
								prodId : param.prodId, //从填单页面头部div获取
								accessNumber : resData.datamap.baseInfo.phoneNumber, //接入号
								anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
								anId : resData.datamap.baseInfo.phoneNumId, //接入号ID
								pnLevelId:resData.datamap.baseInfo.phoneLevelId,
								anTypeCd : resData.datamap.baseInfo.pnTypeId, //号码类型
								state : "ADD", //动作	,新装默认ADD
								areaId:resData.datamap.baseInfo.areaId,
								areaCode:resData.datamap.baseInfo.zoneNumber,
								memberRoleCd:"",
								preStore:resData.datamap.baseInfo.prePrice,
								minCharge:resData.datamap.baseInfo.pnPrice,
								idFlag:"1"
							};
						if(param.prodId&&param.prodId!="-1"){
							phoneParam.memberRoleCd = CONST.MEMBER_ROLE_CD.VICE_CARD;
						}		
						$(subNum).val(nums[index]);
						$("#btn_choosedNum_"+param.prodId).removeAttr("onclick");
						OrderInfo.boProdAns.push(phoneParam);
					}
				}

			});
		}
		//新装显示uim信息框
		
		if(OrderInfo.actionFlag&&OrderInfo.actionFlag=="1"){
			var $uimDivs = $("div[id^='uimDiv_']");
			$.each($uimDivs,function(index,$uimDiv){
				var id=$($uimDiv).attr("id");
				
				 if(id.indexOf("-")!=-1){
					 $($uimDiv).show();
				 }
				
			});
		}
		
		//初始化UIM卡
		_initUimCode();
		
		//新装是否传帐户合同号
		if(OrderInfo.acct&&OrderInfo.acct.acctCd!=null&&OrderInfo.acct.acctCd!=""){//新装传帐户id
			_createAcctWithId();
		}
		
		//新装二次加载处理
		
		if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){
			$("#dealerTbody").empty();
			var custOrderList = OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;		
			$.each(custOrderList,function(){
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员
					var prodId = this.busiObj.instId;
					var accessNumber = this.busiObj.accessNumber;//接入号
					var terminalCode = this.data.bo2Coupons[0].terminalCode;//uim卡号
					var feeType = this.data.boProdFeeTypes[0].feeType;//付费类型
					var prodPwTypeCd = this.data.boProdPasswords[0].prodPwTypeCd;
					var pwd = this.data.boProdPasswords[0].pwd;//产品密码
					//主卡才有是否信控
					var isCheckMask = "20";//默认信控
					if(this.data.boProdItems&&this.data.boProdItems[0].itemSpecId){
						var itemSpecId = this.data.boProdItems[0].itemSpecId;
						if(itemSpecId=="40010030"){//是否信控
							isCheckMask = this.data.boProdItems[0].value;
						}
						//是否信控放在OrderInfo.newOrderInfo.isCheckMask中				
						var checkMark = {};
						checkMark.itemSpecId = itemSpecId;
						checkMark.prodId = prodId;
						checkMark.isCheckMask = isCheckMask;
						OrderInfo.reloadProdInfo.checkMaskList.push(checkMark);
						
						$("#"+itemSpecId+"_"+prodId+"").find("option[value='"+isCheckMask+"']").attr("selected","selected");
					}
					
					$("#choosedNum_"+prodId).val(accessNumber);
					var boProdAns={
							prodId : this.data.boProdAns[0].prodId, //从填单页面头部div获取
							accessNumber : this.data.boProdAns[0].accessNumber, //接入号
							anChooseTypeCd : this.data.boProdAns[0].anChooseTypeCd, //接入号选择方式,自动生成或手工配号，默认传2
							anId : this.data.boProdAns[0].anId, //接入号ID
							pnLevelId:this.data.boProdAns[0].pnLevelId,
							anTypeCd : this.data.boProdAns[0].anTypeCd, //号码类型
							state : this.data.boProdAns[0].state, //动作	,新装默认ADD	
							areaId:this.data.boProdAns[0].areaId,
							areaCode:this.data.boProdAns[0].areaCode,
							memberRoleCd:this.data.boProdAns[0].memberRoleCd,
							preStore:this.data.boProdAns[0].preStore,
							minCharge:this.data.boProdAns[0].minCharge
						};
					OrderInfo.boProdAns.push(boProdAns);
					//付费方式
					OrderInfo.reloadProdInfo.feeType = feeType ;
					$("#idtype").find("option[value='"+feeType+"']").attr("selected","selected");
					//order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);//选号玩要刷新发展人管理里面的号码
					//uim卡校验
					$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);;
					$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);
					$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);
					$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);
					var coupon = {
							couponUsageTypeCd : this.data.bo2Coupons[0].couponUsageTypeCd, //物品使用类型
							inOutTypeId : this.data.bo2Coupons[0].inOutTypeId,  //出入库类型
							inOutReasonId : this.data.bo2Coupons[0].inOutReasonId, //出入库原因
							saleId : this.data.bo2Coupons[0].saleId, //销售类型
							couponId : this.data.bo2Coupons[0].couponId, //物品ID
							couponinfoStatusCd : this.data.bo2Coupons[0].couponinfoStatusCd, //物品处理状态
							chargeItemCd : this.data.bo2Coupons[0].chargeItemCd, //物品费用项类型
							couponNum : this.data.bo2Coupons[0].couponNum, //物品数量
							storeId : this.data.bo2Coupons[0].storeId, //仓库ID
							storeName : this.data.bo2Coupons[0].storeName, //仓库名称
							agentId : this.data.bo2Coupons[0].agentId, //供应商ID
							apCharge : this.data.bo2Coupons[0].apCharge, //物品价格
							couponInstanceNumber : this.data.bo2Coupons[0].couponInstanceNumber, //物品实例编码
							terminalCode : this.data.bo2Coupons[0].terminalCode,//前台内部使用的UIM卡号
							ruleId : this.data.bo2Coupons[0].ruleId, //物品规则ID
							partyId : this.data.bo2Coupons[0].partyId, //客户ID
							prodId :  this.data.bo2Coupons[0].prodId, //产品ID
							offerId : this.data.bo2Coupons[0].offerId, //销售品实例ID
							state : this.data.bo2Coupons[0].state, //动作
							relaSeq : this.data.bo2Coupons[0].relaSeq //关联序列	
						};
					OrderInfo.clearProdUim(this.busiObj.instId);
					OrderInfo.boProd2Tds.push(coupon);
					//产品密码
					//$("#pwd_"+this.busiObj.instId).val(this.data.boProdPasswords[0].pwd);				
					//$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected");
				}								
				//发展人
				//过滤掉 1300 ,1 的产品发展人属性
				if(this.boActionType.actionClassCd!=1300&&this.boActionType.boActionTypeCd!="1"){
					//发展人
					if(this.data.busiOrderAttrs!=undefined){
						var dealerlist = [];
						var dealerMap1 = {};
						var dealerMap2 = {};
						var dealerMap3 = {};
						var offerSpecId = this.busiObj.objId;
						var accessNumber = this.busiObj.accessNumber;
						var busiOrder = this;
						$.each(this.data.busiOrderAttrs,function(){
							if(this.role=="40020005"){
								dealerMap1.role = this.role;
								dealerMap1.offerSpecId = offerSpecId;
								dealerMap1.accessNumber = accessNumber;
								if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
									dealerMap1.staffid = this.value;
								}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
									dealerMap1.staffname = this.value;
								}
								if(busiOrder.busiObj.objName!=undefined){
									dealerMap1.objName = busiOrder.busiObj.objName;
								}
								if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"){
									if(busiOrder.data.ooRoles&&busiOrder.data.ooRoles[0].prodId){
										dealerMap1.prodId=busiOrder.data.ooRoles[0].prodId;
									}
								}
							}else if(this.role=="40020006"){
								dealerMap2.role = this.role;
								dealerMap2.offerSpecId = offerSpecId;
								dealerMap2.accessNumber = accessNumber;
								if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
									dealerMap2.staffid = this.value;
								}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
									dealerMap2.staffname = this.value;
								}
								if(busiOrder.busiObj.objName!=undefined){
									dealerMap2.objName = busiOrder.busiObj.objName;
								}
								if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"){
									if(busiOrder.data.ooRoles&&busiOrder.data.ooRoles[0].prodId){
										dealerMap2.prodId=busiOrder.data.ooRoles[0].prodId;
									}
								}
							}else if(this.role=="40020007"){
								dealerMap3.role = this.role;
								dealerMap3.offerSpecId = offerSpecId;
								dealerMap3.accessNumber = accessNumber;
								if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
									dealerMap3.staffid = this.value;
								}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
									dealerMap3.staffname = this.value;
								}
								if(busiOrder.busiObj.objName!=undefined){
									dealerMap3.objName = busiOrder.busiObj.objName;
								}
								if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"){
									if(busiOrder.data.ooRoles&&busiOrder.data.ooRoles[0].prodId){
										dealerMap2.prodId=busiOrder.data.ooRoles[0].prodId;
									}
								}
							}
							
						});
						if(ec.util.isObj(dealerMap1.role)){
							dealerlist.push(dealerMap1);
						}
						if(ec.util.isObj(dealerMap2.role)){
							dealerlist.push(dealerMap2);
						}
						if(ec.util.isObj(dealerMap3.role)){
							dealerlist.push(dealerMap3);
						}
						var objInstId = "";
						if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"&&this.busiObj.instId=="-1"){
							for(var d=0;d<dealerlist.length;d++){
							  	var objInstId = dealerlist[d].offerSpecId;
								var $li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
								var $dl= $("<dl></dl>");
								var $tdType = $('<dd> </dd>');
								var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
								if(d==0){
									OrderInfo.SEQ.dealerSeq=OrderInfo.SEQ.dealerSeq-1;
								}
								var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
								var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
	
								$.each(OrderInfo.order.dealerTypeList,function(){
									if(dealerlist[d].role==this.PARTYPRODUCTRELAROLECD){
										$select.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
									}else{
										$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
									}
								});
								
								$field.append($select);
								$tdType.append($field);
								var accNbr = "主套餐";
								$dl.append("<dd>"+accNbr+"</dd>");
								$dl.append("<dd>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</dd>");
								$dl.append($tdType);
								
								var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');
								$dl.append($dd);
								
								var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
								$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';
								if(d==0){
									$button+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)" class="ui-btn ui-shadow ui-corner-all ui-mini">添加</button></div></div></dd>';
								}else{
									$button+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.removeDealer(this);" class="ui-btn ui-shadow ui-corner-all ui-mini">删除</button></div></div></dd>';
								}
								$dl.append($button);
								//发展渠道
								var $tdChannel = $('<dd></dd>');
								var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
								if(OrderInfo.provinceInfo.reloadFlag=="N"){
									//获取编码
									var busiOrders = OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;
									var channelNbr="";
									for(var i=0;i<busiOrders.length;i++){
										if(busiOrders[i].boActionType.actionClassCd=="1200" && busiOrders[i].boActionType.boActionTypeCd=="S1" && busiOrders[i].busiObj.offerTypeCd=="1"){
											var busiOrderAttrs=busiOrders[i].data.busiOrderAttrs;
											for(var j=0;j<busiOrderAttrs.length;j++){
												if(busiOrderAttrs[j].channelNbr!=undefined){
													channelNbr=busiOrderAttrs[j].channelNbr;
													break;
												}
											}
										}
									}
									for(var i=0;i<OrderInfo.channelList.length;i++){
										if(OrderInfo.channelList[i].channelNbr==channelNbr){
											$channelSelect.append("<option value='"+OrderInfo.channelList[i].channelNbr+"' selected ='selected'>"+OrderInfo.channelList[i].channelName+"</option>");
										}
										else{
											$channelSelect.append("<option value='"+OrderInfo.channelList[i].channelNbr+"'>"+OrderInfo.channelList[i].channelName+"</option>");
										}
									}
									
								
								}
								$tdChannel.append($channelSelect);
								$tdChannel.append('<label class="f_red">*</label>');
								$dl.append($tdChannel);
								$li.append($dl);
								OrderInfo.SEQ.dealerSeq++;
								$("#dealerTbody").append($li);
								$.jqmRefresh($("#dealerTbody"));
							}	
						}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"&&this.busiObj.instId!="-1"){
							for(var d=0;d<dealerlist.length;d++){
							  	var objInstId = dealerlist[d].prodId+"_"+dealerlist[d].offerSpecId;
								var $li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
								var $dl= $("<dl></dl>");
								var $tdType = $('<dd> </dd>');
								var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
								var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
								var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
	
								$.each(OrderInfo.order.dealerTypeList,function(){
									if(dealerlist[d].role==this.PARTYPRODUCTRELAROLECD){
										$select.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
									}else{
										$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
									}
								});
								
								$field.append($select);
								$tdType.append($field);
								var accNbr = dealerlist[d].accessNumber;
								$dl.append("<dd>"+accNbr+"</dd>");
								$dl.append("<dd>"+dealerlist[d].objName+"</dd>");
								$dl.append($tdType);
								
								var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');
								$dl.append($dd);
								var $button="";
								if(d==0){
									$button='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';
									$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';
									$button+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+objInstId+'\')" class=" ui-btn ui-shadow ui-corner-all ui-mini">添加</button></div>';
								}else{
									$button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
									$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';
								}
								$button+='<div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);" class=" ui-btn ui-shadow ui-corner-all ui-mini">删除</button></div></div></dd>';
								$dl.append($button);
								$li.append($dl);
								OrderInfo.SEQ.dealerSeq++;
								$("#dealerTbody").append($li);
								$("#dealerType_"+objId).selectmenu().selectmenu('refresh');
								$("#dealer_"+objId).textinput();
							}	
						}
					}
				}
				//帐户信息
				if(this.data.boAccountRelas!=undefined){
					var acctId = this.data.boAccountRelas[0].acctId;
					$("#acctSelect").find("option[value="+acctId+"]").attr("selected","selected");
					$("#order_remark").text(OrderInfo.reloadProdInfo.orderMark);
				}			
			});
			order.main.newProdReload();
			var custOrderAttrs = OrderInfo.reloadOrderInfo.orderList.orderListInfo.custOrderAttrs;
			$.each(custOrderAttrs,function(){
				//订单备注
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){
					OrderInfo.reloadProdInfo.orderMark = this.value;
				}
			});
			//处理缓存里面存在而二次加载回参没有的产品
			//退订可选包
			$.each(AttachOffer.openList,function(){
				var openmap = this;
				$.each(this.specList,function(){
					var offermap = this;
					var offerflag = false;
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="2"){
							if(this.busiObj.objId==offermap.offerSpecId){
								offerflag = true;
								return false;
							}
						}
					});
					if(!offerflag){
						AttachOffer.delOfferSpecReload(openmap.prodId,this.offerSpecId);
					}
				});
			});
			
			//退订功能产品
			$.each(AttachOffer.openServList,function(){
				var openmap = this;
				$.each(this.servSpecList,function(){
					var offermap = this;
					var offerflag = false;
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="7"){
							if(offermap.servSpecId==this.data.boServOrders[0].servSpecId && openmap.prodId==this.busiObj.instId){
								offerflag = true;
								return false;
							}
						}
					});
					if(!offerflag){
						AttachOffer.closeServSpecReload(openmap.prodId,this.servSpecId,this.servSpecName,this.ifParams);
					}
				});
			});
		}

	};
	
	
	
	//展示回调函数
	var _callBackBuildView = function(response, param) {
		order.prepare.showOrderTitle(OrderInfo.actionTypeName, param.offerSpecName, false);
		SoOrder.initFillPage(); //并且初始化订单数据
		var content$ = $("#order_fill").html(response.data).fadeIn();
		$.jqmRefresh(content$);
		_initOfferLabel();//初始化主副卡标签
		_initFeeType(param);//初始化付费方式
		if(param.actionFlag==''){
			OrderInfo.actionFlag = 1;
		}
		mktRes.phoneNbr.initOffer('-1');//主卡自动填充号码入口已选过的号码
		_loadOther(param);//页面加载完再加载其他元素
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==13 || OrderInfo.actionFlag==14){
			//_initAcct();//初始化帐户列表 
			$("#acctName").val(OrderInfo.cust.partyName);
			order.dealer.initDealer();//初始化协销		
		}
		/*if(OrderInfo.actionFlag==1){
			$("#templateOrderDiv").show();
		}
		_addEvent();//添加页面事件*/
		$("#fillNextStep").off("click").on("click",function(){
			SoOrder.submitOrder();
		});
		if (param.memberChange) {
			$("#orderedprod").hide();
			$("#order_prepare").hide();
			$("#productDiv .pdcardcon:first").show();
			order.prepare.step(1);
			$("#fillLastStep").off("click").on("click",function(){
				order.prodModify.cancel();
			});
		}else{
			$("#fillLastStep").off("click").on("click",function(){
				_lastStep();
			});
		}
		//新装省份传主副卡信息
		if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""){
			//主卡选号需要的参数 
			var param = {"phoneNum":"",
						"prodId":""};
			//查询号码信息
			param.phoneNum = OrderInfo.newOrderNumInfo.mainPhoneNum;
			param.prodId = "-1";
			var result = mktRes.phoneNbr.queryPhoneNumber(param);
			if(result==undefined||result.datamap.undefined||result.datamap.baseInfo==undefined){
				$("#choosedNum_-1").val("");			
				$("#btn_choosedNum_-1").removeAttr("onclick");
			}else{
				if(result&&result.datamap.baseInfo!=undefined){					
					var phoneParam={
							prodId : param.prodId, //从填单页面头部div获取
							accessNumber : result.datamap.baseInfo.phoneNumber, //接入号
							anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
							anId : result.datamap.baseInfo.phoneNumId, //接入号ID
							pnLevelId:result.datamap.baseInfo.phoneLevelId,
							anTypeCd : result.datamap.baseInfo.pnTypeId, //号码类型
							state : "ADD", //动作	,新装默认ADD
							areaId:result.datamap.baseInfo.areaId,
							areaCode:result.datamap.baseInfo.zoneNumber,
							memberRoleCd:"",
							preStore:result.datamap.baseInfo.prePrice,
							minCharge:result.datamap.baseInfo.pnPrice,
							idFlag:"1"
						};
					if(param.prodId&&param.prodId=="-1"){
						phoneParam.memberRoleCd = CONST.MEMBER_ROLE_CD.MAIN_CARD;
					}
					$("#choosedNum_-1").val(OrderInfo.newOrderNumInfo.mainPhoneNum);
					$("#btn_choosedNum_-1").removeAttr("onclick");
					OrderInfo.boProdAns.push(phoneParam);
				}
			}
		}
		if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""){
			var param = {"phoneNum":"","prodId":""};			
			var numBtns = $("input[id^='choosedNum_']");		
			var nums = OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");
			var subNums = [];
			$.each(numBtns,function(){
				if($(this).attr("id")!="choosedNum_-1"){
					subNums.push(this);
				};
			});
			$.each(subNums,function(index,subNum){
				//副卡选号需要的参数  
				param.phoneNum = nums[index];
				param.prodId = -2-index;
				var resData = mktRes.phoneNbr.queryPhoneNumber(param);
				if(resData==undefined||resData.datamap.undefined||resData.datamap.baseInfo==undefined){
					$(subNum).val("");
					$("#btn_choosedNum_"+param.prodId).removeAttr("onclick");
				}else{
					if(resData&&resData.datamap.baseInfo!=undefined){
						var phoneParam={
								prodId : param.prodId, //从填单页面头部div获取
								accessNumber : resData.datamap.baseInfo.phoneNumber, //接入号
								anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
								anId : resData.datamap.baseInfo.phoneNumId, //接入号ID
								pnLevelId:resData.datamap.baseInfo.phoneLevelId,
								anTypeCd : resData.datamap.baseInfo.pnTypeId, //号码类型
								state : "ADD", //动作	,新装默认ADD
								areaId:resData.datamap.baseInfo.areaId,
								areaCode:resData.datamap.baseInfo.zoneNumber,
								memberRoleCd:"",
								preStore:resData.datamap.baseInfo.prePrice,
								minCharge:resData.datamap.baseInfo.pnPrice,
								idFlag:"1"
							};
						if(param.prodId&&param.prodId!="-1"){
							phoneParam.memberRoleCd = CONST.MEMBER_ROLE_CD.VICE_CARD;
						}		
						$(subNum).val(nums[index]);
						$("#btn_choosedNum_"+param.prodId).removeAttr("onclick");
						OrderInfo.boProdAns.push(phoneParam);
					}
				}

			});
		}
		//新装显示uim信息框
		if(OrderInfo.actionFlag&&OrderInfo.actionFlag=="1"){
			var $uimDivs = $("div[id^='uimDiv_']");
			$.each($uimDivs,function(index,$uimDiv){
				$($uimDiv).show();
			});
		}
		
		//初始化UIM卡
		_initUimCode();
		
		//新装是否传帐户合同号
		if(OrderInfo.acct&&OrderInfo.acct.acctCd!=null&&OrderInfo.acct.acctCd!=""){//新装传帐户id
			_createAcctWithId();
		}
		
		
		//新装二次加载处理
		if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){
			$("#dealerTbody").empty();
			var custOrderList = OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;		
			$.each(custOrderList,function(){
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员
					var prodId = this.busiObj.instId;
					var accessNumber = this.busiObj.accessNumber;//接入号
					var terminalCode = this.data.bo2Coupons[0].terminalCode;//uim卡号
					var feeType = this.data.boProdFeeTypes[0].feeType;//付费类型
					var prodPwTypeCd = this.data.boProdPasswords[0].prodPwTypeCd;
					var pwd = this.data.boProdPasswords[0].pwd;//产品密码
					//主卡才有是否信控
					var isCheckMask = "20";//默认信控
					if(this.data.boProdItems&&this.data.boProdItems[0].itemSpecId){
						var itemSpecId = this.data.boProdItems[0].itemSpecId;
						if(itemSpecId=="40010030"){//是否信控
							isCheckMask = this.data.boProdItems[0].value;
						}
						//是否信控放在OrderInfo.newOrderInfo.isCheckMask中				
						var checkMark = {};
						checkMark.itemSpecId = itemSpecId;
						checkMark.prodId = prodId;
						checkMark.isCheckMask = isCheckMask;
						OrderInfo.reloadProdInfo.checkMaskList.push(checkMark);
						
						$("#"+itemSpecId+"_"+prodId+"").find("option[value='"+isCheckMask+"']").attr("selected","selected");
					}
					
					$("#choosedNum_"+prodId).val(accessNumber);
					var boProdAns={
							prodId : this.data.boProdAns[0].prodId, //从填单页面头部div获取
							accessNumber : this.data.boProdAns[0].accessNumber, //接入号
							anChooseTypeCd : this.data.boProdAns[0].anChooseTypeCd, //接入号选择方式,自动生成或手工配号，默认传2
							anId : this.data.boProdAns[0].anId, //接入号ID
							pnLevelId:this.data.boProdAns[0].pnLevelId,
							anTypeCd : this.data.boProdAns[0].anTypeCd, //号码类型
							state : this.data.boProdAns[0].state, //动作	,新装默认ADD	
							areaId:this.data.boProdAns[0].areaId,
							areaCode:this.data.boProdAns[0].areaCode,
							memberRoleCd:this.data.boProdAns[0].memberRoleCd,
							preStore:this.data.boProdAns[0].preStore,
							minCharge:this.data.boProdAns[0].minCharge
						};
					OrderInfo.boProdAns.push(boProdAns);
					//付费方式
					OrderInfo.reloadProdInfo.feeType = feeType ;
					$("#idtype").find("option[value='"+feeType+"']").attr("selected","selected");
					//order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);//选号玩要刷新发展人管理里面的号码
					//uim卡校验
					$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);;
					$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);
					$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);
					$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);
					var coupon = {
							couponUsageTypeCd : this.data.bo2Coupons[0].couponUsageTypeCd, //物品使用类型
							inOutTypeId : this.data.bo2Coupons[0].inOutTypeId,  //出入库类型
							inOutReasonId : this.data.bo2Coupons[0].inOutReasonId, //出入库原因
							saleId : this.data.bo2Coupons[0].saleId, //销售类型
							couponId : this.data.bo2Coupons[0].couponId, //物品ID
							couponinfoStatusCd : this.data.bo2Coupons[0].couponinfoStatusCd, //物品处理状态
							chargeItemCd : this.data.bo2Coupons[0].chargeItemCd, //物品费用项类型
							couponNum : this.data.bo2Coupons[0].couponNum, //物品数量
							storeId : this.data.bo2Coupons[0].storeId, //仓库ID
							storeName : this.data.bo2Coupons[0].storeName, //仓库名称
							agentId : this.data.bo2Coupons[0].agentId, //供应商ID
							apCharge : this.data.bo2Coupons[0].apCharge, //物品价格
							couponInstanceNumber : this.data.bo2Coupons[0].couponInstanceNumber, //物品实例编码
							terminalCode : this.data.bo2Coupons[0].terminalCode,//前台内部使用的UIM卡号
							ruleId : this.data.bo2Coupons[0].ruleId, //物品规则ID
							partyId : this.data.bo2Coupons[0].partyId, //客户ID
							prodId :  this.data.bo2Coupons[0].prodId, //产品ID
							offerId : this.data.bo2Coupons[0].offerId, //销售品实例ID
							state : this.data.bo2Coupons[0].state, //动作
							relaSeq : this.data.bo2Coupons[0].relaSeq //关联序列	
						};
					OrderInfo.clearProdUim(this.busiObj.instId);
					OrderInfo.boProd2Tds.push(coupon);
					//产品密码
					//$("#pwd_"+this.busiObj.instId).val(this.data.boProdPasswords[0].pwd);				
					//$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected");
				}								
				//发展人
				//过滤掉 1300 ,1 的产品发展人属性
				if(this.boActionType.actionClassCd!=1300&&this.boActionType.boActionTypeCd!="1"){
					//发展人
					if(this.data.busiOrderAttrs!=undefined){
						var dealerlist = [];
						var dealerMap1 = {};
						var dealerMap2 = {};
						var dealerMap3 = {};
						var offerSpecId = this.busiObj.objId;
						var accessNumber = this.busiObj.accessNumber;
						var busiOrder = this;
						$.each(this.data.busiOrderAttrs,function(){
							if(this.role=="40020005"){
								dealerMap1.role = this.role;
								dealerMap1.offerSpecId = offerSpecId;
								dealerMap1.accessNumber = accessNumber;
								if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
									dealerMap1.staffid = this.value;
								}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
									dealerMap1.staffname = this.value;
								}
								if(busiOrder.busiObj.objName!=undefined){
									dealerMap1.objName = busiOrder.busiObj.objName;
								}
								if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"){
									if(busiOrder.data.ooRoles&&busiOrder.data.ooRoles[0].prodId){
										dealerMap1.prodId=busiOrder.data.ooRoles[0].prodId;
									}
								}
							}else if(this.role=="40020006"){
								dealerMap2.role = this.role;
								dealerMap2.offerSpecId = offerSpecId;
								dealerMap2.accessNumber = accessNumber;
								if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
									dealerMap2.staffid = this.value;
								}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
									dealerMap2.staffname = this.value;
								}
								if(busiOrder.busiObj.objName!=undefined){
									dealerMap2.objName = busiOrder.busiObj.objName;
								}
								if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"){
									if(busiOrder.data.ooRoles&&busiOrder.data.ooRoles[0].prodId){
										dealerMap2.prodId=busiOrder.data.ooRoles[0].prodId;
									}
								}
							}else if(this.role=="40020007"){
								dealerMap3.role = this.role;
								dealerMap3.offerSpecId = offerSpecId;
								dealerMap3.accessNumber = accessNumber;
								if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
									dealerMap3.staffid = this.value;
								}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
									dealerMap3.staffname = this.value;
								}
								if(busiOrder.busiObj.objName!=undefined){
									dealerMap3.objName = busiOrder.busiObj.objName;
								}
								if(busiOrder.boActionType.actionClassCd==1200&&busiOrder.boActionType.boActionTypeCd=="S1"){
									if(busiOrder.data.ooRoles&&busiOrder.data.ooRoles[0].prodId){
										dealerMap2.prodId=busiOrder.data.ooRoles[0].prodId;
									}
								}
							}
							
						});
						if(ec.util.isObj(dealerMap1.role)){
							dealerlist.push(dealerMap1);
						}
						if(ec.util.isObj(dealerMap2.role)){
							dealerlist.push(dealerMap2);
						}
						if(ec.util.isObj(dealerMap3.role)){
							dealerlist.push(dealerMap3);
						}
						var objInstId = "";
						if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"&&this.busiObj.instId=="-1"){
							for(var d=0;d<dealerlist.length;d++){
							  	var objInstId = dealerlist[d].offerSpecId;
								var $li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
								var $dl= $("<dl></dl>");
								var $tdType = $('<dd> </dd>');
								var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
								if(d==0){
									OrderInfo.SEQ.dealerSeq=OrderInfo.SEQ.dealerSeq-1;
								}
								var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
								var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
	
								$.each(OrderInfo.order.dealerTypeList,function(){
									if(dealerlist[d].role==this.PARTYPRODUCTRELAROLECD){
										$select.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
									}else{
										$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
									}
								});
								
								$field.append($select);
								$tdType.append($field);
								var accNbr = "主套餐";
								$dl.append("<dd>"+accNbr+"</dd>");
								$dl.append("<dd>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</dd>");
								$dl.append($tdType);
								
								var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');
								$dl.append($dd);
								
								var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
								$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';
								if(d==0){
									$button+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)" class="ui-btn ui-shadow ui-corner-all ui-mini">添加</button></div></div></dd>';
								}else{
									$button+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.removeDealer(this);" class="ui-btn ui-shadow ui-corner-all ui-mini">删除</button></div></div></dd>';
								}
								$dl.append($button);
								$li.append($dl);
								OrderInfo.SEQ.dealerSeq++;
								$("#dealerTbody").append($li);
								$("#dealerType_"+objId).selectmenu().selectmenu('refresh');
								$("#dealer_"+objId).textinput();
							}	
						}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"&&this.busiObj.instId!="-1"){
							for(var d=0;d<dealerlist.length;d++){
							  	var objInstId = dealerlist[d].prodId+"_"+dealerlist[d].offerSpecId;
								var $li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
								var $dl= $("<dl></dl>");
								var $tdType = $('<dd> </dd>');
								var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
								var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
								var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
	
								$.each(OrderInfo.order.dealerTypeList,function(){
									if(dealerlist[d].role==this.PARTYPRODUCTRELAROLECD){
										$select.append("<option selected='selected' value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
									}else{
										$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
									}
								});
								
								$field.append($select);
								$tdType.append($field);
								var accNbr = dealerlist[d].accessNumber;
								$dl.append("<dd>"+accNbr+"</dd>");
								$dl.append("<dd>"+dealerlist[d].objName+"</dd>");
								$dl.append($tdType);
								
								var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');
								$dl.append($dd);
								var $button="";
								if(d==0){
									$button='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';
									$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';
									$button+='<div class="ui-block-b"><button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+objInstId+'\')" class=" ui-btn ui-shadow ui-corner-all ui-mini">添加</button></div>';
								}else{
									$button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
									$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');" class="ui-btn ui-shadow ui-corner-all ui-mini" >选择</button></div>';
								}
								$button+='<div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);" class=" ui-btn ui-shadow ui-corner-all ui-mini">删除</button></div></div></dd>';
								$dl.append($button);
								$li.append($dl);
								OrderInfo.SEQ.dealerSeq++;
								$("#dealerTbody").append($li);
								$("#dealerType_"+objId).selectmenu().selectmenu('refresh');
								$("#dealer_"+objId).textinput();
							}	
						}
					}
				}
				//帐户信息
				if(this.data.boAccountRelas!=undefined){
					var acctId = this.data.boAccountRelas[0].acctId;
					$("#acctSelect").find("option[value="+acctId+"]").attr("selected","selected");
					$("#order_remark").text(OrderInfo.reloadProdInfo.orderMark);
				}			
			});
			order.main.newProdReload();
			var custOrderAttrs = OrderInfo.reloadOrderInfo.orderList.orderListInfo.custOrderAttrs;
			$.each(custOrderAttrs,function(){
				//订单备注
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){
					OrderInfo.reloadProdInfo.orderMark = this.value;
				}
			});
			//处理缓存里面存在而二次加载回参没有的产品
			//退订可选包
			$.each(AttachOffer.openList,function(){
				var openmap = this;
				$.each(this.specList,function(){
					var offermap = this;
					var offerflag = false;
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="2"){
							if(this.busiObj.objId==offermap.offerSpecId){
								offerflag = true;
								return false;
							}
						}
					});
					if(!offerflag){
						AttachOffer.delOfferSpecReload(openmap.prodId,this.offerSpecId);
					}
				});
			});
			
			//退订功能产品
			$.each(AttachOffer.openServList,function(){
				var openmap = this;
				$.each(this.servSpecList,function(){
					var offermap = this;
					var offerflag = false;
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="7"){
							if(offermap.servSpecId==this.data.boServOrders[0].servSpecId && openmap.prodId==this.busiObj.instId){
								offerflag = true;
								return false;
							}
						}
					});
					if(!offerflag){
						AttachOffer.closeServSpecReload(openmap.prodId,this.servSpecId,this.servSpecName,this.ifParams);
					}
				});
			});
		}
	};
	
	var _initUimCode = function() {
		//错误提示信息，如果有号码，但是UIM为空时提示
		var codeMsg=OrderInfo.provinceInfo.codeMsg;
		
		if(OrderInfo.provinceInfo.reloadFlag && OrderInfo.provinceInfo.reloadFlag=="Y"){
			if(OrderInfo.provinceInfo.codeMsg && codeMsg!=null && codeMsg!=""){
				$.alert("提示",codeMsg);
			}else{
				var mktResInstCodeSub=OrderInfo.newOrderNumInfo.mktResInstCode;
				
				if(OrderInfo.newOrderNumInfo.mktResInstCode && mktResInstCodeSub!=null && mktResInstCodeSub!="" && mktResInstCodeSub!="null"){
					var mktResInstCode = mktResInstCodeSub.split(",");
					
					if(mktResInstCode!=null && mktResInstCode.length>0){
						for (var i = 0; i <= mktResInstCode.length; i ++) {
							//numAndUim-->号码_UIM
							var numAndUim=mktResInstCode[i];
							
							if(numAndUim!=null && numAndUim!=""){
								var codes=numAndUim.split("_");
								if(codes!=null && codes.length==2){
									var num=codes[0];
									var uim=codes[1];
									
									var uimParam = {"instCode":uim};
									var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
									
									if (response.code==0) {
										if(response.data&&response.data.mktResBaseInfo){
											if(response.data.mktResBaseInfo.statusCd=="1102"){
												$("#uim_check_btn_"+num).attr("disabled",true);
												$("#uim_check_btn_"+num).removeClass("purchase").addClass("disablepurchase");
												$("#uim_release_btn_"+num).attr("disabled",false);
												$("#uim_release_btn_"+num).removeClass("disablepurchase").addClass("purchase");
												$("#uim_txt_"+ num).val(uim);
												
												var coupon = {
													couponUsageTypeCd : "3", //物品使用类型
													inOutTypeId : "1",  //出入库类型
													inOutReasonId : 0, //出入库原因
													saleId : 1, //销售类型
													couponId : response.data.mktResBaseInfo.mktResId, //物品ID
													couponinfoStatusCd : "A", //物品处理状态
													chargeItemCd : "3000", //物品费用项类型
													couponNum : response.data.mktResBaseInfo.qty, //物品数量
													storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
													storeName : "1", //仓库名称
													agentId : 1, //供应商ID
													apCharge : 0, //物品价格
													couponInstanceNumber : response.data.mktResBaseInfo.instCode, //物品实例编码
													terminalCode : response.data.mktResBaseInfo.instCode,//前台内部使用的UIM卡号
													ruleId : "", //物品规则ID
													partyId : OrderInfo.cust.custId, //客户ID
													prodId :  num, //产品ID
													offerId : "-1", //销售品实例ID
													state : "ADD", //动作
													relaSeq : "" //关联序列	
												};
												
												OrderInfo.clearProdUim(num);
												OrderInfo.boProd2Tds.push(coupon);
											}else{
												$.alert("提示","UIM卡["+uim+"]不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
											}
										}else{
											$.alert("提示","没有查询到相应的UIM卡["+uim+"]信息");
										}
									}else if (response.code==-2){
										$.alert(response.data);
									}else {
										$.alert("提示","UIM信息查询接口出错,稍后重试");
									}
								}
							}
						}
					}
				}
			}
		}
	};
	
	//主副卡成员变更展示回调函数
	var _callBackMemberView = function(response, param) {
		order.prepare.showOrderTitle(OrderInfo.actionTypeName, param.offerSpecName, false);
		SoOrder.initFillPage(); //并且初始化订单数据
		$("#deal_package").css("display","none");
		$("#order_prod_list").css("display","none");
		$("#order_tab_panel_content").html(response.data);
		$.jqmRefresh($("#order_tab_panel_content"));	
		_initFeeType(param);//初始化付费方式
		_initOrderProvAttr();//初始化省内订单属性
		if(CONST.getAppDesc()==0 && OrderInfo.actionFlag==6){
			$("#orderAttrDiv").show();		
			_initOrderAttr();//初始化4G经办人	
		}
		if(param.actionFlag==''){
			OrderInfo.actionFlag = 1;
		}
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==13 || OrderInfo.actionFlag==14){
			_initAcct(0);//初始化主卡帐户列表 
//			if(ec.util.isArray(OrderInfo.oldprodInstInfos)){
//				for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
//					var prodInfo = OrderInfo.oldprodInstInfos[i];
//					order.dealer.initDealer(prodInfo);//初始化协销
//				}
//			}else{
				order.dealer.initDealer();//初始化协销
//			}
		}
		if(order.memberChange.oldMemberFlag){//主副卡纳入老用户
			_initAcct(1);//初始化副卡帐户列表	
			_loadAttachOffer(param);			
		}
		if(order.memberChange.newMemberFlag){
//			mktRes.phoneNbr.initOffer('-1');//主卡自动填充号码入口已选过的号码
			_loadOther(param);//页面加载完再加载其他元素
		}if(order.memberChange.changeMemberFlag){
			_loadViceMember(param);
//			order.memberChange.fillmemberChange(response,param);
		}
		
		/*if(OrderInfo.actionFlag==6){//主副卡纳入老用户
			if(order.memberChange.newMemberFlag){
				_initAcct(1);//初始化副卡帐户列表	
				_loadAttachOffer(param);	
			}
			if(order.memberChange.newMemberFlag){
				mktRes.phoneNbr.initOffer('-1');//主卡自动填充号码入口已选过的号码
				_loadOther(param);//页面加载完再加载其他元素
			}
			if(order.memberChange.changeMemberFlag){
				_loadViceMember(param);
			}
		}else{
			_loadOther(param);//页面加载完再加载其他元素
		}*/
		
		if(OrderInfo.actionFlag==1){
			$("#templateOrderDiv").show();
		}
		_addEvent();//添加页面事件
		
		
		$("#fillNextStep").off("click").on("click",function(){
			order.memberChange.removeAndAdd(param);
		});

		if (param.memberChange) {
			$("#orderedprod").hide();
			$("#order_prepare").hide();
			$("#productDiv .pdcardcon:first").show();
			order.prepare.step(1);
			$("#fillLastStep").off("click").on("click",function(){
				order.prodModify.cancel();
			});
		}else{
			$("#fillLastStep").off("click").on("click",function(){
				_lastStep();
			});
		} 
	
		//新装省份传主副卡信息
		if(OrderInfo.newOrderNumInfo.mainPhoneNum!=""){
			//主卡选号需要的参数 
			var param = {"phoneNum":"",
						"prodId":""};
			//查询号码信息
			param.phoneNum = OrderInfo.newOrderNumInfo.mainPhoneNum;
			param.prodId = "-1";
			var result = order.phoneNumber.queryPhoneNumber(param);
			if(result==undefined||result.datamap==undefined||result.datamap.baseInfo==undefined){
				$("#choosedNum_-1").html("");
				$("#choosedNum_-1").removeAttr("onclick");
			}else{
				if(result&&result.datamap.baseInfo!=undefined){					
					var phoneParam={
							prodId : param.prodId, //从填单页面头部div获取
							accessNumber : result.datamap.baseInfo.phoneNumber, //接入号
							anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
							anId : result.datamap.baseInfo.phoneNumId, //接入号ID
							pnLevelId:result.datamap.baseInfo.phoneLevelId,
							anTypeCd : result.datamap.baseInfo.pnTypeId, //号码类型
							state : "ADD", //动作	,新装默认ADD
							areaId:result.datamap.baseInfo.areaId,
							areaCode:result.datamap.baseInfo.zoneNumber,
							memberRoleCd:"",
							preStore:result.datamap.baseInfo.prePrice,
							minCharge:result.datamap.baseInfo.pnPrice,
							idFlag:"1"
						};
					if(param.prodId&&param.prodId=="-1"){
						phoneParam.memberRoleCd = CONST.MEMBER_ROLE_CD.MAIN_CARD;
					}
					$("#choosedNum_-1").html(OrderInfo.newOrderNumInfo.mainPhoneNum);
					$("#choosedNum_-1").removeAttr("onclick");
					OrderInfo.boProdAns.push(phoneParam);
				}
			}
		}
		if(OrderInfo.newOrderNumInfo.newSubPhoneNum!=""){
			var param = {"phoneNum":"",
						"prodId":""};
			var numBtns = $("div[id^='choosedNum_']");			
			var nums = OrderInfo.newOrderNumInfo.newSubPhoneNum.split(",");
			var subNums = [];
			$.each(numBtns,function(){
				if($(this).attr("id")!="choosedNum_-1"){
					subNums.push(this);
				};
			});
			$.each(subNums,function(index,subNum){
				//副卡选号需要的参数  
				param.phoneNum = nums[index];
				param.prodId = -2-index;
				var resData = order.phoneNumber.queryPhoneNumber(param);
				if(resData==undefined||resData.datamap==undefined||resData.datamap.baseInfo==undefined){
					$(subNum).html("");
					$(subNum).removeAttr("onclick");
				}else{
					if(resData&&resData.datamap.baseInfo!=undefined){
						var phoneParam={
								prodId : param.prodId, //从填单页面头部div获取
								accessNumber : resData.datamap.baseInfo.phoneNumber, //接入号
								anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
								anId : resData.datamap.baseInfo.phoneNumId, //接入号ID
								pnLevelId:resData.datamap.baseInfo.phoneLevelId,
								anTypeCd : resData.datamap.baseInfo.pnTypeId, //号码类型
								state : "ADD", //动作	,新装默认ADD
								areaId:resData.datamap.baseInfo.areaId,
								areaCode:resData.datamap.baseInfo.zoneNumber,
								memberRoleCd:"",
								preStore:resData.datamap.baseInfo.prePrice,
								minCharge:resData.datamap.baseInfo.pnPrice,
								idFlag:"1"
							};
						if(param.prodId&&param.prodId!="-1"){
							phoneParam.memberRoleCd = CONST.MEMBER_ROLE_CD.VICE_CARD;
						}		
						$(subNum).html(nums[index]);
						$(subNum).removeAttr("onclick");
						OrderInfo.boProdAns.push(phoneParam);
					}
				}

			});
		}
		
		//新装暂存单二次加载
		/*
		if(OrderInfo.newOrderInfo.isReloadFlag=="N"){
			var result=OrderInfo.newOrderInfo.result;
			var prodOfferId=OrderInfo.newOrderInfo.prodOfferId;
			var prodOfferName=OrderInfo.newOrderInfo.prodOfferName;
			order.service.callBackBuildOrder(result,prodOfferId,prodOfferName);
		}
		*/
		//主副卡纳入新用户选号
		if(order.memberChange.newSubPhoneNum!="" && order.memberChange.reloadFlag=="Y"){
			var newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
			for(var n=0;n<newSubPhoneNumsize.length;n++){
				if(newSubPhoneNumsize[n]!=""&&newSubPhoneNumsize[n]!=null&&newSubPhoneNumsize[n]!="null"){
					$("#choosedNum_-"+(n+1)).removeAttr("onclick");		
					var param = {"phoneNum":newSubPhoneNumsize[n]};
					var data = mktRes.phoneNbr.queryPhoneNumber(param);
					if(data.datamap.baseInfo){
						$("#choosedNum_-"+(n+1)).val(newSubPhoneNumsize[n]);
						var boProdAns={
								prodId : "-"+(n+1), //从填单页面头部div获取
								accessNumber : data.datamap.baseInfo.phoneNumber, //接入号
								anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
								anId : data.datamap.baseInfo.phoneNumId, //接入号ID
								pnLevelId : data.datamap.baseInfo.phoneLevelId,
								anTypeCd : data.datamap.baseInfo.pnTypeId, //号码类型
								state : "ADD", //动作	,新装默认ADD	
								areaId : data.datamap.baseInfo.areaId,
								areaCode:data.datamap.baseInfo.zoneNumber,
								memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,
								preStore:data.datamap.baseInfo.prePrice,
								minCharge:data.datamap.baseInfo.pnPrice
							};
						OrderInfo.boProdAns.push(boProdAns);
						order.dealer.changeAccNbr("-"+(n+1),newSubPhoneNumsize[n]);//选号玩要刷新发展人管理里面的号码
					}
				}
			}
		}
		//主副卡纳入新用户UIM卡
		if(order.memberChange.mktResInstCode!="" && order.memberChange.mktResInstCode!=undefined && order.memberChange.reloadFlag=="Y"){
			var offerId = "-1";
			if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//判断是否是纳入老用户
				if(ec.util.isArray(OrderInfo.viceprodInstInfos) && OrderInfo.oldMvFlag){
					$.each(OrderInfo.viceprodInstInfos,function(){
						if(this.prodInstId==prodId){
							offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
						}
					});
				}else{
					$.each(OrderInfo.oldprodInstInfos,function(){
						if(this.prodInstId==prodId){
							offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
						}
					});
				}
			}else{
				offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
			}		
			var mktResInstCodesize = order.memberChange.mktResInstCode.split(",");
			for(var u=0;u<mktResInstCodesize.length;u++){
				if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null"){
					var nbrAndUimCode = mktResInstCodesize[u].split("_");
					var _accNbr = nbrAndUimCode[0];
					var _uimCode = nbrAndUimCode[1];
					var newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
					for(var n=0;n<newSubPhoneNumsize.length;n++){
						if(newSubPhoneNumsize[n]==_accNbr){
							$("#uim_txt_-"+(n+1)).attr("disabled",true);
							var uimParam = {
									"instCode":_uimCode
							};
					var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
					if (response.code==0) {
						if(response.data.mktResBaseInfo){
							if(response.data.mktResBaseInfo.statusCd=="1102"){
//								$("#uim_check_btn_-"+(n+1)).attr("disabled",true);
//								$("#uim_check_btn_-"+(n+1)).removeClass("purchase").addClass("disablepurchase");
//								$("#uim_release_btn_-"+(n+1)).attr("disabled",false);
//								$("#uim_release_btn_-"+(n+1)).removeClass("disablepurchase").addClass("purchase");
//								$("#uim_txt_-"+(n+1)).val(_uimCode);								
								$("#uim_check_btn_-"+(n+1)).attr("disabled",true);
								$("#uim_check_btn_-"+(n+1)).removeClass("purchase").addClass("disablepurchase");
								$("#uim_release_btn_-"+(n+1)).attr("disabled",false);
								$("#uim_release_btn_-"+(n+1)).removeClass("disablepurchase").addClass("purchase");
								$("#uim_txt_-"+(n+1)).val(_uimCode);
								var coupon = {
										couponUsageTypeCd : "3", //物品使用类型
										inOutTypeId : "1",  //出入库类型
										inOutReasonId : 0, //出入库原因
										saleId : 1, //销售类型
										couponId : response.data.mktResBaseInfo.mktResId, //物品ID
										couponinfoStatusCd : "A", //物品处理状态
										chargeItemCd : "3000", //物品费用项类型
										couponNum : response.data.mktResBaseInfo.qty, //物品数量
										storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
										storeName : "1", //仓库名称
										agentId : 1, //供应商ID
										apCharge : 0, //物品价格
										couponInstanceNumber : _uimCode, //物品实例编码
										terminalCode :_uimCode,//前台内部使用的UIM卡号
										ruleId : "", //物品规则ID
										partyId : OrderInfo.cust.custId, //客户ID
										prodId :  -(n+1), //产品ID
										offerId : offerId, //销售品实例ID
										state : "ADD", //动作
										relaSeq : "" //关联序列	
									};
								OrderInfo.clearProdUim(-(n+1));
								OrderInfo.boProd2Tds.push(coupon);
							}else{
								$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
							}
						}else{
							$.alert("提示","查询不到UIM信息");
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","UIM信息查询接口出错,稍后重试");
					}
					}
					}
				}
			}
		}
		//主副卡暂存单二次加载
		if(order.memberChange.reloadFlag=="N"){
			$("#dealerTbody").empty();
			var custOrderList = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
			$.each(custOrderList,function(){
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="3"){//拆副卡
				
				}else if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员			
					//选号				
					$("#choosedNum_"+this.data.boProdAns[0].prodId).val(this.busiObj.accessNumber);
					$.jqmRefresh($("#order_tab_panel_content"));
					var boProdAns={
							prodId : this.data.boProdAns[0].prodId, //从填单页面头部div获取
							accessNumber : this.data.boProdAns[0].accessNumber, //接入号
							anChooseTypeCd : this.data.boProdAns[0].anChooseTypeCd, //接入号选择方式,自动生成或手工配号，默认传2
							anId : this.data.boProdAns[0].anId, //接入号ID
							pnLevelId:this.data.boProdAns[0].pnLevelId,
							anTypeCd : this.data.boProdAns[0].anTypeCd, //号码类型
							state : this.data.boProdAns[0].state, //动作	,新装默认ADD	
							areaId:this.data.boProdAns[0].areaId,
							areaCode:this.data.boProdAns[0].areaCode,
							memberRoleCd:this.data.boProdAns[0].memberRoleCd,
							preStore:this.data.boProdAns[0].preStore,
							minCharge:this.data.boProdAns[0].minCharge
						};
					OrderInfo.boProdAns.push(boProdAns);
					order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);//选号玩要刷新发展人管理里面的号码
					//uim卡校验
					$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);
					$("#uim_check_btn_"+this.data.bo2Coupons[0].prodId).removeClass("purchase").addClass("disablepurchase");
					$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).attr("disabled",false);
					$("#uim_release_btn_"+this.data.bo2Coupons[0].prodId).removeClass("disablepurchase").addClass("purchase");
					$("#uim_txt_"+this.data.bo2Coupons[0].prodId).attr("disabled",true);
					$("#uim_txt_"+this.data.bo2Coupons[0].prodId).val(this.data.bo2Coupons[0].terminalCode);
					var coupon = {
							couponUsageTypeCd : this.data.bo2Coupons[0].couponUsageTypeCd, //物品使用类型
							inOutTypeId : this.data.bo2Coupons[0].inOutTypeId,  //出入库类型
							inOutReasonId : this.data.bo2Coupons[0].inOutReasonId, //出入库原因
							saleId : this.data.bo2Coupons[0].saleId, //销售类型
							couponId : this.data.bo2Coupons[0].couponId, //物品ID
							couponinfoStatusCd : this.data.bo2Coupons[0].couponinfoStatusCd, //物品处理状态
							chargeItemCd : this.data.bo2Coupons[0].chargeItemCd, //物品费用项类型
							couponNum : this.data.bo2Coupons[0].couponNum, //物品数量
							storeId : this.data.bo2Coupons[0].storeId, //仓库ID
							storeName : this.data.bo2Coupons[0].storeName, //仓库名称
							agentId : this.data.bo2Coupons[0].agentId, //供应商ID
							apCharge : this.data.bo2Coupons[0].apCharge, //物品价格
							couponInstanceNumber : this.data.bo2Coupons[0].couponInstanceNumber, //物品实例编码
							terminalCode : this.data.bo2Coupons[0].terminalCode,//前台内部使用的UIM卡号
							ruleId : this.data.bo2Coupons[0].ruleId, //物品规则ID
							partyId : this.data.bo2Coupons[0].partyId, //客户ID
							prodId :  this.data.bo2Coupons[0].prodId, //产品ID
							offerId : this.data.bo2Coupons[0].offerId, //销售品实例ID
							state : this.data.bo2Coupons[0].state, //动作
							relaSeq : this.data.bo2Coupons[0].relaSeq //关联序列	
						};
					OrderInfo.clearProdUim(this.busiObj.instId);
					OrderInfo.boProd2Tds.push(coupon);
					//产品密码
					$("#pwd_"+this.busiObj.instId).val(this.data.boProdPasswords[0].pwd);
					//封装付费方式
					$("select[name='pay_type_-1'] option[value='"+this.data.boProdFeeTypes[0].feeType+"']").attr("selected","selected");
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S2"){//纳入老成员
					
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="1"){//保留选择新套擦
					
				}
				//发展人
				if(this.data.busiOrderAttrs!=undefined){
					var dealerlist = [];
					var dealerMap1 = {};
					var dealerMap2 = {};
					var dealerMap3 = {};
					$.each(this.data.busiOrderAttrs,function(){
						if(this.role=="40020005"){
							dealerMap1.role = this.role;
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
								dealerMap1.staffid = this.value;
							}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
								dealerMap1.staffname = this.value;
							}
						}else if(this.role=="40020006"){
							dealerMap2.role = this.role;
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
								dealerMap2.staffid = this.value;
							}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
								dealerMap2.staffname = this.value;
							}
						}else if(this.role=="40020007"){
							dealerMap3.role = this.role;
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER){
								dealerMap3.staffid = this.value;
							}else if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.DEALER_NAME){
								dealerMap3.staffname = this.value;
							}
						}
						
					});
					if(ec.util.isObj(dealerMap1.role)){
						dealerlist.push(dealerMap1);
					}
					if(ec.util.isObj(dealerMap2.role)){
						dealerlist.push(dealerMap2);
					}
					if(ec.util.isObj(dealerMap3.role)){
						dealerlist.push(dealerMap3);
					}
					var objInstId = "";
					var deldealerflag = "";
					if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){
						objInstId = this.busiObj.instId;
					}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd != "1"){
						objInstId = this.data.ooRoles[0].prodId+"_"+this.busiObj.objId;
						deldealerflag = "DEL";
					}
					var dealeraccNbr = this.busiObj.accessNumber;
					for(var d=0;d<dealerlist.length;d++){
						var $li;
						if(d==0){							
							$li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
						}else{							
							$li = $("<li name='tr_"+objInstId+"'></li>");
						}
						var $dl= $("<dl></dl>");
		    			var $tdType = $('<dd></dd>');
		    			var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
		    			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
		    			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		    			$.each(OrderInfo.order.dealerTypeList,function(){
							if(dealerlist[d].role==this.PARTYPRODUCTRELAROLECD){
								$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected>"+this.NAME+"</option>");
							}else{
								$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
							}
						});
		    			$field.append($select);
		    			$tdType.append($field);		    	
		    			$dl.append("<dd>"+dealeraccNbr+"</dd>");			
						if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){
							$dl.append("<dd>移动电话（仅含本地语音）</dd>");
						}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"){
							$dl.append("<dd>"+this.busiObj.objName+"</dd>");
						}
						$dl.append($tdType);
						var $dd;
						if(deldealerflag=="DEL"){							
							$dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" data-mini="true" readonly="readonly" ></input></dd>');
						}else{
							$dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+dealerlist[d].staffid+'" value="'+dealerlist[d].staffname+'" data-mini="true" readonly="readonly" ></input></dd>');
						}
						$dl.append($dd);


//						var $button='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';
//						$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
//						$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</button></div>';
				
						if(d==0){
							if(deldealerflag=="DEL"){
								var $button='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';
								$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
								$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</button></div>';
								$button+='<div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';							
							}else{
								var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
								$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
								$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</button></div></dd>';
							}
//							$button+='<button data-mini="ture" onclick="javascript:order.main.addProdDealer(\'this\',\''+objInstId+',1);">添加</button>';				
						}else if(d==1){
							var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
							$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
//							$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</button></div>';
							$button+='<div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';
			//				$button+='<div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';	
						}
						$dl.append($button);
						//$li.append($dl);
						//发展渠道
						var $tdChannel = $('<dd></dd>');
						var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
						if(order.memberChange.reloadFlag=="N"){
							//获取编码
							var busiOrders = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
							var channelNbr="";
							for(var i=0;i<busiOrders.length;i++){
								if(busiOrders[i].boActionType.actionClassCd=="1300" && busiOrders[i].boActionType.boActionTypeCd=="1"){
									var busiOrderAttrs=busiOrders[i].data.busiOrderAttrs;
									for(var j=0;j<busiOrderAttrs.length;j++){
										if(busiOrderAttrs[j].channelNbr!=undefined){
											channelNbr=busiOrderAttrs[j].channelNbr;
											break;
										}
									}
								}
							}
							for(var i=0;i<OrderInfo.channelList.length;i++){
								if(OrderInfo.channelList[i].channelNbr==channelNbr){
									$channelSelect.append("<option value='"+OrderInfo.channelList[i].channelNbr+"' selected ='selected'>"+OrderInfo.channelList[i].channelName+"</option>");
								}
								else{
									$channelSelect.append("<option value='"+OrderInfo.channelList[i].channelNbr+"'>"+OrderInfo.channelList[i].channelName+"</option>");
								}
							}
						}
						else{
							$.each(OrderInfo.channelList,function(){
								if(this.isSelect==1)
									$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
								else
									$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
							});
						}
						$tdChannel.append($channelSelect);
						$tdChannel.append('<label class="f_red">*</label>');
						$dl.append($tdChannel);
						$li.append($dl);
						OrderInfo.SEQ.dealerSeq++;
						$("#dealerTbody").append($li);
						$.jqmRefresh($("#dealerTbody"));
					}
				}
				//帐户信息
				if(this.data.boAccountRelas!=undefined){
					var acctId = this.data.boAccountRelas[0].acctId;
					$("#acctSelect").find("option[value="+acctId+"]").attr("selected","selected");
				}
			});
			var custOrderAttrs = order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;
			$.each(custOrderAttrs,function(){
				//订单备注
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.REMARK){
					$('#order_remark').val(this.value);
				}
				//经办人
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrName){
					$('#orderAttrName').val(this.value);
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrPhoneNbr){
					$('#orderAttrPhoneNbr').val(this.value);
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderIdentidiesTypeCd){
					$("#orderIdentidiesTypeCd").find("option[value="+this.value+"]").attr("selected","selected");
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrIdCard){
					$('#orderAttrIdCard').val(this.value);
				}
				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.orderAttrAddr){
					$('#orderAttrAddr').val(this.value);
				}
				//省内订单属性
//				if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.PROV_ISALE){
//					$('#orderProvAttrIsale').val(this.value);
//				}
			});
			order.main.reload();
		}
	};
	
	//新装套餐二次加载,可选包、功能包处理
	var _newProdReload = function(){
		//处理可选包和功能产品增删
		var custOrderList = OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;
		$.each(custOrderList,function(){
			if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1"){
				var offermap = this;
				$.each(AttachOffer.openList,function(){
					if(this.prodId==offermap.data.ooRoles[0].prodId){
						var offerflag = false;
						$.each(this.specList,function(){
							if(this.offerSpecId==offermap.busiObj.objId){
								offerflag = true;
								return false;
							}
						});
						if(!offerflag){
							AttachOffer.addOfferSpec(this.prodId,offermap.busiObj.objId);
							//是否有终端信息
							if(offermap.data.bo2Coupons!=undefined){
								for(var i=0;i<offermap.data.bo2Coupons.length;i++){
									var bo2Coupons = offermap.data.bo2Coupons[i];
									if(i==0){
										$("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num).val(bo2Coupons.couponInstanceNumber);
										AttachOffer.checkTerminalCode($("#terminalBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num));
									}else{
										AttachOffer.addAndDelTerminal($("#terminalAddBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId));
										$("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num).val(bo2Coupons.couponInstanceNumber);
										AttachOffer.checkTerminalCode($("#terminalBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num));
									}
									var coupon = {
											couponUsageTypeCd : bo2Coupons.couponUsageTypeCd, //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
											inOutTypeId : bo2Coupons.inOutTypeId,  //出入库类型
											inOutReasonId : bo2Coupons.inOutReasonId, //出入库原因
											saleId : bo2Coupons.saleId, //销售类型
											couponId : bo2Coupons.couponId, //物品ID
											couponinfoStatusCd : bo2Coupons.couponinfoStatusCd, //物品处理状态
											chargeItemCd : bo2Coupons.chargeItemCd, //物品费用项类型
											couponNum : bo2Coupons.couponNum, //物品数量
											storeId : bo2Coupons.storeId, //仓库ID
											storeName : bo2Coupons.storeName, //仓库名称
											agentId : bo2Coupons.agentId, //供应商ID
											apCharge : bo2Coupons.apCharge, //物品价格,约定取值为营销资源的
											couponInstanceNumber : bo2Coupons.couponInstanceNumber, //物品实例编码
											ruleId : bo2Coupons.ruleId, //物品规则ID
											partyId : bo2Coupons.partyId, //客户ID
											prodId : bo2Coupons.prodId, //产品ID
											offerId : bo2Coupons.offerId, //销售品实例ID
											attachSepcId : bo2Coupons.attachSepcId,
											state : bo2Coupons.state, //动作
											relaSeq : bo2Coupons.relaSeq, //关联序列	
											num	: bo2Coupons.num //第几个串码输入框
										};
										OrderInfo.attach2Coupons.push(coupon);
										//AttachOffer.checkTerminalCodeReload($("#terminalAddBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num));
								}
							}
						}
					}
				});
			}else if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="7"){
				var offermap = this;
				var offerflag = false;
				$.each(AttachOffer.openServList,function(){
					if(this.prodId==offermap.data.boServOrders[0].servId){
						$.each(this.servSpecList,function(){
							if(this.servSpecId==offermap.data.boServOrders[0].servSpecId){
								offerflag = true;
								return false;
							}
						});
					}
				});
				if(!offerflag){
					var ifParams = "N";
					if(offermap.data.boServItems!=undefined){
						ifParams = "Y";
					}
					AttachOffer.openServSpecReload(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId,offermap.data.boServOrders[0].servSpecName,ifParams);
	/*				if(ifParams=="Y"){
						var spec = CacheData.getServSpec(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId);
						if(!!spec.prodSpecParams){
							for (var i = 0; i < spec.prodSpecParams.length; i++) {
								var param = spec.prodSpecParams[i];
								var itemSpec = CacheData.getServSpecParam(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId,param.itemSpecId);
								$.each(offermap.data.boServItems,function(){
									if(itemSpec.itemSpecId==this.itemSpecId){
										itemSpec.setValue = this.value;
									}
								});
							}
						}
						$("#can_"+this.busiObj.instId+"_"+offermap.data.boServOrders[0].servSpecId,param.itemSpecId).removeClass("canshu").addClass("canshu2");
						var attchSpec = CacheData.getServSpec(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId,param.itemSpecId);
						attchSpec.isset = "Y";
					}*/
				}
			}
		});
	};
	
	//根据产品id获取销售品成员
	var _getOfferMember = function(prodId){
		for(var j=0;j<OrderInfo.oldoffer.length;j++){
			for ( var i = 0; i < OrderInfo.oldoffer[j].offerMemberInfos.length; i++) {
				var offerMember = OrderInfo.oldoffer[j].offerMemberInfos[i];
				if(offerMember.objInstId==prodId){
					return offerMember;
				}
			}
		}
		return {};
	};
	
	//动态添加产品属性、附属销售品等
	var _loadOther = function(param) {
		$.each(OrderInfo.offerSpec.offerRoles,function(){ //遍历主套餐规格
			var offerRole = this;
			if(offerRole.prodInsts!=undefined && offerRole.prodInsts!=null){
			for ( var i = 0; i < this.prodInsts.length; i++) {
				var prodInst = this.prodInsts[i];
				var param = {   
					offerSpecId : OrderInfo.offerSpec.offerSpecId,
					prodSpecId : prodInst.objId,
					offerRoleId: prodInst.offerRoleId,
					prodId : prodInst.prodInstId,
					queryType : "1,2",
					objType: prodInst.objType,
					objId: prodInst.objId,
					memberRoleCd : prodInst.memberRoleCd
				};
				AttachOffer.queryAttachOfferSpec(param);  //加载附属销售品
				var obj = {
					ul_id : "item_order_"+prodInst.prodInstId,
					prodId : prodInst.prodInstId,
					offerSpecId : OrderInfo.offerSpec.offerSpecId,
					compProdSpecId : "",
					prodSpecId : prodInst.objId,
					roleCd : offerRole.roleCd,
					offerRoleId : offerRole.offerRoleId,
					partyId : OrderInfo.cust.custId,
					actionFlag : OrderInfo.actionFlag
				};
				if(OrderInfo.actionFlag == "6"){//主副卡成员变更				
					order.main.spec_member_parm(obj); //加载产品属性
				}else{
					order.main.spec_parm(obj); //加载产品属性
				}
			}	
		  }
		});
		if(offerChange.oldMemberFlag){
			order.main.loadAttachOffer();
		}
		
	};
	//动态添加产品属性、附属销售品等
	var _loadOtherSub = function(param) {
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if(ec.util.isArray(this.prodInsts)){
				$.each(this.prodInsts,function(){
					var _prodInstId = "'"+this.prodInstId+"'";
					if(_prodInstId.indexOf("-") == -1){
						var prodId = this.prodInstId;
						var param = {
							areaId : OrderInfo.getProdAreaId(prodId),
							channelId : OrderInfo.staff.channelId,
							staffId : OrderInfo.staff.staffId,
						    prodId : prodId,
						    prodSpecId : this.objId,
						    offerSpecId : prodInfo.prodOfferId,
						    offerRoleId : this.offerRoleId,
						    acctNbr : this.accessNumber
						};
						//现在号码
						var nowPhoneNum=this.accessNumber;
						var res = query.offer.queryChangeAttachOffer(param);
						$("#attach_"+prodId).html(res);	
						//如果objId，objType，objType不为空才可以查询默认必须
						if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){
							param.queryType = "1,2";
							param.objId = this.objId;
							param.objType = this.objType;
							param.memberRoleCd = this.roleCd;
							param.offerSpecId=OrderInfo.offerSpec.offerSpecId;
							//默认必须可选包
							var data = query.offer.queryDefMustOfferSpec(param);
							CacheData.parseOffer(data,prodId);
							//默认必须功能产品
							param.queryType = "1";//只查询必选，不查默认
							var data = query.offer.queryServSpec(param);
							CacheData.parseServ(data,prodId);
						}
						/*if(CONST.getAppDesc()==0 && prodInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){	//预校验
						}else{	
						}*/
						AttachOffer.showMainRoleProd(prodId); //显示新套餐构成
	//					AttachOffer.changeLabel(prodId,this.objId,""); //初始化第一个标签附属
						if(AttachOffer.isChangeUim(prodId)){ //需要补换卡
							//uim卡校验
							if(OrderInfo.mktResInstCode!=undefined && OrderInfo.mktResInstCode!=null && OrderInfo.mktResInstCode!="" && OrderInfo.mktResInstCode!="null"){
								var array=OrderInfo.mktResInstCode.split(",");
								if(array!=null && array.length>0){
									//首先进行UIM是否重复判断
									var checkPhone="";
									var checkUim="";
									var checkCode="0";
									for(var i=0;i<array.length;i++){
										var numAndUim=array[i].split("_");
										if(numAndUim!=null && numAndUim.length==2){
											var thisPhone=numAndUim[0];
											var thisUim=numAndUim[1]
											if(checkPhone!=null && checkPhone!=""){
												if(checkPhone==thisPhone || checkUim==thisUim){
													checkCode="1";
													break;
												}
											}else{
												checkPhone=thisPhone;
												checkUim=thisUim;
											}
										}
									}
									if(checkCode=="1"){
										$.alert("提示","传入的UIM参数中存在重复数据,参数为["+OrderInfo.mktResInstCode+"]");
									}else{
										//没有重复的数据再进行匹配
										var nowUim="";
										for(var i=0;i<array.length;i++){
											var numAndUim=array[i].split("_");
											if(numAndUim!=null && numAndUim.length==2){
												var phoneCode=numAndUim[0];
												var uimCode=numAndUim[1];
												
												if(phoneCode==nowPhoneNum){
													nowUim=uimCode;
												}
											}
										}
										if(nowUim!=null && nowUim!="" && nowUim!="null"){
											cleckUim(nowUim,prodId);
											$("#uim_check_btn_"+prodId).hide();
											$("#uim_release_btn_"+prodId).hide();
										}
									}
								}
							}
							num++;
							$("#uimDiv_"+prodId).show();
						}
					}
					else{
						var prodInst = this;
						var param = {   
							offerSpecId : OrderInfo.offerSpec.offerSpecId,
							prodSpecId : prodInst.objId,
							offerRoleId: prodInst.offerRoleId,
							prodId : prodInst.prodInstId,
							queryType : "1,2",
							objType: prodInst.objType,
							objId: prodInst.objId,
							memberRoleCd : prodInst.memberRoleCd
						};
						AttachOffer.queryAttachOfferSpec(param);  //加载附属销售品
						var obj = {
							ul_id : "item_order_"+prodInst.prodInstId,
							prodId : prodInst.prodInstId,
							offerSpecId : OrderInfo.offerSpec.offerSpecId,
							compProdSpecId : "",
							prodSpecId : prodInst.objId,
							roleCd : offerRole.roleCd,
							offerRoleId : offerRole.offerRoleId,
							partyId : OrderInfo.cust.custId,
							actionFlag : OrderInfo.actionFlag
							
						};
						//order.main.spec_parm(obj); //加载产品属性
						order.main.spec_member_parm(obj);
					}
				});
			}
		});
		
		
		
	};
	var _paymethodChange = function(obj){
		$(".paymethodChange").each(function(){
			if($(this).attr("id")!=$(obj).attr("id")){
				$(this).val($(obj).val());
			}
		});
	};
	
	var _templateTypeCheck = function(obj){
		if($("#isTemplateOrder").attr("checked")=="checked"){//如果选择批量模板
			var paytype=$('select[name="pay_type_-1"]').val(); 
			if(obj&&$(obj).val()){//如果是 批量模板 选择 批开模板，直接提示
				if($(obj).val()=="0"&&paytype!="2100"){//如果不是预付费
					$.alert("提示","您选择批开活卡模板，付费方式需改成'预付费'！");
					$("html").scrollTop(0);
					return false ;
				}
			}else{//如果是 订单提交时 判断
				var templeVal = $("#templateOrderDiv select").val();
				if(templeVal){
					if(templeVal=="0"&&paytype!="2100"){//如果不是预付费
						$.alert("提示","您选择批开活卡模板，付费方式需改成预付费！");
						$("html").scrollTop(0);
						return false ;
					}
				}
			}
			/*
			var paymethod = null ;
			var paymethodid = null ;
			$(".paymethodChange").each(function(){//获取第一个付费方式
				if(paymethod==null){
					paymethod = $(this).val();
					paymethodid = $(this).attr("id");
				}
			});
			if(obj&&$(obj).val()){//如果是 批量模板 选择 批开模板，直接提示
				if($(obj).val()=="0"&&paymethod!="2100"){//如果不是预付费
					$.alert("提示","您选择批开活卡模板，付费方式需改成'预付费'！");
					$("html").scrollTop(0);
					return false ;
				}
			}else{//如果是 订单提交时 判断
				var templeVal = $("#templateOrderDiv select").val();
				if(templeVal){
					if(templeVal=="0"&&paymethod!="2100"){//如果不是预付费
						$.alert("提示","您选择批开活卡模板，付费方式需改成预付费！");
						$("html").scrollTop(0);
						return false ;
					}
				}
			}
			*/
		}
		return true ;
	};
	
	var _initFeeType = function(param) {
		if (param.feeType != undefined && param.feeType && param.feeType != CONST.PAY_TYPE.NOLIMIT_PAY) {
			$("input[name^=pay_type_][value="+param.feeType+"]").attr("checked","checked");
			$("input[name^=pay_type_]").attr("disabled","disabled");
		}
	};
	
	//初始化帐户展示
	var _initAcct = function(flag) {
		//新客户自动新建帐户
//		if(OrderInfo.cust.custId==-1){
//			_createAcct();
//		}
//		else{
			//主副卡成员变更业务不能更改帐户，只展示主卡帐户
			if(OrderInfo.actionFlag==6 || (OrderInfo.actionFlag==2 && offerChange.oldMemberFlag == true)){
				var param = {};
				if(flag==1){
					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
						param.prodId=OrderInfo.oldprodInstInfos[i].prodInstId;
						param.acctNbr=OrderInfo.oldprodInstInfos[i].accNbr;
						param.areaId=OrderInfo.oldprodInstInfos[i].areaId;
						var jr = $.callServiceAsJson(contextPath+"/order/queryProdAcctInfo", param);
						if(jr.code==-2){
							$.alertM(jr.data);
							return;
						}
						var prodAcctInfos = jr.data;
						prodAcctInfos[0].accessNumber = OrderInfo.oldprodInstInfos.accNbr;
						OrderInfo.oldprodAcctInfos.push({"prodAcctInfos":prodAcctInfos});
					}
				}else{
					param.prodId=order.prodModify.choosedProdInfo.prodInstId;
					param.acctNbr=order.prodModify.choosedProdInfo.accNbr;
					param.areaId=order.prodModify.choosedProdInfo.areaId;
					var jr = $.callServiceAsJson(contextPath+"/order/queryProdAcctInfo", param);
					if(jr.code==-2){
						$.alertM(jr.data);
						return;
					}
					var prodAcctInfos = jr.data;
					var _obj = $("#acctSelect");
					$("#accountDiv").find("label:eq(0)").text("主卡帐户：");
					$.each(prodAcctInfos, function(i, prodAcctInfo){
						_obj.append("<option value='"+prodAcctInfo.acctId+"' acctcd='"+prodAcctInfo.acctCd+"'>"+prodAcctInfo.name+" : "+prodAcctInfo.acctCd+"</option>");
					});				
					//jquery mobile 需要刷新才能生效
					_obj.selectmenu().selectmenu('refresh');
					
					$("#accountDiv").find("button:eq(0)").hide();
				}				
			}
			else{
				//新装默认新建帐户
				_createAcct();
			}
			/*
			else{
				//先查询客户下的已有帐户
				var param = {
					custId : OrderInfo.cust.custId
				};				
				$.callServiceAsJson(contextPath+"/order/account", param, {
					"done" : function(response){
						if (response==undefined) {
							$.alert("提示", "帐户查询失败");
							return;
						}
						if (response.code==0) {
							var returnMap = response.data;
							if(returnMap.resultCode==0){
								if(returnMap.accountInfos && returnMap.accountInfos.length > 0){
									$.each(returnMap.accountInfos, function(i, accountInfo){
										$("<option>").text("[已有] "+accountInfo.name+" : "+accountInfo.accountNumber).attr("value",accountInfo.acctId).attr("acctcd",accountInfo.accountNumber).appendTo($("#acctSelect"));
									});
								}			
							}
							else{
								$.alert("提示", "客户的帐户定位失败，请联系管理员，若要办理新装业务请稍后再试或者使用新建帐户。错误细节："+returnMap.resultMsg);
							}
						} else {
							if (response.code==-2) {
								$.alertM(response.data);
								return;
							} else {
								$.alert("提示",response.data);
							}							
						}
						//无论是否查询到旧帐户，最后都新建一个账户
						_createAcct();
					}
				});				
			}*/
//		}
	};
	
	//初始化订单标签
	var _initOrderLabel = function() {
		//订单标签
		$(".ordertabcon:first").show();
		$(".ordertab li:first").addClass("setorder");
		$(".ordertab li").each(function(index){
			$(this).click(function(){
				var orderSeq = $(this).attr("order");
				if (orderSeq > 1) {
					$(".order_copy").show();
				} else {
					$(".order_copy").hide();
				}
				$(this).addClass("setorder").siblings().removeClass("setorder");
				$(this).parents(".ordernav").parent().siblings(".ordercon").find(".ordertabcon").eq(index).show().siblings().hide();
			});
		});
	};
	
	//初始化主副卡标签
	var _initOfferLabel = function() {
		//主副卡标签
		$(".many li").bind("click", function () {
			var index = $(this).index();
			var divs = $("#tabs-body .ordercona");
			$(this).parent().children("li").attr("class", "tab-nav");//将所有选项置为未选中
			$(this).attr("class", "tab-nav-action"); //设置当前选中项为选中样式
			divs.hide();//隐藏所有选中项内容
			divs.eq(index).show(); //显示选中项对应内容
		});
	};
	//初始化购物车属性
	var _initOrderAttr = function() {
		//客户类型,证件类型
		order.cust.partyTypeCdChoose($("#orderPartyTypeCd").children(":first-child"),"orderIdentidiesTypeCd");
		order.cust.identidiesTypeCdChoose($("#orderIdentidiesTypeCd").children(":first-child"),"orderAttrIdCard");
		
	};
	
	//帐户信息-添加页面点击事件
	var _addEvent = function() {
		//页面点击帐户查询
		$('#acctQueryForm').bind('formIsValid', function(event, form) {
			var acctQueryParam;
			//1.根据接入号查询帐户
			if($("#chooseQueryAcctType").val()==1){
				if(!CONST.LTE_PHONE_HEAD.test($.trim($("#d_query_nbr input").val()))){
					$.alert("提示", "请输入有效的中国电信手机号");
					return;
				}
//				var param = {
//						accessNumber : $("#d_query_nbr input").val(),
//						prodPwd : $("#d_query_pwd input").val()
//				};
				//根据接入号查询帐户需先经过产品密码鉴权
//				var jr = $.callServiceAsJson(contextPath + "/order/prodAuth", param);
//				if (jr.code==0){
					acctQueryParam = {
						accessNumber : $("#d_query_nbr input").val()							
					};
//				} 
//				else{
//					$.alert("提示",jr.data);
//				}				
			} 
			//2.根据合同号查询帐户
			else if($("#chooseQueryAcctType").val()==2){
				acctQueryParam = {
					acctCd : $("#d_query_cd input").val()
				};
			}
			//0.查询当前客户下帐户
			else{
				acctQueryParam = {
					custId : OrderInfo.cust.custId,
					isServiceOpen:"Y"
				};
			}			
			$.callServiceAsJson(contextPath+"/order/account", acctQueryParam, {
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$("#acctListTab tbody").empty();
					if(response.code==-2){
						$.alertM(response.data);
						return;
					}
					if(response.code==0){
						var returnMap = response.data;
						if(returnMap.resultCode==0){
							if(returnMap.accountInfos && returnMap.accountInfos.length > 0){
								$("#acctPageDiv").empty();
								common.page.init("acctPageDiv", 5, "pageId","queryAccount", returnMap.accountInfos);
							} 
							else{
								$("<tr><td colspan=4>未查询到帐户信息</td></tr>").appendTo($("#acctListTab tbody"));
							}
						}
						else{
							$("<tr><td colspan=4>"+returnMap.resultMsg+"</td></tr>").appendTo($("#acctListTab tbody"));
						}				
					}
					else{
						$("<tr><td colspan=4>"+response.data+"</td</tr>").appendTo($("#acctListTab tbody"));
					}
				}
			});
		}).ketchup({bindElement:"querAcctBtn"});

		$("#zhanghuclose").click(function(){
			easyDialog.close();
			//删除所有选择帐户监听
			$(document).removeJEventListener("queryAccount");
		});
		$(this).addJEventListener("queryAccount",function(data){
			_showAcct(data);
		});
		///选择查询帐户的条件
		$("#chooseQueryAcctType").change(function(){
			if($(this).val() == 1){//1.根据接入号查询
				$("#d_query_cd").remove();
				$("#querAcctBtn").parent().before("<dd id='d_query_nbr'>&nbsp;<input type='text' data-validate='validate(required:接入号不能为空) on(keyup blur)'" +
						" value='' class='inputWidth150px'></dd>");
//				$("#querAcctBtn").parent().before("<dd id='d_query_pwd'>&nbsp; 产品密码：&nbsp;<input  type='password' data-validate='validate(required:密码不能为空) on(keyup blur)' " +
//						"value='' class='inputWidth150px'></dd>");
			}else if($(this).val()==2){//2.根据合同号查询
				$("#d_query_nbr").remove();
//				$("#d_query_pwd").remove();
				$("#querAcctBtn").parent().before("<dd id='d_query_cd'>&nbsp;<input type='text' data-validate='validate(required:合同号不能为空) on(keyup blur)'" +
						" value='' class='inputWidth150px' ></dd>");
			}else{//0.查询当前客户下账户（默认）
				$("#d_query_cd").remove();
				$("#d_query_nbr").remove();
			}
		});
		$("#chooseQueryAcctType").change();
		//当前是否选用新帐户（是否展示自定义属性）
		$("#acctSelect").change(function(){
			if($(this).val()==-1){
				$(this).parent().find("a:eq(1)").hide();
				if(OrderInfo.actionFlag!=2){
					$("#defineNewAcct").show();
				}
				
			}
			else{
				$(this).parent().find("a:eq(1)").show();
				$("#defineNewAcct").hide();
			}
		});
	};
		
	//展示帐户
	var _showAcct = function(accountInfos){
		$("#acctListTab tbody").empty();
		$.each(accountInfos,function(i, accountInfo){
			var tr = $("<tr></tr>").appendTo($("#acctListTab tbody"));
			if(accountInfo.name){
				$("<td class='teleNum'>"+accountInfo.name+"</td>").appendTo(tr);
			}
			else{
				$("<td></td>").appendTo(tr);
			}
			if(accountInfo.acctId){
				$("<td acctId='"+accountInfo.acctId+"'>"+accountInfo.accountNumber+"</td>").appendTo(tr);
			}
			else{
				$("<td></td>").appendTo(tr);
			}
			if(accountInfo.owner){
				$("<td>"+accountInfo.owner+"</td>").appendTo(tr);
			}
			else{
				$("<td></td>").appendTo(tr);
			}
			if(accountInfo.accessNumber){
				$("<td>"+accountInfo.accessNumber+"</td>").appendTo(tr);
			}
			else{
				$("<td></td>").appendTo(tr);
			}
			tr.click(function(){
				var found = false;
				var custAccts = $("#acctSelect").find("option");
				$.each(custAccts, function(i, custAcct){
					if(custAcct.value==accountInfo.acctId){
						$("#acctSelect").find("option[value="+custAcct.value+"]").attr("selected","selected");
						found = true;
						return false;
					}					
				});					
				$(this).dispatchJEvent("chooseAcct",accountInfo);				
				easyDialog.close();
				$("#defineNewAcct").hide();
			});
		});
	};
	
	
	function _spec_parm(param){
		$.callServiceAsHtmlGet(contextPath + "/pad/order/orderSpecParam",param, {
			"done" : function(response){
				if(response && response.code == -2){
					return ;
				}else if(response && (response.data == 0||response.data == "0")){
					return;
				}
				$("#"+param.ul_id).after(response.data);
				$("div[name='spec_params']").each(function(){
					$.jqmRefresh($(this));
				});
				//判断使用人产品属性是否必填
				_checkUsersProdAttr(param.prodId, $("#"+param.ul_id));
				//只有在新装的时候才可编辑“是否信控”产品属性
				_checkUsersProdAttr(param.prodId, $("#"+param.ul_id));
				var xkDom = $("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+param.prodId);
				if(xkDom.length == 1){
					if(OrderInfo.actionFlag != 1&& OrderInfo.actionFlag != 14){
						$(xkDom).attr("disabled","disabled");
						$(xkDom).parent().find("a").addClass("ui-state-disabled");
					} else {
						$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+param.prodId+" option[value=' ']").remove(); //去除“请选择”空值选项
						$(xkDom).val("20"); //默认为“是”
						if(OrderInfo.offerSpec.feeType == CONST.PAY_TYPE.BEFORE_PAY){ //“预付费”默认选是，且不可编辑
							$(xkDom).attr("disabled","disabled");
							$(xkDom).parent().find("a").addClass("ui-state-disabled");
						}
					}
					$(xkDom).selectmenu().selectmenu('refresh');
				}
				//新装--二次加载(是否信控)处理 
				if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){
					$.each(OrderInfo.reloadProdInfo.checkMaskList,function(){
						$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+this.prodId+"").find("option[value='"+this.isCheckMask+"']").attr("selected",true);
						$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+this.prodId+"").selectmenu('refresh', true);
						/*if(this.isCheckMask=="10"){
							$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+prodId+"-button").find("span").text("否");
						}else{
							$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+prodId+"-button").find("span").text("是");
						}*/
					});
					//刷新发展人标签
					var $dealerTypes = $("[id^='dealerType_']");
					//$("#dealerType_81011_1").selectmenu().selectmenu('refresh');
					/*$.each($dealerTypes,function(){
						$(this).selectmenu().selectmenu('refresh');
					});*/
					//处理付费方式
					var $select=$("#paytype_prod_id");
					var $options=$("#paytype_prod_id").find("option");
					for(var i=0;i<$options.length;i++){
						if($($options[i]).val()==OrderInfo.reloadProdInfo.feeType){
							$select[0].selectedIndex=i;
							$select.slider("refresh");
							order.main.feeTypeCascadeChange($select,'-1');
							break;
						}
					}		
				  }
			},
			fail:function(response){
				$.unecOverlay();
			}
		});
	}
	
	//产品属性 提交
	function _spec_parm_change_save(){
		//OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,CONST.BO_ACTION_TYPE.PRODUCT_PARMS,0,CONST.getBoActionTypeName(CONST.BO_ACTION_TYPE.PRODUCT_PARMS),"");
		if(!_check_parm("order_spc_update")){
			return ;
		}
		var boProdItems = new Array();
		//input
		var chang_row = 0;
		$("#order_spc_update input").each(function(){
			//订单属性 是否模板 由公共类自动添加，这里不加入属性
			if($(this).attr("id")!="order_remark"&&$(this).attr("id")!="isTemplateOrder"&&$(this).attr("id")!="templateOrderName"&&$(this).attr("id")!="templateOrderType"){
				if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){
					if("1"==$(this).attr("addtype")){//如果实例没有，通过规格带出的属性，做ADD
						if($(this).val()!=null&&$(this).val()!=""){
							var row1 = {
									"itemSpecId":$(this).attr("itemSpecId"),
									"prodSpecItemId":$(this).attr("prodSpecItemId"),
									"state":"ADD",
									"value":$(this).val()
							};
							boProdItems.push(row1);
							chang_row++;
						}
					}else{
						if($(this).val()!=$(this).attr("oldValue")){
							if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){
								var row2 = {
										"itemSpecId":$(this).attr("itemSpecId"),
										"prodSpecItemId":$(this).attr("prodSpecItemId"),
										"state":"DEL",
										"value":$(this).attr("oldValue")
								};
								boProdItems.push(row2);
								chang_row++;
							}
							if($(this).val()!=null&&$(this).val()!=""){
								var row3 = {
										"itemSpecId":$(this).attr("itemSpecId"),
										"prodSpecItemId":$(this).attr("prodSpecItemId"),
										"state":"ADD",
										"value":$(this).val()
								};
								boProdItems.push(row3);
								chang_row++;
							}
						}
					}
				}
			}
		});
		//select
		$("#order_spc_update select").each(function(){
			if($(this).attr("id")!="templateOrderType"){
				if($(this).attr("itemSpecId")!=null&&$(this).attr("itemSpecId")!=""){
					if("1"==$(this).attr("addtype")){//如果实例没有，通过规格带出的属性，做ADD
						if($(this).val()!=null&&$(this).val()!=""){
							var row1 = {
									"itemSpecId":$(this).attr("itemSpecId"),
									"prodSpecItemId":$(this).attr("prodSpecItemId"),
									"state":"ADD",
									"value":$(this).val()
							};
							boProdItems.push(row1);
							chang_row++;
						}
					}else{
						if($(this).val()!=$(this).attr("oldValue")){
							if($(this).attr("oldValue")!=null&&$(this).attr("oldValue")!=""){
								var row2 = {
										"itemSpecId":$(this).attr("itemSpecId"),
										"prodSpecItemId":$(this).attr("prodSpecItemId"),
										"state":"DEL",
										"value":$(this).attr("oldValue")
								};
								boProdItems.push(row2);
								chang_row++;
							}
							if($(this).val()!=null&&$(this).val()!=""){
								var row3 = {
										"itemSpecId":$(this).attr("itemSpecId"),
										"prodSpecItemId":$(this).attr("prodSpecItemId"),
										"state":"ADD",
										"value":$(this).val()
								};
								boProdItems.push(row3);
								chang_row++;
							}
						}
					}
				}
			}
		});
		var busiOrderAttrs ;
		if($("#order_remark").val()){
			busiOrderAttrs = [{
				atomActionId : OrderInfo.SEQ.atomActionSeq--,
				itemSpecId : CONST.ITEM_SPEC_ID_CODE.busiOrderAttrs ,//"111111122",//备注的ID，待修改
				value : $("#order_remark").val()
			}];
			chang_row++;
		}
		if(chang_row<1){
			$.alert("提示","您未修改订单属性");
			return ;
		}
		/*
		if(!SoOrder.builder()){//加载实例缓存，并且初始化订单数据
			return;
		} 
		*/
		//配置参数：来调用产品属性修改的ser
		//OrderInfo.boProdItems = boProdItems ;
		var data = {boProdItems:boProdItems} ;
		if(busiOrderAttrs){
			data.busiOrderAttrs = busiOrderAttrs ;
		}
		OrderInfo.actionFlag=33;//改产品属性
		SoOrder.submitOrder(data);

	}
	//产品属性-校验所有属性
	function _check_parm(ul_id){
		var f = true ;
		$("#"+ul_id).find("input").each(function(){
			if(f){
				f = _check_parm_self(this);
			}
		});
		return f;
	}
	//产品属性-校验单个属性
	function _check_parm_self(obj){
		//alert("---"+$(obj).val());
		if($(obj).attr("check_option")=="N"){
			if($(obj).val()==null||$(obj).val()==""){
				$.alert("提示",$(obj).attr("check_name")+" 尚未填写");
				return false;
			}
		}
		
		if($(obj).attr("check_type")=="check"){
			var len = $(obj).attr("check_len");
			//alert($(this).val()+"--"+len);
			if(len>0){
				//alert($(this).val().length+"---"+len);
				if($(obj).val().length>len){
					$.alert("提示",$(obj).attr("check_name")+" 长度过长(<"+len+")");
					return false;
				}
			}
			var mask = $(obj).attr("check_mask");
			if(mask!=null&&$(obj).val()!=null&&$(obj).val()!=""){
				//alert($(obj).val()+"---"+mask);
				//mask= "^[A-Za-z]+$";
				var pattern = new RegExp(mask) ;
				if(!pattern.test($(obj).val())){
					$.alert("提示",$(obj).attr("check_name")+ " 校验失败：" + $(obj).attr("check_mess"));
					return false;
				}
			}
			var v_len = $(obj).val().length;
			if(v_len>0&&$(obj).attr("dataType")=="3"){//整数
				if(!/^[0-9]+$/.test($(obj).val())){
					$.alert("提示",$(obj).attr("check_name")+ " 非数字，请修改");
					return false;
				}
			}else if(v_len>0&&$(obj).attr("dataType")=="5"){//小数
				if(!/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test($(obj).val())){
					$.alert("提示",$(obj).attr("check_name")+ " 非小数，请修改");
					return false;
				}
			}else if(v_len>0&&($(obj).attr("dataType")=="4"||$(obj).attr("dataType")=="16")){//日期
				/*
				if(/Invalid|NaN/.test(new Date($(obj).val().substring(0,10)))){
					$.alert("提示",$(obj).attr("check_name")+ " 非日期，请修改");
					return false;
				}
				*/
			}
		}
		return true ;
	}
	//滚动分页回调 ok
	var _queryScroll = function(scrollObj){
		if(scrollObj && scrollObj.page){
			_queryStaffPage(scrollObj.page,scrollObj.scroll);
		}
	};
	//协销人-查询-入口 ok
	var _queryStaff = function(dealerId,objInstId){
		$.callServiceAsHtmlGet(contextPath + "/pad/staffMgr/getStaffListPrepare",{"dealerId":dealerId,"objInstId":objInstId},{
			"done" : function(response){
				//统一弹出框
				var popup = $.popup("#div_staff_dialog",response.data,{
					cache:true,
					width:$(window).width()-200,
					height:$(window).height(),
					contentHeight:$(window).height()-120,
					afterClose:function(){}
				});
				$("#btn_staff_select_chk").off("tap").on("tap",function(){_setStaff(objInstId);});
				$("#a_order_staff_qry").off("tap").on("tap",function(){_queryStaffPage(1);});
			}
		});
	};
	//协销人-查询 -列表 ok
	var _queryStaffPage = function(qryPage,scroller){
	   
		var param = {
			"dealerId" :$("#dealer_id").val(),
			"qrySalesCode":$("#qrySalesCode").val(),
			"staffName":$("#qryStaffName").val(),
			"staffCode":$("#qryStaffCode").val(),
			"staffCode2":$("#qryStaffCode").val(),
			"salesCode":$("#qrySalesCode").val(),
			"pageIndex":qryPage,
			"objInstId":$("#objInstId").val(),
			"pageSize" :10
		};
		
		$.callServiceAsHtml(contextPath + "/pad/staffMgr/getStaffList",param,{
			"before":function(){
				if(qryPage==1)$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				if(qryPage==1)$.unecOverlay();
			},
			"done" : function(response){
				var _data = "";
				if(!response){
					_data='';
				}else{
					_data = response.data;
				}
				var content$ = $("#div_order_dealer_list");
				//首页时直接覆盖,其它页追加
				if(qryPage==1)content$.html(_data);
				else content$.find("tbody").append(_data);
				
				content$.find("tr").each(function(){
					$(this).off("tap").on("tap",function(event){
						$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg");
					});
				});
				
				//回调刷新iscroll控制数据,控件要求
				if(scroller && $.isFunction(scroller)) scroller.apply(this,[]);
			}
		});	

	};
	//选中协销人 ok
	var _setStaff = function(objInstId){
		var $staff = $("#div_order_dealer_list tr.userorderlistlibg");
		$staff.each(function(){
			$("#dealer_"+objInstId).val($(this).attr("staffName")).attr("staffId", $(this).attr("staffId"));
		});
		if($staff.length > 0){
			$("#div_staff_dialog").popup("close");
		}else{
			$.alert("提示","请先选择协销人！");
		}
	};
	/*
	function _setStaff(v_id,staffId,staffCode,staffName){
		//alert(v_id+"--"+staffId+"=="+staffName);
		$("#"+v_id).val(staffName+"("+staffCode+")").attr("staffId",staffId);
		if(!$("#acctDialog").is("hidden")) {
			easyDialog.close();
		}
	}
	*/
	
	//帐户查询
	var _chooseAcct = function() {
		$("#acctDialog .contract_list td").text("帐户查询");
		$("#acctDialog .selectList").show();
		easyDialog.open({
			container : 'acctDialog'
		});
		$("#acctPageDiv").show();
		var listenerName = "chooseAcct";
		var $sel = $("#acctSelect");
		if (!$sel.hasJEventListener(listenerName)) {
			$sel.addJEventListener(listenerName,function(data){
				//遍历当前帐户列表，如果已存在，则直接显示，如果不存在，则加上一个option
				var found = false;
				$.each($sel.find("option"), function(i, option) {
					if ($(option).val() == data.acctId) {
						found = true;
						return false;
					}
				});
				if (found==false) {
					$("<option>").text(data.name+" : "+data.accountNumber).attr("value",data.acctId).attr("acctcd",data.accountNumber).appendTo($sel);
				}
				$sel.find("option[value="+data.acctId+"]").attr("selected","selected");
				if(data.acctId>0){
					$("#account").find("a:eq(1)").show();
				}
			});
		}
		//初始化弹出框
		$("#acctListTab tbody").empty();
		$("#acctPageDiv").empty();
	};
	
	//新增帐户
	var _createAcct = function() {
		$("#acctSelect").append("<option value='-1' style='color:red'>[新增] "+OrderInfo.cust.partyName+"</option>");
		$("#acctSelect").find("option[value='-1']").attr("selected","selected");
		$("#acctName").val(OrderInfo.cust.partyName);//默认帐户名称为客户名称
		//新增帐户自定义支付属性
		if(OrderInfo.actionFlag!=2){
			$("#defineNewAcct").show();
		}
		//隐藏帐户信息的按钮
		$("#account").find("a:gt(0)").hide();
		//获取账单投递信息主数据并初始化新建帐户自定义属性
		window.setTimeout("order.main.showNewAcct()", 0);
	};
	//增加传入帐户
	var _createAcctWithId = function() {
	   //帐户信息查询参数初始化 
		var acctQueryParam;
		acctQueryParam = {acctCd : OrderInfo.acct.acctCd,isServiceOpen:"Y"};
		acctQueryParam.areaId=OrderInfo.getAreaId();
		$.callServiceAsJson(contextPath+"/order/account", acctQueryParam, {
				"before":function(){	},
				"always":function(){},
				"done" : function(response){
					if(response.code==-2){//查询接口出错
						$.alertM(response.data);
						return;
					}
					if(response.code==0){//查询成功
						var returnMap = response.data;
						if(returnMap.resultCode==0){
							if(returnMap.accountInfos && returnMap.accountInfos.length > 0){
								//将对应的帐号添加进进OrderInfo.acct中，以便生成订单时使用
								$.each(returnMap.accountInfos, function(i, prodAcctInfo){
									if(prodAcctInfo.acctId!=null&&prodAcctInfo.acctId!=""){
										OrderInfo.acct={"acctId":prodAcctInfo.acctId,"acctcd":prodAcctInfo.accountNumber,"name":prodAcctInfo.name};
										return false;
									}	
								});	
							} else{//未查询到帐户信息
							    $.alert("提示","没有查询到帐户合同号对应的帐户信息");
							}
						}
						else{
							$.alertM(returnMap.resultMsg);
						}				
					}else{
						$.alertM(response.data);
					}
				}
			});
	};
	
	
	//获取账单投递信息主数据并初始化新建帐户自定义属性
	var _showNewAcct = function(){
		acct.acctModify.ifCanAdjustBankPayment();//查询工号权限：能否选择银行托收
		acct.acctModify.getBILL_POST(function(){
			acct.acctModify.paymentType();
			acct.acctModify.billPostType();
		});
	};
	
	//展示帐户信息
	var _acctDetail = function() {
		var acctSel = $("#acctSelect");
		if(!acctSel.val()){
			$.alert("提示","请选择一个帐户");
			return
		}
		if(acctSel.val() == -1){
			$.alert("提示","该帐户是新建帐户");
			return;
		}
		$("#acctDialog .contract_list td").text("帐户信息");
		$("#acctDialog .selectList").hide();
		$("#acctPageDiv").hide();
		$("#acctListTab tbody").empty();
		easyDialog.open({
			container : 'acctDialog'
		});
		var acctQueryParam = {
			acctCd : acctSel.find("option:selected").attr("acctcd"),
			isServiceOpen:"Y"
		};			
		$.callServiceAsJson(contextPath+"/order/account", acctQueryParam, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code==-2){
					$.alertM(response.data);
					return;
				}
				if(response.code==0){
					_showAcct(response.data.accountInfos);					
				}
				else{
					$("<tr><td colspan=4>"+response.data+"</td</tr>").appendTo($("#acctListTab tbody"));
				}
				$("#acctListTab tr").off("click");				
			}			
		});
	};
	
	var _lastStep = function() {
		$.confirm("信息","确定回到上一步吗？",{
			yes:function(){
				//TODO　may initialize something;				
				var boProdAns = OrderInfo.boProdAns;
				var boProdAn = order.service.boProdAn;
				var boProd2Tds = OrderInfo.boProd2Tds;
				//取消订单时，释放被预占的UIM卡
				if(boProd2Tds.length>0){
					for(var n=0;n<boProd2Tds.length;n++){
						var param = {
								numType : 2,
								numValue : boProd2Tds[n].terminalCode
						};
						$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param, {
							"done" : function(){}
						});
					}
				}
				//若是购机或选号入口则将继续释放主卡以外的预占号码（过滤身份证预占的号码）
//				if(order.service.releaseFlag==1){
//					if(boProdAns.length>0){
//						for(var n=0;n<boProdAns.length;n++){
//							if(boProdAns[n].accessNumber==boProdAn.accessNumber || boProdAns[n].idFlag){
//								continue;
//							}
//							var param = {
//									numType : 1,
//									numValue : boProdAns[n].accessNumber
//							};
//							$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
//						}
//					}
//				}
				//若是套餐入口则将继续释放主副卡预占的号码（过滤身份证预占的号码）
//				if(order.service.releaseFlag==2){
//					if(boProdAns.length>0){
//						for(var n=0;n<boProdAns.length;n++){
//							if(boProdAns[n].idFlag){
//								continue;
//							}
//							var param = {
//									numType : 1,
//									numValue : boProdAns[n].accessNumber
//							};
//							$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
//						}
//					}
//					if(boProdAn.accessNumber!='')
//						order.phoneNumber.resetBoProdAn();
//				}
				//释放预占的号码
				if(boProdAns.length>0){
					for(var n=0;n<boProdAns.length;n++){
						if(boProdAns[n].idFlag){
							continue;
						}
						var param = {
								numType : 1,
								numValue : boProdAns[n].accessNumber
						};
						$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
					}
				}
				//清除号码的缓存！
				mktRes.phoneNbr.resetBoProdAn();
				$("#order_fill").empty();
				$("#order_prepare").show();
				$("#order_fill_content").empty();
				//order.prepare.showOrderTitle();
				$("#order_tab_panel_content").show();
				//order.prepare.step(1);
			},no:function(){
				
			}},"question");
	};
	
	var _getTestParam = function() {
		return {
			boActionTypeCd : S1,
			boActionTypeName : "订购",
			offerSpecId : 1234,
			offerSpecName : "乐享3G-129套餐",
			feeType : 1200,
			viceCardNum : 3,
			offerNum : 3,
			type : 1,//1购套餐2购终端3选靓号
			terminalInfo : {
				terminalName : "IPhone5",
				terminalCode : "46456457345"
			},
			offerRoles : [
				{
					offerRoleId : 1234,
					offerRoleName : "主卡",
					memberRoleCd : "0",
					roleObjs : [{
						offerRoleId : 1,
						objId : CONST.PROD_SPEC.CDMA,
						objName : "CDMA",
						objType : 2
					}]
				},
				{
					offerRoleId : 2345,
					offerRoleName : "副卡",
					memberRoleCd : "1"
				}
			]
		};
	};
	

	var _genRandPass6Input = function(id){
		var pass = _genRandPass6();
		$("#"+id).val(pass);
	};
	
	var _genRandPass6 = function(){
		var str = "" ;
		var lastOneS = "" ;
		var thisOneS = "" ;
		var thisOneI = 0 ;
		for(var k=0;k<6;k++){
			do{
				if(str.length>0){
					lastOneS = str.substring(str.length-1,str.length) ;
				}
				thisOneI = parseInt(Math.random()*9+1);
				thisOneS = ""+thisOneI ;
				if(str.length==5){
					if(_checkIncreace6(str + thisOneS)){
						continue;
					}
				}
			}while(lastOneS==thisOneS);
			str = str + thisOneS ;
		}
		if(str.length!=6){
			return null ;
		}
		return str ;
	};
	
	var _checkIncreace6 = function(str){
		var rownum = 0 ;
		if(str && str.length==6){
			for(var i=0;i<5;i++){
				var int1 = parseInt(str.substring(i,i+1));
				var int2 = parseInt(str.substring(i+1,i+2));
				rownum = rownum + (int1-int2);
			}
			if(rownum==5||rownum==-5){
				return true ;
			}else{
				return false ;
			}
		}else{
			return false ;
		}
	};
	
	var _passwordCheckInput = function(id,accNbr){
		var val = $("#"+id).val();
		return _passwordCheckVal(val,accNbr);
	};
	
	var _passwordCheckVal = function(val,accNbr){
		var detail = "<div style='text-indent:0px;'>密码设置规则：<br/>1、密码必须为六位全数字；<br/>2、密码不能与接入号中的信息重复；<br/>3、密码不能包含连续相同的数字；<br/>4、密码不能是连续的六位数字。</div>";
		var reg = new RegExp("^([0-9]{6})$");//6位纯数字 0~9
		if(val==null){
			$.alertMore("提示", "", "密码不可为空！", detail, "");
			return false ;
		}else if(!reg.test(val)){
			$.alertMore("提示", "", "密码包含非数字或长度不是6位", detail, "");
			return false ;
		}
		if(accNbr!=null && accNbr.indexOf(val)>=0){
			$.alertMore("提示", "", "密码不能与接入号中的信息重复，请修改！", detail, "");
			return false ;
		}
		for(var k=0;k<5;k++){
			lastOneS = val.substring(k,k+1) ;
			thisOneS = val.substring(k+1,k+2) ;
			if(lastOneS==thisOneS){
				$.alertMore("提示", "", "密码中包含连续相同数字，请修改！", detail, "");
				return false ;
			}
		}
		if(_checkIncreace6(val)){
			$.alertMore("提示", "", "密码不可是连续6位数字，请修改！", detail, "");
			return false ;
		}
		return true ;
	};
	
	//付费类型选项变更时级联更新相关的产品属性
	var _feeTypeCascadeChange = function(dom,prodId){
		var feeType = $(dom).val();
		var xkDom = $("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+prodId);
		//“是否信控”产品属性，预付费时默认为“是”且不可编辑，其他默认为“是”但可编辑
		if(feeType == CONST.PAY_TYPE.BEFORE_PAY){
			$(xkDom).val("20").attr("disabled","disabled");
			$(xkDom).parent().find("a").addClass("ui-state-disabled");
		} else {
			$(xkDom).val("20").removeAttr("disabled");
			$(xkDom).parent().find("a").removeClass("ui-state-disabled");
		}
		$(xkDom).selectmenu().selectmenu('refresh');
	};
	
	var _loadAttachOffer = function(param) {
		for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
			var prodInfo = OrderInfo.oldprodInstInfos[i]; //获取老用户产品信息
//			var uimDivShow=false;//是否已经展示了
			//var prodId = prodInfo.prodInstId;
			$.each(OrderInfo.oldoffer,function(){
				if(this.accNbr == prodInfo.accNbr){
					var oldoffer = this;
					$.each(oldoffer.offerMemberInfos,function(){
						var member = this;
						if(member.objType==CONST.OBJ_TYPE.PROD){
							var prodId = this.objInstId;
							var param = {
									areaId : OrderInfo.getProdAreaId(prodId),
									channelId : OrderInfo.staff.channelId,
									staffId : OrderInfo.staff.staffId,
								    prodId : prodId,
								    prodSpecId : member.objId,
								    offerSpecId : prodInfo.mainProdOfferInstInfos[0].prodOfferId,
								    offerRoleId : "",
								    acctNbr : member.accessNumber,
								    partyId:prodInfo.custId,
								    distributorId:OrderInfo.staff.distributorId,
								    mainOfferSpecId:prodInfo.mainProdOfferInstInfos[0].prodOfferId,
								    soNbr:OrderInfo.order.soNbr
								};
							if(ec.util.isObj(prodInfo.prodBigClass)){
								param.prodBigClass = prodInfo.prodBigClass;
							}
							$.each(OrderInfo.oldofferSpec,function(){
								if(this.accNbr==prodInfo.accNbr){
									$.each(this.offerSpec.offerRoles,function(){
										if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD || this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){
											param.offerRoleId = this.offerRoleId;
										}
									});
								}
							});
							var res = query.offer.queryChangeAttachOffer(param);
							$("#attach_"+prodId).html(res);	
							$.jqmRefresh($("#attach_"+prodId));
							//如果objId，objType，objType不为空才可以查询默认必须
							if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){
								param.queryType = "1,2";
								param.objId = member.objId;
								param.objType = member.objType;
								param.memberRoleCd = "401";
								//默认必须可选包
								var data = query.offer.queryDefMustOfferSpec(param);
								CacheData.parseOffer(data);
								//默认必须功能产品
								var data = query.offer.queryServSpec(param);
								CacheData.parseServ(data);
							}
							if(ec.util.isArray(OrderInfo.oldofferSpec)){ //主套餐下的成员判断
	//								var member = CacheData.getOfferMember(prodId);
								$.each(OrderInfo.oldofferSpec,function(){
									if(this.accNbr == prodInfo.accNbr){
										var offerRoles = this.offerSpec.offerRoles;
										$.each(offerRoles,function(){
											if(this.offerRoleId==member.offerRoleId && member.objType==CONST.OBJ_TYPE.PROD){
												var offerRole = this;
												$.each(this.roleObjs,function(){
													if(this.objType==CONST.OBJ_TYPE.SERV){
														var serv = CacheData.getServBySpecId(prodId,this.objId);//从已订购功能产品中找
														if(serv!=undefined){ //不在已经开跟已经选里面
															var $oldLi = $('#li_'+prodId+'_'+serv.servId);
															if(this.minQty==1){
																$oldLi.append('<dd class="mustchoose"></dd>');
															}
															$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
														}
													}
												});
												return false;
											}
										});
									}
								});
							}
							AttachOffer.changeLabel(prodId,prodInfo.productId,"");
						}
					});
				}
			});
			
//				if(_isChangeUim(prodId)){ //需要补换卡
//					if(!uimDivShow){
//						$("#uimDiv_"+prodId).show();
//					}else{
//						$("#uimDiv_"+prodId).hide();
//					}
//				}
//				uimDivShow=true;
			
			var oldoffer = {};
			if(ec.util.isArray(OrderInfo.oldoffer)){ //主套餐下的成员判断
//				var member = CacheData.getOfferMember(prodId);
			    $.each(OrderInfo.oldoffer,function(){
			    	if(this.accNbr == prodInfo.accNbr){
			    		oldoffer = this;
			    	}
			    });
			}
			//老用户加入副卡需要预校验,主卡是4G，加入的老用户为3G
			if(order.prodModify.choosedProdInfo.is3G== "N" && prodInfo.mainProdOfferInstInfos[0].is3G =="Y"){
				if(!order.memberChange.checkOrder(prodInfo,oldoffer)){ //省内校验单
					return;
				}
				order.memberChange.checkOfferProd(oldoffer);
			}
			
		}
//		order.main.reload();
					
//				});
//			}
//		});
	};
	
	var _loadViceMember = function(param) {
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		//遍历主销售品构成
		var uimDivShow=false;//是否已经展示了
		$.each(param.viceParam,function(){
			var prodId = this.objInstId;
			var param = {
				areaId : OrderInfo.getProdAreaId(prodId),
				channelId : OrderInfo.staff.channelId,
				staffId : OrderInfo.staff.staffId,
			    prodId : prodId,
			    prodSpecId : this.objId,
			    offerSpecId : prodInfo.prodOfferId,
			    offerRoleId : this.offerRoleId,
			    acctNbr : this.accessNumber
			};
			var res = query.offer.queryChangeAttachOffer(param);		
			$("#attach_"+prodId).html(res);		
			$.jqmRefresh($("#attach_"+prodId));
			//如果objId，objType，objType不为空才可以查询默认必须		
			if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){
				param.queryType = "1,2";
				param.objId = this.objId;
				param.objType = this.objType;
				param.memberRoleCd = "400";
				param.offerSpecId=this.offerSpecId;
				//默认必须可选包
				var data = query.offer.queryDefMustOfferSpec(param);
				CacheData.parseOffer(data,prodId);
				//默认必须功能产品
				var data = query.offer.queryServSpec(param);
				CacheData.parseServ(data,prodId);
			}
			/*if(CONST.getAppDesc()==0 && prodInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){	//预校验
			}else{	
			}*/
			AttachOffer.showMainMemberRoleProd(prodId); //显示新套餐构成
			AttachOffer.changeLabel(prodId,this.objId,""); //初始化第一个标签附属
			if(AttachOffer.isChangeUim(prodId)){ //需要补换卡
				if(!uimDivShow){
					$("#uimDiv_"+prodId).show();
				}else{
					$("#uimDiv_"+prodId).hide();
				}
			}
			uimDivShow=true;
		});		
//		order.dealer.initDealer(); //初始化发展人
//		offerChange.initOrderProvAttr();//初始化省内订单属性
	};
	
	//开通功能产品
	function openServSpec(prodId,servSpecId,specName,ifParams){
		var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
		if(servSpec==undefined){   //在可订购功能产品里面 
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : specName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			if(servSpecId==CONST.YZFservSpecId){//翼支付助手根据付费类型改变默认值
				var feeType = $("select[name='pay_type_-1']").val();
				if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
				if(feeType == CONST.PAY_TYPE.AFTER_PAY){
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {
						var prodSpecParam = newSpec.prodSpecParams[j];
						prodSpecParam.setValue = "";
					}																			
				}else{
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {							
						var prodSpecParam = newSpec.prodSpecParams[j];
						if (prodSpecParam.value!="") {
							prodSpecParam.setValue = prodSpecParam.value;
						} else if (!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!="")
							//默认值为空则取第一个
							prodSpecParam.setValue = prodSpecParam.valueRange[0].value;
				}
			  }
			}
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			servSpec = newSpec;
		}
		var servSpecId = servSpec.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		AttachOffer.addOpenServList(prodId,servSpecId,servSpec.servSpecName,servSpec.ifParams);
//		AttachOffer.checkServExcludeDepend(prodId,servSpec);
	};
	
	var _reload = function(){
		//主副卡暂存单二次加载
		if(order.memberChange.reloadFlag=="N"){
			var custOrderList = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
			//订购可选包和功能产品
			$.each(custOrderList,function(){
				//可选包
				if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="2"){
					var offermap = this;
					var offerflag = false;
					$.each(AttachOffer.openList,function(){
						if(this.prodId==offermap.data.ooRoles[0].prodId){
							$.each(this.specList,function(){
								if(this.offerSpecId==offermap.busiObj.objId){
									offerflag = true;
									return false;
								}
							});
						}
					});
							if(!offerflag){
								AttachOffer.addOpenList(offermap.data.ooRoles[0].prodId,offermap.busiObj.objId);
								//参数
								if(offermap.data.ooParams!=undefined){
									if(offermap.data.ooParams.length>0){
										var ooParams = offermap.data.ooParams[0];
										var spec = CacheData.getOfferSpec(ooParams.offerParamId,ooParams.offerSpecParamId);
										if(!!spec.offerSpecParams){
											for (var i = 0; i < spec.offerSpecParams.length; i++) {
												var param = spec.offerSpecParams[i];
												var itemSpec = CacheData.getSpecParam(ooParams.offerParamId,ooParams.offerSpecParamId,param.itemSpecId);
												if(itemSpec.itemSpecId == CONST.ITEM_SPEC.PROT_NUMBER){
													itemSpec.setValue = $("#select1").val();
												}else{
													itemSpec.setValue = ooParams.value;
												}
											}
										}
										if(spec.offerRoles!=undefined && spec.offerRoles.length>0){
											for (var i = 0; i < spec.offerRoles.length; i++) {
												var offerRole = spec.offerRoles[i];
												for (var j = 0; j < offerRole.roleObjs.length; j++) {
													var roleObj = offerRole.roleObjs[j];
													if(!!roleObj.prodSpecParams){
														for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
															var prodParam = roleObj.prodSpecParams[k];
															var prodItem = CacheData.getProdSpecParam(ooParams.offerParamId,ooParams.offerSpecParamId,prodParam.itemSpecId);
															prodItem.value = ooParams.value;
														}
													}
												}
											}
										}
										$("#can_"+ooParams.offerParamId+"_"+ooParams.offerSpecParamId).removeClass("canshu").addClass("canshu2");
										var attchSpec = CacheData.getOfferSpec(ooParams.offerParamId,ooParams.offerSpecParamId);
										attchSpec.isset = "Y";
									}
								}
								//终端串码
								if(offermap.data.bo2Coupons!=undefined){
									var bo2Coupons = offermap.data.bo2Coupons[0];
									$("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num).val(bo2Coupons.couponInstanceNumber);
									var coupon = {
											couponUsageTypeCd : bo2Coupons.couponUsageTypeCd, //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
											inOutTypeId : bo2Coupons.inOutTypeId,  //出入库类型
											inOutReasonId : bo2Coupons.inOutReasonId, //出入库原因
											saleId : bo2Coupons.saleId, //销售类型
											couponId : bo2Coupons.couponId, //物品ID
											couponinfoStatusCd : bo2Coupons.couponinfoStatusCd, //物品处理状态
											chargeItemCd : bo2Coupons.chargeItemCd, //物品费用项类型
											couponNum : bo2Coupons.couponNum, //物品数量
											storeId : bo2Coupons.storeId, //仓库ID
											storeName : bo2Coupons.storeName, //仓库名称
											agentId : bo2Coupons.agentId, //供应商ID
											apCharge : bo2Coupons.apCharge, //物品价格,约定取值为营销资源的
											couponInstanceNumber : bo2Coupons.couponInstanceNumber, //物品实例编码
											ruleId : bo2Coupons.ruleId, //物品规则ID
											partyId : bo2Coupons.partyId, //客户ID
											prodId : bo2Coupons.prodId, //产品ID
											offerId : bo2Coupons.offerId, //销售品实例ID
											attachSepcId : bo2Coupons.attachSepcId,
											state : bo2Coupons.state, //动作
											relaSeq : bo2Coupons.relaSeq, //关联序列	
											num	: bo2Coupons.num //第几个串码输入框
										};
										OrderInfo.attach2Coupons.push(coupon);
								}
							}
						
				}else if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S2" && this.busiObj.offerTypeCd=="2"){
					var offermap = this;
					var objInstId = "";
					$.each(order.memberChange.oldmembers.objInstId,function(){
						if(this.instId==offermap.busiObj.instId){
							objInstId = this.objInstId;
							return false;
						}
					});
					AttachOffer.delOffer(objInstId,this.busiObj.instId,"reload");
				}else if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="7"){//功能产品
					if(this.data.boServs[0].state=="ADD"){
						var offermap = this;
						var offerflag = false;
						$.each(AttachOffer.openServList,function(){
							if(this.prodId==offermap.data.boServOrders[0].servId){
								$.each(this.servSpecList,function(){
									if(this.servSpecId==offermap.data.boServOrders[0].servSpecId){
										offerflag = true;
										return false;
									}
								});
							}
						});
								if(!offerflag){
									var ifParams = "N";
									if(offermap.data.boServItems!=undefined){
										ifParams = "Y";
									}
									openServSpec(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId,offermap.data.boServOrders[0].servSpecName,ifParams);
									if(ifParams=="Y"){
										var spec = CacheData.getServSpec(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId);
										if(!!spec.prodSpecParams){
											for (var i = 0; i < spec.prodSpecParams.length; i++) {
												var param = spec.prodSpecParams[i];
												var itemSpec = CacheData.getServSpecParam(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId,param.itemSpecId);
												$.each(offermap.data.boServItems,function(){
													if(itemSpec.itemSpecId==this.itemSpecId){
														itemSpec.setValue = this.value;
													}
												});
											}
										}
										$("#can_"+this.busiObj.instId+"_"+offermap.data.boServOrders[0].servSpecId,param.itemSpecId).removeClass("canshu").addClass("canshu2");
										var attchSpec = CacheData.getServSpec(this.busiObj.instId,offermap.data.boServOrders[0].servSpecId,param.itemSpecId);
										attchSpec.isset = "Y";
									}
								}
							
					}else if(this.data.boServs[0].state=="DEL"){
						AttachOffer.closeServ(this.busiObj.instId,this.data.boServOrders[0].servId,"reload");
					}
				}
			});
			
			//退订可选包
			$.each(AttachOffer.openList,function(){
				var openmap = this;
				$.each(this.specList,function(){
					var offermap = this;
					var offerflag = false;
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1200" && this.boActionType.boActionTypeCd=="S1" && this.busiObj.offerTypeCd=="2"){
							if(this.busiObj.objId==offermap.offerSpecId){
								offerflag = true;
								return false;
							}
						}
					});
					if(!offerflag){
						AttachOffer.delOfferSpec(openmap.prodId,this.offerSpecId,"reload");
					}
				});
			});
			
			//退订功能产品
			$.each(AttachOffer.openServList,function(){
				var openmap = this;
				$.each(this.servSpecList,function(){
					var offermap = this;
					var offerflag = false;
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="7"){
							if(offermap.servSpecId==this.data.boServOrders[0].servSpecId && openmap.prodId==this.busiObj.instId){
								offerflag = true;
								return false;
							}
						}
					});
					if(!offerflag){
						var $span = $("#li_"+openmap.prodId+"_"+this.servSpecId).find("span"); //定位删除的附属
						var spec = CacheData.getServSpec(openmap.prodId,this.servSpecId);
						if(spec == undefined){ //没有在已开通附属销售列表中
							return;
						}
						$span.addClass("del");
						spec.isdel = "Y";
						AttachOffer.showHideUim(1,openmap.prodId,this.servSpecId);   //显示或者隐藏
						var serv = CacheData.getServBySpecId(openmap.prodId,this.servSpecId);
						if(ec.util.isObj(serv)){ //没有在已开通附属销售列表中
							$span.addClass("del");
							serv.isdel = "Y";
						}
					}
				});
			});
			//补换卡
			$.each(custOrderList,function(){
				if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="14"){
					var instId = this.busiObj.instId;
					$("#uim_check_btn_"+instId).attr("disabled",true);
					$("#uim_check_btn_"+instId).removeClass("purchase").addClass("disablepurchase");
					$("#uim_release_btn_"+instId).attr("disabled",false);
					$("#uim_release_btn_"+instId).removeClass("disablepurchase").addClass("purchase");
					$("#uim_txt_"+instId).attr("disabled",true);
					$.each(this.data.bo2Coupons,function(){
						if(this.state=="ADD"){
							$("#uim_txt_"+instId).val(this.terminalCode);
							var coupon = {
									couponUsageTypeCd : this.couponUsageTypeCd, //物品使用类型
									cardTypeFlag : this.cardTypeFlag,
									inOutTypeId : this.inOutTypeId,  //出入库类型
									inOutReasonId : this.inOutReasonId, //出入库原因
									saleId : this.saleId, //销售类型
									couponId : this.couponId, //物品ID
									couponinfoStatusCd : this.couponinfoStatusCd, //物品处理状态
									chargeItemCd : this.chargeItemCd, //物品费用项类型
									couponNum : this.couponNum, //物品数量
									storeId : this.storeId, //仓库ID
									storeName : this.storeName, //仓库名称
									agentId : this.agentId, //供应商ID
									apCharge : this.apCharge, //物品价格
									couponInstanceNumber : this.couponInstanceNumber, //物品实例编码
									terminalCode : this.terminalCode,//前台内部使用的UIM卡号
									ruleId : this.ruleId, //物品规则ID
									partyId : this.partyId, //客户ID
									prodId :  this.prodId, //产品ID
									offerId : this.offerId, //销售品实例ID
									state : this.state, //动作
									relaSeq : this.relaSeq //关联序列	
								};
							OrderInfo.clearProdUim(instId);
							OrderInfo.boProd2Tds.push(coupon);
						}
					});
				}
			});
		}
	};
	
	function _spec_member_parm(param){
		$.callServiceAsHtmlGet(contextPath + "/token/pad/order/orderSpecParam",param, {
			"done" : function(response){
				if(response && response.code == -2){
					if(param.prodId!=-1&&param.prodId!="-1"){
						$("#"+param.ul_id).append("<li><label> </label></li>");
					}
					return ;
				}else if(response && (response.data == 0||response.data == "0")){
					if(param.prodId!=-1&&param.prodId!="-1"){
						$("#"+param.ul_id).append("<li><label> </label></li>");
					}
					//$.alert("提示","该产品无产品规格属性！");
					return;
				}
				//$("#order_spec_parm").append(response.data);				
				$("#"+param.ul_id).append(response.data);
				//加载可选包		
				var pageagehtml = "<div class=\"optional\"> 可选包/功能产品 <a href=\"#optional_"+param.prodId+"\" data-role=\"button\" data-icon=\"optional\" data-iconpos=\"notext\" data-theme=\"i\" class=\"ui-link ui-btn ui-btn-i ui-icon-optional ui-btn-icon-notext ui-shadow ui-corner-all\">可选包/功能产品</a> </div>";
				$("#"+param.ul_id).append(pageagehtml);
			
				$.jqmRefresh($("#order_tab_panel_content"));
				
				//判断使用人产品属性是否必填
				_checkUsersProdAttr(param.prodId, $("#"+param.ul_id));
				
				//只有在新装的时候才可编辑“是否信控”产品属性
				var xkDom = $("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+param.prodId);
				if(xkDom.length == 1){
					//如果是6主副卡成员变更副卡加装，使副卡的信控属性与主卡保持一致
					if(OrderInfo.actionFlag == 6 || (OrderInfo.actionFlag==2 && offerChange.newMemberFlag)){
						var exist = false; 
						if(OrderInfo.prodInstAttrs && OrderInfo.prodInstAttrs.length){
							$.each(OrderInfo.prodInstAttrs, function(){
								if(this.itemSpecId==CONST.PROD_ATTR.IS_XINKONG){
									$(xkDom).val(this.value);
									exist = true;
								}					
							});
						}
						if(exist){
							$(xkDom).attr("disabled","disabled");
						} else {
//							$.alert("提示","查询主卡产品实例属性未获取到“是否信控”属性值");
							$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+param.prodId+" option[value='']").remove(); //去除“请选择”空值选项
							$(xkDom).val("20"); //默认为“是”
							if(OrderInfo.offerSpec.feeType == CONST.PAY_TYPE.BEFORE_PAY){ //“预付费”默认选是，且不可编辑
								$(xkDom).attr("disabled","disabled");
							}
						}
					} else if (OrderInfo.actionFlag != 1 && OrderInfo.actionFlag != 14){
						$(xkDom).attr("disabled","disabled");
					} else {
						$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+param.prodId+" option[value='']").remove(); //去除“请选择”空值选项
						$(xkDom).val("20"); //默认为“是”
						if(OrderInfo.offerSpec.feeType == CONST.PAY_TYPE.BEFORE_PAY){ //“预付费”默认选是，且不可编辑
							$(xkDom).attr("disabled","disabled");
						}
					}
				}
				
				//新装--二次加载(是否信控)处理
				$.each(OrderInfo.newOrderInfo.checkMaskList,function(){
					$("#"+CONST.PROD_ATTR.IS_XINKONG+"_"+this.prodId+"").find("option[value='"+this.isCheckMask+"']").attr("selected","selected");
				});
				//判断是否是预付费，是：修改信控信息
				if(OrderInfo.newOrderInfo.isReloadFlag=="N"){
					var feetype = $("select[name='pay_type_-1']").find("option:selected").val();
					if(feetype=="2100"){
						order.main.feeTypeCascadeChange($("select[name='pay_type_-1']"),'-1');
					}
				}
				//主副卡暂存单二次加载
				if(order.memberChange.reloadFlag=="N"||OrderInfo.newOrderInfo.isReloadFlag=="N"){				
					var custOrderList ="";//order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
					if(order.memberChange.rejson&&order.memberChange.rejson.orderList&&order.memberChange.rejson.orderList.custOrderList[0].busiOrder){
						custOrderList = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
					}else if(OrderInfo.newOrderInfo.result&&OrderInfo.newOrderInfo.result.orderList.custOrderList[0].busiOrder){
						custOrderList = OrderInfo.newOrderInfo.result.orderList.custOrderList[0].busiOrder;
					}
					$.each(custOrderList,function(){
						if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="1"){//纳入新成员
							//封装产品属性
							var newboProdItems = this.data.boProdItems;
							$("[name=prodSpec_"+this.busiObj.instId+"]").each(function(){
								var tagName = this.tagName;
								var itemSpecId=$(this).attr("id").split("_")[0];
								var newid = $(this).attr("id");
								for(var i=0;i<newboProdItems.length;i++){
									if(newboProdItems[i].itemSpecId == itemSpecId && newid.split("_")[1]==newboProdItems[i].prodSpecItemId){
										if(tagName=="SELECT"){
											$("#"+newid+" option[value='"+newboProdItems[i].value+"']").attr("selected","selected");
										}else{
											$("#"+newid).val(newboProdItems[i].value);
										}
									}
								}
							});
						}
					});
				}
			},
			fail:function(response){
				$.unecOverlay();
			}
		});
	}
	
	//初始化省内订单属性
	var _initOrderProvAttr = function(){
		if(order.cust.fromProvFlag == "1" && ec.util.isObj(order.cust.provIsale)){
			$("#orderProvAttrIsale").val(order.cust.provIsale);
		}
	};
	
	var _callBackBuildOrder=function(result,prodOfferId,prodOfferName){
		var busiOrders = result.orderList.custOrderList[0].busiOrder;
		//产品信息
		var acctCd="";
		var acctName = "";
		var acctId="";//帐户信息中帐户id
		var mailingType = "";
		var param1 = "";
		var param2 = "";
		var param3 = "";
		var param7 = "";
		var bankAcct = "";
		var bankId = "";
		var paymentMan = "";
		var paymentAcctTypeCd = "";
		
		//取缓存中的已选可选包和已选功能产品
		//处理在缓存中，却不在二次加载返回的参数中----已选可选包
		$.each(AttachOffer.openList,function(index,openList){
			$.each(openList.specList,function(i,specList){
				if(!order.service.compareOrder(busiOrders,specList.offerSpecId,openList.prodId)){
					AttachOffer.delOfferSpecReload(openList.prodId,specList.offerSpecId);
				}
			});				
		});
		//处理在缓存中，却不在二次加载返回的参数中----已选功能产品
		$.each(AttachOffer.openServList,function(index,openServList){
			$.each(openServList.servSpecList,function(i,servSpecList){
				var servSpecId = servSpecList.servSpecId;
				var servSpecName = servSpecList.servSpecName;
				if(!order.service.compareServOrder(busiOrders,servSpecId,openServList.prodId)){						
					AttachOffer.closeServSpecReload(openServList.prodId,servSpecId,servSpecName,servSpecList.ifParams)
				}
			});
		});
		
		$.each(busiOrders,function(index,busiOrder){
			//主副卡信息
			if(busiOrder.boActionType.actionClassCd==1300&&busiOrder.boActionType.boActionTypeCd=="1"){
				var prodId = busiOrder.busiObj.instId;
				var accessNumber = busiOrder.busiObj.accessNumber;//接入号
				var terminalCode = busiOrder.data.bo2Coupons[0].terminalCode;//uim卡号
				var feeType = busiOrder.data.boProdFeeTypes[0].feeType;//付费类型
				var prodPwTypeCd = busiOrder.data.boProdPasswords[0].prodPwTypeCd;
				var pwd = busiOrder.data.boProdPasswords[0].pwd;//产品密码
				//主卡才有是否信控
				var isCheckMask = "20";//默认信控
				if(busiOrder.data.boProdItems&&busiOrder.data.boProdItems[0].itemSpecId){
					var itemSpecId = busiOrder.data.boProdItems[0].itemSpecId;
					if(itemSpecId=="40010030"){//是否信控
						isCheckMask = busiOrder.data.boProdItems[0].value;
					}
					//是否信控放在OrderInfo.newOrderInfo.isCheckMask中				
					var checkMark = {};
					checkMark.itemSpecId = itemSpecId;
					checkMark.prodId = prodId;
					checkMark.isCheckMask = isCheckMask;
					OrderInfo.newOrderInfo.checkMaskList.push(checkMark);
					
					$("#"+itemSpecId+"_"+prodId+"").find("option[value='"+isCheckMask+"']").attr("selected","selected");
				}
				
				
				$("#nbr_btn_"+prodId).html(accessNumber+"<u></u>");
				var boProdAns={
						prodId : this.data.boProdAns[0].prodId, //从填单页面头部div获取
						accessNumber : this.data.boProdAns[0].accessNumber, //接入号
						anChooseTypeCd : this.data.boProdAns[0].anChooseTypeCd, //接入号选择方式,自动生成或手工配号，默认传2
						anId : this.data.boProdAns[0].anId, //接入号ID
						pnLevelId:this.data.boProdAns[0].pnLevelId,
						anTypeCd : this.data.boProdAns[0].anTypeCd, //号码类型
						state : this.data.boProdAns[0].state, //动作	,新装默认ADD	
						areaId:this.data.boProdAns[0].areaId,
						areaCode:this.data.boProdAns[0].areaCode,
						memberRoleCd:this.data.boProdAns[0].memberRoleCd,
						preStore:this.data.boProdAns[0].preStore,
						minCharge:this.data.boProdAns[0].minCharge
					};
				OrderInfo.boProdAns.push(boProdAns);
				order.dealer.changeAccNbr(this.data.boProdAns[0].prodId,this.data.boProdAns[0].accessNumber);//选号要刷新发展人管理里面的号码					
				//uim卡校验					
				$("#uim_txt_"+prodId).attr("disabled",true);
				$("#uim_txt_"+prodId).val(terminalCode);
				$("#uim_check_btn_"+prodId).attr("disabled",true);
				$("#uim_check_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
				$("#uim_release_btn_"+prodId).attr("disabled",false);
				$("#uim_release_btn_"+prodId).removeClass("disablepurchase").addClass("purchase");
				var coupon = {
						couponUsageTypeCd : this.data.bo2Coupons[0].couponUsageTypeCd, //物品使用类型
						inOutTypeId : this.data.bo2Coupons[0].inOutTypeId,  //出入库类型
						inOutReasonId : this.data.bo2Coupons[0].inOutReasonId, //出入库原因
						saleId : this.data.bo2Coupons[0].saleId, //销售类型
						couponId : this.data.bo2Coupons[0].couponId, //物品ID
						couponinfoStatusCd : this.data.bo2Coupons[0].couponinfoStatusCd, //物品处理状态
						chargeItemCd : this.data.bo2Coupons[0].chargeItemCd, //物品费用项类型
						couponNum : this.data.bo2Coupons[0].couponNum, //物品数量
						storeId : this.data.bo2Coupons[0].storeId, //仓库ID
						storeName : this.data.bo2Coupons[0].storeName, //仓库名称
						agentId : this.data.bo2Coupons[0].agentId, //供应商ID
						apCharge : this.data.bo2Coupons[0].apCharge, //物品价格
						couponInstanceNumber : this.data.bo2Coupons[0].couponInstanceNumber, //物品实例编码
						terminalCode : this.data.bo2Coupons[0].terminalCode,//前台内部使用的UIM卡号
						ruleId : this.data.bo2Coupons[0].ruleId, //物品规则ID
						partyId : this.data.bo2Coupons[0].partyId, //客户ID
						prodId :  this.data.bo2Coupons[0].prodId, //产品ID
						offerId : this.data.bo2Coupons[0].offerId, //销售品实例ID
						state : this.data.bo2Coupons[0].state, //动作
						relaSeq : this.data.bo2Coupons[0].relaSeq //关联序列	
					};
				OrderInfo.clearProdUim(this.busiObj.instId);
				OrderInfo.boProd2Tds.push(coupon);
				
				var payTypeOptions = $("select[name='pay_type_"+prodId+"']");
				$(payTypeOptions).find("option[value='"+feeType+"']").attr("selected","selected");
				$("#pwd_"+prodId).val(pwd);
			}
			//取订购套餐的公共信息
			if(busiOrder.boActionType.actionClassCd==1100&&busiOrder.boActionType.boActionTypeCd=="A1"){
				if(busiOrder.data.boAccountInfos.length>0){
					acctCd=busiOrder.data.boAccountInfos[0].acctCd;
					acctName = busiOrder.data.boAccountInfos[0].acctName;
					//将账单投递方式保存到公共变量中
					OrderInfo.newOrderInfo.acctCd=acctCd;
					OrderInfo.newOrderInfo.acctName=acctName;
				}
				if(busiOrder.data.boAccountMailings&&busiOrder.data.boAccountMailings.length>0){
					mailingType = busiOrder.data.boAccountMailings[0].mailingType;
					param1 = busiOrder.data.boAccountMailings[0].param1;
					param2 = busiOrder.data.boAccountMailings[0].param2;
					param3 = busiOrder.data.boAccountMailings[0].param3;
					param7 = busiOrder.data.boAccountMailings[0].param7;
					OrderInfo.newOrderInfo.mailingType=mailingType;
					OrderInfo.newOrderInfo.param1=param1;
					OrderInfo.newOrderInfo.param2=param2;
					OrderInfo.newOrderInfo.param3=param3;
					OrderInfo.newOrderInfo.param7=param7;
				}
				if(busiOrder.data.boPaymentAccounts&&busiOrder.data.boPaymentAccounts.length>0){
					bankAcct = busiOrder.data.boPaymentAccounts[0].bankAcct;
					bankId = busiOrder.data.boPaymentAccounts[0].bankId;
					limitQty = busiOrder.data.boPaymentAccounts[0].limitQty;
					paymentMan = busiOrder.data.boPaymentAccounts[0].paymentMan;
					paymentAcctTypeCd = busiOrder.data.boPaymentAccounts[0].paymentAcctTypeCd;
					OrderInfo.newOrderInfo.bankAcct=bankAcct;
					OrderInfo.newOrderInfo.bankId=bankId;
					OrderInfo.newOrderInfo.limitQty=limitQty;
					OrderInfo.newOrderInfo.paymentMan=paymentMan;
					OrderInfo.newOrderInfo.paymentAcctTypeCd=paymentAcctTypeCd;
				}
			}else if(busiOrder.boActionType.actionClassCd=="1300" && busiOrder.boActionType.boActionTypeCd=="1"){//当二次加载帐户信息不为新增帐户时
				if(busiOrder.data.boAccountRelas&&busiOrder.data.boAccountRelas.length>0){
					acctCd=busiOrder.data.boAccountRelas[0].acctCd;
					acctId=busiOrder.data.boAccountRelas[0].acctId;
				}
			}else{
				acctCd="";
			}
			//取缓存中的已选可选包和已选功能产品
			var openLists = AttachOffer.openList;
			var cloneOpenLists = $.extend(true, [], AttachOffer.openList);
			var openServLists = AttachOffer.openServList;
			var cloneOpenServLists =  $.extend(true, [], AttachOffer.openServList);
			//将二次加载回参做解析
			var resOpenLists = [];
			var resOpenServLists = [];				
			//可选包和功能产品
			if(busiOrder.boActionType.actionClassCd=="1200" && busiOrder.boActionType.boActionTypeCd=="S1"){
				var offermap = busiOrder;
				$.each(AttachOffer.openList,function(){
					if(this.prodId==offermap.data.ooRoles[0].prodId){
						var offerflag = false;
						$.each(this.specList,function(){
							if(this.offerSpecId==offermap.busiObj.objId){
								offerflag = true;
								return false;
							}
						});
						if(!offerflag){
							AttachOffer.addOfferSpecReload(this.prodId,offermap.busiObj.objId);
							//AttachOffer.addOpenList(offermap.data.ooRoles[0].prodId,offermap.busiObj.objId);							
							if(offermap.data.bo2Coupons!=undefined){
								for(var i=0;i<offermap.data.bo2Coupons.length;i++){
									var bo2Coupons = offermap.data.bo2Coupons[i];
									if(i==0){
										$("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num).val(bo2Coupons.couponInstanceNumber);
										AttachOffer.checkTerminalCodeReload($("#terminalBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num));
									}else{
										AttachOffer.addAndDelTerminal($("#terminalAddBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId));
										$("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num).val(bo2Coupons.couponInstanceNumber);
										AttachOffer.checkTerminalCodeReload($("#terminalBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num));
									}
									var coupon = {
											couponUsageTypeCd : bo2Coupons.couponUsageTypeCd, //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
											inOutTypeId : bo2Coupons.inOutTypeId,  //出入库类型
											inOutReasonId : bo2Coupons.inOutReasonId, //出入库原因
											saleId : bo2Coupons.saleId, //销售类型
											couponId : bo2Coupons.couponId, //物品ID
											couponinfoStatusCd : bo2Coupons.couponinfoStatusCd, //物品处理状态
											chargeItemCd : bo2Coupons.chargeItemCd, //物品费用项类型
											couponNum : bo2Coupons.couponNum, //物品数量
											storeId : bo2Coupons.storeId, //仓库ID
											storeName : bo2Coupons.storeName, //仓库名称
											agentId : bo2Coupons.agentId, //供应商ID
											apCharge : bo2Coupons.apCharge, //物品价格,约定取值为营销资源的
											couponInstanceNumber : bo2Coupons.couponInstanceNumber, //物品实例编码
											ruleId : bo2Coupons.ruleId, //物品规则ID
											partyId : bo2Coupons.partyId, //客户ID
											prodId : bo2Coupons.prodId, //产品ID
											offerId : bo2Coupons.offerId, //销售品实例ID
											attachSepcId : bo2Coupons.attachSepcId,
											state : bo2Coupons.state, //动作
											relaSeq : bo2Coupons.relaSeq, //关联序列	
											num	: bo2Coupons.num //第几个串码输入框
										};
										OrderInfo.attach2Coupons.push(coupon);
										//AttachOffer.checkTerminalCodeReload($("#terminalAddBtn_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId+"_"+bo2Coupons.num));
								}
							}
						}
					}
				});
				
				//老用户纳入
				if(offermap.data.ooRoles[0].prodId>0){
					AttachOffer.addOfferSpecReload(offermap.data.ooRoles[0].prodId,offermap.busiObj.objId);
				}
			}else if(busiOrder.boActionType.actionClassCd=="1300" && busiOrder.boActionType.boActionTypeCd=="7"){
				if(busiOrder.data.boServs[0].state=="ADD"){
					var offermap = busiOrder;
					$.each(AttachOffer.openServList,function(){
						if(this.prodId==offermap.busiObj.instId){
							var offerflag = false;
							$.each(this.servSpecList,function(){
								if(this.servSpecId==offermap.data.boServOrders[0].servSpecId){
									offerflag = true;
									return false;
								}
							});
							if(!offerflag){
								var ifParams = "N";
								if(offermap.data.boServItems!=undefined){
									ifParams = "Y";
								}
								AttachOffer.openServSpecReload(this.prodId,offermap.data.boServOrders[0].servSpecId,offermap.data.boServOrders[0].servSpecName,ifParams);
								
							}
						}
					});
					
					//老用户纳入
					if(offermap.busiObj.instId>0){
						var ifParams = "N";
						if(offermap.data.boServItems!=undefined){
							ifParams = "Y";
						}
						AttachOffer.openServSpecReload(offermap.busiObj.instId,offermap.data.boServOrders[0].servSpecId,offermap.data.boServOrders[0].servSpecName,ifParams);
					}
					
				}
			}
			
			if(acctCd!=""&&acctCd!=-1){
				var acctQueryParam = {
					"acctCd" : acctCd,
					"isServiceOpen":"Y"
				};
				
				$.callServiceAsJson(contextPath+"/order/account", acctQueryParam, {
					"before":function(){
						$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
					},
					"always":function(){
						$.unecOverlay();
					},
					"done" : function(response){
						if(response.code==-2){
							$.alertM(response.data);
							return;
						}
						if(response.code==0){
							var accountInfo = response.data.accountInfos;
							var returnMap = response.data;
							var found = false;	
							if(returnMap.resultCode==0){
								if(returnMap.accountInfos && returnMap.accountInfos.length > 0){
									$("#accountDiv").find("label:eq(0)").text("主卡帐户：");
									//将对应的帐号添加进去
									$.each(response.data.accountInfos, function(i, custAcct){
										if(acctId==custAcct.acctId){
											accountInfo=custAcct;
											//创建节点
											$("<option>").text(custAcct.name+" : "+custAcct.accountNumber).attr("value",custAcct.acctId)
											.attr("acctcd",custAcct.accountNumber).appendTo($("#acctSelect"));
											
											//选中节点
											$("#acctSelect").find("option[value="+custAcct.acctId+"]").attr("selected","selected");
											found = true;
											return false;
										}
									});
									$("#accountDiv").find("a:eq(0)").hide();
									$("#acctSelect").find("option[value='-1']").remove();//将新增的选项进行删除
									$("#acctSelect").parent().find("a:eq(1)").show();//显示帐户信息按钮
									$("#defineNewAcct").hide();//隐藏新增帐户对应内容
								}else{//未查询到帐户信息
								    $.alert("提示","没有查询到帐户合同号对应的帐户信息");
								}
							}else{
								$.alertM(returnMap.resultMsg);
							}	
							
							$(this).dispatchJEvent("chooseAcct",accountInfo);
							//隐藏
							$("#defineNewAcct").hide();
						}
						else{
							$("<tr><td colspan=4>"+response.data+"</td</tr>").appendTo($("#acctListTab tbody"));
						}
						$("#acctListTab tr").off("click");				
					}			
				});
			}
			
			//获取订单信息和经办人信息
			var orderListInfo = result.orderList.orderListInfo;
			var isTemplateOrder = orderListInfo.isTemplateOrder;
			var custOrderAttrs = orderListInfo.custOrderAttrs;
			var orderRemark="";
			var orderAttrName="";
			var orderAttrPhoneNbr="";
			var orderPartyTypeCd = "1";//TODO 需要查询的客户信息中获取
			var orderIdentidiesTypeCd="";
			var orderAttrIdCard="";
			var orderAttrAddr="";
			$.each(custOrderAttrs,function(index,custOrderAttr){
				if(custOrderAttr.itemSpecId=="111111118"){
					//备注 
					orderRemark = custOrderAttr.value;
				}else if(custOrderAttr.itemSpecId=="30010020"){
					//经办人姓名 
					orderAttrName = custOrderAttr.value;
				}else if(custOrderAttr.itemSpecId=="30010025"){
					// 经办人联系人号码 
					orderAttrPhoneNbr = custOrderAttr.value;
				}else if(custOrderAttr.itemSpecId=="30010026"){
					// 经办人证件类型 
					orderIdentidiesTypeCd = custOrderAttr.value;
				}else if(custOrderAttr.itemSpecId=="30010021"){
					// 经办人证件号码 
					orderAttrIdCard = custOrderAttr.value;
				}else if(custOrderAttr.itemSpecId=="30010022"){
					//经办人证件地址 
					orderAttrAddr = custOrderAttr.value;
				}
			});
			$("#order_remark").val(orderRemark);//备注信息
			//判断是否需要模板
			if(isTemplateOrder=="Y"){
				$("#isTemplateOrder").css("checked",true);
				var templateOrderName = orderListInfo.templateOrderName;
				var templateType = orderListInfo.templateType;
				$(".template_info_name").show();
				$(".template_info_type").show();
				$("#isActivation").removeAttr("checked");
				$("#isActivation").attr("disabled","disabled");
				$("#templateOrderName").val(templateOrderName);
				$("#template_info_type").find("option[value='"+templateType+"']").attr("selected", true);
			};	
			
		//经办人
		$("#orderAttrName").val(orderAttrName);
		$("#orderPartyTypeCd").find("option[value='"+orderPartyTypeCd+"']").attr("selected", true);
		$("#orderAttrPhoneNbr").val(orderAttrPhoneNbr);
		$("#orderIdentidiesTypeCd").find("option[value='"+orderIdentidiesTypeCd+"']").attr("selected", true);
		$("#orderAttrIdCard").val(orderAttrIdCard);
		$("#orderAttrAddr").val(orderAttrAddr);
	});
	
	//管理属性 发展人
	$("#dealerTbody").empty();
	order.service.dealDevelopingPerson(busiOrders,OrderInfo.newOrderInfo.prodOfferId,OrderInfo.newOrderInfo.prodOfferName);
	//清空新装二次加载标识
	//OrderInfo.newOrderInfo.isReloadFlag="";
}	
	//判断使用人产品属性是否必填，mantis 0147689: 关于政企单位用户实名制信息录入相关工作的要求 ；
	function _checkUsersProdAttr(prodId, dom){
		//1）新建客户新装，如果是政企客户，填单时必须填写使用人；
		//2）老客户新装，根据客户查询判断是政企客户（segmentId=1000）时，填单必须填写使用人；
		var itemId = CONST.PROD_ATTR.PROD_USER + '_' + prodId;
		if($('#'+itemId).length > 0){
			// 屏蔽使用人
			if(OrderInfo.actionFlag == 1){//新装才屏蔽
				$('#'+itemId).attr({'readonly':'readonly','disabled':'disabled'}).hide();
				$('#'+itemId).attr({'readonly':'readonly','disabled':'disabled'}).parent().parent().parent().parent().hide();
				$('#choose_user_btn_'+prodId).off('click').hide();
				$('#choose_user_btn_'+prodId).parent().hide();

				if(OrderInfo.actionFlag == 6 || OrderInfo.actionFlag==2){//主副卡成员变更
					$('#MEMBERDIV_'+prodId).hide();					
				}

			}
			
			if(OrderInfo.actionFlag == 6){//主副卡成员变更
				$('#MEMBERDIV_'+prodId).hide();					
			}
		}
	};
	
	return {
		buildMainView 		: _buildMainView,
		spec_parm			: _spec_parm,
		spec_member_parm 	: _spec_member_parm,
		check_parm			: _check_parm,
		queryScroll			: _queryScroll,
		queryStaff			: _queryStaff,
		queryStaffPage		: _queryStaffPage,
		setStaff			: _setStaff,
		chooseAcct 			: _chooseAcct,
		check_parm_self		: _check_parm_self,
		createAcct 			: _createAcct,
		createAcctWithId    :_createAcctWithId,
		showNewAcct 		: _showNewAcct,
		acctDetail 			: _acctDetail,
		//spec_parm_change: _spec_parm_change,
		spec_parm_change_save:_spec_parm_change_save,
		//spec_password_change:_spec_password_change,
		//spec_password_change_save:_spec_password_change_save,
		paymethodChange		:_paymethodChange,
		templateTypeCheck	:_templateTypeCheck,
		lastStep 			: _lastStep,
		genRandPass6		:_genRandPass6,
		genRandPass6Input	:_genRandPass6Input,
		passwordCheckInput	:_passwordCheckInput,
		passwordCheckVal	:_passwordCheckVal,
		checkIncreace6		:_checkIncreace6,
		feeTypeCascadeChange:_feeTypeCascadeChange,
		newProdReload       :_newProdReload,
		loadAttachOffer		:_loadAttachOffer,
		reload				:_reload,
		initAcct:_initAcct
	};
})();


/**
 * 发展人管理
 * 
 * @author wukf
 * date 2014-01-20
 */
CommonUtils.regNamespace("order","dealer");

/** 发展人对象*/
order.dealer = (function() {
	//初始化发展人
	var _initDealer = function(prodInfo) {
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":"40020005","NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":"40020006","NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":"40020007","NAME":"第三发展人"}];
		}else{
			$.ecOverlay("<strong>正在查询发展人类型中,请稍后....</strong>");
			var response = $.callServiceAsJson(contextPath+"/order/queryPartyProfileSpecList",null); //发展人类型查询
			$.unecOverlay();
			if(response.code==0){
				OrderInfo.order.dealerTypeList = response.data;
			}else if(response.code==-2){
				$.alertM(response.data);
				return;
			}else{
				$.alert("信息提示",response.msg);
				return;
			}
			if(!ec.util.isArray(OrderInfo.channelList)||OrderInfo.channelList.length==0){
				OrderInfo.getChannelList();
			}
		}		
		
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==2 || OrderInfo.actionFlag==14){ //新装业务，套餐变更需要主套餐发展人
			var objInstId = OrderInfo.offerSpec.offerSpecId;
			var $li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
			var $dl= $("<dl></dl>");
			var $tdType = $('<dd> </dd>');
			var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
			if(order.ysl!=undefined){
				$select.append("<option value='40020005'>第一发展人</option>");
				$select.append("<option value='40020006'>第二发展人</option>");
				$select.append("<option value='40020007'>第三发展人</option>");
			}else{
				$.each(OrderInfo.order.dealerTypeList,function(){
					$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
				});
			}
			$field.append($select);
			$tdType.append($field);
			var accNbr = "主套餐";
			$dl.append("<dd>"+accNbr+"</dd>");
			$dl.append("<dd>"+OrderInfo.offerSpec.offerSpecName+"（包含接入产品）</dd>");
			$dl.append($tdType);
			//判断是否
			if(OrderInfo.salesCode!=null && OrderInfo.salesCode!="" && OrderInfo.salesCode!="null" && OrderInfo.salesCode!=undefined){
				var param = {
						"dealerId":"",
						"areaId":"",
						"currentAreaAllName":"",
						"staffName":"",
						"staffCode":OrderInfo.salesCode,
						"staffCode2":OrderInfo.salesCode,
						"salesCode":"",
						"pageIndex":1,
						"objInstId":objInstId,
						"pageSize":10
				};
				var url=contextPath+"/token/pad/staffMgr/getStaffList";
				$.ecOverlay("<strong>正在查询发展人的服务中,请稍后....</strong>");
				var response = $.callServiceAsJson(url,param);	
				$.unecOverlay();
				var code=response.code;
                if(code==0){
                	var data=response.data.result;
                	OrderInfo.staff.staffId=data[0].staffId;
                	OrderInfo.staff.staffName=data[0].staffName;
                }
			}
			if(order.ysl!=undefined){
				var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true"></input></dd>');
				$dl.append($dd);
			}else{
				var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');
				$dl.append($dd);
			}

			var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
			$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
			$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</button></div></div></dd>';
			$dl.append($button);
			//发展渠道
			var $tdChannel = $('<dd></dd>');
			var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
			if(OrderInfo.provinceInfo.reloadFlag=="N"){
				//获取编码
				var busiOrders = OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;
				var channelNbr="";
				for(var i=0;i<busiOrders.length;i++){
					if(busiOrders[i].boActionType.actionClassCd=="1200" && busiOrders[i].boActionType.boActionTypeCd=="S1" && busiOrders[i].busiObj.offerTypeCd=="1"){
						var busiOrderAttrs=busiOrders[i].data.busiOrderAttrs;
						for(var j=0;j<busiOrderAttrs.length;j++){
							if(busiOrderAttrs[j].channelNbr!=undefined){
								channelNbr=busiOrderAttrs[j].channelNbr;
								break;
							}
						}
					}
				}
				for(var i=0;i<OrderInfo.channelList.length;i++){
					if(OrderInfo.channelList[i].channelNbr==channelNbr){
						$channelSelect.append("<option value='"+OrderInfo.channelList[i].channelNbr+"' selected ='selected'>"+OrderInfo.channelList[i].channelName+"</option>");
					}
					else{
						$channelSelect.append("<option value='"+OrderInfo.channelList[i].channelNbr+"'>"+OrderInfo.channelList[i].channelName+"</option>");
					}
				}
			}
			else{
				$.each(OrderInfo.channelList,function(){
						if(this.isSelect==1)
							$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
						else
							$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
				
				});
			}
			$tdChannel.append($channelSelect);
			$tdChannel.append('<label class="f_red">*</label>');
			$dl.append($tdChannel);
			$li.append($dl);
			OrderInfo.SEQ.dealerSeq++;
			$("#dealerTbody").append($li);
			$.jqmRefresh($("#dealerTbody"));
		}
		if(OrderInfo.actionFlag==6 ){ //加装需要接入产发展人
			//判断是否
			if(OrderInfo.salesCode!=null && OrderInfo.salesCode!="" && OrderInfo.salesCode!="null" && OrderInfo.salesCode!=undefined){
				var param = {
						"dealerId":"",
						"areaId":"",
						"currentAreaAllName":"",
						"staffName":"",
						"staffCode":OrderInfo.salesCode,
						"staffCode2":OrderInfo.salesCode,
						"salesCode":"",
						"pageIndex":1,
						"objInstId":objInstId,
						"pageSize":10
				};
				var url=contextPath+"/token/pad/staffMgr/getStaffList";
				$.ecOverlay("<strong>正在查询发展人的服务中,请稍后....</strong>");
				var response = $.callServiceAsJson(url,param);	
				$.unecOverlay();
				var code=response.code;
                if(code==0){
                	var data=response.data.result;
                	OrderInfo.staff.staffId=data[0].staffId;
                	OrderInfo.staff.staffName=data[0].staffName;
                }
			}
			if(order.memberChange.newMemberFlag){
				$.each(OrderInfo.offerSpec.offerRoles,function(){
		    		$.each(this.prodInsts,function(){
		    			var objInstId = this.prodInstId;
		    			var $li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
		    			var $dl= $("<dl></dl>");
		    			var $tdType = $('<dd></dd>');
		    			var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
		    			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
		    			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		    			$.each(OrderInfo.order.dealerTypeList,function(){
		    				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
		    			});
		    			$field.append($select);
		    			$tdType.append($field);
						var accNbr = "未选号";
						if(this.accNbr!=undefined && this.accNbr!=""){
							accNbr = prodInst.accNbr;
						}
						$dl.append("<dd>"+accNbr+"</dd>");
						$dl.append("<dd>"+this.objName+"</dd>");
						$dl.append($tdType);
						var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');
						$dl.append($dd);
						var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
						$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
						$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</button></div></div></dd>';
						$dl.append($button);
						//发展渠道
						var $tdChannel = $('<dd></dd>');
						var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
						if(order.memberChange.reloadFlag=="N"){
							//获取编码
							var busiOrders = order.memberChange.rejson.orderList.custOrderList[0].busiOrder;
							var channelNbr="";
							for(var i=0;i<busiOrders.length;i++){
								if(busiOrders[i].boActionType.actionClassCd=="1300" && busiOrders[i].boActionType.boActionTypeCd=="1"){
									var busiOrderAttrs=busiOrders[i].data.busiOrderAttrs;
									for(var j=0;j<busiOrderAttrs.length;j++){
										if(busiOrderAttrs[j].channelNbr!=undefined){
											channelNbr=busiOrderAttrs[j].channelNbr;
											break;
										}
									}
								}
							}
							for(var i=0;i<OrderInfo.channelList.length;i++){
								if(OrderInfo.channelList[i].channelNbr==channelNbr){
									$channelSelect.append("<option value='"+OrderInfo.channelList[i].channelNbr+"' selected ='selected'>"+OrderInfo.channelList[i].channelName+"</option>");
								}
								else{
									$channelSelect.append("<option value='"+OrderInfo.channelList[i].channelNbr+"'>"+OrderInfo.channelList[i].channelName+"</option>");
								}
							}
						}
						else{
							$.each(OrderInfo.channelList,function(){
								if(this.isSelect==1)
									$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
								else
									$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
							});
						}
						$tdChannel.append($channelSelect);
						$tdChannel.append('<label class="f_red">*</label>');
						$dl.append($tdChannel);
						$li.append($dl);
						OrderInfo.SEQ.dealerSeq++;
						$("#dealerTbody").append($li);
						$.jqmRefresh($("#dealerTbody"));
		    		});
		    	});
			}
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					var objInstId = this.offerSpecId;
	    			var $li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
	    			var $dl= $("<dl></dl>");
	    			var $tdType = $('<dd></dd>');
	    			var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
	    			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
	    			var flag = true;
					$.each(OrderInfo.order.dealerTypeList,function(){
						var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
						$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
							if(dealerTypeId==$(this).val()){  //如果已经存在
								flag = false;
							}
						});
					});
					if(!flag){
						return;
					}
					
					var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
	    			if(order.ysl!=undefined){
						$select.append("<option value='40020005'>第一发展人</option>");
						$select.append("<option value='40020006'>第二发展人</option>");
						$select.append("<option value='40020007'>第三发展人</option>");
					}else{
						$.each(OrderInfo.order.dealerTypeList,function(){
							$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
						});
					}
				
	    			$field.append($select);
	    			$tdType.append($field);
	    			var accNbr = "主套餐";					
					$dl.append("<dd>"+accNbr+"</dd>");
					$dl.append("<dd>"+this.offerSpecName+"包含接入产品）</dd>");				
					$dl.append($tdType);
					if(order.ysl!=undefined){
						var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true"></input></dd>');
					}else{
						var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly"></input></dd>');
					}
					
					$dl.append($dd);
					var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
					$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
					$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</button></div></div></dd>';
					$dl.append($button);
					//发展渠道
					var $tdChannel = $('<dd></dd>');
					var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
					$.each(OrderInfo.channelList,function(){
						if(this.isSelect==1)
							$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
						else
							$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
					});
					$tdChannel.append($channelSelect);
					$tdChannel.append('<label class="f_red">*</label>');
					$dl.append($tdChannel);
					$li.append($dl);
					OrderInfo.SEQ.dealerSeq++;
					$("#dealerTbody").append($li);				
					$.jqmRefresh($("#dealerTbody"));
				});
			}
		}
		if(OrderInfo.actionFlag==13){ //裸机销售需要发展人
			var objInstId = $("#mktResId").val();
			var $li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
			var $dl= $("<dl></dl>");
			var $tdType = $('<dd></dd>');
			var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
			var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
			$.each(OrderInfo.order.dealerTypeList,function(){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			});
			$field.append($select);
			$tdType.append($field);
			$dl.append($tdType);
			var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly" ></input></dd>');
			$dl.append($dd);
			var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
			$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
			$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</button></div></div></dd>';
			$dl.append($button);
			$li.append($dl);
			OrderInfo.SEQ.dealerSeq++;
			$("#dealerMktTbody").append($li);
			$.jqmRefresh($("#dealerMktTbody"));
		}
		
		if(OrderInfo.actionFlag==21){//副卡套餐变更		
			if(ec.util.isArray(OrderInfo.viceOfferSpec)){
				$.each(OrderInfo.viceOfferSpec,function(){
					var objInstId = this.offerSpecId;
	    			var $li = $("<li id='tr_"+objInstId+"' name='tr_"+objInstId+"'></li>");
	    			var $dl= $("<dl></dl>");
	    			var $tdType = $('<dd></dd>');
	    			var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
	    			var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
	    			var flag = true;
					$.each(OrderInfo.order.dealerTypeList,function(){
						var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
						$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
							if(dealerTypeId==$(this).val()){  //如果已经存在
								flag = false;
							}
						});
					});
					if(!flag){
						return;
					}
					
					var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'" data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
	    			if(order.ysl!=undefined){
						$select.append("<option value='40020005'>第一发展人</option>");
						$select.append("<option value='40020006'>第二发展人</option>");
						$select.append("<option value='40020007'>第三发展人</option>");
					}else{
						$.each(OrderInfo.order.dealerTypeList,function(){
							$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
						});
					}
				
	    			$field.append($select);
	    			$tdType.append($field);
	    			var accNbr = "主套餐";					
					$dl.append("<dd>"+accNbr+"</dd>");
					$dl.append("<dd>"+this.offerSpecName+"包含接入产品）</dd>");				
					$dl.append($tdType);
					if(order.ysl!=undefined){
						var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true"></input></dd>');
					}else{
						var $dd = $('<dd><input type="text" id="dealer_'+objId+'" staffId="'+OrderInfo.staff.staffId+'" value="'+OrderInfo.staff.staffName+'" data-mini="true" readonly="readonly"></input></dd>');
					}
					
					$dl.append($dd);
					var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
					$button+='<button data-mini="ture" onclick="javascript:order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
					$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,'+objInstId+',1)">添加</button></div></div></dd>';
					$dl.append($button);
					$li.append($dl);
					OrderInfo.SEQ.dealerSeq++;
					$("#dealerTbody").append($li);				
					$.jqmRefresh($("#dealerTbody"));
				});
			}
		}	
	};
	
	//修改发展人角色
	var _changeDealer = function(select,objInstId,value){
		var i = 0;
		$("select[name="+objInstId+"]").each(function(){
			if($(this).val() == $(select).val()){
				i++;
			}
		});
		if(i>1){
			$.alert("信息提示","每个业务的发展人类型不能重复");
			$(select).val(value);
		}
	};
	
	//点击确认，添加附属销售品发展人
	var _addAttachDealer = function(){
		$("input[name=attach_dealer]:checked").each(function(){	
			var id = $(this).attr("id");	
			var prodId = id.split("_")[0];
			if($("#tr_"+id)[0]==undefined){ //没有添加过
				var objId = id+"_"+OrderInfo.SEQ.dealerSeq;
				var $tdType = _getDealerType(id,objId);
				if($tdType==undefined){
					return false;
				}
				var $tr = $("#atr_"+id);
				var $li = $('<li name="tr_'+id+'"></li>');
				var $dl= $("<dl></dl>");
				$dl.append("<dd>"+$tr.children().eq(1).text()+"</dd>");
				$dl.append("<dd>"+$tr.children().eq(2).text()+"</dd>");
				$dl.append($tdType);
				
				var dealer = $("#tr_"+prodId).find("input"); //产品协销人
				var staffId = 1;
				var staffName = "";
				if(dealer[0]==undefined){
					staffId = OrderInfo.staff.staffId;
					staffName = OrderInfo.staff.staffName;
				}else {
					staffId = dealer.attr("staffId");
					staffName = dealer.attr("value");
				}
				if(order.ysl!=undefined){
					var $dd = $('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'"  data-mini="true"></input></dd>');
					$dl.append($dd);
				}else{
					var $dd = $('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'"  data-mini="true"  readonly="readonly"></input></dd>');
					$dl.append($dd);
				}
				var $button='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';
				$button+='<button data-mini="ture" onclick="order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
				$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+id+'\')">添加</button></div>';
				$button+=' <div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';			
				$dl.append($button);
				//发展渠道
				var $tdChannel = $('<dd></dd>');
				var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
				$.each(OrderInfo.channelList,function(){
					if(this.isSelect==1)
						$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
					else
						$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
				});
				$tdChannel.append($channelSelect);
				$tdChannel.append('<label class="f_red">*</label>');
				$dl.append($tdChannel);
				$li.append($dl);
				$("#dealerTbody").append($li);
				$.jqmRefresh($("#dealerTbody"));
				OrderInfo.SEQ.dealerSeq++;
			}	
		});
		$("#div_attach_choose").popup("close");
	};
	
	//添加一行产品协销人
	var _addProdDealer = function(obj,objInstId,type){
		var $oldTr = $(obj).parent().parent().parent().parent().parent();
		var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
		var $tdType = _getDealerType(objInstId,objId);
		if($tdType==undefined){
			return;
		}
		var $li = $('<li name="tr_'+objInstId+'"></li>');
		var $dl= $("<dl></dl>");
		if (OrderInfo.actionFlag != 13) {
			$dl.append("<dd>"+$oldTr.find("dd").eq(0).text()+"</dd>");
			$dl.append("<dd>"+$oldTr.find("dd").eq(1).text()+"</dd>");
		}
		$dl.append($tdType);
		if(order.ysl!=undefined){
			var $dd = $('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+objInstId+'" staffId="'+$oldTr.find("input").attr("staffId")+'" value="'+$oldTr.find("input").attr("value")+'"  data-mini="true"></input></dd>');
			$dl.append($dd);
		}else{
			var $dd = $('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+objInstId+'" staffId="'+$oldTr.find("input").attr("staffId")+'" value="'+$oldTr.find("input").attr("value")+'"  data-mini="true"  readonly="readonly"></input></dd>');
			$dl.append($dd);
		}
		var $button='<dd class="ui-grid"><div class="ui-grid-a"><div class="ui-block-a">';
		$button+='<button data-mini="ture" onclick="order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
		$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';			
		$dl.append($button);
		//发展渠道
		var $tdChannel = $('<dd></dd>');
		var selectChanne=$oldTr.find("dd select[name='dealerChannel_"+objInstId+"']").clone();
        $(selectChanne).attr("id","dealerChannel_"+objId);
		
		$(selectChanne).empty(); 
		var $channelListOptions ="";
		$($oldTr.find("dd select[name='dealerChannel_"+objInstId+"']")).find("option").each(function(){
			var $channelListOptionVal  = $(this).val() ; 
			var $channelListOptionName = $(this).html() ; 
			if(this.selected==true){
				$channelListOptions += "<option value='"+$channelListOptionVal+"' selected ='selected'>"+$channelListOptionName+"</option>";
			}else{
				$channelListOptions += "<option value='"+$channelListOptionVal+"'>"+$channelListOptionName+"</option>";
			}
		});
		$(selectChanne).append($channelListOptions);
		$tdChannel.append(selectChanne);
		$tdChannel.append('<label class="f_red">*</label>');
		$dl.append($tdChannel);
		$li.append($dl);	
		$oldTr.after($li);
		$.jqmRefresh($("#dealerTbody"));
		OrderInfo.SEQ.dealerSeq++;
	};
	
	//改变发展人号码
	var _changeAccNbr = function(prodId,accNbr){
		$("li[name^='tr_"+prodId+"']").each(function(){
			$(this).find("dd").eq(0).text(accNbr);
		});
	};
	
	//校验发展人类型,并获取发展人类型列表
	var _getDealerType = function(objInstId,objId){
		var dealerType = "";
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":40020005,"NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":40020006,"NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":40020007,"NAME":"第三发展人"}];
		}
		if(OrderInfo.order.dealerTypeList!=undefined && OrderInfo.order.dealerTypeList.length>0){ //发展人类型列表
			$.each(OrderInfo.order.dealerTypeList,function(){
				var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
				var flag = true;
				$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
					if(dealerTypeId==$(this).val()){  //如果已经存在
						flag = false;
						return false;
					}
				});
				if(flag){ //如果发展人类型没有重复
					dealerType = dealerTypeId;
					return false;
				}
			});
		}else{
			$.alert("信息提示","没有发展人类型");
			return;
		}
		if(dealerType==undefined || dealerType==""){	
			$.alert("信息提示","每个业务发展人类型不能重复");
			return;
		}
		var $tdType = $('<dd></dd>');
		var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
		var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
		var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		$.each(OrderInfo.order.dealerTypeList,function(){
			if(this.PARTYPRODUCTRELAROLECD==dealerType){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>");
			}else{
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			}
		});
		$field.append($select);
		$tdType.append($field);
		return $tdType;
	};
	
	//显示已经受理的业务列表
	var _showOfferList = function(){	
		$('#attach_pop').empty();
		
		//可选包
		var $pop=$('<div id="div_attach_choose"  data-role="popup" data-transition="slideup" data-corners="false" data-overlay-theme="b" class="popwindow" data-dismissible="false"></div>');
		$pop.append('<div data-role="header" data-theme="t"> <a href="#" id="order_dealer_btn" data-role="button" data-icon="back" data-rel="back" data-iconpos="notext" class="ui-btn-right">返回</a><h1>发展人管理</h1></div>');
		var $content=$('<div data-role="content"></div>');
		var $table=$('<table class="searchtable"></table>');
		$table.append('<tr><th>操作</th><th>号码</th><th>发展业务</th></tr>');
		
		$.each(AttachOffer.openList,function(){
			
			var prodId = this.prodId;
			var accNbr = OrderInfo.getAccessNumber(prodId);
			
			if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
				for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
					if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
						accNbr = OrderInfo.oldprodInstInfos[i].accNbr;
					}
				}
			}else{
				accNbr = OrderInfo.getAccessNumber(prodId);
			}
			
			if(accNbr==undefined || accNbr==""){ 
				accNbr = "未选号";
			}
			
			$.each(this.specList,function(){
				var id = prodId+'_'+this.offerSpecId;
				if(this.isdel != "Y" && this.isdel != "C" && $("li[name='tr_"+id+"']")[0]==undefined){  //订购的附属销售品	
					var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"></tr>');
					//var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"><td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td></tr>');
					$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td>');
					$tr.append('<td>'+accNbr+'</td><td>'+this.offerSpecName+'</td>');
					$table.append($tr);
				};
			});
		});
		
		//预受理
		if(order.ysl!=undefined){
			if(order.ysl.yslbean.yslflag!=undefined){
				for (var j = 0; j < order.ysl.openList.length; j++) {
					if(order.ysl.openList[j].type=="1"){
						var prodId = "-1";
						var accNbr = $("#choosedNumSpan").val();
						if(accNbr==undefined || accNbr==""){ 
							accNbr = "未选号";
						}
						var dealerchecked = "N";
						var dealertr = $("#dealerTbody").find("tr");
						dealertr.each(function(){
							if($(this).attr("name")=="tr_-1_"+order.ysl.openList[j].id){
								dealerchecked = "Y";
							}else{
								dealerchecked = "N";
							}
						});
						if(dealerchecked=="N"){
							var id = prodId+'_'+order.ysl.openList[j].id;
							var $tr = $('<tr id="atr_'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')"></tr>');
							$tr.append('<td><input type="checkbox" id="'+id+'" onclick="order.dealer.checkAttach(\''+id+'\')" name="attach_dealer"/></td>');
							$tr.append('<td>'+accNbr+'</td><td>'+order.ysl.openList[j].name+'</td>');
							$table.append($tr);
						}
					}
				}
			}
		}
		
		$content.append($table);
		var $footer='<div data-role="footer" data-position="inline" data-tap-toggle="false" data-theme="n"> <button data-inline="true" data-icon="next" id="sureAdddealer">确定</button>';
		$footer+='<button data-inline="true" data-icon="back" data-rel="back" id="closeAdddealer">取消</button></div>';
		$pop.append($content);
		$pop.append($footer);
		//$('#attach_pop').append($pop);
		//统一弹出框
		var popup = $.popup("#div_attach_choose",$pop,{
			width:800,
			height:$(window).height(),
			contentHeight:$(window).height()-120,
			afterClose:function(){}
		});
		$("#sureAdddealer").off("tap").on("tap",function(){_addAttachDealer();});
		$("#closeAdddealer").off("tap").on("tap",function(){$("#div_attach_choose").popup("close");});
		if(OrderInfo.provinceInfo!=undefined&&OrderInfo.provinceInfo.prodOfferId!=undefined&&OrderInfo.provinceInfo.prodOfferId!=""){
			$("#order_dealer_btn").tap(function(){$("#div_attach_choose").popup("close");});
		}
	};
	//勾选一个附属
	var _checkAttach = function(id){
		//var tr = $("#atr_"+id);
		var checkbox = $("#"+id);
		if(checkbox.attr("checked")=="checked"){
			//tr.removeClass("plan_select");
			checkbox.attr("checked", false);
		}else {
			//tr.addClass("plan_select");
			checkbox.attr("checked", true);
		}
	};
	
	//删除协销人
	var _removeDealer = function(obj){
		$(obj).parent().parent().parent().parent().parent().remove();
		$.jqmRefresh($("#dealerTbody"));
	};
	
	//删除协销人
	var _removeAttDealer = function(id){
		$("li[name^='tr_"+id+"']").each(function(){
			$(this).remove();
		});
		$.jqmRefresh($("#dealerTbody"));
	};
	
	return {
		initDealer 			: _initDealer,
		changeAccNbr		: _changeAccNbr,
		showOfferList		: _showOfferList,
		addProdDealer		: _addProdDealer,
		addAttachDealer		: _addAttachDealer,
		checkAttach			: _checkAttach,
		removeDealer		: _removeDealer,
		removeAttDealer		: _removeAttDealer,
		changeDealer		: _changeDealer
	};
})();
/**
 * 终端入口
 * 
 * @author dujb3
 * @modifyby liusd
 */
CommonUtils.regNamespace("mktRes", "terminal");

mktRes.terminal = (function($){
	var _offerSpecId = ""; //保存合约附属ID，合约套餐使用
	var pageSize = 10;
	var termInfo = {};
	/**
	 * 校验是否可以进入下一步
	 */
	var buyChk = {
			buyType : "lj",
			numFlag : false,
			numLevel : "0",
			hyFlag : false,
			hyType: "",
			hyOfferSpecId: 0,
			hyOfferSpecName: "",
			hyOfferSpecQty: 0,
			hyOfferSpecFt: 0,
			hyOfferRoles:null,
			tsnFlag : false
	};
	_initBuyChk = function() {
		buyChk = {
			buyType 	: "lj",
			numFlag 	: false,
			numLevel 	: "0",
			hyFlag 		: false,
			hyType		: "",
			hyOfferSpecId	: 0,
			hyOfferSpecName	: "",
			hyOfferSpecQty	: 0,
			hyOfferSpecFt	: 0,
			hyOfferRoles	: null,
			tsnFlag 		: false
		};
	};
	/**
	 * 检验buyChk的状态，改变选购类型及协助人控制,及下一步操作
	 */
	var _chkState=function(){
		if ("lj"==buyChk.buyType) {
			OrderInfo.actionFlag = 13;
			$("#treaty").hide();
			$("#agreementFie").hide();
			$("#phonenumberFie").hide();
			$("#dealerMktDiv").show();
		} else if ("hy"==buyChk.buyType){
			OrderInfo.actionFlag = 14;
			$("#dealerMktDiv").hide();
			$("#phonenumberFie").show();
		}

	};
	var _setNumber=function(num, numLevel){
		$("#choosedNumSpan").html(num);
		buyChk.numFlag = true;
		buyChk.numLevel = numLevel;
		_chkState();
		$("#treaty").show();
	};

	//滚动页面入口
	var _scroll = function(scrollObj){
		if(scrollObj && scrollObj.page && scrollObj.page >= 1){
			_btnQueryTerminal(scrollObj.page,scrollObj.scroll);
		}
	}
	/**
	 * 按钮查询
	 */
	var _btnQueryTerminal=function(curPage,scroller){
		//请求地址
		var url = contextPath+"/pad/mktRes/terminal/list";
		//收集参数
		var param = _buildInParam(curPage);
		$.callServiceAsHtml(url,param,{
			"before":function(){
				if(curPage == 1)$.ecOverlay("<strong>查询中,请稍等...</strong>");
			},
			"always":function(){
				if(curPage == 1)$.unecOverlay();
			},
			"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","<br/>查询失败,稍后重试");
					return;
				}
				var content$ = $("#div_terminal_list");
				if(curPage == 1)
					content$.html(response.data);
				else{
					content$.find("ul").append(response.data).listview("refresh");
				}
				//刷新jqm控件
				$.jqmRefresh(content$);
				//回调刷新iscroll控制数据,控件要求
				if(scroller && $.isFunction(scroller)) scroller.apply(this,[]);

				//绑定选中单个终端事件
				content$.find("div.phone").off("tap").on("tap",function(){
					$(this).addClass("choose").parents().siblings().find("div.phone").removeClass("choose");
				});
				if(OrderInfo.busitypeflag==1){
					$("#btn_enter_prev").show();
					$("#btn_enter_prev").off("tap").on("tap",function(){
						$("#ul_busi_area").show();
						$("#order_prepare").empty();
					});
				}
				//绑定选中终端后下一步操作功能
				$("#btn_enter_terminal_detail").off("tap").on("tap",function(){
					var _choose = content$.find("div.choose");
					if(_choose.length==1){
						_selectTerminal(_choose);
					}else{
						$.alert("提示","请先选择一款终端,再进入下一步操作.");
					}
				});
			}
		});	
	};
	/**
	 * 构造查询条件
	 */
	var _buildInParam = function(curPage){
		var brand 		= ec.util.defaultStr($("#select_brand").val());
		var phoneType 	= ec.util.defaultStr($("#select_phone_type").val());
		var $priceArea 	= $("#select_price").find("option:selected");
		var minPrice 	= $priceArea.attr("minPrice");
		var maxPrice 	= $priceArea.attr("maxPrice");
		var commCond 	= $("#input_phone_name").val();
		var contractFlag = ec.util.defaultStr($("#select_by_type").val());
		
		if(minPrice!=""){
			minPrice=parseInt(minPrice) * 100;
		}
		if(maxPrice!=""){
			maxPrice=parseInt(maxPrice) * 100;
		}
		var attrList = [];
		if(brand != "" && brand != "无限") {
			var attr = {
				"attrId":CONST.TERMINAL_SPEC_ATTR_ID.BRAND,
				"attrValue":brand
			};
			attrList.push(attr);
		}
		if(phoneType != "" && phoneType != "无限") {
			var attr = {
				"attrId":CONST.TERMINAL_SPEC_ATTR_ID.PHONE_TYPE,
				"attrValue":phoneType
			};
			attrList.push(attr);
		}
		return {
			"mktResCd":"",
			"mktResName":commCond,
			"mktResType":"",
			"minPrice":minPrice,
			"maxPrice":maxPrice,
			"contractFlag":contractFlag,
			"pageInfo":{
				"pageIndex":curPage,
				"pageSize":pageSize
			},
			"attrList":attrList
		};
	};
	/**
	 * 点击前定位
	 */
	var _exchangeSelected = function(loc,selected){
		$(loc).removeClass("selected");
		$(selected).addClass("selected");
	};
	/**
	 * 初始化查询条件
	 */
	var _initInParam = function(brand,minPrice,maxPrice,commCond){
		$("#commCond").val(commCond);
		//给搜索输入框绑定回车事件
		$("#commCond").off("keydown").on("keydown", function(e){
			var ev = document.all ? window.event : e; 
			if(ev.keyCode==13) {
				$("#btn_term_search").click();
			}
		});
		var not_exist_ = false;
		$("#termManf_small a").each(function(){
			if($(this).attr("val")==brand){
				$(this).addClass("selected");
				not_exist_ = true;
			}else{
				$(this).removeClass("selected");
			}
		});
		if(!not_exist_){
			$("#termManf_all a").each(function(){
				if($(this).attr("val")==brand){
					$(this).addClass("selected");
				}else{
					$(this).removeClass("selected");
				}
			});
			//_view_termManf("termManf_all");
		}
		$("#priceArea a").removeClass("selected");
		$("#priceArea a[minPrice='"+minPrice+"'][maxPrice='"+maxPrice+"']").addClass("selected");
	};
	/**
	 * 成功获取搜索条件后展示
	 */
	var call_back_success_queryApConfig=function(response){
		var dataLength=response.data.length;
		
		var _phone_brand;
		var _phone_price_area;
		var _phone_type;
		
		for (var i=0; i < dataLength; i++) {
			if(response.data[i].PHONE_BRAND){
				var _obj = $("#select_brand");
			  	_phone_brand=response.data[i].PHONE_BRAND;
			  	for(var m = 0;m < _phone_brand.length; m++){
			  		var phoneBrand=(_phone_brand[m].COLUMN_VALUE_NAME).replace(/\"/g, "");
			  		_obj.append("<option value='"+phoneBrand+"'>"+phoneBrand+"</option>");
			  	}
				_obj.selectmenu("refresh");
			}
			if(response.data[i].PHONE_PRICE_AREA){
				var _obj = $("#select_price");
			  	_phone_price_area=response.data[i].PHONE_PRICE_AREA;
			  	for(var m=0;m<_phone_price_area.length;m++){
			  		var  phonePriceArea=(_phone_price_area[m].COLUMN_VALUE_NAME).replace(/\"/g, "");
		  			var phonePriceAreaArry=phonePriceArea.split("-");
		  			if(phonePriceAreaArry.length!=1){
		  				minPrice=phonePriceAreaArry[0];
		  				maxPrice=phonePriceAreaArry[1];
		  			}else{
		  				phonePriceAreaArry=phonePriceAreaArry.toString();
		  				minPrice=phonePriceAreaArry.substring(0,phonePriceAreaArry.length-2);
		  				maxPrice="\"\"";
		  			}
		  			_obj.append("<option minPrice="+minPrice+" maxPrice="+maxPrice+">"+phonePriceArea+"</option>");
		  			_obj.selectmenu().selectmenu("refresh");
			  	}
			}
			if(response.data[i].PHONE_TYPE){
				var _obj = $("#select_phone_type");
				_phone_type=response.data[i].PHONE_TYPE;
			  	for(var m=0;m<_phone_type.length;m++){
			  		var phoneType=(_phone_type[m].COLUMN_VALUE_NAME).replace(/\"/g, "");
			  		_obj.append("<option value="+phoneType+">"+phoneType+"</option>");
			  	}
			  	_obj.selectmenu().selectmenu("refresh");
			}
		};
	};
	/**
	 * 获取搜索条件
	 */
	var _queryApConfig=function(){
		var configParam={"CONFIG_PARAM_TYPE":"TERMINAL_AND_PHONENUMBER"};
		var qryConfigUrl=contextPath+"/order/queryApConf";
		$.callServiceAsJsonGet(qryConfigUrl, configParam,{
			"done" : call_back_success_queryApConfig
		});
	};
	var _hyClick=function(){
		_initBuyChk();
		buyChk.buyType = 'hy';
		_chkState();
	};
	var _ljClick=function(){
		_initBuyChk();
		buyChk.buyType = 'lj';
		_chkState();
	};
	/**
	 * 选择立即订购终端
	 */
	var _selectTerminal=function(obj){
		var param = {
			mktResTypeCd 	: $(obj).attr("mktResTypeCd"),
			mktResCd		: $(obj).attr("mktResCd"),
			mktResId 		: $(obj).attr("mktResId"),
			brand 			: $(obj).attr("brand"),
			phoneType 		: $(obj).attr("phoneType"),
			phoneColor 		: $(obj).attr("phoneColor"),
			mktName 		: $(obj).attr("mktName"),
			mktPrice 		: $(obj).attr("mktPrice"),
			mktPicA 		: $(obj).attr("mktPicA")
		};
		if(CONST.getAppDesc()==0){
			param.mktSpecCode=$(obj).attr("mktSpecCode");
			param.pageInfo={pageIndex:1,pageSize:pageSize};
			param.attrList=[];
			param.is4G="yes";
		}
		var url = contextPath+"/pad/mktRes/terminal/detail";
		$.callServiceAsHtml(url, param, {
			"before":function(){
				$.ecOverlay("<strong>查询中,请稍等...</strong>");
			},"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response || response.code != 0){
					$.alert("提示","<br/>处理失败，请稍后重试！");
					return;
				}
				var content$=$("#div_terminal").html(response.data);
				content$.find(".phonedetails.ui-grid-a > .ui-block-b").width($(window).width() - 342 - 20 - 10);	
				_initBuyChk();
//				$("#hy").off("click").on("click",function(){
//					_initBuyChk();
//					buyChk.buyType = 'hy';
//					_chkState();
//				});
//				$("#lj1").off("click").on("click",function(){
//					_initBuyChk();
//					buyChk.buyType = 'lj';
//					_chkState();
//				});
				$("#cNumA").click(function(){
					var custId = OrderInfo.cust.custId;
					if(OrderInfo.cust==undefined || custId==undefined || custId==""){
						$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");
						return;
					}
					_chkState();
					mktRes.phoneNbr.phoneNumDialog('terminal','Y1','01');
				});	
				
//				$("#cfsjA").off("click").on("click",function(){
//					_selectHy(1);
//				});
//				$("#gjsfA").off("click").on("click",function(){
//					_selectHy(2);
//				});
				$("#chkTsnA").off("click").on("click",function(){
					_checkTerminalCode('#tsn');
				});
				$("#purchaseTermA").off("click").on("click",function(){
					_purchase();
				});
				$("#btn_terminal_back").off("click").on("click",function(){
					order.prepare.commonTab(contextPath+"/pad/mktRes/terminal/prepare.html","order_tab_panel_terminal");
				});
//				$("#fls_terminal_color label").off("click").on("click",function(){
//					_selectColor($(this));
//				});
				//初始化裸机发展人信息
				OrderInfo.actionFlag=13;
				//初始化协销发展人
				order.dealer.initDealer();
				$.jqmRefresh(content$);
			}
		});	
	};
	
	/**
	 * 切换终端颜色
	 */
	var _selectColor=function(obj){
		var p_pic				=$(obj).attr("p_pic");
		var mktResName			=$(obj).attr("mktResName");
		var mktSalePrice		=$(obj).attr("mktSalePrice");
		var mktNormalSalePrice	=$(obj).attr("mktNormalSalePrice");
		var mktResId			=$(obj).attr("mktResId");
		var mktResTypeCd		=$(obj).attr("mktResTypeCd");
		var mktSpecCode			=$(obj).attr("mktSpecCode");
		$("#term_pic_id").attr("src",p_pic);
		$("#mkt_resname_id").html(mktResName);
		$("#mkt_saleprice_id").html(mktSalePrice+" 元");
		$("#mktResId").val(mktResId);
		$("#mktResName").val(mktResName);
		$("#price").val(mktNormalSalePrice);
		$("#mktResType").val(mktResTypeCd);
		$("#mktSpecCode").val(mktSpecCode);
		
		var buyTypeTmp=buyChk.buyType;
		_initBuyChk();
		buyChk.buyType=buyTypeTmp;
		_chkState();
		$("#tsn_hid").val("");
		$("#tsn").val("");
		termInfo = {};
	};
	
	/**
	 * 选择合约类型,具体合约放致后面操作
	 */
	var _selectHy=function(agreementType){
		if (agreementType == 1) {
			buyChk.hyType = 'cfsj';
		} else {
			buyChk.hyType = 'gjsf';
		}
		buyChk.hyFlag = true;
		_chkState();
		if (!buyChk.numFlag){
			$.alert("提示","请先选号！");
			return;
		}
		var param={
				"mktResCd":$("#mktResId").val(),
				"agreementType":agreementType
		};
		var url=contextPath+"/pad/mktRes/terminal/mktplan";
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
//				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
//				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					$.alert("提示","<br/>处理失败，请稍后重试！");
					return;
				}
				if(response.code != 0) {
					if (response.code == 1006){
						$.alert("提示","<br/>查询不到，请稍后重试");
					} else {								
						$.alert("提示","<br/>查询失败，请稍后重试");
					}
					return;
				}
				//统一弹出框
//				var popup = $.popup("#div_offer",response.data,{
//					cache:true,
//					width:$(window).width()-200,
//					height:$(window).height(),
//					contentHeight:$(window).height()-120,
//					afterClose:function(){if($.ketchup) $.ketchup.hideAllErrorContainer($("#custCreateForm"));}
//				});
				$("#terminalMain").hide();
				$("#div_offer").show();
				$("#gjhyContent").html(response.data);
				
				
				$(".many li").bind("click", function () {
					var index = $(this).index();
					var divs = $("#tabs-body .ordercona");
					$(this).parent().children("li").attr("class", "tab-nav");//将所有选项置为未选中
					$(this).attr("class", "tab-nav-action"); //设置当前选中项为选中样式
					divs.hide();//隐藏所有选中项内容
					divs.eq(index).show(); //显示选中项对应内容
				});
				$(".userorderlist li.multi").on("tap",function(){
					if($(this).next(".multidiv").is(":hidden")) 
						{ 
							$(this).next(".multidiv").show().siblings(".multidiv").hide();
						} else {
							$(this).next(".multidiv").hide().siblings(".multidiv").hide();
						}
				});
				$(".userorderlist > li").on("tap",function(){
					$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").siblings().find("li").removeClass("userorderlistlibg");
					$("#orderlistmenu").panel( "open" );
				});
				$(".userorderlist .multidiv li").on("tap",function(){
					$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").parents().siblings("li").removeClass("userorderlistlibg");
					$("#orderlistmenu").panel( "open" );
				});
				$("#otabs li").bind("click", function () {
			                var index = $(this).index();
			                var divs = $("#otabs-body > div");
			                $(this).parent().children("li").attr("class", "otab-nav");//将所有选项置为未选中
			                $(this).attr("class", "otab-nav-action"); //设置当前选中项为选中样式
							  $(this).parent().children("li").find(".ui-input-search").hide();
							  $(this).parent().children("li").find(".ui-select").hide(); 
							  $(this).children("div").show();
			                divs.hide();//隐藏所有选中项内容
			                divs.eq(index).show(); //显示选中项对应内容
			    });			
				//显示第一个tab的div
				$("#phone_warp_id .otabs-body > div").hide();
				$("#phone_warp_id .otabs-body > div").eq(0).show();
				$.jqmRefresh($("#phone_warp_id"));
				//绑定切换合约页click事件
				$("#contract_nav_agreement li").off("click").on("click",function(event){
					_setPlanOfferTab(this, $(this).attr("itemIndex"));
				});
				//绑定每行合约click事件
				$("#phone_warp_id .otabs-body tr:gt(0)").off("click").on("click",function(event){
					_linkQueryOffer(this);
				});
				//绑定确定按钮click事件
				$("#hy_nav_confirm_a").off("click").on("click",function(event){
					_selectPlan();
				});
			}
		});

		
		
		/*
		ec.form.dialog.createDialog({
			"id":"-gjhy",
			"width":980,
			"height":550,
			"initCallBack":function(dialogForm,dialog){
				var param={
						"mktResCd":$("#mktResId").val(),
						"agreementType":agreementType
				};
				var url=contextPath+"/mktRes/terminal/mktplan";
				$.callServiceAsHtmlGet(url,param,{
					"before":function(){
//						$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
					},
					"always":function(){
//						$.unecOverlay();
					},
					"done" : function(response){
						mktRes.terminal.dialogForm=dialogForm;
						mktRes.terminal.dialog=dialog;
						if(!response){
							$.alert("提示","<br/>处理失败，请稍后重试！");
							return;
						}
						if(response.code != 0) {
							if (response.code == 1006){
								$.alert("提示","<br/>查询不到，请稍后重试");
							} else {								
								$.alert("提示","<br/>查询失败，请稍后重试");
							}
							if(mktRes.terminal.dialogForm!=undefined&&mktRes.terminal.dialog!=undefined){
								mktRes.terminal.dialogForm.close(mktRes.terminal.dialog);
							}
							return;
						}
						$("#gjhyContent").html(response.data);
						//显示第一个tab的div
						$("#tab_content_0").show();
						//绑定切换合约页click事件
						$("#contract_nav_agreement li").off("click").on("click",function(event){
							_setPlanOfferTab(this, $(this).attr("itemIndex"));
						});
						//绑定每行合约click事件
						$("#phone_warp_id .contract_tab_content tr:gt(0)").off("click").on("click",function(event){
							_linkQueryOffer(this);
						});
						//绑定确定按钮click事件
						$("#hy_nav_confirm_a").off("click").on("click",function(event){
							_selectPlan();
						});
					}
				});	
			 },
			"submitCallBack":function(dialogForm,dialog){
				buyChk.hyFlag = true;
			},
			"closeCallBack":function(dialogForm,dialog){
//				buyChk.hyFlag = false;
				_chkState();
				var content$=$("#gjhyContent");
				content$.html('');
			}
		});	
		*/	
	};
	/**
	 * 切换合约计划标签页
	 */
	var _setPlanOfferTab=function(selected, id){
		if ($(selected).hasClass("current")) {
			return;
		}
		$("#contract_nav_agreement li").removeClass("current");
		$("#tab_"+id).addClass("current");
		$(".contract_tab_content").hide();
		$("#tab_content_"+id).show();
	};
	/**
	 * 根据合约查询套餐
	 */
	var _linkQueryOffer=function(selected){
		if ($(selected).hasClass("plan_select")) {
			$(selected).removeClass("bg plan_select").next("#plan2ndTr").hide();
			return false;
		}
		$("#phone_warp_id .otabs-body tr").filter(".plan_select")
			.removeClass("bg plan_select").next("#plan2ndTr").hide();
		$(selected).addClass("bg").addClass("plan_select");
		var offerSpecId=$(selected).attr("offerSpecId");
		var agreementType = $(selected).attr("agreementType");
		_queryOffer(selected, offerSpecId, agreementType);
	};
	/**
	 * 查询套餐后生成展示内容
	 */
	var _queryOffer=function(selected, offerSpecId, agreementType){
		
		var obj$ = $(selected).next("#plan2ndTr");
		if (obj$.length > 0) {
			obj$.show();
			return;
		}
		
		//调用order.js中的方法获得主销售品规格
		var response = order.service.queryPackForTerm(offerSpecId, agreementType, '');
		if (typeof(response) == "undefined" || response==null){
			$.alert("提示","<br/>未查到套餐，请稍后再试！");
			return;
		}
		if (response.code == -2){
			$.alertM(response.data);
			$.unecOverlay();
			return;
		}
		if(response.code != 0 || response.data.code != "POR-0000"){
			$.alert("提示","<br/>未查到合适套餐，请稍后再试！");
			return;
		}
		var offerHtml="";
		offerHtml+="<tr id='plan2ndTr' class='nocolor'>";
		offerHtml+="<td class='nopadding' colspan='7'>";
		offerHtml+="<div id='plan2ndDiv' class='plan_second_list cashier_tr'>";
		offerHtml+="  <table class='contract_list'>";
		offerHtml+="  <thead>";
		offerHtml+="    <tr>";
		offerHtml+="      <td class='borderLTB'>&nbsp;</td><td>套餐名称</td><td>价格</td>";
		offerHtml+="      <td>流量</td><td>语音分钟数</td><td>WIFI时长</td><td>点对点短信</td>";
		offerHtml+="      <td>点对点彩信</td><td>套餐外流量</td><td>套餐外通话分钟数</td>";
		offerHtml+="    </tr>";
		offerHtml+="  </thead>";
		offerHtml+="  <tbody>";
		var offerInfos = response.data.prodOfferInfos;
		if (offerInfos.length == 0) {
			$.alert("提示","<br/>未查到套餐，请稍后再试！");
		}
		for(var i=0;i<offerInfos.length;i++){
			var offer = offerInfos[i];
			offerHtml+="    <tr offerSpecId='"+offer.offerSpecId+"' ";
			offerHtml+=		"   offerSpecName='"+offer.offerSpecName+"' ";
			offerHtml+=		"   price='"+offer.price+"' >";
			offerHtml+="      <td></td>";
			offerHtml+="      <td style='width:240px;'>"+ec.util.defaultStr(offer.offerSpecName)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.price)+"</td>";
			var inFlux = '';
			if (offer.inFlux >= 1024) {
				inFlux = offer.inFlux / 1024 + 'G';
			} else {
				inFlux = offer.inFlux + 'M';
			}
			offerHtml+="      <td>"+ec.util.defaultStr(inFlux)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.inVoice)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.inWIFI)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.inSMS)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.inMMS)+"</td>";
			offerHtml+="      <td style='width:140px;'>"+ec.util.defaultStr(offer.outFlux)+"</td>";
			offerHtml+="      <td>"+ec.util.defaultStr(offer.outVoice)+"</td>";
			offerHtml+="    </tr>";
		}
		offerHtml+="  </tbody>";
		offerHtml+="  </table>";
		offerHtml+="</div>";
		offerHtml+="</td>";
		offerHtml+="</tr>";
		
		$(selected).after(offerHtml);
		$("#plan2ndDiv tbody tr").off("click").on("click",function(event){_linkSelectPlan(this);event.stopPropagation();});
//		alert(response.data);
	};
	var _linkSelectPlan=function(selected){
		$("#plan2ndDiv tbody tr").removeClass("plan_select2");
		$("#plan2ndDiv tbody tr").children(":first-child").html("");
		var offerSpecId = $(selected).attr("offerSpecId");
//		$("#div_offer").popup("close");
//		$.jqmRefresh($("#div_offer"));
		var result = _queryOfferSpec(offerSpecId, selected);
		if (result) {
			$(selected).addClass("plan_select2");
			var nike="<i class='terminalSelect'></i>";
			$(selected).children(":first").html(nike);
		}
	};
	
	var _queryOfferSpec=function(offerSpecId, selected){
		var inParam = {
			"price":$(selected).attr("price"),
			"id" : 'tcnum1',
			"specId" : offerSpecId,
			"custId" : OrderInfo.cust.custId,
			"areaId" : OrderInfo.staff.soAreaId
		};
		order.service.opeSer(inParam); //调用公用弹出层
		return true;
	};
	
	
	/**
	 * 查询销售品构成
	 */
	var _queryOfferSpecOld=function(offerSpecId, selected){
		buyChk.hyOfferSpecQty=0;
		buyChk.hyOfferSpecFt=0;
		var data = $(selected).data("__offerSpec");
		if (typeof(data) == "undefined") {
			var params={
					"offerSpecId":Number(offerSpecId)
			};
			var url = contextPath+"/order/queryOfferSpec";
			var response = $.callServiceAsJson(url,params);
			data = response.data.offerSpec;
			$(selected).data("__offerSpec", data);
			
			if (typeof(response) == "undefined" || response==null){
				$.alert("提示","<br/>未查到销售品构成，请稍后再试！");
				return false;
			}
			if (response.code != "0" || !response.isjson){
				$.alert("提示","<br/>未查到销售品构成，请稍后再试！");
				return false;
			}
			if(response.data.code != "POR-0000"){
				$.alert("提示","<br/>未查到销售品构成，请稍后再试！");
				return false;
			}
		}
		var offerSpec= SoOrder.sortOfferSpec(data);//排序主副卡销售品
				
		var offerRoles=offerSpec.offerRoles;
		
		buyChk.hyOfferRoles=offerRoles;
		
		var i;
		var maxQty = 0;
		var minQty = 0;
		/*
		for(i=0;i<offerRoles.length;i++){
			if(CONST.MEMBER_ROLE_CD.VICE_CARD==offerRoles[i].memberRoleCd){
				maxQty=offerRoles[i].maxQty;
				minQty=offerRoles[i].minQty;
			} else {
				offerRoles[i].selectQty=1;
			}
		}
		*/
		/*卞贤伟 2014-0307修改 控制副卡个数*/
		for(i=0;i<offerRoles.length;i++){
			var offerRole = offerRoles[i];
			if(CONST.MEMBER_ROLE_CD.VICE_CARD==offerRoles[i].memberRoleCd){
				if(offerRole.roleObjs){
					$.each(offerRole.roleObjs,function(){
						if(this.objType == 2){
							maxQty = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量
							minQty = this.minQty<0?"0":this.minQty;//主卡的最大数量
						}
					});
				}
			} else {
				offerRoles[i].selectQty=1;
			}
		}
		offerSpec.offerRoles=offerRoles;
		//填OrderInfo
		OrderInfo.offerSpec = offerSpec;
		
		//付费类型 ：初始化buyChk.hyOfferSpecFt
		buyChk.hyOfferSpecFt=offerSpec.feeType;
		
		//如果没有副卡
		if (maxQty == 0) {
			return true;
		}
		
		//副卡个数
		var cPanel = $("#termOfferSpecViceLi");
		cPanel.find("input").val(minQty);
		cPanel.find(".addinfo").html("&nbsp;&nbsp;&nbsp;"+minQty+"-"+maxQty+"（张） ");
		cPanel.find("a:first").off("click").on("click", function(event){
			var num = parseInt(cPanel.find("input").val());
			if (num <= minQty) {
				$.alert("提示","副卡数量已经达到最小值，不能再减少。");
				return;
			} else {
				cPanel.find("input").val(num-1);
			}
		});
		cPanel.find("a:last").off("click").on("click", function(event){
			var num = parseInt(cPanel.find("input").val());
			if (num >= maxQty) {
				$.alert("提示","副卡数量已经达到最大值，不能再增加。");
				return;
			} else {
				cPanel.find("input").val(num+1);
			}
		});
		easyDialog.open({
			container : 'termOfferSpec'
		});
		$("#termOfferSpecClose").off("click").on("click",function(event){
			easyDialog.close();
		});
		$("#termOfferSpecCancel").off("click").on("click",function(event){
			easyDialog.close();
		});
		$("#termOfferSpecConfirm").off("click").on("click",function(event){
			var selectQty = cPanel.find("input").val();
			buyChk.hyOfferSpecQty = selectQty;
			for(i=0;i<offerRoles.length;i++){
				if(CONST.MEMBER_ROLE_CD.VICE_CARD==offerRoles[i].memberRoleCd){
					offerRoles[i].selectQty=selectQty;
				} else {
					offerRoles[i].selectQty=1;
				}
			}
			OrderInfo.offerSpec.offerRoles = offerRoles;
			
			easyDialog.close();
		});
		return true;
	};
	/**
	 * 在合约套餐窗口选择套餐
	 */
	var _selectPlan=function(){
		//搜索是否有
		var offerSpec=$("#plan2ndDiv tbody tr[class='plan_select2']");
		if (offerSpec.length!=1) {
			$.alert("提示","请选择一个套餐！");
			return;
		}
		//填入合约信息
		var agreement = offerSpec.parents("#plan2ndTr").prev();
		if (agreement.length!=1) {
			$.alert("提示","请选择一个合约！");
			return;
		}
		mktRes.terminal.offerSpecId = agreement.attr("offerSpecId");
		buyChk.hyFlag = true;
		buyChk.hyOfferSpecId=offerSpec.attr("offerSpecId");
		buyChk.hyOfferSpecName=offerSpec.attr("offerSpecName");
//		order.service.setOfferSpec(1, Number(buyChk.hyOfferSpecQty));
		
		_chkState();
		$("#agreementFie").show();
		$("#choosedOfferPlan").html(agreement.attr("offerSpecName"));
		$("#terminalMain").attr("style","display:block");
		$("#div_offer").attr("style","display:none");
	};
	/**
	 * 增加附属销售品（填入合约信息）
	 */
	var _addAttachParam=function(prodId,offerSpecId,offerSpecName){
		var param = {
			offerSpecId:offerSpecId,
			prodId:prodId
		};
		var orderedOfferSpecIds = [];
		var specList = AttachOffer.getSpecList(prodId);
		if(specList!=undefined){
			for (var i = 0; i < specList.length; i++) {  //遍历开通附属
				if(specList[i].offerSpecId!=offerSpecId&&specList[i].isdel!="Y"){
					orderedOfferSpecIds.push(specList[i].offerSpecId);
				}
			}	
		}
		var offerList = AttachOffer.getOfferList(prodId);
		if(offerList!=undefined){
			for (var i = 0; i < offerList.length; i++) { //遍历已订购附属
				if(offerList[i].offerSpecId!=offerSpecId && offerList[i].isdel!="Y"){
					orderedOfferSpecIds.push(offerList[i].offerSpecId);
				}
			}
		}
		if(orderedOfferSpecIds.length>0){
			param.orderedOfferSpecIds = orderedOfferSpecIds;
		}
		var response = $.callServiceAsJsonGet(contextPath+"/offer/queryExcludeDepend",{strParam:JSON.stringify(param)},{});
		if(response.code == 0){
			AttachOffer.parseRuleData(response.data,offerSpecId,prodId,offerSpecName);	
			return true;
		}else if(response.code == 1){
			$.alert("提示","<strong>"+response.errorsList[0].msg+"("+response.errorsList[0].code+")</strong>");
		}else{
			$.alert("提示","数据查询异常，请稍后重试！");
		}
		return false;
	};
	/**
	 * 终端串号校验
	 */
	var _checkTerminalCode = function(id){
		termInfo = {};
		buyChk.tsnFlag = false;
		_chkState();
		$("#tsn_hid").val("");
		
		var tc = $(id).val();
		if(tc == "")
			return ;
		var param = {
			"instCode" 		: tc,
			"mktResTypeCd" 	: $("#mktResType").val(),
			"orderNo" 		: ""
		};
		if(CONST.getAppDesc()==0){
			var mktSpecCode=$("#mktSpecCode").val();
			if($.trim(mktSpecCode)==""){
				$.alert("提示","营销资源返回的规格存货编码为空！");
				return;
			}
			if(mktSpecCode.length>=22){
				mktSpecCode=mktSpecCode.substring(0,22);
			}
			param.mktSpecCode=mktSpecCode;
		}else{
			param.mktResId=$("#mktResId").val();
		}
		var url = contextPath+"/mktRes/terminal/checkTerminal";
		$.callServiceAsJson(url,param,{
			"done" : function(response){
				if (response && response.code == -2) {
					$.alertM(response.data);
				} else if(response&&response.data&&response.data.code == 0) {
					if(response.data.statusCd==CONST.MKTRES_STATUS.USABLE){
						$.alert("提示","<br/>此终端串号可以使用");
						buyChk.tsnFlag = true;
						_chkState();
						$("#tsn_hid").val(tc);
						termInfo = response.data;
					}else{
						$.alert("提示",response.data.message);
					}
				}else if(response && response.data && response.data.message
						&& response.data.code == 1){
					$.alert("提示", response.data.message);
				}else{
					$.alert("提示","<br/>校验失败，请稍后重试！");
				}
			}
		});
	};
	
	/**
	 * 购买手机，判断是否满足条件，合约机跳往填单，裸机直接算费
	 */
	var _purchase=function(){
		if ("lj"==buyChk.buyType) {
			if (!buyChk.tsnFlag) {
				$.alert("提示","<br/>请先校验终端串号。");
				return;
			}
			var apCharge = $("#price").val() / 100;
			var coupons = [{
				couponUsageTypeCd : "3", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : termInfo.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
				couponNum : 1, //物品数量
				storeId : termInfo.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : apCharge, //物品价格
				couponInstanceNumber : termInfo.instCode, //物品实例编码
				ruleId : "", //物品规则ID
				partyId : CONST.CUST_COUPON_SALE, //客户ID
				prodId : 0, //产品ID
				offerId : 0, //销售品实例ID
				state : "ADD", //动作
				relaSeq : "" //关联序列	
			}];
			//如果是老客户或新建客户
			if ((OrderInfo.cust.custId)&& OrderInfo.cust.custId != "") {
				coupons[0].partyId = OrderInfo.cust.custId;
			}
			OrderInfo.actionTypeName = "订购";
			OrderInfo.businessName = $("#mktResName").val();
			var data = {};
			data.busiObj = {
				instId : termInfo.mktResId //业务对象实例ID
			};
			data.boActionType = {
				actionClassCd : CONST.ACTION_CLASS_CD.MKTRES_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.COUPON_SALE
			};
			data.coupons = coupons;
			//发展人
			var $li = $("#dealerMktDiv li[name='li_"+$("#mktResId").val()+"']");
			if($li.length>0){
				data.dealers = [];
				$li.each(function(){   //遍历产品有几个发展人
					var dealer = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("staffid") 
					};
					data.dealers.push(dealer);
				});
			}
			SoOrder.getTokenSynchronize();
			//订单提交
			SoOrder.submitOrder(data);
			return;
		} else if ("hy"==buyChk.buyType) {
			if (!buyChk.tsnFlag) {
				$.alert("提示","<br/>请先校验终端串号。");
				return;
			}
			//校验客户是否已定位
			if (!(OrderInfo.cust.custId)|| OrderInfo.cust.custId=="") {
				$.alert("提示","<br/>在订购套餐之前请先进行客户定位！");
				return;
			}
			//构造参数，填单
			if (buyChk.hyType==""){
				$.alert("提示","<br/>请选择合约!");
				return;
			}
		} else {
			return;
		}
		var coupon = {
			couponUsageTypeCd 	: "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
			inOutTypeId 		: "1",  //出入库类型
			inOutReasonId 		: 0, //出入库原因
			saleId 				: 1, //销售类型
			couponId 			: termInfo.mktResId, //物品ID
			couponinfoStatusCd 	: "A", //物品处理状态
			chargeItemCd 		: CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
			couponNum 			: 1, //物品数量
			storeId 			: termInfo.mktResStoreId, //仓库ID
			storeName 			: "1", //仓库名称
			agentId 			: 1, //供应商ID
			apCharge 			: $("#price").val() / 100, //物品价格
			couponInstanceNumber: termInfo.instCode, //物品实例编码
			ruleId 				: "", //物品规则ID
			partyId 			: OrderInfo.cust.custId, //客户ID
			prodId 				: -1, //产品ID
			offerId 			: -1, //销售品实例ID
			attachSepcId 		: mktRes.terminal.offerSpecId,
			state 				: "ADD", //动作
			relaSeq 			: "" //关联序列	
		};
		if(CONST.getAppDesc()==0){
			coupon.termTypeFlag=termInfo.termTypeFlag;
		}
		OrderInfo.attach2Coupons = [];
		OrderInfo.attach2Coupons.push(coupon);
		var param = {
			boActionTypeCd 	: 'S1',
			boActionTypeName: "订购",
			offerSpec 		: OrderInfo.offerSpec,
			offerSpecId 	: buyChk.hyOfferSpecId,
			offerSpecName 	: buyChk.hyOfferSpecName,
			viceCardNum 	: Number(buyChk.hyOfferSpecQty),
			feeType 		: buyChk.hyOfferSpecFt,
			offerNum 		: 1,
			type 			: 2,//1购套餐2购终端3选靓号
			actionFlag 		: OrderInfo.actionFlag,
			terminalInfo 	: {
				terminalName : $("#mktResName").val(),
				terminalCode : $("#tsn_hid").val()
			},
			offerRoles : buyChk.hyOfferRoles
		};
		OrderInfo.actionTypeName = "订购";
		SoOrder.builder(); //初始化订单数据
		order.main.buildMainView(param);
	};
	
	return {
		btnQueryTerminal	:_btnQueryTerminal,
		initInParam			:_initInParam,
		queryApConfig		:_queryApConfig,
		selectTerminal		:_selectTerminal,
		setNumber			:_setNumber,
		offerSpecId			:_offerSpecId,
		selectColor			:_selectColor,
		scroll				:_scroll,
		hyClick				:_hyClick,
		ljClick				:_ljClick,
		selectHy			:_selectHy
	};
})(jQuery);
/**
 * 号码查询
 * 
 * @author lianld
 */
CommonUtils.regNamespace("mktRes", "phoneNbr");
/**
 * 号码查询
 */
var phoneNum_level="";
var selectedObj=null;
var _queryFlag="0";
mktRes.phoneNbr = (function(){
	var _boProdAn = {
			accessNumber : "", //接入号
			org_level:"",//原始的号码等级，为了页面展示增加的字段
			level : "", //等级
			anId : "", //接入号ID
			anTypeCd : "",//号码类型
			areaId:"",
			areaCode:"",
			memberRoleCd:""
	};
	var _resetBoProdAn = function(){
		_boProdAn = {
				accessNumber : "", //接入号
				org_level:"",//原始的号码等级，为了页面展示增加的字段
				level : "", //等级
				anId : "", //接入号ID
				anTypeCd : "",//号码类型
				areaId:"",
				areaCode:"",
				memberRoleCd:""
		};
	};
	var ispurchased=0;
	var selectedLevel="";
	var idcode=[];
	//请求地址
	var url = contextPath+"/pad/mktRes/phonenumber/list";
	var phoneNumberVal="";
	//按钮查询
	var _btnQueryPhoneNumber=function(param){
		selectedObj=null;//初始化原先选中的号码
		//收集参数
		param = _buildInParam(param);
		param.isReserveFlag=_queryFlag;
		if(_queryFlag=='1'){//预约选号
			param.queryFlag="3";
		}
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response||response.code != 0){
					 response.data='查询失败,稍后重试';
				}
				var content$=$("#div_number_list");
				content$.html(response.data).fadeIn();
				$.jqmRefresh(content$);
				$("#btnSwitchNbr").off("tap").on("tap",function(){_btnQueryPhoneNumber({});});
				$(".numberlist .ui-grid-b").on("tap",function(){
					var obj=$(this);
					obj.addClass("numlistbg").siblings().removeClass("numlistbg").parents().siblings().find(".ui-grid-b").removeClass("numlistbg");
					if(selectedObj==obj){//老点同一个号？
						return;
					}
					selectedObj=obj;
					ispurchased= $(selectedObj).attr("ispurchased"); 
				});
				var subPage=$("#subPage").val();
				if(subPage=='number'&&OrderInfo.busitypeflag==1){
					$("#btn_enter_prev").show();
					$("#btn_enter_prev").off("tap").on("tap",function(){
						$("#ul_busi_area").show();
						$("#order_prepare").empty();
					});
				}
				$("#btn_enter_phoneNum_next").off("tap").on("tap",function(){
					_endSelectNum();
				});
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	
	//提供给LTE项目，新装套餐、主副卡变更等功能中的号码信息查询
	var _queryPhoneNumber=function(param){
		var url = contextPath+"/pad/mktRes/phone/numberlist";
		//收集参数
		var params = {
				"areaId":OrderInfo.getAreaId(),
				"phoneNumber":param.phoneNum
			};
		var response = $.callServiceAsJson(url,params);
		if (response&&response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
		}else {
			$.alert("提示","查询号码信息失败,稍后重试");
		}
	};
	
	var _btnIBydentityQuery=function(){
		var idcode=$.trim($("#idCode").val());
		if(idcode==''){
			$.alert("提示","请先输入身份证号码!");
			return;
		}
		if(!_idcardCheck(idcode)){
			$.alert("提示","身份证号码输入有误!");
			return;
		}
		var areaId=$("#p_cust_areaId").val();
		var param={"identityId":idcode,"areaId":areaId};
		$.callServiceAsHtmlGet(contextPath+"/pad/mktRes/phonenumber/listByIdentity",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response||response.code != 0){
					 response.data='查询失败,稍后重试';
				}
				var content$=$("#div_number_list");
				content$.html(response.data).fadeIn();
				$.jqmRefresh(content$);
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});	
	};
	//选择身份证预占的号码
	var _btnToOffer=function(obj){
		phoneNumberVal = $(obj).attr("numberVal"); 
		var memberRoleCd=CONST.MEMBER_ROLE_CD.MAIN_CARD;
		//选号类型：新装主卡选号、新装副卡选号 Y1、Y2
		var subFlag=$("#subFlag").val();
		if(subFlag=='Y2'){
			memberRoleCd=CONST.MEMBER_ROLE_CD.VICE_CARD;
		}
		//订单序号：O1、O2区分暂存单允许多个订单的情况
		var subnum=$("#subnum").val();
		//入口终端入口，号码入口，订单填写入口:terminal\offer\number
		var subPage=$("#subPage").val();
		//保底消费
		var pnPrice=phoneNumberVal.split("_")[2];
		if(order.service.offerprice!=''){
			var minMonthFare=parseInt(pnPrice);
			//套餐月基本费用
			var packageMonthFare=parseInt(order.service.offerprice);
			if(packageMonthFare<minMonthFare){
				$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");
				return;
			}
		}
		//正在被预占的号码
		var phoneNumber=phoneNumberVal.split("_")[0];
		var anTypeCd=phoneNumberVal.split("_")[3];
		var plevel=selectedLevel;
		if(selectedLevel==""){
			plevel=phoneNumberVal.split("_")[5];
		}
		var orgLevel=phoneNumberVal.split("_")[5];//初始等级
		var phoneNumId=phoneNumberVal.split("_")[6];
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		//var areaCode=$("#p_cust_areaId").attr("areaCode");
		var areaCode=  $(obj).attr("zoneNumber");
		if(areaCode==null || areaCode==""){
			areaCode =OrderInfo.staff.areaCode;
		} 
		if(phoneNumber){
			var oldrelease=false;
			var oldPhoneNumber="";
			var oldAnTypeCd="";
			if(subPage=='terminal'||subPage=='number'){
				oldPhoneNumber=_boProdAn.accessNumber;
				oldAnTypeCd=_boProdAn.anTypeCd;
				/*if(oldPhoneNumber==phoneNumber){
					$.alert("提示","号码已经被预占,请选择其它号码!");
					return;
				}*/
			}else if(subPage=='offer'){
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].prodId==subnum){
						oldPhoneNumber=OrderInfo.boProdAns[i].accessNumber;
						oldAnTypeCd=OrderInfo.boProdAns[i].anTypeCd;
						break;
					}
				}
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].prodId!=subnum){
						if(OrderInfo.boProdAns[i].accessNumber==phoneNumber){
							$.alert("提示","你已经选择了该号码,请选择其它号码!");
							return;
						}
					}
				}
			}
			if(oldPhoneNumber!=""){
				oldrelease=true;
				for(var i=0;i<idcode.length;i++){//身份证预占的号码不需要被释放
					if(idcode[i]==oldPhoneNumber){
						oldrelease=false;
						break;
					}
				}
				if(oldrelease){
					var purchaseUrl=contextPath+"/mktRes/phonenumber/purchase";
					var params={"oldPhoneNumber":oldPhoneNumber,"oldAnTypeCd":oldAnTypeCd};
					$.callServiceAsJson(purchaseUrl, params, {});
				}
			}
			idcode.push(phoneNumber);
			if(subPage=='number'){
				var content$=$("#order_fill_content");
				content$.html('');
				_boProdAn.accessNumber=phoneNumber;
				_boProdAn.anTypeCd=anTypeCd;
				_boProdAn.level=plevel;
				_boProdAn.org_level=orgLevel;
				_boProdAn.anId=phoneNumId;
				_boProdAn.areaId=areaId;
				_boProdAn.areaCode =areaCode;
				_boProdAn.memberRoleCd=memberRoleCd;
				_boProdAn.idFlag=0;
				order.service.boProdAn = _boProdAn;
				_qryOfferInfoByPhoneNumFee();
			}else if(subPage=='terminal'){
				mktRes.terminal.setNumber(phoneNumber, plevel);
				_boProdAn.accessNumber=phoneNumber;
				_boProdAn.anTypeCd=anTypeCd;
				_boProdAn.level=plevel;
				_boProdAn.org_level=orgLevel;
				_boProdAn.anId=phoneNumId;
				_boProdAn.areaId=areaId;
				_boProdAn.areaCode =areaCode;
				_boProdAn.memberRoleCd=memberRoleCd;
				_boProdAn.idFlag=0;
				order.service.boProdAn = _boProdAn;
				$("#div_phoneNbr_choose").popup("close");
			}else if(subPage=='offer'){
				_boProdAn.anTypeCd=anTypeCd;
				_boProdAn.anId=phoneNumId;
				_boProdAn.accessNumber=phoneNumber;
				_boProdAn.level=plevel;
				_boProdAn.org_level=orgLevel;
				_boProdAn.areaId=areaId;
				_boProdAn.areaCode =areaCode;
				$("#choosedNum_"+subnum).val(phoneNumber);
				var isExists=false;
				if(OrderInfo.boProdAns.length>0){
					for(var i=0;i<OrderInfo.boProdAns.length;i++){
						if(OrderInfo.boProdAns[i].prodId==subnum){
							OrderInfo.boProdAns[i].accessNumber=phoneNumber;
							OrderInfo.boProdAns[i].anTypeCd=anTypeCd;
							OrderInfo.boProdAns[i].pnLevelId=plevel;
							OrderInfo.boProdAns[i].anId=phoneNumId;
							OrderInfo.boProdAns[i].areaId=areaId;
							OrderInfo.boProdAns[i].areaCode =areaCode;
							OrderInfo.boProdAns[i].memberRoleCd=memberRoleCd;
							OrderInfo.boProdAns[i].idFlag=0;
							isExists=true;
							OrderInfo.setProdAn(OrderInfo.boProdAns[i]);  //保存到产品实例列表里面
							order.dealer.changeAccNbr(subnum,phoneNumber); //选号玩要刷新发展人管理里面的号码
							break;
						}
					}
				}
				if(!isExists){
					var param={
						prodId : subnum, //从填单页面头部div获取
						accessNumber : phoneNumber, //接入号
						anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
						anId : phoneNumId, //接入号ID
						anTypeCd : anTypeCd, //号码类型
						pnLevelId:plevel,
						state : "ADD", //动作	,新装默认ADD	
						areaId:areaId,
						areaCode:areaCode,
						memberRoleCd:memberRoleCd,
						idFlag:0,
						preStore:preStoreFare,
						minCharge:pnPrice
					};
					OrderInfo.boProdAns.push(param);
				}
				$("#div_phoneNbr_choose").popup("close");
				if(subnum=='-1'){
					OrderInfo.boCustInfos.telNumber=phoneNumber;
				}
			}
		} else {
			$.alert("提示","号码格式不正确!");
		}
	};
	//已选号码填单页面初始化
	var _initOffer=function(subnum){
		if(_boProdAn.accessNumber!=''){
			$("#choosedNum_"+subnum).val(_boProdAn.accessNumber);
			order.dealer.changeAccNbr(subnum,_boProdAn.accessNumber);
			var isExists=false;
			if(OrderInfo.boProdAns.length>0){
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].prodId==subnum){
						OrderInfo.boProdAns[i].accessNumber=_boProdAn.accessNumber;
						OrderInfo.boProdAns[i].anTypeCd=_boProdAn.anTypeCd;
						OrderInfo.boProdAns[i].anId=_boProdAn.anId;
						OrderInfo.boProdAns[i].pnLevelId=_boProdAn.level;
						OrderInfo.boProdAns[i].areaId=_boProdAn.areaId;
						OrderInfo.boProdAns[i].memberRoleCd=_boProdAn.memberRoleCd;
						if(_boProdAn.idFlag){
							OrderInfo.boProdAns[i].idFlag=_boProdAn.idFlag;
						}
						OrderInfo.setProdAn(OrderInfo.boProdAns[i]);  //保存到产品实例列表里面
						order.dealer.changeAccNbr(subnum,phoneNumber); //选号玩要刷新发展人管理里面的号码
						isExists=true;
						break;
					}
				}
			}
			if(!isExists){
				var param={
					prodId : subnum, //从填单页面头部div获取
					accessNumber : _boProdAn.accessNumber, //接入号
					anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
					anId : _boProdAn.anId, //接入号ID
					pnLevelId:_boProdAn.level,
					anTypeCd : _boProdAn.anTypeCd, //号码类型
					state : "ADD", //动作	,新装默认ADD
					areaId:_boProdAn.areaId,
					areaCode:_boProdAn.areaCode,
					memberRoleCd:_boProdAn.memberRoleCd
				};
				if(_boProdAn.idFlag){
					param.idFlag=_boProdAn.idFlag;
				}
				OrderInfo.boProdAns.push(param);
			}
			if(subnum=='-1'){
				OrderInfo.boCustInfos.telNumber=_boProdAn.accessNumber;
			}
		}
	};
	//加载套餐数据
	var _qryOfferInfoByPhoneNumFee=function(){
		var param={"numsubflag":"number"};
		$.callServiceAsHtmlGet(contextPath+"/pad/order/prodoffer/prepare",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response||response.code != 0){
					 response.data='查询失败,稍后重试';
				}
				var content$ = $("#order_prepare").html(response.data).fadeIn();
				$.jqmRefresh(content$);
				//order.service.initSpec();
				//order.prodOffer.init();
				order.prepare.initOffer();
				order.service.searchPack();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	
	//号码预占
	var _btnPurchase=function(obj,needPsw){
		phoneNumberVal = $(obj).attr("numberVal"); 
		var memberRoleCd=CONST.MEMBER_ROLE_CD.MAIN_CARD;
		//选号类型：新装主卡选号、新装副卡选号 Y1、Y2
		var subFlag=$("#subFlag").val();
		if(subFlag=='Y2'){
			memberRoleCd=CONST.MEMBER_ROLE_CD.VICE_CARD;
		}
		//订单序号：O1、O2区分暂存单允许多个订单的情况
		var subnum=$("#subnum").val();
		//入口终端入口，号码入口，订单填写入口:terminal\offer\number
		var subPage=$("#subPage").val();
		//号码的预存话费
		var preStoreFare=phoneNumberVal.split("_")[1];
		//保底消费
		var pnPrice=phoneNumberVal.split("_")[2];
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		var areaCode=  $(obj).attr("zoneNumber");
		//var areaCode=$("#p_cust_areaId").attr("areaCode");
		if(areaCode==null || areaCode==""){
			areaCode =OrderInfo.staff.areaCode;
		} 
		if(order.service.offerprice!=''){
			var minMonthFare=parseInt(pnPrice);
			//套餐月基本费用
			var packageMonthFare=parseInt(order.service.offerprice);
			if(packageMonthFare<minMonthFare){
				$.alert("提示","对不起,此号码不能被选购.(原因:套餐月基本费用必须大于号码月保底消费)");
				return;
			}
		}
		//正在被预占的号码
		var phoneNumber=phoneNumberVal.split("_")[0];
		var anTypeCd=phoneNumberVal.split("_")[3];
		if(phoneNumber){
			var phoneAreaId = $("#p_cust_areaId").val();
			var params={};
			if(needPsw){
				 params={"phoneNumber":phoneNumber,"actionType":"E","anTypeCd":anTypeCd,"areaId":phoneAreaId,"attrList":[{"attrId":"65010036","attrValue":needPsw}]};
			}else{
				 params={"phoneNumber":phoneNumber,"actionType":"E","anTypeCd":anTypeCd,"areaId":phoneAreaId};
			}
			var oldrelease=false;
			var oldPhoneNumber="";
			var oldAnTypeCd="";
			if(subPage=='terminal'||subPage=='number'){
				oldPhoneNumber=_boProdAn.accessNumber;
				oldAnTypeCd=_boProdAn.anTypeCd;
				if(oldPhoneNumber==phoneNumber){
					$.alert("提示","号码已经被预占,请选择其它号码!");
					return;
				}else{
					_boProdAn={};
				}
			}else if(subPage=='offer'){
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].prodId==subnum){
						oldPhoneNumber=OrderInfo.boProdAns[i].accessNumber;
						oldAnTypeCd=OrderInfo.boProdAns[i].anTypeCd;
						break;
					}
				}
				for(var i=0;i<OrderInfo.boProdAns.length;i++){
					if(OrderInfo.boProdAns[i].accessNumber==phoneNumber){
						$.alert("提示","号码已经被预占,请选择其它号码!");
						return;
					}
				}
			}
			if(oldPhoneNumber&&oldPhoneNumber!=""){
				oldrelease=true;
				for(var i=0;i<idcode.length;i++){//身份证预占的号码不需要被释放
					if(idcode[i]==oldPhoneNumber){
						oldrelease=false;
						break;
					}
				}
				if(oldrelease){
					if(needPsw){
						params={"newPhoneNumber":phoneNumber,"oldPhoneNumber":oldPhoneNumber,"newAnTypeCd":anTypeCd,"oldAnTypeCd":oldAnTypeCd,"areaId":phoneAreaId,"attrList":[{"attrId":"65010036","attrValue":needPsw}]};
					}else{
						params={"newPhoneNumber":phoneNumber,"oldPhoneNumber":oldPhoneNumber,"newAnTypeCd":anTypeCd,"oldAnTypeCd":oldAnTypeCd,"areaId":phoneAreaId};
					}
				}
			}
			
			var purchaseUrl=contextPath+"/app/mktRes/phonenumber/purchase";//"/mktRes/phonenumber/purchase";
			$.callServiceAsJson(purchaseUrl, params, {
				"before":function(){
					$.ecOverlay("<strong>正在预占号码,请稍等会儿....</strong>");
				},"always":function(){
					$.unecOverlay();
				},	
				"done" : function(response){
					if (response.code == 0) {
						if(selectedLevel==""){//selectedLevel缓存号码等级信息，以缓存的为准
							selectedLevel=response.data.phoneLevelId;
						}
						if(subPage=='number'){
							var content$=$("#order_fill_content");
							content$.html('');
							_boProdAn.accessNumber=phoneNumber;
							_boProdAn.anTypeCd=anTypeCd;
							_boProdAn.level=selectedLevel;
							_boProdAn.org_level=response.data.phoneLevelId;
							_boProdAn.anId=response.data.phoneNumId;
							_boProdAn.areaId=areaId;
							_boProdAn.areaCode = areaCode;
							_boProdAn.memberRoleCd=memberRoleCd;
							_boProdAn.preStore=preStoreFare;
							_boProdAn.minCharge=pnPrice;
							order.service.boProdAn = _boProdAn;
							_qryOfferInfoByPhoneNumFee();
						}else if(subPage=='terminal'){
							mktRes.terminal.setNumber(phoneNumber, response.data.phoneLevelId);
							_boProdAn.accessNumber=phoneNumber;
							_boProdAn.anTypeCd=anTypeCd;
							_boProdAn.level=selectedLevel;
							_boProdAn.org_level=response.data.phoneLevelId;
							_boProdAn.anId=response.data.phoneNumId;
							_boProdAn.areaId=areaId;
							_boProdAn.areaCode = areaCode;
							_boProdAn.memberRoleCd=memberRoleCd;
							_boProdAn.preStore=preStoreFare;
							_boProdAn.minCharge=pnPrice;
							order.service.boProdAn = _boProdAn;
							$("#div_phoneNbr_choose").popup("close");
						}else if(subPage=='offer'){
							$("#choosedNum_"+subnum).val(phoneNumber);
							_boProdAn.accessNumber=phoneNumber;
							_boProdAn.level=selectedLevel;
							_boProdAn.org_level=response.data.phoneLevelId;
							_boProdAn.areaId=areaId;
							_boProdAn.anTypeCd=anTypeCd;
							_boProdAn.preStore=preStoreFare;
							_boProdAn.minCharge=pnPrice;
							_boProdAn.anId=response.data.phoneNumId;
							var isExists=false;
							if(OrderInfo.boProdAns.length>0){//判断是否选过
								for(var i=0;i<OrderInfo.boProdAns.length;i++){
									if(OrderInfo.boProdAns[i].prodId==subnum){
										OrderInfo.boProdAns[i].accessNumber=phoneNumber;
										OrderInfo.boProdAns[i].anTypeCd=anTypeCd;
										OrderInfo.boProdAns[i].pnLevelId=selectedLevel;
										OrderInfo.boProdAns[i].anId=response.data.phoneNumId;
										OrderInfo.boProdAns[i].areaId=areaId;
										OrderInfo.boProdAns[i].areaCode = areaCode;
										OrderInfo.boProdAns[i].memberRoleCd=memberRoleCd;
										OrderInfo.boProdAns[i].preStore=preStoreFare;
										OrderInfo.boProdAns[i].minCharge=pnPrice;
										isExists=true;
										if(OrderInfo.offerSpec.offerRoles!=undefined){
											OrderInfo.setProdAn(OrderInfo.boProdAns[i]);  //保存到产品实例列表里面
										}
										order.dealer.changeAccNbr(subnum,phoneNumber); //选号玩要刷新发展人管理里面的号码
										break;
									}
								}
							}
							if(!isExists){
								var param={
									prodId : subnum, //从填单页面头部div获取
									accessNumber : phoneNumber, //接入号
									anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
									anId : response.data.phoneNumId, //接入号ID
									pnLevelId:selectedLevel,
									anTypeCd : anTypeCd, //号码类型
									state : "ADD", //动作	,新装默认ADD	
									areaId:areaId,
									areaCode:areaCode,
									memberRoleCd:memberRoleCd,
									preStore:preStoreFare,
									minCharge:pnPrice
								};
								OrderInfo.boProdAns.push(param);
								if(OrderInfo.offerSpec.offerRoles!=undefined){
									OrderInfo.setProdAn(param);//保存到产品实例列表里面
								}
								order.dealer.changeAccNbr(subnum,phoneNumber);//选号玩要刷新发展人管理里面的号码
							}
							if(subnum=='-1'){
								OrderInfo.boCustInfos.telNumber=phoneNumber;
							}
							$("#div_phoneNbr_choose").popup("close");
						}
					}else if (response.code == -2) {
						$.alertM(response.data);
					}else{
						var msg="";
						if(response.data!=undefined&&response.data.msg!=undefined){
							msg=response.data.msg;
						}else{
							msg="号码["+phoneNumber+"]预占失败";
						}
						$.alert("提示","号码预占失败，可能原因:"+msg);
					}
				},
				fail:function(response){
					$.unecOverlay();
					$.alert("提示","请求可能发生异常，请稍后再试！");
				}
			});
		} else {
			$.alert("提示","号码格式不正确!");
		}
	};
	
	//构造查询条件 
	var _buildInParam = function(param){
		var query_flag_01= $('#passyz').val();
		var areaId="";
		if(OrderInfo.cust==undefined || OrderInfo.cust.custId==undefined || OrderInfo.cust.custId==""){
			areaId=$("#p_cust_areaId").val();
		}else{
			areaId=OrderInfo.getAreaId();
		}
		var pnHead = $.trim($("#pnHead option:selected").val());
		var pnEnd =$.trim($("#pnEnd").val());
		if(pnEnd=='最后四位'){
			pnEnd='';
		}
		var phoneNum='';
		var Greater  = "";
		var Less  ="";
		var preStore=$.trim($("#preStore option:selected").val());
		var preStoreArry=preStore.split("-");
		if(preStoreArry.length==2){
			Greater=preStoreArry[0];
			Less=preStoreArry[1];
		}else{
			preStoreArry=preStoreArry.toString();
			Greater=preStoreArry.substring(0,preStoreArry.length-2);
			Less="";
		}
		var poolId = $.trim($("#nbrPool option:selected").val());	
		var pnCharacterId=$.trim($("#pnCharacterId option:selected").val());	
		return {"pnHead":pnHead,"pnEnd":pnEnd,"goodNumFlag":pnCharacterId,"maxPrePrice":Less,
			"minPrePrice":Greater,"pnLevelId":'',"pageSize":"16","phoneNum":phoneNum,"areaId":areaId,"poolId":poolId,
			"queryFlag":query_flag_01
		};
	};
	var _idcardCheck=function(num){
		num = num.toUpperCase();
		if(!(/(^\d{15}$)|(^\d{17}([0-9]|X)$)/.test(num)))//是否15位数字或者17位数字加一位数字或字母X
		{
			return false;
		}
		var len, re;
		len = num.length;
		if(len == 15) {
			re = new RegExp(/^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/);
			var arrSplit = num.match(re);
			var dtmBirth = new Date('19' + arrSplit[2] + '/' + arrSplit[3] + '/' + arrSplit[4]);
			var bGoodDay;
			bGoodDay = (dtmBirth.getYear() == Number(arrSplit[2])) && ((dtmBirth.getMonth() + 1) == Number(arrSplit[3])) && (dtmBirth.getDate() == Number(arrSplit[4]));
			if(!bGoodDay) {
				return false;
			} else {
				var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
				var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
				var nTemp = 0, i;
				num = num.substr(0, 6) + '19' + num.substr(6, num.length - 6);
				for( i = 0; i < 17; i++) {
					nTemp += num.substr(i, 1) * arrInt[i];
				}
				num += arrCh[nTemp % 11];
				return num;
			}
		}
		if(len == 18) {
			re = new RegExp(/^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/);
			var arrSplit = num.match(re);
			var dtmBirth = new Date(arrSplit[2] + "/" + arrSplit[3] + "/" + arrSplit[4]);
			var bGoodDay;
			bGoodDay = (dtmBirth.getFullYear() == Number(arrSplit[2])) && ((dtmBirth.getMonth() + 1) == Number(arrSplit[3])) && (dtmBirth.getDate() == Number(arrSplit[4]));
			if(!bGoodDay) {
				return false;
			} else {
				var valnum;
				var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
				var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
				var nTemp = 0, i;
				for( i = 0; i < 17; i++) {
					nTemp += num.substr(i, 1) * arrInt[i];
				}
				valnum = arrCh[nTemp % 11];
				if(valnum != num.substr(17, 1)) {
					return false;
				}
				return num;
			}
		}
		return false;
	};
	var _initPage=function(){		
		var url=contextPath+"/pad/mktRes/phonenumber/prepare";
		var param={};
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response){
					 response.data='选号页面加载异常,稍后重试';
				}
				if(response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				var content$=$("#order_tab_panel_content");
				content$.html(response.data);
				$.jqmRefresh(content$);
				_boProdAn = {accessNumber : "",level : "",anId : "",anTypeCd : ""};
				_initPhonenumber();
			}
		});	
	};
	var _initPhonenumber=function(){
		selectedObj=null;
		selectedLevel="";
		_queryApConfig();
		//查询号池
		queryPhoneNbrPool();
		//查询号码预存和保底金额
		queryPnLevelProdOffer();
		var param={};
		_btnQueryPhoneNumber(param);
		//点击更多显示更多查询条件
		$("#searchmore").on("tap",function(){
			var obj=$(this);
			$("#moresearch").slideToggle(400);
			obj.toggleClass("ui-icon-plus");
			obj.toggleClass("ui-icon-minus");
		});
		$("#form_phonenumber_qry").find("select").off("change").on("change",function(){
			_btnQueryPhoneNumber(param);
			$(this).selectmenu("refresh");
		});
		
		//给搜索输入框绑定回车事件
		$("#idCode").off("keydown").on("keydown", function(e){
			var ev = document.all ? window.event : e; 
			if(ev.keyCode==13) {
				_btnIBydentityQuery(param);
			}
		});
		$("#pnEnd").off("keydown").on("keydown", function(e){
			var ev = document.all ? window.event : e; 
			if(ev.keyCode==13) {
				_btnQueryPhoneNumber(param);
			}
		});
	};
	var call_back_success_queryApConfig=function(response){
		var PHONE_NUMBER_PRESTORE;
		var PHONE_NUMBER_SEGMENT;
		var PHONE_NUMBER_FEATURE;
		if(response.data){
			var dataLength=response.data.length;
			//号码预存话费
			for (var i=0; i < dataLength; i++) {
				if(response.data[i].PHONE_NUMBER_PRESTORE){
				  	PHONE_NUMBER_PRESTORE=response.data[i].PHONE_NUMBER_PRESTORE;
				  	for(var m=0;m<PHONE_NUMBER_PRESTORE.length;m++){
				  		var  preStore=PHONE_NUMBER_PRESTORE[m].COLUMN_VALUE_NAME.replace(/\"/g, "");
			  			preStore=preStore.replace(/\"/g, "");
				  		$("#preStore").append("<option  value="+preStore+">"+preStore+"</option>");
				  	}
			  		$("#preStore").selectmenu("refresh");
				}
			};
			//号段
			for (var i=0; i < dataLength; i++) {
				if(response.data[i].PHONE_NUMBER_SEGMENT){
				  	PHONE_NUMBER_SEGMENT=response.data[i].PHONE_NUMBER_SEGMENT;
				  	for(var m=0;m<PHONE_NUMBER_SEGMENT.length;m++){
				  		var  numberStart=PHONE_NUMBER_SEGMENT[m].COLUMN_VALUE_NAME;
				  		numberStart=numberStart.replace(/\"/g, "");
				  		$("#pnHead").append("<option  value="+numberStart+">"+numberStart+"</option>");
				  	}
			  		$("#pnHead").selectmenu("refresh");
				}
			};
			//号码特征
			for (var i=0; i < dataLength; i++) {
				if(response.data[i].PHONE_NUMBER_FEATURE){
					PHONE_NUMBER_FEATURE=response.data[i].PHONE_NUMBER_FEATURE;
				  	for(var m=0;m<PHONE_NUMBER_FEATURE.length;m++){
				  		var numberFeature=(PHONE_NUMBER_FEATURE[m].COLUMN_VALUE_NAME).replace(/\"/g, "");
				  		var numberFeatureVal=(PHONE_NUMBER_FEATURE[m].COLUMN_VALUE).replace(/\"/g, "");
				  		$("#pnCharacterId").append("<option value="+numberFeatureVal+">"+numberFeature+"</option>");
				  	}
			  		$("#pnCharacterId").selectmenu("refresh");
				}
			};
		}
		
	};
	//查询平台配置信息
	var _queryApConfig=function(){
		var configParam={"CONFIG_PARAM_TYPE":"TERMINAL_AND_PHONENUMBER"};
		var qryConfigUrl=contextPath+"/order/queryApConf";
		$.callServiceAsJsonGet(qryConfigUrl, configParam,{
			"done" : call_back_success_queryApConfig
		});
	};
	
	//查询号池
	var queryPhoneNbrPool = function(){
		var url=contextPath+"/mktRes/phonenumber/queryPhoneNbrPool";
		var param={};
		var response = $.callServiceAsJson(url,param);
		if (response.code==0) {
			if(response.data){
				var phoneNbrPoolList= response.data.phoneNbrPoolList;
				var $sel = $("#nbrPool");  
				if(phoneNbrPoolList!=null){
					$.each(phoneNbrPoolList,function(){
						var $option = $('<option value="'+this.poolId+'">'+this.poolName+'</option>');
						$sel.append($option);
						$sel.selectmenu("refresh");
					});
				}
			}
		}else if(response.code == -2){
			$.alertM(response.data);
		}else{
			$.alert("提示","号池加载失败，请稍后再试！");
		}
	};
	//靓号预存和保底金额查询
	var queryPnLevelProdOffer = function(str){
		var url=contextPath+"/mktRes/phonenumber/queryPnLevelProdOffer";
		var areaId = "";
		if(order.ysl!=undefined||str!=undefined){
			areaId=$("#_session_staff_info").attr("areaid");
		}else{
			areaId=$("#p_cust_areaId").val();
		}
		areaId = areaId.substring(0,3)+"0000";
		var param={"areaId":areaId};
		var response = $.callServiceAsJson(url,param);
	};
	
	//设置号码等级
	var _qryPhoneNbrLevelInfoList=function(){
		if(selectedObj==undefined||selectedObj==null){
			$.alert("提示","请先选择号码！");
			return;
		}
		var phoneNumberVal = $(selectedObj).attr("numberVal"); 
		var plevel=phoneNumberVal.split("_")[5];
		var phoneNumber=phoneNumberVal.split("_")[0];
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		var qryUrl=contextPath+"/mktRes/qryPhoneNbrLevelInfoList";
		$.ligerDialog.open({
			width:560,
			height:350,
			allowClose:false,
			title:'设置号码等级（'+phoneNumber+"）",
			url:qryUrl+"?pnLevelId="+selectedLevel+"&areaId="+areaId+"&org_level="+plevel,
			buttons: [ { text: '确定', onclick:function (item, dialog) {
				var strs=phoneNum_level.split("_");////全局变量，保存“号码等级_预存金额_保底金额”，由弹出框的iframe，赋值
				dialog.close(); 
				//设置选择的样式
				$(".select_nbr_li").each(function(){
					if($(this).hasClass("select")){
						var numberval=$(this).attr("numberval").split("_");
						var tx;
						if(phoneNum_level!=undefined&&phoneNum_level!=""&&numberval[5]!=strs[0]){
							tx="<span style='float:left;margin-left:10px;'>预存<span class='orange'>"+numberval[1]+"</span>元<br/>保底<span class='orange'>"+numberval[2]+"</span>元</span><span style='float:right;margin-right:10px;'>预存<span class='orange'>"+strs[1]+"</span>元<br/>保底<span class='orange'>"+strs[2]+"</span>元</span><span style='width: 15px; display: table; height: 30px; padding-top: 10px;'><img  src='"+contextPath+"/image/common/levelArrow.png'></span>";
						}else{
							tx="<span style='padding-left:10px;'>预存<span class='orange'>"+numberval[1]+"</span>元</span> <span style='padding-left:10px;'> 保底<span class='orange'>"+numberval[2]+"</span>元</span>";
						}
						$(this).find("div").html(tx);
					}
				});
				//保存刚修改的值
				selectedLevel=strs[0];
			} }, { text: '关闭', onclick: function (item, dialog) { dialog.close(); } }] 	
		});
	};
	//结束选号，不通的模块要做的动作不相同
	var _endSelectNum=function(){
		if(selectedObj==undefined||selectedObj==null){
			$.alert("提示","请先选择号码！");
			return;
		}
		if(ispurchased==1){
			_btnToOffer(selectedObj);
		}else{
			var phoneNumberVal_06 = $(selectedObj).attr("numberVal").split("_")[7]; 
			//phoneNumberVal_06="1";
			if(phoneNumberVal_06=="1"){
				//$("#dlg-phonenumber-pwd").popup("open");
				$("#dlg-phonenumber-pwd").show();
				$("#phoneNbrSurebtn").off("tap").on("tap",function(event){
					_preePassword();
				});
				$("#phoneNbrCancelbtn").off("tap").on("tap",function(event){
					$("#dlg-phonenumber-pwd").hide();
				});
			}else{
				_btnPurchase(selectedObj);
			}
		}
	};
	
	/**
	 * 靓号预占 密码校验
	 */
	var _preePassword=function(){
		var pree_password_text=$("#pree_password_text").val();
		if($.trim(pree_password_text)==""){
			$.alert("提示","预占密码不能为空！");
		}else{
			//$("#dlg-phonenumber-pwd").dialog("close");
			$("#dlg-phonenumber-pwd").hide();
			$("#pree_password_text").val("");//初始化
			_btnPurchase(selectedObj,pree_password_text);
		}
	};
	//弹出选择号码窗口
	//subPage入口:终端入口，号码入口，订单填写入口:terminal\offer\number
	//subnum订单序号：O1、O2区分暂存单允许多个订单的情况
	//subFlag选号类型：新装主卡选号、新装副卡选号 Y1、Y2
	var _phoneNumDialog=function(subPage,subFlag,subnum){
			var param={"subPage":subPage};
			var url=contextPath+"/pad/mktRes/phonenumber/prepare";
			$.callServiceAsHtmlGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					if(!response){
						 response.data='<div style="margin:2px 0 2px 0;width:100%,height:100%;text-align:center;"><strong>not data return,please try reload again.</strong></div>';
					}
					if(response.code != 0) {
						$.alert("提示","查询失败,稍后重试");
						return;
					}
					//统一弹出框
					var popup = $.popup("#div_phoneNbr_choose",response.data,{
						width:$(window).width()-50,
						height:$(window).height(),
						contentHeight:$(window).height()-120,
						afterClose:function(){}
					});
					$("#moresearch").width($(window).width()-50-60);
					$("#idCode").parent().css("float","left");
					$("#pnEnd").parent().css("float","left");
					$(".search").css("position","fixed");
					$(".search").css("top","50px");
					$(".numbertitle").css("top","90px");
					$("#subPage").val(subPage);
					$("#subFlag").val(subFlag);
					$("#subnum").val(subnum);
					if(OrderInfo.provinceInfo!=undefined&&OrderInfo.provinceInfo.prodOfferId!=undefined&&OrderInfo.provinceInfo.prodOfferId!=""){
						$("#phone_num_btn").tap(function(){$("#div_phoneNbr_choose").popup("close");});
					}
					mktRes.phoneNbr.initPhonenumber();
					
					$("#nbrPool-button").css({"width":"65px","padding":"5px 40px 6px 20px"});
					$("#pnCharacterId-button").css({"width":"35px","padding":"5px 40px 6px 20px"});
					$("#preStore-button").css({"width":"35px","padding":"5px 40px 6px 20px"});
				}
			});	
	};
	return {
		qryPhoneNbrLevelInfoList:_qryPhoneNbrLevelInfoList,
		endSelectNum:_endSelectNum,
		phoneNumDialog :_phoneNumDialog,
		btnQueryPhoneNumber : _btnQueryPhoneNumber,
		queryApConfig:_queryApConfig,
		initPhonenumber:_initPhonenumber,
		boProdAn:_boProdAn,
		resetBoProdAn:_resetBoProdAn,
		btnIBydentityQuery:_btnIBydentityQuery,
		initOffer:_initOffer,
		initPage:_initPage,
		preePassword:_preePassword,
		queryPhoneNbrPool:queryPhoneNbrPool,
		queryFlag:_queryFlag,
		queryPnLevelProdOffer:queryPnLevelProdOffer,
		queryPhoneNumber:_queryPhoneNumber
	};
})();
/**
 * uim卡管理
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("prod","uim");

prod.uim = (function() {
	
	//uim卡号校验
	var _checkUim = function(prodId){
		var phoneNumber = OrderInfo.getAccessNumber(prodId);
		var offerId = "-1"; //新装默认，主销售品ID
		if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14||(OrderInfo.actionFlag==2&&offerChange.newMemberFlag)){ //新装需要选号
			if(phoneNumber==''){
				$.alert("提示","校验UIM卡前请先选号!");
				return false;
			}
		}
		if(OrderInfo.actionFlag==3 || OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23 || OrderInfo.actionFlag==6 ){ //可选包变更，补换卡，加装副卡
			offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
		}
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}
		var inParam = {
			"instCode" : cardNo,
			"phoneNum" : phoneNumber
		};

		var prodSpecId = OrderInfo.getProdSpecId(prodId);
		var mktResCd="";
		if(CONST.getAppDesc()==0){
			if(getIsMIFICheck(prodId)){
				mktResCd =getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID);
			}else{
				mktResCd = getMktResCd(prodSpecId);
			}
			if(ec.util.isObj(mktResCd)){
//				inParam.mktResCd = mktResCd;
			}else{
				$.alert("提示","查询卡类型失败！");
				return;
			}
		}
		var data = query.prod.checkUim(inParam);//校验uim卡
		if(data==undefined || data.baseInfo==undefined){
			return false;
		}
		//根据uim返回数据组织物品节点
		var couponNum = data.baseInfo.qty ;
		if(couponNum==undefined||couponNum==null){
			couponNum = 1 ;
		}
		var coupon = {
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "1",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId : data.baseInfo.mktResId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : "3000", //物品费用项类型
			couponNum : couponNum, //物品数量
			storeId : data.baseInfo.mktResStoreId, //仓库ID
			storeName : "1", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : data.baseInfo.mktResInstCode, //物品实例编码
			terminalCode : data.baseInfo.mktResInstCode,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId :  prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "ADD", //动作
			relaSeq : "" //关联序列	
		};
		if(CONST.getAppDesc()==0){
			coupon.cardTypeFlag=data.baseInfo.cardTypeFlag;//UIM卡类型
		}
		$("#uim_check_btn_"+prodId).attr("disabled",true);
		$("#uim_release_btn_"+prodId).attr("disabled",false);
		$("#uim_txt_"+prodId).attr("disabled",true);
		if(getIsMIFICheck(prodId)){//判断是否通过MIFI 校验
			$("#isMIFI_"+prodId).val("yes");
		}else{
			$("#isMIFI_"+prodId).val("no");
		}
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
	};
	
	/*
	 * 是否是MIFI卡类型校验
	 */
	var getIsMIFICheck=function(prodId){
		var prodIdTmp=(Math.abs(prodId)-1);
		if(AttachOffer.openServList.length>prodIdTmp){
			var specList = AttachOffer.openServList[prodIdTmp].servSpecList;
			for (var j = 0; j < specList.length; j++) {
				var spec = specList[j];
				if(spec.isdel!="Y" && spec.isdel!="C"){
					if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID && CONST.APP_DESC==0){
						return true ; 
					}
				}
			}
		}
		return false;
	};
	
	var getMktResCd = function(prodSpecId){
		var param={
			"prodSpecId":prodSpecId
		};
		var url = contextPath+"/mktRes/uim/getMktResCd";
		$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == "0") {
			return response.data;
		}else{
			return "";
		}
	};
	
	//uim卡号释放
	var _releaseUim = function(prodId){	
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}
		//释放UIM并更新门户记录
		var param = {
				numType : 2,
				numValue : cardNo
		};
		var jr = $.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);			
		if(jr.code==-2){
			$.alertM(jr.data);
			return;
		}
		if(jr.code==-1){
			$.alert("提示",jr.data);
			return;
		}
		$.alert("提示","成功释放UIM卡："+cardNo);
		$("#uim_check_btn_"+prodId).attr("disabled",false);
		$("#uim_release_btn_"+prodId).attr("disabled",true);
		$("#uim_txt_"+prodId).attr("disabled",false);
		$("#uim_txt_"+prodId).val("");
		OrderInfo.clearProdUim(prodId);
	};
	
	//保存旧卡
	var _setOldUim = function(offerId ,prodId,uim){
		var oldUim={
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "2",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId :uim.couponId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : CONST.ACCT_ITEM_TYPE.UIM_CHARGE_ITEM_CD, //物品费用项类型
			couponNum : 1, //物品数量
			//storeId : oldUimInfo.storeId, //仓库ID
			storeId : 1, //仓库ID
			storeName : "11", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : uim.couponInsNumber, //物品实例编码
			terminalCode : uim.couponInsNumber,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId : prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "DEL", //动作
			relaSeq : "", //关联序列
			id:0,
			isOld : "T"  //旧卡
		};
		OrderInfo.boProd2OldTds.push(oldUim);
		order.prodModify.choosedProdInfo.extCouponInstanceId = uim.extCouponInstanceId;
		order.prodModify.choosedProdInfo.corCouponInstanceId = uim.corCouponInstanceId;
	};

	//根据UIM类型，设置产品是3G还是4G，并且保存uim卡
	var _setProdUim = function(){
		OrderInfo.boProd2OldTds = []; //清空旧卡
		var flag = true;
		if(OrderInfo.actionFlag==3 || OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23){ //可选包变更，补换卡
			var prod = order.prodModify.choosedProdInfo; 
			var uim = query.prod.getTerminalInfo(prod);
			if(uim == undefined){  //查询旧卡信息失败返回
				return false;
			}
			_setOldUim(prod.prodOfferInstId,prod.prodInstId,uim); //保存旧卡信息
			if(uim.is4GCard=="Y"){
				prod.prodClass = CONST.PROD_CLASS.FOUR;
			}else{
				prod.prodClass = CONST.PROD_CLASS.THREE;
			}
		}else{
			var prod = {};
			$.each(OrderInfo.offer.offerMemberInfos,function(){
				if(this.objType==CONST.OBJ_TYPE.PROD){ //接入类产品
					prod.prodInstId = this.objInstId;
					prod.accNbr = this.accessNumber;
					var uim = query.prod.getTerminalInfo(prod);
					if(uim == undefined){  //查询旧卡信息失败返回
						flag = false;
						return false;
					}
					_setOldUim(this.offerId,this.objInstId,uim); //保存旧卡信息
					if(uim.is4GCard=="Y"){
						this.prodClass = CONST.PROD_CLASS.FOUR;
					}else{
						this.prodClass = CONST.PROD_CLASS.THREE;
					}
					var prodInfo = order.prodModify.choosedProdInfo; 
					if(prodInfo!=undefined && prodInfo.prodInstId==this.objInstId){
						prodInfo.prodClass = this.prodClass;
					}
				}
			});
		}
		return flag;	
	};
	
	return {
		getMktResCd:getMktResCd,
		checkUim				: _checkUim,
		releaseUim 				: _releaseUim,
		setProdUim				: _setProdUim
	};
})();
/**
 * 产品相关查询
 * 没有任何业务逻辑
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("query","prod");

query.prod = (function() {
	
	/**
	 * 产品规格属性查询
	 * @param  offerSpecId 销售品规格ID
	 * @param  prodSpecId 产品规格ID
	 */
	var _prodSpecParamQuery = function(param){
		addParam(param);
		var url = contextPath + "/prod/prodSpecParamQuery";
		$.ecOverlay("<strong>正在查询产品规格属性中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,param);
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","产品规格属性失败,稍后重试");
			return;
		}
	};
	
	/**
	 * 产品实例属性查询
	 * @param  prodId 产品实例ID
	 * @param  acctNbr 产品接入号码
	 * @param  ifServItem 是否是功能产品
	 */
	var _prodInstParamQuery = function(param){
		addParam(param);
		var url = contextPath + "/prod/prodInstParamQuery";
		$.ecOverlay("<strong>正在查询产品实例属性中,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,param);
		$.unecOverlay();
		if (response.code==0) {
			if(response.data){
				return response.data;
			}
		}else if (response.code==-2){
			$.alertM(response.data);
			return;
		}else {
			$.alert("提示","产品规格属性失败,稍后重试");
			return;
		}
	};
	
	/**
	 * 产品下终端实例数据查询
	 * @param  prodId 产品实例ID
	 * @param  accNbr 产品接入号
	 * @param  areaId  受理地区
	 * @callBackFun 回调函数
	 * @service/intf.soService/queryOfferCouponById
	 */
	var _getTerminalInfo = function(prod){
		var params = {
			prodId: prod.prodInstId,
			areaId: OrderInfo.getProdAreaId(prod.prodInstId),
			acctNbr: prod.accNbr,
			isServiceOpen:"Y"
		};
		$.ecOverlay("<strong>正在查询产品下终端实例数据中,请稍后....</strong>");
		//var response = $.callServiceAsJson(contextPath+"/order/queryTerminalInfo", params, {});
		var response = $.callServiceAsJson(contextPath+"/token/pad/order/queryTerminalInfo", params, {});
		$.unecOverlay();
		if(response.code == 0){
			return response.data;
		}else if (response.code == -2) {
			$.alertM(response.data);
		}else{
			$.alert("错误提示","接口未返回号码["+params.acctNbr+"]产品原UIM卡数据，无法继续受理！");
		}
	};
	
	/**
	 * 产品下账号信息查询
	 * @param  prodId 产品实例ID
	 * @param  acctCd 账号信息
	 * @param  areaId  受理地区
	 * @callBackFun 回调函数
	 * @service/intf.soService/queryOfferCouponById
	 */
	var _queryAcct = function(param,callBackFun) {
		param.isServiceOpen="Y";
		var url= contextPath+"/order/account";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>");
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						callBackFun(response.data);
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询账户信息失败,稍后重试");
					}
				}
			});
		}else{
			$.ecOverlay("<strong>正在查询账户信息中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data.offerSpec;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询账户信息失败,稍后重试");
			}
		}
	};
	
	/**
	 * 终端串号校验
	 */
	var _checkTerminal = function(param){
		var url = contextPath+"/mktRes/terminal/checkTerminal";
		$.ecOverlay("<strong>终端校验中,请稍后....</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == -2) {
			$.alertM(response.data);
		}else if(response.data && response.data.code == 0) {
			return response.data;
		}else if( response.data.code == 1){
			$.alert("提示", response.data.message);
		}else{
			$.alert("提示","<br/>校验失败，请稍后重试！");
		}
	};
	
	//校验UIM卡
	var _checkUim=function(param){
		var url = contextPath+"/mktRes/uim/checkUim";
		$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == 0) {
			$.alert("提示","UIM卡校验成功!");
			return response.data;
		}else{
			if(typeof response == undefined){
				$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常");
			}else if (response.code == -2) {
				$.alertM(response.data);
			}else{
				var msg="";
				if(response.data!=undefined && response.data.msg!=undefined){
					msg=response.data.msg;
				}else{
					msg="卡号["+cardNo+"]预占失败";
				}
				$.alert("提示","UIM卡校验失败，可能原因:"+msg);
			}
		}
	};
	
	//释放UIM卡
	var _releaseUim = function(param){
		var url = contextPath+"/mktRes/uim/checkUim";
		$.ecOverlay("<strong>UIM卡释放中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == 0) {
			$.alert("提示","UIM卡释放成功!");
			return response.data;
		}else{
			if(typeof response == undefined){
				$.alert("提示","UIM卡释放请求调用失败，可能原因服务停止或者数据解析异常");
			}else if (response.code == -2) {
				$.alertM(response.data);
			}else{
				var msg="";
				if(response.data!=undefined && response.data.msg!=undefined){
					msg=response.data.msg;
				}else{
					msg="卡号["+cardNo+"]预占失败";
				}
				$.alert("提示","UIM卡释放失败，可能原因:"+msg);
			}
		}
	};
	
	var _getOldUim = function(){
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		var oldUimInfo = _getTerminalInfo(prodInfo);
		if(oldUimInfo==undefined){
			return;
		}
		var oldUimdata={
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "2",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId :oldUimInfo.couponId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : "3000", //物品费用项类型
			couponNum : 1, //物品数量
			//storeId : oldUimInfo.storeId, //仓库ID
			storeId : 1, //仓库ID
			storeName : "11", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : oldUimInfo.couponInsNumber, //物品实例编码
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId :prodInfo.prodInstId, //产品ID
			offerId : prodInfo.prodOfferInstId, //销售品实例ID
			state : "DEL", //动作
			relaSeq : "", //关联序列
			id:0,
			isOld : "T"  //旧卡
		};
		return oldUimdata;
	};
	
	//检查是否是4G产品实例（是否已开通4G功能产品）
	var _checkIs4GProdInst = function(prodInfo){
		var param = {
			    prodId : prodInfo.prodInstId,
			    prodSpecId : prodInfo.productId,
			    offerSpecId : prodInfo.prodOfferId,
			    acctNbr : prodInfo.accNbr
		};
		var data = query.offer.queryOpenedAttachAndServ(param);
		if(data && data.result && data.result.servLists){
			var is4G = false;
			$.each(data.result.servLists,function(){//遍历是否有开通4G上网功能
				if(this.servSpecId == CONST.PROD_SPEC.PROD_FUN_4G){ //开通4G功能产品
					is4G = true; //已开通4G上网功能产品
				}
			});
			return is4G;
		} 
		return false;
	};
	
	//补充查询基本条件
	var addParam = function(param){
		param.staffId = OrderInfo.staff.staffId;
		param.channelId = OrderInfo.staff.channelId;
		param.partyId = OrderInfo.cust.custId;
		param.areaId = OrderInfo.getProdAreaId(param.prodId);
		param.distributorId = OrderInfo.staff.distributorId;
		if(OrderInfo.order.soNbr!=undefined && OrderInfo.order.soNbr != ""){  //缓存流水号
			param.soNbr = OrderInfo.order.soNbr;
		}
	};
	
	return {
		checkUim				: _checkUim,
		releaseUim 				: _releaseUim,
		getTerminalInfo 		: _getTerminalInfo,
		prodSpecParamQuery		: _prodSpecParamQuery,
		prodInstParamQuery		: _prodInstParamQuery,
		getOldUim 				: _getOldUim,
		queryAcct				: _queryAcct,
		checkTerminal			: _checkTerminal,
		checkIs4GProdInst		: _checkIs4GProdInst
	};
})();
/**
 * 打印方法-回执、发票、押金票据
 * 
 * @author dujb3
 */
CommonUtils.regNamespace("common", "print");
/**
 * 打印方法-回执、发票、押金票据
 */
common.print = (function($){
	//回执打印准备
	var _voucherCommon=function(olId){
		var ifPrint = $('a[olId=' + olId + ']').attr("ifPrint");
		if (CONST.getAppDesc() == 0 && 'N' == ifPrint) {
			var trList = $("#tab_orderList tr[olId=" + olId + "]");
			var areaId = '';
			var instList = [];
			var newProdFlag = 'false';
			for (var i=0; i < trList.length; i++) {
				var tr = trList[i];
				var actionClass = $(tr).attr("actionClass");
				if (actionClass == '1600') {
					continue;
				}
				newProdFlag = $(tr).attr("newProdFlag");
				if (newProdFlag == 'true') {
					break;
				}
				var instId = $(tr).attr("objInstId");
				if (instId == undefined || instId == '') {
					$.alert("提示", "objInstId为空，请核查接口返回的数据！");
					return false;
				}
				var accessNumber = $(tr).attr("accessNumber");
				if (accessNumber == undefined || accessNumber == '') {
					$.alert("提示", "accessNumber为空，请核查接口返回的数据！");
					return false;
				}
			}
			for (var i=0; newProdFlag == 'false' && i < trList.length; i++) {
				var tr = trList[i];
				var actionClass = $(tr).attr("actionClass");
				if (actionClass == '1600') {
					continue;
				}
				var instId = $(tr).attr("objInstId");
				var accessNumber = $(tr).attr("accessNumber");
				if ($.inArray(instId, instList) >= 0) {
					continue;
				}
				areaId = $(tr).attr("areaId");
				OrderInfo.orderResult.olNbr = $(tr).attr("olNbr");
				var custId = '';
				OrderInfo.order.soNbr = UUID.getDataId();
				var param = {
						areaId : areaId,
						acctNbr : accessNumber,
						custId : custId,
						soNbr : OrderInfo.order.soNbr ,
						//queryType : "1,2,3,4,5",
						instId : instId,
						type : "2"
				};
				var loadInstFlag = query.offer.invokeLoadInst(param);
				if (!loadInstFlag) {
					return false;
				}
				instList.push(instId);
			}
			$('a[olId=' + olId + ']').attr("ifPrint", "Y");
		}
		if (OrderInfo.order.soNbr == undefined || OrderInfo.order.soNbr==''){
			OrderInfo.order.soNbr = UUID.getDataId();
		}
		OrderInfo.orderResult.olId = olId;
		return true;
	};
	//点击查看
	var _preSign=function(olId,chargeItems){
		if(!_voucherCommon(olId)){
			return;
		}
		var voucherInfo = {
			"olId":OrderInfo.orderResult.olId,
			"soNbr": OrderInfo.order.soNbr
		};
		var arr=new Array(3);
		if(ec.util.browser.versions.android){
			arr[0]='order/sign/downVoucher';				
		}else{
			arr[0]='print/iosVoucher';				
		}
		arr[1]='voucherInfo';
		arr[2]=JSON.stringify(voucherInfo);
		MyPlugin.printShow(arr,
            function(result) {
            },
            function(error) {
            }
		);
	};
	//点击打印回执预览回执内容
	var _signVoucher=function(params){
		var PcFlag="1";
		params.PcFlag=PcFlag;
		var url=contextPath+"/order/sign/previewForSign";
		$.callServiceAsJson(url, params, {
			"before":function(){
				$.ecOverlay("<strong>生成回执预览的html,请稍等会儿....</strong>");
			},"always":function(){
				$.unecOverlay();
			},	
			"done" : function(response){
				if (response.code == 0) {
					SignPlugin.datasign(response.data,JSON.stringify(params),function(){}, function(){});
				}else if (response.code == -2) {
					$.alertM(response.data);
				}else{
					$.alert("提示","生成回执预览的html失败!");
				}
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","服务忙，请稍后再试！");
			}
		});
	};
	//回执打印（重打）
	var _preVoucher=function(olId, chargeItems){
		if(!_voucherCommon(olId)){
			return;
		}
		var voucherInfo = {
			"olId":OrderInfo.orderResult.olId,
			"soNbr": OrderInfo.order.soNbr,
			"busiType":"1",
			"chargeItems":chargeItems
		};
		common.print.printVoucher(voucherInfo);
	};
	//调客户端展示打印pdf
	var _printVoucher=function(voucherInfo){
			var arr=new Array(3);
			if(ec.util.browser.versions.android){
				arr[0]='print/voucher';				
			}else{
				arr[0]='print/iosVoucher';				
			}
			arr[1]='voucherInfo';
			arr[2]=JSON.stringify(voucherInfo);
			MyPlugin.printShow(arr,
                function(result) {
                },
                function(error) {
                }
			);
	};
	//发票打印准备
	var _preInvoice=function(olId,olNbr, printFlag){
		var ifInvoice = $('a[olId=' + olId + ']').attr("ifInvoice");
		var areaId = $('a[olId=' + olId + ']').attr("areaId");
		if (CONST.getAppDesc() == 0 && 'N' == ifInvoice) {
			var trList = $("#tab_orderList tr[olId=" + olId + "]");
			var instList = [];
			var newProdFlag = 'false';
			for (var i=0; i < trList.length; i++) {
				var tr = trList[i];
				var actionClass = $(tr).attr("actionClass");
				if (actionClass == '1600') {
					continue;
				}
				newProdFlag = $(tr).attr("newProdFlag");
				if (newProdFlag == 'true') {
					break;
				}
				var instId = $(tr).attr("objInstId");
				if (instId == undefined || instId == '') {
					$.alert("提示", "objInstId为空，请核查接口返回的数据！");
					return ;
				}
				var accessNumber = $(tr).attr("accessNumber");
				if (accessNumber == undefined || accessNumber == '') {
					$.alert("提示", "accessNumber为空，请核查接口返回的数据！");
					return ;
				}
			}
			for (var i=0; newProdFlag == 'false' && i < trList.length; i++) {
				var tr = trList[i];
				var actionClass = $(tr).attr("actionClass");
				if (actionClass == '1600') {
					continue;
				}
				var instId = $(tr).attr("objInstId");
				var accessNumber = $(tr).attr("accessNumber");
				if ($.inArray(instId, instList) >= 0) {
					continue;
				}
				areaId = $(tr).attr("areaId");
				OrderInfo.orderResult.olNbr = $(tr).attr("olNbr");
				var custId = '';
				OrderInfo.order.soNbr = UUID.getDataId();
				var param = {
						areaId : areaId,
						acctNbr : accessNumber,
						custId : custId,
						soNbr : OrderInfo.order.soNbr ,
						//queryType : "1,2,3,4,5",
						instId : instId,
						type : "2"
				};
				var loadInstFlag = query.offer.invokeLoadInst(param);
				if (!loadInstFlag) {
					return;
				}
				instList.push(instId);
			}
			$('a[olId=' + olId + ']').attr("ifInvoice", "Y");
		}
		if (OrderInfo.order.soNbr == undefined || OrderInfo.order.soNbr==''){
			OrderInfo.order.soNbr = UUID.getDataId();
		}
		OrderInfo.orderResult.olNbr = olNbr;
		OrderInfo.orderResult.olId = olId;
		var param = {
			"olId" : OrderInfo.orderResult.olId,
			"soNbr": OrderInfo.order.soNbr,
			"billType" : 0,
			"printFlag": printFlag,
			"areaId" : areaId,
			"acctItemIds":[]
		};
		common.print.prepareInvoiceInfo(param);
	};
	
	//可打印费用项查询
	var _queryComputeCharge=function(param) {
		$.ecOverlay("<strong>正在查询中,请稍等会儿....</strong>");
		var url=contextPath+"/print/getInvoiceItems";
		var response = $.callServiceAsJson(url,param,{});
		$.unecOverlay();
		if(!response){
			$.alert("提示","<br/>查询可打印费用项失败，请稍后重试");
			return false;
		}
		if(response.code == -2) {
			$.alertM(response.data);
			return false;
		}
		if(response.code != 0) {
			$.alert("提示","<br/>查询可打印费用项失败，请稍后重试");
			return false;
		}
		if(response.data.resultCode != '0') {
			$.alert("提示", response.data.resultMsg);
			return false;
		}
		//判断是否有可打印费用项
		if (response.data.chargeItems == undefined || response.data.chargeItems.length==0) {
			$.alert("提示", "没有可打印的费用项");
			return false;
		} else {
			var i = 0;
			for(; i < response.data.chargeItems.length; i++){
				var item = response.data.chargeItems[i];
				if (item.paymentAmount!=0) {
					break;
				}
			}
			if (i == response.data.chargeItems.length) {
				$.alert("提示", "没有可打印的费用项");
				return false;
			}
		}
		return response;
	};
	//发票代码、发票号码查询
	var _queryInvoiceInfo = function() {
		var param = {
			"staffId" : OrderInfo.staff.staffId,
			"areaId" : OrderInfo.staff.areaId,
			"custSoNbr" : OrderInfo.orderResult.olNbr,
			"custOrderId" : OrderInfo.orderResult.olId,
			"invoiceType" : "100" //目前阶段我们用到的是：100 普通发票和 200 收据。待后续有营改增需求后再 用其它类型。
		};
		var url=contextPath+"/print/getInvoiceInfo";
		var response = $.callServiceAsJson(url,param,{});
		if(!response){
//			$.alert("提示","<br/>查询发票代码发票号码失败，请稍后重试");
			return false;
		}
		if(response.code == -2) {
			$.alertM(response.data);
			return false;
		}
		if(response.code != 0) {
//			$.alert("提示","<br/>查询发票代码发票号码失败，请稍后重试");
			return false;
		}
		if (response.data.invoiceInfos != undefined && response.data.invoiceInfos instanceof Array && response.data.invoiceInfos.length > 0) {
		
		} else {
//			$.alert("提示","<br/>查询发票代码发票号码失败，返回结果中未获取到发票信息，请稍后重试");
			return false;
		}
		return response;
	};
	/**
	 * 填写打印发票信息
	 */
	var _prepareInvoiceInfo=function(param){
		
		//判断是否一般纳税人，如果是的话提示
		if (OrderInfo.cust.norTaxPayer == "Y") {
			$.alert("提示", "客户为一般纳税人，请到省份CRM系统打印专用增值税发票！");
			$.confirm("提示信息","客户为一般纳税人，专用增值税发票需要到省份CRM系统打印。是否只打印普通发票?", {
				yes : function(){
					_prepareInvoiceInfoCore(param);
				},
				no : function(){
					return;
				}
			}, "question");
		}else{
			_prepareInvoiceInfoCore(param);
		}
	};
	var _prepareInvoiceInfoCore=function(param){
		//可打印费用项查询
		var qccResp = _queryComputeCharge(param);
		if (!qccResp) {
			return;
		}
		//发票代码、发票号码查询
		var iiqResp = _queryInvoiceInfo();
		if (!iiqResp) {
//			return;
		} else {
			var iiqInfos = iiqResp.data.invoiceInfos;
			if(ec.util.isArray(iiqInfos[0].invoiceInfos)){
				$("#invoiceNbrInp").val(iiqInfos[0].invoiceInfos[0].invoiceNbr);
				$("#invoiceNumInp").val(iiqInfos[0].invoiceInfos[0].invoiceNum);
				
			}else{
				$("#invoiceNbrInp").val(iiqInfos[0].invoiceNbr);
				$("#invoiceNumInp").val(iiqInfos[0].invoiceNum);
			}
			
		}
		
		
		var invoiceInfos = qccResp.data.invoiceInfos;
		if (invoiceInfos != undefined && invoiceInfos instanceof Array && invoiceInfos.length > 0) {
			
		} else {
			//没有发票信息，需要进行初始化
			var initParam={
				"soNbr":OrderInfo.order.soNbr,
				"billType" : 0,
				"olId" : param.olId,
				"printFlag" : -1,
				"areaId" : OrderInfo.staff.areaId,
				"acctItemIds":[]
			};
			var initResult = common.print.initPrintInfo(initParam);
			if(!initResult) {
				return;
			}
			//提示到发票补打页面操作
			if (param.printFlag == 1) {
				$.alert("信息", "此购物车对应的发票未打印过，请到发票补打页面。");
				return;
			}
			//可打印费用项查询
			qccResp = _queryComputeCharge(param);
			if (!qccResp) {
				return;
			}
		}
		//判断是否是重打还是补打
		common.print.oldInvoiceFlag = '0';
		if (_checkCanReOrAdd(qccResp.data.invoiceInfos, param.printFlag)) {
			return;
		}
		
		
		//查询可打印费用项成功，接下去查询模板组
		var tempUrl = contextPath+"/print/getInvoiceTemplates";
		var tempParam = {
			'areaId' : OrderInfo.staff.areaId
		};
		var tempResp = $.callServiceAsJson(tempUrl, tempParam, {});
		if (tempResp.code == -2) {
			$.alertM(tempResp.data);
			return;
		} else if (tempResp.code != 0) {
			$.alert("提示",ec.util.defaultStr(tempResp.data, "获取打印模板出错"));
			return;
		} else {
			var tempData = tempResp.data;
			if (tempData.resultCode != 'POR-0000') {
				$.alert("提示",ec.util.defaultStr(tempData.resultMsg, "获取打印模板异常"));
				return;
			}
			if (tempData.length == 0) {
				$.alert("提示", "没有获取到可用的打印模板");
				return;
			}
			var tempHtml = "";
			var tempList = tempData.tempList;
			if (typeof tempList != undefined && tempList.length > 0) {
				tempHtml += "<option selected='selected' value="+tempList[0].templateId+">"+tempList[0].templateName+"</option>";
				for(var i = 1; i < tempList.length; i++){
					var template = tempList[i];
					tempHtml += "<option value="+template.templateId+">"+template.templateName+"</option>";
				}
			}
			$("#tempListSel").html(tempHtml);
		}
		
		
		//显示接入号
		var selHtml = "";
		var prodInfo = qccResp.data.prodInfo;
		if (prodInfo != undefined && prodInfo.length > 0) {
			selHtml+="<option selected='selected' value="+prodInfo[0].accessNumber+">"+prodInfo[0].accessNumber+"</option>";
			for(var i=1;i<prodInfo.length;i++){
				var prod = prodInfo[i];
				selHtml+="<option value="+prod.accessNumber+">"+prod.accessNumber+"</option>";
			}
		}
		$("#acceNbrSel").html(selHtml);
		
		//显示费用项
		var contHtml = "";
		contHtml+="<div id='invoiceContDiv'>";
		contHtml+="  <table class='searchtable'>";
		contHtml+="    <tr>";
		contHtml+="      <th>是否打印</th><th>费用名称</th><th>费用(元)</th><th>税金(元)</th><th>付费方式</th>";
		contHtml+="    </tr>";
		var chargeItems = qccResp.data.chargeItems;
		for(var i=0;i<chargeItems.length;i++){
			var item = chargeItems[i];
			if (i == 0) {
				$("#invoiceTitleInp").val(item.custName);
			}
			if (item.paymentAmount==0) {
				continue;
			}
			contHtml+="    <tr acctItemId="+item.acctItemId+" acctItemTypeId="+item.acctItemTypeId+" ";
			contHtml+="        acctItemTypeName='"+item.acctItemTypeName+"' boActionType='"+item.boActionType+"' ";
			contHtml+="        boActionType='"+item.boActionType+"' boId="+item.boId+" feeAmount="+item.feeAmount+" ";
			contHtml+="        invoiceId="+item.invoiceId+" objId="+item.objId+" objType="+item.objType+" ";
			contHtml+="        payMethodCd="+item.payMethodCd+" payMethodName="+item.payMethodName+" ";
			contHtml+="        realAmount="+item.realAmount + " ";
			contHtml+="        tax="+item.tax+" taxRate="+item.taxRate+" >";
			if (_checkChargeItem(item)) {
				contHtml+="      <td><input type='checkbox' name='invoiceItemsChkBox' checked='checked'/></td>";
			} else {
				contHtml+="      <td><input type='checkbox' name='invoiceItemsChkBox' disabled='disabled'/></td>";
			}
			contHtml+="      <td>"+item.acctItemTypeName+"</td>";
			contHtml+="      <td>"+(item.realAmount / 100).toFixed(2)+"</td>";
			contHtml+="      <td>"+(item.tax / 100).toFixed(2)+"</td>";
			contHtml+="      <td>"+item.payMethodName+"</td>";
			contHtml+="    </tr>";
		}
		contHtml+="  </table>";
		contHtml+="</div>";
		$("#invoiceItemsContDiv").html(contHtml);
		var htmlStr=$("#div_printInvoice").html();
		$("#div_printInvoice").html('');
		var popup = $.popup("#div_printInvoice_prepare",htmlStr,{
			width:$(window).width()-200,
			height:$(window).height(),
			contentHeight:$(window).height()-120,
			afterClose:function(){
				$("#div_printInvoice").html(htmlStr);
			}
		});
		$("#billType").off("change").on("change",function(event){
			if ($("#billType").val()=="0") {
				$("#invoiceNbrNumDl").show();
				$("#titleDt").html("发票抬头：");
				$("#tempDt").html("发票模板：");
				param.billType = 0;
			} else {
				$("#invoiceNbrNumDl").hide();
				$("#titleDt").html("票据抬头：");
				$("#tempDt").html("票据模板：");
				param.billType = 1;
			}
		});
		$("#invoiceItemsConfirm").off("tap").on("tap",function(event){
			if (common.print.oldInvoiceFlag != '0') {
				$.alert("信息", "存在未作废发票，请先确定作废发票");
				return;
			}
			_saveInvoiceInfo(param, qccResp.data);
		});
		$("#invoiceItemsConCancel").off("tap").on("tap",function(event){
			$("#div_printInvoice_prepare").popup("close");
		});
	};
	//查询可打印费用项
	var _initPrintInfo=function(param) {
		var url=contextPath+"/print/getInvoiceItems";
		var queryResult = $.callServiceAsJson(url,param);
		if(!queryResult){
			$.alert("提示","<br/>查询可打印费用项失败，请稍后重试");
			return;
		}
		if(queryResult.code == -2) {
			$.alertM(queryResult.data);
			return;
		}
		if(queryResult.code != 0) {
			$.alert("提示","<br/>查询可打印费用项失败，请稍后重试");
			return;
		}
		if(queryResult.data.resultCode != '0') {
			$.alert("提示", queryResult.data.resultMsg);
			return;
		}
		//判断是否有可打印费用项
		if (queryResult.data.chargeItems == undefined || queryResult.data.chargeItems.length==0) {
			$.alert("提示", "没有可打印的费用项");
			return;
		}
		var result = _prepareInitParam(param, queryResult.data);
		var invoiceInfos = result.invoiceInfos;
		
		var params={"invoiceInfos" : invoiceInfos};
		var smResp = _invokeSavingMethod(params, param.printFlag);
		if (smResp == false) {
			return false;
		}
		invoiceInfos = _setInvoiceId(invoiceInfos, smResp.data.invoiceIds, '0');
		return invoiceInfos;
	};
	
	var _getPrintState=function(printFlag) {
		if (printFlag == '-1') {
			return '初始打印';
		} else if (printFlag == '0') {
			return '正常打印';
		} else if (printFlag == '1') {
			return '重打';
		} else if (printFlag == '2') {
			return '补打';
		} else {
			return '未知操作';
		}
	};
	//判断是否能重打或补打  true - 限制 , false - 允许打印
	var _checkCanReOrAdd=function(invoiceInfos, printFlag) {
		if (invoiceInfos != undefined && invoiceInfos instanceof Array && invoiceInfos.length > 0) {
			for (var i=0; i < invoiceInfos.length; i++) {
				if (!invoiceInfos[i]) {
					$.alert("信息", "接口返回的发票信息不是有效值，请确认。");
					return true;
				}
				if (invoiceInfos[i].printFlag=='-1') {
					//未打印时，允许正常打印和补打
					if (printFlag == '0' || printFlag == '2') {
						
					} else {
						$.alert("信息", "此购物车对应的发票未打印过，请到发票补打页面。");
						return true;
					}
				} else if (invoiceInfos[i].printFlag == '0') {
					//如果是收据，就允许操作
					if (invoiceInfos[i].billType == '1') {
						return false;
					}
					//正常打印状态，允许重打
					if (printFlag == '1') {
						//弹出作废发票提示
						_invalidInvoice(invoiceInfos, printFlag);
					} else {
						$.alert("信息", "此购物车对应的发票正常打印过，只允许重打。");
						return true;
					}
				} else if (invoiceInfos[i].printFlag == '1' || invoiceInfos[i].printFlag == '2') {
					//重打或补打状态，允许重打
					if (printFlag == '1') {
						//弹出作废发票提示
						_invalidInvoice(invoiceInfos, printFlag);
					} else {
						$.alert("信息", "此购物车对应的发票已打印过，只允许重打。");
						return true;
					}
				} else {
					//默认不允许
					$.alert("信息", "发票信息中打印标识值不规范");
					return true;
				}
			}
			//走出循环，代表允许打印
			return false;
		} else {
			//没有发票信息，允许正常打印
			if (printFlag == '0') {
				return false;
			} else {
				$.alert("信息", "此购物车没有对应的发票信息，不能进行补打或重打");
				return true;
			}
		}
	};
	
	//判断是否已打印过发票，true-有旧发票需要作废,false-没有旧发票
	var _invalidInvoice=function(invoiceInfos, printFlag) {
		if (invoiceInfos != undefined && invoiceInfos instanceof Array && invoiceInfos.length > 0) {
			//筛选invoiceId，展示需要作废的发票代码和发票号码
			var infoHtml ='<ul data-role="listview" style="min-width:380px;min-height: 140px">';
			infoHtml += '<li>存在未作废发票，请先作废发票：</li>';
			var invoiceIds = [];
			for (var i=0; i < invoiceInfos.length; i++) {
				var info = invoiceInfos[i];
				if ($.inArray(info.invoiceId, invoiceIds) >= 0) {
					
				} else {
					infoHtml += '<li>发票代码：' + info.invoiceNbr + ';发票号码：'+info.invoiceNum+'</li>';
					invoiceIds.push(info.invoiceId);
				}
			}
			infoHtml+='</ul>';
			if (invoiceIds.length > 0) {
				//需要作废发票
				common.print.oldInvoiceFlag = '1';
				$("#invalidInvoiceInfoDiv").html(infoHtml);
				$.jqmRefresh($("#invalidInvoiceInfoDiv"));
				$("#dlg-invalid-invoice").popup("open");
				$("#invalidInvoiceConfirm").off("tap").on("tap", function() {
					common.print.oldInvoiceFlag = '0';
					$("#dlg-invalid-invoice").popup("close");
				});
			}
			return false;
		} else {
			return false;
		}
	};
	//校验费用项能否被打印，true-可以打印；false-不可打印
	var _checkChargeItem=function(item){
		var payMethodCd = item.payMethodCd;
		if (payMethodCd == CONST.PAYMETHOD_CD.ZHANG_WU_DAI_SHOU) {
			return false;
		}
		return true;
	};
	
	//校验发票抬头，发票代码，发票号码等
	var _chkInput=function(param){
		try {
			//发票的需要校验代码和号码
			if (param.billType != 1) {
				if ($("#invoiceNbrInp").val() == "") {
					$.alert("提示","请输入发票代码");
					return true;
				}
				//原17位发票代码，现12位
				if (!/^\d{0,12}$/.test($("#invoiceNbrInp").val())) {
					$.alert("提示","请输入正确的发票代码");
					return true;
				}
				if ($("#invoiceNumInp").val() == "") {
					$.alert("提示","请输入发票号码");
					return true;
				}
				//8位发票号码
				if (!/^\d{0,12}$/.test($("#invoiceNumInp").val())) {
					$.alert("提示","请输入正确的发票号码");
					return true;
				}
			}
			if ($("#invoiceTitleInp").val() == "") {
				$.alert("提示","请输入发票抬头");
				return true;
			}
			
			if($("#invoiceContDiv tbody input:checked").length < 1) {
				$.alert("提示","请选择要打印的费用项");
				return true;
			}
		} catch (e) {
			return true;
		}
		return false;
	};
	var _prepareInitParam=function(param, queryResult) {
		var invoiceInfos =[];
		var invoiceInfo = {
			"acctItemIds": [],
			"instanceType": 2,//根据过滤取值，优先为产品或销售品，2-产品，7-销售品
			"instanceId": 0,//根据过滤取值，优先为产品或销售品
			"invoiceType": "100", //目前阶段我们用到的是：100 普通发票和 200 收据。待后续有营改增需求后再 用其它类型。
			"staffId": OrderInfo.staff.staffId,
			"amount": 0,
			"realPay": 0,
			"tax": 0,//可为空，暂为0
			"invoiceNbr": 0,//发票代码，前台人工输入，票据时可为空
			"invoiceNum": "0",//发票号码，前台人工输入，票据时可为空
			"custOrderId": OrderInfo.orderResult.olId,
			"custSoNumber": OrderInfo.orderResult.olNbr,
			"custId": OrderInfo.cust.custId,
			"commonRegionId": OrderInfo.staff.areaId,
			"channelId": OrderInfo.staff.channelId,
			"bssOrgId": OrderInfo.staff.orgId,
			"acctNbr": 0,//接入号码，根据5.12接口返回展示，前台选择
			"paymethod": 100000,
			"busiName": "具体业务说明",//可为空
			"rmbUpper": "人民币大写",//固定此值
			"accountUpper": "零圆整",
			"account": 0,
			"billType": param.billType,//票据类型：0发票，1收据
			"printFlag": param.printFlag,//打印标记：0正常打印，1重打票据，2补打票据，-1未打印
			"invoiceId": 0
		};
		
		var instanceFlag = false;
		var sumFeeAmount = 0;
		var sumRealAmount = 0;
		var sumTax = 0;
		var items = [];
		var payMethodName = "";
		var chargeItems = queryResult.chargeItems;
		for(var i=0;i<chargeItems.length;i++){
			var item = chargeItems[i];
			invoiceInfo.acctItemIds.push({"acctItemId": item.acctItemId});
			if (item.objType == "2") {
				invoiceInfo.instanceType = item.objType;
				invoiceInfo.instanceId = item.objId;
				invoiceInfo.paymethod = item.payMethodCd;
				instanceFlag = true;
			} else if (!instanceFlag && item.objType == "7") {
				invoiceInfo.instanceType =item.objType;
				invoiceInfo.instanceId = item.objId;
				invoiceInfo.paymethod = item.payMethodCd;
			}
			//计算金额
			sumFeeAmount += parseInt(item.feeAmount);
			sumRealAmount += parseInt(item.realAmount);
			sumTax += parseInt(item.tax);
			payMethodName = item.payMethodName;
		}
		
		//设置金额
		invoiceInfo.amount = sumFeeAmount;
		invoiceInfo.realPay = sumRealAmount;
		invoiceInfo.tax = sumTax;
		invoiceInfo.account = sumRealAmount;
		invoiceInfo.accountUpper = ec.util.atoc(sumRealAmount);
		//取实例ID和类型
		invoiceInfo.invoiceNbr = 0;
		invoiceInfo.invoiceNum = "0";
		//取接入号
		var prodInfo = queryResult.prodInfo;
		if (prodInfo != undefined && prodInfo.length > 0) {
			invoiceInfo.acctNbr = prodInfo[0].accessNumber;
		}
		
		invoiceInfos.push(invoiceInfo);
		var result = {
			"payMethodName" : payMethodName,
			"items" : items,
			"invoiceInfos" : invoiceInfos
		};
		return result;
	};
	var _addParam=function(param, queryResult) {
		var invoiceInfos = [];
		var invoiceInfo = {
			"acctItemIds": [],
			"instanceType": 2,//根据过滤取值，优先为产品或销售品，2-产品，7-销售品
			"instanceId": 0,//根据过滤取值，优先为产品或销售品
			"invoiceType": "100", //目前阶段我们用到的是：100 普通发票和 200 收据。待后续有营改增需求后再 用其它类型。
			"staffId": OrderInfo.staff.staffId,
			"amount": 0,
			"realPay": 0,
			"tax": 0,//可为空，暂为0
			"invoiceNbr": 0,//发票代码，前台人工输入，票据时可为空
			"invoiceNum": "0",//发票号码，前台人工输入，票据时可为空
			"custOrderId": OrderInfo.orderResult.olId,
			"custSoNumber": OrderInfo.orderResult.olNbr,
			"custId": OrderInfo.cust.custId,
			"commonRegionId": OrderInfo.staff.areaId,
			"channelId": OrderInfo.staff.channelId,
			"bssOrgId": OrderInfo.staff.orgId,
			"acctNbr": 0,//接入号码，根据5.12接口返回展示，前台选择
			"paymethod": 100000,
			"busiName": "具体业务说明",//可为空
			"rmbUpper": "人民币大写",//固定此值
			"accountUpper": "零圆整",
			"account": 0,
			"billType": param.billType,//票据类型：0发票，1收据
			"printFlag": param.printFlag,//打印标记：0正常打印，1重打票据，2补打票据，-1未打印
			"invoiceId": 0
		};
		//设置invoiceId
		invoiceInfo.invoiceId = queryResult.invoiceInfos[0].invoiceId;
		//设置票据类型
		invoiceInfo.billType = $("#billType").val();
		//设置发票类型
		if (invoiceInfo.billType == '0') {
			invoiceInfo.invoiceType = '100';
		} else {
			invoiceInfo.invoiceType = '200';
		}
		
		
		var instanceFlag = false;
		var sumFeeAmount = 0;
		var sumRealAmount = 0;
		var sumTax = 0;
		var items = [];
		var payMethodName = "";
		//获取费用项和接入号的关系
		var rela = _getAcceNbrBoIdRela(queryResult);
		invoiceInfo.acctItemIds = [];
		$("#invoiceContDiv tbody input:checked").parent().parent().parent().each(function(){
			//设置账单项ID
			invoiceInfo.acctItemIds.push({"acctItemId": $(this).attr("acctItemId")});
			//设置实例id和类型，优先为产品或销售品，2-产品，7-销售品
			if ($(this).attr("objType") == "2") {
				invoiceInfo.instanceType = $(this).attr("objType");
				invoiceInfo.instanceId = $(this).attr("objId");
				invoiceInfo.paymethod = $(this).attr("payMethodCd");
				instanceFlag = true;
			} else if (!instanceFlag && $(this).attr("objType") == "7") {
				invoiceInfo.instanceType = $(this).attr("objType");
				invoiceInfo.instanceId = $(this).attr("objId");
				invoiceInfo.paymethod = $(this).attr("payMethodCd");
			}
			//计算金额
			sumFeeAmount += parseInt($(this).attr("feeAmount"));
			sumRealAmount += parseInt($(this).attr("realAmount"));
			sumTax += parseInt($(this).attr("tax"));
			var accessNumber = '';
			var boId = $(this).attr("boId");
			for (var i=0; i < rela.length; i++) {
				if (boId == rela[i].boId) {
					accessNumber = rela[i].accessNumber;
				}
			}
			
			items.push({
				"itemName" : $(this).attr("acctItemTypeName"),
				"charge" : parseInt($(this).attr("realAmount")),
				"tax" : parseInt($(this).attr("tax")),
				"acceNumber" : accessNumber
			});
			payMethodName = $(this).attr("payMethodName");
		});
		if(OrderInfo.actionFlag==11){
			invoiceInfo.printFlag = 0;
		}
		
		//设置金额
		invoiceInfo.amount = sumFeeAmount;
		invoiceInfo.realPay = sumRealAmount;
		invoiceInfo.tax = sumTax;
		invoiceInfo.account = sumRealAmount;
		invoiceInfo.accountUpper = ec.util.atoc(sumRealAmount);
		//取实例ID和类型
		invoiceInfo.invoiceNbr = $("#invoiceNbrInp").val();
		invoiceInfo.invoiceNum = "" + $("#invoiceNumInp").val();
		//取接入号
		invoiceInfo.acctNbr = $("#acceNbrSel option:selected").val();
		
		invoiceInfos.push(invoiceInfo);
		var result = {
			"payMethodName" : payMethodName,
			"items" : items,
			"invoiceInfos" : invoiceInfos
		};
		return result;
	};
	var _getAcceNbrBoIdRela=function(queryResult) {
		var rela = [];
		var chargeItems = queryResult.chargeItems;
		var prodInfo = queryResult.prodInfo;
		for (var i=0; i < chargeItems.length; i++) {
			var boId = chargeItems[i].boId;
			for(var j=0; j < prodInfo.length; j++) {
				var accessNumber = prodInfo[j].accessNumber;
				var busiOrders = prodInfo[j].busiOrders;
				for (var k=0; k < busiOrders.length; k++) {
					if (busiOrders[k].boId == boId) {
						var tmp = {
							"boId" : boId,
							"accessNumber" : accessNumber
						};
						rela.push(tmp);
					}
				}
			}
		}
		return rela;
	};
	
	var _saveInvoiceInfo=function(param, queryResult){
		
		if (_chkInput(param)) {
			return;
		}
		if (!queryResult.invoiceInfos[0]) {
			$.alert("提示","集团营业受理后台接口返回缺少发票信息，请确认。");
			return;
		}
		var result = _addParam(param, queryResult);
		var invoiceInfos = result.invoiceInfos;
		
		var params={"invoiceInfos" : invoiceInfos};
		var smResp = _invokeSavingMethod(params, param.printFlag);
		if (smResp == false) {
			return;
		}
		
		//调用受理后台结束，开始调用生成PDF
		var invoiceParam = {
			"partyName" : $("#invoiceTitleInp").val(),
			"templateId" : $("#tempListSel :selected").val(),
			"prodInfo" : queryResult.prodInfo,
			"items" : result.items,
			"payMethod" : result.payMethodName,
			"invoiceInfos" : invoiceInfos
		};
		_printInvoice(invoiceParam);
		//最终关闭窗口
		if (OrderInfo.cust.norTaxPayer != "Y") {
			$("#div_printInvoice_prepare").popup("close");
		}
		return;
	};
	//调用集团发票打印处理接口
	var _invokeSavingMethod=function(params, printFlag){
		$.ecOverlay("<strong>正在提交中,请稍等会儿....</strong>");
		var response = $.callServiceAsJson(contextPath+"/print/saveInvoiceInfo",params);
		$.unecOverlay();
		if(response.code == -2) {
			$.alertM(response.data);
			return false;
		} else if(response.code != 0 || response.data.resultCode != "0") {
			$.alert("提示", _getPrintState(printFlag) + "调用集团发票打印处理接口失败，请稍后重试");
			return false;
		}
		return response;
	};
	var _setInvoiceId=function(invoiceInfos, invoiceIds, printFlag) {
		for(var i=0;i<invoiceInfos.length;i++){
			invoiceInfos[i].invoiceId = invoiceIds[i];
			invoiceInfos[i].printFlag = printFlag;
		}
		return invoiceInfos;
	};
	//打印显示发票pdf
	var _printInvoice=function(invoiceParam){
		var arr=new Array(3);
		if(ec.util.browser.versions.android){
			arr[0]='print/invoice';
		}else{
			arr[0]='print/iosInvoice';
		}
		arr[1]='invoiceParam';
		arr[2]=encodeURI(JSON.stringify(invoiceParam));
		MyPlugin.printShow(arr,
            function(result) {
            },
            function(error) {
            }
		);
	};
	return {
		preVoucher:_preVoucher,
		printVoucher:_printVoucher,
		preInvoice:_preInvoice,
		initPrintInfo:_initPrintInfo,
		prepareInvoiceInfo:_prepareInvoiceInfo,
		saveInvoiceInfo:_saveInvoiceInfo,
		chkInput : _chkInput,
		printInvoice : _printInvoice,
		preSign:_preSign,
		signVoucher:_signVoucher
	};
})(jQuery);

//初始化
$(function(){
	
});
/**
 * 订单准备,绑定三个入口及相应初始化数据操作
 * 
 * @author wukf
 * @modifyby liusd
 */
CommonUtils.regNamespace("order", "prepare");
/**
 * 订单准备
 */
order.prepare = (function(){
	//三个入口选择
	var _tabChange= function(){
		$("#ul_busi_area li").each(function(){
			$(this).off("tap").on("tap",function(event){
				OrderInfo.actionFlag= 1;
				var url=$(this).attr("url");
				var forTab = $(this).attr("for");
				if(forTab == "order_tab_panel_phonenumber"){
					var custId = OrderInfo.cust.custId;
					if(OrderInfo.cust==undefined || custId==undefined || custId==""){
						$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");
						return;
					}
				}
				_commonTab(url,forTab);
				event.stopPropagation();});});
		//异地业务隐藏三个入口
		var diffPlaceFlag = $("#diffPlaceFlag").val();
		if (diffPlaceFlag == "diff") {
			$("#order_prepare").hide();
			$("#nothreelinks").show();
		}
		
		//如果有资源ID，则跳转到终端详情
		var mktResCd$ = $("#mktResHidId").attr("mktResCd");
		var offerSpecId$ = $("#offerSpecHidId").val();
		if (mktResCd$ && mktResCd$.length > 0) {
			var url = contextPath+"/pad/mktRes/terminal/prepare";
			var param={};
			var response = $.callServiceAsHtmlGet(url,param);
			var content$=$("#div_public_info");
			content$.html(response.data);
			mktRes.terminal.selectTerminal($("#mktResHidId"));
			$("#order_prepare").hide();
			order.prepare.step(1);//显示"第一步：订单准备"
			_showOrderTitle("", "购手机", true);
			content$.show();
		}else if (offerSpecId$ && offerSpecId$.length > 0) {
			var url = contextPath+"/order/prodoffer/prepare";
			var param={"prodOfferId":offerSpecId$};
			var response = $.callServiceAsHtmlGet(url,param);
			var content$=$("#order_tab_panel_content");
			content$.html(response.data);
			$("#order_prepare").hide();
			order.prepare.step(1);//显示"第一步：订单准备"
			_showOrderTitle("", "办套餐", true);
			content$.show();
			order.service.initSpec();
			order.prodOffer.init();
		}
	};
	var _commonTab=function(url,forTab){
		$.callServiceAsHtmlGet(url,{},{
			"before":function(){
				$.ecOverlay("<strong>查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response || response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				if(order.cust.mgr.orderBtnflag=="1"){
					order.cust.mgr.btnQueryCustProdMore();
				};
				order.prepare.step(1);//显示"第一步：订单准备";
				//隐藏所有首页其它内容
				main.home.hideMainAllIco();
				var content$ = $("#order_prepare").html(response.data).fadeIn();
				$.jqmRefresh(content$);
				$("#navbar").slideUp(500);
				
				if (forTab == "order_tab_panel_terminal") {
					_showOrderTitle("", "购手机", true);
					order.service.releaseFlag = 1;
					order.prepare.createorderlonger();
					OrderInfo.busitypeflag=1;
					mktRes.terminal.queryApConfig();
					mktRes.terminal.initInParam('', '', '', '', '');
					mktRes.terminal.btnQueryTerminal(1);
					//回车事件交给键盘go
					$("#form_terminal_qry").off("submit").on("submit",function(e){
						e.preventDefault();//屏蔽form action默认事件
						mktRes.terminal.btnQueryTerminal(1);
					}).find("select").off("change").on("change",function(){
						mktRes.terminal.btnQueryTerminal(1);
						$(this).selectmenu("refresh");
					});
				}else if(forTab == "order_tab_panel_phonenumber"){
					_showOrderTitle("", "选号码", true);
					order.service.releaseFlag = 1;
					order.prepare.createorderlonger();
					OrderInfo.busitypeflag=1;
					mktRes.phoneNbr.initPhonenumber();					
				}else if(forTab == "order_tab_panel_offer"){
					_showOrderTitle("", "办套餐", true);
					//判断是否直接进入新装套餐入口
					if(order.service.releaseFlag==0){
						order.service.releaseFlag = 2;
					}
					
					order.prepare.createorderlonger();
					OrderInfo.busitypeflag=1;
					initOffer();
					//如果二次加载
					if(OrderInfo.provinceInfo.reloadFlag=="N"){
						//获取主套餐id
						var custOrderList = OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;	
						var offerid="";
						for(var i=0;i<custOrderList.length;i++){
						     if(custOrderList[i].boActionType.actionClassCd=="1200" && custOrderList[i].boActionType.boActionTypeCd=="S2" && custOrderList[i].busiObj.offerTypeCd=="1"){
						    	 offerid=custOrderList[i].busiObj.objId;
						     }	
						}
						if(offerid !=null && offerid!=""){
							order.service.buyService("tcnum1",offerid,"");
						}
						
					}
					else{
						//如果有传主套餐id
						if(OrderInfo.provinceInfo.prodOfferId!=undefined && OrderInfo.provinceInfo.prodOfferId!=null && OrderInfo.provinceInfo.prodOfferId!="" && OrderInfo.provinceInfo.prodOfferId!="null"){
							order.service.buyService("tcnum1",OrderInfo.provinceInfo.prodOfferId,"");
						} 
						else{
							order.service.searchPack();
						}
						
					}
					
					
					mktRes.phoneNbr.resetBoProdAn();
				}
			}
		});	
	};
	
	//初始化套餐入口
	var initOffer = function(){
		query.common.queryApConfig("PROD_AND_OFFER",function(data){
			if(ec.util.isArray(data)){
				$.each(data,function(){
					if(this.OFFER_PRICE){ //价格
						$.each(this.OFFER_PRICE,function(){
							$("#select_price").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g, "")+"</option>");
						});
						$("#select_price").selectmenu("refresh");
					}else if(this.OFFER_INFLUX){ //流量
						$.each(this.OFFER_INFLUX,function(){
							$("#select_influx").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g, "")+"</option>");
						});
						$("#select_influx").selectmenu("refresh");
					}else if(this.OFFER_INVOICE){ //语音
						$.each(this.OFFER_INVOICE,function(){
							$("#select_invoice").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g, "")+"</option>");
						});
						$("#select_invoice").selectmenu("refresh");
					}
				});
			}
		});
		$("#form_prodOffer_qry").off("submit").on("submit",function(e){
			e.preventDefault();//屏蔽form action默认事件
			order.service.searchPack();
		}).find("select").off("change").on("change",function(){
			order.service.searchPack();
			$(this).selectmenu("refresh");
		});
	};
	
	var _step = function(num) {
		//如果没传参数，默认显示第一步
		if (num == undefined || !num) {
			num = 1;
		}
		if(1==num){
			OrderInfo.order.step=0;
		}
		$.each($("div[id^=step]"),function(i,stepDiv){
			if (num == (i+1)) {
				$(this).show();
			} else {
				$(this).hide();
			}
		});
	};
	
	var _hideStep = function() {
		$("div[id^=step]").hide();
	};
	
	var _showOrderTitle = function(action, titleName, backwardFlag){
//		var cont$ = $("<span id='orderTitleSpan'></span>").html(action);
//		var back$ = '';
//		if (backwardFlag == true) {
//			back$ = $("<a href='javascript:void(0);'><span style='float: right;'>返回</span></a>");
//			back$.addClass("numberSearch back3").show().click(function(){order.prepare.backToInit();});
//		}
//		$("#orderTitleDiv h2").html('').append(cont$).append(titleName).append(back$).parent().show();
	};
	var _hideOrderTitle = function() {
		$("#orderTitleDiv").hide();
	};

	var _backToInit=function(){
		//若是购机或选号入口，在退出业务办理时将释放主卡预占的号码（过滤身份证预占的号码）
		var boProdAn = order.service.boProdAn;
		if(boProdAn.accessNumber && !boProdAn.idFlag){
			var param = {
					numType : 1,
					numValue : boProdAn.accessNumber
			};
			$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param, {
				"done" : function(){}
			});
			order.service.boProdAn = {};
		}		
		mktRes.phoneNbr.resetBoProdAn();		
		_hideOrderTitle();		
		$("#step1").hide();
		$("#main_div").hide();
		$("#order_prepare").show();	
		
		if(OrderInfo.actionFlag != 6){//主副卡变更
			$("#order_tab_panel_content").html('');
		}
		if(OrderInfo.actionFlag == 2){
			$("#orderedprod").show();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
		}
	};
	
	//订单时长
	var _createorderlonger = function(){
		var url=contextPath+"/order/createorderlonger";
		var response = $.callServiceAsJson(url, {});
		if(response.code==0){
			OrderInfo.orderlonger=response.data;
		}
	};
	
	return {
		tabChange		: _tabChange,
		commonTab		: _commonTab,
		step 			: _step,
		hideStep 		: _hideStep,
		showOrderTitle 	: _showOrderTitle,
		hideOrderTitle 	: _hideOrderTitle,
		backToInit		: _backToInit,
		createorderlonger:_createorderlonger,
		initOffer:initOffer
	};
})();
//初始化
$(function(){
	order.prepare.tabChange();
})
/**
 * 订单准备,绑定三个入口及相应初始化数据操作
 * 
 * @author wukf
 * @modifyby liusd
 */
CommonUtils.regNamespace("order", "prepare");
/**
 * 订单准备
 */
order.prepare = (function(){
	//三个入口选择
	var _tabChange= function(){
		$("#ul_busi_area li").each(function(){
			$(this).off("tap").on("tap",function(event){
				OrderInfo.actionFlag= 1;
				var url=$(this).attr("url");
				var forTab = $(this).attr("for");
				if(forTab == "order_tab_panel_phonenumber"){
					var custId = OrderInfo.cust.custId;
					if(OrderInfo.cust==undefined || custId==undefined || custId==""){
						$.alert("提示","在选号码之前请先进行客户定位或者新建客户！");
						return;
					}
				}
				_commonTab(url,forTab);
				event.stopPropagation();});});
		//异地业务隐藏三个入口
		var diffPlaceFlag = $("#diffPlaceFlag").val();
		if (diffPlaceFlag == "diff") {
			$("#order_prepare").hide();
			$("#nothreelinks").show();
		}
		
		//如果有资源ID，则跳转到终端详情
		var mktResCd$ = $("#mktResHidId").attr("mktResCd");
		var offerSpecId$ = $("#offerSpecHidId").val();
		if (mktResCd$ && mktResCd$.length > 0) {
			var url = contextPath+"/pad/mktRes/terminal/prepare";
			var param={};
			var response = $.callServiceAsHtmlGet(url,param);
			var content$=$("#div_public_info");
			content$.html(response.data);
			mktRes.terminal.selectTerminal($("#mktResHidId"));
			$("#order_prepare").hide();
			order.prepare.step(1);//显示"第一步：订单准备"
			_showOrderTitle("", "购手机", true);
			content$.show();
		}else if (offerSpecId$ && offerSpecId$.length > 0) {
			var url = contextPath+"/order/prodoffer/prepare";
			var param={"prodOfferId":offerSpecId$};
			var response = $.callServiceAsHtmlGet(url,param);
			var content$=$("#order_tab_panel_content");
			content$.html(response.data);
			$("#order_prepare").hide();
			order.prepare.step(1);//显示"第一步：订单准备"
			_showOrderTitle("", "办套餐", true);
			content$.show();
			order.service.initSpec();
			order.prodOffer.init();
		}
	};
	var _commonTab=function(url,forTab){
		$.callServiceAsHtmlGet(url,{},{
			"before":function(){
				$.ecOverlay("<strong>查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response || response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				if(order.cust.mgr.orderBtnflag=="1"){
					order.cust.mgr.btnQueryCustProdMore();
				};
				order.prepare.step(1);//显示"第一步：订单准备";
				//隐藏所有首页其它内容
				main.home.hideMainAllIco();
				var content$ = $("#order_prepare").html(response.data).fadeIn();
				$.jqmRefresh(content$);
				$("#navbar").slideUp(500);
				
				if (forTab == "order_tab_panel_terminal") {
					_showOrderTitle("", "购手机", true);
					order.service.releaseFlag = 1;
					order.prepare.createorderlonger();
					OrderInfo.busitypeflag=1;
					mktRes.terminal.queryApConfig();
					mktRes.terminal.initInParam('', '', '', '', '');
					mktRes.terminal.btnQueryTerminal(1);
					//回车事件交给键盘go
					$("#form_terminal_qry").off("submit").on("submit",function(e){
						e.preventDefault();//屏蔽form action默认事件
						mktRes.terminal.btnQueryTerminal(1);
					}).find("select").off("change").on("change",function(){
						mktRes.terminal.btnQueryTerminal(1);
						$(this).selectmenu("refresh");
					});
				}else if(forTab == "order_tab_panel_phonenumber"){
					_showOrderTitle("", "选号码", true);
					order.service.releaseFlag = 1;
					order.prepare.createorderlonger();
					OrderInfo.busitypeflag=1;
					mktRes.phoneNbr.initPhonenumber();					
				}else if(forTab == "order_tab_panel_offer"){
					_showOrderTitle("", "办套餐", true);
					//判断是否直接进入新装套餐入口
					if(order.service.releaseFlag==0){
						order.service.releaseFlag = 2;
					}
					order.prepare.createorderlonger();
					OrderInfo.busitypeflag=1;
					initOffer();
					order.service.searchPack();
					mktRes.phoneNbr.resetBoProdAn();
					
					//新装主副卡数据
					if($("#mainPhoneNum").val()!=undefined&&$("#mainPhoneNum").val()!=""){
						OrderInfo.newOrderNumInfo.mainPhoneNum = $("#mainPhoneNum").val();
					}
					if($("#newSubPhoneNum").val()!=undefined&&$("#newSubPhoneNum").val()!=""){
						OrderInfo.newOrderNumInfo.newSubPhoneNum = $("#newSubPhoneNum").val();
					}
					
					//直接跳过订购界面
					if(OrderInfo.provinceInfo.reloadFlag!="N" && OrderInfo.provinceInfo.prodOfferId!=null && OrderInfo.provinceInfo.prodOfferId!="" && OrderInfo.provinceInfo.prodOfferId!="null"){
						order.service.buyService("",OrderInfo.provinceInfo.prodOfferId,"");
					}
					
					if(OrderInfo.provinceInfo.reloadFlag=="N" && OrderInfo.reloadProdInfo.prodOfferId!=null && OrderInfo.reloadProdInfo.prodOfferId!="" && OrderInfo.reloadProdInfo.prodOfferId!="null"){
						order.service.buyService("",OrderInfo.reloadProdInfo.prodOfferId,"");
					}
					
				}
			}
		});	
	};
	
	//初始化套餐入口
	var initOffer = function(){
		query.common.queryApConfig("PROD_AND_OFFER",function(data){
			if(ec.util.isArray(data)){
				$.each(data,function(){
					if(this.OFFER_PRICE){ //价格
						$.each(this.OFFER_PRICE,function(){
							$("#select_price").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g, "")+"</option>");
						});
						$("#select_price").selectmenu("refresh");
					}else if(this.OFFER_INFLUX){ //流量
						$.each(this.OFFER_INFLUX,function(){
							$("#select_influx").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g, "")+"</option>");
						});
						$("#select_influx").selectmenu("refresh");
					}else if(this.OFFER_INVOICE){ //语音
						$.each(this.OFFER_INVOICE,function(){
							$("#select_invoice").append("<option value='"+this.COLUMN_VALUE+"'>"+this.COLUMN_VALUE_NAME.replace(/\"/g, "")+"</option>");
						});
						$("#select_invoice").selectmenu("refresh");
					}
				});
			}
		});
		$("#form_prodOffer_qry").off("submit").on("submit",function(e){
			e.preventDefault();//屏蔽form action默认事件
			order.service.searchPack();
		}).find("select").off("change").on("change",function(){
			order.service.searchPack();
			$(this).selectmenu("refresh");
		});
	};
	
	var _step = function(num) {
		//如果没传参数，默认显示第一步
		if (num == undefined || !num) {
			num = 1;
		}
		if(1==num){
			OrderInfo.order.step=0;
		}
		$.each($("div[id^=step]"),function(i,stepDiv){
			if (num == (i+1)) {
				$(this).show();
			} else {
				$(this).hide();
			}
		});
	};
	
	var _hideStep = function() {
		$("div[id^=step]").hide();
	};
	
	var _showOrderTitle = function(action, titleName, backwardFlag){
//		var cont$ = $("<span id='orderTitleSpan'></span>").html(action);
//		var back$ = '';
//		if (backwardFlag == true) {
//			back$ = $("<a href='javascript:void(0);'><span style='float: right;'>返回</span></a>");
//			back$.addClass("numberSearch back3").show().click(function(){order.prepare.backToInit();});
//		}
//		$("#orderTitleDiv h2").html('').append(cont$).append(titleName).append(back$).parent().show();
	};
	var _hideOrderTitle = function() {
		$("#orderTitleDiv").hide();
	};

	var _backToInit=function(){
		//若是购机或选号入口，在退出业务办理时将释放主卡预占的号码（过滤身份证预占的号码）
		var boProdAn = order.service.boProdAn;
		if(boProdAn.accessNumber && !boProdAn.idFlag){
			var param = {
					numType : 1,
					numValue : boProdAn.accessNumber
			};
			$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param, {
				"done" : function(){}
			});
			order.service.boProdAn = {};
		}		
		mktRes.phoneNbr.resetBoProdAn();		
		_hideOrderTitle();		
		$("#step1").hide();
		$("#main_div").hide();
		$("#order_prepare").show();	
		
		if(OrderInfo.actionFlag != 6){//主副卡变更
			$("#order_tab_panel_content").html('');
		}
		if(OrderInfo.actionFlag == 2){
			$("#orderedprod").show();
			$("#arroworder").removeClass();
			$("#arroworder").addClass("arrowup");
		}
	};
	
	//订单时长
	var _createorderlonger = function(){
		var url=contextPath+"/order/createorderlonger";
		var response = $.callServiceAsJson(url, {});
		if(response.code==0){
			OrderInfo.orderlonger=response.data;
		}
	};
	
	return {
		tabChange		: _tabChange,
		commonTab		: _commonTab,
		step 			: _step,
		hideStep 		: _hideStep,
		showOrderTitle 	: _showOrderTitle,
		hideOrderTitle 	: _hideOrderTitle,
		backToInit		: _backToInit,
		createorderlonger:_createorderlonger,
		initOffer:initOffer
	};
})();
//初始化
$(function(){
	order.prepare.tabChange();
});

/**
 * 套餐入口
 * 
 * @author dujb3
 */
CommonUtils.regNamespace("order", "prodOffer");
/**
 * 套餐入口
 */
order.prodOffer = (function($){
	
	var _init = function(){
		order.prodOffer.queryApConfig();
		
	};
	
	
	//查询平台配置信息
	var _queryApConfig=function(){
		var configParam={"CONFIG_PARAM_TYPE":"PROD_AND_OFFER"};
		var qryConfigUrl=contextPath+"/order/queryApConf";
		$.callServiceAsJsonGet(qryConfigUrl, configParam,{
			"done" : call_back_success_queryApConfig
		});
	};
	
	var call_back_success_queryApConfig=function(response){
		var OFFER_PRICE ;
		var OFFER_INFLUX ;
		var OFFER_INVOICE ;
		
		var OFFER_PRICE_html   = "<a href='javascript:void(0);' class='selected' val='' >不限</a>";
		var OFFER_INFLUX_html  = "<a href='javascript:void(0);' class='selected' val='' >不限</a>";
		var OFFER_INVOICE_html = "<a href='javascript:void(0);' class='selected' val='' >不限</a>";
		if(response.data){
			var dataLength=response.data.length;
			for (var i=0; i < dataLength; i++) {
				if(response.data[i].OFFER_PRICE){
					OFFER_PRICE = response.data[i].OFFER_PRICE ;
					for(var j=0;j<OFFER_PRICE.length;j++){
						var rowKey=OFFER_PRICE[j].COLUMN_VALUE;
						var rowVal=OFFER_PRICE[j].COLUMN_VALUE_NAME;
						OFFER_PRICE_html=OFFER_PRICE_html+"<a href='javascript:void(0);' val='"+rowKey+"'>"+rowVal+"</a>";
					}
					$("#price_basic").html(OFFER_PRICE_html);
					$("#price_basic a").each(function(){
						$(this).off("click").on("click",function(event){
							$("#price_basic a").each(function(){$(this).removeClass("selected");});
							$(this).addClass("selected");
							event.stopPropagation();
							order.service.searchPack(1);
						});
					});
				}else if(response.data[i].OFFER_INFLUX){
					OFFER_INFLUX = response.data[i].OFFER_INFLUX ;
					for(var j=0;j<OFFER_INFLUX.length;j++){
						var rowKey=OFFER_INFLUX[j].COLUMN_VALUE;
						var rowVal=OFFER_INFLUX[j].COLUMN_VALUE_NAME;
						OFFER_INFLUX_html=OFFER_INFLUX_html+"<a href='javascript:void(0);' val='"+rowKey+"'>"+rowVal+"</a>";
					}
					$("#influx_basic").html(OFFER_INFLUX_html);
					$("#influx_basic a").each(function(){
						$(this).off("click").on("click",function(event){
							$("#influx_basic a").each(function(){$(this).removeClass("selected");});
							$(this).addClass("selected");
							event.stopPropagation();
							order.service.searchPack(1);
						});
					});
				}else if(response.data[i].OFFER_INVOICE){
					OFFER_INVOICE = response.data[i].OFFER_INVOICE ;
					for(var j=0;j<OFFER_INVOICE.length;j++){
						var rowKey=OFFER_INVOICE[j].COLUMN_VALUE;
						var rowVal=OFFER_INVOICE[j].COLUMN_VALUE_NAME;
						OFFER_INVOICE_html=OFFER_INVOICE_html+"<a href='javascript:void(0);' val='"+rowKey+"'>"+rowVal+"</a>";
					}
					$("#invoice_basic").html(OFFER_INVOICE_html);
					$("#invoice_basic a").each(function(){
						$(this).off("click").on("click",function(event){
							$("#invoice_basic a").each(function(){$(this).removeClass("selected");});
							$(this).addClass("selected");
							event.stopPropagation();
							order.service.searchPack(1);
						});
					});
				}
			}
		}
	};
	
	return {
		init:_init,
		queryApConfig:_queryApConfig
	};
})(jQuery);

//初始化
$(function(){
	
});
/**
 * 附属销售品受理对象
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("AttachOffer");

/** 附属销售品受理对象*/
AttachOffer = (function() {

	var _openList = []; //保存已经选择的附属销售品列表，保存附属销售品完整节点，以及参数值
	
	var _openedList = []; //已经订购的附属销售品列表，保存附属销售品完整节点，以及参数值
	
	var _openServList = []; //保存已经选择功能产品列表，保存附属销售品完整节点，以及参数值
	
	var _openedServList = []; //保存已经订购功能产品列表，保存附属销售品完整节点，以及参数值
	
	var _openAppList = []; //保存产品下增值业务
	
	var _changeList = []; //3g订购4g流量包订单提交预校验时，保存修改缓存列表的修改数据，用于订单确认页面返回的反向操作
	
	var _labelList = []; //标签列表
	
	var checkedReserveNbr = "";//已经校验过的终端预约号
	
	var checkedReserveCode = "";//已经校验过的终端预约码
	
	var checkedOfferSpec = []; //已经校验过的终端预约号对应的促销包
	
	//初始化附属销售页面
	var _init = function(){
		//attach[1]
		var prodInfo = order.prodModify.choosedProdInfo;
		if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
			$.alert("提示","请选择一个在用产品");
			return;
		}
		OrderInfo.actionFlag = 3;
		if(OrderInfo.provinceInfo.mergeFlag=="0"){
			if(!query.offer.setOffer()){ //必须先保存销售品实例构成，加载实例到缓存要使用
				return ;
			}
		}
		if(!rule.rule.ruleCheck()){ //规则校验失败
			return;
		}
		var param = {
			offerSpecId : prodInfo.prodOfferId,
			offerTypeCd : 1,
			partyId: OrderInfo.cust.custId
		};
		if(ec.util.isObj(prodInfo.prodOfferId)){
			if(!query.offer.queryMainOfferSpec(param)){ //查询主套餐规格构成，并且保存
				return;
			}
		}else{
			OrderInfo.offerSpec = {};
		}
		if(CONST.getAppDesc()==0){ //4g系统需要
			if(!prod.uim.setProdUim()){ //根据UIM类型，设置产品是3G还是4G，并且保存旧卡
				return;	
			}
		}
		AttachOffer.queryAttachOffer();
	}; 
	
	//已订购的附属销售品查询
	var _queryAttachOffer = function() {
		//attach[2]
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		var prodId = prodInfo.prodInstId;
		var param = {
		    prodId : prodId,
		    prodSpecId : prodInfo.productId,
		    offerSpecId : prodInfo.prodOfferId,
		    acctNbr : prodInfo.accNbr
		};
		if(ec.util.isObj(prodInfo.prodBigClass)){
			param.prodBigClass = prodInfo.prodBigClass;
		}
		SoOrder.initFillPage();
		var data = query.offer.queryAttachOfferHtml(param);
		$("#dlg_cust_prod").popup("close");
		$("#navbar").slideUp(500);
		SoOrder.step(0,data); //订单准备
		$.jqmRefresh($("#order_tab_panel_content"));
		
		$("#fillNextStep").off("click").on("click",function(){
			SoOrder.submitOrder();
		});
		$("#fillLastStep").off("click").on("click",function(){
			_lastStep();
		});
		var member = CacheData.getOfferMember(prodId);
		//如果objId，objType，objType不为空才可以查询默认必须
		if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){
			param.queryType = "1,2";
			param.objId = member.objId;
			param.objType = member.objType;
			param.offerRoleId = member.offerRoleId;
			param.memberRoleCd = member.roleCd;
			//默认必须可选包
			var data = query.offer.queryDefMustOfferSpec(param);
			CacheData.parseOffer(data,prodId);
			//默认必须功能产品
			var data = query.offer.queryServSpec(param);
			CacheData.parseServ(data);
		}
		if(ec.util.isArray(OrderInfo.offerSpec.offerRoles)){ //主套餐下的成员判断
			var member = CacheData.getOfferMember(prodId);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(this.offerRoleId==member.offerRoleId && member.objType==CONST.OBJ_TYPE.PROD){
					var offerRole = this;
					$.each(this.roleObjs,function(){
						if(this.objType==CONST.OBJ_TYPE.SERV){
							var serv = CacheData.getServBySpecId(prodId,this.objId);//从已订购功能产品中找
							if(serv!=undefined){ //不在已经开跟已经选里面
								var $oldLi = $('#li_'+prodId+'_'+serv.servId);
								if(this.minQty==1){
									$oldLi.append('<dd class="mustchoose"></dd>');
								}
								$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
							}
						}
					});
					return false;
				}
			});
		}
		
		AttachOffer.changeLabel(prodId, prodInfo.productId,""); //初始化第一个标签附属
		
		order.dealer.initDealer();
		
		//进行重载
		_querrOldOrderInfo();
	};
	
	//切换标签attach[3]
	var _changeLabel = function(prodId,prodSpecId,labelId){
		if(labelId==''){
			labelId=$("#attachType_"+prodId).val();
		}
		$("#attachSearch_div_"+prodId+" ul").each(function(){
			$(this).hide();
		});
		var $ul = $("#ul_"+prodId+"_"+labelId); //创建ul
		if($ul[0]==undefined){ //没有加载过，重新加载  
			var queryType = "3";
			if(prodId>0){
				queryType = "";
			}
			if(labelId==CONST.LABEL.SERV){  //功能产品
				var param = {
					prodId : prodId,
					prodSpecId : prodSpecId,
					queryType : queryType,
					labelId : labelId
				};
				var data = query.offer.queryServSpec(param);
				var $ul = $('<ul id="ul_'+prodId+'_'+labelId+'" class="optionallist noorder" data-role="listview" data-inset="false" style="height:413px"></ul>');
				if(data!=undefined && data.resultCode == "0"){
					if(ec.util.isArray(data.result.servSpec)){
						var servList = CacheData.getServList(prodId);//过滤已订购
						var servSpecList = CacheData.getServSpecList(prodId);//过滤已选择
						var i=0;
						var html='';
						$.each(data.result.servSpec,function(){
							var servSpecId = this.servSpecId;
							var flag = true;
							$.each(servList,function(){
								if(this.servSpecId==servSpecId&&this.isDel!="C"){
									flag = false;
									return false;
								}
							});
							$.each(servSpecList,function(){
								if(this.servSpecId==servSpecId){
									flag = false;
									return false;
								}
							});
							if(flag){
			                  	html='<li id="li_'+prodId+'_'+this.servSpecId+'"><div class="block">';
								html+=this.servSpecName+'<span></span><span>';
								html+='<a href="javascript:AttachOffer.openServSpec('+prodId+','+this.servSpecId+',\''+this.servSpecName+'\',\''+this.ifParams+'\')" class="abtn03 icon-buy">&nbsp;</a></span>';
								html+='</span>';
								if(i%2==1){
									html+='</div></li>';
									$ul.append(html);
								}
								i++;
							}
						});
					}
				}
				$("#attachSearch_div_"+prodId).append($ul);
				$.jqmRefresh($("#attachSearch_div_"+prodId));
			}else{
				var param = {
					prodSpecId : prodSpecId,
					offerSpecIds : [],
					queryType : queryType,
					prodId : prodId,
					partyId : OrderInfo.cust.custId,
					labelId : labelId,
					ifCommonUse : ""			
				};
				if(OrderInfo.actionFlag == 2){ //套餐变更		
					$.each(OrderInfo.offerSpec.offerRoles,function(){
						if(ec.util.isArray(this.prodInsts)){
							$.each(this.prodInsts,function(){
								if(this.prodInstId==prodId){
									param.acctNbr = this.accessNumber;
									param.offerRoleId = this.offerRoleId;
									param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);	
									return false;
								}
							});
						}
					});
				}else if(OrderInfo.actionFlag == 3){  //可选包
					var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
					param.acctNbr = prodInfo.accNbr;
					if(!ec.util.isObj(prodInfo.prodOfferId)){
						prodInfo.prodOfferId = "";
					}
					var offerRoleId = CacheData.getOfferMember(prodInfo.prodInstId).offerRoleId;
					if(offerRoleId==undefined){
						offerRoleId = "";
					}
					param.offerRoleId = offerRoleId;
					param.offerSpecIds.push(prodInfo.prodOfferId);
				}else { //新装
					param.offerSpecIds.push(OrderInfo.offerSpec.offerSpecId);
					var prodInst = OrderInfo.getProdInst(prodId);
					if(prodInst){
						param.offerRoleId = prodInst.offerRoleId;
					}
				}
				query.offer.queryCanBuyAttachSpec(param,function(data){
					var $ul = $('<ul id="ul_'+prodId+'_'+labelId+'" class="optionallist noorder" data-role="listview" data-inset="false"  style="height:413px"></ul>');
					if(data!=undefined && data.resultCode == "0"){
						if(ec.util.isArray(data.result.offerSpecList)){
							var offerList = CacheData.getOfferList(prodId); //过滤已订购
							var offerSpecList = CacheData.getOfferSpecList(prodId);//过滤已选择
							var i=0;
							var html='';
							$.each(data.result.offerSpecList,function(){
								var offerSpecId = this.offerSpecId;
								var flag = true;
								$.each(offerList,function(){
									if(this.offerSpecId==offerSpecId&&this.isDel!="C"){
										flag = false;
										return false;
									}
								});
								$.each(offerSpecList,function(){
									if(this.offerSpecId==offerSpecId){
										flag = false;
										return false;
									}
								});
								if(flag){
									html='<li id="li_'+prodId+'_'+this.offerSpecId+'"><div class="block">';
									html+=this.offerSpecName+'<span></span><span>';
									html+='<a href="javascript:AttachOffer.addOfferSpec('+prodId+','+this.offerSpecId+')" class="abtn03 icon-buy">&nbsp;</a></span>';
									html+='</span>';
									if(i%2==1){
										html+='</div></li>';
										$ul.append(html);
									}
									i++;
								}
							});
						}
					}
					$("#attachSearch_div_"+prodId).append($ul);
					$.jqmRefresh($("#attachSearch_div_"+prodId));
				});
			}
		}else{
			$("#ul_"+prodId+"_"+labelId).show();
		}
	};
	
	var _querrOldOrderInfo=function(){
		//开始可选包前进行重载校验 [4]
		var isReload=OrderInfo.provinceInfo.reloadFlag;
		
		var orderInfo=OrderInfo.reloadOrderInfo;
		
		if(isReload=="N"){
			if(orderInfo==null || orderInfo=="" || orderInfo==undefined){
				$.alert("订单数据为空，重载失败!");
				return ;
			} 
			
			//0是正确的，进行信息重新加载
			var resultCode=orderInfo.resultCode;
			var resultMsg=orderInfo.resultMsg;
			
			if(resultCode=="0"){
				//进行进行数据解析工作,获取产品数据
				var custOrderList=orderInfo.result.orderList.custOrderList;
				
				var orderListInfo=orderInfo.result.orderList.orderListInfo;
				
				if(custOrderList!=null && custOrderList!=""){
					//获取下属的产品
					if(custOrderList!=null && custOrderList.length>0){
						$(custOrderList).each(function(i,custOrder) { 
							
							//先把删除的开通功能进行删除操作
							$(custOrder.busiOrder).each(function(i,busiOrder) { 
								//解析到具体的订购产品数据
								//获取产品操作类型
								var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;
								
								//获取产品的操作状态,state,del-删除,add-添加
								var state="";
								var data=busiOrder.data;
								var ooOwners;
								var boServs;
								
								// 7是已开通功能，状态的获取和其他类型获取不一样
								if(boActionTypeCd=="7"){
									boServs=data.boServs;
									
									if(boServs!=null){
										$(boServs).each(function(i,boServ) { 
											state=boServ.state;
										});
									}
								}
								
								var busiObj=busiOrder.busiObj;
								
								if(boActionTypeCd=="7"){
									//7是已开通功能产品
									//获取唯一ID标识
									var instId=busiObj.instId;
									
									var boServOrders=data.boServOrders;
									
									$(data.boServs).each(function(i,boServ) { 
										var servId=boServ.servId;
										var state=boServ.state;
										if(state=="DEL"){
											_closeServSub(instId,servId);//4-1
										}
									});
								}
							});
						});
						
						$(custOrderList).each(function(i,custOrder) { 
							$(custOrder.busiOrder).each(function(i,busiOrder) { 
								//解析到具体的订购产品数据
								//获取产品操作类型
								var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;
								
								//获取产品的操作状态,state,del-删除,add-添加
								var state="";
								
								var data=busiOrder.data;
								
								var ooOwners;
								var boServs;
								
								// 7是已开通功能，状态的获取和其他类型获取不一样
								if(boActionTypeCd=="7"){
									boServs=data.boServs;
									
									if(boServs!=null){
										$(boServs).each(function(i,boServ) { 
											state=boServ.state;
										});
									}
								}else{
									ooOwners=data.ooOwners;
									if(ooOwners!=null){
										$(ooOwners).each(function(i,ooOwner) { 
											state=ooOwner.state;
											return false
										});
									}
								}
								
								var busiObj=busiOrder.busiObj;
								
								//S2是已订购可选包
								if(boActionTypeCd=="S2"){
									//获取唯一ID标识
									var instId=busiObj.instId;
									
									$(data.ooRoles).each(function(i,ooRole) { 
										var objInstId=ooRole.objInstId;
										if(state=="DEL"){
											_delOfferSub(objInstId,instId);//4-2
										}
									});
								}else if(boActionTypeCd=="7"){
									//7是已开通功能产品
									//获取唯一ID标识
									var instId=busiObj.instId;
									
									var boServOrders=data.boServOrders;
									
									$(data.boServs).each(function(i,boServ) { 
										var servId=boServ.servId;
										var state=boServ.state;
										
										if(state=="ADD"){
											$(boServOrders).each(function(i2,boServOrder) {
												var servSpecId=boServOrder.servSpecId;
												var servSpecName=boServOrder.servSpecName;
												
												_openServSpecSub(instId,servSpecId,servSpecName,'N');//4-3
											});
										}
									});
								}else if(boActionTypeCd=="S1"){
									//S1是订单中的已选可选包数据
									//获取唯一ID标识
									var objId=busiObj.objId;
									var accessNumber=busiObj.accessNumber;
									var objName=busiObj.objName;
									var prodId=null;
									
									var ooRoles=data.ooRoles;
									var busiOrderAttrs=data.busiOrderAttrs;
									
									$(data.ooRoles).each(function(i,ooRole) { 
										prodId=ooRole.prodId;
										return false;
									});
									
									var isNeedAdd=false;
									
									var roleCode="";
									
									$(busiOrderAttrs).each(function(i,busiOrderAttr) { 
										var itemSpecId=busiOrderAttr.itemSpecId;
										if(itemSpecId=="111111116"){
											roleCode=busiOrderAttr.role;
											isNeedAdd=true;
											return false;
										}
									});
									
									//新增发展人
									if(isNeedAdd){
										_addAttachDealerSub(prodId+"_"+objId,accessNumber,objName,roleCode);//4-4
									}
									
									//重载订单中已经选择的服务
									_addOfferSpecSub(prodId,objId,ooRoles);//4-5
									
									//加载终端数据
									var bo2Coupons=data.bo2Coupons;
									
									if(bo2Coupons!=null && bo2Coupons!=null && bo2Coupons.length>0){
										$(bo2Coupons).each(function(i,bo2Coupon) { 
											var prodId=bo2Coupon.prodId;
											var attachSepcId=bo2Coupon.attachSepcId;
											var num=bo2Coupon.num;
											var couponInstanceNumber=bo2Coupon.couponInstanceNumber;
											
											$("#terminalText_"+prodId+"_"+attachSepcId).val(couponInstanceNumber);
											
											_checkTerminalCodeSub(prodId,attachSepcId);//4-6
										});
									}
								}
							});
						});
						
						//号码的预占一定要放到最后
						$(custOrderList).each(function(i,custOrder) { 
							$(custOrder.busiOrder).each(function(i,busiOrder) { 
								//解析到具体的订购产品数据
								//获取产品操作类型
								var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;
								
								var data=busiOrder.data;
								
								var ooOwners;
								var boServs;
								
								//14是号码预占
								if(boActionTypeCd=="14"){
									//加载UIM数据
									var bo2Coupons=data.bo2Coupons;
									
									if(bo2Coupons!=null && bo2Coupons!=null && bo2Coupons.length>0){
										$(bo2Coupons).each(function(i,bo2Coupon) { 
											var prodId=bo2Coupon.prodId;
											var attachSepcId=bo2Coupon.attachSepcId;
											var couponInstanceNumber=bo2Coupon.couponInstanceNumber;
											var state=bo2Coupon.state;
											
											if(state=="ADD"){
												
												//$("#uim_txt_"+prodId).val(couponInstanceNumber);
												
												//先释放
												//_releaseUim(prodId);//4-7
												
												//释放的时候会清空输入框，所以再次填值
												//$("#uim_txt_"+prodId).val(couponInstanceNumber);											
												
												//第一次释放
												//_checkUim(prodId);
												
												//如果失败,进行第二次
												//if(isRightCheck=="N"){
													//_checkUim(prodId);
												//}
												_uimCardInfoSearch(couponInstanceNumber,prodId,bo2Coupon);
											}
										});
									}
								}
							});
						});
					}
				}
				
				//订单备注和模版等加载
				if(orderListInfo!=null && custOrderList!=null){
					var custOrderAttrs=orderListInfo.custOrderAttrs;
					var isTemplateOrder=orderListInfo.isTemplateOrder;
					var templateOrderName=orderListInfo.templateOrderName;
					
					$(custOrderAttrs).each(function(i,custOrderAttr) { 
						var itemSpecId=custOrderAttr.itemSpecId;
						
						//111111118是为备注的编码
						if(itemSpecId=="111111118"){
							var value=custOrderAttr.value;
							
							if(value!=null && value!=""){
								$("#order_remark").html(value);
							}
						}
					});
					
					//模版的操作
					if(isTemplateOrder=="Y"){
						$("#isTemplateOrder").click();//选中模版按钮
						
						SoOrder.showTemplateOrderName();//显示模版名称输入
						
						$("#templateOrderName").val(templateOrderName);//赋值模版名称
					}
				}
			}
		}
	}
	
	var  _uimCardInfoSearch=function(instCode,prodId,bo2Coupon){
		$("#uim_txt_"+prodId).val(instCode);//将UIM卡信息放入
		var coupon = {
				couponUsageTypeCd : "3", //物品使用类型
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : bo2Coupon.couponId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : "3000", //物品费用项类型
				couponNum : 1, //物品数量
				storeId : bo2Coupon.storeId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : 0, //物品价格
				couponInstanceNumber :instCode, //物品实例编码
				terminalCode : instCode,//前台内部使用的UIM卡号
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId :  prodId, //产品ID
				offerId : bo2Coupon.offerId, //销售品实例ID
				state : "ADD", //动作
				relaSeq : "" //关联序列	
		};
		if(bo2Coupon.cardTypeFlag!=null && bo2Coupon.cardTypeFlag!=""){
			coupon.cardTypeFlag=bo2Coupon.cardTypeFlag;
		}
		
		//校验按钮
		$("#uim_check_btn_"+prodId).attr("disabled",true);
		
		//释放按钮
		$("#uim_release_btn_"+prodId).removeAttr("disabled");
		//$("#uim_release_btn_"+prodId).attr("class","btn btn-uim");
		
		//输入框
		$("#uim_txt_"+prodId).attr("disabled",true);
		
		if(getIsMIFICheck(prodId)){//判断是否通过MIFI 校验
			$("#isMIFI_"+prodId).val("yes");
		}else{
			$("#isMIFI_"+prodId).val("no");
		}
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
	}
	
	//关闭已订购功能[4-1]
	var _closeServSub = function(prodId,servId){
		var serv = CacheData.getServ(prodId,servId);
		var $div = $("#li_span_"+prodId+"_"+servId).parent(); //定位删除的附属
		if($div.attr("class")=="block deldiv"){  //已经退订，再订购
			_openServ(prodId,serv);
		}else { //关闭
			var uim = OrderInfo.getProdUim(prodId);
			if(serv.servSpecId=="280000020" && (OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23) && uim.cardTypeFlag=="1"){//补换卡补4G卡不能退订4G上网功能产品
				$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");
				return;
			}
			
			$div.addClass("deldiv");
			serv.isdel = "Y";
		}
	};
	
	//删除附属销售品实例[4-2]
	var _delOfferSub = function(prodId,offerId){
		var $div = $("#li_span_"+prodId+"_"+offerId).parent(); //定位删除的附属
		if($div.attr("class")=="block deldiv"){  //已经退订，再订购		
			AttachOffer.addOffer(prodId,offerId,$div.text());
		}else { //退订
			var offer = _getOffer(prodId,offerId);
			if(offer==undefined){
				return;
			}
			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offerId	
				};
				param.acctNbr = OrderInfo.getAccessNumber(prodId);
				var data = query.offer.queryOfferInst(param);
				if(data==undefined){
					return;
				}
				offer.offerMemberInfos = data.offerMemberInfos;
				offer.offerSpec = data.offerSpec;
			}
			var content = "";
			if(offer.offerSpec!=undefined){
				content = CacheData.getOfferProdStr(prodId,offer,1);
			}else {
				content = '退订【'+$div.text()+'】可选包' ;
			}
			
			offer.isdel = "Y";
			$div.addClass("deldiv");
			delServByOffer(prodId,offer);
		}
	};
	
	//获取销售品实例构成 4-2-1
	var _getOffer = function(prodId,offerId){
		var offerList = _getOfferList(prodId);
		if(ec.util.isArray(offerList)){
			for ( var i = 0; i < offerList.length; i++) {
				if(offerList[i].offerId==offerId){
					return offerList[i];
				}
			}
		}
	};
	
	//通过产品id获取产品已开通附属实例列表4-2-2
	var _getOfferList = function (prodId){
		for ( var i = 0; i < AttachOffer.openedList.length; i++) {
			var opened = AttachOffer.openedList[i];
			if(opened.prodId == prodId){
				return opened.offerList;
			} 
		}
		return []; //如果没值返回空数组
	};
	
	//开通功能产品[4-3]
	var _openServSpecSub = function(prodId,servSpecId,specName,ifParams){
		var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
		if(servSpec==undefined){   //在可订购功能产品里面 
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : specName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			servSpec = newSpec;
		}
		
		_checkServExcludeDependSub(prodId,servSpec);
	};
	
	//校验服务的互斥依赖[4-3-1]
	var _checkServExcludeDependSub = function(prodId,serv,flag){
		var servSpecId = serv.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		if(param.orderedServSpecIds.length == 0){
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserServDataSub(data.result,prodId,serv);//解析数据
			}
		}
	};
	
	//解析服务互斥依赖[4-3-2]
	var paserServDataSub = function(result,prodId,serv){
		var servSpecId = serv.servSpecId;
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
		};
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + this.servSpecName + "<br>";
					param.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.dependServ.push(this);
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.relatedServ.push(this);
			});
		}
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{	
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
			excludeAddServ(prodId,servSpecId,param);
		}
	};
	
	//点击确认，添加附属销售品发展人[4-4]
	var _addAttachDealerSub = function(id,accessNumbe,objName,roleCode){
		var prodId = id.split("_")[0];
		if($("#tr_"+id)[0]==undefined){ //没有添加过
			var objId = id+"_"+OrderInfo.SEQ.dealerSeq;
			var $tdType = _getDealerTypeSub(id,objId);
			if($tdType==undefined){
				return false;
			}
			var $tr = $("#atr_"+id);
			var $li = $('<li name="tr_'+id+'"></li>');
			var $dl= $("<dl></dl>");
			$dl.append("<dd>"+accessNumbe+"</dd>");
			$dl.append("<dd>"+objName+"</dd>");
			$dl.append($tdType);
			
			var dealer = $("#tr_"+prodId).find("input"); //产品协销人
			var staffId = 1;
			var staffName = "";
			if(dealer[0]==undefined){
				staffId = OrderInfo.staff.staffId;
				staffName = OrderInfo.staff.staffName;
			}else {
				staffId = dealer.attr("staffId");
				staffName = dealer.attr("value");
			}
			if(order.ysl!=undefined){
				var $dd = $('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'"  data-mini="true"></input></dd>');
				$dl.append($dd);
			}else{
				var $dd = $('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'"  data-mini="true"  readonly="readonly"></input></dd>');
				$dl.append($dd);
			}
			var $button='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';
			$button+='<button data-mini="ture" onclick="order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
			$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+id+'\')">添加</button></div>';
			$button+=' <div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';			
			$dl.append($button);
			$li.append($dl);
			$("#dealerTbody").append($li);
			$.jqmRefresh($("#dealerTbody"));
			OrderInfo.SEQ.dealerSeq++;
		}	
	};
	
	//校验发展人类型,并获取发展人类型列表[4-4-1]
	var _getDealerTypeSub = function(objInstId,objId){
		var dealerType = "";
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":40020005,"NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":40020006,"NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":40020007,"NAME":"第三发展人"}];
		}
		if(OrderInfo.order.dealerTypeList!=undefined && OrderInfo.order.dealerTypeList.length>0){ //发展人类型列表
			$.each(OrderInfo.order.dealerTypeList,function(){
				var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
				var flag = true;
				$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
					if(dealerTypeId==$(this).val()){  //如果已经存在
						flag = false;
						return false;
					}
				});
				if(flag){ //如果发展人类型没有重复
					dealerType = dealerTypeId;
					return false;
				}
			});
		}else{
			$.alert("信息提示","没有发展人类型");
			return;
		}
		if(dealerType==undefined || dealerType==""){	
			$.alert("信息提示","每个业务发展人类型不能重复");
			return;
		}
		var $tdType = $('<dd></dd>');
		var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
		var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
		var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		$.each(OrderInfo.order.dealerTypeList,function(){
			if(this.PARTYPRODUCTRELAROLECD==dealerType){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>");
			}else{
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			}
		});
		$field.append($select);
		$tdType.append($field);
		return $tdType;
	};
	
	//订购附属销售品[4-5]
	var _addOfferSpecSub = function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		
		_setServ2OfferSpecSub(prodId,newSpec);
	
		_checkOfferExcludeDependSub(prodId,newSpec);
	};
	
	//把选中的服务保存到销售品规格中[4-5-1]
	var _setServ2OfferSpecSub = function(prodId,offerSpec,roles){
		if(offerSpec!=undefined){
			$.each(offerSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					var nowProd=prodId+"_"+this.objId;
					
					$(roles).each(function(i,role) { 
						var oldProd=role.prodId+"_"+role.objId;
							
						if(nowProd==oldProd){
							this.selQty = 1;
							return false;
						}else{
							this.selQty = 2;
						}
					});
				});
			});
		}
	};
	
	//校验销售品的互斥依赖[4-5-2]
	var _checkOfferExcludeDependSub = function(prodId,offerSpec){
		var offerSpecId = offerSpec.offerSpecId;
		var param = CacheData.getExcDepOfferParam(prodId,offerSpecId);
		var data = query.offer.queryExcludeDepend(param);//查询规则校验
		if(data!=undefined){
			paserOfferDataSub(data.result,prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
		}
	};
	
	//解析互斥依赖返回结果[4-5-3]
	var paserOfferDataSub = function(result,prodId,offerSpecId,specName){
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
				excludeOffer : [],   //互斥依赖显示列表
				dependOffer : {  //存放互斥依赖列表
					dependOffers : [],
					offerGrpInfos : []
				}
		};
		if(result!=""){
			var exclude = result.offerSpec.exclude;
			var depend = result.offerSpec.depend;
			
			//解析可选包互斥依赖组
			if(ec.util.isArray(exclude)){
				for (var i = 0; i < exclude.length; i++) {
					var offerList = CacheData.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
						param.excludeOffer.push(exclude[i].offerSpecId);
					}
				}
			}
			if(depend!=undefined && ec.util.isArray(depend.offerInfos)){
				for (var i = 0; i < depend.offerInfos.length; i++) {	
					content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
				}	
			}
			if(depend!=undefined && ec.util.isArray(depend.offerGrpInfos)){
				for (var i = 0; i < depend.offerGrpInfos.length; i++) {
					var offerGrpInfo = depend.offerGrpInfos[i];
					param.dependOffer.offerGrpInfos.push(offerGrpInfo);
					content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
					if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
						for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
							var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
							content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
						}
					}
				}
			}
		}
		var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);//查询销售品构成成员的依赖互斥以及连带
		
		content=content+serContent;
		
		AttachOffer.addOpenList(prodId,offerSpecId); 
	};
	
	//终端校验[4-6]
	var _checkTerminalCodeSub = function(prodId,offerSpecId){
		var flag ="0";
		
		//清空旧终端信息
		//_filterAttach2Coupons(prodId,offerSpecId,num);
		
		//清空旧终端信息
		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
			var attach2Coupon = OrderInfo.attach2Coupons[i];
			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId){
				OrderInfo.attach2Coupons.splice(i,1);
				break;
			}
		}
		
		var objInstId = prodId+"_"+offerSpecId;
		var resIdArray = [];
		var terminalGroupIdArray = [];
		
		$("#terminalSel_"+objInstId + "  option").each(function(){
			resIdArray.push($(this).val());
		});
		
		$("#group_"+objInstId+"  option").each(function(){
			terminalGroupIdArray.push($(this).val());
		});
		
		var resId = resIdArray.join("|"); //拼接可用的资源id
		var terminalGroupId = terminalGroupIdArray.join("|"); //拼接可用的资源终端组id
		
		if((resId==undefined || $.trim(resId)=="") && (terminalGroupId==undefined || $.trim(terminalGroupId)=="")){
			$.alert("信息提示","终端规格不能为空！");
			return;
		}
		
		var instCode = $("#terminalText_"+objInstId).val();
		
		if(instCode==undefined || $.trim(instCode)==""){
			$.alert("信息提示","终端串码不能为空！");
			return;
		}
		
		//验证
		if(_checkData(objInstId,instCode)){
			return;
		}
		
		var param = {
			instCode : instCode,
			flag : flag,
			mktResId : ""
		//	termGroup : ""
		};
		
		var data = query.prod.checkTerminal(param);
		
		if(data==undefined){
			return;
		}
		
		var activtyType ="";
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C" && ec.util.isArray(spec.agreementInfos)){  //订购的附属销售品
                    if(spec.agreementInfos[0].activtyType == 2){
                    	activtyType = "2";
				    }
				}
			}
		}
		
		if(data.statusCd==CONST.MKTRES_STATUS.USABLE || (data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2")){
			//$.alert("信息提示",data.message);
			$("#terminalSel_"+objInstId).val(data.mktResId);
			
			var mktPrice=0;//营销资源返回的单位是元
			var mktColor="";
			if(ec.util.isArray(data.mktAttrList)){
				$.each(data.mktAttrList,function(){
					if(this.attrId=="65010058"){
						mktPrice=this.attrValue;
					}else if(this.attrId=="60010004"){
						mktColor=this.attrValue;
					}
				});
			}
			
			$("#terminalName").html(data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");
			
			$("#terminalDesc").css("display","block");
			
			var coupon = {
				couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : data.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
				couponNum : 1, //物品数量
				storeId : data.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : mktPrice, //物品价格
				couponInstanceNumber : data.instCode, //物品实例编码
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId : prodId+"", //产品ID
				offerId : -1, //销售品实例ID
				attachSepcId : offerSpecId+"",
				state : "ADD", //动作
				relaSeq : "" ,//关联序列	
				num	:"1"
			};
			if(CONST.getAppDesc()==0){
				coupon.termTypeFlag=data.termTypeFlag;
			}
			OrderInfo.attach2Coupons.push(coupon);
		}else{
			$.alert("提示",data.message);
		}
	};
	
	//过滤 同一个串码输入框校验多次，如果之前有校验通过先清空[4-6-1]
	var _filterAttach2Coupons=function(prodId,offerSpecId,num){
		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
			var attach2Coupon = OrderInfo.attach2Coupons[i];
			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId&&attach2Coupon.num==num){
				OrderInfo.attach2Coupons.splice(i,1);
				$("#terminalName_"+num).html("");
				break;
			}
		}
	};
	
	//判断同一个终端组里面是否串码有重复的[4-6-2]
	var _checkData=function(objInstId,terminalCode){
		var $input=$("input[id^=terminalText_"+objInstId+"]");
		var num=0;
		$input.each(function(){//遍历页面上面的串码输入框，为的是跟缓存里面的串码进行比对
			var instCode=$.trim(this.value);//页面上面的串码
			if(ec.util.isObj(instCode)&&terminalCode==instCode){
				num++;
			}
		});
		if(num>=2){
			$.alert("信息提示","终端串码重复了，请填写不同的串码。");
			return true ; 
		}
		return false;
	};
	
	//uim卡号释放[4-7]
	var _releaseUim = function(prodId){	
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}
		//释放UIM并更新门户记录
		var param = {
			numType : 2,
			numValue : cardNo
		};
		var jr = $.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);			
		if(jr.code==-2){
			$.alertM(jr.data);
			return;
		}
		if(jr.code==-1){
			$.alert("提示",jr.data);
			return;
		}
		//$.alert("提示","成功释放UIM卡："+cardNo);
		$("#uim_check_btn_"+prodId).attr("disabled",false);
		$("#uim_release_btn_"+prodId).attr("disabled",true);
		$("#uim_txt_"+prodId).attr("disabled",false);
		$("#uim_txt_"+prodId).val("");
		OrderInfo.clearProdUim(prodId);
	};
	
	//uim卡号校验[4-8]
	var _checkUim = function(prodId){
		var phoneNumber = OrderInfo.getAccessNumber(prodId);
		var offerId = "-1"; //新装默认，主销售品ID
		if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){ //新装需要选号
			if(phoneNumber==''){
				$.alert("提示","校验UIM卡前请先选号!");
				return false;
			}
		}
		if(OrderInfo.actionFlag==3 || OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23 || OrderInfo.actionFlag==6 ){ //可选包变更，补换卡，加装副卡
			offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
		}
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}
		var inParam = {
			"instCode" : cardNo,
			"phoneNum" : phoneNumber
		};

		var prodSpecId = OrderInfo.getProdSpecId(prodId);
		var mktResCd="";
		if(CONST.getAppDesc()==0){
			if(getIsMIFICheck(prodId)){
				mktResCd =getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID);
			}else{
				mktResCd = getMktResCd(prodSpecId);
			}
			if(ec.util.isObj(mktResCd)){
//				inParam.mktResCd = mktResCd;
			}else{
				$.alert("提示","查询卡类型失败！");
				return;
			}
		}
		var data = _checkUimSub(inParam);//校验uim卡
		if(data==undefined || data.baseInfo==undefined){
			return false;
		}
		//根据uim返回数据组织物品节点
		var couponNum = data.baseInfo.qty ;
		if(couponNum==undefined||couponNum==null){
			couponNum = 1 ;
		}
		var coupon = {
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "1",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId : data.baseInfo.mktResId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : "3000", //物品费用项类型
			couponNum : couponNum, //物品数量
			storeId : data.baseInfo.mktResStoreId, //仓库ID
			storeName : "1", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : data.baseInfo.mktResInstCode, //物品实例编码
			terminalCode : data.baseInfo.mktResInstCode,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId :  prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "ADD", //动作
			relaSeq : "" //关联序列	
		};
		if(CONST.getAppDesc()==0){
			coupon.cardTypeFlag=data.baseInfo.cardTypeFlag;//UIM卡类型
		}
		$("#uim_check_btn_"+prodId).attr("disabled",true);
		$("#uim_release_btn_"+prodId).attr("disabled",false);
		$("#uim_txt_"+prodId).attr("disabled",true);
		if(getIsMIFICheck(prodId)){//判断是否通过MIFI 校验
			$("#isMIFI_"+prodId).val("yes");
		}else{
			$("#isMIFI_"+prodId).val("no");
		}
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
	};
	
	//4-8-2
	var getMktResCd = function(prodSpecId){
		var param={
			"prodSpecId":prodSpecId
		};
		var url = contextPath+"/mktRes/uim/getMktResCd";
		$.ecOverlay("<strong>获取产品规格中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == "0") {
			return response.data;
		}else{
			return "";
		}
	};
	
	/*
	 * 是否是MIFI卡类型校验4-8-3
	 */
	var getIsMIFICheck=function(prodId){
		var prodIdTmp=(Math.abs(prodId)-1);
		if(AttachOffer.openServList.length>prodIdTmp){
			var specList = AttachOffer.openServList[prodIdTmp].servSpecList;
			for (var j = 0; j < specList.length; j++) {
				var spec = specList[j];
				if(spec.isdel!="Y" && spec.isdel!="C"){
					if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID && CONST.APP_DESC==0){
						return true ; 
					}
				}
			}
		}
		return false;
	};
	
	//4-8-4
	var _checkUimSub=function(param,prodId){
		var url = contextPath+"/app/mktRes/uim/checkUim";
		$.ecOverlay("<strong>UIM卡校验中,请稍等...</strong>");
		var response = $.callServiceAsJson(url,param);
		$.unecOverlay();
		if (response.code == 0) {
			isRightCheck="Y";
			//$.alert("提示","UIM卡校验成功!");
			
			//校验成功后，修改按钮class属性数据
			$("#uim_check_btn_"+prodId).attr("disabled","disabled");	
			
			//修改释放按钮的展示
			$("#uim_release_btn_"+prodId).removeAttr("disabled");
			
			return response.data;
		}else{
			if(typeof response == undefined){
				$.alert("提示","UIM卡校验请求调用失败，可能原因服务停止或者数据解析异常");
			}else if (response.code == -2) {
				$.alertM(response.data);
			}else{
				var msg="";
				if(response.data!=undefined && response.data.msg!=undefined){
					msg=response.data.msg;
				}else{
					msg="卡号["+cardNo+"]预占失败";
				}
				$.alert("提示","UIM卡校验失败，可能原因:"+msg);
			}
		}
	};
	
	//可订购的附属查询 
	var _queryAttachOfferSpec = function(param) {
	
		var data=query.offer.queryAttachSpec(param);
		if (data) {
			$("#attach_"+param.prodId).html(data);
			$.jqmRefresh($("#attach_"+param.prodId));
			_showMainRoleProd(param.prodId); //通过主套餐成员显示角字
			//根据已选功能产品查询带出的可选包
			var servSpecIds = [];
			if(AttachOffer.openServList!=null&&AttachOffer.openServList!=undefined){
				$.each(AttachOffer.openServList,function(){
					if(this.prodId == param.prodId){
						var servSpecList = this.servSpecList;
						if(servSpecList!=null&&servSpecList!=undefined){
							$.each(servSpecList,function(){
								if(this.servSpecId!=null&&this.servSpecId!=undefined){

									servSpecIds.push(this.servSpecId);
								}
								});
							}
					}
				});					
			}
			param.servSpecIds = servSpecIds;
			var queryData = query.offer.queryServSpecPost(param);
			if(queryData!=null&&queryData.resultCode==0){
				if(queryData.result.offerList!=null&&queryData.result.offerList!=undefined){
					$.each(queryData.result.offerList,function(){
						AttachOffer.addOpenList(param.prodId,this.offerSpecId); 
					});
				}					
			}				
			AttachOffer.changeLabel(param.prodId,param.prodSpecId,""); //初始化第一个标签附属
			if(param.prodId==-1 && OrderInfo.actionFlag==14){ //合约计划特殊处理
				AttachOffer.addOpenList(param.prodId,mktRes.terminal.offerSpecId);
			}
		}
	};
	var _changeOfferS=function(obj,prodId){
		var val=$(obj).val();
		if(val=="0"){
			$('#open_ul_'+prodId).show();
			$('#open_serv_ul_'+prodId).hide();
		}else{
			$('#open_ul_'+prodId).hide();
			$('#open_serv_ul_'+prodId).show();
		}
	};
	
	var _changeOfferOrdered=function(obj,prodId){
		var val=$(obj).val();
		if(val=="0"){
			$('#open_ul_'+prodId).hide();
			$('#open_serv_ul_'+prodId).hide();
			$('#order_ul_'+prodId).show();
			$('#serv_ul_'+prodId).hide();
		}else if(val=="1"){
			$('#open_ul_'+prodId).hide();
			$('#open_serv_ul_'+prodId).hide();
			$('#order_ul_'+prodId).hide();
			$('#serv_ul_'+prodId).show();
		}else if(val=="2"){
			$('#open_ul_'+prodId).show();
			$('#open_serv_ul_'+prodId).hide();
			$('#order_ul_'+prodId).hide();
			$('#serv_ul_'+prodId).hide();
		}else if(val=="3"){
			$('#open_ul_'+prodId).hide();
			$('#open_serv_ul_'+prodId).show();
			$('#order_ul_'+prodId).hide();
			$('#serv_ul_'+prodId).hide();
		}
	};	
	//显示增值业务内容
	var _showApp = function(prodId){
		var appList = CacheData.getOpenAppList(prodId);
		var content = CacheData.getAppContent(prodId,appList);
		$.confirm("增值业务设置： ",content[0].innerHTML,{ 
			yes:function(){	
				$.each(appList,function(){
					if($("#"+prodId+"_"+this.objId).attr("checked")=="checked"){
						this.dfQty = 1;
					}else{
						this.dfQty = 0;
					}
				});
			},
			no:function(){
			}
		});
	};
	
	//获取产品实例
	var getProdInst = function(prodId){
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(ec.util.isArray(offerRole.prodInsts)){
				for ( var j = 0; j < offerRole.prodInsts.length; j++) {  //遍历产品实例列表
					if(offerRole.prodInsts[j].prodInstId==prodId){
						return offerRole.prodInsts[j];
					}
				}
			}
		}
	};
	
	//主销售品角色分解个每个接入产品
	var _showMainRoleProd = function(prodId){
		var prodInst = getProdInst(prodId);
		var app = {
			prodId:prodId,
			appList:[]
		};
		AttachOffer.openAppList.push(app);
		for (var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.CONTENT){ //增值业务角色
				for ( var j = 0; j < offerRole.roleObjs.length; j++) {
					var roleObj = offerRole.roleObjs[j];
					if(roleObj.objType== CONST.OBJ_TYPE.SERV){
						if(prodInst.objId==roleObj.parentProdId && prodInst.componentTypeCd.substring(0,1)==roleObj.componentTypeCd.substring(0,1)){	
							app.appList.push(roleObj);
							if(roleObj.servSpecId==undefined){
								roleObj.servSpecId = roleObj.objId;
							}
							if(roleObj.servSpecName==undefined){
								roleObj.servSpecName = roleObj.objName;
							}
						}
					}
				}
				if(app.appList.length>0){
					var $li = $('<li id="li_'+prodId+'_'+offerRole.offerRoleId+'"></li>');
					var $div=$('<div class="block"></div>');
					$div.append(offerRole.offerRoleName);
					$div.append('<span></span>');
					var $span=$('<span></span>');
					$span.append('<a href="javascript:void(0);" class="abtn03 icon-nodel">&nbsp;</a>');	
					$span.append('<a id="can_'+prodId+'_'+offerRole.offerRoleId+'" class="abtn01" onclick="AttachOffer.showApp('+prodId+');">构</a>');
					$div.append($span);
					$li.append($div);
					$("#open_app_ul_"+prodId).append($li);
					$("#open_app_ul_"+prodId).listview();
				}
			}else{ 
				if(offerRole.prodInsts==undefined){
					continue;
				}
				$.each(offerRole.prodInsts,function(){  //遍历产品实例列表
					if(this.prodInstId==prodId){
						for (var k = 0; k < offerRole.roleObjs.length; k++) {
							var roleObj = offerRole.roleObjs[k];
							if(roleObj.objType==CONST.OBJ_TYPE.SERV){
								var servSpecId = roleObj.objId;
								var $oldspan1 = $('#li_span1_'+prodId+'_'+servSpecId);
								var $oldspan2 = $('#li_span2_'+prodId+'_'+servSpecId);
								var spec = CacheData.getServSpec(prodId,servSpecId);//从已选择功能产品中找
								if(spec != undefined){
									if(roleObj.minQty==1){
										$oldspan2.append('<a href="javascript:void(0);" class="abtn03 icon-nodel">&nbsp;</a>');
									}
									$oldspan1.append('<a id="jue_'+prodId+'_'+servSpecId+'" class="ui-link" title="'+offerRole.offerRoleName+'" href="javascript:void(0);">角</a>');
									continue;
								}
								var serv = CacheData.getServBySpecId(prodId,servSpecId);//从已订购功能产品中找
								if(serv!=undefined){ //不在已经开跟已经选里面
									var $oldspan1 = $('#li_span1_'+prodId+'_'+serv.servId);
									var $oldspan2 = $('#li_span2_'+prodId+'_'+serv.servId);
									if(roleObj.minQty==1){
										$oldspan2.append('<a href="javascript:void(0);" class="abtn03 icon-nodel">&nbsp;</a>');
									}
									$oldspan1.append('<a id="jue_'+prodId+'_'+serv.servId+'" class="ui-link" title="'+offerRole.offerRoleName+'" href="javascript:void(0);">角</a>');
									continue;
								}
								if(roleObj.dfQty > 0){ //必选，或者默选
									CacheData.setServSpec(prodId,roleObj); //添加到已开通列表里
									spec = roleObj;
									if(ec.util.isArray(spec.prodSpecParams)){
										spec.ifParams = "Y";
									}
									$('#li_'+prodId+'_'+servSpecId).remove(); //删除可开通功能产品里面
									var $li = $('<li id="li_'+prodId+'_'+servSpecId+'"></li>');
									var $div=$('<div class="block"></div>');
									$div.append(spec.servSpecName);
									var $span1=$('<span></span>');
									$span1.append('<a id="jue_'+prodId+'_'+servSpecId+'" class="ui-link" title="'+offerRole.offerRoleName+'" href="javascript:void(0);">角</a>');
									$div.append($span1);
									var $span=$('<span></span>');
									if (spec.ifParams=="Y"){
										if(CacheData.setServParam(prodId,spec)){ 
											$span.append('<a id="can_'+prodId+'_'+servSpecId+'" class="abtn01" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');">参</dd>');
										}else {
											$span.append('<a id="can_'+prodId+'_'+servSpecId+'" class="abtn01" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');">参</dd>');
										}
									}
									if(roleObj.minQty==0){
										$span.append('<a class="abtn02 icon-del" onclick="AttachOffer.closeServSpec('+prodId+','+servSpecId+',\''+spec.servSpecName+'\',\''+spec.ifParams+'\')">&nbsp;</a>');
									}else{
										$span.append('<a href="javascript:void(0);" class="abtn03 icon-nodel">&nbsp;</a>');
									}
									$div.append($span);
									$li.append($div);
									$("#open_serv_ul_"+prodId).append($li);
									$("#open_serv_ul_"+prodId).listview();
									spec.isdel = "N";
									//_showHideUim(0,prodId,servSpecId);//显示或者隐藏补换卡
								}
							}
						}
					}
				});
			}
		}
	};
	
	//查询附属销售品规格
	var _searchAttachOfferSpec = function(prodId,offerSpecId,prodSpecId) {
		var param = {   
			prodId : prodId,
		    prodSpecId : prodSpecId,
		    offerSpecIds : [offerSpecId],
		    ifCommonUse : "" 
		};
		
		var offerSepcName = $("#search_text_"+prodId).val();
		
		if(offerSepcName.replace(/\ /g,"")==""){
			alert("请输入查询条件");
		}else{
			param.offerSpecName = offerSepcName;
			var data = query.offer.searchAttachOfferSpec(param);
			if(data!=undefined){
				//<ul id="ul_-1_100" class="optionallist noorder ui-listview" style="height:413px" data-inset="false" data-role="listview">
				//_changeLabel1x(prodId,prodId,"search");
				
				$("#attachSearch_div_"+prodId+" ul").each(function(){
					$(this).hide();
				});
				
				$("#attachSearch_div_"+prodId).append(data);
				
				//$.jqmRefresh($("#attachSearch_div_"+prodId));
			}
		}
	};
	
	var _dbClickAttachType = function(prodId) {
		$("#attachType_"+prodId).dblclick();
	}
	
	//点击搜索出来的附属销售品
	var _selectAttachOffer = function(prodId,offerSpecId){
		$("#attach_div_"+prodId).hide();
		_addAttOffer(prodId,offerSpecId);
	};
	
	//点击搜索出来的功能产品
	var _selectServ = function(prodId,servSpecId,specName,ifParams){
		$("#attach_div_"+prodId).hide();
		_openServSpec(prodId,servSpecId,specName,ifParams);
	};
	
	//点击搜索出来的附属销售品
	var _closeAttachSearch = function(prodId){
		$("#attach_div_"+prodId).hide();
	};
	
	//删除附属销售品规格
	var _delOfferSpec = function(prodId,offerSpecId){
		var $div = $("#li_span_"+prodId+"_"+offerSpecId).parent(); //定位删除的附属
		if($div.attr("class")=="block deldiv"){ //已经取消订购，再订购
			AttachOffer.addOfferSpec(prodId,offerSpecId);
		}else { //取消订购
			var spec = CacheData.getOfferSpec(prodId,offerSpecId);
			var content = CacheData.getOfferProdStr(prodId,spec,2);
			$.confirm("信息确认",content,{ 
				yes:function(){
					$div.addClass("deldiv");
					spec.isdel = "Y";
					delServSpec(prodId,spec); //取消订购销售品时
					order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
					//同时应该隐藏整个终端输入
					$("#terminalDiv_"+prodId).hide();
					$("#terminalUl_"+prodId+"_"+offerSpecId).remove();
					spec.isTerminal = 0;
				},
				no:function(){
					
				}
			});
		}
	};
	
	//二次业务加载--删除附属销售品规格
	var _delOfferSpecReload = function(prodId,offerSpecId){
		var $div = $("#li_span_"+prodId+"_"+offerSpecId).parent(); //定位删除的附属
		if($div.attr("class")=="block deldiv"){ //已经取消订购，再订购
			AttachOffer.addOfferSpec(prodId,offerSpecId);
		}else { //取消订购
			var spec = CacheData.getOfferSpec(prodId,offerSpecId);
			var content = CacheData.getOfferProdStr(prodId,spec,2);
			$div.addClass("deldiv");
			spec.isdel = "Y";
			delServSpec(prodId,spec); //取消订购销售品时
			order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
			//同时应该隐藏整个终端输入
			$("#terminalDiv_"+prodId).hide();
			$("#terminalUl_"+prodId+"_"+offerSpecId).remove();
			spec.isTerminal = 0;
		}
	};
	var _lastStep = function() {
		$.confirm("信息","确定要取消吗？",{
			yes:function(){
				var boProd2Tds = OrderInfo.boProd2Tds;
				//取消订单时，释放被预占的UIM卡
				if(boProd2Tds.length>0){
					for(var n=0;n<boProd2Tds.length;n++){
						var param = {
								numType : 2,
								numValue : boProd2Tds[n].terminalCode
						};
						$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param, {
							"done" : function(){}
						});
					}
				}
				
				
				/*$("#orderedprod").hide();
				$("#order_prepare").hide();
				$("#order_fill_content").hide();
				$("#ul_busi_area").hide();
				$("#order_fill_content").html(data).show();
				k++;
				$.jqmRefresh($("#order_fill_content"));*/
				
				
				/*$("#order_fill").empty();
				$("#order_prepare").show();
				$("#order_fill_content").empty();
				order.prepare.showOrderTitle();*/
				$("#order_tab_panel_content").hide();
				order.prepare.step(1);
			},no:function(){
				
			}},"question");
	};
	
	//删除附属销售品实例
	var _delOffer = function(prodId,offerId){
		var $div = $("#li_span_"+prodId+"_"+offerId).parent(); //定位删除的附属
		if($div.attr("class")=="block deldiv"){  //已经退订，再订购		
			AttachOffer.addOffer(prodId,offerId,$div.text());
		}else { //退订
			var offer = CacheData.getOffer(prodId,offerId);
			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offerId	
				};
				param.acctNbr = OrderInfo.getAccessNumber(prodId);
				var data = query.offer.queryOfferInst(param);
				if(data==undefined){
					return;
				}
				offer.offerMemberInfos = data.offerMemberInfos;
				offer.offerSpec = data.offerSpec;
			}
			var content = "";
			if(offer.offerSpec!=undefined){
				content = CacheData.getOfferProdStr(prodId,offer,1);
			}else {
				content = '退订【'+$div.text()+'】可选包' ;
			}
			$.confirm("信息确认",content,{ 
				yes:function(){
					offer.isdel = "Y";
					$div.addClass("deldiv");
					delServByOffer(prodId,offer);
				},
				no:function(){	
				}
			});
		}
	};
	
	//关闭服务规格
	var _closeServSpec = function(prodId,servSpecId,specName,ifParams){
		var $div = $("#li_span_"+prodId+"_"+servSpecId).parent(); //定位删除的附属
		if($div.attr("class")=="block deldiv"){  //已经退订，再订购
			AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams);
		}else { //退订
			$.confirm("信息确认","取消开通【"+specName+"】功能产品",{ 
				yesdo:function(){
					var spec = CacheData.getServSpec(prodId,servSpecId);
					if(spec == undefined){ //没有在已开通附属销售列表中
						return;
					}
					$div.addClass("deldiv");
					spec.isdel = "Y";
					_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					
					var serv = CacheData.getServBySpecId(prodId,servSpecId);
					if(ec.util.isObj(serv)){ //没有在已开通附属销售列表中
						$div.addClass("deldiv");
						serv.isdel = "Y";
					}
				},
				no:function(){
				}
			});
		}
	};
	
	//二次加载业务--关闭服务规格
	var _closeServSpecReload = function(prodId,servSpecId,specName,ifParams){
		var $div = $("#li_span_"+prodId+"_"+servSpecId).parent(); //定位删除的附属
		if($div.attr("class")=="block deldiv"){  //已经退订，再订购
			AttachOffer.openServSpec(prodId,servSpecId,specName,ifParams);
		}else { //退订
			var spec = CacheData.getServSpec(prodId,servSpecId);
			if(spec == undefined){ //没有在已开通附属销售列表中
				return;
			}
			$div.addClass("deldiv");
			spec.isdel = "Y";
			_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
			
			var serv = CacheData.getServBySpecId(prodId,servSpecId);
			if(ec.util.isObj(serv)){ //没有在已开通附属销售列表中
				$div.addClass("deldiv");
				serv.isdel = "Y";
			}
		}
	};
	
	//关闭服务实例
	var _closeServ = function(prodId,servId){
		var serv = CacheData.getServ(prodId,servId);
		var $div = $("#li_span_"+prodId+"_"+servId).parent(); //定位删除的附属
		if($div.attr("class")=="block deldiv"){  //已经退订，再订购
			_openServ(prodId,serv);
		}else { //关闭
			$.confirm("信息确认","关闭【"+$div.text()+"】功能产品",{ 
				yesdo:function(){
					$div.addClass("deldiv");
					serv.isdel = "Y";
				},
				no:function(){						
				}
			});
		}
	};
	
	//开通功能产品
	var _openServSpec = function(prodId,servSpecId,specName,ifParams){
		$.confirm("信息确认","开通【"+specName+"】功能产品",{ 
			yesdo:function(){
				var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
				if(servSpec==undefined){   //在可订购功能产品里面 
					var newSpec = {
						objId : servSpecId, //调用公用方法使用
						servSpecId : servSpecId,
						servSpecName : specName,
						ifParams : ifParams,
						isdel : "C"   //加入到缓存列表没有做页面操作为C
					};
					var inPamam = {
						prodSpecId:servSpecId
					};
					if(ifParams == "Y"){
						var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
						if(data==undefined || data.result==undefined){
							return;
						}
						newSpec.prodSpecParams = data.result.prodSpecParams;
					}
					CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
					servSpec = newSpec;
				}
				_checkServExcludeDepend(prodId,servSpec);
			},
			no:function(){
			}
		});
	};
	
	//开通功能产品
	var _openServSpecReload = function(prodId,servSpecId,specName,ifParams){
		var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
		if(servSpec==undefined){   //在可订购功能产品里面 
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : specName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			servSpec = newSpec;
		}
		_checkServExcludeDepend(prodId,servSpec);
	};
	
	//开通功能产品
	var _openServ = function(prodId,serv){
		$.confirm("信息确认","取消关闭【"+serv.servSpecName+"】功能产品",{ 
			yesdo:function(){
				if(serv!=undefined){   //在可订购功能产品里面 
					if(serv.servSpecId==""){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.removeClass("del");
						serv.isdel = "N";
					}else{
						_checkServExcludeDepend(prodId,serv);
					}
				}
			},
			no:function(){
			}
		});
	};
	
	//校验销售品的互斥依赖
	var _checkOfferExcludeDepend = function(prodId,offerSpec){
		var offerSpecId = offerSpec.offerSpecId;
		var param = CacheData.getExcDepOfferParam(prodId,offerSpecId);
//		if(param.orderedOfferSpecIds.length == 0 ){
////			AttachOffer.addOpenList(prodId,offerSpecId); 
//			paserOfferData("",prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
//		}else{
		var data = query.offer.queryExcludeDepend(param);//查询规则校验
		if(data!=undefined){
			paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
		}
//		}
		
		//获取销售品节点校验销售品下功能产品的互斥依赖
		/*var offerSpec = CacheData.getOfferSpec(offerSpecId);
		if(offerSpec!=undefined){
			$.each(offerSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					var param = {
						prodId : prodId,
						servSpecId : this.objId,
						orderedServSpecIds : [] //功能产品互斥依赖查询入场数组
					};
					//已选销售品列表
					var offerSpecList = CacheData.getSpecList(prodId);
					if(ec.util.isArray(offerSpecList)){
						$.each(offerSpecList,function(){
							if(this.offerSpecId!=offerSpecId && this.isdel!="Y" && this.isdel!="C"){
								param.orderedOfferSpecIds.push(this.offerSpecId);
							}
						});
					}
					if(param.orderedServSpecIds.length == 0 ){
						AttachOffer.addOpenList(prodId,offerSpecId); 
					}else{
						datas.push(query.offer.queryServExcludeDepend(param));//查询规则校验
					}
				});
			});
		}*/
		//paserData(datas,prodId,offerSpecId,offer.offerSpecName,"OFFER"); //解析数据
		
		/*if(param.orderedOfferSpecIds.length == 0 ){
			AttachOffer.addOpenList(prodId,offerSpecId); 
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserData(data.result,prodId,offerSpecId,offer.offerSpecName,"OFFER"); //解析数据
			}
		}*/
	};
	
	//校验服务的互斥依赖
	var _checkServExcludeDepend = function(prodId,serv,flag){
		var servSpecId = serv.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		if(param.orderedServSpecIds.length == 0){
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserServData(data.result,prodId,serv);//解析数据
			}
		}
	};
	
	var _addSearchOfferSpec=function(prodId,offerSpecId){
		$("#attachType_"+prodId).dblclick();
		
		AttachOffer.addOfferSpec(prodId,offerSpecId);
	}
	
	//订购附属销售品
	var _addOfferSpec = function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		if(OrderInfo.provinceInfo.reloadFlag&&OrderInfo.provinceInfo.reloadFlag=="N"){
			CacheData.setServ2OfferSpec(prodId,newSpec);
			_checkOfferExcludeDepend(prodId,newSpec);
		}else{
			$.confirm("信息确认",content,{
				yes:function(){
					CacheData.setServ2OfferSpec(prodId,newSpec);
				},
				yesdo:function(){
					_checkOfferExcludeDepend(prodId,newSpec);
				},
				no:function(){
				}
			});
		}
	};
	
	//根据预校验返回订购附属销售品
	var _addOfferSpecByCheck = function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		$.confirm("信息确认",content,{ 
			yes:function(){
				CacheData.setServ2OfferSpec(prodId,newSpec);
			},
			yesdo:function(){
				_checkOfferExcludeDepend(prodId,newSpec);
			}
		});
	};
	
	//删除附属销售品带出删除功能产品
	var delServSpec = function(prodId,offerSpec){
		$.each(offerSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				var servSpecId = this.objId;
				if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){
					var spec = CacheData.getServSpec(prodId,servSpecId);
					if(ec.util.isObj(spec)){
						spec.isdel = "Y";
						var $li = $("#li_"+prodId+"_"+servSpecId);
						$li.removeClass("canshu").addClass("canshu2");
						$li.find("span").addClass("del"); //定位删除的附属
						_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					}
				}
			});
		});
	};
	
	//删除附属销售品带出删除功能产品
	var delServByOffer = function(prodId,offer){	
		$.each(offer.offerMemberInfos,function(){
			var servId = this.objInstId;
			if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){
				var serv = CacheData.getServ(prodId,servId);
				if(ec.util.isObj(serv)){
					serv.isdel = "Y";
					var $li = $("#li_"+prodId+"_"+servId);
					$li.removeClass("canshu").addClass("canshu2");
					$li.find("span").addClass("del"); //定位删除的附属
				}
			}
		});
	};
	
	//取消退订附属销售品
	var _addOffer = function(prodId,offerId,specName){
		//var specName = $("#li_"+prodId+"_"+offerId).find("span").text();
		$.confirm("信息确认","取消退订【"+specName+"】可选包",{ 
			yesdo:function(){
				var offer = CacheData.getOffer(prodId,offerId); //在已经开通列表中查找
				if(offer!=undefined){   //在可订购功能产品里面 
					if(offer.offerSpecId==""){
						$("#li_"+prodId+"_"+offerSpecId).find("div").removeClass("deldiv");
						offer.isdel = "N";
					}else{
						_checkOfferExcludeDepend(prodId,offer);
					}
				}
			},
			no:function(){
			}
		});
	};
	
	//确认订购附属销售品
	var _addAttOffer = function(prodId,offerSpecId,specName){
		_addOfferSpec(prodId,offerSpecId);
	};
	
	//解析互斥依赖返回结果
	var paserOfferData = function(result,prodId,offerSpecId,specName){
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
				excludeOffer : [],   //互斥依赖显示列表
				dependOffer : {  //存放互斥依赖列表
					dependOffers : [],
					offerGrpInfos : []
				}
		};
		if(result!=""){
			var exclude = result.offerSpec.exclude;
			var depend = result.offerSpec.depend;
			
			//解析可选包互斥依赖组
			if(ec.util.isArray(exclude)){
				for (var i = 0; i < exclude.length; i++) {
					var offerList = CacheData.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
						param.excludeOffer.push(exclude[i].offerSpecId);
					}
				}
			}
			if(depend!=undefined && ec.util.isArray(depend.offerInfos)){
				for (var i = 0; i < depend.offerInfos.length; i++) {	
					content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
				}	
			}
			if(depend!=undefined && ec.util.isArray(depend.offerGrpInfos)){
				for (var i = 0; i < depend.offerGrpInfos.length; i++) {
					var offerGrpInfo = depend.offerGrpInfos[i];
					param.dependOffer.offerGrpInfos.push(offerGrpInfo);
					content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
					if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
						for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
							var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
							content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
						}
					}
				}
			}
		}
		var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);//查询销售品构成成员的依赖互斥以及连带
		content=content+serContent;
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenList(prodId,offerSpecId); 
		}else{	
			content = "<div style='max-height:300px;overflow:auto;'>" + content + "</div>";
			$.confirm("订购： " + specName,content,{ 
				yes:function(){
					CacheData.setOffer2ExcludeOfferSpec(param);
				},
				yesdo:function(){
					excludeAddattch(prodId,offerSpecId,param);
					excludeAddServ(prodId,"",paramObj);
				},
				no:function(){
					
				}
			});
		}
	};
	
	/*//解析互斥依赖返回结果
	var paserData = function(datas,prodId,offerSpecId,specName,objType){
		var exclude = result.offerSpec.exclude;
		var depend = result.offerSpec.depend;
		var servExclude = result.servSpec.exclude;
		var servDepend = result.servSpec.depend;

		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeOffer : [],   //互斥依赖显示列表
			dependOffer : {  //存放互斥依赖列表
				dependOffers : [],
				offerGrpInfos : []
			},
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [] //存放互斥依赖列表
		};
		
		//解析可选包互斥依赖组
		if(exclude!=undefined && exclude.length>0){
			for (var i = 0; i < exclude.length; i++) {
				var offerList = AttachOffer.getOfferList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(offerList!=undefined){
					for ( var j = 0; j < offerList.length; j++) {
						if(offerList[j].isdel=="Y"){
							if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
					param.excludeOffer.push(exclude[i].offerSpecId);
				}
			}
		}
		if(depend!=undefined && depend.offerInfos!=undefined && depend.offerInfos.length>0){
			for (var i = 0; i < depend.offerInfos.length; i++) {	
				content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
				param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
			}	
		}
		if(depend!=undefined && depend.offerGrpInfos!=undefined && depend.offerGrpInfos.length>0){
			for (var i = 0; i < depend.offerGrpInfos.length; i++) {
				var offerGrpInfo = depend.offerGrpInfos[i];
				param.dependOffer.offerGrpInfos.push(offerGrpInfo);
				content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
				if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
					for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
						var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
						content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
					}
				}
			}
		}
		
		//解析功能产品互斥依赖组
		if(servExclude!=undefined && servExclude.length>0){
			$.each(servExclude,function(){
				if(this.offerSpecId == undefined || this.offerSpecId == ""){ //纯功能产品互斥
					var servList = AttachOffer.getServList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(servList!=undefined){
						for ( var i = 0; i < servList.length; i++) {
							if(servList[i].isdel=="Y"){
								if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + this.servSpecName + "<br>";
						param.excludeServ.push(this);
					}
				}else {  //可选包下功能产品互斥
					var offerList = AttachOffer.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == this.offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + this.offerSpecName + "<br>";
						param.excludeOffer.push(this.offerSpecId);
					}
				}
			});
		}
		if(servDepend!=undefined && servDepend.length>0){
			$.each(servDepend,function(){
				if(this.offerSpecId == undefined || this.offerSpecId == ""){ //纯功能产品依赖
					content += "需要开通：   " + this.servSpecName + "<br>";
					param.dependServ.push(this);
				}else {  //功能产品与可选包下功能产品依赖
					content += "需要开通：   " + this.offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(this.offerSpecId);
				}
			});
		}
		
		if(content==""){ //没有互斥依赖
			if(objType == "OFFER"){
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}else {
				AttachOffer.addOpenServList(prodId,offerSpecId); 
			}
		}else{	
			$.confirm("开通： " + specName,content,{ 
				yesdo:function(){
					excludeAddattch(prodId,offerSpecId,param,objType);
				},
				no:function(){
					
				}
			});
		}
	};*/
	
	//解析服务互斥依赖
	var paserServData = function(result,prodId,serv){
		var servSpecId = serv.servSpecId;
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
		};
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + this.servSpecName + "<br>";
					param.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.dependServ.push(this);
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.relatedServ.push(this);
			});
		}
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			//新装二次加载，互斥的销售品处理
			if(OrderInfo.provinceInfo.reloadFlag!=""&&OrderInfo.provinceInfo.reloadFlag=="N"){
				AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
				excludeAddServ(prodId,servSpecId,param);
			}else{
				$.confirm("开通： " + serv.servSpecName,content,{ 
					yesdo:function(){
						AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
						excludeAddServ(prodId,servSpecId,param);
					},
					no:function(){
					}
				});
			}
		}
	};
	
	//服务互斥依赖时带出添加跟删除
	var excludeAddServ = function(prodId,servSpecId,param){
		if(ec.util.isArray(param.excludeServ)){ //有互斥
			for (var i = 0; i < param.excludeServ.length; i++) { //删除已开通
				var excludeServSpecId = param.excludeServ[i].servSpecId;
				var spec = CacheData.getServSpec(prodId,excludeServSpecId);
				if(spec!=undefined){
					var $span = $("#li_"+prodId+"_"+excludeServSpecId).find("span");
					$span.addClass("del");
					spec.isdel = "Y";
				}else{
					var serv = CacheData.getServBySpecId(prodId,excludeServSpecId);
					if(serv!=undefined){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.addClass("del");
						serv.isdel = "Y";
					}
				}
			}
		}
		if(ec.util.isArray(param.dependServ)){ // 依赖
			for (var i = 0; i < param.dependServ.length; i++) {
				var servSpec = param.dependServ[i];
				AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams); 
			}
		}
		if(ec.util.isArray(param.relatedServ)){ // 连带
			for (var i = 0; i < param.relatedServ.length; i++) {
				var servSpec = param.relatedServ[i];
				AttachOffer.addOpenServList(prodId,servSpec.servSpecId,servSpec.servSpecName,servSpec.ifParams); 
			}
		}
	};
	
	//互斥依赖时添加
	var excludeAddattch = function(prodId,specId,param){
		if(param.dependOffer.offerGrpInfos.length>0){  // 依赖组
			var dependOffer=param.dependOffer;
			for (var i = 0; i < dependOffer.offerGrpInfos.length; i++) {
				var offerGrpInfo = dependOffer.offerGrpInfos[i];
				var len  = offerGrpInfo.checkLen;
				if(len>=offerGrpInfo.minQty&&len<=offerGrpInfo.maxQty){
					$.each(offerGrpInfo.subOfferSpecInfos,function(){
						if(this.isCheck){
							AttachOffer.addOpenList(prodId,this.offerSpecId); 
						}
					});
				}else if(len<offerGrpInfo.minQty){
					$.alert("提示信息","依赖组至少选中"+offerGrpInfo.minQty+"个！");
					return;
				}else if(len>offerGrpInfo.maxQty){
					$.alert("提示信息","依赖组至多选中"+offerGrpInfo.maxQty+"个！");
					return;
				}else {
					$.alert("错误信息","依赖组选择出错！");
					return;
				}
			}
		}
		
		AttachOffer.addOpenList(prodId,specId); //添加开通附属
		if(param.excludeOffer.length>0){ //有互斥
			//删除已开通
			for (var i = 0; i < param.excludeOffer.length; i++) {
				var excludeSpecId = param.excludeOffer[i];
				var spec = CacheData.getOfferSpec(prodId,excludeSpecId);
				if(spec!=undefined){
					var $div = $("#li_span_"+prodId+"_"+excludeSpecId).parent(); //定位删除的附属
					
					$div.addClass("deldiv");
					
					var $span = $("#li_"+prodId+"_"+excludeSpecId).find("span");
					
					$span.addClass("del");
					
					spec.isdel = "Y";
					
					$("#terminalUl_"+prodId+"_"+excludeSpecId).remove();
					
					$("li[name=tr_"+prodId+"_"+excludeSpecId+"]").remove();
				}
				var offer = CacheData.getOfferBySpecId(prodId,excludeSpecId);
				if(offer!=undefined){
					var $div = $("#li_span_"+prodId+"_"+excludeSpecId).parent(); //定位删除的附属
					
					$div.addClass("deldiv");
					
					var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
					
					$span.addClass("del");
					
					offer.isdel = "Y";
				}
			}
		}
		if(param.dependOffer.dependOffers.length>0){ // 依赖
			for (var i = 0; i < param.dependOffer.dependOffers.length; i++) {
				var offerSpecId = param.dependOffer.dependOffers[i];
				AttachOffer.addOpenList(prodId,offerSpecId); 
			}
		}
		/*if(objType == "OFFER"){
			AttachOffer.addOpenList(prodId,specId); //添加开通附属
			if(param.excludeOffer.length>0){ //有互斥
				//删除已开通
				for (var i = 0; i < param.excludeOffer.length; i++) {
					var excludeSpecId = param.excludeOffer[i];
					var spec = AttachOffer.getSpec(prodId,excludeSpecId);
					if(spec!=undefined){
						var $span = $("#li_"+prodId+"_"+excludeSpecId).find("span");
						$span.addClass("del");
						spec.isdel = "Y";
					}
					var offer = AttachOffer.getOfferBySpecId(prodId,excludeSpecId);
					if(offer!=undefined){
						var $span = $("#li_"+prodId+"_"+offer.offerId).find("span");
						$span.addClass("del");
						offer.isdel = "Y";
					}
				}
			}
			if(param.dependOffer.dependOffers.length>0){ // 依赖
				for (var i = 0; i < param.dependOffer.dependOffers.length; i++) {
					var offerSpecId = param.dependOffer.dependOffers[i];
					AttachOffer.addOpenList(prodId,offerSpecId); 
				}
			}
		}else{
			AttachOffer.addOpenServList(prodId,specId); //添加开通功能
			if(param.excludeServ!=undefined && param.excludeServ.length>0){ //有互斥
				//删除已开通
				for (var i = 0; i < param.excludeServ.length; i++) {
					var excludeServSpecId = param.excludeServ[i].servSpecId;
					var spec = CacheData.getServSpec(prodId,excludeServSpecId);
					if(spec!=undefined){
						var $span = $("#li_"+prodId+"_"+excludeServSpecId).find("span");
						$span.addClass("del");
						spec.isdel = "Y";
					}
					var serv = AttachOffer.getServ(prodId,excludeServSpecId);
					if(serv!=undefined){
						var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
						$span.addClass("del");
						serv.isdel = "Y";
					}
				}
			}
			if(param.dependServ!=undefined&&param.dependServ.length>0){ // 依赖
				for (var i = 0; i < param.dependServ.length; i++) {
					var servSpecId = param.dependServ[i].servSpecId;	
					var newSpec = {
						objId : servSpecId, //调用公用方法使用
						servSpecId : servSpecId,
						servSpecName : param.dependServ[i].servSpecName,
						ifParams : param.dependServ[i].ifParams,
						isdel : "C"   //加入到缓存列表没有做页面操作为C
					};
					var inPamam = {
						prodSpecId:servSpecId
					};
					if("Y"  == newSpec.ifParams){
						var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
						if(data==undefined || data.result==undefined){
							return;
						}
						newSpec.prodSpecParams = data.result.prodSpecParams;
					}
					CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
					AttachOffer.addOpenServList(prodId,servSpecId); 
				}
			}
		}*/
	};
	
	//添加到开通列表
	var _addOpenList = function(prodId,offerSpecId){
		var offer = CacheData.getOfferBySpecId(prodId,offerSpecId); //从已订购数据中找
		if(offer != undefined){ //在已开通中，需要取消退订
			$("#li_"+prodId+"_"+offer.offerId).find("div").removeClass("deldiv");
			offer.isdel = "N";
			return;
		}
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		if(newSpec.isdel=="C"){ //没有在已开通附属销售列表中，但是已经加载到缓存
			var $spec = $('#li_'+prodId+'_'+offerSpecId); //在已开通附属里面
			$spec.remove();
			var $li = $('<li id="li_'+prodId+'_'+offerSpecId+'" class="ui-li-static ui-body-inherit ui-last-child"></li>');
			var $div = $('<div class="block"></div>');
			$div.append(newSpec.offerSpecName+'<span></span>');
			var $span = $('<span id="li_span_'+prodId+'_'+offerSpecId+'"></span>');
			if(newSpec.ifParams){
				if(CacheData.setParam(prodId,newSpec)){ 
					$span.append('<a href="javascript:void(0);" id="can_'+prodId+'_'+offerSpecId+'" isset="N" class="abtn01" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');">参</a>');
				}else {
					$span.append('<a href="javascript:void(0);" id="can_'+prodId+'_'+offerSpecId+'" isset="Y" class="abtn03" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');">参</a>');
				}
			}
			if(newSpec.ifShowTime=="Y"){
				$li.append('<a href="javascript:void(0);" class="abtn01" id="time_'+prodId+'_'+offerSpecId+'" isset="N" onclick="AttachOffer.showTime('+prodId+','+offerSpecId+',\''+newSpec.offerSpecName+'\');">时</a>');
			}
			if(newSpec.ifDault==0){ //必须
				$span.append('<a href="javascript:void(0);" class="abtn03 icon-nodel ui-link">&nbsp;</a>');	
			}else {
				$span.append('<a href="javascript:void(0);" class="abtn02 icon-del" onclick="AttachOffer.delOfferSpec('+prodId+','+offerSpecId+');">&nbsp;</a>');	
			}
			$div.append($span).appendTo($li);
			/*<li id="li_-1_81043" offerspecid="81043" isdel="N" class="ui-li-static ui-body-inherit ui-last-child">
	   			<div class="block">
	  				 <span id="li_span1_-1_81043">爱看4G定向流量包201407 0元-可选包</span>
	  				 <span id="li_span2_-1_81043">
	  				 <a href="javascript:void(0);" class="abtn01 ui-link" id="can_-1_81043" isset="N" onclick="AttachOffer.showParam(-1,81043,0);">参</a>
	  				 <a href="javascript:void(0);" class="abtn03 icon-nodel ui-link">&nbsp;</a>
	  				 </span>
	   			</div>
	 		</li>*/
 		
 		
			/*var $li = $('<li id="li_'+prodId+'_'+offerSpecId+'"></li>');
			if(newSpec.ifDault==0){ //必须
				$li.append('<dd class="mustchoose"></dd>');	
			}else {
				$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+','+offerSpecId+')"></dd>');	
			}
			$li.append('<span>'+newSpec.offerSpecName+'</span>');
			if(newSpec.ifParams){
				if(CacheData.setParam(prodId,newSpec)){ 
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}else {
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}
			}
			if(newSpec.ifShowTime=="Y"){
				$li.append('<dd class="time" id="time_'+prodId+'_'+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+','+offerSpecId+',\''+newSpec.offerSpecName+'\');"></dd>');
			}*/
			$("#open_ul_"+prodId).append($li);
			newSpec.isdel = "N";
		}else if((newSpec.isdel=="Y")) { 
			$("#li_"+prodId+"_"+offerSpecId).find("div").removeClass("deldiv");
			newSpec.isdel = "N";
		}else {  //容错处理 //if((newSpec.isdel=="N")) 
			var $spec = $('#li_'+prodId+'_'+offerSpecId); //在已开通附属里面
			$spec.remove();
			var $li = $('<li id="li_'+prodId+'_'+offerSpecId+'"></li>');
			if(newSpec.ifDault==0){ //必须
				$li.append('<dd class="mustchoose"></dd>');	
			}else {
				$li.append('<dd class="delete" onclick="AttachOffer.delOfferSpec('+prodId+','+offerSpecId+')"></dd>');	
			}
			$li.append('<span>'+newSpec.offerSpecName+'</span>');
			if (newSpec.ifParams){
				if(CacheData.setParam(prodId,newSpec)){ 
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu2" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}else {
					$li.append('<dd id="can_'+prodId+'_'+offerSpecId+'" class="canshu" onclick="AttachOffer.showParam('+prodId+','+offerSpecId+');"></dd>');
				}
			}
			if(newSpec.ifShowTime=="Y"){
				$li.append('<dd class="time" id="time_'+prodId+'_'+offerSpecId+'" onclick="AttachOffer.showTime('+prodId+','+offerSpecId+',\''+newSpec.offerSpecName+'\');"></dd>');
			}
			$("#open_ul_"+prodId).append($li);
		}
		
		//获取销售品节点校验销售品下功能产品的互斥依赖
		if(newSpec!=undefined){
			$.each(newSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					if(this.objType==4 && this.selQty!=2){
						var ifParams = "N";
						if(ec.util.isArray(this.prodSpecParams)){
							ifParams = "Y";
						}
						_addOpenServList(prodId,this.objId,this.objName,ifParams);
						if(this.minQty>0){
							_minQtyFileter(prodId,this.objId);
						}
					}
				});
			});
		}
		if(ec.util.isArray(newSpec.agreementInfos)){ //合约销售品需要输入终端
			/*var $sel = $("#terminalSel_"+prodId);
			$sel.empty();
			$.each(newSpec.agreementInfos,function(){
				var $option = $('<option value="'+this.terminalModels+'">'+this.terminalName+'</option>');
				$sel.append($option);
			});
			$("#terminalDiv_"+prodId).show();
			AttachOffer.isTerminal = 1;*/
			//if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==6 || OrderInfo.actionFlag==14){				
				var objInstId = prodId+'_'+newSpec.offerSpecId;
				//$("#terminalDi1").show();
				//$("#terminalDi2").show();
				$("#terminalDiv").append('<input id="terminalText_'+objInstId+'" type="text" class="inputWidth228px inputMargin0" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />');
				
				//一个终端对应一个ul
				var $ul = $('<ul id="terminalUl_'+objInstId+'" class="fillin show" style="margin-left:0px;padding-left:0px;"></ul>');
				var $sel = $('<select id="terminalSel_'+objInstId+'"></select>');  
				var $li1 = $('<li class="full"><label style=""><span style="color:#71AB5A;font-size:16px">'+newSpec.offerSpecName+'</span></label></li>');
				var $li2 = $('<li style="display:none;"><label> 可选终端规格：</label></li>'); //隐藏
				
				$.each(newSpec.agreementInfos,function(){
					var $option = $('<option value="'+this.terminalModels+'" price="'+this.agreementPrice+'">'+this.terminalName+'</option>');
					$sel.append($option);
				});
				$li2.append($sel).append('<label class="f_red">*</label>');
				var $li3="";
				if(OrderInfo.actionFlag==2){
					 $li3 = $(
							'<label>终端校验：</label>'+
							'<input id="terminalText_'+objInstId+'" type="text" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" style="width:210px;height:30px; display: inline-block; margin-right: 20px;" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />'+
							'<label><input type="checkbox" id="if_p_reserveCode" onclick="AttachOffer.changereserveCode()">使用预约码：</label>'+
							'<input id="reserveCode" type="text" disabled="disabled" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" maxlength="50" placeholder="请输入预约码" style="background-color: #E8E8E8;width:50%;height:45px;"/>'+
							'<input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+','+newSpec.offerSpecId+')" value="校验" class="ui-btn ui-shadow ui-corner-all ui-mini" style="width:50px;display: inline-block"></input>'
						);
				}
				else{
					 $li3 = $(
							'<label>终端校验：</label>'+
							'<input id="terminalText_'+objInstId+'" type="text" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" style="width:50%;height:45px;" data-validate="validate(terminalCodeCheck) on(keyup blur)" maxlength="50" placeholder="请先输入终端串号" />'+
							'<label><input type="checkbox" id="if_p_reserveCode" onclick="AttachOffer.changereserveCode()">使用预约码：</label>'+
							'<input id="reserveCode" type="text" disabled="disabled" class="ui-input-text ui-shadow-inset ui-body-inherit ui-corner-all ui-textinput-autogrow" maxlength="50" placeholder="请输入预约码" style="background-color: #E8E8E8;width:50%;height:45px;"/>'+
							'<input id="terminalBtn_'+objInstId+'" type="button" onclick="AttachOffer.checkTerminalCode('+prodId+','+newSpec.offerSpecId+')" value="校验" class="ui-btn ui-shadow ui-corner-all ui-mini" style="width:50%;"></input>'
						);	
				}
				var $div = $("#terminalDiv_"+prodId);
				 $("#terminalDiv_"+prodId).css("display","none");
				var $li4 = $('<li id="terminalDesc" style="display:none;white-space:nowrap;"><label> 终端规格：</label><label id="terminalName"></label></li>');
				$ul.append($li1).append($li2).append($li3).append($li4).appendTo($div);
				if(OrderInfo.terminalCode!=null && OrderInfo.terminalCode!="" && OrderInfo.terminalCode!="null" && OrderInfo.provinceInfo.reloadFlag=="Y"){
					var	accessNum=OrderInfo.getAccessNumber(prodId);
					if(accessNum!="" && accessNum!=null && accessNum!= undefined){
						var terminalCodeArray=OrderInfo.terminalCode.split(",");
						for(var k=0;k<terminalCodeArray.length;k++){
							if(terminalCodeArray[k].indexOf(accessNum)!=-1){
								var terminalCode=terminalCodeArray[k].split("_")[1];
								$("#terminalText_"+objInstId).val(terminalCode);
			                    break;
							}
						}
					}
				}
				$div.show();
				newSpec.isTerminal = 1;
				if(OrderInfo.actionFlag==14){
					for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
						var coupon = OrderInfo.attach2Coupons[i];
						if(prodId==coupon.prodId){
							$("#terminalSel_"+objInstId).val(coupon.couponId);
							$("#terminalSel_"+objInstId).attr("disabled",true);
							$("#terminalText_"+objInstId).val(coupon.couponInstanceNumber);
							$("#terminalText_"+objInstId).attr("disabled",true);
							$("#terminalBtn_"+objInstId).hide();
						}
					}
				}
			//}
		}
	};
	
	var _changereserveCode = function(){
		if(document.getElementById("if_p_reserveCode").checked){
			$("#reserveCode").css("background-color","white").attr("disabled", false) ;
		}else{
			$("#reserveCode").css("background-color","#E8E8E8").attr("disabled", true) ;
		}
	}
	
	//终端校验
	var _checkTerminalCode = function(prodId,offerSpecId){
		var flag="0";
		//清空旧终端信息
		for ( var i = 0; i < OrderInfo.attach2Coupons.length; i++) {
			var attach2Coupon = OrderInfo.attach2Coupons[i];
			if(offerSpecId == attach2Coupon.attachSepcId && prodId==attach2Coupon.prodId){
				OrderInfo.attach2Coupons.splice(i,1);
				break;
			}
		}
		var objInstId = prodId+"_"+offerSpecId;
//		var resId = $("#terminalSel_"+objInstId).val();
		var resIdArray = [];
		var terminalGroupIdArray = [];
		$("#terminalSel_"+objInstId + "  option").each(function(){
			resIdArray.push($(this).val());
		});
		$("#group_"+objInstId+"  option").each(function(){
			terminalGroupIdArray.push($(this).val());
		});
		var resId = resIdArray.join("|"); //拼接可用的资源id
		var terminalGroupId = terminalGroupIdArray.join("|"); //拼接可用的资源终端组id
		if((resId==undefined || $.trim(resId)=="") && (terminalGroupId==undefined || $.trim(terminalGroupId)=="")){
			$.alert("信息提示","终端规格不能为空！");
			return;
		}
		var instCode = $("#terminalText_"+objInstId).val();
		if(instCode==undefined || $.trim(instCode)==""){
			$.alert("信息提示","终端串码不能为空！");
			return;
		}
		if(document.getElementById("if_p_reserveCode").checked){
			var reserveCode = $("#reserveCode").val();
			if(reserveCode ==""){
				$.alert("信息提示","请输入终端预约码！");
				return;
			}
		}
		//验证
		if(_checkData(objInstId,instCode)){
			return;
		}
		var param = {
			instCode : instCode,
			flag : flag,
			mktResId : "",
			termGroup : ""
		};
		var data = query.prod.checkTerminal(param);
		if(data==undefined){
			return;
		}
		var activtyType ="";
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C" && ec.util.isArray(spec.agreementInfos)){  //订购的附属销售品
                    if(spec.agreementInfos[0].activtyType == 2){
                    	activtyType = "2";
				    }
				}
			}
		}
		if(data.statusCd==CONST.MKTRES_STATUS.USABLE || (data.statusCd==CONST.MKTRES_STATUS.HAVESALE && activtyType=="2")){
//			$.alert("信息提示",data.message);
			$("#terminalSel_"+objInstId).val(data.mktResId);
			var price = $("#terminalSel_"+objInstId).find("option:selected").attr("price");
			/*$("#terRes_"+objInstId).show();
			$("#terName_"+objInstId).text(data.mktResName);
			$("#terCode_"+objInstId).text(data.instCode);	
			if(price!=undefined){
				$("#terPrice_"+objInstId).text(price/100 + "元");
			}*/
			
			var mktPrice=0;//营销资源返回的单位是元
			var mktColor="";
			if(ec.util.isArray(data.mktAttrList)){
				$.each(data.mktAttrList,function(){
					if(this.attrId=="65010058"){
						mktPrice=this.attrValue;
					}else if(this.attrId=="60010004"){
						mktColor=this.attrValue;
					}
				});
			}
			$("#terminalName").html(data.mktResName+",终端颜色："+mktColor+",合约价格："+mktPrice+"元");
			$("#terminalDesc").css("display","block");
			var coupon = {
				couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : data.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
				couponNum : 1, //物品数量
				storeId : data.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : mktPrice, //物品价格
				couponInstanceNumber : data.instCode, //物品实例编码
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId : prodId, //产品ID
				offerId : -1, //销售品实例ID
				attachSepcId : offerSpecId,
				state : "ADD", //动作
				relaSeq : "", //关联序列	
				num :"1"
			};
			if(CONST.getAppDesc()==0){
				coupon.termTypeFlag=data.termTypeFlag;
			}
			if(document.getElementById("if_p_reserveCode").checked){
				var custId = OrderInfo.cust.custId;
				var identityTypeCd  ="";
				var identityNum ="";
				if (custId == -1) {
					identityTypeCd = OrderInfo.boCustIdentities.identidiesTypeCd;
					identityNum =OrderInfo.boCustIdentities.identityNum;
				}
				var param = {
						reserveCode : reserveCode,
						couponId : data.mktResId,
						terminalPrice : mktPrice,
						custId : custId,
						identityTypeCd : identityTypeCd,
						identityNum : identityNum
				};
				var url = contextPath+"/mktRes/terminal/queryCouponReserveCodeCheck ";
				$.callServiceAsJson(url,param,{
					"before":function(){
//						$.ecOverlay("<strong>预约码校验中,请稍等...</strong>");
					},"always":function(){
//						$.unecOverlay();
					},
					"done" : function(response){
						if (response && response.code == -2) {
							$.each(checkedOfferSpec,function(){
								var offerSpec = this;
								var specList = CacheData.getOfferSpecList(prodId);
								$.each(specList,function(){
									if(offerSpec.offerSpecId == this.offerSpecId){
										var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
										this.isdel = "Y";
										_delServSpec(prodId,this); //取消订购销售品时
										order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
										$("#li_"+prodId+"_"+this.offerSpecId).remove();
									}
								});
							});
							checkedOfferSpec = [];
							$.alertM(response.data);
							return;
						} else if(response&&response.data&&response.data.code == 0) {
							if(response.data.buyFlag!=null && response.data.buyFlag=="Y"){
								var content = "您购买的终端和预约的终端不一致，请确认是否需要购买该终端？";
								$.confirm("信息确认",content,{ 
									yes:function(){
									},
									yesdo:function(){
										if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){
											$.each(checkedOfferSpec,function(){
												var offerSpec = this;
												var specList = CacheData.getOfferSpecList(prodId);
												$.each(specList,function(){
													if(offerSpec.offerSpecId == this.offerSpecId){
														var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
														this.isdel = "Y";
														_delServSpec(prodId,this); //取消订购销售品时
														order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
														$("#li_"+prodId+"_"+this.offerSpecId).remove();
													}
												});
											});
										}
										checkedReserveNbr= response.data.couponInfo.reserveNbr;
										coupon.sourceId = checkedReserveNbr;
										OrderInfo.termReserveFlag = CONST.OL_TYPE_CD.ZDYY;
										OrderInfo.attach2Coupons.push(coupon);
										if(response.data.offerSpec.length>0){
											checkedOfferSpec = response.data.offerSpec;
											var content = '<form id="promotionForm"><table>';
											var selectStr = "";
											var optionStr = "";
											selectStr = selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>"; 
											$.each(response.data.offerSpec,function(){
												var offerSpec = this;
												optionStr +='<option value="'+this.offerSpecId+'">'+this.offerSpecName+'</option>';
											});
											selectStr += optionStr + "</select></td></tr>"; 
											content +=selectStr;
											var offerSpecId;
											$.confirm("促销包选择",content,{ 
												yes:function(){	
													
												},
												no:function(){
													
												}
											});
											$('#promotionForm').bind('formIsValid', function(event, form) {
												offerSpecId = $('#'+checkedReserveNbr+' option:selected').val();
												$(".ZebraDialog").remove();
								                $(".ZebraDialogOverlay").remove();
								                AttachOffer.selectAttachOffer(prodId,offerSpecId);
											}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
											
										}
									},
									no:function(){
									}
								});
							}else{
								if(checkedReserveNbr!=response.data.couponInfo.reserveNbr){
									$.each(checkedOfferSpec,function(){
										var offerSpec = this;
										var specList = CacheData.getOfferSpecList(prodId);
										$.each(specList,function(){
											if(offerSpec.offerSpecId == this.offerSpecId){
												var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
												this.isdel = "Y";
												_delServSpec(prodId,this); //取消订购销售品时
												order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
												$("#li_"+prodId+"_"+this.offerSpecId).remove();
											}
										});
									});
								}
								checkedReserveNbr= response.data.couponInfo.reserveNbr;
								coupon.sourceId = checkedReserveNbr;
								OrderInfo.termReserveFlag = CONST.OL_TYPE_CD.ZDYY;
								OrderInfo.attach2Coupons.push(coupon);
								if(response.data.offerSpec.length>0){
									checkedOfferSpec = response.data.offerSpec;
									var content = '<form id="promotionForm"><table>';
									var selectStr = "";
									var optionStr = "";
									selectStr = selectStr+"<tr><td>可订购促销包: </td><td><select class='inputWidth183px' id="+checkedReserveNbr+"><br>"; 
									$.each(response.data.offerSpec,function(){
										var offerSpec = this;
										optionStr +='<option value="'+this.offerSpecId+'">'+this.offerSpecName+'</option>';
									});
									selectStr += optionStr + "</select></td></tr>"; 
									content +=selectStr;
									var offerSpecId;
									$.confirm("促销包选择",content,{ 
										yes:function(){	
											
										},
										no:function(){
											
										}
									});
									$('#promotionForm').bind('formIsValid', function(event, form) {
										offerSpecId = $('#'+checkedReserveNbr+' option:selected').val();
										$(".ZebraDialog").remove();
						                $(".ZebraDialogOverlay").remove();
						                AttachOffer.selectAttachOffer(prodId,offerSpecId);
									}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
									
								}else {
									$.alert("信息提示",data.message);
								}
							}
						}else if(response && response.data && response.data.message
								&& response.data.code == 1){
							$.each(checkedOfferSpec,function(){
								var offerSpec = this;
								var specList = CacheData.getOfferSpecList(prodId);
								$.each(specList,function(){
									if(offerSpec.offerSpecId == this.offerSpecId){
										var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
										this.isdel = "Y";
										_delServSpec(prodId,this); //取消订购销售品时
										order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
										$("#li_"+prodId+"_"+this.offerSpecId).remove();
									}
								});
							});
							checkedOfferSpec = [];
							$.alert("提示", response.data.message);
							return;
						}else{
							$.each(checkedOfferSpec,function(){
								var offerSpec = this;
								var specList = CacheData.getOfferSpecList(prodId);
								$.each(specList,function(){
									if(offerSpec.offerSpecId == this.offerSpecId){
										var $span = $("#li_"+prodId+"_"+this.offerSpecId).find("span"); //定位删除的附属
										this.isdel = "Y";
										_delServSpec(prodId,this); //取消订购销售品时
										order.dealer.removeAttDealer(prodId+"_"+offerSpecId); //删除协销人
										$("#li_"+prodId+"_"+this.offerSpecId).remove();
									}
								});
							});
							checkedOfferSpec = [];
							$.alert("提示","<br/>终端预约码校验失败，请稍后重试！");
							return;
						}
					}
				});
			}else{
				$.alert("信息提示",data.message);
				OrderInfo.attach2Coupons.push(coupon);
			}
		}else if(data.statusCd==CONST.MKTRES_STATUS.HAVESALE){
			$.alert("提示","终端当前状态为已销售为补贴[1115],只有在办理话补合约时可用");
		}else{
			$.alert("提示",data.message);
		}
	};
	
	//添加可选包到缓存列表
	var _setSpec = function(prodId,offerSpecId){
		var newSpec = CacheData.getOfferSpec(prodId,offerSpecId);  //没有在已选列表里面
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			newSpec = query.offer.queryAttachOfferSpec(prodId,offerSpecId); //重新获取销售品构成
			if(!newSpec){
				return;
			}
			CacheData.setOfferSpec(prodId,newSpec);
		}
		return newSpec;
	};
	
	//添加到开通列表
	var _addOpenServList = function(prodId,servSpecId,servSpecName,ifParams){
		//从已开通功能产品中找
		var serv = CacheData.getServBySpecId(prodId,servSpecId); 
		if(serv != undefined){
			$("#li_"+prodId+"_"+serv.servId).find("div").removeClass("deldiv");
			serv.isdel = "N";
			return;
		}
		//从已选择功能产品中找
		var spec = CacheData.getServSpec(prodId,servSpecId);
		if(spec == undefined){
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : servSpecName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			spec = newSpec;
		} 
		if(spec.isdel == "C"){  //没有订购过
			$('#li_'+prodId+'_'+servSpecId).remove(); //在已开通附属里面
			var $li = $('<li id="li_'+prodId+'_'+servSpecId+'" class="ui-li-static ui-body-inherit ui-last-child"></li>');
			var $div = $('<div class="block"></div>');
			$div.append(servSpecName+'<span></span>');
			var $span = $('<span id="li_span_'+prodId+'_'+servSpecId+'"></span>');
			if(spec.ifDault==0){ //必须
				$span.append('<a href="javascript:void(0);" class="abtn03 icon-nodel ui-link">&nbsp;</a>');
			}else {
				$span.append('<a href="javascript:void(0);" class="abtn02 icon-del" onclick="AttachOffer.closeServSpec('+prodId+','+servSpecId+',\''+servSpecName+'\',\''+ifParams+'\');">&nbsp;</a>');
			}
			if (spec.ifParams=="Y"){
				if(CacheData.setServParam(prodId,spec)){ 
					$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="abtn01" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
				}else {
					$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="abtn02" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
				}
			}
			$div.append($span).appendTo($li).appendTo($("#open_serv_ul_"+prodId));
			spec.isdel = "N";
		}else {
			$("#li_span_"+prodId+"_"+servSpecId).parent().removeClass("deldiv");
		}
		spec.isdel = "N";
		_showHideUim(0,prodId,servSpecId);//显示或者隐藏补换卡
	};
	
	//现在主销售品参数
	var _showMainParam = function(){
		var content = CacheData.getParamContent(-1,OrderInfo.offerSpec,0);
		$.confirm("参数设置： ",content,{ 
			yes:function(){	
				
			},
			no:function(){
				
			}
		});
		$('#paramForm').bind('formIsValid', function(event, form) {
		}).ketchup({bindElement:"easyDialogYesBtn"});
	};
	
	//显示参数
	var _showParam = function(prodId,offerSpecId,flag){	
		if(flag==1){ //显示已订购附属		
			var offer = CacheData.getOfferBySpecId(prodId,offerSpecId);
			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offer.offerId	
				};
				param.acctNbr = OrderInfo.getAccessNumber(prodId);
				var data = query.offer.queryOfferInst(param);
				if(data==undefined){
					return;
				}
				offer.offerMemberInfos = data.offerMemberInfos;
				offer.offerSpec = data.offerSpec;
			}
			if(!offer.isGetParam){  //已订购附属没有参数，需要获取销售品参数
				var param = {   
				    offerTypeCd : "2",
				    offerId: offer.offerId,
				    offerSpecId : offer.offerSpecId
				};
				var offerParam = query.offer.queryOfferParam(param); //重新获取销售品参数
				if(offerParam==undefined){
					return;
				}else{
					offer.offerParamInfos = offerParam.offerParamInfos;
					offer.isGetParam = true;
				}
			}
			var content = CacheData.getParamContent(prodId,offer,flag);
			$.confirm("参数设置： ",content,{ 
				yes:function(){		
				},
				no:function(){
				}
			});
			$('#paramForm').bind('formIsValid', function(event, form) {
				var isset = false;
				$.each(offer.offerSpec.offerSpecParams,function(){
					var itemInfo = CacheData.getOfferParam(prodId,offer.offerId,this.itemSpecId);
					itemInfo.setValue = $("#"+prodId+"_"+this.itemSpecId).val();	
					if(itemInfo.value!=itemInfo.setValue){
						itemInfo.isUpdate = "Y";
						isset = true;
					}
				});
				if(isset){
					$("#can_"+prodId+"_"+offer.offerId).removeClass("abtn03").addClass("abtn01");
					offer.isset = "Y";
					offer.update = "Y";
				}else{
					$("#can_"+prodId+"_"+offer.offerId).removeClass("abtn01").addClass("abtn03");
					offer.isset = "N";
					offer.update = "N";
				}
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});		
		}else {
			var spec = CacheData.getOfferSpec(prodId,offerSpecId);
			if(spec == undefined){  //未开通的附属销售品，需要获取销售品构成
				spec = query.offer.queryAttachOfferSpec(prodId,offerSpecId); //重新获取销售品构成
				if(!spec){
					return;
				}
			}
			var content = CacheData.getParamContent(prodId,spec,flag);	
			$.confirm("参数设置： ",content,{ 
				yes:function(){
				},
				no:function(){
				}
			});
			
			//order.protocolnbr.init();
			$('#paramForm').bind('formIsValid', function(event, form){
				if(!paramInputCheck()){
					return;
				}
				
				if(!!spec.offerSpecParams){
					for (var i = 0; i < spec.offerSpecParams.length; i++) {
						var param = spec.offerSpecParams[i];
						var itemSpec = CacheData.getSpecParam(prodId,offerSpecId,param.itemSpecId);
						itemSpec.setValue = $("#"+prodId+"_"+param.itemSpecId).val();
					}
				}
				
				if(spec.offerRoles!=undefined && spec.offerRoles.length>0){
					for (var i = 0; i < spec.offerRoles.length; i++) {
						var offerRole = spec.offerRoles[i];
						for (var j = 0; j < offerRole.roleObjs.length; j++) {
							var roleObj = offerRole.roleObjs[j];
							if(!!roleObj.prodSpecParams){
								for (var k = 0; k < roleObj.prodSpecParams.length; k++) {
									var prodParam = roleObj.prodSpecParams[k];
									var prodItem = CacheData.getProdSpecParam(prodId,offerSpecId,prodParam.itemSpecId);
									prodItem.value = $("#"+prodId+"_"+prodParam.itemSpecId).val();
								}
							}
						}
					}
				}
				$("#can_"+prodId+"_"+offerSpecId).removeClass("abtn03").addClass("abtn01");
				var attchSpec = CacheData.getOfferSpec(prodId,offerSpecId);
				attchSpec.isset = "Y";
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});	
		}
	};
	
	//（销售品）参数输入校验（服务参数暂未使用）
	var paramInputCheck = function(){
		var pass = true;
		$("#paramForm").find("input[type=text]").each(function(){
			var mask = $(this).attr("mask");
			var maskmsg = $(this).attr("maskmsg");
			if(mask!=null && mask!="" && mask.substring(0,1)=="/" && mask.substring(mask.length-1,mask.length)=="/"){
				if(!eval(mask).test($(this).val())){
					$.alert("提示",maskmsg);
					pass = false;
					return false;
				}
			}
		});
		return pass;
	};
	
	//显示服务参数
	var _showServParam = function(prodId,servSpecId,flag){
		if(flag==1){ //显示已订购附属
			var serv = CacheData.getServBySpecId(prodId,servSpecId);
			var param = {
				prodId : serv.servId,
				ifServItem:"Y"
			};
			if(!serv.isGetParamSpec){  //已订购附属没有参数，需要获取销售品参数	
				param.prodSpecId = serv.servSpecId;
				var dataSepc = query.prod.prodSpecParamQuery(param); //重新获取销售品参数
				if(dataSepc==undefined){
					return;
				}else{
					serv.prodSpecParams = dataSepc.result.prodSpecParams;
					serv.isGetParamSpec = true;
				}
			}
			if(!serv.isGetParamInst){  //已订购附属没有参数，需要获取销售品参数
				var data = query.prod.prodInstParamQuery(param); //重新获取销售品参数
				if(data==undefined){
					return;
				}else{
					serv.prodInstParams = data.result.prodInstParams;
					serv.isGetParamInst = true;
				}
			}
			var content = CacheData.getParamContent(prodId,serv,3);
			$.confirm("参数设置： ",content,{ 
				yes:function(){	
					
				},
				no:function(){
					
				}
			});
			$('#paramForm').bind('formIsValid', function(event, form) {
				var isset = false;
				$.each(serv.prodSpecParams,function(){
					var prodItem = CacheData.getServInstParam(prodId,serv.servId,this.itemSpecId);
					prodItem.setValue = $("#"+prodId+"_"+this.itemSpecId).val();	
					if(prodItem.value!=prodItem.setValue){
						prodItem.isUpdate = "Y";
						isset = true;
					}
				});
				if(isset){
					$("#can_"+prodId+"_"+serv.servId).removeClass("abtn03").addClass("abtn01");
					serv.isset = "Y";
					serv.update = "Y";
				}else{
					$("#can_"+prodId+"_"+serv.servId).removeClass("abtn01").addClass("abtn02");
					serv.isset = "N";
					serv.update = "N";
				}
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
		
		}else {
			var spec = CacheData.getServSpec(prodId,servSpecId);
			if(spec == undefined){  //未开通的附属销售品，需要获取销售品构成
				return;
			}
			var content = CacheData.getParamContent(prodId,spec,2);	
			$.confirm("参数设置： ",content,{ 
				yes:function(){
				},
				no:function(){	
				}
			});
			$('#paramForm').bind('formIsValid', function(event, form){
				if(!!spec.prodSpecParams){
					for (var i = 0; i < spec.prodSpecParams.length; i++) {
						var param = spec.prodSpecParams[i];
						var itemSpec = CacheData.getServSpecParam(prodId,servSpecId,param.itemSpecId);
						itemSpec.setValue = $("#"+prodId+"_"+param.itemSpecId).val();
					}
				}
				$("#can_"+prodId+"_"+servSpecId).removeClass("abtn03").addClass("abtn01");
				var attchSpec = CacheData.getServSpec(prodId,servSpecId);
				attchSpec.isset = "Y";
				$(".ZebraDialog").remove();
                $(".ZebraDialogOverlay").remove();
			}).ketchup({bindElementByClass:"ZebraDialog_Button1"});
		}
		
	};
	
	//销售品生失效时间显示
	var _showTime = function(prodId,offerSpecId,offerSpecName){	
		var data = OrderInfo.getPrivilege("EFF_TIME");		
		$('#attachName').text(offerSpecName+"--生失效设置");
		var spec = CacheData.getOfferSpec(prodId,offerSpecId);
		_initTime(spec);
		easyDialog.open({
			container : "div_time_dialog"
		});
		$("#timeSpan").off("click").on("click",function(){
			_setAttachTime(prodId,offerSpecId);
		});
		if(data==0){
			$("#startTimeTr").show();
			$("#endTimeTr").show();
		}else{
			$("#startTimeTr").hide();
			$("#endTimeTr").hide();
		}
	};
	
	//销售品生效时间显示
	var _showStartTime = function(){	
		var strDate =DateUtil.Format("yyyy年MM月dd日",new Date());
		var endDate = $("#endDt").val();
		if(endDate ==""){
			$.calendar({minDate:strDate});
		}else{
			$.calendar({minDate:strDate,maxDate:endDate});
		}
	};
	
	//销售品失效时间显示
	var _showEndTime = function(){	
		var strDate = $("#startDt").val();
		if(strDate==""){
			strDate =DateUtil.Format("yyyy年MM月dd日",new Date());
		}
		$.calendar({minDate:strDate});
	};
	
	//初始化时间设置页面
	var _initTime = function(spec){
		if(spec!=undefined && spec.ooTimes!=undefined){
			var ooTime = spec.ooTimes;
			$("input[name=startTimeType][value='"+ooTime.startType+"']").attr("checked","checked");
			$("input[name=endTimeType][value='"+ooTime.endType+"']").attr("checked","checked");
			$("#startDt").val("");
			$("#endDt").val("");
			$("#endTime").val("");
			if(ooTime.startType == 4){ //指定生效时间
				$("#startDt").val(ooTime.startDt);
			}
			if(ooTime.endType == 4){ //指定失效时间
				$("#endDt").val(ooTime.endDt);
			}else if(ooTime.endType == 5){  //有效时长
				$("#endTime").val(ooTime.effTime);
				$("#endTimeUnit").val(ooTime.effTimeUnitCd);
			}
		}else {
			$("input[name=startTimeType][value=1]").attr("checked","checked");
			$("input[name=endTimeType][value=1]").attr("checked","checked");
			$("#startDt").val("");
			$("#endDt").val("");
			$("#endTime").val("");
		}
	};
	
	//显示主套餐时间
	var _showOfferTime = function(){
		var data = OrderInfo.getPrivilege("EFF_TIME");		
		$('#attachName').text(OrderInfo.offerSpec.offerSpecName+"-生失效设置");
		_initTime(OrderInfo.offerSpec);
		easyDialog.open({
			container : "div_time_dialog"
		});
		$("#timeSpan").off("click").on("click",function(){
			_setMainTime();
		});
		if(data==0){
			$("#startTimeTr").show();
			$("#endTimeTr").show();
		}else{
			$("#startTimeTr").hide();
			$("#endTimeTr").hide();
		}
	};
	
	//显示主套餐构成
	var _showMainMember = function(){
		$('#memberName').text(OrderInfo.offerSpec.offerSpecName+"-构成");
		$("#main_member_div").empty();
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if(this.memberRoleCd == CONST.MEMBER_ROLE_CD.CONTENT){
				var $ul = $('</div><ul id="serv_ul_'+prodId+'"></ul>');
				var $div = $('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');
				$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));
				$.each(offerRole.roleObjs,function(){
					var $li = $('<li id="li_'+prodId+'_'+this.objId+'">'+this.objName+'</li>');
					var $checkbox = $('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');
					$ul.append($checkbox).append($li);
				});
				$("#main_member_div").append('<div class="clear"></div>');
			}else{
				$.each(offerRole.prodInsts,function(){
					var prodId = this.prodInstId;
					var $ul = $('</div><ul id="serv_ul_'+prodId+'"></ul>');
					var $div = $('<div id="serv_div_'+prodId+'" class="fs_choosed"></div>');
					$("#main_member_div").append("<h4>"+this.offerRoleName+"</h4>").append($div.append($ul));
					$.each(offerRole.roleObjs,function(){
						if(this.objType == CONST.OBJ_TYPE.SERV){
							var $li = $('<li id="li_'+prodId+'_'+this.objId+'">'+this.objName+'</li>');
							var $checkbox = $('<input type="checkbox" name="serv_check_'+prodId+'" servSpecId="'+this.objId+'"></input>');
							$ul.append($checkbox).append($li);		
						}
					});
					$("#main_member_div").append('<div class="clear"></div>');
				});
			}
		});
		easyDialog.open({
			container : "div_member_dialog"
		});
		
		$.each(OrderInfo.offerSpec.offerRoles,function(){  //自动勾选功能产品
			var offerRole = this;
			$.each(offerRole.prodInsts,function(){ //自动勾选接入产品已经选择的功能产品
				var prodInst = this;
				$.each(offerRole.roleObjs,function(){ //根据规格配置勾选默认的功能产品
					var servSpecId = this.objId;
					if(this.minQty>0){ //必选
						$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){
							if(servSpecId==$(this).attr("servSpecId")){
								$(this).attr("checked","checked");
								$(this).attr("disabled","disabled");
							}
						});
					}
				});
				if(!!prodInst.servInsts){  
					$.each(prodInst.servInsts,function(){  //遍历产品实例下已经选择的功能产品
						var servSpecId = this.objId;
						$("input[name='serv_check_"+prodInst.prodInstId+"']").each(function(){
							if(servSpecId==$(this).attr("servSpecId")){
								$(this).attr("checked","checked");
							}
						});
					});
				}
			});
		});
		
		$("#memberSpan").off("click").on("click",function(){
			_setMainMember();
		});
	};
	
	//保存主销售品成员
	var _setMainMember = function(){
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			$.each(this.prodInsts,function(){
				var prodInst = this;
				prodInst.servInsts = [];
				$("input[name='serv_check_"+this.prodInstId+"']:checked").each(function(){
					var servSpecId = $(this).attr("servSpecId");
					$.each(offerRole.roleObjs,function(){
						if(this.objId==servSpecId){  //获取选择功能产品的构成
							prodInst.servInsts.push(this);	
						}
					});
				});
			});
		});
		easyDialog.close();
	};
	
	//获取ooTime节点
	var _getTime = function(){
		var ooTime = {
			state : "ADD" 
		};
		//封装生效时间
		var startRadio = $("input[name=startTimeType]:checked").attr("value");
		ooTime.startType = startRadio;
		if(startRadio==1){
			ooTime.isDefaultStart = "Y";
		}else if(startRadio==2){  //竣工生效，不传值
			
		}else if(startRadio==3){  //次月生效
			ooTime.startTime = 1;
			ooTime.startTimeUnitCd = 7;
			//ooTime.startDt = _getNextMonthFirstDate();
		}else if(startRadio==4){ //指定生效时间
			if($("#startDt").val()==""){
				$.alert("提示","指定生效时间不能为空!");
				return;
			}
			ooTime.startDt = $("#startDt").val();
		}
		//封装失效时间
		var endRadio = $("input[name=endTimeType]:checked").attr("value");	
		ooTime.endType = endRadio;
		if(endRadio==1){
			ooTime.isDefaultEnd = "Y";
		}else if(endRadio==4){
			if($("#endDt").val()==""){
				$.alert("提示","指定失效时间不能为空!");
				return;
			}
			ooTime.endDt = $("#endDt").val();
		}else if(endRadio==5){
			var end = $("#endTime").val();
			if(end==""){
				$.alert("提示","有效时长不能为空!");
				return;
			}
			if(isNaN(end)){
				$.alert("提示","有效时长必须为数字!");
				return;
			} 
			if(end<=0){
				$.alert("提示","有效时长必须大于0!");
				return;
			} 
			ooTime.effTime = end;
			ooTime.effTimeUnitCd = $("#endTimeUnit").val();
		}
		return ooTime;
	};
	
	//设置主销售品生失效时间设置
	var _setMainTime = function(){
		var ooTime = _getTime();
		if(ooTime==undefined){
			return;
		}
		OrderInfo.offerSpec.ooTimes = ooTime;
		$("#mainTime").removeClass("time").addClass("time2");
		easyDialog.close();
	};
	
	//设置附属销售品生失效时间设置
	var _setAttachTime = function(prodId,offerSpecId){
		var ooTime = _getTime();
		if(ooTime==undefined){
			return;
		}
		var spec = CacheData.getOfferSpec(prodId,offerSpecId);
		spec.ooTimes = ooTime;
		$("#time_"+prodId+"_"+offerSpecId).removeClass("time").addClass("time2");
		easyDialog.close();
	};
	
	//获取下个月第一天
	/*var _getNextMonthFirstDate = function(){
		var d = new Date();
		var yyyy = 1900+d.getYear();    
		var MM = d.getMonth()+1;      
		var dd = "01";   
		if(MM==12){
			yyyy++;
			MM = "01";	
		}else if(MM<9){
			MM++;
			MM = "0"+MM;
		}else {
			MM++;
		}
		return yyyy+"-"+MM+"-"+dd; 
	};*/
	var _changeLabel1=function(prodId,prodSpecId,obj){
		var labelId=$(obj).val();
		_changeLabel(prodId,prodSpecId,labelId);
	};
	
	var _changeLabel1x=function(prodId,prodSpecId,obj){
		var labelId="search";
		_changeLabel(prodId,prodSpecId,labelId);
	};
	
	//开通跟取消开通功能产品时判断是否显示跟隐藏补换卡
	var _showHideUim = function(flag,prodId,servSpecId){
		if(CONST.getAppDesc()==0 && servSpecId == CONST.PROD_SPEC.PROD_FUN_4G){ //4G系统并且是开通或者关闭4g功能产品
			var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
			if(OrderInfo.actionFlag==2){//套餐变更
				prodClass = CacheData.getOfferMember(prodId).prodClass;
				if(prodClass==undefined && offerChange.oldMemberFlag){
					$.each(OrderInfo.oldoffer,function(){
						$.each(this.offerMemberInfos,function(){
							if(this.objInstId==prodId){
								prodClass = this.prodClass;
							}
						});
					});
				}
			}
			if(flag==0){ //开通功能产品
				if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡需要补卡
					$("#uimDiv_"+prodId).show();
					
					var actionFalg=OrderInfo.actionFlag;
					var instCode=OrderInfo.provinceInfo.mktResInstCode;
					var codeMsg=OrderInfo.provinceInfo.codeMsg;
					
					if(actionFalg=="3" && OrderInfo.provinceInfo.reloadFlag=="Y"){
						if(codeMsg!=null && codeMsg!=""){
							$.alert("提示",codeMsg);
						}else{
							if(instCode!=null && instCode!=""){
								$("#uim_txt_"+prodId).val(instCode);//将UIM卡信息放入
								$("#uim_check_btn_"+prodId).hide();
								$("#uim_release_btn_"+prodId).hide();
								$("#uim_txt_"+prodId).attr("disabled",true);
								
								var uimParam = {
									"instCode":instCode
								};
								
								var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
								
								if (response.code==0) {
									if(response.data.mktResBaseInfo){
										var statusCd=response.data.mktResBaseInfo.statusCd;
										if(statusCd=="1102"){
											var offerId="";
											if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//判断是否是纳入老用户
												$.each(OrderInfo.oldprodInstInfos,function(){
													if(this.prodInstId==prodId){
														offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
													}
												});
											}else{
												offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
											}
											
											_packageCouponInfo(prodId,offerId,response,instCode);
										}else{
											$.alert("提示","UIM卡不是预占状态，当前为"+statusCd);
										}
									}else{
										$.alert("提示","查询不到UIM卡["+instCode+"]信息");
									}
								}else if (response.code==-2){
									$.alertM(response.data);
								}else {
									$.alert("提示","UIM信息查询接口出错,稍后重试");
								}
							}
						}
					}
					if(order.memberChange.mktResInstCode!="" && order.memberChange.mktResInstCode!=undefined && order.memberChange.reloadFlag=="Y"){
						var offerId = "-1";
						if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//判断是否是纳入老用户
							if(ec.util.isArray(OrderInfo.viceprodInstInfos) && OrderInfo.oldMvFlag){
								$.each(OrderInfo.viceprodInstInfos,function(){
									if(this.prodInstId==prodId){
										offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
									}
								});
							}else{
								$.each(OrderInfo.oldprodInstInfos,function(){
									if(this.prodInstId==prodId){
										offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
									}
								});
							}
						}else{
							offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
						}		
						var mktResInstCodesize = order.memberChange.mktResInstCode.split(",");
						for(var u=0;u<mktResInstCodesize.length;u++){
							if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null"){
								var nbrAndUimCode = mktResInstCodesize[u].split("_");
								var _accNbr = nbrAndUimCode[0];
								var _uimCode = nbrAndUimCode[1];
								var oldSubPhoneNumsize = order.memberChange.oldSubPhoneNum.split(",");
								for(var n=0;n<oldSubPhoneNumsize.length;n++){
									if(oldSubPhoneNumsize[n]==_accNbr){
										$.each(OrderInfo.oldoffer,function(){
											$.each(this.offerMemberInfos,function(){
												if(this.accessNumber==_accNbr){
										$("#uim_txt_"+this.objInstId).attr("disabled",true);
										var uimParam = {
												"instCode":_uimCode
										};
								var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
								if (response.code==0) {
									if(response.data.mktResBaseInfo){
										if(response.data.mktResBaseInfo.statusCd=="1102"){
//											$("#uim_check_btn_-"+(n+1)).attr("disabled",true);
//											$("#uim_check_btn_-"+(n+1)).removeClass("purchase").addClass("disablepurchase");
//											$("#uim_release_btn_-"+(n+1)).attr("disabled",false);
//											$("#uim_release_btn_-"+(n+1)).removeClass("disablepurchase").addClass("purchase");
//											$("#uim_txt_-"+(n+1)).val(_uimCode);								
											$("#uim_check_btn_"+this.objInstId).attr("disabled",true);
											$("#uim_check_btn_"+this.objInstId).removeClass("purchase").addClass("disablepurchase");
											$("#uim_release_btn_"+this.objInstId).attr("disabled",false);
											$("#uim_release_btn_"+this.objInstId).removeClass("disablepurchase").addClass("purchase");
											$("#uim_txt_"+this.objInstId).val(_uimCode);
											var coupon = {
													couponUsageTypeCd : "3", //物品使用类型
													inOutTypeId : "1",  //出入库类型
													inOutReasonId : 0, //出入库原因
													saleId : 1, //销售类型
													couponId : response.data.mktResBaseInfo.mktResId, //物品ID
													couponinfoStatusCd : "A", //物品处理状态
													chargeItemCd : "3000", //物品费用项类型
													couponNum : response.data.mktResBaseInfo.qty, //物品数量
													storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
													storeName : "1", //仓库名称
													agentId : 1, //供应商ID
													apCharge : 0, //物品价格
													couponInstanceNumber : _uimCode, //物品实例编码
													terminalCode :_uimCode,//前台内部使用的UIM卡号
													ruleId : "", //物品规则ID
													partyId : OrderInfo.cust.custId, //客户ID
													prodId :  this.objInstId, //产品ID
													offerId : offerId, //销售品实例ID
													state : "ADD", //动作
													relaSeq : "" //关联序列	
												};
											OrderInfo.clearProdUim(-(n+1));
											OrderInfo.boProd2Tds.push(coupon);
										}else{
											$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
										}
									}else{
										$.alert("提示","查询不到UIM信息");
									}
								}else if (response.code==-2){
									$.alertM(response.data);
								}else {
									$.alert("提示","UIM信息查询接口出错,稍后重试");
								}
												}
										});
										})
								}
								}
							}
						}
					}
					//老用户uim卡
					if((OrderInfo.actionFlag==2 || OrderInfo.actionFlag==1) && OrderInfo.mktResInstCode!=undefined && OrderInfo.mktResInstCode!=null && OrderInfo.mktResInstCode!="" && OrderInfo.mktResInstCode!="null" && OrderInfo.provinceInfo.reloadFlag=="Y"){
						var offerId = "-1";
//						offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
						$.each(OrderInfo.oldprodInstInfos,function(){
							if(this.prodInstId==prodId){
								offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
							}
						});
						var mktResInstCodesize = order.memberChange.mktResInstCode.split(",");
						for(var u=0;u<mktResInstCodesize.length;u++){
							if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null"){
								var nbrAndUimCode = mktResInstCodesize[u].split("_");
								var _accNbr = nbrAndUimCode[0];
								var _uimCode = nbrAndUimCode[1];
								var oldSubPhoneNumsize = order.memberChange.oldSubPhoneNum.split(",");
								for(var n=0;n<oldSubPhoneNumsize.length;n++){
									if(oldSubPhoneNumsize[n]==_accNbr){
										$.each(OrderInfo.oldoffer,function(){
											$.each(this.offerMemberInfos,function(){
												if(this.accessNumber==_accNbr){
//													$("#uim_txt_"+this.objInstId).attr("disabled",true);
													var uimParam = {
															"instCode":_uimCode
													};
													var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
													if (response.code==0) {
														if(response.data.mktResBaseInfo){
															if(response.data.mktResBaseInfo.statusCd=="1102"){
																$("#uim_check_btn_"+this.objInstId).attr("disabled",true);
																$("#uim_release_btn_"+this.objInstId).attr("disabled",false);
																$("#uim_release_btn_"+this.objInstId).removeClass("disabled");
																$("#uim_txt_"+this.objInstId).attr("disabled",true);
																$("#uim_txt_"+this.objInstId).val(_uimCode);
																var coupon = {
																		couponUsageTypeCd : "3", //物品使用类型
																		inOutTypeId : "1",  //出入库类型
																		inOutReasonId : 0, //出入库原因
																		saleId : 1, //销售类型
																		couponId : response.data.mktResBaseInfo.mktResId, //物品ID
																		couponinfoStatusCd : "A", //物品处理状态
																		chargeItemCd : "3000", //物品费用项类型
																		couponNum : response.data.mktResBaseInfo.qty, //物品数量
																		storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
																		storeName : "1", //仓库名称
																		agentId : 1, //供应商ID
																		apCharge : 0, //物品价格
																		couponInstanceNumber : _uimCode, //物品实例编码
																		terminalCode :_uimCode,//前台内部使用的UIM卡号
																		ruleId : "", //物品规则ID
																		partyId : OrderInfo.cust.custId, //客户ID
																		prodId :  this.objInstId, //产品ID
																		offerId : offerId, //销售品实例ID
																		state : "ADD", //动作
																		relaSeq : "" //关联序列	
																	};
																OrderInfo.clearProdUim(this.objInstId);
																OrderInfo.boProd2Tds.push(coupon);
															}else{
																$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
															}
														}else{
															$.alert("提示","查询不到UIM信息");
														}
													}else if (response.code==-2){
														$.alertM(response.data);
													}else {
														$.alert("提示","UIM信息查询接口出错,稍后重试");
													}
												}
											});
										})
									}
								}
							}
						}
					}

				}
			}else if(flag==1){//取消开通功能产品
				if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡，已经显示补卡,判断是否隐藏补卡
					$("#uimDiv_"+prodId).hide();
				}
			}
		}
	};
	
	/**组装UIM数据信息*/
	var _packageCouponInfo=function(prodId,offerId,response,instCode){
		var coupon = {
				couponUsageTypeCd : "3", //物品使用类型
				inOutTypeId : "1",  //出入库类型
				inOutReasonId : 0, //出入库原因
				saleId : 1, //销售类型
				couponId : response.data.mktResBaseInfo.mktResId, //物品ID
				couponinfoStatusCd : "A", //物品处理状态
				chargeItemCd : "3000", //物品费用项类型
				couponNum : 1, //物品数量
				storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
				storeName : "1", //仓库名称
				agentId : 1, //供应商ID
				apCharge : 0, //物品价格
				couponInstanceNumber :instCode, //物品实例编码
				terminalCode : instCode,//前台内部使用的UIM卡号
				ruleId : "", //物品规则ID
				partyId : OrderInfo.cust.custId, //客户ID
				prodId :  prodId, //产品ID
				offerId : offerId, //销售品实例ID
				state : "ADD", //动作
				relaSeq : "" //关联序列	
		};
		
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
	}
	
	//判断是否需要补卡
	var _isChangeUim = function(objId){
		if(CONST.getAppDesc()==0){
			var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
			var prodId = order.prodModify.choosedProdInfo.prodInstId;
			if(OrderInfo.actionFlag==2){//套餐变更
				var member = CacheData.getOfferMember(objId);
				prodClass = member.prodClass;
				prodId = member.objInstId;
			}else if(OrderInfo.actionFlag==6){
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.prodInstId==objId){
						prodClass = this.prodClass;
						prodId = this.prodInstId;
					}
				});
				$.each(OrderInfo.viceOfferSpec,function(){
					if(this.prodId==prodId){
						var member = CacheData.getOfferMember(objId);
						prodClass = member.prodClass;
						prodId = member.objInstId;
					}
				});
			}
			if(prodClass==CONST.PROD_CLASS.THREE){ //3G卡，已经显示补卡,判断是否隐藏补卡
				var servSpec = CacheData.getServSpec(prodId,CONST.PROD_SPEC.PROD_FUN_4G);
				if(servSpec!=undefined && servSpec.isdel != "Y" && servSpec.isdel != "C"){ //有开通4G功能产品
					return true;
				}
			}
		}
		return false;
	};
	
	//获取附属销售品节点
	var _setAttachBusiOrder = function(busiOrders){
		//遍历已选功能产品列表
		$.each(AttachOffer.openServList,function(){
			var prodId = this.prodId;
			$.each(this.servSpecList,function(){
				if(this.isdel != "Y" && this.isdel != "C"){  //订购的功能产品  && _getRelaType(this.servSpecId)!="1000"
					SoOrder.createServ(this,prodId,0,busiOrders);
				}
			});
		});
		//遍历已订购功能产品列表
		$.each(AttachOffer.openedServList,function(){
			var prodId = this.prodId;
			$.each(this.servList,function(){
				if(this.isdel == "Y"){  //关闭功能产品
					SoOrder.createServ(this,prodId,1,busiOrders);
				}else {
					if(this.update=="Y"){  //变更功能产品
						SoOrder.createServ(this,prodId,2,busiOrders);
					}
				}
			});
		});
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C"){  //订购的附属销售品
					SoOrder.createAttOffer(spec,open.prodId,0,busiOrders);
				}
			}
		}
		//遍历已订购附属销售品列表
		for ( var i = 0; i < AttachOffer.openedList.length; i++) {
			var opened = AttachOffer.openedList[i];
			for ( var j = 0; j < opened.offerList.length; j++) {  //遍历当前产品下面的附属销售品
				var offer = opened.offerList[j];
				if(offer.isdel == "Y"){  //退订的附属销售品
					SoOrder.createAttOffer(offer,opened.prodId,1,busiOrders);
				}else {
					if(offer.update=="Y"){  //修改附属销售品
						SoOrder.createAttOffer(offer,opened.prodId,2,busiOrders);
					}
				}
			}
		}
		
		//遍历已选增值业务
		$.each(AttachOffer.openAppList,function(){
			var prodId = this.prodId;
			$.each(this.appList,function(){
				if(this.dfQty==1){  //开通增值业务
					SoOrder.createServ(this,prodId,0,busiOrders);
				}
			});
		});
	};
	//把对比省预校验的后有变动的 功能产品和可选包 放入临时缓存列表中
	var _setChangeList=function(prodId){
		AttachOffer.changeList=[];//清空
		var prodInfos = offerChange.resultOffer.prodInfos;//预校验返回的功能产品
		if(ec.util.isArray(prodInfos)){
			$.each(prodInfos,function(){
//				var prodId = this.accProdInstId;
				//容错处理，省份接入产品实例id传错
//				var flag = true;
//				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
//					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
//						flag = false;
//						return false;
//					}
//				});
				if(prodId!=this.accProdInstId){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var param={
						prodInstId:prodId
					};
					var serv = CacheData.getServ(prodId,this.prodInstId);//在已开通的功能产品里面查找
					var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
					if(this.state=="DEL"){
						if(serv!=undefined && serv.isdel != "Y"){
							param.objId=this.prodInstId;
							param.status=(serv.isdel!=undefined?serv.isdel:"N");
							param.objIdType=1;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							serv.isdel = "Y";
							AttachOffer.changeList.push(param);
						}else if(servSpec!=undefined && servSpec.isdel !="Y" && servSpec.isdel !="C"){
							param.objId=this.productId;
							param.status=servSpec.isdel;
							param.objIdType=2;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							servSpec.isdel = "Y";
							AttachOffer.changeList.push(param);
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined && serv.isdel == "Y"){  //在已开通里面，修改不让关闭
							param.objId=this.prodInstId;
							param.status=serv.isdel;
							param.objIdType=1;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							serv.isdel = "N";
							AttachOffer.changeList.push(param);
						}else if(servSpec != undefined && servSpec.isdel =="Y"){
							param.objId=this.productId;
							param.status=servSpec.isdel;
							param.objIdType=2;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							servSpec.isdel = "N";
							AttachOffer.changeList.push(param);
						}else if(serv==undefined && servSpec==undefined){
							param.objId=this.productId;
							param.status="Y";
							param.objIdType=2;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
							AttachOffer.changeList.push(param);
							if(this.productId!=undefined && this.productId!=""){
//								AttachOffer.openServSpec(prodId,this.productId);
								var newSerSpec = {
										objId : this.productId,
										servSpecId : this.productId,
										servSpecName : this.productName,
										ifParams : "N",
										isdel : "N"  
									};
								CacheData.setServSpec(prodId,newSerSpec); //添加到已开通列表里
								var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
								servSpec.isdel="N";
							}
						}
					}
				}
			});
		}
		var offers = offerChange.resultOffer.prodOfferInfos;//省预校验返回的可选包
		if(ec.util.isArray(offers)){
			$.each(offers,function(){
				if(this.memberInfo==undefined){
					return true;
				}
				var flag = true;
				$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
					if(ec.util.isObj(this.accProdInstId)&&prodId == this.accProdInstId){
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				var param={
						prodInstId:prodId
					};
				var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已开通里面查找
				var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已选里面查找
				if(this.state=="DEL"){
					if(offer!=undefined && offer.isdel != "Y"){
						param.objId=this.prodOfferInstId;
						param.status=(offer.isdel!=undefined?offer.isdel:"N");
						param.objIdType=3;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offer.isdel = "Y";
						AttachOffer.changeList.push(param);
					}else if(offerSpec!=undefined && offerSpec.isdel !="Y" && offerSpec.isdel !="C"){
						param.objId=this.prodOfferId;
						param.status=offerSpec.isdel;
						param.objIdType=4;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offerSpec.isdel = "Y";
						AttachOffer.changeList.push(param);
					}	
				}else if(this.state=="ADD"){
					if(offer!=undefined && offer.isdel == "Y"){  //在已开通里面，修改不让关闭
						param.objId=this.prodOfferInstId;
						param.status=offer.isdel;
						param.objIdType=3;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offer.isdel = "N";
						AttachOffer.changeList.push(param);
					}else if(offerSpec != undefined && offerSpec.isdel =="Y"){
						param.objId=this.prodOfferId;
						param.status=offerSpec.isdel;
						param.objIdType=4;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						offerSpec.isdel = "N";
						AttachOffer.changeList.push(param);
					}else if(offer==undefined && offerSpec==undefined){
						param.objId=this.prodOfferId;
						param.status="Y";
						param.objIdType=4;//1 、功能产品实例id 2、功能产品规格id 3、销售品实例id 4、销售品规格id
						AttachOffer.changeList.push(param);
						if(ec.util.isObj(this.prodOfferId) && this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){
//							AttachOffer.addOfferSpecByCheck(prodId,this.prodOfferId);
							var newOfferSpec=_setSpec(prodId,this.prodOfferId);
							newOfferSpec.isdel="N";
						}
					}
				}
			});
		}
	};
	//还原预校验前的缓存信息
	var _reductionChangList=function(prodId){
		$.each(AttachOffer.changeList,function(){
			if(this.prodInstId==prodId){
				if(this.objIdType==1){
					var serv = CacheData.getServ(prodId,this.objId);//在已开通的功能产品里面查找
					if(serv!=undefined){
						serv.isdel=this.status;
					}
				}else if(this.objIdType==2){
					var servSpec = CacheData.getServSpec(prodId,this.objId);//在已选的功能产品里面查找
					if(servSpec!=undefined){
						servSpec.isdel=this.status;
					}
				}else if(this.objIdType==3){
					var offer = CacheData.getOffer(prodId,this.objId); //已开通里面查找
					if(offer!=undefined){
						offer.isdel=this.status;
					}
				}else if(this.objIdType==4){
					var offerSpec = CacheData.getOfferSpec(prodId,this.objId); //已选里面查找
					if(offerSpec!=undefined){
						offerSpec.isdel=this.status;
					}
				}
			}
		});
	};
	//查询销售品对象的互斥依赖连带的关系
	var _servExDepReByRoleObjs=function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		paramObj.excludeServ=[];//初始化
		paramObj.dependServ=[];//初始化
		paramObj.relatedServ=[];//初始化
		var globContent="";
		$.each(newSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objType==4 && this.selQty==1){
						var servSpec = CacheData.getServSpec(prodId,this.objId); //在已选列表中查找
						if(servSpec==undefined){   //在可订购功能产品里面 
							var serv = CacheData.getServBySpecId(prodId,this.objId); //在已开通列表中查找
							if(serv==undefined){
								var newServSpec = {
										objId : this.objId, //调用公用方法使用
										servSpecId : this.objId,
										servSpecName : this.objName,
										ifParams : this.isCompParam,
										prodSpecParams : this.prodSpecParams,
										isdel : "C"   //加入到缓存列表没有做页面操作为C
								};
								CacheData.setServSpec(prodId,newServSpec); //添加到已开通列表里
								servSpec = newServSpec;
							}else{
								servSpec=serv;
							}
						}
						var servSpecId = servSpec.servSpecId;
						var param = CacheData.getExcDepServParam(prodId,servSpecId);
						if(param.orderedServSpecIds.length == 0){
//							AttachOffer.addOpenServList(prodId,servSpecId,servSpec.servSpecName,servSpec.ifParams);
						}else{
							var data=query.offer.queryExcludeDepend(param);//查询规则校验
							var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);
							if(content!=""){
								content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);
								globContent+=(content+"<br>");
							}
						}
				}
			});
		});
		return globContent;
	};
	
	//转换接口返回的互斥依赖
	var paramObj = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
	};
	//解析服务互斥依赖
	var paserServDataByObjs = function(result,prodId,serv,newSpec){
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + this.servSpecName + "<br>";
					paramObj.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				if(!AttachOffer.filterServ(this.servSpecId,newSpec)){
					content += "需要开通：   " + this.servSpecName + "<br>";
					paramObj.dependServ.push(this);
				}
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				if(!AttachOffer.filterServ(this.servSpecId,newSpec)){
					content += "需要开通：   " + this.servSpecName + "<br>";
					paramObj.relatedServ.push(this);
				}
			});
		}
		return content;
	};
	
	//去重，把互斥依赖里面的信息进行去重处理
	var _filterServ=function(servSpecId,newSpec){
		var flag=false;
		$.each(newSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objType==4 && this.selQty==1){
					if(servSpecId==this.objId){
						flag=true;
						return false;
					}
				}
			});
		});
		if(!flag){
			if(ec.util.isArray(paramObj.dependServ)){
				for(var i=0;i<paramObj.dependServ.length;i++){
					if(servSpecId==paramObj.dependServ[i].servSpecId){
						flag=true;
						break;
					}
				}
			}
			if(!flag){
				if(ec.util.isArray(paramObj.relatedServ)){
					for(var i=0;i<paramObj.relatedServ.length;i++){
						if(servSpecId==paramObj.relatedServ[i].servSpecId){
							flag=true;
							break;
						}
					}
				}
			}
		}
		return flag;
	};
	
	//销售品角色成员对象是中 minQty大于0的话 就必须设置其为不能删除（暂定）
	var _minQtyFileter=function(prodId,servSpecId){
		//从已开通功能产品中找
		var serv = CacheData.getServBySpecId(prodId,servSpecId); 
		var $li;
		if(serv != undefined){
			$li=$("#li_"+prodId+"_"+serv.servId);
		}else{
			$li=$("#li_"+prodId+"_"+servSpecId);
		}
		if($li!=undefined){
			$li.find(".delete").remove();
			$li.append('<dd class="mustchoose"></dd>');	
		}
	};
	
	var _showMainMemberRoleProd=function(prodId){
		for (var i = 0; i < OrderInfo.viceOfferSpec.length; i++) {//多张副卡同时进行套餐变更
			var offerSpec=OrderInfo.viceOfferSpec[i];
			if(prodId==offerSpec.prodId){
				for (var j = 0; j < offerSpec.offerRoles.length; j++) {
					var offerRole = offerSpec.offerRoles[j];
					if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){//主卡
						for (var k = 0; k < offerRole.roleObjs.length; k++) {
							var roleObj = offerRole.roleObjs[k];
							if(roleObj.objType==CONST.OBJ_TYPE.SERV){
								var servSpecId = roleObj.objId;
								var $oldLi = $('#li_'+prodId+'_'+servSpecId);
								var spec = CacheData.getServSpec(prodId,servSpecId);//从已选择功能产品中找
								if(spec != undefined){
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								var serv = CacheData.getServBySpecId(prodId,servSpecId);//从已订购功能产品中找
								if(serv!=undefined){ //不在已经开跟已经选里面
									var $oldLi = $('#li_'+prodId+'_'+serv.servId);
									if(roleObj.minQty==1){
										$oldLi.append('<dd class="mustchoose"></dd>');
									}
									$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									continue;
								}
								if(roleObj.dfQty > 0){ //必选，或者默选
									var servSpec=jQuery.extend(true, {}, roleObj);
									CacheData.setServSpec(prodId,servSpec); //添加到已开通列表里
									spec = servSpec;
									if(ec.util.isArray(spec.prodSpecParams)){
										spec.ifParams = "Y";
									}
									$('#li_'+prodId+'_'+servSpecId).remove(); //删除可开通功能产品里面
									var $li = $('<li id="li_'+prodId+'_'+servSpecId+'"></li>');
									if(roleObj.minQty==0){
										$li.append('<dd class="delete" onclick="AttachOffer.closeServSpec('+prodId+','+servSpecId+',\''+spec.servSpecName+'\',\''+spec.ifParams+'\')"></dd>');
									}else{
										$li.append('<dd class="mustchoose"></dd>');
									}
									$li.append('<span>'+spec.servSpecName+'</span>');
									if (spec.ifParams=="Y"){
										if(CacheData.setServParam(prodId,spec)){ 
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu2" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}else {
											$li.append('<dd id="can_'+prodId+'_'+servSpecId+'" class="canshu" onclick="AttachOffer.showServParam('+prodId+','+servSpecId+');"></dd>');
										}
									}
									$li.append('<dd id="jue_'+prodId+'_'+servSpecId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
									$("#open_serv_ul_"+prodId).append($li);
									spec.isdel = "N";
									_showHideUim(0,prodId,servSpecId);//显示或者隐藏补换卡
								}
							}
						}
					}
				}
			}
		}
	};
	
	//删除附属销售品带出删除功能产品
	var _delServSpec = function(prodId,offerSpec){
		$.each(offerSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				var servSpecId = this.objId;
				if($("#check_"+prodId+"_"+servSpecId).attr("checked")=="checked"){
					var spec = CacheData.getServSpec(prodId,servSpecId);
					if(ec.util.isObj(spec)){
						spec.isdel = "Y";
						var $li = $("#li_"+prodId+"_"+servSpecId);
						$li.removeClass("canshu").addClass("canshu2");
						$li.find("span").addClass("del"); //定位删除的附属
						_showHideUim(1,prodId,servSpecId);   //显示或者隐藏
					}
				}
			});
		});
	};
	
	return {
		excludeAddattch:excludeAddattch,
	    delOfferSub:_delOfferSub,
		excludeAddServ:excludeAddServ,
		checkTerminalCodeSub:_checkTerminalCodeSub,
		addOffer 				: _addOffer,
		addOfferSpec 			: _addOfferSpec,
		addOpenList				: _addOpenList,
		addOpenServList			: _addOpenServList,
		addOfferSpecByCheck		: _addOfferSpecByCheck,
		closeAttachSearch 		: _closeAttachSearch,
		changeLabel				: _changeLabel,
		changeLabel1            : _changeLabel1,
		changeList				: _changeList,
		closeServ				: _closeServ,
		closeServSpec			: _closeServSpec,
		delOffer				: _delOffer,
		delOfferSpec			: _delOfferSpec,
		labelList				: _labelList,
		isChangeUim				: _isChangeUim,
		init					: _init,
		openList				: _openList,
		openedList				: _openedList,
		openServList			: _openServList,
		openedServList 			: _openedServList,
		openServSpec			: _openServSpec,
		openAppList				: _openAppList,
		queryAttachOffer 		: _queryAttachOffer,
		queryAttachOfferSpec 	: _queryAttachOfferSpec,
		showParam 				: _showParam,
		showServParam			: _showServParam,
		showTime				: _showTime,
		setAttachTime			: _setAttachTime,
		searchAttachOfferSpec   : _searchAttachOfferSpec,
		selectAttachOffer		: _selectAttachOffer,
		showOfferTime			: _showOfferTime,
		showMainParam			: _showMainParam,
		showMainMember			: _showMainMember,
		selectServ				: _selectServ,
		showStartTime			: _showStartTime,
		showEndTime			    : _showEndTime,
		setAttachBusiOrder		: _setAttachBusiOrder,
		showApp					: _showApp,
		showHideUim				: _showHideUim,
		showMainRoleProd		: _showMainRoleProd,
		checkTerminalCode		: _checkTerminalCode,
		checkOfferExcludeDepend	: _checkOfferExcludeDepend,
		checkServExcludeDepend	: _checkServExcludeDepend,
		servExDepReByRoleObjs	: _servExDepReByRoleObjs,
		setChangeList			: _setChangeList,
		reductionChangList		: _reductionChangList,
		filterServ				: _filterServ,
		changeOfferS            : _changeOfferS,
		changeOfferOrdered      : _changeOfferOrdered,
		openServSpecReload     :_openServSpecReload,
		closeServSpecReload   :_closeServSpecReload,
		delOfferSpecReload    :_delOfferSpecReload,
		showMainMemberRoleProd	: _showMainMemberRoleProd,
		addSearchOfferSpec	:_addSearchOfferSpec,
		dbClickAttachType :_dbClickAttachType,
		changereserveCode:_changereserveCode,
		delServSpec             : _delServSpec
	};
})();
/**
 * 销售品变更
 * 
 * @author wukf
 * date 2013-9-22
 */
CommonUtils.regNamespace("offerChange");

offerChange = (function() {
	
	var _resultOffer = {}; //预校验单接口返回
	var num=0;
	var _newMemberFlag = false;
	var _oldMemberFlag = false;
	//初始化套餐变更页面
	var _init = function (){
		var prodInfo = order.prodModify.choosedProdInfo;
		if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
			$.alert("提示","请选择一个在用产品");
			return;
		}
		OrderInfo.actionFlag = 2;
		if(!query.offer.setOffer()){ //必须先保存销售品实例构成，加载实例到缓存要使用
			return ;
		}
		//规则校验入参
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		},{
			boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		}];
		if(!rule.rule.ruleCheck(boInfos)){ //规则校验失败
			return;
		}
		//初始化套餐查询页面
		$.ecOverlay("<strong>正在查询中,请稍后....</strong>");
		var response = $.callServiceAsHtmlGet(contextPath+"/pad/order/prodoffer/prepare",{});	
		$.unecOverlay();
		if(response.code != 0) {
			$.alert("提示","查询失败,稍后重试");
			return;
		}
		SoOrder.step(0,response.data); //订单准备
		order.prepare.initOffer();
		order.service.searchPack();
		$("#dlg_cust_prod").popup("close");
		$("#navbar").slideUp(500);
		$.jqmRefresh($("#order_tab_panel_content"));
	};
		
	//套餐变更页面显示
	var _offerChangeView=function(){
		var oldLen = 0 ;
		$.each(OrderInfo.offer.offerMemberInfos,function(){
			if(this.objType==2){
				oldLen++;
			}
		});
		var memberNum = 1; //判断是否多成员 1 单成员2多成员
		var viceNum = 0;
		if(oldLen>1){ //多成员角色，目前只支持主副卡
			memberNum = 2;
		}
		//把旧套餐的产品自动匹配到新套餐中
		if(!_setChangeOfferSpec(memberNum,viceNum)){  
			return;
		};
		//4g系统需要
		if(CONST.getAppDesc()==0){ 
			//老套餐是3G，新套餐是4G
			if(order.prodModify.choosedProdInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){
				if(!offerChange.checkOrder()){ //省内校验单
					return;
				}
			}
			//根据UIM类型，设置产品是3G还是4G，并且保存旧卡
			if(!prod.uim.setProdUim()){ 
				return ;
			}
		}
		//初始化填单页面
		var prodInfo = order.prodModify.choosedProdInfo;
		var param = {
			boActionTypeCd : "S2" ,
			boActionTypeName : "套餐变更",
			actionFlag :"2",
			offerSpec : OrderInfo.offerSpec,
			prodId : prodInfo.prodInstId,
			offerMembers : OrderInfo.offer.offerMemberInfos,
			oldOfferSpecName : prodInfo.prodOfferName,
			prodClass : prodInfo.prodClass,
			appDesc : CONST.getAppDesc()
		};
		order.main.buildMainView(param);
	};
	
	//填充套餐变更页面
	var _fillOfferChange = function(response, param) {
		
		SoOrder.initFillPage(); //并且初始化订单数据
		$("#order_tab_panel_content").hide();
		$("#order_fill_content").show();
		$("#order_fill_content").html(response.data);

//		_initOfferLabel();//初始化主副卡标签
		$("#tabs-body .ordercona").eq(0).show();
		$("#fillNextStep").off("click").on("click",function(){
			SoOrder.submitOrder();
		});
		$("#fillLastStep").off("click").on("click",function(){
			order.main.lastStep();
		});
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息
		//遍历主销售品构成
		var uimDivShow=false;//是否已经展示了
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			var offerRole = this;
			if(ec.util.isArray(this.prodInsts)){
				$.each(this.prodInsts,function(){
					var _prodInstId = "'"+this.prodInstId+"'";
					if(_prodInstId.indexOf("-") == -1){
						var prodId = this.prodInstId;
						var param = {
							areaId : OrderInfo.getProdAreaId(prodId),
							channelId : OrderInfo.staff.channelId,
							staffId : OrderInfo.staff.staffId,
						    prodId : prodId,
						    prodSpecId : this.objId,
						    offerSpecId : prodInfo.prodOfferId,
						    offerRoleId : this.offerRoleId,
						    acctNbr : this.accessNumber
						};
						//现在号码
						var nowPhoneNum=this.accessNumber;
						var res = query.offer.queryChangeAttachOffer(param);
						$("#attach_"+prodId).html(res);	
						//如果objId，objType，objType不为空才可以查询默认必须
						if(ec.util.isObj(this.objId)&&ec.util.isObj(this.objType)&&ec.util.isObj(this.offerRoleId)){
							param.queryType = "1,2";
							param.objId = this.objId;
							param.objType = this.objType;
							param.memberRoleCd = this.roleCd;
							param.offerSpecId=OrderInfo.offerSpec.offerSpecId;
							//默认必须可选包
							var data = query.offer.queryDefMustOfferSpec(param);
							CacheData.parseOffer(data,prodId);
							//默认必须功能产品
							param.queryType = "1";//只查询必选，不查默认
							var data = query.offer.queryServSpec(param);
							CacheData.parseServ(data,prodId);
						}
						/*if(CONST.getAppDesc()==0 && prodInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){	//预校验
						}else{	
						}*/
						AttachOffer.showMainRoleProd(prodId); //显示新套餐构成
	//					AttachOffer.changeLabel(prodId,this.objId,""); //初始化第一个标签附属
						if(AttachOffer.isChangeUim(prodId)){ //需要补换卡
							//uim卡校验
							if(OrderInfo.mktResInstCode!=undefined && OrderInfo.mktResInstCode!=null && OrderInfo.mktResInstCode!="" && OrderInfo.mktResInstCode!="null"){
								var array=OrderInfo.mktResInstCode.split(",");
								if(array!=null && array.length>0){
									//首先进行UIM是否重复判断
									var checkPhone="";
									var checkUim="";
									var checkCode="0";
									for(var i=0;i<array.length;i++){
										var numAndUim=array[i].split("_");
										if(numAndUim!=null && numAndUim.length==2){
											var thisPhone=numAndUim[0];
											var thisUim=numAndUim[1]
											if(checkPhone!=null && checkPhone!=""){
												if(checkPhone==thisPhone || checkUim==thisUim){
													checkCode="1";
													break;
												}
											}else{
												checkPhone=thisPhone;
												checkUim=thisUim;
											}
										}
									}
									if(checkCode=="1"){
										$.alert("提示","传入的UIM参数中存在重复数据,参数为["+OrderInfo.mktResInstCode+"]");
									}else{
										//没有重复的数据再进行匹配
										var nowUim="";
										for(var i=0;i<array.length;i++){
											var numAndUim=array[i].split("_");
											if(numAndUim!=null && numAndUim.length==2){
												var phoneCode=numAndUim[0];
												var uimCode=numAndUim[1];
												
												if(phoneCode==nowPhoneNum){
													nowUim=uimCode;
												}
											}
										}
										if(nowUim!=null && nowUim!="" && nowUim!="null"){
											cleckUim(nowUim,prodId);
											$("#uim_check_btn_"+prodId).hide();
											$("#uim_release_btn_"+prodId).hide();
										}
									}
								}
							}
							num++;
							$("#uimDiv_"+prodId).show();
						}
					}
					else{
						var prodInst = this;
						var param = {   
							offerSpecId : OrderInfo.offerSpec.offerSpecId,
							prodSpecId : prodInst.objId,
							offerRoleId: prodInst.offerRoleId,
							prodId : prodInst.prodInstId,
							queryType : "1,2",
							objType: prodInst.objType,
							objId: prodInst.objId,
							memberRoleCd : prodInst.memberRoleCd
						};
						AttachOffer.queryAttachOfferSpec(param);  //加载附属销售品
						var obj = {
							ul_id : "item_order_"+prodInst.prodInstId,
							prodId : prodInst.prodInstId,
							offerSpecId : OrderInfo.offerSpec.offerSpecId,
							compProdSpecId : "",
							prodSpecId : prodInst.objId,
							roleCd : offerRole.roleCd,
							offerRoleId : offerRole.offerRoleId,
							partyId : OrderInfo.cust.custId,
							actionFlag : OrderInfo.actionFlag
							
						};
						//order.main.spec_parm(obj); //加载产品属性
						order.main.spec_member_parm(obj);
					}
				});
			}
		});
		
		
		//老用户
		if(offerChange.oldMemberFlag){
			for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
				var prodInfo = OrderInfo.oldprodInstInfos[i]; //获取老用户产品信息
				$.each(OrderInfo.oldoffer,function(){
					if(this.accNbr == prodInfo.accNbr){
						var oldoffer = this;
						$.each(oldoffer.offerMemberInfos,function(){
							var member = this;
							if(member.objType==CONST.OBJ_TYPE.PROD){
								var prodId = this.objInstId;
								var param = {
										areaId : OrderInfo.getProdAreaId(prodId),
										channelId : OrderInfo.staff.channelId,
										staffId : OrderInfo.staff.staffId,
									    prodId : prodId,
									    prodSpecId : member.objId,
									    offerSpecId : prodInfo.mainProdOfferInstInfos[0].prodOfferId,
									    offerRoleId : "",
									    acctNbr : member.accessNumber,
									    partyId:prodInfo.custId,
									    distributorId:OrderInfo.staff.distributorId,
									    mainOfferSpecId:prodInfo.mainProdOfferInstInfos[0].prodOfferId,
									    soNbr:OrderInfo.order.soNbr
									};
								if(ec.util.isObj(prodInfo.prodBigClass)){
									param.prodBigClass = prodInfo.prodBigClass;
								}
								$.each(OrderInfo.oldofferSpec,function(){
									if(this.accNbr==prodInfo.accNbr){
										$.each(this.offerSpec.offerRoles,function(){
											if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD || this.memberRoleCd==CONST.MEMBER_ROLE_CD.COMMON_MEMBER){
												param.offerRoleId = this.offerRoleId;
											}
										});
									}
								});
								var res = query.offer.queryChangeAttachOffer(param);
								$("#attach_"+prodId).html(res);	
								//如果objId，objType，objType不为空才可以查询默认必须
								if(ec.util.isObj(member.objId)&&ec.util.isObj(member.objType)&&ec.util.isObj(member.offerRoleId)){
									param.queryType = "1,2";
									param.objId = member.objId;
									param.objType = member.objType;
									param.memberRoleCd = "401";
									//默认必须可选包
									var data = query.offer.queryDefMustOfferSpec(param);
									CacheData.parseOffer(data,prodId);
									//默认必须功能产品
									var data = query.offer.queryServSpec(param);
									CacheData.parseServ(data,prodId);
								}
								if(ec.util.isArray(OrderInfo.oldofferSpec)){ //主套餐下的成员判断
									$.each(OrderInfo.oldofferSpec,function(){
										if(this.accNbr == prodInfo.accNbr){
											var offerRoles = this.offerSpec.offerRoles;
											$.each(offerRoles,function(){
												if(this.offerRoleId==member.offerRoleId && member.objType==CONST.OBJ_TYPE.PROD){
													var offerRole = this;
													$.each(this.roleObjs,function(){
														if(this.objType==CONST.OBJ_TYPE.SERV){
															var serv = CacheData.getServBySpecId(prodId,this.objId);//从已订购功能产品中找
															if(serv!=undefined){ //不在已经开跟已经选里面
																var $oldLi = $('#li_'+prodId+'_'+serv.servId);
//																if(this.minQty==1){
//																	$oldLi.append('<dd class="mustchoose"></dd>');
//																}
//																$oldLi.append('<dd id="jue_'+prodId+'_'+serv.servId+'" class="jue2" title="'+offerRole.offerRoleName+'"></dd>');
															}
														}
													});
													return false;
												}
											});
										}
									});
								}
//								AttachOffer.changeLabel(prodId,prodInfo.productId,"");
							}
						});
					}
				});
				var oldoffer = {};
				if(ec.util.isArray(OrderInfo.oldoffer)){ //主套餐下的成员判断
				    $.each(OrderInfo.oldoffer,function(){
				    	if(this.accNbr == prodInfo.accNbr){
				    		oldoffer = this;
				    	}
				    });
				}
				//老用户加入副卡需要预校验,主卡是4G，加入的老用户为3G
				if(order.prodModify.choosedProdInfo.is3G== "N" && prodInfo.mainProdOfferInstInfos[0].is3G =="Y"){
					if(!order.memberChange.checkOrder(prodInfo,oldoffer)){ //省内校验单
						return;
					}
					order.memberChange.checkOfferProd(oldoffer);
				}
				
			}
		}
        //初始化账户信息
		if(offerChange.newMemberFlag==true || offerChange.oldMemberFlag==true){
			order.main.initAcct(0);//初始化主卡帐户列表 
			order.main.initAcct(1);//初始化副卡帐户列表
		}
		
		order.dealer.initDealer(); //初始化发展人
		if(CONST.getAppDesc()==0 && order.prodModify.choosedProdInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){ //3G转4G需要校验
			offerChange.checkOfferProd();
		}
		
		//新用户选号
		if(order.memberChange.newSubPhoneNum!="" && OrderInfo.provinceInfo.reloadFlag=="Y"){
			var newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
			for(var n=0;n<newSubPhoneNumsize.length;n++){
				if(newSubPhoneNumsize[n]!=""&&newSubPhoneNumsize[n]!=null&&newSubPhoneNumsize[n]!="null"){
					var param = {"phoneNum":newSubPhoneNumsize[n]};
					var data = order.phoneNumber.queryPhoneNumber(param);
					if(data.datamap.baseInfo){
						$("#nbr_btn_-"+(n+1)).val(newSubPhoneNumsize[n]);
						var boProdAns={
								prodId : "-"+(n+1), //从填单页面头部div获取
								accessNumber : data.datamap.baseInfo.phoneNumber, //接入号
								anChooseTypeCd : "2", //接入号选择方式,自动生成或手工配号，默认传2
								anId : data.datamap.baseInfo.phoneNumId, //接入号ID
								pnLevelId : data.datamap.baseInfo.phoneLevelId,
								anTypeCd : data.datamap.baseInfo.pnTypeId, //号码类型
								state : "ADD", //动作	,新装默认ADD	
								areaId : data.datamap.baseInfo.areaId,
								areaCode:data.datamap.baseInfo.zoneNumber,
								memberRoleCd:CONST.MEMBER_ROLE_CD.VICE_CARD,
								preStore:data.datamap.baseInfo.prePrice,
								minCharge:data.datamap.baseInfo.pnPrice
							};
						OrderInfo.boProdAns.push(boProdAns);
						order.dealer.changeAccNbr("-"+(n+1),newSubPhoneNumsize[n]);//选号玩要刷新发展人管理里面的号码
					}
				}
			}
		}
		//新用户uim卡
		if(OrderInfo.mktResInstCode!=undefined && OrderInfo.mktResInstCode!=null && OrderInfo.mktResInstCode!="" && OrderInfo.mktResInstCode!="null" && OrderInfo.provinceInfo.reloadFlag=="Y"){
			var offerId = "-1";
			var mktResInstCodesize = OrderInfo.mktResInstCode.split(",");
			for(var u=0;u<mktResInstCodesize.length;u++){
				if(mktResInstCodesize[u]!=""&&mktResInstCodesize[u]!=null&&mktResInstCodesize[u]!="null"){
					var nbrAndUimCode = mktResInstCodesize[u].split("_");
					var _accNbr = nbrAndUimCode[0];
					var _uimCode = nbrAndUimCode[1];
					var newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
					for(var n=0;n<newSubPhoneNumsize.length;n++){
						if(newSubPhoneNumsize[n]==_accNbr){
//							$("#uim_txt_-"+(n+1)).attr("disabled",true);
							var uimParam = {
									"instCode":_uimCode
							};
							var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
							if (response.code==0) {
								if(response.data.mktResBaseInfo){
									if(response.data.mktResBaseInfo.statusCd=="1102"){
									
										$("#uim_check_btn_-"+(n+1)).attr("disabled",true);
										$("#uim_release_btn_-"+(n+1)).attr("disabled",false);
										$("#uim_release_btn_-"+(n+1)).removeClass("disabled");
										$("#uim_txt_-"+(n+1)).attr("disabled",true);
										$("#uim_txt_-"+(n+1)).val(_uimCode);
										var coupon = {
												couponUsageTypeCd : "3", //物品使用类型
												inOutTypeId : "1",  //出入库类型
												inOutReasonId : 0, //出入库原因
												saleId : 1, //销售类型
												couponId : response.data.mktResBaseInfo.mktResId, //物品ID
												couponinfoStatusCd : "A", //物品处理状态
												chargeItemCd : "3000", //物品费用项类型
												couponNum : response.data.mktResBaseInfo.qty, //物品数量
												storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
												storeName : "1", //仓库名称
												agentId : 1, //供应商ID
												apCharge : 0, //物品价格
												couponInstanceNumber : _uimCode, //物品实例编码
												terminalCode :_uimCode,//前台内部使用的UIM卡号
												ruleId : "", //物品规则ID
												partyId : OrderInfo.cust.custId, //客户ID
												prodId :  -(n+1), //产品ID
												offerId : offerId, //销售品实例ID
												state : "ADD", //动作
												relaSeq : "" //关联序列	
											};
										OrderInfo.clearProdUim(-(n+1));
										OrderInfo.boProd2Tds.push(coupon);
									}else{
										$.alert("提示","UIM卡不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
									}
								}else{
									$.alert("提示","查询不到UIM信息");
								}
							}else if (response.code==-2){
								$.alertM(response.data);
							}else {
								$.alert("提示","UIM信息查询接口出错,稍后重试");
							}
						}
					}
				}
			}
		}
	};
	
	
	
	
	function cleckUim(uim,prodId){
		var uimParam = {"instCode":uim};
		var response = $.callServiceAsJsonGet(contextPath+"/token/pc/mktRes/qrymktResInstInfo",uimParam);
		if (response.code==0) {
			if(response.data.mktResBaseInfo){
				if(response.data.mktResBaseInfo.statusCd=="1102"){
				//	$("#uim_check_btn_-"+(n+1)).attr("disabled",true);
				//	$("#uim_check_btn_-"+(n+1)).removeClass("purchase").addClass("disablepurchase");
				//	$("#uim_release_btn_-"+(n+1)).attr("disabled",false);
				//	$("#uim_release_btn_-"+(n+1)).removeClass("disablepurchase").addClass("purchase");
					$("#uim_txt_"+prodId).val(uim);
					var coupon = {
							couponUsageTypeCd : "5", //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
							inOutTypeId : "1",  //出入库类型
							inOutReasonId : 0, //出入库原因
							saleId : 1, //销售类型
							couponId :response.data.mktResBaseInfo.mktResId, //物品ID
							couponinfoStatusCd : "A", //物品处理状态
							chargeItemCd : CONST.CHARGE_ITEM_CD.COUPON_SALE, //物品费用项类型
							couponNum : 1, //物品数量
							storeId : response.data.mktResBaseInfo.mktResStoreId, //仓库ID
							storeName : "1", //仓库名称
							agentId : 1, //供应商ID
							apCharge : 0, //物品价格
							couponInstanceNumber : uim, //物品实例编码
							ruleId : "", //物品规则ID
							partyId : OrderInfo.cust.custId, //客户ID
							prodId : prodId, //产品ID
							offerId : -1, //销售品实例ID
							attachSepcId : OrderInfo.offerSpec.offerSpecId,
							state : "ADD", //动作
							relaSeq : "" //关联序列	
						};
					OrderInfo.clearProdUim(prodId);
					OrderInfo.boProd2Tds.push(coupon);
				}else{
					$.alert("提示","UIM卡["+uim+"]不是预占状态，当前为"+response.data.mktResBaseInfo.statusCd);
				}
			}else{
				$.alert("提示","查询不到UIM卡["+uim+"]信息");
			}
		}else if (response.code==-2){
			$.alertM(response.data);
		}else {
			$.alert("提示","UIM信息查询接口出错,稍后重试");
		}
	}
	//套餐变更提交组织报文
	var _changeOffer = function(busiOrders){
		_createDelOffer(busiOrders,OrderInfo.offer); //退订主销售品
		_createMainOffer(busiOrders,OrderInfo.offer); //订购主销售品	
		AttachOffer.setAttachBusiOrder(busiOrders);  //订购退订附属销售品
		if(CONST.getAppDesc()==0){ //4g系统需要,补换卡 
			if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //遍历主销售品构成
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
						if(OrderInfo.boProd2Tds.length>0){
							var prod = {
								prodId : this.objInstId,
								prodSpecId : this.objId,
								accessNumber : this.accessNumber,
								isComp : "N",
								boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
							};
							var busiOrder = OrderInfo.getProdBusiOrder(prod);
							if(busiOrder){
								busiOrders.push(busiOrder);
							}
						}
					}
				});
			}
		}
	};
			
	//创建退订主销售品节点
	var _createDelOffer = function(busiOrders,offer){	
		offer.offerTypeCd = 1;
		offer.boActionTypeCd = CONST.BO_ACTION_TYPE.DEL_OFFER;
		var prodInfo = order.prodModify.choosedProdInfo;
		OrderInfo.getOfferBusiOrder(busiOrders,offer, prodInfo.prodInstId);
	};
	

	//创建主销售品节点
	
	var _createMainOffer = function(busiOrders,offer) {
		var offerRole = getOfferRole();
		var prod = order.prodModify.choosedProdInfo;
		var offerSpec = OrderInfo.offerSpec;
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
				objId : offerSpec.offerSpecId,  //业务规格ID
				offerTypeCd : "1", //1主销售品
				accessNumber : prod.accNbr  //接入号码
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
			}, 
			data:{
				ooRoles : [],
				ooOwners : [{
					partyId : OrderInfo.cust.custId, //客户ID
					state : "ADD" //动作
				}]
			}
		};
		//遍历主销售品构成
		$.each(offerSpec.offerRoles,function(){
			var offerRole = this;
			if(this.prodInsts!=undefined){
				$.each(this.prodInsts,function(){
					var prodInstId = '"'+this.prodInstId+'"';
					if(prodInstId.indexOf("-")==-1){
						var ooRoles = {
							objId : this.objId, //业务规格ID
							objInstId : this.prodInstId, //业务对象实例ID,新装默认-1
							objType : this.objType, // 业务对象类型
							offerRoleId : offerRole.offerRoleId, //销售品角色ID
							state : "ADD" //动作
						};
						busiOrder.data.ooRoles.push(ooRoles);
					}
				});
			}
		});
		
		if(offerChange.oldMemberFlag){//纳入老用户
			var offerRoleId = "";
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
							offerRoleId = offerRole.offerRoleId;
							break;
				} 
			}
			for(var q=0;q<OrderInfo.oldprodInstInfos.length;q++){
				var oldprodInfo = OrderInfo.oldprodInstInfos[q];
				var oldbusiOrder = {
						areaId : oldprodInfo.areaId,  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							objId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferId,  //业务规格ID
							instId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferInstId, //业务对象实例ID
							accessNumber : oldprodInfo.accNbr, //业务号码
							isComp : "Y", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER
						}, 
						data:{
							ooRoles : []			
						}
					};
					var memberid = -1;
					for ( var i = 0; i < OrderInfo.oldoffer.length; i++) {
						if(OrderInfo.oldoffer[i].accNbr==oldprodInfo.accNbr){
							$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
								if(this.objType==CONST.OBJ_TYPE.PROD){
									var ooRole = {
										objId : this.objId,
										objInstId : this.objInstId,
										objType : this.objType,
										offerMemberId : memberid,
										offerRoleId : offerRoleId,
										state : "ADD"
									};
									busiOrder.data.ooRoles.push(ooRole);
									var oldooRole = {
											objId : this.objId,
											objInstId : this.objInstId,
											objType : this.objType,
											offerMemberId : this.offerMemberId,
											offerRoleId : this.offerRoleId,
											state : "DEL"
										};
									oldbusiOrder.data.ooRoles.push(oldooRole);
									--memberid;
								}
							});
						}
					}
				busiOrders.push(oldbusiOrder);
			}
			if(CONST.getAppDesc()==0){ //4g系统需要,补换卡 
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) { //遍历主销售品构成
					$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
							if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
								var prod = {
									prodId : this.objInstId,
									prodSpecId : this.objId,
									accessNumber : this.accessNumber,
									isComp : "N",
									boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
								};
								var busiOrder1 = OrderInfo.getProdBusiOrder(prod);
								if(busiOrder1){
									busiOrders.push(busiOrder1);
								}
							}
						}
					});
				}
			}
		}
		if(offerChange.newMemberFlag){
			//遍历主销售品构成
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
					if(offerRole.prodInsts!=undefined && offerRole.prodInsts.length>0){
						for ( var j = 0; j < offerRole.prodInsts.length; j++) {
							var prodInst = offerRole.prodInsts[j];
							var instid = '"'+prodInst.prodInstId+'"';
							if(prodInst.memberRoleCd=="401" && instid.indexOf("-")!=-1){
								var ooRole = {
									objId : prodInst.objId,
									objInstId : prodInst.prodInstId,
									objType : prodInst.objType,
									offerMemberId : OrderInfo.SEQ.offerMemberSeq--,
									offerRoleId : prodInst.offerRoleId,
									state : "ADD"
								};
								busiOrder.data.ooRoles.push(ooRole);
								busiOrders.push(SoOrder.createProd(prodInst.prodInstId,prodInst.objId));	
							}
						}
					}
				} 
			} 
		}

		//销售参数节点
		if(ec.util.isArray(offerSpec.offerSpecParams)){  
			busiOrder.data.ooParams = [];
			for (var i = 0; i < offerSpec.offerSpecParams.length; i++) {
				var param = offerSpec.offerSpecParams[i];
				var ooParam = {
	                itemSpecId : param.itemSpecId,
	                offerParamId : OrderInfo.SEQ.paramSeq--,
	                offerSpecParamId : param.offerSpecParamId,
	                value : param.value,
	                state : "ADD"
	            };
	            busiOrder.data.ooParams.push(ooParam);
			}				
		}
		
		//销售生失效时间节点
		if(offerSpec.ooTimes !=undefined ){
			busiOrder.data.ooTimes = [];
			busiOrder.data.ooTimes.push(offerSpec.ooTimes);
		}
		
		//发展人
		busiOrder.data.busiOrderAttrs = [];
		var $tr = $("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");
		if($tr!=undefined){
			$tr.each(function(){   //遍历产品有几个发展人
				var dealer = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
					role : $(this).find("select").val(),
					value : $(this).find("input").attr("staffid"),
					channelNbr : $(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()
				};
				busiOrder.data.busiOrderAttrs.push(dealer);
				var dealer_name = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("value") 
				};
				busiOrder.data.busiOrderAttrs.push(dealer_name);
			});
		}
	//	AttachOffer.setAttachBusiOrder(busiOrders);//添加附属
		busiOrders.push(busiOrder);
	};
	
	var getOfferRole = function(){
		//新套餐是主副卡,获取主卡角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){  //主卡
				return offerRole;
			}
		}
		//新套餐不是主副卡，返回第一个包含接入产品的角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			for (var j = 0; j < offerRole.roleObjs.length; j++) {
				var roleObj = offerRole.roleObjs[j];
				if(roleObj.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
					return offerRole;
				}
			}
		}
	};
	//填单页面切换
	var _changeTab = function(prodId) {
		/*
		$.each($("#tab_"+prodId).parent().find("li"),function(){
			$(this).removeClass("setcon");
			$("#attach_tab_"+$(this).attr("prodId")).hide();
			$("#uimDiv_"+$(this).attr("prodId")).hide();
		});
		$("#tab_"+prodId).addClass("setcon");
		$("#attach_tab_"+prodId).show();
		if(AttachOffer.isChangeUim(prodId)){
			$("#uimDiv_"+prodId).show();
		}
		*/
	};
	
	//省里校验单
	var _checkOrder = function(prodId){
		if(OrderInfo.actionFlag==3){
			_getAttachOfferInfo();
		}else{
			_getChangeInfo();
		}
		var data = query.offer.updateCheckByChange(JSON.stringify(OrderInfo.orderData));
		OrderInfo.orderData.orderList.custOrderList[0].busiOrder = []; //校验完清空	
		if(data==undefined){
			return false;
		}
		if(data.resultCode==0 && ec.util.isObj(data.result)){ //预校验成功
			offerChange.resultOffer = data.result;
		}else {
			$.alert("预校验规则限制",data.resultMsg);
			offerChange.resultOffer = {}; 
			return false;
		}
		return true;
	};
	
	//3G套餐订购4G流量包时预校验的入参封装
	var _getAttachOfferInfo=function(){
		OrderInfo.getOrderData(); //获取订单提交节点	
		OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		var busiOrders = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;//获取业务对象数组
		//遍历已开通附属销售品列表
		for ( var i = 0; i < AttachOffer.openList.length; i++) {
			var open = AttachOffer.openList[i];
			for ( var j = 0; j < open.specList.length; j++) {  //遍历当前产品下面的附属销售品
				var spec = open.specList[j];
				if(spec.isdel != "Y" && spec.isdel != "C" && spec.ifPackage4G=="Y"){  //订购的附属销售品
					spec.offerTypeCd = 2;
					spec.boActionTypeCd = CONST.BO_ACTION_TYPE.BUY_OFFER;
					spec.offerId = OrderInfo.SEQ.offerSeq--; 
					OrderInfo.getOfferBusiOrder(busiOrders,spec,open.prodId);	
				}
			}
		}
		$.each(busiOrders,function(){
			this.busiObj.state="ADD";
		});
	};
	
	//把旧套餐的产品自动匹配到新套餐中，由于现在暂时只支持主副卡跟单产品，所以可以自动匹配
	var _setChangeOfferSpec = function(memberNum,viceNum){
		if(memberNum==1){ //单产品变更
			var offerRole = getOfferRole();
			if(offerRole==undefined){
				alert("错误提示","无法变更到该套餐");
				return false;
			}
			offerRole.prodInsts = [];
			var flag=false;
			$.each(offerRole.roleObjs,function(){
				if(this.objType==CONST.OBJ_TYPE.PROD){
					var roleObj = this;
					flag=false;
					$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
						if(this.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
							if(roleObj.objId!=this.objId){
								$.alert("规则限制","新套餐【"+roleObj.offerRoleName+"】角色的规格ID【"+roleObj.objId+"】和旧套餐【"+this.roleName+"】角色的规格ID【"+this.objId+"】不一样");
								flag=true;
								return false;
							}
							roleObj.prodInstId = this.objInstId;
							roleObj.accessNumber = this.accessNumber;
							offerRole.prodInsts.push(roleObj);
						}
					});
					if(flag){
						return false;
					}
				}
			});
			if(flag){
				return false;
			}
		}else{  //多成员角色
			for (var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[i];
				if(offerMember.objType==CONST.OBJ_TYPE.PROD){
					var flag = true;
					for (var j = 0; j < OrderInfo.offerSpec.offerRoles.length; j++) {
						var offerRole = OrderInfo.offerSpec.offerRoles[j];
						if(offerMember.roleCd==offerRole.memberRoleCd){ //旧套餐对应新套餐角色
							for (var k = 0; k < offerRole.roleObjs.length; k++) {
								var roleObj = offerRole.roleObjs[k];
								if(roleObj.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
									if(roleObj.objId!=offerMember.objId){
										$.alert("规则限制","新套餐【"+roleObj.offerRoleName+"】角色的规格ID【"+roleObj.objId+"】和旧套餐【"+offerMember.roleName+"】角色的规格ID【"+offerMember.objId+"】不一样");
										return false;
									}
									if(!ec.util.isArray(offerRole.prodInsts)){
										offerRole.prodInsts = [];
									}
									var newObject = jQuery.extend(true, {}, roleObj); 
									newObject.prodInstId = offerMember.objInstId;
									newObject.accessNumber = offerMember.accessNumber;
									offerRole.prodInsts.push(newObject);
									if(offerRole.prodInsts.length>roleObj.maxQty){
										$.alert("规则限制","新套餐【"+offerRole.offerRoleName+"】角色最多可以办理数量为"+roleObj.maxQty+",而旧套餐数量大于"+roleObj.maxQty);
										return false;
									}
									break;
								}
							}
							flag = false;
							break;
						}
					}
					if(flag){
						$.alert("规则限制","旧套餐【"+offerMember.roleName+"】角色在新套餐中不存在，无法变更");
						return false;
					}
				}
			}
		}
		return true;
	};
	
	//获取单产品变更自动匹配的角色
	var getOfferRole = function(){
		//新套餐是主副卡,获取主卡角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){  //主卡
				return offerRole;
			}
		}
		//新套餐不是主副卡，返回第一个包含接入产品的角色
		for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
			var offerRole = OrderInfo.offerSpec.offerRoles[i];
			for (var j = 0; j < offerRole.roleObjs.length; j++) {
				var roleObj = offerRole.roleObjs[j];
				if(roleObj.objType==CONST.OBJ_TYPE.PROD){  //接入类产品
					return offerRole;
				}
			}
		}
	};
	
	//获取套餐变更节点
	var _getChangeInfo = function(){
		OrderInfo.getOrderData(); //获取订单提交节点	
		OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		OrderInfo.orderData.orderList.orderListInfo.areaId = OrderInfo.cust.areaId;
		var busiOrders = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;//获取业务对象数组
		_createDelOffer(busiOrders,OrderInfo.offer); //退订主销售品
		_createMainOffer(busiOrders,OrderInfo.offer); //订购主销售品	
	};
	
	//根据省内返回的数据校验
	var _checkOfferProd = function(){
		if(offerChange.resultOffer==undefined){
			return;
		}
		//功能产品
		var prodInfos = offerChange.resultOffer.prodInfos;
		if(ec.util.isArray(prodInfos)){
			$.each(prodInfos,function(){
				var prodId = this.accProdInstId;
				//容错处理，省份接入产品实例id传错
				var flag = true;
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var serv = CacheData.getServ(prodId,this.prodInstId);
					if(this.state=="DEL"){
						if(serv!=undefined){
							var $span = $("#li_"+prodId+"_"+this.prodInstId).find("span");
							$span.addClass("del");
							serv.isdel = "Y";
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined){  //在已开通里面，修改不让关闭
							$("#del_"+prodId+"_"+this.prodInstId).hide();
						}else{
							var servSpec = CacheData.getServSpec(prodId,this.productId); //已开通里面查找
							if(servSpec!=undefined){
								$("#del_"+prodId+"_"+this.productId).hide();
							}else {
								if(this.productId!=undefined && this.productId!=""){
									//AttachOffer.addOpenServList(prodId,this.productId,this.prodName,this.ifParams);
									AttachOffer.openServSpec(prodId,this.productId);
								}
							}
						}
					}
				}
			});
		}
		
		//可选包
		var offers = offerChange.resultOffer.prodOfferInfos;
		if(ec.util.isArray(offers)){
			if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){//多产品套餐
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					var prodId = this.objInstId;
					$.each(offers,function(){
						if(this.memberInfo==undefined){
							return true;
						}
						var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已开通里面查找
						var flag = true;
						$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
							if(prodId == this.accProdInstId){		
								if(ec.util.isObj(offer)){
									this.prodId = this.accProdInstId;
//									offer.offerMemberInfos = [];
//									offer.offerMemberInfos.push(this);
								}
								flag = false;
								return false;
							}
						});
						if(flag){
							return true;
						}
						if(this.state=="DEL"){
							if(offer!=undefined){
								var $span = $("#li_"+prodId+"_"+this.prodOfferInstId).find("span");
								$span.addClass("del");
								offer.isdel = "Y";
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}	
						}else if(this.state=="ADD"){
							if(offer!=undefined){ //在已开通里面，修改不让关闭
								$("#del_"+prodId+"_"+this.prodOfferInstId).hide();
							}else{
								var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已开通里面查找
								if(offerSpec!=undefined){
									$("#del_"+prodId+"_"+this.prodOfferId).hide();
								}else {
									if(ec.util.isObj(this.prodOfferId) && this.prodOfferId!=OrderInfo.offerSpec.offerSpecId){
										//AttachOffer.addOpenList(prodId,this.prodOfferId);			
										AttachOffer.addOfferSpecByCheck(prodId,this.prodOfferId);
									}
								}
							}
						}
					});
				});
			}
		}
	};
	
	//根据省内返回的数据校验拼成html
	var _checkAttachOffer = function(prodId){
		var content="";
		if(offerChange.resultOffer==undefined){
			return content;
		}
		//功能产品
		var prodInfos = offerChange.resultOffer.prodInfos;
		if(ec.util.isArray(prodInfos)){
			var str = "";
			$.each(prodInfos,function(){
//				var prodId = this.accProdInstId;
//				//容错处理，省份接入产品实例id传错
//				var flag = true;
//				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历旧套餐构成
//					if(this.objType==CONST.OBJ_TYPE.PROD && this.objInstId==prodId){  //接入类产品
//						flag = false;
//						return false;
//					}
//				});
				if(prodId!=this.accProdInstId){
					return true;
				}
				if(prodId!=this.prodInstId){ //功能产品
					var serv = CacheData.getServ(prodId,this.prodInstId);//已开通功能产品里面查找
					var servSpec = CacheData.getServSpec(prodId,this.productId);//已选功能产品里面查找
					if(this.state=="DEL"){
						if(serv!=undefined){
							str+='<li id="li_'+prodId+'_'+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N">'
									+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
									+'<span class="del">'+serv.servSpecName+'</span>'
								+'</li>';
						}else{
							if(servSpec!=undefined){
								str+='<li id="li_'+prodId+'_'+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N">'
										+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
										+'<span class="del">'+servSpec.servSpecName+'</span>'
									+'</li>';
							}else if(this.productName!=undefined && this.productName!=""){
								str+='<li id="li_'+prodId+'_'+this.prodInstId+'" offerspecid="" offerid="'+this.prodInstId+'" isdel="N">'
										+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
										+'<span class="del">'+this.productName+'</span>'
									+'</li>';
							}
						}	
					}else if(this.state=="ADD"){
						if(serv!=undefined){
							str+='<li id="li_'+prodId+'_'+this.prodInstId+'">'
									+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
									+'<span>'+serv.servSpecName+'</span>'
									+'<dd class="mustchoose"></dd>'
								+'</li>';
						}else{
							if(servSpec!=undefined){
								str+='<li id="li_'+prodId+'_'+this.prodInstId+'">'
										+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
										+'<span>'+servSpec.servSpecName+'</span>'
										+'<dd class="mustchoose"></dd>'
									+'</li>';
							}else if(this.productName!=undefined && this.productName!=""){
								str+='<li id="li_'+prodId+'_'+this.prodInstId+'">'
										+'<dd id="del_'+prodId+'_'+this.prodInstId+'" class="delete"></dd>'
										+'<span>'+this.productName+'</span>'
										+'<dd class="mustchoose"></dd>'
									+'</li>';
								}
						}
					}
				}
			});
			if(str==""){
				content="";
			}else{
				content="<div class='fs_choosed'>订购4G流量包，需订购和取消如下功能产品：<br><ul>"+str+"</ul></div><br>";
			}
		}
		
		
		//可选包
		var offers = offerChange.resultOffer.prodOfferInfos;
		if(ec.util.isArray(offers)){
			var str="";
			$.each(offers,function(){
				if(this.memberInfo==undefined){
					return true;
				}
				var flag = true;
				$.each(this.memberInfo,function(){  //寻找该销售品属于哪个产品
					if(ec.util.isObj(this.accProdInstId)&&prodId == this.accProdInstId){
						flag = false;
						return false;
					}
				});
				if(flag){
					return true;
				}
				var offer = CacheData.getOffer(prodId,this.prodOfferInstId); //已订购里面查找
				var offerSpec = CacheData.getOfferSpec(prodId,this.prodOfferId); //已选里面查找
				if(this.state=="DEL"){
					if(offer!=undefined){
						str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N">'
								+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
								+'<span class="del">'+offer.offerSpecName+'</span>'
							+'</li>';
					}else{
						if(offerSpec!=undefined){
							str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N">'
									+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
									+'<span class="del">'+offerSpec.offerSpecName+'</span>'
								+'</li>';
						}else if(this.prodOfferName!=undefined && this.prodOfferName!=""){
							str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'" offerspecid="" offerid="'+this.prodOfferInstId+'" isdel="N">'
									+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
									+'<span class="del">'+this.prodOfferName+'</span>'
								+'</li>';
						}
					}	
				}else if(this.state=="ADD"){
					if(offer!=undefined){
						str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'">'
								+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
								+'<span>'+offer.offerSpecName+'</span>'
								+'<dd class="mustchoose"></dd>'
							+'</li>';
					}else{
						if(offerSpec!=undefined){
							str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'">'
									+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
									+'<span>'+offerSpec.offerSpecName+'</span>'
									+'<dd class="mustchoose"></dd>'
								+'</li>';
						}else if(this.prodOfferName!=undefined && this.prodOfferName!=""){
							str+='<li id="li_'+prodId+'_'+this.prodOfferInstId+'">'
									+'<dd id="del_'+prodId+'_'+this.prodOfferInstId+'" class="delete"></dd>'
									+'<span>'+this.prodOfferName+'</span>'
									+'<dd class="mustchoose"></dd>'
								+'</li>';
						}
					}
				}
			});
			if(str!=""){
				content+="<div class='fs_choosed'>订购4G流量包，需开通和关闭如下可选包：<br><ul>"+str+"</ul></div>";
			}
		}
		
		return content;
	};
	//初始化主副卡标签
	var _initOfferLabel = function() {
		//主副卡标签
		$(".many li").bind("click", function () {
			var index = $(this).index();
			var divs = $("#tabs-body .ordercona");
			$(this).parent().children("li").attr("class", "tab-nav");//将所有选项置为未选中
			$(this).attr("class", "tab-nav-action"); //设置当前选中项为选中样式
			divs.hide();//隐藏所有选中项内容
			divs.eq(index).show(); //显示选中项对应内容
		});
	};
	
	//初始化省内订单属性
	var _initOrderProvAttr = function(){
		//var obj=$("#orderProvAttrIsale").val;
		if($("#orderProvAttrIsale")){
			$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale);
		}
		var url=contextPath+"/order/provOrderAttrFlag";
		$.ecOverlay("<strong>正在查询是否显示省内订单属性,请稍后....</strong>");
		var response = $.callServiceAsJsonGet(url,{});	
		$.unecOverlay();
		if (response.code==0) {
			if(response.data!=undefined){
				if("0"==response.data){
					$("#orderProvAttrDiv").show();
					if(order.memberChange.reloadFlag=="N"){
						var custOrderAttrs = order.memberChange.rejson.orderList.orderListInfo.custOrderAttrs;
						$.each(custOrderAttrs,function(){
							//省内订单属性
							if(this.itemSpecId==CONST.BUSI_ORDER_ATTR.PROV_ISALE){
								$("#orderProvAttrIsale").val(OrderInfo.provinceInfo.provIsale);
							}
						});
					}
				}
			}
		}
	};
	
	return {
		initOfferLabel:_initOfferLabel,
		init 					: _init,
		changeOffer 			: _changeOffer,
		offerChangeView			: _offerChangeView,
		changeTab				: _changeTab,
		checkOrder				: _checkOrder,
		checkAttachOffer		: _checkAttachOffer,
		fillOfferChange			: _fillOfferChange,
		resultOffer				: _resultOffer,
		checkOfferProd			: _checkOfferProd,
		getChangeInfo			: _getChangeInfo,
		setChangeOfferSpec		: _setChangeOfferSpec,
		initOrderProvAttr		: _initOrderProvAttr,
		newMemberFlag: _newMemberFlag,
	    oldMemberFlag:  _oldMemberFlag
	};
})();
/**
 * 受理订单对象
 * 
 * @author wukf
 */
CommonUtils.regNamespace("SoOrder");

/** 受理订单对象*/
SoOrder = (function() {
	
	//订单准备
	var _builder = function() {
		if(query.offer.loadInst()){  //加载实例到缓存
			SoOrder.initFillPage();
			return true;
		}else{
			return false;
		};
	};
	//主副卡订单确认信息
	var _viceParam="";
	//初始化填单页面，为规则校验类型业务使用
	var _initFillPage = function(){
		SoOrder.initOrderData();
		SoOrder.step(1); //显示填单界面
		OrderInfo.order.step=1;//订单页面
		_getToken(); //获取页面步骤
	}; 
	
	//初始化订单数据
	var _initOrderData = function(){
		OrderInfo.resetSeq(); //重置序列
		OrderInfo.resetData(); //重置 数据
		OrderInfo.orderResult = {}; //清空购物车
		OrderInfo.getOrderData(); //获取订单提交节点	
		OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		OrderInfo.orderData.orderList.orderListInfo.areaId = OrderInfo.getAreaId();
	};
	
	var _getCheckOperatSpec=function(){
		var url=contextPath+"/token/pc/order/getCheckOperatSpec";//获取是否有分段的权限
		var response = $.callServiceAsJson(url, {});
		OrderInfo.zcd_privilege=response.data;
	};
	
	//提交订单节点
	var _submitOrder = function(data) {
		_getCheckOperatSpec();
		if(_getOrderInfo(data)){
			//订单提交
			var url = contextPath+"/token/pad/order/orderSubmit";
			if(OrderInfo.order.token!=""){
				url = contextPath+"/token/pad/order/orderSubmit?token="+OrderInfo.order.token;
			}

			$.callServiceAsJson(url,JSON.stringify(OrderInfo.orderData), {
				"before":function(){
					$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
				},"always":function(){
					$.unecOverlay();
				},	
				"done" : function(response){
					_getToken();
					if (response.code == 0) {
						var data = response.data;
						var ruleInfos=data.result.ruleInfos;
						if(ruleInfos!=undefined && ruleInfos.length > 0){							var ruleDesc = "";
							$.each(data.result.ruleInfos, function(){
								ruleDesc += this.ruleDesc+"<br/>";
							});
							$.alert("提示",ruleDesc);
							OrderInfo.orderData.orderList.custOrderList[0].busiOrder = [];
							OrderInfo.resetSeq(); //重置序列
						}else if(data.checkRule!=undefined){
							var provCheckResult = order.calcharge.tochargeSubmit(response.data);
							//var provCheckResult = {code:0};
							if(provCheckResult.code==0){
								var returnData = _gotosubmitOrder(response.data);
								_orderConfirm(returnData);
							}else{//下省校验失败也将转至订单确认页面，展示错误信息，只提供返回按钮
								response.data.provCheckError = "Y";
								if(provCheckResult.data.resultMsg!=undefined && $.trim(provCheckResult.data.resultMsg)!=""){
									response.data.provCheckErrorMsg = provCheckResult.data.resultMsg;
								} else if(provCheckResult.data.errMsg!=undefined && $.trim(provCheckResult.data.errMsg)!=""){
									response.data.provCheckErrorMsg = provCheckResult.data.errMsg;
									if(provCheckResult.data.errCode){
										response.data.provCheckErrorMsg = "【错误编码："+provCheckResult.data.errCode+"】" + response.data.provCheckErrorMsg;
									}
									if(provCheckResult.data.errData){
										response.data.provCheckErrorData=provCheckResult.data.errData;
//										try{
//											var errData=$.parseJSON(provCheckResult.data.errData);
//											if(response.data.provCheckErrorData){
												response.data.provCheckErrorMsg+=","+response.data.provCheckErrorData;
//											}
//										}catch(e){
//											
//										}
									}
									if(provCheckResult.data.paramMap){
										response.data.provCheckErrorMsg += "【入参："+provCheckResult.data.paramMap+"】";
									}
								} else{
									response.data.provCheckErrorMsg = "未返回错误信息，可能是下省请求超时，请返回填单页面并稍后重试订单提交。";
								}
								var returnData = _gotosubmitOrder(response.data);
								_orderConfirm(returnData);								
							}
						}else{
							var returnData = _gotosubmitOrder(response.data);
							_orderConfirm(returnData);
						}
					}else{
						$.alertM(response.data);
//						_getToken();
						OrderInfo.orderData.orderList.custOrderList[0].busiOrder = [];
						OrderInfo.resetSeq(); //重置序列
					}
				}
			});
//					var result = query.offer.orderSubmit(JSON.stringify(OrderInfo.orderData));
//					if(result){
//						_orderConfirm(result);
//					}else{
//						_getToken();
//						OrderInfo.orderData.orderList.custOrderList[0].busiOrder = [];
//						OrderInfo.resetSeq(); //重置序列
//					}
		}	
	};

	
	var _gotosubmitOrder = function(orderdata){
		//order[2]
		var url = contextPath+"/token/pad/order/gotosubmitOrder";
		$.ecOverlay("<strong>订单提交中，请稍等...</strong>");
		var response = $.callServiceAsHtml(url,JSON.stringify(orderdata));
		$.unecOverlay();
		return response.data;
	};

	
	
	//填充订单信息
	var _getOrderInfo = function(data){
		if(OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){ //终端购买、退换货
			//如果是合约机换货，已经加载缓存
			if (OrderInfo.actionFlag==18 && data.boActionType.actionClassCd==CONST.ACTION_CLASS_CD.OFFER_ACTION) {
				
			} else {
				query.offer.loadInst(); //加载实例到缓存
			}
			couponSale(data);
			if(OrderInfo.order.soNbr!=undefined && OrderInfo.order.soNbr != ""){  //缓存流水号
				OrderInfo.orderData.orderList.orderListInfo.soNbr = OrderInfo.order.soNbr;
			}
			return true;
		}
		var busiOrders = [];  //存放订单项数组
		var custOrderAttrs = []; //获取订单属性数组
		var itemValue="N";
		if(_setOfferType()){
			itemValue="Y";
		}
		custOrderAttrs.push({
			itemSpecId : CONST.BUSI_ORDER_ATTR.THRETOFOUR_ITEM,//3转4标志
			value : itemValue
		});
		custOrderAttrs.push({
			itemSpecId : "111111113",
			value : OrderInfo.orderlonger
		});	
		custOrderAttrs.push({
			itemSpecId : "30010024",
			value : OrderInfo.busitypeflag
		});
		custOrderAttrs.push({
			itemSpecId : "30010050",
			value : OrderInfo.custorderlonger
		});	
		
		if(OrderInfo.zcd_privilege=='0'){
			custOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.ZCD_ITEM,//是否是暂存单
				value : 0
			});
		}
		if(ec.util.isObj(OrderInfo.order.soNbr)){
			custOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.SO_NBR,//全量查询的soNbr
				value : OrderInfo.order.soNbr
			});
		}
		
		//添加订单属性，isale下省流水号
//		if(order.cust.fromProvFlag == "1"){
		order.cust.provIsale = $.trim($("#orderProvAttrIsale").val());
		if(ec.util.isObj(order.cust.provIsale)){
			order.cust.fromProvFlag = "1";
			custOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.PROV_ISALE,
				value : order.cust.provIsale
			});	
		} else {
			order.cust.fromProvFlag = "0";
		}
//		}
		if(!_checkData()){ //校验通过
			return false;
		}
		//订单备注前置
		var remark = $('#order_remark').val(); 
		if(ec.util.isObj(remark)){
			custOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
				value : remark
			});	
		}
		
		if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14){ //新装
			_createOrder(busiOrders); //新装
		}else if (OrderInfo.actionFlag==2){ //套餐变更
			offerChange.changeOffer(busiOrders);	
		}else if (OrderInfo.actionFlag==3){ //可选包变更		
			_createAttOrder(busiOrders); //附属销售品变更
			if(busiOrders.length==0){
				$.alert("提示","没有做任何业务，无法提交");
				return false;
			}
		}else if (OrderInfo.actionFlag==4){ //客户资料变更
			_createCustOrder(busiOrders,data); //附属销售品变更
		}else if (OrderInfo.actionFlag==5){//销售品成员变更拆副卡
			_delViceCard(busiOrders,data);
		}else if (OrderInfo.actionFlag==6){ //销售品成员变更加装副卡
			_createMainOrder(busiOrders); 
		}else if (OrderInfo.actionFlag==7){ //拆主卡保留副卡
			_delAndNew(busiOrders,data); 
		}else if (OrderInfo.actionFlag==8){ //新建客户单独订单
			_createCustOrderOnly(busiOrders,data);
		}else if (OrderInfo.actionFlag==9){ //活卡销售返档
			_ActiveReturnOrder(busiOrders,data); 
		}else if (OrderInfo.actionFlag==10){ //传到节点busiOrder 
			busiOrders = data;
		}else if (OrderInfo.actionFlag==11){ //撤单,有做特殊处理
			busiOrders = data;
		}else if (OrderInfo.actionFlag==12){ //加入退出组合
			busiOrders = data;
		}else if(OrderInfo.actionFlag==16){ //改号
			_changeNumber(busiOrders);	
		}else if(OrderInfo.actionFlag==19){ //返销
			_fillBusiOrder(busiOrders,data,"N"); //填充业务对象节点	
		}else if(OrderInfo.actionFlag==20){ //返销
			_delAndNew(busiOrders,data); 
		}else if(OrderInfo.actionFlag==21){ //销售品成员变更保留副卡订购新套餐
			_delViceCardAndNew(busiOrders,data);
		}else if(OrderInfo.actionFlag== 22 ){ //补换卡
			busiOrders = data;
		}else if(OrderInfo.actionFlag == 23){//异地补换卡
			busiOrders = data;
			//异地补换卡的订单地区为受理工号当前的受理地区而不是定位客户的受理地区
			OrderInfo.orderData.orderList.orderListInfo.areaId = OrderInfo.staff.areaId;
			//外部客户ID
			var corCustId = $("#custInfos").attr("corCustId");
			if(ec.util.isObj(corCustId)){
				var custOrderAttr1 = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.COR_CUST_ID,
					value : corCustId
				};
				custOrderAttrs.push(custOrderAttr1);
			}
			//省内客户ID
			var extCustId = $("#custInfos").attr("extCustId");
			if(ec.util.isObj(extCustId)){
				var custOrderAttr2 = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.EXT_CUST_ID,
					value : extCustId
				};
				custOrderAttrs.push(custOrderAttr2);
			}
			//省内产品实例ID
			var extProdInstId = order.prodModify.choosedProdInfo.extProdInstId;
			if(ec.util.isObj(extProdInstId)){
				var custOrderAttr3 = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.EXT_PROD_INST_ID,
						value : extProdInstId
				};
				custOrderAttrs.push(custOrderAttr3);
			}
			//外部产品实例ID
			var corProdInstId = order.prodModify.choosedProdInfo.corProdInstId;
			if(ec.util.isObj(corProdInstId)){
				var custOrderAttr4 = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.COR_PROD_INST_ID,
						value : corProdInstId
				};
				custOrderAttrs.push(custOrderAttr4);
			}
			//营销资源省内实例ID
			var extCouponInstanceId = order.prodModify.choosedProdInfo.extCouponInstanceId;
			if(ec.util.isObj(extCouponInstanceId)){
				var custOrderAttr5 = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.EXT_COUPON_INST_ID,
						value : extCouponInstanceId
				};
				custOrderAttrs.push(custOrderAttr5);
			}
			//营销资源外部实例ID
			var corCouponInstanceId = order.prodModify.choosedProdInfo.corCouponInstanceId;
			if(ec.util.isObj(corCouponInstanceId)){
				var custOrderAttr6 = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.COR_COUPON_INST_ID,
						value : corCouponInstanceId
				};
				custOrderAttrs.push(custOrderAttr6);
			}
		}else{  //默认单个业务动作
			_fillBusiOrder(busiOrders,data,"N"); //填充业务对象节点
		}
		OrderInfo.orderData.orderList.orderListInfo.custOrderAttrs = custOrderAttrs; //订单属性数组
		OrderInfo.orderData.orderList.orderListInfo.extCustOrderId = OrderInfo.provinceInfo.provIsale; //省份流水
		OrderInfo.orderData.orderList.custOrderList[0].busiOrder = busiOrders; //订单项数组
		OrderInfo.orderData.orderList.orderListInfo.extCustOrderId = OrderInfo.provinceInfo.provIsale; //省份流水
		if($("#isTemplateOrder").attr("checked")=="checked"){ //批量订单
			OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder ="Y";
			OrderInfo.orderData.orderList.orderListInfo.templateOrderName =$("#templateOrderName").val();
			if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){
				OrderInfo.orderData.orderList.orderListInfo.templateType = $("#templateOrderDiv").find("select").val(); //批量换挡
			}else if(OrderInfo.actionFlag==2){
				OrderInfo.orderData.orderList.orderListInfo.templateType = 5; //批量换挡
			}else if(OrderInfo.actionFlag==3){
				OrderInfo.orderData.orderList.orderListInfo.templateType = 2; //批量可选包订购退订
			}
		}else{
			OrderInfo.orderData.orderList.orderListInfo.isTemplateOrder ="N";
		}
		if(OrderInfo.order.soNbr!=undefined && OrderInfo.order.soNbr != ""){  //缓存流水号
			OrderInfo.orderData.orderList.orderListInfo.soNbr = OrderInfo.order.soNbr;
		}
		return true;
	};
	
	//终端销售
	var couponSale = function(data){
		var coupons = data.coupons;
		OrderInfo.getOrderData(); //获取订单提交节点
		//新建客户、或是老客户、或是虚拟客户
		var busiOrders = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;//获取业务对象数组
		if (OrderInfo.cust.custId == -1) {
			OrderInfo.createCust(busiOrders);
		} else if (OrderInfo.cust.custId != undefined && OrderInfo.cust.custId != "") {
			OrderInfo.orderData.orderList.orderListInfo.partyId = OrderInfo.cust.custId;
		} else {
			OrderInfo.orderData.orderList.orderListInfo.partyId = CONST.CUST_COUPON_SALE;
		}
		if (OrderInfo.actionFlag == 18) {
			OrderInfo.orderData.orderList.orderListInfo.partyId = coupons[0].partyId;
		}
		//填入订单
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : data.busiObj,  
			boActionType : data.boActionType, 
			data:{
				bo2Coupons:[]
			}
		};
		busiOrder.data.bo2Coupons = coupons;
		if (data.dealers) {
			busiOrder.data.busiOrderAttrs = data.dealers;
		}
		busiOrders.push(busiOrder);
	};
	
	//订单确认
	var _orderConfirm = function(data){
		SoOrder.step(2,data);
		//记录olId到cookie，用于取消订单
		SoOrder.delOrderBegin();
		
		if(OrderInfo.actionFlag==1 ||OrderInfo.actionFlag==14){ //新装
			$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">套餐名称：</div><div class="ui-block-b">'+OrderInfo.offerSpec.offerSpecName+'</div></div>');
			var $span = $("<span>订购</span>"+OrderInfo.offerSpec.offerSpecName);
			$("#tital").append($span);
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				$.each(this.prodInsts,function(){
					$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+this.offerRoleName+'号码：</div><div class="ui-block-b">'
							+OrderInfo.getProdAn(this.prodInstId).accessNumber+'</div></div>');
				});
			});
			if(offerChange.oldMemberFlag){
				for(var j=0;j<OrderInfo.oldoffer.length;j++){
					for ( var i = 0; i < OrderInfo.oldoffer[j].offerMemberInfos.length; i++) {
						var offerMember = OrderInfo.oldoffer[j].offerMemberInfos[i];
						if(offerMember.objType==CONST.OBJ_TYPE.PROD){
							//$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading">纳入副卡号码</h4><p class="list-group-item-text">'+offerMember.accessNumber+'</p></li>');
							$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">纳入副卡号码：</div><div class="ui-block-b">'+offerMember.accessNumber+'</div></div> ');	
						}
					}
				}
			}
		}else if(OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){ //裸机销售
			$("#order_prepare").hide();
			$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端名称：</div><div class="ui-block-b">'+OrderInfo.businessName+'</div></div>');
			var busiOrder = OrderInfo.orderData.orderList.custOrderList[0].busiOrder;
			var bo2Coupons = undefined;
			if (OrderInfo.actionFlag==13) {
				for(var i=0; i<busiOrder.length; i++) {
					var boActionType = busiOrder[i].boActionType;
					if (boActionType.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION
							&& boActionType.boActionTypeCd==CONST.BO_ACTION_TYPE.COUPON_SALE) {
						bo2Coupons = busiOrder[i].data.bo2Coupons;
					}
				}
				$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端串码：</div><div class="ui-block-b">'+bo2Coupons[0].couponInstanceNumber+'</div></div>');
			} else if (OrderInfo.actionFlag==17) {
				for(var i=0; i<busiOrder.length; i++) {
					var boActionType = busiOrder[i].boActionType;
					if (boActionType.actionClassCd==CONST.ACTION_CLASS_CD.MKTRES_ACTION
							&& boActionType.boActionTypeCd==CONST.BO_ACTION_TYPE.RETURN_COUPON) {
						bo2Coupons = busiOrder[i].data.bo2Coupons;
					}
				}
				$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">终端串码：</div><div class="ui-block-b">'+bo2Coupons[0].couponInstanceNumber+'</div></div>');
			} else if (OrderInfo.actionFlag==18) {
				for(var i=0; i<busiOrder.length; i++) {
					var boActionType = busiOrder[i].boActionType;
					if (boActionType.boActionTypeCd==CONST.BO_ACTION_TYPE.EXCHANGE_COUPON) {
						bo2Coupons = busiOrder[i].data.bo2Coupons;
					}
				}
				var oldCoupon = null;
				var newCoupon = null;
				if (bo2Coupons[0].state=="DEL") {
					oldCoupon = bo2Coupons[0];
					newCoupon = bo2Coupons[1];
				} else {
					oldCoupon = bo2Coupons[1];
					newCoupon = bo2Coupons[0];
				}
				$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">旧终端串码：</div><div class="ui-block-b">'+oldCoupon.couponInstanceNumber+'</div></div>');
				$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新终端串码：</div><div class="ui-block-b">'+newCoupon.couponInstanceNumber+'</div></div>');
			}
			var $span = $("<span>"+OrderInfo.actionTypeName+"</span>"+OrderInfo.businessName);
			$("#tital").append($span);
		}else{ //二次业务
			var prod = order.prodModify.choosedProdInfo;
			$("#order_tab_panel_content").hide();
			$("#orderTbody").append('<div class="ui-grid-a" id="offerSpecName"><div class="ui-block-a">套餐名称：</div><div class="ui-block-b">'+prod.prodOfferName+'</div></div>');
			$("#orderTbody").append('<div class="ui-grid-a" id="accNbrTr"><div class="ui-block-a">手机号码：</div><div class="ui-block-b">'+prod.accNbr+'</div></div>');	
			if(OrderInfo.actionFlag==2){ //套餐变更 
				
                if(OrderInfo.provinceInfo.reloadFlag=="N"){
                	$("#order_tab_panel_content").show();
                }
                else if(OrderInfo.provinceInfo.prodOfferId!=null && OrderInfo.provinceInfo.prodOfferId!=""){
                	$("#order_tab_panel_content").show();
                }
                else{
                	$("#order_tab_panel_content").hide();
                }
				OrderInfo.actionTypeName = "套餐变更";
				$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新套餐名称：</div><div class="ui-block-b">'+OrderInfo.offerSpec.offerSpecName+'</div></div>');
				$("#accNbrTr").hide();
				for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) { //遍历主销售品构成
					var offerMember = OrderInfo.offer.offerMemberInfos[i];
					if(offerMember.objType==CONST.OBJ_TYPE.PROD){
						$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+offerMember.roleName+'号码：</div><div class="ui-block-b">'+offerMember.accessNumber+'</div></div>');	
					}
				}
				if(offerChange.newMemberFlag){
					$.each(OrderInfo.boProdAns,function(){
						$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">加装移动电话号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div>');
						//$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading">纳入副卡号码</h4><p class="list-group-item-text">'+this.accessNumber+'</p></li>');
					});
				}
				if(offerChange.oldMemberFlag){
					for(var j=0;j<OrderInfo.oldoffer.length;j++){
						for ( var i = 0; i < OrderInfo.oldoffer[j].offerMemberInfos.length; i++) {
							var offerMember = OrderInfo.oldoffer[j].offerMemberInfos[i];
							if(offerMember.objType==CONST.OBJ_TYPE.PROD){
								//$("#orderTbody").append('<li class="list-group-item" id="accNbrTr"> <h4 class="list-group-item-heading">纳入副卡号码</h4><p class="list-group-item-text">'+offerMember.accessNumber+'</p></li>');
								$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">纳入副卡号码：</div><div class="ui-block-b">'+offerMember.accessNumber+'</div></div> ');	
							}
						}
					}
				}
			}else if(OrderInfo.actionFlag==3){ //可选包变更 
				OrderInfo.actionTypeName = "订购/退订可选包与功能产品";
			}else if(OrderInfo.actionFlag==4||OrderInfo.actionFlag==8){ //客户资料变更与新建客户单独
				$("#offerSpecName").hide();
				$("#accNbrTr").hide();
			}else if(OrderInfo.actionFlag==5){  //主副卡成员变更拆除副卡
				$("#accNbrTr").hide();
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.objType==CONST.OBJ_TYPE.PROD){
						if(this.roleCd == CONST.MEMBER_ROLE_CD.VICE_CARD && this.isRemove=="Y"){
							$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除副卡号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div>');	
						}else {
							$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div>');	
						}
					}
				});
				OrderInfo.actionTypeName = "主副卡成员变更";
			}else if(OrderInfo.actionFlag==6){ //主副卡成员变更纳入副卡			
				$("#accNbrTr").hide();			
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.objType==CONST.OBJ_TYPE.PROD){
						$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div>');
					}
				});
				$.each(OrderInfo.boProdAns,function(){
					$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">纳入副卡号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div> ');	
				});
				if(ec.util.isArray(OrderInfo.oldAddNumList)){
					for(var i=0;i<OrderInfo.oldAddNumList.length;i++){
						$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">纳入副卡号码：</div><div class="ui-block-b">'+OrderInfo.oldAddNumList[i].accNbr+'</div></div> ');
					}
				}
				OrderInfo.actionTypeName = "主副卡成员变更";
			}else if(OrderInfo.actionFlag==7){ //主副卡拆机保留副卡
				$("#accNbrTr").hide();
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.objType==CONST.OBJ_TYPE.PROD){
						if(this.roleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD){
							$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div> ');	
						}else {
							var del="";
							var accessNumber=this.accessNumber;
							$.each(_viceParam,function(i,val){
								if(val.accessNumber==accessNumber&&val.del=="N"){
									del="N";
								}
							});
							if(del=="N"){
								$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div>');
							}else{
								$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div> ');	
							}
						}
					}
				});
				OrderInfo.actionTypeName = CONST.getBoActionTypeName(OrderInfo.boActionTypeCd);
			}else if(OrderInfo.actionFlag==21){ //主副卡成员变更
				if(ec.util.isArray(OrderInfo.viceOfferSpec)){
					$.each(OrderInfo.viceOfferSpec,function(){
						$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新套餐名称：</div><div class="ui-block-b">'+this.offerSpecName+'</div></div> ');	
					});
				}
				$("#accNbrTr").hide();
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.objType==CONST.OBJ_TYPE.PROD){
						if(this.roleCd != CONST.MEMBER_ROLE_CD.MAIN_CARD){
							var knew="";
							var del="";
							var objInstId=this.objInstId;
							$.each(_viceParam,function(i,val){
								if(val.objInstId==objInstId&&val.knew=="Y"){
									knew="Y";
								}
								if(val.objInstId==objInstId&&val.del=="Y"){
									del="Y";
								}
							});
							if(knew=="Y"){
								$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div>');
							}else if(del=="Y"){
								$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div>');	
							}
						}
					}
				});
				OrderInfo.actionTypeName = "主副卡成员变更";
			}else if(OrderInfo.actionFlag==20){ //主副卡拆机保留副卡
				$("#accNbrTr").hide();
				for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) { //遍历主销售品构成
					var offerMember = OrderInfo.offer.offerMemberInfos[i];
					if(offerMember.objType==CONST.OBJ_TYPE.PROD){
						if(offerMember.roleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD){
							$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+offerMember.roleName+'号码：</div><div class="ui-block-b">'+offerMember.accessNumber+'</div></div> ');	
						}else {
							$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">订购'+offerMember.roleName+'号码：</div><div class="ui-block-b">'+offerMember.accessNumber+'</div></div>');	
						}
					}
				}
				OrderInfo.actionTypeName = "返销";	
			}else if(OrderInfo.actionFlag==12){ //加入组合退出组合
				$("#accNbrTr").hide();
				for (var i = 0; i < OrderInfo.confirmList.length; i++) {
					var prod = OrderInfo.confirmList[i];
					for(var j = 0; j < prod.accNbr.length; j++){
						$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">'+prod.name+'：</div><div class="ui-block-b">'+prod.accNbr[j]+'</div></div>');
					}
				}
			}else if(OrderInfo.actionFlag==16){ //改号
				OrderInfo.actionTypeName = "改号";
				$.each(OrderInfo.boProdAns,function(){
					if(this.state=="ADD"){
						$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">新号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div>');	
					}
				});
			}else if(OrderInfo.actionFlag==0&&OrderInfo.actionTypeName=="拆机"){ //拆机
				$("#accNbrTr").hide();
				var isMainCard="";
				$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
					if(this.roleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD&&this.objInstId==order.prodModify.choosedProdInfo.prodInstId){
						isMainCard="Y";	
					}
				});
				if(isMainCard=="Y"){
					$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
							$("#orderTbody").append('<div class="ui-grid-a"><div class="ui-block-a">拆除'+this.roleName+'号码：</div><div class="ui-block-b">'+this.accessNumber+'</div></div>');	
					});
				}
				OrderInfo.actionTypeName = "拆机";
			}
			var $span = $("<span>"+OrderInfo.actionTypeName+"</span>");
			$("#tital").append($span);
		}
		
		var ruleFlag = true;
		if($("#ruleTbody tr").length>0){ //规则限制
			$("#ruleTbody tr").each(function (){
				var ruleLevel = $(this).attr("ruleLevel");
				if(ruleLevel == "1"){
					ruleFlag = false;
					return false; 
				}
			});
		}
		if(ruleFlag){
			if(OrderInfo.actionFlag==1 || OrderInfo.actionFlag==14){
				_showOrderOffer(); //显示订购的销售品
			}else if(OrderInfo.actionFlag==2){ //套餐变更 
				_showChangeAttach();
			}else if (OrderInfo.actionFlag==3){
				_showAttachOffer(); //显示订购的销售品
			}else if (OrderInfo.actionFlag==6){
				_showAddViceOffer(); //加装副卡显示订购的销售品
			}else if(OrderInfo.actionFlag==21 && order.memberChange.getSimulateData()){
				_showMemberChangeAttach();
			}else{
				if(OrderInfo.orderResult.autoBoInfos!=undefined&&OrderInfo.orderResult.autoBoInfos.length>0){
					$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));
					$.each(OrderInfo.orderResult.autoBoInfos,function(){
						$("#chooseTable").append($('<tr><td width="50%">'+this.specName+'</td><td>'+this.boActionTypeName+'</td></tr>'));
					});
				}
			}
		}
	};
	
	//显示步骤
	var _showStep = function(k,data) {
		for (var i = 1; i < 4; i++) {
			$("#step"+i).hide();
		}
		$("#step"+k).show();
	};
	
	//页面步骤,优化页面显示功能
	var _step = function(k,data){
		if(k==0){   //订单准备页面
			$("#orderedprod").hide();
			$("#order_prepare").hide();
			$("#order_fill_content").hide();
			$("#order_tab_panel_content").html(data).show();
			k++;
		}else if(k==1){  //订单填写页面
			//$("#orderedprod").hide();
			$("#order_prepare").hide();
			//$("#order_tab_panel_content").hide();
			$("#order_confirm").hide();
			$("#order_fill").show();
		}else if(k==2){ //订单确认填写页面
			//修改客户按钮隐藏
			if($("#a-cust-modify")[0]){
				$("#a-cust-modify").attr("style","display: none;");
			}
			//$("#main_conetent").hide();
			$("#order_fill").hide();
			
			$("#order_fill_content").hide();
			$("#order_confirm").html(data).show();	
			$.jqmRefresh($("#order_confirm"));
		}
		/*for (var i = 1; i < 4; i++) {
			$("#step"+i).hide();
		}
		$("#step"+k).show();*/
	};
	
	// 新装，显示订购的销售品
	var _showOrderOffer = function(){
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			$.each(this.prodInsts,function(){
				$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+')</th><th>业务动作</th></tr>'));			
				_showAttOffer(this.prodInstId);
			});
		});
		if(offerChange.oldMemberFlag){
			$.each(OrderInfo.oldoffer,function(){
				$.each(this.offerMemberInfos,function(){
					if(this.objType==CONST.OBJ_TYPE.PROD){
						$("#chooseTable").append($('<tr><th width="50%">业务名称(已有移动电话)</th><th>业务动作</th></tr>'));
						_showAttOffer(this.objInstId);
					}
				});
			});
			
		}
	};
	
	//显示加装副卡订购的销售品
	var _showAddViceOffer = function(){
		if(ec.util.isArray(OrderInfo.oldoffer)){
			$.each(OrderInfo.oldoffer,function(){
				$.each(this.offerMemberInfos,function(){
					if(this.objType==CONST.OBJ_TYPE.PROD){
						$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.roleName+')</th><th>业务动作</th></tr>'));
						_showAttOffer(this.objInstId);
					}
				});
			});
		}else{
			$.each(OrderInfo.offerSpec.offerRoles,function(){
				if(this.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){
					$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.offerRoleName+')</th><th>业务动作</th></tr>'));
					$.each(this.prodInsts,function(){
						_showAttOffer(this.prodInstId);	
					});
				}
			});
		}
	};
	
	//套餐变更销售附属
	var _showChangeAttach = function(){
		$.each(OrderInfo.offer.offerMemberInfos,function(){
			if(this.objType==CONST.OBJ_TYPE.PROD){
				$("#chooseTable").append($('<tr><th width="50%">业务名称('+this.roleName+')</th><th>业务动作</th></tr>'));
				_showAttOffer(this.objInstId);
			}
		});
		if(offerChange.oldMemberFlag){
		var j=0;
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			if(this.memberRoleCd==401){
				var prod=this.prodInsts;
				if(prod!=undefined && prod!=null){
					$.each(this.prodInsts,function(){
						var instid = '"'+this.prodInstId+'"';
						if(instid.indexOf("-")!=-1){
							if(j==0){
//								$("#orderTbody").after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));
								j="chooseTable_"+this.prodInstId;
							}else{
								$("#"+j).after($('<table id="chooseTable_'+this.prodInstId+'" class="table table-bordered tablecenter"></table>'));
								j="chooseTable_"+this.prodInstId;
							}
//							$("#chooseTable_"+this.prodInstId).append($('<thead><tr><th  style="width: 60%;">业务名称('+this.offerRoleName+')</th><th>业务动作</th></tr></thead>'));			
							_showAttOffer(this.prodInstId);
						}
					});
				}
			}
		});
		}
		if(offerChange.oldMemberFlag){
			$.each(OrderInfo.oldoffer,function(){
				$.each(this.offerMemberInfos,function(){
					if(this.objType==CONST.OBJ_TYPE.PROD){
						_showAttOffer(this.objInstId);
					}
				});
			});
		}

	};
	
	//副卡套餐变更销售附属
	var _showMemberChangeAttach = function(){
		if(ec.util.isArray(OrderInfo.viceOfferSpec)){
			$.each(OrderInfo.viceOfferSpec,function(){
//				var prodId=this.prodId;
//				$.each(OrderInfo.offer.offerMemberInfos,function(){
//					if(this.objType==CONST.OBJ_TYPE.PROD&&prodId==this.objInstId){
				$("#chooseTable").append($('<tr><th width="50%">业务名称(基础移动电话)</th><th>业务动作</th></tr>'));
				_showAttOffer(this.prodId);
//					}
//				});
			});
		}
	};
	
	//显示订购的销售品
	var _showAttachOffer = function(){
		var prod = order.prodModify.choosedProdInfo;
		if(prod==undefined || prod.prodInstId ==undefined){
			return true;
		}
		$("#chooseTable").append($('<tr><th width="50%">业务名称</th><th>业务动作</th></tr>'));
		_showAttOffer(prod.prodInstId);
	};
	
	//显示的可选包/功能产品
	var _showAttOffer = function(prodId){
		var offerSpecList = CacheData.getOfferSpecList(prodId);
		var offerList = CacheData.getOfferList(prodId);
		var servSpecList = CacheData.getServSpecList(prodId);
		var servList = CacheData.getServList(prodId);
		var appList = CacheData.getOpenAppList(prodId);
		//可选包显示
		if(offerSpecList!=undefined && offerSpecList.length>0){  
			$.each(offerSpecList,function(){ //遍历当前产品下面的附属销售品
				if(this.isdel != "Y" && this.isdel != "C"){  //订购的附属销售品				
					if(ec.util.isObj(this.counts)){//组装重复订购的可选包
						for(var i=0;i<this.counts;i++){
							$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_BUY+'</td></tr>'));
						}
					}else{
						$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_BUY+'</td></tr>'));
					}
				}
			});
		}	
		if(offerList!=undefined && offerList.length>0){
			$.each(offerList,function(){ //遍历当前产品下面的附属销售品
				 //遍历当前产品下面的附属销售品
				if(this.isdel == "Y"){  //退订的附属销售品
					if(ec.util.isObj(this.counts)){//组装重复订购的可选包
						for(var i=0;i<this.counts;i++){
							$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_DEL+'</td></tr>'));
						}
					}else{
						$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_DEL+'</td></tr>'));
					}
				}else if(this.update == "Y"){
					$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_UPDATE+'</td></tr>'));
				}else if(ec.util.isObj(this.orderCount)&&ec.util.isObj(this.counts)){
					if(this.orderCount<this.counts){//订购附属销售品
						for(var k=0;k<(this.counts-this.orderCount);k++){
							$("#chooseTable").append($('<tr><td width="50%" align="center">'+this.offerSpecName+'</td><td align="center">'+CONST.EVENT.OFFER_BUY+'</td></tr>'));
						}
					}
				}			
			});
		}
		//功能产品显示		
		if(servSpecList!=undefined && servSpecList.length>0){
			$.each(servSpecList,function(){ //遍历当前产品下面的附属销售品
				if(this.isdel != "Y"  && this.isdel != "C"){  //订购的附属销售品
					$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.servSpecName+'</td><td align="center">'+CONST.EVENT.PROD_OPEN+'</td></tr>'));
				}
			});
		}	
		if(servList!=undefined && servList.length>0){
			$.each(servList,function(){ //遍历当前产品下面的附属销售品
				if(this.isdel == "Y"){  //退订的附属销售品
					$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.servSpecName+'</td><td align="center">'+CONST.EVENT.PROD_CLOSE+'</td></tr>'));
				}else if(this.update == "Y"){
					$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.servSpecName+'</td><td align="center">'+CONST.EVENT.PROD_UPDATE+'</td></tr>'));
				}
			});
		}	
		if(appList!=undefined && appList.length>0){
			$.each(appList,function(){ //遍历当前产品下面的增值业务
				if(this.dfQty == 1){  //开通增值业务
					$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.servSpecName+'</td><td align="center">'+CONST.EVENT.PROD_OPEN+'</td></tr>'));
				}
			});
		}
		
		//动作链返回显示
		if(OrderInfo.orderResult.autoBoInfos!=undefined){
			$.each(OrderInfo.orderResult.autoBoInfos,function(){
				if(this.instAccessNumber==OrderInfo.getAccessNumber(prodId)){
					$("#chooseTable").append($('<tr><td width="50%"  align="center">'+this.specName+'</td><td align="center">'+this.boActionTypeName+'</td></tr>'));
				}
			});
		}
	};
	
	//订单返回
	var _orderBack = function(){
		//3G套餐订购4G流量包 订单返回需还原预校验前的缓存信息
		if(CONST.getAppDesc()==0 && OrderInfo.actionFlag==3){
			var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
			var prodId = order.prodModify.choosedProdInfo.prodInstId;
			var specList=CacheData.getOfferSpecList(prodId);
			var flag=false;
			if(ec.util.isArray(specList)){
				$.each(specList,function(){
					if(this.ifPackage4G=="Y" && this.isdel != "Y" && this.isdel != "C"){ //是否有开通4g流量包
						flag = true;
						return false;
					}
				});
			}
			if(flag && prodClass==CONST.PROD_CLASS.THREE){
				AttachOffer.reductionChangList(prodId);
			}
		}
		//不再绑定异常撤单
		SoOrder.delOrderFin();
		
		$("#order_tab_panel_content").show();
		//$("#main_conetent").show();
        if(OrderInfo.actionFlag==2){
        	$("#order_tab_panel_content").hide(); 
			$("#order_fill_content").show();
			$("#order_prepare").show();
        }
		if(OrderInfo.actionFlag==3 || OrderInfo.actionFlag==13 || OrderInfo.actionFlag==17 || OrderInfo.actionFlag==18){
			$("#order_fill_content").show();
			$("#order_prepare").show();
		}
		
		$("#order_confirm").hide();
		
		//SoOrder.showStep(1);
		OrderInfo.orderData.orderList.custOrderList[0].busiOrder = [];
		OrderInfo.resetSeq(); //重置序列
		SoOrder.delOrder();
		_getToken(); //获取页面步骤
		$("#order_fill").show();
		if(CONST.getAppDesc()!=0){
			if($("#a-cust-modify")[0]){
				$("#a-cust-modify").show();
			}
		}
	};
	
	//作废购物车
	var _delOrder = function(){
		var olId = OrderInfo.orderResult.olId;
		if(olId!=0&&olId!=undefined){  //作废购物车
			var param = {
				olId : olId,
				areaId : OrderInfo.getAreaId()
			};
			$.callServiceAsJsonGet(contextPath+"/order/delOrder",param,{
				"done" : function(response){
					if (response.code==0) {
						if(response.data.resultCode==0){
							$.alert("提示","购物车作废成功！");
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","购物车作废失败！");
					}
				},
				fail:function(response){
					$.alert("提示","信息","请求可能发生异常，请稍后再试");
				}
			});
		}
	};
	
	var _delOrderBegin = function(){
		$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID, OrderInfo.orderResult.olId);
		$("a[href^='/']").off("mousedown").on("mousedown", function(){
			SoOrder.delOrderSilent();
			window.location.href=this.href;
		});
		//在订单确认和收银台页面关闭浏览器时调用订单作废
		$(window).off("unload").on("unload", function(){
			SoOrder.delOrderSilent();
		});
	};
	var _delOrderSilent = function() {
//		var olId = OrderInfo.orderResult.olId;
		var olId = $.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID);
		$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID, null);
		if(olId!=0&&olId!=undefined && olId != null){  //作废购物车
			var param = {
				olId : olId,
				areaId : OrderInfo.getAreaId(),
				flag: "U"
			};
			var result = $.callServiceAsJsonGet(contextPath+"/order/delOrder",param);
			//自动撤单时后台会释放该单预占的号码，门户相应更新预占号码表状态（目前撤单不释放预占的UIM，这里也不更新UIM的状态）
			var resources  = [];
			for (var i = 0; i < OrderInfo.boProdAns.length; i++) {	
				var res = {
					accNbr :OrderInfo.boProdAns[i].accessNumber,
					accNbrType : 1,  //号码类型（1手机号码2.UIM卡）
					action : "UPDATE"
				};
				resources.push(res);
			}
			if(resources.length>0){
				var url= contextPath+"/common/updateResState";	 
				$.callServiceAsJsonGet(url,{strParam:JSON.stringify(resources)},{
					"done" : function(response){
						if (response.code==0) {
							if(response.data){
							}
						}
					}
				});	
			}
			OrderInfo.orderData.orderList.custOrderList[0].busiOrder = [];
			OrderInfo.resetSeq(); //重置序列
			_getToken();
			SoOrder.delOrderFin();
		}
	};
	var _delOrderFin = function(){
		$.cookie(CONST.DEL_ORDER_FLAG.SILENT_OLID, null);
		$("a[href^='/']").off("mousedown");
		$(window).off("unload");
	};
	
	//拆副卡
	var _delViceCard = function(busiOrders,data){
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息 
		var param = {
			offerSpecId : prodInfo.prodOfferId,  //业务规格ID
			offerId : prodInfo.prodOfferInstId,  //业务对象实例ID
			offerTypeCd : "1",
			isUpdate : "Y",
			boActionTypeCd : CONST.BO_ACTION_TYPE.UPDATE_OFFER,
			data : data
		};
		OrderInfo.getOfferBusiOrder(busiOrders,param,data[0].objInstId);
		$.each(data,function(){
			var prod = {
				prodId : this.objInstId, 
				isComp : "Y",
				boActionTypeCd : CONST.BO_ACTION_TYPE.REMOVE_PROD
			};
			busiOrders.push(OrderInfo.getProdBusiOrder(prod));
			$.each(OrderInfo.offer.offerMemberInfos,function(){ //遍历主销售品构成
				if(this.roleCd == CONST.MEMBER_ROLE_CD.VICE_CARD && this.objInstId== prodId){
					this.isRemove = "Y";//标志是否拆机
					return false;
				}
			});
		});
	};
	
	//销售品成员变更保留副卡订购新套餐拆副卡并订购新套餐
	var _delViceCardAndNew = function(busiOrders,data){		
		//var newData = data ;
		var objInstId="";
        var newData = data.viceParam ;
        _viceParam=newData;
        var ooRoles = data.ooRoles;
		var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息 
		var param = {
			offerSpecId : prodInfo.prodOfferId,  //业务规格ID
			offerId : prodInfo.prodOfferInstId,  //业务对象实例ID
			offerTypeCd : "1",
			isUpdate : "Y",
			boActionTypeCd : CONST.BO_ACTION_TYPE.UPDATE_OFFER,
			data : data.ooRoles
		};
		$.each(OrderInfo.offer.offerMemberInfos,function(i){
			if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){
				objInstId = this.objInstId;
				return false;
			}
		});
		OrderInfo.getOfferBusiOrder(busiOrders,param,objInstId);		
		//订购副卡主套餐
		for (var i = 0; i < newData.length; i++) {
			if(newData[i].knew=="Y"){
			var offerSpec = newData[i];
			var busiOrder2 = {
				areaId : prodInfo.areaId,  //受理地区ID
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					objId : offerSpec.offerSpecId,  //业务规格ID
					instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
					isComp : "N", //是否组合
					offerTypeCd : "1" //1主销售品
				},  
				boActionType : {
					actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
					boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
				}, 
				data:{
					ooRoles : [],
					ooOwners : [{
						partyId : OrderInfo.cust.custId, //客户ID
						state : "ADD" //动作
					}]
				}
			};
			//遍历主销售品构成
			for ( var j = 0; j < OrderInfo.offer.offerMemberInfos.length; j++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[j];
				if(offerMember.objInstId==offerSpec.objInstId){
					var ooRoles = {
						objId : offerMember.objId, //业务规格ID
						objInstId : offerMember.objInstId, //业务对象实例ID,新装默认-1
						objType : offerMember.objType, // 业务对象类型
						offerRoleId : offerSpec.offerRoleId, //销售品角色ID
						state : "ADD" //动作
					};
					busiOrder2.data.ooRoles.push(ooRoles);
					break;
				}
			}
			busiOrders.push(busiOrder2);
			}else{
			var prod = {
						prodId : newData[i].objInstId, 
						isComp : "Y",
						boActionTypeCd : CONST.BO_ACTION_TYPE.REMOVE_PROD
					};
			busiOrders.push(OrderInfo.getProdBusiOrder(prod));
			}
			
			
		}
	};
	
	//填充业务对象节点
	var _fillBusiOrder = function(busiOrders,data,isComp) {	
		var prod = order.prodModify.choosedProdInfo; //获取产品信息 
		var boActionTypeCd= OrderInfo.boActionTypeCd;
		var objId= prod.productId;
		var instId=prod.prodInstId;
		var classcd=OrderInfo.actionClassCd;
		if(boActionTypeCd==CONST.BO_ACTION_TYPE.ADDOREXIT_COMP){
			objId=prod.prodOfferId;
			instId=prod.prodOfferInstId;
			classcd=CONST.ACTION_CLASS_CD.OFFER_ACTION;
		}
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				objId : objId,//prodInfo.productId, //业务对象规格ID
				instId : instId, //业务对象实例ID
				isComp : isComp, //是否组合
				accessNumber : prod.accNbr,   //业务号码
				offerTypeCd : "1"  //1主销售品
			},  
			boActionType : {
				actionClassCd : classcd,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		busiOrder.data =data;
		busiOrders.push(busiOrder);
	};
	
	//创建订单数据
	var _createOrder = function(busiOrders) {
		//添加客户节点
		if(OrderInfo.cust.custId == -1){
			OrderInfo.createCust(busiOrders);	
		}
		//var acctId = $("#acctSelect").find("option:selected").attr("value"); //先写死
		//var acctId =$("#acctSelect").val();
		var acctId=-1;
		if(OrderInfo.acct!=undefined&&OrderInfo.acct.acctId!=undefined&&OrderInfo.acct.acctId!=null&&OrderInfo.acct.acctId!=""){//新装传帐户id
			acctId=OrderInfo.acct.acctId;//帐户id改成从orderInfo中取
		}
		if(acctId < 0 && acctId!=undefined ){
			OrderInfo.createAcct(busiOrders,acctId);	//添加帐户节点
		}
		var busiOrder = _createMainOffer(busiOrders); //添加主销售品节点	
		//遍历主销售品构成,添加产品节点
		for ( var i = 0; i < busiOrder.data.ooRoles.length; i++) {
			var ooRole = busiOrder.data.ooRoles[i];
			if(ooRole.objType==2 && ooRole.memberRoleCd!=undefined){
				busiOrders.push(_createProd(ooRole.objInstId,ooRole.objId));	
			}		
		}
		
		AttachOffer.setAttachBusiOrder(busiOrders);  //添加可选包跟功能产品
	};
	
	//初始化订单获取token
	var _getToken = function() {
		var response = $.callServiceAsHtmlGet(contextPath+"/common/getToken");
		OrderInfo.order.token = response.data;
	};
	
	//获取token的同步请求
	var _getTokenSynchronize = function() {
		var response = $.callServiceAsHtmlGet(contextPath+"/common/getToken");
		OrderInfo.order.token = response.data;
	};
	
	//创建主副卡订单数据
	var _createMainOrder = function(busiOrders) {
		var prodInfo = order.prodModify.choosedProdInfo;
		var busiOrder = {
			areaId : prodInfo.areaId,  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				objId : prodInfo.prodOfferId,  //业务规格ID
				instId : prodInfo.prodOfferInstId, //业务对象实例ID
				accessNumber : prodInfo.accNbr, //业务号码
				isComp : "Y", //是否组合
				offerTypeCd : "1" //1主销售品
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.ADDOREXIT_COMP
			}, 
			data:{
				ooRoles : []			
			}
		};
		
		if(order.memberChange.oldMemberFlag){//纳入老用户
			var offerRoleId = "";
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
							offerRoleId = offerRole.offerRoleId;
							break;
//						}		
//					}
				} 
			}
			for(var q=0;q<OrderInfo.oldprodInstInfos.length;q++){
				var oldprodInfo = OrderInfo.oldprodInstInfos[q];
				var oldbusiOrder = {
						areaId : oldprodInfo.areaId,  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							objId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferId,  //业务规格ID
							instId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferInstId, //业务对象实例ID
							accessNumber : oldprodInfo.accNbr, //业务号码
							isComp : "Y", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER
						}, 
						data:{
							ooRoles : []			
						}
					};
				var memberid = -1;
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) {
					if(OrderInfo.oldoffer[i].accNbr==oldprodInfo.accNbr){
						$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
							if(this.objType==CONST.OBJ_TYPE.PROD){
								var ooRole = {
									objId : this.objId,
									objInstId : this.objInstId,
									objType :this.objType,
									offerMemberId : memberid,
									offerRoleId : offerRoleId,
									state : "ADD"
								};
								busiOrder.data.ooRoles.push(ooRole);
								var oldooRole = {
										objId : this.objId,
										objInstId : this.objInstId,
										objType : this.objType,
										offerMemberId : this.offerMemberId,
										offerRoleId : this.offerRoleId,
										state : "DEL"
									};
								oldbusiOrder.data.ooRoles.push(oldooRole);
								--memberid;
							}
						});
//						var offerMemberInfo = OrderInfo.oldoffer.offerMemberInfos[i];
//						if((offerMemberInfo.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD || offerMemberInfo.roleCd=="1") && offerMemberInfo.objType=="2"){
//							var ooRole = {
//								objId : offerMemberInfo.objId,
//								objInstId : offerMemberInfo.objInstId,
//								objType : "2",
//								offerMemberId : "-1",
//								offerRoleId : offerRoleId,
//								state : "ADD"
//							};
//							busiOrder.data.ooRoles.push(ooRole);
//							var oldooRole = {
//									objId : offerMemberInfo.objId,
//									objInstId : offerMemberInfo.objInstId,
//									objType : "2",
//									offerMemberId : "-1",
//									offerRoleId : offerMemberInfo.offerRoleId,
//									state : "DEL"
//								};
//							oldbusiOrder.data.ooRoles.push(oldooRole);
//						}
					}
				}
				busiOrders.push(oldbusiOrder);
			}
			if(CONST.getAppDesc()==0){ //4g系统需要,补换卡 
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) { //遍历主销售品构成
					$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
							if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
								var prod = {
									prodId : this.objInstId,
									prodSpecId : this.objId,
									accessNumber : this.accessNumber,
									isComp : "N",
									boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
								};
								var busiOrder = OrderInfo.getProdBusiOrder(prod);
								if(busiOrder){
									busiOrders.push(busiOrder);
								}
							}
						}
					});
				}
			}
		}
		if(order.memberChange.newMemberFlag){
			//遍历主销售品构成
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
					if(offerRole.prodInsts!=undefined && offerRole.prodInsts.length>0){
						for ( var j = 0; j < offerRole.prodInsts.length; j++) {
							var prodInst = offerRole.prodInsts[j];
							var ooRole = {
								objId : prodInst.objId,
								objInstId : prodInst.prodInstId,
								objType : prodInst.objType,
								offerMemberId : OrderInfo.SEQ.offerMemberSeq--,
								offerRoleId : prodInst.offerRoleId,
								state : "ADD"
							};
							busiOrder.data.ooRoles.push(ooRole);
							busiOrders.push(_createProd(prodInst.prodInstId,prodInst.objId));	
						}		
					}
				} 
			} 
		}
		if(order.memberChange.changeMemberFlag){
//			var objInstId="";
	        var newData = order.memberChange.viceparams;
//	        _viceParam=newData;
	        var ooRoles = order.memberChange.ooRoless;
			var prodInfo = order.prodModify.choosedProdInfo; //获取产品信息 
//			var param = {
//				offerSpecId : prodInfo.prodOfferId,  //业务规格ID
//				offerId : prodInfo.prodOfferInstId,  //业务对象实例ID
//				offerTypeCd : "1",
//				isUpdate : "Y",
//				boActionTypeCd : CONST.BO_ACTION_TYPE.UPDATE_OFFER,
//				data : data.ooRoles
//			};
//			$.each(OrderInfo.offer.offerMemberInfos,function(i){
//				if(this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){
//					objInstId = this.objInstId;
//					return false;
//				}
//			});
//			OrderInfo.getOfferBusiOrder(busiOrders,param,objInstId);	
	        $.each(ooRoles,function(){
	        	busiOrder.data.ooRoles.push(this);
	        });
//			busiOrder.data.ooRoles.push(ooRoles);
			//订购副卡主套餐
			for (var i = 0; i < newData.length; i++) {
				if(newData[i].knew=="Y"){
					var offerSpec = newData[i];
					var accessNumber="";
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objInstId==offerSpec.objInstId){
							accessNumber=this.accessNumber;
						}
					});
					var busiOrder2 = {
						areaId : prodInfo.areaId,  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							objId : offerSpec.offerSpecId,  //业务规格ID
							objName : offerSpec.offerSpecName,
							instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
							isComp : "N", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
						}, 
						data:{
							ooRoles : [],
							ooOwners : [{
								partyId : OrderInfo.cust.custId, //客户ID
								state : "ADD" //动作
							}]
						}
					};
					if(ec.util.isObj(accessNumber)){
						busiOrder2.busiObj.accessNumber=accessNumber;
					}
					//遍历主销售品构成
					for ( var j = 0; j < OrderInfo.offer.offerMemberInfos.length; j++) {
						var offerMember = OrderInfo.offer.offerMemberInfos[j];
						if(offerMember.objInstId==offerSpec.objInstId){
							var ooRoles = {
								objId : offerMember.objId, //业务规格ID
								objInstId : offerMember.objInstId, //业务对象实例ID,新装默认-1
								objType : offerMember.objType, // 业务对象类型
								offerRoleId : offerSpec.offerRoleId, //销售品角色ID
								state : "ADD" //动作
							};
							busiOrder2.data.ooRoles.push(ooRoles);
							break;
						}
					}
					
					//发展人
					var $tr = $("li[name='tr_"+offerSpec.offerSpecId+"']");
					if($tr!=undefined){
						busiOrder2.data.busiOrderAttrs = [];
						$tr.each(function(){   //遍历产品有几个发展人
							var dealer = {
									itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
									role : $(this).find("select").val(),
									value : $(this).find("input").attr("staffid"),
									channelNbr : $(this).find("select[name ='dealerChannel_"+offerSpec.offerSpecId+"']").val()
							};
							busiOrder2.data.busiOrderAttrs.push(dealer);
							var dealer_name = {
									itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
									role : $(this).find("select").val(),
									value : $(this).find("input").attr("value") 
							};
							busiOrder2.data.busiOrderAttrs.push(dealer_name);
						});
					}
					
					busiOrders.push(busiOrder2);
				}else{
					var prod = {
								prodId : newData[i].objInstId, 
								isComp : "Y",
								boActionTypeCd : CONST.BO_ACTION_TYPE.REMOVE_PROD
							};
					busiOrders.push(OrderInfo.getProdBusiOrder(prod));
				}
				
				
			}
			if(order.memberChange.getSimulateData()){
				if(ec.util.isArray(OrderInfo.viceOfferSpec)){
					$.each(OrderInfo.viceOfferSpec,function(){
						var prodId=this.prodId;
						if(ec.util.isArray(OrderInfo.offer.offerMemberInfos)){ //遍历主销售品构成
							$.each(OrderInfo.offer.offerMemberInfos,function(){
								if(prodId==this.objInstId&&this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
									if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
										var prod = {
												prodId : this.objInstId,
												prodSpecId : this.objId,
												accessNumber : this.accessNumber,
												isComp : "N",
												boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
										};
										var busiOrder = OrderInfo.getProdBusiOrder(prod);
										if(busiOrder){
											busiOrders.push(busiOrder);
										}
									}
								}
							});
						}
					});
				}
//				AttachOffer.setAttachBusiOrder(busiOrders);  //订购退订附属销售品
			}
		}
		AttachOffer.setAttachBusiOrder(busiOrders);//添加附属
		busiOrders.push(busiOrder);
	};
	
	//创建主副卡订单数据
	var _delAndNew = function(busiOrders,newDataMap) {
		var newData = newDataMap ;
		var remark = "" ; 
		var allDel=true;
		var v_actionClassCd = CONST.ACTION_CLASS_CD.OFFER_ACTION;
		var v_boActionTypeCd = CONST.BO_ACTION_TYPE.DEL_OFFER;
		var v_actionClassCd2 = CONST.ACTION_CLASS_CD.OFFER_ACTION;
		var v_boActionTypeCd2 = CONST.BO_ACTION_TYPE.BUY_OFFER;
		if(OrderInfo.actionFlag==19||OrderInfo.actionFlag==20){
			v_actionClassCd = CONST.ACTION_CLASS_CD.PROD_ACTION;//产品及服务动作
			v_boActionTypeCd = CONST.BO_ACTION_TYPE.BUY_BACK;//返销
			v_actionClassCd2 = CONST.ACTION_CLASS_CD.OFFER_ACTION;//销售品动作
			v_boActionTypeCd2 = CONST.BO_ACTION_TYPE.BUY_OFFER;//订购销售品
			v_boActionTypeCdAdd =CONST.BO_ACTION_TYPE.BUY_BACK;//副卡带出动作小类
			newData = newDataMap.viceParam ;
			remark = newDataMap.remark; 
		}else if(OrderInfo.actionFlag==7){
			v_boActionTypeCdAdd =CONST.BO_ACTION_TYPE.REMOVE_PROD;//副卡带出动作小类
		}
		for (var i = 0; i < newData.length; i++) {
			var offerSpec = newData[i];
			if(offerSpec.del=='N'){
				allDel=false;
			}
		}
		if(allDel){
			_viceParam=newData;
			var busiOrder = {
					areaId : OrderInfo.getProdAreaId(order.prodModify.choosedProdInfo.prodInstId),  //受理地区ID
					busiOrderInfo : {
						seq : OrderInfo.SEQ.seq--
					}, 
					busiObj : { //业务对象节点
						accessNumber : order.prodModify.choosedProdInfo.accNbr,
						objId : order.prodModify.choosedProdInfo.productId,  //业务规格ID,prod.prodOfferId
						instId : order.prodModify.choosedProdInfo.prodInstId, //业务对象实例ID,prod.prodOfferInstId
						isComp : "N", //是否组合
						offerTypeCd : "1" //1主销售品
					},  
					boActionType : {
						actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
						boActionTypeCd : OrderInfo.boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
					},
					data:{
						boProdStatuses :[{
							prodStatusCd : order.prodModify.choosedProdInfo.prodStateCd,
							state : "DEL"
						},{
							prodStatusCd : (OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD) ? CONST.PROD_STATUS_CD.STOP_PROD : CONST.PROD_STATUS_CD.REMOVE_PROD,
							state : "ADD"
						}],
						busiOrderAttrs:[]
					}
				};
			/*var remark = $('#order_remark').val();   //订单备注
			if(remark!=""&&remark!=undefined){
				busiOrder.data.busiOrderAttrs.push({
					itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
					value : remark
				});	
			}*/
				busiOrders.push(busiOrder);	
			for (var i = 0; i < newData.length; i++) {
				var offerSpec = newData[i];
				var busiOrder = {
						areaId : OrderInfo.getProdAreaId(offerSpec.prodInstId),  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							accessNumber :offerSpec.accessNumber,
							objId : offerSpec.objId,  //业务规格ID,prod.prodOfferId
							instId : offerSpec.objInstId, //业务对象实例ID,prod.prodOfferInstId
							isComp : "N", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : OrderInfo.boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
						},
						data:{
							boProdStatuses :[/*{
								prodStatusCd :order.prodModify.choosedProdInfo.prodStateCd,
								state : "DEL"
							},*/
							{
								prodStatusCd : (OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD) ? CONST.PROD_STATUS_CD.STOP_PROD : CONST.PROD_STATUS_CD.REMOVE_PROD,
								state : "ADD"
							}],
							busiOrderAttrs:[]
						}
					};
				/*var remark = $('#order_remark').val();   //订单备注
				if(remark!=""&&remark!=undefined){
					busiOrder.data.busiOrderAttrs.push({
						itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
						value : remark
					});	
				}*/
					busiOrders.push(busiOrder);	
			}
			return;
		}
		if(OrderInfo.actionFlag==7){ //7 拆主卡保留副卡
			_viceParam=newData;
			//退订主套餐
			var prod = order.prodModify.choosedProdInfo;
			var busiOrder = {
				areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					objId : prod.prodOfferId,  //业务规格ID,prod.prodOfferId
					instId : prod.prodOfferInstId, //业务对象实例ID,prod.prodOfferInstId
					isComp : "N", //是否组合
					offerTypeCd : "1" //1主销售品
				},  
				boActionType : {
					actionClassCd : v_actionClassCd,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
					boActionTypeCd : v_boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
				},
				data:{
					ooRoles : [],	
					ooOwners : [{
						partyId : OrderInfo.cust.custId, //客户ID
						state : "DEL" //动作
					}]
				}
			};
			//遍历主销售品构成
			for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[i];
				var ooRoles = {
					objId : offerMember.objId, //业务规格ID
					objInstId : offerMember.objInstId, //业务对象实例ID,新装默认-1
					objType : offerMember.objType, // 业务对象类型
					offerMemberId : offerMember.offerMemberId, //成员id
					offerRoleId : offerMember.offerRoleId, //销售品角色ID
					state : "DEL" //动作
				};
				busiOrder.data.ooRoles.push(ooRoles);
			}
			busiOrders.push(busiOrder);	
			/*var prod = {
				prodId : this.objInstId, 
				isComp : "Y",
				boActionTypeCd : CONST.BO_ACTION_TYPE.REMOVE_PROD
			};
			busiOrders.push(OrderInfo.getProdBusiOrder(prod));*/
		}else {
			//反销主卡
			var prod = order.prodModify.choosedProdInfo;
			var busiOrder = {
				areaId : OrderInfo.getProdAreaId(prod.prodInstId),  //受理地区ID
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					objId : prod.productId,  //业务规格ID,prod.prodOfferId
					instId : prod.prodInstId, //业务对象实例ID,prod.prodOfferInstId
					accessNumber : prod.accNbr, //接入号码
					isComp : "N" //是否组合
				},  
				boActionType : {
					actionClassCd : v_actionClassCd,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
					boActionTypeCd : v_boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
				},
				data:{
					boProdStatuses : [
					  {
						  "prodStatusCd": CONST.PROD_STATUS_CD.NORMAL_PROD,
	                        "state": "DEL"
					  },{
						  "prodStatusCd": CONST.PROD_STATUS_CD.REMOVE_PROD,
	                        "state": "ADD"
					  }
					],	
					busiOrderAttrs : []
				}
			};
			/*//订单属性
			if(remark!=undefined&&remark!=""){
				busiOrder.data.busiOrderAttrs.push({
					itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
					value : remark
				});	
			}*/
			busiOrders.push(busiOrder);	
		}
		
		//订购副卡主套餐
		for (var i = 0; i < newData.length; i++) {
			var offerSpec = newData[i];
			if(offerSpec.del=="N"){
			var busiOrder2 = {
				areaId : OrderInfo.getAreaId(),  //受理地区ID
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					objId : offerSpec.offerSpecId,  //业务规格ID
					instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
					isComp : "N", //是否组合
					offerTypeCd : "1" //1主销售品
				},  
				boActionType : {
					actionClassCd : v_actionClassCd2,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
					boActionTypeCd : v_boActionTypeCd2//CONST.BO_ACTION_TYPE.BUY_OFFER
				}, 
				data:{
					ooRoles : [],
					ooOwners : [{
						partyId : OrderInfo.cust.custId, //客户ID
						state : "ADD" //动作
					}]
				}
			};
			//遍历主销售品构成
			for ( var j = 0; j < OrderInfo.offer.offerMemberInfos.length; j++) {
				var offerMember = OrderInfo.offer.offerMemberInfos[j];
				if(offerMember.objInstId==offerSpec.objInstId){
					var ooRoles = {
						objId : offerMember.objId, //业务规格ID
						objInstId : offerMember.objInstId, //业务对象实例ID,新装默认-1
						objType : offerMember.objType, // 业务对象类型
						offerRoleId : offerSpec.offerRoleId, //销售品角色ID
						state : "ADD" //动作
					};
					busiOrder2.data.ooRoles.push(ooRoles);
					break;
				}
			}
			busiOrders.push(busiOrder2);
		}else{
				var busiOrder = {
						areaId : OrderInfo.getProdAreaId(offerSpec.prodInstId),  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							accessNumber :offerSpec.accessNumber,
							objId : offerSpec.objId,  //业务规格ID,prod.prodOfferId
							instId : offerSpec.objInstId, //业务对象实例ID,prod.prodOfferInstId
							isComp : "N", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,//CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : OrderInfo.boActionTypeCd//CONST.BO_ACTION_TYPE.DEL_OFFER
						},
						data:{
							boProdStatuses :[/*{
								prodStatusCd :order.prodModify.choosedProdInfo.prodStateCd,
								state : "DEL"
							},*/
							{
								prodStatusCd : (OrderInfo.boActionTypeCd==CONST.BO_ACTION_TYPE.PREMOVE_PROD) ? CONST.PROD_STATUS_CD.STOP_PROD : CONST.PROD_STATUS_CD.REMOVE_PROD,
								state : "ADD"
							}],
							busiOrderAttrs:[]
						}
					};
				/*var remark = $('#order_remark').val();   //订单备注
				if(remark!=""&&remark!=undefined){
					busiOrder.data.busiOrderAttrs.push({
						itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
						value : remark
					});	
				}*/
					busiOrders.push(busiOrder);	
		}
		}
	};
	
	//创建附属销售品订单数据
	var _createAttOrder = function(busiOrders){	
		AttachOffer.setAttachBusiOrder(busiOrders);		
		var prodInfo = order.prodModify.choosedProdInfo;
		if(AttachOffer.isChangeUim(prodInfo.prodInstId)){
			if(OrderInfo.boProd2Tds.length>0){
				var prod = {
					prodId : prodInfo.prodInstId,
					prodSpecId : prodInfo.productId,
					isComp : "N",
					accessNumber : prodInfo.accNbr,
					boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
				};
				busiOrders.push(OrderInfo.getProdBusiOrder(prod));
			}
		}
	};
	
	//创建附属销售品订单数据
	var _createCustOrder = function(busiOrders,data){	
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : OrderInfo.cust.custId //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : OrderInfo.actionClassCd,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		busiOrder.data =data;
		busiOrders.push(busiOrder);
	};
	//创建活卡销售返档订单数据
	var _ActiveReturnOrder = function(busiOrders,data){
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				accessNumber: order.prodModify.choosedProdInfo.accNbr,
				instId : OrderInfo.cust.custId //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : OrderInfo.actionClassCd,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		busiOrder.data =data;
		busiOrders.push(busiOrder);
		var busiOrderAdd = {
				areaId : OrderInfo.getAreaId(),  //受理地区ID		
				busiOrderInfo : {
					seq : OrderInfo.SEQ.seq--
				}, 
				busiObj : { //业务对象节点
					accessNumber: order.prodModify.choosedProdInfo.accNbr,
					instId : order.prodModify.choosedProdInfo.prodInstId, //业务对象实例ID
					objId :order.prodModify.choosedProdInfo.productId
				},  
				boActionType : {
					actionClassCd: CONST.ACTION_CLASS_CD.PROD_ACTION,
                    boActionTypeCd: CONST.BO_ACTION_TYPE.ACTIVERETURNTWO
				}, 
				data:{}
			};
		busiOrderAdd.data.boProdStatuses = [{
			prodStatusCd : CONST.PROD_STATUS_CD.READY_PROD,
			state : "DEL"
		},{
			prodStatusCd : CONST.PROD_STATUS_CD.DONE_PROD,
			state : "ADD"
		}
		];
		busiOrders.push(busiOrderAdd);
	};
	//创建客户单独订单
	var _createCustOrderOnly = function(busiOrders,data){
		var busiOrder = {
			areaId : OrderInfo.getAreaId(),  //受理地区ID		
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				instId : -1 //业务对象实例ID
			},  
			boActionType : {
				actionClassCd : OrderInfo.actionClassCd,
				boActionTypeCd : OrderInfo.boActionTypeCd
			}, 
			data:{}
		};
		busiOrder.data =data;
		busiOrders.push(busiOrder);
	};
	
	
	//创建主销售品节点
	var _createMainOffer = function(busiOrders) {
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(-1),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq--
			}, 
			busiObj : { //业务对象节点
				objId : OrderInfo.offerSpec.offerSpecId,  //业务规格ID
				instId : OrderInfo.SEQ.offerSeq--, //业务对象实例ID
				isComp : "N", //是否组合
				offerTypeCd : "1" //1主销售品
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
				boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER
			}, 
			data:{
				ooRoles : [],
				ooOwners : [],
				busiOrderAttrs : []
			}
		};
		var accNbr = OrderInfo.getAccessNumber(-1);
		if(ec.util.isObj(accNbr)){ //接入号
			busiOrder.busiObj.accessNumber = accNbr;
		}	
		//遍历主销售品构成
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			$.each(this.prodInsts,function(){
				var ooRoles = {
					objId : this.objId, //业务规格ID
					objInstId : this.prodInstId, //业务对象实例ID,新装默认-1
					objType : this.objType, // 业务对象类型
					memberRoleCd : this.memberRoleCd, //成员角色类型
					offerRoleId : this.offerRoleId, //销售品角色ID
					state : "ADD" //动作
				};
				busiOrder.data.ooRoles.push(ooRoles);  //接入类产品
				var prodId = this.prodInstId;
				if(this.servInsts!=undefined && this.servInsts.length>0){ //功能类产品
					$.each(this.servInsts,function(){
						var ooRoles = {
							objId : this.objId, //业务规格ID
							objInstId : OrderInfo.SEQ.servSeq--, //业务对象实例ID,新装默认-1
							objType : this.objType, // 业务对象类型
							prodId : prodId,
							//memberRoleCd : this.memberRoleCd, //成员角色类型
							offerRoleId : this.offerRoleId, //销售品角色ID
							state : "ADD" //动作
						};
						busiOrder.data.ooRoles.push(ooRoles); //功能类产品
					});
				}
			});
		}); 
		
		
		if(offerChange.oldMemberFlag){//纳入老用户
			var offerRoleId = "";
			for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
				var offerRole = OrderInfo.offerSpec.offerRoles[i];
				if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.VICE_CARD){ //副卡
							offerRoleId = offerRole.offerRoleId;
							break;
				} 
			}
			for(var q=0;q<OrderInfo.oldprodInstInfos.length;q++){
				var oldprodInfo = OrderInfo.oldprodInstInfos[q];
				var oldbusiOrder = {
						areaId : oldprodInfo.areaId,  //受理地区ID
						busiOrderInfo : {
							seq : OrderInfo.SEQ.seq--
						}, 
						busiObj : { //业务对象节点
							objId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferId,  //业务规格ID
							instId : oldprodInfo.mainProdOfferInstInfos[0].prodOfferInstId, //业务对象实例ID
							accessNumber : oldprodInfo.accNbr, //业务号码
							isComp : "Y", //是否组合
							offerTypeCd : "1" //1主销售品
						},  
						boActionType : {
							actionClassCd : CONST.ACTION_CLASS_CD.OFFER_ACTION,
							boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER
						}, 
						data:{
							ooRoles : []			
						}
					};
				
					var memberid = -1;
					for ( var i = 0; i < OrderInfo.oldoffer.length; i++) {
						if(OrderInfo.oldoffer[i].accNbr==oldprodInfo.accNbr){
							$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
								//if((this.roleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD || this.roleCd=="1") && this.objType=="2"){
								if(this.objType==CONST.OBJ_TYPE.PROD){
									var ooRole = {
										objId : this.objId,
										objInstId : this.objInstId,
										objType : this.objType,
										offerMemberId : memberid,
										offerRoleId : offerRoleId,
										state : "ADD"
									};
									busiOrder.data.ooRoles.push(ooRole);
									var oldooRole = {
											objId : this.objId,
											objInstId : this.objInstId,
											objType : this.objType,
											offerMemberId : this.offerMemberId,
											offerRoleId : this.offerRoleId,
											state : "DEL"
										};
									oldbusiOrder.data.ooRoles.push(oldooRole);
									--memberid;
								}
							});
						}
					}
				busiOrders.push(oldbusiOrder);
			}
			if(CONST.getAppDesc()==0){ //4g系统需要,补换卡 
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) { //遍历主销售品构成
					$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
						if(this.objType==CONST.OBJ_TYPE.PROD && this.prodClass==CONST.PROD_CLASS.THREE && OrderInfo.offerSpec.is3G=="N"){//补换卡
							if(AttachOffer.isChangeUim(this.objInstId)&&(OrderInfo.boProd2Tds.length>0||OrderInfo.zcd_privilege==0)){
								var prod = {
									prodId : this.objInstId,
									prodSpecId : this.objId,
									accessNumber : this.accessNumber,
									isComp : "N",
									boActionTypeCd : CONST.BO_ACTION_TYPE.CHANGE_CARD
								};
								var busiOrder = OrderInfo.getProdBusiOrder(prod);
								if(busiOrder){
									busiOrders.push(busiOrder);
								}
							}
						}
					});
				}
			}
		}
		
		
		//销售参数节点
		var offerSpecParams = OrderInfo.offerSpec.offerSpecParams;
		if(offerSpecParams!=undefined && offerSpecParams.length>0){  
			busiOrder.data.ooParams = [];
			for (var i = 0; i < offerSpecParams.length; i++) {
				var param = offerSpecParams[i];
				var ooParam = {
	                itemSpecId : param.itemSpecId,
	                offerParamId : OrderInfo.SEQ.paramSeq--,
	                offerSpecParamId : param.offerSpecParamId,
	                value : param.value,
	                state : "ADD"
	            };
	            busiOrder.data.ooParams.push(ooParam);
			}				
		}
		
		//销售生失效时间节点
		if(OrderInfo.offerSpec.ooTimes !=undefined ){  
			busiOrder.data.ooTimes = [];
			busiOrder.data.ooTimes.push(OrderInfo.offerSpec.ooTimes);
		}
		
		//所属人节点
		var ooOwners = {
			partyId : OrderInfo.cust.custId, //客户对象ID
			state : "ADD" //动作
		};
		busiOrder.data.ooOwners.push(ooOwners);
		
		//发展人
		var $tr = $("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");
		if($tr!=undefined){
			$tr.each(function(){   //遍历产品有几个发展人
				var dealer = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
					role : $(this).find("select").val(),
					value : $(this).find("input").attr("staffid"),
					channelNbr : $(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val()
				};
				busiOrder.data.busiOrderAttrs.push(dealer);
				var dealer_name = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("value") 
				};
				busiOrder.data.busiOrderAttrs.push(dealer_name);
			});
		}
		
		busiOrders.push(busiOrder);
		return busiOrder;
	};
	
	//创建产品节点
	var _createProd = function(prodId,prodSpecId) {	
		var busiOrder = {
			areaId : OrderInfo.getProdAreaId(prodId),  //受理地区ID
			busiOrderInfo : {
				seq : OrderInfo.SEQ.seq-- 
			}, 
			busiObj : { //业务对象节点
				objId : prodSpecId,  //业务对象ID
				instId : prodId, //业务对象实例ID
				isComp : "N"  //是否组合
				//accessNumber : "" //接入号码
			},  
			boActionType : {
				actionClassCd : CONST.ACTION_CLASS_CD.PROD_ACTION,
				boActionTypeCd : "1"
			}, 
			data:{
				boProdFeeTypes : [], //付费方式节点
				boProdSpecs : [{
					prodSpecId : prodSpecId,
					state : 'ADD'
				}], //产品规格节点
				boCusts : [],  //客户信息节点		
				boProdItems : [], //产品属性节点
				boProdPasswords : [], //产品密码节点
				boProdAns : [], //号码信息节点
				//boProd2Tds : [], //UIM卡节点信息
				bo2Coupons : [],  //物品信息节点
				boAccountRelas : [], //帐户关联关系节
				boProdStatuses : [], //产品状态节点
				busiOrderAttrs : [] //订单属性节点
			}
		};
		
		var prodStatus = CONST.PROD_STATUS_CD.NORMAL_PROD;
		/*if($("#isActivation").attr("checked")=="checked"){//首话单激活
			prodStatus = CONST.PROD_STATUS_CD.DONE_PROD;
		}else if($("#isTemplateOrder").attr("checked")=="checked"){ //批量订单
			if($("#templateOrderDiv").find("select").val()==0){ //批量开活卡
				prodStatus = CONST.PROD_STATUS_CD.READY_PROD;	
			}
		}*/
		//封装产品状态节点
		busiOrder.data.boProdStatuses.push({
			state : "ADD",
			prodStatusCd : prodStatus
		});	
			
		//封装号码信息节点
		var boProdAns = OrderInfo.boProdAns;
		for ( var i = 0; i < boProdAns.length; i++) {
			if(boProdAns[i].prodId==prodId){
				busiOrder.data.boProdAns.push(boProdAns[i]);
				busiOrder.busiObj.accessNumber = boProdAns[i].accessNumber;
				break;
			}
		}
		
		//封装UIM卡信息节点
		var boProd2Tds = OrderInfo.boProd2Tds;
		for ( var i = 0; i < boProd2Tds.length; i++) {
			if(boProd2Tds[i].prodId==prodId){
				busiOrder.data.bo2Coupons.push(boProd2Tds[i]);
				break;
			}
		}
		
		/*//封装物品信息节点
		var bo2Coupons = OrderInfo.bo2Coupons;
		for ( var i = 0; i < bo2Coupons.length; i++) {
			if( bo2Coupons[i].prodId==prodId){
				busiOrder.data.bo2Coupons = bo2Coupons[i].coupons;
				break;
			}
		}*/
		
		//封装客户与产品之间的关系信息
		busiOrder.data.boCusts.push({
			partyId	: OrderInfo.cust.custId, //客户ID
			partyProductRelaRoleCd : "0", //客户与产品之间的关系（担保关系）
			state : "ADD" //动作
		});
		
		//封装产品密码
		var pwd=$("#pwd_"+prodId).val();
		if(pwd=="******"){
			pwd = order.main.genRandPass6();
		}
		var boProdPassword = {
			prodPwTypeCd : 2, //密码类型
			pwd : pwd, //密码
			state : "ADD"  //动作
		};
		busiOrder.data.boProdPasswords.push(boProdPassword);
		
		//封装产品属性
		$("[name=prodSpec_"+prodId+"]").each(function(){
			var itemSpecId=$(this).attr("id").split("_")[0];
			var val=$.trim($(this).val());
			if(val!=""&&val!=undefined){
				var prodSpecItem = {
					itemSpecId : itemSpecId,  //属性规格ID
					prodSpecItemId : OrderInfo.SEQ.itemSeq--, //产品属性实例ID
					state : "ADD", //动作
					value : val//属性值	
				};
				busiOrder.data.boProdItems.push(prodSpecItem);
			}
		});
		
		//封装付费方式
		//var paytype=$('select[name="pay_type_'+prodId+'"]').val(); 
		var paytype=$('select[name="pay_type_-1"]').val();  //先写死
		if(paytype!= undefined){
			busiOrder.data.boProdFeeTypes.push({
				feeType : paytype,
				state : "ADD"
			});
		}
		
		//封装付费方式
		/*$("[name=prodSpec_"+prodId+"]").each(function(){
			var itemSpecId=$(this).attr("id").split("_")[0];
			if(itemSpecId==CONST.PROD_ATTR.FEE_TYPE){ //付费方式
				busiOrder.data.boProdFeeTypes.push({
					feeType : $(this).val(),
					state : "ADD"
				});
				return false;
			}
		});
		*/
		/*//订单属性
		var remark = $('#order_remark').val();   //订单备注
		if(remark!=""&&remark!=undefined){
			busiOrder.data.busiOrderAttrs.push({
				itemSpecId : CONST.BUSI_ORDER_ATTR.REMARK,
				value : remark
			});	
		}*/
		//发展人
		var $tr;
		if(OrderInfo.actionFlag==6){ //加装发展人根据产品
			$tr = $("li[name='tr_"+prodId+"']");
		}else{
			$tr = $("li[name='tr_"+OrderInfo.offerSpec.offerSpecId+"']");
		}
		if($tr!=undefined){
			$tr.each(function(){   //遍历产品有几个发展人
				var dealer = {
					itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER,
					role : $(this).find("select").val(),
					value : $(this).find("input").attr("staffid")
					
				};
				if(OrderInfo.actionFlag==6){
					dealer.channelNbr=$(this).find("select[name ='dealerChannel_"+prodId+"']").val();
				}
				else{
					dealer.channelNbr=$(this).find("select[name ='dealerChannel_"+OrderInfo.offerSpec.offerSpecId+"']").val();
				}
				busiOrder.data.busiOrderAttrs.push(dealer);
				var dealer_name = {
						itemSpecId : CONST.BUSI_ORDER_ATTR.DEALER_NAME,
						role : $(this).find("select").val(),
						value : $(this).find("input").attr("value") 
				};
				busiOrder.data.busiOrderAttrs.push(dealer_name);
			});
		}
		
		var acctId=-1;
		if(OrderInfo.acct!=undefined&&OrderInfo.acct.acctId!=undefined&&OrderInfo.acct.acctId!=null&&OrderInfo.acct.acctId!=""){//新装传帐户id
			acctId=OrderInfo.acct.acctId;
		}
		var acctCd = -1;
		if(acctId==undefined){
			acctId = -1;
			acctCd = -1;
		}else if(acctId<0 ){ //新增
			acctCd = acctId;
		}else{
			acctCd = OrderInfo.acct.acctcd;
		}
		var boAccountRela = {
			acctId : acctId,
			acctCd : acctCd,
			acctRelaTypeCd : "1", //帐户和产品关联原因
			chargeItemCd : "0", //帐户主要费用类型
			percent : "100", //付费比例
			priority : "1",  //付费优先级
			state : "ADD" //动作
		};
		
		busiOrder.data.boAccountRelas.push(boAccountRela);	
		return busiOrder;
	};
	
	//创建附属销售品节点
	var _createAttOffer = function(offerSpec,prodId,flag,busiOrders) {
		if(flag==1){  //退订附属
			offerSpec.offerTypeCd = 2;
			offerSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.DEL_OFFER;
			OrderInfo.getOfferBusiOrder(busiOrders,offerSpec,prodId);
		}else if(flag==2){  //参数变更
			if(offerSpec.offerSpec.offerSpecParams!=undefined && offerSpec.offerSpec.offerSpecParams.length>0){  //销售参数节点
				offerSpec.offerTypeCd = 2;
				offerSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.UPDATE_OFFER;
				OrderInfo.getOfferBusiOrder(busiOrders,offerSpec,prodId);
			}
			/*if(offerSpec.offerMembers!=undefined && offerSpec.offerMembers.length>0){ //设置功能产品参数	 
				for (var i = 0; i < offerSpec.offerMembers.length; i++) {
					var offerMember = offerSpec.offerMembers[i];
					if(offerMember.prodParamInfos.length >0){
						offerMember.boActionTypeCd = CONST.BO_ACTION_TYPE.PRODUCT_PARMS;
						offerMember.prodId = prodId;
						offerMember.prodSpecId = offerMember.objId;
						busiOrders.push(OrderInfo.getProdBusiOrder(offerMember));
					}
				}
			}*/
		}else{ //订购
			offerSpec.offerTypeCd = 2;
			offerSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.BUY_OFFER;
			offerSpec.offerId = OrderInfo.SEQ.offerSeq--; 
			OrderInfo.getOfferBusiOrder(busiOrders,offerSpec,prodId);			
		}
	};
	
	//创建功能产品节点
	var _createServ = function(servSpec,prodId,flag,busiOrders) {
		servSpec.prodId = prodId;
		if(flag==1){  //退订附属
			servSpec.servClose = "Y";
			servSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.SERV_OPEN;
			busiOrders.push(OrderInfo.getProdBusiOrder(servSpec));	
		}else if(flag==2){  //参数变更
			if(servSpec.prodSpecParams!=undefined && servSpec.prodSpecParams.length>0){  //设置功能产品参数	
				servSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.PRODUCT_PARMS;
				servSpec.memberId = servSpec.servId;
				busiOrders.push(OrderInfo.getProdBusiOrder(servSpec));
			}
		}else{ //订购
			servSpec.servId = OrderInfo.SEQ.servSeq--;
			servSpec.boActionTypeCd = CONST.BO_ACTION_TYPE.SERV_OPEN;		
			busiOrders.push(OrderInfo.getProdBusiOrder(servSpec));	
		}
	};
	
	//改号
	var _changeNumber = function(busiOrders){
		var data = {};
		data.boProdAns = OrderInfo.boProdAns;
		OrderInfo.setProdModifyBusiOrder(busiOrders,data);
	};	
	
	//订单数据校验
	var _checkData = function() {	
		if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 14 || (OrderInfo.actionFlag==2 && offerChange.newMemberFlag)){ //新装
			if(OrderInfo.cust.custId==""){
				$.alert("提示","客户信息不能为空！");
				return false ; 
			}
			//遍历主销售品构成
			if(OrderInfo.order.dealerTypeList==undefined ||OrderInfo.order.dealerTypeList.length == 0 ){
				$.alert("提示","发展人类型不能为空！");
				return false ; 
			}
			
			//纳入老用户判断主卡副卡账户一致
			if(ec.util.isArray(OrderInfo.oldprodAcctInfos)){
				for(var a=0;a<OrderInfo.oldprodAcctInfos.length;a++){
					var oldacctId = OrderInfo.oldprodAcctInfos[a].prodAcctInfos[0].acctId;
					var mainacctid = $("#acctSelect option:selected").val();
					if(oldacctId!=mainacctid){
						$.alert("提示","副卡和主卡的账户不一致！");
						return false ; 
					}
				}
			}
			
			//新装纳入老用户
			
			if(offerChange.oldMemberFlag){
				var paytype=$('select[name="pay_type_-1"]').val();
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.feeType.feeType!=paytype){
						$.alert("提示",this.accNbr+"和主卡的付费类型不一致！");
						return false ; 
					}
				});
			}
			
			//校验号码跟UIM卡
			if(!ec.util.isArray(OrderInfo.oldprodInstInfos)){
				for ( var i = 0; i < OrderInfo.offerSpec.offerRoles.length; i++) {
					var prodInsts=OrderInfo.offerSpec.offerRoles[i].prodInsts;
					if(prodInsts!=undefined && prodInsts!=null && prodInsts!=""){
					var offerRole = OrderInfo.offerSpec.offerRoles[i];
					for ( var j = 0; j < offerRole.prodInsts.length; j++) {
						var prodInst = offerRole.prodInsts[j];
						if(OrderInfo.actionFlag==2){
							var instid = '"'+prodInst.prodInstId+'"';
							if(prodInst.memberRoleCd=="401" && instid.indexOf("-")!=-1){
								var accNbr = OrderInfo.getProdAn(prodInst.prodInstId).accessNumber;
								if(accNbr==undefined || accNbr == ""){
									$.alert("信息提示","【接入产品("+offerRole.offerRoleName+")】号码不能为空！");
									return false;
								} 
								if(OrderInfo.getProdTd(prodInst.prodInstId)==""){
									$.alert("信息提示","【接入产品("+offerRole.offerRoleName+")】UIM卡不能为空！");
									$("#uim_txt_"+prodInst.prodInstId).css("border-color","red");
									return false;
								}
								var password = $("#pwd_"+prodInst.prodInstId).val();
								if(password!="******" && password!=undefined && password!=null && password!=""){
									var accNbr = OrderInfo.getProdAn(prodInst.prodInstId).accessNumber;
									if(!order.main.passwordCheckVal(password, accNbr)){
										return false ;
									}
								}
							}
						}
						else{
							var accNbr = OrderInfo.getProdAn(prodInst.prodInstId).accessNumber;
							if(accNbr==undefined || accNbr == ""){
								$.alert("信息提示","【接入产品("+offerRole.offerRoleName+")】号码不能为空！");
								return false;
							} 
							if(OrderInfo.getProdTd(prodInst.prodInstId)==""){
								$.alert("信息提示","【接入产品("+offerRole.offerRoleName+")】UIM卡不能为空！");
								$("#uim_txt_"+prodInst.prodInstId).css("border-color","red");
								return false;
							}
						}
						
						
						
						
						//封装产品属性
						var flag = false;
						$("[name='pay_type_-1']").each(function(){
							if($(this).val()!= undefined&&$(this).val()!=null&&$(this).val()!=""){
								flag = true ;
							}
						});
						if(!flag){
							$.alert("信息提示","没有配置付费类型，无法提交");
							return false;
						}
						
						//校验必填的产品属性
						var prodAttrFlag = true;
						var checkName = null;
						$(OrderInfo.prodAttrs).each(function(){
							var isOptional = this.isOptional;
							var id = this.id;
							if(isOptional == "N" && id){
								var val=$.trim($("#"+id).val());
								if(val == "" || val == undefined){
									checkName = this.name;
									prodAttrFlag = false;
								}
							}
						});
						if(!prodAttrFlag){
							$.alert("信息提示","没有配置产品属性("+checkName+")，无法提交");
							return false;
						}
						
						if(!order.main.templateTypeCheck()){
							return false;
						}
					}
				  }
				}
			}
			
			var oldMemberUimFlag = true;
			if(order.memberChange.oldMemberFlag){
				for ( var i = 0; i < OrderInfo.oldoffer.length; i++) {
					$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
						var member = this;
						if(member.objType == CONST.OBJ_TYPE.PROD){  //接入产品
							if(AttachOffer.isChangeUim(member.objInstId)){
								var td = OrderInfo.getProdTd(member.objInstId);
								if(td==""){
									$.alert("提示","加装移动电话"+member.accessNumber+" UIM卡不能为空！");
									oldMemberUimFlag = false;
									return false ; 
								}
							}
						}
					});
					if(!oldMemberUimFlag){
						break;
					}
				}
				if(!oldMemberUimFlag){
					return;
				}
			}
			
			var acctId = $("#acctSelect").val();
			if(acctId==undefined || $.trim(acctId)==""){
				$.alert("提示","请新建或者查询选择一个可用帐户");
				return false;
			}
			if(acctId<0){
				//帐户信息填写校验
				if(!_checkAcctInfo()){
					return false;
				}
			}
		}
		
		//销售品更功能产品参数校验
		if(OrderInfo.actionFlag == 1||OrderInfo.actionFlag == 2||OrderInfo.actionFlag == 3
				|| OrderInfo.actionFlag == 6||OrderInfo.actionFlag == 14){
			//附属销售参数设置校验
			for ( var i = 0; i < AttachOffer.openList.length; i++) {
				var specList = AttachOffer.openList[i].specList;
				var roleName = OrderInfo.getOfferRoleName(AttachOffer.openList[i].prodId);
				for (var j = 0; j < specList.length; j++) {
					var spec = specList[j];
					if(spec.isdel!="Y" && spec.isdel!="C"){
						if(spec.ifParams){  //销售参数节点
							if(spec.isset !="Y"){
								$.alert("提示",roleName+" "+spec.offerSpecName+"：参数未设置");
								return false ; 
							}
						}
					}
				}
			}
			//功能产品参数设置校验
			for ( var i = 0; i < AttachOffer.openServList.length; i++) {
				var specList = AttachOffer.openServList[i].servSpecList;
				var roleName = OrderInfo.getOfferRoleName(AttachOffer.openServList[i].prodId);
				for (var j = 0; j < specList.length; j++) {
					var spec = specList[j];
					if(spec.isdel!="Y" && spec.isdel!="C"){
						if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID && CONST.APP_DESC==0){
							if("no"==$("#isMIFI_-"+(i+1)).val()){
								$.alert("提示","要开通"+spec.servSpecName+"功能，请选择4G上网卡-全球卡（MIFI卡）！");
								$("#uim_txt_-"+(i+1)).css("border-color","red");
								return false ; 
							}
						}
						if(spec.ifParams=="Y"){  //销售参数节点
							if(spec.isset !="Y"){
								$.alert("提示",roleName+" "+spec.servSpecName+"：参数未设置");
								return false ; 
							}
						}
					}
				}
			}
			//附属销售参数终端校验
			for ( var i = 0; i < AttachOffer.openList.length; i++) {
				var specList = AttachOffer.openList[i].specList;
				var prodId = AttachOffer.openList[i].prodId;
				var roleName = OrderInfo.getOfferRoleName(prodId);
				for (var j = 0; j < specList.length; j++) {
					var spec = specList[j];
					if(spec.isdel!="Y" && spec.isdel!="C"){
						if(spec.isTerminal==1){  //1表示有终端
							var flag = true;
							$.each(OrderInfo.attach2Coupons,function(){
								if(spec.offerSpecId == this.attachSepcId && prodId==this.prodId){
									flag = false;
									return false;
								}	
							});
							if(flag){
								$.alert("提示",roleName+" "+spec.offerSpecName+"：终端信息未填写");
								return false ; 
							}
						}
					}
				}
			}
		}
		
		//套餐变更,可选包变更，补换卡校验
		if(CONST.getAppDesc()==0){
			if(OrderInfo.actionFlag == 2 ){ //套餐变更补换卡校验
				for ( var i = 0; i < OrderInfo.offer.offerMemberInfos.length; i++) {
					var member = OrderInfo.offer.offerMemberInfos[i];
					if(member.objType == CONST.OBJ_TYPE.PROD){  //接入产品
						if(AttachOffer.isChangeUim(member.objInstId)){
							var td = OrderInfo.getProdTd(member.objInstId);
							if(td==""){
								$.alert("提示",member.roleName+" UIM卡不能为空！");
								return false ; 
							}
						}
					}
				}
				var oldMemberUimFlag = true;
				if(offerChange.oldMemberFlag){
					for ( var i = 0; i < OrderInfo.oldoffer.length; i++) {
						$.each(OrderInfo.oldoffer[i].offerMemberInfos,function(){
							var member = this;
							if(member.objType == CONST.OBJ_TYPE.PROD){  //接入产品
								if(AttachOffer.isChangeUim(member.objInstId)){
									var td = OrderInfo.getProdTd(member.objInstId);
									if(td==""){
										$.alert("提示","加装移动电话"+member.accessNumber+" UIM卡不能为空！");
										oldMemberUimFlag = false;
										return false ; 
									}
								}
							}
						});
						if(!oldMemberUimFlag){
							break;
						}
					}
					if(!oldMemberUimFlag){
						return;
					}
				}
			}else if(OrderInfo.actionFlag == 3){ //可选包变更补换卡校验
				if(AttachOffer.isChangeUim()){
					if(OrderInfo.boProd2Tds.length==0){
						$.alert("提示","UIM卡不能为空！");
						return false ; 
					}
				}
			}
		}
		
		//补换卡校验
		if(OrderInfo.actionFlag == 22 || OrderInfo.actionFlag == 23){
			if(OrderInfo.boProd2OldTds.length==0){
				$.alert("提示","原UIM卡信息为空！");
				return false ; 
			}
			if(OrderInfo.boProd2Tds.length==0){
				$.alert("提示","UIM卡不能为空！");
				return false ; 
			}
		}
		
		//开通4G功能产品时，需要校验UIM，终端是否是4G
		if(CONST.getAppDesc()==0){
			for ( var i = 0; i < AttachOffer.openServList.length; i++) {
				var specList = AttachOffer.openServList[i].servSpecList;
				var flag = false;//是否开通4G上网功能产品
				var isTerminal=false;//是否有终端
				$.each(specList,function(){//遍历是否有开通4G上网功能
					if(this.servSpecId == CONST.PROD_SPEC.PROD_FUN_4G && this.isdel != "Y" && this.isdel != "C"){ //开通4G功能产品
						flag = true;
						return false;
					}
				});
				var prodId=AttachOffer.openServList[i].prodId;
				var termTypeFlag="";//终端类型
				
				if(AttachOffer.openList[i]!=undefined){
					var specListTemp = AttachOffer.openList[i].specList;
					for (var j = 0; j < specListTemp.length; j++) {
						var spec = specListTemp[j];
						if(spec.isdel!="Y" && spec.isdel!="C"){
							if(spec.isTerminal==1){  //1表示有终端
								$.each(OrderInfo.attach2Coupons,function(){//遍历是否有终端
									if(prodId==this.prodId){//有终端信息
										isTerminal = true;
										if(ec.util.isObj(this.termTypeFlag)){
											termTypeFlag=this.termTypeFlag;
										}
										return false;
									}	
								});
							}
						}
					}
				}
				
				var roleName = OrderInfo.getOfferRoleName(prodId);
				if(isTerminal && termTypeFlag==""){
					$.alert("信息提示",roleName+"中,营销资源未返回终端机型，无法判断是3G终端还是4G终端!");
					return false;
				}
				
				if(flag){ //该产品已经开通4G功能产品，需要做4G卡终端校验
					if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 14){ //新装
						var uim = OrderInfo.getProdUim(prodId);
						if(uim.cardTypeFlag=="2"){ //3g卡
							$.alert("信息提示",roleName+"中UIM卡是3G卡，无法提交");
							return false;
						}
						if(isTerminal && termTypeFlag=="2"){
							$.alert("信息提示",roleName+"中终端是3G机型，无法提交");
							return false;
						}
					}else if(OrderInfo.actionFlag == 2 || OrderInfo.actionFlag == 3 ){
						var oldUim = OrderInfo.getProdOldUim(prodId);
						if(oldUim.is4GCard!="Y"){//旧卡不是4G卡 就判断新卡是否是4G卡
							var uim = OrderInfo.getProdUim(prodId);
							if(uim.cardTypeFlag=="2"){
								$.alert("信息提示",roleName+"中UIM卡是3G卡，无法提交");
								return false;
							}
						}
						if(isTerminal && termTypeFlag=="2"){
							$.alert("信息提示",roleName+"中终端是3G机型，无法提交");
							return false;
						}
					}
				}else{//没有开通4G功能产品 就判断UIM卡和终端的类型要一致，4G终端匹配4GUIM卡 3G终端匹配3GUIM卡
					if(OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 6 || OrderInfo.actionFlag == 14){ //新装
						if(isTerminal){
							var uim = OrderInfo.getProdUim(prodId);
							if(uim.cardTypeFlag!=termTypeFlag){ //终端和卡不匹配
								var uimtype=uim.cardTypeFlag=="1"?"4G卡":"3G卡";
								var termtype=termTypeFlag=="1"?"4G机型":"3G机型";
								$.alert("信息提示",roleName+"中UIM卡是"+uimtype+" 终端是"+termtype+"，无法提交");
								return false;
							}
						}
					}else if(OrderInfo.actionFlag == 2 || OrderInfo.actionFlag == 3 ){
						if(isTerminal){
							var currentUimCoupon = OrderInfo.getProdUim(prodId); //当前uim卡物品信息，做套餐变更或可选包变更时可能带出补换卡业务，提交时使用新的uim检验终端
							if(ec.util.isObj(currentUimCoupon) && ec.util.isObj(currentUimCoupon.cardTypeFlag)){ //补换卡
								if(currentUimCoupon.cardTypeFlag=="2" && termTypeFlag=="1"){ 
									$.alert("信息提示",roleName+"中UIM卡是3G卡 终端是4G机型，无法提交");
									return false;
								}
								if(currentUimCoupon.cardTypeFlag=="1" && termTypeFlag=="2"){ 
									$.alert("信息提示",roleName+"中UIM卡是4G卡 终端是3G机型，无法提交");
									return false;
								}
							} else {  //未做补换卡
								var oldUim = OrderInfo.getProdOldUim(prodId);
								if(ec.util.isObj(oldUim.is4GCard)){
									if(oldUim.is4GCard!="Y"){//旧卡不是4G卡 
										if(termTypeFlag=="1"){
											$.alert("信息提示",roleName+"中UIM卡是3G卡 终端是4G机型，无法提交");
											return false; 
										}
									}else{
										if(termTypeFlag=="2"){
											$.alert("信息提示",roleName+"中UIM卡是4G卡 终端是3G机型，无法提交");
											return false;
										}
									}
								}
							}
							
						}
					}
				}
			}
		}
		
		return true; 
	};
	//帐户信息填写校验公用方法（新装，过户，帐户信息修改，改帐务定制关系）
	var _checkAcctInfo = function(){
		if($.trim($("#acctName").val())==""){
			$.alert("提示","帐户名称不能为空");
			return false;
		}
		if($("#paymentType").val()==110000){
			if($("#bankId").val()=="" || $.trim($("#bankAcct").val())=="" || $.trim($("#paymentMan").val())==""){
				$.alert("提示","若选择银行支付请填写必要的银行支付信息");
				return false;
			}
		}			
		if($("#postType").val()!=-1){
			if($.trim($("#postAddress").val())==""){
				$.alert("提示","若选择投递账单请填写必要的账单投递信息");
				return false;
			}
			if($("#postType").val()==13){
				var EmailType = /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/; // /^[^\.@]+@[^\.@]+\.[a-z]+$/;
				if(EmailType.test($("#postAddress").val())==false){
					$.alert("提示","若选择 Email 投递帐单请输入有效的 Email 地址");
					return false;
				}
			}
		}
		return true;
	};
	
	//修改资源状态
	var _updateResState= function() {
		var resources  = [];
		for (var i = 0; i < OrderInfo.boProdAns.length; i++) {	
			var res = {
				accNbr :OrderInfo.boProdAns[i].accessNumber,
				accNbrType : 1,  //号码类型（1手机号码2.UIM卡）
				action : "UPDATE"
			};
			resources.push(res);
		}
		for (var i = 0; i < OrderInfo.boProd2Tds.length; i++) {
			var res = {
				accNbr :OrderInfo.boProd2Tds[i].terminalCode,
				accNbrType : 2,  //号码类型（1手机号码2.UIM卡）
				action : "UPDATE"
			};
			resources.push(res);
		}
		if(resources.length>0){
			var url= contextPath+"/common/updateResState";	 
			$.callServiceAsJsonGet(url,{strParam:JSON.stringify(resources)},{
				"done" : function(response){
					if (response.code==0) {
						if(response.data){
						}
					}
				}
			});	
		}
	};
	
	//显示模板名称
	var _showTemplateOrderName = function(id){
		if($("#isTemplateOrder").attr("checked")=="checked"){
			if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==14){
				$(".template_info_type").show();
				$("#isActivation").removeAttr("checked");
				$("#isActivation").attr("disabled","disabled");
				//$("#templateTypeDiv").show();
				//$("#templateOrderName").show();
				//$("#templateOrderTitle").show();
			}
			$(".template_info_name").show();
		}else {
			$(".template_info_name").hide();
			$(".template_info_type").hide();
			$("#templateOrderName").val("");
			$("#isActivation").removeAttr("disabled");
			//$("#templateOrderTitle").hide();
			//$("#templateTypeDiv").hide();
			//$("#templateOrderName").val("");	
		}
	};
	
	//首话单激活
	var _showActivation = function(){
		if($("#isActivation").attr("checked")=="checked"){
			$("#isTemplateOrder").removeAttr("checked");
			$("#isTemplateOrder").attr("disabled","disabled");
			$(".template_info_name").hide();
			$(".template_info_type").hide();
			$("#templateOrderName").val("");
		}else {
			$("#isTemplateOrder").removeAttr("disabled");
		}
	};
	
	//重新排列offerRole 把按顺序把主卡角色提前
	var _sortOfferSpec = function(offerSpec){
		var tmpOfferSpecRole = [];
		for ( var i = 0; i < offerSpec.offerRoles.length; i++) {
			var offerRole = offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd==CONST.MEMBER_ROLE_CD.MAIN_CARD){ //主卡
				tmpOfferSpecRole.push(offerRole);
			}
		}
		for ( var i = 0; i < offerSpec.offerRoles.length; i++) {
			var offerRole = offerSpec.offerRoles[i];
			if(offerRole.memberRoleCd!=CONST.MEMBER_ROLE_CD.MAIN_CARD){
				tmpOfferSpecRole.push(offerRole);
			}
		}
		offerSpec.offerRoles = tmpOfferSpecRole;
		return offerSpec;
	};
	
	var _checkOrder=function(){
		var flag = false;
		var prodClass = order.prodModify.choosedProdInfo.prodClass; //可选包变更
		var prodId = order.prodModify.choosedProdInfo.prodInstId;
		var specList=CacheData.getOfferSpecList(prodId);
		if(ec.util.isArray(specList)){
			$.each(specList,function(){
				if(this.ifPackage4G=="Y" && this.isdel != "Y" && this.isdel != "C"){ //是否有开通4g流量包
					flag = true;
					return false;
				}
			});
		}
		if(CONST.getAppDesc()==0 && flag && prodClass==CONST.PROD_CLASS.THREE && OrderInfo.actionFlag==3){//可选包变更 且是3G用户套餐 开通了4G流量包 必须进行省预校验
			if(offerChange.checkOrder()){//省预校验
				var content=offerChange.checkAttachOffer(prodId);
				if(content!=""){
					if(_checkData()){
						$("#offer_serv").html(content);
						easyDialog.open({
							container : 'offer_dialog'
						});
					}
//					$.confirm("信息确认",content,{ 
//						yesdo:function(){
//							if(_checkData()){
//								AttachOffer.setChangeList(prodId);
//								SoOrder.submitOrder();
//							}
//						},
//						no:function(){
//						}
//					});
				}else{
					SoOrder.submitOrder();
				}
			}
		}else{
			SoOrder.submitOrder();
		}
	};
	var _orderPrepare=function(){
		var prodId = order.prodModify.choosedProdInfo.prodInstId;
		AttachOffer.setChangeList(prodId);
		SoOrder.submitOrder();
		easyDialog.close();
	};
	
	//判断是否是3G转4G
	var _setOfferType=function(){
		var oldType=order.prodModify.choosedProdInfo.is3G;
		if(OrderInfo.actionFlag==2){
			var newType=OrderInfo.offerSpec.is3G;
			if(ec.util.isObj(oldType)){
				if(ec.util.isObj(newType)){
					if(oldType=="Y"&&newType=="N"){
						return true;
					}
				}
			}
		}else if(OrderInfo.actionFlag==3){
			if(ec.util.isObj(oldType)){
				if(oldType=="Y"){
					for ( var i = 0; i < AttachOffer.openServList.length; i++) {
						var specList = AttachOffer.openServList[i].servSpecList;
						var flag = false;//是否开通4G上网功能产品
						$.each(specList,function(){//遍历是否有开通4G上网功能
							if(this.servSpecId == CONST.PROD_SPEC.PROD_FUN_4G && this.isdel != "Y" && this.isdel != "C"){ //开通4G功能产品
								flag = true;
								return false;
							}
						});
						if(flag){
							return true;
						}
					}
				}
			}
		}
		return false;
	};
	return {
		builder 				: _builder,
		createAttOffer  		: _createAttOffer,
		createServ				: _createServ,
		delOrder 				: _delOrder,
		delAndNew				: _delAndNew,
		getOrderInfo 			: _getOrderInfo,
		getToken				: _getToken,
		getTokenSynchronize : _getTokenSynchronize,
		initFillPage			: _initFillPage,
		initOrderData			: _initOrderData,
		orderBack				: _orderBack,
		step					: _step,
		showStep				: _showStep,
		submitOrder 			: _submitOrder,
		checkAcctInfo  			: _checkAcctInfo,
		showTemplateOrderName   : _showTemplateOrderName,
		sortOfferSpec			: _sortOfferSpec,
		updateResState			: _updateResState,
		delOrderBegin			: _delOrderBegin,
		delOrderSilent			: _delOrderSilent,
		delOrderFin				: _delOrderFin,
		showActivation			: _showActivation,
		checkOrder				: _checkOrder,
		orderPrepare			: _orderPrepare,
		createProd:_createProd
	};
})();
/**
 * 补换卡
 * 
 * @author wukf
 * date 2013-08-22
 */
CommonUtils.regNamespace("prod","changeUim");

prod.changeUim = (function() {
	
	//初始化
	var _init = function(){
		var prod = order.prodModify.choosedProdInfo;
		//客户级规则校验入参
		var param = {
			"areaId" : OrderInfo.staff.soAreaId, //地区ID
			"custId" : OrderInfo.cust.custId, //客户ID
			"staffId" : OrderInfo.staff.staffId,
			"channelId" : OrderInfo.staff.channelId,
			"boInfos":[{
				"boActionTypeCd": CONST.BO_ACTION_TYPE.CHANGE_CARD,//动作类型
			    "instId" : prod.prodInstId, //实例ID
			    "specId" : CONST.PROD_SPEC.CDMA //产品（销售品）规格ID
			}]
		};
		var area = $("#DiffPlaceFlag").val();
		var actionFlag = 22;
		var areaAtionType = "";
		var opeName = "";
		if(area=="diff"){
			actionFlag = 23;
			areaAtionType = CONST.BO_ACTION_TYPE.DIFF_AREA_CHANGE_CARD;
			opeName = "异地补换卡";
			var areaid = prod.areaId;
			if(areaid==undefined || areaid==''){
				$.alert("提示","营业后台未返回产品归属地区，无法办理异地补换卡业务！");
				return false;
			}
		}else{
			areaAtionType = CONST.BO_ACTION_TYPE.CHANGE_CARD;
			opeName = "补换卡";
		}
		var callParam = {
			prodId : prod.prodInstId 	
		};
		OrderInfo.initData(CONST.ACTION_CLASS_CD.PROD_ACTION,areaAtionType,actionFlag,opeName,"");
		rule.rule.prepare(param,'prod.changeUim.initFillPage',callParam);
		
		$("#dlg_cust_prod").popup("close");
	};
	
	//初始化填单页面
	var _initFillPage = function(param){
		if(!prod.uim.setProdUim()){ //根据UIM类型，设置产品是3G还是4G，并且保存旧卡
			return false;
		}
		var prodInfo = order.prodModify.choosedProdInfo;
		$.callServiceAsHtml(contextPath+"/pad/prod/changeCard", param, {
			"before":function(){
			},
			"done" : function(response){
				$("#order_tab_panel_content").html(response.data).show();
				$.jqmRefresh($("#order_tab_panel_content"));
				$("#fillLastStep").click(function(){
					order.prodModify.cancel();
				});
				$("#nothreelinks").css("display","none");
				$(".ordercon").show();
				$(".ordertabcon").show();
				$(".ordertitle").append(prodInfo.productName+"-"+prodInfo.accNbr);
				order.prepare.step(1);
				$("#orderedprod").hide();
				$("#order_prepare").hide();
//				alert($("#DiffPlaceFlag").val());
				if($("#DiffPlaceFlag").val() == 'diff'){
					$("#uim_txt_" + prodInfo.prodInstId).css("display","none");
					$("#uim_check_btn_" + prodInfo.prodInstId).css("display","none");
					$("#uim_release_btn_" + prodInfo.prodInstId).css("display","none");
					$("#uim_lable").text("写卡：");
				}
				
				var nowActionFalg=OrderInfo.actionFlag;
				
				if(nowActionFalg=="22" || nowActionFalg=="23"){
					var $uimDivs = $("div[id^='uimDiv_']");
					$.each($uimDivs,function(index,$uimDiv){
						$($uimDiv).show();
					});
				}
			},
			"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	//订单提交
	var _submit = function(){
		var prod = order.prodModify.choosedProdInfo;
		var param = {
			prodId : prod.prodInstId,	
			boActionTypeCd : OrderInfo.boActionTypeCd,
			remark : $("#orderRemark").val()
		};
		var busiOrder = [];
		busiOrder.push(OrderInfo.getProdBusiOrder(param));
		SoOrder.submitOrder(busiOrder);
	};
	
	return {
		init				: _init,
		initFillPage		: _initFillPage,
		submit 				: _submit
	};
})();
/**
 * 客户资料管理
 */
CommonUtils.regNamespace("order", "uiCusts");

order.uiCusts = (function(){
	var num=0;
	var _newAddList = [];
	var _newMemberFlag = false;
	var _oldMemberFlag = false;
	var objInsterId="";
	var choosenum = 1;//纳入老用户数量
	var idnum = 1;
	var maxNum = 0;
	var _called = false;
	var _choosedCustInfo = {};
	var _createCustInfo = {};
	var _custInfo = null;
	var _authFlag = null;
	var _fromProvFlag = "0"; //省份甩单标志
	var _provIsale = null; //省份isale流水号
	//客户鉴权跳转权限
	var _jumpAuthflag="";
	//客户属性
	var _partyProfiles =[];
	//客户属性分页列表
	var _profileTabLists =[];
	
	var _getCustInfo = function() {
		return _custInfo;
	};
	var _orderBtnflag="";
	
	var _packageInfo={
		provIsale:"",
		redirectUri:"",
		isFee:"",
		reloadFlag:""
	}

	var _orderInfo;
	
	var showDialogInfo=function(content){
		$.ligerDialog.waitting("<div style='width:100%;text-align:center;font-size:15px;'>"+content+"</div>");
	}
	
	var _showPackageDialog=function(msg){
		var html="<table class=\"contract_list rule\">";
		html+='<thead><tr> <td colspan="2">提示</td></tr></thead></table>';
		html+="<div id=\"rules_div\" height=\"height:140px;\">";
		html+='<table width="100%" height="120px;" border="0" cellspacing="0" cellpadding="0">';
		html+='<tr>';
		html+='<td align="right"></td>';
		html+="<td><div class=\"rule_font\" style=\"width:100%;font-size:15px; text-align:center;\">"+msg+"</div></td>";
		html+='</tr>';
		html+='</table>';
		html+='</div>';
		easyDialog.open({
			container : 'packageTip_dialog'
		});
		$("#infoTipContent").html("");
		$("#infoTipContent").html(html);
	};
	
	var _packageQuery=function(){
		OrderInfo.busitypeflag=2;
		//开始可选包前进行重载校验 
		var isReload=OrderInfo.provinceInfo.reloadFlag;
		var url=contextPath+"/order/createorderlonger";
		var response = $.callServiceAsJson(url, {});
		if(response.code==0){
			OrderInfo.custorderlonger=response.data;
		}
		if(OrderInfo.provinceInfo.mergeFlag=="0"){
			_custLookforButton();
		}else{
			var provCustAreaId = $("#custAreaId_").val();
			if(order.cust.mgr.queryCustCompreInfo(OrderInfo.provinceInfo.mainPhoneNum,provCustAreaId,2,'')){
				_showoffer();
			}
		}
	};
	
	//客户定位开始 [1]
	var _custLookforButton = function() {
		var identityCd="";
		var idcard="";
		var diffPlace="";
		var acctNbr="";
		var identityNum="";
		var queryType="";
		var queryTypeValue="";
		identityCd=$("#p_cust_identityCd").val();
		identityNum=OrderInfo.provinceInfo.mainPhoneNum;//$.trim($("#p_cust_identityNum").val());
		//判断是否是号码或身份证输入

		//省份甩单定位客户不需要进行客户鉴权
		if(order.cust.mgr.fromProvFlag == "1" || (identityCd!=-1 && CONST.getAppDesc()!=0)){
			identityCd=$("#p_cust_identityCd").val();
			_authFlag="1";
		}else{
			//4G所有证件类型定位都需要客户鉴权
			_authFlag="0";
		}
		if(identityCd==-1){
			acctNbr=identityNum;
			identityNum="";
			identityCd="";
		}else if(identityCd=="acctCd"||identityCd=="custNumber"){
			acctNbr="";
			identityNum="";
			identityCd="";
			queryType=$("#p_cust_identityCd").val();
			queryTypeValue=$.trim($("#p_cust_identityNum").val());

		}
		diffPlace=$("#DiffPlaceFlag").val();
		
		//旧客户定位地市是获取工号地市，暂不用
		areaId=$("#p_cust_areaId").val();
		
		//改为使用参数中的地市进行定位
		//areaId=$("#custAreaId_").val();
		
		if(areaId==null || areaId=="" || areaId=="null" || areaId=="undefined"){
			$.alert("提示","用于客户定位的地市为空，请重试!");
			return;
		}
		
		//lte进行受理地区市级验证
		if(CONST.getAppDesc()==0&&areaId.indexOf("0000")>0){
			$.alert("提示","省级地区无法进行定位客户,请选择市级地区！");
			return;
		}
		
		var param = {
			"acctNbr"		:acctNbr,
			"identityCd"	:identityCd,
			"identityNum"	:identityNum,
			"partyName"		:"",
			"custQueryType"	:$("#custQueryType").val(),
			"diffPlace"		:diffPlace,
			"areaId" 		:areaId,
			"queryType" 	:queryType,
			"queryTypeValue":queryTypeValue
		};
		$.callServiceAsHtml(contextPath+"/token/pad/cust/queryCustSub",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if (response.code == -2) {
					return;
				}
				_queryCallBack(response);
			},fail:function(response){
				$.unecOverlay();
				$.alert("提示","查询失败，请稍后再试！");
			},"always":function(){
				$.unecOverlay();
				$("#usersearchbtn").attr("disabled",false);
			}
		});
	};
	
	//客户查询列表 [2]
	var _queryCallBack = function(response) {
		if(response.data.indexOf("false") >=0) {
			$.alert("提示","抱歉，没有定位到客户，请尝试其他客户。");
			return;
		}
		var _qry_result = $("#div_user_qry_result");
		
		_qry_result.find("ul").html(response.data);
		$("#a_cust_qry_back").off("tap").on("tap",function(event) {
			_authFlag="";
		});
		
		$.jqmRefresh(_qry_result);
	};
	
	//客户列表点击 [3]
	var _showCustAuth = function(scope) {
		
		var _this = $(scope);
		_choosedCustInfo = {
			custId 			: _this.attr("custId"),
			partyName 		: _this.attr("partyName"),
			idCardNumber 	: _this.attr("idCardNumber"),
			identityName 	: _this.attr("identityName"),
			areaName 		: _this.attr("areaName"),
			areaId 			: _this.attr("areaId"),
			identityCd 		: _this.attr("identityCd"),
			addressStr 		: _this.attr("addressStr"),
			norTaxPayer 	: _this.attr("norTaxPayer"),
			segmentId 		: _this.attr("segmentId"),
			segmentName 	: _this.attr("segmentName"),
			custFlag 		: _this.attr("custFlag"),
			vipLevel 		: _this.attr("vipLevel"),
			vipLevelName 	: _this.attr("vipLevelName")
		};
		if(_authFlag=="0"){
			if(order.cust.mgr.authType == '00'){//动态追加,内部没定义
				$("#custAuthTypeName").html("客户密码：");
			} else {
				$("#custAuthTypeName").html("产品密码：");
			}
			if(order.cust.mgr.jumpAuthflag=="0"){
				$("#jumpAuth").show();
				$("#jumpAuth").off("tap").on("tap",_jumpAuth);
			}else{
				$("#jumpAuth").hide();				
			}
			$("#authPassword").val("");
			$("#custAuthbtn").off("tap").on("tap",_bindChkAuth);
			
			//不需要弹出验证弹框
			//$("#dlg-chk-auth").popup("open");
			
			//直接无需验证
			_jumpAuth();
		} else{
			_custAuth(scope);
		}
	};
	
	//跳过验证 [4]
	var _jumpAuth = function() {
		if(order.cust.mgr.jumpAuthflag!="0"){
			$.alert("提示","没有跳过校验权限！");
			return;
		}
		var param = _choosedCustInfo;
		param.authFlag="1";
		$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				
				_custInfo = param;
				OrderInfo.boCusts.prodId=-1;
				OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
				OrderInfo.boCusts.partyProductRelaRoleCd="0";
				OrderInfo.boCusts.state="ADD";
				OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
				
				OrderInfo.cust = _choosedCustInfo;
				
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	//鉴权回调 [5]
	var _custAuthCallBack = function(response) {
		if(_authFlag=="0"){
			$("#dlg-chk-auth").popup("close");
		}
		//隐藏查询选项,展示查询后结果
		$("#custQueryFirstForm").hide();
		$("#custInfo").html(response.data).show().enhanceWithin();
		
		if((OrderInfo.boCusts.partyId != "-1" && OrderInfo.boCusts.partyId != ""	
			 && OrderInfo.boCusts.partyId != undefined) && order.prodModify.lteFlag == true){
			$("#a-cust-modify").hide();
		}else{
			$("#a-cust-modify").show();
			$("#a-cust-modify").off("tap").on("tap",order.prodModify.showCustInfoModify);
		}
		//绑定事件
		$("#a-cust-rechk").off("tap").on("tap",_custReset);
		$("#a-qry-cust-prod").off("tap").on("tap",_btnQueryCustProdMore);
		$("#cCustName").val("");
		$("#cCustIdCard").val("");
		
		main.home.hideMainIco();
		
		//查询客户产品[5-1]
		_btnQueryCustProdMore();
	};
	
	//已订购业务 页面 [6]
	var _btnQueryCustProdMore=function(){
		if(OrderInfo.cust.custId==-1){
			$.alert("提示","新建客户无法查询已订购业务！");
			return;
		}		
		//初次查询
		if(_orderBtnflag==""){
			_btnQueryCustProdPrepare();
			_orderBtnflag="1";
			//二次进入
		}else if(_orderBtnflag=="1"){
			$("#dlg_cust_prod").popup("open",{transition:"slide"});
			_orderBtnflag="1";
			//关闭
		}else{
			$("#dlg_cust_prod").popup("close");
			_orderBtnflag="1";
		}
	};
	
	//已订购业务查询 入口 [7]
	_btnQueryCustProdPrepare = function(){
		$.callServiceAsHtmlGet(contextPath+"/token/pad/cust/orderProdPrepare.html",{"diffPlaceFlag":$("#diffPlaceFlag").val()},{
			"before":function(){
				//$.ecOverlay("<strong>查询中,请稍等...</strong>");
			},
			"always":function(){
				//$.unecOverlay();
			},
			"done" : function(response){
				if(!response || response.code != 0) {
					$.alert("提示","已订购业务查询失败,稍后重试");
					return;
				}
				$.popup("#dlg_cust_prod",response.data,{
					width:$(window).width()-200,
					height:$(window).height(),
					contentHeight:$(window).height()-120,
					afterClose:function(){},
					cache:true
				});
				$(".ui-panel-inner > .ui-listview").height($(window).height());
				_btnQueryCustProd(1);
			}
		});
	}
	
	//已订购业务查询分页   [8]
	var _btnQueryCustProd=function(curPage,scroller){
		//收集参数
		var param={};
		if(!_choosedCustInfo || !$.isPlainObject(_choosedCustInfo) || $.isEmptyObject(_choosedCustInfo)){
			param.custId="";
		}else{
			param.custId=_choosedCustInfo.custId;
			param.areaId =$("#area").attr("areaId");
		}
		//产品号码查询条件
		if($("#accNbrQuery").length == 1){
			param.acctNbr=$.trim($("#accNbrQuery").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
			//是否指定号码
		} else if($("#isAppointNum").attr("value")=="1"){
			param.acctNbr=$.trim($("#p_cust_identityNum").val());
			if(CONST.getAppDesc()==0){
				param.areaId=$("#p_cust_areaId").val();
			}
		}else {
			param.acctNbr="";
		}
		param.pageSize="8";
		param.curPage=curPage;
		//param.diffPlaceFlag=$("#diffPlaceFlag").val();
		if(!(param.custId) || param.custId==""){
			$.alert("提示","无法查询已订购产品");
			return;
		}
		
		//获取查询号码[8-1]
		param.acctNbr=OrderInfo.provinceInfo.mainPhoneNum;
		
		//订购产品查询
		var url = contextPath+"/pad/cust/orderProdSub";
		$.callServiceAsHtmlGet(url,param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(!response || response.code != 0) {
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				//填充数据,
				var ul$ = $("#dlg_cust_prod").find("ul:first");
				if(curPage == 1)ul$.html(response.data);
				else ul$.append(response.data);
				ul$.listview().listview("refresh");
				//绑定每行合约tap事件 父级
				ul$.find("li").off("tap").on("tap",function(){
					var _this = $(this);
					if(_this.hasClass("multi")){
						if(_this.next(".multidiv").is(":hidden")){
							_this.next(".multidiv").show().siblings(".multidiv").hide();
						} else {
							_this.next(".multidiv").hide().siblings(".multidiv").hide();
						}
					}
					_chk2ndOrderFinish(this,function(){
						_this.addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg");
						$("#div_2nd_order").panel( "open" );
					});
				});
				//子级
				ul$.find("div.multidiv li").off("tap").on("tap",function(){
					_chk2ndOrderFinish(this,function(){
						$(this).addClass("userorderlistlibg").siblings().removeClass("userorderlistlibg").parent().siblings("li").removeClass("userorderlistlibg");
						$("#div_2nd_order").panel( "open" );
						order.prodModify.getChooseProdInfo();
					});
				});
				//如果存在数据,默认选中首行
				ul$.find("li:first").trigger("tap").next("div.multidiv li:first").trigger("tap");
				
				order.prodModify.getChooseProdInfo();
				
				//进入具体的功能页面[8-2]
				//order.prodModify.orderAttachOffer();
				//order.uiCusts.showOffer();
				//判断获取客户业务信息是否正确
				if($("#searchInfos_") && $("#searchInfos_").val()=="0"){
					_showoffer();
				}
			}
		});	
	};
	
	
	
	//绑定鉴权事件
	var _bindChkAuth = function(){
		$('#custAuthForm').off("formIsValid").on('formIsValid', function(event, form) {
			var param = _choosedCustInfo;
			param.prodPwd = $.trim($("#authPassword").val());
			param.accessNumber=_choosedCustInfo.accessNumber;
			param.authFlag=_authFlag;
			$.callServiceAsHtml(contextPath+"/cust/custAuth",param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
				},"done" : function(response){
					if (response.code == -2) {
						return;
					}
					if(response.data.indexOf("false") >=0) {
						$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
						return;
					}
					//判断能否转为json，可以的话返回的就是错误信息
					try {
						var errorData = $.parseJSON(response.data);
						$.alertMore("异常信息", errorData.resultMsg, errorData.errorStack,"error");
						return;
					} catch(e){
						
					}
					_custInfo = param;
					OrderInfo.boCusts.prodId=-1;
					OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
					OrderInfo.boCusts.partyProductRelaRoleCd="0";
					OrderInfo.boCusts.state="ADD";
					OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
					
					OrderInfo.cust = _choosedCustInfo;
					_custAuthCallBack(response);
				},"always":function(){
					$.unecOverlay();
				}
			});
		}).ketchup({bindElement:"custAuthbtn"});
	}
	//客户类型选择事件 ok
	var _partyTypeCdChoose = function(scope,id) {
		var partyTypeCd=$(scope).val();
		_certTypeByPartyType(partyTypeCd,id);
		//创建客户确认按钮
		_custCreateButton();

	};
	//客户类型关联证件类型下拉框     ok
	var _certTypeByPartyType = function(_partyTypeCd,id){
		var _obj = $("#"+id);
		$.callServiceAsJson(contextPath+"/cust/queryCertType", {"partyTypeCd":_partyTypeCd}, {
			"before":function(){
			},"done" : function(response){
				if (response.code == -2) {
					$.alertM(response.data);
					return false;
			  	}
			   	if (response.code == 1002) {
					$.alert("错误","根据员工类型查询员工证件类型无数据,请配置","information");
					return;
			   	}
			   	if(response.code==0){
					var data = response.data ;
					if(data!=undefined && data.length>0){
						//去除重复的证件类型编码
						var uniData = [];
						for(var i=0;i<data.length;i++){
							var unique = true;
							for(var j=0;j<uniData.length;j++){
								unique = unique && data[i].certTypeCd != uniData[j].certTypeCd;
								if(!unique){
									break;
								}
							}
							if(unique){
								uniData.push(data[i]);
							}
						}
						for(var i=0;i<uniData.length;i++){
							var certTypedate = uniData[i];
							_obj.append("<option value='"+certTypedate.certTypeCd+"' >"+certTypedate.name+"</option>");
						}
						//jquery mobile 需要刷新才能生效
						_obj.selectmenu().selectmenu('refresh');
						if(id=='identidiesTypeCd'){
							//创建客户证件类型选择事件
							_identidiesTypeCdChoose($("#"+id).children(":first-child"),"cCustIdCard");
						}
					}
				}
			},fail:function(response){
			},always:function(){
				
			}
	   });
	};
	//客户定位证件类型选择事件  ok
	var _custidentidiesTypeCdChoose = function(scope,id) {
		var identidiesTypeCd=$(scope).val();
		if(identidiesTypeCd==-1){
			$("#"+id).attr("placeHolder","请输入接入号码");
			$("#"+id).attr("data-validate","validate(required:请准确填写接入号码) on(blur)");
		}else if (identidiesTypeCd==1){
			$("#"+id).attr("placeHolder","请输入身份证号码");
			$("#"+id).attr("data-validate","validate(idCardCheck:请准确填写身份证号码) on(blur)");
		}else if(identidiesTypeCd==2){
			$("#"+id).attr("placeHolder","请输入军官证");
			$("#"+id).attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}else if(identidiesTypeCd==3){
			$("#"+id).attr("placeHolder","请输入护照");
			$("#"+id).attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}else{
			$("#"+id).attr("placeHolder","请输入证件号码");
			$("#"+id).attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		if(identidiesTypeCd!=-1){
			$("#isAppointNum").val("0").slider().slider("refresh");
		}
		_custLookforButton();

	};
	//创建客户证件类型选择事件
	var _identidiesTypeCdChoose = function(scope,id) {
		var identidiesTypeCd=$(scope).val();
		var _obj = $("#"+id);
		if(identidiesTypeCd==1){
			_obj.attr("placeHolder","请输入合法身份证号码");
			_obj.attr("data-validate","validate(idCardCheck18:请输入合法身份证号码) on(blur)");
		}else if(identidiesTypeCd==2){
			_obj.attr("placeHolder","请输入合法军官证");
			_obj.attr("data-validate","validate(required:请准确填写军官证) on(blur)");
		}else if(identidiesTypeCd==3){
			_obj.attr("placeHolder","请输入合法护照");
			_obj.attr("data-validate","validate(required:请准确填写护照) on(blur)");
		}else{
			_obj.attr("placeHolder","请输入合法证件号码");
			_obj.attr("data-validate","validate(required:请准确填写证件号码) on(blur)");
		}
		_custCreateButton();

	};
	
	//创建客户确认按钮
    var _custCreateButton = function() {
	    $('#custCreateForm').off('formIsValid').on('formIsValid',function(event) {
	    	var url=contextPath+"/order/createorderlonger";
			var response = $.callServiceAsJson(url, {});
			if(response.code==0){
				OrderInfo.custorderlonger=response.data;
			}
			_checkIdentity();
	     }).ketchup({bindElement:"btn_cust_create_save"});
    };
	
	// 客户重新定位 ok
	var _custReset = function() {
		//填单页面
		//if(0!=OrderInfo.order.step){
			window.location.reload();
		//}
		$("#custQueryFirstForm").show();
		$("#custInfo").hide();
		$("#p_cust_identityNum").val("");
		$("#authPassword").val("");
		_authFlag="";
		OrderInfo.boCusts.partyId="";
		//新建客户
		OrderInfo.boCustInfos.name="";
		OrderInfo.boCustIdentities.identityNum="";
		OrderInfo.cust = {
			custId:-1,	
			custName : "",
			areaId:""
		};
		//定位客户
		OrderInfo.boCusts.prodId=-1;
		OrderInfo.boCusts.partyId="";
		OrderInfo.boCusts.partyProductRelaRoleCd="0";
		OrderInfo.boCusts.state="ADD";
		OrderInfo.cust = "";
		//已订购查询是不是查询标志
		_orderBtnflag="";
		//填单步骤
		OrderInfo.order.step=0;
		if((CONST.getAppDesc()!=0)&&($("#custModifyId").is(":hidden"))){
			$("#a-cust-modify").show();
		}
		
	};
	
	//客户鉴权 ok
	var _custAuth = function(scope) {
		var param = _choosedCustInfo;
		param.prodPwd = $.trim($("#authPassword").val());
		param.authFlag=_authFlag;
		$.callServiceAsHtml(contextPath+"/cust/custAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				_custInfo = param;
				OrderInfo.boCusts.prodId=-1;
				OrderInfo.boCusts.partyId=_choosedCustInfo.custId;
				OrderInfo.boCusts.partyProductRelaRoleCd="0";
				OrderInfo.boCusts.state="ADD";
				OrderInfo.boCusts.norTaxPayer=_choosedCustInfo.norTaxPayer;
				
				OrderInfo.cust = _choosedCustInfo;
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
	};
	
	//创键客户 ok
	var _showCustCreate = function() {
		var areaId=$("#p_cust_areaId").val();
		if(areaId.indexOf("0000")>0){
			$.alert("提示","前页受理地区为省级地区无法进行创建,请先选择市级地区！");
			return;
		}
		$.callServiceAsHtmlGet(contextPath+"/pad/cust/create.html",{},{
			"done" : function(response){
				if (!response || !response.data) {
					return;
				}
				//统一弹出框
				var popup = $.popup("#div_cust_create",response.data,{
					cache:true,
					width:$(window).width()-200,
					height:$(window).height(),
					contentHeight:$(window).height()-120,
					afterClose:function(){if($.ketchup) $.ketchup.hideAllErrorContainer($("#custCreateForm"));}
				});
				//由于脚本静态,所以要清理之前有可能创建的客户资料信息
				$("#div_cust_create input[type='text']").val("");
				//初始化页面数据
				_partyTypeCdChoose($("#partyTypeCd").children(":first-child"),"identidiesTypeCd");
				_spec_parm_show();
				//更多属性默认隐藏,并绑定打开事件
				popup.find("div[data-role='collapsible']").collapsible({
				  	collapsed: true,
					collapse: function( event, ui ) {
						$("#contactName").attr("data-validate","");
						_custCreateButton();
					},
				  	expand: function(event,ui) {
						$("#contactName").attr("data-validate","validate(required:请准确填写联系人名称) on(blur)").attr("placeholder","请准确填写联系人名称");
						_custCreateButton();
				  	}
				});
			}});
	};
	
	var _linkSelectPlan=function(selected){
		//二层选择取消
		$("#plan2ndDiv tbody tr").removeClass("plan_select2");
		//勾取消
		$("#plan2ndDiv tbody tr").children(":first-child").next().html("");
		$(selected).addClass("plan_select2");
		//打勾操作
		var nike="<i class='select'></i>";
		$(selected).children(":first-child").next().html(nike);
		order.prodModify.getChooseProdInfo();
		
	};
	
	//判断二次业务办理时,切换已订购
	var _chk2ndOrderFinish = function(obj,cb){
		if(1==OrderInfo.order.step&&(!$(obj).hasClass("userorderlistlibg"))){
			$.confirm("确认","你已重新选择号码，需跳转至上一步，是否确认?",{
				yes:function(){
					_cancel();
					OrderInfo.order.step=0;
					cb.apply(this,[]);
				},
				no:function(){}
			});
		}else if(2==OrderInfo.order.step&&(!$(obj).hasClass("userorderlistlibg"))){
			$.confirm("确认","你已重新选择号码，需取消订单，是否确认?",{
				yes:function(){
					SoOrder.orderBack();
					_cancel();
					OrderInfo.order.step=0;
					cb.apply(this,[]);
				},
				no:function(){}
			});
		}else{
			cb.apply(this,[]);
		}
	}
	
	//定位客户选择地区 ok
	var _chooseArea = function(){
		order.pad.area.chooseAreaTree("order/prepare","p_cust_areaId_val","p_cust_areaId",3);
	};
	//客户信息查询户选择地区
	var _preQueryCustChooseArea = function(){
		order.area.chooseAreaTreeManger("cust/preQueryCust","p_areaId_val","p_areaId",3);
	};
	//异地定位客户选择地区
	var _chooseAllArea = function(){
		order.area.chooseAreaTreeAll("p_cust_areaId_val","p_cust_areaId",3,"limitProvince");
	};
	//新建客户选择地区
	var _newCustChooseArea = function(){
		order.area.chooseAreaTree("order/prepare","p_ncust_areaId_val","p_ncust_areaId",3);
	};
	//已订购选择地区
	var _prodChooseArea = function(){
		order.area.chooseAreaTree("order/prepare","prodareaName","prodareaid",3);
		order.prodModify.choosedProdInfo.areaId=$("#prodareaid").val();
	};
	//定位客户证件类型下拉框 ok
	var _init = function(){
		$("#p_cust_identityCd").off("change").on("change",function(){
			_custidentidiesTypeCdChoose($(this).find("option:selected"),"p_cust_identityNum");
			$("#p_cust_identityCd").selectmenu().selectmenu('refresh');
		})
		_certTypeByPartyType("-1","p_cust_identityCd"); //客户定位也使用根据客户类型查询证件类型接口，p_cust_identityCd=-1表示查询所有已关联的证件类型
		$("#isAppointNum").off("change").on("change",_isAppointNum);
		//省份甩单，自动定位客户
		_checkAutoCustQry();
		//绑定创建客户事件
		$("#a_user_create").off("tap").on("tap",_showCustCreate);
		//绑定查询校验事件
		_custLookforButton();
	};
	//使用带入的客户信息自动定位客户 ok
	var _checkAutoCustQry = function(){
		if($("#fromProvFlag").length && $("#fromProvFlag").val() == "1"){
			order.cust.mgr.fromProvFlag = "1";
			order.cust.mgr.provIsale = $("#provIsale").val();
			$("#p_cust_areaId_val").val("");
			$("#p_cust_areaId").val($("#provAreaId").val());
			$("#p_cust_identityCd").val($("#provIdentityCd").val());
			$("#p_cust_identityNum").val($("#provIdentityNum").val());
			if($("#provIdentityCd").val()!=-1){
				$("#isAppointNum").attr("checked",false);
			}
			$("#a_user_search").click();
		} else {
			order.cust.fromProvFlag = "0";
			order.cust.provIsale = null;
		}
	};
	//客户所有属性初始化-展示 ok
	var _spec_parm_show = function(){
		$.callServiceAsHtmlGet(contextPath + "/pad/cust/partyProfileSpecList",{}, {
			"before":function(){
				$.ecOverlay("<strong>加载更多属性,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},"fail":function(){
				$.alert("提示","属性加载异常,请稍后重试.");
				$.unecOverlay();
			},
			"done" : function(response){
				if (response.code == -2) {
					return;
				}
				var pp = $("#partyProfile").html(response.data);
				$("#otabs li").on("tap",function(){_changeLabel($(this));});
				$.jqmRefresh(pp);
			}
		});	
		
	};
	//客户信息查询定位客户
	var _queryCust = function(){
		var identityCd="";
		var acctNbr="";
		var identityNum="";
		identityCd=$("#p_cust_identityCd").val();
		identityNum=$.trim($("#p_cust_identityNum").val());
		if(identityNum==""){
			$.alert("提示","请输入证件号码！");
			return;
		}
		//判断是否是号码或身份证输入
		if(identityCd==1){
		 identityCd=$("#p_cust_identityCd").val();
		}
		if(identityCd==-1){
			acctNbr=OrderInfo.provinceInfo.mainPhoneNum;
			identityNum="";
			identityCd="";
		}

		diffPlace=$("#DiffPlaceFlag").val();
		areaId=$("#p_areaId").val();
		var param = {
			"acctNbr":acctNbr,
			"identityCd":identityCd,
			"identityNum":identityNum,
			"partyName":"",
			"custQueryType":$("#custQueryType").val(),
			"diffPlace":diffPlace,
			"areaId" : areaId
		};
		$.callServiceAsHtmlGet(contextPath+"/cust/queryCustAlone", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if (response.code == -2) {
					return;
				}
				if(!response){
					response.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';					
				}
				if(response.data =="fail\r\n"){
					$.alert("提示","查询失败，请稍后再试");
					return;
				}
				if(response.data =="error\r\n"){
					$.alert("提示","数据异常，请联系管理员");
					return;
				}
				$("#acctList").html(response.data).show();	
				$("#acctDetail").hide();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
		
	};
	//查询客户详情
	var _queryCustDetail = function(_custId){
		var param = {
				partyId : _custId,
				areaId : $("#p_areaId").val()
		};
		$.callServiceAsHtml(contextPath+"/cust/custInfo", param, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if (response.code == -2) {
					return;
				}
				if(!response){
					response.data='<div style="margin:2px 0 2px 0;widht:100%,height:100%;text-align:center;"><strong>no data return,please try reload.</strong></div>';					
				}
				if(response.data =="fail\r\n"){
					$.alert("提示","查询失败，请稍后再试");
					return;
				}
				if(response.data =="error\r\n"){
					$.alert("提示","数据异常，请联系管理员");
					return;
				}
				$("#acctDetail").html(response.data).show();	
				$("#acctList").hide();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	};
	
	//保存静态客户信息
	var _createCustConfirm = function() {
		createCustInfo = {
			cAreaId 			: OrderInfo.staff.soAreaId,
			cAreaName 			: OrderInfo.staff.soAreaName,
			cCustName 			: $.trim($("#cCustName").val()),
			cCustIdCard 		: $.trim($("#cCustIdCard").val()),
			cPartyTypeCd 		: $.trim($("#partyTypeCd  option:selected").val()),
			cPartyTypeName 		: ($.trim($("#partyTypeCd  option:selected").val())==1) ? "个人客户":"政企客户",
			cIdentidiesTypeCd 	: $.trim($("#identidiesTypeCd  option:selected").val()),
			cAddressStr 		: $.trim($("#cAddressStr").val()),
			cMailAddressStr 	: $.trim($("#cMailAddressStr").val())
		};
		var _boPartyContactInfo = {
			contactAddress 	: $.trim($("#contactAddress").val()),//参与人的联系地址
	        contactDesc 	: $.trim($("#contactDesc").val()),//参与人联系详细信息
	        contactEmployer : $.trim($("#contactEmployer").val()),//参与人的联系单位
	        contactGender  	: $.trim($("#contactGender").val()),//参与人联系人的性别
	        contactId 		: $.trim($("#contactId").val()),//参与人联系信息的唯一标识
	        contactName 	: $.trim($("#contactName").val()),//参与人的联系人名称
	        contactType 	: $.trim($("#contactType").val()),//联系人类型
	        eMail 			: $.trim($("#eMail").val()),//参与人的eMail地址
	        fax 			: $.trim($("#fax").val()),//传真号
	        headFlag 		: $.trim($("#headFlag  option:selected").val()),//是否首选联系人
	        homePhone 		: $.trim($("#homePhone").val()),//参与人的家庭联系电话
	        mobilePhone 	: $.trim($("#mobilePhone").val()),//参与人的移动电话号码
	        officePhone 	: $.trim($("#officePhone").val()),//参与人办公室的电话号码
	        postAddress 	: $.trim($("#postAddress").val()),//参与人的邮件地址
	        postcode 		: $.trim($("#postcode").val()),//参与人联系地址的邮政编码
	        staffId 		: OrderInfo.staff.staffId,//员工ID
	        state 			: "ADD",//状态
	        statusCd 		: "100001"//订单状态
		};
		OrderInfo.boCustInfos.name					= createCustInfo.cCustName;//客户名称
		OrderInfo.boCustInfos.areaId				= createCustInfo.cAreaId;//客户地区
		OrderInfo.boCustInfos.partyTypeCd			= createCustInfo.cPartyTypeCd;//客户类型
		OrderInfo.boCustInfos.defaultIdType			= createCustInfo.cIdentidiesTypeCd;//证件类型
		OrderInfo.boCustInfos.addressStr			= createCustInfo.cAddressStr;//客户地址
		OrderInfo.boCustInfos.mailAddressStr		= createCustInfo.cMailAddressStr;//通信地址
		OrderInfo.boCustIdentities.identidiesTypeCd	= createCustInfo.cIdentidiesTypeCd;//证件类型
		OrderInfo.boCustIdentities.identityNum		= createCustInfo.cCustIdCard;//证件号码
		//boPartyContactInfo
		OrderInfo.boPartyContactInfo.contactAddress	=_boPartyContactInfo.contactAddress,//参与人的联系地址
		OrderInfo.boPartyContactInfo.contactDesc 	=_boPartyContactInfo.contactDesc,//参与人联系详细信息
		OrderInfo.boPartyContactInfo.contactEmployer=_boPartyContactInfo.contactEmployer,//参与人的联系单位
		OrderInfo.boPartyContactInfo.contactGender  =_boPartyContactInfo.contactGender,//参与人联系人的性别
		OrderInfo.boPartyContactInfo.contactId 		=_boPartyContactInfo.contactId,//参与人联系信息的唯一标识
		OrderInfo.boPartyContactInfo.contactName 	=_boPartyContactInfo.contactName,//参与人的联系人名称
		OrderInfo.boPartyContactInfo.contactType 	=_boPartyContactInfo.contactType,//联系人类型
		OrderInfo.boPartyContactInfo.eMail 			=_boPartyContactInfo.eMail,//参与人的eMail地址
		OrderInfo.boPartyContactInfo.fax 			=_boPartyContactInfo.fax,//传真号
		OrderInfo.boPartyContactInfo.headFlag 		=_boPartyContactInfo.headFlag,//是否首选联系人
		OrderInfo.boPartyContactInfo.homePhone 		=_boPartyContactInfo.homePhone,//参与人的家庭联系电话
		OrderInfo.boPartyContactInfo.mobilePhone 	=_boPartyContactInfo.mobilePhone,//参与人的移动电话号码
		OrderInfo.boPartyContactInfo.officePhone 	=_boPartyContactInfo.officePhone,//参与人办公室的电话号码
		OrderInfo.boPartyContactInfo.postAddress 	=_boPartyContactInfo.postAddress,//参与人的邮件地址
		OrderInfo.boPartyContactInfo.postcode		=_boPartyContactInfo.postcode,//参与人联系地址的邮政编码
		OrderInfo.boPartyContactInfo.staffId 		=_boPartyContactInfo.staffId,//员工ID
		OrderInfo.boPartyContactInfo.state 			=_boPartyContactInfo.state,//状态
		OrderInfo.boPartyContactInfo.statusCd 		=_boPartyContactInfo.statusCd//订单状态

		OrderInfo.cust = {
			custId		: -1,	
			partyName 	: createCustInfo.cCustName,
			areaId		: createCustInfo.cAreaId
		};
		//客户属性
		OrderInfo.boCustProfiles=[];
		//客户属性节点
		for ( var i = 0; i < _partyProfiles.length; i++) {
			var partyProfiles = _partyProfiles[i];
			var profileValue  = $("#"+partyProfiles.attrId).val();
			if(""==profileValue||undefined==profileValue){
				profileValue==$("#"+partyProfiles.attrId+"option:selected").val();
			}
			var partyProfiles = {
				partyProfileCatgCd: partyProfiles.attrId,
				profileValue: profileValue,
                state: "ADD"
			};
			if(""!=profileValue && profileValue!=undefined){
				OrderInfo.boCustProfiles.push(partyProfiles);
			}
		}
		$("#div_cust_create").popup("close");
		var param = {};
		param.prodPwd 		= "";
		param.accessNumber	="";
		param.authFlag		="1";
		authFlag			="";
		param.identityCd	=createCustInfo.cIdentidiesTypeCd;
		param.idCardNumber	=createCustInfo.cCustIdCard;
		param.partyName		=createCustInfo.cCustName;
		param.areaId		=createCustInfo.cAreaId;
		param.areaName		=createCustInfo.cAreaName;
		param.segmentName	=createCustInfo.cPartyTypeName;
		param.identityName	=$("#identidiesTypeCd option:selected").text();
		$.callServiceAsHtml(contextPath+"/pad/cust/custAuth",param,{
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","客户鉴权失败,稍后重试");
					return;
				}
				if(response.data.indexOf("false") >=0) {
					$.alert("提示","抱歉，您输入的密码有误，请重新输入。");
					return;
				}
				_custAuthCallBack(response);
			},"always":function(){
				$.unecOverlay();
			}
		});
   };
	//验证证件号码是否存在
	var _checkIdentity = function() {
		var areaId=$("#p_cust_areaId").val();
		if(areaId==null||areaId==""){
			areaId=OrderInfo.staff.areaId;
		}
		var custName=$("#p_cust_areaId_val").val();
		createCustInfo = {
			cAreaId : areaId,
			cAreaName : custName,
			cCustName : $.trim($("#cCustName").val()),
			cCustIdCard :  $.trim($("#cCustIdCard").val()),
			cPartyTypeCd : $.trim($("#partyTypeCd option:selected").val()),
			cIdentidiesTypeCd : $.trim($("#identidiesTypeCd option:selected").val()),
			cAddressStr :$.trim($("#cAddressStr").val())
		};
		diffPlace=$("#DiffPlaceFlag").val();
		var params = {
			"acctNbr":"",
			"identityCd":createCustInfo.cIdentidiesTypeCd,
			"identityNum":createCustInfo.cCustIdCard,
			"partyName":"",
			"custQueryType":$("#custQueryType").val(),
			"diffPlace":diffPlace,
			"areaId" : createCustInfo.cAreaId
		};
		var url=contextPath+"/pad/cust/checkIdentity";
		var response = $.callServiceAsJson(url, params, {"before":function(){
			$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
		}});
		var msg="";
		if (response.code == 0) {
			$.unecOverlay();
			$.confirm("确认","此证件号码已存在,是否确认新建?",{ 
				yes:function(){	
					_createCustConfirm();
				},
				no:function(){
					
				}
			});
		}else{
			$.unecOverlay();
			_createCustConfirm();
		}
	};
	//更多属性标签 切换
	var _changeLabel = function(tabObj){
        var labId = $(tabObj).attr("tabid");
        if(labId !="0" && $("#contactName").val()==""){
        	$("#contactName").blur();
			return;
		}
        var index = $(tabObj).index();
        var divs = $("#otabs-body > div");
        $(tabObj).parent().children("li").attr("class", "otab-nav");//将所有选项置为未选中
        $(tabObj).attr("class", "otab-nav-action"); //设置当前选中项为选中样式
		$(tabObj).parent().children("li").find(".ui-input-search").hide();
		$(tabObj).parent().children("li").find(".ui-select").hide(); 
		$(tabObj).children("div").show();
        divs.hide();//隐藏所有选中项内容
        divs.eq(index).show(); //显示选中项对应内容
	};
	//指定号码 切换时控制,ok 
	var _isAppointNum = function(){
		if(!_called){
			_called = true;
			if($("#p_cust_identityCd").find("option:selected").val()!=-1){
				$.alertSync("提示","只能接入号码才能指定号码！","information",function(){
					$("#isAppointNum").val("0").slider().slider("refresh");
					_called = false;
				});
			}
		}
	};
	//退出二次业务
	var _cancel = function() {
		//退出二次业务时释放被预占的UIM卡
		var boProd2Tds = OrderInfo.boProd2Tds;
		if(boProd2Tds.length>0){
			for(var n=0;n<boProd2Tds.length;n++){
				var param = {
					numType : 2,
					numValue : boProd2Tds[n].terminalCode
				};
				$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
			}
		}
		//退出二次业务时释放被预占的号码（过滤身份证预占的号码）
		var boProdAns = OrderInfo.boProdAns;
		if(boProdAns.length>0){
			for(var n=0;n<boProdAns.length;n++){
				if(boProdAns[n].idFlag){
					continue;
				}
				var param = {
						numType : 1,
						numValue : boProdAns[n].accessNumber
				};
				$.callServiceAsJson(contextPath+"/mktRes/phonenumber/releaseErrorNum", param);
			}
			order.service.boProdAn = {};
			order.phoneNumber.resetBoProdAn();
		}			
		//页面变动
		$("#order_fill_content").empty();
		order.prepare.hideStep();
		$("#orderedprod").show();
		$("#order_prepare").show();
	};
	//返回按钮
	var _back = function(){
		$("#acctDetail").hide();
		$("#acctList").show();
	};
	
	var _showoffer=function(){
		
		if(OrderInfo.provinceInfo.reloadFlag=="N"){
			//带主套餐id
			var busiOrder=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder;
			var offid="";
			for(var i=0;i<busiOrder.length;i++){
				if(busiOrder[i].boActionType.actionClassCd=="1200" && busiOrder[i].boActionType.boActionTypeCd=="S1" && busiOrder[i].busiObj.offerTypeCd=="1"){
					offid=busiOrder[i].busiObj.objId;
					break;
				}
			}
			//var offid=OrderInfo.reloadOrderInfo.orderList.custOrderList[0].busiOrder[1].busiObj.objId;
			OrderInfo.provinceInfo.prodOfferId=offid;
			order.uiCusts.offerinit(offid,null);
			_loadData();
		}
		else{
			if(OrderInfo.provinceInfo.prodOfferId!=null && OrderInfo.provinceInfo.prodOfferId!=""){
				//带主套餐id
				order.uiCusts.offerinit(OrderInfo.provinceInfo.prodOfferId,null);
			}
			else{
				order.uiCusts.initSub();
				
				
			}
		}
	};
	
	//校验发展人类型,并获取发展人类型列表[4-4-1]
	var _getDealerTypeSub = function(objInstId,objId){
		var dealerType = "";
		if(order.ysl!=undefined){
			OrderInfo.order.dealerTypeList = [{"PARTYPRODUCTRELAROLECD":40020005,"NAME":"第一发展人"},{"PARTYPRODUCTRELAROLECD":40020006,"NAME":"第二发展人"},{"PARTYPRODUCTRELAROLECD":40020007,"NAME":"第三发展人"}];
		}
		if(OrderInfo.order.dealerTypeList!=undefined && OrderInfo.order.dealerTypeList.length>0){ //发展人类型列表
			$.each(OrderInfo.order.dealerTypeList,function(){
				var dealerTypeId = this.PARTYPRODUCTRELAROLECD;
				var flag = true;
				$("select[name='dealerType_"+objInstId+"']").each(function(){ //遍历选择框
					if(dealerTypeId==$(this).val()){  //如果已经存在
						flag = false;
						return false;
					}
				});
				if(flag){ //如果发展人类型没有重复
					dealerType = dealerTypeId;
					return false;
				}
			});
		}else{
			$.alert("信息提示","没有发展人类型");
			return;
		}
		if(dealerType==undefined || dealerType==""){	
			$.alert("信息提示","每个业务发展人类型不能重复");
			return;
		}
		var $tdType = $('<dd></dd>');
		var $field=$('<fieldset data-role="fieldcontain"></fieldset>');
		var objId = objInstId+"_"+OrderInfo.SEQ.dealerSeq;
		var $select = $('<select id="dealerType_'+objId+'" name="dealerType_'+objInstId+'"  data-mini="true" data-native-menu="false" data-icon="select" onclick=a=this.value; onchange="order.dealer.changeDealer(this,\'dealerType_'+objInstId+'\',a)"></select>');
		$.each(OrderInfo.order.dealerTypeList,function(){
			if(this.PARTYPRODUCTRELAROLECD==dealerType){
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' selected='selected'>"+this.NAME+"</option>");
			}else{
				$select.append("<option value='"+this.PARTYPRODUCTRELAROLECD+"' >"+this.NAME+"</option>");
			}
		});
		$field.append($select);
		$tdType.append($field);
		return $tdType;
	};
	
	
	
	
	
	
	
	
	
	
/***************************订单准备**********************************************/
	//初始化套餐变更页面
	var _initSub = function (){
		var prodInfo = order.prodModify.choosedProdInfo;
		if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
			$.alert("提示","请选择一个在用产品");
			return;
		}
		OrderInfo.actionFlag = 2;
		if(OrderInfo.provinceInfo.mergeFlag=="0"){
			if(!query.offer.setOffer()){ //必须先保存销售品实例构成，加载实例到缓存要使用
				return ;
			}
		}
		//规则校验入参
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		},{
			boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		}];
		if(!rule.rule.ruleCheck(boInfos)){ //规则校验失败
			return;
		}
		//初始化套餐查询页面
		$.ecOverlay("<strong>正在查询中,请稍后....</strong>");
		var response = $.callServiceAsHtmlGet(contextPath+"/pad/order/prodoffer/prepare",{});	
		$.unecOverlay();
		if(response.code != 0) {
			$.alert("提示","查询失败,稍后重试");
			return;
		}
		SoOrder.step(0,response.data); //订单准备		
		order.prepare.initOffer();
		order.uiCusts.searchPack();
		$("#dlg_cust_prod").popup("close");
		$("#navbar").slideUp(500);
		$.jqmRefresh($("#order_tab_panel_content"));
	};
	
	//初始化套餐变更页面
	var _offerinit = function (offid,p){
		var prodInfo = order.prodModify.choosedProdInfo;
		if(prodInfo.prodStateCd!=CONST.PROD_STATUS_CD.NORMAL_PROD){
			$.alert("提示","请选择一个在用产品");
			return;
		}
		OrderInfo.actionFlag = 2;
		if(OrderInfo.provinceInfo.mergeFlag=="0"){
			if(!query.offer.setOffer()){ //必须先保存销售品实例构成，加载实例到缓存要使用
				return ;
			}
		}
		//规则校验入参
		var boInfos = [{
			boActionTypeCd : CONST.BO_ACTION_TYPE.DEL_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		},{
			boActionTypeCd : CONST.BO_ACTION_TYPE.BUY_OFFER,
			instId : prodInfo.prodInstId,
			specId : CONST.PROD_SPEC.CDMA,
			prodId : prodInfo.prodInstId
		}];
		if(!rule.rule.ruleCheck(boInfos)){ //规则校验失败
			return;
		}
		$("#dlg_cust_prod").popup("close");
		$("#navbar").slideUp(500);
		$.jqmRefresh($("#order_tab_panel_content"));
		order.uiCusts.buyService(offid,p);
		
		/*
		//初始化套餐查询页面
		$.ecOverlay("<strong>正在查询中,请稍后....</strong>");
		var response = $.callServiceAsHtmlGet(contextPath+"/token/pad/order/prodoffer/prepare",{});	
		$.unecOverlay();
		if(response.code != 0) {
			$.alert("提示","查询失败,稍后重试");
			return;
		}
		SoOrder.step(0,response.data); //订单准备
//		$('#search').bind('click',function(){
//			order.service.searchPack();
//		});
//		order.prodOffer.init();
//		order.service.searchPack(); //查询可以变更套餐
		order.prepare.initOffer();
		order.service.searchPack();
		$("#dlg_cust_prod").popup("close");
		$("#navbar").slideUp(500);
		$.jqmRefresh($("#order_tab_panel_content"));
		*/
	};
		
	//主套餐查询
	var _searchPack = function(pageIndex,scroller){
		var custId = OrderInfo.cust.custId;
		var searchtext = $('#searchtext').val();
		if(searchtext=="请输入您要搜索的套餐名称或首字母简拼"){
			searchtext="";
		}
		var phoneLevel="";//order.phoneNumber.boProdAn.level;
		if(phoneLevel==undefined&&phoneLevel==null){
			phoneLevel='';
		}
		//var subPage=$("#subpageFlag").val(); "subPage":subPage,
		var params={"qryStr":searchtext,"pnLevelId":phoneLevel,"custId":custId};
		//解析价格范围条件
		var price = $.trim($("#select_price").val());
		if(ec.util.isObj(price)){
			var priceArr = price.split("-");
			if(priceArr[0]!=null&&priceArr[0]!=""){
				params.priceMin = priceArr[0] ;
			}
			if(priceArr[1]!=null&&priceArr[1]!=""){
				params.priceMax = priceArr[1] ;
			}
		}
		//解析流量范围条件
		var influx = $.trim($("#select_influx").val());
		if(ec.util.isObj(influx)){
			var influxArr = influx.split("-");
			if(influxArr[0]!=null&&influxArr[0]!=""){
				params.INFLUXMin = influxArr[0]*1024;
			}
			if(influxArr[1]!=null&&influxArr[1]!=""){
				params.INFLUXMax = influxArr[1]*1024;
			}
		}
		//解析语音范围条件
		var invoice = $.trim($("#select_invoice").val());
		if(ec.util.isObj(invoice)){
			var invoiceArr = invoice.split("-");
			if(invoiceArr[0]!=null&&invoiceArr[0]!=""){
				params.INVOICEMin = invoiceArr[0] ;
			}
			if(invoiceArr[1]!=null&&invoiceArr[1]!=""){
				params.INVOICEMax = invoiceArr[1] ;
			}
		}
		_queryData(params,scroller);
		
	};
	
	var _queryData = function(params,scroller) {
		if(OrderInfo.actionFlag==2){
			var offerSpecId = order.prodModify.choosedProdInfo.prodOfferId;
			if(offerSpecId!=undefined){
				params.changeGradeProdOfferId = offerSpecId;
			}
		}else if(CONST.getAppDesc()==0){
			params.prodOfferFlag = "4G";
		}
		var url = contextPath+"/token/pad/order/offerSpecList";
		$.callServiceAsHtmlGet(url,params, {
			"before":function(){
				$.ecOverlay("<strong>正在查询中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done" : function(response){
				if(response.code != 0) {
					$.alert("提示","<br/>查询失败,稍后重试");
					return;
				}
				var content$ = $("#div_offer_list");
				content$.html(response.data);
				//刷新jqm控件
				$.jqmRefresh(content$);
				if(scroller && $.isFunction(scroller)) scroller.apply(this,[]);
				//绑定选中单个套餐事件
				$("#ul_offer_list li").off("tap").on("tap",function(){
					$(this).addClass("pakeagelistlibg").siblings().removeClass("pakeagelistlibg");
				});
				if(OrderInfo.busitypeflag==1){
					$("#btn_enter_prev").show();
					$("#btn_enter_prev").off("tap").on("tap",function(){
						$("#ul_busi_area").show();
						$("#order_prepare").empty();
					});
				}
				//绑定选中套餐后下一步操作功能
				$("#btn_enter_offerlist_next").off("tap").on("tap",function(){
					if($("#ul_offer_list .pakeagelistlibg").length==1){
						//弹出层
						
						var $dl = $("#ul_offer_list .pakeagelistlibg").find("dl");
						order.uiCusts.buyService($dl.attr("offerSpecId"),$dl.attr("price"));
					}else{
						$.alert("提示","请先选择一个套餐,再进入下一步操作.");
					}
				});
			},
			"always":function(){
				$.unecOverlay();
			},
			fail:function(response){
				$.unecOverlay();
				$.alert("提示","套餐加载失败，请稍后再试！");
			}
		});
	};
	//订购销售品
	var _buyService = function(specId,price) {
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldAddNumList = [];
		var custId = OrderInfo.cust.custId;
		offerprice = price;
		if(OrderInfo.cust==undefined || custId==undefined || custId==""){
			$.alert("提示","在订购套餐之前请先进行客户定位！");
			return;
		}
		var param = {
			"price":price,
			"specId" : specId,
			"custId" : OrderInfo.cust.custId,
			"areaId" : OrderInfo.staff.soAreaId
		};
		
		if(OrderInfo.actionFlag == 2){  //套餐变更不做校验
			order.uiCusts.opeSer(param);  
			
		}else {  //新装
			var boInfos = [{
	            boActionTypeCd: "S1",//动作类型
	            instId : "",
	            specId : specId //产品（销售品）规格ID
	        }];
	        if(rule.rule.ruleCheck(boInfos)){  //业务规则校验通过
	        	order.service.opeSer(param);   
	        }
		}
	};
	
	//获取销售品构成，并选择数量
	var _opeSer = function(inParam){
		
		var param = {
			offerSpecId : inParam.specId,
			offerTypeCd : 1,
			partyId: OrderInfo.cust.custId
		};
		var offerSpec = query.offer.queryMainOfferSpec(param); //查询主销售品构成
		if(!offerSpec){
			return;
		}
		if(OrderInfo.actionFlag == 2){ //套餐变更
			var url=contextPath+"/order/queryFeeType";
			$.ecOverlay("<strong>正在查询是否判断付费类型的服务中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data!=undefined){
					if("0"==response.data){
						var is_same_feeType=false;
						if(order.prodModify.choosedProdInfo.feeType=="2100" && (offerSpec.feeType=="2100"||offerSpec.feeType=="3100"||offerSpec.feeType=="3101"||offerSpec.feeType=="3103"||offerSpec.feeType=="1202"||offerSpec.feeType=="2101")){
							is_same_feeType=true;//预付费
						}else if(order.prodModify.choosedProdInfo.feeType=="1200" && (offerSpec.feeType=="1200"||offerSpec.feeType=="3100"||offerSpec.feeType=="3102"||offerSpec.feeType=="3103"||offerSpec.feeType=="1202"||offerSpec.feeType=="2101")){
							is_same_feeType=true;//后付费
						}else if(order.prodModify.choosedProdInfo.feeType=="1201" && (offerSpec.feeType=="1201"||offerSpec.feeType=="3101"||offerSpec.feeType=="3102"||offerSpec.feeType=="3103")){
							is_same_feeType=true;//准实时预付费
						}
						if(!is_same_feeType){
							$.alert("提示","付费类型不一致,无法进行套餐变更。");
							return;
						}
					}
				}
			}
		    order.uiCusts.offerChangeView(inParam,offerSpec);
		    if(OrderInfo.provinceInfo.reloadFlag=="Y"){
		    	 if(OrderInfo.provinceInfo.prodOfferId!=null && OrderInfo.provinceInfo.prodOfferId!=""){
				    	$("#dlg-memberRole-num-popup").removeClass("ui-popup-hidden");
						$("#dlg-memberRole-num-popup").removeClass("ui-popup-truncate");
						$("#dlg-memberRole-num-popup").removeClass("slideup");
				    }
		    }
			return;
		}
		

	};
	
	//弹出层
	var _showLayer=function (inParam,offerSpec){
		
		var newSubPhoneNumsize=[];
		var oldSubPhoneNumsize=[];
	
		if(order.memberChange.newSubPhoneNum!=null && order.memberChange.newSubPhoneNum!=""){
			newSubPhoneNumsize = order.memberChange.newSubPhoneNum.split(",");
		}
		if(order.memberChange.oldSubPhoneNum!=null && order.memberChange.oldSubPhoneNum!=""){
			oldSubPhoneNumsize = order.memberChange.oldSubPhoneNum.split(",");
		}
		
		var iflag = 0; //判断是否弹出副卡选择框 false为不选择
		if(OrderInfo.provinceInfo.prodOfferId!=null && OrderInfo.provinceInfo.prodOfferId!=""){
			var htmlStr='<div id="dlg-memberRole-num" data-role="popup" data-transition="slideup" data-corners="false" data-overlay-theme="b" style="width: 800px; height: 450px;margin-left:300px;" class="popwindow" data-dismissible="false">'+
			'<div data-role="header" data-position="inline" data-tap-toggle="false" data-theme="t">'+
				'<a href="#" data-role="button" data-icon="back" data-rel="back" data-iconpos="notext" class="ui-btn-right">返回</a>'+
				'<h1>'+OrderInfo.offerSpec.offerSpecName+'</h1>'+
			'</div>';
		}
		else{
			var htmlStr='<div id="dlg-memberRole-num" data-role="popup" data-transition="slideup" data-corners="false" data-overlay-theme="b" style="width: 800px; height: 450px;" class="popwindow" data-dismissible="false">'+
			'<div data-role="header" data-position="inline" data-tap-toggle="false" data-theme="t">'+
				'<a href="#" data-role="button" data-icon="back" data-rel="back" data-iconpos="notext" class="ui-btn-right">返回</a>'+
				'<h1>'+OrderInfo.offerSpec.offerSpecName+'</h1>'+
			'</div>';
		}
		var $con=$('<div></div>');
		var $content=$('<div style="height: 400px;" data-role="content"></div>');
		var $ul=$('<ul id="ul1" data-role="listview" class="develist"></ul>'); 
		
		var existViceCardNum = 0;//已有副卡数量
		//副卡个数
		$.each(OrderInfo.offer.offerMemberInfos,function(){
			if(this.roleCd=="401"){
				existViceCardNum++;
			}
		})
		var max=0;
		
		$.each(offerSpec.offerRoles,function(){
			var offerRole = this;
			if (offerRole.memberRoleCd == CONST.MEMBER_ROLE_CD.MAIN_CARD) {
				$.each(this.roleObjs,function(){
					if(this.objType == CONST.OBJ_TYPE.PROD){
						$("#objHtml").html(this.objName);
					}
				});
				$.each(OrderInfo.offer.offerMemberInfos,function(){
					if(this.offerRoleId==offerRole.offerRoleId && this.objType==CONST.OBJ_TYPE.PROD){
						$("#accessNumberHtml").html(this.accessNumber);						
						return;
					}
				});
			}
			else{
					$.each(this.roleObjs,function(){
						var oldCardHtml = "";
							var objInstId = offerRole.offerRoleId+"_"+this.objId;//角色id+产品规格id
							if(objInsterId==""){
								objInsterId=objInstId;
							}
							if(this.objType == CONST.OBJ_TYPE.PROD){
								_newAddList.push(objInstId);
								if(offerRole.minQty == 0){ //加装角色
									this.minQty = 0;
									this.dfQty = 0;
								}
								 max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量						
								max = max -existViceCardNum;
								maxNum = max;
								if(max>0){
									var $li=$('<li></li>');
									var $dl= $('<dl></dl>');
									$dl.append("<dd></dd><dd><span style='color: #5a9203;'>"+offerRole.offerRoleName+" :</span>"+this.objName+" :</dd>"+
											"<dd><div class='ui-grid-b addnum'> <div class='ui-block-a' align='center'>" +
											"<a class='abtn01' href='javascript:order.service.subNum(\""+objInstId+"\","+this.minQty+");'>-</a></div>"+
											"<div class='ui-block-b'><input id='"+objInstId+"' type='text' value='"+this.dfQty+"' style='width:22px' readonly='readonly'></div>"+
											"<div class='ui-block-c' align='center'><a class='abtn01'  href='javascript:order.service.addNum(\""+objInstId+"\","+max+",\""+offerRole.parentOfferRoleId+"\");'>+</a></div>"+
											"</div></dd><dd>"+this.minQty+"-"+max+"（张） </dd>");	
									
									
									$li.append($dl);
									$ul.append($li);
									iflag++;
								}
							}
					
				   });
					
					//老成员
					$.each(this.roleObjs,function(){
						var offerRole = this;
						if(this.objType == CONST.OBJ_TYPE.PROD){
						    max = this.maxQty<0?"不限制":this.maxQty;//主卡的最大数量						
							max = max -existViceCardNum;
							maxNum = max;
							if(max>0){
							if(newSubPhoneNumsize.length==0 && oldSubPhoneNumsize.length==0){							
								var $li=$('<li id="li'+idnum+'"></li>');
								var $dl= $('<dl></dl>');
								var str="<dd></dd>";
								str+="<dd><span style='color: #5a9203;'>已有移动电话 :</span>移动电话（仅含本地语音） :</dd>"
								str += "<dd style=\"width:150px;\">";
								str += "";									
								str += "";
								str += "</div>";
								str += "<div class=\"\">";
								str += "<input  name=\"oldphonenum\" type=\"text\" id=\"oldphonenum_1\">";
								str += "</div>";
								str += "<div class=\"\">";
								str+="</dd>";
								str+="<dd>"
								str += "<button data-mini=\"ture\" onclick=\"order.uiCusts.addLi("+max+")\">+</button>";
								str += "</div>";
								str += "<div class=\"ui-block-d\">";
								str += "</div>";								
								str += "</div>";
								str += "</div></dd>";				
								$dl.append(str);
								$li.append($dl);
								$ul.append($li);
							}
							else if(oldSubPhoneNumsize.length>max){
								$.alert("规则限制","oldSubPhoneNum的角色成员数量总和不能超过"+max);
								errorflag = false;
								return false;
							}
							else{
								for(var k=0;k<oldSubPhoneNumsize.length;k++){
									var id="li"+idnum;
									var $li=$('<li id="'+id+'"></li>');
									var $dl= $('<dl></dl>');
									var str="<dd></dd>";
									str+="<dd><span style='color: #5a9203;'>已有移动电话 :</span>移动电话（仅含本地语音） :</dd>"
									str += "<dd style=\"width:150px;\">";
									str += "";									
									str += "";
									str += "</div>";
									str += "<div class=\"\">";
									str += "<input type=\"text\" value=\""+oldSubPhoneNumsize[k]+"\" name=\"oldphonenum\" id=\"oldphonenum_1\" readonly=\"readonly\">";
									str += "</div>";
									str += "<div class=\"\">";
									str+="</dd>";
									str+="<dd>"
									//str += "<button data-mini=\"ture\" onclick=\"order.uiCusts.delLi("+idnum+")\">-</button>";
									str += "</div>";
									str += "<div class=\"ui-block-d\">";
									str += "</div>";								
									str += "</div>";
									str += "</div></dd>";				
									$dl.append(str);
									$li.append($dl);
									$ul.append($li);
									$.jqmRefresh($("#dlg-memberRole-num"));
								}
							}
						 }
						}
						
					});
			}
		});

					
		
		//底部
		var foot=' <div data-role="footer" data-position="inline" data-tap-toggle="false" data-theme="n">'+
     	'<button id="memberRoleNumConfirm1"  data-inline="true"  data-icon="check">确认</button>'+

		'</div>';
		$content.append($ul);
		$content.append(foot);
		$con.append($content);
		//$con.append(foot);
		htmlStr+=$con.html()+"</div>";
		
		if(iflag >=1){
			if(OrderInfo.provinceInfo.prodOfferId!=null && OrderInfo.provinceInfo.prodOfferId!=""){
				var popup = $.popup("#dlg-memberRole-num",htmlStr,{
					width:800,
					height:450,
					contentHeight:400,
					afterClose:function(){}
				});
				//{"width","800px;","height","450px;"}
				//ui-popup-truncate slideup

				$("#dlg-memberRole-num-popup").removeClass("ui-popup-hidden");
				$("#dlg-memberRole-num-popup").removeClass("ui-popup-truncate");
				$("#dlg-memberRole-num-popup").removeClass("slideup");
				
			}
			else{
			var popup = $.popup("#dlg-memberRole-num",htmlStr,{
				width:800,
				height:450,
				contentHeight:400,
				afterClose:function(){}
			});
			$("#dlg-memberRole-num-popup").removeClass("ui-popup-hidden");
			$("#dlg-memberRole-num-popup").removeClass("ui-popup-truncate");
			$("#dlg-memberRole-num-popup").removeClass("slideup");
			}
			$("#memberRoleNumConfirm1").off("tap").on("tap",function(){
				//$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				var newnum=$("#"+objInsterId).val();
				    newnum=newnum*1;
				var oldnum=0;
				$("input[name='oldphonenum']").each(function(){
					if(this.value!=null && this.value!="" && this.value.length==11){
						oldnum+=1;
					}
				});
				if((newnum+oldnum)>max){
					$.alert("提示","新装副卡和纳入老成员数量超过最大值"+max);
					return ;
				}
				else{
					if(OrderInfo.provinceInfo.prodOfferId!=null && OrderInfo.provinceInfo.prodOfferId!=""){
						$("#dlg-memberRole-num-popup").addClass("ui-popup-hidden");
					}
					else{
						$("#dlg-memberRole-num").popup("close");
					}
					confirm(newnum,oldnum);
				}

			});
			$("#memberRoleNumCancel").off("tap").on("tap",function(){
				$("#dlg-memberRole-num").popup("close");
			});
			
			//是否二次加载
			if(OrderInfo.provinceInfo.reloadFlag=="N"){
				$("#memberRoleNumCancel").off("tap").on("tap",function(){
					$("#dlg-memberRole-num").popup("close");
				});
			var newnum=$("#"+objInsterId).val();
			    newnum=newnum*1;
			var oldnum=0;
			$("input[name='oldphonenum']").each(function(){
				if(this.value!=null && this.value!="" && this.value.length==11){
					oldnum+=1;
				}
			});
			
			confirm(newnum,oldnum);
			}
			$("#dlg-memberRole-num-popup").removeClass("ui-popup-hidden");
			$("#dlg-memberRole-num-popup").removeClass("ui-popup-truncate");

		}else{
			if(!order.service.setOfferSpec(1)){
				$.alert("错误提示","请选择一个接入产品");
				return;
			}
		}
	};
	
	function confirm(newnum,oldnum){
		if(CONST.getAppDesc()==0){ 
			//老套餐是3G，新套餐是4G
			if(order.prodModify.choosedProdInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){
				if(!offerChange.checkOrder()){ //省内校验单
					return;
				}
			}
			//根据UIM类型，设置产品是3G还是4G，并且保存旧卡
			if(!prod.uim.setProdUim()){ 
				return ;
			}
		}
				//纳入老用户数量
		//order.memberChange.choosenum=oldnum;
		OrderInfo.oldprodInstInfos = [];
		OrderInfo.oldofferSpec = [];
		OrderInfo.oldoffer = [];
		OrderInfo.oldAddNumList = [];
		order.memberChange.viceCartNum = 0;
		var delprodInsts = [];
		$.each(OrderInfo.offerSpec.offerRoles,function(){
			if(this.memberRoleCd=="401"){
				if(this.prodInsts!=undefined){
					var oldprodInsts = this.prodInsts;
					for(var i=0;i<this.prodInsts.length;i++){
						var prodInstId = '"'+this.prodInsts[i].prodInstId+'"';
						if(prodInstId.indexOf("-")!=-1){
							delprodInsts.push(this.prodInsts[i]);
						}
					}
					$.each(delprodInsts,function(){
						var delprodInstId = this.prodInstId;
						$.each(oldprodInsts,function(j){
							if(this.prodInstId = delprodInstId){
								oldprodInsts.splice(j,1);
							}
						});
					});
				}
			}
		});
	  
		if(newnum>0){
			offerChange.newMemberFlag = true;
			order.memberChange.newMemberFlag=true;
			order.service.setOfferSpec();
		}
		if(oldnum>0){
			
			offerChange.oldMemberFlag = true;
			order.memberChange.oldMemberFlag=true;
			if(!order.memberChange.queryofferinfoSub()){
				return;
			}
			
		}
		if(parseInt(newnum)+parseInt(order.memberChange.viceCartNum)>maxNum){
			$.alert("提示","加装数量已经超过能加装的最大数量【"+maxNum+"】!");
			return;
		}
		//初始化填单页面
		var prodInfo = order.prodModify.choosedProdInfo;
		var param = {
			boActionTypeCd : "S2" ,
			boActionTypeName : "套餐变更",
			actionFlag :"2",
			offerSpec : OrderInfo.offerSpec,
			prodId : prodInfo.prodInstId,
			offerMembers : OrderInfo.offer.offerMemberInfos,
			oldOfferSpecName : prodInfo.prodOfferName,
			prodClass : prodInfo.prodClass,
			appDesc : CONST.getAppDesc(),
			areaId : order.prodModify.choosedProdInfo.areaId,
			newnum:newnum,
			oldnum:oldnum,
			feeTypeMain:prodInfo.feeType
		};
		
		if(oldnum>0){
			param.oldprodInstInfos = OrderInfo.oldprodInstInfos;
			param.oldofferSpec = OrderInfo.oldofferSpec;
			param.oldoffer = OrderInfo.oldoffer;
		}
		$("#dlg-memberRole-num").popup("close");
		order.uiCusts.buildMainView(param);
		

	}

	var _delLi=function (id){
		id="li"+id;
		$("ul li[id="+id+"]").remove();
		 choosenum --;//纳入老用户数量
		 idnum --;
		//$.jqmRefresh($("#dlg-memberRole-num"));
	};
	//动态添加一个li
	var _addLi=function (max){
		if(choosenum>=max){
			return;
		}
		idnum++;
		choosenum++;
		var id="li"+idnum;
		var $li=$('<li class="ui-li-static ui-body-inherit ui-last-child" id="'+id+'"></li>');
		var $dl= $('<dl></dl>');
		var str="<dd></dd>";
		str+="<dd><span style='color: #5a9203;'>已有移动电话 :</span>移动电话（仅含本地语音） :</dd>"
		str += "<dd style=\"width:150px;\">";
		str += "";									
		str += "";
		str += "</div>";
		str += "<div class=\"\">";
		str += "<input name=\"oldphonenum\" type=\"text\" id=\"oldphonenum_"+idnum+"\">";
		str += "</div>";
		str += "<div class=\"\">";
		str+="</dd>";
		str+="<dd>"
		str += "<button data-mini=\"ture\" onclick=\"order.uiCusts.delLi("+idnum+")\">-</button>";
		str += "</div>";
		str += "<div class=\"ui-block-d\">";
		str += "</div>";								
		str += "</div>";
		str += "</div></dd>";				
		$dl.append(str);
		$li.append($dl);
		$("#ul1").append($li);
		
		$.jqmRefresh($("#dlg-memberRole-num"));
	};
	
	
	//套餐变更页面显示
	var _offerChangeView=function(inParam,offerSpec){
		var oldLen = 0 ;
		$.each(OrderInfo.offer.offerMemberInfos,function(){
			if(this.objType==2){
				oldLen++;
			}
		});
		var memberNum = 1; //判断是否多成员 1 单成员2多成员
		var viceNum = 0;
		if(oldLen>1){ //多成员角色，目前只支持主副卡
			memberNum = 2;
		}
		//把旧套餐的产品自动匹配到新套餐中
		if(!offerChange.setChangeOfferSpec(memberNum,viceNum)){  
			return;
		};
		/*//4g系统需要
		if(CONST.getAppDesc()==0){ 
			//老套餐是3G，新套餐是4G
			if(order.prodModify.choosedProdInfo.is3G== "Y" && OrderInfo.offerSpec.is3G =="N"){
				if(!offerChange.checkOrder()){ //省内校验单
					return;
				}
			}
			//根据UIM类型，设置产品是3G还是4G，并且保存旧卡
			if(!prod.uim.setProdUim()){ 
				return ;
			}
		}
		*/
		_showLayer(inParam,offerSpec);
		if(OrderInfo.provinceInfo.reloadFlag=="N"){
			$("#dlg-memberRole-num-popup").addClass("ui-popup-hidden");
		}
		//order.uiCusts.buildMainView(param);
	};
	
	var _buildMainView = function(param) {
	
		if (param == undefined || !param) {
			param = _getTestParam();
		}
		
		if(OrderInfo.actionFlag == 2){
			if(param.newnum>0 || param.oldnum>0){
				var is_same_feeType=false;//
				if(param.feeTypeMain=="2100" && (param.offerSpec.feeType=="2100"||param.offerSpec.feeType=="3100"||param.offerSpec.feeType=="3101"||param.offerSpec.feeType=="3103")){
					is_same_feeType=true;
				}else if(param.feeTypeMain=="1200" && (param.offerSpec.feeType=="1200"||param.offerSpec.feeType=="3100"||param.offerSpec.feeType=="3102"||param.offerSpec.feeType=="3103")){
					is_same_feeType=true;
				}else if(param.feeTypeMain=="1201" && (param.offerSpec.feeType=="1201"||param.offerSpec.feeType=="3101"||param.offerSpec.feeType=="3102"||param.offerSpec.feeType=="3103")){
					is_same_feeType=true;
				}
				/****
				if(!is_same_feeType){
					$.alert("提示","主副卡付费类型不一致，无法进行纳入老成员。");
					return;
				}
				*/
			}
		}
		
		/*
		if(OrderInfo.actionFlag == 6){//主副卡成员变更 付费类型判断 如果一致才可以进行加装
			var is_same_feeType=false;//
			if(param.feeTypeMain=="2100" && (param.offerSpec.feeType=="2100"||param.offerSpec.feeType=="3100"||param.offerSpec.feeType=="3101"||param.offerSpec.feeType=="3103")){
				is_same_feeType=true;
			}else if(param.feeTypeMain=="1200" && (param.offerSpec.feeType=="1200"||param.offerSpec.feeType=="3100"||param.offerSpec.feeType=="3102"||param.offerSpec.feeType=="3103")){
				is_same_feeType=true;
			}else if(param.feeTypeMain=="1201" && (param.offerSpec.feeType=="1201"||param.offerSpec.feeType=="3101"||param.offerSpec.feeType=="3102"||param.offerSpec.feeType=="3103")){
				is_same_feeType=true;
			}
			if(!is_same_feeType){
				$.alert("提示","主副卡付费类型不一致，无法进行主副卡成员变更。");
				return;
			}
		}
		*/
		
		$.callServiceAsHtml(contextPath+"/token/pad/order/mainSub",param,{
			
     		"before":function(){
				$.ecOverlay("<strong>正在加载中,请稍等...</strong>");
			},"done" : function(response){
				if(!response){
					$.unecOverlay();
					 response.data='查询失败,稍后重试';
				}
				if(response.code != 0) {
					$.unecOverlay();
					$.alert("提示","查询失败,稍后重试");
					return;
				}
				OrderInfo.actionFlag = param.actionFlag;
				if(OrderInfo.actionFlag == 2){
			
					setTimeout(function () { 
						$.unecOverlay();
						offerChange.fillOfferChange(response,param);
						$.jqmRefresh($("#order_fill_content"));
				    }, 800);
					
					/*//二次加载
					if(OrderInfo.provinceInfo.reloadFlag=="N"){
						order.uiCusts.loadData();
					}
				    */
				}else {
					$.unecOverlay();
					_callBackBuildView(response,param);
				}
				
			}
		});

	};
	
	//解析数据
	var _loadData=function(){
		
		//if(OrderInfo.provinceInfo.reloadFlag!=null && OrderInfo.provinceInfo.reloadFlag!=""){
			var data=OrderInfo.reloadOrderInfo;
			//进行进行数据解析工作,获取产品数据
			var custOrderList=data.orderList.custOrderList;
			var orderListInfo=data.orderList.orderListInfo;
			if(custOrderList!=null && custOrderList!=""){
				//获取下属的产品
				if(custOrderList!=null && custOrderList.length>0){
					$(custOrderList).each(function(i,custOrder) { 
						
						//先把删除的开通功能进行删除操作
						$(custOrder.busiOrder).each(function(i,busiOrder) { 
							//解析到具体的订购产品数据
							//获取产品操作类型
							var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;
							
							//获取产品的操作状态,state,del-删除,add-添加
							var state="";
							var data=busiOrder.data;
							var ooOwners;
							var boServs;
							
							// 7是已开通功能，状态的获取和其他类型获取不一样
							if(boActionTypeCd=="7"){
								boServs=data.boServs;
								
								if(boServs!=null){
									$(boServs).each(function(i,boServ) { 
										state=boServ.state;
									});
								}
							}
							
							var busiObj=busiOrder.busiObj;
							
							if(boActionTypeCd=="7"){
								//7是已开通功能产品
								//获取唯一ID标识
								var instId=busiObj.instId;
								
								var boServOrders=data.boServOrders;
								
								$(data.boServs).each(function(i,boServ) { 
									var servId=boServ.servId;
									var state=boServ.state;
									if(state=="DEL"){
										_closeServSub(instId,servId);//4-1
									}
								});
							}
						});
					});
				
					$(custOrderList).each(function(i,custOrder) { 
						
						$(custOrder.busiOrder).each(function(i,busiOrder) { 
							
							//解析到具体的订购产品数据
							//获取产品操作类型
							var boActionTypeCd=busiOrder.boActionType.boActionTypeCd;
							
							//获取产品的操作状态,state,del-删除,add-添加
							var state="";
							
							var datas=busiOrder.data;
					
							var ooOwners;
							var boServs;
							
							// 7是已开通功能，状态的获取和其他类型获取不一样
							if(boActionTypeCd=="7"){
								boServs=datas.boServs;
								
								if(boServs!=null){
									$(boServs).each(function(i,boServ) { 
										state=boServ.state;
									});
								}
								
							}else{
								ooOwners=datas.ooOwners;
								if(ooOwners!=null){
									$(ooOwners).each(function(i,ooOwner) { 
										state=ooOwner.state;
										return false
									});
								}
							}
							
							var busiObj=busiOrder.busiObj;
							//S2是已订购可选包
							if(boActionTypeCd=="S2"){
								//获取唯一ID标识
								var instId=busiObj.instId;
								var offerTypeCd1=busiObj.offerTypeCd;
								$(datas.ooRoles).each(function(i,ooRole) { 
									var objInstId=ooRole.objInstId;
									state=ooRole.state;
									if(offerTypeCd1=="2"){
										if(state=="DEL"){
											_delOfferSub(objInstId,instId);
										}
									}
									
								});
							}else if(boActionTypeCd=="7"){
						
								//7是已开通功能产品
								//获取唯一ID标识
								
								var instId=busiObj.instId;
								
								var boServOrders=datas.boServOrders;
								
								$(datas.boServs).each(function(i,boServ) { 
									var servId=boServ.servId;
									var state=boServ.state;
									
									if(state=="DEL"){
										_closeServSub(instId,servId);
									}else if(state=="ADD"){
										$(boServOrders).each(function(i2,boServOrder) {
											var servSpecId=boServOrder.servSpecId;
											var servSpecName=boServOrder.servSpecName;
											
											_openServSpecSub(instId,servSpecId,servSpecName,'N');
										});
									}
								});
								
							}else if(boActionTypeCd=="S1"){

								var zdDatas=busiOrder.data;    //终端
								//S1是订单中的已选可选包数据
								//获取唯一ID标识
								var objId=busiObj.objId;
								var accessNumber=busiObj.accessNumber;
								var objName=busiObj.objName;
								var prodId=null;
								
								var ooRoles=datas.ooRoles;
								var busiOrderAttrs=datas.busiOrderAttrs;
								
								$(datas.ooRoles).each(function(i,ooRole) { 
									prodId=ooRole.prodId;
									return false;
								});
								
								var isNeedAdd=false;
								
								var roleCode="";
								
								$(busiOrderAttrs).each(function(i,busiOrderAttr) { 
									var itemSpecId=busiOrderAttr.itemSpecId;
									if(itemSpecId=="111111116"){
										roleCode=busiOrderAttr.role;
										isNeedAdd=true;
										return false;
									}
								});
								if( busiOrder.boActionType.actionClassCd=="1200" && busiOrder.boActionType.boActionTypeCd=="S1" && busiOrder.busiObj.offerTypeCd=="2" ){
									
									var objId=busiObj.objId;
									var accessNumber=busiObj.accessNumber;
									var objName=busiObj.objName;
									var prodId=null;
									var ooRoles=datas.ooRoles;
									$(datas.ooRoles).each(function(i,ooRole) { 
										prodId=ooRole.prodId;
										return false;
									});
									
									
								//	_addAttachDealerSub(prodId+"_"+objId,accessNumber,objName);
									
									//重载订单中已经选择的服务
									_addOfferSpecSub(prodId,objId,ooRoles);
									
								}
								
								/*新增发展人
								if(isNeedAdd){
									_addAttachDealerSub(prodId+"_"+objId,accessNumber,objName,roleCode);//4-4
								}
								*/
								//重载订单中已经选择的服务
								//_addOfferSpecSub(prodId,objId,ooRoles);//4-5

								//解析终端串码
								if(busiOrder.boActionType.actionClassCd=="1200" && busiOrder.boActionType.boActionTypeCd=="S1" && busiOrder.busiObj.offerTypeCd=="2"){
									if(zdDatas.bo2Coupons!=undefined){
										//开始解析终端
										for(var i=0;i<zdDatas.bo2Coupons.length;i++){
											var bo2Coupons = zdDatas.bo2Coupons[i];
											
											var coupon = {
													couponUsageTypeCd : bo2Coupons.couponUsageTypeCd, //物品使用类型,1-其他，2-赠送，3-销售，4-活动，5-租机
													inOutTypeId : bo2Coupons.inOutTypeId,  //出入库类型
													inOutReasonId : bo2Coupons.inOutReasonId, //出入库原因
													saleId : bo2Coupons.saleId, //销售类型
													couponId : bo2Coupons.couponId, //物品ID
													couponinfoStatusCd : bo2Coupons.couponinfoStatusCd, //物品处理状态
													chargeItemCd : bo2Coupons.chargeItemCd, //物品费用项类型
													couponNum : bo2Coupons.couponNum, //物品数量
													storeId : bo2Coupons.storeId, //仓库ID
													storeName : bo2Coupons.storeName, //仓库名称
													agentId : bo2Coupons.agentId, //供应商ID
													apCharge : bo2Coupons.apCharge, //物品价格,约定取值为营销资源的
													couponInstanceNumber : bo2Coupons.couponInstanceNumber, //物品实例编码
													ruleId : bo2Coupons.ruleId, //物品规则ID
													partyId : bo2Coupons.partyId, //客户ID
													prodId : bo2Coupons.prodId, //产品ID
													offerId : bo2Coupons.offerId, //销售品实例ID
													attachSepcId : bo2Coupons.attachSepcId,
													state : bo2Coupons.state, //动作
													relaSeq : bo2Coupons.relaSeq, //关联序列	
													num	: bo2Coupons.num //第几个串码输入框
												};
												OrderInfo.attach2Coupons.push(coupon);
												
												$("#terminalText_"+bo2Coupons.prodId+"_"+bo2Coupons.attachSepcId).val(bo2Coupons.couponInstanceNumber);
												//进行校验 
												AttachOffer.checkTerminalCodeSub(bo2Coupons.prodId,bo2Coupons.attachSepcId);
										}
									}
		
								}
								
								
							}
							else if(boActionTypeCd=="14"){
							
								var bo2Coupons=busiOrder.data.bo2Coupons
								for(var i=0;i<bo2Coupons.length;i++){
									if(bo2Coupons[i].state=="ADD"){
										//uim卡号  //uim_txt_140029724038
										var card=bo2Coupons[i].couponInstanceNumber;
										//prodId
										var id=bo2Coupons[i].prodId;
										
										$("#uim_txt_"+id).val(card);//填充卡号
										order.uiCusts.checkUim(id,bo2Coupons[i]);
									}
								}
							}
							
						});
					});
				}
			}
			//退订功能产品
			$.each(AttachOffer.openServList,function(){
				var openmap = this;
				$.each(this.servSpecList,function(){
					var offermap = this;
					var offerflag = false;
					var custOrderLists=custOrderList[0];
					$.each(custOrderLists.busiOrder,function(){
						var obj=this;
						if(this.boActionType.actionClassCd=="1300" && this.boActionType.boActionTypeCd=="7"){
							if(offermap.servSpecId==this.data.boServOrders[0].servSpecId && openmap.prodId==this.busiObj.instId){
								offerflag = true;
								return false;
							}
						}
					});
					if(!offerflag){
						var $span = $("#li_span_"+openmap.prodId+"_"+this.servSpecId).parent();
						//var $span = $("#li_"+openmap.prodId+"_"+this.servSpecId).find("span"); //定位删除的附属
						var spec = CacheData.getServSpec(openmap.prodId,this.servSpecId);
						if(spec == undefined){ //没有在已开通附属销售列表中
							return;
						}
						$span.addClass("deldiv");
						spec.isdel = "Y";
						AttachOffer.showHideUim(1,openmap.prodId,this.servSpecId);   //显示或者隐藏
						var serv = CacheData.getServBySpecId(openmap.prodId,this.servSpecId);
						if(ec.util.isObj(serv)){ //没有在已开通附属销售列表中
							$span.addClass("deldiv");
							spec.isdel = "Y";
						}
					}
				});
			});
			//订单备注和模版等加载
			if(orderListInfo!=null && custOrderList!=null){
				var custOrderAttrs=orderListInfo.custOrderAttrs;
				var isTemplateOrder=orderListInfo.isTemplateOrder;
				var templateOrderName=orderListInfo.templateOrderName;
				
				$(custOrderAttrs).each(function(i,custOrderAttr) { 
					var itemSpecId=custOrderAttr.itemSpecId;
					
					//111111118是为备注的编码
					if(itemSpecId=="111111118"){
						var value=custOrderAttr.value;
						
						if(value!=null && value!=""){
							$("#order_remark").html(value);
						}
					}
				});
				
				//模版的操作
				if(isTemplateOrder=="Y"){
					$("#isTemplateOrder").click();//选中模版按钮
					
					SoOrder.showTemplateOrderName();//显示模版名称输入
					
					$("#templateOrderName").val(templateOrderName);//赋值模版名称
				}
			}
	};
	
	//开通功能产品
	var _openServSpecSub = function(prodId,servSpecId,specName,ifParams){
		var servSpec = CacheData.getServSpec(prodId,servSpecId); //在已选列表中查找
		if(servSpec==undefined){   //在可订购功能产品里面 
			var newSpec = {
				objId : servSpecId, //调用公用方法使用
				servSpecId : servSpecId,
				servSpecName : specName,
				ifParams : ifParams,
				isdel : "C"   //加入到缓存列表没有做页面操作为C
			};
			var inPamam = {
				prodSpecId:servSpecId
			};
			if(ifParams == "Y"){
				var data = query.prod.prodSpecParamQuery(inPamam);// 产品功能产品属性
				if(data==undefined || data.result==undefined){
					return;
				}
				newSpec.prodSpecParams = data.result.prodSpecParams;
			if(servSpecId==CONST.YZFservSpecId){//翼支付助手根据付费类型改变默认值
				var feeType = $("select[name='pay_type_-1']").val();
				if(feeType==undefined) feeType = order.prodModify.choosedProdInfo.feeType;
				if(feeType == CONST.PAY_TYPE.AFTER_PAY){
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {
						var prodSpecParam = newSpec.prodSpecParams[j];
						prodSpecParam.setValue = "";
					}																			
				}else{
					for ( var j = 0; j < newSpec.prodSpecParams.length; j++) {							
						var prodSpecParam = newSpec.prodSpecParams[j];
						if (prodSpecParam.value!="") {
							prodSpecParam.setValue = prodSpecParam.value;
						} else if (!!prodSpecParam.valueRange[0]&&prodSpecParam.valueRange[0].value!="")
							//默认值为空则取第一个
							prodSpecParam.setValue = prodSpecParam.valueRange[0].value;
				}
			  }
			}
			}
			CacheData.setServSpec(prodId,newSpec); //添加到已开通列表里
			servSpec = newSpec;
		}
		
		_checkServExcludeDepend(prodId,servSpec);
	};
	//校验服务的互斥依赖
	//校验销售品的互斥依赖
	var _checkOfferExcludeDepend = function(prodId,offerSpec){
		var offerSpecId = offerSpec.offerSpecId;
		var param = CacheData.getExcDepOfferParam(prodId,offerSpecId);

		var data = query.offer.queryExcludeDepend(param);//查询规则校验
		if(data!=undefined){
			paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
		}
	};
	
	//解析服务互斥依赖
	var paserServData = function(result,prodId,serv){
		var servSpecId = serv.servSpecId;
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
		};
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					//scontent += "需要关闭：   " + this.servSpecName + "<br>";
					param.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		/*
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.dependServ.push(this);
			});
		}
		*/
		param.dependServ.push(this);
		//解析功能产品连带
		/*
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.relatedServ.push(this);
			});
		}
		*/
		param.relatedServ.push(this);
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{	
			$.confirm("开通： " + serv.servSpecName,content,{ 
				yesdo:function(){
					AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
					AttachOffer.excludeAddServ(prodId,servSpecId,param);
				},
				no:function(){
				}
			});
		}
	};
	//二次加载附属业务数据信息 第一步
	var _addOfferSpecSub = function(prodId,offerSpecId,roles){
		var newSpec = _setSpec(prodId,offerSpecId);
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			return;
		}
		
		var content = CacheData.getOfferProdStr(prodId,newSpec,0);
		
		_setServ2OfferSpecSub(prodId,newSpec);
		
		_checkOfferExcludeDependSub(prodId,newSpec);
			
	};
	//把选中的服务保存到销售品规格中 第二步
	var _setServ2OfferSpecSub = function(prodId,offerSpec,roles){
		if(offerSpec!=undefined){
			$.each(offerSpec.offerRoles,function(){
				$.each(this.roleObjs,function(){
					var nowProd=prodId+"_"+this.objId;
					
					$(roles).each(function(i,role) { 
						var oldProd=role.prodId+"_"+role.objId;
							
						if(nowProd==oldProd){
							this.selQty = 1;
							return false;
						}else{
							this.selQty = 2;
						}
					});
				});
			});
		}
	};
	//校验销售品的互斥依赖 第三步
	var _checkOfferExcludeDependSub = function(prodId,offerSpec){
		var offerSpecId = offerSpec.offerSpecId;
		var param = CacheData.getExcDepOfferParam(prodId,offerSpecId);
		var data = query.offer.queryExcludeDepend(param);//查询规则校验
		if(data!=undefined){
			paserOfferData(data.result,prodId,offerSpecId,offerSpec.offerSpecName); //解析数据
		}
	};
	
	//解析互斥依赖返回结果
	var paserOfferData = function(result,prodId,offerSpecId,specName){
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
				excludeOffer : [],   //互斥依赖显示列表
				dependOffer : {  //存放互斥依赖列表
					dependOffers : [],
					offerGrpInfos : []
				}
		};
		if(result!=""){
			var exclude = result.offerSpec.exclude;
			var depend = result.offerSpec.depend;
			
			//解析可选包互斥依赖组
			if(ec.util.isArray(exclude)){
				for (var i = 0; i < exclude.length; i++) {
					var offerList = CacheData.getOfferList(prodId); //互斥要去除已订购手动删除
					var flag = true;
					if(offerList!=undefined){
						for ( var j = 0; j < offerList.length; j++) {
							if(offerList[j].isdel=="Y"){
								if(offerList[j].offerSpecId == exclude[i].offerSpecId){  //返回互斥数组在已订购中删除，不需要判断
									flag = false;
									break;
								}
							}
						}
					}
					if(flag){
						content += "需要关闭：   " + exclude[i].offerSpecName + "<br>";
						param.excludeOffer.push(exclude[i].offerSpecId);
					}
				}
			}
			if(depend!=undefined && ec.util.isArray(depend.offerInfos)){
				for (var i = 0; i < depend.offerInfos.length; i++) {	
					content += "需要开通： " + depend.offerInfos[i].offerSpecName + "<br>";
					param.dependOffer.dependOffers.push(depend.offerInfos[i].offerSpecId);
				}	
			}
			if(depend!=undefined && ec.util.isArray(depend.offerGrpInfos)){
				for (var i = 0; i < depend.offerGrpInfos.length; i++) {
					var offerGrpInfo = depend.offerGrpInfos[i];
					param.dependOffer.offerGrpInfos.push(offerGrpInfo);
					content += "需要开通： 开通" + offerGrpInfo.minQty+ "-" + offerGrpInfo.maxQty+ "个以下业务:<br>";
					if(offerGrpInfo.subOfferSpecInfos!="undefined" && offerGrpInfo.subOfferSpecInfos.length>0){
						for (var j = 0; j < offerGrpInfo.subOfferSpecInfos.length; j++) {
							var subOfferSpec = offerGrpInfo.subOfferSpecInfos[j];
							content += '<input id="'+subOfferSpec.offerSpecId+'" type="checkbox" name="'+offerGrpInfo.grpId+'" value="'+subOfferSpec.offerSpecId+'">'+subOfferSpec.offerSpecName+'</input><br>';
						}
					}
				}
			}
		}
		var serContent=_servExDepReByRoleObjs(prodId,offerSpecId);//查询销售品构成成员的依赖互斥以及连带
		content=content+serContent;
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenList(prodId,offerSpecId); 
		}else{	
			content = "<div style='max-height:300px;overflow:auto;'>" + content + "</div>";
			
			CacheData.setOffer2ExcludeOfferSpec(param);
			AttachOffer.excludeAddattch(prodId,offerSpecId,param);
			AttachOffer.excludeAddServ(prodId,"",paramObj);

		}
	};
	//查询销售品对象的互斥依赖连带的关系
	var _servExDepReByRoleObjs=function(prodId,offerSpecId){
		var newSpec = _setSpec(prodId,offerSpecId);
		paramObj.excludeServ=[];//初始化
		paramObj.dependServ=[];//初始化
		paramObj.relatedServ=[];//初始化
		var globContent="";
		$.each(newSpec.offerRoles,function(){
			$.each(this.roleObjs,function(){
				if(this.objType==4 && this.selQty==1){
						var servSpec = CacheData.getServSpec(prodId,this.objId); //在已选列表中查找
						if(servSpec==undefined){   //在可订购功能产品里面 
							var serv = CacheData.getServBySpecId(prodId,this.objId); //在已开通列表中查找
							if(serv==undefined){
								var newServSpec = {
										objId : this.objId, //调用公用方法使用
										servSpecId : this.objId,
										servSpecName : this.objName,
										ifParams : this.isCompParam,
										prodSpecParams : this.prodSpecParams,
										isdel : "C"   //加入到缓存列表没有做页面操作为C
								};
								CacheData.setServSpec(prodId,newServSpec); //添加到已开通列表里
								servSpec = newServSpec;
							}else{
								servSpec=serv;
							}
						}
						var servSpecId = servSpec.servSpecId;
						var param = CacheData.getExcDepServParam(prodId,servSpecId);
						if(param.orderedServSpecIds.length == 0){
//							AttachOffer.addOpenServList(prodId,servSpecId,servSpec.servSpecName,servSpec.ifParams);
						}else{
							var data=query.offer.queryExcludeDepend(param);//查询规则校验
							var content=paserServDataByObjs(data.result,prodId,servSpec,newSpec);
							if(content!=""){
								content=("开通【"+servSpec.servSpecName+"】功能产品：<br>"+content);
								globContent+=(content+"<br>");
							}
						}
				}
			});
		});
		return globContent;
	};
	//添加可选包到缓存列表
	var _setSpec = function(prodId,offerSpecId){
		var newSpec = CacheData.getOfferSpec(prodId,offerSpecId);  //没有在已选列表里面
		if(newSpec==undefined){ //没有在已开通附属销售列表中
			newSpec = query.offer.queryAttachOfferSpec(prodId,offerSpecId); //重新获取销售品构成
			if(!newSpec){
				return;
			}
			CacheData.setOfferSpec(prodId,newSpec);
		}
		return newSpec;
	};
	//转换接口返回的互斥依赖
	var paramObj = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
	};
	
	//uim卡号校验
	var _checkUim = function(prodId,bo2Coupons){
	
		var phoneNumber = OrderInfo.getAccessNumber(prodId);
		var offerId = "-1"; //新装默认，主销售品ID
		/*
		if(OrderInfo.actionFlag==1||OrderInfo.actionFlag==6||OrderInfo.actionFlag==14){ //新装需要选号
			if(phoneNumber==''){
				$.alert("提示","校验UIM卡前请先选号!");
				return false;
			}
		}
		*/
		if(OrderInfo.actionFlag==3 || OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23 || OrderInfo.actionFlag==6 ){ //可选包变更，补换卡，加装副卡
			if(ec.util.isArray(OrderInfo.oldprodInstInfos)){//判断是否是纳入老用户
				$.each(OrderInfo.oldprodInstInfos,function(){
					if(this.prodInstId==prodId){
						offerId = this.mainProdOfferInstInfos[0].prodOfferInstId;
					}
				});
			}else{
				offerId = order.prodModify.choosedProdInfo.prodOfferInstId;
			}
		}
		var cardNo =$.trim($("#uim_txt_"+prodId).val());
		/*
		if(cardNo==undefined || cardNo==''){
			$.alert("提示","UIM卡不能为空!");
			return false;
		}
		*/
		var inParam = {
			"instCode" : cardNo,
			"phoneNum" : phoneNumber,
			"areaId"   : OrderInfo.getProdAreaId(prodId)
		};

		var prodSpecId = OrderInfo.getProdSpecId(prodId);
		var mktResCd="";
		if(CONST.getAppDesc()==0){
			if(getIsMIFICheck(prodId)){
				mktResCd =prod.uim.getMktResCd(CONST.PROD_SPEC_ID.MIFI_ID);
			}else{
				mktResCd = prod.uim.getMktResCd(prodSpecId);
			}
			if(ec.util.isObj(mktResCd)){
//				inParam.mktResCd = mktResCd;
			}else{
				//$.alert("提示","查询卡类型失败！");
				return;
			}
			if(OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23){ //补换卡和异地补换卡
				if(prod.changeUim.is4GProdInst){ //如果已办理4G业务，则校验uim卡是否是4G卡
					inParam.onlyLTE = "1";
				}
			}
		}
		//var data = query.prod.checkUim(inParam);//校验uim卡
  
			var uimData = {
					prodId :  prodId, //产品ID
					isWireBusi : "",
					isWireUIM : false, //判断是否为无线上网卡
					wireType : 0, //1-普通上网卡 2-全球上网卡 0-默认
					uimCode  : bo2Coupons.couponInstanceNumber,//data.baseInfo.mktResInstCode,
					uimName  : ""//data.baseInfo.mktResName
			};
			/*
			$.each(data.attrList, function() {
				if (this.attrId == '60020007') {
					uimData.isWireUIM = true;
					uimData.wireType = this.attrValue;
					return false;
				}
			});
			*/
			if(uimData.isWireUIM){
				if (prodSpecId == CONST.PROD_SPEC.CDMA) {
					uimData.isWireBusi = 1; // 上网卡 - 移动电话业务
				}
			}else{
				if(prodSpecId == CONST.PROD_SPEC.DATA_CARD){
					uimData.isWireBusi = 2; // 普通卡 - 无线业务
				}
			}
			OrderInfo.clearCheckUimData(prodId);
			OrderInfo.checkUimData.push(uimData);
		//根据uim返回数据组织物品节点
		var couponNum = bo2Coupons.couponNum;//data.baseInfo.qty ;
		if(couponNum==undefined||couponNum==null){
			couponNum = 1 ;
		}
		var coupon = {
			couponUsageTypeCd : "3", //物品使用类型
			inOutTypeId : "1",  //出入库类型
			inOutReasonId : 0, //出入库原因
			saleId : 1, //销售类型
			couponId :bo2Coupons.couponId, //data.baseInfo.mktResId, //物品ID
			couponinfoStatusCd : "A", //物品处理状态
			chargeItemCd : "3000", //物品费用项类型
			couponNum : couponNum, //物品数量
			storeId : bo2Coupons.storeId,//data.baseInfo.mktResStoreId, //仓库ID
			storeName : "1", //仓库名称
			agentId : 1, //供应商ID
			apCharge : 0, //物品价格
			couponInstanceNumber : bo2Coupons.terminalCode,//data.baseInfo.mktResInstCode, //物品实例编码
			terminalCode : bo2Coupons.terminalCode,//data.baseInfo.mktResInstCode,//前台内部使用的UIM卡号
			ruleId : "", //物品规则ID
			partyId : OrderInfo.cust.custId, //客户ID
			prodId :  prodId, //产品ID
			offerId : offerId, //销售品实例ID
			state : "ADD", //动作
			relaSeq : "" //关联序列	
		};
		if(CONST.getAppDesc()==0){
			coupon.cardTypeFlag=bo2Coupons.cardTypeFlag;//UIM卡类型
		}
		$("#uim_check_btn_"+prodId).attr("disabled",true);
		$("#uim_check_btn_"+prodId).removeClass("purchase").addClass("disablepurchase");
		$("#uim_release_btn_"+prodId).attr("disabled",false);
		$("#uim_release_btn_"+prodId).removeClass("disablepurchase").addClass("purchase");
		$("#uim_txt_"+prodId).attr("disabled",true);
		if(getIsMIFICheck(prodId)){//判断是否通过MIFI 校验
			$("#isMIFI_"+prodId).val("yes");
		}else{
			$("#isMIFI_"+prodId).val("no");
		}
		OrderInfo.clearProdUim(prodId);
		OrderInfo.boProd2Tds.push(coupon);
		if(OrderInfo.actionFlag==22 && bo2Coupons.cardTypeFlag==1 && order.prodModify.choosedProdInfo.productId != '280000000'){
		//	_queryAttachOffer();
		  AttachOffer.queryCardAttachOffer(bo2Coupons.cardTypeFlag);  //加载附属销售品
	    }
		// 办理上网卡套餐，UIM校验当卡为全球上网卡自动带出天翼宽带-国际及港澳台数据漫游
		if (OrderInfo.actionFlag == 1 || OrderInfo.actionFlag == 14) {
			if (uimData.isWireUIM && uimData.wireType == '02'
					&& prodSpecId == CONST.PROD_SPEC.DATA_CARD) {
				// AttachOffer.openServSpec(prodId,13409441,'天翼宽带-国际及港澳台数据漫游','N');
				AttachOffer.addOpenServList(prodId,
						CONST.PROD_SPEC_ID.WIRE_GLOBAL, '天翼宽带-国际及港澳台数据漫游', 'N');
				var $li = $("#li_" + prodId + "_"
						+ CONST.PROD_SPEC_ID.WIRE_GLOBAL);
				if ($li.length > 0) {
					$li.find("dd").removeClass("delete").addClass("mustchoose")
							.attr("onclick", '');
				}
			}
		}
	};
	var getIsMIFICheck=function(prodId){
		var prodIdTmp=(Math.abs(prodId)-1);
		if(AttachOffer.openServList.length>prodIdTmp){
			var specList = AttachOffer.openServList[prodIdTmp].servSpecList;
			for (var j = 0; j < specList.length; j++) {
				var spec = specList[j];
				if(spec.isdel!="Y" && spec.isdel!="C"){
					if(spec.servSpecId==CONST.PROD_SPEC_ID.MIFI_ID && CONST.APP_DESC==0){
						return true ; 
					}
				}
			}
		}
		return false;
	};
	//通过产品id获取产品已开通附属实例列表
	var _getOfferList = function (prodId){
		for ( var i = 0; i < AttachOffer.openedList.length; i++) {
			var opened = AttachOffer.openedList[i];
			if(opened.prodId == prodId){
				return opened.offerList;
			} 
		}
		return []; //如果没值返回空数组
	};
	//获取销售品实例构成new
	var _getOffer = function(prodId,offerId){
		
		var offerList = _getOfferList(prodId);
		//$.alert(JSON.stringify(offerList));
		if(ec.util.isArray(offerList)){
			for ( var i = 0; i < offerList.length; i++) {
				if(offerList[i].offerId==offerId){
					return offerList[i];
				}
			}
		}
	};
	//删除已订购可选包(new)
	var _delOfferSub = function(prodId,offerId){
		//var $span = $("#li_"+prodId+"_"+offerId).find("span"); //定位删除的附属
		var $div = $("#li_span_"+prodId+"_"+offerId).parent(); //定位删除的附属
		if($div.attr("class")=="block deldiv"){  //已经退订，再订购	
			AttachOffer.addOffer(prodId,offerId,$span.text());
		}else { //退订
			var offer = CacheData.getOffer(prodId,offerId);
			if(!ec.util.isArray(offer.offerMemberInfos)){	
				var param = {
					prodId:prodId,
					areaId: OrderInfo.getProdAreaId(prodId),
					offerId:offerId	
				};
				if(ec.util.isArray(OrderInfo.oldprodInstInfos) && OrderInfo.actionFlag==6){//主副卡纳入老用户
					for(var i=0;i<OrderInfo.oldprodInstInfos.length;i++){
						if(prodId==OrderInfo.oldprodInstInfos[i].prodInstId){
							param.areaId = OrderInfo.oldprodInstInfos[i].areaId;
							param.acctNbr = OrderInfo.oldprodInstInfos[i].accNbr;
						}
					}
				}else{
					param.acctNbr = OrderInfo.getAccessNumber(prodId);
				}
				var dataes = order.uiCusts.queryOfferInst(param);
				if(dataes==undefined){
					return;
				}
				//遍历附属的构成要和主套餐的构成实例要一致（兼容融合套餐）
				var offerMemberInfos=[];
				$.each(dataes.offerMemberInfos,function(){
					var prodInstId=this.objInstId;
					var flag=false;
					$.each(OrderInfo.offer.offerMemberInfos,function(){
						if(this.objInstId==prodInstId){
							flag=true;
							return false;
						}
					});
					if(flag){
						offerMemberInfos.push(this);
					}
				});
				
				offer.offerMemberInfos = dataes.offerMemberInfos=offerMemberInfos;
				offer.offerSpec = dataes.offerSpec;
			}
			var content = "";
			if(offer.offerSpec!=undefined){
				content = CacheData.getOfferProdStr(prodId,offer,1);
			}
			//这里原先是有弹窗提示的，二次加载就不需要了，原方法：_delOffer
			offer.isdel = "Y";
			$span.addClass("del");
			delServByOffer(prodId,offer);
		}
	};
	var _queryOfferInst = function(param,callBackFun) {
		var url= contextPath+"/offer/queryOfferInst";
		if(typeof(callBackFun)=="function"){
			$.callServiceAsJsonGet(url,param,{
				"before":function(){
					$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
				},
				"always":function(){
					$.unecOverlay();
				},
				"done" : function(response){
					$.unecOverlay();
					if (response.code==0) {
						if(response.data){
							callBackFun(response.data);
						}
					}else if (response.code==-2){
						$.alertM(response.data);
					}else {
						$.alert("提示","查询销售品实例失败,稍后重试");
					}
				}
			});	
		}else {
			$.ecOverlay("<strong>正在查询销售品实例中,请稍后....</strong>");
			var response = $.callServiceAsJsonGet(url,param);	
			$.unecOverlay();
			if (response.code==0) {
				if(response.data){
					return response.data;
				}
			}else if (response.code==-2){
				$.alertM(response.data);
			}else {
				$.alert("提示","查询销售品实例失败,稍后重试");
			}
		}
	};
	
	//删除附属销售品带出删除功能产品
	var delServByOffer = function(prodId,offer){	
		$.each(offer.offerMemberInfos,function(){
			var servId = this.objInstId;
			if($("#check_"+prodId+"_"+servId).attr("checked")=="checked"){
				var serv = CacheData.getServ(prodId,servId);
				if(ec.util.isObj(serv)){
					serv.isdel = "Y";
					var $li = $("#li_"+prodId+"_"+servId);
					$li.removeClass("canshu").addClass("canshu2");
					$li.find("span").addClass("del"); //定位删除的附属
				}
			}
		});
	};
	
	
	//关闭已订购功能[4-1]
	var _closeServSub = function(prodId,servId){
		var $div = $("#li_span_"+prodId+"_"+servId).parent(); //定位删除的附属
		var serv = CacheData.getServ(prodId,servId);
		if(serv!=undefined && serv!=""){
			var $div = $("#li_span_"+prodId+"_"+servId).parent(); //定位删除的附属
			var uim = OrderInfo.getProdUim(prodId);
			if(serv.servSpecId=="280000020" && (OrderInfo.actionFlag==22 || OrderInfo.actionFlag==23) && uim.cardTypeFlag=="1"){//补换卡补4G卡不能退订4G上网功能产品
				$.alert("提示","4G卡不能退订【4G（LTE）上网】功能产品");
				return;
			}
			
			$div.addClass("deldiv");
			serv.isdel = "Y";
		}

	};
	//开通功能产品
	var _openServ = function(prodId,serv){
		if(serv!=undefined){   //在可订购功能产品里面 
			if(serv.servSpecId==""){
				var $span = $("#li_"+prodId+"_"+serv.servId).find("span");
				$span.removeClass("del");
				serv.isdel = "N";
			}else{
				_checkServExcludeDepend(prodId,serv);
			}
		}
	};
	
	
	//校验服务的互斥依赖[4-3-1]
	var _checkServExcludeDependSub = function(prodId,serv,flag){
		var servSpecId = serv.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		if(param.orderedServSpecIds.length == 0){
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserServDataSub(data.result,prodId,serv);//解析数据
			}
		}
	};
	var paserServDataSub = function(result,prodId,serv){
		var servSpecId = serv.servSpecId;
		var servExclude = result.servSpec.exclude; //互斥
		var servDepend = result.servSpec.depend; //依赖
		var servRelated = result.servSpec.related; //连带
		var content = "";
		//转换接口返回的互斥依赖
		var param = {  
			excludeServ : [],  //互斥依赖显示列表
			dependServ : [], //存放互斥依赖列表
			relatedServ : [] //连带
		};
		
		//解析功能产品互斥
		if(ec.util.isArray(servExclude)){
			$.each(servExclude,function(){
				var servList = CacheData.getServList(prodId); //互斥要去除已订购手动删除
				var flag = true;
				if(servList!=undefined){
					for ( var i = 0; i < servList.length; i++) {
						if(servList[i].isdel=="Y"){
							if(servList[i].servSpecId == this.servSpecId){  //返回互斥数组在已订购中删除，不需要判断
								flag = false;
								break;
							}
						}
					}
				}
				if(flag){
					content += "需要关闭：   " + this.servSpecName + "<br>";
					param.excludeServ.push(this);
				}
			});
		}
		//解析功能产品依赖
		if(ec.util.isArray(servDepend)){
			$.each(servDepend,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.dependServ.push(this);
			});
		}
		//解析功能产品连带
		if(ec.util.isArray(servRelated)){
			$.each(servRelated,function(){
				content += "需要开通：   " + this.servSpecName + "<br>";
				param.relatedServ.push(this);
			});
		}
		if(content==""){ //没有互斥依赖
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{	
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams); //添加开通功能
			AttachOffer.excludeAddServ(prodId,servSpecId,param);
		}
	};
	
	//校验服务的互斥依赖
	var _checkServExcludeDepend = function(prodId,serv,flag){
		var servSpecId = serv.servSpecId;
		var param = CacheData.getExcDepServParam(prodId,servSpecId);
		if(param.orderedServSpecIds.length == 0){
			AttachOffer.addOpenServList(prodId,servSpecId,serv.servSpecName,serv.ifParams);
		}else{
			var data = query.offer.queryExcludeDepend(param);  //查询规则校验
			if(data!=undefined){
				paserServData(data.result,prodId,serv);//解析数据
			}
		}
	};
	

	
	
	
	//点击确认，添加附属销售品发展人[4-4]
	var _addAttachDealerSub = function(id,accessNumbe,objName,roleCode){
		var prodId = id.split("_")[0];
		if($("#tr_"+id)[0]==undefined){ //没有添加过
			var objId = id+"_"+OrderInfo.SEQ.dealerSeq;
			var $tdType = _getDealerTypeSub(id,objId);
			if($tdType==undefined){
				return false;
			}
			var $tr = $("#atr_"+id);
			var $li = $('<li name="tr_'+id+'"></li>');
			var $dl= $("<dl></dl>");
			$dl.append("<dd>"+accessNumbe+"</dd>");
			$dl.append("<dd>"+objName+"</dd>");
			$dl.append($tdType);
			
			var dealer = $("#tr_"+prodId).find("input"); //产品协销人
			var staffId = 1;
			var staffName = "";
			if(dealer[0]==undefined){
				staffId = OrderInfo.staff.staffId;
				staffName = OrderInfo.staff.staffName;
			}else {
				staffId = dealer.attr("staffId");
				staffName = dealer.attr("value");
			}
			if(order.ysl!=undefined){
				var $dd = $('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'"  data-mini="true"></input></dd>');
				$dl.append($dd);
			}else{
				var $dd = $('<dd><input type="text" id="dealer_'+objId+'" name="dealer_'+id+'" staffId="'+staffId+'" value="'+staffName+'"  data-mini="true"  readonly="readonly"></input></dd>');
				$dl.append($dd);
			}
			var $button='<dd class="ui-grid"><div class="ui-grid-b"><div class="ui-block-a">';
			$button+='<button data-mini="ture" onclick="order.main.queryStaff(\'dealer\',\''+objId+'\');">选择</button></div>';
			$button+=' <div class="ui-block-b"> <button data-mini="ture" onclick="order.dealer.addProdDealer(this,\''+id+'\')">添加</button></div>';
			$button+=' <div class="ui-block-c"> <button data-mini="ture" onclick="order.dealer.removeDealer(this);">删除</button></div></div></dd>';			
			$dl.append($button);
			//发展渠道
			var $tdChannel = $('<dd></dd>');
			var $channelSelect = $('<select id="dealerChannel_'+objId+'" name="dealerChannel_'+objInstId+'" class="inputWidth183px" onclick=a=this.value;></select>');
			$.each(OrderInfo.channelList,function(){
				if(this.isSelect==1)
					$channelSelect.append("<option value='"+this.channelNbr+"' selected ='selected'>"+this.channelName+"</option>");
				else
					$channelSelect.append("<option value='"+this.channelNbr+"'>"+this.channelName+"</option>");
			});
			$tdChannel.append($channelSelect);
			$tdChannel.append('<label class="f_red">*</label>');
			$dl.append($tdChannel);
			$li.append($dl);
			$("#dealerTbody").append($li);
			$.jqmRefresh($("#dealerTbody"));
			OrderInfo.SEQ.dealerSeq++;
		}	
	};
	
	return {
		initSub:_initSub,
		addAttachDealerSub:_addAttachDealerSub,
		checkServExcludeDependSub:_checkServExcludeDependSub,
		openServ:_openServ,
		closeServSub:_closeServSub,
		queryOfferInst:_queryOfferInst,
		getOfferList:_getOfferList,
		delServByOffer:delServByOffer,
		getOffer:_getOffer,
		delOfferSub:_delOfferSub,
		getIsMIFICheck:getIsMIFICheck,
		checkUim:_checkUim,
		setSpec:_setSpec,
		servExDepReByRoleObjs:_servExDepReByRoleObjs,
		checkOfferExcludeDependSub:_checkOfferExcludeDependSub,
		//paserServData:_paserServData,
		setServ2OfferSpecSub:_setServ2OfferSpecSub,
		addOfferSpecSub:_addOfferSpecSub,
		checkServExcludeDepend:_checkServExcludeDepend,
		openServSpecSub:_openServSpecSub,
		opeSer:_opeSer,
		showoffer:_showoffer,
		loadData:_loadData,
		buildMainView:_buildMainView,
		offerChangeView:_offerChangeView,
		buyService:_buyService,
		queryData:_queryData,
		searchPack:_searchPack,
		offerinit:_offerinit,
		packageQuery : _packageQuery,
		showCustAuth 			: _showCustAuth,
		showCustCreate 			: _showCustCreate,
		custAuth 				: _custAuth,
		getCustInfo 			: _getCustInfo,
		custReset				: _custReset,
		btnQueryCustProd		: _btnQueryCustProd,
		btnQueryCustProdMore	: _btnQueryCustProdMore,
		jumpAuth 				: _jumpAuth,
		identidiesTypeCdChoose 	: _identidiesTypeCdChoose,
		custidentidiesTypeCdChoose :_custidentidiesTypeCdChoose,
		choosedCustInfo 		: _choosedCustInfo,
		partyTypeCdChoose 		: _partyTypeCdChoose,
		chooseArea 				: _chooseArea,
		chooseAllArea 			: _chooseAllArea,
		newCustChooseArea 		: _newCustChooseArea,
		prodChooseArea 			: _prodChooseArea,
		init	 				: _init,
		partyProfiles 			: _partyProfiles,
		profileTabLists 		: _profileTabLists,
		queryCust 				: _queryCust,
		queryCustDetail 		: _queryCustDetail,
		changeLabel 			: _changeLabel,
		jumpAuthflag 			: _jumpAuthflag,
		orderBtnflag 			: _orderBtnflag,
		custCreateButton 		: _custCreateButton,
		isAppointNum 			: _isAppointNum,
		preQueryCustChooseArea 	: _preQueryCustChooseArea,
		linkSelectPlan			: _linkSelectPlan,
		back 					: _back,
		fromProvFlag 			: _fromProvFlag,
		provIsale 				: _provIsale,
		addLi:_addLi,
		delLi:_delLi
	};
	
})();
$(function() {
//   order.cust.form_valid_init();
//   order.cust.initDic();
});
/**
 * 首页 功能控制
 * 
 * @author liusd
 */
CommonUtils.regNamespace("main", "home");
main.home = (function(){
	//原有配置
	var _pre_shortcut = [];
	//变化内容
	var _change_shortcut = [];
	//首页请求公告
	var _queryNotice = function(bulletinId){
		var param = {};
		if(bulletinId){
			 param = {"bulletinId" : bulletinId};
		}
		$.callServiceAsHtmlGet(contextPath + "/pad/main/notice",$.param(param), {
			"before":function(){
				if(!$.isEmptyObject(param))
					$.ecOverlay("公告查询中,请稍等...</strong>");
			},
			"always":function(){
				if(!$.isEmptyObject(param))
					$.unecOverlay();
			},
			"done" : function(response){
				if(!$.isEmptyObject(param)){
					$.popup("#dlg_notice_detail",response.data,{"transition":"slidedown"});
					return;
				}
				//没查到数据保留页面提示信息
				if(!response && !(response.data)){
					return ;
				}
				
				$("#div_notice").html(response.data);
				//滚动处理
				var intervalTime = $("#input_interval_time").val();
				if(intervalTime == ""){
					intervalTime = 3000;
				}
				//滚动一次的长度，必须是行高的倍数,这样滚动的时候才不会断行
				var _stepSize = 40;
				//可选("slow", "normal", or "fast")，或者滚动动画时长的毫秒数
				var _scrollSpeed = "slow";
				var _objInterval = null;
				var _scrollObj = $("#span_scroll_notice");
				//启动定时器，开始滚动
				var _start = function(){
					_objInterval=setInterval(function(){
						if(_scrollObj.scrollTop() >= $("#span_notice_body").outerHeight()){
							_scrollObj.scrollTop(_scrollObj.scrollTop()-$("#span_notice_body").outerHeight());
						}
						//使用jquery创建滚动时的动画效果
						_scrollObj.animate({"scrollTop" : _scrollObj.scrollTop()+_stepSize +"px"},_scrollSpeed,function(){});
					},intervalTime);
				}
				//清除定时器，停止滚动
				var _stop = function(){
					window.clearInterval(_objInterval);
				}
				//用上部的内容填充下部
				$("#span_notice_hide").html($("#span_notice_body").html());
				//给显示的区域绑定鼠标事件
				_scrollObj.bind("mouseover",function(){_stop();});
				_scrollObj.bind("mouseout",function(){_start();});
				//事件绑定 
				$("#span_notice_body a").on("tap",function(){
					_queryNotice($(this).attr("nid"));
				})
				$("#span_notice_hide a").on("tap",function(){
					_queryNotice($(this).attr("nid"));
				})
				_start();
			}
		});
	};
	
	//首页请求已设置的快捷菜单
	var _queryMainShortcut = function(){
		$.callServiceAsHtmlGet(contextPath + "/pad/menu/mainShortcut.html",{}, {
			"before":function(){
				$("#ul_quick_set").animate({"margin-left":"1400px"},500);
			},
			"done":function(response){
				var obj = $("#ul_quick_set");
				obj.html(response.data).delay(1000).animate({"margin-left":"0px"},1500);
				obj.find("li[ctrl='add']").off("tap").on("tap",function(){
					$(this).off("tap").on("tap",_configShortCut);
				});
				obj.find("li[ctrl!='add']").off("tap").on("tap",function(){
					window.location.href=$(this).attr("url");
				});
			}
		});
	};
	//隐藏首页非业务操作入口内容,保留三个入口 ok
	var _hideMainIco = function(){
		$("#div_notice").hide();
		$("#div_user_info").hide();
		$("#div_quick_set").hide();
		$("#ul_quick_set").hide();
	};
	//隐藏首页所有内容  ok
	var _hideMainAllIco = function(){
		$("#div_notice").hide();
		$("#ul_busi_area").hide();
		$("#div_user_info").hide();
		$("#div_quick_set").hide();
		$("#ul_quick_set").hide();
	};
	//配置快捷菜单
	var _configShortCut = function(){
		//登录窗口
		var response = $.callServiceAsJson(contextPath+"/staff/login/isLogin");
		if (response.code !=0){
			login.windowpub.alertLoginWindow(response.data);
			return;
		}
		$.callServiceAsHtmlGet(contextPath+"/pad/menu/configPrepare.html",{},{
			"before":function(){
				$.ecOverlay("<strong>查询菜单中,请稍等...</strong>");
			},
			"always":function(){
				$.unecOverlay();
			},		
			"done":function(response){
				if (!response || !response.data) {
					$.alert("提示","抱歉,没有找到可供配置的菜单信息.");
					return;
				}
				$.popup("#dlg_shortcut_quickset",response.data,{
					width:$(window).width()-200,
					height:$(window).height(),
					contentHeight:$(window).height()-120,
					afterClose:function(){_queryMainShortcut();}
				});
				
				$("#dlg_shortcut_quickset li").each(function(){
					var _this = $(this);
					_this.off("tap").on("tap",function(){
						if($("#dlg_shortcut_quickset li.set").length >=8 && !_this.hasClass("set")){
							$.alert("提示","最多允许添加8个图标,请取消已选图标后再添加！");
							return;
						}
						_this.toggleClass("set");
						var _data = {};
						if(_this.hasClass("set")){
							_data = {"resourceId":_this.attr("rid"),"actionType":"ADD"};
						}else{
							_data = {"resourceId":_this.attr("rid"),"actionType":"DEL"};
						}
						_saveShortcut(_data);
					});
				});
			}
		});	
	};
	var _saveShortcut = function(dataObj){
		var url = contextPath+"/menu/setShortcut";
		var param = dataObj;
		$.callServiceAsJson(url,param, {
			"before":function(){
				$.ecOverlay("保存中,请稍等...");
			},
			"always":function(){
				$.unecOverlay();
			},
			"done":function(response){
				if(response.code != 0){
					$.alertM(response.data);
				}					
			},
			"fail":function(response){
				$.unecOverlay();
				$.alert("提示","请求可能发生异常，请稍后再试！");
			}
		});
	}
	//退出系统操作 ok
	var _callExit = function(){
		$.callServiceAsJson(contextPath+"/staff/login/padloginout", {}, {
			"done" : function(response){
				if(response.code==0){
					MyPlugin.exitSystem([],function(result) {},function(error) {});
				}
			},
			"fail" : function(response){
				MyPlugin.exitSystem([],function(result) {},function(error) {});
			}
		});
	}
	//菜单控制
	var _menuCtrl = function(){
		$("#a_logobar").off("tap").on("tap",function(){
		    $("#navbar").slideToggle(400);
		});
		$("#a_logobar").off("taphold").on("taphold",function(){
		    window.location.href = contextPath+"/pad/main/home";
		});
	}
	//页面初始化块 ok
	var _mainInit = function(){			
		//查询公告
		_queryNotice();
		//查询已配置快捷菜单
		_queryMainShortcut();
		//首页事件
		_bindMainEvent();
		//首页数据
		_bindMainData();
	}
	//业务数据在首页初始加载 ok
	var _bindMainData = function(){
		//业务办理所需用户信息
		var _obj = $("#_session_staff_info");
		OrderInfo.staff={
			staffId 		: _obj.attr("staffId"),
			staffCode 		: _obj.attr("staffCode"),
			staffName 		: _obj.attr("staffName"),
			channelId 		: _obj.attr("channelId"),
			channelName 	: _obj.attr("channelName"),
			areaId 			: _obj.attr("areaId"),
			areaCode 		: _obj.attr("areaCode"),
			areaName 		: _obj.attr("areaName"),
			areaAllName 	: _obj.attr("areaAllName"),
			orgId 			: _obj.attr("orgId"),
			distributorId 	: _obj.attr("partnerId"),
			operatorsId 	: _obj.attr("operatorsId"),
			operatorsName 	: _obj.attr("operatorsName"),
			operatorsNbr 	: _obj.attr("operatorsNbr"),
			soAreaId 		: _obj.attr("areaId"),
			soAreaCode 		: _obj.attr("areaCode"),
			soAreaName 		: _obj.attr("areaName"),
			soAreaAllName 	: _obj.attr("areaAllName")
		};
	}
	//绑定主页面所有事件 ok
	var _bindMainEvent = function(){			
		//绑定退出与渠道切换
		$("#a_sys_exit").off("tap").on("tap",_callExit);
		$("#a_channel_exchange").off("tap").on("tap",function(){
			$("#dlg-exchange-channel").popup("open");
		    $("#dlg-exchange-channel li").on("tap", function (){
		    	_chooseChannel($(this).find("a"));
		    });
		});
		//菜单控制
		_menuCtrl();
		//快捷菜单配置
		$("#div_quick_set a").off("tap").on("tap",_configShortCut);
		//客户查询相关数据初始化
		order.cust.mgr.init();
	}
	//选定渠道后设置会话中的信息 ok
	var _chooseChannel= function(obj){
		$.confirm("信息","您当前正在进行渠道切换的操作，点击确定按钮，将清除当前页所有数据！",{
			yes:function(){
				var setUrl  = contextPath + "/staffMgr/setCurrentChannel";
				var param = {"channelId":$(obj).attr("cnlid")};
				var response = $.callServiceAsJson(setUrl,param);
				if(response.code == 0){
					$("#dlg-exchange-channel").popup("close");
					//关闭后再重新载入页面,防止url中存在#&ui-state等信息
					if(!$("#dlg-exchange-channel").hasClass("ui-page-active")){
						window.location.reload();
					}
				}else {
					$.alert("提示","渠道设定异常，请稍后再试");
				}
		},no:function(){
			$("#dlg-exchange-channel").popup("close");
		}});
	};
	return {
		saveShortcut	:_saveShortcut,
		hideMainIco		:_hideMainIco,
		hideMainAllIco	:_hideMainAllIco,
		mainInit		:_mainInit
	};
})();
//首页初始化
$(function(){
	main.home.mainInit();
})
